<!DOCTYPE html>
<html>
<head hexo-theme='Volantis' version='1.5.2' docs='https://xaoxuu.com/wiki/volantis/'>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  <title>Archives: 2018 | Throwable&#39;s Blog</title>
  
  <meta name="keywords" content="thorwable,doge,Thorwable">
  
  
  <meta name="description" content="一棵还在尝试努力生存的90后韭菜Doge">
  

  
  <link rel="alternate" href="/atom.xml" title="Throwable's Blog">
  

  <meta name="HandheldFriendly" content="True" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <!-- meta -->
  

  <!-- link -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.css">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.10.1/css/all.min.css">
  
  
  <link rel='stylesheet' href='https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/static/css/gb.css'>
  

  
  <link rel="shortcut icon" type='image/x-icon' href="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/mine/doge_favicon.ico">
  

  

  
    
<link rel="stylesheet" href="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/static/css/throwable.css">

  

  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>

  
  
    <!-- ba -->
    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?4df6907aebab752244c3ca1432b4ff57";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
    </script>
  
</head>

<body>
  
  
  <div class="cover-wrapper">
    <cover class='cover  half'>
      
        
  <img class='logo' src='https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/mine/blog-logo.png'/>


  <div class="m_search">
    <form name="searchform" class="form u-search-form">
      <i class="icon fas fa-search fa-fw"></i>
      <input type="text" class="input u-search-input" placeholder="(゜-゜)つロ搜一搜有没有想看的" />
    </form>
  </div>

<div class='menu navigation'>
  <ul class='h-list'>
    
      
        <li>
          <a class="nav home "
            href="/"
            
            
            id="home">
            <i class='fas fa-home fa-fw'></i>&nbsp;主页
          </a>
        </li>
      
        <li>
          <a class="nav home "
            href="/projects/"
            
            
            id="projects">
            <i class='fas fa-code-branch fa-fw'></i>&nbsp;开源项目
          </a>
        </li>
      
        <li>
          <a class="nav home "
            href="/friends/"
            
              rel="nofollow"
            
            
            id="friends">
            <i class='fas fa-link fa-fw'></i>&nbsp;友链
          </a>
        </li>
      
        <li>
          <a class="nav home "
            href="/about/"
            
              rel="nofollow"
            
            
            id="about">
            <i class='fas fa-info-circle fa-fw'></i>&nbsp;关于
          </a>
        </li>
      
    
  </ul>
</div>
<div style="text-align: center;margin-top: 5px;" id="rollingColorfulFont"></div>
      
    </cover>
    <header class="l_header ">
  <div id="loading-bar-wrapper">
    <div id="loading-bar"></div>
  </div>

	<div class='wrapper'>
		<div class="nav-main container container--flex">
      <a class="logo flat-box" target="_self" href='/' >
        
          
          
            Throwable
          
        
      </a>
			<div class='menu navigation'>
				<ul class='h-list'>
          
  					
  						<li>
								<a class="nav flat-box" href="/"
                  
                  
                    target="_self"
                  
                  id="home">
									<i class='fas fa-hourglass-half fa-fw'></i>&nbsp;近期
								</a>
							</li>
      			
  						<li>
								<a class="nav flat-box" href="/categories/"
                  
                    rel="nofollow"
                  
                  
                    target="_self"
                  
                  id="categories">
									<i class='fas fa-folder-open fa-fw'></i>&nbsp;分类
								</a>
							</li>
      			
  						<li>
								<a class="nav flat-box" href="/tags/"
                  
                    rel="nofollow"
                  
                  
                    target="_self"
                  
                  id="tags">
									<i class='fas fa-hashtag fa-fw'></i>&nbsp;标签
								</a>
							</li>
      			
  						<li>
								<a class="nav flat-box" href="/friends/"
                  
                    rel="nofollow"
                  
                  
                  id="friends">
									<i class='fas fa-link fa-fw'></i>&nbsp;友接
								</a>
							</li>
      			
  						<li>
								<a class="nav flat-box" href="/blog/archives/"
                  
                    rel="nofollow"
                  
                  
                    target="_self"
                  
                  id="blogarchives">
									<i class='fas fa-archive fa-fw'></i>&nbsp;归档
								</a>
							</li>
      			
  						<li>
								<a class="nav flat-box" href="/about/"
                  
                    rel="nofollow"
                  
                  
                    target="_self"
                  
                  id="about">
									<i class='fas fa-info-circle fa-fw'></i>&nbsp;关于
								</a>
							</li>
      			
      		
				</ul>
			</div>

      <div class="m_search">
        <form name="searchform" class="form u-search-form">
          <i class="icon fas fa-search fa-fw"></i>
          <input type="text" class="input u-search-input" placeholder="(゜-゜)つロ搜一搜有没有想看的" />
        </form>
      </div>

			<ul class='switcher h-list'>
				
					<li class='s-search'><a class="fas fa-search fa-fw" target="_self" href='javascript:void(0)'></a></li>
				
				<li class='s-menu'><a class="fas fa-bars fa-fw" target="_self" href='javascript:void(0)'></a></li>
			</ul>
		</div>

		<div class='nav-sub container container--flex'>
			<a class="logo flat-box"></a>
			<ul class='switcher h-list'>
				<li class='s-comment'><a class="flat-btn fas fa-comments fa-fw" target="_self" href='javascript:void(0)'></a></li>
        
          <li class='s-toc'><a class="flat-btn fas fa-list fa-fw" target="_self" href='javascript:void(0)'></a></li>
        
			</ul>
		</div>
	</div>
</header>
	<aside class="menu-phone white-box">
    <header>
		<nav class="menu navigation">
      <ul>
        
          
            <li>
							<a class="nav flat-box" href="/"
                
                
                id="home">
								<i class='fas fa-clock fa-fw'></i>&nbsp;近期文章
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/blog/archives/"
                
                  rel="nofollow"
                
                
                id="blogarchives">
								<i class='fas fa-archive fa-fw'></i>&nbsp;文章归档
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/projects/"
                
                
                id="projects">
								<i class='fas fa-code-branch fa-fw'></i>&nbsp;开源项目
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/friends/"
                
                  rel="nofollow"
                
                
                id="friends">
								<i class='fas fa-link fa-fw'></i>&nbsp;我的友链
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/about/"
                
                  rel="nofollow"
                
                
                id="about">
								<i class='fas fa-info-circle fa-fw'></i>&nbsp;关于小站
							</a>
            </li>
          
       
      </ul>
		</nav>
    </header>
	</aside>
<script>setLoadingBarProgress(40);</script>

  </div>


  <div class="l_body">
    <div class='body-wrapper'>
      <div class='l_main'>
	
		
  <section class="post-list ">
    
    
      
        
          <div class='post-wrapper'>
            <article class="post white-box card-shadow  reveal ">
  


  <section class='meta'>
    
    
    <div class="meta" id="header-meta">
      
        
  <h2 class="title">
    <a href="/2018/11/28/rabbitmq-extension-confirm-cancel/">
      RabbitMQ扩展之消费者取消通知
    </a>
  </h2>


      
      <div class='new-meta-box'>
        
          
        
          
            
  <div class='new-meta-item author'>
    
      <a href="http://throwable.club" rel="nofollow">
        
          <img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/mine/doge_avatar.jpg">
        
        <p>Throwable</p>
      </a>
    
  </div>


          
        
          
            <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-edit" aria-hidden="true"></i>
    <p>发布于：2018年11月28日</p>
  </a>
</div>

          
        
          
            
  
  <div class='new-meta-item category'>
    <a href='/blog/categories/Middleware/RabbitMQ/' rel="nofollow">
      <i class="fas fa-folder-open" aria-hidden="true"></i>
      <p>Middleware&nbsp;/&nbsp;RabbitMQ</p>
    </a>
  </div>


          
        
          
            
  <div class="new-meta-item wordcount">
    <a class='notlink'>
      <i class="fas fa-keyboard" aria-hidden="true"></i>
      <p>字数：646字</p>
    </a>
  </div>
  <div class="new-meta-item readtime">
    <a class='notlink'>
      <i class="fas fa-hourglass-half" aria-hidden="true"></i>
      <p>时长：2分钟</p>
    </a>
  </div>


          
        
          
            <div class="new-meta-item date" itemprop="dateUpdated" datetime="2018-11-28T23:03:26+08:00">
  <a class='notlink'>
    <i class="fas fa-save" aria-hidden="true"></i>
    <p>更新于：2018年11月28日</p>
  </a>
</div>

          
        
          
            

          
        
          
            

          
        
      </div>
      
        <hr>
      
    </div>
  </section>


  <section class="article typo">
    <div class="article-entry" itemprop="articleBody">
      <h1>前提</h1>
<p>本文来源于官方文档<a href="https://www.rabbitmq.com/consumer-cancel.html" target="_blank" rel="noopener">Consumer Cancel Notification</a>。</p>
<h2 id="消费者取消通知">消费者取消通知</h2>
<p>当一个信道上建立的消费者订阅了一个队列，有可能出现各种原因导致消费停止。一个很明显的原因就是客户端在同一个信道上发出<code>basic.cancel</code>命令，消息中间件代理响应<code>basic.cancel-ok</code>，将会导致消费者被取消。还有其他的事件如队列的删除或者集群方案所在队列的集群节点失败也有可能导致消费者被取消，<strong>消费者被取消这个事件并不会通知客户端对应的信道，这样子会造成客户端无法感知消费者被取消</strong>。</p>
<p>为了避免上面这些情况出现，RabbitMQ引入了扩展特性：由于消息中间件代理出现的异常或者正常情况导致消费者取消，会向对应的消费者(信道)发送<code>basic.cancel</code>，但是由客户端信道主动向消息中间件代理发送<code>basic.cancel</code>以取消消费者的情况下不会受到消息中间件代理的<code>basic.cancel</code>回复。</p>
<p>有些情况下，客户端感知到异常(例如队列删除等)主动向消息中间件代理发送<code>basic.cancel</code>，这个时候，消息中间件代理也有可能因为队列删除主动向对应的消费者(信道)发送<code>basic.cancel</code>，也就是存在竞争，RabbitMQ代理收到前者的<code>basic.cancel</code>时不会出现异常，基于后者还是正常回复<code>basic.cancel-ok</code>。</p>
<p>举个例子，<strong>情况一：例如我们主动取消信道上的消费者</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">InitiativeBasicCancel</span> <span class="keyword">extends</span> <span class="title">BaseChannelFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		provideChannel(channel -&gt; &#123;</span><br><span class="line">			<span class="comment">// 此方法返回的是消费者的标签</span></span><br><span class="line">			String consumerTag = channel.basicConsume(<span class="string">"throwable.queue.direct"</span>, <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line"></span><br><span class="line">			&#125;);</span><br><span class="line">			channel.basicCancel(consumerTag);</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>情况二：假如我们想监听消息中间件代理异步回调的<code>basic.cancel</code>和<code>basic.cancel-ok</code>，应该这样做</strong>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AsyncBasicCancel</span> <span class="keyword">extends</span> <span class="title">BaseChannelFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		provideChannel(channel -&gt; &#123;</span><br><span class="line">			channel.basicConsume(<span class="string">"throwable.queue.direct"</span>, <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line"></span><br><span class="line">				<span class="meta">@Override</span></span><br><span class="line">				<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleCancelOk</span><span class="params">(String consumerTag)</span> </span>&#123;</span><br><span class="line">					System.out.println(<span class="string">"收到来自消息中间件代理的basic.cancel-ok回复,consumerTag="</span> + consumerTag);</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="meta">@Override</span></span><br><span class="line">				<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleCancel</span><span class="params">(String consumerTag)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">					System.out.println(<span class="string">"收到来自消息中间件代理的basic.cancel回复,consumerTag="</span> + consumerTag);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;);</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一般情况下，我们应该同时考虑情况一和情况二有可能同时发生(也就是前面说到的竞争)，并且做好相应的处理即可。</p>

      
    </div>
    <!-- 
      <div class="full-width auto-padding tags">
        
          <a href="/blog/tags/Middleware/" rel="nofollow"><i class="fas fa-tag fa-fw"></i> Middleware</a>
        
          <a href="/blog/tags/RabbitMQ/" rel="nofollow"><i class="fas fa-tag fa-fw"></i> RabbitMQ</a>
        
      </div>
     -->
  </section>
</article>

          </div>
        
      
        
          <div class='post-wrapper'>
            <article class="post white-box card-shadow  reveal ">
  


  <section class='meta'>
    
    
    <div class="meta" id="header-meta">
      
        
  <h2 class="title">
    <a href="/2018/11/25/rabbitmq-send-consume-confirm/">
      RabbitMQ消息发送、消费和确认
    </a>
  </h2>


      
      <div class='new-meta-box'>
        
          
        
          
            
  <div class='new-meta-item author'>
    
      <a href="http://throwable.club" rel="nofollow">
        
          <img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/mine/doge_avatar.jpg">
        
        <p>Throwable</p>
      </a>
    
  </div>


          
        
          
            <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-edit" aria-hidden="true"></i>
    <p>发布于：2018年11月25日</p>
  </a>
</div>

          
        
          
            
  
  <div class='new-meta-item category'>
    <a href='/blog/categories/Middleware/RabbitMQ/' rel="nofollow">
      <i class="fas fa-folder-open" aria-hidden="true"></i>
      <p>Middleware&nbsp;/&nbsp;RabbitMQ</p>
    </a>
  </div>


          
        
          
            
  <div class="new-meta-item wordcount">
    <a class='notlink'>
      <i class="fas fa-keyboard" aria-hidden="true"></i>
      <p>字数：6.1k字</p>
    </a>
  </div>
  <div class="new-meta-item readtime">
    <a class='notlink'>
      <i class="fas fa-hourglass-half" aria-hidden="true"></i>
      <p>时长：25分钟</p>
    </a>
  </div>


          
        
          
            <div class="new-meta-item date" itemprop="dateUpdated" datetime="2018-11-25T22:13:55+08:00">
  <a class='notlink'>
    <i class="fas fa-save" aria-hidden="true"></i>
    <p>更新于：2018年11月25日</p>
  </a>
</div>

          
        
          
            

          
        
          
            

          
        
      </div>
      
        <hr>
      
    </div>
  </section>


  <section class="article typo">
    <div class="article-entry" itemprop="articleBody">
      <h1>前提</h1>
<p>前一篇文章介绍到RabbitMQ相关组件的声明，组件声明完成之后，就可以发送消息和消费消息，消费消息的时候需要考虑消息的确认。</p>
<h2 id="消息的发送">消息的发送</h2>
<p>消息的发送只依赖于交互器(名称)、可选路由键和可选的Header参数，可选路由键和Header可以认为是路由参数。因为RabbitMQ有四种内建的交换器，加上特殊的默认交换器可以认为有五种，这里列举一下通过这五种交换器发送消息需要的参数：</p>
<table>
<thead>
<tr>
<th style="text-align:center">交换器类型</th>
<th style="text-align:center">路由参数</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">默认交换器(AMQP default)</td>
<td style="text-align:center">交换器名称(空字符串)和队列名称</td>
</tr>
<tr>
<td style="text-align:center">Direct交换器</td>
<td style="text-align:center">交换器名称和路由键</td>
</tr>
<tr>
<td style="text-align:center">Fanout交换器</td>
<td style="text-align:center">交换器名称(API中必须提供路由键，可以随意输入)</td>
</tr>
<tr>
<td style="text-align:center">Topic交换器</td>
<td style="text-align:center">交换器名称和路由键</td>
</tr>
<tr>
<td style="text-align:center">Headers交换器</td>
<td style="text-align:center">交换器名称和Header参数(API中必须提供路由键，可以随意输入)</td>
</tr>
</tbody>
</table>
<p>消息的发布依赖于Channel的<code>basicPublish</code>方法，按照惯例查看其重载方法中参数列表长度最大的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">basicPublish</span><span class="params">(String exchange, </span></span></span><br><span class="line"><span class="function"><span class="params">                  String routingKey, </span></span></span><br><span class="line"><span class="function"><span class="params">                  <span class="keyword">boolean</span> mandatory, </span></span></span><br><span class="line"><span class="function"><span class="params">                  <span class="keyword">boolean</span> immediate, </span></span></span><br><span class="line"><span class="function"><span class="params">                  BasicProperties props, </span></span></span><br><span class="line"><span class="function"><span class="params">                  <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>exchange：交换器名称。</li>
<li>routingKey：路由键。</li>
<li>mandatory：是否强制的，如果此属性设置为true，消息发布的时候如果根据exchange和routingKey无法找到可达的目标队列，会调用AMQP方法<code>basic.return</code>将该消息返回给消息发布者；如果此属性设置为false，出现上面的情况，消息会被消息中间件代理直接丢弃。</li>
<li>immediate：是否立即的，如果此属性设置为true，消息通过exchange和routingKey找到目标队列(一个或者多个)，如果所有的目标队列都没有消费者，那么会调用AMQP方法<code>basic.return</code>将该消息返回给消息发布者。</li>
<li>props：BasicProperties类型，消息属性或者叫消息元数据，<code>com.rabbitmq.client.MessageProperties</code>已经提供了一些列的实现，如果不满足可以使用<code>BasicProperties.Builder</code>自行构建。</li>
<li>body：字节数组类型，消息的有效负载，一般我们说的消息或者消息体就是指这个。</li>
</ul>
<p>值得注意的是：<code>immediate</code>属性在<a href="http://www.rabbitmq.com/blog/2012/11/19/breaking-things-with-rabbitmq-3-0/" target="_blank" rel="noopener">RabbitMQ-3.0版本已经被移除</a>，具体原因是：</p>
<p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/r-m-s-c-c/r-m-s-c-c-1.png" alt="r-m-s-c-c-1.png"></p>
<p>翻译一下就是：<code>immediate</code>属性原有的功能对于基础代码的复杂性太高，特别是在镜像队列的条件下。它还影响到镜像队列的性能优化，推荐使用TTL(Time To Live，队列消息过期特性)或者DLX(Dead Letter Exchange，死信交换器)替代。<strong>在RabbitMQ-3.0后的版本如果immediate设置为true，会抛异常。</strong></p>
<p>举个消息发送的例子(<strong>下面的例子中，每次发送之前都声明交换器、队列和绑定，实际上我们不需要这样操作，如果依赖于Servlet容器，可以在容器启动之后做一次声明即可</strong>)：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageSendMain</span> <span class="keyword">extends</span> <span class="title">BaseChannelFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DEFAULT_EXCHANGE = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		provideChannel(channel -&gt; &#123;</span><br><span class="line">			<span class="comment">//使用Direct类型的交换器</span></span><br><span class="line">			channel.queueDeclare(<span class="string">"throwable.queue.direct"</span>, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">			channel.exchangeDeclare(<span class="string">"throwable.exchange.direct"</span>, BuiltinExchangeType.DIRECT, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">			channel.queueBind(<span class="string">"throwable.queue.direct"</span>, <span class="string">"throwable.exchange.direct"</span>, <span class="string">"direct.routingKey"</span>, <span class="keyword">null</span>);</span><br><span class="line">			<span class="comment">//发送"Direct Message"到队列throwable.queue.direct</span></span><br><span class="line">			channel.basicPublish(<span class="string">"throwable.exchange.direct"</span>, <span class="string">"direct.routingKey"</span>,</span><br><span class="line">					MessageProperties.TEXT_PLAIN, <span class="string">"Direct Message"</span>.getBytes(StandardCharsets.UTF_8));</span><br><span class="line"></span><br><span class="line">			<span class="comment">//其实也可以通过默认的交换器直接发送消息到队列throwable.queue.direct</span></span><br><span class="line">			channel.basicPublish(DEFAULT_EXCHANGE, <span class="string">"throwable.queue.direct"</span>,</span><br><span class="line">					MessageProperties.TEXT_PLAIN, <span class="string">"Direct Message"</span>.getBytes(StandardCharsets.UTF_8));</span><br><span class="line"></span><br><span class="line">			<span class="comment">//使用Fanout类型的交换器</span></span><br><span class="line">			channel.queueDeclare(<span class="string">"throwable.queue.fanout"</span>, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">			channel.exchangeDeclare(<span class="string">"throwable.exchange.fanout"</span>, BuiltinExchangeType.FANOUT, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">			<span class="comment">//这里路由键随便写，或者用空字符串也可以</span></span><br><span class="line">			channel.queueBind(<span class="string">"throwable.queue.fanout"</span>, <span class="string">"throwable.exchange.fanout"</span>, <span class="string">"random"</span>, <span class="keyword">null</span>);</span><br><span class="line">			channel.basicPublish(<span class="string">"throwable.exchange.fanout"</span>, <span class="string">"random"</span>,</span><br><span class="line">					MessageProperties.TEXT_PLAIN, <span class="string">"Fanout Message"</span>.getBytes(StandardCharsets.UTF_8));</span><br><span class="line"></span><br><span class="line">			<span class="comment">//使用Topic类型的交换器</span></span><br><span class="line">			channel.queueDeclare(<span class="string">"throwable.queue.topic"</span>, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">			channel.exchangeDeclare(<span class="string">"throwable.exchange.topic"</span>, BuiltinExchangeType.TOPIC, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">			channel.queueBind(<span class="string">"throwable.queue.topic"</span>, <span class="string">"throwable.exchange.topic"</span>, <span class="string">"topic.routingKey.#"</span>, <span class="keyword">null</span>);</span><br><span class="line">			channel.basicPublish(<span class="string">"throwable.exchange.topic"</span>, <span class="string">"topic.routingKey.throwable"</span>,</span><br><span class="line">					MessageProperties.TEXT_PLAIN, <span class="string">"Topic Message"</span>.getBytes(StandardCharsets.UTF_8));</span><br><span class="line"></span><br><span class="line">			<span class="comment">//使用Headers类型的交换器</span></span><br><span class="line">			channel.queueDeclare(<span class="string">"throwable.queue.headers"</span>, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">			channel.exchangeDeclare(<span class="string">"throwable.exchange.headers"</span>, BuiltinExchangeType.HEADERS, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">			Map&lt;String, Object&gt; headerBindingArgs = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">8</span>);</span><br><span class="line">			headerBindingArgs.put(<span class="string">"headers.name"</span>, <span class="string">"throwable"</span>);</span><br><span class="line">			headerBindingArgs.put(<span class="string">"headers.age"</span>, <span class="number">25</span>);</span><br><span class="line">			headerBindingArgs.put(<span class="string">"x-match"</span>, <span class="string">"all"</span>);</span><br><span class="line">			<span class="comment">//这里路由键随便写，或者用空字符串也可以,要添加Headers参数到绑定参数中</span></span><br><span class="line">			channel.queueBind(<span class="string">"throwable.queue.headers"</span>, <span class="string">"throwable.exchange.headers"</span>, <span class="string">"random"</span>, headerBindingArgs);</span><br><span class="line">			AMQP.BasicProperties basicProperties = MessageProperties.TEXT_PLAIN;</span><br><span class="line">			<span class="comment">//这里发送消息的时候要添加Headers参数到消息属性中</span></span><br><span class="line">			AMQP.BasicProperties realBasicProperties = basicProperties.builder().headers(headerBindingArgs).build();</span><br><span class="line">			channel.basicPublish(<span class="string">"throwable.exchange.headers"</span>, <span class="string">"random"</span>,</span><br><span class="line">					realBasicProperties, <span class="string">"Headers Message"</span>.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="消息的元数据">消息的元数据</h3>
<p>消息元数据接口是<code>com.rabbitmq.client.BasicProperties</code>，实现类是<code>com.rabbitmq.client.AMQP$BasicProperties</code>，可以看一下具体的属性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">BasicProperties</span> <span class="keyword">extends</span> <span class="title">com</span>.<span class="title">rabbitmq</span>.<span class="title">client</span>.<span class="title">impl</span>.<span class="title">AMQBasicProperties</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String contentType;</span><br><span class="line">    <span class="keyword">private</span> String contentEncoding;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String,Object&gt; headers;</span><br><span class="line">    <span class="keyword">private</span> Integer deliveryMode;</span><br><span class="line">    <span class="keyword">private</span> Integer priority;</span><br><span class="line">    <span class="keyword">private</span> String correlationId;</span><br><span class="line">    <span class="keyword">private</span> String replyTo;</span><br><span class="line">    <span class="keyword">private</span> String expiration;</span><br><span class="line">    <span class="keyword">private</span> String messageId;</span><br><span class="line">    <span class="keyword">private</span> Date timestamp;</span><br><span class="line">    <span class="keyword">private</span> String type;</span><br><span class="line">    <span class="keyword">private</span> String userId;</span><br><span class="line">    <span class="keyword">private</span> String appId;</span><br><span class="line">    <span class="keyword">private</span> String clusterId;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//省略Setter、Getter和Builder方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>属性分析：</p>
<ul>
<li>contentType：消息内容类型，类似于HTTP协议中的Content-Type，例如：application/json。</li>
<li>contentEncoding：消息内容编码，类似于MIME的内容编码，例如：gzip。</li>
<li>headers：头部属性，K-V结构，一般使用在Headers的交换器和绑定中，很多时候被开发者滥用用来传输一些自定义属性，其实也无可厚非。</li>
<li>deliveryMode：<strong>消息的持久化模式，deliveryMode=1代表消息不持久化(nonpersistent)，deliveryMode=2代表消息持久化(persistent)。</strong></li>
<li>priority：消息优先级，可选值为0-255，值越大优先级越大，注意要和队列的优先级区分。</li>
<li>correlationId：客户端定义的用于客户端区分和标识消息的唯一标记。</li>
<li>replyTo：需要应答的目标队列名，只有一个持有值，不会有任何额外的操作，spring-amqp模块对这个值做了额外的操作，不要混淆原生Java驱动和二次封装的框架。</li>
<li>expiration：消息过期时间，单位为毫秒。</li>
<li>messageId：消息的唯一标识，消息中间件代理对消息接收去重的一个重要标识。</li>
<li>timestamp：消息发送时的时间戳。</li>
<li>type：可选的消息类型。</li>
<li>userId：可选的发布消息的用户的唯一标识。</li>
<li>appId：可选的发布消息的应用的唯一标识。</li>
<li>clusterId：集群唯一标识，AMQP-0-9-1已经弃用，供RabbitMQ集群应用程序使用的集群内路由标识符。</li>
</ul>
<p><strong>消息元数据的每个属性基本对应着AMQP规范中的属性值，以上的描述来源于AMQP协议，RabbitMQ中的实现要自行实践相关的属性</strong>。<code>com.rabbitmq.client.MessageProperties</code>中已经有几个现成的<code>BasicProperties</code>实例，如果合适的话可以直接拿过来使用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageProperties</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Empty basic properties, with no fields set */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> BasicProperties MINIMAL_BASIC =</span><br><span class="line">        <span class="keyword">new</span> BasicProperties(<span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>,</span><br><span class="line">                            <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>,</span><br><span class="line">                            <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>,</span><br><span class="line">                            <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    <span class="comment">/** Empty basic properties, with only deliveryMode set to 2 (persistent) */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> BasicProperties MINIMAL_PERSISTENT_BASIC =</span><br><span class="line">        <span class="keyword">new</span> BasicProperties(<span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="number">2</span>,</span><br><span class="line">                            <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>,</span><br><span class="line">                            <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>,</span><br><span class="line">                            <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Content-type "application/octet-stream", deliveryMode 1 (nonpersistent), priority zero */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> BasicProperties BASIC =</span><br><span class="line">        <span class="keyword">new</span> BasicProperties(<span class="string">"application/octet-stream"</span>,</span><br><span class="line">                            <span class="keyword">null</span>,</span><br><span class="line">                            <span class="keyword">null</span>,</span><br><span class="line">                            <span class="number">1</span>,</span><br><span class="line">                            <span class="number">0</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>,</span><br><span class="line">                            <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>,</span><br><span class="line">                            <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Content-type "application/octet-stream", deliveryMode 2 (persistent), priority zero */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> BasicProperties PERSISTENT_BASIC =</span><br><span class="line">        <span class="keyword">new</span> BasicProperties(<span class="string">"application/octet-stream"</span>,</span><br><span class="line">                            <span class="keyword">null</span>,</span><br><span class="line">                            <span class="keyword">null</span>,</span><br><span class="line">                            <span class="number">2</span>,</span><br><span class="line">                            <span class="number">0</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>,</span><br><span class="line">                            <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>,</span><br><span class="line">                            <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Content-type "text/plain", deliveryMode 1 (nonpersistent), priority zero */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> BasicProperties TEXT_PLAIN =</span><br><span class="line">        <span class="keyword">new</span> BasicProperties(<span class="string">"text/plain"</span>,</span><br><span class="line">                            <span class="keyword">null</span>,</span><br><span class="line">                            <span class="keyword">null</span>,</span><br><span class="line">                            <span class="number">1</span>,</span><br><span class="line">                            <span class="number">0</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>,</span><br><span class="line">                            <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>,</span><br><span class="line">                            <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Content-type "text/plain", deliveryMode 2 (persistent), priority zero */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> BasicProperties PERSISTENT_TEXT_PLAIN =</span><br><span class="line">        <span class="keyword">new</span> BasicProperties(<span class="string">"text/plain"</span>,</span><br><span class="line">                            <span class="keyword">null</span>,</span><br><span class="line">                            <span class="keyword">null</span>,</span><br><span class="line">                            <span class="number">2</span>,</span><br><span class="line">                            <span class="number">0</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>,</span><br><span class="line">                            <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>,</span><br><span class="line">                            <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="mandatory属性的作用">mandatory属性的作用</h3>
<p>mandatory属性主要是用于消息发送路由失败后配置消息返回(return)功能使用，可以故意造一下消息发布路由失败的场景，验证一下mandatory属性的作用。之前的例子中曾经建立过一个Direct类型的交换<code>throwable.exchange.direct</code>和队列<code>throwable.queue.direct</code>基于路由键<code>direct.routingKey</code>进行了绑定，我们开启mandatory特性，故意把路由键弄错，看效果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MandatoryMain</span> <span class="keyword">extends</span> <span class="title">BaseChannelFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		provideChannel(channel -&gt; &#123;</span><br><span class="line">			channel.basicPublish(<span class="string">"throwable.exchange.direct"</span>, <span class="string">"doge"</span>,</span><br><span class="line">					<span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">null</span>, <span class="string">"Mandatory Message"</span>.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">			<span class="comment">//使用addReturnListener(ReturnCallBack)也可以</span></span><br><span class="line">			channel.addReturnListener(<span class="keyword">new</span> ReturnListener() &#123;</span><br><span class="line">				<span class="meta">@Override</span></span><br><span class="line">				<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleReturn</span><span class="params">(<span class="keyword">int</span> replyCode, String replyText,</span></span></span><br><span class="line"><span class="function"><span class="params">										 String exchange,</span></span></span><br><span class="line"><span class="function"><span class="params">										 String routingKey,</span></span></span><br><span class="line"><span class="function"><span class="params">										 AMQP.BasicProperties properties,</span></span></span><br><span class="line"><span class="function"><span class="params">										 <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">					StringBuilder builder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">					builder.append(<span class="string">"返回码:"</span>).append(replyCode).append(<span class="string">"\n"</span>);</span><br><span class="line">					builder.append(<span class="string">"返回信息:"</span>).append(replyText).append(<span class="string">"\n"</span>);</span><br><span class="line">					builder.append(<span class="string">"交换器:"</span>).append(exchange).append(<span class="string">"\n"</span>);</span><br><span class="line">					builder.append(<span class="string">"路由键:"</span>).append(routingKey).append(<span class="string">"\n"</span>);</span><br><span class="line">					builder.append(<span class="string">"消息体:"</span>).append(<span class="keyword">new</span> String(body, StandardCharsets.UTF_8));</span><br><span class="line">					System.out.println(builder.toString());</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;);</span><br><span class="line">			<span class="comment">//因为是异步回调,这里要sleep一下</span></span><br><span class="line">			Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行之后，控制台打印：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">返回码:<span class="number">312</span></span><br><span class="line">返回信息:NO_ROUTE</span><br><span class="line">交换器:throwable.exchange.direct</span><br><span class="line">路由键:doge</span><br><span class="line">消息体:Mandatory Message</span><br></pre></td></tr></table></figure>
<p>可见路由失败的消息直接原样返回，这样就能确保路由错误的情况下消息也不会丢失。</p>
<h3 id="消息发送的确认机制">消息发送的确认机制</h3>
<p>前面提到的mandatory属性和消息返回机制能保证路由失败的消息也不丢失，实际上消息发送的时候允许使用消息发送确认(Confirm)机制，这样可以确认客户端发送的消息是否已经到达了消息中间件代理。消息发送的确认机制主要包括轻量级的确认和消息事务，这一小节介绍一下轻量级的确认。消息发送的轻量级确认需要把信道(Channel)更变为Confirm模式，通过等待消息中间件代理消息是否到达的确认回调，依赖到的方法或者类如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//信道更变为Confirm模式</span></span><br><span class="line">Confirm.<span class="function">SelectOk <span class="title">confirmSelect</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//等待消息中间件确认消息到达 - 同步阻塞法法</span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">waitForConfirms</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//等待消息中间件确认消息到达，可以设置超时，单位毫秒 - 同步阻塞方法</span></span><br><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">waitForConfirms</span><span class="params">(<span class="keyword">long</span> timeout)</span> <span class="keyword">throws</span> InterruptedException, TimeoutException</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//等待消息中间件确认消息到达，存在任一消息未到达，则抛出IOException - 同步阻塞方法</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">waitForConfirmsOrDie</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InterruptedException</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//等待消息中间件确认消息到达，可以设置超时，单位毫秒，存在任一消息未到达，则抛出IOException - 同步阻塞方法</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">waitForConfirmsOrDie</span><span class="params">(<span class="keyword">long</span> timeout)</span> <span class="keyword">throws</span> IOException, InterruptedException, TimeoutException</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//消息发布确认回调接口</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ConfirmListener</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">handleAck</span><span class="params">(<span class="keyword">long</span> deliveryTag, <span class="keyword">boolean</span> multiple)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">handleNack</span><span class="params">(<span class="keyword">long</span> deliveryTag, <span class="keyword">boolean</span> multiple)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>消息发送确认模式开启之后，每条消息都会基于同一个信道下新增一个投递标签(deliveryTag)属性，deliveryTag属性是从1开始递增的整数，只要新建一个信道实例就会重置为1，<strong>一定要十分注意，这个消息投递标签和消息消费中的信封(Envelope)中的deliveryTag不是同一个属性，后者虽然也是从1开始递增，但是它是基于队列而不是信道</strong>。举个简单的使用例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfirmMain</span> <span class="keyword">extends</span> <span class="title">BaseChannelFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		provideChannel(channel -&gt; &#123;</span><br><span class="line">			channel.addConfirmListener(<span class="keyword">new</span> ConfirmListener() &#123;</span><br><span class="line">				<span class="meta">@Override</span></span><br><span class="line">				<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleAck</span><span class="params">(<span class="keyword">long</span> deliveryTag, <span class="keyword">boolean</span> multiple)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">					System.out.println(String.format(<span class="string">"消息发送确认回调成功,序号:%s,是否批量:%s"</span>, deliveryTag, multiple));</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="meta">@Override</span></span><br><span class="line">				<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleNack</span><span class="params">(<span class="keyword">long</span> deliveryTag, <span class="keyword">boolean</span> multiple)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">					System.out.println(String.format(<span class="string">"消息发送确认回调失败,序号:%s,是否批量:%s"</span>, deliveryTag, multiple));</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;);</span><br><span class="line">			channel.confirmSelect();</span><br><span class="line">			channel.basicPublish(<span class="string">"throwable.exchange.direct"</span>, <span class="string">"direct.routingKey"</span>,</span><br><span class="line">					MessageProperties.TEXT_PLAIN, <span class="string">"Direct Message"</span>.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">			<span class="keyword">if</span> (!channel.waitForConfirms()) &#123;</span><br><span class="line">				System.out.println(<span class="string">"消息发送确认失败!"</span>);</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				System.out.println(<span class="string">"消息发送确认成功!"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">			Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>消息发布确认基本上是遵循下面的代码模板：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">channel.addConfirmListener(<span class="keyword">new</span> ConfirmListener() &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;;</span><br><span class="line">channel.confirmSelect();</span><br><span class="line">channel.basicPublish();</span><br><span class="line"><span class="keyword">if</span> (!channel.waitForConfirms()) &#123;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当然，这里演示的仅仅是单条的消息发布确认，这种做法性能会相对低下，但是可靠性会提高，编码难度也相对比较低。</p>
<h3 id="消息发布事务">消息发布事务</h3>
<p>消息发布事务能够保证消息发布到RabbitMQ的Broker这个动作是一个原子操作，也就是开启了消息发布事务模式，消息能明确知道发布成功或者失败。使用消息发布事务需要把信道转换为事务模式，然后进行消息发布和事务提交(或者回滚)，依赖于下面的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//信道转换为事务模式</span></span><br><span class="line">Tx.<span class="function">SelectOk <span class="title">txSelect</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//提交事务</span></span><br><span class="line">Tx.<span class="function">CommitOk <span class="title">txCommit</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//回滚事务</span></span><br><span class="line">Tx.<span class="function">RollbackOk <span class="title">txRollback</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br></pre></td></tr></table></figure>
<p>消息发布事务的基本代码模板如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123; </span><br><span class="line">      channel.txSelect();</span><br><span class="line">	  channel.basicPublish();</span><br><span class="line">	  channel.txCommit();</span><br><span class="line">	&#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">	  channel.txRollback();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>举个简单的例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessagePublishTxMain</span> <span class="keyword">extends</span> <span class="title">BaseChannelFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		provideChannel(channel -&gt; &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				channel.txSelect();</span><br><span class="line">				channel.basicPublish(<span class="string">"throwable.exchange.direct"</span>, <span class="string">"direct.routingKey"</span>,</span><br><span class="line">						MessageProperties.TEXT_PLAIN, <span class="string">"Direct Message"</span>.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">				channel.txCommit();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">				channel.txRollback();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一般来说，事物基本是遵循&quot;等价交换的原则&quot;，消息发布的可靠性是需要性能换取的，消息发布事务的可靠性是最高的，但是代价是它的性能是比较低的。</p>
<h2 id="消息的消费">消息的消费</h2>
<p>消息消费主要包括推模式和拉模式，区别如下：</p>
<ul>
<li>推模式：客户端注册消费者到消息中间件代理的队列，也就是对队列进行订阅，消息中间件代理通过队列投递(deliver)消息到消费者中，典型方法是<code>basic-consume</code>。</li>
<li>拉模式：客户端主动向消息中间件代理拉取队列中的消息，典型方法是<code>basic-get</code>。</li>
</ul>
<h3 id="消息消费之推模式">消息消费之推模式</h3>
<p>推模式下，消息的消费依赖于Channel的<code>basicConsume</code>方法(用的是最新的RabbitMQ的Java驱动，关于消息消费的方法新增了不少，在3.X版本只有几个方法)：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">String <span class="title">basicConsume</span><span class="params">(String queue,</span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">boolean</span> autoAck, </span></span></span><br><span class="line"><span class="function"><span class="params">                    String consumerTag, </span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">boolean</span> noLocal, </span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">boolean</span> exclusive, </span></span></span><br><span class="line"><span class="function"><span class="params">                    Map&lt;String, Object&gt; arguments, </span></span></span><br><span class="line"><span class="function"><span class="params">                    Consumer callback)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line"><span class="function">String <span class="title">basicConsume</span><span class="params">(String queue, </span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">boolean</span> autoAck, </span></span></span><br><span class="line"><span class="function"><span class="params">                    String consumerTag, </span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">boolean</span> noLocal, </span></span></span><br><span class="line"><span class="function"><span class="params">                    <span class="keyword">boolean</span> exclusive, </span></span></span><br><span class="line"><span class="function"><span class="params">                    Map&lt;String, Object&gt; arguments, </span></span></span><br><span class="line"><span class="function"><span class="params">                    DeliverCallback deliverCallback, </span></span></span><br><span class="line"><span class="function"><span class="params">                    CancelCallback cancelCallback, </span></span></span><br><span class="line"><span class="function"><span class="params">                    ConsumerShutdownSignalCallback shutdownSignalCallback)</span> <span class="keyword">throws</span> IOException</span>;</span><br></pre></td></tr></table></figure>
<p>别看第二个方法的参数列表很庞大很吓人，它只是把<code>com.rabbitmq.client.Consumer</code>接口的部分方法拆解出来做成单独的接口，方便使用Lambda表达式，参数分析如下：</p>
<ul>
<li>queue：消费者订阅的队列名称。</li>
<li>autoAck：是否自动确认(主动ack)。</li>
<li>consumerTag：消费者标签，队列中消费者的唯一标识，如果不指定则由消息中间件代理自动生成，停止消费者和取消消费者都是基于此标识属性。</li>
<li>noLocal：是否非本地的，如果此属性为true，则消息中间件代理不会投递消息到此消费者如果发布消息使用的连接和当前消费者建立的通道所在的连接是同一个连接，但是RabbitMQ不支持此属性。</li>
<li>exclusive：是否独占(排他)的，如果此属性为true，队列中只能有一个消费者(也就是当前设置了exclusive=true的消费者)，消费者关闭(shutdown)</li>
<li>arguments：消费者参数，K-V结构。</li>
</ul>
<p>下面看一下<code>Consumer</code>、<code>DeliverCallback</code>、<code>CancelCallback</code>和<code>ConsumerShutdownSignalCallback</code>的定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Consumer</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//创建消费者成功的回调</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">handleConsumeOk</span><span class="params">(String consumerTag)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//消费者取消成功的回调 - 主动调用basicCancel或者队列删除等因素</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">handleCancelOk</span><span class="params">(String consumerTag)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//消费者取消的回调 - 主动调用basicCancel或者队列删除等因素</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">handleCancel</span><span class="params">(String consumerTag)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//消费者关闭的信号回调</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">handleShutdownSignal</span><span class="params">(String consumerTag, ShutdownSignalException sig)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//AMQP方法basic.recover-ok的回调</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">handleRecoverOk</span><span class="params">(String consumerTag)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//消息推模式下接受消息中间件代理投递的消息 - 核心方法</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag,</span></span></span><br><span class="line"><span class="function"><span class="params">                        Envelope envelope,</span></span></span><br><span class="line"><span class="function"><span class="params">                        AMQP.BasicProperties properties,</span></span></span><br><span class="line"><span class="function"><span class="params">                        <span class="keyword">byte</span>[] body)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DeliverCallback</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//Delivery中持有了Envelope、AMQP.BasicProperties和消息体body</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">handle</span><span class="params">(String consumerTag, Delivery message)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CancelCallback</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">handle</span><span class="params">(String consumerTag)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ConsumerShutdownSignalCallback</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">void</span> <span class="title">handleShutdownSignal</span><span class="params">(String consumerTag, ShutdownSignalException sig)</span></span>; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>DeliverCallback</code>、<code>CancelCallback</code>和<code>ConsumerShutdownSignalCallback</code>实际上就是把<code>Consumer</code>接口中的部分方法抽离出来编写为函数式接口，没有特别的东西，所以我们还是关注<code>Consumer</code>接口的使用就可以了。<code>Consumer</code>接口有一个默认的实现类<code>DefaultConsumer</code>，可以直接使用。在旧版本的Java驱动中还存在一个废弃的<code>QueueingConsumer</code>，在5.X版本的驱动已经删除该类。其实，我们也可以自行实现<code>Consumer</code>接口，因为<code>DefaultConsumer</code>也仅仅是对<code>Consumer</code>接口进行了空实现，具体的方法还是需要我们覆盖实现自定义的逻辑。这里举个简单的使用例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumeMain</span> <span class="keyword">extends</span> <span class="title">BaseChannelFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		provideChannel(channel -&gt; &#123;</span><br><span class="line">			channel.basicConsume(<span class="string">"throwable.queue.direct"</span>, <span class="keyword">true</span>, <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">				<span class="meta">@Override</span></span><br><span class="line">				<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag,</span></span></span><br><span class="line"><span class="function"><span class="params">										   Envelope envelope,</span></span></span><br><span class="line"><span class="function"><span class="params">										   AMQP.BasicProperties properties,</span></span></span><br><span class="line"><span class="function"><span class="params">										   <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">					System.out.println(<span class="string">"消息序号:"</span> + envelope.getDeliveryTag());</span><br><span class="line">					System.out.println(<span class="string">"交换器:"</span> + envelope.getExchange());</span><br><span class="line">					System.out.println(<span class="string">"路由键:"</span> + envelope.getRoutingKey());</span><br><span class="line">					System.out.println(<span class="string">"消息内容:"</span> + <span class="keyword">new</span> String(body, StandardCharsets.UTF_8));</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;);</span><br><span class="line">			<span class="comment">//消息消费是异步的，要想办法阻塞消费者所在的线程和主线程，否则会退出</span></span><br><span class="line">			Thread.sleep(Integer.MAX_VALUE);</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/r-m-s-c-c/r-m-s-c-c-2.png" alt="r-m-s-c-c-2.png"></p>
<p>可以从Web管理界面看到消费者已经启动，消费者标签是由RabbitMQ代理随机生成的，我们开启了消息自动确认，所以Ack required一栏是空心的圆形，也就是不需要进行消息消费确认。还有一点需要注意的是：<strong><code>Consumer</code>接口的回调也就是<code>DefaultConsumer</code>中的方法回调是委托到RabbitMQ的Java驱动中的线程池执行，过程是异步的，也就是我们在写Demo的时候需要想办法挂起<code>DefaultConsumer</code>实例所在的线程和主线程，否则会导致线程退出无法消费消息</strong>。</p>
<h3 id="消息消费之拉模式">消息消费之拉模式</h3>
<p>拉模式下，消息消费主要依赖于Channel的<code>basicGet</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">GetResponse <span class="title">basicGet</span><span class="params">(String queue, <span class="keyword">boolean</span> autoAck)</span> <span class="keyword">throws</span> IOException</span>;</span><br></pre></td></tr></table></figure>
<p>此方法很简单，只依赖于队列名称和是否自动确认两个参数，如果autoAck为false，需要手动确认。返回值如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GetResponse</span> </span>&#123;</span><br><span class="line">    <span class="comment">//信封对象，主要用于获取消息的投递标签DeliveryTag、交换器、路由键等</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Envelope envelope;</span><br><span class="line">    <span class="comment">//消息元数据</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> BasicProperties props;</span><br><span class="line">    <span class="comment">//消息体</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] body;</span><br><span class="line">    <span class="comment">//当前队列中剩余消息数量，只是个参考值</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> messageCount;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//省略Getter方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>信封对象中的投递标签DeliveryTag很重要，用于手动确认的时候指定对应的值。举个简单的使用例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BasicGetMain</span> <span class="keyword">extends</span> <span class="title">BaseChannelFactory</span></span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">	       provideChannel(channel -&gt; &#123;</span><br><span class="line">			   GetResponse getResponse = channel.basicGet(<span class="string">"throwable.queue.direct"</span>, <span class="keyword">true</span>);</span><br><span class="line">			   System.out.println(String.format(<span class="string">"消息内容:%s,消息序号:%s"</span>, <span class="keyword">new</span> String(getResponse.getBody(), StandardCharsets.UTF_8),</span><br><span class="line">					   getResponse.getEnvelope().getDeliveryTag()));</span><br><span class="line">		   &#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="消息消费的确认机制">消息消费的确认机制</h2>
<p>消息消费的确认机制保障消息中间件代理的消息成功投递到消费者中，主要包括三种类确认：</p>
<ul>
<li>主动积极确认：主动积极确认成功后，消息会从队列中移除，支持批量确认操作，典型方法是<code>basic-ack</code>，下面直接叫ack。</li>
<li>主动消极确认：消极积极确认成功后，基于<code>basic-get</code>或者<code>basic-consume</code>等到的消息标签，可以选择消息重新入队列或者直接丢弃，支持批量操作，典型方法是<code>basic-nack</code>，下面直接叫nack。</li>
<li>拒绝：基于<code>basic-get</code>或者<code>basic-consume</code>等到的消息标签进行消息拒绝，可以选择丢弃或者重新入队，下面叫做reject。</li>
</ul>
<p>nack和reject的基本功能是相同的，nack同时支持批量操作和单条操作，而reject只支持单条操作。消息消费确认其实是手动确认，如果针对的是<code>basicConsume</code>方法，则其autoAck属性需要设置为false，否则有可能会出现重复确认导致异常。</p>
<h3 id="ack">ack</h3>
<p>ack依赖于Channel的<code>basicAck</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">basicAck</span><span class="params">(<span class="keyword">long</span> deliveryTag, <span class="keyword">boolean</span> multiple)</span> <span class="keyword">throws</span> IOException</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>deliveryTag：Envelope(信封)对象中的消息标签。</li>
<li>multiple：是否使用批量积极确认，如果此属性为true，则消息标签小于当前deliveryTag的所有消息都会被主动积极确认，不了解此属性最好使用false。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AckMain</span> <span class="keyword">extends</span> <span class="title">BaseChannelFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		provideChannel(channel -&gt; &#123;</span><br><span class="line">			<span class="comment">//这里autoAck设置为false</span></span><br><span class="line">			channel.basicConsume(<span class="string">"throwable.queue.direct"</span>, <span class="keyword">false</span>, <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">				<span class="meta">@Override</span></span><br><span class="line">				<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag,</span></span></span><br><span class="line"><span class="function"><span class="params">										   Envelope envelope,</span></span></span><br><span class="line"><span class="function"><span class="params">										   AMQP.BasicProperties properties,</span></span></span><br><span class="line"><span class="function"><span class="params">										   <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">					System.out.println(<span class="string">"消息序号:"</span> + envelope.getDeliveryTag());</span><br><span class="line">					System.out.println(<span class="string">"交换器:"</span> + envelope.getExchange());</span><br><span class="line">					System.out.println(<span class="string">"路由键:"</span> + envelope.getRoutingKey());</span><br><span class="line">					System.out.println(<span class="string">"消息内容:"</span> + <span class="keyword">new</span> String(body, StandardCharsets.UTF_8));</span><br><span class="line">					channel.basicAck(envelope.getDeliveryTag(), <span class="keyword">false</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;);</span><br><span class="line">			<span class="comment">//消息消费是异步的，要想办法阻塞消费者所在的线程和主线程，否则会退出</span></span><br><span class="line">			Thread.sleep(Integer.MAX_VALUE);</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="nack">nack</h3>
<p>nack依赖于Channel的<code>basicNack</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">basicNack</span><span class="params">(<span class="keyword">long</span> deliveryTag, <span class="keyword">boolean</span> multiple, <span class="keyword">boolean</span> requeue)</span> <span class="keyword">throws</span> IOException</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>deliveryTag：Envelope(信封)对象中的消息标签。</li>
<li>multiple：是否使用批量消极确认，如果此属性为true，则消息标签小于当前deliveryTag的所有消息都会被主动消极确认，不了解此属性最好使用false。</li>
<li>requeue：是否重新入队，如果此属性为true，消息会被重新放置回去对应队列(如果可能的话，会放回到原来的位置)，如果此属性为false，消息直接被丢弃。</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NackMain</span> <span class="keyword">extends</span> <span class="title">BaseChannelFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		provideChannel(channel -&gt; &#123;</span><br><span class="line">			<span class="comment">//这里autoAck设置为false</span></span><br><span class="line">			channel.basicConsume(<span class="string">"throwable.queue.direct"</span>, <span class="keyword">false</span>, <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">				<span class="meta">@Override</span></span><br><span class="line">				<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag,</span></span></span><br><span class="line"><span class="function"><span class="params">										   Envelope envelope,</span></span></span><br><span class="line"><span class="function"><span class="params">										   AMQP.BasicProperties properties,</span></span></span><br><span class="line"><span class="function"><span class="params">										   <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">					System.out.println(<span class="string">"消息序号:"</span> + envelope.getDeliveryTag());</span><br><span class="line">					System.out.println(<span class="string">"交换器:"</span> + envelope.getExchange());</span><br><span class="line">					System.out.println(<span class="string">"路由键:"</span> + envelope.getRoutingKey());</span><br><span class="line">					System.out.println(<span class="string">"消息内容:"</span> + <span class="keyword">new</span> String(body, StandardCharsets.UTF_8));</span><br><span class="line">					channel.basicNack(envelope.getDeliveryTag(), <span class="keyword">false</span>, <span class="keyword">false</span>);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;);</span><br><span class="line">			<span class="comment">//消息消费是异步的，要想办法阻塞消费者所在的线程和主线程，否则会退出</span></span><br><span class="line">			Thread.sleep(Integer.MAX_VALUE);</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>属性<code>requeue</code>如果设置为true，需要谨慎设计程序的逻辑，否则很有可能导致消息一直重复消费失败并且重复重新入队，表现为消费者线程出现死循环逻辑，耗尽服务器CPU资源。</p>
<h3 id="reject">reject</h3>
<p>reject的用法和nack基本一致，不过reject没有批量处理功能，依赖于<code>Channel的basicReject</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">basicReject</span><span class="params">(<span class="keyword">long</span> deliveryTag, <span class="keyword">boolean</span> requeue)</span> <span class="keyword">throws</span> IOException</span>;</span><br></pre></td></tr></table></figure>
<p>简单举个使用例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RejectMain</span> <span class="keyword">extends</span> <span class="title">BaseChannelFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		provideChannel(channel -&gt; &#123;</span><br><span class="line">			GetResponse getResponse = channel.basicGet(<span class="string">"throwable.queue.direct"</span>, <span class="keyword">true</span>);</span><br><span class="line">			channel.basicReject(getResponse.getEnvelope().getDeliveryTag(), <span class="keyword">false</span>);</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="消费消息不进行消息确认会怎么样">消费消息不进行消息确认会怎么样</h3>
<p>消息消费方法<code>basiConsume</code>中的autoAck属性设置为false，但是消费者接收到消息后不进行消息确认会怎么样？举个例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NoneAckMain</span> <span class="keyword">extends</span> <span class="title">BaseChannelFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		provideChannel(channel -&gt; &#123;</span><br><span class="line">			channel.basicPublish(<span class="string">"throwable.exchange.direct"</span>, <span class="string">"direct.routingKey"</span>,</span><br><span class="line">					MessageProperties.TEXT_PLAIN, <span class="string">"Direct Message"</span>.getBytes(StandardCharsets.UTF_8));</span><br><span class="line">			<span class="comment">//autoAck = false</span></span><br><span class="line">			channel.basicConsume(<span class="string">"throwable.queue.direct"</span>, <span class="keyword">false</span>, <span class="keyword">new</span> DefaultConsumer(channel) &#123;</span><br><span class="line">				<span class="meta">@Override</span></span><br><span class="line">				<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleDelivery</span><span class="params">(String consumerTag,</span></span></span><br><span class="line"><span class="function"><span class="params">										   Envelope envelope,</span></span></span><br><span class="line"><span class="function"><span class="params">										   AMQP.BasicProperties properties,</span></span></span><br><span class="line"><span class="function"><span class="params">										   <span class="keyword">byte</span>[] body)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">					System.out.println(<span class="string">"消息序号:"</span> + envelope.getDeliveryTag());</span><br><span class="line">					System.out.println(<span class="string">"交换器:"</span> + envelope.getExchange());</span><br><span class="line">					System.out.println(<span class="string">"路由键:"</span> + envelope.getRoutingKey());</span><br><span class="line">					System.out.println(<span class="string">"消息内容:"</span> + <span class="keyword">new</span> String(body, StandardCharsets.UTF_8));</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;);</span><br><span class="line">			<span class="comment">//消息消费是异步的，要想办法阻塞消费者所在的线程和主线程，否则会退出</span></span><br><span class="line">			Thread.sleep(Integer.MAX_VALUE);</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行之后，控制台输出：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">消息序号:<span class="number">1</span></span><br><span class="line">交换器:throwable.exchange.direct</span><br><span class="line">路由键:direct.routingKey</span><br><span class="line">消息内容:Direct Message</span><br></pre></td></tr></table></figure>
<p>查看RabbitMQ的Web管理界面，发现消息由Ready转变为Unacked状态：</p>
<p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/r-m-s-c-c/r-m-s-c-c-3.png" alt="r-m-s-c-c-3.png"></p>
<p>尝试终止消费者所在线程，再次观察RabbitMQ的Web管理界面对应队列：</p>
<p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/r-m-s-c-c/r-m-s-c-c-4.png" alt="r-m-s-c-c-4.png"></p>
<p>发现消息由Unacked状态恢复为Ready。这里需要注意，只有Ready状态的消息才能被消息中间件代理投递到消费者。总的来说就是：</p>
<ul>
<li>被路由到队列的新消息的状态为Ready，这种消息可以被消息中间件代理投递到客户端的消费者中。</li>
<li>客户端消费者在消费消息的时候，如果采用手动确认(autoAck=false)并且没有主动确认(也就是没有调用<code>basicAck</code>、<code>basicNack</code>或者<code>basicReject</code>)，那么消息就会变为Unacked状态，Unacked状态的消息只有当所有的消费者线程终止的时候，才会重新转变为Ready状态。</li>
</ul>
<h2 id="小结">小结</h2>
<p>这篇文章仅仅从基本使用来分析RabbitMQ中的消息发送、消费和确认的例子。关于消息发布确认机制和消息发布事务机制后面有专门的文章分析其性能和具体使用场景。</p>
<p>RabbitMQ中的消息发布确认(publish confirm)和消息消费(投递)确认(deliver confirm)能够确保消息发布和消息消费阶段消息不会丢失，至于策略应该根据具体场景选择，autoAck并不适合所有的场景。</p>
<p>(本文完 c-2-d e-a-20181125)</p>

      
    </div>
    <!-- 
      <div class="full-width auto-padding tags">
        
          <a href="/blog/tags/Middleware/" rel="nofollow"><i class="fas fa-tag fa-fw"></i> Middleware</a>
        
          <a href="/blog/tags/RabbitMQ/" rel="nofollow"><i class="fas fa-tag fa-fw"></i> RabbitMQ</a>
        
      </div>
     -->
  </section>
</article>

          </div>
        
      
        
          <div class='post-wrapper'>
            <article class="post white-box card-shadow  reveal ">
  


  <section class='meta'>
    
    
    <div class="meta" id="header-meta">
      
        
  <h2 class="title">
    <a href="/2018/11/25/rabbitmq-component-operation/">
      RabbitMQ队列、交换器和绑定的操作
    </a>
  </h2>


      
      <div class='new-meta-box'>
        
          
        
          
            
  <div class='new-meta-item author'>
    
      <a href="http://throwable.club" rel="nofollow">
        
          <img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/mine/doge_avatar.jpg">
        
        <p>Throwable</p>
      </a>
    
  </div>


          
        
          
            <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-edit" aria-hidden="true"></i>
    <p>发布于：2018年11月25日</p>
  </a>
</div>

          
        
          
            
  
  <div class='new-meta-item category'>
    <a href='/blog/categories/Middleware/RabbitMQ/' rel="nofollow">
      <i class="fas fa-folder-open" aria-hidden="true"></i>
      <p>Middleware&nbsp;/&nbsp;RabbitMQ</p>
    </a>
  </div>


          
        
          
            
  <div class="new-meta-item wordcount">
    <a class='notlink'>
      <i class="fas fa-keyboard" aria-hidden="true"></i>
      <p>字数：3.8k字</p>
    </a>
  </div>
  <div class="new-meta-item readtime">
    <a class='notlink'>
      <i class="fas fa-hourglass-half" aria-hidden="true"></i>
      <p>时长：15分钟</p>
    </a>
  </div>


          
        
          
            <div class="new-meta-item date" itemprop="dateUpdated" datetime="2018-11-25T02:26:00+08:00">
  <a class='notlink'>
    <i class="fas fa-save" aria-hidden="true"></i>
    <p>更新于：2018年11月25日</p>
  </a>
</div>

          
        
          
            

          
        
          
            

          
        
      </div>
      
        <hr>
      
    </div>
  </section>


  <section class="article typo">
    <div class="article-entry" itemprop="articleBody">
      <h1>前提</h1>
<p>如果能提前先阅读一下之前写过的一篇文章<a href="http://throwable.coding.me/2018/11/21/rabbitmq-amqp-model" target="_blank" rel="noopener">理解RabbitMQ中的AMQP-0-9-1模型</a>，那么这篇文章应该会比较容易理解。</p>
<h2 id="引入依赖">引入依赖</h2>
<p>先确认已经安装了RabbitMQ的服务，并且开启了Web管理插件，方便直接从Web管理界面查找到队列、交换器和绑定。个人有软件洁癖，喜欢把软件和依赖保持升级到最新版本。引入RabbitMQ的Java驱动：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.rabbitmq<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>amqp-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.5.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>本文介绍RabbitMQ通过其Java驱动声明队列、交换器和绑定。对于队列和交换器，其首次声明也是创建的操作。队列、交换器和绑定的声明依赖于通道(Channel)，对应的是<code>com.rabbitmq.client.Channel</code>接口。在使用RabbitMQ的Java驱动的时候，一般在我们都使用下面的方式进行组件的声明操作：</p>
<ul>
<li>1、基于RabbitMQ连接信息构建<code>com.rabbitmq.client.ConnectionFactory</code>实例。</li>
<li>2、基于ConnectionFactory新建一个<code>com.rabbitmq.client.Connection</code>实例。</li>
<li>3、基于Connection新建一个<code>com.rabbitmq.client.Channel</code>实例。</li>
<li>4、通过Channel实例声明(删除、解除绑定)队列、交换器或者绑定(<strong>Channel实例是可以复用的</strong>)。</li>
</ul>
<p>虽然Channel实例是可以复用的，但是为了简化测试方法的编写，我们可以写下个简单的基础类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseChannelFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">provideChannel</span><span class="params">(ChannelAction channelAction)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		ConnectionFactory connectionFactory = <span class="keyword">new</span> ConnectionFactory();</span><br><span class="line">		connectionFactory.setHost(<span class="string">"localhost"</span>);</span><br><span class="line">		connectionFactory.setPort(<span class="number">5672</span>);</span><br><span class="line">		connectionFactory.setUsername(<span class="string">"guest"</span>);</span><br><span class="line">		connectionFactory.setPassword(<span class="string">"guest"</span>);</span><br><span class="line">		Connection connection = connectionFactory.newConnection();</span><br><span class="line">		Channel channel = connection.createChannel();</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			channelAction.doInChannel(channel);</span><br><span class="line">		&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">			channel.close();</span><br><span class="line">			connection.close();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">interface</span> <span class="title">ChannelAction</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		<span class="function"><span class="keyword">void</span> <span class="title">doInChannel</span><span class="params">(Channel channel)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这样子，每次调用都是新建的Connection和Channel，我们只需要重点关注<code>ChannelAction</code>的实现即可。</p>
<p>在查看一下框架类型的API文档的时候有个很重要的技巧：<strong>如果提供的方法有重载，只需要看参数最多的基础方法</strong>。</p>
<h2 id="队列的相关操作">队列的相关操作</h2>
<p>队列的相关参数主要包括队列的声明(declare)、删除(delete)和清空队列消息(purge)。</p>
<h3 id="队列的声明">队列的声明</h3>
<p>队列的声明依赖于<code>com.rabbitmq.client.Channel</code>的<code>queueDeclare</code>方法。<code>queueDeclare</code>方法的多个重载都是同步方法，提供同样功能的还有一个异步方法<code>queueDeclareNoWait</code>。下面选取<code>queueDeclare</code>参数列表长度最大的方法进行分析：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Queue.<span class="function">DeclareOk <span class="title">queueDeclare</span><span class="params">(String queue,</span></span></span><br><span class="line"><span class="function"><span class="params">                             <span class="keyword">boolean</span> durable,</span></span></span><br><span class="line"><span class="function"><span class="params">                             <span class="keyword">boolean</span> exclusive,</span></span></span><br><span class="line"><span class="function"><span class="params">                             <span class="keyword">boolean</span> autoDelete,</span></span></span><br><span class="line"><span class="function"><span class="params">                             Map&lt;String, Object&gt; arguments)</span> <span class="keyword">throws</span> IOException</span>;</span><br></pre></td></tr></table></figure>
<p>参数如下：</p>
<ul>
<li>queue：需要声明的队列名称。</li>
<li>durable：是否开启持久化特性，如果此属性为true，消息中间件代理重启后队列会被重新声明(也就是说不会被删除)，注意<strong>这个特性和消息的持久化特性完全不相关</strong>。</li>
<li>exclusive：是否独占的，如果此属性为true，则队列的存在性绑定在创建它的连接上，意味着队列只能被一个连接使用并且连接关闭之后队列会被删除。</li>
<li>autoDelete：是否自动删除，如果此属性为true，意味着队列不被使用的时候会被消息中间件代理删除，实际上意味着队列至少有一个消费者并且最后一个消费者解除订阅状态(一般是消费者对应的通道关闭)后队列会自动删除。</li>
<li>arguments：K-V结构，队列参数，一般和消息中间件代理或者插件的特性相关，如消息的过期时间(Message TTL)和队列长度等，后面会有专门文章介绍这些特性。</li>
</ul>
<p>队列声明的返回值是<code>Queue.DeclareOk</code>实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DeclareOk</span> <span class="keyword">extends</span> <span class="title">Method</span> </span>&#123;</span><br><span class="line">    <span class="function">String <span class="title">getQueue</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getMessageCount</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getConsumerCount</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">//...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以从中得知声明的队列名、队列中的消息数量、队列当前的消费者数量，这个返回值对于无参数的<code>queueDeclare</code>方法十分有意义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Queue.<span class="function">DeclareOk <span class="title">queueDeclare</span><span class="params">()</span> <span class="keyword">throws</span> IOException</span>;</span><br></pre></td></tr></table></figure>
<p>因为这个方法声明的队列名称是由消息中间件代理随机生成，队列名就是通过返回值告知客户端的。这里贴一个简单的例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QueueDeclareMain</span> <span class="keyword">extends</span> <span class="title">BaseChannelFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		provideChannel(channel -&gt; &#123;</span><br><span class="line">			AMQP.Queue.DeclareOk declareOk = channel.queueDeclare(<span class="string">"throwable.queue"</span>, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">			System.out.println(declareOk.getQueue());</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>运行后控制台打印throwable.queue说明队列声明成功，可以查看RabbitMQ的Web管理界面：</p>
<p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/r-m-d/r-m-d-1.png" alt="r-m-d-1.png"></p>
<p><strong>可见队列的确已经被创建，但是Bindings一栏显示队列只绑定到默认的交换器中，这个时候其实已经可以通过默认的交换器向队列中发送消息</strong>。队列声明失败的时候会直接抛出异常，一般是IOException。上面的例子中是我们最常见到的队列声明方式，声明出来的队列开启了队列持久化特性、非独占的、非自动删除的，也就是即使RabbitMQ服务重启了，队列依然会存在(被重新声明)，但是并不是所有的场景都需要这种声明方式(说实话，目前笔者没碰到不使用这种声明方式的场景，有点惭愧)。还有一点需要重点关注：<strong>队列可以重复声明，但是声明所使用的参数必须一致，否则会抛出异常</strong>。</p>
<h3 id="队列的被动-Passive-声明">队列的被动(Passive)声明</h3>
<p>队列的被动声明，其实是检查队列在消息代理中间件是否存在的判断方法，依赖于Channel的<code>queueDeclarePassive</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Queue.<span class="function">DeleteOk <span class="title">queueDelete</span><span class="params">(String queue)</span> <span class="keyword">throws</span> IOException</span>;</span><br></pre></td></tr></table></figure>
<p>它只依赖于一个参数-队列名称，如果队列名称对应的队列已经存在，则返回<code>Queue.DeleteOk</code>实例，如果队列不存在，会抛出IOException，通常是一个被包装为IOException的ShutdownSignalException，而ShutdownSignalException是运行时异常的子类。举个列子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QueueDeclarePassiveMain</span> <span class="keyword">extends</span> <span class="title">BaseChannelFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		provideChannel(channel -&gt; &#123;</span><br><span class="line">			<span class="comment">//队列throwable.queue已存在</span></span><br><span class="line">			AMQP.Queue.DeclareOk declareOk = channel.queueDeclarePassive(<span class="string">"throwable.queue"</span>);</span><br><span class="line">			System.out.println(declareOk.getQueue());</span><br><span class="line">			<span class="comment">//队列throwable.queue.passive不存在</span></span><br><span class="line">			declareOk = channel.queueDeclarePassive(<span class="string">"throwable.queue.passive"</span>);</span><br><span class="line">			System.out.println(declareOk.getQueue());</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于<code>throwable.queue.passive</code>队列不存在，因此会抛出IOException，追踪异常栈查看底层的异常是：</p>
<blockquote>
<p>Caused by: com.rabbitmq.client.ShutdownSignalException: channel error; protocol method: #method&lt;channel.close&gt;(reply-code=404, reply-text=NOT_FOUND - no queue ‘throwable.queue.passive’ in vhost ‘/’, class-id=50, method-id=10)</p>
</blockquote>
<p>利用这个方法的特性可以尝试编写一个方法确认队列是否存在，例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isQueueExisted</span><span class="params">(Channel channel, String queueName)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">boolean</span> flag = <span class="keyword">false</span>;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		channel.queuePurge(queueName);</span><br><span class="line">		flag = <span class="keyword">true</span>;</span><br><span class="line">	&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">			<span class="comment">//no-op</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> flag;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="队列的删除">队列的删除</h3>
<p>队列的删除对应的是Channel的<code>queueDelete</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//基于队列名删除队列，不关注队列是否被使用，也不关注队列中是否存在消息</span></span><br><span class="line">Queue.<span class="function">DeleteOk <span class="title">queueDelete</span><span class="params">(String queue)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">Queue.<span class="function">DeleteOk <span class="title">queueDelete</span><span class="params">(String queue, <span class="keyword">boolean</span> ifUnused, <span class="keyword">boolean</span> ifEmpty)</span> <span class="keyword">throws</span> IOException</span>;</span><br></pre></td></tr></table></figure>
<p>参数如下：</p>
<ul>
<li>queue：队列名称。</li>
<li>ifUnused：判断队列是否被不被使用，如果为true，只有不被使用的队列才能被删除。</li>
<li>ifEmpty：判断队列是否为空(没有消息积压)，如果为true，只有空的队列才能被删除。</li>
</ul>
<p>其实也就是只依赖队列名的单参数的<code>queueDelete</code>就是强制删除方法，举个例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QueueDeleteMain</span> <span class="keyword">extends</span> <span class="title">BaseChannelFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		provideChannel(channel -&gt; &#123;</span><br><span class="line">			AMQP.Queue.DeleteOk deleteOk = channel.queueDelete(<span class="string">"throwable.queue"</span>);</span><br><span class="line">			System.out.println(String.format(<span class="string">"Delete queue [%s] successfully,message count = %d!"</span>, </span><br><span class="line">					<span class="string">"throwable.queue"</span>, deleteOk.getMessageCount()));</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>一般来说，队列的删除功能权限最好不要下放到应用程序中，除非有特殊的需要，如果需要删除队列，最好使用<code>queueDelete(String queue, boolean ifUnused, boolean ifEmpty)</code>方法，否则有可能造成消息丢失。</p>
<h3 id="队列的清空">队列的清空</h3>
<p>队列的清空操作会删除队列中的所有消息，依赖的方法是Channel的<code>queuePurge</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Queue.<span class="function">PurgeOk <span class="title">queuePurge</span><span class="params">(String queue)</span> <span class="keyword">throws</span> IOException</span>;</span><br></pre></td></tr></table></figure>
<p>此方法会基于队列名清除对应队列中的所有内容，使用的时候需要谨慎，举个例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QueuePurgeMain</span> <span class="keyword">extends</span> <span class="title">BaseChannelFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		provideChannel(channel -&gt; &#123;</span><br><span class="line">			AMQP.Queue.PurgeOk purgeOk = channel.queuePurge(<span class="string">"throwable.queue"</span>);</span><br><span class="line">			System.out.println(String.format(<span class="string">"Purge queue [%s] successfully,message count = %d!"</span>,</span><br><span class="line">					<span class="string">"throwable.queue"</span>, purgeOk.getMessageCount()));</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实在Web管理界面中，每个队列所在的页面下有一个<code>Purge</code>按钮，该按钮的功能就是清空队列消息。</p>
<p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/r-m-d/r-m-d-2.png" alt="r-m-d-2.png"></p>
<h2 id="交换器的相关操作">交换器的相关操作</h2>
<p>交换器的相关操作主要包括交换器的声明和删除。</p>
<h3 id="交换器的声明">交换器的声明</h3>
<p>交换器的声明方法依赖于Channel的<code>exchangeDeclare</code>方法，按照惯例查看它重载方法中参数列表长度最大的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Exchange.<span class="function">DeclareOk <span class="title">exchangeDeclare</span><span class="params">(String exchange,</span></span></span><br><span class="line"><span class="function"><span class="params">                                              BuiltinExchangeType type,</span></span></span><br><span class="line"><span class="function"><span class="params">                                              <span class="keyword">boolean</span> durable,</span></span></span><br><span class="line"><span class="function"><span class="params">                                              <span class="keyword">boolean</span> autoDelete,</span></span></span><br><span class="line"><span class="function"><span class="params">                                              <span class="keyword">boolean</span> internal,</span></span></span><br><span class="line"><span class="function"><span class="params">                                              Map&lt;String, Object&gt; arguments)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">Exchange.<span class="function">DeclareOk <span class="title">exchangeDeclare</span><span class="params">(String exchange,</span></span></span><br><span class="line"><span class="function"><span class="params">                                              String type,</span></span></span><br><span class="line"><span class="function"><span class="params">                                              <span class="keyword">boolean</span> durable,</span></span></span><br><span class="line"><span class="function"><span class="params">                                              <span class="keyword">boolean</span> autoDelete,</span></span></span><br><span class="line"><span class="function"><span class="params">                                              <span class="keyword">boolean</span> internal,</span></span></span><br><span class="line"><span class="function"><span class="params">                                              Map&lt;String, Object&gt; arguments)</span> <span class="keyword">throws</span> IOException</span>;</span><br></pre></td></tr></table></figure>
<p>参数解释如下：</p>
<ul>
<li>exchange：交换器名称。</li>
<li>type：type可以为字符串或者BuiltinExchangeType类型，BuiltinExchangeType枚举只包括DIRECT、FANOUT、TOPIC和HEADERS，而字符串类型除了定义四种内建类型的交换器，实际上RabbitMQ允许自定义类型的交换器，不过很少使用。</li>
<li>durable：是否开启持久化特性，如果此属性为true，则消息中间件代理重启后，交换器不会删除，实际上是会被重新声明一次。</li>
<li>autoDelete：是否自动删除，如果此属性为true，当最后一个绑定到此交换器的队列解除绑定关系，交换器会被删除。</li>
<li>internal：是否内部的，如果此属性为true，该交换器只允许消息中间件代理使用，客户端无法使用。</li>
<li>arguments：交换器参数，K-V结构，参数一般和消息中间件代理或者插件的一些扩展特性相关，不依赖这些扩展特性直接使用null即可。</li>
</ul>
<p>举个简单的使用例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExchangeDeclareMain</span> <span class="keyword">extends</span> <span class="title">BaseChannelFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		provideChannel(channel -&gt; &#123;</span><br><span class="line">			channel.exchangeDeclare(<span class="string">"throwable.exchange.direct"</span>,</span><br><span class="line">					BuiltinExchangeType.DIRECT, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行完毕之后，RabbitMQ的Web管理器的Exchanges的选项卡中就能看到对应的交换器：</p>
<p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/r-m-d/r-m-d-3.png" alt="r-m-d-3.png"></p>
<p>因为没有声明交换器和队列的绑定，所以Bindings一栏是空的。</p>
<h3 id="交换器的被动声明">交换器的被动声明</h3>
<p>交换器的被动声明类似于队列的被动声明，用于通过交换器名称检查是否存在对应的交换器，依赖于Channel的<code>exchangeDeclarePassive</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Exchange.<span class="function">DeclareOk <span class="title">exchangeDeclarePassive</span><span class="params">(String name)</span> <span class="keyword">throws</span> IOException</span>;</span><br></pre></td></tr></table></figure>
<p>举个例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExchangeDeclarePassiveMain</span> <span class="keyword">extends</span> <span class="title">BaseChannelFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		provideChannel(channel -&gt; &#123;</span><br><span class="line">			<span class="comment">//throwable.exchange.direct存在</span></span><br><span class="line">			channel.exchangeDeclarePassive(<span class="string">"throwable.exchange.direct"</span>);</span><br><span class="line">			<span class="comment">//throwable.exchange.fanout不存在,会抛出IOException</span></span><br><span class="line">			channel.exchangeDeclarePassive(<span class="string">"throwable.exchange.fanout"</span>);</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>类似可以写个检查交换器是否存在的工具方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">isExchangeExisted</span><span class="params">(Channel channel, String exchangeName)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">boolean</span> flag = <span class="keyword">false</span>;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">		channel.exchangeDeclarePassive(exchangeName);</span><br><span class="line">		flag = <span class="keyword">true</span>;</span><br><span class="line">	&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">		<span class="comment">//no-op</span></span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> flag;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="交换器的删除">交换器的删除</h3>
<p>交换器的删除依赖于Channel的<code>exchangeDelete</code>方法，方法只依赖于交换器的名称。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Exchange.<span class="function">DeleteOk <span class="title">exchangeDelete</span><span class="params">(String exchange)</span> <span class="keyword">throws</span> IOException</span>;</span><br></pre></td></tr></table></figure>
<p>举个例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExchangeDeleteMain</span> <span class="keyword">extends</span> <span class="title">BaseChannelFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		provideChannel(channel -&gt; &#123;</span><br><span class="line">			channel.exchangeDelete(<span class="string">"throwable.exchange.direct"</span>);</span><br><span class="line"></span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="绑定的声明">绑定的声明</h2>
<p>前面提到队列的声明和交换器的声明，队列和交换器创建之后，需要声明两者的绑定关系，Channel中提供了两种声明绑定关系的方法：</p>
<ul>
<li><code>queueBind</code>方法，声明队列和交换器的绑定关系。</li>
<li><code>exchangeBind</code>方法，声明交换器和交换器之间的绑定关系。</li>
</ul>
<p>同时也提供解除绑定的方法：</p>
<ul>
<li><code>queueUnbind</code>方法：解除队列和交换器的绑定关系。</li>
<li><code>exchangeUnbind</code>方法：解除交换器之间的绑定关系。</li>
</ul>
<h3 id="队列和交换器的绑定和解绑">队列和交换器的绑定和解绑</h3>
<p>队列和交换器的绑定主要依赖于Channel的<code>queueBind</code>，而解绑主要依赖于<code>queueUnbind</code>方法，按照惯例看这两个方法重载方法中参数列表长度最大的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Queue.<span class="function">BindOk <span class="title">queueBind</span><span class="params">(String queue, </span></span></span><br><span class="line"><span class="function"><span class="params">                       String exchange, </span></span></span><br><span class="line"><span class="function"><span class="params">                       String routingKey, </span></span></span><br><span class="line"><span class="function"><span class="params">                       Map&lt;String, Object&gt; arguments)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">Queue.<span class="function">UnbindOk <span class="title">queueUnbind</span><span class="params">(String queue, </span></span></span><br><span class="line"><span class="function"><span class="params">                           String exchange, </span></span></span><br><span class="line"><span class="function"><span class="params">                           String routingKey, </span></span></span><br><span class="line"><span class="function"><span class="params">                           Map&lt;String, Object&gt; arguments)</span> <span class="keyword">throws</span> IOException</span>;</span><br></pre></td></tr></table></figure>
<p>注意这两个方法的参数列表完全一致：</p>
<ul>
<li>queue：队列名称。</li>
<li>exchange：交换器名称。</li>
<li>routingKey：路由键。</li>
<li>arguments：绑定参数，K-V结构，参数一般和消息中间件代理或者插件的一些扩展特性相关，不依赖这些扩展特性直接使用null即可。</li>
</ul>
<p>基于声明队列和交换器间的绑定举个例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QueueBindMain</span> <span class="keyword">extends</span> <span class="title">BaseChannelFactory</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">       provideChannel(channel -&gt; &#123;</span><br><span class="line">       	   <span class="comment">//throwable.exchange.direct-&gt;throwable.queue</span></span><br><span class="line">       	   channel.queueBind(<span class="string">"throwable.queue"</span>,<span class="string">"throwable.exchange.direct"</span>, <span class="string">"throwable.routingKey"</span>,<span class="keyword">null</span>);</span><br><span class="line">	   &#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>声明成功之后，可以查看对应的队列和交换器中的Bindings一栏：</p>
<p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/r-m-d/r-m-d-4.png" alt="r-m-d-4.png"></p>
<p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/r-m-d/r-m-d-5.png" alt="r-m-d-5.png"></p>
<p>可见交换器和队列成功建立了绑定关系。接着可以尝试使用解绑方法进行绑定解除：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">QueueUnbindMain</span> <span class="keyword">extends</span> <span class="title">BaseChannelFactory</span></span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">       provideChannel(channel -&gt; &#123;</span><br><span class="line">       	   channel.queueUnbind(<span class="string">"throwable.queue"</span>,<span class="string">"throwable.exchange.direct"</span>, <span class="string">"throwable.routingKey"</span>,<span class="keyword">null</span>);</span><br><span class="line">	   &#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="交换器之间的绑定和解绑">交换器之间的绑定和解绑</h3>
<p>RabbitMQ中支持两个不同的交换器之间进行绑定和解除绑定，绑定方法依赖于Channel的<code>exchangeBind</code>方法，解除绑定依赖于Channel的<code>exchangeUnbind</code>方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Exchange.<span class="function">BindOk <span class="title">exchangeBind</span><span class="params">(String destination, </span></span></span><br><span class="line"><span class="function"><span class="params">                             String source, </span></span></span><br><span class="line"><span class="function"><span class="params">                             String routingKey,</span></span></span><br><span class="line"><span class="function"><span class="params">                             Map&lt;String, Object&gt; arguments)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line"></span><br><span class="line">Exchange.<span class="function">UnbindOk <span class="title">exchangeUnbind</span><span class="params">(String destination, </span></span></span><br><span class="line"><span class="function"><span class="params">                                 String source, </span></span></span><br><span class="line"><span class="function"><span class="params">                                 String routingKey, </span></span></span><br><span class="line"><span class="function"><span class="params">                                 Map&lt;String, Object&gt; arguments)</span> <span class="keyword">throws</span> IOException</span>;</span><br></pre></td></tr></table></figure>
<p>参数如下：</p>
<ul>
<li>destination：目标交换器名称。</li>
<li>source：来源交换器名称。</li>
<li>routingKey：路由键。</li>
<li>arguments：参数，K-V结构。</li>
</ul>
<p>我们先预先建立一个Fanout类型的交换器，命名为<code>throwable.exchange.fanout</code>，接着，我们把Fanout类型的交换器<code>throwable.exchange.fanout</code>作为来源交换器，绑定到Direct类型的目标交换器<code>throwable.exchange.direct</code>上：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExchangeBindMain</span> <span class="keyword">extends</span> <span class="title">BaseChannelFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		provideChannel(channel -&gt; &#123;</span><br><span class="line">			channel.exchangeDeclare(<span class="string">"throwable.exchange.fanout"</span>, BuiltinExchangeType.FANOUT, <span class="keyword">true</span>, <span class="keyword">false</span>, <span class="keyword">null</span>);</span><br><span class="line">			channel.exchangeBind(<span class="string">"throwable.exchange.direct"</span>, <span class="string">"throwable.exchange.fanout"</span>, <span class="string">"exchange.routingKey"</span>);</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>现在可以查看交换器<code>throwable.exchange.direct</code>的Bindings一栏的信息：</p>
<p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/r-m-d/r-m-d-6.png" alt="r-m-d-6.png"></p>
<p>这就是现在我们通过交换器<code>throwable.exchange.fanout</code>发送消息，消息会先到达交换器<code>throwable.exchange.direct</code>，然后再路由到队列<code>throwable.queue</code>中。<strong>多重绑定的交换器在一些复杂的场景有重要的作用，但是目前来看还没有碰到使用场景(一般来说，存在即合理)</strong>。</p>
<p>接着举个例子进行交换器之间的绑定解除：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExchangeUnbindMain</span> <span class="keyword">extends</span> <span class="title">BaseChannelFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		provideChannel(channel -&gt; &#123;</span><br><span class="line">			channel.exchangeUnbind(<span class="string">"throwable.exchange.direct"</span>, <span class="string">"throwable.exchange.fanout"</span>, <span class="string">"exchange.routingKey"</span>);</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="小结">小结</h2>
<p>一旦队列和交换器之间的绑定关系声明完毕，我们可以通过交换器和可选的路由键向队列中发送消息，可以注册消费者到队列中获取消息。RabbitMQ中的队列、交换器和绑定有个特点：<strong>组件的声明只承认第一次，也就是队列名、交换器名是唯一的，组件可以反复声明，不过声明所使用的参数必须和首次声明的参数一致</strong>。</p>
<p>(本文完 c-3-d e-a-20181125)</p>

      
    </div>
    <!-- 
      <div class="full-width auto-padding tags">
        
          <a href="/blog/tags/Middleware/" rel="nofollow"><i class="fas fa-tag fa-fw"></i> Middleware</a>
        
          <a href="/blog/tags/RabbitMQ/" rel="nofollow"><i class="fas fa-tag fa-fw"></i> RabbitMQ</a>
        
      </div>
     -->
  </section>
</article>

          </div>
        
      
        
          <div class='post-wrapper'>
            <article class="post white-box card-shadow  reveal ">
  


  <section class='meta'>
    
    
    <div class="meta" id="header-meta">
      
        
  <h2 class="title">
    <a href="/2018/11/21/rabbitmq-amqp-model/">
      理解RabbitMQ中的AMQP-0-9-1模型
    </a>
  </h2>


      
      <div class='new-meta-box'>
        
          
        
          
            
  <div class='new-meta-item author'>
    
      <a href="http://throwable.club" rel="nofollow">
        
          <img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/mine/doge_avatar.jpg">
        
        <p>Throwable</p>
      </a>
    
  </div>


          
        
          
            <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-edit" aria-hidden="true"></i>
    <p>发布于：2018年11月21日</p>
  </a>
</div>

          
        
          
            
  
  <div class='new-meta-item category'>
    <a href='/blog/categories/Middleware/RabbitMQ/' rel="nofollow">
      <i class="fas fa-folder-open" aria-hidden="true"></i>
      <p>Middleware&nbsp;/&nbsp;RabbitMQ</p>
    </a>
  </div>


          
        
          
            
  <div class="new-meta-item wordcount">
    <a class='notlink'>
      <i class="fas fa-keyboard" aria-hidden="true"></i>
      <p>字数：5.8k字</p>
    </a>
  </div>
  <div class="new-meta-item readtime">
    <a class='notlink'>
      <i class="fas fa-hourglass-half" aria-hidden="true"></i>
      <p>时长：20分钟</p>
    </a>
  </div>


          
        
          
            <div class="new-meta-item date" itemprop="dateUpdated" datetime="2018-11-22T23:38:56+08:00">
  <a class='notlink'>
    <i class="fas fa-save" aria-hidden="true"></i>
    <p>更新于：2018年11月22日</p>
  </a>
</div>

          
        
          
            

          
        
          
            

          
        
      </div>
      
        <hr>
      
    </div>
  </section>


  <section class="article typo">
    <div class="article-entry" itemprop="articleBody">
      <h1>前提</h1>
<p>之前有个打算在学习RabbitMQ之前，把AMQP详细阅读一次，挑出里面的重点内容。后来找了下RabbitMQ的官方文档，发现了有一篇文档专门介绍了RabbitMQ中实现的AMQP模型部分，于是直接基于此文档和个人理解写下这篇文章。</p>
<h2 id="AMQP协议">AMQP协议</h2>
<p><a href="http://www.amqp.org/" target="_blank" rel="noopener">AMQP</a>全称是Advanced Message Queuing Protocol，它是一个(分布式)消息传递协议，使用和符合此协议的客户端能够基于使用和符合此协议的消息传递中间件代理(Broker，也就是经纪人，个人感觉叫代理合口一些)进行通信。AMQP目前已经推出协议1.0，实现此协议的比较知名的产品有StormMQ、RabbitMQ、Apache Qpid等。RabbitMQ实现的AMQP版本是0.9.1，官方文档中也提供了该协议pdf文本下载，有兴趣可以翻阅一下。</p>
<h2 id="消息中间件代理的职责">消息中间件代理的职责</h2>
<p>Messaging Broker，这里称为消息中间件代理。它的职责是从发布者(Publisher，或者有些时候称为Producer，生产者)接收消息，然后把消息路由到消费者(Consumer，或者有些时候称为Listener，监听者)。</p>
<p>因为消息中间件代理、发布者客户端和消费者客户端都是基于AMQP这一网络消息协议，所以消息中间件代理、发布者客户端和消费者客户端可以在不同的机器上，从而实现分布式通讯和服务解耦。</p>
<p>消息中间件代理不仅仅提供了消息接收和消息路由这两个基本功能，还有其他高级的特性如消息持久化功能、监控功能等等。</p>
<h2 id="AMQP-0-9-1在RabbitMQ中的基本模型">AMQP-0-9-1在RabbitMQ中的基本模型</h2>
<p>AMQP-0-9-1模型的基本视图是：消息发布者将消息发布到交换器(Exchange)中，交换器的角色有点类似于日常见到的邮局或者信箱。然后，交换器把<strong>消息的副本</strong>分发到队列(Queue)中，分发消息的时候遵循的规则叫做绑定(Binding)。接着，消息中间件代理向订阅队列的消费者发送消息(push模式)，或者消费者也可以主动从队列中拉取消息(fetch/pull模式)。</p>
<p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/r-a-m/r-a-m-1.png" alt="r-a-m-1.png"></p>
<p>发布者在发布消息的时候可以指定消息属性(消息元数据)，某些消息元数据可能由消息中间件代理使用，其他消息元数据对于消息中间件代理而言是不透明的，仅供消息消费者使用。</p>
<p>由于网络是不可靠的，客户端可能无法接收消息或者处理消息失败，这个时候消息中间件代理无法感知消息是否正确传递到消费者中，因此AMQP模型提供了消息确认(Message Acknowledgement)的概念：当消息传递到消费者，消费者可以自动向消息中间件代理确认消息已经接收成功或者由应用程序开发者选择手动确认消息已经接收成功并且向消息中间件代理确认消息，消息中间件代理只有在接收到该消息(或者消息组)的确认通知后才会从队列中完全删除该消息。</p>
<p>在某些情况下，交换器无法正确路由到队列中，那么该消息就会返回给发布者，或者丢弃，或者如果消息中间件代理实现了&quot;死信队列(Dead Letter Queue)&quot;扩展，消息会被放置到死信队列中。消息发布者可以选择使用对应的参数控制路由失败的处理策略。</p>
<h2 id="交换器和交换器类型">交换器和交换器类型</h2>
<p>交互器(Exchange)是消息发送的第一站目的地，它的作用就是就收消息并且将其路由到零个或者多个队列。路由消息的算法取决于交互器的类型和路由规则(也就是Binding)。RabbitMQ消息中间件代理支持四种类型的交互器，分别是：</p>
<table>
<thead>
<tr>
<th style="text-align:center">交换器类型</th>
<th style="text-align:center">Broker默认预声明的交换器</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Direct</td>
<td style="text-align:center">(空字符串[(AMQP default)])和amq.direct</td>
</tr>
<tr>
<td style="text-align:center">Fanout</td>
<td style="text-align:center">amq.fanout</td>
</tr>
<tr>
<td style="text-align:center">Topic</td>
<td style="text-align:center">amq.topic</td>
</tr>
<tr>
<td style="text-align:center">Headers</td>
<td style="text-align:center">amq.match (和RabbitMQ中的amq.headers)</td>
</tr>
</tbody>
</table>
<p>声明交互器的时候需要提供一些列的属性，其中比较重要的属性如下：</p>
<ul>
<li>Name：交互器的名称。</li>
<li>Type：交换器的类型。</li>
<li>Durability：(交换器)持久化特性，如果启动此特性，则Broker重启后交换器依然存在，否则交换器会被删除。</li>
<li>Auto-delete：是否自动删除，如果启用此特性，当最后一个队列解除与交换器的绑定关系，交换器会被删除。</li>
<li>Arguments：可选参数，一般配合插件或者Broker的特性使用。</li>
</ul>
<p>之所以存在Durability和Auto-delete特性是因为并发所有的场景和用例都要求交互器是持久化的。</p>
<h3 id="Direct交换器">Direct交换器</h3>
<p>Direct类型的交换器基于消息路由键(RoutingKey)把消息传递到队列中。Direct交换器是消息单播路由的理想实现(当然，用于多播路由也可以)，它的工作原理如下：</p>
<ul>
<li>队列使用路由键K绑定到交换器。</li>
<li>当具有路由键R的新消息到达交换器的时候，如果K = R，那么交换器会把消息传递到队列中。</li>
</ul>
<p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/r-a-m/r-a-m-4.png" alt="direct-exchange"></p>
<h3 id="默认交换器">默认交换器</h3>
<p>默认交换器(Default Exchange)是一种特殊的Direct交互器，它的名称是空字符串(也就是&quot;&quot;)，它由消息中间件代理预声明，在RabbitMQ Broker中，它在Web管理界面中的名称是<code>(AMQP default)</code>。每个新创建的队列都会绑定到默认交换器，路由键就是该队列的队列名，也就是所有的队列都可以通过默认交换器进行消息投递，只需要指定路由键为相应的队列名即可。</p>
<p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/r-a-m/r-a-m-5.png" alt="default-exchange"></p>
<h3 id="Fanout交换器">Fanout交换器</h3>
<p>Fanout其实是一个组合单词，fan也就是扇形，out就是向外发散的意思，Fanout交换器可以想象为&quot;扇形&quot;交换器。Fanout交换器会忽略路由键，它会路由消息到所有绑定到它的队列。也就是说，如果有N个队列绑定到一个Fanout交换器，当一个新的消息发布到该Fanout交换器，那么这条新消息的一个副本会分发到这N个队列中。Fanout交换器是消息广播路由的理想实现。</p>
<p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/r-a-m/r-a-m-6.png" alt="fanout-exchange"></p>
<h3 id="Topic交换器">Topic交换器</h3>
<p>Topic交换器基于路由键和绑定队列和交换器的模式进行匹配从而把消息路由到一个或者多个队列。绑定队列和交换器的Topic模式(这个模式串其实就是声明绑定时候的路由键，和消息发布的路由键并非同一个)一般使用点号(dot，也就是’.’)分隔，例如<code>source.target.key</code>，绑定模式支持通配符：</p>
<ul>
<li>符号<code>#</code>匹配一个或者多个词，例如：<code>source.target.#</code>可以匹配<code>source.target.doge</code>、<code>source.target.doge.throwable</code>等等。</li>
<li>符号<code>*</code>只能匹配一个词，例如：<code>source.target.*</code>可以匹配<code>source.target.doge</code>、<code>source.target.throwable</code>等等。</li>
</ul>
<p>对每一条消息，Topic交换器会遍历所有的绑定关系，检查消息指定的路由键是否匹配绑定关系中的路由键，如果匹配，则将消息推送到相应队列。</p>
<p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/r-a-m/r-a-m-7.png" alt="topic-exchange"></p>
<p>Topic交换器是消息多播路由的理想实现。</p>
<h3 id="Headers交换器">Headers交换器</h3>
<p>Headers交换器是一种不常用的交换器，它使用多个属性进行路由，这些属性一般称为消息头，它不使用路由键进行消息路由。消息头(Message Headers)是消息属性(消息元数据)部分，因此，使用Headers交换器在建立队列和交换器的绑定关系的时候需要指定一组键值对，发送消息到Headers交换器时候，需要在消息属性中携带一组键值对作为消息头。消息头属性支持匹配规则x-match如下：</p>
<ul>
<li>x-match = all：表示所有的键值对都匹配才能接受到消息。</li>
<li>x-match = any：表示只要存在键值对匹配就能接受到消息。</li>
</ul>
<p>Headers交换器也是忽略路由键的，只依赖于消息属性中的消息头进行消息路由。</p>
<p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/r-a-m/r-a-m-8.png" alt="headers-exchange"></p>
<h2 id="队列">队列</h2>
<p>AMQP 0-9-1模型中的队列与其他消息或者任务队列系统中的队列非常相似：它们存储应用程序所使用的消息。队列和交换器的基本属性有类似的地方：</p>
<ul>
<li>Name：队列名称。</li>
<li>Durable：是否持久化，开启持久化意味着消息中间件代理重启后队列依然存在，否则队列会被删除。</li>
<li>Exclusive：是否独占的，开启队列独占特性意味着队列只能被一个连接使用并且连接关闭之后队列会被删除。</li>
<li>Auto-delete：是否自动删除，开启自动删除特性意味着队列至少有一个消费者并且最后一个消费者解除订阅状态(一般是消费者对应的通道关闭)后队列会自动删除。</li>
<li>Arguments：队列参数，一般和消息中间件代理或者插件的特性相关，如消息的过期时间(Message TTL)和队列长度等。</li>
</ul>
<p>一个队列只有被声明(Declare)了才能使用，也就是队列的第一次声明就是队列的创建操作(因为第一次声明的时候队列并不存在)。如果使用相同的参数再次声明已经存在的队列，那么此次声明会不生效(当然也不会出现异常)。但是如果使用不相同的参数再次声明已经存在的队列，那么会抛出通道级别的异常，异常代码是406(PRECONDITION_FAILED)。</p>
<h3 id="队列名称">队列名称</h3>
<p>队列名必须由255字节(bytes)长度以内的UTF-8编码字符组成。实现AMQP 0-9-1规范的消息中间件代理具备自动生成随机队列名的功能，也就是在声明队列的时候，队列名指定为空字符串，那么消息中间件代理会自动生成一个队列名，并且在队列声明的返回结果中带上对应的队列名。</p>
<p>以&quot;amq.&quot;开头的队列是由消息中间件代理内部生成的，有其特殊的作用，因此不能声明此类名称的新队列，否则会导致通道级别的异常，异常代码为403(ACCESS_REFUSED)。</p>
<h3 id="队列的持久化特性">队列的持久化特性</h3>
<p>持久化的队列会持久化到磁盘中，这种队列在消息中间件代理重启后不会被删除。不开启持久化特性的队列称为瞬时(transient)队列，并非所有的场景都需要开启队列的持久化特性。</p>
<p>队列的持久化特性并不意味着路由到它上面的消息是持久化的，也就是<strong>队列的持久化跟消息的持久化是两回事</strong>。如果息中间件代理挂了，它重启后会重新声明开启了持久化特性的队列，这些队列中只有使用了消息持久化特性的消息会被恢复。</p>
<h2 id="绑定">绑定</h2>
<p>绑定(Binding)是交换器路由消息到队列的规则。例如交换器E可以路由消息到队列Q，那么Q必须通过一定的规则绑定到E。绑定中使用的某些交换器的类型决定了它可以使用可选的路由键(RoutingKey)。路由键的作用类似于过滤器，可以筛选某些发布到交换器的消息路由到目标队列。</p>
<p>如果发布的消息没有路由到任意一个目标队列，例如，消息已经发布到交换器，交换器中没有任何绑定，这个时候消息会被丢弃或者返回给发布者，取决于消息发布者发布消息时候使用的参数。</p>
<h2 id="消费者">消费者</h2>
<p>如果队列只有发布者生产消息，那么是没有意义的，必须有消费者对消息进行使用，或者叫这个操作为消息消费，消息消费的方式有两种：</p>
<ul>
<li>消息代理中间件向消费者推送消息(推模式，代表方法是<code>basic.consume</code>)。</li>
<li>消费者主动向消息代理中间件拉取消息(拉模式，代表方法是<code>basic.get</code>)。</li>
</ul>
<p>使用推模式的情况下，消费者必须指定需要订阅的队列。每个队列可以存在多个消费者，或者仅仅注册一个独占的消费者。</p>
<p>每个消费者(订阅者)都有一个称为消费者标签(consumer tag)的标识符，消费者标签是一个字符串。通过消费者标签可以实现取消订阅的操作。</p>
<h2 id="消息确认">消息确认</h2>
<p>消费者应用程序有可能在接收和处理消息的时候崩溃，也有可能因为网络原因导致消息中间件代理投递消息到消费者的时候失败了，这样就会催生一个问题：AMQP消息中间件代理应该在什么时候从队列中删除消息？因此，AMQP 0-9-1规范提供了两种选择：</p>
<ul>
<li>消息中间件代理向应用程序发送消息(使用AMQP方法<code>basic.deliver</code>或<code>basic.get-ok</code>)。</li>
<li>应用程序收到消息后向消息中间件代理发送确认(使用AMQP方法<code>basic.ack</code> &lt;= 个人感觉这个地方少写了<code>basic.nack</code>和<code>basic.reject</code>)</li>
</ul>
<p>前一种称为自动确认模型(动作触发的同时进行了消息确认)，后一种称为显式确认模型。显式确认模型中，需要消费者主动向消息中间件代理进行消息主动确认，这个消息主动确认动作的执行时机完全由应用程序控制。消息主动确认有三种方式：积极确认(ack)、消极确认(nack)和拒绝(reject)。</p>
<h2 id="预取消息">预取消息</h2>
<p>预取消息(Prefetching Messages)是一个特性。对于多个消费者共享同一个队列的情况，能够告知消息中间件代理在发送下一个确认之前指定每个消费者一次可以接收消息的消息量。这个特性可以理解为简单的负载均衡技术，在批量发布消息的场景下能够提高吞吐量。</p>
<h2 id="消息属性和有效负载">消息属性和有效负载</h2>
<p>AMQP模型中，消息具有属性值。AMQP 0-9-1规范定义了一些常见的属性，一般开发人员不需要太关注这些属性：</p>
<ul>
<li>Content type</li>
<li>Content encoding</li>
<li>Routing key</li>
<li>Delivery mode (persistent or not)</li>
<li>Message priority</li>
<li>Message publishing timestamp</li>
<li>Expiration period</li>
<li>Publisher application id</li>
</ul>
<p>这些通用的属性一般是消息中间件代理使用的，还有可以定制的可选属性header，形式是键值对，类似于HTTP中的请求头。消息属性是在发布消息的时候设置的。</p>
<p>AMQP消息还有一个有效载荷(payload，其实就是消息数据体)，AMQP代理将其视为不透明的字节数组，也就是AMQP代理不会检查或者修改消息的有效载荷。有些消息可能只包含属性而没有有效负载。通常使用序列化格式(如JSON，Thrift，Protocol Buffers和MessagePack)来序列化和结构化数据，以便将其作为消息有效负载发布。在一般约定下，消息属性中的<code>Content type</code>和<code>Content encoding</code>一般可以表明其序列化的方式。</p>
<p>消息发布支持消息的持久化特性，消息持久化特性开启后，消息中间件代理会把消息保存到磁盘中，如果重启代理消息也不会丢失。开启消息持久化特性将会影响性能，主要是因为涉及到刷盘操作。</p>
<h2 id="AMQP-0-9-1方法">AMQP-0-9-1方法</h2>
<p>AMQP 0-9-1定义了一些方法，对应了客户端和消息中间件代理之间交互的一些操作方法，这些操作方法的设计跟面向对象编程语言中的方法没有任何共同之处。常用的交换器相关的操作方法有：</p>
<ul>
<li>exchange.declare</li>
<li>exchange.declare-OK</li>
<li>exchange.delete</li>
<li>exchange.delete-OK</li>
</ul>
<p>在逻辑上，上面几个操作方法在客户端和消息中间件代理之间的交互如下：</p>
<p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/r-a-m/r-a-m-2.png" alt="r-a-m-2.png"></p>
<p>对于队列，也有类似的操作方法：</p>
<ul>
<li>queue.declare</li>
<li>queue.declare-OK</li>
<li>queue.delete</li>
<li>queue.delete-OK</li>
</ul>
<p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/r-a-m/r-a-m-3.png" alt="r-a-m-3.png"></p>
<p>并非所有的AMQP操作方法都有响应结果操作方法，像消息发布方法<code>basic.publish</code>的使用是最广泛的，此操作方法没有对应的响应结果操作方法。有些操作方法可能有多个响应结果(操作方法)，例如<code>basic.get</code>。</p>
<h2 id="连接-Connection">连接(Connection)</h2>
<p>AMQP的连接(Connection)通常是长期存在的。AMQP是一种使用TCP进行可靠传递的应用程序级协议。AMQP连接使用用户身份验证，可以使用TLS(SSL)进行保护。当应用程序不再需要连接到AMQP代理时，它应该正常关闭AMQP连接，而不是突然关闭底层TCP连接。</p>
<h2 id="通道-Channel">通道(Channel)</h2>
<p>某些应用程序需要与AMQP代理程序建立多个连接。但是，不希望同时打开许多TCP连接，因为这样做会消耗系统资源并使配置防火墙变得十分困难。通道(Channel)可以认为是&quot;共享一个单独的TCP连接的轻量级连接&quot;，一个AMQP连接可以拥有多个通道。</p>
<p>对于使用了多线程处理的应用程序，有一种使用场景十分普遍：每个线程开启一个新的通道使用，这些通道是线程间隔离的。</p>
<p>另外，每个特定的通道和其他通道是相互隔离的，每个执行的AMQP操作方法(包括响应)都携带一个通道的唯一标识，这样客户端就能通过该通道的唯一标识得知操作方法是对应哪个通道发生的。</p>
<h2 id="虚拟主机-Virtual-Host">虚拟主机(Virtual Host)</h2>
<p>为了使单个消息中间件代理可以托管多个完全隔离的&quot;环境&quot;(这里的隔离指的是用户组、交互器、队列等)，AMQP提供了虚拟主机(Virtual Host)的概念。多个虚拟主机类似于许多主流的Web服务器的虚拟主机，提供了AMQP组件完全隔离的环境。AMQP客户端可以在连接消息中间件代理时指定需要连接的虚拟主机。</p>
<h2 id="个人理解">个人理解</h2>
<h3 id="关于Exchange、Queue和Binding">关于Exchange、Queue和Binding</h3>
<p>理解RabbitMQ中的AMQP模型，其实从开发者的角度来看，最重要的是Exchange、Queue、Binding三者的关系，这里谈谈个人的见解。消息的发布第一站总是Exchange，从模型上看，消息发布无法直接发送到队列中。Exchange本身不存储消息，它在接收到消息之后，会基于路由规则也就是Binding，把消息路由到目标Queue中。从实际操作来看，声明路由规则总是在发布消息和消费消息之前，也就是一般步骤如下：</p>
<ul>
<li>1、声明Exchange。</li>
<li>2、声明Queue。</li>
<li>3、基于Exchange和Queue声明Binding，这个过程有可能自定义一个RoutingKey。</li>
<li>4、通过Exchange消息发布，这个过程有可能使用到上一步定义的RoutingKey。</li>
<li>5、通过Queue消费消息。</li>
</ul>
<p>我们最关注的两个阶段，消息发布和消息消费中，<strong>消息发布实际上只跟Exchange有关，而消息消费实际上只跟Queue有关</strong>。Binding实际上就是Exchange和Queue的契约关系，会直接影响消息发布阶段的消息路由。那么，路由失败一般是什么情况导致的？路由失败，其实就是消息已经发布到Exchange，而Exchange中从既有的Binding中无法找到存在的目标Queue用于传递消息副本(一般而言，很少人会发送消息到一个不存在的Exchange)。消息路由失败，从理解AMQP的模型来看，可以从根本上避免的，除非是消息发布者故意胡乱使用或者人为错误使用了未存在的RoutingKey、Exchange或者说是Binding关系而导致的。</p>
<h3 id="关于Exchange的类型">关于Exchange的类型</h3>
<p>AMQP-0-9-1模型中支持了四种交换器direct(单播)、fanout(广播)、topic(多播)、headers，实际上，从使用者角度来看，四种交换器的功能是可以相互取代的。例如可以使用fanout类型交换器实现广播，其实使用direct类型交换器也是可以实现广播的，只是对应的direct类型交换器需要通过多个路由键绑定到多个目标队列中。在面对生产环境的技术选型的时候，我们需要考虑性能、维护难度、合理性等角度去考虑选择什么类型的交换器，就上面的广播消息的例子，显然使用fanout类型交换器可以避免声明多个绑定关系，这样在性能、合理性上是更优的选择。</p>
<h3 id="关于负载均衡">关于负载均衡</h3>
<p>在AMQP-0-9-1模型中，负载均衡的实现是基于消费者而不是基于队列(准确来说应该是消息传递到队列的方式)。实际上，出现消息生产速度大大超过消费者的消费速度的时候，队列中有可能会出现消息积压。AMQP-0-9-1模型中没有提供基于队列负载均衡的特性，也就是出现消息生产速度大大超过消费者的消费速度时候，并不会把消息路由到多个队列中，而是通过预取消息(Prefetching Messages)的特性，确定消息者的消费能力，从而调整消息中间件代理推送消息到对应消费者的数量，这样就能够实现消费速度快的消费者能够消费更多的消息，减少产生有消费者处于饥饿状态和有消费者长期处于忙碌状态的问题。</p>
<h3 id="关于消息确认机制">关于消息确认机制</h3>
<p>AMQP中提供的消息确认机制主要包括积极确认(一般叫ack，Acknowledgement)、消极确认(一般叫nack，Negative Acknowledgement)和拒绝(reject)。消息确认机制是保证消息不丢失的重要措施，当消费者接收到消息中间件代理推送的消息时候，需要主动通知消息中间件代理消息已经确认投递成功，然后消息中间件代理才会从队列中删除对应的消息。没有主动确认的消息就会变为&quot;nack&quot;状态，可以想象为暂存在队列的&quot;nack区&quot;中，这些消息不会投递到消费者，直到消费者重启后，&quot;nack区&quot;中的消息会重新变为&quot;ready&quot;状态，可以重新投递给消费者。关于消息确认机制其实场景比较复杂，后面再做一篇文章专门分析。</p>
<h2 id="小结">小结</h2>
<p>参考资料：</p>
<ul>
<li><a href="https://www.rabbitmq.com/tutorials/amqp-concepts.html" target="_blank" rel="noopener">AMQP 0-9-1 Model Explained</a></li>
</ul>

      
    </div>
    <!-- 
      <div class="full-width auto-padding tags">
        
          <a href="/blog/tags/Middleware/" rel="nofollow"><i class="fas fa-tag fa-fw"></i> Middleware</a>
        
          <a href="/blog/tags/RabbitMQ/" rel="nofollow"><i class="fas fa-tag fa-fw"></i> RabbitMQ</a>
        
      </div>
     -->
  </section>
</article>

          </div>
        
      
        
          <div class='post-wrapper'>
            <article class="post white-box card-shadow  reveal ">
  


  <section class='meta'>
    
    
    <div class="meta" id="header-meta">
      
        
  <h2 class="title">
    <a href="/2018/11/18/rabbitmq-installation/">
      RabbitMQ服务端的安装和使用
    </a>
  </h2>


      
      <div class='new-meta-box'>
        
          
        
          
            
  <div class='new-meta-item author'>
    
      <a href="http://throwable.club" rel="nofollow">
        
          <img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/mine/doge_avatar.jpg">
        
        <p>Throwable</p>
      </a>
    
  </div>


          
        
          
            <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-edit" aria-hidden="true"></i>
    <p>发布于：2018年11月18日</p>
  </a>
</div>

          
        
          
            
  
  <div class='new-meta-item category'>
    <a href='/blog/categories/Middleware/RabbitMQ/' rel="nofollow">
      <i class="fas fa-folder-open" aria-hidden="true"></i>
      <p>Middleware&nbsp;/&nbsp;RabbitMQ</p>
    </a>
  </div>


          
        
          
            
  <div class="new-meta-item wordcount">
    <a class='notlink'>
      <i class="fas fa-keyboard" aria-hidden="true"></i>
      <p>字数：1.3k字</p>
    </a>
  </div>
  <div class="new-meta-item readtime">
    <a class='notlink'>
      <i class="fas fa-hourglass-half" aria-hidden="true"></i>
      <p>时长：5分钟</p>
    </a>
  </div>


          
        
          
            <div class="new-meta-item date" itemprop="dateUpdated" datetime="2018-11-20T23:50:43+08:00">
  <a class='notlink'>
    <i class="fas fa-save" aria-hidden="true"></i>
    <p>更新于：2018年11月20日</p>
  </a>
</div>

          
        
          
            

          
        
          
            

          
        
      </div>
      
        <hr>
      
    </div>
  </section>


  <section class="article typo">
    <div class="article-entry" itemprop="articleBody">
      <h1>前提</h1>
<p>工作接近3年，一直有使用RabbitMQ作为服务间解耦的中间件，但是一直没有做一系列学习和总结，这里决心做一个系列总结一下RabbitMQ的运维、使用以及生产中遇到的问题等，以便日后直接拿起来使用。整个系列使用的Linux系统为CentOS 7的最新版本<code>CentOS-7-x86_64-Minimal-1804</code>。而<code>RabbitMQ Server</code>使用当前最新的版本3.7.9.RELEASE。</p>
<h2 id="RabbitMQ-Server的安装">RabbitMQ Server的安装</h2>
<p><code>RabbitMQ Server</code>使用Erlang语言编写，Erlang语言的并发编程支持比较优异，所以我们要先安装Erlang(类似于我们需要运行Java程序，要先安装JVM)：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加erlang的yum源</span></span><br><span class="line">rpm --import https://packages.erlang-solutions.com/rpm/erlang_solutions.asc</span><br></pre></td></tr></table></figure>
<p><strong>或者</strong>直接在目录<code>/etc/yum.repos.d/</code>手动添加一个新的.repo文件(文件名可以随意如erlang.repos)，内容是：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[erlang-solutions]</span><br><span class="line">name=CentOS <span class="variable">$releasever</span> - <span class="variable">$basearch</span> - Erlang Solutions</span><br><span class="line">baseurl=https://packages.erlang-solutions.com/rpm/centos/<span class="variable">$releasever</span>/<span class="variable">$basearch</span></span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=https://packages.erlang-solutions.com/rpm/erlang_solutions.asc</span><br><span class="line">enabled=1</span><br></pre></td></tr></table></figure>
<p>然后执行命令安装Erlang：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装erlang</span></span><br><span class="line">sudo yum install erlang</span><br></pre></td></tr></table></figure>
<p>安装完成之后Erlang会自行后台运行，输入erl就能进入Erlang的命令行工具说明安装成功：</p>
<p><img src="http://pazkqls86.bkt.clouddn.com/r-s-1.png" alt="r-s-1.png"></p>
<p>安装Erlang过程中如果提示：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">error: Failed dependencies:</span><br><span class="line">	epel-release is needed by erlang-solutions-1.0-1.noarch</span><br></pre></td></tr></table></figure>
<p>说明缺少<code>epel-release</code>依赖，通过<code>sudo yum install epel-release</code>安装<code>epel-release</code>即可。</p>
<p>接着可以安装<code>RabbitMQ Server</code>，先下载其RPM安装包：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 下载</span></span><br><span class="line">wget https://github.com/rabbitmq/rabbitmq-server/releases/download/v3.7.9/rabbitmq-server-3.7.9-1.el7.noarch.rpm</span><br></pre></td></tr></table></figure>
<p>接着在下载文件目录中执行安装命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 在Yum仓库可以使用之前，需要让RPM工具信任RabbitMQ的rpm包的签名，需要执行下面的命令</span></span><br><span class="line">rpm --import https://www.rabbitmq.com/rabbitmq-release-signing-key.asc</span><br><span class="line"><span class="comment"># Yum安装</span></span><br><span class="line">yum install rabbitmq-server-3.7.9-1.el7.noarch.rpm</span><br></pre></td></tr></table></figure>
<p>安装完成后，<code>RabbitMQ Server</code>会自行在后台运行，这个时候可以执行命令<code>rabbitmqctl status</code>验证其状态：</p>
<p><img src="http://pazkqls86.bkt.clouddn.com/r-s-2.png" alt="r-s-2.png"></p>
<h2 id="RabbitMQ-Server启动于停止">RabbitMQ Server启动于停止</h2>
<p><code>RabbitMQ Server</code>已经成功安装为CentOS 7的服务，它的启动和停止可以直接使用<code>systemctl</code>命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 启动</span></span><br><span class="line">systemctl start rabbitmq-server</span><br><span class="line"></span><br><span class="line"><span class="comment"># 停止</span></span><br><span class="line">systemctl stop rabbitmq-server</span><br><span class="line"></span><br><span class="line"><span class="comment"># 重启</span></span><br><span class="line">systemctl restart rabbitmq-server</span><br><span class="line"></span><br><span class="line"><span class="comment"># 前台启动,shell关闭会shutdown</span></span><br><span class="line">rabbitmq-server start</span><br><span class="line"></span><br><span class="line"><span class="comment"># 后台启动</span></span><br><span class="line">rabbitmq-server -detached</span><br></pre></td></tr></table></figure>
<p>当然，也可以使用<code>RabbitMQ Server</code>的<code>rabbitmqctl</code>命令(格式是：<code>rabbitmqctl [-n &lt;node&gt;] [-l] [-q] &lt;command&gt; [&lt;command options&gt;]</code>)：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 停止Erlang上的node节点</span></span><br><span class="line">rabbitmqctl stop_app</span><br><span class="line"><span class="comment"># 启动</span></span><br><span class="line">rabbitmqctl start_app</span><br></pre></td></tr></table></figure>
<h2 id="安装Web管理插件">安装Web管理插件</h2>
<p><code>RabbitMQ Server</code>管理插件的命令是<code>rabbitmq-plugins [-n &lt;node&gt;] [-l] [-q] &lt;command&gt; [&lt;command options&gt;]</code>，command部分目前只有下面几个：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Commands:</span><br><span class="line">    <span class="built_in">disable</span> &lt;plugin&gt;|--all [--offline] [--online]</span><br><span class="line">    <span class="built_in">enable</span> &lt;plugin&gt;|--all [--offline] [--online]</span><br><span class="line">    <span class="built_in">help</span> &lt;<span class="built_in">command</span>&gt;</span><br><span class="line">    list [pattern] [--verbose] [--minimal] [--enabled] [--implicitly-enabled]</span><br><span class="line">    <span class="built_in">set</span> [&lt;plugin&gt;] [--offline] [--online]</span><br></pre></td></tr></table></figure>
<p>我们可以通过命令<code>rabbitmq-plugins list</code>先展示所有可用的插件：</p>
<p><img src="http://pazkqls86.bkt.clouddn.com/r-s-3.png" alt="r-s-3.png"></p>
<p>其中的<code>rabbitmq_management</code>就是我们需要安装的Web管理界面，执行下面的命令启用Web管理插件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmq-plugins <span class="built_in">enable</span> rabbitmq_management</span><br></pre></td></tr></table></figure>
<p><img src="http://pazkqls86.bkt.clouddn.com/r-s-4.png" alt="r-s-4.png"></p>
<p>实际上是启用了<code>rabbitmq_management</code>、<code>rabbitmq_management_agent</code>、<code>rabbitmq_web_dispatch</code>三个插件。插件启动完毕后，我们需要添加一个新的用户或者修改原有的guest用户的权限，因为guest用户只允许使用localhost访问Web管理界面。</p>
<h2 id="用户管理">用户管理</h2>
<p>用户账号密码管理常用命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 新增一个用户</span></span><br><span class="line">rabbitmqctl add_user <span class="variable">$&#123;username&#125;</span> <span class="variable">$&#123;password&#125;</span></span><br><span class="line"><span class="comment"># 修改用户密码</span></span><br><span class="line">rabbitmqctl change_password <span class="variable">$&#123;old_password&#125;</span> <span class="variable">$&#123;new_password&#125;</span></span><br><span class="line"><span class="comment"># 验证用户密码</span></span><br><span class="line">rabbitmqctl authenticate_user <span class="variable">$&#123;username&#125;</span> <span class="variable">$&#123;password&#125;</span></span><br><span class="line"><span class="comment"># 删除用户</span></span><br><span class="line">rabbitmqctl delete_user <span class="variable">$&#123;username&#125;</span></span><br><span class="line"><span class="comment"># 展示用户列表</span></span><br><span class="line">rabbitmqctl list_users</span><br></pre></td></tr></table></figure>
<p>例如创建一个用户名和密码都是root的账号：<code>rabbitmqctl add_user root root</code>。</p>
<p>用户角色(Tag)管理常用命令格式是<code>rabbitmqctl set_user_tags ${username} ${tag...}</code>，可选的角色类型有：</p>
<table>
<thead>
<tr>
<th style="text-align:center">Tag</th>
<th style="text-align:center">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">none</td>
<td style="text-align:center">无角色，新创建的用户就是这类型的Tag</td>
</tr>
<tr>
<td style="text-align:center">management</td>
<td style="text-align:center">具备Web管理界面访问权限</td>
</tr>
<tr>
<td style="text-align:center">policymaker</td>
<td style="text-align:center">具备management所有权限，可以管理policy和parameter</td>
</tr>
<tr>
<td style="text-align:center">monitoring</td>
<td style="text-align:center">具备policymaker所有权限，可以监控连接、channel、节点信息等</td>
</tr>
<tr>
<td style="text-align:center">administrator</td>
<td style="text-align:center">管理员权限</td>
</tr>
</tbody>
</table>
<p>例如为root账号赋予管理员权限：<code>rabbitmqctl set_user_tags root administrator</code>。</p>
<p>用户权限(Permission)管理常用命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 添加权限</span></span><br><span class="line"><span class="comment"># vhost：虚拟host，默认为"/"</span></span><br><span class="line"><span class="comment"># username：用户名</span></span><br><span class="line"><span class="comment"># conf：配置权限，可以用正则表达式</span></span><br><span class="line"><span class="comment"># write：写权限，可以用正则表达式</span></span><br><span class="line"><span class="comment"># read：读权限，可以用正则表达式</span></span><br><span class="line">rabbitmqctl set_permissions [-p vhost] <span class="variable">$&#123;username&#125;</span> <span class="variable">$&#123;conf&#125;</span> <span class="variable">$&#123;write&#125;</span> <span class="variable">$&#123;read&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看虚拟host权限</span></span><br><span class="line">rabbitmqctl list_permissions [-p vhost]</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看用户权限</span></span><br><span class="line">rabbitmqctl list_user_permissions <span class="variable">$&#123;username&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 清除用户权限</span></span><br><span class="line">rabbitmqctl clear_permissions [-p vhost] <span class="variable">$&#123;username&#125;</span></span><br></pre></td></tr></table></figure>
<p>例如为root账号赋予虚拟host为&quot;/&quot;下的所有的配置、读、写权限：<code>rabbitmqctl set_permissions root &quot;.*&quot; &quot;.*&quot; &quot;.*&quot;</code>。</p>
<p>我们可以使用root账号登录Web管理界面：</p>
<p><img src="http://pazkqls86.bkt.clouddn.com/r-s-5.png" alt="r-s-5.png"></p>
<p>关于<code>RabbitMQ Server</code>多租户(虚拟Host)、角色、权限管理的其他细节暂时不展开，因为可能需要不少的篇幅才能说明。</p>
<h2 id="小结">小结</h2>
<p>关于<code>RabbitMQ Server</code>的命令和运维方面的东西暂时不大量展开，按照上面几节搭建好的RabbitMQ服务对于测试或者开发调试已经基本可用，接着就可以通过官方提供的例子进行学习。</p>
<p>参考资料：</p>
<ul>
<li><a href="https://www.erlang-solutions.com/resources/download.html" target="_blank" rel="noopener">https://www.erlang-solutions.com/resources/download.html</a></li>
<li><a href="http://www.rabbitmq.com/install-rpm.html" target="_blank" rel="noopener">http://www.rabbitmq.com/install-rpm.html</a></li>
</ul>
<p>参考资料的链接在将来不确定是否有变，主要是参考了erlang和rabbitmq的官方文档的安装提示。</p>
<p>(本文完 c-1-d e-20181118)</p>

      
    </div>
    <!-- 
      <div class="full-width auto-padding tags">
        
          <a href="/blog/tags/Middleware/" rel="nofollow"><i class="fas fa-tag fa-fw"></i> Middleware</a>
        
          <a href="/blog/tags/RabbitMQ/" rel="nofollow"><i class="fas fa-tag fa-fw"></i> RabbitMQ</a>
        
      </div>
     -->
  </section>
</article>

          </div>
        
      
        
          <div class='post-wrapper'>
            <article class="post white-box card-shadow  reveal ">
  


  <section class='meta'>
    
    
    <div class="meta" id="header-meta">
      
        
  <h2 class="title">
    <a href="/2018/11/17/jvm-micrometer-prometheus/">
      JVM应用度量框架Micrometer实战
    </a>
  </h2>


      
      <div class='new-meta-box'>
        
          
        
          
            
  <div class='new-meta-item author'>
    
      <a href="http://throwable.club" rel="nofollow">
        
          <img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/mine/doge_avatar.jpg">
        
        <p>Throwable</p>
      </a>
    
  </div>


          
        
          
            <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-edit" aria-hidden="true"></i>
    <p>发布于：2018年11月17日</p>
  </a>
</div>

          
        
          
            
  
  <div class='new-meta-item category'>
    <a href='/blog/categories/Framework/Micrometer/' rel="nofollow">
      <i class="fas fa-folder-open" aria-hidden="true"></i>
      <p>Framework&nbsp;/&nbsp;Micrometer</p>
    </a>
  </div>


          
        
          
            
  <div class="new-meta-item wordcount">
    <a class='notlink'>
      <i class="fas fa-keyboard" aria-hidden="true"></i>
      <p>字数：7.8k字</p>
    </a>
  </div>
  <div class="new-meta-item readtime">
    <a class='notlink'>
      <i class="fas fa-hourglass-half" aria-hidden="true"></i>
      <p>时长：33分钟</p>
    </a>
  </div>


          
        
          
            <div class="new-meta-item date" itemprop="dateUpdated" datetime="2019-01-08T22:46:58+08:00">
  <a class='notlink'>
    <i class="fas fa-save" aria-hidden="true"></i>
    <p>更新于：2019年1月8日</p>
  </a>
</div>

          
        
          
            

          
        
          
            

          
        
      </div>
      
        <hr>
      
    </div>
  </section>


  <section class="article typo">
    <div class="article-entry" itemprop="articleBody">
      <h1>JVM应用度量框架Micrometer实战</h1>
<h2 id="前提">前提</h2>
<p>最近线上的项目使用了<code>spring-actuator</code>做度量统计收集，使用Prometheus进行数据收集，Grafana进行数据展示，用于监控生成环境机器的性能指标和业务数据指标。一般，我们叫这样的操作为&quot;埋点&quot;。SpringBoot中的依赖<code>spring-actuator</code>中集成的度量统计API使用的框架是Micrometer，<a href="http://xn--Micrometer-fo3su03h0j2e.io" target="_blank" rel="noopener">官网是Micrometer.io</a>。在实践中发现了业务开发者滥用了Micrometer的度量类型<code>Counter</code>，导致无论什么情况下都只使用计数统计的功能。这篇文章就是基于Micrometer分析其他的度量类型API的作用和适用场景。</p>
<h2 id="Micrometer提供的度量类库">Micrometer提供的度量类库</h2>
<p><code>Meter</code>是指一组用于收集应用中的度量数据的接口，Meter单词可以翻译为&quot;米&quot;或者&quot;千分尺&quot;，但是显然听起来都不是很合理，因此下文直接叫Meter，理解它为度量接口即可。<code>Meter</code>是由<code>MeterRegistry</code>创建和保存的，可以理解<code>MeterRegistry</code>是<code>Meter</code>的工厂和缓存中心，一般而言每个JVM应用在使用Micrometer的时候必须创建一个<code>MeterRegistry</code>的具体实现。Micrometer中，<code>Meter</code>的具体类型包括：<code>Timer</code>，<code>Counter</code>，<code>Gauge</code>，<code>DistributionSummary</code>，<code>LongTaskTimer</code>，<code>FunctionCounter</code>，<code>FunctionTimer</code>和<code>TimeGauge</code>。下面分节详细介绍这些类型的使用方法和实战使用场景。而一个<code>Meter</code>具体类型需要通过名字和<code>Tag</code>(这里指的是Micrometer提供的Tag接口)作为它的唯一标识，这样做的好处是可以使用名字进行标记，通过不同的<code>Tag</code>去区分多种维度进行数据统计。</p>
<h2 id="MeterRegistry">MeterRegistry</h2>
<p>MeterRegistry在Micrometer是一个抽象类，主要实现包括：</p>
<ul>
<li>1、SimpleMeterRegistry：每个Meter的最新数据可以收集到SimpleMeterRegistry实例中，但是这些数据不会发布到其他系统，也就是数据是位于应用的内存中的。</li>
<li>2、CompositeMeterRegistry：多个MeterRegistry聚合，内部维护了一个MeterRegistry的列表。</li>
<li>3、全局的MeterRegistry：工厂类<code>io.micrometer.core.instrument.Metrics</code>中持有一个静态final的<code>CompositeMeterRegistry</code>实例globalRegistry。</li>
</ul>
<p>当然，使用者也可以自行继承MeterRegistry去实现自定义的MeterRegistry。<code>SimpleMeterRegistry</code>适合做调试的时候使用，它的简单使用方式如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MeterRegistry registry = <span class="keyword">new</span> SimpleMeterRegistry();</span><br><span class="line">Counter counter = registry.counter(<span class="string">"counter"</span>);</span><br><span class="line">counter.increment();</span><br></pre></td></tr></table></figure>
<p><code>CompositeMeterRegistry</code>实例初始化的时候，内部持有的<code>MeterRegistry</code>列表是空的，如果此时用它新增一个Meter实例，Meter实例的操作是无效的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CompositeMeterRegistry composite = <span class="keyword">new</span> CompositeMeterRegistry();</span><br><span class="line"></span><br><span class="line">Counter compositeCounter = composite.counter(<span class="string">"counter"</span>);</span><br><span class="line">compositeCounter.increment(); <span class="comment">// &lt;- 实际上这一步操作是无效的,但是不会报错</span></span><br><span class="line"></span><br><span class="line">SimpleMeterRegistry simple = <span class="keyword">new</span> SimpleMeterRegistry();</span><br><span class="line">composite.add(simple);  <span class="comment">// &lt;- 向CompositeMeterRegistry实例中添加SimpleMeterRegistry实例</span></span><br><span class="line"></span><br><span class="line">compositeCounter.increment();  <span class="comment">// &lt;-计数成功</span></span><br></pre></td></tr></table></figure>
<p>全局的MeterRegistry的使用方式更加简单便捷，因为一切只需要操作工厂类<code>Metrics</code>的静态方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Metrics.addRegistry(<span class="keyword">new</span> SimpleMeterRegistry());</span><br><span class="line">Counter counter = Metrics.counter(<span class="string">"counter"</span>, <span class="string">"tag-1"</span>, <span class="string">"tag-2"</span>);</span><br><span class="line">counter.increment();</span><br></pre></td></tr></table></figure>
<h2 id="Tag与Meter的命名">Tag与Meter的命名</h2>
<p>Micrometer中，Meter的命名约定使用英文逗号(dot，也就是&quot;.&quot;)分隔单词。但是对于不同的监控系统，对命名的规约可能并不相同，如果命名规约不一致，在做监控系统迁移或者切换的时候，可能会对新的系统造成破坏。Micrometer中使用英文逗号分隔单词的命名规则，再通过底层的命名转换接口<code>NamingConvention</code>进行转换，最终可以适配不同的监控系统，同时可以消除监控系统不允许的特殊字符的名称和标记等。开发者也可以覆盖<code>NamingConvention</code>实现自定义的命名转换规则：<code>registry.config().namingConvention(myCustomNamingConvention);</code>。在Micrometer中，对一些主流的监控系统或者存储系统的命名规则提供了默认的转换方式，例如当我们使用下面的命名时候：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MeterRegistry registry = ...</span><br><span class="line">registry.timer(<span class="string">"http.server.requests"</span>);</span><br></pre></td></tr></table></figure>
<p>对于不同的监控系统或者存储系统，命名会自动转换如下：</p>
<ul>
<li>1、Prometheus - http_server_requests_duration_seconds。</li>
<li>2、Atlas - httpServerRequests。</li>
<li>3、Graphite - http.server.requests。</li>
<li>4、InfluxDB - http_server_requests。</li>
</ul>
<p>其实<code>NamingConvention</code>已经提供了5种默认的转换规则：dot、snakeCase、camelCase、upperCamelCase和slashes。</p>
<p>另外，Tag(标签)是Micrometer的一个重要的功能，严格来说，一个度量框架只有实现了标签的功能，才能真正地多维度进行度量数据收集。Tag的命名一般需要是有意义的，所谓有意义就是可以根据Tag的命名可以推断出它指向的数据到底代表什么维度或者什么类型的度量指标。假设我们需要监控数据库的调用和Http请求调用统计，一般推荐的做法是：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MeterRegistry registry = ...</span><br><span class="line">registry.counter(<span class="string">"database.calls"</span>, <span class="string">"db"</span>, <span class="string">"users"</span>)</span><br><span class="line">registry.counter(<span class="string">"http.requests"</span>, <span class="string">"uri"</span>, <span class="string">"/api/users"</span>)</span><br></pre></td></tr></table></figure>
<p>这样，当我们选择命名为&quot;database.calls&quot;的计数器，我们可以进一步选择分组&quot;db&quot;或者&quot;users&quot;分别统计不同分组对总调用数的贡献或者组成。一个反例如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MeterRegistry registry = ...</span><br><span class="line">registry.counter(<span class="string">"calls"</span>,</span><br><span class="line">    <span class="string">"class"</span>, <span class="string">"database"</span>,</span><br><span class="line">    <span class="string">"db"</span>, <span class="string">"users"</span>);</span><br><span class="line"></span><br><span class="line">registry.counter(<span class="string">"calls"</span>,</span><br><span class="line">    <span class="string">"class"</span>, <span class="string">"http"</span>,</span><br><span class="line">    <span class="string">"uri"</span>, <span class="string">"/api/users"</span>);</span><br></pre></td></tr></table></figure>
<p>通过命名&quot;calls&quot;得到的计数器，由于标签混乱，数据是基本无法分组统计分析，这个时候可以认为得到的时间序列的统计数据是没有意义的。可以定义全局的Tag，也就是全局的Tag定义之后，会附加到所有的使用到的Meter上(只要是使用同一个MeterRegistry)，全局的Tag可以这样定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">MeterRegistry registry = ...</span><br><span class="line">registry.config().commonTags(<span class="string">"stack"</span>, <span class="string">"prod"</span>, <span class="string">"region"</span>, <span class="string">"us-east-1"</span>);</span><br><span class="line"><span class="comment">// 和上面的意义是一样的</span></span><br><span class="line">registry.config().commonTags(Arrays.asList(Tag.of(<span class="string">"stack"</span>, <span class="string">"prod"</span>), Tag.of(<span class="string">"region"</span>, <span class="string">"us-east-1"</span>)));</span><br></pre></td></tr></table></figure>
<p>像上面这样子使用，就能通过主机，实例，区域，堆栈等操作环境进行多维度深入分析。</p>
<p>还有两点点需要注意：</p>
<ul>
<li>1、Tag的值必须不为null。</li>
<li>2、Micrometer中，Tag必须成对出现，也就是Tag必须设置为偶数个，实际上它们以Key=Value的形式存在，具体可以看<code>io.micrometer.core.instrument.Tag</code>接口：</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Tag</span> <span class="keyword">extends</span> <span class="title">Comparable</span>&lt;<span class="title">Tag</span>&gt; </span>&#123;</span><br><span class="line">    <span class="function">String <span class="title">getKey</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">getValue</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> Tag <span class="title">of</span><span class="params">(String key, String value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ImmutableTag(key, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Tag o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.getKey().compareTo(o.getKey());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当然，有些时候，我们需要过滤一些必要的标签或者名称进行统计，或者为Meter的名称添加白名单，这个时候可以使用<code>MeterFilter</code>。<code>MeterFilter</code>本身提供一些列的静态方法，多个<code>MeterFilter</code>可以叠加或者组成链实现用户最终的过滤策略。例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">MeterRegistry registry = ...</span><br><span class="line">registry.config()</span><br><span class="line">    .meterFilter(MeterFilter.ignoreTags(<span class="string">"http"</span>))</span><br><span class="line">    .meterFilter(MeterFilter.denyNameStartsWith(<span class="string">"jvm"</span>));</span><br></pre></td></tr></table></figure>
<p>表示忽略&quot;http&quot;标签，拒绝名称以&quot;jvm&quot;字符串开头的Meter。更多用法可以参详一下<code>MeterFilter</code>这个类。</p>
<p>Meter的命名和Meter的Tag相互结合，以命名为轴心，以Tag为多维度要素，可以使度量数据的维度更加丰富，便于统计和分析。</p>
<h2 id="Meters">Meters</h2>
<p>前面提到Meter主要包括：<code>Timer</code>，<code>Counter</code>，<code>Gauge</code>，<code>DistributionSummary</code>，<code>LongTaskTimer</code>，<code>FunctionCounter</code>，<code>FunctionTimer</code>和<code>TimeGauge</code>。下面逐一分析它们的作用和个人理解的实际使用场景(应该说是生产环境)。</p>
<h3 id="Counter">Counter</h3>
<p><code>Counter</code>是一种比较简单的Meter，它是一种单值的度量类型，或者说是一个单值计数器。<code>Counter</code>接口允许使用者使用一个固定值(必须为正数)进行计数。准确来说：<code>Counter</code>就是一个增量为正数的单值计数器。这个举个很简单的使用例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">MeterRegistry meterRegistry = <span class="keyword">new</span> SimpleMeterRegistry();</span><br><span class="line">Counter counter = meterRegistry.counter(<span class="string">"http.request"</span>, <span class="string">"createOrder"</span>, <span class="string">"/order/create"</span>);</span><br><span class="line">counter.increment();</span><br><span class="line">System.out.println(counter.measure()); <span class="comment">// [Measurement&#123;statistic='COUNT', value=1.0&#125;]</span></span><br></pre></td></tr></table></figure>
<p><strong>使用场景：</strong></p>
<p><code>Counter</code>的作用是记录XXX的总量或者计数值，适用于一些增长类型的统计，例如下单、支付次数、Http请求总量记录等等，通过Tag可以区分不同的场景，对于下单，可以使用不同的Tag标记不同的业务来源或者是按日期划分，对于Http请求总量记录，可以使用Tag区分不同的URL。用下单业务举个例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//实体</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Order</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String orderId;</span><br><span class="line">	<span class="keyword">private</span> Integer amount;</span><br><span class="line">	<span class="keyword">private</span> String channel;</span><br><span class="line">	<span class="keyword">private</span> LocalDateTime createTime;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CounterMain</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> DateTimeFormatter FORMATTER = DateTimeFormatter.ofPattern(<span class="string">"yyyy-MM-dd"</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">static</span> &#123;</span><br><span class="line">		Metrics.addRegistry(<span class="keyword">new</span> SimpleMeterRegistry());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		Order order1 = <span class="keyword">new</span> Order();</span><br><span class="line">		order1.setOrderId(<span class="string">"ORDER_ID_1"</span>);</span><br><span class="line">		order1.setAmount(<span class="number">100</span>);</span><br><span class="line">		order1.setChannel(<span class="string">"CHANNEL_A"</span>);</span><br><span class="line">		order1.setCreateTime(LocalDateTime.now());</span><br><span class="line">		createOrder(order1);</span><br><span class="line">		Order order2 = <span class="keyword">new</span> Order();</span><br><span class="line">		order2.setOrderId(<span class="string">"ORDER_ID_2"</span>);</span><br><span class="line">		order2.setAmount(<span class="number">200</span>);</span><br><span class="line">		order2.setChannel(<span class="string">"CHANNEL_B"</span>);</span><br><span class="line">		order2.setCreateTime(LocalDateTime.now());</span><br><span class="line">		createOrder(order2);</span><br><span class="line">		Search.in(Metrics.globalRegistry).meters().forEach(each -&gt; &#123;</span><br><span class="line">			StringBuilder builder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">			builder.append(<span class="string">"name:"</span>)</span><br><span class="line">					.append(each.getId().getName())</span><br><span class="line">					.append(<span class="string">",tags:"</span>)</span><br><span class="line">					.append(each.getId().getTags())</span><br><span class="line">					.append(<span class="string">",type:"</span>).append(each.getId().getType())</span><br><span class="line">					.append(<span class="string">",value:"</span>).append(each.measure());</span><br><span class="line">			System.out.println(builder.toString());</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">createOrder</span><span class="params">(Order order)</span> </span>&#123;</span><br><span class="line">		<span class="comment">//忽略订单入库等操作</span></span><br><span class="line">		Metrics.counter(<span class="string">"order.create"</span>,</span><br><span class="line">				<span class="string">"channel"</span>, order.getChannel(),</span><br><span class="line">				<span class="string">"createTime"</span>, FORMATTER.format(order.getCreateTime())).increment();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>控制台输出：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">name:order.create,tags:[tag(channel=CHANNEL_A), tag(createTime=<span class="number">2018</span>-<span class="number">11</span>-<span class="number">10</span>)],type:COUNTER,value:[Measurement&#123;statistic=<span class="string">'COUNT'</span>, value=<span class="number">1.0</span>&#125;]</span><br><span class="line">name:order.create,tags:[tag(channel=CHANNEL_B), tag(createTime=<span class="number">2018</span>-<span class="number">11</span>-<span class="number">10</span>)],type:COUNTER,value:[Measurement&#123;statistic=<span class="string">'COUNT'</span>, value=<span class="number">1.0</span>&#125;]</span><br></pre></td></tr></table></figure>
<p>上面的例子是使用全局静态方法工厂类<code>Metrics</code>去构造Counter实例，实际上，<code>io.micrometer.core.instrument.Counter</code>接口提供了一个内部建造器类Counter.Builder去实例化Counter，Counter.Builder的使用方式如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CounterBuilderMain</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">		Counter counter = Counter.builder(<span class="string">"name"</span>)  <span class="comment">//名称</span></span><br><span class="line">				.baseUnit(<span class="string">"unit"</span>) <span class="comment">//基础单位</span></span><br><span class="line">				.description(<span class="string">"desc"</span>) <span class="comment">//描述</span></span><br><span class="line">				.tag(<span class="string">"tagKey"</span>, <span class="string">"tagValue"</span>)  <span class="comment">//标签</span></span><br><span class="line">				.register(<span class="keyword">new</span> SimpleMeterRegistry());<span class="comment">//绑定的MeterRegistry</span></span><br><span class="line">		counter.increment();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="FunctionCounter">FunctionCounter</h3>
<p><code>FunctionCounter</code>是<code>Counter</code>的特化类型，它把计数器数值增加的动作抽象成接口类型<code>ToDoubleFunction</code>，这个接口JDK1.8中对于<code>Function</code>的特化类型接口。<code>FunctionCounter</code>的使用场景和<code>Counter</code>是一致的，这里介绍一下它的用法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FunctionCounterMain</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		MeterRegistry registry = <span class="keyword">new</span> SimpleMeterRegistry();</span><br><span class="line">		AtomicInteger n = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line">		<span class="comment">//这里ToDoubleFunction匿名实现其实可以使用Lambda表达式简化为AtomicInteger::get</span></span><br><span class="line">		FunctionCounter.builder(<span class="string">"functionCounter"</span>, n, <span class="keyword">new</span> ToDoubleFunction&lt;AtomicInteger&gt;() &#123;</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">applyAsDouble</span><span class="params">(AtomicInteger value)</span> </span>&#123;</span><br><span class="line">				<span class="keyword">return</span> value.get();</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;).baseUnit(<span class="string">"function"</span>)</span><br><span class="line">				.description(<span class="string">"functionCounter"</span>)</span><br><span class="line">				.tag(<span class="string">"createOrder"</span>, <span class="string">"CHANNEL-A"</span>)</span><br><span class="line">				.register(registry);</span><br><span class="line">		<span class="comment">//下面模拟三次计数		</span></span><br><span class="line">		n.incrementAndGet();</span><br><span class="line">		n.incrementAndGet();</span><br><span class="line">		n.incrementAndGet();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>FunctionCounter</code>使用的一个明显的好处是，我们不需要感知FunctionCounter实例的存在，实际上我们只需要操作作为FunctionCounter实例构建元素之一的AtomicInteger实例即可，这种接口的设计方式在很多框架里面都可以看到。</p>
<h3 id="Timer">Timer</h3>
<p>Timer(计时器)适用于记录耗时比较短的事件的执行时间，通过时间分布展示事件的序列和发生频率。所有的Timer的实现至少记录了发生的事件的数量和这些事件的总耗时，从而生成一个时间序列。Timer的基本单位基于服务端的指标而定，但是实际上我们不需要过于关注Timer的基本单位，因为Micrometer在存储生成的时间序列的时候会自动选择适当的基本单位。Timer接口提供的常用方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Timer</span> <span class="keyword">extends</span> <span class="title">Meter</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">record</span><span class="params">(<span class="keyword">long</span> var1, TimeUnit var3)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">record</span><span class="params">(Duration duration)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.record(duration.toNanos(), TimeUnit.NANOSECONDS);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    &lt;T&gt; <span class="function">T <span class="title">record</span><span class="params">(Supplier&lt;T&gt; var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    &lt;T&gt; <span class="function">T <span class="title">recordCallable</span><span class="params">(Callable&lt;T&gt; var1)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">record</span><span class="params">(Runnable var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">default</span> Runnable <span class="title">wrap</span><span class="params">(Runnable f)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> () -&gt; &#123;</span><br><span class="line">            <span class="keyword">this</span>.record(f);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span> &lt;T&gt; <span class="function">Callable&lt;T&gt; <span class="title">wrap</span><span class="params">(Callable&lt;T&gt; f)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> () -&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.recordCallable(f);</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">count</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">double</span> <span class="title">totalTime</span><span class="params">(TimeUnit var1)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">double</span> <span class="title">mean</span><span class="params">(TimeUnit unit)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.count() == <span class="number">0L</span> ? <span class="number">0.0</span>D : <span class="keyword">this</span>.totalTime(unit) / (<span class="keyword">double</span>)<span class="keyword">this</span>.count();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">double</span> <span class="title">max</span><span class="params">(TimeUnit var1)</span></span>;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实际上，比较常用和方便的方法是几个函数式接口入参的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Timer timer = ...</span><br><span class="line">timer.record(() -&gt; dontCareAboutReturnValue());</span><br><span class="line">timer.recordCallable(() -&gt; returnValue());</span><br><span class="line"></span><br><span class="line">Runnable r = timer.wrap(() -&gt; dontCareAboutReturnValue());</span><br><span class="line">Callable c = timer.wrap(() -&gt; returnValue());</span><br></pre></td></tr></table></figure>
<p><strong>使用场景：</strong></p>
<p>根据个人经验和实践，总结如下：</p>
<ul>
<li>1、记录指定方法的执行时间用于展示。</li>
<li>2、记录一些任务的执行时间，从而确定某些数据来源的速率，例如消息队列消息的消费速率等。</li>
</ul>
<p>这里举个实际的例子，要对系统做一个功能，记录指定方法的执行时间，还是用下单方法做例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TimerMain</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Random R = <span class="keyword">new</span> Random();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">static</span> &#123;</span><br><span class="line">		Metrics.addRegistry(<span class="keyword">new</span> SimpleMeterRegistry());</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		Order order1 = <span class="keyword">new</span> Order();</span><br><span class="line">		order1.setOrderId(<span class="string">"ORDER_ID_1"</span>);</span><br><span class="line">		order1.setAmount(<span class="number">100</span>);</span><br><span class="line">		order1.setChannel(<span class="string">"CHANNEL_A"</span>);</span><br><span class="line">		order1.setCreateTime(LocalDateTime.now());</span><br><span class="line">		Timer timer = Metrics.timer(<span class="string">"timer"</span>, <span class="string">"createOrder"</span>, <span class="string">"cost"</span>);</span><br><span class="line">		timer.record(() -&gt; createOrder(order1));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">createOrder</span><span class="params">(Order order)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			TimeUnit.SECONDS.sleep(R.nextInt(<span class="number">5</span>)); <span class="comment">//模拟方法耗时</span></span><br><span class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">			<span class="comment">//no-op</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在实际生产环境中，可以通过<code>spring-aop</code>把记录方法耗时的逻辑抽象到一个切面中，这样就能减少不必要的冗余的模板代码。上面的例子是通过Mertics构造Timer实例，实际上也可以使用Builder构造：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">MeterRegistry registry = ...</span><br><span class="line">Timer timer = Timer</span><br><span class="line">    .builder(<span class="string">"my.timer"</span>)</span><br><span class="line">    .description(<span class="string">"a description of what this timer does"</span>) <span class="comment">// 可选</span></span><br><span class="line">    .tags(<span class="string">"region"</span>, <span class="string">"test"</span>) <span class="comment">// 可选</span></span><br><span class="line">    .register(registry);</span><br></pre></td></tr></table></figure>
<p>另外，Timer的使用还可以基于它的内部类<code>Timer.Sample</code>，通过start和stop两个方法记录两者之间的逻辑的执行耗时。例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Timer.Sample sample = Timer.start(registry);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这里做业务逻辑</span></span><br><span class="line">Response response = ...</span><br><span class="line"></span><br><span class="line">sample.stop(registry.timer(<span class="string">"my.timer"</span>, <span class="string">"response"</span>, response.status()));</span><br></pre></td></tr></table></figure>
<h3 id="FunctionTimer">FunctionTimer</h3>
<p>FunctionTimer是Timer的特化类型，它主要提供两个单调递增的函数(其实并不是单调递增，只是在使用中一般需要随着时间最少保持不变或者说不减少)：一个用于计数的函数和一个用于记录总调用耗时的函数，它的建造器的入参如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">FunctionTimer</span> <span class="keyword">extends</span> <span class="title">Meter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> &lt;T&gt; <span class="function">Builder&lt;T&gt; <span class="title">builder</span><span class="params">(String name, T obj, ToLongFunction&lt;T&gt; countFunction,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  ToDoubleFunction&lt;T&gt; totalTimeFunction,</span></span></span><br><span class="line"><span class="function"><span class="params">                                  TimeUnit totalTimeFunctionUnit)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Builder&lt;&gt;(name, obj, countFunction, totalTimeFunction, totalTimeFunctionUnit);</span><br><span class="line">    &#125;</span><br><span class="line">	...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>官方文档中的例子如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">IMap&lt;?, ?&gt; cache = ...; <span class="comment">// 假设使用了Hazelcast缓存</span></span><br><span class="line">registry.more().timer(<span class="string">"cache.gets.latency"</span>, Tags.of(<span class="string">"name"</span>, cache.getName()), cache,</span><br><span class="line">    c -&gt; c.getLocalMapStats().getGetOperationCount(),  <span class="comment">//实际上就是cache的一个方法，记录缓存生命周期初始化的增量(个数)</span></span><br><span class="line">    c -&gt; c.getLocalMapStats().getTotalGetLatency(),  <span class="comment">// Get操作的延迟时间总量，可以理解为耗时</span></span><br><span class="line">    TimeUnit.NANOSECONDS</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<p>按照个人理解，<code>ToDoubleFunction</code>用于统计事件个数，<code>ToDoubleFunction</code>用于记录执行总时间，实际上两个函数都只是Function函数的变体，还有一个比较重要的是总时间的单位totalTimeFunctionUnit。简单的使用方式如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FunctionTimerMain</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="comment">//这个是为了满足参数,暂时不需要理会</span></span><br><span class="line">		Object holder = <span class="keyword">new</span> Object();</span><br><span class="line">		AtomicLong totalTimeNanos = <span class="keyword">new</span> AtomicLong(<span class="number">0</span>);</span><br><span class="line">		AtomicLong totalCount = <span class="keyword">new</span> AtomicLong(<span class="number">0</span>);</span><br><span class="line">		FunctionTimer.builder(<span class="string">"functionTimer"</span>, holder, p -&gt; totalCount.get(), </span><br><span class="line">				p -&gt; totalTimeNanos.get(), TimeUnit.NANOSECONDS)</span><br><span class="line">				.register(<span class="keyword">new</span> SimpleMeterRegistry());</span><br><span class="line">		totalTimeNanos.addAndGet(<span class="number">10000000</span>);</span><br><span class="line">		totalCount.incrementAndGet();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="LongTaskTimer">LongTaskTimer</h3>
<p>LongTaskTimer也是一种Timer的特化类型，主要用于记录长时间执行的任务的持续时间，在任务完成之前，被监测的事件或者任务仍然处于运行状态，任务完成的时候，任务执行的总耗时才会被记录下来。LongTaskTimer适合用于长时间持续运行的事件耗时的记录，例如相对耗时的定时任务。在Spring应用中，可以简单地使用@Scheduled和@Timed注解，基于spring-aop完成定时调度任务的总耗时记录：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Timed</span>(value = <span class="string">"aws.scrape"</span>, longTask = <span class="keyword">true</span>)</span><br><span class="line"><span class="meta">@Scheduled</span>(fixedDelay = <span class="number">360000</span>)</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">scrapeResources</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">//这里做相对耗时的业务逻辑</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当然，在非spring体系中也能方便地使用LongTaskTimer：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LongTaskTimerMain</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">		MeterRegistry meterRegistry = <span class="keyword">new</span> SimpleMeterRegistry();</span><br><span class="line">		LongTaskTimer longTaskTimer = meterRegistry.more().longTaskTimer(<span class="string">"longTaskTimer"</span>);</span><br><span class="line">		longTaskTimer.record(() -&gt; &#123;</span><br><span class="line">			</span><br><span class="line">			<span class="comment">//这里编写Task的逻辑</span></span><br><span class="line">		&#125;);</span><br><span class="line">		<span class="comment">//或者这样</span></span><br><span class="line">		Metrics.more().longTaskTimer(<span class="string">"longTaskTimer"</span>).record(()-&gt; &#123;</span><br><span class="line">			<span class="comment">//这里编写Task的逻辑</span></span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Gauge">Gauge</h3>
<p>Gauge(仪表)是获取当前度量记录值的句柄，也就是它表示一个可以任意上下浮动的单数值度量Meter。Gauge通常用于变动的测量值，测量值用<code>ToDoubleFunction</code>参数的返回值设置，如当前的内存使用情况，同时也可以测量上下移动的&quot;计数&quot;，比如队列中的消息数量。官网文档中提到Gauge的典型使用场景是用于测量集合或映射的大小或运行状态中的线程数。Gauge一般用于监测有自然上界的事件或者任务，而Counter一般使用于无自然上界的事件或者任务的监测，所以像Http请求总量计数应该使用Counter而非Gauge。<code>MeterRegistry</code>中提供了一些便于构建用于观察数值、函数、集合和映射的Gauge相关的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; list = registry.gauge(<span class="string">"listGauge"</span>, Collections.emptyList(), <span class="keyword">new</span> ArrayList&lt;&gt;(), List::size); </span><br><span class="line">List&lt;String&gt; list2 = registry.gaugeCollectionSize(<span class="string">"listSize2"</span>, Tags.empty(), <span class="keyword">new</span> ArrayList&lt;&gt;()); </span><br><span class="line">Map&lt;String, Integer&gt; map = registry.gaugeMapSize(<span class="string">"mapGauge"</span>, Tags.empty(), <span class="keyword">new</span> HashMap&lt;&gt;());</span><br></pre></td></tr></table></figure>
<p>上面的三个方法通过<code>MeterRegistry</code>构建Gauge并且返回了集合或者映射实例，使用这些集合或者映射实例就能在其size变化过程中记录这个变更值。更重要的优点是，我们不需要感知Gauge接口的存在，只需要像平时一样使用集合或者映射实例就可以了。此外，Gauge还支持<code>java.lang.Number</code>的子类，<code>java.util.concurrent.atomic</code>包中的<code>AtomicInteger</code>和<code>AtomicLong</code>，还有Guava提供的<code>AtomicDouble</code>：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">AtomicInteger n = registry.gauge(<span class="string">"numberGauge"</span>, <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>));</span><br><span class="line">n.set(<span class="number">1</span>);</span><br><span class="line">n.set(<span class="number">2</span>);</span><br></pre></td></tr></table></figure>
<p>除了使用<code>MeterRegistry</code>创建Gauge之外，还可以使用建造器流式创建：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//一般我们不需要操作Gauge实例</span></span><br><span class="line">Gauge gauge = Gauge</span><br><span class="line">    .builder(<span class="string">"gauge"</span>, myObj, myObj::gaugeValue)</span><br><span class="line">    .description(<span class="string">"a description of what this gauge does"</span>) <span class="comment">// 可选</span></span><br><span class="line">    .tags(<span class="string">"region"</span>, <span class="string">"test"</span>) <span class="comment">// 可选</span></span><br><span class="line">    .register(registry);</span><br></pre></td></tr></table></figure>
<p><strong>使用场景：</strong></p>
<p>根据个人经验和实践，总结如下：</p>
<ul>
<li>1、有自然(物理)上界的浮动值的监测，例如物理内存、集合、映射、数值等。</li>
<li>2、有逻辑上界的浮动值的监测，例如积压的消息、(线程池中)积压的任务等，其实本质也是集合或者映射的监测。</li>
</ul>
<p>举个相对实际的例子，假设我们需要对登录后的用户发送一条短信或者推送，做法是消息先投放到一个阻塞队列，再由一个线程消费消息进行其他操作：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GaugeMain</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> MeterRegistry MR = <span class="keyword">new</span> SimpleMeterRegistry();</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> BlockingQueue&lt;Message&gt; QUEUE = <span class="keyword">new</span> ArrayBlockingQueue&lt;&gt;(<span class="number">500</span>);</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> BlockingQueue&lt;Message&gt; REAL_QUEUE;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">static</span> &#123;</span><br><span class="line">		REAL_QUEUE = MR.gauge(<span class="string">"messageGauge"</span>, QUEUE, Collection::size);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		consume();</span><br><span class="line">		Message message = <span class="keyword">new</span> Message();</span><br><span class="line">		message.setUserId(<span class="number">1L</span>);</span><br><span class="line">		message.setContent(<span class="string">"content"</span>);</span><br><span class="line">		REAL_QUEUE.put(message);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">consume</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">			<span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					Message message = REAL_QUEUE.take();</span><br><span class="line">					<span class="comment">//handle message</span></span><br><span class="line">					System.out.println(message);</span><br><span class="line">				&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">					<span class="comment">//no-op</span></span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;).start();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的例子代码写得比较糟糕，只为了演示相关使用方式，切勿用于生产环境。</p>
<h3 id="TimeGauge">TimeGauge</h3>
<p>TimeGauge是Gauge的特化类型，相比Gauge，它的构建器中多了一个TimeUnit类型的参数，用于指定<code>ToDoubleFunction</code>入参的基础时间单位。这里简单举个使用例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TimeGaugeMain</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> SimpleMeterRegistry R = <span class="keyword">new</span> SimpleMeterRegistry();</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">		AtomicInteger count = <span class="keyword">new</span> AtomicInteger();</span><br><span class="line">		TimeGauge.Builder&lt;AtomicInteger&gt; timeGauge = TimeGauge.builder(<span class="string">"timeGauge"</span>, count,</span><br><span class="line">				TimeUnit.SECONDS, AtomicInteger::get);</span><br><span class="line">		timeGauge.register(R);</span><br><span class="line">		count.addAndGet(<span class="number">10086</span>);</span><br><span class="line">		print();</span><br><span class="line">		count.set(<span class="number">1</span>);</span><br><span class="line">		print();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">print</span><span class="params">()</span><span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">		Search.in(R).meters().forEach(each -&gt; &#123;</span><br><span class="line">			StringBuilder builder = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">			builder.append(<span class="string">"name:"</span>)</span><br><span class="line">					.append(each.getId().getName())</span><br><span class="line">					.append(<span class="string">",tags:"</span>)</span><br><span class="line">					.append(each.getId().getTags())</span><br><span class="line">					.append(<span class="string">",type:"</span>).append(each.getId().getType())</span><br><span class="line">					.append(<span class="string">",value:"</span>).append(each.measure());</span><br><span class="line">			System.out.println(builder.toString());</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//输出</span></span><br><span class="line">name:timeGauge,tags:[],type:GAUGE,value:[Measurement&#123;statistic=<span class="string">'VALUE'</span>, value=<span class="number">10086.0</span>&#125;]</span><br><span class="line">name:timeGauge,tags:[],type:GAUGE,value:[Measurement&#123;statistic=<span class="string">'VALUE'</span>, value=<span class="number">1.0</span>&#125;]</span><br></pre></td></tr></table></figure>
<h3 id="DistributionSummary">DistributionSummary</h3>
<p>Summary(摘要)主要用于跟踪事件的分布，在Micrometer中，对应的类是DistributionSummary(分发摘要)。它的使用方式和Timer十分相似，但是它的记录值并不依赖于时间单位。常见的使用场景：使用DistributionSummary测量命中服务器的请求的有效负载大小。使用<code>MeterRegistry</code>创建DistributionSummary实例如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DistributionSummary summary = registry.summary(<span class="string">"response.size"</span>);</span><br></pre></td></tr></table></figure>
<p>通过建造器流式创建如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">DistributionSummary summary = DistributionSummary</span><br><span class="line">    .builder(<span class="string">"response.size"</span>)</span><br><span class="line">    .description(<span class="string">"a description of what this summary does"</span>) <span class="comment">// 可选</span></span><br><span class="line">    .baseUnit(<span class="string">"bytes"</span>) <span class="comment">// 可选</span></span><br><span class="line">    .tags(<span class="string">"region"</span>, <span class="string">"test"</span>) <span class="comment">// 可选</span></span><br><span class="line">    .scale(<span class="number">100</span>) <span class="comment">// 可选</span></span><br><span class="line">    .register(registry);</span><br></pre></td></tr></table></figure>
<p>DistributionSummary中有很多构建参数跟缩放和直方图的表示相关，见下一节。</p>
<p><strong>使用场景：</strong></p>
<p>根据个人经验和实践，总结如下：</p>
<ul>
<li>1、不依赖于时间单位的记录值的测量，例如服务器有效负载值，缓存的命中率等。</li>
</ul>
<p>举个相对具体的例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DistributionSummaryMain</span> </span>&#123;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> DistributionSummary DS  = DistributionSummary.builder(<span class="string">"cacheHitPercent"</span>)</span><br><span class="line">			.register(<span class="keyword">new</span> SimpleMeterRegistry());</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> LoadingCache&lt;String, String&gt; CACHE = CacheBuilder.newBuilder()</span><br><span class="line">			.maximumSize(<span class="number">1000</span>)</span><br><span class="line">			.recordStats()</span><br><span class="line">			.expireAfterWrite(<span class="number">60</span>, TimeUnit.SECONDS)</span><br><span class="line">			.build(<span class="keyword">new</span> CacheLoader&lt;String, String&gt;() &#123;</span><br><span class="line">				<span class="meta">@Override</span></span><br><span class="line">				<span class="function"><span class="keyword">public</span> String <span class="title">load</span><span class="params">(String s)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">					<span class="keyword">return</span> selectFromDatabase();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;);</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">		String key = <span class="string">"doge"</span>;</span><br><span class="line">		String value = CACHE.get(key);</span><br><span class="line">		record();</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">record</span><span class="params">()</span><span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">		CacheStats stats = CACHE.stats();</span><br><span class="line">		BigDecimal hitCount = <span class="keyword">new</span> BigDecimal(stats.hitCount());</span><br><span class="line">		BigDecimal requestCount = <span class="keyword">new</span> BigDecimal(stats.requestCount());</span><br><span class="line">		DS.record(hitCount.divide(requestCount,<span class="number">2</span>,BigDecimal.ROUND_HALF_DOWN).doubleValue());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="直方图和百分数配置">直方图和百分数配置</h3>
<p>直方图和百分数配置适用于Summary和Timer，这部分相对复杂，等研究透了再补充。</p>
<h1>基于SpirngBoot、Prometheus、Grafana集成</h1>
<p>集成了Micrometer框架的JVM应用使用到Micrometer的API收集的度量数据位于内存之中，因此，需要额外的存储系统去存储这些度量数据，需要有监控系统负责统一收集和处理这些数据，还需要有一些UI工具去展示数据，一般大佬只喜欢看炫酷的图表或者动画。常见的存储系统就是时序数据库，主流的有Influx、Datadog等。比较主流的监控系统(主要是用于数据收集和处理)就是Prometheus(一般叫普罗米修斯，下面就这样叫吧)。而展示的UI目前相对用得比较多的就是Grafana。另外，Prometheus已经内置了一个时序数据库的实现，因此，在做一套相对完善的度量数据监控的系统只需要依赖目标JVM应用，Prometheus组件和Grafana组件即可。下面花一点时间从零开始搭建一个这样的系统，之前写的一篇文章基于Windows系统，操作可能跟生产环境不够接近，这次使用CentOS7。</p>
<h2 id="SpirngBoot中使用Micrometer">SpirngBoot中使用Micrometer</h2>
<p>SpringBoot中的<code>spring-boot-starter-actuator</code>依赖已经集成了对Micrometer的支持，其中的metrics端点的很多功能就是通过Micrometer实现的，prometheus端点默认也是开启支持的，实际上actuator依赖的<code>spring-boot-actuator-autoconfigure</code>中集成了对很多框架的开箱即用的API，其中<code>prometheus</code>包中集成了对Prometheus的支持，使得使用了actuator可以轻易地让项目暴露出prometheus端点，作为Prometheus收集数据的客户端，Prometheus(服务端软件)可以通过此端点收集应用中Micrometer的度量数据。</p>
<p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201812/jvm-m-1.png" alt="jvm-m-1.png"></p>
<p>我们先引入<code>spring-boot-starter-actuator</code>和<code>spring-boot-starter-web</code>，实现一个<code>Counter</code>和<code>Timer</code>作为示例。依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.0.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">              <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.16.22<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.micrometer<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>micrometer-registry-prometheus<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>接着编写一个下单接口和一个消息发送模块，模拟用户下单之后向用户发送消息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//实体</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Message</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String orderId;</span><br><span class="line">	<span class="keyword">private</span> Long userId;</span><br><span class="line">	<span class="keyword">private</span> String content;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Order</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> String orderId;</span><br><span class="line">	<span class="keyword">private</span> Long userId;</span><br><span class="line">	<span class="keyword">private</span> Integer amount;</span><br><span class="line">	<span class="keyword">private</span> LocalDateTime createTime;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//控制器和服务类</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> OrderService orderService;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@PostMapping</span>(value = <span class="string">"/order"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> ResponseEntity&lt;Boolean&gt; <span class="title">createOrder</span><span class="params">(@RequestBody Order order)</span></span>&#123;</span><br><span class="line">		<span class="keyword">return</span> ResponseEntity.ok(orderService.createOrder(order));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Random R = <span class="keyword">new</span> Random();</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> MessageService messageService;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Boolean <span class="title">createOrder</span><span class="params">(Order order)</span> </span>&#123;</span><br><span class="line">		<span class="comment">//模拟下单</span></span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			<span class="keyword">int</span> ms = R.nextInt(<span class="number">50</span>) + <span class="number">50</span>;</span><br><span class="line">			TimeUnit.MILLISECONDS.sleep(ms);</span><br><span class="line">			log.info(<span class="string">"保存订单模拟耗时&#123;&#125;毫秒..."</span>, ms);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">			<span class="comment">//no-op</span></span><br><span class="line">		&#125;</span><br><span class="line">		<span class="comment">//记录下单总数</span></span><br><span class="line">		Metrics.counter(<span class="string">"order.count"</span>, <span class="string">"order.channel"</span>, order.getChannel()).increment();</span><br><span class="line">		<span class="comment">//发送消息</span></span><br><span class="line">		Message message = <span class="keyword">new</span> Message();</span><br><span class="line">		message.setContent(<span class="string">"模拟短信..."</span>);</span><br><span class="line">		message.setOrderId(order.getOrderId());</span><br><span class="line">		message.setUserId(order.getUserId());</span><br><span class="line">		messageService.sendMessage(message);</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MessageService</span> <span class="keyword">implements</span> <span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> BlockingQueue&lt;Message&gt; QUEUE = <span class="keyword">new</span> ArrayBlockingQueue&lt;&gt;(<span class="number">500</span>);</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> BlockingQueue&lt;Message&gt; REAL_QUEUE;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Executor EXECUTOR = Executors.newSingleThreadExecutor();</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Random R = <span class="keyword">new</span> Random();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">static</span> &#123;</span><br><span class="line">		REAL_QUEUE = Metrics.gauge(<span class="string">"message.gauge"</span>, Tags.of(<span class="string">"message.gauge"</span>, <span class="string">"message.queue.size"</span>), QUEUE, Collection::size);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMessage</span><span class="params">(Message message)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">try</span> &#123;</span><br><span class="line">			REAL_QUEUE.put(message);</span><br><span class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">			<span class="comment">//no-op</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		EXECUTOR.execute(() -&gt; &#123;</span><br><span class="line">			<span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">				<span class="keyword">try</span> &#123;</span><br><span class="line">					Message message = REAL_QUEUE.take();</span><br><span class="line">					log.info(<span class="string">"模拟发送短信,orderId:&#123;&#125;,userId:&#123;&#125;,内容:&#123;&#125;,耗时:&#123;&#125;毫秒"</span>, message.getOrderId(), message.getUserId(),</span><br><span class="line">							message.getContent(), R.nextInt(<span class="number">50</span>));</span><br><span class="line">				&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">					<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(e);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//切面类</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TimerAspect</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Around</span>(value = <span class="string">"execution(* club.throwable.smp.service.*Service.*(..))"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">around</span><span class="params">(ProceedingJoinPoint joinPoint)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">		Signature signature = joinPoint.getSignature();</span><br><span class="line">		MethodSignature methodSignature = (MethodSignature) signature;</span><br><span class="line">		Method method = methodSignature.getMethod();</span><br><span class="line">		Timer timer = Metrics.timer(<span class="string">"method.cost.time"</span>, <span class="string">"method.name"</span>, method.getName());</span><br><span class="line">		ThrowableHolder holder = <span class="keyword">new</span> ThrowableHolder();</span><br><span class="line">		Object result = timer.recordCallable(() -&gt; &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> joinPoint.proceed();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">				holder.throwable = e;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">		&#125;);</span><br><span class="line">		<span class="keyword">if</span> (<span class="keyword">null</span> != holder.throwable) &#123;</span><br><span class="line">			<span class="keyword">throw</span> holder.throwable;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> result;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ThrowableHolder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">		Throwable throwable;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>yaml的配置如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9091</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">10091</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">		<span class="attr">include:</span> <span class="string">'*'</span></span><br><span class="line">	  <span class="attr">base-path:</span> <span class="string">/management</span></span><br></pre></td></tr></table></figure>
<p>注意多看<a href="https://spring.io" target="_blank" rel="noopener">spring官方文档</a>关于Actuator的详细描述，在SpringBoot-2.x之后，配置Web端点暴露的权限控制和1.x有很大的不同。总结一下就是：除了<code>shutdown</code>端点之外，其他端点默认都是开启支持的(<strong>这里仅仅是开启支持，并不是暴露为Web端点，端点必须暴露为Web端点才能被访问</strong>)，禁用或者开启端点支持的配置方式如下：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">management.endpoint.$&#123;端点ID&#125;.enabled</span>=<span class="string">true/false</span></span><br></pre></td></tr></table></figure>
<p>可以查看<a href="https://docs.spring.io/spring-boot/docs/2.1.0.RELEASE/actuator-api//html/" target="_blank" rel="noopener">actuator-api文档</a>查看所有支持的端点的特性，这个是2.1.0.RELEASE版本的官方文档，不知道日后链接会不会挂掉。端点只开启支持，但是不暴露为Web端点，是无法通过<code>http://{host}:{management.port}/{management.endpoints.web.base-path}/{endpointId}</code>访问的。暴露监控端点为Web端点的配置是：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">management.endpoints.web.exposure.include</span>=<span class="string">info,health</span></span><br><span class="line"><span class="meta">management.endpoints.web.exposure.exclude</span>=<span class="string">prometheus</span></span><br></pre></td></tr></table></figure>
<p><code>management.endpoints.web.exposure.include</code>用于指定暴露为Web端点的监控端点，指定多个的时候用英文逗号分隔。<code>management.endpoints.web.exposure.exclude</code>用于指定不暴露为Web端点的监控端点，指定多个的时候用英文逗号分隔。<br>
<code>management.endpoints.web.exposure.include</code>默认指定的只有info和health两个端点，我们可以直接指定暴露所有的端点：<code>management.endpoints.web.exposure.include=*</code>，如果采用YAML配置，记得*要加单引号’*’。暴露所有Web监控端点是一件比较危险的事情，如果需要在生产环境这样做，请务必先确认<code>http://{host}:{management.port}</code>不能通过公网访问(也就是监控端点访问的端口只能通过内网访问，这样可以方便后面说到的Prometheus服务端通过此端口收集数据)。</p>
<h2 id="Prometheus的安装和配置">Prometheus的安装和配置</h2>
<p><a href="https://prometheus.io" target="_blank" rel="noopener">Prometheus</a>目前的最新版本是2.5，鉴于笔者没深入玩过Docker，这里还是直接下载它的压缩包解压安装。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/prometheus/prometheus/releases/download/v2.5.0/prometheus-2.5.0.linux-amd64.tar.gz</span><br><span class="line">tar xvfz prometheus-*.tar.gz</span><br><span class="line"><span class="built_in">cd</span> prometheus-*</span><br></pre></td></tr></table></figure>
<p>先编辑解压出来的目录下的prometheus配置文件<code>prometheus.yml</code>，主要修改scrape_configs节点的属性：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">scrape_configs:</span></span><br><span class="line">  <span class="comment"># The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">job_name:</span> <span class="string">'prometheus'</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># metrics_path defaults to '/metrics'</span></span><br><span class="line">    <span class="comment"># scheme defaults to 'http'.</span></span><br><span class="line">    <span class="comment"># 这里配置需要拉取度量信息的URL路径，这里选择应用程序的prometheus端点</span></span><br><span class="line">	<span class="attr">metrics_path:</span> <span class="string">/management/prometheus</span></span><br><span class="line">	<span class="attr">static_configs:</span></span><br><span class="line">	<span class="comment"># 这里配置host和port</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">targets:</span> <span class="string">['localhost:10091']</span></span><br></pre></td></tr></table></figure>
<p>配置拉取度量数据的路径为<code>localhost:10091/management/metrics</code>，此前记得把前一节提到的应用在虚拟机中启动。接着启动Prometheus应用：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 可选参数 --storage.tsdb.path=存储数据的路径，默认路径为./data</span></span><br><span class="line">./prometheus --config.file=prometheus.yml</span><br></pre></td></tr></table></figure>
<p>Prometheus引用的默认启动端口是9090，启动成功后，日志如下：</p>
<p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201812/jvm-m-2.png" alt="jvm-m-2.png"></p>
<p>此时，访问<code>http://${虚拟机host}:9090/targets</code>就能看到当前Prometheus中执行的Job：</p>
<p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201812/jvm-m-3.png" alt="jvm-m-3.png"></p>
<p>访问<code>http://${虚拟机host}:9090/graph</code>可以查找到我们定义的度量Meter和<code>spring-boot-starter-actuator</code>中已经定义好的一些关于JVM或者Tomcat的度量Meter。我们先对应用的<code>/order</code>接口进行调用，然后查看一下监控前面在应用中定义的<code>order_count_total</code>和<code>method_cost_time_seconds_sum</code>：</p>
<p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201812/jvm-m-4.png" alt="jvm-m-4.png"></p>
<p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201812/jvm-m-5.png" alt="jvm-m-5.png"></p>
<p>可以看到，Meter的信息已经被收集和展示，但是显然不够详细和炫酷，这个时候就需要使用Grafana的UI做一下点缀。</p>
<h2 id="Grafana的安装和使用">Grafana的安装和使用</h2>
<p>Grafana的安装过程如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://s3-us-west-2.amazonaws.com/grafana-releases/release/grafana-5.3.4-1.x86_64.rpm </span><br><span class="line">sudo yum localinstall grafana-5.3.4-1.x86_64.rpm</span><br></pre></td></tr></table></figure>
<p>安装完成后，通过命令<code>service grafana-server start</code>启动即可，默认的启动端口为3000，通过<code>http://${host}:3000</code>访问即可。初始的账号密码都为admin，权限是管理员权限。接着需要在Home面板添加一个数据源，目的是对接Prometheus服务端从而可以拉取它里面的度量数据。数据源添加面板如下：</p>
<p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201812/jvm-m-6.png" alt="jvm-m-6.png"></p>
<p>其实就是指向Prometheus服务端的端口就可以了。接下来可以天马行空地添加需要的面板，就下单数量统计的指标，可以添加一个<code>Graph</code>的面板：</p>
<p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201812/jvm-m-7.png" alt="jvm-m-7.png"></p>
<p>配置面板的时候，需要在基础(General)中指定Title：</p>
<p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201812/jvm-m-9.png" alt="jvm-m-9.png"></p>
<p>接着比较重要的是Metrics的配置，需要指定数据源和Prometheus的查询语句：</p>
<p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201812/jvm-m-8.png" alt="jvm-m-8.png"></p>
<p>最好参考一下Prometheus的官方文档，稍微学习一下它的查询语言PromQL的使用方式，一个面板可以支持多个PromQL查询。前面提到的两项是基本配置，其他配置项一般是图表展示的辅助或者预警等辅助功能，这里先不展开，可以取Grafana的官网挖掘一下使用方式。然后我们再调用一下下单接口，过一段时间，图表的数据就会自动更新和展示：</p>
<p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201812/jvm-m-10.png" alt="jvm-m-10.png"></p>
<p>接着添加一下项目中使用的Timer的Meter，便于监控方法的执行时间，完成之后大致如下：</p>
<p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201812/jvm-m-11.png" alt="jvm-m-11.png"></p>
<p>上面的面板虽然设计相当粗糙，但是基本功能已经实现。设计面板并不是一件容易的事，如果有需要可以从Github中搜索一下<code>grafana dashboard</code>关键字找现成的开源配置使用或者二次加工后使用。</p>
<h2 id="小结">小结</h2>
<p>常言道：工欲善其事，必先利其器。Micrometer是JVM应用的一款相当优异的度量框架，它提供基于Tag和丰富的度量类型和API便于多维度地进行不同角度度量数据的统计，可以方便地接入Prometheus进行数据收集，使用Grafana的面板进行炫酷的展示，提供了天然的spring-boot体系支持。但是，在实际的业务代码中，度量类型<code>Counter</code>经常被滥用，一旦工具被不加思考地滥用，就反而会成为混乱或者毒瘤。因此，这篇文章就是对Micrometer中的各种Meter的使用场景基于个人的理解做了调研和分析，分享一下实战中的经验和踩坑经历。</p>
<p>以前写过的一篇文章：</p>
<ul>
<li><a href="https://zjcscut.github.io/2018/11/10/spring-cloud-prometheus/" target="_blank" rel="noopener">基于Prometheus搭建SpringCloud全方位立体监控体系</a></li>
</ul>
<p>参考资料：</p>
<ul>
<li><a href="https://micrometer.io/docs" target="_blank" rel="noopener">https://micrometer.io/docs</a></li>
<li><a href="https://grafana.com" target="_blank" rel="noopener">https://grafana.com</a></li>
<li><a href="https://prometheus.io" target="_blank" rel="noopener">https://prometheus.io</a></li>
</ul>
<p>(To be continue c-10-d n-e-20181102 最近有点忙，没办法经常更新 r-a-201918)</p>

      
    </div>
    <!-- 
      <div class="full-width auto-padding tags">
        
          <a href="/blog/tags/Framework/" rel="nofollow"><i class="fas fa-tag fa-fw"></i> Framework</a>
        
          <a href="/blog/tags/Micrometer/" rel="nofollow"><i class="fas fa-tag fa-fw"></i> Micrometer</a>
        
      </div>
     -->
  </section>
</article>

          </div>
        
      
        
          <div class='post-wrapper'>
            <article class="post white-box card-shadow  reveal ">
  


  <section class='meta'>
    
    
    <div class="meta" id="header-meta">
      
        
  <h2 class="title">
    <a href="/2018/11/10/spring-cloud-prometheus/">
      基于Prometheus搭建SpringCloud全方位立体监控体系
    </a>
  </h2>


      
      <div class='new-meta-box'>
        
          
        
          
            
  <div class='new-meta-item author'>
    
      <a href="http://throwable.club" rel="nofollow">
        
          <img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/mine/doge_avatar.jpg">
        
        <p>Throwable</p>
      </a>
    
  </div>


          
        
          
            <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-edit" aria-hidden="true"></i>
    <p>发布于：2018年11月10日</p>
  </a>
</div>

          
        
          
            
  
  <div class='new-meta-item category'>
    <a href='/blog/categories/Spring/Prometheus/' rel="nofollow">
      <i class="fas fa-folder-open" aria-hidden="true"></i>
      <p>Spring&nbsp;/&nbsp;Prometheus</p>
    </a>
  </div>


          
        
          
            
  <div class="new-meta-item wordcount">
    <a class='notlink'>
      <i class="fas fa-keyboard" aria-hidden="true"></i>
      <p>字数：4.4k字</p>
    </a>
  </div>
  <div class="new-meta-item readtime">
    <a class='notlink'>
      <i class="fas fa-hourglass-half" aria-hidden="true"></i>
      <p>时长：19分钟</p>
    </a>
  </div>


          
        
          
            <div class="new-meta-item date" itemprop="dateUpdated" datetime="2019-01-08T22:41:56+08:00">
  <a class='notlink'>
    <i class="fas fa-save" aria-hidden="true"></i>
    <p>更新于：2019年1月8日</p>
  </a>
</div>

          
        
          
            

          
        
          
            

          
        
      </div>
      
        <hr>
      
    </div>
  </section>


  <section class="article typo">
    <div class="article-entry" itemprop="articleBody">
      <h1>基于Prometheus搭建SpringCloud全方位立体监控体系</h1>
<h2 id="前提">前提</h2>
<p>最近公司在联合运维做一套全方位监控的系统，应用集群的技术栈是SpringCloud体系。虽然本人没有参与具体基础架构的研发，但是从应用引入的包和一些资料的查阅大致推算出具体的实现方案，这里做一次推演，详细记录一下整个搭建过程。</p>
<h2 id="Prometheus是什么">Prometheus是什么</h2>
<p><a href="https://prometheus.io" target="_blank" rel="noopener">Prometheus(普罗米修斯)</a>，是一个开源的系统监控和告警的工具包，其采用Pull方式采集时间序列的度量数据，通过Http协议传输。它的工作方式是被监控的服务需要公开一个Prometheus端点，这端点是一个HTTP接口，该接口公开了度量的列表和当前的值，然后Prometheus应用从此接口定时拉取数据，一般可以存放在时序数据库中，然后通过可视化的Dashboard(例如Promdash或者Grafana)进行数据展示。当然，此文章不打算深入研究这个工具，只做应用层面的展示。这篇文章将会用到下面几个技术栈：</p>
<ul>
<li>SpringCloud体系，主要是注册中心和注册客户端。</li>
<li>spring-boot-starter-actuator，主要是提供了Prometheus端点，不用重复造轮子。</li>
<li>Prometheus的Java客户端。</li>
<li>Prometheus应用。</li>
<li>io.micrometer，SpringBoot标准下使用的度量工具包。</li>
<li>Grafana，可视化的Dashboard。</li>
</ul>
<p>这里所有的软件或者依赖全部使用当前的最新版本，如果有坑踩了再填。其实，Prometheus本身也开发了一套Counter、Gauge、Timer等相关接口，不过SpringBoot中使用了io.micrometer中的套件，所以本文不深入分析Prometheus的Java客户端。</p>
<h2 id="io-micrometer的使用">io.micrometer的使用</h2>
<p>在SpringBoot2.X中，spring-boot-starter-actuator引入了<a href="https://micrometer.io/" target="_blank" rel="noopener">io.micrometer</a>，对1.X中的metrics进行了重构，主要特点是支持tag/label，配合支持tag/label的监控系统，使得我们可以更加方便地对metrics进行多维度的统计查询及监控。io.micrometer目前支持Counter、Gauge、Timer、Summary等多种不同类型的度量方式(不知道有没有遗漏)，下面逐个简单分析一下它们的作用和使用方式。 需要在SpringBoot项目下引入下面的依赖：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">  &lt;groupId&gt;io.micrometer&lt;/groupId&gt;</span><br><span class="line">  &lt;artifactId&gt;micrometer-core&lt;/artifactId&gt;</span><br><span class="line">  &lt;version&gt;$&#123;micrometer.version&#125;&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
<p>目前最新的micrometer.version为1.0.5。注意一点的是：<strong>io.micrometer支持Tag(标签)的概念</strong>，Tag是其metrics是否能够有多维度的支持的基础，Tag必须成对出现，也就是必须配置也就是偶数个Tag，有点类似于K-V的关系。</p>
<h3 id="Counter">Counter</h3>
<p>Counter(计数器)简单理解就是一种只增不减的计数器。它通常用于记录服务的请求数量、完成的任务数量、错误的发生数量等等。举个例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io.micrometer.core.instrument.Counter;</span><br><span class="line"><span class="keyword">import</span> io.micrometer.core.instrument.Metrics;</span><br><span class="line"><span class="keyword">import</span> io.micrometer.core.instrument.simple.SimpleMeterRegistry;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> throwable</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> v1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2018/7/19 23:10</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CounterSample</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="comment">//tag必须成对出现，也就是偶数个</span></span><br><span class="line">		Counter counter = Counter.builder(<span class="string">"counter"</span>)</span><br><span class="line">				.tag(<span class="string">"counter"</span>, <span class="string">"counter"</span>)</span><br><span class="line">				.description(<span class="string">"counter"</span>)</span><br><span class="line">				.register(<span class="keyword">new</span> SimpleMeterRegistry());</span><br><span class="line">		counter.increment();</span><br><span class="line">		counter.increment(<span class="number">2</span>D);</span><br><span class="line">		System.out.println(counter.count());</span><br><span class="line">		System.out.println(counter.measure());</span><br><span class="line">		<span class="comment">//全局静态方法</span></span><br><span class="line">		Metrics.addRegistry(<span class="keyword">new</span> SimpleMeterRegistry());</span><br><span class="line">		counter = Metrics.counter(<span class="string">"counter"</span>, <span class="string">"counter"</span>, <span class="string">"counter"</span>);</span><br><span class="line">		counter.increment(<span class="number">10086</span>D);</span><br><span class="line">		counter.increment(<span class="number">10087</span>D);</span><br><span class="line">		System.out.println(counter.count());</span><br><span class="line">		System.out.println(counter.measure());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">3.0</span></span><br><span class="line">[Measurement&#123;statistic=<span class="string">'COUNT'</span>, value=<span class="number">3.0</span>&#125;]</span><br><span class="line"><span class="number">20173.0</span></span><br><span class="line">[Measurement&#123;statistic=<span class="string">'COUNT'</span>, value=<span class="number">20173.0</span>&#125;]</span><br></pre></td></tr></table></figure>
<p>Counter的Measurement的statistic(可以理解为度量的统计角度)只有COUNT，也就是它只具备计数(它只有增量的方法，因此只增不减)，这一点从它的接口定义可知：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Counter</span> <span class="keyword">extends</span> <span class="title">Meter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">increment</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        increment(<span class="number">1.0</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">increment</span><span class="params">(<span class="keyword">double</span> amount)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">double</span> <span class="title">count</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//忽略其他方法或者成员</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Counter还有一个衍生类型FunctionCounter，它是基于函数式接口ToDoubleFunction进行计数统计的，用法差不多。</p>
<h3 id="Gauge">Gauge</h3>
<p>Gauge(仪表)是一个表示单个数值的度量，它可以表示任意地上下移动的数值测量。Gauge通常用于变动的测量值，如当前的内存使用情况，同时也可以测量上下移动的&quot;计数&quot;，比如队列中的消息数量。举个例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io.micrometer.core.instrument.Gauge;</span><br><span class="line"><span class="keyword">import</span> io.micrometer.core.instrument.Metrics;</span><br><span class="line"><span class="keyword">import</span> io.micrometer.core.instrument.simple.SimpleMeterRegistry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.atomic.AtomicInteger;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> throwable</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> v1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2018/7/19 23:30</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GaugeSample</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		AtomicInteger atomicInteger = <span class="keyword">new</span> AtomicInteger();</span><br><span class="line">		Gauge gauge = Gauge.builder(<span class="string">"gauge"</span>, atomicInteger, AtomicInteger::get)</span><br><span class="line">				.tag(<span class="string">"gauge"</span>, <span class="string">"gauge"</span>)</span><br><span class="line">				.description(<span class="string">"gauge"</span>)</span><br><span class="line">				.register(<span class="keyword">new</span> SimpleMeterRegistry());</span><br><span class="line">		atomicInteger.addAndGet(<span class="number">5</span>);</span><br><span class="line">		System.out.println(gauge.value());</span><br><span class="line">		System.out.println(gauge.measure());</span><br><span class="line">		atomicInteger.decrementAndGet();</span><br><span class="line">		System.out.println(gauge.value());</span><br><span class="line">		System.out.println(gauge.measure());</span><br><span class="line">		<span class="comment">//全局静态方法，返回值竟然是依赖值，有点奇怪，暂时不选用</span></span><br><span class="line">		Metrics.addRegistry(<span class="keyword">new</span> SimpleMeterRegistry());</span><br><span class="line">		AtomicInteger other = Metrics.gauge(<span class="string">"gauge"</span>, atomicInteger, AtomicInteger::get);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">5.0</span></span><br><span class="line">[Measurement&#123;statistic=<span class="string">'VALUE'</span>, value=<span class="number">5.0</span>&#125;]</span><br><span class="line"><span class="number">4.0</span></span><br><span class="line">[Measurement&#123;statistic=<span class="string">'VALUE'</span>, value=<span class="number">4.0</span>&#125;]</span><br></pre></td></tr></table></figure>
<p>Gauge关注的度量统计角度是VALUE(值)，它的构建方法中依赖于函数式接口ToDoubleFunction的实例(如例子中的实例方法引用AtomicInteger::get)和一个依赖于ToDoubleFunction改变自身值的实例(如例子中的AtomicInteger实例)，它的接口方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Gauge</span> <span class="keyword">extends</span> <span class="title">Meter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">double</span> <span class="title">value</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//忽略其他方法或者成员</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Timer">Timer</h3>
<p>Timer(计时器)同时测量一个特定的代码逻辑块的调用(执行)速度和它的时间分布。简单来说，就是在调用结束的时间点记录整个调用块执行的总时间，适用于测量短时间执行的事件的耗时分布，例如消息队列消息的消费速率。举个例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> io.micrometer.core.instrument.Timer;</span><br><span class="line"><span class="keyword">import</span> io.micrometer.core.instrument.simple.SimpleMeterRegistry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> throwable</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> v1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2018/7/19 23:44</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TimerSample</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">		Timer timer = Timer.builder(<span class="string">"timer"</span>)</span><br><span class="line">				.tag(<span class="string">"timer"</span>,<span class="string">"timer"</span>)</span><br><span class="line">				.description(<span class="string">"timer"</span>)</span><br><span class="line">				.register(<span class="keyword">new</span> SimpleMeterRegistry());</span><br><span class="line">		timer.record(()-&gt;&#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">			&#125;<span class="keyword">catch</span> (InterruptedException e)&#123;</span><br><span class="line">				<span class="comment">//ignore</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">		System.out.println(timer.count());</span><br><span class="line">		System.out.println(timer.measure());</span><br><span class="line">		System.out.println(timer.totalTime(TimeUnit.SECONDS));</span><br><span class="line">		System.out.println(timer.mean(TimeUnit.SECONDS));</span><br><span class="line">		System.out.println(timer.max(TimeUnit.SECONDS));</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span></span><br><span class="line">[Measurement&#123;statistic=<span class="string">'COUNT'</span>, value=<span class="number">1.0</span>&#125;, Measurement&#123;statistic=<span class="string">'TOTAL_TIME'</span>, value=<span class="number">2.000603975</span>&#125;, Measurement&#123;statistic=<span class="string">'MAX'</span>, value=<span class="number">2.000603975</span>&#125;]</span><br><span class="line"><span class="number">2.000603975</span></span><br><span class="line"><span class="number">2.000603975</span></span><br><span class="line"><span class="number">2.000603975</span></span><br></pre></td></tr></table></figure>
<p>Timer的度量统计角度主要包括记录执行的最大时间、总时间、平均时间、执行完成的总任务数，它提供多种的统计方法变体：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Timer</span> <span class="keyword">extends</span> <span class="title">Meter</span>, <span class="title">HistogramSupport</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">record</span><span class="params">(<span class="keyword">long</span> amount, TimeUnit unit)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">record</span><span class="params">(Duration duration)</span> </span>&#123;</span><br><span class="line">      record(duration.toNanos(), TimeUnit.NANOSECONDS);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &lt;T&gt; <span class="function">T <span class="title">record</span><span class="params">(Supplier&lt;T&gt; f)</span></span>;</span><br><span class="line">    </span><br><span class="line">  &lt;T&gt; <span class="function">T <span class="title">recordCallable</span><span class="params">(Callable&lt;T&gt; f)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">record</span><span class="params">(Runnable f)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">default</span> Runnable <span class="title">wrap</span><span class="params">(Runnable f)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> () -&gt; record(f);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">default</span> &lt;T&gt; <span class="function">Callable&lt;T&gt; <span class="title">wrap</span><span class="params">(Callable&lt;T&gt; f)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> () -&gt; recordCallable(f);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//忽略其他方法或者成员</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这些record或者包装方法可以根据需要选择合适的使用，另外，一些度量属性(如下限和上限)或者单位可以自行配置，具体属性的相关内容可以查看DistributionStatisticConfig类，这里不详细展开。</p>
<p>另外，Timer有一个衍生类LongTaskTimer，主要是用来记录正在执行但是尚未完成的任务数，用法差不多。</p>
<h3 id="Summary">Summary</h3>
<p>Summary(摘要)用于跟踪事件的分布。它类似于一个计时器，但更一般的情况是，它的大小并不一定是一段时间的测量值。在micrometer中，对应的类是DistributionSummary，它的用法有点像Timer，但是记录的值是需要直接指定，而不是通过测量一个任务的执行时间。举个例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> io.micrometer.core.instrument.DistributionSummary;</span><br><span class="line"><span class="keyword">import</span> io.micrometer.core.instrument.simple.SimpleMeterRegistry;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> throwable</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> v1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2018/7/19 23:55</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SummarySample</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		DistributionSummary summary = DistributionSummary.builder(<span class="string">"summary"</span>)</span><br><span class="line">				.tag(<span class="string">"summary"</span>, <span class="string">"summary"</span>)</span><br><span class="line">				.description(<span class="string">"summary"</span>)</span><br><span class="line">				.register(<span class="keyword">new</span> SimpleMeterRegistry());</span><br><span class="line">		summary.record(<span class="number">2</span>D);</span><br><span class="line">		summary.record(<span class="number">3</span>D);</span><br><span class="line">		summary.record(<span class="number">4</span>D);</span><br><span class="line">		System.out.println(summary.measure());</span><br><span class="line">		System.out.println(summary.count());</span><br><span class="line">		System.out.println(summary.max());</span><br><span class="line">		System.out.println(summary.mean());</span><br><span class="line">		System.out.println(summary.totalAmount());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[Measurement&#123;statistic=<span class="string">'COUNT'</span>, value=<span class="number">3.0</span>&#125;, Measurement&#123;statistic=<span class="string">'TOTAL'</span>, value=<span class="number">9.0</span>&#125;, Measurement&#123;statistic=<span class="string">'MAX'</span>, value=<span class="number">4.0</span>&#125;]</span><br><span class="line"><span class="number">3</span></span><br><span class="line"><span class="number">4.0</span></span><br><span class="line"><span class="number">3.0</span></span><br><span class="line"><span class="number">9.0</span></span><br></pre></td></tr></table></figure>
<p>Summary的度量统计角度主要包括记录过的数据中的最大值、总数值、平均值和总次数。另外，一些度量属性(如下限和上限)或者单位可以自行配置，具体属性的相关内容可以查看DistributionStatisticConfig类，这里不详细展开。</p>
<h3 id="小结">小结</h3>
<p>一般情况下，上面的Counter、Gauge、Timer、DistributionSummary例子可以满足日常开发需要，但是有些高级的特性这里没有展开，具体可以参考<code>micrometer-spring-legacy</code>这个依赖包，毕竟源码是老师，源码不会骗人。</p>
<h2 id="spring-boot-starter-actuator的使用">spring-boot-starter-actuator的使用</h2>
<p><code>spring-boot-starter-actuator</code>在2.X版本中不仅升级了metrics为io.micrometer，很多配置方式也和1.X完全不同，鉴于前段时间没有维护SpringBoot技术栈的项目，现在重新看了下官网复习一下。引入依赖：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;springboot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>目前最新的springboot.version为2.0.3.RELEASE。在<code>spring-boot-starter-actuator</code>中，最大的变化就是配置的变化，原来在1.X版本是通过<code>management.security.enabled</code>控制是否可以忽略权限访问所有的监控端点，在2.X版本中，必须显式配置不需要权限验证对外开放的端点：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">management.endpoints.web.exposure.include=*</span><br><span class="line">management.endpoints.web.exposure.exclude=env,beans</span><br><span class="line">management.endpoints.jmx.exposure.include=</span><br><span class="line">management.endpoints.jmx.exposure.include=*</span><br></pre></td></tr></table></figure>
<p>例如上面的配置，访问非/env和非/beans的端点，可以不受权限控制，也就是所有人都可以访问非/env和非/beans的端点。例如，如果我只想暴露/health端点，只需配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">management.endpoints.web.exposure.include=health</span><br></pre></td></tr></table></figure>
<p>这一点需要特别注意，其他使用和1.X差不多。还有一点是，2.X中所有监控端点的访问url的默认路径前缀为：<code>http://${host}/${port}/actuator</code>，也就是想访问health端点就要访问<code>http://${host}/${port}/actuator/health</code>，当然也可以修改/actuator这个路径前缀。其他细节区别没有深入研究，可以参考<a href="https://docs.spring.io/spring-boot/docs/2.0.3.RELEASE/reference/htmlsingle" target="_blank" rel="noopener">文档</a>。</p>
<h3 id="搭建SpringCloud应用">搭建SpringCloud应用</h3>
<p>接着先搭建一个SpringCloud应用群，主要包括注册中心(registry-center)和一个简单的服务节点(cloud-prometheus-sample)，其中注册中心只引入eureka-server的依赖，而服务节点用于对接Prometheus，引入eureka-client、spring-boot-starter-actuator、prometheus等依赖。</p>
<h3 id="registry-center">registry-center</h3>
<p>registry-center是一个单纯的服务注册中心，只需要引入eureka-server的依赖，添加一个启动类即可，添加的依赖如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>添加一个启动类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> throwable</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> v1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2018/7/21 9:06</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RegistryCenterApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		SpringApplication.run(RegistryCenterApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置文件application.yaml如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 9091</span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: registry-center</span><br><span class="line">eureka:</span><br><span class="line">  instance:</span><br><span class="line">    hostname: localhost</span><br><span class="line">  client:</span><br><span class="line">    enabled: true</span><br><span class="line">    register-with-eureka: false</span><br><span class="line">    fetch-registry: false</span><br><span class="line">    service-url:</span><br><span class="line">         defaultZone: http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/</span><br></pre></td></tr></table></figure>
<p>就是这么简单，启动入口类即可，启动的端口为9091。</p>
<h3 id="cloud-prometheus-sample">cloud-prometheus-sample</h3>
<p>cloud-prometheus-sample主要作为eureka-client，接入spring-boot-starter-actuator和prometheus依赖，引入依赖如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.micrometer<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>micrometer-registry-prometheus<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>这里引入的是<code>micrometer-registry-prometheus</code>而不是<code>micrometer-spring-legacy</code>是因为<code>micrometer-spring-legacy</code>是<code>spring-integration</code>(spring系统集成)的依赖，这里没有用到，但是里面很多实现可以参考。<code>micrometer-registry-prometheus</code>提供了基于actuator的端点，路径是…/prometheus。启动类如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span><br><span class="line"><span class="keyword">import</span> org.springframework.cloud.netflix.eureka.EnableEurekaClient;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> throwable</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@version</span> v1.0</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@description</span></span></span><br><span class="line"><span class="comment"> * <span class="doctag">@since</span> 2018/7/21 9:13</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SampleApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		SpringApplication.run(SampleApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置文件application.yaml如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">server:</span><br><span class="line">  port: 9092</span><br><span class="line">spring:</span><br><span class="line">  application:</span><br><span class="line">    name: cloud-prometheus-sample</span><br><span class="line">eureka:</span><br><span class="line">  instance:</span><br><span class="line">    hostname: localhost</span><br><span class="line">  client:</span><br><span class="line">    service-url: http://localhost:9091/eureka/</span><br></pre></td></tr></table></figure>
<p>启动端口为9092，eureka的服务注册地址为：<a href="http://localhost:9091/eureka/%EF%BC%8C%E4%B9%9F%E5%B0%B1%E6%98%AF" target="_blank" rel="noopener">http://localhost:9091/eureka/，也就是</a><code>registry-center</code>中指定的默认数据区(defaultZone)的注册地址，先启动<code>registry-center</code>，再启动<code>cloud-prometheus-sample</code>，然后访问http://localhost:9091/：</p>
<p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201812/sp-p-1.png" alt="sp-p-1"></p>
<p>访问http://localhost:9092/actuator/prometheus：</p>
<p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201812/sp-p-2.png" alt="sp-p-2"></p>
<p>这些数据就是实时的度量数据，Prometheus(软件)配置好任务并且启动执行后，就是通过定时拉取/prometheus这个端点返回的数据进行数据聚合和展示的。</p>
<p>接着，我们先定制一个功能，统计<code>cloud-prometheus-sample</code>所有入站的Http请求数量(包括成功、失败和非法的)，添加如下代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//请求拦截器</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SampleMvcInterceptor</span> <span class="keyword">extends</span> <span class="title">HandlerInterceptorAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Counter COUNTER = Counter.builder(<span class="string">"Http请求统计"</span>)</span><br><span class="line">			.tag(<span class="string">"HttpCount"</span>, <span class="string">"HttpCount"</span>)</span><br><span class="line">			.description(<span class="string">"Http请求统计"</span>)</span><br><span class="line">			.register(Metrics.globalRegistry);</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterCompletion</span><span class="params">(HttpServletRequest request, HttpServletResponse response,</span></span></span><br><span class="line"><span class="function"><span class="params">								Object handler, Exception ex)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		COUNTER.increment();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//自定义Mvc配置</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SampleWebMvcConfigurer</span> <span class="keyword">implements</span> <span class="title">WebMvcConfigurer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> SampleMvcInterceptor sampleMvcInterceptor;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addInterceptors</span><span class="params">(InterceptorRegistry registry)</span> </span>&#123;</span><br><span class="line">		registry.addInterceptor(sampleMvcInterceptor);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>重启<code>cloud-prometheus-sample</code>，直接访问几次不存在的根节点路径<code>http://localhost:9092</code>，再查看端点统计数据：</p>
<p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201812/sp-p-3.png" alt="sp-p-3"></p>
<h1>安装和使用Prometheus</h1>
<p>先从<a href="https://prometheus.io/download/" target="_blank" rel="noopener">Prometheus官方下载地址</a>下载软件，这里用Windows10平台演示，直接下载prometheus-2.3.2.windows-amd64.tar.gz，个人有软件洁癖，用软件或者依赖喜欢最高版本，出现坑了自己填。解压后目录如下：</p>
<p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201812/sp-p-4.png" alt="sp-p-4"></p>
<p>启动的话，直接运行prometheus.exe即可，这里先配置一下prometheus.yml：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">global:</span><br><span class="line">  scrape_interval:     15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.</span><br><span class="line">  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.</span><br><span class="line">alerting:</span><br><span class="line">  alertmanagers:</span><br><span class="line">  - static_configs:</span><br><span class="line">    - targets:</span><br><span class="line">      # - alertmanager:9093</span><br><span class="line">scrape_configs:</span><br><span class="line">  - job_name: 'prometheus'</span><br><span class="line">    metrics_path: /actuator/prometheus</span><br><span class="line">    static_configs:</span><br><span class="line">    - targets: ['localhost:9092']</span><br></pre></td></tr></table></figure>
<p>我们主要修改的是scrape_configs节点下的配置，这个节点时配置同步任务的，这里配置一个任务为’prometheus’，拉取数据的路径为/actuator/prometheus，目标host-port为’localhost:9092’，也就是<code>cloud-prometheus-sample</code>暴露的prometheus端点，Prometheus(软件)的默认启动端口为9090。启动后，同级目录下会生成一个data目录，实际上起到&quot;时序数据库&quot;的类似作用。访问Prometheus(软件)的控制台<code>http://localhost:9090/targets</code>:</p>
<p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201812/sp-p-5.png" alt="sp-p-5"></p>
<p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201812/sp-p-6.png" alt="sp-p-6"></p>
<p>Prometheus度量统计的所有监控项可以在http://localhost:9090/graph中查看到。这里可以观察到HttpCount的统计，但是界面不够炫酷，配置项也少，因此需要引入Grafana。</p>
<h2 id="安装和接入Grafana">安装和接入Grafana</h2>
<p>Grafana的安装也十分简单，它也是开箱即用的，就是配置的时候需要熟悉它的语法。先到<a href="https://grafana.com/grafana/download" target="_blank" rel="noopener">Grafana官网下载页面</a>下载一个适合系统的版本，这里选择Windows版本。解压之后，直接运行bin目录下的grafana-server.exe即可，默认的启动端口是3000，访问http://localhost:3000/，初始化账号密码是admin/admin，首次登陆需要修改密码，接着添加一个数据源：</p>
<p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201812/sp-p-7.png" alt="sp-p-7"></p>
<p>接着添加一个新的命名为’sample’的Dashboard，添加一个Graph类型的Panel，配置其属性：</p>
<p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201812/sp-p-8.png" alt="sp-p-8"></p>
<p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201812/sp-p-9.png" alt="sp-p-9"></p>
<p>A记录(查询命令)就是对应http://localhost:9090/graph中的查询命令的目标：</p>
<p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201812/sp-p-10.png" alt="sp-p-10"></p>
<p>很简单，配置完毕之后，就可以看到高大上的统计图：</p>
<p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201812/sp-p-11.png" alt="sp-p-11"></p>
<p>这里只是介绍了Grafana使用的冰山一角，更多配置和使用命令可以自行查阅它的官方文档。</p>
<h2 id="原理和扩展">原理和扩展</h2>
<h3 id="原理">原理</h3>
<p>下面是Prometheus的工作原理流程图，来源于其官网：</p>
<p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201812/sp-p-12.png" alt="sp-p-12"></p>
<p>在SpringBoot项目中，它的工作原理如下：</p>
<p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201812/sp-p-13.png" alt="sp-p-13"></p>
<p>这就是为什么能够使用Metrics的静态方法直接进行数据统计，因为Spring内部用MeterRegistryPostProcessor对Metrics内部持有的全局的CompositeMeterRegistry进行了合成操作，也就是所有MeterRegistry类型的Bean都会添加到Metrics内部持有的静态globalRegistry。</p>
<h3 id="扩展">扩展</h3>
<p>下面来个相对有生产意义的扩展实现，这篇文章提到SpringCloud体系的监控，我们需要扩展一个功能，记录一下每个有效的请求的执行时间。添加下面几个类或者方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//注解</span></span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Target</span>(ElementType.METHOD)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> MethodMetric &#123;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">name</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line"></span><br><span class="line">	<span class="function">String <span class="title">description</span><span class="params">()</span> <span class="keyword">default</span> ""</span>;</span><br><span class="line"></span><br><span class="line">	String[] tags() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//切面类</span></span><br><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HttpMethodCostAspect</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> MeterRegistry meterRegistry;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Pointcut</span>(<span class="string">"@annotation(club.throwable.sample.aspect.MethodMetric)"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pointcut</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Around</span>(value = <span class="string">"pointcut()"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">process</span><span class="params">(ProceedingJoinPoint joinPoint)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">		Method targetMethod = ((MethodSignature) joinPoint.getSignature()).getMethod();</span><br><span class="line">		<span class="comment">//这里是为了拿到实现类的注解</span></span><br><span class="line">		Method currentMethod = ClassUtils.getUserClass(joinPoint.getTarget().getClass())</span><br><span class="line">				.getDeclaredMethod(targetMethod.getName(), targetMethod.getParameterTypes());</span><br><span class="line">		<span class="keyword">if</span> (currentMethod.isAnnotationPresent(MethodMetric<span class="class">.<span class="keyword">class</span>)) </span>&#123;</span><br><span class="line">			MethodMetric methodMetric = currentMethod.getAnnotation(MethodMetric<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">			<span class="keyword">return</span> processMetric(joinPoint, currentMethod, methodMetric);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">return</span> joinPoint.proceed();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">private</span> Object <span class="title">processMetric</span><span class="params">(ProceedingJoinPoint joinPoint, Method currentMethod,</span></span></span><br><span class="line"><span class="function"><span class="params">								 MethodMetric methodMetric)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">		String name = methodMetric.name();</span><br><span class="line">		<span class="keyword">if</span> (!StringUtils.hasText(name)) &#123;</span><br><span class="line">			name = currentMethod.getName();</span><br><span class="line">		&#125;</span><br><span class="line">		String desc = methodMetric.description();</span><br><span class="line">		<span class="keyword">if</span> (!StringUtils.hasText(desc)) &#123;</span><br><span class="line">			desc = name;</span><br><span class="line">		&#125;</span><br><span class="line">		String[] tags = methodMetric.tags();</span><br><span class="line">		<span class="keyword">if</span> (tags.length == <span class="number">0</span>) &#123;</span><br><span class="line">			tags = <span class="keyword">new</span> String[<span class="number">2</span>];</span><br><span class="line">			tags[<span class="number">0</span>] = name;</span><br><span class="line">			tags[<span class="number">1</span>] = name;</span><br><span class="line">		&#125;</span><br><span class="line">		Timer timer = Timer.builder(name).tags(tags)</span><br><span class="line">				.description(desc)</span><br><span class="line">				.register(meterRegistry);</span><br><span class="line">		<span class="keyword">return</span> timer.record(() -&gt; &#123;</span><br><span class="line">			<span class="keyword">try</span> &#123;</span><br><span class="line">				<span class="keyword">return</span> joinPoint.proceed();</span><br><span class="line">			&#125; <span class="keyword">catch</span> (Throwable throwable) &#123;</span><br><span class="line">				<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(throwable);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//启动类里面添加方法</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SampleApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		SpringApplication.run(SampleApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@MethodMetric</span></span><br><span class="line">	<span class="meta">@GetMapping</span>(value = <span class="string">"/hello"</span>)</span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">(@RequestParam(name = <span class="string">"name"</span>, required = <span class="keyword">false</span>, defaultValue = <span class="string">"doge"</span>)</span> String name) </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> String.format(<span class="string">"%s say hello!"</span>, name);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>配置好Grafana的面板，重启项目，多次调用/hello接口：</p>
<p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201812/sp-p-14.png" alt="sp-p-14"></p>
<h2 id="后记">后记</h2>
<p>如果想把监控界面做得更炫酷、更直观、更详细，可以先熟悉一下Prometheus的查询语法和Grafana的面板配置，此外，Grafana或者Prometheus都支持预警功能，可以接入钉钉机器人等以便及时发现问题作出预警。</p>
<p>参考资料：</p>
<ul>
<li><a href="https://prometheus.io/" target="_blank" rel="noopener">https://prometheus.io/</a></li>
<li><a href="https://spring.io/" target="_blank" rel="noopener">https://spring.io/</a></li>
<li><a href="https://github.com/percona/grafana-dashboards" target="_blank" rel="noopener">https://github.com/percona/grafana-dashboards</a></li>
</ul>
<p>本文Demo项目仓库：<a href="https://github.com/zjcscut/spring-cloud-prometheus-sample" target="_blank" rel="noopener">https://github.com/zjcscut/spring-cloud-prometheus-sample</a></p>
<p>(本文完 c-5-d e-a-20180721 r-a-201918)</p>

      
    </div>
    <!-- 
      <div class="full-width auto-padding tags">
        
          <a href="/blog/tags/Spring/" rel="nofollow"><i class="fas fa-tag fa-fw"></i> Spring</a>
        
          <a href="/blog/tags/SpringCloud/" rel="nofollow"><i class="fas fa-tag fa-fw"></i> SpringCloud</a>
        
      </div>
     -->
  </section>
</article>

          </div>
        
      
        
          <div class='post-wrapper'>
            <article class="post white-box card-shadow  reveal ">
  


  <section class='meta'>
    
    
    <div class="meta" id="header-meta">
      
        
  <h2 class="title">
    <a href="/2018/11/04/annotation-implementation/">
      JDK中注解的底层实现
    </a>
  </h2>


      
      <div class='new-meta-box'>
        
          
        
          
            
  <div class='new-meta-item author'>
    
      <a href="http://throwable.club" rel="nofollow">
        
          <img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/mine/doge_avatar.jpg">
        
        <p>Throwable</p>
      </a>
    
  </div>


          
        
          
            <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-edit" aria-hidden="true"></i>
    <p>发布于：2018年11月4日</p>
  </a>
</div>

          
        
          
            
  
  <div class='new-meta-item category'>
    <a href='/blog/categories/Java/Annotation/' rel="nofollow">
      <i class="fas fa-folder-open" aria-hidden="true"></i>
      <p>Java&nbsp;/&nbsp;Annotation</p>
    </a>
  </div>


          
        
          
            
  <div class="new-meta-item wordcount">
    <a class='notlink'>
      <i class="fas fa-keyboard" aria-hidden="true"></i>
      <p>字数：2.9k字</p>
    </a>
  </div>
  <div class="new-meta-item readtime">
    <a class='notlink'>
      <i class="fas fa-hourglass-half" aria-hidden="true"></i>
      <p>时长：13分钟</p>
    </a>
  </div>


          
        
          
            <div class="new-meta-item date" itemprop="dateUpdated" datetime="2018-11-04T18:45:13+08:00">
  <a class='notlink'>
    <i class="fas fa-save" aria-hidden="true"></i>
    <p>更新于：2018年11月4日</p>
  </a>
</div>

          
        
          
            

          
        
          
            

          
        
      </div>
      
        <hr>
      
    </div>
  </section>


  <section class="article typo">
    <div class="article-entry" itemprop="articleBody">
      <h1>前提</h1>
<p>用Java快三年了，注解算是一个常用的类型，特别是在一些框架里面会大量使用注解做组件标识、配置或者策略。但是一直没有深入去探究JDK中的注解到底是什么，底层是怎么实现了?于是参考了一些资料，做了一次稍微详细的分析。</p>
<h1>JDK的注解描述</h1>
<p>参考JavaSE-8里面的<a href="https://docs.oracle.com/javase/specs/jls/se8/html/jls-9.html#jls-9.6" target="_blank" rel="noopener">JLS-9.6</a>对注解的描述如下：</p>
<p><img src="http://pazkqls86.bkt.clouddn.com/anno-1.png" alt="anno-1"></p>
<p>注解的声明如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123;InterfaceModifier&#125; @ interface Identifier AnnotationTypeBody</span><br><span class="line"></span><br><span class="line">接口修饰符 @ interface 注解标识符 注解类型的内容</span><br></pre></td></tr></table></figure>
<p>其中：</p>
<ul>
<li>注解类型声明中的标识符指定了注解类型的名称。</li>
<li>如果注解类型与它的任何封闭类或接口具有相同的简单名称，则编译时会出现错误。</li>
<li>每个注解类型的直接父接口都是<code>java.lang.annotation.Annotation</code>。</li>
</ul>
<p>既然所有注解类型的父接口都是<code>java.lang.annotation.Annotation</code>，那么我们可以看一下Annotation接口的文档：</p>
<blockquote>
<p>public interface Annotation</p>
</blockquote>
<blockquote>
<p>The common interface extended by all annotation types. Note that an interface that manually extends this one does not define an annotation type. Also note that this interface does not itself define an annotation type. More information about annotation types can be found in section 9.6 of The Java™ Language Specification. The AnnotatedElement interface discusses compatibility concerns when evolving an annotation type from being non-repeatable to being repeatable.</p>
</blockquote>
<blockquote>
<p>Since: 1.5</p>
</blockquote>
<p>JavaSE-8中的文档对Annotation的描述和JLS-9.6中差不多，不过最后指明了可重复注解的兼容性考虑的问题，可重复注解在JDK1.8中由元注解@Repeatable实现。下面基于JDK8的最后一个版本<code>java version 1.8.0_181</code>探究一下注解在JDK中的底层实现。</p>
<h1>注解实现探究</h1>
<p>我们先定义一个十分简单的Counter注解如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> club.throwable.annotation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.*;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span><br><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Counter &#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">count</span><span class="params">()</span> <span class="keyword">default</span> 0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们先从直接使用<code>@Counter</code>注解，从直观上观察<code>@Counter</code>实例的类型：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Counter</span>(count = <span class="number">1</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">		Counter counter = Main<span class="class">.<span class="keyword">class</span>.<span class="title">getAnnotation</span>(<span class="title">Counter</span>.<span class="title">class</span>)</span>;</span><br><span class="line">		System.out.println(counter.count());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="http://pazkqls86.bkt.clouddn.com/anno-2.png" alt="anno-2"></p>
<p><code>@Counter</code>实例从Debug过程中观察发现是JDK的一个代理类(并且InvocationHandler的实例是sun.reflect.annotation.AnnotationInvocationHandler，它是一个修饰符为default的sun包内可用的类)，为了验证这一点我们使用JDK的反编译命令查看<code>@Counter</code>的字节码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javap -c -v D:\Projects\rxjava-seed\target\classes\club\throwable\annotation\Counter.class</span><br></pre></td></tr></table></figure>
<p><code>@Counter</code>反编译后的字节码如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">Classfile /D:/Projects/rxjava-seed/target/classes/club/throwable/annotation/Counter<span class="class">.<span class="keyword">class</span></span></span><br><span class="line"><span class="class">  <span class="title">Last</span> <span class="title">modified</span> 2018-10-6</span>; size <span class="number">487</span> bytes</span><br><span class="line">  MD5 checksum <span class="number">83</span>cee23f426e5b51a096281068d8b555</span><br><span class="line">  Compiled from <span class="string">"Counter.java"</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">club</span>.<span class="title">throwable</span>.<span class="title">annotation</span>.<span class="title">Counter</span> <span class="keyword">extends</span> <span class="title">java</span>.<span class="title">lang</span>.<span class="title">annotation</span>.<span class="title">Annotation</span></span></span><br><span class="line">  minor version: 0</span><br><span class="line">  major version: <span class="number">52</span></span><br><span class="line">  flags: ACC_PUBLIC, ACC_INTERFACE, ACC_ABSTRACT, ACC_ANNOTATION</span><br><span class="line">Constant pool:</span><br><span class="line">   #1 = Class              #19            // club/throwable/annotation/Counter</span><br><span class="line">   #2 = Class              #20            // java/lang/Object</span><br><span class="line">   #3 = Class              #21            // java/lang/annotation/Annotation</span><br><span class="line">   #4 = Utf8               count</span><br><span class="line">   #5 = Utf8               ()I</span><br><span class="line">   #6 = Utf8               AnnotationDefault</span><br><span class="line">   #7 = Integer            0</span><br><span class="line">   #8 = Utf8               SourceFile</span><br><span class="line">   #9 = Utf8               Counter.java</span><br><span class="line">  #10 = Utf8               RuntimeVisibleAnnotations</span><br><span class="line">  #11 = Utf8               Ljava/lang/annotation/Retention;</span><br><span class="line">  #12 = Utf8               value</span><br><span class="line">  #13 = Utf8               Ljava/lang/annotation/RetentionPolicy;</span><br><span class="line">  #14 = Utf8               RUNTIME</span><br><span class="line">  #15 = Utf8               Ljava/lang/annotation/Documented;</span><br><span class="line">  #16 = Utf8               Ljava/lang/annotation/Target;</span><br><span class="line">  #17 = Utf8               Ljava/lang/annotation/ElementType;</span><br><span class="line">  #18 = Utf8               TYPE</span><br><span class="line">  #19 = Utf8               club/throwable/annotation/Counter</span><br><span class="line">  #20 = Utf8               java/lang/Object</span><br><span class="line">  #21 = Utf8               java/lang/annotation/Annotation</span><br><span class="line">&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">int</span> <span class="title">count</span><span class="params">()</span></span>;</span><br><span class="line">    descriptor: ()I</span><br><span class="line">    flags: ACC_PUBLIC, ACC_ABSTRACT</span><br><span class="line">    AnnotationDefault:</span><br><span class="line">      default_value: I#7&#125;</span><br><span class="line">SourceFile: <span class="string">"Counter.java"</span></span><br><span class="line">RuntimeVisibleAnnotations:</span><br><span class="line">  0: #11(#12=e#13.#14)</span><br><span class="line">  1: #15()</span><br><span class="line">  2: #16(#12=[e#17.#18])</span><br></pre></td></tr></table></figure>
<p>如果熟悉字节码，从直观上可以得到下面的信息：</p>
<ul>
<li>注解是一个接口，它继承自java.lang.annotation.Annotation父接口。</li>
<li><code>@Counter</code>对应的接口接口除了继承了java.lang.annotation.Annotation中的抽象方法，自身定义了一个抽象方法<code>public abstract int count();</code>。</li>
</ul>
<p>既然注解最后转化为一个接口，注解中定义的注解成员属性会转化为抽象方法，那么最后这些注解成员属性怎么进行赋值的呢?答案就是：为注解对应的接口生成一个实现该接口的动态代理类。直接点说就是：Java通过动态代理的方式生成了一个实现了&quot;注解对应接口&quot;的实例，该代理类实例实现了&quot;注解成员属性对应的方法&quot;，这个步骤类似于&quot;注解成员属性&quot;的赋值过程，这样子就可以在程序运行的时候通过反射获取到注解的成员属性(这里注解必须是运行时可见的，也就是使用了@Retention(RetentionPolicy.RUNTIME)，另外需要理解JDK原生动态代理和反射相关内容)。</p>
<h1>注解对应的动态代理类实例</h1>
<p>上面一些已经指出了，注解的最底层实现就是一个JDK的动态代理类，而这个动态代理类的生成过程我们完全可以通过Debug跟踪，这里列举一下笔者跟踪整个过程的流水账：</p>
<ul>
<li>1、<code>Class&lt;?&gt;#getAnnotation(Class&lt;A&gt; annotationClass)</code>，通过类型获取注解实例。</li>
<li>2、<code>Class&lt;?&gt;#annotationData()</code>，获取注解的数据。</li>
<li>3、<code>Class&lt;?&gt;#createAnnotationData(int classRedefinedCount)</code>，构建注解的数据。</li>
<li>4、<code>AnnotationParser#parseAnnotations(byte[] var0, ConstantPool var1, Class&lt;?&gt; var2)</code>，这里已经是sun包下的类，无法看到源码，这个方法用于解析注解，<strong>这一步使用到字节码中常量池的索引解析，常量解析完毕会生成一个成员属性键值对作为下一个环节的入参，常量池的解析可以看<code>AnnotationParser#parseMemberValue</code>方法</strong>。</li>
<li>5、<code>AnnotationParser#annotationForMap(final Class&lt;? extends Annotation&gt; var0, final Map&lt;String, Object&gt; var1)</code>，同样是<code>sun.reflect.annotation.AnnotationParser</code>中的方法，用于生成注解的动态代理类。</li>
</ul>
<p>注意第5步，贴出它的源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Annotation <span class="title">annotationForMap</span><span class="params">(<span class="keyword">final</span> Class&lt;? extends Annotation&gt; var0, <span class="keyword">final</span> Map&lt;String, Object&gt; var1)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (Annotation)AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction&lt;Annotation&gt;() &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> Annotation <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> (Annotation)Proxy.newProxyInstance(var0.getClassLoader(), <span class="keyword">new</span> Class[]&#123;var0&#125;, <span class="keyword">new</span> AnnotationInvocationHandler(var0, var1));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>熟悉JDK动态代理的这里的代码应该看起来很简单，就是生成一个标准的JDK动态代理，而InvocationHandler的实例是AnnotationInvocationHandler，可以看它的成员变量、构造方法和实现InvocationHandler接口的invoke方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AnnotationInvocationHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span>, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">6182022883658399397L</span>;</span><br><span class="line">	<span class="comment">//保存了当前注解的类型</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;? extends Annotation&gt; type;</span><br><span class="line">	<span class="comment">//保存了注解的成员属性的名称和值的映射，注解成员属性的名称实际上就对应着接口中抽象方法的名称</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; memberValues;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Method[] memberMethods = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    AnnotationInvocationHandler(Class&lt;? extends Annotation&gt; var1, Map&lt;String, Object&gt; var2) &#123;</span><br><span class="line">        Class[] var3 = var1.getInterfaces();</span><br><span class="line">        <span class="keyword">if</span> (var1.isAnnotation() &amp;&amp; var3.length == <span class="number">1</span> &amp;&amp; var3[<span class="number">0</span>] == Annotation<span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.type = var1;</span><br><span class="line">            <span class="keyword">this</span>.memberValues = var2;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AnnotationFormatError(<span class="string">"Attempt to create proxy for a non-annotation type."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object var1, Method var2, Object[] var3)</span> </span>&#123;</span><br><span class="line">		<span class="comment">//获取当前执行的方法名称</span></span><br><span class="line">        String var4 = var2.getName();</span><br><span class="line">        Class[] var5 = var2.getParameterTypes();</span><br><span class="line">        <span class="keyword">if</span> (var4.equals(<span class="string">"equals"</span>) &amp;&amp; var5.length == <span class="number">1</span> &amp;&amp; var5[<span class="number">0</span>] == Object<span class="class">.<span class="keyword">class</span>) </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>.equalsImpl(var3[<span class="number">0</span>]);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var5.length != <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> AssertionError(<span class="string">"Too many parameters for an annotation method"</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">byte</span> var7 = -<span class="number">1</span>;</span><br><span class="line">            <span class="keyword">switch</span>(var4.hashCode()) &#123;</span><br><span class="line">            <span class="keyword">case</span> -<span class="number">1776922004</span>:</span><br><span class="line">                <span class="keyword">if</span> (var4.equals(<span class="string">"toString"</span>)) &#123;</span><br><span class="line">                    var7 = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">147696667</span>:</span><br><span class="line">                <span class="keyword">if</span> (var4.equals(<span class="string">"hashCode"</span>)) &#123;</span><br><span class="line">                    var7 = <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1444986633</span>:</span><br><span class="line">                <span class="keyword">if</span> (var4.equals(<span class="string">"annotationType"</span>)) &#123;</span><br><span class="line">                    var7 = <span class="number">2</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">switch</span>(var7) &#123;</span><br><span class="line">            <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.toStringImpl();</span><br><span class="line">            <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.hashCodeImpl();</span><br><span class="line">            <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">this</span>.type;</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">			    <span class="comment">//利用方法名称从memberValues获取成员属性的赋值</span></span><br><span class="line">                Object var6 = <span class="keyword">this</span>.memberValues.get(var4);</span><br><span class="line">                <span class="keyword">if</span> (var6 == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IncompleteAnnotationException(<span class="keyword">this</span>.type, var4);</span><br><span class="line">                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (var6 <span class="keyword">instanceof</span> ExceptionProxy) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> ((ExceptionProxy)var6).generateException();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					<span class="comment">//这一步就是注解成员属性返回值获取的实际逻辑</span></span><br><span class="line">					<span class="comment">//需要判断是否数据，如果是数据需要克隆一个数组</span></span><br><span class="line">					<span class="comment">//不是数组直接返回</span></span><br><span class="line">                    <span class="keyword">if</span> (var6.getClass().isArray() &amp;&amp; Array.getLength(var6) != <span class="number">0</span>) &#123;</span><br><span class="line">                        var6 = <span class="keyword">this</span>.cloneArray(var6);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> var6;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">//忽略其他方法</span></span><br></pre></td></tr></table></figure>
<p>这里需要重点注意一下的是：AnnotationInvocationHandler的成员变量<code>Map&lt;String, Object&gt; memberValues</code>存放着注解的成员属性的名称和值的映射，注解成员属性的名称实际上就对应着接口中抽象方法的名称，例如上面我们定义的<code>@Counter</code>注解生成代理类后，它的AnnotationInvocationHandler实例中的memberValues属性存放着键值对<code>count=1</code>。</p>
<p>既然知道了注解底层使用了JDK原生的Proxy，那么我们可以直接输出代理类到指定目录去分析代理类的源码，有两种方式可以输出Proxy类的源码：</p>
<ul>
<li>1、通过Java系统属性设置<code>System.setProperty(&quot;sun.misc.ProxyGenerator.saveGeneratedFiles&quot;, &quot;true&quot;);</code>。</li>
<li>2、通过-D参数指定，其实跟1差不多，参数是：<code>-Dsun.misc.ProxyGenerator.saveGeneratedFiles=true</code>。</li>
</ul>
<p>这里使用方式1，修改一下上面用到的main方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">	System.setProperty(<span class="string">"sun.misc.ProxyGenerator.saveGeneratedFiles"</span>, <span class="string">"true"</span>);</span><br><span class="line">	Counter counter = Main<span class="class">.<span class="keyword">class</span>.<span class="title">getAnnotation</span>(<span class="title">Counter</span>.<span class="title">class</span>)</span>;</span><br><span class="line">	System.out.println(counter.count());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>执行完毕之后，项目中多了一个目录：</p>
<p><img src="http://pazkqls86.bkt.clouddn.com/anno-3.png" alt="anno-3"></p>
<p>其中$Proxy0是@Retention注解对应的动态代理类，而$Proxy1才是我们的@Counter对应的动态代理类，当然如果有更多的注解，那么有可能生成$ProxyN。接着我们直接看$Proxy1的源码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> $<span class="title">Proxy1</span> <span class="keyword">extends</span> <span class="title">Proxy</span> <span class="keyword">implements</span> <span class="title">Counter</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m1;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m2;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m3;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m4;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Method m0;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> $Proxy1(InvocationHandler var1) <span class="keyword">throws</span>  &#123;</span><br><span class="line">        <span class="keyword">super</span>(var1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object var1)</span> <span class="keyword">throws</span>  </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (Boolean)<span class="keyword">super</span>.h.invoke(<span class="keyword">this</span>, m1, <span class="keyword">new</span> Object[]&#123;var1&#125;);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> var3;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var4) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var4);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">toString</span><span class="params">()</span> <span class="keyword">throws</span>  </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (String)<span class="keyword">super</span>.h.invoke(<span class="keyword">this</span>, m2, (Object[])<span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var2) &#123;</span><br><span class="line">            <span class="keyword">throw</span> var2;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var3);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">count</span><span class="params">()</span> <span class="keyword">throws</span>  </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (Integer)<span class="keyword">super</span>.h.invoke(<span class="keyword">this</span>, m3, (Object[])<span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var2) &#123;</span><br><span class="line">            <span class="keyword">throw</span> var2;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var3);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Class <span class="title">annotationType</span><span class="params">()</span> <span class="keyword">throws</span>  </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (Class)<span class="keyword">super</span>.h.invoke(<span class="keyword">this</span>, m4, (Object[])<span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var2) &#123;</span><br><span class="line">            <span class="keyword">throw</span> var2;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var3);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> <span class="keyword">throws</span>  </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> (Integer)<span class="keyword">super</span>.h.invoke(<span class="keyword">this</span>, m0, (Object[])<span class="keyword">null</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RuntimeException | Error var2) &#123;</span><br><span class="line">            <span class="keyword">throw</span> var2;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> UndeclaredThrowableException(var3);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            m1 = Class.forName(<span class="string">"java.lang.Object"</span>).getMethod(<span class="string">"equals"</span>, Class.forName(<span class="string">"java.lang.Object"</span>));</span><br><span class="line">            m2 = Class.forName(<span class="string">"java.lang.Object"</span>).getMethod(<span class="string">"toString"</span>);</span><br><span class="line">            m3 = Class.forName(<span class="string">"club.throwable.annotation.Counter"</span>).getMethod(<span class="string">"count"</span>);</span><br><span class="line">            m4 = Class.forName(<span class="string">"club.throwable.annotation.Counter"</span>).getMethod(<span class="string">"annotationType"</span>);</span><br><span class="line">            m0 = Class.forName(<span class="string">"java.lang.Object"</span>).getMethod(<span class="string">"hashCode"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NoSuchMethodException var2) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchMethodError(var2.getMessage());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NoClassDefFoundError(var3.getMessage());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>显然，$Proxy1实现了Counter接口，它在代码的最后部分使用了静态代码块实例化了成员方法的Method实例，在前面的代码对这些Method进行了缓存，在调用成员方法的时候都是直接委托到InvocationHandler(AnnotationInvocationHandler)实例完成调用。我们在分析AnnotationInvocationHandler的时候看到，它只用到了Method的名称从Map从匹配出成员方法的结果，因此调用过程<strong>并不是反射调用</strong>，反而是直接的调用，效率类似于通过Key从Map实例中获取Value一样，是十分高效的。</p>
<h1>小结</h1>
<p>既然知道了注解的底层原理，我们可以编写一个&quot;注解接口&quot;和InvocationHandler实现来简单模拟整个过程。先定义一个接口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CounterAnnotation</span> <span class="keyword">extends</span> <span class="title">Annotation</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">int</span> <span class="title">count</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>InvocationHandler的简单实现：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CounterAnnotationInvocationHandler</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, Object&gt; memberValues;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Class&lt;? extends Annotation&gt; clazz;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">CounterAnnotationInvocationHandler</span><span class="params">(Map&lt;String, Object&gt; memberValues, Class&lt;? extends Annotation&gt; clazz)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">this</span>.memberValues = memberValues;</span><br><span class="line">		<span class="keyword">this</span>.clazz = clazz;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Override</span></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">		String methodName = method.getName();</span><br><span class="line">		Object value;</span><br><span class="line">		<span class="keyword">switch</span> (methodName) &#123;</span><br><span class="line">			<span class="keyword">case</span> <span class="string">"toString"</span>:</span><br><span class="line">				value = <span class="keyword">super</span>.toString();</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="string">"hashCode"</span>:</span><br><span class="line">				value = <span class="keyword">super</span>.hashCode();</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="string">"equals"</span>:</span><br><span class="line">				value = <span class="keyword">super</span>.equals(args[<span class="number">0</span>]);</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">case</span> <span class="string">"annotationType"</span>:</span><br><span class="line">				value = clazz;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			<span class="keyword">default</span>:</span><br><span class="line">				value = memberValues.get(methodName);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> value;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编写一个main方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CounterAnnotationMain</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">		<span class="comment">//这里模拟了注解成员属性从常量池解析的过程</span></span><br><span class="line">		Map&lt;String,Object&gt; values = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">8</span>);</span><br><span class="line">		values.put(<span class="string">"count"</span>, <span class="number">1</span>);</span><br><span class="line">		<span class="comment">//生成代理类</span></span><br><span class="line">		CounterAnnotation proxy = (CounterAnnotation)Proxy.newProxyInstance(CounterAnnotationMain<span class="class">.<span class="keyword">class</span>.<span class="title">getClassLoader</span>(),</span></span><br><span class="line">				new Class[]&#123;CounterAnnotation.class&#125;,</span><br><span class="line">				<span class="keyword">new</span> CounterAnnotationInvocationHandler(values, CounterAnnotation<span class="class">.<span class="keyword">class</span>))</span>;</span><br><span class="line">		System.out.println(proxy.count());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//运行后控制台输出:1</span></span><br></pre></td></tr></table></figure>
<p>(本文完 c-1-d e-20181006)</p>

      
    </div>
    <!-- 
      <div class="full-width auto-padding tags">
        
          <a href="/blog/tags/Java/" rel="nofollow"><i class="fas fa-tag fa-fw"></i> Java</a>
        
          <a href="/blog/tags/Annotation/" rel="nofollow"><i class="fas fa-tag fa-fw"></i> Annotation</a>
        
      </div>
     -->
  </section>
</article>

          </div>
        
      
        
          <div class='post-wrapper'>
            <article class="post white-box card-shadow  reveal ">
  


  <section class='meta'>
    
    
    <div class="meta" id="header-meta">
      
        
  <h2 class="title">
    <a href="/2018/11/04/enum-implementation/">
      JDK中枚举的底层实现
    </a>
  </h2>


      
      <div class='new-meta-box'>
        
          
        
          
            
  <div class='new-meta-item author'>
    
      <a href="http://throwable.club" rel="nofollow">
        
          <img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/mine/doge_avatar.jpg">
        
        <p>Throwable</p>
      </a>
    
  </div>


          
        
          
            <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-edit" aria-hidden="true"></i>
    <p>发布于：2018年11月4日</p>
  </a>
</div>

          
        
          
            
  
  <div class='new-meta-item category'>
    <a href='/blog/categories/Java/Enum/' rel="nofollow">
      <i class="fas fa-folder-open" aria-hidden="true"></i>
      <p>Java&nbsp;/&nbsp;Enum</p>
    </a>
  </div>


          
        
          
            
  <div class="new-meta-item wordcount">
    <a class='notlink'>
      <i class="fas fa-keyboard" aria-hidden="true"></i>
      <p>字数：2.3k字</p>
    </a>
  </div>
  <div class="new-meta-item readtime">
    <a class='notlink'>
      <i class="fas fa-hourglass-half" aria-hidden="true"></i>
      <p>时长：12分钟</p>
    </a>
  </div>


          
        
          
            <div class="new-meta-item date" itemprop="dateUpdated" datetime="2018-11-17T15:52:01+08:00">
  <a class='notlink'>
    <i class="fas fa-save" aria-hidden="true"></i>
    <p>更新于：2018年11月17日</p>
  </a>
</div>

          
        
          
            

          
        
          
            

          
        
      </div>
      
        <hr>
      
    </div>
  </section>


  <section class="article typo">
    <div class="article-entry" itemprop="articleBody">
      <h1>前提</h1>
<p>上一篇文章复习介绍了JDK中注解的底层实现，跟注解一样比较常用，但是底层实现比较神秘的还有枚举类型。趁着国庆假期的最后两天，把JDK中枚举的底层实现也进行一次探究。</p>
<h1>通过例子查找本质</h1>
<p>在探究JDK注解的底层实现的时候，因为预先参考了不少资料，所以整个过程有点&quot;未卜先知&quot;的意味，这里尝试用未知的角度去看注解的底层实现。先定义一个手机操作系统类型枚举PhoneOsEnum：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> club.throwable.enumeration;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> PhoneOsEnum &#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * 安卓</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	ANDROID(<span class="number">1</span>, <span class="string">"android"</span>),</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * ios</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	IOS(<span class="number">2</span>, <span class="string">"ios"</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Integer type;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> String typeName;</span><br><span class="line"></span><br><span class="line">	PhoneOsEnum(Integer type, String typeName) &#123;</span><br><span class="line">		<span class="keyword">this</span>.type = type;</span><br><span class="line">		<span class="keyword">this</span>.typeName = typeName;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Integer <span class="title">getType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> type;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getTypeName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> typeName;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这是一个很简单的枚举，接着使用JDK的反编译工具反编译出其字节码，执行下面的命令：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">javap -c -v D:\Projects\rxjava-seed\target\classes\club\throwable\enumeration\PhoneOsEnum.class</span><br></pre></td></tr></table></figure>
<p>然后就得到了关于PhoneOsEnum.class的很长的字节码，这里全部贴出来：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br></pre></td><td class="code"><pre><span class="line">Classfile /D:/Projects/rxjava-seed/target/classes/club/throwable/enumeration/PhoneOsEnum<span class="class">.<span class="keyword">class</span></span></span><br><span class="line"><span class="class">  <span class="title">Last</span> <span class="title">modified</span> 2018-10-6</span>; size <span class="number">1561</span> bytes</span><br><span class="line">  MD5 checksum <span class="number">6</span>d3186042f54233219000927a2f196aa</span><br><span class="line">  Compiled from <span class="string">"PhoneOsEnum.java"</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">club</span>.<span class="title">throwable</span>.<span class="title">enumeration</span>.<span class="title">PhoneOsEnum</span> <span class="keyword">extends</span> <span class="title">java</span>.<span class="title">lang</span>.<span class="title">Enum</span>&lt;<span class="title">club</span>.<span class="title">throwable</span>.<span class="title">enumeration</span>.<span class="title">PhoneOsEnum</span>&gt;</span></span><br><span class="line">  minor version: 0</span><br><span class="line">  major version: <span class="number">52</span></span><br><span class="line">  flags: ACC_PUBLIC, ACC_FINAL, ACC_SUPER, ACC_ENUM</span><br><span class="line">Constant pool:</span><br><span class="line">   #1 = Fieldref           #4.#49         // club/throwable/enumeration/PhoneOsEnum.$VALUES:[Lclub/throwable/enumeration/PhoneOsEnum;</span><br><span class="line">   #2 = Methodref          #50.#51        // "[Lclub/throwable/enumeration/PhoneOsEnum;".clone:()Ljava/lang/Object;</span><br><span class="line">   #3 = Class              #26            // "[Lclub/throwable/enumeration/PhoneOsEnum;"</span><br><span class="line">   #4 = Class              #52            // club/throwable/enumeration/PhoneOsEnum</span><br><span class="line">   #5 = Methodref          #17.#53        // java/lang/Enum.valueOf:(Ljava/lang/Class;Ljava/lang/String;)Ljava/lang/Enum;</span><br><span class="line">   #6 = Methodref          #17.#54        // java/lang/Enum."&lt;init&gt;":(Ljava/lang/String;I)V</span><br><span class="line">   #7 = Fieldref           #4.#55         // club/throwable/enumeration/PhoneOsEnum.type:Ljava/lang/Integer;</span><br><span class="line">   #8 = Fieldref           #4.#56         // club/throwable/enumeration/PhoneOsEnum.typeName:Ljava/lang/String;</span><br><span class="line">   #9 = String             #18            // ANDROID</span><br><span class="line">  #10 = Methodref          #57.#58        // java/lang/Integer.valueOf:(I)Ljava/lang/Integer;</span><br><span class="line">  #11 = String             #59            // android</span><br><span class="line">  #12 = Methodref          #4.#60         // club/throwable/enumeration/PhoneOsEnum."&lt;init&gt;":(Ljava/lang/String;ILjava/lang/Integer;Ljava/lang/String;)V</span><br><span class="line">  #13 = Fieldref           #4.#61         // club/throwable/enumeration/PhoneOsEnum.ANDROID:Lclub/throwable/enumeration/PhoneOsEnum;</span><br><span class="line">  #14 = String             #20            // IOS</span><br><span class="line">  #15 = String             #62            // ios</span><br><span class="line">  #16 = Fieldref           #4.#63         // club/throwable/enumeration/PhoneOsEnum.IOS:Lclub/throwable/enumeration/PhoneOsEnum;</span><br><span class="line">  #17 = Class              #64            // java/lang/Enum</span><br><span class="line">  #18 = Utf8               ANDROID</span><br><span class="line">  #19 = Utf8               Lclub/throwable/enumeration/PhoneOsEnum;</span><br><span class="line">  #20 = Utf8               IOS</span><br><span class="line">  #21 = Utf8               type</span><br><span class="line">  #22 = Utf8               Ljava/lang/Integer;</span><br><span class="line">  #23 = Utf8               typeName</span><br><span class="line">  #24 = Utf8               Ljava/lang/String;</span><br><span class="line">  #25 = Utf8               $VALUES</span><br><span class="line">  #26 = Utf8               [Lclub/throwable/enumeration/PhoneOsEnum;</span><br><span class="line">  #27 = Utf8               values</span><br><span class="line">  #28 = Utf8               ()[Lclub/throwable/enumeration/PhoneOsEnum;</span><br><span class="line">  #29 = Utf8               Code</span><br><span class="line">  #30 = Utf8               LineNumberTable</span><br><span class="line">  #31 = Utf8               valueOf</span><br><span class="line">  #32 = Utf8               (Ljava/lang/String;)Lclub/throwable/enumeration/PhoneOsEnum;</span><br><span class="line">  #33 = Utf8               LocalVariableTable</span><br><span class="line">  #34 = Utf8               name</span><br><span class="line">  #35 = Utf8               &lt;init&gt;</span><br><span class="line">  #36 = Utf8               (Ljava/lang/String;ILjava/lang/Integer;Ljava/lang/String;)V</span><br><span class="line">  #37 = Utf8               this</span><br><span class="line">  #38 = Utf8               Signature</span><br><span class="line">  #39 = Utf8               (Ljava/lang/Integer;Ljava/lang/String;)V</span><br><span class="line">  #40 = Utf8               getType</span><br><span class="line">  #41 = Utf8               ()Ljava/lang/Integer;</span><br><span class="line">  #42 = Utf8               getTypeName</span><br><span class="line">  #43 = Utf8               ()Ljava/lang/String;</span><br><span class="line">  #44 = Utf8               &lt;clinit&gt;</span><br><span class="line">  #45 = Utf8               ()V</span><br><span class="line">  #46 = Utf8               Ljava/lang/Enum&lt;Lclub/throwable/enumeration/PhoneOsEnum;&gt;;</span><br><span class="line">  #47 = Utf8               SourceFile</span><br><span class="line">  #48 = Utf8               PhoneOsEnum.java</span><br><span class="line">  #49 = NameAndType        #25:#26        // $VALUES:[Lclub/throwable/enumeration/PhoneOsEnum;</span><br><span class="line">  #50 = Class              #26            // "[Lclub/throwable/enumeration/PhoneOsEnum;"</span><br><span class="line">  #51 = NameAndType        #65:#66        // clone:()Ljava/lang/Object;</span><br><span class="line">  #52 = Utf8               club/throwable/enumeration/PhoneOsEnum</span><br><span class="line">  #53 = NameAndType        #31:#67        // valueOf:(Ljava/lang/Class;Ljava/lang/String;)Ljava/lang/Enum;</span><br><span class="line">  #54 = NameAndType        #35:#68        // "&lt;init&gt;":(Ljava/lang/String;I)V</span><br><span class="line">  #55 = NameAndType        #21:#22        // type:Ljava/lang/Integer;</span><br><span class="line">  #56 = NameAndType        #23:#24        // typeName:Ljava/lang/String;</span><br><span class="line">  #57 = Class              #69            // java/lang/Integer</span><br><span class="line">  #58 = NameAndType        #31:#70        // valueOf:(I)Ljava/lang/Integer;</span><br><span class="line">  #59 = Utf8               android</span><br><span class="line">  #60 = NameAndType        #35:#36        // "&lt;init&gt;":(Ljava/lang/String;ILjava/lang/Integer;Ljava/lang/String;)V</span><br><span class="line">  #61 = NameAndType        #18:#19        // ANDROID:Lclub/throwable/enumeration/PhoneOsEnum;</span><br><span class="line">  #62 = Utf8               ios</span><br><span class="line">  #63 = NameAndType        #20:#19        // IOS:Lclub/throwable/enumeration/PhoneOsEnum;</span><br><span class="line">  #64 = Utf8               java/lang/Enum</span><br><span class="line">  #65 = Utf8               clone</span><br><span class="line">  #66 = Utf8               ()Ljava/lang/Object;</span><br><span class="line">  #67 = Utf8               (Ljava/lang/Class;Ljava/lang/String;)Ljava/lang/Enum;</span><br><span class="line">  #68 = Utf8               (Ljava/lang/String;I)V</span><br><span class="line">  #69 = Utf8               java/lang/Integer</span><br><span class="line">  #70 = Utf8               (I)Ljava/lang/Integer;</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> club.throwable.enumeration.PhoneOsEnum ANDROID;</span><br><span class="line">    descriptor: Lclub/throwable/enumeration/PhoneOsEnum;</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC, ACC_FINAL, ACC_ENUM</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> club.throwable.enumeration.PhoneOsEnum IOS;</span><br><span class="line">    descriptor: Lclub/throwable/enumeration/PhoneOsEnum;</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC, ACC_FINAL, ACC_ENUM</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> club.throwable.enumeration.PhoneOsEnum[] values();</span><br><span class="line">    descriptor: ()[Lclub/throwable/enumeration/PhoneOsEnum;</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=<span class="number">1</span>, locals=<span class="number">0</span>, args_size=<span class="number">0</span></span><br><span class="line">         0: getstatic     #1                  // Field $VALUES:[Lclub/throwable/enumeration/PhoneOsEnum;</span><br><span class="line">         3: invokevirtual #2                  // Method "[Lclub/throwable/enumeration/PhoneOsEnum;".clone:()Ljava/lang/Object;</span><br><span class="line">         6: checkcast     #3                  // class "[Lclub/throwable/enumeration/PhoneOsEnum;"</span><br><span class="line">         <span class="number">9</span>: areturn</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line <span class="number">9</span>: <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">static</span> club.throwable.enumeration.<span class="function">PhoneOsEnum <span class="title">valueOf</span><span class="params">(java.lang.String)</span></span>;</span><br><span class="line">    descriptor: (Ljava/lang/String;)Lclub/throwable/enumeration/PhoneOsEnum;</span><br><span class="line">    flags: ACC_PUBLIC, ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=<span class="number">2</span>, locals=<span class="number">1</span>, args_size=<span class="number">1</span></span><br><span class="line">         0: ldc           #4                  // class club/throwable/enumeration/PhoneOsEnum</span><br><span class="line">         <span class="number">2</span>: aload_0</span><br><span class="line">         3: invokestatic  #5                  // Method java/lang/Enum.valueOf:(Ljava/lang/Class;Ljava/lang/String;)Ljava/lang/Enum;</span><br><span class="line">         6: checkcast     #4                  // class club/throwable/enumeration/PhoneOsEnum</span><br><span class="line">         <span class="number">9</span>: areturn</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line <span class="number">9</span>: <span class="number">0</span></span><br><span class="line">      LocalVariableTable:</span><br><span class="line">        Start  Length  Slot  Name   Signature</span><br><span class="line">            <span class="number">0</span>      <span class="number">10</span>     <span class="number">0</span>  name   Ljava/lang/String;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> java.lang.<span class="function">Integer <span class="title">getType</span><span class="params">()</span></span>;</span><br><span class="line">    descriptor: ()Ljava/lang/Integer;</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=<span class="number">1</span>, locals=<span class="number">1</span>, args_size=<span class="number">1</span></span><br><span class="line">         <span class="number">0</span>: aload_0</span><br><span class="line">         1: getfield      #7                  // Field type:Ljava/lang/Integer;</span><br><span class="line">         <span class="number">4</span>: areturn</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line <span class="number">31</span>: <span class="number">0</span></span><br><span class="line">      LocalVariableTable:</span><br><span class="line">        Start  Length  Slot  Name   Signature</span><br><span class="line">            <span class="number">0</span>       <span class="number">5</span>     <span class="number">0</span>  <span class="keyword">this</span>   Lclub/throwable/enumeration/PhoneOsEnum;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">public</span> java.lang.<span class="function">String <span class="title">getTypeName</span><span class="params">()</span></span>;</span><br><span class="line">    descriptor: ()Ljava/lang/String;</span><br><span class="line">    flags: ACC_PUBLIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=<span class="number">1</span>, locals=<span class="number">1</span>, args_size=<span class="number">1</span></span><br><span class="line">         <span class="number">0</span>: aload_0</span><br><span class="line">         1: getfield      #8                  // Field typeName:Ljava/lang/String;</span><br><span class="line">         <span class="number">4</span>: areturn</span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line <span class="number">35</span>: <span class="number">0</span></span><br><span class="line">      LocalVariableTable:</span><br><span class="line">        Start  Length  Slot  Name   Signature</span><br><span class="line">            <span class="number">0</span>       <span class="number">5</span>     <span class="number">0</span>  <span class="keyword">this</span>   Lclub/throwable/enumeration/PhoneOsEnum;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> &#123;&#125;;</span><br><span class="line">    descriptor: ()V</span><br><span class="line">    flags: ACC_STATIC</span><br><span class="line">    Code:</span><br><span class="line">      stack=<span class="number">6</span>, locals=<span class="number">0</span>, args_size=<span class="number">0</span></span><br><span class="line">         0: new           #4                  // class club/throwable/enumeration/PhoneOsEnum</span><br><span class="line">         <span class="number">3</span>: dup</span><br><span class="line">         4: ldc           #9                  // String ANDROID</span><br><span class="line">         <span class="number">6</span>: iconst_0</span><br><span class="line">         <span class="number">7</span>: iconst_1</span><br><span class="line">         8: invokestatic  #10                 // Method java/lang/Integer.valueOf:(I)Ljava/lang/Integer;</span><br><span class="line">        11: ldc           #11                 // String android</span><br><span class="line">        13: invokespecial #12                 // Method "&lt;init&gt;":(Ljava/lang/String;ILjava/lang/Integer;Ljava/lang/String;)V</span><br><span class="line">        16: putstatic     #13                 // Field ANDROID:Lclub/throwable/enumeration/PhoneOsEnum;</span><br><span class="line">        19: new           #4                  // class club/throwable/enumeration/PhoneOsEnum</span><br><span class="line">        <span class="number">22</span>: dup</span><br><span class="line">        23: ldc           #14                 // String IOS</span><br><span class="line">        <span class="number">25</span>: iconst_1</span><br><span class="line">        <span class="number">26</span>: iconst_2</span><br><span class="line">        27: invokestatic  #10                 // Method java/lang/Integer.valueOf:(I)Ljava/lang/Integer;</span><br><span class="line">        30: ldc           #15                 // String ios</span><br><span class="line">        32: invokespecial #12                 // Method "&lt;init&gt;":(Ljava/lang/String;ILjava/lang/Integer;Ljava/lang/String;)V</span><br><span class="line">        35: putstatic     #16                 // Field IOS:Lclub/throwable/enumeration/PhoneOsEnum;</span><br><span class="line">        <span class="number">38</span>: iconst_2</span><br><span class="line">        39: anewarray     #4                  // class club/throwable/enumeration/PhoneOsEnum</span><br><span class="line">        <span class="number">42</span>: dup</span><br><span class="line">        <span class="number">43</span>: iconst_0</span><br><span class="line">        44: getstatic     #13                 // Field ANDROID:Lclub/throwable/enumeration/PhoneOsEnum;</span><br><span class="line">        <span class="number">47</span>: aastore</span><br><span class="line">        <span class="number">48</span>: dup</span><br><span class="line">        <span class="number">49</span>: iconst_1</span><br><span class="line">        50: getstatic     #16                 // Field IOS:Lclub/throwable/enumeration/PhoneOsEnum;</span><br><span class="line">        <span class="number">53</span>: aastore</span><br><span class="line">        54: putstatic     #1                  // Field $VALUES:[Lclub/throwable/enumeration/PhoneOsEnum;</span><br><span class="line">        <span class="number">57</span>: <span class="keyword">return</span></span><br><span class="line">      LineNumberTable:</span><br><span class="line">        line <span class="number">14</span>: <span class="number">0</span></span><br><span class="line">        line <span class="number">19</span>: <span class="number">19</span></span><br><span class="line">        line <span class="number">9</span>: <span class="number">38</span></span><br><span class="line">&#125;</span><br><span class="line">Signature: #46                          // Ljava/lang/Enum&lt;Lclub/throwable/enumeration/PhoneOsEnum;&gt;;</span><br><span class="line">SourceFile: <span class="string">"PhoneOsEnum.java"</span></span><br></pre></td></tr></table></figure>
<p>先看类的签名是<code>public final class club.throwable.enumeration.PhoneOsEnum extends java.lang.Enum&lt;club.throwable.enumeration.PhoneOsEnum&gt;</code>，它的父类是java.lang.Enum，父类的泛型就是自身club.throwable.enumeration.PhoneOsEnum。上面的字节码的可读性相对比较低，直接翻译为Java代码(当然我们不能声明一个类直接继承java.lang.Enum，这里仅仅为了说明反编译后的枚举类的原型)如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">PhoneOsEnumeration</span> <span class="keyword">extends</span> <span class="title">Enum</span>&lt;<span class="title">PhoneOsEnumeration</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="title">PhoneOsEnumeration</span><span class="params">(String name, <span class="keyword">int</span> ordinal, Integer type, String typeName)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">super</span>(name, ordinal);</span><br><span class="line">		<span class="keyword">this</span>.type = type;</span><br><span class="line">		<span class="keyword">this</span>.typeName = typeName;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> Integer <span class="title">getType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> type;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getTypeName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> typeName;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> PhoneOsEnumeration[] values() &#123;</span><br><span class="line">		<span class="keyword">return</span> $VALUES.clone();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> PhoneOsEnumeration <span class="title">valueOf</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> Enum.valueOf(PhoneOsEnumeration<span class="class">.<span class="keyword">class</span>, <span class="title">name</span>)</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Integer type;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">final</span> String typeName;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> PhoneOsEnumeration ANDROID;</span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> PhoneOsEnumeration IOS;</span><br><span class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> PhoneOsEnumeration[] $VALUES;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">static</span> &#123;</span><br><span class="line">		ANDROID = <span class="keyword">new</span> PhoneOsEnumeration(<span class="string">"ANDROID"</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="string">"android"</span>);</span><br><span class="line">		IOS = <span class="keyword">new</span> PhoneOsEnumeration(<span class="string">"IOS"</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="string">"ios"</span>);</span><br><span class="line">		$VALUES = <span class="keyword">new</span> PhoneOsEnumeration[]&#123;ANDROID, IOS&#125;;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>概括来说就是成员变量都是通过静态代码块声明，这里注意一点父类Enum实例化的时候需要覆盖父类构造器<code>protected Enum(String name, int ordinal)</code>，其他方法的实现都是十分简单。</p>
<h1>JDK的枚举描述</h1>
<p>国际惯例，先看一下JavaSE-8的语言规范中<a href="https://docs.oracle.com/javase/specs/jls/se8/html/jls-8.html#jls-8.9" target="_blank" rel="noopener">JLS-8.9</a>对枚举类型的定义和描述：</p>
<p><img src="http://pazkqls86.bkt.clouddn.com/enum-1.png" alt="enum-1"></p>
<p>感觉有点似曾相识，总结一下重要内容有以下几点：</p>
<ul>
<li>枚举的声明格式是：<code>{ClassModifier} enum Identifier [Superinterfaces] EnumBody</code>，ClassModifier是修饰符，Identifier是枚举的名称可以类比为类名，枚举类型可以实现接口。</li>
<li>枚举类型不能使用abstract或者final修饰，否则会产生编译错误。</li>
<li>枚举类型的直接超类是java.lang.Enum。</li>
<li>枚举类型除了枚举常量定义之外没有其他实例，也就是枚举类型不能实例化。</li>
<li>枚举类型禁用反射操作进行实例化(这个特性就是Effetive Java中推荐使用枚举实现单例的原因)。</li>
</ul>
<p>枚举的公共父类java.lang.Enum的源码如下(已经去掉全部注释)：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Enum</span>&lt;<span class="title">E</span> <span class="keyword">extends</span> <span class="title">Enum</span>&lt;<span class="title">E</span>&gt;&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">Comparable</span>&lt;<span class="title">E</span>&gt;, <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String name; </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> String <span class="title">name</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> ordinal;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">ordinal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ordinal;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">Enum</span><span class="params">(String name, <span class="keyword">int</span> ordinal)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.ordinal = ordinal;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object other)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>==other;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.hashCode();</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> Object <span class="title">clone</span><span class="params">()</span> <span class="keyword">throws</span> CloneNotSupportedException </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> CloneNotSupportedException();</span><br><span class="line">    &#125;  </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(E o)</span> </span>&#123;</span><br><span class="line">        Enum&lt;?&gt; other = (Enum&lt;?&gt;)o;</span><br><span class="line">        Enum&lt;E&gt; self = <span class="keyword">this</span>;</span><br><span class="line">        <span class="keyword">if</span> (self.getClass() != other.getClass() &amp;&amp; <span class="comment">// optimization</span></span><br><span class="line">            self.getDeclaringClass() != other.getDeclaringClass())</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ClassCastException();</span><br><span class="line">        <span class="keyword">return</span> self.ordinal - other.ordinal;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> Class&lt;E&gt; <span class="title">getDeclaringClass</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Class&lt;?&gt; clazz = getClass();</span><br><span class="line">        Class&lt;?&gt; zuper = clazz.getSuperclass();</span><br><span class="line">        return (zuper == Enum.class) ? (Class&lt;E&gt;)clazz : (Class&lt;E&gt;)zuper;</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T extends Enum&lt;T&gt;&gt; <span class="function">T <span class="title">valueOf</span><span class="params">(Class&lt;T&gt; enumType,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                String name)</span> </span>&#123;</span><br><span class="line">        T result = enumType.enumConstantDirectory().get(name);</span><br><span class="line">        <span class="keyword">if</span> (result != <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">return</span> result;</span><br><span class="line">        <span class="keyword">if</span> (name == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"Name is null"</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(</span><br><span class="line">            <span class="string">"No enum constant "</span> + enumType.getCanonicalName() + <span class="string">"."</span> + name);</span><br><span class="line">    &#125;  </span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">finalize</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObject</span><span class="params">(ObjectInputStream in)</span> <span class="keyword">throws</span> IOException,</span></span><br><span class="line"><span class="function">        ClassNotFoundException </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InvalidObjectException(<span class="string">"can't deserialize enum"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readObjectNoData</span><span class="params">()</span> <span class="keyword">throws</span> ObjectStreamException </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> InvalidObjectException(<span class="string">"can't deserialize enum"</span>);</span><br><span class="line">    &#125;                              </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>大部分方法都比较简单，值得注意的几点是：</p>
<ul>
<li>1、<code>valueOf</code>方法依赖到的<code>Class&lt;?&gt;#enumConstantDirectory()</code>，这个方法首次调用完成之后，结果会缓存在<code>Class&lt;?&gt;#enumConstantDirectory</code>变量中。</li>
<li>2、Enum实现了Serializable接口，但是<code>readObject</code>和<code>readObjectNoData</code>直接抛出了InvalidObjectException异常，注释说到是&quot;防止默认的反序列化&quot;，这一点有点不明不白，既然禁用反序列化为何要实现Serializable接口，这里可能考虑到是否实现Serializable接口应该交给开发者决定。</li>
<li>3、Enum禁用克隆。</li>
</ul>
<h1>小结</h1>
<p>JDK中枚举的底层实现就是使用了enum关键字声明的枚举类编译后最终会变成public final修饰同时实现了泛型接口java.lang.Enum并且指定泛型参数为自身的普通Java类，而成员属性和方法实现相关都是在编译完成后就已经成型的，枚举类型的成员变量都是通过静态代码块声明的。</p>
<p>(本文完 c-1-d e-20181006)</p>

      
    </div>
    <!-- 
      <div class="full-width auto-padding tags">
        
          <a href="/blog/tags/Java/" rel="nofollow"><i class="fas fa-tag fa-fw"></i> Java</a>
        
          <a href="/blog/tags/Enum/" rel="nofollow"><i class="fas fa-tag fa-fw"></i> Enum</a>
        
      </div>
     -->
  </section>
</article>

          </div>
        
      
        
          <div class='post-wrapper'>
            <article class="post white-box card-shadow  reveal ">
  


  <section class='meta'>
    
    
    <div class="meta" id="header-meta">
      
        
  <h2 class="title">
    <a href="/2018/11/04/helloworld/">
      Hi, theme-melody!
    </a>
  </h2>


      
      <div class='new-meta-box'>
        
          
        
          
            
  <div class='new-meta-item author'>
    
      <a href="http://throwable.club" rel="nofollow">
        
          <img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/mine/doge_avatar.jpg">
        
        <p>Throwable</p>
      </a>
    
  </div>


          
        
          
            <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-edit" aria-hidden="true"></i>
    <p>发布于：2018年11月4日</p>
  </a>
</div>

          
        
          
            
  
  <div class='new-meta-item category'>
    <a href='/blog/categories/hexo/' rel="nofollow">
      <i class="fas fa-folder-open" aria-hidden="true"></i>
      <p>hexo</p>
    </a>
  </div>


          
        
          
            
  <div class="new-meta-item wordcount">
    <a class='notlink'>
      <i class="fas fa-keyboard" aria-hidden="true"></i>
      <p>字数：185字</p>
    </a>
  </div>
  <div class="new-meta-item readtime">
    <a class='notlink'>
      <i class="fas fa-hourglass-half" aria-hidden="true"></i>
      <p>时长：1分钟</p>
    </a>
  </div>


          
        
          
            <div class="new-meta-item date" itemprop="dateUpdated" datetime="2019-07-22T22:58:31+08:00">
  <a class='notlink'>
    <i class="fas fa-save" aria-hidden="true"></i>
    <p>更新于：2019年7月22日</p>
  </a>
</div>

          
        
          
            

          
        
          
            

          
        
      </div>
      
        <hr>
      
    </div>
  </section>


  <section class="article typo">
    <div class="article-entry" itemprop="articleBody">
      <h1>init</h1>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo init [folder]</span><br></pre></td></tr></table></figure>
<p>Initializes a website.</p>
<h1>new</h1>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hexo new [layout] &lt;title&gt;  <span class="comment"># hexo new post $&#123;article&#125;</span></span><br></pre></td></tr></table></figure>
<p>Creates a new article.</p>
<h1>generate</h1>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate  <span class="comment"># hexo g</span></span><br></pre></td></tr></table></figure>
<p>Generates static files.</p>
<table>
<thead>
<tr>
<th style="text-align:center">Option</th>
<th style="text-align:center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">-d, --deploy</td>
<td style="text-align:center">Deploy after generation finishes</td>
</tr>
<tr>
<td style="text-align:center">-w, --watch</td>
<td style="text-align:center">Watch file changes</td>
</tr>
<tr>
<td style="text-align:center">-b, --bail</td>
<td style="text-align:center">Raise an error if any unhandled exception is thrown during generation</td>
</tr>
<tr>
<td style="text-align:center">-f, --force</td>
<td style="text-align:center">Force regenerate</td>
</tr>
</tbody>
</table>
<h1>publish</h1>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo publish [layout] &lt;filename&gt;</span><br></pre></td></tr></table></figure>
<p>Publishes a draft.</p>
<h1>server</h1>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server <span class="comment"># hexo s</span></span><br></pre></td></tr></table></figure>
<table>
<thead>
<tr>
<th style="text-align:center">Option</th>
<th style="text-align:center">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">-p, --port</td>
<td style="text-align:center">Override default port</td>
</tr>
<tr>
<td style="text-align:center">-s, --static</td>
<td style="text-align:center">Only serve static files</td>
</tr>
<tr>
<td style="text-align:center">-l, --log</td>
<td style="text-align:center">Enable logger. Override logger format</td>
</tr>
</tbody>
</table>
<p>Starts a local server. By default, this is at <a href="http://localhost:4000/" target="_blank" rel="noopener">http://localhost:4000/</a>.</p>
<h1>deploy</h1>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy <span class="comment"># hexo d</span></span><br></pre></td></tr></table></figure>
<h1>clean</h1>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo clean</span><br></pre></td></tr></table></figure>
<h1>end</h1>
<p>I spent an afternoon updating blog topics and migrating articles.The theme has been updated to <a href="https://molunerfinn.com/hexo-theme-melody-doc" target="_blank" rel="noopener">melody</a> and I like it very much!</p>
<h1>test</h1>
<div class="admonitionblock note"><table><tr><td style="padding: 1.3rem 0.6rem;border: none;border-right: solid;" class="icon"><i class="fa icon-note" title="Note"></i></td><td class="content" style="border: none"><div class="title">Not bloğu</div><div class="paragraph"><p>Burası bir not bloğu</p></div></td></tr></table></div><br>
<div class="admonitionblock important"><table><tr><td  style="padding: 1.3rem 0.6rem;border: none;border-right: solid;" class="icon"><i class="fa icon-important" title="Important"></i></td><td class="content" style="border: none"><div class="title">İpucu bloğu</div><div class="paragraph"><p>Burası bir ipucu bloğu</p></div></td></tr></table></div><br>
<div class="admonitionblock tip"><table><tr><td class="icon" style="padding: 1.3rem 0.6rem;border: none;border-right: solid;"><i class="fa icon-tip" title="Tip"></i></td><td class="content" style="border: none"><div class="title">İpucu bloğu</div><div class="paragraph"><p>Burası bir ipucu bloğu</p></div></td></tr></table></div><br>
<div class="admonitionblock caution"><table><tr><td class="icon" style="padding: 1.3rem 0.6rem;border: none;border-right: solid;"><i class="fa icon-caution" title="Caution"></i></td><td class="content" style="border: none"><div class="title">Dikkat bloğu</div><div class="paragraph"><p>Burası bir dikkat bloğu</p></div></td></tr></table></div><br>
<div class="admonitionblock warning"><table><tr><td class="icon" style="padding: 1.3rem 0.6rem;border: none;border-right: solid;"><i class="fa icon-warning" title="Warning"></i></td><td class="content" style="border: none"><div class="title">Uyarı bloğu</div><div class="paragraph"><p>Burası bir uyarı bloğu</p></div></td></tr></table></div><br>
<p>(To be continue…)</p>

      
    </div>
    <!-- 
      <div class="full-width auto-padding tags">
        
          <a href="/blog/tags/hexo/" rel="nofollow"><i class="fas fa-tag fa-fw"></i> hexo</a>
        
          <a href="/blog/tags/hexo-theme/" rel="nofollow"><i class="fas fa-tag fa-fw"></i> hexo theme</a>
        
      </div>
     -->
  </section>
</article>

          </div>
        
      
    
  </section>
  
    
      <br>
      <div class="prev-next">
        
          <a class="prev" rel="prev" href="/blog/archives/2018/page/2/">
            <section class="post prev white-box card-shadow " >
              <i class="fas fa-chevron-left" aria-hidden="true"></i>&nbsp;上一页&nbsp;
            </section>
          </a>
        
        <p class="current">
          3 / 3
        </p>
        
      </div>
    
    <!-- 根据主题中的设置决定是否在archive中针对摘要部分的MathJax公式加载mathjax.js文件 -->
    
    

  


	
</div>
<aside class='l_side'>
  
    
    
      
        
          <section class='widget card-shadow  blogger'>
  <div class='content'>
    
      <div class='avatar'>
        <img class='avatar' src='https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/mine/doge_avatar.jpg'/>
      </div>
    
    
    
      <div class="social-wrapper">
        
          
            <a href="/atom.xml"
              class="social fas fa-rss fa-lg flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
          
            <a href="mailto:739805340@qq.com"
              class="social fas fa-envelope fa-lg flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
          
            <a href="https://github.com/zjcscut"
              class="social fab fa-github fa-lg flat-btn"
              target="_blank"
              rel="external nofollow noopener noreferrer">
            </a>
          
        
      </div>
    
  </div>
</section>

        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
      
        
      
        
      
        
          
  <section class='widget card-shadow  category'>
    <header>
  <div>
    
      <i class="fas fa-folder-open fa-fw" aria-hidden="true"></i><span class='name'>文章分类</span>
    

  </div>
  
    <a class="rightBtn"
    
      rel="external nofollow noopener noreferrer"
    
    
      target="_self"
    
    href="/categories/"
    title="categories/">
    <i class="fas fa-expand-arrows-alt fa-fw"></i></a>
  
</header>

    <div class='content'>
      <ul class="entry navigation">
        
          <li><a class="flat-box"
            title="/blog/categories/Framework/" href="/blog/categories/Framework/"
            id="blogcategoriesFramework"
            ><div class='name'>Framework</div><div class='badge'>(8)</div></a></li>
        
          <li><a class="flat-box child"
            title="/blog/categories/Framework/Archunit/" href="/blog/categories/Framework/Archunit/"
            id="blogcategoriesFrameworkArchunit"
            ><div class='name'>Archunit</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box child"
            title="/blog/categories/Framework/Cglib/" href="/blog/categories/Framework/Cglib/"
            id="blogcategoriesFrameworkCglib"
            ><div class='name'>Cglib</div><div class='badge'>(2)</div></a></li>
        
          <li><a class="flat-box child"
            title="/blog/categories/Framework/Hystrix/" href="/blog/categories/Framework/Hystrix/"
            id="blogcategoriesFrameworkHystrix"
            ><div class='name'>Hystrix</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box child"
            title="/blog/categories/Framework/Micrometer/" href="/blog/categories/Framework/Micrometer/"
            id="blogcategoriesFrameworkMicrometer"
            ><div class='name'>Micrometer</div><div class='badge'>(2)</div></a></li>
        
          <li><a class="flat-box child"
            title="/blog/categories/Framework/Mybatis/" href="/blog/categories/Framework/Mybatis/"
            id="blogcategoriesFrameworkMybatis"
            ><div class='name'>Mybatis</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box child"
            title="/blog/categories/Framework/Zuul/" href="/blog/categories/Framework/Zuul/"
            id="blogcategoriesFrameworkZuul"
            ><div class='name'>Zuul</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box"
            title="/blog/categories/Go/" href="/blog/categories/Go/"
            id="blogcategoriesGo"
            ><div class='name'>Go</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box child"
            title="/blog/categories/Go/Golang/" href="/blog/categories/Go/Golang/"
            id="blogcategoriesGoGolang"
            ><div class='name'>Golang</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box"
            title="/blog/categories/In-Action/" href="/blog/categories/In-Action/"
            id="blogcategoriesIn-Action"
            ><div class='name'>In Action</div><div class='badge'>(2)</div></a></li>
        
          <li><a class="flat-box child"
            title="/blog/categories/In-Action/Distributed-Transaction/" href="/blog/categories/In-Action/Distributed-Transaction/"
            id="blogcategoriesIn-ActionDistributed-Transaction"
            ><div class='name'>Distributed Transaction</div><div class='badge'>(2)</div></a></li>
        
          <li><a class="flat-box"
            title="/blog/categories/Java/" href="/blog/categories/Java/"
            id="blogcategoriesJava"
            ><div class='name'>Java</div><div class='badge'>(37)</div></a></li>
        
          <li><a class="flat-box child"
            title="/blog/categories/Java/Algorithm/" href="/blog/categories/Java/Algorithm/"
            id="blogcategoriesJavaAlgorithm"
            ><div class='name'>Algorithm</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box child"
            title="/blog/categories/Java/Annotation/" href="/blog/categories/Java/Annotation/"
            id="blogcategoriesJavaAnnotation"
            ><div class='name'>Annotation</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box child"
            title="/blog/categories/Java/Concurrency/" href="/blog/categories/Java/Concurrency/"
            id="blogcategoriesJavaConcurrency"
            ><div class='name'>Concurrency</div><div class='badge'>(9)</div></a></li>
        
          <li><a class="flat-box child"
            title="/blog/categories/Java/Design-Pattern/" href="/blog/categories/Java/Design-Pattern/"
            id="blogcategoriesJavaDesign-Pattern"
            ><div class='name'>Design Pattern</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box child"
            title="/blog/categories/Java/Enum/" href="/blog/categories/Java/Enum/"
            id="blogcategoriesJavaEnum"
            ><div class='name'>Enum</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box child"
            title="/blog/categories/Java/Functional-Programming/" href="/blog/categories/Java/Functional-Programming/"
            id="blogcategoriesJavaFunctional-Programming"
            ><div class='name'>Functional Programming</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box child"
            title="/blog/categories/Java/Instrument/" href="/blog/categories/Java/Instrument/"
            id="blogcategoriesJavaInstrument"
            ><div class='name'>Instrument</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box child"
            title="/blog/categories/Java/Introspector/" href="/blog/categories/Java/Introspector/"
            id="blogcategoriesJavaIntrospector"
            ><div class='name'>Introspector</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box child"
            title="/blog/categories/Java/JVM/" href="/blog/categories/Java/JVM/"
            id="blogcategoriesJavaJVM"
            ><div class='name'>JVM</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box child"
            title="/blog/categories/Java/Lambda/" href="/blog/categories/Java/Lambda/"
            id="blogcategoriesJavaLambda"
            ><div class='name'>Lambda</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box child"
            title="/blog/categories/Java/Netty/" href="/blog/categories/Java/Netty/"
            id="blogcategoriesJavaNetty"
            ><div class='name'>Netty</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box child"
            title="/blog/categories/Java/Reflection/" href="/blog/categories/Java/Reflection/"
            id="blogcategoriesJavaReflection"
            ><div class='name'>Reflection</div><div class='badge'>(8)</div></a></li>
        
          <li><a class="flat-box"
            title="/blog/categories/Life/" href="/blog/categories/Life/"
            id="blogcategoriesLife"
            ><div class='name'>Life</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box"
            title="/blog/categories/Middleware/" href="/blog/categories/Middleware/"
            id="blogcategoriesMiddleware"
            ><div class='name'>Middleware</div><div class='badge'>(34)</div></a></li>
        
          <li><a class="flat-box child"
            title="/blog/categories/Middleware/Quartz/" href="/blog/categories/Middleware/Quartz/"
            id="blogcategoriesMiddlewareQuartz"
            ><div class='name'>Quartz</div><div class='badge'>(14)</div></a></li>
        
          <li><a class="flat-box child"
            title="/blog/categories/Middleware/RabbitMQ/" href="/blog/categories/Middleware/RabbitMQ/"
            id="blogcategoriesMiddlewareRabbitMQ"
            ><div class='name'>RabbitMQ</div><div class='badge'>(9)</div></a></li>
        
          <li><a class="flat-box child"
            title="/blog/categories/Middleware/Redis/" href="/blog/categories/Middleware/Redis/"
            id="blogcategoriesMiddlewareRedis"
            ><div class='name'>Redis</div><div class='badge'>(10)</div></a></li>
        
          <li><a class="flat-box child"
            title="/blog/categories/Middleware/Zookeeper/" href="/blog/categories/Middleware/Zookeeper/"
            id="blogcategoriesMiddlewareZookeeper"
            ><div class='name'>Zookeeper</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box"
            title="/blog/categories/MySQL/" href="/blog/categories/MySQL/"
            id="blogcategoriesMySQL"
            ><div class='name'>MySQL</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box"
            title="/blog/categories/Netty/" href="/blog/categories/Netty/"
            id="blogcategoriesNetty"
            ><div class='name'>Netty</div><div class='badge'>(5)</div></a></li>
        
          <li><a class="flat-box child"
            title="/blog/categories/Netty/Java/" href="/blog/categories/Netty/Java/"
            id="blogcategoriesNettyJava"
            ><div class='name'>Java</div><div class='badge'>(5)</div></a></li>
        
          <li><a class="flat-box"
            title="/blog/categories/SOFAStack/" href="/blog/categories/SOFAStack/"
            id="blogcategoriesSOFAStack"
            ><div class='name'>SOFAStack</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box child"
            title="/blog/categories/SOFAStack/Nacos/" href="/blog/categories/SOFAStack/Nacos/"
            id="blogcategoriesSOFAStackNacos"
            ><div class='name'>Nacos</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box"
            title="/blog/categories/Spring-Cloud/" href="/blog/categories/Spring-Cloud/"
            id="blogcategoriesSpring-Cloud"
            ><div class='name'>Spring Cloud</div><div class='badge'>(6)</div></a></li>
        
          <li><a class="flat-box child"
            title="/blog/categories/Spring-Cloud/Spring-Cloud-Gateway/" href="/blog/categories/Spring-Cloud/Spring-Cloud-Gateway/"
            id="blogcategoriesSpring-CloudSpring-Cloud-Gateway"
            ><div class='name'>Spring Cloud Gateway</div><div class='badge'>(6)</div></a></li>
        
          <li><a class="flat-box"
            title="/blog/categories/Spring/" href="/blog/categories/Spring/"
            id="blogcategoriesSpring"
            ><div class='name'>Spring</div><div class='badge'>(5)</div></a></li>
        
          <li><a class="flat-box child"
            title="/blog/categories/Spring/Prometheus/" href="/blog/categories/Spring/Prometheus/"
            id="blogcategoriesSpringPrometheus"
            ><div class='name'>Prometheus</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box child"
            title="/blog/categories/Spring/SpringBoot/" href="/blog/categories/Spring/SpringBoot/"
            id="blogcategoriesSpringSpringBoot"
            ><div class='name'>SpringBoot</div><div class='badge'>(2)</div></a></li>
        
          <li><a class="flat-box child"
            title="/blog/categories/Spring/SpringMVC/" href="/blog/categories/Spring/SpringMVC/"
            id="blogcategoriesSpringSpringMVC"
            ><div class='name'>SpringMVC</div><div class='badge'>(2)</div></a></li>
        
          <li><a class="flat-box"
            title="/blog/categories/SpringBoot/" href="/blog/categories/SpringBoot/"
            id="blogcategoriesSpringBoot"
            ><div class='name'>SpringBoot</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box child"
            title="/blog/categories/SpringBoot/Nacos/" href="/blog/categories/SpringBoot/Nacos/"
            id="blogcategoriesSpringBootNacos"
            ><div class='name'>Nacos</div><div class='badge'>(1)</div></a></li>
        
          <li><a class="flat-box"
            title="/blog/categories/hexo/" href="/blog/categories/hexo/"
            id="blogcategorieshexo"
            ><div class='name'>hexo</div><div class='badge'>(1)</div></a></li>
        
      </ul>
    </div>
  </section>


        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
      
        
      
        
      
        
      
        
          
  <section class='widget card-shadow  tagcloud'>
    <header>
  <div>
    
      <i class="fas fa-tags fa-fw" aria-hidden="true"></i><span class='name'>热门标签</span>
    

  </div>
  
    <a class="rightBtn"
    
      rel="external nofollow noopener noreferrer"
    
    
      target="_self"
    
    href="/tags/"
    title="tags/">
    <i class="fas fa-expand-arrows-alt fa-fw"></i></a>
  
</header>

    <div class='content'>
      <a href="/blog/tags/AQS/" style="font-size: 14px; color: #999">AQS</a> <a href="/blog/tags/Algorithm/" style="font-size: 14px; color: #999">Algorithm</a> <a href="/blog/tags/Annotation/" style="font-size: 14px; color: #999">Annotation</a> <a href="/blog/tags/Archunit/" style="font-size: 14px; color: #999">Archunit</a> <a href="/blog/tags/Cglib/" style="font-size: 14.83px; color: #939393">Cglib</a> <a href="/blog/tags/Concurrency/" style="font-size: 14.83px; color: #939393">Concurrency</a> <a href="/blog/tags/Design-Pattern/" style="font-size: 14px; color: #999">Design Pattern</a> <a href="/blog/tags/Distributed-Transaction/" style="font-size: 14.83px; color: #939393">Distributed Transaction</a> <a href="/blog/tags/Enum/" style="font-size: 14px; color: #999">Enum</a> <a href="/blog/tags/ExecutorService/" style="font-size: 14px; color: #999">ExecutorService</a> <a href="/blog/tags/Framework/" style="font-size: 17.33px; color: #828282">Framework</a> <a href="/blog/tags/Go/" style="font-size: 14px; color: #999">Go</a> <a href="/blog/tags/Golang/" style="font-size: 14px; color: #999">Golang</a> <a href="/blog/tags/Hystrix/" style="font-size: 14px; color: #999">Hystrix</a> <a href="/blog/tags/In-Action/" style="font-size: 16.5px; color: #888">In Action</a> <a href="/blog/tags/Instrument/" style="font-size: 14px; color: #999">Instrument</a> <a href="/blog/tags/Introspector/" style="font-size: 14px; color: #999">Introspector</a> <a href="/blog/tags/JSR-310/" style="font-size: 17.33px; color: #828282">JSR-310</a> <a href="/blog/tags/JVM/" style="font-size: 14px; color: #999">JVM</a> <a href="/blog/tags/Java/" style="font-size: 24px; color: #555">Java</a> <a href="/blog/tags/Lambda/" style="font-size: 14px; color: #999">Lambda</a> <a href="/blog/tags/Life/" style="font-size: 14px; color: #999">Life</a> <a href="/blog/tags/ListenableFuture/" style="font-size: 14px; color: #999">ListenableFuture</a> <a href="/blog/tags/Micrometer/" style="font-size: 14.83px; color: #939393">Micrometer</a> <a href="/blog/tags/Middleware/" style="font-size: 23.17px; color: #5b5b5b">Middleware</a> <a href="/blog/tags/MySQL/" style="font-size: 14px; color: #999">MySQL</a> <a href="/blog/tags/Mybatis/" style="font-size: 14px; color: #999">Mybatis</a> <a href="/blog/tags/Nacos/" style="font-size: 14.83px; color: #939393">Nacos</a> <a href="/blog/tags/Netty/" style="font-size: 18.17px; color: #7d7d7d">Netty</a> <a href="/blog/tags/Object/" style="font-size: 14px; color: #999">Object</a> <a href="/blog/tags/Optional/" style="font-size: 14px; color: #999">Optional</a> <a href="/blog/tags/Quartz/" style="font-size: 22.33px; color: #606060">Quartz</a> <a href="/blog/tags/RabbitMQ/" style="font-size: 20.67px; color: #6c6c6c">RabbitMQ</a> <a href="/blog/tags/Redis/" style="font-size: 21.5px; color: #666">Redis</a> <a href="/blog/tags/Reference/" style="font-size: 14px; color: #999">Reference</a> <a href="/blog/tags/Reflection/" style="font-size: 19.83px; color: #717171">Reflection</a> <a href="/blog/tags/SOFAStack/" style="font-size: 14px; color: #999">SOFAStack</a> <a href="/blog/tags/Security/" style="font-size: 14px; color: #999">Security</a> <a href="/blog/tags/Spring/" style="font-size: 17.33px; color: #828282">Spring</a> <a href="/blog/tags/Spring-Cloud/" style="font-size: 18.17px; color: #7d7d7d">Spring Cloud</a> <a href="/blog/tags/Spring-Cloud-Gateway/" style="font-size: 19px; color: #777">Spring Cloud Gateway</a> <a href="/blog/tags/SpringBoot/" style="font-size: 15.67px; color: #8e8e8e">SpringBoot</a> <a href="/blog/tags/SpringCloud/" style="font-size: 14px; color: #999">SpringCloud</a> <a href="/blog/tags/SpringMVC/" style="font-size: 14.83px; color: #939393">SpringMVC</a> <a href="/blog/tags/Thread/" style="font-size: 14.83px; color: #939393">Thread</a> <a href="/blog/tags/ThreadLocal/" style="font-size: 14px; color: #999">ThreadLocal</a> <a href="/blog/tags/ThreadPoolExecutor/" style="font-size: 14px; color: #999">ThreadPoolExecutor</a> <a href="/blog/tags/Zookeeper/" style="font-size: 14px; color: #999">Zookeeper</a> <a href="/blog/tags/Zuul/" style="font-size: 14px; color: #999">Zuul</a> <a href="/blog/tags/hexo/" style="font-size: 14px; color: #999">hexo</a> <a href="/blog/tags/hexo-theme/" style="font-size: 14px; color: #999">hexo theme</a>
    </div>
  </section>


        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
  
</aside>

<footer class="clearfix ">
  <br><br>
  
    <div class="social-wrapper">
      
        
          <a href="/atom.xml"
            class="social fas fa-rss fa-lg flat-btn"
            target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
        
          <a href="mailto:739805340@qq.com"
            class="social fas fa-envelope fa-lg flat-btn"
            target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
        
          <a href="https://github.com/zjcscut"
            class="social fab fa-github fa-lg flat-btn"
            target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
    </div>
  
  
  <br>
  <div><p>博客内容遵循 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener">署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0) 协议</a></p>
</div>
  <div>
    本站使用
    <a href="https://xaoxuu.com/wiki/volantis/" target="_blank" class="codename">Volantis</a>
    作为主题
    
      ，
      总访问量为
      <span id="busuanzi_value_site_pv"><i class="fas fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span>
      次
    
    。
  </div>
  
    <div class='copyright'>
    <p><a href="http://throwable.club">Copyright © 2017-2020 Throwable</a></p>

    </div>
  
</footer>
<script>setLoadingBarProgress(80);</script>




	<!-- 根据主题中的设置决定是否在archive中针对摘要部分的MathJax公式加载mathjax.js文件 -->
	

	


      <script>setLoadingBarProgress(60);</script>
    </div>
    <a class="s-top fas fa-arrow-up fa-fw" href='javascript:void(0)'></a>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>

  <script>
    
    var SEARCH_SERVICE = "hexo" || "hexo";
    var ROOT = "/" || "/";
    if (!ROOT.endsWith('/')) ROOT += '/';
  </script>

<script async src="//instant.page/3.0.0" type="module" defer integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script>


  <script src="https://cdn.jsdelivr.net/npm/scrollreveal@4.0.5/dist/scrollreveal.min.js"></script>
  <script type="text/javascript">
    $(function() {
      const $reveal = $('.reveal');
      if ($reveal.length === 0) return;
      const sr = ScrollReveal({ distance: 0 });
      sr.reveal('.reveal');
    });
  </script>


  <script src="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.js"></script>
  <script type="text/javascript">
    $(function() {
      Waves.attach('.flat-btn', ['waves-button']);
      Waves.attach('.float-btn', ['waves-button', 'waves-float']);
      Waves.attach('.float-btn-light', ['waves-button', 'waves-float', 'waves-light']);
      Waves.attach('.flat-box', ['waves-block']);
      Waves.attach('.float-box', ['waves-block', 'waves-float']);
      Waves.attach('.waves-image');
      Waves.init();
    });
  </script>


  <script async src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-busuanzi@2.3/js/busuanzi.pure.mini.js"></script>














  
<script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@20.2.30/js/app.js"></script>



  
<script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@20.2.30/js/search.js"></script>



  
    
<script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@20.2.30/js/commentTyping.js"></script>

  





<!-- 复制 -->
<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  let COPY_SUCCESS = "复制成功";
  let COPY_FAILURE = "复制失败";
  /*页面载入完成后，创建复制按钮*/
  !function (e, t, a) {
    /* code */
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '  <i class="fa fa-copy"></i><span>复制</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });

      clipboard.on('success', function(e) {
        //您可以加入成功提示
        console.info('Action:', e.action);
        console.info('Text:', e.text);
        console.info('Trigger:', e.trigger);
        success_prompt(COPY_SUCCESS);
        e.clearSelection();
      });
      clipboard.on('error', function(e) {
        //您可以加入失败提示
        console.error('Action:', e.action);
        console.error('Trigger:', e.trigger);
        fail_prompt(COPY_FAILURE);
      });
    }
    initCopyCode();

  }(window, document);

  /**
   * 弹出式提示框，默认1.5秒自动消失
   * @param message 提示信息
   * @param style 提示样式，有alert-success、alert-danger、alert-warning、alert-info
   * @param time 消失时间
   */
  var prompt = function (message, style, time)
  {
      style = (style === undefined) ? 'alert-success' : style;
      time = (time === undefined) ? 1500 : time*1000;
      $('<div>')
          .appendTo('body')
          .addClass('alert ' + style)
          .html(message)
          .show()
          .delay(time)
          .fadeOut();
  };

  // 成功提示
  var success_prompt = function(message, time)
  {
      prompt(message, 'alert-success', time);
  };

  // 失败提示
  var fail_prompt = function(message, time)
  {
      prompt(message, 'alert-danger', time);
  };

  // 提醒
  var warning_prompt = function(message, time)
  {
      prompt(message, 'alert-warning', time);
  };

  // 信息提示
  var info_prompt = function(message, time)
  {
      prompt(message, 'alert-info', time);
  };

</script>


<!-- fancybox -->
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script>
  let LAZY_LOAD_IMAGE = "";
  $(".article-entry").find("fancybox").find("img").each(function () {
      var element = document.createElement("a");
      $(element).attr("data-fancybox", "gallery");
      $(element).attr("href", $(this).attr("src"));
      /* 图片采用懒加载处理时,
       * 一般图片标签内会有个属性名来存放图片的真实地址，比如 data-original,
       * 那么此处将原本的属性名src替换为对应属性名data-original,
       * 修改如下
       */
       if (LAZY_LOAD_IMAGE) {
         $(element).attr("href", $(this).attr("data-original"));
       }
      $(this).wrap(element);
  });
</script>





<script src='https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/static/js/roll.js'></script>


  <script>setLoadingBarProgress(100);</script>
</body>
</html>
