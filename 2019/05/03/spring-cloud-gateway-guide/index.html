<!DOCTYPE html>
<html>
<head hexo-theme='Volantis' version='1.5.2' docs='https://xaoxuu.com/wiki/volantis/'>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  <title>Spring Cloud Gateway入坑记 | Throwable&#39;s Blog</title>
  
  <meta name="keywords" content="thorwable,doge,Thorwable">
  
  
  <meta name="description" content="一棵还在尝试努力生存的90后韭菜Doge">
  

  

  <meta name="HandheldFriendly" content="True" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <!-- meta -->
  

  <!-- link -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.css">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.10.1/css/all.min.css">
  
  
  <link rel='stylesheet' href='https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/static/css/gb.css'>
  

  
  <link rel="shortcut icon" type='image/x-icon' href="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/mine/doge_favicon.ico">
  

  

  
    
<link rel="stylesheet" href="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/static/css/throwable.css">

  

  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>

  
  
    <!-- ba -->
    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?4df6907aebab752244c3ca1432b4ff57";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
    </script>
  
</head>

<body>
  
  
  <div class="cover-wrapper">
    <cover class='cover post half'>
      
        
  <img class='logo' src='https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/mine/blog-logo.png'/>


  <div class="m_search">
    <form name="searchform" class="form u-search-form">
      <i class="icon fas fa-search fa-fw"></i>
      <input type="text" class="input u-search-input" placeholder="(゜-゜)つロ搜一搜有没有想看的" />
    </form>
  </div>

<div class='menu navigation'>
  <ul class='h-list'>
    
      
        <li>
          <a class="nav home "
            href="/"
            
            
            id="home">
            <i class='fas fa-home fa-fw'></i>&nbsp;主页
          </a>
        </li>
      
        <li>
          <a class="nav home "
            href="/projects/"
            
            
            id="projects">
            <i class='fas fa-code-branch fa-fw'></i>&nbsp;开源项目
          </a>
        </li>
      
        <li>
          <a class="nav home "
            href="/friends/"
            
              rel="nofollow"
            
            
            id="friends">
            <i class='fas fa-link fa-fw'></i>&nbsp;友链
          </a>
        </li>
      
        <li>
          <a class="nav home "
            href="/about/"
            
              rel="nofollow"
            
            
            id="about">
            <i class='fas fa-info-circle fa-fw'></i>&nbsp;关于
          </a>
        </li>
      
    
  </ul>
</div>
<div style="text-align: center;margin-top: 5px;" id="rollingColorfulFont"></div>
      
    </cover>
    <header class="l_header ">
  <div id="loading-bar-wrapper">
    <div id="loading-bar"></div>
  </div>

	<div class='wrapper'>
		<div class="nav-main container container--flex">
      <a class="logo flat-box" target="_self" href='/' >
        
          
          
            Throwable
          
        
      </a>
			<div class='menu navigation'>
				<ul class='h-list'>
          
  					
  						<li>
								<a class="nav flat-box" href="/"
                  
                  
                    target="_self"
                  
                  id="home">
									<i class='fas fa-hourglass-half fa-fw'></i>&nbsp;近期
								</a>
							</li>
      			
  						<li>
								<a class="nav flat-box" href="/categories/"
                  
                    rel="nofollow"
                  
                  
                    target="_self"
                  
                  id="categories">
									<i class='fas fa-folder-open fa-fw'></i>&nbsp;分类
								</a>
							</li>
      			
  						<li>
								<a class="nav flat-box" href="/tags/"
                  
                    rel="nofollow"
                  
                  
                    target="_self"
                  
                  id="tags">
									<i class='fas fa-hashtag fa-fw'></i>&nbsp;标签
								</a>
							</li>
      			
  						<li>
								<a class="nav flat-box" href="/friends/"
                  
                    rel="nofollow"
                  
                  
                  id="friends">
									<i class='fas fa-link fa-fw'></i>&nbsp;友接
								</a>
							</li>
      			
  						<li>
								<a class="nav flat-box" href="/blog/archives/"
                  
                    rel="nofollow"
                  
                  
                    target="_self"
                  
                  id="blogarchives">
									<i class='fas fa-archive fa-fw'></i>&nbsp;归档
								</a>
							</li>
      			
  						<li>
								<a class="nav flat-box" href="/about/"
                  
                    rel="nofollow"
                  
                  
                    target="_self"
                  
                  id="about">
									<i class='fas fa-info-circle fa-fw'></i>&nbsp;关于
								</a>
							</li>
      			
      		
				</ul>
			</div>

      <div class="m_search">
        <form name="searchform" class="form u-search-form">
          <i class="icon fas fa-search fa-fw"></i>
          <input type="text" class="input u-search-input" placeholder="(゜-゜)つロ搜一搜有没有想看的" />
        </form>
      </div>

			<ul class='switcher h-list'>
				
					<li class='s-search'><a class="fas fa-search fa-fw" target="_self" href='javascript:void(0)'></a></li>
				
				<li class='s-menu'><a class="fas fa-bars fa-fw" target="_self" href='javascript:void(0)'></a></li>
			</ul>
		</div>

		<div class='nav-sub container container--flex'>
			<a class="logo flat-box"></a>
			<ul class='switcher h-list'>
				<li class='s-comment'><a class="flat-btn fas fa-comments fa-fw" target="_self" href='javascript:void(0)'></a></li>
        
          <li class='s-toc'><a class="flat-btn fas fa-list fa-fw" target="_self" href='javascript:void(0)'></a></li>
        
			</ul>
		</div>
	</div>
</header>
	<aside class="menu-phone white-box">
    <header>
		<nav class="menu navigation">
      <ul>
        
          
            <li>
							<a class="nav flat-box" href="/"
                
                
                id="home">
								<i class='fas fa-clock fa-fw'></i>&nbsp;近期文章
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/blog/archives/"
                
                  rel="nofollow"
                
                
                id="blogarchives">
								<i class='fas fa-archive fa-fw'></i>&nbsp;文章归档
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/projects/"
                
                
                id="projects">
								<i class='fas fa-code-branch fa-fw'></i>&nbsp;开源项目
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/friends/"
                
                  rel="nofollow"
                
                
                id="friends">
								<i class='fas fa-link fa-fw'></i>&nbsp;我的友链
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/about/"
                
                  rel="nofollow"
                
                
                id="about">
								<i class='fas fa-info-circle fa-fw'></i>&nbsp;关于小站
							</a>
            </li>
          
       
      </ul>
		</nav>
    </header>
	</aside>
<script>setLoadingBarProgress(40);</script>

  </div>


  <div class="l_body">
    <div class='body-wrapper'>
      <div class='l_main'>
  

  
    <article id="post" class="post white-box card-shadow  article-type-post" itemscope itemprop="blogPost">
      


  <section class='meta'>
    
    
    <div class="meta" id="header-meta">
      
        
  
    <h1 class="title">
      <a href="/2019/05/03/spring-cloud-gateway-guide/">
        Spring Cloud Gateway入坑记
      </a>
    </h1>
  


      
      <div class='new-meta-box'>
        
          
        
          
            
  <div class='new-meta-item author'>
    
      <a href="http://throwable.club" rel="nofollow">
        
          <img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/mine/doge_avatar.jpg">
        
        <p>Throwable</p>
      </a>
    
  </div>


          
        
          
            
  
  <div class='new-meta-item category'>
    <a href='/blog/categories/Spring-Cloud/Spring-Cloud-Gateway/' rel="nofollow">
      <i class="fas fa-folder-open" aria-hidden="true"></i>
      <p>Spring Cloud&nbsp;/&nbsp;Spring Cloud Gateway</p>
    </a>
  </div>


          
        
          
            <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-edit" aria-hidden="true"></i>
    <p>发布于：2019年5月3日</p>
  </a>
</div>

          
        
          
            <div class="new-meta-item date" itemprop="dateUpdated" datetime="2019-06-11T23:21:05+08:00">
  <a class='notlink'>
    <i class="fas fa-save" aria-hidden="true"></i>
    <p>更新于：2019年6月11日</p>
  </a>
</div>

          
        
          
            
  
    <div class="new-meta-item browse busuanzi">
      <a class='notlink'>
        <i class="fas fa-eye" aria-hidden="true"></i>
        <p>
          <span id="busuanzi_value_page_pv">
            <i class="fas fa-spinner fa-spin fa-fw" aria-hidden="true"></i>
          </span>
        </p>
      </a>
    </div>
  


          
        
          
            
  <div class="new-meta-item wordcount">
    <a class='notlink'>
      <i class="fas fa-keyboard" aria-hidden="true"></i>
      <p>字数：4.6k字</p>
    </a>
  </div>
  <div class="new-meta-item readtime">
    <a class='notlink'>
      <i class="fas fa-hourglass-half" aria-hidden="true"></i>
      <p>时长：19分钟</p>
    </a>
  </div>


          
        
          
            

          
        
      </div>
      
        <hr>
      
    </div>
  </section>


      <section class="article typo">
        <div class="article-entry" itemprop="articleBody">
          
          <p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/mine/spring-cloud-logo.png" alt=""></p>
<h2 id="前提">前提</h2>
<p>最近在做老系统的重构，重构完成后新系统中需要引入一个网关服务，作为新系统和老系统接口的适配和代理。之前，很多网关应用使用的是<code>Spring-Cloud-Netfilx</code>基于<code>Zuul1.x</code>版本实现的那套方案，但是鉴于<code>Zuul1.x</code>已经停止迭代，它使用的是比较传统的阻塞(B)IO + 多线程的实现方案，其实性能不太好。后来Spring团队干脆自己重新研发了一套网关组件，这个就是本次要调研的<code>Spring-Cloud-Gateway</code>。</p>
<h2 id="简介">简介</h2>
<p><font color=green size=5>Spring Cloud Gateway</font>依赖于<a href="https://spring.io/projects/spring-boot#learn" target="_blank" rel="noopener">Spring Boot 2.0</a>, <a href="https://docs.spring.io/spring/docs/current/spring-framework-reference/web-reactive.html" target="_blank" rel="noopener">Spring WebFlux</a>,和<a href="https://projectreactor.io/docs" target="_blank" rel="noopener">Project Reactor</a>。许多熟悉的同步类库(例如<code>Spring-Data</code>和<code>Spring-Security</code>)和同步编程模式在<code>Spring Cloud Gateway</code>中并不适用，所以最好先阅读一下上面提到的三个框架的文档。</p>
<p><code>Spring Cloud Gateway</code>依赖于<code>Spring Boot</code>和<code>Spring WebFlux</code>提供的基于<code>Netty</code>的运行时环境，它并非构建为一个WAR包或者运行在传统的<code>Servlet</code>容器中。</p>
<a id="more"></a>
<h3 id="专有名词">专有名词</h3>
<ul>
<li>路由(Route)：路由是网关的基本组件。它由ID，目标URI，谓词(Predicate)集合和过滤器集合定义。如果谓词聚合判断为真，则匹配路由。</li>
<li>谓词(Predicate)：使用的是Java8中基于函数式编程引入的<a href="https://docs.oracle.com/javase/8/docs/api/java/util/function/Predicate.html" target="_blank" rel="noopener">java.util.Predicate</a>。使用谓词(聚合)判断的时候，输入的参数是<code>ServerWebExchange</code>类型，它允许开发者匹配来自HTTP请求的任意参数，例如HTTP请求头、HTTP请求参数等等。</li>
<li>过滤器(Filter)：使用的是指定的<code>GatewayFilter</code>工厂所创建出来的<code>GatewayFilter</code>实例，可以在发送请求到下游之前或者之后修改请求(参数)或者响应(参数)。</li>
</ul>
<p>其实<code>Filter</code>还包括了<code>GlobalFilter</code>，不过在官方文档中没有提到。</p>
<h3 id="工作原理">工作原理</h3>
<p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201905/s-c-g-e-1.png" alt="s-c-g-e-1.png"></p>
<p>客户端向<code>Spring Cloud Gateway</code>发出请求，如果<code>Gateway Handler Mapping</code>模块处理当前请求如果匹配到一个目标路由配置，该请求就会转发到<code>Gateway Web Handler</code>模块。<code>Gateway Web Handler</code>模块在发送请求的时候，会把该请求通过一个匹配于该请求的过滤器链。上图中过滤器被虚线分隔的原因是：过滤器的处理逻辑可以在代理请求发送之前或者之后执行。所有<code>pre</code>类型的过滤器执行之后，代理请求才会创建(和发送)，当代理请求创建(和发送)完成之后，所有的<code>post</code>类型的过滤器才会执行。</p>
<p>见上图，外部请求进来后如果落入过滤器链，那么虚线左边的就是<code>pre</code>类型的过滤器，请求先经过<code>pre</code>类型的过滤器，再发送到目标被代理的服务。目标被代理的服务响应请求，响应会再次经过滤器链，也就是走虚线右侧的过滤器链，这些过滤器就是<code>post</code>类型的过滤器。</p>
<p>注意，如果在路由配置中没有明确指定对应的路由端口，那么会使用如下的默认端口：</p>
<ul>
<li>HTTP协议，使用80端口。</li>
<li>HTTPS协议，使用443端口。</li>
</ul>
<h2 id="引入依赖">引入依赖</h2>
<p>建议直接通过Train版本(其实笔者考究过，Train版本的代号其实是伦敦地铁站的命名，像当前的<code>Spring Cloud</code>最新版本是<code>Greenwich.SR1</code>，<code>Greenwich</code>可以在伦敦地铁站的地图查到这个站点，对应的<code>SpringBoot</code>版本是2.1.x)引入<code>Spring-Cloud-Gateway</code>，因为这样可以跟上最新稳定版本的<code>Spring-Cloud</code>版本，另外由于<code>Spring-Cloud-Gateway</code>基于<code>Netty</code>的运行时环境启动，不需要引入带<code>Servlet</code>容器的<code>spring-boot-starter-web</code>。</p>
<p>父POM引入下面的配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>Greenwich.SR1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.4.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>子模块或者需要引入<code>Spring-Cloud-Gateway</code>的模块POM引入下面的配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>创建一个启动类即可：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RouteServerApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">		SpringApplication.run(RouteServerApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="网关配置">网关配置</h2>
<p>网关配置最终需要转化为一个<code>RouteDefinition</code>的集合，配置的定义接口如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RouteDefinitionLocator</span> </span>&#123;</span><br><span class="line">	<span class="function">Flux&lt;RouteDefinition&gt; <span class="title">getRouteDefinitions</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过YAML文件配置或者流式编程式配置（其实文档中还有配合Eureka的<code>DiscoveryClient</code>进行配置，这里暂时不研究），最终都是为了创建一个<code>RouteDefinition</code>的集合。</p>
<h3 id="Yaml配置">Yaml配置</h3>
<p>配置实现是<code>PropertiesRouteDefinitionLocator</code>，关联着配置类<code>GatewayProperties</code>：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">       <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">datetime_after_route</span>    <span class="comment"># &lt;------ 这里是路由配置的ID</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">http://www.throwable.club</span>  <span class="comment"># &lt;------ 这里是路由最终目标Server的URI(Host)</span></span><br><span class="line">        <span class="attr">predicates:</span>                     <span class="comment"># &lt;------ 谓词集合配置，多个是用and逻辑连接</span></span><br><span class="line">         <span class="bullet">-</span> <span class="string">Path=/blog</span>    <span class="comment"># &lt;------- Key(name)=Expression，键是谓词规则工厂的ID，值一般是匹配规则的正则表示</span></span><br></pre></td></tr></table></figure>
<h3 id="编程式流式配置">编程式流式配置</h3>
<p>编程式和流式编程配置需要依赖<code>RouteLocatorBuilder</code>，目标是构造一个<code>RouteLocator</code>实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RouteLocator <span class="title">customRouteLocator</span><span class="params">(RouteLocatorBuilder builder)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> builder.routes()</span><br><span class="line">            .route(r -&gt; r.path(<span class="string">"/blog"</span>)</span><br><span class="line">                .uri(<span class="string">"http://www.throwable.club"</span>)</span><br><span class="line">            )</span><br><span class="line">            .build();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="路由谓词工厂">路由谓词工厂</h2>
<p><code>Spring Cloud Gateway</code>将路由(Route)作为<code>Spring-WebFlux</code>的<code>HandlerMapping</code>组件基础设施的一部分，也就是<code>HandlerMapping</code>进行匹配的时候，会把配置好的路由规则也纳入匹配机制之中。<code>Spring Cloud Gateway</code>自身包含了很多内建的路由谓词工厂。这些谓词分别匹配一个HTTP请求的不同属性。多个路由谓词工厂可以用<code>and</code>的逻辑组合在一起。</p>
<p>目前<code>Spring Cloud Gateway</code>提供的内置的路由谓词工厂如下：</p>
<p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201905/s-c-g-e-2.png" alt="s-c-g-e-2.png"></p>
<h3 id="指定日期时间规则路由谓词">指定日期时间规则路由谓词</h3>
<p>按照配置的日期时间指定的路由谓词有三种可选规则：</p>
<ul>
<li>匹配请求在指定日期时间之前。</li>
<li>匹配请求在指定日期时间之后。</li>
<li>匹配请求在指定日期时间之间。</li>
</ul>
<p>值得注意的是，配置的日期时间必须满足<code>ZonedDateTime</code>的格式：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//年月日和时分秒用'T'分隔,接着-07:00是和UTC相差的时间，最后的[America/Denver]是所在的时间地区</span></span><br><span class="line"><span class="number">2017</span>-<span class="number">01</span>-<span class="number">20</span>T17:<span class="number">42</span>:<span class="number">47.789</span>-<span class="number">07</span>:<span class="number">00</span>[America/Denver]</span><br></pre></td></tr></table></figure>
<p>例如网关的应用是<code>2019-05-01T00:00:00+08:00[Asia/Shanghai]</code>上线的，上线之后的请求都路由奥<code>www.throwable.club</code>，那么配置如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">server</span> </span><br><span class="line">  <span class="attr">port:</span> <span class="number">9090</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">       <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">datetime_after_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">http://www.throwable.club</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">         <span class="bullet">-</span> <span class="string">After=2019-05-01T00:00:00+08:00[Asia/Shanghai]</span></span><br></pre></td></tr></table></figure>
<p>此时，只要请求网关<code>http://localhost:9090</code>，请求就会转发到<code>http://www.throwable.club</code>。</p>
<p>如果想要只允许<code>2019-05-01T00:00:00+08:00[Asia/Shanghai]</code>之前的请求，那么只需要改为：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">server</span> </span><br><span class="line">  <span class="attr">port:</span> <span class="number">9091</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">       <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">datetime_before_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">http://www.throwable.club</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">         <span class="bullet">-</span> <span class="string">Before=2019-05-01T00:00:00+08:00[Asia/Shanghai]</span></span><br></pre></td></tr></table></figure>
<p>如果只允许两个日期时间段之间的时间进行请求，那么只需要改为：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">server</span> </span><br><span class="line">  <span class="attr">port:</span> <span class="number">9090</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">       <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">datetime_between_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">http://www.throwable.club</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">         <span class="bullet">-</span> <span class="string">Between=2019-05-01T00:00:00+08:00[Asia/Shanghai],2019-05-02T00:00:00+08:00[Asia/Shanghai]</span></span><br></pre></td></tr></table></figure>
<p>那么只有2019年5月1日0时到5月2日0时的请求才能正常路由。</p>
<h3 id="Cookie路由谓词">Cookie路由谓词</h3>
<p><code>CookieRoutePredicateFactory</code>需要提供两个参数，分别是Cookie的name和一个正则表达式(value)。只有在请求中的Cookie对应的name和value和Cookie路由谓词中配置的值匹配的时候，才能匹配命中进行路由。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">server</span> </span><br><span class="line">  <span class="attr">port:</span> <span class="number">9090</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">       <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">cookie_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">http://www.throwable.club</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">         <span class="bullet">-</span> <span class="string">Cookie=doge,throwable</span></span><br></pre></td></tr></table></figure>
<p>请求需要携带一个Cookie，name为doge，value需要匹配正则表达式&quot;throwable&quot;才能路由到<code>http://www.throwable.club</code>。</p>
<p>这里尝试本地搭建一个订单<code>Order</code>服务，基于SpringBoot2.1.4搭建，启动在9091端口：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 入口类</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(path = <span class="string">"/order"</span>)</span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderServiceApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(OrderServiceApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(value = <span class="string">"/cookie"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;String&gt; <span class="title">cookie</span><span class="params">(@CookieValue(name = <span class="string">"doge"</span>)</span> String doge) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(doge);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>订单服务application.yaml配置：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">order-service</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9091</span></span><br><span class="line"><span class="string">```</span>  </span><br><span class="line"></span><br><span class="line"><span class="string">网关路由配置：</span></span><br><span class="line"></span><br><span class="line"><span class="string">```yaml</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">route-server</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">cookie_route</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://localhost:9091</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Cookie=doge,throwable</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:9090/order/cookie --cookie <span class="string">"doge=throwable"</span></span><br><span class="line"></span><br><span class="line">//响应结果</span><br><span class="line">throwable</span><br></pre></td></tr></table></figure>
<h3 id="Header路由谓词">Header路由谓词</h3>
<p><code>HeaderRoutePredicateFactory</code>需要提供两个参数，分别是Header的name和一个正则表达式(value)。只有在请求中的Header对应的name和value和Header路由谓词中配置的值匹配的时候，才能匹配命中进行路由。</p>
<p>订单服务中新增一个<code>/header</code>端点：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(path = <span class="string">"/order"</span>)</span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderServiceApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(OrderServiceApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(value = <span class="string">"/header"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;String&gt; <span class="title">header</span><span class="params">(@RequestHeader(name = <span class="string">"accessToken"</span>)</span> String accessToken) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(accessToken);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>网关的路由配置如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">header_route</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://localhost:9091</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Header=accessToken,Doge</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -H <span class="string">"accessToken:Doge"</span> http://localhost:9090/order/header</span><br><span class="line"></span><br><span class="line">//响应结果</span><br><span class="line">Doge</span><br></pre></td></tr></table></figure>
<h3 id="Host路由谓词">Host路由谓词</h3>
<p><code>HostRoutePredicateFactory</code>只需要指定一个主机名列表，列表中的每个元素支持Ant命名样式，使用<code>.</code>作为分隔符，多个元素之间使用<code>,</code>区分。Host路由谓词实际上针对的是HTTP请求头中的<code>Host</code>属性。</p>
<p>订单服务中新增一个<code>/header</code>端点：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(path = <span class="string">"/order"</span>)</span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderServiceApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(OrderServiceApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(value = <span class="string">"/host"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;String&gt; <span class="title">host</span><span class="params">(@RequestHeader(name = <span class="string">"Host"</span>)</span> String host) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> ResponseEntity.ok(host);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>网关的路由配置如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">host_route</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://localhost:9091</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Host=localhost:9090</span></span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:9090/order/host</span><br><span class="line"></span><br><span class="line">//响应结果</span><br><span class="line">localhost:9091  <span class="comment"># &lt;--------- 这里要注意一下，路由到订单服务的时候，Host会被修改为localhost:9091</span></span><br></pre></td></tr></table></figure>
<p>其实可以定制更多样化的Host匹配模式，甚至可以支持URI模板变量。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="string">Host=www.throwable.**,**.throwable.**</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="string">Host=&#123;sub&#125;.throwable.club</span></span><br></pre></td></tr></table></figure>
<h3 id="请求方法路由谓词">请求方法路由谓词</h3>
<p><code>MethodRoutePredicateFactory</code>只需要一个参数：要匹配的HTTP请求方法。</p>
<p>网关的路由配置如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">method_route</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://localhost:9091</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Method=GET</span></span><br></pre></td></tr></table></figure>
<p>这样配置，所有的进入到网关的GET方法的请求都会路由到<code>http://localhost:9091</code>。</p>
<p>订单服务中新增一个<code>/get</code>端点：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(value = <span class="string">"/get"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ResponseEntity&lt;String&gt; <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ResponseEntity.ok(<span class="string">"get"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:9090/order/get</span><br><span class="line"></span><br><span class="line">//响应结果</span><br><span class="line">get</span><br></pre></td></tr></table></figure>
<h3 id="请求路径路由谓词">请求路径路由谓词</h3>
<p><code>PathRoutePredicateFactory</code>需要<code>PathMatcher</code>模式路径列表和一个可选的标志位参数<code>matchOptionalTrailingSeparator</code>。这个是最常用的一个路由谓词。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">path_route</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://localhost:9091</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/order/path</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(value = <span class="string">"/path"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ResponseEntity&lt;String&gt; <span class="title">path</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ResponseEntity.ok(<span class="string">"path"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:9090/order/path</span><br><span class="line"></span><br><span class="line">//响应结果</span><br><span class="line">path</span><br></pre></td></tr></table></figure>
<p>此外，可以通过<code>{segment}</code>占位符配置路径如<code>/foo/1</code>或<code>/foo/bar</code>或<code>/bar/baz</code>，如果通过这种形式配置，在匹配命中进行路由的时候，会提取路径中对应的内容并且将键值对放在<code>ServerWebExchange.getAttributes()</code>集合中，KEY为<code>ServerWebExchangeUtils.URI_TEMPLATE_VARIABLES_ATTRIBUTE</code>，这些提取出来的属性可以供<code>GatewayFilter Factories</code>使用。</p>
<h3 id="请求查询参数路由谓词">请求查询参数路由谓词</h3>
<p><code>QueryRoutePredicateFactory</code>需要一个必须的请求查询参数(param的name)以及一个可选的正则表达式(regexp)。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">query_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">http://localhost:9091</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Query=doge,throwabl.</span></span><br></pre></td></tr></table></figure>
<p>这里配置的param就是<code>doge</code>，正则表达式是<code>throwabl.</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(value = <span class="string">"/query"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ResponseEntity&lt;String&gt; <span class="title">query</span><span class="params">(@RequestParam(<span class="string">"name"</span>)</span> String doge) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> ResponseEntity.ok(doge);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:9090/order/query?doge=throwable</span><br><span class="line"></span><br><span class="line">//响应结果</span><br><span class="line">throwable</span><br></pre></td></tr></table></figure>
<h3 id="远程IP地址路由谓词">远程IP地址路由谓词</h3>
<p><code>RemoteAddrRoutePredicateFactory</code>匹配规则采用CIDR符号（IPv4或IPv6）字符串的列表（最小值为1），例如192.168.0.1/16（其中192.168.0.1是远程IP地址并且16是子网掩码）。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">remoteaddr_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">http://localhost:9091</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">RemoteAddr=127.0.0.1</span></span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(value = <span class="string">"/remote"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ResponseEntity&lt;String&gt; <span class="title">remote</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> ResponseEntity.ok(<span class="string">"remote"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl http://localhost:9090/order/remote</span><br><span class="line"></span><br><span class="line">//响应结果</span><br><span class="line">remote</span><br></pre></td></tr></table></figure>
<p>关于远程IP路由这一个路由谓词其实还有很多扩展手段，这里暂时不展开。</p>
<h3 id="多个路由谓词组合">多个路由谓词组合</h3>
<p>因为路由配置中的<code>predicates</code>属性其实是一个列表，可以直接添加多个路由规则：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">remoteaddr_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">http://localhost:9091</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">RemoteAddr=xxxx</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Path=/yyyy</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Query=zzzz,aaaa</span></span><br></pre></td></tr></table></figure>
<p>这些规则是用<code>and</code>逻辑组合的，例如上面的例子相当于：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">request = ...</span><br><span class="line"><span class="keyword">if</span>(request.getRemoteAddr == <span class="string">'xxxx'</span> &amp;&amp; request.getPath match <span class="string">'/yyyy'</span> &amp;&amp; request.getQuery(<span class="string">'zzzz'</span>) match <span class="string">'aaaa'</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">false</span>;</span><br></pre></td></tr></table></figure>
<h2 id="GatewayFilter工厂">GatewayFilter工厂</h2>
<p>路由过滤器<code>GatewayFilter</code>允许修改进来的HTTP请求内容或者返回的HTTP响应内容。路由过滤器的作用域是一个具体的路由配置。<code>Spring Cloud Gateway</code>提供了丰富的内建的<code>GatewayFilter</code>工厂，可以按需选用。</p>
<p>因为<code>GatewayFilter</code>工厂类实在太多，笔者这里举个简单的例子。</p>
<p>如果我们想对某些请求附加特殊的HTTP请求头，可以选用<code>AddRequestHeaderX-Request-Foo:Bar</code>，<code>application.yml</code>如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">add_request_header_route</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">https://example.org</span></span><br><span class="line">        <span class="attr">filters:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">AddRequestHeader=X-Request-Foo,Bar</span></span><br></pre></td></tr></table></figure>
<p>那么所有的从网关入口的HTTP请求都会添加一个特殊的HTTP请求头：<code>X-Request-Foo:Bar</code>。</p>
<p>目前<code>GatewayFilter</code>工厂的内建实现如下：</p>
<table>
<thead>
<tr>
<th style="text-align:center">ID</th>
<th style="text-align:center">类名</th>
<th style="text-align:center">类型</th>
<th style="text-align:center">功能</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">StripPrefix</td>
<td style="text-align:center">StripPrefixGatewayFilterFactory</td>
<td style="text-align:center">pre</td>
<td style="text-align:center">移除请求URL路径的第一部分，例如原始请求路径是/order/query，处理后是/query</td>
</tr>
<tr>
<td style="text-align:center">SetStatus</td>
<td style="text-align:center">SetStatusGatewayFilterFactory</td>
<td style="text-align:center">post</td>
<td style="text-align:center">设置请求响应的状态码，会从org.springframework.http.HttpStatus中解析</td>
</tr>
<tr>
<td style="text-align:center">SetResponseHeader</td>
<td style="text-align:center">SetResponseHeaderGatewayFilterFactory</td>
<td style="text-align:center">post</td>
<td style="text-align:center">设置(添加)请求响应的响应头</td>
</tr>
<tr>
<td style="text-align:center">SetRequestHeader</td>
<td style="text-align:center">SetRequestHeaderGatewayFilterFactory</td>
<td style="text-align:center">pre</td>
<td style="text-align:center">设置(添加)请求头</td>
</tr>
<tr>
<td style="text-align:center">SetPath</td>
<td style="text-align:center">SetPathGatewayFilterFactory</td>
<td style="text-align:center">pre</td>
<td style="text-align:center">设置(覆盖)请求路径</td>
</tr>
<tr>
<td style="text-align:center">SecureHeader</td>
<td style="text-align:center">SecureHeadersGatewayFilterFactory</td>
<td style="text-align:center">pre</td>
<td style="text-align:center">设置安全相关的请求头，见SecureHeadersProperties</td>
</tr>
<tr>
<td style="text-align:center">SaveSession</td>
<td style="text-align:center">SaveSessionGatewayFilterFactory</td>
<td style="text-align:center">pre</td>
<td style="text-align:center">保存WebSession</td>
</tr>
<tr>
<td style="text-align:center">RewriteResponseHeader</td>
<td style="text-align:center">RewriteResponseHeaderGatewayFilterFactory</td>
<td style="text-align:center">post</td>
<td style="text-align:center">重新响应头</td>
</tr>
<tr>
<td style="text-align:center">RewritePath</td>
<td style="text-align:center">RewritePathGatewayFilterFactory</td>
<td style="text-align:center">pre</td>
<td style="text-align:center">重写请求路径</td>
</tr>
<tr>
<td style="text-align:center">Retry</td>
<td style="text-align:center">RetryGatewayFilterFactory</td>
<td style="text-align:center">pre</td>
<td style="text-align:center">基于条件对请求进行重试</td>
</tr>
<tr>
<td style="text-align:center">RequestSize</td>
<td style="text-align:center">RequestSizeGatewayFilterFactory</td>
<td style="text-align:center">pre</td>
<td style="text-align:center">限制请求的大小，单位是byte，超过设定值返回<code>413 Payload Too Large</code></td>
</tr>
<tr>
<td style="text-align:center">RequestRateLimiter</td>
<td style="text-align:center">RequestRateLimiterGatewayFilterFactory</td>
<td style="text-align:center">pre</td>
<td style="text-align:center">限流</td>
</tr>
<tr>
<td style="text-align:center">RequestHeaderToRequestUri</td>
<td style="text-align:center">RequestHeaderToRequestUriGatewayFilterFactory</td>
<td style="text-align:center">pre</td>
<td style="text-align:center">通过请求头的值改变请求URL</td>
</tr>
<tr>
<td style="text-align:center">RemoveResponseHeader</td>
<td style="text-align:center">RemoveResponseHeaderGatewayFilterFactory</td>
<td style="text-align:center">post</td>
<td style="text-align:center">移除配置的响应头</td>
</tr>
<tr>
<td style="text-align:center">RemoveRequestHeader</td>
<td style="text-align:center">RemoveRequestHeaderGatewayFilterFactory</td>
<td style="text-align:center">pre</td>
<td style="text-align:center">移除配置的请求头</td>
</tr>
<tr>
<td style="text-align:center">RedirectTo</td>
<td style="text-align:center">RedirectToGatewayFilterFactory</td>
<td style="text-align:center">pre</td>
<td style="text-align:center">重定向，需要指定HTTP状态码和重定向URL</td>
</tr>
<tr>
<td style="text-align:center">PreserveHostHeader</td>
<td style="text-align:center">PreserveHostHeaderGatewayFilterFactory</td>
<td style="text-align:center">pre</td>
<td style="text-align:center">设置请求携带的属性preserveHostHeader为true</td>
</tr>
<tr>
<td style="text-align:center">PrefixPath</td>
<td style="text-align:center">PrefixPathGatewayFilterFactory</td>
<td style="text-align:center">pre</td>
<td style="text-align:center">请求路径添加前置路径</td>
</tr>
<tr>
<td style="text-align:center">Hystrix</td>
<td style="text-align:center">HystrixGatewayFilterFactory</td>
<td style="text-align:center">pre</td>
<td style="text-align:center">整合Hystrix</td>
</tr>
<tr>
<td style="text-align:center">FallbackHeaders</td>
<td style="text-align:center">FallbackHeadersGatewayFilterFactory</td>
<td style="text-align:center">pre</td>
<td style="text-align:center">Hystrix执行如果命中降级逻辑允许通过请求头携带异常明细信息</td>
</tr>
<tr>
<td style="text-align:center">AddResponseHeader</td>
<td style="text-align:center">AddResponseHeaderGatewayFilterFactory</td>
<td style="text-align:center">post</td>
<td style="text-align:center">添加响应头</td>
</tr>
<tr>
<td style="text-align:center">AddRequestParameter</td>
<td style="text-align:center">AddRequestParameterGatewayFilterFactory</td>
<td style="text-align:center">pre</td>
<td style="text-align:center">添加请求参数，仅仅限于URL的Query参数</td>
</tr>
<tr>
<td style="text-align:center">AddRequestHeader</td>
<td style="text-align:center">AddRequestHeaderGatewayFilterFactory</td>
<td style="text-align:center">pre</td>
<td style="text-align:center">添加请求头</td>
</tr>
</tbody>
</table>
<p><code>GatewayFilter</code>工厂使用的时候需要知道其ID以及配置方式，配置方式可以看对应工厂类的公有静态内部类<code>XXXXConfig</code>。</p>
<h2 id="GlobalFilter工厂">GlobalFilter工厂</h2>
<p><code>GlobalFilter</code>的功能其实和<code>GatewayFilter</code>是相同的，只是<code>GlobalFilter</code>的作用域是所有的路由配置，而不是绑定在指定的路由配置上。多个<code>GlobalFilter</code>可以通过<code>@Order</code>或者<code>getOrder()</code>方法指定每个<code>GlobalFilter</code>的执行顺序，order值越小，<code>GlobalFilter</code>执行的优先级越高。</p>
<p>注意，由于过滤器有pre和post两种类型，pre类型过滤器如果order值越小，那么它就应该在pre过滤器链的顶层，post类型过滤器如果order值越小，那么它就应该在pre过滤器链的底层。示意图如下：</p>
<p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201905/s-c-g-e-3.png" alt="s-c-g-e-3.png"></p>
<p>例如要实现负载均衡的功能，<code>application.yml</code>配置如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">myRoute</span></span><br><span class="line">        <span class="attr">uri:</span> <span class="string">lb://myservice</span>   <span class="comment"># &lt;-------- lb特殊标记会使用LoadBalancerClient搜索目标服务进行负载均衡</span></span><br><span class="line">        <span class="attr">predicates:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">Path=/service/**</span></span><br></pre></td></tr></table></figure>
<p>目前<code>Spring Cloud Gateway</code>提供的内建的<code>GlobalFilter</code>如下：</p>
<table>
<thead>
<tr>
<th style="text-align:center">类名</th>
<th style="text-align:center">功能</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">ForwardRoutingFilter</td>
<td style="text-align:center">重定向</td>
</tr>
<tr>
<td style="text-align:center">LoadBalancerClientFilter</td>
<td style="text-align:center">负载均衡</td>
</tr>
<tr>
<td style="text-align:center">NettyRoutingFilter</td>
<td style="text-align:center">Netty的HTTP客户端的路由</td>
</tr>
<tr>
<td style="text-align:center">NettyWriteResponseFilter</td>
<td style="text-align:center">Netty响应进行写操作</td>
</tr>
<tr>
<td style="text-align:center">RouteToRequestUrlFilter</td>
<td style="text-align:center">基于路由配置更新URL</td>
</tr>
<tr>
<td style="text-align:center">WebsocketRoutingFilter</td>
<td style="text-align:center">Websocket请求转发到下游</td>
</tr>
</tbody>
</table>
<p>内建的<code>GlobalFilter</code>大多数和<code>ServerWebExchangeUtils</code>的属性相关，这里就不深入展开。</p>
<h2 id="跨域配置">跨域配置</h2>
<p>网关可以通过配置来控制全局的CORS行为。全局的CORS配置对应的类是<code>CorsConfiguration</code>，这个配置是一个URL模式的映射。例如<code>application.yaml</code>文件如下：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">globalcors:</span></span><br><span class="line">        <span class="attr">corsConfigurations:</span></span><br><span class="line">          <span class="string">'[/**]'</span><span class="string">:</span></span><br><span class="line">            <span class="attr">allowedOrigins:</span> <span class="string">"https://docs.spring.io"</span></span><br><span class="line">            <span class="attr">allowedMethods:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">GET</span></span><br></pre></td></tr></table></figure>
<p>在上面的示例中，对于所有请求的路径，将允许来自<code>docs.spring.io</code>并且是GET方法的CORS请求。</p>
<h2 id="Actuator端点相关">Actuator端点相关</h2>
<p>引入<code>spring-boot-starter-actuator</code>，需要做以下配置开启<code>gateway</code>监控端点：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">management.endpoint.gateway.enabled</span>=<span class="string">true </span></span><br><span class="line"><span class="meta">management.endpoints.web.exposure.include</span>=<span class="string">gateway</span></span><br></pre></td></tr></table></figure>
<p>目前支持的端点列表：</p>
<table>
<thead>
<tr>
<th style="text-align:center">ID</th>
<th style="text-align:center">请求路径</th>
<th style="text-align:center">HTTP方法</th>
<th style="text-align:left">描述</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">globalfilters</td>
<td style="text-align:center">/actuator/gateway/globalfilters</td>
<td style="text-align:center">GET</td>
<td style="text-align:left">展示路由配置中的GlobalFilter列表</td>
</tr>
<tr>
<td style="text-align:center">routefilters</td>
<td style="text-align:center">/actuator/gateway/routefilters</td>
<td style="text-align:center">GET</td>
<td style="text-align:left">展示绑定到对应路由配置的GatewayFilter列表</td>
</tr>
<tr>
<td style="text-align:center">refresh</td>
<td style="text-align:center">/actuator/gateway/refresh</td>
<td style="text-align:center">POST</td>
<td style="text-align:left">清空路由配置缓存</td>
</tr>
<tr>
<td style="text-align:center">routes</td>
<td style="text-align:center">/actuator/gateway/routes</td>
<td style="text-align:center">GET</td>
<td style="text-align:left">展示已经定义的路由配置列表</td>
</tr>
<tr>
<td style="text-align:center">routes/{id}</td>
<td style="text-align:center">/actuator/gateway/routes/{id}</td>
<td style="text-align:center">GET</td>
<td style="text-align:left">展示对应ID已经定义的路由配置</td>
</tr>
<tr>
<td style="text-align:center">routes/{id}</td>
<td style="text-align:center">/actuator/gateway/routes/{id}</td>
<td style="text-align:center">POST</td>
<td style="text-align:left">添加一个新的路由配置</td>
</tr>
<tr>
<td style="text-align:center">routes/{id}</td>
<td style="text-align:center">/actuator/gateway/routes/{id}</td>
<td style="text-align:center">DELETE</td>
<td style="text-align:left">删除指定ID的路由配置</td>
</tr>
</tbody>
</table>
<p>其中<code>/actuator/gateway/routes/{id}</code>添加一个新的路由配置请求参数的格式如下：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"id"</span>: <span class="string">"first_route"</span>,</span><br><span class="line">  <span class="attr">"predicates"</span>: [&#123;</span><br><span class="line">    <span class="attr">"name"</span>: <span class="string">"Path"</span>,</span><br><span class="line">    <span class="attr">"args"</span>: &#123;<span class="attr">"doge"</span>:<span class="string">"/throwable"</span>&#125;</span><br><span class="line">  &#125;],</span><br><span class="line">  <span class="attr">"filters"</span>: [],</span><br><span class="line">  <span class="attr">"uri"</span>: <span class="string">"https://www.throwable.club"</span>,</span><br><span class="line">  <span class="attr">"order"</span>: <span class="number">0</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="小结">小结</h2>
<p>笔者虽然是一个底层的码畜，但是很久之前就向身边的朋友说：</p>
<blockquote>
<p>反应式编程结合同步非阻塞IO或者异步非阻塞IO是目前网络编程框架的主流方向，最好要跟上主流的步伐掌握这些框架的使用，有能力最好成为它们的贡献者。</p>
</blockquote>
<p>目前常见的反应式编程框架有：</p>
<ul>
<li><a href="https://projectreactor.io/" target="_blank" rel="noopener">Reactor</a>和<code>RxJava2</code>，其中<code>Reactor</code>在后端的JVM应用比较常见，<code>RxJava2</code>在安卓编写的APP客户端比较常见。</li>
<li><code>Reactor-Netty</code>，这个是基于<code>Reactor</code>和<code>Netty</code>封装的。</li>
<li><code>Spring-WebFlux</code>和<code>Spring-Cloud-Gateway</code>，其中<code>Spring-Cloud-Gateway</code>依赖<code>Spring-WebFlux</code>，而<code>Spring-WebFlux</code>底层依赖于<code>Reactor-Netty</code>。</li>
</ul>
<p>根据这个链式关系，最好系统学习一下<code>Reactor</code>和<code>Netty</code>。</p>
<p>参考资料：</p>
<ul>
<li><a href="spring-cloud-gateway">Spring-Cloud-Gateway官方文档</a></li>
<li><a href="https://projectreactor.io/docs" target="_blank" rel="noopener">Reactor官方文档</a></li>
</ul>
<h2 id="附录">附录</h2>
<p>选用<code>Spring-Cloud-Gateway</code>不仅仅是为了使用新的技术，更重要的是它的性能有了不俗的提升，基准测试项目<a href="https://github.com/spencergibb/spring-cloud-gateway-bench" target="_blank" rel="noopener">spring-cloud-gateway-bench</a>的结果如下：</p>
<table>
<thead>
<tr>
<th style="text-align:center">代理组件(Proxy)</th>
<th style="text-align:center">平均交互延迟(Avg Latency)</th>
<th style="text-align:center">平均每秒处理的请求数(Avg Requests/Sec)</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">Spring Cloud Gateway</td>
<td style="text-align:center">6.61ms</td>
<td style="text-align:center">32213.38</td>
</tr>
<tr>
<td style="text-align:center">Linkered</td>
<td style="text-align:center">7.62ms</td>
<td style="text-align:center">28050.76</td>
</tr>
<tr>
<td style="text-align:center">Zuul(1.x)</td>
<td style="text-align:center">12.56ms</td>
<td style="text-align:center">20800.13</td>
</tr>
<tr>
<td style="text-align:center">None(直接调用)</td>
<td style="text-align:center">2.09ms</td>
<td style="text-align:center">116841.15</td>
</tr>
</tbody>
</table>
<p>(本文完 c-3-d e-a-20190504)</p>

          
            <br>
            
              
                
              
                
              
                
              
                
              
                
              
                
                  <section class='widget card-shadow  copyright'>
  <div class='content'>
    
      <blockquote>
        
          
            <p>作者：<a href="http://www.throwable.club" target="_blank" rel="noopener">Throwable</a></p>

          
        
          
            <p>版权：博客内容遵循<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener">署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0) 协议</a>，转载请在文章明显位置注明作者及出处</p>

          
        
          
            <p>本文永久链接是：<a href=http://throwable.club/2019/05/03/spring-cloud-gateway-guide/>http://throwable.club/2019/05/03/spring-cloud-gateway-guide/</a></p>
          
        
      </blockquote>
    
  </div>
</section>

                
              
                
              
                
              
                
              
                
              
            
              
                
              
                
              
                
              
                
              
                
              
                
              
                
                  <section class='widget card-shadow  text'>
  <header>
  <div>
    
      <i class=" fa-fw" aria-hidden="true"></i><span class='name'>打赏</span>
    

  </div>
  
</header>

  <div class='content'>
    
      <p>
        <iframe src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/static/simple-mine/index.html" style="overflow-x:hidden;overflow-y:hidden; border:0xp none #fff; min-height:240px; width:100%;"  frameborder="0" scrolling="no"></iframe>
      </p>
    
  </div>
</section>

                
              
                
              
                
              
                
              
            
          
        </div>
        
          <br>
          


  <section class='meta' id="footer-meta">
    <div class='new-meta-box'>
      
        
          
  
  <div class="new-meta-item meta-tags"><a class="tag" href="/blog/tags/Spring-Cloud-Gateway/" rel="nofollow"><i class="fas fa-tag" aria-hidden="true"></i><p>Spring Cloud Gateway</p></a></div> <div class="new-meta-item meta-tags"><a class="tag" href="/blog/tags/Spring-Cloud/" rel="nofollow"><i class="fas fa-tag" aria-hidden="true"></i><p>Spring Cloud</p></a></div>


        
      
        
          
  <div class="new-meta-item share -mob-share-list">
  <div class="-mob-share-list share-body">
    
      
        <a class="-mob-share-qq" title="QQ好友" rel="external nofollow noopener noreferrer"
          
          href="http://connect.qq.com/widget/shareqq/index.html?url=http://throwable.club/2019/05/03/spring-cloud-gateway-guide/&title=Spring Cloud Gateway入坑记 | Throwable's Blog&pics=https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/mine/doge_avatar.jpg&summary=
前提
最近在做老系统的重构，重构完成后新系统中需要引入一个网关服务，作为新系统和老系统接口的适配和代理。之前，很多网关应用使用的是Spring-Cloud-Netfilx基于Zuul1.x版本实现的那套方案，但是鉴于Zuul1.x已经停止迭代，它使用的是比较传统的阻塞(B)IO + 多线程的实现方案，其实性能不太好。后来Spring团队干脆自己重新研发了一套网关组件，这个就是本次要调研的Spring-Cloud-Gateway。
简介
Spring Cloud Gateway依赖于Spring Boot 2.0, Spring WebFlux,和Project Reactor。许多熟悉的同步类库(例如Spring-Data和Spring-Security)和同步编程模式在Spring Cloud Gateway中并不适用，所以最好先阅读一下上面提到的三个框架的文档。
Spring Cloud Gateway依赖于Spring Boot和Spring WebFlux提供的基于Netty的运行时环境，它并非构建为一个WAR包或者运行在传统的Servlet容器中。"
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/xaoxuu/assets@19.1.9/logo/128/qq.png">
          
        </a>
      
    
      
        <a class="-mob-share-qzone" title="QQ空间" rel="external nofollow noopener noreferrer"
          
          href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=http://throwable.club/2019/05/03/spring-cloud-gateway-guide/&title=Spring Cloud Gateway入坑记 | Throwable's Blog&pics=https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/mine/doge_avatar.jpg&summary=
前提
最近在做老系统的重构，重构完成后新系统中需要引入一个网关服务，作为新系统和老系统接口的适配和代理。之前，很多网关应用使用的是Spring-Cloud-Netfilx基于Zuul1.x版本实现的那套方案，但是鉴于Zuul1.x已经停止迭代，它使用的是比较传统的阻塞(B)IO + 多线程的实现方案，其实性能不太好。后来Spring团队干脆自己重新研发了一套网关组件，这个就是本次要调研的Spring-Cloud-Gateway。
简介
Spring Cloud Gateway依赖于Spring Boot 2.0, Spring WebFlux,和Project Reactor。许多熟悉的同步类库(例如Spring-Data和Spring-Security)和同步编程模式在Spring Cloud Gateway中并不适用，所以最好先阅读一下上面提到的三个框架的文档。
Spring Cloud Gateway依赖于Spring Boot和Spring WebFlux提供的基于Netty的运行时环境，它并非构建为一个WAR包或者运行在传统的Servlet容器中。"
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/xaoxuu/assets@19.1.9/logo/128/qzone.png">
          
        </a>
      
    
      
        <a class='qrcode' rel="external nofollow noopener noreferrer" href='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAN4AAADeCAAAAAB3DOFrAAACqklEQVR42u3aQW7DMAwEwPz/0+21RWFjSYqJC4xPReLaGh0kZqnXK76+flz3n1z9/fe6f8v98w9feHh4eIOh3z/6anBXn/TuzO+JJg4PDw9vjXe1ot4v9Pf/lW8MyQZQvQcPDw/vabx7zF5RjoeHh/d/edUNII8Skifg4eHhPYGXD65XFueF+MeyFjw8PLyYly/Wz/l7pb+Hh4eHN+6q582wPJLIQ4oDo8XDw8Nb4OVDqRbckwA3n8RksvDw8PA2eNUlOH9QNdRIvk2OguHh4eG9h5cswfPDUtUjXL0guNBVw8PDw2vxklhho+lVPTTQnCY8PDy8Zd686VW9szdBhWYYHh4e3lHe2S2hFysk7a7kvVF/Dw8PD2/MyyODSQHdCyzmLTQ8PDy89/DmS3zePEsmOt888PDw8N7PyxfuaqOrGmr0to1C7oKHh4c3+DY/VpW39vO3bIQgv+7Bw8PDW+Dli/g8PqhuDPkn5V8MeHh4eGPe5FhV76jBJOpNohA8PDy8PV6hgdR6TR4BT9pjl2PDw8PDW+Dli3i0w4wL7slxgctpwsPDwzvKy6Pb3mZQLdzze6IJxcPDw1vgJYFC/uM/b5JNoopqFIKHh4d3llctkfPX9yZlHhPj4eHhbfOqpWpSavfa/713RWU9Hh4e3hqvWYOPkb2AuHyaDA8PD2+B14tNq0PPh9t7fmHfw8PDwxvzkqU8L6bzyCBa3CcXHh4e3gIsv06VyD1SdZvBw8PD2+D1Hp238/PGVTUQObyR4OHh4RV51c2gdxgr3x6S5xQ2Gzw8PLw1Xi9KqLb/q024A/EKHh4e3gN4Z6OE3jGCxY0BDw8Pb41XLZerh2Kr5fvldOPh4eGt8SaBwtnpyI8jRP+Lh4eHt8Ar/7wfh7nV0rkKxsPDw1vjfQOfWl6TbCEjSAAAAABJRU5ErkJggg=='>
        
          <img src="https://cdn.jsdelivr.net/gh/xaoxuu/assets@19.1.9/logo/128/wechat.png">
        
        </a>
      
    
      
        <a class="-mob-share-weibo" title="微博" rel="external nofollow noopener noreferrer"
          
          href="http://service.weibo.com/share/share.php?url=http://throwable.club/2019/05/03/spring-cloud-gateway-guide/&title=Spring Cloud Gateway入坑记 | Throwable's Blog&pics=https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/mine/doge_avatar.jpg&summary=
前提
最近在做老系统的重构，重构完成后新系统中需要引入一个网关服务，作为新系统和老系统接口的适配和代理。之前，很多网关应用使用的是Spring-Cloud-Netfilx基于Zuul1.x版本实现的那套方案，但是鉴于Zuul1.x已经停止迭代，它使用的是比较传统的阻塞(B)IO + 多线程的实现方案，其实性能不太好。后来Spring团队干脆自己重新研发了一套网关组件，这个就是本次要调研的Spring-Cloud-Gateway。
简介
Spring Cloud Gateway依赖于Spring Boot 2.0, Spring WebFlux,和Project Reactor。许多熟悉的同步类库(例如Spring-Data和Spring-Security)和同步编程模式在Spring Cloud Gateway中并不适用，所以最好先阅读一下上面提到的三个框架的文档。
Spring Cloud Gateway依赖于Spring Boot和Spring WebFlux提供的基于Netty的运行时环境，它并非构建为一个WAR包或者运行在传统的Servlet容器中。"
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/xaoxuu/assets@19.1.9/logo/128/weibo.png">
          
        </a>
      
    
      
        <a class='qrcode' rel="external nofollow noopener noreferrer" href='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAN4AAADeCAAAAAB3DOFrAAACqklEQVR42u3aQW7DMAwEwPz/0+21RWFjSYqJC4xPReLaGh0kZqnXK76+flz3n1z9/fe6f8v98w9feHh4eIOh3z/6anBXn/TuzO+JJg4PDw9vjXe1ot4v9Pf/lW8MyQZQvQcPDw/vabx7zF5RjoeHh/d/edUNII8Skifg4eHhPYGXD65XFueF+MeyFjw8PLyYly/Wz/l7pb+Hh4eHN+6q582wPJLIQ4oDo8XDw8Nb4OVDqRbckwA3n8RksvDw8PA2eNUlOH9QNdRIvk2OguHh4eG9h5cswfPDUtUjXL0guNBVw8PDw2vxklhho+lVPTTQnCY8PDy8Zd686VW9szdBhWYYHh4e3lHe2S2hFysk7a7kvVF/Dw8PD2/MyyODSQHdCyzmLTQ8PDy89/DmS3zePEsmOt888PDw8N7PyxfuaqOrGmr0to1C7oKHh4c3+DY/VpW39vO3bIQgv+7Bw8PDW+Dli/g8PqhuDPkn5V8MeHh4eGPe5FhV76jBJOpNohA8PDy8PV6hgdR6TR4BT9pjl2PDw8PDW+Dli3i0w4wL7slxgctpwsPDwzvKy6Pb3mZQLdzze6IJxcPDw1vgJYFC/uM/b5JNoopqFIKHh4d3llctkfPX9yZlHhPj4eHhbfOqpWpSavfa/713RWU9Hh4e3hqvWYOPkb2AuHyaDA8PD2+B14tNq0PPh9t7fmHfw8PDwxvzkqU8L6bzyCBa3CcXHh4e3gIsv06VyD1SdZvBw8PD2+D1Hp238/PGVTUQObyR4OHh4RV51c2gdxgr3x6S5xQ2Gzw8PLw1Xi9KqLb/q024A/EKHh4e3gN4Z6OE3jGCxY0BDw8Pb41XLZerh2Kr5fvldOPh4eGt8SaBwtnpyI8jRP+Lh4eHt8Ar/7wfh7nV0rkKxsPDw1vjfQOfWl6TbCEjSAAAAABJRU5ErkJggg=='>
        
          <img src="https://cdn.jsdelivr.net/gh/xaoxuu/assets@19.1.9/logo/128/qrcode.png">
        
        </a>
      
    
  </div>
</div>



        
      
    </div>
  </section>


        
        
            <div class="prev-next">
                
                    <section class="prev">
                        <span class="art-item-left">
                            <h6><i class="fas fa-chevron-left" aria-hidden="true"></i>&nbsp;上一页</h6>
                            <h4>
                                <a href="/2019/05/05/spring-cloud-gateway-custom-global-filter/" rel="prev" title="Spring Cloud Gateway-自定义GlobalFilter">
                                  
                                      Spring Cloud Gateway-自定义GlobalFilter
                                  
                                </a>
                            </h4>
                            
                                
                                <h6 class="tags">
                                    <a class="tag" href="/blog/tags/Spring-Cloud-Gateway/"><i class="fas fa-tag fa-fw" aria-hidden="true"></i> Spring Cloud Gateway</a> <a class="tag" href="/blog/tags/Spring-Cloud/"><i class="fas fa-tag fa-fw" aria-hidden="true"></i> Spring Cloud</a>
                                </h6>
                            
                        </span>
                    </section>
                
                
                    <section class="next">
                        <span class="art-item-right" aria-hidden="true">
                            <h6>下一页&nbsp;<i class="fas fa-chevron-right" aria-hidden="true"></i></h6>
                            <h4>
                                <a href="/2019/04/30/java-object-wait-notify/" rel="prev" title="深入理解Object提供的阻塞和唤醒API">
                                    
                                        深入理解Object提供的阻塞和唤醒API
                                    
                                </a>
                            </h4>
                            
                                
                                <h6 class="tags">
                                    <a class="tag" href="/blog/tags/Java/"><i class="fas fa-tag fa-fw" aria-hidden="true"></i> Java</a> <a class="tag" href="/blog/tags/Object/"><i class="fas fa-tag fa-fw" aria-hidden="true"></i> Object</a>
                                </h6>
                            
                        </span>
                    </section>
                
            </div>
        
      </section>
    </article>
  

  
    <!-- 显示推荐文章和评论 -->



  <article class="post white-box comments card-shadow ">
    <section class="article typo">
      <h4><i class="fas fa-comments fa-fw" aria-hidden="true"></i>&nbsp;评论</h4>
      
      
      
      
        <section id="comments">
          <div id="valine_container" class="valine_thread">
            <i class="fas fa-spinner fa-spin fa-fw"></i>
          </div>
        </section>
      
    </section>
  </article>


  




<!-- 根据页面mathjax变量决定是否加载MathJax数学公式js -->



  <script>
    window.subData = {
      title: 'Spring Cloud Gateway入坑记',
      tools: true
    }
  </script>


</div>
<aside class='l_side'>
  
    
    
      
        
      
        
          
  <section class='widget card-shadow  toc-wrapper'>
    <header>
  <div>
    
      <i class="fas fa-list fa-fw" aria-hidden="true"></i><span class='name'>本文目录</span>
    

  </div>
  
    <!-- <div class='wrapper'><a class="s-toc rightBtn" rel="external nofollow noopener noreferrer" href="javascript:void(0)"><i class="fas fa-thumbtack fa-fw"></i></a></div> -->
  
</header>

    <div class='content'>
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前提"><span class="toc-text">前提</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#简介"><span class="toc-text">简介</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#专有名词"><span class="toc-text">专有名词</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#工作原理"><span class="toc-text">工作原理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#引入依赖"><span class="toc-text">引入依赖</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#网关配置"><span class="toc-text">网关配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Yaml配置"><span class="toc-text">Yaml配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#编程式流式配置"><span class="toc-text">编程式流式配置</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#路由谓词工厂"><span class="toc-text">路由谓词工厂</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#指定日期时间规则路由谓词"><span class="toc-text">指定日期时间规则路由谓词</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cookie路由谓词"><span class="toc-text">Cookie路由谓词</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Header路由谓词"><span class="toc-text">Header路由谓词</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Host路由谓词"><span class="toc-text">Host路由谓词</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#请求方法路由谓词"><span class="toc-text">请求方法路由谓词</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#请求路径路由谓词"><span class="toc-text">请求路径路由谓词</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#请求查询参数路由谓词"><span class="toc-text">请求查询参数路由谓词</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#远程IP地址路由谓词"><span class="toc-text">远程IP地址路由谓词</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#多个路由谓词组合"><span class="toc-text">多个路由谓词组合</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GatewayFilter工厂"><span class="toc-text">GatewayFilter工厂</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#GlobalFilter工厂"><span class="toc-text">GlobalFilter工厂</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#跨域配置"><span class="toc-text">跨域配置</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Actuator端点相关"><span class="toc-text">Actuator端点相关</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#小结"><span class="toc-text">小结</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#附录"><span class="toc-text">附录</span></a></li></ol>
    </div>
  </section>


        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
  
</aside>

<footer class="clearfix ">
  <br><br>
  
    <div class="social-wrapper">
      
        
          <a href="/atom.xml"
            class="social fas fa-rss fa-lg flat-btn"
            target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
        
          <a href="mailto:739805340@qq.com"
            class="social fas fa-envelope fa-lg flat-btn"
            target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
        
          <a href="https://github.com/zjcscut"
            class="social fab fa-github fa-lg flat-btn"
            target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
    </div>
  
  
  <br>
  <div><p>博客内容遵循 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener">署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0) 协议</a></p>
</div>
  <div>
    本站使用
    <a href="https://xaoxuu.com/wiki/volantis/" target="_blank" class="codename">Volantis</a>
    作为主题
    
      ，
      总访问量为
      <span id="busuanzi_value_site_pv"><i class="fas fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span>
      次
    
    。
  </div>
  
    <div class='copyright'>
    <p><a href="http://throwable.club">Copyright © 2017-2020 Throwable</a></p>

    </div>
  
</footer>
<script>setLoadingBarProgress(80);</script>


      <script>setLoadingBarProgress(60);</script>
    </div>
    <a class="s-top fas fa-arrow-up fa-fw" href='javascript:void(0)'></a>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>

  <script>
    
    var SEARCH_SERVICE = "hexo" || "hexo";
    var ROOT = "/" || "/";
    if (!ROOT.endsWith('/')) ROOT += '/';
  </script>

<script async src="//instant.page/3.0.0" type="module" defer integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script>


  <script src="https://cdn.jsdelivr.net/npm/scrollreveal@4.0.5/dist/scrollreveal.min.js"></script>
  <script type="text/javascript">
    $(function() {
      const $reveal = $('.reveal');
      if ($reveal.length === 0) return;
      const sr = ScrollReveal({ distance: 0 });
      sr.reveal('.reveal');
    });
  </script>


  <script src="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.js"></script>
  <script type="text/javascript">
    $(function() {
      Waves.attach('.flat-btn', ['waves-button']);
      Waves.attach('.float-btn', ['waves-button', 'waves-float']);
      Waves.attach('.float-btn-light', ['waves-button', 'waves-float', 'waves-light']);
      Waves.attach('.flat-box', ['waves-block']);
      Waves.attach('.float-box', ['waves-block', 'waves-float']);
      Waves.attach('.waves-image');
      Waves.init();
    });
  </script>


  <script async src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-busuanzi@2.3/js/busuanzi.pure.mini.js"></script>












  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  
    
      
<script src="https://cdn.jsdelivr.net/gh/xaoxuu/volantis@1.0.6/js/volantis.min.js"></script>

    
  
  <script>
  var GUEST_INFO = ['nick','mail','link'];
  var guest_info = 'nick,mail,link'.split(',').filter(function(item){
    return GUEST_INFO.indexOf(item) > -1
  });
  var notify = 'true' == true;
  var verify = 'true' == true;
  var valine = new Valine();
  valine.init({
    el: '#valine_container',
    notify: notify,
    verify: verify,
    guest_info: guest_info,
    
    appId: "2rSnXSt7hr4528jSF4ifr2lJ-gzGzoHsz",
    appKey: "n5fe705fSsz4JHfwwtym1Fus",
    placeholder: "(゜-゜)つロ 干杯~-bilibili",
    pageSize:'10',
    avatar:'mp',
    lang:'zh-cn',
    highlight:'true'
  })
  </script>



  
<script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@20.2.30/js/app.js"></script>



  
<script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@20.2.30/js/search.js"></script>



  
    
<script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@20.2.30/js/commentTyping.js"></script>

  





<!-- 复制 -->
<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  let COPY_SUCCESS = "复制成功";
  let COPY_FAILURE = "复制失败";
  /*页面载入完成后，创建复制按钮*/
  !function (e, t, a) {
    /* code */
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '  <i class="fa fa-copy"></i><span>复制</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });

      clipboard.on('success', function(e) {
        //您可以加入成功提示
        console.info('Action:', e.action);
        console.info('Text:', e.text);
        console.info('Trigger:', e.trigger);
        success_prompt(COPY_SUCCESS);
        e.clearSelection();
      });
      clipboard.on('error', function(e) {
        //您可以加入失败提示
        console.error('Action:', e.action);
        console.error('Trigger:', e.trigger);
        fail_prompt(COPY_FAILURE);
      });
    }
    initCopyCode();

  }(window, document);

  /**
   * 弹出式提示框，默认1.5秒自动消失
   * @param message 提示信息
   * @param style 提示样式，有alert-success、alert-danger、alert-warning、alert-info
   * @param time 消失时间
   */
  var prompt = function (message, style, time)
  {
      style = (style === undefined) ? 'alert-success' : style;
      time = (time === undefined) ? 1500 : time*1000;
      $('<div>')
          .appendTo('body')
          .addClass('alert ' + style)
          .html(message)
          .show()
          .delay(time)
          .fadeOut();
  };

  // 成功提示
  var success_prompt = function(message, time)
  {
      prompt(message, 'alert-success', time);
  };

  // 失败提示
  var fail_prompt = function(message, time)
  {
      prompt(message, 'alert-danger', time);
  };

  // 提醒
  var warning_prompt = function(message, time)
  {
      prompt(message, 'alert-warning', time);
  };

  // 信息提示
  var info_prompt = function(message, time)
  {
      prompt(message, 'alert-info', time);
  };

</script>


<!-- fancybox -->
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script>
  let LAZY_LOAD_IMAGE = "";
  $(".article-entry").find("fancybox").find("img").each(function () {
      var element = document.createElement("a");
      $(element).attr("data-fancybox", "gallery");
      $(element).attr("href", $(this).attr("src"));
      /* 图片采用懒加载处理时,
       * 一般图片标签内会有个属性名来存放图片的真实地址，比如 data-original,
       * 那么此处将原本的属性名src替换为对应属性名data-original,
       * 修改如下
       */
       if (LAZY_LOAD_IMAGE) {
         $(element).attr("href", $(this).attr("data-original"));
       }
      $(this).wrap(element);
  });
</script>





<script src='https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/static/js/roll.js'></script>


  <script>setLoadingBarProgress(100);</script>
</body>
</html>
