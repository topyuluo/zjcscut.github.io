{"meta":{"title":"Throwable's Blog","subtitle":"å»åˆ›ä¸šäº†ï¼Œå¤ªå¿™äº†ï¼Œå¯èƒ½ä¼šä¸å®šæœŸé¸½ğŸ˜ğŸ˜ğŸ˜ğŸ˜‚ğŸ˜‚ğŸ˜‚","description":"ä¸€æ£µè¿˜åœ¨å°è¯•åŠªåŠ›ç”Ÿå­˜çš„90åéŸ­èœDoge","author":"Throwable","url":"http://throwable.club","root":"/"},"pages":[{"title":"404 Not Found","date":"2019-12-24T17:01:51.466Z","updated":"2019-12-24T17:01:51.466Z","comments":true,"path":"404.html","permalink":"http://throwable.club/404.html","excerpt":"","text":"404 Not Found **å¾ˆæŠ±æ­‰ï¼Œæ‚¨è®¿é—®çš„é¡µé¢ä¸å­˜åœ¨** å¯èƒ½æ˜¯è¾“å…¥åœ°å€æœ‰è¯¯æˆ–è¯¥åœ°å€å·²è¢«åˆ é™¤"},{"title":"å…³äº","date":"2018-11-04T09:47:35.000Z","updated":"2020-01-16T15:05:37.592Z","comments":true,"path":"about/index.html","permalink":"http://throwable.club/about/index.html","excerpt":"","text":"2016å±Šåå—ç†å·¥æ¯•ä¸šï¼Œæœ¬ä¸“ä¸šä¿¡æ¯ä¸è®¡ç®—ç§‘å­¦(æ•°å­¦å­¦ç§‘)ï¼Œæœ¬æ¥åšæ•°å€¼ç®—æ³•æ–¹é¢çš„ä¸œè¥¿ï¼Œåæ¥å› ä¸ºå…´è¶£å…¥è¡ŒJavaã€‚ æŠ€æœ¯é©±åŠ¨ï¼Œå–œæ¬¢å°è¯•å’Œè½åœ°æ–°æŠ€æœ¯ï¼ŒåŒæ—¶ä¹Ÿå–œæ¬¢æ·±å…¥ç ”ç©¶åº•å±‚åŸç†ã€‚ 2015-2016 åå—å¸ˆèŒƒå¤§å­¦ç½‘ç»œä¸­å¿ƒå®ä¹ ï¼Œè´Ÿè´£ä¸€äº›æ ¡å†…åº”ç”¨å’Œå…¬ä¼—å·éƒ¨åˆ†åŠŸèƒ½çš„å¼€å‘ç»´æŠ¤ã€‚ å±¥å† 2016.6-2019.11 å°±èŒäºPPmoneyå€Ÿè´·ï¼Œæ›¾ä¸»è¦åšä¸šåŠ¡å¼€å‘ï¼Œåæ¥åå‘äºä¸šåŠ¡æ¶æ„å’ŒåŸºç¡€æ¶æ„ã€‚ 2019.11ä¹‹å åˆ›ä¸šï¼ˆå¤ªå¿™äº†ï¼Œå¯èƒ½ä¼šä¸å®šæœŸé¸½ï¼‰ã€‚ å£°æ˜ è¿™ä¸ªåšå®¢é‡Œé¢çš„æ‰€æœ‰æ–‡ç« éƒ½æ˜¯ç¬”è€…åœ¨ä¸šä½™æ—¶é—´å®Œæˆï¼Œæœ‰æ—¶å€™å·¥ä½œä¸Šä¸šåŠ¡æ¯”è¾ƒç¹å¿™å¯èƒ½éœ€è¦996æˆ–è€…997ï¼Œæ‰€ä»¥æ›´æ–°é€Ÿåº¦ä¼šæ¯”è¾ƒç¼“æ…¢ã€‚ å¤§å¤šæ•°æ–‡ç« éƒ½æ˜¯Javaç›¸å…³ï¼Œä½¿ç”¨çš„æ˜¯JDK11ï¼Œå¹¶ä¸æ˜¯ä¸ºäº†æ ‡æ–°ç«‹å¼‚ï¼Œåªå› ä¸ºJDK11æ˜¯å…è´¹çš„LTSç‰ˆæœ¬ï¼ˆLong Term Supportï¼Œé•¿æœŸæ”¯æŒï¼‰ã€‚ æ‰€æœ‰æ–‡ç« éƒ½æ˜¯åŸåˆ›ï¼Œå¦‚æœå‚è€ƒäº†åˆ«äººçš„å†…å®¹ï¼Œä¸ºäº†å°Šé‡å…¶ç‰ˆæƒä¸€å®šä¼šåœ¨æœ«å°¾çš„å‚è€ƒèµ„æ–™ä¸­æ ‡æ˜å¹¶ä¸”æ·»åŠ å…¶é“¾æ¥ã€‚ æ¯•ä¸šå‰åæ›¾ç»å†™è¿‡å¤§é‡æ–‡ç« ï¼ˆä¸»è¦æ˜¯ä¸»æµæ¡†æ¶çš„æºç åˆ†æï¼‰ï¼Œç”±äºä¹‹å‰çš„æ–‡ç« è´¨é‡å’Œæ’ç‰ˆæœ‰é—®é¢˜æˆ–è€…ä¸å…¼å®¹ï¼Œåé¢ä¿®å¤ä¹‹åä¼šé‡æ–°å‘å¸ƒã€‚ åœ¨æŸä¸ªæ—¶é—´åå‘å¸ƒçš„æ–‡ç« ä¼šé™„å¸¦åŸä»¶å’Œå›¾ç‰‡çš„ä¸‹è½½é“¾æ¥ï¼Œå…·ä½“çœ‹ç¬”è€…çš„ä¹ æƒ¯ï¼ˆo(&gt;ï¹&lt;)oæœ‰æ—¶å€™æ‡’å¯èƒ½ä¼šå¿˜è®°ï¼‰ï¼Œé™„ä»¶é“¾æ¥åœ¨æ¯ç¯‡æ–‡ç« çš„ç»“å°¾éƒ¨åˆ†ã€‚ æ¯ç¯‡æ–‡ç« çš„æœ«å°¾éƒ½ä¼šé™„å¸¦å®Œæˆçš„æ—¥æœŸã€è€—æ—¶å’Œæ›´æ–°ä¿®è®¢å†…å®¹çš„æ—¥æœŸã€‚å¦‚ï¼š 12345ï¼ˆæœ¬æ–‡å®Œ c-7-d e-a-20190727 r-a-20190728ï¼‰æ„æ€æ˜¯ï¼šcost 7 days,end at 2019-07-27,raised at 2019-07-28&#x3D;&gt; å†™è¿™ç¯‡æ–‡ç« èŠ±è´¹äº†7å¤©æ—¶é—´ï¼Œå®Œæˆäº2019-07-27ï¼Œæœ€åä¿®è®¢æ›´æ–°äº2019-07-28 æ–‡ç« å‘å¸ƒå¹³å° æ˜é‡‘ åšå®¢å›­ ç®€ä¹¦ Github Page Coding Page é™¤äº†Github Pageå’ŒCoding Pageï¼Œå…¶ä»–å¹³å°éšç¼˜æ›´æ–°ã€‚ To Be Continueâ€¦ åªæ˜¯ä¸€ä¸ªæ™®é€šçš„ä¸Šç­æ—ï¼Œä¹Ÿè®¸ä½ èƒ½åœ¨å¹¿å·åœ°é“äº”å·çº¿é‡åˆ°æˆ‘ï¼ŒæœŸå¾…ä¸ä½ çš„é‚‚é€…ã€‚ åŠ æ²¹ï¼Œå…±å‹‰ã€‚ ![](https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/mine/about-me-1.jpg) é™„å½• å¤§å­¦ä¸­äºŒæœŸæ›¾ç»å†™è¿‡çš„ä¸€ç¯‡çŸ­å¥ï¼Œè™½ç„¶ç°åœ¨å›æƒ³èµ·æ¥ä¸çŸ¥é“å½“æ—¶æ˜¯æ€ä¹ˆæƒ³å‡ºæ¥ï¼Œä½†æ˜¯æ„Ÿè§‰è¯»èµ·æ¥è¿˜æ˜¯æŒºæœ‰æ„Ÿè§‰çš„ï¼Œæ»¡æ˜¯å›å¿†ï¼š æ›¾ç»å±…ä½å·²ä¹…çš„å¿ƒå’Œä¸–ç•Œï¼Œæ—©å·²åœ¨å¤œè·¯ä¸­æ¸è¡Œæ¸è¿œ é‚£äº›è¿·å¤±è¿‡çš„è·¯ï¼ŒæŠ¬å¤´åªæœ‰è¢«é«˜å‹çº¿å‰²ç ´çš„å¤©ç©º é£ç¿”åœ¨å¤©ç©ºçš„ï¼Œä»…æ˜¯ç ´ç¢çš„ç¿…è†€çš„æ¢¦ æ¢¦ç»ˆç©¶æ˜¯æ¢¦ï¼Œåœ¨æ•åº•å‘éœ‰ï¼ŒæŠ‘æˆ–æ½œè—åœ¨å¿ƒä¸­ å¿ƒè„æµè¿‡èº«ä½“çš„æ¯ä¸€æ»´è¡€ï¼Œä½†æµè¡€çš„æ—¶å€™æˆ‘èƒ½å¦çŸ¥é“å†…å¿ƒåœ¨æƒ³ä»€ä¹ˆ æƒ³è¿‡çš„äººæˆ–äº‹ï¼Œåˆ°å¤´æ¥åˆè¢«æ—¶é—´æ²‰æ·€ä¸ºå›å¿† å›å¿†ä¸­çš„è‹¦ä¸ç”œï¼Œæ˜¯é˜³å…‰ï¼Œæˆ–æ˜¯èº«åçš„é˜´æš—é¢ é˜´æš—å°±æ˜¯è¿™ä¸ªä¸–ç•Œçš„æœ¬è´¨ï¼Œæœ¬è´¨åªæœ‰ç™½å’Œé»‘ é»‘å¤œå¦‚çº¦è€Œè‡³ï¼Œæˆ‘è¦ä¸ºé‚£ä¸ªç ´ç¢çš„æ¢¦ç¼–ç»‡ä¸€ä¸ªè°è¨€ è°è¨€èµ°åˆ°æœ€åæ€»ä¼šæœ‰ç»“å±€ï¼Œè€Œç»“å±€å¾€å¾€åªæ˜¯è°è¨€çš„å»¶ç»­ å»¶ç»­ä¸‹å»çš„ä»…ä»…æ˜¯æˆ‘ä¸€ä¸ªäººçš„è½®å›ï¼Œå›åˆ°é‚£ä¸ªç¦»å¼€å·²ä¹…çš„å¿ƒå’Œä¸–ç•Œ Written on 2013-11-20 21:28 by throwable"},{"title":"æ‰€æœ‰åˆ†ç±»","date":"2019-12-24T17:55:09.888Z","updated":"2019-12-24T17:55:09.888Z","comments":true,"path":"categories/index.html","permalink":"http://throwable.club/categories/index.html","excerpt":"","text":""},{"title":"å‹æƒ…é“¾æ¥","date":"2020-01-07T00:32:29.610Z","updated":"2020-01-07T00:32:29.610Z","comments":true,"path":"friends/index.html","permalink":"http://throwable.club/friends/index.html","excerpt":"","text":"å„ä½å¤§ä½¬æƒ³äº¤æ¢å‹é“¾çš„è¯å¯ä»¥åœ¨ä¸‹æ–¹ç•™è¨€ï¼Œå¿…é¡»è¦æœ‰åç§°ã€å¤´åƒé“¾æ¥ã€å’Œè‡³å°‘ä¸€ä¸ªæ ‡ç­¾å“¦ï½ åç§°ï¼š Throwableâ€™s Blog å¤´åƒï¼š https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/mine/doge_favicon.ico ç½‘å€ï¼š http://throwable.club æ ‡ç­¾ï¼š Java"},{"title":"æ‰€æœ‰æ ‡ç­¾","date":"2019-12-24T17:55:01.701Z","updated":"2019-12-24T17:55:01.701Z","comments":true,"path":"tags/index.html","permalink":"http://throwable.club/tags/index.html","excerpt":"","text":""}],"posts":[{"title":"ç†è§£å’Œè¿ç”¨Javaä¸­çš„Lambda","slug":"java-understand-and-use-lambda","date":"2020-02-09T10:13:50.000Z","updated":"2020-02-09T14:45:48.809Z","comments":true,"path":"2020/02/09/java-understand-and-use-lambda/","link":"","permalink":"http://throwable.club/2020/02/09/java-understand-and-use-lambda/","excerpt":"å‰æ å›æƒ³ä¸€ä¸‹ï¼ŒJDK8æ˜¯2014å¹´å‘å¸ƒæ­£å¼ç‰ˆçš„ï¼Œåˆ°ç°åœ¨ä¸ºï¼ˆ2020-02-08ï¼‰æ­¢å·²ç»è¿‡å»äº†5å¹´å¤šã€‚JDK8å¼•å…¥çš„ä¸¤ä¸ªæ¯”è¾ƒå¼ºå¤§çš„æ–°ç‰¹æ€§æ˜¯Lambdaè¡¨è¾¾å¼ï¼ˆä¸‹æ–‡çš„Lambdaç‰¹æŒ‡JDKæä¾›çš„Lambdaï¼‰å’ŒStreamï¼Œè¿™ä¸¤ä¸ªå¼ºå¤§çš„ç‰¹æ€§è®©å‡½æ•°å¼ç¼–ç¨‹åœ¨Javaå¼€å‘ä¸­å‘æ‰¬å…‰å¤§ã€‚è¿™ç¯‡æ–‡ç« ä¼šä»åŸºæœ¬æ¦‚å¿µã€ä½¿ç”¨æ–¹å¼ã€å®ç°åŸç†å’Œå®æˆ˜åœºæ™¯ç­‰è§’åº¦ä»‹ç»Lambdaçš„å…¨è²Œï¼Œå…¶ä¸­è¿˜ä¼šæ¶‰åŠä¸€äº›å‡½æ•°å¼ç¼–ç¨‹æ¦‚å¿µã€JVMä¸€äº›çŸ¥è¯†ç­‰ç­‰ã€‚","text":"å‰æ å›æƒ³ä¸€ä¸‹ï¼ŒJDK8æ˜¯2014å¹´å‘å¸ƒæ­£å¼ç‰ˆçš„ï¼Œåˆ°ç°åœ¨ä¸ºï¼ˆ2020-02-08ï¼‰æ­¢å·²ç»è¿‡å»äº†5å¹´å¤šã€‚JDK8å¼•å…¥çš„ä¸¤ä¸ªæ¯”è¾ƒå¼ºå¤§çš„æ–°ç‰¹æ€§æ˜¯Lambdaè¡¨è¾¾å¼ï¼ˆä¸‹æ–‡çš„Lambdaç‰¹æŒ‡JDKæä¾›çš„Lambdaï¼‰å’ŒStreamï¼Œè¿™ä¸¤ä¸ªå¼ºå¤§çš„ç‰¹æ€§è®©å‡½æ•°å¼ç¼–ç¨‹åœ¨Javaå¼€å‘ä¸­å‘æ‰¬å…‰å¤§ã€‚è¿™ç¯‡æ–‡ç« ä¼šä»åŸºæœ¬æ¦‚å¿µã€ä½¿ç”¨æ–¹å¼ã€å®ç°åŸç†å’Œå®æˆ˜åœºæ™¯ç­‰è§’åº¦ä»‹ç»Lambdaçš„å…¨è²Œï¼Œå…¶ä¸­è¿˜ä¼šæ¶‰åŠä¸€äº›å‡½æ•°å¼ç¼–ç¨‹æ¦‚å¿µã€JVMä¸€äº›çŸ¥è¯†ç­‰ç­‰ã€‚ åŸºæœ¬æ¦‚å¿µ ä¸‹é¢ä»‹ç»ä¸€äº›åŸºæœ¬æ¦‚å¿µï¼Œä¸€æ­¥ä¸€æ­¥å¼•å‡ºLambdaçš„æ¦‚å¿µã€‚ å‡½æ•°å¼æ¥å£ å‡½æ•°å¼æ¥å£å’Œæ¥å£é»˜è®¤æ–¹æ³•éƒ½æ˜¯JDK8å¼•å…¥çš„æ–°ç‰¹æ€§ã€‚å‡½æ•°å¼æ¥å£çš„æ¦‚å¿µå¯ä»¥ä»java.lang.FunctionalInterfaceæ³¨è§£çš„APIæ³¨é‡Šä¸­å¾—çŸ¥ï¼š An informative annotation type used to indicate that an interface type declaration is intended to be a functional interface as defined by the Java Language Specification. Conceptually, a functional interface has exactly one abstract method. Since {@linkplain java.lang.reflect.Method#isDefault() default methods} have an implementation, they are not abstract. ç®€å•æ¥è¯´å°±æ˜¯ï¼š@FunctionalInterfaceæ˜¯ä¸€ä¸ªæä¾›ä¿¡æ¯çš„æ¥å£ï¼ˆå…¶å®å°±æ˜¯æ ‡è¯†æ¥å£ï¼‰ï¼Œç”¨äºè¡¨æ˜å¯¹åº”çš„æ¥å£ç±»å‹å£°æ˜æ˜¯ä¸€ä¸ªJavaè¯­è¨€è§„èŒƒå®šä¹‰çš„å‡½æ•°å¼æ¥å£ã€‚ä»æ¦‚å¿µä¸Šè¯´ï¼Œä¸€ä¸ªå‡½æ•°å¼æ¥å£æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œå› ä¸ºæ¥å£é»˜è®¤æ–¹æ³•å¿…é¡»äºˆä»¥å®ç°ï¼Œå®ƒä»¬ä¸æ˜¯æŠ½è±¡æ–¹æ³•ã€‚ æ‰€ä»¥å¯ä»¥è¿™æ ·ç»™å‡½æ•°å¼æ¥å£å®šä¹‰ï¼šå¦‚æœä¸€ä¸ªæ¥å£å£°æ˜çš„æ—¶å€™æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯å‡½æ•°å¼æ¥å£ï¼Œå¯ä»¥ä½¿ç”¨@FunctionalInterfaceæ³¨è§£æ ‡è¯†ã€‚ JDKä¸­å·²ç»å®šä¹‰äº†å¾ˆå¤šå†…ç½®çš„å‡½æ•°å¼æ¥å£ï¼Œä¾‹å¦‚ï¼š 12345678910111213// java.lang.Runnable@FunctionalInterfacepublic interface Runnable &#123; public abstract void run();&#125; // java.util.function.Supplier@FunctionalInterfacepublic interface Supplier&lt;T&gt; &#123; T get();&#125; ä¹Ÿå¯ä»¥è‡ªå®šä¹‰å‡½æ•°å¼æ¥å£ï¼Œä¾‹å¦‚ï¼š 123456@FunctionalInterfacepublic interface CustomFunctionalInterface &#123; // å¯ä»¥ç¼©å†™ä¸ºvoid process(); æ¥å£æ–¹æ³•å®šä¹‰çš„æ—¶å€™ï¼Œé»˜è®¤ä½¿ç”¨public abstractä¿®é¥° public abstract void process();&#125; æ¥å£é»˜è®¤æ–¹æ³• æ¥å£é»˜è®¤æ–¹æ³•çš„å«ä¹‰å¯ä»¥è§Javaå®˜æ–¹æ•™ç¨‹ä¸­å¯¹åº”çš„ç« èŠ‚ï¼Œåœ¨æ–‡æœ«çš„å‚è€ƒèµ„æ–™å¯ä»¥æŸ¥çœ‹å…·ä½“çš„é“¾æ¥ï¼š Default methods enable you to add new functionality to the interfaces of your libraries and ensure binary compatibility with code written for older versions of those interfaces. ç®€å•æ¥è¯´å°±æ˜¯ï¼šé»˜è®¤æ–¹æ³•å…è®¸ä½ åœ¨ä½ çš„ç±»åº“ä¸­å‘æ¥å£æ·»åŠ æ–°çš„åŠŸèƒ½ï¼Œå¹¶ç¡®ä¿æ–°å¢çš„é»˜è®¤æ–¹æ³•ä¸è¿™äº›æ¥å£çš„è¾ƒæ—©ç‰ˆæœ¬ç¼–å†™çš„ä»£ç äºŒè¿›åˆ¶å…¼å®¹ã€‚ æ¥å£é»˜è®¤æ–¹æ³•ï¼ˆä¸‹ç§°é»˜è®¤æ–¹æ³•ï¼‰é€šè¿‡defaultå…³é”®å­—å£°æ˜ï¼Œå¯ä»¥ç›´æ¥åœ¨æ¥å£ä¸­ç¼–å†™æ–¹æ³•ä½“ã€‚ä¹Ÿå°±æ˜¯é»˜è®¤æ–¹æ³•æ—¢å£°æ˜äº†æ–¹æ³•ï¼Œä¹Ÿå®ç°äº†æ–¹æ³•ã€‚è¿™ä¸€ç‚¹å¾ˆé‡è¦ï¼Œåœ¨é»˜è®¤æ–¹æ³•ç‰¹æ€§å‡ºç°ä¹‹å‰ï¼ŒJavaç¼–ç¨‹è¯­è¨€è§„èŒƒä¸­ï¼Œæ¥å£çš„æœ¬è´¨å°±æ˜¯æ–¹æ³•å£°æ˜çš„é›†åˆä½“ï¼Œè€Œè‡ªé»˜è®¤æ–¹æ³•ç‰¹æ€§å‡ºç°ä¹‹åï¼Œæ¥å£çš„æœ¬è´¨ä¹Ÿæ”¹å˜äº†ã€‚é»˜è®¤æ–¹æ³•çš„ä¸€ä¸ªä¾‹å­å¦‚ä¸‹ï¼š 123456789101112131415161718public interface DefaultMethod &#123; default void defaultVoidMethod() &#123; &#125; default String sayHello(String name) &#123; return String.format(\"%s say hello!\", name); &#125; static void main(String[] args) throws Exception &#123; class Impl implements DefaultMethod &#123; &#125; DefaultMethod defaultMethod = new Impl(); System.out.println(defaultMethod.sayHello(\"throwable\")); // throwable say hello! &#125;&#125; å¦‚æœç»§æ‰¿ä¸€ä¸ªå®šä¹‰äº†é»˜è®¤æ–¹æ³•çš„æ¥å£ï¼Œé‚£ä¹ˆå¯ä»¥æœ‰å¦‚ä¸‹çš„åšæ³•ï¼š å®Œå…¨å¿½ç•¥çˆ¶æ¥å£çš„é»˜è®¤æ–¹æ³•ï¼Œé‚£ä¹ˆç›¸å½“äºç›´æ¥ç»§æ‰¿çˆ¶æ¥å£çš„é»˜è®¤æ–¹æ³•çš„å®ç°ï¼ˆæ–¹æ³•ç»§æ‰¿ï¼‰ã€‚ é‡æ–°å£°æ˜é»˜è®¤æ–¹æ³•ï¼Œè¿™é‡Œç‰¹æŒ‡å»æ‰defaultå…³é”®å­—ï¼Œç”¨public abstractå…³é”®å­—é‡æ–°å£°æ˜å¯¹åº”çš„æ–¹æ³•ï¼Œç›¸å½“äºè®©é»˜è®¤æ–¹æ³•è½¬å˜ä¸ºæŠ½è±¡æ–¹æ³•ï¼Œå­ç±»éœ€è¦è¿›è¡Œå®ç°ï¼ˆæ–¹æ³•æŠ½è±¡ï¼‰ã€‚ é‡æ–°å®šä¹‰é»˜è®¤æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯ç›´æ¥è¦†ç›–çˆ¶æ¥å£ä¸­çš„å®ç°ï¼ˆæ–¹æ³•è¦†ç›–ï¼‰ã€‚ ç»“åˆå‰é¢ä¸€èŠ‚æåˆ°çš„å‡½æ•°å¼æ¥å£ï¼Œè¿™é‡Œå¯ä»¥ç»¼åˆå¾—å‡ºä¸€ä¸ªç»“è®ºï¼šå‡½æ•°å¼æ¥å£ï¼Œä¹Ÿå°±æ˜¯æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªæŠ½è±¡æ–¹æ³•çš„æ¥å£ï¼Œå¯ä»¥å®šä¹‰0ä¸ªæˆ–è€…Nï¼ˆN &gt;= 1ï¼‰ä¸ªé»˜è®¤æ–¹æ³•ã€‚è¿™ä¸€ç‚¹æ­£æ˜¯Streamç‰¹æ€§å¼•å…¥çš„ç†è®ºåŸºç¡€ã€‚ä¸¾ä¸ªä¾‹å­ï¼š 12345678910111213@FunctionalInterfacepublic interface CustomFunctionalInterface &#123; public abstract void process(); default void defaultVoidMethod() &#123; &#125; default String sayHello(String name) &#123; return String.format(\"%s say hello!\", name); &#125;&#125; è¿™é‡Œè¯´ç‚¹é¢˜å¤–è¯ã€‚ åœ¨å†™è¿™ç¯‡æ–‡ç« çš„æ—¶å€™ï¼Œç¬”è€…æƒ³èµ·äº†ä¸€ä¸ªå‰åŒäº‹è¯´è¿‡çš„è¯ï¼Œå¤§æ„å¦‚ä¸‹ï¼šåœ¨è½¯ä»¶å·¥ç¨‹ä¸­ï¼Œå¦‚æœä»é›¶åšèµ·ï¼Œä»»ä½•æ–°åŠŸèƒ½çš„å¼€å‘éƒ½æ˜¯ååˆ†ç®€å•çš„ï¼Œå›°éš¾çš„æ˜¯åœ¨å…¼å®¹æ‰€æœ‰å†å²åŠŸèƒ½çš„å‰æä¸‹è¿›è¡Œæ–°åŠŸèƒ½çš„è¿­ä»£ã€‚è¯•æƒ³ä¸€ä¸‹ï¼ŒJavaè¿­ä»£åˆ°ä»Šå¤©å·²ç»è¿‡å»åå¤šå¹´äº†ï¼ŒHotspot VMæºç å·¥ç¨‹å·²ç»ååˆ†åºå¤§ï¼ˆæ‰‹åŠ¨ç¼–è¯‘è¿‡OpenJDK Hotspot VMæºç çš„äººéƒ½çŸ¥é“è¿‡ç¨‹çš„ç—›è‹¦ï¼‰ï¼Œä»»ä½•æ–°å¢çš„ç‰¹æ€§éƒ½è¦å‘å‰å…¼å®¹ï¼Œå¦åˆ™å¾ˆå¤šç”¨äº†å†å²ç‰ˆæœ¬çš„Javaåº”ç”¨ä¼šæ— æ³•å‡çº§æ–°çš„JDKç‰ˆæœ¬ã€‚æ—¢è¦äºŒè¿›åˆ¶å‘å‰å…¼å®¹ï¼Œåˆè¦è¿­ä»£å‡ºæ–°çš„ç‰¹æ€§ï¼ŒJavaéœ€è¦è¿›è¡Œèˆå¤ºï¼Œé»˜è®¤æ–¹æ³•å°±æ˜¯ä¸€ä¸ªä¾‹å­ï¼Œå¿…é¡»èˆå»æ¥å£åªèƒ½å®šä¹‰æŠ½è±¡æ–¹æ³•è¿™ä¸ªå»¶ç»­äº†å¤šå¹´åœ¨Javaå¼€å‘è€…ä¸­æ ¹æ·±è’‚å›ºçš„æ¦‚å¿µï¼Œå¤ºå–äº†åŸºäºé»˜è®¤æ–¹æ³•å®ç°æ„ç­‘å‡ºæ¥çš„æµå¼ç¼–ç¨‹ä½“ç³»ã€‚ç¬”è€…æœ‰æ—¶å€™ä¹Ÿåœ¨æ€è€ƒï¼šå¦‚æœè¦æˆ‘å»å¼€å‘Streamè¿™ä¸ªæ–°ç‰¹æ€§ï¼Œæˆ‘ä¼šæ€ä¹ˆåšæˆ–è€…æˆ‘èƒ½æ€ä¹ˆåšï¼Ÿ åµŒå¥—ç±»(Nested Classes) åµŒå¥—ç±»ï¼ˆNested Classesï¼‰ï¼Œç®€å•æ¥è¯´å°±æ˜¯ï¼šåœ¨ä¸€ä¸ªç±»ä¸­å®šä¹‰å¦ä¸€ä¸ªç±»ï¼Œé‚£ä¹ˆåœ¨ç±»å†…è¢«å®šä¹‰çš„é‚£ä¸ªç±»å°±æ˜¯åµŒå¥—ç±»ï¼Œæœ€å¤–å±‚çš„ç±»ä¸€èˆ¬ç§°ä¸ºå°é—­ç±»ï¼ˆEnclosing Classï¼‰ã€‚åµŒå¥—ç±»ä¸»è¦åˆ†ä¸ºä¸¤ç§ï¼šé™æ€åµŒå¥—ç±»å’Œéé™æ€åµŒå¥—ç±»ï¼Œè€Œéé™æ€åµŒå¥—ç±»åˆç§°ä¸ºå†…éƒ¨ç±»ï¼ˆInner Classesï¼‰ã€‚ 12345678910111213// å°é—­ç±»class OuterClass &#123; ... // é™æ€åµŒå¥—ç±» static class StaticNestedClass &#123; ... &#125; // å†…éƒ¨ç±» class InnerClass &#123; ... &#125;&#125; é™æ€åµŒå¥—ç±»å¯ä»¥ç›´æ¥ä½¿ç”¨å°é—­çš„ç±»åç§°å»è®¿é—®ä¾‹å¦‚ï¼šOuterClass.StaticNestedClass x = new OuterClass.StaticNestedClass();ï¼Œè¿™ç§ä½¿ç”¨å½¢å¼å’Œä¸€èˆ¬ç±»å®ä¾‹åŒ–åŸºæœ¬æ²¡æœ‰åŒºåˆ«ã€‚ å†…éƒ¨ç±»å®ä¾‹çš„å­˜åœ¨å¿…é¡»ä¾èµ–äºå°é—­ç±»å®ä¾‹çš„å­˜åœ¨ï¼Œå¹¶ä¸”å†…éƒ¨ç±»å¯ä»¥ç›´æ¥è®¿é—®å°é—­ç±»çš„ä»»æ„å±æ€§å’Œæ–¹æ³•ï¼Œç®€å•æ¥è¯´å°±æ˜¯å†…éƒ¨ç±»çš„å®ä¾‹åŒ–å¿…é¡»åœ¨å°é—­ç±»å®ä¾‹åŒ–ä¹‹åï¼Œå¹¶ä¸”ä¾èµ–äºå°é—­ç±»çš„å®ä¾‹ï¼Œå£°æ˜çš„è¯­æ³•æœ‰ç‚¹å¥‡ç‰¹ï¼š 1234567891011121314151617181920212223242526public class OuterClass &#123; int x = 1; static class StaticNestedClass &#123; &#125; class InnerClass &#123; // å†…éƒ¨ç±»å¯ä»¥è®¿é—®å°é—­ç±»çš„å±æ€§ int y = x; &#125; public static void main(String[] args) throws Exception &#123; OuterClass outerClass = new OuterClass(); // å¿…é¡»è¿™æ ·å®ä¾‹åŒ–å†…éƒ¨ç±» - å£°æ˜çš„è¯­æ³•ç›¸å¯¹å¥‡ç‰¹ OuterClass.InnerClass innerClass = outerClass.new InnerClass(); // é™æ€åµŒå¥—ç±»å¯ä»¥ä¸€èˆ¬å®ä¾‹åŒ–,å½¢å¼ä¸º:å°é—­ç±».é™æ€åµŒå¥—ç±» OuterClass.StaticNestedClass staticNestedClass = new OuterClass.StaticNestedClass(); // å¦‚æœmainæ–¹æ³•åœ¨å°é—­ç±»å†…,å¯ä»¥ç›´æ¥ä½¿ç”¨é™æ€åµŒå¥—ç±»è¿›è¡Œå®ä¾‹åŒ– StaticNestedClass x = new StaticNestedClass(); &#125;&#125; å†…éƒ¨ç±»ä¸­æœ‰ä¸¤ç§ç‰¹æ®Šçš„ç±»å‹ï¼šæœ¬åœ°ç±»(Local Classes)å’ŒåŒ¿åç±»(Anonymous Classes)ã€‚ æœ¬åœ°ç±»æ˜¯ä¸€ç§å£°æ˜åœ¨ä»»æ„å—ï¼ˆblockï¼‰çš„ç±»ï¼Œä¾‹å¦‚å£°æ˜åœ¨ä»£ç å—ã€é™æ€ä»£ç å—ã€å®ä¾‹æ–¹æ³•æˆ–è€…é™æ€æ–¹æ³•ä¸­ï¼Œå®ƒå¯ä»¥è®¿é—®å°é—­ç±»çš„æ‰€æœ‰æˆå‘˜å±æ€§å’Œæ–¹æ³•ï¼Œå®ƒçš„ä½œç”¨åŸŸå°±æ˜¯å—å†…ï¼Œä¸èƒ½åœ¨å—å¤–ä½¿ç”¨ã€‚ä¾‹å¦‚ï¼š 12345678910111213141516171819202122232425262728public class OuterClass &#123; static int y = 1; &#123; // æœ¬åœ°ç±»A class A&#123; int z = y; &#125; A a = new A(); &#125; static &#123; // æœ¬åœ°ç±»B class B&#123; int z = y; &#125; B b = new B(); &#125; private void method()&#123; // æœ¬åœ°ç±»C class C&#123; int z = y; &#125; C c = new C(); &#125;&#125; åŒ¿åç±»å¯ä»¥è®©ä»£ç æ›´åŠ ç®€æ˜ï¼Œå…è®¸ä½¿ç”¨è€…åœ¨å®šä¹‰ç±»çš„åŒæ—¶äºˆä»¥å®ç°ï¼ŒåŒ¿åç±»å’Œå…¶ä»–å†…éƒ¨ç±»ä¸åŒçš„åœ°æ–¹æ˜¯ï¼šå®ƒæ˜¯ä¸€ç§è¡¨è¾¾å¼ï¼Œè€Œä¸æ˜¯ç±»å£°æ˜ã€‚ä¾‹å¦‚ï¼š 1234567891011121314151617181920212223public class OuterClass &#123; interface In &#123; void method(String value); &#125; public void sayHello()&#123; // æœ¬åœ°ç±» - ç±»å£°æ˜ class LocalClass&#123; &#125; // åŒ¿åç±» - æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼ In in = new In() &#123; @Override public void method(String value) &#123; &#125; &#125;; &#125;&#125; å¦‚æœç”¨Javaåšè¿‡GUIå¼€å‘ï¼ŒåŒ¿åç±»åœ¨Swingæˆ–è€…JavaFxçš„äº‹ä»¶å›è°ƒä¸­å¤§é‡ä½¿ç”¨ï¼Œç»å¸¸ä¼šçœ‹åˆ°ç±»ä¼¼è¿™æ ·çš„ä»£ç ï¼š 1234567JButton button = new JButton();button.addActionListener(new AbstractAction() &#123; @Override public void actionPerformed(ActionEvent e) &#123; System.out.println(\"æŒ‰é’®äº‹ä»¶è¢«è§¦å‘...\"); &#125;&#125;); åµŒå¥—ç±»çš„ç±»å‹å…³ç³»å›¾å¦‚ä¸‹ï¼š 123456Nested Classes - Static Nested Classes - None Nested Classes - Local Classes - Anonymous Classes - Other Inner Classes Lambdaè¡¨è¾¾å¼ ä¸‹é¢æ˜¯æ¥è‡ªæŸæœç´¢å¼•æ“ç™¾ç§‘å…³äºLambdaè¡¨è¾¾å¼çš„å®šä¹‰ï¼š Lambdaè¡¨è¾¾å¼ï¼ˆLambda Expressionï¼‰æ˜¯ä¸€ä¸ªåŒ¿åå‡½æ•°ï¼ŒLambdaè¡¨è¾¾å¼åŸºäºæ•°å­¦ä¸­çš„Î»æ¼”ç®—å¾—åï¼Œç›´æ¥å¯¹åº”äºå…¶ä¸­çš„LambdaæŠ½è±¡ï¼ˆLambda Abstractionï¼‰ï¼Œæ˜¯ä¸€ä¸ªåŒ¿åå‡½æ•°ï¼Œå³æ²¡æœ‰å‡½æ•°åçš„å‡½æ•°ã€‚Lambdaè¡¨è¾¾å¼å¯ä»¥è¡¨ç¤ºé—­åŒ…ï¼ˆæ³¨æ„å’Œæ•°å­¦ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„ä¸åŒï¼‰ã€‚ Javaä¸­çš„Lambdaè¡¨è¾¾å¼ï¼ˆä¸‹é¢ç§°Lambdaï¼‰è¡¨é¢ä¸Šå’Œä¸Šé¢çš„å®šä¹‰ç±»ä¼¼ï¼Œæœ¬è´¨ä¹Ÿæ˜¯åŒ¿åå‡½æ•°ï¼Œä½†å…¶å®ç°åŸç†åŒºåˆ«äºä¸€èˆ¬çš„åŒ¿åç±»ä¸­çš„åŒ¿åå‡½æ•°å®ç°ï¼Œå¥¹æ˜¯JDK8å¼•å…¥çš„ä¸€é¢—æ–°çš„è¯­æ³•ç³–ã€‚ å¼•å…¥Lambdaè¡¨è¾¾å¼çš„åˆè¡· å¦‚æœä¸€ä¸ªæ¥å£åªåŒ…å«ä¸€ä¸ªæ–¹æ³•ï¼Œé‚£ä¹ˆåŒ¿åç±»çš„è¯­æ³•ä¼šå˜å¾—ååˆ†ç¬¨æ‹™å’Œä¸æ¸…æ¥šï¼Œäº§ç”Ÿå¤§é‡çš„æ¨¡æ¿ä»£ç ï¼Œå½’ç»“ä¸€ä¸‹å°±æ˜¯ï¼šä»£ç å†—ä½™æ˜¯åŒ¿åç±»çš„æœ€å¤§å¼Šç«¯ã€‚åœ¨ç¼–ç¨‹çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¾ˆå¤šæ—¶å€™å¸Œæœ›æŠŠåŠŸèƒ½ä½œä¸ºå‚æ•°ä¼ é€’åˆ°å¦ä¸€ä¸ªæ–¹æ³•ï¼ŒLambdaå°±æ˜¯ä¸ºæ­¤è€Œç”Ÿï¼ŒLambdaå…è®¸ä½¿ç”¨è€…å°†åŠŸèƒ½è§†ä¸ºæ–¹æ³•å‚æ•°ï¼Œå°†ä»£ç è§†ä¸ºæ•°æ®ã€‚å¼•å…¥Lambdaå¸¦æ¥äº†å¦‚ä¸‹ä¼˜åŠ¿ï¼š ç®€åŒ–ä»£ç ï¼Œå¼•å…¥äº†å¼ºå¤§çš„ç±»å‹æ¨æ–­å’Œæ–¹æ³•å¼•ç”¨ç‰¹æ€§ï¼Œç®€å•çš„åŠŸèƒ½ç”šè‡³å¯ä»¥ä¸€è¡Œä»£ç è§£å†³ï¼Œè§£æ”¾åŒ¿åç±»çš„æŸç¼šã€‚ æŠŠåŠŸèƒ½ä½œä¸ºå‚æ•°å‘ä¸‹ä¼ é€’ï¼Œä¸ºå‡½æ•°å¼ç¼–ç¨‹æä¾›äº†æ”¯æŒã€‚ è‡³æ­¤è¿˜å¾—å‡ºä¸€ä¸ªç»“è®ºï¼šLambdaåªé€‚ç”¨äºå‡½æ•°å¼æ¥å£å¯¹åº”å”¯ä¸€æŠ½è±¡æ–¹æ³•çš„å®ç°ã€‚ Lambdaè¡¨è¾¾å¼çš„è¯­æ³•å®šä¹‰ Lambdaè¯­æ³•çš„è¯¦ç»†å®šä¹‰å¦‚ä¸‹ï¼š 12345// en_USInterfaceType interfaceObject = [Method Argument List] -&gt; Method Body// zh_CNæ¥å£ç±»å‹ æ¥å£å®ä¾‹ = [æ–¹æ³•å‚æ•°åˆ—è¡¨] -&gt; æ–¹æ³•ä½“ æ›´å…·ä½“çš„æè¿°åº”è¯¥æ˜¯ï¼š æ¥å£ç±»å‹ æ¥å£å®ä¾‹ä¸´æ—¶å˜é‡ = (æ–¹æ³•å‚æ•°ç±»å‹X æ–¹æ³•å‚æ•°ç±»å‹Xä¸´æ—¶å˜é‡ , æ–¹æ³•å‚æ•°ç±»å‹Y æ–¹æ³•å‚æ•°ç±»å‹Yä¸´æ—¶å˜é‡...) -&gt; { æ–¹æ³•ä½“... return æ¥å£æŠ½è±¡æ–¹æ³•è¿”å›å€¼å¯¹åº”ç±»å‹ç±»å‹å®ä¾‹;} ä¸€ä¸ªLambdaè¡¨è¾¾å¼ç”±äº”ä¸ªéƒ¨åˆ†ç»„æˆï¼š è¿”å›å€¼ï¼šæ¥å£ç±»å‹ä»¥åŠæ¥å£ç±»å‹å¯¹åº”çš„ä¸´æ—¶å®ä¾‹å˜é‡ã€‚ ç­‰å·ï¼š=ã€‚ æ–¹æ³•å‚æ•°åˆ—è¡¨ï¼šä¸€èˆ¬ç”±ä¸­æ‹¬å·()åŒ…è£¹ï¼Œæ ¼å¼æ˜¯(ç±»å‹1 ç±»å‹1çš„ä¸´æ—¶å˜é‡,...,ç±»å‹N ç±»å‹Nçš„ä¸´æ—¶å˜é‡)ï¼Œåœ¨æ–¹æ³•æ²¡æœ‰é‡è½½å¯ä»¥æ˜ç¡®æ¨æ–­å‚æ•°ç±»å‹çš„æ—¶å€™ï¼Œå‚æ•°ç±»å‹å¯ä»¥çœç•¥ï¼Œåªç•™ä¸‹ä¸´æ—¶å˜é‡åˆ—è¡¨ã€‚ç‰¹æ®Šåœ°ï¼Œç©ºå‚æ•°åˆ—è¡¨ç”¨()è¡¨ç¤ºï¼Œå¦‚æœå‚æ•°åªæœ‰ä¸€ä¸ªï¼Œå¯ä»¥çœç•¥()ã€‚ ç®­å¤´ï¼š-&gt;ã€‚ æ–¹æ³•ä½“ï¼šä¸€èˆ¬ç”±èŠ±æ‹¬å·{}åŒ…è£¹ï¼Œæ ¼å¼æ˜¯{æ–¹æ³•é€»è¾‘... return å‡½æ•°å¼æ¥å£æ–¹æ³•è¿”å›å€¼ç±»å‹çš„å€¼;}ï¼Œæœ‰å‡ ç‚¹éœ€è¦æ³¨æ„ï¼š å¦‚æœæ–¹æ³•ä½“æ˜¯ç©ºå®ç°ï¼Œç”¨{}è¡¨ç¤ºï¼Œå¦‚Runnable runnable = () -&gt; {};ã€‚ å¦‚æœå‡½æ•°å¼æ¥å£æŠ½è±¡æ–¹æ³•çš„è¿”å›å€¼ä¸ºvoidç±»å‹ï¼Œåˆ™ä¸éœ€è¦returnå…³é”®å­—è¯­å¥ï¼Œå¦‚Runnable runnable = () -&gt; {int i=0; i++;};ã€‚ å¦‚æœå‡½æ•°å¼æ¥å£æŠ½è±¡æ–¹æ³•çš„æ–¹æ³•ä½“ä»…ä»…åŒ…å«ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œåˆ™ä¸éœ€è¦ä½¿ç”¨{}åŒ…è£¹ï¼Œå¦‚Runnable runnable = () -&gt; System.out.println(&quot;Hello World!&quot;);ã€‚ ä¸¾ä¸€äº›ä¾‹å­ï¼š 1234567891011121314151617181920// Function - å…·ä½“java.util.function.Function&lt;String, Integer&gt; functionY = (String string) -&gt; &#123; return Integer.parseInt(string);&#125;;// Function - ç®€åŒ–java.util.function.Function&lt;String, Integer&gt; functionX = string -&gt; Integer.parseInt(string);// Runnable - å…·ä½“Runnable runnableX = () -&gt; &#123; System.out.println(\"Hello World!\");&#125;;// Runnable - ç®€åŒ–Runnable runnableY = () -&gt; System.out.println(\"Hello World!\");// æ•´æ•°1-100çš„å’Œ - å…·ä½“int reduceX = IntStream.range(1, 101).reduce(0, (int addend, int augend) -&gt; &#123; return addend + augend;&#125;);// æ•´æ•°1-100çš„å’Œ - ç®€åŒ–int reduceY = IntStream.range(1, 101).reduce(0, Integer::sum); ç›®æ ‡ç±»å‹ä¸ç±»å‹æ¨æ–­ å…ˆå¼•å…¥ä¸‹é¢çš„ä¸€ä¸ªåœºæ™¯ï¼š 12345678910111213// club.throwable.Runnable@FunctionalInterfacepublic interface Runnable &#123; void run(); static void main(String[] args) throws Exception &#123; java.lang.Runnable langRunnable = () -&gt; &#123;&#125;; club.throwable.Runnable customRunnable = () -&gt; &#123;&#125;; langRunnable.run(); customRunnable.run(); &#125;&#125; ç¬”è€…å®šä¹‰äº†ä¸€ä¸ªå’Œjava.lang.Runnableå®Œå…¨ä¸€è‡´çš„å‡½æ•°å¼æ¥å£club.throwable.Runnableï¼Œä¸Šé¢main()æ–¹æ³•ä¸­ï¼Œå¯ä»¥çœ‹åˆ°ä¸¤ä¸ªæ¥å£å¯¹åº”çš„Lambdaè¡¨è¾¾å¼çš„æ–¹æ³•ä½“å®ç°ä¹Ÿæ˜¯å®Œå…¨ä¸€è‡´ï¼Œä½†æ˜¯å¾ˆæ˜æ˜¾æœ€ç»ˆå¯ä»¥ä½¿ç”¨ä¸åŒç±»å‹çš„æ¥å£å»æ¥æ”¶è¿”å›å€¼ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸¤ä¸ªLambdaçš„ç±»å‹æ˜¯ä¸ç›¸åŒçš„ã€‚è€Œè¿™ä¸¤ä¸ªLambdaè¡¨è¾¾å¼è¿”å›å€¼çš„ç±»å‹æ˜¯æˆ‘ä»¬æœ€ç»ˆæœŸå¾…çš„è¿”å›å€¼ç±»å‹ï¼ˆexpecting a data type of XXï¼‰ï¼Œé‚£ä¹ˆLambdaè¡¨è¾¾å¼å°±æ˜¯å¯¹åº”çš„è¢«æœŸå¾…çš„ç±»å‹ï¼Œè¿™ä¸ªè¢«æœŸå¾…çš„ç±»å‹å°±æ˜¯Lambdaè¡¨è¾¾å¼çš„ç›®æ ‡ç±»å‹ã€‚ ä¸ºäº†ç¡®å®šLambdaè¡¨è¾¾å¼çš„ç›®æ ‡ç±»å‹ï¼ŒJavaç¼–è¯‘å™¨ä¼šåŸºäºå¯¹åº”çš„Lambdaè¡¨è¾¾å¼ï¼Œä½¿ç”¨ä¸Šä¸‹æ–‡æˆ–è€…åœºæ™¯è¿›è¡Œç»¼åˆæ¨å¯¼ï¼Œåˆ¤æ–­çš„ä¸€ä¸ªå› ç´ å°±æ˜¯ä¸Šä¸‹æ–‡ä¸­å¯¹è¯¥Lambdaè¡¨è¾¾å¼æ‰€æœŸå¾…çš„ç±»å‹ã€‚å› æ­¤ï¼Œåªèƒ½åœ¨Javaç¼–è¯‘å™¨èƒ½å¤Ÿæ­£ç¡®æ¨æ–­Lambdaè¡¨è¾¾å¼ç›®æ ‡ç±»å‹çš„åœºæ™¯ä¸‹æ‰èƒ½ä½¿ç”¨Lambdaè¡¨è¾¾å¼ï¼Œè¿™äº›åœºæ™¯åŒ…æ‹¬ï¼š å˜é‡å£°æ˜ã€‚ èµ‹å€¼ã€‚ è¿”å›è¯­å¥ã€‚ æ•°ç»„åˆå§‹åŒ–å™¨ã€‚ Lambdaè¡¨è¾¾å¼å‡½æ•°ä½“ã€‚ æ¡ä»¶è¡¨è¾¾å¼ï¼ˆcondition ? processIfTrue() : processIfFalse()ï¼‰ã€‚ ç±»å‹è½¬æ¢ï¼ˆCastï¼‰è¡¨è¾¾å¼ã€‚ Lambdaè¡¨è¾¾å¼é™¤äº†ç›®æ ‡ç±»å‹ï¼Œè¿˜åŒ…å«å‚æ•°åˆ—è¡¨å’Œæ–¹æ³•ä½“ï¼Œè€Œæ–¹æ³•ä½“éœ€è¦ä¾èµ–äºå‚æ•°åˆ—è¡¨è¿›è¡Œå®ç°ï¼Œæ‰€ä»¥æ–¹æ³•å‚æ•°ä¹Ÿæ˜¯å†³å®šç›®æ ‡ç±»å‹çš„ä¸€ä¸ªå› ç´ ã€‚ æ–¹æ³•å‚æ•°çš„ç±»å‹æ¨å¯¼çš„è¿‡ç¨‹ä¸»è¦ä¾èµ–äºä¸¤ä¸ªè¯­è¨€ç‰¹æ€§ï¼šé‡è½½è§£æï¼ˆOverload Resolutionï¼‰å’Œå‚æ•°ç±»å‹æ¨å¯¼ï¼ˆType Argument Inferenceï¼‰ã€‚ åŸæ–‡ï¼šFor method arguments, the Java compiler determines the target type with two other language features: overload resolution and type argument inference é‡è½½è§£æä¼šä¸ºä¸€ä¸ªç»™å®šçš„æ–¹æ³•è°ƒç”¨ï¼ˆMethod Invocationï¼‰å¯»æ‰¾æœ€åˆé€‚çš„æ–¹æ³•å£°æ˜ï¼ˆMethod Declarationï¼‰ã€‚ç”±äºä¸åŒçš„å£°æ˜å…·æœ‰ä¸åŒçš„ç­¾åï¼Œå½“Lambdaè¡¨è¾¾å¼ä½œä¸ºæ–¹æ³•å‚æ•°æ—¶ï¼Œé‡è½½è§£æå°±ä¼šå½±å“åˆ°Lambdaè¡¨è¾¾å¼çš„ç›®æ ‡ç±»å‹ã€‚ç¼–è¯‘å™¨ä¼šæ ¹æ®å®ƒå¯¹è¯¥Lambdaè¡¨è¾¾å¼çš„æ‰€æä¾›çš„ä¿¡æ¯çš„ç†è§£åšå‡ºå†³å®šã€‚å¦‚æœLambdaè¡¨è¾¾å¼å…·æœ‰æ˜¾å¼ç±»å‹ï¼ˆå‚æ•°ç±»å‹è¢«æ˜¾å¼æŒ‡å®šï¼‰ï¼Œç¼–è¯‘å™¨å°±å¯ä»¥ç›´æ¥ä½¿ç”¨Lambdaè¡¨è¾¾å¼çš„è¿”å›ç±»å‹ï¼›å¦‚æœLambdaè¡¨è¾¾å¼å…·æœ‰éšå¼ç±»å‹ï¼ˆå‚æ•°ç±»å‹è¢«æ¨å¯¼è€ŒçŸ¥ï¼‰ï¼Œé‡è½½è§£æåˆ™ä¼šå¿½ç•¥Lambdaè¡¨è¾¾å¼å‡½æ•°ä½“è€Œåªä¾èµ–Lambdaè¡¨è¾¾å¼å‚æ•°çš„æ•°é‡ã€‚ ä¸¾ä¸ªä¾‹å­ï¼š 12345// æ˜¾å¼ç±»å‹Function&lt;String, String&gt; functionX = (String x) -&gt; x;// éšå¼ç±»å‹Function&lt;String, Integer&gt; functionY = x -&gt; Integer.parseInt(x); å¦‚æœä¾èµ–äºæ–¹æ³•å‚æ•°çš„ç±»å‹æ¨å¯¼æœ€ä½³æ–¹æ³•å£°æ˜æ—¶å­˜åœ¨äºŒä¹‰æ€§ï¼ˆAmbiguousï¼‰ï¼Œæˆ‘ä»¬å°±éœ€è¦åˆ©ç”¨è½¬å‹ï¼ˆCastï¼‰æˆ–æ˜¾å¼Lambdaè¡¨è¾¾å¼æ¥æä¾›æ›´å¤šçš„ç±»å‹ä¿¡æ¯ï¼Œä»è€ŒLambdaè¡¨è¾¾å¼çš„ç›®æ ‡ç±»å‹ã€‚ä¸¾ä¸ªä¾‹å­ï¼š 12345678910111213// ç¼–è¯‘ä¸é€šè¿‡Object runnableX = () -&gt; &#123;&#125;;// ç¼–è¯‘é€šè¿‡ - CastObject runnableY = (Runnable) () -&gt; &#123;&#125;;// é™æ€æ–¹æ³•å…¥å‚ç±»å‹æ˜¯å‡½æ•°å¼æ¥å£public static void function(java.util.function.Function function) &#123;&#125;function((Function&lt;String, Long&gt;) (x) -&gt; Long.parseLong(x)); ä½œç”¨åŸŸ å…³äºä½œç”¨åŸŸçš„é—®é¢˜è®°ä½å‡ ç‚¹å³å¯ï¼š &lt;1&gt;ï¼šLambdaè¡¨è¾¾å¼å†…çš„thiså¼•ç”¨å’Œå°é—­ç±»çš„thiså¼•ç”¨ç›¸åŒã€‚ &lt;2&gt;ï¼šLambdaè¡¨è¾¾å¼åŸºäºè¯æ³•ä½œç”¨åŸŸï¼Œå®ƒä¸ä¼šä»è¶…ç±»ä¸­ç»§æ‰¿ä»»ä½•å˜é‡ï¼Œæ–¹æ³•ä½“é‡Œé¢çš„å˜é‡å’Œå®ƒå¤–éƒ¨ç¯å¢ƒçš„å˜é‡å…·æœ‰ç›¸åŒçš„è¯­ä¹‰ã€‚ &lt;3&gt;ï¼šLambda expressions close over values, not variablesï¼Œä¹Ÿå°±æ˜¯Lambdaè¡¨è¾¾å¼å¯¹å€¼ç±»å‹å°é—­ï¼Œå¯¹å˜é‡ï¼ˆå¼•ç”¨ï¼‰ç±»å‹å¼€æ”¾ï¼ˆè¿™ä¸€ç‚¹æ­£å¥½è§£é‡Šäº†Lambdaè¡¨è¾¾å¼å†…éƒ¨å¼•ç”¨å¤–éƒ¨çš„å±æ€§çš„æ—¶å€™ï¼Œè¯¥å±æ€§å¿…é¡»å®šä¹‰ä¸ºfinalï¼‰ã€‚ å¯¹äºç¬¬&lt;1&gt;ç‚¹ä¸¾ä¸ªä¾‹å­ï¼š 123456789101112131415161718public class LambdaThis &#123; int x = 1; public void method() &#123; Runnable runnable = () -&gt; &#123; int y = this.x; y++; System.out.println(y); &#125;; runnable.run(); &#125; public static void main(String[] args) throws Exception &#123; LambdaThis lambdaThis = new LambdaThis(); lambdaThis.method(); // 2 &#125;&#125; å¯¹äºç¬¬&lt;2&gt;ç‚¹ä¸¾ä¸ªä¾‹å­ï¼š 1234567891011public class LambdaScope &#123; public void method() &#123; int x = 1; Runnable runnable = () -&gt; &#123; // ç¼–è¯‘ä¸é€šè¿‡ - Lambdaæ–¹æ³•ä½“å¤–éƒ¨å·²ç»å®šä¹‰äº†åŒåå˜é‡ int x = 2; &#125;; runnable.run(); &#125;&#125; å¯¹äºç¬¬&lt;3&gt;ç‚¹ä¸¾ä¸ªä¾‹å­ï¼š 12345678910111213141516171819202122232425262728public class LambdaValue &#123; public void method() &#123; (final) int x = 1; Runnable runnable = () -&gt; &#123; // ç¼–è¯‘ä¸é€šè¿‡ - å¤–éƒ¨å€¼ç±»å‹ä½¿ç”¨äº†final x ++; &#125;; runnable.run(); &#125;&#125;public class LambdaValue &#123; public void method() &#123; (final) IntHolder holder = new IntHolder(); Runnable runnable = () -&gt; &#123; // ç¼–è¯‘é€šè¿‡ - ä½¿ç”¨äº†å¼•ç”¨ç±»å‹ holder.x++; &#125;; runnable.run(); &#125; private static class IntHolder &#123; int x = 1; &#125;&#125; æ–¹æ³•å¼•ç”¨ æ–¹æ³•å¼•ç”¨ï¼ˆMethod Referenceï¼‰æ˜¯ä¸€ç§åŠŸèƒ½å’ŒLambdaè¡¨è¾¾å¼ç±»ä¼¼çš„è¡¨è¾¾å¼ï¼Œéœ€è¦ç›®æ ‡ç±»å‹å’Œå®ç°å‡½æ•°å¼æ¥å£ï¼Œä½†æ˜¯è¿™ä¸ªå®ç°å½¢å¼å¹¶ä¸æ˜¯é€šè¿‡æ–¹æ³•ä½“ï¼Œè€Œæ˜¯é€šè¿‡æ–¹æ³•åç§°ï¼ˆæˆ–è€…å…³é”®å­—ï¼‰å…³è”åˆ°ä¸€ä¸ªå·²ç»å­˜åœ¨çš„æ–¹æ³•ï¼Œæœ¬è´¨æ˜¯ç¼–è¯‘å±‚é¢çš„æŠ€æœ¯ï¼Œæ—¨åœ¨è¿›ä¸€æ­¥ç®€åŒ–Lambdaè¡¨è¾¾å¼æ–¹æ³•ä½“å’Œä¸€äº›ç‰¹å®šè¡¨è¾¾å¼çš„å®ç°ã€‚æ–¹æ³•å¼•ç”¨çš„ç±»å‹å½’ç»“å¦‚ä¸‹ï¼š ç±»å‹ ä¾‹å­ é™æ€æ–¹æ³•å¼•ç”¨ ClassName::methodName æŒ‡å®šå¯¹è±¡å®ä¾‹æ–¹æ³•å¼•ç”¨ instanceRef::methodName ç‰¹å®šç±»å‹ä»»æ„å¯¹è±¡æ–¹æ³•å¼•ç”¨ ContainingType::methodName è¶…ç±»æ–¹æ³•å¼•ç”¨ supper::methodName æ„é€ å™¨æ–¹æ³•å¼•ç”¨ ClassName::new æ•°ç»„æ„é€ å™¨æ–¹æ³•å¼•ç”¨ TypeName[]::new å¯è§å…¶åŸºæœ¬å½¢å¼æ˜¯ï¼šæ–¹æ³•å®¹å™¨::æ–¹æ³•åç§°æˆ–è€…å…³é”®å­—ã€‚ ä¸¾ä¸€äº›åŸºæœ¬çš„ä½¿ç”¨ä¾‹å­ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485// é™æ€æ–¹æ³•å¼•ç”¨public class StaticMethodRef &#123; public static void main(String[] args) throws Exception &#123; Function&lt;String, Integer&gt; function = StaticMethodRef::staticMethod; Integer result = function.apply(\"10086\"); System.out.println(result); // 10086 &#125; public static Integer staticMethod(String value) &#123; return Integer.parseInt(value); &#125;&#125;// æŒ‡å®šå¯¹è±¡å®ä¾‹æ–¹æ³•å¼•ç”¨public class ParticularInstanceRef &#123; public Integer refMethod(String value) &#123; return Integer.parseInt(value); &#125; public static void main(String[] args) throws Exception&#123; ParticularInstanceRef ref = new ParticularInstanceRef(); Function&lt;String, Integer&gt; function = ref::refMethod; Integer result = function.apply(\"10086\"); System.out.println(result); // 10086 &#125;&#125;// ç‰¹å®šç±»å‹ä»»æ„å¯¹è±¡æ–¹æ³•å¼•ç”¨String[] stringArray = &#123;\"C\", \"a\", \"B\"&#125;;Arrays.sort(stringArray, String::compareToIgnoreCase);System.out.println(Arrays.toString(stringArray)); // [a, B, C]// è¶…ç±»æ–¹æ³•å¼•ç”¨public class SupperRef &#123; public static void main(String[] args) throws Exception &#123; Sub sub = new Sub(); System.out.println(sub.refMethod(\"10086\")); // 10086 &#125; private static class Supper &#123; private Integer supperRefMethod(String value) &#123; return Integer.parseInt(value); &#125; &#125; private static class Sub extends Supper &#123; private Integer refMethod(String value) &#123; Function&lt;String, Integer&gt; function = super::supperRefMethod; return function.apply(value); &#125; &#125;&#125;// æ„é€ å™¨æ–¹æ³•å¼•ç”¨public class ConstructorRef &#123; public static void main(String[] args) throws Exception &#123; Function&lt;String, Person&gt; function = Person::new; Person person = function.apply(\"doge\"); System.out.println(person.getName()); // doge &#125; private static class Person &#123; private final String name; public Person(String name) &#123; this.name = name; &#125; public String getName() &#123; return name; &#125; &#125;&#125;// æ•°ç»„æ„é€ å™¨æ–¹æ³•å¼•ç”¨Function&lt;Integer, Integer[]&gt; function = Integer[]::new;Integer[] array = function.apply(10);System.out.println(array.length); // 10 Javaä¸­Lambdaçš„åº•å±‚å®ç°åŸç† é‡ç‚¹è¦è¯´ä¸‰æ¬¡ï¼š Lambdaè¡¨è¾¾å¼åº•å±‚ä¸æ˜¯åŒ¿åç±»å®ç°ã€‚ Lambdaè¡¨è¾¾å¼åº•å±‚ä¸æ˜¯åŒ¿åç±»å®ç°ã€‚ Lambdaè¡¨è¾¾å¼åº•å±‚ä¸æ˜¯åŒ¿åç±»å®ç°ã€‚ åœ¨æ·±å…¥å­¦ä¹ Lambdaè¡¨è¾¾å¼ä¹‹å‰ï¼Œç¬”è€…ä¹Ÿæ›¾ç»è®¤ä¸ºLambdaå°±æ˜¯åŒ¿åç±»çš„è¯­æ³•ç³–ï¼š 123456789// LambdaFunction&lt;String, String&gt; functionX = (String x) -&gt; x;// é”™è¯¯è®¤çŸ¥Function&lt;String, String&gt; functionX = new Function&lt;String, String&gt;() &#123; @Override public Void apply(String x) &#123; return x; &#125;&#125; Lambdaå°±æ˜¯åŒ¿åç±»çš„è¯­æ³•ç³–è¿™ä¸ªè®¤çŸ¥æ˜¯é”™è¯¯çš„ã€‚ä¸‹é¢ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œä»æºç å’Œå­—èŠ‚ç çš„è§’åº¦åˆ†æä¸€ä¸‹Lambdaè¡¨è¾¾å¼ç¼–è¯‘å’Œæ‰§è¡Œçš„æ•´ä¸ªæµç¨‹ã€‚ 123456789101112public class Sample &#123; public static void main(String[] args) throws Exception &#123; Runnable runnable = () -&gt; &#123; System.out.println(\"Hello World!\"); &#125;; runnable.run(); String hello = \"Hello \"; Function&lt;String, String&gt; function = string -&gt; hello + string; function.apply(\"Doge\"); &#125;&#125; æ·»åŠ VMå‚æ•°-Djdk.internal.lambda.dumpProxyClasses=.è¿è¡Œä¸Šé¢çš„Sample#main()æ–¹æ³•ï¼Œé¡¹ç›®æ ¹ç›®å½•åŠ¨æ€ç”Ÿæˆäº†ä¸¤ä¸ªç±»å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233import java.lang.invoke.LambdaForm.Hidden;// $FF: synthetic classfinal class Sample$$Lambda$14 implements Runnable &#123; private Sample$$Lambda$14() &#123; &#125; @Hidden public void run() &#123; Sample.lambda$main$0(); &#125;&#125;import java.lang.invoke.LambdaForm.Hidden;import java.util.function.Function;// $FF: synthetic classfinal class Sample$$Lambda$15 implements Function &#123; private final String arg$1; private Sample$$Lambda$15(String var1) &#123; this.arg$1 = var1; &#125; private static Function get$Lambda(String var0) &#123; return new Sample$$Lambda$15(var0); &#125; @Hidden public Object apply(Object var1) &#123; return Sample.lambda$main$1(this.arg$1, (String)var1); &#125;&#125; åæŸ¥ä¸¤ä¸ªç±»çš„å­—èŠ‚ç ï¼Œå‘ç°äº†ç±»ä¿®é¥°ç¬¦ä¸ºfinal syntheticã€‚æ¥ç€ç›´æ¥çœ‹å°é—­ç±»Sampleçš„å­—èŠ‚ç ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283public class club/throwable/Sample &#123; &lt;ClassVersion=52&gt; &lt;SourceFile=Sample.java&gt; public Sample() &#123; // &lt;init&gt; //()V &lt;localVar:index=0 , name=this , desc=Lclub/throwable/Sample;, sig=null, start=L1, end=L2&gt; L1 &#123; aload0 // reference to self invokespecial java/lang/Object.&lt;init&gt;()V return &#125; L2 &#123; &#125; &#125; public static main(java.lang.String[] arg0) throws java/lang/Exception &#123; //([Ljava/lang/String;)V &lt;localVar:index=0 , name=args , desc=[Ljava/lang/String;, sig=null, start=L1, end=L2&gt; &lt;localVar:index=1 , name=runnable , desc=Lclub/throwable/Runnable;, sig=null, start=L3, end=L2&gt; &lt;localVar:index=2 , name=hello , desc=Ljava/lang/String;, sig=null, start=L4, end=L2&gt; &lt;localVar:index=3 , name=function , desc=Ljava/util/function/Function;, sig=Ljava/util/function/Function&lt;Ljava/lang/String;Ljava/lang/String;&gt;;, start=L5, end=L2&gt; L1 &#123; invokedynamic java/lang/invoke/LambdaMetafactory.metafactory(Ljava/lang/invoke/MethodHandles$Lookup;Ljava/lang/String;Ljava/lang/invoke/MethodType;Ljava/lang/invoke/MethodType;Ljava/lang/invoke/MethodHandle;Ljava/lang/invoke/MethodType;)Ljava/lang/invoke/CallSite; : run()Lclub/throwable/Runnable; ()V club/throwable/Sample.lambda$main$0()V (6) ()V astore1 &#125; L3 &#123; aload1 invokeinterface club/throwable/Runnable.run()V &#125; L6 &#123; ldc \"Hello \" (java.lang.String) astore2 &#125; L4 &#123; aload2 invokedynamic java/lang/invoke/LambdaMetafactory.metafactory(Ljava/lang/invoke/MethodHandles$Lookup;Ljava/lang/String;Ljava/lang/invoke/MethodType;Ljava/lang/invoke/MethodType;Ljava/lang/invoke/MethodHandle;Ljava/lang/invoke/MethodType;)Ljava/lang/invoke/CallSite; : apply(Ljava/lang/String;)Ljava/util/function/Function; (Ljava/lang/Object;)Ljava/lang/Object; club/throwable/Sample.lambda$main$1(Ljava/lang/String;Ljava/lang/String;)Ljava/lang/String; (6) (Ljava/lang/String;)Ljava/lang/String; astore3 &#125; L5 &#123; aload3 ldc \"Doge\" (java.lang.String) invokeinterface java/util/function/Function.apply(Ljava/lang/Object;)Ljava/lang/Object; pop &#125; L7 &#123; return &#125; L2 &#123; &#125; &#125; private static synthetic lambda$main$1(java.lang.String arg0, java.lang.String arg1) &#123; //(Ljava/lang/String;Ljava/lang/String;)Ljava/lang/String; &lt;localVar:index=0 , name=hello , desc=Ljava/lang/String;, sig=null, start=L1, end=L2&gt; &lt;localVar:index=1 , name=string , desc=Ljava/lang/String;, sig=null, start=L1, end=L2&gt; L1 &#123; new java/lang/StringBuilder dup invokespecial java/lang/StringBuilder.&lt;init&gt;()V aload0 // reference to arg0 invokevirtual java/lang/StringBuilder.append(Ljava/lang/String;)Ljava/lang/StringBuilder; aload1 invokevirtual java/lang/StringBuilder.append(Ljava/lang/String;)Ljava/lang/StringBuilder; invokevirtual java/lang/StringBuilder.toString()Ljava/lang/String; areturn &#125; L2 &#123; &#125; &#125; private static synthetic lambda$main$0() &#123; //()V L1 &#123; getstatic java/lang/System.out:java.io.PrintStream ldc \"Hello World!\" (java.lang.String) invokevirtual java/io/PrintStream.println(Ljava/lang/String;)V &#125; L2 &#123; return &#125; &#125;// The following inner classes couldn't be decompiled: java/lang/invoke/MethodHandles$Lookup &#125; ä¸Šé¢çš„å­—èŠ‚ç å·²ç»è¢«Bytecode-Viewerå·¥å…·æ ¼å¼åŒ–è¿‡ï¼Œç¬¦åˆäºäººçš„é˜…è¯»ä¹ æƒ¯ï¼Œä»å­—èŠ‚ç çš„é˜…è¯»ï¼Œç»“åˆå‰é¢çš„åˆ†æå¤§æ¦‚å¯ä»¥å¾—å‡ºä¸‹é¢çš„ç»“è®ºï¼š &lt;1&gt;ï¼šLambdaè¡¨è¾¾å¼åœ¨ç¼–è¯‘æœŸé€šè¿‡å­—èŠ‚ç å¢å¼ºæŠ€æœ¯æ–°å¢ä¸€ä¸ªæ¨¡æ¿ç±»å®ç°å¯¹åº”çš„æ¥å£ç±»å‹ï¼Œè¿™ä¸ªæ¨¡æ¿ç±»çš„æ‰€æœ‰å±æ€§éƒ½ä½¿ç”¨finalä¿®é¥°ï¼Œæ¨¡æ¿ç±»ç”±å…³é”®å­—final syntheticä¿®é¥°ã€‚ &lt;2&gt;ï¼šå°é—­ç±»ä¼šåŸºäºç±»å†…çš„Lambdaè¡¨è¾¾å¼ç±»å‹ç”Ÿæˆprivate static syntheticä¿®é¥°çš„é™æ€æ–¹æ³•ï¼Œè¯¥é™æ€æ–¹æ³•çš„æ–¹æ³•ä½“å°±æ˜¯æ¥æºäºLambdaæ–¹æ³•ä½“ï¼Œè¿™äº›é™æ€æ–¹æ³•çš„åç§°æ˜¯lambda$å°é—­ç±»æ–¹æ³•å$é€’å¢æ•°å­—ã€‚ &lt;3&gt;ï¼šLambdaè¡¨è¾¾å¼è°ƒç”¨æœ€ç»ˆé€šè¿‡å­—èŠ‚ç æŒ‡ä»¤invokedynamicï¼Œå¿½ç•¥ä¸­é—´è¿‡ç¨‹ï¼Œæœ€åè°ƒç”¨åˆ°ç¬¬&lt;2&gt;æ­¥ä¸­å¯¹åº”çš„æ–¹æ³•ã€‚ é™äºç¯‡å¹…é—®é¢˜ï¼Œè¿™é‡ŒæŠŠLambdaè¡¨è¾¾å¼çš„åº•å±‚åŸç†åšäº†ç®€å•çš„æ¢³ç†ï¼ˆè¿™ä¸ªæ¨å¯¼è¿‡ç¨‹ä»…é™äºä¸ªäººç†è§£ï¼Œä¾æ®å°šæœªå……åˆ†ï¼‰ï¼š &lt;1&gt;ï¼šå°é—­ç±»ä¼šåŸºäºç±»å†…çš„Lambdaè¡¨è¾¾å¼ç±»å‹ç”Ÿæˆprivate static syntheticä¿®é¥°çš„é™æ€æ–¹æ³•ï¼Œè¯¥é™æ€æ–¹æ³•çš„æ–¹æ³•ä½“å°±æ˜¯æ¥æºäºLambdaæ–¹æ³•ä½“ï¼Œè¿™äº›é™æ€æ–¹æ³•çš„åç§°æ˜¯lambda$å°é—­ç±»æ–¹æ³•å$é€’å¢æ•°å­—ã€‚ &lt;2&gt;ï¼šLambdaè¡¨è¾¾å¼ä¼šé€šè¿‡LambdaMetafactory#metafactory()æ–¹æ³•ï¼Œç”Ÿæˆä¸€ä¸ªå¯¹åº”å‡½æ•°å¼æ¥å£çš„æ¨¡æ¿ç±»ï¼Œæ¨¡æ¿ç±»çš„æ¥å£æ–¹æ³•å®ç°å¼•ç”¨äº†ç¬¬&lt;1&gt;æ­¥ä¸­å®šä¹‰çš„é™æ€æ–¹æ³•ï¼ŒåŒæ—¶åˆ›å»ºä¸€ä¸ªè°ƒç”¨ç‚¹ConstantCallSiteå®ä¾‹ï¼Œåé¢ä¼šé€šè¿‡Unsafe#defineAnonymousClass()å®ä¾‹åŒ–æ¨¡æ¿ç±»ã€‚ã€‚ &lt;3&gt;ï¼šè°ƒç”¨ç‚¹ConstantCallSiteå®ä¾‹ä¸­çš„æ–¹æ³•å¥æŸ„MethodHandleä¼šæ ¹æ®ä¸åŒåœºæ™¯é€‰å–ä¸åŒçš„å®ç°ï¼ŒMethodHandleçš„å­ç±»å¾ˆå¤šï¼Œè¿™é‡Œæ— æ³•ä¸€ä¸€å±•å¼€ã€‚ &lt;4&gt;ï¼šé€šè¿‡invokedynamiceæŒ‡ä»¤ï¼ŒåŸºäºç¬¬&lt;1&gt;æ­¥ä¸­çš„æ¨¡æ¿ç±»å®ä¾‹ã€ç¬¬&lt;3&gt;æ­¥ä¸­çš„æ–¹æ³•å¥æŸ„ä»¥åŠæ–¹æ³•å…¥å‚è¿›è¡Œæ–¹æ³•å¥æŸ„çš„è°ƒç”¨ï¼Œå®é™…ä¸Šæœ€ç»ˆå§”æ‰˜åˆ°ç¬¬&lt;1&gt;æ­¥ä¸­å®šä¹‰çš„é™æ€æ–¹æ³•ä¸­æ‰§è¡Œã€‚ å¦‚æœæƒ³è¦è·Ÿè¸ªLambdaè¡¨è¾¾å¼çš„æ•´ä¸ªè°ƒç”¨ç”Ÿå‘½å‘¨æœŸï¼Œå¯ä»¥ä»¥LambdaMetafactory#metafactory()æ–¹æ³•ä¸ºå…¥å£å¼€å§‹DEBUGï¼Œè°ƒç”¨é“¾è·¯ååˆ†åºå¤§ï¼Œéœ€è¦æœ‰è¶³å¤Ÿçš„è€å¿ƒã€‚æ€»çš„æ¥è¯´å°±æ˜¯ï¼šLambdaè¡¨è¾¾å¼æ˜¯åŸºäºJSR-292å¼•å…¥çš„åŠ¨æ€è¯­è¨€è°ƒç”¨åŒ…java.lang.invokeå’ŒUnsafe#defineAnonymousClass()å®šä¹‰çš„è½»é‡çº§æ¨¡æ¿ç±»å®ç°çš„ï¼Œä¸»è¦ç”¨åˆ°äº†invokedynamiceå­—èŠ‚ç æŒ‡ä»¤ï¼Œå…³è”åˆ°æ–¹æ³•å¥æŸ„MethodHandleã€è°ƒç”¨ç‚¹CallSiteç­‰ç›¸å¯¹å¤æ‚çš„çŸ¥è¯†ç‚¹ï¼Œè¿™é‡Œä¸å†è¯¦ç»†å±•å¼€ã€‚ å®æˆ˜ åŸºäºJdbcTemplateè¿›è¡Œè½»é‡çº§DAOå°è£… å‡è®¾è®¢å•è¡¨çš„DDLå¦‚ä¸‹ï¼š 1234567891011CREATE TABLE `t_order`( id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY, create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP, edit_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP, user_id BIGINT UNSIGNED NOT NULL COMMENT 'ç”¨æˆ·ID', order_id VARCHAR(64) NOT NULL COMMENT 'è®¢å•ID', amount DECIMAL(12, 2) NOT NULL DEFAULT 0 COMMENT 'è®¢å•é‡‘é¢', INDEX idx_user_id (user_id), UNIQUE uniq_order_id (order_id)) COMMENT 'è®¢å•è¡¨'; ä¸‹é¢åŸºäºJdbcTemplateå°è£…ä¸€ä¸ªè½»é‡çº§çš„OrderDaoï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191// è¾…åŠ©æ¥å£@FunctionalInterfacepublic interface PreparedStatementProcessor &#123; void process(PreparedStatement ps) throws SQLException;&#125;@FunctionalInterfacepublic interface ResultSetConverter&lt;T&gt; &#123; T convert(ResultSet resultSet) throws SQLException;&#125;// OrderDaoæ¥å£public interface OrderDao &#123; int insertSelective(Order record); int updateSelective(Order record); Order selectOneByOrderId(String orderId); List&lt;Order&gt; selectByUserId(Long userId);&#125;// OrderDaoå®ç°@Repository@RequiredArgsConstructorpublic class MySqlOrderDao implements OrderDao &#123; private final JdbcTemplate jdbcTemplate; private static final ResultSetConverter&lt;Order&gt; CONVERTER = r -&gt; &#123; Order order = new Order(); order.setId(r.getLong(\"id\")); order.setCreateTime(r.getTimestamp(\"create_time\").toLocalDateTime()); order.setEditTime(r.getTimestamp(\"edit_time\").toLocalDateTime()); order.setUserId(r.getLong(\"user_id\")); order.setAmount(r.getBigDecimal(\"amount\")); order.setOrderId(r.getString(\"order_id\")); return order; &#125;; private static final ResultSetExtractor&lt;List&lt;Order&gt;&gt; MULTI = r -&gt; &#123; List&lt;Order&gt; list = new ArrayList&lt;&gt;(); while (r.next()) &#123; list.add(CONVERTER.convert(r)); &#125; return list; &#125;; private static final ResultSetExtractor&lt;Order&gt; SINGLE = r -&gt; &#123; if (r.next()) &#123; return CONVERTER.convert(r); &#125; return null; &#125;; @Override public int insertSelective(Order record) &#123; List&lt;PreparedStatementProcessor&gt; processors = new ArrayList&lt;&gt;(); StringBuilder sql = new StringBuilder(\"INSERT INTO t_order(\"); Cursor cursor = new Cursor(); if (null != record.getId()) &#123; int idx = cursor.add(); sql.append(\"id,\"); processors.add(p -&gt; p.setLong(idx, record.getId())); &#125; if (null != record.getOrderId()) &#123; int idx = cursor.add(); sql.append(\"order_id,\"); processors.add(p -&gt; p.setString(idx, record.getOrderId())); &#125; if (null != record.getUserId()) &#123; int idx = cursor.add(); sql.append(\"user_id,\"); processors.add(p -&gt; p.setLong(idx, record.getUserId())); &#125; if (null != record.getAmount()) &#123; int idx = cursor.add(); sql.append(\"amount,\"); processors.add(p -&gt; p.setBigDecimal(idx, record.getAmount())); &#125; if (null != record.getCreateTime()) &#123; int idx = cursor.add(); sql.append(\"create_time,\"); processors.add(p -&gt; p.setTimestamp(idx, Timestamp.valueOf(record.getCreateTime()))); &#125; if (null != record.getEditTime()) &#123; int idx = cursor.add(); sql.append(\"edit_time,\"); processors.add(p -&gt; p.setTimestamp(idx, Timestamp.valueOf(record.getEditTime()))); &#125; StringBuilder realSql = new StringBuilder(sql.substring(0, sql.lastIndexOf(\",\"))); realSql.append(\") VALUES (\"); int idx = cursor.idx(); for (int i = 0; i &lt; idx; i++) &#123; if (i != idx - 1) &#123; realSql.append(\"?,\"); &#125; else &#123; realSql.append(\"?\"); &#125; &#125; realSql.append(\")\"); // ä¼ å…¥ä¸»é”®çš„æƒ…å†µ if (null != record.getId()) &#123; return jdbcTemplate.update(realSql.toString(), p -&gt; &#123; for (PreparedStatementProcessor processor : processors) &#123; processor.process(p); &#125; &#125;); &#125; else &#123; // è‡ªå¢ä¸»é”®çš„æƒ…å†µ KeyHolder keyHolder = new GeneratedKeyHolder(); int count = jdbcTemplate.update(p -&gt; &#123; PreparedStatement ps = p.prepareStatement(realSql.toString(), Statement.RETURN_GENERATED_KEYS); for (PreparedStatementProcessor processor : processors) &#123; processor.process(ps); &#125; return ps; &#125;, keyHolder); record.setId(Objects.requireNonNull(keyHolder.getKey()).longValue()); return count; &#125; &#125; @Override public int updateSelective(Order record) &#123; List&lt;PreparedStatementProcessor&gt; processors = new ArrayList&lt;&gt;(); StringBuilder sql = new StringBuilder(\"UPDATE t_order SET \"); Cursor cursor = new Cursor(); if (null != record.getOrderId()) &#123; int idx = cursor.add(); sql.append(\"order_id = ?,\"); processors.add(p -&gt; p.setString(idx, record.getOrderId())); &#125; if (null != record.getUserId()) &#123; int idx = cursor.add(); sql.append(\"user_id = ?,\"); processors.add(p -&gt; p.setLong(idx, record.getUserId())); &#125; if (null != record.getAmount()) &#123; int idx = cursor.add(); sql.append(\"amount = ?,\"); processors.add(p -&gt; p.setBigDecimal(idx, record.getAmount())); &#125; if (null != record.getCreateTime()) &#123; int idx = cursor.add(); sql.append(\"create_time = ?,\"); processors.add(p -&gt; p.setTimestamp(idx, Timestamp.valueOf(record.getCreateTime()))); &#125; if (null != record.getEditTime()) &#123; int idx = cursor.add(); sql.append(\"edit_time = ?,\"); processors.add(p -&gt; p.setTimestamp(idx, Timestamp.valueOf(record.getEditTime()))); &#125; StringBuilder realSql = new StringBuilder(sql.substring(0, sql.lastIndexOf(\",\"))); int idx = cursor.add(); processors.add(p -&gt; p.setLong(idx, record.getId())); realSql.append(\" WHERE id = ?\"); return jdbcTemplate.update(realSql.toString(), p -&gt; &#123; for (PreparedStatementProcessor processor : processors) &#123; processor.process(p); &#125; &#125;); &#125; @Override public Order selectOneByOrderId(String orderId) &#123; return jdbcTemplate.query(\"SELECT * FROM t_order WHERE order_id = ?\", p -&gt; p.setString(1, orderId), SINGLE); &#125; @Override public List&lt;Order&gt; selectByUserId(Long userId) &#123; return jdbcTemplate.query(\"SELECT * FROM t_order WHERE order_id = ?\", p -&gt; p.setLong(1, userId), MULTI); &#125; private static class Cursor &#123; private int idx; public int add() &#123; idx++; return idx; &#125; public int idx() &#123; return idx; &#125; &#125;&#125; ç±»ä¼¼äºMybatis Generatorï¼Œä¸Šé¢çš„DAOå®ç°ç¬”è€…å·²ç»åšäº†ä¸€ä¸ªç®€å•çš„ç”Ÿæˆå™¨ï¼Œåªè¦é…ç½®å¥½æ•°æ®æºçš„è¿æ¥å±æ€§å’Œè¡¨è¿‡æ»¤è§„åˆ™å°±å¯ä»¥ç”Ÿæˆå¯¹åº”çš„å®ä½“ç±»å’ŒDAOç±»ã€‚ åŸºäºOptionalè¿›è¡ŒVOè®¾ç½®å€¼ 123456789101112131415161718192021222324// å‡è®¾VOæœ‰å¤šä¸ªå±‚çº§ï¼Œæ¯ä¸ªå±‚çº§éƒ½ä¸çŸ¥é“çˆ¶èŠ‚ç‚¹æ˜¯å¦ä¸ºNULLï¼Œå¦‚ä¸‹// - OrderInfoVo// - UserInfoVo// - AddressInfoVo// - address(å±æ€§)// å‡è®¾æˆ‘è¦ä¸ºaddresså±æ€§èµ‹å€¼ï¼Œé‚£ä¹ˆå°±ä¼šäº§ç”Ÿç®­å¤´å‹ä»£ç ã€‚// å¸¸è§„æ–¹æ³•String address = \"xxx\";OrderInfoVo o = ...;if(null != o)&#123; UserInfoVo uiv = o.getUserInfoVo(); if (null != uiv)&#123; AddressInfoVo aiv = uiv.getAddressInfoVo(); if (null != aiv)&#123; aiv.setAddress(address); &#125; &#125;&#125;// ä½¿ç”¨Optionalå’ŒLambdaString address = \"xxx\";OrderInfoVo o = ...;Optional.ofNullable(o).map(OrderInfoVo::getUserInfoVo).map(UserInfoVo::getAddressInfoVo).ifPresent(a -&gt; a.setAddress(address)); å°ç»“ Lambdaæ˜¯Javaä¸­ä¸€ä¸ªé¦™ç”œçš„è¯­æ³•ç³–ï¼Œæ‹¥æŠ±Lambdaï¼Œæ‹¥æŠ±å‡½æ•°å¼ç¼–ç¨‹ï¼Œç¬”è€…ä¹Ÿç»å†è¿‡æŠ—æ‹’ã€ä¸çœ‹å¥½ã€ä¸Šæ‰‹å’ŒçœŸé¦™çš„è¿‡ç¨‹ï¼Œç›®å‰ä¹Ÿå¤§é‡ä½¿ç”¨Streamå’ŒLambdaï¼Œèƒ½åœ¨ä¿è¯æ€§èƒ½çš„å‰æä¸‹ï¼Œå°½å¯èƒ½ç®€åŒ–ä»£ç ï¼Œè§£æ”¾åŠ³åŠ¨åŠ›ã€‚æ—¶ä»£åœ¨è¿›æ­¥ï¼ŒJavaä¹Ÿåœ¨è¿›æ­¥ï¼Œè¿™æ˜¯å¾ˆå¤šäººæ´»ç€å’ŒåšæŒç¼–ç¨‹äº‹ä¸šçš„ä¿¡å¿µã€‚ å‚è€ƒèµ„æ–™ï¼š Lambda Expressions Default Methods State of the Lambda JDK11éƒ¨åˆ†æºç  ï¼ˆæœ¬æ–‡å®Œ e-a-20200208 c-5-dï¼‰","categories":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/categories/Java/"},{"name":"Lambda","slug":"Java/Lambda","permalink":"http://throwable.club/blog/categories/Java/Lambda/"}],"tags":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/tags/Java/"},{"name":"Lambda","slug":"Lambda","permalink":"http://throwable.club/blog/tags/Lambda/"}]},{"title":"ä¸€ä¸ªåŸºäºRabbitMQçš„å¯å¤ç”¨çš„äº‹åŠ¡æ¶ˆæ¯æ–¹æ¡ˆ","slug":"j-action-transactional-message-by-rabbit","date":"2020-02-05T13:37:56.000Z","updated":"2020-02-05T13:39:07.621Z","comments":true,"path":"2020/02/05/j-action-transactional-message-by-rabbit/","link":"","permalink":"http://throwable.club/2020/02/05/j-action-transactional-message-by-rabbit/","excerpt":"å‰æ åˆ†å¸ƒå¼äº‹åŠ¡æ˜¯å¾®æœåŠ¡å®è·µä¸­ä¸€ä¸ªæ¯”è¾ƒæ£˜æ‰‹çš„é—®é¢˜ï¼Œåœ¨ç¬”è€…æ‰€å®æ–½çš„å¾®æœåŠ¡å®è·µæ–¹æ¡ˆä¸­ï¼Œéƒ½é‡‡ç”¨äº†æŠ˜ä¸­æˆ–è€…è§„é¿å¼ºä¸€è‡´æ€§çš„æ–¹æ¡ˆã€‚å‚è€ƒEbayå¤šå¹´å‰æå‡ºçš„æœ¬åœ°æ¶ˆæ¯è¡¨æ–¹æ¡ˆï¼ŒåŸºäºRabbitMQå’ŒMySQLï¼ˆJDBCï¼‰åšäº†è½»é‡çº§çš„å°è£…ï¼Œå®ç°äº†ä½å…¥ä¾µæ€§çš„äº‹åŠ¡æ¶ˆæ¯æ¨¡å—ã€‚æœ¬æ–‡çš„å†…å®¹å°±æ˜¯è¯¦ç»†åˆ†ææ•´ä¸ªæ–¹æ¡ˆçš„è®¾è®¡æ€è·¯å’Œå®æ–½ã€‚ç¯å¢ƒä¾èµ–å¦‚ä¸‹ï¼š JDK1.8+ spring-boot-start-web:2.x.xã€spring-boot-start-jdbc:2.x.xã€spring-boot-start-amqp:2.x.x HikariCP:3.x.xï¼ˆspring-boot-start-jdbcè‡ªå¸¦ï¼‰ã€mysql-connector-java:5.1.48 redisson:3.12.1","text":"å‰æ åˆ†å¸ƒå¼äº‹åŠ¡æ˜¯å¾®æœåŠ¡å®è·µä¸­ä¸€ä¸ªæ¯”è¾ƒæ£˜æ‰‹çš„é—®é¢˜ï¼Œåœ¨ç¬”è€…æ‰€å®æ–½çš„å¾®æœåŠ¡å®è·µæ–¹æ¡ˆä¸­ï¼Œéƒ½é‡‡ç”¨äº†æŠ˜ä¸­æˆ–è€…è§„é¿å¼ºä¸€è‡´æ€§çš„æ–¹æ¡ˆã€‚å‚è€ƒEbayå¤šå¹´å‰æå‡ºçš„æœ¬åœ°æ¶ˆæ¯è¡¨æ–¹æ¡ˆï¼ŒåŸºäºRabbitMQå’ŒMySQLï¼ˆJDBCï¼‰åšäº†è½»é‡çº§çš„å°è£…ï¼Œå®ç°äº†ä½å…¥ä¾µæ€§çš„äº‹åŠ¡æ¶ˆæ¯æ¨¡å—ã€‚æœ¬æ–‡çš„å†…å®¹å°±æ˜¯è¯¦ç»†åˆ†ææ•´ä¸ªæ–¹æ¡ˆçš„è®¾è®¡æ€è·¯å’Œå®æ–½ã€‚ç¯å¢ƒä¾èµ–å¦‚ä¸‹ï¼š JDK1.8+ spring-boot-start-web:2.x.xã€spring-boot-start-jdbc:2.x.xã€spring-boot-start-amqp:2.x.x HikariCP:3.x.xï¼ˆspring-boot-start-jdbcè‡ªå¸¦ï¼‰ã€mysql-connector-java:5.1.48 redisson:3.12.1 æ–¹æ¡ˆè®¾è®¡æ€è·¯ äº‹åŠ¡æ¶ˆæ¯åŸåˆ™ä¸Šåªé€‚åˆå¼±ä¸€è‡´æ€§ï¼ˆæˆ–è€…è¯´æœ€ç»ˆä¸€è‡´æ€§ï¼‰çš„åœºæ™¯ï¼Œå¸¸è§çš„å¼±ä¸€è‡´æ€§åœºæ™¯å¦‚ï¼š ç”¨æˆ·æœåŠ¡å®Œæˆäº†æ³¨å†ŒåŠ¨ä½œï¼Œå‘çŸ­ä¿¡æœåŠ¡æ¨é€ä¸€æ¡è¥é”€ç›¸å…³çš„æ¶ˆæ¯ã€‚ ä¿¡è´·ä½“ç³»ä¸­ï¼Œè®¢å•æœåŠ¡ä¿å­˜è®¢å•å®Œæ¯•ï¼Œå‘å®¡æ‰¹æœåŠ¡æ¨é€ä¸€æ¡å¾…å®¡æ‰¹çš„è®¢å•è®°å½•ä¿¡æ¯ã€‚ â€¦ å¼ºä¸€è‡´æ€§çš„åœºæ™¯ä¸€èˆ¬ä¸åº”è¯¥é€‰ç”¨äº‹åŠ¡æ¶ˆæ¯ã€‚ ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè¦æ±‚å¼ºä¸€è‡´æ€§è¯´æ˜è¦ä¸¥æ ¼åŒæ­¥ï¼Œä¹Ÿå°±æ˜¯æ‰€æœ‰æ“ä½œå¿…é¡»åŒæ—¶æˆåŠŸæˆ–è€…åŒæ—¶å¤±è´¥ï¼Œè¿™æ ·å°±ä¼šå¼•å…¥åŒæ­¥å¸¦æ¥çš„é¢å¤–æ¶ˆè€—ã€‚å¦‚æœä¸€ä¸ªäº‹åŠ¡æ¶ˆæ¯æ¨¡å—è®¾è®¡åˆç†ï¼Œè¡¥å¿ã€æŸ¥è¯¢ã€ç›‘æ§ç­‰ç­‰åŠŸèƒ½éƒ½å®Œæ¯•ï¼Œç”±äºç³»ç»Ÿäº¤äº’æ˜¯å¼‚æ­¥çš„ï¼Œæ•´ä½“ååè¦æ¯”ä¸¥æ ¼åŒæ­¥é«˜ã€‚åœ¨ç¬”è€…è´Ÿè´£çš„ä¸šåŠ¡ç³»ç»Ÿä¸­åŸºäºäº‹åŠ¡æ¶ˆæ¯ä½¿ç”¨è¿˜å®šåˆ¶äº†ä¸€æ¡åŸºæœ¬åŸåˆ™ï¼šæ¶ˆæ¯å†…å®¹æ­£ç¡®çš„å‰æä¸‹ï¼Œæ¶ˆè´¹æ–¹å‡ºç°å¼‚å¸¸éœ€è¦è‡ªç†ã€‚ ç®€å•æ¥è¯´å°±æ˜¯ï¼šä¸Šæ¸¸ä¿è¯äº†è‡ªèº«çš„ä¸šåŠ¡æ­£ç¡®æ€§ï¼ŒæˆåŠŸæ¨é€äº†æ­£ç¡®çš„æ¶ˆæ¯åˆ°RabbitMQå°±è®¤ä¸ºä¸Šæ¸¸ä¹‰åŠ¡å·²ç»ç»“æŸã€‚ ä¸ºäº†é™ä½ä»£ç çš„å…¥ä¾µæ€§ï¼Œäº‹åŠ¡æ¶ˆæ¯éœ€è¦å€ŸåŠ©Springçš„ç¼–ç¨‹å¼äº‹åŠ¡æˆ–è€…å£°æ˜å¼äº‹åŠ¡ã€‚ç¼–ç¨‹å¼äº‹åŠ¡ä¸€èˆ¬ä¾èµ–äºTransactionTemplateï¼Œè€Œå£°æ˜å¼äº‹åŠ¡ä¾æ‰˜äºAOPæ¨¡å—ï¼Œä¾èµ–äºæ³¨è§£@Transactionalã€‚ æ¥ç€éœ€è¦è‡ªå®šä¹‰ä¸€ä¸ªäº‹åŠ¡æ¶ˆæ¯åŠŸèƒ½æ¨¡å—ï¼Œæ–°å¢ä¸€ä¸ªäº‹åŠ¡æ¶ˆæ¯è®°å½•è¡¨ï¼ˆå…¶å®å°±æ˜¯æœ¬åœ°æ¶ˆæ¯è¡¨ï¼‰ï¼Œç”¨äºä¿å­˜æ¯ä¸€æ¡éœ€è¦å‘é€çš„æ¶ˆæ¯è®°å½•ã€‚äº‹åŠ¡æ¶ˆæ¯åŠŸèƒ½æ¨¡å—çš„ä¸»è¦åŠŸèƒ½æ˜¯ï¼š ä¿å­˜æ¶ˆæ¯è®°å½•ã€‚ æ¨é€æ¶ˆæ¯åˆ°RabbitMQæœåŠ¡ç«¯ã€‚ æ¶ˆæ¯è®°å½•çš„æŸ¥è¯¢ã€è¡¥å¿æ¨é€ç­‰ç­‰ã€‚ äº‹åŠ¡æ‰§è¡Œçš„é€»è¾‘å•å…ƒ åœ¨äº‹åŠ¡æ‰§è¡Œçš„é€»è¾‘å•å…ƒé‡Œé¢ï¼Œéœ€è¦è¿›è¡Œå¾…æ¨é€çš„äº‹åŠ¡æ¶ˆæ¯è®°å½•çš„ä¿å­˜ï¼Œä¹Ÿå°±æ˜¯ï¼šæœ¬åœ°ï¼ˆä¸šåŠ¡ï¼‰é€»è¾‘å’Œäº‹åŠ¡æ¶ˆæ¯è®°å½•ä¿å­˜æ“ä½œç»‘å®šåœ¨åŒä¸€ä¸ªäº‹åŠ¡ã€‚ å‘é€æ¶ˆæ¯åˆ°RabbitMQæœåŠ¡ç«¯è¿™ä¸€æ­¥éœ€è¦å»¶ååˆ°äº‹åŠ¡æäº¤ä¹‹åï¼Œè¿™æ ·æ‰èƒ½ä¿è¯äº‹åŠ¡æäº¤æˆåŠŸå’Œæ¶ˆæ¯æˆåŠŸå‘é€åˆ°RabbitMQæœåŠ¡ç«¯è¿™ä¸¤ä¸ªæ“ä½œæ˜¯ä¸€è‡´çš„ã€‚ä¸ºäº†æŠŠä¿å­˜å¾…å‘é€çš„äº‹åŠ¡æ¶ˆæ¯å’Œå‘é€æ¶ˆæ¯åˆ°RabbitMQä¸¤ä¸ªåŠ¨ä½œä»ä½¿ç”¨è€…æ„ŸçŸ¥è§’åº¦åˆå¹¶ä¸ºä¸€ä¸ªåŠ¨ä½œï¼Œè¿™é‡Œéœ€è¦ç”¨åˆ°Springç‰¹æœ‰çš„äº‹åŠ¡åŒæ­¥å™¨TransactionSynchronizationï¼Œè¿™é‡Œåˆ†æä¸€ä¸‹äº‹åŠ¡åŒæ­¥å™¨çš„ä¸»è¦æ–¹æ³•çš„å›è°ƒä½ç½®ï¼Œä¸»è¦å‚è€ƒAbstractPlatformTransactionManager#commit()æˆ–è€…AbstractPlatformTransactionManager#processCommit()æ–¹æ³•ï¼š ä¸Šå›¾ä»…ä»…æ¼”ç¤ºäº†äº‹åŠ¡æ­£ç¡®æäº¤çš„åœºæ™¯ï¼ˆä¸åŒ…å«å¼‚å¸¸çš„åœºæ™¯ï¼‰ã€‚è¿™é‡Œå¯ä»¥æ˜ç¡®çŸ¥é“ï¼Œäº‹åŠ¡åŒæ­¥å™¨TransactionSynchronizationçš„afterCommit()å’ŒafterCompletion(int status)æ–¹æ³•éƒ½åœ¨çœŸæ­£çš„äº‹åŠ¡æäº¤ç‚¹AbstractPlatformTransactionManager#doCommit()ä¹‹åå›è°ƒï¼Œå› æ­¤å¯ä»¥é€‰ç”¨è¿™ä¸¤ä¸ªæ–¹æ³•å…¶ä¸­ä¹‹ä¸€ç”¨äºæ‰§è¡Œæ¨é€æ¶ˆæ¯åˆ°RabbitMQæœåŠ¡ç«¯ï¼Œæ•´ä½“çš„ä¼ªä»£ç å¦‚ä¸‹ï¼š 123456789@Transactionalpublic Dto businessMethod()&#123; business transaction code block ... // ä¿å­˜äº‹åŠ¡æ¶ˆæ¯ [saveTransactionMessageRecord()] // æ³¨å†Œäº‹åŠ¡åŒæ­¥å™¨ - åœ¨afterCommit()æ–¹æ³•ä¸­æ¨é€æ¶ˆæ¯åˆ°RabbitMQ [register TransactionSynchronization,send message in method afterCommit()] business transaction code block ...&#125; ä¸Šé¢ä¼ªä»£ç ä¸­ï¼Œä¿å­˜äº‹åŠ¡æ¶ˆæ¯å’Œæ³¨å†Œäº‹åŠ¡åŒæ­¥å™¨ä¸¤ä¸ªæ­¥éª¤å¯ä»¥å®‰æ’åœ¨äº‹åŠ¡æ–¹æ³•ä¸­çš„ä»»æ„ä½ç½®ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸æ‰§è¡Œé¡ºåºæ— å…³ã€‚ äº‹åŠ¡æ¶ˆæ¯çš„è¡¥å¿ è™½ç„¶ä¹‹å‰æåˆ°ç¬”è€…å»ºè®®ä¸‹æ¸¸æœåŠ¡è‡ªç†è‡ªèº«æœåŠ¡æ¶ˆè´¹å¼‚å¸¸çš„åœºæ™¯ï¼Œä½†æ˜¯æœ‰äº›æ—¶å€™è¿«äºæ— å¥ˆè¿˜æ˜¯éœ€è¦ä¸Šæ¸¸æŠŠå¯¹åº”çš„æ¶ˆæ¯é‡æ–°æ¨é€ï¼Œè¿™ä¸ªç®—æ˜¯ç‰¹æ®Šçš„åœºæ™¯ã€‚å¦å¤–è¿˜æœ‰ä¸€ä¸ªåœºæ™¯éœ€è¦è€ƒè™‘ï¼šäº‹åŠ¡æäº¤ä¹‹åè§¦å‘äº‹åŠ¡åŒæ­¥å™¨TransactionSynchronizationçš„afterCommit()æ–¹æ³•å¤±è´¥ã€‚è¿™æ˜¯ä¸€ä¸ªä½æ¦‚ç‡çš„åœºæ™¯ï¼Œä½†æ˜¯åœ¨ç”Ÿäº§ä¸­ä¸€å®šä¼šå‡ºç°ï¼Œä¸€ä¸ªæ¯”è¾ƒå…¸å‹çš„åŸå› å°±æ˜¯ï¼šäº‹åŠ¡æäº¤å®Œæˆåå°šæœªæ¥å¾—åŠè§¦å‘TransactionSynchronization#afterCommit()æ–¹æ³•è¿›è¡Œæ¨é€æœåŠ¡å®ä¾‹å°±è¢«é‡å¯ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š ä¸ºäº†ç»Ÿä¸€å¤„ç†è¡¥å¿æ¨é€çš„é—®é¢˜ï¼Œä½¿ç”¨äº†æœ‰é™çŠ¶æ€åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦å·²ç»æ¨é€æˆåŠŸï¼š åœ¨äº‹åŠ¡æ–¹æ³•å†…ï¼Œä¿å­˜äº‹åŠ¡æ¶ˆæ¯çš„æ—¶å€™ï¼Œæ ‡è®°æ¶ˆæ¯è®°å½•æ¨é€çŠ¶æ€ä¸ºå¤„ç†ä¸­ã€‚ äº‹åŠ¡åŒæ­¥å™¨æ¥å£TransactionSynchronizationçš„afterCommit()æ–¹æ³•çš„å®ç°ä¸­ï¼Œæ¨é€å¯¹åº”çš„æ¶ˆæ¯åˆ°RabbitMQï¼Œç„¶åæ›´å˜äº‹åŠ¡æ¶ˆæ¯è®°å½•çš„çŠ¶æ€ä¸ºæ¨é€æˆåŠŸã€‚ è¿˜æœ‰ä¸€ç§æä¸ºç‰¹æ®Šçš„æƒ…å†µæ˜¯RabbitMQæœåŠ¡ç«¯æœ¬èº«å‡ºç°æ•…éšœå¯¼è‡´æ¶ˆæ¯æ¨é€å¼‚å¸¸ï¼Œè¿™ç§æƒ…å†µä¸‹éœ€è¦è¿›è¡Œé‡è¯•ï¼ˆè¡¥å¿æ¨é€ï¼‰ï¼Œç»éªŒè¯æ˜çŸ­æ—¶é—´å†…çš„åå¤é‡è¯•æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œæ•…éšœçš„æœåŠ¡ä¸€èˆ¬ä¸ä¼šç¬æ—¶æ¢å¤ï¼Œæ‰€ä»¥å¯ä»¥è€ƒè™‘ä½¿ç”¨æŒ‡æ•°é€€é¿ç®—æ³•è¿›è¡Œé‡è¯•ï¼ŒåŒæ—¶éœ€è¦é™åˆ¶æœ€å¤§é‡è¯•æ¬¡æ•°ã€‚ æŒ‡æ•°å€¼ã€é—´éš”å€¼å’Œæœ€å¤§é‡è¯•æ¬¡æ•°ä¸Šé™éœ€è¦æ ¹æ®å®é™…æƒ…å†µè®¾å®šï¼Œå¦åˆ™å®¹æ˜“å‡ºç°æ¶ˆæ¯å»¶æ—¶è¿‡å¤§æˆ–è€…é‡è¯•è¿‡äºé¢‘ç¹ç­‰é—®é¢˜ã€‚ æ–¹æ¡ˆå®æ–½ å¼•å…¥æ ¸å¿ƒä¾èµ–ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344&lt;properties&gt; &lt;spring.boot.version&gt;2.2.4.RELEASE&lt;/spring.boot.version&gt; &lt;redisson.version&gt;3.12.1&lt;/redisson.version&gt; &lt;mysql.connector.version&gt;5.1.48&lt;/mysql.connector.version&gt;&lt;/properties&gt;&lt;dependencyManagement&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-dependencies&lt;/artifactId&gt; &lt;version&gt;$&#123;spring.boot.version&#125;&lt;/version&gt; &lt;type&gt;pom&lt;/type&gt; &lt;scope&gt;import&lt;/scope&gt; &lt;/dependency&gt; &lt;/dependencies&gt;&lt;/dependencyManagement&gt;&lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;mysql&lt;/groupId&gt; &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt; &lt;version&gt;$&#123;mysql.connector.version&#125;&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-jdbc&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-aop&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-amqp&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.redisson&lt;/groupId&gt; &lt;artifactId&gt;redisson&lt;/artifactId&gt; &lt;version&gt;$&#123;redisson.version&#125;&lt;/version&gt; &lt;/dependency&gt;&lt;/dependencies&gt; spring-boot-starter-jdbcã€mysql-connector-javaå’Œspring-boot-starter-aopæ˜¯MySQLäº‹åŠ¡ç›¸å…³ï¼Œè€Œspring-boot-starter-amqpæ˜¯RabbitMQå®¢æˆ·ç«¯çš„å°è£…ï¼Œredissonä¸»è¦ä½¿ç”¨å…¶åˆ†å¸ƒå¼é”ï¼Œç”¨äºè¡¥å¿å®šæ—¶ä»»åŠ¡çš„åŠ é”æ‰§è¡Œï¼ˆä»¥é˜²æ­¢æœåŠ¡å¤šä¸ªèŠ‚ç‚¹å¹¶å‘æ‰§è¡Œè¡¥å¿æ¨é€ï¼‰ã€‚ è¡¨è®¾è®¡ äº‹åŠ¡æ¶ˆæ¯æ¨¡å—ä¸»è¦æ¶‰åŠä¸¤å¼ è¡¨ï¼Œä»¥MySQLä¸ºä¾‹ï¼Œå»ºè¡¨DDLå¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132CREATE TABLE `t_transactional_message`( id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY, create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP, edit_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP, creator VARCHAR(20) NOT NULL DEFAULT 'admin', editor VARCHAR(20) NOT NULL DEFAULT 'admin', deleted TINYINT NOT NULL DEFAULT 0, current_retry_times TINYINT NOT NULL DEFAULT 0 COMMENT 'å½“å‰é‡è¯•æ¬¡æ•°', max_retry_times TINYINT NOT NULL DEFAULT 5 COMMENT 'æœ€å¤§é‡è¯•æ¬¡æ•°', queue_name VARCHAR(255) NOT NULL COMMENT 'é˜Ÿåˆ—å', exchange_name VARCHAR(255) NOT NULL COMMENT 'äº¤æ¢å™¨å', exchange_type VARCHAR(8) NOT NULL COMMENT 'äº¤æ¢ç±»å‹', routing_key VARCHAR(255) COMMENT 'è·¯ç”±é”®', business_module VARCHAR(32) NOT NULL COMMENT 'ä¸šåŠ¡æ¨¡å—', business_key VARCHAR(255) NOT NULL COMMENT 'ä¸šåŠ¡é”®', next_schedule_time DATETIME NOT NULL COMMENT 'ä¸‹ä¸€æ¬¡è°ƒåº¦æ—¶é—´', message_status TINYINT NOT NULL DEFAULT 0 COMMENT 'æ¶ˆæ¯çŠ¶æ€', init_backoff BIGINT UNSIGNED NOT NULL DEFAULT 10 COMMENT 'é€€é¿åˆå§‹åŒ–å€¼,å•ä½ä¸ºç§’', backoff_factor TINYINT NOT NULL DEFAULT 2 COMMENT 'é€€é¿å› å­(ä¹Ÿå°±æ˜¯æŒ‡æ•°)', INDEX idx_queue_name (queue_name), INDEX idx_create_time (create_time), INDEX idx_next_schedule_time (next_schedule_time), INDEX idx_business_key (business_key)) COMMENT 'äº‹åŠ¡æ¶ˆæ¯è¡¨';CREATE TABLE `t_transactional_message_content`( id BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY, message_id BIGINT UNSIGNED NOT NULL COMMENT 'äº‹åŠ¡æ¶ˆæ¯è®°å½•ID', content TEXT COMMENT 'æ¶ˆæ¯å†…å®¹') COMMENT 'äº‹åŠ¡æ¶ˆæ¯å†…å®¹è¡¨'; å› ä¸ºæ­¤æ¨¡å—æœ‰å¯èƒ½æ‰©å±•å‡ºä¸€ä¸ªåå°ç®¡ç†æ¨¡å—ï¼Œæ‰€ä»¥è¦æŠŠæ¶ˆæ¯çš„ç®¡ç†å’ŒçŠ¶æ€ç›¸å…³å­—æ®µå’Œå¤§ä½“ç§¯çš„æ¶ˆæ¯å†…å®¹åˆ†åˆ«å­˜æ”¾åœ¨ä¸¤ä¸ªè¡¨ï¼Œä»è€Œé¿å…å¤§æ‰¹é‡æŸ¥è¯¢æ¶ˆæ¯è®°å½•çš„æ—¶å€™MySQLæœåŠ¡IOä½¿ç”¨ç‡è¿‡é«˜çš„é—®é¢˜ï¼ˆè¿™æ˜¯å’Œä¸Šä¸€ä¸ªå…¬å¸çš„DBAå›¢é˜Ÿå•†è®¨åå¾—åˆ°çš„ä¸€ä¸ªæ¯”è¾ƒåˆç†çš„æ–¹æ¡ˆï¼‰ã€‚é¢„ç•™äº†ä¸¤ä¸ªä¸šåŠ¡å­—æ®µbusiness_moduleå’Œbusiness_keyç”¨äºæ ‡è¯†ä¸šåŠ¡æ¨¡å—å’Œä¸šåŠ¡é”®ï¼ˆä¸€èˆ¬æ˜¯å”¯ä¸€è¯†åˆ«å·ï¼Œä¾‹å¦‚è®¢å•å·ï¼‰ã€‚ ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¦‚æœæœåŠ¡é€šè¿‡é…ç½®è‡ªè¡Œæå‰å£°æ˜é˜Ÿåˆ—å’Œäº¤æ¢å™¨çš„ç»‘å®šå…³ç³»ï¼Œé‚£ä¹ˆå‘é€RabbitMQæ¶ˆæ¯çš„æ—¶å€™å…¶å®åªä¾èµ–äºexchangeNameå’ŒroutingKeyä¸¤ä¸ªå­—æ®µï¼ˆheaderç±»å‹çš„äº¤æ¢å™¨æ˜¯ç‰¹æ®Šçš„ï¼Œä¹Ÿæ¯”è¾ƒå°‘ç”¨ï¼Œè¿™é‡Œæš‚æ—¶ä¸ç”¨è€ƒè™‘ï¼‰ï¼Œè€ƒè™‘åˆ°æœåŠ¡å¯èƒ½ä¼šé—æ¼å£°æ˜æ“ä½œï¼Œå‘é€æ¶ˆæ¯çš„æ—¶å€™ä¼šåŸºäºé˜Ÿåˆ—è¿›è¡Œé¦–æ¬¡ç»‘å®šå£°æ˜å¹¶ä¸”ç¼“å­˜ç›¸å…³çš„ä¿¡æ¯ï¼ˆRabbitMQä¸­çš„é˜Ÿåˆ—-äº¤æ¢å™¨ç»‘å®šå£°æ˜åªè¦æ¯æ¬¡å£°æ˜ç»‘å®šå…³ç³»çš„å‚æ•°ä¸€è‡´ï¼Œåˆ™ä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼‰ã€‚ æ–¹æ¡ˆä»£ç è®¾è®¡ ä¸‹é¢çš„æ–¹æ¡ˆè®¾è®¡æè¿°ä¸­ï¼Œæš‚æ—¶å¿½ç•¥äº†æ¶ˆæ¯äº‹åŠ¡ç®¡ç†åå°çš„APIè®¾è®¡ï¼Œè¿™äº›å¯ä»¥åœ¨åæœŸè¡¥å……ã€‚ å®šä¹‰è´«è¡€æ¨¡å‹å®ä½“ç±»TransactionalMessageå’ŒTransactionalMessageContentï¼š 123456789101112131415161718192021222324252627282930@Datapublic class TransactionalMessage &#123; private Long id; private LocalDateTime createTime; private LocalDateTime editTime; private String creator; private String editor; private Integer deleted; private Integer currentRetryTimes; private Integer maxRetryTimes; private String queueName; private String exchangeName; private String exchangeType; private String routingKey; private String businessModule; private String businessKey; private LocalDateTime nextScheduleTime; private Integer messageStatus; private Long initBackoff; private Integer backoffFactor;&#125;@Datapublic class TransactionalMessageContent &#123; private Long id; private Long messageId; private String content;&#125; ç„¶åå®šä¹‰daoæ¥å£ï¼ˆè¿™é‡Œæš‚æ—¶ä¸å±•å¼€å®ç°çš„ç»†èŠ‚ä»£ç ï¼Œå­˜å‚¨ä½¿ç”¨MySQLï¼Œå¦‚æœè¦æ›¿æ¢ä¸ºå…¶ä»–ç±»å‹çš„æ•°æ®åº“ï¼Œåªéœ€è¦ä½¿ç”¨ä¸åŒçš„å®ç°å³å¯ï¼‰ï¼š 1234567891011121314151617public interface TransactionalMessageDao &#123; void insertSelective(TransactionalMessage record); void updateStatusSelective(TransactionalMessage record); List&lt;TransactionalMessage&gt; queryPendingCompensationRecords(LocalDateTime minScheduleTime, LocalDateTime maxScheduleTime, int limit);&#125;public interface TransactionalMessageContentDao &#123; void insert(TransactionalMessageContent record); List&lt;TransactionalMessageContent&gt; queryByMessageIds(String messageIds);&#125; æ¥ç€å®šä¹‰äº‹åŠ¡æ¶ˆæ¯æœåŠ¡æ¥å£TransactionalMessageServiceï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121// å¯¹å¤–æä¾›çš„æœåŠ¡ç±»æ¥å£public interface TransactionalMessageService &#123; void sendTransactionalMessage(Destination destination, TxMessage message);&#125;@Getter@RequiredArgsConstructorpublic enum ExchangeType &#123; FANOUT(\"fanout\"), DIRECT(\"direct\"), TOPIC(\"topic\"), DEFAULT(\"\"), ; private final String type;&#125;// å‘é€æ¶ˆæ¯çš„ç›®çš„åœ°public interface Destination &#123; ExchangeType exchangeType(); String queueName(); String exchangeName(); String routingKey();&#125;@Builderpublic class DefaultDestination implements Destination &#123; private ExchangeType exchangeType; private String queueName; private String exchangeName; private String routingKey; @Override public ExchangeType exchangeType() &#123; return exchangeType; &#125; @Override public String queueName() &#123; return queueName; &#125; @Override public String exchangeName() &#123; return exchangeName; &#125; @Override public String routingKey() &#123; return routingKey; &#125;&#125;// äº‹åŠ¡æ¶ˆæ¯public interface TxMessage &#123; String businessModule(); String businessKey(); String content();&#125;@Builderpublic class DefaultTxMessage implements TxMessage &#123; private String businessModule; private String businessKey; private String content; @Override public String businessModule() &#123; return businessModule; &#125; @Override public String businessKey() &#123; return businessKey; &#125; @Override public String content() &#123; return content; &#125;&#125;// æ¶ˆæ¯çŠ¶æ€@RequiredArgsConstructorpublic enum TxMessageStatus &#123; /** * æˆåŠŸ */ SUCCESS(1), /** * å¾…å¤„ç† */ PENDING(0), /** * å¤„ç†å¤±è´¥ */ FAIL(-1), ; private final Integer status;&#125; TransactionalMessageServiceçš„å®ç°ç±»æ˜¯äº‹åŠ¡æ¶ˆæ¯çš„æ ¸å¿ƒåŠŸèƒ½å®ç°ï¼Œä»£ç å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445@Slf4j@Service@RequiredArgsConstructorpublic class RabbitTransactionalMessageService implements TransactionalMessageService &#123; private final AmqpAdmin amqpAdmin; private final TransactionalMessageManagementService managementService; private static final ConcurrentMap&lt;String, Boolean&gt; QUEUE_ALREADY_DECLARE = new ConcurrentHashMap&lt;&gt;(); @Override public void sendTransactionalMessage(Destination destination, TxMessage message) &#123; String queueName = destination.queueName(); String exchangeName = destination.exchangeName(); String routingKey = destination.routingKey(); ExchangeType exchangeType = destination.exchangeType(); // åŸå­æ€§çš„é¢„å£°æ˜ QUEUE_ALREADY_DECLARE.computeIfAbsent(queueName, k -&gt; &#123; Queue queue = new Queue(queueName); amqpAdmin.declareQueue(queue); Exchange exchange = new CustomExchange(exchangeName, exchangeType.getType()); amqpAdmin.declareExchange(exchange); Binding binding = BindingBuilder.bind(queue).to(exchange).with(routingKey).noargs(); amqpAdmin.declareBinding(binding); return true; &#125;); TransactionalMessage record = new TransactionalMessage(); record.setQueueName(queueName); record.setExchangeName(exchangeName); record.setExchangeType(exchangeType.getType()); record.setRoutingKey(routingKey); record.setBusinessModule(message.businessModule()); record.setBusinessKey(message.businessKey()); String content = message.content(); // ä¿å­˜äº‹åŠ¡æ¶ˆæ¯è®°å½• managementService.saveTransactionalMessageRecord(record, content); // æ³¨å†Œäº‹åŠ¡åŒæ­¥å™¨ TransactionSynchronizationManager.registerSynchronization(new TransactionSynchronizationAdapter() &#123; @Override public void afterCommit() &#123; managementService.sendMessageSync(record, content); &#125; &#125;); &#125;&#125; æ¶ˆæ¯è®°å½•çŠ¶æ€å’Œå†…å®¹æŒä¹…åŒ–çš„ç®¡ç†ç»Ÿä¸€æ”¾åœ¨TransactionalMessageManagementServiceä¸­ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110@Slf4j@RequiredArgsConstructor@Servicepublic class TransactionalMessageManagementService &#123; private final TransactionalMessageDao messageDao; private final TransactionalMessageContentDao contentDao; private final RabbitTemplate rabbitTemplate; private static final LocalDateTime END = LocalDateTime.of(2999, 1, 1, 0, 0, 0); private static final long DEFAULT_INIT_BACKOFF = 10L; private static final int DEFAULT_BACKOFF_FACTOR = 2; private static final int DEFAULT_MAX_RETRY_TIMES = 5; private static final int LIMIT = 100; public void saveTransactionalMessageRecord(TransactionalMessage record, String content) &#123; record.setMessageStatus(TxMessageStatus.PENDING.getStatus()); record.setNextScheduleTime(calculateNextScheduleTime(LocalDateTime.now(), DEFAULT_INIT_BACKOFF, DEFAULT_BACKOFF_FACTOR, 0)); record.setCurrentRetryTimes(0); record.setInitBackoff(DEFAULT_INIT_BACKOFF); record.setBackoffFactor(DEFAULT_BACKOFF_FACTOR); record.setMaxRetryTimes(DEFAULT_MAX_RETRY_TIMES); messageDao.insertSelective(record); TransactionalMessageContent messageContent = new TransactionalMessageContent(); messageContent.setContent(content); messageContent.setMessageId(record.getId()); contentDao.insert(messageContent); &#125; public void sendMessageSync(TransactionalMessage record, String content) &#123; try &#123; rabbitTemplate.convertAndSend(record.getExchangeName(), record.getRoutingKey(), content); if (log.isDebugEnabled()) &#123; log.debug(\"å‘é€æ¶ˆæ¯æˆåŠŸ,ç›®æ ‡é˜Ÿåˆ—:&#123;&#125;,æ¶ˆæ¯å†…å®¹:&#123;&#125;\", record.getQueueName(), content); &#125; // æ ‡è®°æˆåŠŸ markSuccess(record); &#125; catch (Exception e) &#123; // æ ‡è®°å¤±è´¥ markFail(record, e); &#125; &#125; private void markSuccess(TransactionalMessage record) &#123; // æ ‡è®°ä¸‹ä¸€æ¬¡æ‰§è¡Œæ—¶é—´ä¸ºæœ€å¤§å€¼ record.setNextScheduleTime(END); record.setCurrentRetryTimes(record.getCurrentRetryTimes().compareTo(record.getMaxRetryTimes()) &gt;= 0 ? record.getMaxRetryTimes() : record.getCurrentRetryTimes() + 1); record.setMessageStatus(TxMessageStatus.SUCCESS.getStatus()); record.setEditTime(LocalDateTime.now()); messageDao.updateStatusSelective(record); &#125; private void markFail(TransactionalMessage record, Exception e) &#123; log.error(\"å‘é€æ¶ˆæ¯å¤±è´¥,ç›®æ ‡é˜Ÿåˆ—:&#123;&#125;\", record.getQueueName(), e); record.setCurrentRetryTimes(record.getCurrentRetryTimes().compareTo(record.getMaxRetryTimes()) &gt;= 0 ? record.getMaxRetryTimes() : record.getCurrentRetryTimes() + 1); // è®¡ç®—ä¸‹ä¸€æ¬¡çš„æ‰§è¡Œæ—¶é—´ LocalDateTime nextScheduleTime = calculateNextScheduleTime( record.getNextScheduleTime(), record.getInitBackoff(), record.getBackoffFactor(), record.getCurrentRetryTimes() ); record.setNextScheduleTime(nextScheduleTime); record.setMessageStatus(TxMessageStatus.FAIL.getStatus()); record.setEditTime(LocalDateTime.now()); messageDao.updateStatusSelective(record); &#125; /** * è®¡ç®—ä¸‹ä¸€æ¬¡æ‰§è¡Œæ—¶é—´ * * @param base åŸºç¡€æ—¶é—´ * @param initBackoff é€€é¿åŸºå‡†å€¼ * @param backoffFactor é€€é¿æŒ‡æ•° * @param round è½®æ•° * @return LocalDateTime */ private LocalDateTime calculateNextScheduleTime(LocalDateTime base, long initBackoff, long backoffFactor, long round) &#123; double delta = initBackoff * Math.pow(backoffFactor, round); return base.plusSeconds((long) delta); &#125; /** * æ¨é€è¡¥å¿ - é‡Œé¢çš„å‚æ•°åº”è¯¥æ ¹æ®å®é™…åœºæ™¯å®šåˆ¶ */ public void processPendingCompensationRecords() &#123; // æ—¶é—´çš„å³å€¼ä¸ºå½“å‰æ—¶é—´å‡å»é€€é¿åˆå§‹å€¼ï¼Œè¿™é‡Œé¢„é˜²æŠŠåˆšä¿å­˜çš„æ¶ˆæ¯ä¹Ÿæ¨é€äº† LocalDateTime max = LocalDateTime.now().plusSeconds(-DEFAULT_INIT_BACKOFF); // æ—¶é—´çš„å·¦å€¼ä¸ºå³å€¼å‡å»1å°æ—¶ LocalDateTime min = max.plusHours(-1); Map&lt;Long, TransactionalMessage&gt; collect = messageDao.queryPendingCompensationRecords(min, max, LIMIT) .stream() .collect(Collectors.toMap(TransactionalMessage::getId, x -&gt; x)); if (!collect.isEmpty()) &#123; StringJoiner joiner = new StringJoiner(\",\", \"(\", \")\"); collect.keySet().forEach(x -&gt; joiner.add(x.toString())); contentDao.queryByMessageIds(joiner.toString()) .forEach(item -&gt; &#123; TransactionalMessage message = collect.get(item.getMessageId()); sendMessageSync(message, item.getContent()); &#125;); &#125; &#125;&#125; è¿™é‡Œæœ‰ä¸€ç‚¹å°šå¾…ä¼˜åŒ–ï¼šæ›´æ–°äº‹åŠ¡æ¶ˆæ¯è®°å½•çŠ¶æ€çš„æ–¹æ³•å¯ä»¥ä¼˜åŒ–ä¸ºæ‰¹é‡æ›´æ–°ï¼Œåœ¨limitæ¯”è¾ƒå¤§çš„æ—¶å€™ï¼Œæ‰¹é‡æ›´æ–°çš„æ•ˆç‡ä¼šæ›´é«˜ã€‚ æœ€åæ˜¯å®šæ—¶ä»»åŠ¡çš„é…ç½®ç±»ï¼š 123456789101112131415161718192021222324252627282930313233343536@Slf4j@RequiredArgsConstructor@Configuration@EnableSchedulingpublic class ScheduleJobAutoConfiguration &#123; private final TransactionalMessageManagementService managementService; /** * è¿™é‡Œç”¨çš„æ˜¯æœ¬åœ°çš„Redis,å®é™…ä¸Šè¦åšæˆé…ç½® */ private final RedissonClient redisson = Redisson.create(); @Scheduled(fixedDelay = 10000) public void transactionalMessageCompensationTask() throws Exception &#123; RLock lock = redisson.getLock(\"transactionalMessageCompensationTask\"); // ç­‰å¾…æ—¶é—´5ç§’,é¢„æœŸ300ç§’æ‰§è¡Œå®Œæ¯•,è¿™ä¸¤ä¸ªå€¼éœ€è¦æŒ‰ç…§å®é™…åœºæ™¯å®šåˆ¶ boolean tryLock = lock.tryLock(5, 300, TimeUnit.SECONDS); if (tryLock) &#123; try &#123; long start = System.currentTimeMillis(); log.info(\"å¼€å§‹æ‰§è¡Œäº‹åŠ¡æ¶ˆæ¯æ¨é€è¡¥å¿å®šæ—¶ä»»åŠ¡...\"); managementService.processPendingCompensationRecords(); long end = System.currentTimeMillis(); long delta = end - start; // ä»¥é˜²é”è¿‡æ—©é‡Šæ”¾ if (delta &lt; 5000) &#123; Thread.sleep(5000 - delta); &#125; log.info(\"æ‰§è¡Œäº‹åŠ¡æ¶ˆæ¯æ¨é€è¡¥å¿å®šæ—¶ä»»åŠ¡å®Œæ¯•,è€—æ—¶:&#123;&#125; ms...\", end - start); &#125; finally &#123; lock.unlock(); &#125; &#125; &#125;&#125; åŸºæœ¬ä»£ç ç¼–å†™å®Œï¼Œæ•´ä¸ªé¡¹ç›®çš„ç»“æ„å¦‚ä¸‹ï¼š æœ€åæ·»åŠ ä¸¤ä¸ªæµ‹è¯•ç±»ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849@RequiredArgsConstructor@Componentpublic class MockBusinessRunner implements CommandLineRunner &#123; private final MockBusinessService mockBusinessService; @Override public void run(String... args) throws Exception &#123; mockBusinessService.saveOrder(); &#125;&#125;@Slf4j@RequiredArgsConstructor@Servicepublic class MockBusinessService &#123; private final JdbcTemplate jdbcTemplate; private final TransactionalMessageService transactionalMessageService; private final ObjectMapper objectMapper; @Transactional(rollbackFor = Exception.class) public void saveOrder() throws Exception &#123; String orderId = UUID.randomUUID().toString(); BigDecimal amount = BigDecimal.valueOf(100L); Map&lt;String, Object&gt; message = new HashMap&lt;&gt;(); message.put(\"orderId\", orderId); message.put(\"amount\", amount); jdbcTemplate.update(\"INSERT INTO t_order(order_id,amount) VALUES (?,?)\", p -&gt; &#123; p.setString(1, orderId); p.setBigDecimal(2, amount); &#125;); String content = objectMapper.writeValueAsString(message); transactionalMessageService.sendTransactionalMessage( DefaultDestination.builder() .exchangeName(\"tm.test.exchange\") .queueName(\"tm.test.queue\") .routingKey(\"tm.test.key\") .exchangeType(ExchangeType.DIRECT) .build(), DefaultTxMessage.builder() .businessKey(orderId) .businessModule(\"SAVE_ORDER\") .content(content) .build() ); log.info(\"ä¿å­˜è®¢å•:&#123;&#125;æˆåŠŸ...\", orderId); &#125;&#125; æŸæ¬¡æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š 12020-02-05 21:10:13.287 INFO 49556 --- [ main] club.throwable.cm.MockBusinessService : ä¿å­˜è®¢å•:07a75323-460b-42cb-aa63-1a0a45ce19bfæˆåŠŸ... æ¨¡æ‹Ÿè®¢å•æ•°æ®æˆåŠŸä¿å­˜ï¼Œè€Œä¸”RabbitMQæ¶ˆæ¯åœ¨äº‹åŠ¡æˆåŠŸæäº¤åæ­£å¸¸å‘é€åˆ°RabbitMQæœåŠ¡ç«¯ä¸­ï¼Œå¦‚RabbitMQæ§åˆ¶å°æ•°æ®æ‰€ç¤ºã€‚ å°ç»“ äº‹åŠ¡æ¶ˆæ¯æ¨¡å—çš„è®¾è®¡ä»…ä»…æ˜¯ä½¿å¼‚æ­¥æ¶ˆæ¯æ¨é€è¿™ä¸ªåŠŸèƒ½å®ç°è¶‹å‘äºå®Œå¤‡ï¼Œå…¶å®ä¸€ä¸ªåˆç†çš„å¼‚æ­¥æ¶ˆæ¯äº¤äº’ç³»ç»Ÿï¼Œä¸€å®šä¼šæä¾›åŒæ­¥æŸ¥è¯¢æ¥å£ï¼Œè¿™ä¸€ç‚¹æ˜¯åŸºäºå¼‚æ­¥æ¶ˆæ¯æ²¡æœ‰å›è°ƒæˆ–è€…æ²¡æœ‰å“åº”çš„ç‰¹æ€§å¯¼è‡´çš„ã€‚ä¸€èˆ¬è€Œè¨€ï¼Œä¸€ä¸ªç³»ç»Ÿçš„ååé‡å’Œç³»ç»Ÿçš„å¼‚æ­¥åŒ–å¤„ç†å æ¯”æˆæ­£ç›¸å…³ï¼ˆè¿™ä¸€ç‚¹å¯ä»¥å‚è€ƒAmdahl's Lawï¼‰ï¼Œæ‰€ä»¥åœ¨ç³»ç»Ÿæ¶æ„è®¾è®¡å®é™…ä¸­åº”è¯¥å°½å¯èƒ½ä½¿ç”¨å¼‚æ­¥äº¤äº’ï¼Œæé«˜ç³»ç»Ÿååé‡åŒæ—¶å‡å°‘åŒæ­¥é˜»å¡å¸¦æ¥çš„æ— è°“ç­‰å¾…ã€‚äº‹åŠ¡æ¶ˆæ¯æ¨¡å—å¯ä»¥æ‰©å±•å‡ºä¸€ä¸ªåå°ç®¡ç†ï¼Œç”šè‡³å¯ä»¥é…åˆMicrometerã€Prometheuså’ŒGrafanaä½“ç³»åšå®æ—¶æ•°æ®ç›‘æ§ã€‚ æœ¬æ–‡demoé¡¹ç›®ä»“åº“ï¼šrabbit-transactional-message demoå¿…é¡»æœ¬åœ°å®‰è£…MySQLã€Rediså’ŒRabbitMQæ‰èƒ½æ­£å¸¸å¯åŠ¨ï¼Œæœ¬åœ°å¿…é¡»æ–°å»ºä¸€ä¸ªæ•°æ®åº“å‘½ålocalã€‚ ï¼ˆæœ¬æ–‡å®Œ c-5-d e-a-20200202 ç–«æƒ…ä¸¥é‡ï¼Œé©¬ä¸Šè¦å¼€å§‹åœ¨å®¶åŠå…¬ï¼Œå°‘å‡ºé—¨å¤šçœ‹ä¹¦ï¼‰","categories":[{"name":"In Action","slug":"In-Action","permalink":"http://throwable.club/blog/categories/In-Action/"},{"name":"Distributed Transaction","slug":"In-Action/Distributed-Transaction","permalink":"http://throwable.club/blog/categories/In-Action/Distributed-Transaction/"}],"tags":[{"name":"In Action","slug":"In-Action","permalink":"http://throwable.club/blog/tags/In-Action/"},{"name":"Distributed Transaction","slug":"Distributed-Transaction","permalink":"http://throwable.club/blog/tags/Distributed-Transaction/"}]},{"title":"ä»æºç ä¸Šç†è§£Nettyå¹¶å‘å·¥å…·-Promise","slug":"netty-common-promise-source-code-usage","date":"2020-01-23T15:34:42.000Z","updated":"2020-01-23T15:36:23.803Z","comments":true,"path":"2020/01/23/netty-common-promise-source-code-usage/","link":"","permalink":"http://throwable.club/2020/01/23/netty-common-promise-source-code-usage/","excerpt":"å‰æ æœ€è¿‘ä¸€ç›´åœ¨çœ‹Nettyç›¸å…³çš„å†…å®¹ï¼Œä¹Ÿåœ¨ç¼–å†™ä¸€ä¸ªè½»é‡çº§çš„RPCæ¡†æ¶æ¥ç»ƒæ‰‹ï¼Œé€”ä¸­å‘ç°äº†Nettyçš„æºç æœ‰å¾ˆå¤šäº®ç‚¹ï¼ŒæŸäº›å®ç°ç”šè‡³å¯ä»¥ç”¨è‹›åˆ»æ¥å½¢å®¹ã€‚å¦å¤–ï¼ŒNettyæä¾›çš„å·¥å…·ç±»ä¹Ÿæ˜¯ç›¸å½“ä¼˜ç§€ï¼Œå¯ä»¥å¼€ç®±å³ç”¨ã€‚è¿™é‡Œåˆ†æä¸€ä¸‹ä¸ªäººæ¯”è¾ƒå–œæ¬¢çš„é¢†åŸŸï¼Œå¹¶å‘æ–¹é¢çš„ä¸€ä¸ªNettyå·¥å…·æ¨¡å— - Promiseã€‚ ç¯å¢ƒç‰ˆæœ¬ï¼š Netty:4.1.44.Final JDK1.8","text":"å‰æ æœ€è¿‘ä¸€ç›´åœ¨çœ‹Nettyç›¸å…³çš„å†…å®¹ï¼Œä¹Ÿåœ¨ç¼–å†™ä¸€ä¸ªè½»é‡çº§çš„RPCæ¡†æ¶æ¥ç»ƒæ‰‹ï¼Œé€”ä¸­å‘ç°äº†Nettyçš„æºç æœ‰å¾ˆå¤šäº®ç‚¹ï¼ŒæŸäº›å®ç°ç”šè‡³å¯ä»¥ç”¨è‹›åˆ»æ¥å½¢å®¹ã€‚å¦å¤–ï¼ŒNettyæä¾›çš„å·¥å…·ç±»ä¹Ÿæ˜¯ç›¸å½“ä¼˜ç§€ï¼Œå¯ä»¥å¼€ç®±å³ç”¨ã€‚è¿™é‡Œåˆ†æä¸€ä¸‹ä¸ªäººæ¯”è¾ƒå–œæ¬¢çš„é¢†åŸŸï¼Œå¹¶å‘æ–¹é¢çš„ä¸€ä¸ªNettyå·¥å…·æ¨¡å— - Promiseã€‚ ç¯å¢ƒç‰ˆæœ¬ï¼š Netty:4.1.44.Final JDK1.8 Promiseç®€ä»‹ Promiseï¼Œä¸­æ–‡ç¿»è¯‘ä¸ºæ‰¿è¯ºæˆ–è€…è®¸è¯ºï¼Œå«ä¹‰æ˜¯äººä¸äººä¹‹é—´ï¼Œä¸€ä¸ªäººå¯¹å¦ä¸€ä¸ªäººæ‰€è¯´çš„å…·æœ‰ä¸€å®šæ†§æ†¬çš„è¯ï¼Œä¸€èˆ¬æ˜¯å¯ä»¥å®ç°çš„ã€‚ io.netty.util.concurrent.Promiseåœ¨æ³¨é‡Šä¸­åªæœ‰ä¸€å¥è¯ï¼šç‰¹æ®Šçš„å¯å†™çš„io.netty.util.concurrent.Futureï¼ˆPromiseæ¥å£æ˜¯io.netty.util.concurrent.Futureçš„å­æ¥å£ï¼‰ã€‚è€Œio.netty.util.concurrent.Futureæ˜¯java.util.concurrent.Futureçš„æ‰©å±•ï¼Œè¡¨ç¤ºä¸€ä¸ªå¼‚æ­¥æ“ä½œçš„ç»“æœã€‚æˆ‘ä»¬çŸ¥é“ï¼ŒJDKå¹¶å‘åŒ…ä¸­çš„Futureæ˜¯ä¸å¯å†™ï¼Œä¹Ÿæ²¡æœ‰æä¾›å¯ç›‘å¬çš„å…¥å£ï¼ˆæ²¡æœ‰åº”ç”¨è§‚å¯Ÿè€…æ¨¡å¼ï¼‰ï¼Œè€ŒPromiseå¾ˆå¥½åœ°å¼¥è¡¥äº†è¿™ä¸¤ä¸ªé—®é¢˜ã€‚å¦ä¸€æ–¹é¢ä»ç»§æ‰¿å…³ç³»æ¥çœ‹ï¼ŒDefaultPromiseæ˜¯è¿™äº›æ¥å£çš„æœ€ç»ˆå®ç°ç±»ï¼Œæ‰€ä»¥åˆ†ææºç çš„æ—¶å€™éœ€è¦æŠŠé‡å¿ƒæ”¾åœ¨DefaultPromiseç±»ã€‚ä¸€èˆ¬ä¸€ä¸ªæ¨¡å—æä¾›çš„åŠŸèƒ½éƒ½ç”±æ¥å£å®šä¹‰ï¼Œè¿™é‡Œåˆ†æä¸€ä¸‹ä¸¤ä¸ªæ¥å£çš„åŠŸèƒ½åˆ—è¡¨ï¼š io.netty.util.concurrent.Promise io.netty.util.concurrent.Future å…ˆçœ‹io.netty.util.concurrent.Futureæ¥å£ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546public interface Future&lt;V&gt; extends java.util.concurrent.Future&lt;V&gt; &#123; // I/Oæ“ä½œæ˜¯å¦æ‰§è¡ŒæˆåŠŸ boolean isSuccess(); // æ ‡è®°æ˜¯å¦å¯ä»¥é€šè¿‡ä¸‹é¢çš„cancel(boolean mayInterruptIfRunning)å–æ¶ˆI/Oæ“ä½œ boolean isCancellable(); // è¿”å›I/Oæ“ä½œçš„å¼‚å¸¸å®ä¾‹ - å¦‚æœI/Oæ“ä½œæœ¬èº«æ˜¯æˆåŠŸçš„ï¼Œæ­¤æ–¹æ³•è¿”å›null Throwable cause(); // ä¸ºå½“å‰Futureå®ä¾‹æ·»åŠ ç›‘å¬Futureæ“ä½œå®Œæˆçš„ç›‘å¬å™¨ - isDone()æ–¹æ³•æ¿€æ´»ä¹‹åæ‰€æœ‰ç›‘å¬å™¨å®ä¾‹ä¼šå¾—åˆ°å›è°ƒ Future&lt;V&gt; addListener(GenericFutureListener&lt;? extends Future&lt;? super V&gt;&gt; listener); Future&lt;V&gt; addListeners(GenericFutureListener&lt;? extends Future&lt;? super V&gt;&gt;... listeners); // ä¸ºå½“å‰Futureç§»é™¤ç›‘å¬Futureæ“ä½œå®Œæˆçš„ç›‘å¬å™¨ Future&lt;V&gt; removeListener(GenericFutureListener&lt;? extends Future&lt;? super V&gt;&gt; listener); Future&lt;V&gt; removeListeners(GenericFutureListener&lt;? extends Future&lt;? super V&gt;&gt;... listeners); // åŒæ­¥ç­‰å¾…Futureå®Œæˆå¾—åˆ°æœ€ç»ˆç»“æœï¼ˆæˆåŠŸï¼‰æˆ–è€…æŠ›å‡ºå¼‚å¸¸ï¼ˆå¤±è´¥ï¼‰ï¼Œå“åº”ä¸­æ–­ Future&lt;V&gt; sync() throws InterruptedException; // åŒæ­¥ç­‰å¾…Futureå®Œæˆå¾—åˆ°æœ€ç»ˆç»“æœï¼ˆæˆåŠŸï¼‰æˆ–è€…æŠ›å‡ºå¼‚å¸¸ï¼ˆå¤±è´¥ï¼‰ï¼Œä¸å“åº”ä¸­æ–­ Future&lt;V&gt; syncUninterruptibly(); // ç­‰å¾…Futureå®Œæˆï¼Œå“åº”ä¸­æ–­ Future&lt;V&gt; await() throws InterruptedException; // ç­‰å¾…Futureå®Œæˆï¼Œä¸å“åº”ä¸­æ–­ Future&lt;V&gt; awaitUninterruptibly(); // å¸¦è¶…æ—¶æ—¶é™çš„ç­‰å¾…Futureå®Œæˆï¼Œå“åº”ä¸­æ–­ boolean await(long timeout, TimeUnit unit) throws InterruptedException; boolean await(long timeoutMillis) throws InterruptedException; // å¸¦è¶…æ—¶æ—¶é™çš„ç­‰å¾…Futureå®Œæˆï¼Œä¸å“åº”ä¸­æ–­ boolean awaitUninterruptibly(long timeout, TimeUnit unit); boolean awaitUninterruptibly(long timeoutMillis); // éé˜»å¡é©¬ä¸Šè¿”å›Futureçš„ç»“æœï¼Œå¦‚æœFutureæœªå®Œæˆï¼Œæ­¤æ–¹æ³•ä¸€å®šè¿”å›nullï¼›æœ‰äº›åœºæ™¯ä¸‹å¦‚æœFutureæˆåŠŸè·å–åˆ°çš„ç»“æœæ˜¯nullåˆ™éœ€è¦äºŒæ¬¡æ£€æŸ¥isDone()æ–¹æ³•æ˜¯å¦ä¸ºtrue V getNow(); // å–æ¶ˆå½“å‰Futureå®ä¾‹çš„æ‰§è¡Œï¼Œå¦‚æœå–æ¶ˆæˆåŠŸä¼šæŠ›å‡ºCancellationExceptionå¼‚å¸¸ @Override boolean cancel(boolean mayInterruptIfRunning);&#125; sync()å’Œawait()æ–¹æ³•ç±»ä¼¼ï¼Œåªæ˜¯sync()ä¼šæ£€æŸ¥å¼‚å¸¸æ‰§è¡Œçš„æƒ…å†µï¼Œä¸€æ—¦å‘ç°æ‰§è¡Œå¼‚å¸¸é©¬ä¸ŠæŠŠå¼‚å¸¸å®ä¾‹åŒ…è£…æŠ›å‡ºï¼Œè€Œawait()æ–¹æ³•å¯¹å¼‚å¸¸æ— æ„ŸçŸ¥ã€‚ æ¥ç€çœ‹io.netty.util.concurrent.Promiseæ¥å£ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243public interface Promise&lt;V&gt; extends Future&lt;V&gt; &#123; // æ ‡è®°å½“å‰FutureæˆåŠŸï¼Œè®¾ç½®ç»“æœï¼Œå¦‚æœè®¾ç½®æˆåŠŸï¼Œåˆ™é€šçŸ¥æ‰€æœ‰çš„ç›‘å¬å™¨ï¼Œå¦‚æœFutureå·²ç»æˆåŠŸæˆ–è€…å¤±è´¥ï¼Œåˆ™æŠ›å‡ºIllegalStateException Promise&lt;V&gt; setSuccess(V result); // æ ‡è®°å½“å‰FutureæˆåŠŸï¼Œè®¾ç½®ç»“æœï¼Œå¦‚æœè®¾ç½®æˆåŠŸï¼Œåˆ™é€šçŸ¥æ‰€æœ‰çš„ç›‘å¬å™¨å¹¶ä¸”è¿”å›trueï¼Œå¦åˆ™è¿”å›false boolean trySuccess(V result); // æ ‡è®°å½“å‰Futureå¤±è´¥ï¼Œè®¾ç½®ç»“æœä¸ºå¼‚å¸¸å®ä¾‹ï¼Œå¦‚æœè®¾ç½®æˆåŠŸï¼Œåˆ™é€šçŸ¥æ‰€æœ‰çš„ç›‘å¬å™¨ï¼Œå¦‚æœFutureå·²ç»æˆåŠŸæˆ–è€…å¤±è´¥ï¼Œåˆ™æŠ›å‡ºIllegalStateException Promise&lt;V&gt; setFailure(Throwable cause); // æ ‡è®°å½“å‰Futureå¤±è´¥ï¼Œè®¾ç½®ç»“æœä¸ºå¼‚å¸¸å®ä¾‹ï¼Œå¦‚æœè®¾ç½®æˆåŠŸï¼Œåˆ™é€šçŸ¥æ‰€æœ‰çš„ç›‘å¬å™¨å¹¶ä¸”è¿”å›trueï¼Œå¦åˆ™è¿”å›false boolean tryFailure(Throwable cause); // æ ‡è®°å½“å‰çš„Promiseå®ä¾‹ä¸ºä¸å¯å–æ¶ˆï¼Œè®¾ç½®æˆåŠŸè¿”å›trueï¼Œå¦åˆ™è¿”å›false boolean setUncancellable(); // ä¸‹é¢çš„æ–¹æ³•å’Œio.netty.util.concurrent.Futureä¸­çš„æ–¹æ³•åŸºæœ¬ä¸€è‡´ï¼Œåªæ˜¯ä¿®æ”¹äº†è¿”å›ç±»å‹ä¸ºPromise @Override Promise&lt;V&gt; addListener(GenericFutureListener&lt;? extends Future&lt;? super V&gt;&gt; listener); @Override Promise&lt;V&gt; addListeners(GenericFutureListener&lt;? extends Future&lt;? super V&gt;&gt;... listeners); @Override Promise&lt;V&gt; removeListener(GenericFutureListener&lt;? extends Future&lt;? super V&gt;&gt; listener); @Override Promise&lt;V&gt; removeListeners(GenericFutureListener&lt;? extends Future&lt;? super V&gt;&gt;... listeners); @Override Promise&lt;V&gt; await() throws InterruptedException; @Override Promise&lt;V&gt; awaitUninterruptibly(); @Override Promise&lt;V&gt; sync() throws InterruptedException; @Override Promise&lt;V&gt; syncUninterruptibly();&#125; åˆ°æ­¤ï¼ŒPromiseæ¥å£çš„æ‰€æœ‰åŠŸèƒ½éƒ½åˆ†æå®Œæ¯•ï¼Œæ¥ä¸‹æ¥ä»æºç è§’åº¦è¯¦ç»†åˆ†æPromiseçš„å®ç°ã€‚ Promiseæºç å®ç° Promiseçš„å®ç°ç±»ä¸ºio.netty.util.concurrent.DefaultPromiseï¼ˆå…¶å®DefaultPromiseè¿˜æœ‰å¾ˆå¤šå­ç±»ï¼ŒæŸäº›å®ç°æ˜¯ä¸ºäº†å®šåˆ¶ç‰¹å®šçš„åœºæ™¯åšäº†æ‰©å±•ï¼‰ï¼Œè€ŒDefaultPromiseç»§æ‰¿è‡ªio.netty.util.concurrent.AbstractFutureï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243public abstract class AbstractFuture&lt;V&gt; implements Future&lt;V&gt; &#123; // æ°¸ä¹…é˜»å¡ç­‰å¾…è·å–ç»“æœçš„æ–¹æ³• @Override public V get() throws InterruptedException, ExecutionException &#123; // è°ƒç”¨å“åº”ä¸­æ–­çš„æ°¸ä¹…ç­‰å¾…æ–¹æ³•è¿›è¡Œé˜»å¡ await(); // ä»æ°¸ä¹…é˜»å¡ä¸­å”¤é†’åï¼Œå…ˆåˆ¤æ–­Futureæ˜¯å¦æ‰§è¡Œå¼‚å¸¸ Throwable cause = cause(); if (cause == null) &#123; // å¼‚å¸¸ä¸ºç©ºè¯´æ˜æ‰§è¡ŒæˆåŠŸï¼Œè°ƒç”¨getNow()æ–¹æ³•è¿”å›ç»“æœ return getNow(); &#125; // å¼‚å¸¸ä¸ºç©ºä¸ä¸ºç©ºï¼Œè¿™é‡ŒåŒºåˆ†ç‰¹å®šçš„å–æ¶ˆå¼‚å¸¸åˆ™è½¬æ¢ä¸ºCancellationExceptionæŠ›å‡º if (cause instanceof CancellationException) &#123; throw (CancellationException) cause; &#125; // éå–æ¶ˆå¼‚å¸¸çš„å…¶ä»–æ‰€æœ‰å¼‚å¸¸éƒ½è¢«åŒ…è£…ä¸ºæ‰§è¡Œå¼‚å¸¸ExecutionExceptionæŠ›å‡º throw new ExecutionException(cause); &#125; // å¸¦è¶…æ—¶é˜»å¡ç­‰å¾…è·å–ç»“æœçš„æ–¹æ³• @Override public V get(long timeout, TimeUnit unit) throws InterruptedException, ExecutionException, TimeoutException &#123; // è°ƒç”¨å“åº”ä¸­æ–­çš„å¸¦è¶…æ—¶æ—¶é™ç­‰å¾…æ–¹æ³•è¿›è¡Œé˜»å¡ if (await(timeout, unit)) &#123; // ä»å¸¦è¶…æ—¶æ—¶é™é˜»å¡ä¸­å”¤é†’åï¼Œå…ˆåˆ¤æ–­Futureæ˜¯å¦æ‰§è¡Œå¼‚å¸¸ Throwable cause = cause(); if (cause == null) &#123; // å¼‚å¸¸ä¸ºç©ºè¯´æ˜æ‰§è¡ŒæˆåŠŸï¼Œè°ƒç”¨getNow()æ–¹æ³•è¿”å›ç»“æœ return getNow(); &#125; // å¼‚å¸¸ä¸ºç©ºä¸ä¸ºç©ºï¼Œè¿™é‡ŒåŒºåˆ†ç‰¹å®šçš„å–æ¶ˆå¼‚å¸¸åˆ™è½¬æ¢ä¸ºCancellationExceptionæŠ›å‡º if (cause instanceof CancellationException) &#123; throw (CancellationException) cause; &#125; // åœ¨éç­‰å¾…è¶…æ—¶çš„å‰æä¸‹ï¼Œéå–æ¶ˆå¼‚å¸¸çš„å…¶ä»–æ‰€æœ‰å¼‚å¸¸éƒ½è¢«åŒ…è£…ä¸ºæ‰§è¡Œå¼‚å¸¸ExecutionExceptionæŠ›å‡º throw new ExecutionException(cause); &#125; // æ–¹æ³•æ­¥å…¥æ­¤å¤„è¯´æ˜ç­‰å¾…è¶…æ—¶ï¼Œåˆ™æŠ›å‡ºè¶…æ—¶å¼‚å¸¸TimeoutException throw new TimeoutException(); &#125;&#125; AbstractFutureä»…ä»…å¯¹get()å’Œget(long timeout, TimeUnit unit)ä¸¤ä¸ªæ–¹æ³•è¿›è¡Œäº†å®ç°ï¼Œå…¶å®è¿™ä¸¤å¤„çš„å®ç°å’Œjava.util.concurrent.FutureTaskä¸­çš„å®ç°æ–¹å¼ååˆ†ç›¸ä¼¼ã€‚ DefaultPromiseçš„æºç æ¯”è¾ƒå¤šï¼Œè¿™é‡Œåˆ†å¼€å¤šä¸ªéƒ¨åˆ†å»é˜…è¯»ï¼Œå…ˆçœ‹å®ƒçš„å±æ€§å’Œæ„é€ å‡½æ•°ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283public class DefaultPromise&lt;V&gt; extends AbstractFuture&lt;V&gt; implements Promise&lt;V&gt; &#123; // æ­£å¸¸æ—¥å¿—çš„æ—¥å¿—å¥æŸ„ï¼ŒInternalLoggeræ˜¯Nettyå†…éƒ¨å°è£…çš„æ—¥å¿—æ¥å£ private static final InternalLogger logger = InternalLoggerFactory.getInstance(DefaultPromise.class); // ä»»åŠ¡æ‹’ç»æ‰§è¡Œæ—¶å€™çš„æ—¥å¿—å¥æŸ„ - Promiseéœ€è¦ä½œä¸ºä¸€ä¸ªä»»åŠ¡æäº¤åˆ°çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œå¦‚æœä»»åŠ¡æ‹’ç»åˆ™ä½¿ç”¨æ­¤æ—¥å¿—å¥æŸ„æ‰“å°æ—¥å¿— private static final InternalLogger rejectedExecutionLogger = InternalLoggerFactory.getInstance(DefaultPromise.class.getName() + \".rejectedExecution\"); // ç›‘å¬å™¨çš„æœ€å¤§æ ˆæ·±åº¦ï¼Œé»˜è®¤å€¼ä¸º8ï¼Œè¿™ä¸ªå€¼æ˜¯é˜²æ­¢åµŒå¥—å›è°ƒè°ƒç”¨çš„æ—¶å€™æ ˆæ·±åº¦è¿‡å¤§å¯¼è‡´å†…å­˜æº¢å‡ºï¼Œåé¢ä¼šä¸¾ä¸ªä¾‹å­è¯´æ˜å®ƒçš„ç”¨æ³• private static final int MAX_LISTENER_STACK_DEPTH = Math.min(8, SystemPropertyUtil.getInt(\"io.netty.defaultPromise.maxListenerStackDepth\", 8)); // ç»“æœæ›´æ–°å™¨ï¼Œç”¨äºCASæ›´æ–°ç»“æœresultçš„å€¼ @SuppressWarnings(\"rawtypes\") private static final AtomicReferenceFieldUpdater&lt;DefaultPromise, Object&gt; RESULT_UPDATER = AtomicReferenceFieldUpdater.newUpdater(DefaultPromise.class, Object.class, \"result\"); // ç”¨äºå¡«å……resultçš„å€¼ï¼Œå½“è®¾ç½®ç»“æœresultä¼ å…¥nullï¼ŒPromiseæ‰§è¡ŒæˆåŠŸï¼Œç”¨è¿™ä¸ªå€¼å»è¡¨ç¤ºæˆåŠŸçš„ç»“æœ private static final Object SUCCESS = new Object(); // ç”¨äºå¡«å……resultçš„å€¼ï¼Œè¡¨ç¤ºPromiseä¸èƒ½è¢«å–æ¶ˆ private static final Object UNCANCELLABLE = new Object(); // CancellationExceptionå®ä¾‹çš„æŒæœ‰å™¨ï¼Œç”¨äºåˆ¤æ–­Promiseå–æ¶ˆçŠ¶æ€å’ŒæŠ›å‡ºCancellationException private static final CauseHolder CANCELLATION_CAUSE_HOLDER = new CauseHolder(ThrowableUtil.unknownStackTrace( new CancellationException(), DefaultPromise.class, \"cancel(...)\")); // CANCELLATION_CAUSE_HOLDERçš„å¼‚å¸¸æ ˆä¿¡æ¯å…ƒç´ æ•°ç»„ private static final StackTraceElement[] CANCELLATION_STACK = CANCELLATION_CAUSE_HOLDER.cause.getStackTrace(); // çœŸæ­£çš„ç»“æœå¯¹è±¡ï¼Œä½¿ç”¨Objectç±»å‹ï¼Œæœ€ç»ˆæœ‰å¯èƒ½ä¸ºnullã€çœŸæ­£çš„ç»“æœå®ä¾‹ã€SUCCESSã€UNCANCELLABLEæˆ–è€…CANCELLATION_CAUSE_HOLDERç­‰ç­‰ private volatile Object result; // äº‹ä»¶æ‰§è¡Œå™¨ï¼Œè¿™é‡Œæš‚æ—¶ä¸åšå±•å¼€ï¼Œå¯ä»¥ç†è§£ä¸ºå•ä¸ªè°ƒåº¦çº¿ç¨‹ private final EventExecutor executor; // ç›‘å¬å™¨é›†åˆï¼Œå¯èƒ½æ˜¯å•ä¸ªGenericFutureListenerå®ä¾‹æˆ–è€…DefaultFutureListenersï¼ˆç›‘å¬å™¨é›†åˆï¼‰å®ä¾‹ private Object listeners; // ç­‰å¾…è·å–ç»“æœçš„çº¿ç¨‹æ•°é‡ private short waiters; // æ ‡è®°æ˜¯å¦æ­£åœ¨å›è°ƒç›‘å¬å™¨ private boolean notifyingListeners; // æ„é€ å‡½æ•°ä¾èµ–äºEventExecutor public DefaultPromise(EventExecutor executor) &#123; this.executor = checkNotNull(executor, \"executor\"); &#125; protected DefaultPromise() &#123; // only for subclasses - è¿™ä¸ªæ„é€ å‡½æ•°é¢„ç•™ç»™å­ç±» executor = null; &#125; // ... çœç•¥å…¶ä»–ä»£ç  ... // ç§æœ‰é™æ€å†…éƒ¨ç±»ï¼Œç”¨äºå­˜æ”¾Throwableå®ä¾‹ï¼Œä¹Ÿå°±æ˜¯æŒæœ‰å¼‚å¸¸çš„åŸå› å®ä¾‹ private static final class CauseHolder &#123; final Throwable cause; CauseHolder(Throwable cause) &#123; this.cause = cause; &#125; &#125; // ç§æœ‰é™æ€å†…éƒ¨ç±»ï¼Œç”¨äºè¦†ç›–CancellationExceptionçš„æ ˆä¿¡æ¯ä¸ºå‰é¢å®šä¹‰çš„CANCELLATION_STACKï¼ŒåŒæ—¶è¦†ç›–äº†toString()è¿”å›CancellationExceptionçš„å…¨ç±»å private static final class LeanCancellationException extends CancellationException &#123; private static final long serialVersionUID = 2794674970981187807L; @Override public Throwable fillInStackTrace() &#123; setStackTrace(CANCELLATION_STACK); return this; &#125; @Override public String toString() &#123; return CancellationException.class.getName(); &#125; &#125; // ... çœç•¥å…¶ä»–ä»£ç  ...&#125; Promiseç›®å‰æ”¯æŒä¸¤ç§ç±»å‹çš„ç›‘å¬å™¨ï¼š GenericFutureListenerï¼šæ”¯æŒæ³›å‹çš„Futureç›‘å¬å™¨ã€‚ GenericProgressiveFutureListenerï¼šå®ƒæ˜¯GenericFutureListenerçš„å­ç±»ï¼Œæ”¯æŒè¿›åº¦è¡¨ç¤ºå’Œæ”¯æŒæ³›å‹çš„Futureç›‘å¬å™¨ï¼ˆæœ‰äº›åœºæ™¯éœ€è¦å¤šä¸ªæ­¥éª¤å®ç°ï¼Œç±»ä¼¼äºè¿›åº¦æ¡é‚£æ ·ï¼‰ã€‚ 1234567891011// GenericFutureListenerpublic interface GenericFutureListener&lt;F extends Future&lt;?&gt;&gt; extends EventListener &#123; void operationComplete(F future) throws Exception;&#125;// GenericProgressiveFutureListenerpublic interface GenericProgressiveFutureListener&lt;F extends ProgressiveFuture&lt;?&gt;&gt; extends GenericFutureListener&lt;F&gt; &#123; void operationProgressed(F future, long progress, long total) throws Exception;&#125; ä¸ºäº†è®©Promiseæ”¯æŒå¤šä¸ªç›‘å¬å™¨ï¼ŒNettyæ·»åŠ äº†ä¸€ä¸ªé»˜è®¤ä¿®é¥°ç¬¦ä¿®é¥°çš„DefaultFutureListenersç±»ç”¨äºä¿å­˜ç›‘å¬å™¨å®ä¾‹æ•°ç»„ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677// DefaultFutureListenersfinal class DefaultFutureListeners &#123; private GenericFutureListener&lt;? extends Future&lt;?&gt;&gt;[] listeners; private int size; private int progressiveSize; // the number of progressive listeners // è¿™ä¸ªæ„é€ ç›¸å¯¹ç‰¹åˆ«ï¼Œæ˜¯ä¸ºäº†è®©Promiseä¸­çš„listenersï¼ˆObjectç±»å‹ï¼‰å®ä¾‹ç”±å•ä¸ªGenericFutureListenerå®ä¾‹è½¬æ¢ä¸ºDefaultFutureListenersç±»å‹ @SuppressWarnings(\"unchecked\") DefaultFutureListeners(GenericFutureListener&lt;? extends Future&lt;?&gt;&gt; first, GenericFutureListener&lt;? extends Future&lt;?&gt;&gt; second) &#123; listeners = new GenericFutureListener[2]; listeners[0] = first; listeners[1] = second; size = 2; if (first instanceof GenericProgressiveFutureListener) &#123; progressiveSize ++; &#125; if (second instanceof GenericProgressiveFutureListener) &#123; progressiveSize ++; &#125; &#125; public void add(GenericFutureListener&lt;? extends Future&lt;?&gt;&gt; l) &#123; GenericFutureListener&lt;? extends Future&lt;?&gt;&gt;[] listeners = this.listeners; final int size = this.size; // æ³¨æ„è¿™é‡Œï¼Œæ¯æ¬¡æ‰©å®¹æ•°ç»„é•¿åº¦æ˜¯åŸæ¥çš„2å€ if (size == listeners.length) &#123; this.listeners = listeners = Arrays.copyOf(listeners, size &lt;&lt; 1); &#125; // æŠŠå½“å‰çš„GenericFutureListeneråŠ å…¥æ•°ç»„ä¸­ listeners[size] = l; // ç›‘å¬å™¨æ€»æ•°é‡åŠ 1 this.size = size + 1; // å¦‚æœä¸ºGenericProgressiveFutureListenerï¼Œåˆ™å¸¦è¿›åº¦æŒ‡ç¤ºçš„ç›‘å¬å™¨æ€»æ•°é‡åŠ 1 if (l instanceof GenericProgressiveFutureListener) &#123; progressiveSize ++; &#125; &#125; public void remove(GenericFutureListener&lt;? extends Future&lt;?&gt;&gt; l) &#123; final GenericFutureListener&lt;? extends Future&lt;?&gt;&gt;[] listeners = this.listeners; int size = this.size; for (int i = 0; i &lt; size; i ++) &#123; if (listeners[i] == l) &#123; // è®¡ç®—éœ€è¦éœ€è¦ç§»åŠ¨çš„ç›‘å¬å™¨çš„ä¸‹æ ‡ int listenersToMove = size - i - 1; if (listenersToMove &gt; 0) &#123; // listenersToMoveåé¢çš„å…ƒç´ å…¨éƒ¨ç§»åŠ¨åˆ°æ•°ç»„çš„å‰ç«¯ System.arraycopy(listeners, i + 1, listeners, i, listenersToMove); &#125; // å½“å‰ç›‘å¬å™¨æ€»é‡çš„æœ€åä¸€ä¸ªä½ç½®è®¾ç½®ä¸ºnullï¼Œæ•°é‡å‡1 listeners[-- size] = null; this.size = size; // å¦‚æœç›‘å¬å™¨æ˜¯GenericProgressiveFutureListenerï¼Œåˆ™å¸¦è¿›åº¦æŒ‡ç¤ºçš„ç›‘å¬å™¨æ€»æ•°é‡å‡1 if (l instanceof GenericProgressiveFutureListener) &#123; progressiveSize --; &#125; return; &#125; &#125; &#125; // è¿”å›ç›‘å¬å™¨å®ä¾‹æ•°ç»„ public GenericFutureListener&lt;? extends Future&lt;?&gt;&gt;[] listeners() &#123; return listeners; &#125; // è¿”å›ç›‘å¬å™¨æ€»æ•°é‡ public int size() &#123; return size; &#125; // è¿”å›å¸¦è¿›åº¦æŒ‡ç¤ºçš„ç›‘å¬å™¨æ€»æ•°é‡ public int progressiveSize() &#123; return progressiveSize; &#125;&#125; æ¥ä¸‹æ¥çœ‹DefaultPromiseçš„å‰©ä½™æ–¹æ³•å®ç°ï¼Œç¬”è€…è§‰å¾—DefaultPromiseæ–¹æ³•å®ç°åœ¨ä»£ç é¡ºåºä¸Šæ˜¯æœ‰ä¸€å®šçš„è‰ºæœ¯çš„ã€‚å…ˆçœ‹å‡ ä¸ªåˆ¤æ–­Promiseæ‰§è¡ŒçŠ¶æ€çš„æ–¹æ³•ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879public class DefaultPromise&lt;V&gt; extends AbstractFuture&lt;V&gt; implements Promise&lt;V&gt; &#123; // ... çœç•¥å…¶ä»–ä»£ç  ... @Override public boolean setUncancellable() &#123; // é€šè¿‡ç»“æœæ›´æ–°å™¨CASæ›´æ–°resultä¸ºUNCANCELLABLEï¼ŒæœŸæœ›æ—§å€¼ä¸ºnullï¼Œæ›´æ–°å€¼ä¸ºUNCANCELLABLEå±æ€§ï¼Œå¦‚æœæˆåŠŸåˆ™è¿”å›true if (RESULT_UPDATER.compareAndSet(this, null, UNCANCELLABLE)) &#123; return true; &#125; Object result = this.result; // æ­¥å…¥è¿™é‡Œè¯´æ˜resultå½“å‰å€¼ä¸ä¸ºnullï¼ŒisDone0()å’ŒisCancelled0()éƒ½æ˜¯ç»ˆæ€ï¼Œè¿™é‡Œå¦‚æœå‘½ä¸­ç»ˆæ€å°±è¿”å›false //ï¼ˆç¬”è€…æ³¨ï¼šå…¶å®å¯ä»¥è¿™æ ·è®¤ä¸ºï¼Œè¿™é‡Œresultä¸èƒ½ä¸ºnullï¼Œå¦‚æœä¸ä¸ºç»ˆæ€ï¼Œå®ƒåªèƒ½æ˜¯UNCANCELLABLEå±æ€§å®ä¾‹ï¼‰ return !isDone0(result) || !isCancelled0(result); &#125; @Override public boolean isSuccess() &#123; Object result = this.result; // å¦‚æœæ‰§è¡ŒæˆåŠŸï¼Œåˆ™ç»“æœä¸ä¸ºnullï¼ŒåŒæ—¶ä¸ä¸ºUNCANCELLABLEï¼ŒåŒæ—¶ä¸ä¸ºCauseHolderç±»å‹ //ï¼ˆç¬”è€…æ³¨ï¼šå…¶å®å¯ä»¥è¿™æ ·è®¤ä¸ºï¼ŒPromiseä¸ºæˆåŠŸï¼Œåˆ™resultåªèƒ½æ˜¯ä¸€ä¸ªå¼€å‘è€…å®šä¹‰çš„å®ä¾‹æˆ–è€…SUCCESSå±æ€§å®ä¾‹ï¼‰ return result != null &amp;&amp; result != UNCANCELLABLE &amp;&amp; !(result instanceof CauseHolder); &#125; @Override public boolean isCancellable() &#123; // æ˜¯å¦å¯å–æ¶ˆçš„ï¼Œresultä¸ºnullè¯´æ˜Promiseå¤„äºåˆå§‹åŒ–çŠ¶æ€å°šæœªæ‰§è¡Œï¼Œåˆ™è®¤ä¸ºå¯ä»¥å–æ¶ˆ return result == null; &#125; @Override public Throwable cause() &#123; // é€šè¿‡å½“å‰resultè·å–Throwableå®ä¾‹ return cause0(result); &#125; private Throwable cause0(Object result) &#123; // resultéCauseHolderç±»å‹ï¼Œåˆ™ç›´æ¥è¿”å›null if (!(result instanceof CauseHolder)) &#123; return null; &#125; // å¦‚æœresultä¸ºCANCELLATION_CAUSE_HOLDERï¼ˆé™æ€CancellationExceptionçš„æŒæœ‰ï¼‰ if (result == CANCELLATION_CAUSE_HOLDER) &#123; // åˆ™æ–°å»ºä¸€ä¸ªè‡ªå®šä¹‰LeanCancellationExceptionå®ä¾‹ CancellationException ce = new LeanCancellationException(); // å¦‚æœCASæ›´æ–°ç»“æœresultä¸ºLeanCancellationExceptionæ–°å®ä¾‹åˆ™è¿”å› if (RESULT_UPDATER.compareAndSet(this, CANCELLATION_CAUSE_HOLDER, new CauseHolder(ce))) &#123; return ce; &#125; // èµ°åˆ°è¿™é‡Œè¯´æ˜äº†resultæ˜¯éCANCELLATION_CAUSE_HOLDERçš„è‡ªå®šä¹‰CauseHolderå®ä¾‹ result = this.result; &#125; // å…œåº•è¿”å›CauseHolderæŒæœ‰çš„cause return ((CauseHolder) result).cause; &#125; // é™æ€æ–¹æ³•ï¼Œåˆ¤æ–­Promiseæ˜¯å¦ä¸ºå–æ¶ˆï¼Œä¾æ®æ˜¯resultå¿…é¡»æ˜¯CauseHolderç±»å‹ï¼ŒåŒæ—¶CauseHolderä¸­çš„causeå¿…é¡»ä¸ºCancellationExceptionç±»å‹æˆ–è€…å…¶å­ç±» private static boolean isCancelled0(Object result) &#123; return result instanceof CauseHolder &amp;&amp; ((CauseHolder) result).cause instanceof CancellationException; &#125; // é™æ€æ–¹æ³•ï¼Œåˆ¤æ–­Promiseæ˜¯å¦å®Œæˆï¼Œä¾æ®æ˜¯resultä¸ä¸ºnullåŒæ—¶ä¸ä¸ºUNCANCELLABLEå±æ€§å®ä¾‹ private static boolean isDone0(Object result) &#123; return result != null &amp;&amp; result != UNCANCELLABLE; &#125; // åˆ¤æ–­Promiseå®ä¾‹æ˜¯å¦å–æ¶ˆ @Override public boolean isCancelled() &#123; return isCancelled0(result); &#125; // åˆ¤æ–­Promiseå®ä¾‹æ˜¯å¦å®Œæˆ @Override public boolean isDone() &#123; return isDone0(result); &#125; // ... çœç•¥å…¶ä»–ä»£ç  ...&#125; æ¥ç€çœ‹ç›‘å¬å™¨çš„æ·»åŠ å’Œç§»é™¤æ–¹æ³•ï¼ˆè¿™å…¶ä¸­ä¹ŸåŒ…å«äº†é€šçŸ¥ç›‘å¬å™¨çš„é€»è¾‘ï¼‰ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188public class DefaultPromise&lt;V&gt; extends AbstractFuture&lt;V&gt; implements Promise&lt;V&gt; &#123; // ... çœç•¥å…¶ä»–ä»£ç  ... @Override public Promise&lt;V&gt; addListener(GenericFutureListener&lt;? extends Future&lt;? super V&gt;&gt; listener) &#123; // å…¥å‚éç©ºæ ¡éªŒ checkNotNull(listener, \"listener\"); // åŠ é”ï¼Œé”å®šçš„å¯¹è±¡æ˜¯Promiseå®ä¾‹è‡ªèº« synchronized (this) &#123; // æ·»åŠ ç›‘å¬å™¨ addListener0(listener); &#125; // å¦‚æœPromiseå®ä¾‹å·²ç»æ‰§è¡Œå®Œæ¯•ï¼Œåˆ™é€šçŸ¥ç›‘å¬å™¨è¿›è¡Œå›è°ƒ if (isDone()) &#123; notifyListeners(); &#125; return this; &#125; @Override public Promise&lt;V&gt; addListeners(GenericFutureListener&lt;? extends Future&lt;? super V&gt;&gt;... listeners) &#123; // å…¥å‚éç©ºæ ¡éªŒ checkNotNull(listeners, \"listeners\"); // åŠ é”ï¼Œé”å®šçš„å¯¹è±¡æ˜¯Promiseå®ä¾‹è‡ªèº« synchronized (this) &#123; // éå†å…¥å‚æ•°ç»„æ·»åŠ ç›‘å¬å™¨ï¼Œæœ‰ç©ºå…ƒç´ ç›´æ¥è·³å‡º for (GenericFutureListener&lt;? extends Future&lt;? super V&gt;&gt; listener : listeners) &#123; if (listener == null) &#123; break; &#125; addListener0(listener); &#125; &#125; // å¦‚æœPromiseå®ä¾‹å·²ç»æ‰§è¡Œå®Œæ¯•ï¼Œåˆ™é€šçŸ¥ç›‘å¬å™¨è¿›è¡Œå›è°ƒ if (isDone()) &#123; notifyListeners(); &#125; return this; &#125; @Override public Promise&lt;V&gt; removeListener(final GenericFutureListener&lt;? extends Future&lt;? super V&gt;&gt; listener) &#123; // å…¥å‚éç©ºæ ¡éªŒ checkNotNull(listener, \"listener\"); // åŠ é”ï¼Œé”å®šçš„å¯¹è±¡æ˜¯Promiseå®ä¾‹è‡ªèº« synchronized (this) &#123; // ç§»é™¤ç›‘å¬å™¨ removeListener0(listener); &#125; return this; &#125; @Override public Promise&lt;V&gt; removeListeners(final GenericFutureListener&lt;? extends Future&lt;? super V&gt;&gt;... listeners) &#123; // å…¥å‚éç©ºæ ¡éªŒ checkNotNull(listeners, \"listeners\"); // åŠ é”ï¼Œé”å®šçš„å¯¹è±¡æ˜¯Promiseå®ä¾‹è‡ªèº« synchronized (this) &#123; // éå†å…¥å‚æ•°ç»„ç§»é™¤ç›‘å¬å™¨ï¼Œæœ‰ç©ºå…ƒç´ ç›´æ¥è·³å‡º for (GenericFutureListener&lt;? extends Future&lt;? super V&gt;&gt; listener : listeners) &#123; if (listener == null) &#123; break; &#125; removeListener0(listener); &#125; &#125; return this; &#125; private void addListener0(GenericFutureListener&lt;? extends Future&lt;? super V&gt;&gt; listener) &#123; // å¦‚æœPromiseå®ä¾‹æŒæœ‰listenersä¸ºnullï¼Œåˆ™ç›´æ¥è®¾ç½®ä¸ºå…¥å‚listener if (listeners == null) &#123; listeners = listener; &#125; else if (listeners instanceof DefaultFutureListeners) &#123; // å¦‚æœå½“å‰Promiseå®ä¾‹æŒæœ‰listenersçš„æ˜¯DefaultFutureListenersç±»å‹ï¼Œåˆ™è°ƒç”¨å®ƒçš„add()æ–¹æ³•è¿›è¡Œæ·»åŠ  ((DefaultFutureListeners) listeners).add(listener); &#125; else &#123; // æ­¥å…¥è¿™é‡Œè¯´æ˜å½“å‰Promiseå®ä¾‹æŒæœ‰listenersä¸ºå•ä¸ªGenericFutureListenerå®ä¾‹ï¼Œéœ€è¦è½¬æ¢ä¸ºDefaultFutureListenerså®ä¾‹ listeners = new DefaultFutureListeners((GenericFutureListener&lt;?&gt;) listeners, listener); &#125; &#125; private void removeListener0(GenericFutureListener&lt;? extends Future&lt;? super V&gt;&gt; listener) &#123; // å¦‚æœå½“å‰Promiseå®ä¾‹æŒæœ‰listenersçš„æ˜¯DefaultFutureListenersç±»å‹ï¼Œåˆ™è°ƒç”¨å®ƒçš„remove()æ–¹æ³•è¿›è¡Œç§»é™¤ if (listeners instanceof DefaultFutureListeners) &#123; ((DefaultFutureListeners) listeners).remove(listener); &#125; else if (listeners == listener) &#123; // å¦‚æœå½“å‰Promiseå®ä¾‹æŒæœ‰listenersä¸ä¸ºDefaultFutureListenersç±»å‹ï¼Œä¹Ÿå°±æ˜¯å•ä¸ªGenericFutureListenerå¹¶ä¸”å’Œä¼ å…¥çš„listenerç›¸åŒï¼Œ // åˆ™Promiseå®ä¾‹æŒæœ‰listenersç½®ä¸ºnull listeners = null; &#125; &#125; private void notifyListeners() &#123; EventExecutor executor = executor(); // å½“å‰æ‰§è¡Œçº¿ç¨‹æ˜¯äº‹ä»¶å¾ªç¯çº¿ç¨‹ï¼Œé‚£ä¹ˆç›´æ¥åŒæ­¥è°ƒç”¨ï¼Œç®€å•æ¥è¯´å°±æ˜¯è°ƒç”¨notifyListeners()æ–¹æ³•çš„çº¿ç¨‹å’ŒEventExecutoræ˜¯åŒä¸€ä¸ªçº¿ç¨‹ if (executor.inEventLoop()) &#123; // ä¸‹é¢çš„ThreadLocalå’ŒlistenerStackDepthæ˜¯è°ƒç”¨æ ˆæ·±åº¦ä¿æŠ¤ç›¸å…³ï¼Œåšæ–‡ä¼šå¦èµ·ä¸€ä¸ªç« èŠ‚ä¸“é—¨è®²è§£è¿™ä¸ªé—®é¢˜ï¼Œè¿™é‡Œå¯ä»¥æš‚æ—¶å¿½ç•¥ final InternalThreadLocalMap threadLocals = InternalThreadLocalMap.get(); final int stackDepth = threadLocals.futureListenerStackDepth(); if (stackDepth &lt; MAX_LISTENER_STACK_DEPTH) &#123; threadLocals.setFutureListenerStackDepth(stackDepth + 1); try &#123; notifyListenersNow(); &#125; finally &#123; threadLocals.setFutureListenerStackDepth(stackDepth); &#125; return; &#125; &#125; // å½“å‰æ‰§è¡Œçº¿ç¨‹ä¸æ˜¯äº‹ä»¶å¾ªç¯çº¿ç¨‹ï¼Œåˆ™æŠŠnotifyListenersNow()åŒ…è£…ä¸ºRunnableå®ä¾‹æ”¾åˆ°EventExecutorä¸­æ‰§è¡Œ safeExecute(executor, new Runnable() &#123; @Override public void run() &#123; notifyListenersNow(); &#125; &#125;); &#125; // ä½¿ç”¨EventExecutorè¿›è¡Œä»»åŠ¡æ‰§è¡Œï¼Œexecute()æ–¹æ³•æŠ›å‡ºçš„å¼‚å¸¸ä¼šä½¿ç”¨rejectedExecutionLoggerå¥æŸ„æ‰“å° private static void safeExecute(EventExecutor executor, Runnable task) &#123; try &#123; executor.execute(task); &#125; catch (Throwable t) &#123; rejectedExecutionLogger.error(\"Failed to submit a listener notification task. Event loop shut down?\", t); &#125; &#125; // é©¬ä¸Šé€šçŸ¥æ‰€æœ‰ç›‘å¬å™¨è¿›è¡Œå›è°ƒ private void notifyListenersNow() &#123; Object listeners; // è¿™é‡ŒåŠ é”ï¼Œåœ¨é”çš„ä¿æŠ¤ä¸‹è®¾ç½®notifyingListenersçš„å€¼ï¼Œå¦‚æœå¤šä¸ªçº¿ç¨‹è°ƒç”¨åŒä¸€ä¸ªPromiseå®ä¾‹çš„notifyListenersNow()æ–¹æ³• // å‘½ä¸­notifyingListenersçš„çº¿ç¨‹å¯ä»¥ç›´æ¥è¿”å› synchronized (this) &#123; // Only proceed if there are listeners to notify and we are not already notifying listeners. if (notifyingListeners || this.listeners == null) &#123; return; &#125; notifyingListeners = true; // ä¸´æ—¶å˜é‡listenerså­˜æ”¾ç¬æ—¶çš„ç›‘å¬å™¨å®ä¾‹ï¼Œæ–¹ä¾¿ä¸‹ä¸€æ­¥è®¾ç½®Promiseå®ä¾‹çš„listenersä¸ºnull listeners = this.listeners; // é‡ç½®å½“å‰Promiseå®ä¾‹çš„listenersä¸ºnull this.listeners = null; &#125; for (;;) &#123; if (listeners instanceof DefaultFutureListeners) &#123; // å¤šä¸ªç›‘å¬å™¨æƒ…å†µä¸‹çš„é€šçŸ¥ notifyListeners0((DefaultFutureListeners) listeners); &#125; else &#123; // å•ä¸ªç›‘å¬å™¨æƒ…å†µä¸‹çš„é€šçŸ¥ notifyListener0(this, (GenericFutureListener&lt;?&gt;) listeners); &#125; synchronized (this) &#123; if (this.listeners == null) &#123; // è¿™é‡Œå› ä¸ºæ²¡æœ‰å¼‚å¸¸æŠ›å‡ºçš„å¯èƒ½ï¼Œä¸ç”¨åœ¨finallyå—ä¸­ç¼–å†™ï¼Œé‡ç½®notifyingListenersä¸ºfalseå¹¶ä¸”è¿”å›è·³å‡ºå¾ªç¯ notifyingListeners = false; return; &#125; // ä¸´æ—¶å˜é‡listenerså­˜æ”¾ç¬æ—¶çš„ç›‘å¬å™¨å®ä¾‹ï¼Œå›è°ƒæ“ä½œåˆ¤æ–­æ˜¯åŸºäºä¸´æ—¶å®ä¾‹å»åš - è¿™é‡Œå¯èƒ½ç”±å¦ä¸€ä¸ªçº¿ç¨‹æ›´æ–°äº†listenersçš„å€¼ listeners = this.listeners; // é‡ç½®å½“å‰Promiseå®ä¾‹çš„listenersä¸ºnullï¼Œç¡®ä¿ç›‘å¬å™¨åªä¼šè¢«å›è°ƒä¸€æ¬¡ï¼Œä¸‹ä¸€æ¬¡è·³å‡ºforæ­»å¾ªç¯ this.listeners = null; &#125; &#125; &#125; // éå†DefaultFutureListenersä¸­çš„listenersæ•°ç»„ï¼Œè°ƒç”¨é™æ€æ–¹æ³•notifyListener0() private void notifyListeners0(DefaultFutureListeners listeners) &#123; GenericFutureListener&lt;?&gt;[] a = listeners.listeners(); int size = listeners.size(); for (int i = 0; i &lt; size; i ++) &#123; notifyListener0(this, a[i]); &#125; &#125; // è¿™ä¸ªé™æ€æ–¹æ³•æ˜¯æœ€ç»ˆç›‘å¬å™¨å›è°ƒçš„æ–¹æ³•,ä¹Ÿå°±æ˜¯ç®€å•è°ƒç”¨GenericFutureListener#operationComplete()ä¼ å…¥çš„æ˜¯å½“å‰çš„Promiseå®ä¾‹ï¼Œæ•è·ä¸€åˆ‡å¼‚å¸¸æ‰“å°warnæ—¥å¿— @SuppressWarnings(&#123; \"unchecked\", \"rawtypes\" &#125;) private static void notifyListener0(Future future, GenericFutureListener l) &#123; try &#123; l.operationComplete(future); &#125; catch (Throwable t) &#123; if (logger.isWarnEnabled()) &#123; logger.warn(\"An exception was thrown by \" + l.getClass().getName() + \".operationComplete()\", t); &#125; &#125; &#125;&#125; ç„¶åçœ‹wait()å’Œsync()æ–¹æ³•ä½“ç³»ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216public class DefaultPromise&lt;V&gt; extends AbstractFuture&lt;V&gt; implements Promise&lt;V&gt; &#123; // ... çœç•¥å…¶ä»–ä»£ç  ... @Override public Promise&lt;V&gt; await() throws InterruptedException &#123; // å¦‚æœPromiseæ‰§è¡Œå®Œæ¯•ï¼Œç›´æ¥è¿”å› if (isDone()) &#123; return this; &#125; // å¦‚æœå½“å‰çº¿ç¨‹ä¸­æ–­åˆ™ç›´æ¥æŠ›å‡ºInterruptedException if (Thread.interrupted()) &#123; throw new InterruptedException(toString()); &#125; // æ­»é”æ£€æµ‹ checkDeadLock(); // åŠ é”ï¼ŒåŠ é”å¯¹è±¡æ˜¯å½“å‰Promiseå®ä¾‹ synchronized (this) &#123; // è¿™é‡Œè®¾ç½®ä¸€ä¸ªæ­»å¾ªç¯ï¼Œç»ˆæ­¢æ¡ä»¶æ˜¯isDone()ä¸ºtrue while (!isDone()) &#123; // ç­‰å¾…çº¿ç¨‹æ•°åŠ 1 incWaiters(); try &#123; // è¿™é‡Œè°ƒç”¨çš„æ˜¯Object#wait()æ–¹æ³•è¿›è¡Œé˜»å¡ï¼Œå¦‚æœçº¿ç¨‹è¢«ä¸­æ–­ä¼šæŠ›å‡ºInterruptedException wait(); &#125; finally &#123; // è§£é™¤é˜»å¡åç­‰å¾…çº¿ç¨‹æ•°å‡1 decWaiters(); &#125; &#125; &#125; return this; &#125; @Override public Promise&lt;V&gt; awaitUninterruptibly() &#123; // å¦‚æœPromiseæ‰§è¡Œå®Œæ¯•ï¼Œç›´æ¥è¿”å› if (isDone()) &#123; return this; &#125; // æ­»é”æ£€æµ‹ checkDeadLock(); boolean interrupted = false; // åŠ é”ï¼ŒåŠ é”å¯¹è±¡æ˜¯å½“å‰Promiseå®ä¾‹ synchronized (this) &#123; // è¿™é‡Œè®¾ç½®ä¸€ä¸ªæ­»å¾ªç¯ï¼Œç»ˆæ­¢æ¡ä»¶æ˜¯isDone()ä¸ºtrue while (!isDone()) &#123; // ç­‰å¾…çº¿ç¨‹æ•°åŠ 1 incWaiters(); try &#123; // è¿™é‡Œè°ƒç”¨çš„æ˜¯Object#wait()æ–¹æ³•è¿›è¡Œé˜»å¡ï¼Œæ•è·äº†InterruptedExceptionå¼‚å¸¸ï¼Œå¦‚æœæŠ›å‡ºInterruptedExceptionè®°å½•çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€åˆ°interrupted wait(); &#125; catch (InterruptedException e) &#123; // Interrupted while waiting. interrupted = true; &#125; finally &#123; // è§£é™¤é˜»å¡åç­‰å¾…çº¿ç¨‹æ•°å‡1 decWaiters(); &#125; &#125; &#125; // å¦‚æœçº¿ç¨‹è¢«ä¸­æ–­è·³å‡ºç­‰å¾…é˜»å¡ï¼Œåˆ™æ¸…é™¤çº¿ç¨‹çš„ä¸­æ–­æ ‡å¿—ä½ if (interrupted) &#123; Thread.currentThread().interrupt(); &#125; return this; &#125; // åé¢çš„å‡ ä¸ªå¸¦è¶…æ—¶æ—¶é™çš„wait()æ–¹æ³•éƒ½æ˜¯è°ƒç”¨await0() @Override public boolean await(long timeout, TimeUnit unit) throws InterruptedException &#123; return await0(unit.toNanos(timeout), true); &#125; @Override public boolean await(long timeoutMillis) throws InterruptedException &#123; return await0(MILLISECONDS.toNanos(timeoutMillis), true); &#125; @Override public boolean awaitUninterruptibly(long timeout, TimeUnit unit) &#123; try &#123; return await0(unit.toNanos(timeout), false); &#125; catch (InterruptedException e) &#123; // Should not be raised at all. throw new InternalError(); &#125; &#125; @Override public boolean awaitUninterruptibly(long timeoutMillis) &#123; try &#123; return await0(MILLISECONDS.toNanos(timeoutMillis), false); &#125; catch (InterruptedException e) &#123; // Should not be raised at all. throw new InternalError(); &#125; &#125; // æ£€æŸ¥æ­»é”ï¼Œè¿™é‡Œåˆ¤æ–­äº†ç­‰å¾…çº¿ç¨‹æ˜¯äº‹ä»¶å¾ªç¯çº¿ç¨‹åˆ™ç›´æ¥æŠ›å‡ºBlockingOperationExceptionå¼‚å¸¸ // ç®€å•æ¥è¯´å°±æ˜¯ï¼šPromiseçš„æ‰§è¡Œçº¿ç¨‹å’Œç­‰å¾…ç»“æœçš„çº¿ç¨‹ï¼Œä¸èƒ½æ˜¯åŒä¸€ä¸ªçº¿ç¨‹ï¼Œå¦åˆ™ä¾èµ–ä¼šæˆç¯ protected void checkDeadLock() &#123; EventExecutor e = executor(); if (e != null &amp;&amp; e.inEventLoop()) &#123; throw new BlockingOperationException(toString()); &#125; &#125; @Override public Promise&lt;V&gt; sync() throws InterruptedException &#123; // åŒæ­¥æ°¸ä¹…é˜»å¡ç­‰å¾… await(); // é˜»å¡ç­‰å¾…è§£é™¤ï¼Œå¦‚æœæ‰§è¡Œå­˜åœ¨å¼‚å¸¸ï¼Œåˆ™ç›´æ¥æŠ›å‡º rethrowIfFailed(); return this; &#125; @Override public Promise&lt;V&gt; syncUninterruptibly() &#123; // åŒæ­¥æ°¸ä¹…é˜»å¡ç­‰å¾… - å“åº”ä¸­æ–­ awaitUninterruptibly(); // å¡ç­‰å¾…è§£é™¤ï¼Œå¦‚æœæ‰§è¡Œå­˜åœ¨å¼‚å¸¸ï¼Œåˆ™ç›´æ¥æŠ›å‡º rethrowIfFailed(); return this; &#125; // waitersåŠ 1ï¼Œå¦‚æœè¶…è¿‡Short.MAX_VALUEåˆ™æŠ›å‡ºIllegalStateException private void incWaiters() &#123; if (waiters == Short.MAX_VALUE) &#123; throw new IllegalStateException(\"too many waiters: \" + this); &#125; ++waiters; &#125; // waiterså‡1 private void decWaiters() &#123; --waiters; &#125; // causeä¸ä¸ºnullåˆ™æŠ›å‡º private void rethrowIfFailed() &#123; Throwable cause = cause(); if (cause == null) &#123; return; &#125; PlatformDependent.throwException(cause); &#125; private boolean await0(long timeoutNanos, boolean interruptable) throws InterruptedException &#123; // å¦‚æœPromiseæ‰§è¡Œå®Œæ¯•ï¼Œç›´æ¥è¿”å› if (isDone()) &#123; return true; &#125; // å¦‚æœè¶…æ—¶æ—¶é™å°äº0é‚£ä¹ˆè¿”å›isDone()çš„ç»“æœ if (timeoutNanos &lt;= 0) &#123; return isDone(); &#125; // å¦‚æœå…è®¸ä¸­æ–­ï¼Œå½“å‰çº¿ç¨‹çš„ä¸­æ–­æ ‡å¿—ä½ä¸ºtrueï¼Œåˆ™æŠ›å‡ºInterruptedException if (interruptable &amp;&amp; Thread.interrupted()) &#123; throw new InterruptedException(toString()); &#125; // æ­»é”æ£€æµ‹ checkDeadLock(); // è®°å½•å½“å‰çš„çº³ç§’æ—¶é—´æˆ³ long startTime = System.nanoTime(); // ç­‰å¾…æ—¶é—´çš„é•¿åº¦ - å•ä½ä¸ºçº³ç§’ long waitTime = timeoutNanos; // è®°å½•çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­ boolean interrupted = false; try &#123; // æ­»å¾ªç¯ for (;;) &#123; synchronized (this) &#123; // å¦‚æœPromiseæ‰§è¡Œå®Œæ¯•ï¼Œç›´æ¥è¿”å›true - è¿™ä¸€æ­¥æ˜¯å…ˆéªŒåˆ¤æ–­ï¼Œå‘½ä¸­äº†å°±ä¸éœ€è¦é˜»å¡ç­‰å¾… if (isDone()) &#123; return true; &#125; // ç­‰å¾…çº¿ç¨‹æ•°åŠ 1 incWaiters(); try &#123; // è¿™é‡Œè°ƒç”¨çš„æ˜¯å¸¦è¶…æ—¶æ—¶é™çš„Object#wait()æ–¹æ³•è¿›è¡Œé˜»å¡ wait(waitTime / 1000000, (int) (waitTime % 1000000)); &#125; catch (InterruptedException e) &#123; // çº¿ç¨‹è¢«ä¸­æ–­å¹¶ä¸”å¤–éƒ¨å…è®¸ä¸­æ–­ï¼Œé‚£ä¹ˆç›´æ¥æŠ›å‡ºInterruptedException if (interruptable) &#123; throw e; &#125; else &#123; // å¦åˆ™åªè®°å½•ä¸­æ–­è¿‡çš„çŠ¶æ€ interrupted = true; &#125; &#125; finally &#123; // è§£é™¤é˜»å¡åç­‰å¾…çº¿ç¨‹æ•°å‡1 decWaiters(); &#125; &#125; // è§£é™¤é˜»å¡åï¼Œå¦‚æœPromiseæ‰§è¡Œå®Œæ¯•ï¼Œç›´æ¥è¿”å›true if (isDone()) &#123; return true; &#125; else &#123; // æ­¥å…¥è¿™é‡Œè¯´æ˜Promiseå°šæœªæ‰§è¡Œå®Œæ¯•ï¼Œåˆ™é‡æ–°è®¡ç®—ç­‰å¾…æ—¶é—´é—´éš”çš„é•¿åº¦æ•°é‡ï¼ˆä¿®æ­£ï¼‰ï¼Œå¦‚æœå¤§äº0åˆ™è¿›å…¥ä¸‹ä¸€è½®å¾ªç¯ waitTime = timeoutNanos - (System.nanoTime() - startTime); if (waitTime &lt;= 0) &#123; return isDone(); &#125; &#125; &#125; &#125; finally &#123; // å¦‚æœçº¿ç¨‹è¢«ä¸­æ–­è·³å‡ºç­‰å¾…é˜»å¡ï¼Œåˆ™æ¸…é™¤çº¿ç¨‹çš„ä¸­æ–­æ ‡å¿—ä½ if (interrupted) &#123; Thread.currentThread().interrupt(); &#125; &#125; &#125; // ... çœç•¥å…¶ä»–ä»£ç  ...&#125; æœ€åæ˜¯å‡ ä¸ªè®¾ç½®ç»“æœå’Œè·å–ç»“æœçš„æ–¹æ³•ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156public class DefaultPromise&lt;V&gt; extends AbstractFuture&lt;V&gt; implements Promise&lt;V&gt; &#123; // ... çœç•¥å…¶ä»–ä»£ç  ... @Override public Promise&lt;V&gt; setSuccess(V result) &#123; // è®¾ç½®æˆåŠŸç»“æœï¼Œå¦‚æœè®¾ç½®æˆåŠŸåˆ™è¿”å›å½“å‰Promiseå®ä¾‹ if (setSuccess0(result)) &#123; return this; &#125; // è®¾ç½®å¤±è´¥è¯´æ˜äº†å¤šæ¬¡è®¾ç½®ï¼ŒPromiseå·²ç»æ‰§è¡Œå®Œæ¯•ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ throw new IllegalStateException(\"complete already: \" + this); &#125; @Override public boolean trySuccess(V result) &#123; // è®¾ç½®æˆåŠŸç»“æœï¼Œè¿”å›çš„å¸ƒå°”å€¼è¡¨ç¤ºæˆåŠŸæˆ–å¤±è´¥ return setSuccess0(result); &#125; @Override public Promise&lt;V&gt; setFailure(Throwable cause) &#123; // è®¾ç½®å¤±è´¥ç»“æœï¼Œå¦‚æœè®¾ç½®æˆåŠŸåˆ™è¿”å›å½“å‰Promiseå®ä¾‹ if (setFailure0(cause)) &#123; return this; &#125; // è®¾ç½®å¤±è´¥è¯´æ˜äº†å¤šæ¬¡è®¾ç½®ï¼ŒPromiseå·²ç»æ‰§è¡Œå®Œæ¯•ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ throw new IllegalStateException(\"complete already: \" + this, cause); &#125; @Override public boolean tryFailure(Throwable cause) &#123; // è®¾ç½®å¤±è´¥ç»“æœï¼Œè¿”å›çš„å¸ƒå°”å€¼è¡¨ç¤ºæˆåŠŸæˆ–å¤±è´¥ return setFailure0(cause); &#125; @SuppressWarnings(\"unchecked\") @Override public V getNow() &#123; // éé˜»å¡è·å–ç»“æœï¼Œå¦‚æœresultæ˜¯CauseHolderç±»å‹ã€SUCCESSå±æ€§å®ä¾‹æˆ–è€…UNCANCELLABLEå®è¡Œå®ä¾‹åˆ™è¿”å›nullï¼Œå¦åˆ™è¿”å›è½¬æ¢ç±»å‹åçš„resultå€¼ // å¯¹å¼‚å¸¸æ— æ„ŸçŸ¥ï¼Œå¦‚æœCauseHolderåŒ…è£¹äº†å¼‚å¸¸ï¼Œæ­¤æ–¹æ³•ä¾ç„¶è¿”å›null Object result = this.result; if (result instanceof CauseHolder || result == SUCCESS || result == UNCANCELLABLE) &#123; return null; &#125; return (V) result; &#125; @SuppressWarnings(\"unchecked\") @Override public V get() throws InterruptedException, ExecutionException &#123; // æ°¸ä¹…é˜»å¡è·å–ç»“æœ Object result = this.result; // å¦‚æœPromiseæœªæ‰§è¡Œå®Œæ¯•åˆ™è¿›è¡Œæ°¸ä¹…é˜»å¡ç­‰å¾… if (!isDone0(result)) &#123; await(); // æ›´æ–°ç»“æœä¸´æ—¶å˜é‡ result = this.result; &#125; // resultä¸ºSUCCESSå±æ€§å®ä¾‹æˆ–è€…UNCANCELLABLEå±æ€§å®ä¾‹çš„æ—¶å€™ç›´æ¥è¿”å›null if (result == SUCCESS || result == UNCANCELLABLE) &#123; return null; &#125; // å¦‚æœresultä¸ºCauseHolderç±»å‹ï¼Œåˆ™è·å–å…¶ä¸­æŒæœ‰çš„causeå±æ€§ï¼Œä¹Ÿæœ‰å¯èƒ½ä¸ºnull Throwable cause = cause0(result); if (cause == null) &#123; // æ‰§è¡ŒæˆåŠŸçš„å‰æä¸‹è½¬æ¢ç±»å‹åçš„resultå€¼è¿”å› return (V) result; &#125; // å–æ¶ˆçš„æƒ…å†µï¼ŒæŠ›å‡ºCancellationException if (cause instanceof CancellationException) &#123; throw (CancellationException) cause; &#125; // å‰©ä½™çš„æƒ…å†µä¸€å¾‹å°è£…ä¸ºExecutionExceptionå¼‚å¸¸ throw new ExecutionException(cause); &#125; @SuppressWarnings(\"unchecked\") @Override public V get(long timeout, TimeUnit unit) throws InterruptedException, ExecutionException, TimeoutException &#123; // å¸¦è¶…æ—¶æ—¶é™çš„é˜»å¡è·å–ç»“æœ Object result = this.result; // å¦‚æœPromiseæœªæ‰§è¡Œå®Œæ¯•åˆ™è¿›è¡Œå¸¦è¶…æ—¶æ—¶é™çš„é˜»å¡ç­‰å¾… if (!isDone0(result)) &#123; if (!await(timeout, unit)) &#123; // ç­‰å¾…è¶…æ—¶ç›´æ¥æŠ›å‡ºTimeoutException throw new TimeoutException(); &#125; // æ›´æ–°ç»“æœä¸´æ—¶å˜é‡ result = this.result; &#125; // resultä¸ºSUCCESSå±æ€§å®ä¾‹æˆ–è€…UNCANCELLABLEå±æ€§å®ä¾‹çš„æ—¶å€™ç›´æ¥è¿”å›null if (result == SUCCESS || result == UNCANCELLABLE) &#123; return null; &#125; // å¦‚æœresultä¸ºCauseHolderç±»å‹ï¼Œåˆ™è·å–å…¶ä¸­æŒæœ‰çš„causeå±æ€§ï¼Œä¹Ÿæœ‰å¯èƒ½ä¸ºnull Throwable cause = cause0(result); if (cause == null) &#123; // æ‰§è¡ŒæˆåŠŸçš„å‰æä¸‹è½¬æ¢ç±»å‹åçš„resultå€¼è¿”å› return (V) result; &#125; // å–æ¶ˆçš„æƒ…å†µï¼ŒæŠ›å‡ºCancellationException if (cause instanceof CancellationException) &#123; throw (CancellationException) cause; &#125; // å‰©ä½™çš„æƒ…å†µä¸€å¾‹å°è£…ä¸ºExecutionExceptionå¼‚å¸¸ throw new ExecutionException(cause); &#125; @Override public boolean cancel(boolean mayInterruptIfRunning) &#123; // CASæ›´æ–°resultä¸ºCANCELLATION_CAUSE_HOLDERï¼Œresultçš„æœŸæœ›å€¼å¿…é¡»ä¸ºnull if (RESULT_UPDATER.compareAndSet(this, null, CANCELLATION_CAUSE_HOLDER)) &#123; // åˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡Œç­‰å¾…çº¿ç¨‹çš„é€šçŸ¥ if (checkNotifyWaiters()) &#123; // é€šçŸ¥ç›‘å¬å™¨è¿›è¡Œå›è°ƒ notifyListeners(); &#125; return true; &#125; return false; &#125; private boolean setSuccess0(V result) &#123; // è®¾ç½®æ‰§è¡ŒæˆåŠŸçš„ç»“æœï¼Œå¦‚æœå…¥å‚resultä¸ºnullï¼Œåˆ™é€‰ç”¨SUCCESSå±æ€§ï¼Œå¦åˆ™ä½¿ç”¨result return setValue0(result == null ? SUCCESS : result); &#125; private boolean setFailure0(Throwable cause) &#123; // è®¾ç½®æ‰§è¡Œå¤±è´¥çš„ç»“æœï¼Œå…¥å‚æ˜¯Throwableç±»å‹ï¼Œå°è£…ä¸ºCauseHolderï¼Œå­˜æ”¾åœ¨CauseHolderå®ä¾‹çš„causeå±æ€§ return setValue0(new CauseHolder(checkNotNull(cause, \"cause\"))); &#125; private boolean setValue0(Object objResult) &#123; // CASæ›´æ–°resultä¸ºå…¥å‚objResultï¼Œresultçš„æœŸæœ›å€¼å¿…é¡»ä¸ºnullæˆ–è€…UNCANCELLABLEæ‰èƒ½æ›´æ–°æˆåŠŸ if (RESULT_UPDATER.compareAndSet(this, null, objResult) || RESULT_UPDATER.compareAndSet(this, UNCANCELLABLE, objResult)) &#123; // åˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡Œç­‰å¾…çº¿ç¨‹çš„é€šçŸ¥ if (checkNotifyWaiters()) &#123; // é€šçŸ¥ç›‘å¬å™¨è¿›è¡Œå›è°ƒ notifyListeners(); &#125; return true; &#125; return false; &#125; // åˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡Œç­‰å¾…çº¿ç¨‹çš„é€šçŸ¥ - å…¶å®æ˜¯åˆ¤æ–­æ˜¯å¦éœ€è¦é€šçŸ¥ç›‘å¬å™¨å›è°ƒ private synchronized boolean checkNotifyWaiters() &#123; // å¦‚æœç­‰å¾…çº¿ç¨‹æ•°é‡å¤§äº0åˆ™è°ƒç”¨Object#notifyAll()å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹ if (waiters &gt; 0) &#123; notifyAll(); &#125; // å¦‚æœlistenersä¸ä¸ºç©ºï¼ˆä¹Ÿå°±æ˜¯å­˜åœ¨ç›‘å¬å™¨ï¼‰çš„æ—¶å€™æ‰è¿”å›true return listeners != null; &#125; // ... çœç•¥å…¶ä»–ä»£ç  ...&#125; Promiseçš„åŸºæœ¬ä½¿ç”¨ è¦ä½¿ç”¨Nettyçš„Promiseæ¨¡å—ï¼Œå¹¶ä¸éœ€è¦å¼•å…¥Nettyçš„æ‰€æœ‰ä¾èµ–ï¼Œè¿™é‡Œåªéœ€è¦å¼•å…¥netty-commonï¼š 12345&lt;dependency&gt; &lt;groupId&gt;io.netty&lt;/groupId&gt; &lt;artifactId&gt;netty-common&lt;/artifactId&gt; &lt;version&gt;4.1.44.Final&lt;/version&gt;&lt;/dependency&gt; EventExecutoré€‰å–æ–¹é¢ï¼ŒNettyå·²ç»å‡†å¤‡äº†ä¸€ä¸ªGlobalEventExecutorç”¨äºå…¨å±€äº‹ä»¶å¤„ç†ï¼Œè¿™é‡Œå¯ä»¥ç›´æ¥é€‰ç”¨ï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥è‡ªè¡Œå®ç°EventExecutoræˆ–è€…ç”¨EventExecutorçš„å…¶ä»–å®ç°ç±»ï¼‰ï¼š 12EventExecutor executor = GlobalEventExecutor.INSTANCE;Promise&lt;String&gt; promise = new DefaultPromise&lt;&gt;(executor); è¿™é‡Œè®¾è®¡ä¸€ä¸ªåœºæ™¯ï¼šå¼‚æ­¥ä¸‹è½½ä¸€ä¸ªé“¾æ¥çš„èµ„æºåˆ°ç£ç›˜ä¸Šï¼Œä¸‹è½½å®Œæˆä¹‹åéœ€è¦å¼‚æ­¥é€šçŸ¥ä¸‹è½½å®Œçš„ç£ç›˜æ–‡ä»¶è·¯å¾„ï¼Œå¾—åˆ°é€šçŸ¥ä¹‹åæ‰“å°ä¸‹è½½ç»“æœåˆ°æ§åˆ¶å°ä¸­ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152public class PromiseMain &#123; public static void main(String[] args) throws Exception &#123; String url = \"http://xxx.yyy.zzz\"; EventExecutor executor = GlobalEventExecutor.INSTANCE; Promise&lt;DownloadResult&gt; promise = new DefaultPromise&lt;&gt;(executor); promise.addListener(new DownloadResultListener()); Thread thread = new Thread(() -&gt; &#123; try &#123; System.out.println(\"å¼€å§‹ä¸‹è½½èµ„æº,url:\" + url); long start = System.currentTimeMillis(); // æ¨¡æ‹Ÿä¸‹è½½è€—æ—¶ Thread.sleep(2000); String location = \"C:\\\\xxx\\\\yyy\\\\z.md\"; long cost = System.currentTimeMillis() - start; System.out.println(String.format(\"ä¸‹è½½èµ„æºæˆåŠŸ,url:%s,ä¿å­˜åˆ°:%s,è€—æ—¶:%d ms\", url, location, cost)); DownloadResult result = new DownloadResult(); result.setUrl(url); result.setFileDiskLocation(location); result.setCost(cost); // é€šçŸ¥ç»“æœ promise.setSuccess(result); &#125; catch (Exception ignore) &#123; &#125; &#125;, \"Download-Thread\"); thread.start(); Thread.sleep(Long.MAX_VALUE); &#125; @Data private static class DownloadResult &#123; private String url; private String fileDiskLocation; private long cost; &#125; private static class DownloadResultListener implements GenericFutureListener&lt;Future&lt;DownloadResult&gt;&gt; &#123; @Override public void operationComplete(Future&lt;DownloadResult&gt; future) throws Exception &#123; if (future.isSuccess()) &#123; DownloadResult downloadResult = future.getNow(); System.out.println(String.format(\"ä¸‹è½½å®Œæˆé€šçŸ¥,url:%s,æ–‡ä»¶ç£ç›˜è·¯å¾„:%s,è€—æ—¶:%d ms\", downloadResult.getUrl(), downloadResult.getFileDiskLocation(), downloadResult.getCost())); &#125; &#125; &#125;&#125; æ‰§è¡Œåæ§åˆ¶å°è¾“å‡ºï¼š 123å¼€å§‹ä¸‹è½½èµ„æº,url:http://xxx.yyy.zzzä¸‹è½½èµ„æºæˆåŠŸ,url:http://xxx.yyy.zzz,ä¿å­˜åˆ°:C:\\xxx\\yyy\\z.md,è€—æ—¶:2000 msä¸‹è½½å®Œæˆé€šçŸ¥,url:http://xxx.yyy.zzz,æ–‡ä»¶ç£ç›˜è·¯å¾„:C:\\xxx\\yyy\\z.md,è€—æ—¶:2000 ms Promiseé€‚ç”¨çš„åœºæ™¯å¾ˆå¤šï¼Œé™¤äº†å¼‚æ­¥é€šçŸ¥çš„åœºæ™¯ä¹Ÿèƒ½ç”¨äºåŒæ­¥è°ƒç”¨ï¼Œå®ƒåœ¨è®¾è®¡ä¸Šæ¯”JUCçš„Futureçµæ´»å¾ˆå¤šï¼ŒåŸºäºFutureæ‰©å±•å‡ºå¾ˆå¤šæ–°çš„ç‰¹æ€§ï¼Œæœ‰éœ€è¦çš„å¯ä»¥å•ç‹¬å¼•å…¥æ­¤ä¾èµ–ç›´æ¥ä½¿ç”¨ã€‚ Promiseç›‘å¬å™¨æ ˆæ·±åº¦çš„é—®é¢˜ æœ‰äº›æ—¶å€™ï¼Œç”±äºå°è£…æˆ–è€…äººä¸ºç¼–ç å¼‚å¸¸ç­‰åŸå› ï¼Œç›‘å¬å™¨çš„å›è°ƒå¯èƒ½å‡ºç°åŸºäºå¤šä¸ªPromiseå½¢æˆçš„é“¾ï¼ˆå‚è€ƒIssue-5302ï¼Œa promise listener chainï¼‰ï¼Œè¿™æ ·å­æœ‰å¯èƒ½å‡ºç°é€’å½’è°ƒç”¨æ·±åº¦è¿‡å¤§è€Œå¯¼è‡´æ ˆæº¢å‡ºï¼Œå› æ­¤éœ€è¦è®¾ç½®ä¸€ä¸ªé˜ˆå€¼ï¼Œé™åˆ¶é€’å½’è°ƒç”¨çš„æœ€å¤§æ ˆæ·±åº¦ï¼Œè¿™ä¸ªæ·±åº¦é˜ˆå€¼æš‚ä¸”ç§°ä¸ºæ ˆæ·±åº¦ä¿æŠ¤é˜ˆå€¼ï¼Œé»˜è®¤å€¼æ˜¯8ï¼Œå¯ä»¥é€šè¿‡ç³»ç»Ÿå‚æ•°io.netty.defaultPromise.maxListenerStackDepthè¦†ç›–è®¾ç½®ã€‚è¿™é‡Œè´´å‡ºå‰é¢æåˆ°è¿‡çš„ä»£ç å—ï¼š 1234567891011121314151617181920212223242526272829private void notifyListeners() &#123; EventExecutor executor = executor(); // äº‹ä»¶æ‰§è¡Œå™¨å¿…é¡»æ˜¯äº‹ä»¶å¾ªç¯ç±»å‹ï¼Œä¹Ÿå°±æ˜¯executor.inEventLoop()ä¸ºtrueçš„æ—¶å€™æ‰å¯ç”¨é€’å½’æ ˆæ·±åº¦ä¿æŠ¤ if (executor.inEventLoop()) &#123; // è·å–å½“å‰çº¿ç¨‹ç»‘å®šçš„InternalThreadLocalMapå®ä¾‹ï¼Œè¿™é‡Œç±»ä¼¼äºThreadLocal final InternalThreadLocalMap threadLocals = InternalThreadLocalMap.get(); // è·å–å½“å‰çº¿ç¨‹çš„ç›‘å¬å™¨è°ƒç”¨æ ˆæ·±åº¦ final int stackDepth = threadLocals.futureListenerStackDepth(); // ç›‘å¬å™¨è°ƒç”¨æ ˆæ·±åº¦å¦‚æœä¸è¶…è¿‡é˜ˆå€¼MAX_LISTENER_STACK_DEPTH if (stackDepth &lt; MAX_LISTENER_STACK_DEPTH) &#123; // è°ƒç”¨notifyListenersNow()å‰å…ˆè®¾ç½®ç›‘å¬å™¨è°ƒç”¨æ ˆæ·±åº¦ + 1 threadLocals.setFutureListenerStackDepth(stackDepth + 1); try &#123; notifyListenersNow(); &#125; finally &#123; // è°ƒç”¨notifyListenersNow()å®Œæ¯•åè®¾ç½®ç›‘å¬å™¨è°ƒç”¨æ ˆæ·±åº¦ä¸ºè°ƒç”¨å‰çš„æ•°å€¼ï¼Œä¹Ÿå°±æ˜¯æ¢å¤çº¿ç¨‹çš„ç›‘å¬å™¨è°ƒç”¨æ ˆæ·±åº¦ threadLocals.setFutureListenerStackDepth(stackDepth); &#125; return; &#125; &#125; // å¦‚æœç›‘å¬å™¨è°ƒç”¨æ ˆæ·±åº¦è¶…è¿‡é˜ˆå€¼MAX_LISTENER_STACK_DEPTHï¼Œåˆ™ç›´æ¥æ¯æ¬¡é€šçŸ¥ç›‘å¬å™¨å½“æˆä¸€ä¸ªæ–°çš„å¼‚æ­¥ä»»åŠ¡å¤„ç† safeExecute(executor, new Runnable() &#123; @Override public void run() &#123; notifyListenersNow(); &#125; &#125;);&#125; å¦‚æœæˆ‘ä»¬æƒ³æ¨¡æ‹Ÿä¸€ä¸ªä¾‹å­è§¦å‘ç›‘å¬å™¨è°ƒç”¨æ ˆæ·±åº¦ä¿æŠ¤ï¼Œé‚£ä¹ˆåªéœ€è¦æƒ³åŠæ³•åœ¨åŒä¸€ä¸ªEventLoopç±»å‹çš„çº¿ç¨‹ä¸­é€’å½’è°ƒç”¨notifyListeners()æ–¹æ³•å³å¯ã€‚ æœ€å…¸å‹çš„ä¾‹å­å°±æ˜¯åœ¨ä¸Šä¸€ä¸ªPromiseç›‘å¬å™¨å›è°ƒçš„æ–¹æ³•é‡Œé¢è§¦å‘ä¸‹ä¸€ä¸ªPromiseçš„ç›‘å¬å™¨çš„setSuccess()ï¼ˆç®€å•ç†è§£å°±æ˜¯å¥—å¨ƒï¼‰ï¼Œç”»ä¸ªå›¾ç†è§£ä¸€ä¸‹ï¼š æµ‹è¯•ä»£ç ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051public class PromiseListenerMain &#123; private static final AtomicInteger COUNTER = new AtomicInteger(0); public static void main(String[] args) throws Exception &#123; EventExecutor executor = ImmediateEventExecutor.INSTANCE; // root Promise&lt;String&gt; root = new DefaultPromise&lt;&gt;(executor); Promise&lt;String&gt; p1 = new DefaultPromise&lt;&gt;(executor); Promise&lt;String&gt; p2 = new DefaultPromise&lt;&gt;(executor); Promise&lt;String&gt; p3 = new DefaultPromise&lt;&gt;(executor); Promise&lt;String&gt; p4 = new DefaultPromise&lt;&gt;(executor); Promise&lt;String&gt; p5 = new DefaultPromise&lt;&gt;(executor); Promise&lt;String&gt; p6 = new DefaultPromise&lt;&gt;(executor); Promise&lt;String&gt; p7 = new DefaultPromise&lt;&gt;(executor); Promise&lt;String&gt; p8 = new DefaultPromise&lt;&gt;(executor); Promise&lt;String&gt; p9 = new DefaultPromise&lt;&gt;(executor); Promise&lt;String&gt; p10 = new DefaultPromise&lt;&gt;(executor); p1.addListener(new Listener(p2)); p2.addListener(new Listener(p3)); p3.addListener(new Listener(p4)); p4.addListener(new Listener(p5)); p5.addListener(new Listener(p6)); p6.addListener(new Listener(p7)); p7.addListener(new Listener(p8)); p8.addListener(new Listener(p9)); p9.addListener(new Listener(p10)); root.addListener(new Listener(p1)); root.setSuccess(\"success\"); Thread.sleep(Long.MAX_VALUE); &#125; private static class Listener implements GenericFutureListener&lt;Future&lt;String&gt;&gt; &#123; private final String name; private final Promise&lt;String&gt; promise; public Listener(Promise&lt;String&gt; promise) &#123; this.name = \"listener-\" + COUNTER.getAndIncrement(); this.promise = promise; &#125; @Override public void operationComplete(Future&lt;String&gt; future) throws Exception &#123; System.out.println(String.format(\"ç›‘å¬å™¨[%s]å›è°ƒæˆåŠŸ...\", name)); if (null != promise) &#123; promise.setSuccess(\"success\"); &#125; &#125; &#125;&#125; å› ä¸ºæœ‰safeExecute()å…œåº•æ‰§è¡Œï¼Œä¸Šé¢çš„æ‰€æœ‰Promiseéƒ½ä¼šå›è°ƒï¼Œè¿™é‡Œå¯ä»¥é‡‡ç”¨IDEAçš„é«˜çº§æ–­ç‚¹åŠŸèƒ½ï¼Œåœ¨æ­¥å…¥æ–­ç‚¹çš„åœ°æ–¹æ·»åŠ é¢å¤–çš„æ—¥å¿—ï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š 1234567891011121314151617181920MAX_LISTENER_STACK_DEPTH(notifyListenersNow)æ‰§è¡Œ---ç›‘å¬å™¨[listener-9]å›è°ƒæˆåŠŸ...MAX_LISTENER_STACK_DEPTH(notifyListenersNow)æ‰§è¡Œ---ç›‘å¬å™¨[listener-0]å›è°ƒæˆåŠŸ...MAX_LISTENER_STACK_DEPTH(notifyListenersNow)æ‰§è¡Œ---ç›‘å¬å™¨[listener-1]å›è°ƒæˆåŠŸ...MAX_LISTENER_STACK_DEPTH(notifyListenersNow)æ‰§è¡Œ---ç›‘å¬å™¨[listener-2]å›è°ƒæˆåŠŸ...MAX_LISTENER_STACK_DEPTH(notifyListenersNow)æ‰§è¡Œ---ç›‘å¬å™¨[listener-3]å›è°ƒæˆåŠŸ...MAX_LISTENER_STACK_DEPTH(notifyListenersNow)æ‰§è¡Œ---ç›‘å¬å™¨[listener-4]å›è°ƒæˆåŠŸ...MAX_LISTENER_STACK_DEPTH(notifyListenersNow)æ‰§è¡Œ---ç›‘å¬å™¨[listener-5]å›è°ƒæˆåŠŸ...MAX_LISTENER_STACK_DEPTH(notifyListenersNow)æ‰§è¡Œ---ç›‘å¬å™¨[listener-6]å›è°ƒæˆåŠŸ...safeExecute(notifyListenersNow)æ‰§è¡Œ----------ç›‘å¬å™¨[listener-7]å›è°ƒæˆåŠŸ...safeExecute(notifyListenersNow)æ‰§è¡Œ----------ç›‘å¬å™¨[listener-8]å›è°ƒæˆåŠŸ... è¿™é‡Œç¬”è€…æœ‰ç‚¹ç–‘æƒ‘ï¼Œå¦‚æœè°ƒç”¨æ ˆæ·±åº¦å¤§äº8ï¼Œè¶…å‡ºçš„éƒ¨åˆ†ä¼šåŒ…è£…ä¸ºRunnableå®ä¾‹æäº¤åˆ°äº‹ä»¶æ‰§è¡Œå™¨æ‰§è¡Œï¼Œå²‚ä¸æ˜¯æŠŠé€’å½’æ ˆæº¢å‡ºçš„éšæ‚£å˜æˆäº†å†…å­˜æº¢å‡ºçš„éšæ‚£ï¼ˆå› ä¸ºå¼‚æ­¥ä»»åŠ¡ä¹Ÿæœ‰å¯èƒ½ç§¯å‹ï¼Œé™¤éæ‹’ç»ä»»åŠ¡æäº¤ï¼Œé‚£ä¹ˆå…·ä½“è¦çœ‹EventExecutorçš„å®ç°äº†ï¼‰ï¼Ÿ å°ç»“ Nettyæä¾›çš„Promiseå·¥å…·çš„æºç å’Œä½¿ç”¨æ–¹å¼éƒ½åˆ†æå®Œäº†ï¼Œè®¾è®¡ç†å¿µå’Œä»£ç éƒ½æ˜¯ååˆ†å€¼å¾—å€Ÿé‰´ï¼ŒåŒæ—¶èƒ½å¤Ÿå¼€ç®±å³ç”¨ï¼Œå¯ä»¥åœ¨æ—¥å¸¸ç¼–ç ä¸­ç›´æ¥å¼•å…¥ï¼Œå‡å°‘é‡å¤é€ è½®å­çš„åŠ³åŠ¨å’Œé£é™©ã€‚ ï¼ˆæœ¬æ–‡å®Œ e-a-20200123 c-3-dï¼‰","categories":[{"name":"Netty","slug":"Netty","permalink":"http://throwable.club/blog/categories/Netty/"},{"name":"Java","slug":"Netty/Java","permalink":"http://throwable.club/blog/categories/Netty/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/tags/Java/"},{"name":"Netty","slug":"Netty","permalink":"http://throwable.club/blog/tags/Netty/"}]},{"title":"çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ContextClassLoaderå†…å­˜æ³„æ¼éšæ‚£","slug":"java-thread-context-class-loader-memory-leak-risk","date":"2020-01-19T15:07:48.000Z","updated":"2020-01-20T00:32:17.916Z","comments":true,"path":"2020/01/19/java-thread-context-class-loader-memory-leak-risk/","link":"","permalink":"http://throwable.club/2020/01/19/java-thread-context-class-loader-memory-leak-risk/","excerpt":"å‰æ ä»Šå¤©ï¼ˆ2020-01-18ï¼‰åœ¨ç¼–å†™Nettyç›¸å…³ä»£ç çš„æ—¶å€™ï¼Œä»Nettyæºç ä¸­çš„ThreadDeathWatcherå’ŒGlobalEventExecutorè¿½æº¯åˆ°ä¸¤ä¸ªå’Œçº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ContextClassLoaderå†…å­˜æ³„æ¼ç›¸å…³çš„Issueï¼š ThreadDeathWatcher causes custom classLoader script memory leaks Ensure ThreadDeathWatcher and GlobalEventExecutor will not cause clasâ€¦ ä¸¤ä¸ªIssueåˆ†åˆ«æ˜¯ä¸¤ä½å‰è¾ˆåœ¨2017-12çš„æ—¶å€™æå‡ºçš„ï¼Œæè¿°çš„æ˜¯åŒä¸€ç±»é—®é¢˜ï¼Œæœ€åè¢«Nettyçš„è´Ÿè´£äººé‡‡çº³ï¼Œå¹¶ä¸”ä¿®å¤äº†å¯¹åº”çš„é—®é¢˜ä»è€Œå…³é—­äº†Issueã€‚è¿™é‡ŒåŸºäºè¿™ä¸¤ä¸ªIssueæè¿°çš„å†…å®¹ï¼Œå¯¹ContextClassLoaderå†…å­˜æ³„æ¼éšæ‚£åšä¸€æ¬¡å¤ç›˜ã€‚","text":"å‰æ ä»Šå¤©ï¼ˆ2020-01-18ï¼‰åœ¨ç¼–å†™Nettyç›¸å…³ä»£ç çš„æ—¶å€™ï¼Œä»Nettyæºç ä¸­çš„ThreadDeathWatcherå’ŒGlobalEventExecutorè¿½æº¯åˆ°ä¸¤ä¸ªå’Œçº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ContextClassLoaderå†…å­˜æ³„æ¼ç›¸å…³çš„Issueï¼š ThreadDeathWatcher causes custom classLoader script memory leaks Ensure ThreadDeathWatcher and GlobalEventExecutor will not cause clasâ€¦ ä¸¤ä¸ªIssueåˆ†åˆ«æ˜¯ä¸¤ä½å‰è¾ˆåœ¨2017-12çš„æ—¶å€™æå‡ºçš„ï¼Œæè¿°çš„æ˜¯åŒä¸€ç±»é—®é¢˜ï¼Œæœ€åè¢«Nettyçš„è´Ÿè´£äººé‡‡çº³ï¼Œå¹¶ä¸”ä¿®å¤äº†å¯¹åº”çš„é—®é¢˜ä»è€Œå…³é—­äº†Issueã€‚è¿™é‡ŒåŸºäºè¿™ä¸¤ä¸ªIssueæè¿°çš„å†…å®¹ï¼Œå¯¹ContextClassLoaderå†…å­˜æ³„æ¼éšæ‚£åšä¸€æ¬¡å¤ç›˜ã€‚ ClassLoaderç›¸å…³çš„å†…å®¹ ä¸€ä¸ªJVMå®ä¾‹ï¼ˆJavaåº”ç”¨ç¨‹åºï¼‰é‡Œé¢çš„æ‰€æœ‰ç±»éƒ½æ˜¯é€šè¿‡ClassLoaderåŠ è½½çš„ã€‚ ä¸åŒçš„ClassLoaderåœ¨JVMä¸­æœ‰ä¸åŒçš„å‘½åç©ºé—´ï¼Œä¸€ä¸ªç±»å®ä¾‹ï¼ˆClassï¼‰çš„å”¯ä¸€æ ‡è¯†æ˜¯å…¨ç±»å + ClassLoaderï¼Œä¹Ÿå°±æ˜¯ä¸åŒçš„ClassLoaderåŠ è½½åŒä¸€ä¸ªç±»æ–‡ä»¶ï¼Œä¹Ÿä¼šå¾—åˆ°ä¸ç›¸åŒçš„Classå®ä¾‹ã€‚ JVMä¸æä¾›ç±»å¸è½½çš„åŠŸèƒ½ï¼Œä»ç›®å‰å‚è€ƒåˆ°çš„èµ„æ–™æ¥çœ‹ï¼Œç±»å¸è½½éœ€è¦æ»¡è¶³ä¸‹é¢å‡ ç‚¹ï¼š æ¡ä»¶ä¸€ï¼šClassçš„æ‰€æœ‰å®ä¾‹ä¸è¢«å¼ºå¼•ç”¨ï¼ˆä¸å¯è¾¾ï¼‰ã€‚ æ¡ä»¶äºŒï¼šClassæœ¬èº«ä¸è¢«å¼ºå¼•ç”¨ï¼ˆä¸å¯è¾¾ï¼‰ã€‚ æ¡ä»¶ä¸‰ï¼šåŠ è½½è¯¥Classçš„ClassLoaderå®ä¾‹ä¸è¢«å¼ºå¼•ç”¨ï¼ˆä¸å¯è¾¾ï¼‰ã€‚ æœ‰äº›åœºæ™¯ä¸‹éœ€è¦å®ç°ç±»çš„çƒ­éƒ¨ç½²å’Œå¸è½½ï¼Œä¾‹å¦‚å®šä¹‰ä¸€ä¸ªæ¥å£ï¼Œç„¶åç”±å¤–éƒ¨åŠ¨æ€ä¼ å…¥ä»£ç çš„å®ç°ã€‚ è¿™ä¸€ç‚¹å¾ˆå¸¸è§ï¼Œæœ€å…¸å‹çš„å°±æ˜¯åœ¨çº¿ç¼–ç¨‹ï¼Œä»£ç ä¼ åˆ°æœåŠ¡ç«¯å†è¿›è¡Œç¼–è¯‘å’Œè¿è¡Œã€‚ ç”±äºåº”ç”¨å¯åŠ¨æœŸæ‰€æœ‰éJDKç±»åº“çš„ç±»éƒ½æ˜¯ç”±AppClassLoaderåŠ è½½ï¼Œæˆ‘ä»¬æ²¡æœ‰åŠæ³•é€šè¿‡AppClassLoaderå»åŠ è½½éç±»è·¯å¾„ä¸‹çš„å·²å­˜åœ¨åŒåçš„ç±»æ–‡ä»¶ï¼ˆå¯¹äºä¸€ä¸ªClassLoaderè€Œè¨€ï¼Œæ¯ä¸ªç±»æ–‡ä»¶åªèƒ½åŠ è½½ä¸€æ¬¡ï¼Œç”Ÿæˆå”¯ä¸€çš„Classï¼‰ï¼Œæ‰€ä»¥ä¸ºäº†åŠ¨æ€åŠ è½½ç±»ï¼Œæ¯æ¬¡å¿…é¡»ä½¿ç”¨å®Œå…¨ä¸åŒçš„è‡ªå®šä¹‰ClassLoaderå®ä¾‹åŠ è½½åŒä¸€ä¸ªç±»æ–‡ä»¶æˆ–è€…ä½¿ç”¨åŒä¸€ä¸ªè‡ªå®šä¹‰çš„ClassLoaderå®ä¾‹åŠ è½½ä¸åŒçš„ç±»æ–‡ä»¶ã€‚ç±»çš„çƒ­éƒ¨ç½²è¿™é‡Œä¸¾ä¸ªç®€å•ä¾‹å­ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374// æ­¤æ–‡ä»¶åœ¨é¡¹ç›®ç±»è·¯å¾„package club.throwable.loader;public class DefaultHelloService implements HelloService &#123; @Override public String sayHello() &#123; return \"default say hello!\"; &#125;&#125;// ä¸‹é¢ä¸¤ä¸ªæ–‡ä»¶ç¼–è¯‘åæ”¾åœ¨Iç›˜æ ¹ç›®å½•// I:\\\\DefaultHelloService1.classpackage club.throwable.loader;public class DefaultHelloService1 implements HelloService &#123; @Override public String sayHello() &#123; return \"1 say hello!\"; &#125;&#125;// I:\\\\DefaultHelloService2.classpackage club.throwable.loader;public class DefaultHelloService2 implements HelloService &#123; @Override public String sayHello() &#123; return \"2 say hello!\"; &#125;&#125;// æ¥å£å’Œè¿è¡Œæ–¹æ³•public interface HelloService &#123; String sayHello(); static void main(String[] args) throws Exception &#123; HelloService helloService = new DefaultHelloService(); System.out.println(helloService.sayHello()); ClassLoader loader = new ClassLoader() &#123; @Override protected Class&lt;?&gt; findClass(String name) throws ClassNotFoundException &#123; String location = \"I:\\\\DefaultHelloService1.class\"; if (name.contains(\"DefaultHelloService2\")) &#123; location = \"I:\\\\DefaultHelloService2.class\"; &#125; File classFile = new File(location); ByteArrayOutputStream outputStream = new ByteArrayOutputStream(); try &#123; InputStream stream = new FileInputStream(classFile); int b; while ((b = stream.read()) != -1) &#123; outputStream.write(b); &#125; &#125; catch (IOException e) &#123; throw new IllegalArgumentException(e); &#125; byte[] bytes = outputStream.toByteArray(); return super.defineClass(name, bytes, 0, bytes.length); &#125; &#125;; Class&lt;?&gt; klass = loader.loadClass(\"club.throwable.loader.DefaultHelloService1\"); helloService = (HelloService) klass.newInstance(); System.out.println(helloService.sayHello()); klass = loader.loadClass(\"club.throwable.loader.DefaultHelloService2\"); helloService = (HelloService) klass.newInstance(); System.out.println(helloService.sayHello()); &#125;&#125;// æ§åˆ¶å°è¾“å‡ºdefault say hello!1 say hello!2 say hello! å¦‚æœæ–°å»ºè¿‡å¤šçš„ClassLoaderå®ä¾‹å’ŒClasså®ä¾‹ï¼Œä¼šå ç”¨å¤§é‡çš„å†…å­˜ï¼Œå¦‚æœç”±äºä¸Šé¢å‡ ä¸ªæ¡ä»¶æ— æ³•å…¨éƒ¨æ»¡è¶³ï¼Œä¹Ÿå°±æ˜¯è¿™äº›ClassLoaderå®ä¾‹å’ŒClasså®ä¾‹ä¸€ç›´å †ç§¯æ— æ³•å¸è½½ï¼Œé‚£ä¹ˆå°±ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ï¼ˆmemory leakï¼Œåæœå¾ˆä¸¥é‡ï¼Œæœ‰å¯èƒ½è€—å°½æœåŠ¡å™¨çš„ç‰©ç†å†…å­˜ï¼Œå› ä¸ºJDK1.8+ç±»ç›¸å…³å…ƒä¿¡æ¯å­˜åœ¨åœ¨å…ƒç©ºé—´metaspaceï¼Œè€Œå…ƒç©ºé—´ä½¿ç”¨çš„æ˜¯native memoryï¼‰ã€‚ çº¿ç¨‹ä¸­çš„ContextClassLoader ContextClassLoaderå…¶å®æŒ‡çš„æ˜¯çº¿ç¨‹ç±»java.lang.Threadä¸­çš„contextClassLoaderå±æ€§ï¼Œå®ƒæ˜¯ClassLoaderç±»å‹ï¼Œä¹Ÿå°±æ˜¯ç±»åŠ è½½å™¨å®ä¾‹ã€‚æœ‰äº›åœºæ™¯ä¸‹ï¼ŒJDKæä¾›äº†ä¸€äº›æ ‡å‡†æ¥å£éœ€è¦ç¬¬ä¸‰æ–¹æä¾›å•†å»å®ç°ï¼ˆæœ€å¸¸è§çš„å°±æ˜¯SPIï¼ŒService Provider Interfaceï¼Œä¾‹å¦‚java.sql.Driverï¼‰ï¼Œè¿™äº›æ ‡å‡†æ¥å£ç±»æ˜¯ç”±å¯åŠ¨ç±»åŠ è½½å™¨(Bootstrap ClassLoader)åŠ è½½ï¼Œä½†æ˜¯è¿™äº›æ¥å£çš„å®ç°ç±»éœ€è¦ä»å¤–éƒ¨å¼•å…¥ï¼Œæœ¬èº«ä¸å±äºJDKçš„åŸç”Ÿç±»åº“ï¼Œæ— æ³•ç”¨å¯åŠ¨ç±»åŠ è½½å™¨åŠ è½½ã€‚ä¸ºäº†è§£å†³æ­¤å›°å¢ƒï¼Œå¼•å…¥äº†çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨Thread Context ClassLoaderã€‚çº¿ç¨‹java.lang.Threadå®ä¾‹åœ¨åˆå§‹åŒ–çš„æ—¶å€™ä¼šè°ƒç”¨Thread#init()æ–¹æ³•ï¼ŒThreadç±»å’ŒcontextClassLoaderç›¸å…³çš„æ ¸å¿ƒä»£ç å—å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132// çº¿ç¨‹å®ä¾‹çš„åˆå§‹åŒ–æ–¹æ³•,new Thread()çš„æ—¶å€™ä¸€å®šä¼šè°ƒç”¨private void init(ThreadGroup g, Runnable target, String name, long stackSize, AccessControlContext acc, boolean inheritThreadLocals) &#123; // çœç•¥å…¶ä»–ä»£ç  Thread parent = currentThread(); // çœç•¥å…¶ä»–ä»£ç  if (security == null || isCCLOverridden(parent.getClass())) this.contextClassLoader = parent.getContextClassLoader(); else this.contextClassLoader = parent.contextClassLoader; // çœç•¥å…¶ä»–ä»£ç &#125;public void setContextClassLoader(ClassLoader cl) &#123; SecurityManager sm = System.getSecurityManager(); if (sm != null) &#123; sm.checkPermission(new RuntimePermission(\"setContextClassLoader\")); &#125; contextClassLoader = cl;&#125;@CallerSensitivepublic ClassLoader getContextClassLoader() &#123; if (contextClassLoader == null) return null; SecurityManager sm = System.getSecurityManager(); if (sm != null) &#123; ClassLoader.checkClassLoaderPermission(contextClassLoader, Reflection.getCallerClass()); &#125; return contextClassLoader;&#125; é¦–å…ˆæ˜ç¡®ä¸¤ç‚¹ï¼š Threadå®ä¾‹å…è®¸æ‰‹åŠ¨è®¾ç½®contextClassLoaderå±æ€§ï¼Œè¦†ç›–å½“å‰çš„çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨å®ä¾‹ã€‚ Threadåœ¨åˆå§‹åŒ–å®ä¾‹ï¼ˆè°ƒç”¨new Thread()ï¼‰çš„æ—¶å€™ä¸€å®šä¼šè°ƒç”¨Thread#init()æ–¹æ³•ï¼Œæ–°å»ºçš„å­çº¿ç¨‹å®ä¾‹ä¼šç»§æ‰¿çˆ¶çº¿ç¨‹çš„contextClassLoaderå±æ€§ï¼Œè€Œåº”ç”¨ä¸»çº¿ç¨‹[main]çš„contextClassLoaderä¸€èˆ¬æ˜¯åº”ç”¨ç±»åŠ è½½å™¨ï¼ˆApplication ClassLoaderï¼Œæœ‰æ—¶ä¹Ÿç§°ä¸ºç³»ç»Ÿç±»åŠ è½½å™¨ï¼‰ï¼Œå…¶ä»–ç”¨æˆ·çº¿ç¨‹éƒ½æ˜¯ä¸»çº¿ç¨‹æ´¾ç”Ÿå‡ºæ¥çš„åä»£çº¿ç¨‹ï¼Œå¦‚æœä¸è¦†ç›–contextClassLoaderï¼Œé‚£ä¹ˆæ–°å»ºçš„åä»£çº¿ç¨‹çš„contextClassLoaderå°±æ˜¯åº”ç”¨ç±»åŠ è½½å™¨ã€‚ åˆ†æåˆ°è¿™é‡Œï¼Œç¬”è€…åªæƒ³è¯´æ˜ä¸€ä¸ªç»“è®ºï¼šåä»£çº¿ç¨‹çš„çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ä¼šç»§æ‰¿çˆ¶çº¿ç¨‹çš„çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼Œå…¶å®è¿™é‡Œç”¨ç»§æ‰¿è¿™ä¸ªè¯è¯­ä¹Ÿä¸æ˜¯å¤ªå‡†ç¡®ï¼Œå‡†ç¡®æ¥è¯´åº”è¯¥æ˜¯åä»£çº¿ç¨‹çš„çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨å’Œçˆ¶çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨å®Œå…¨ç›¸åŒï¼Œå¦‚æœéƒ½æ´¾ç”Ÿè‡ªä¸»çº¿ç¨‹ï¼Œé‚£ä¹ˆéƒ½æ˜¯åº”ç”¨ç±»åŠ è½½å™¨ã€‚å¯¹äºè¿™ä¸ªç»“è®ºå¯ä»¥éªŒè¯ä¸€ä¸‹ï¼ˆä¸‹é¢ä¾‹å­åœ¨JDK8ä¸­è¿è¡Œï¼‰ï¼š 1234567891011121314151617public class ThreadContextClassLoaderMain &#123; public static void main(String[] args) throws Exception &#123; AtomicReference&lt;Thread&gt; grandSonThreadReference = new AtomicReference&lt;&gt;(); Thread sonThread = new Thread(() -&gt; &#123; Thread thread = new Thread(()-&gt; &#123;&#125;,\"grand-son-thread\"); grandSonThreadReference.set(thread); &#125;, \"son-thread\"); sonThread.start(); Thread.sleep(100); Thread main = Thread.currentThread(); Thread grandSonThread = grandSonThreadReference.get(); System.out.println(String.format(\"ContextClassLoader of [main]:%s\", main.getContextClassLoader())); System.out.println(String.format(\"ContextClassLoader of [%s]:%s\",sonThread.getName(), sonThread.getContextClassLoader())); System.out.println(String.format(\"ContextClassLoader of [%s]:%s\", grandSonThread.getName(), grandSonThread.getContextClassLoader())); &#125;&#125; æ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š 123ContextClassLoader of [main]:sun.misc.Launcher$AppClassLoader@18b4aac2ContextClassLoader of [son-thread]:sun.misc.Launcher$AppClassLoader@18b4aac2ContextClassLoader of [grand-son-thread]:sun.misc.Launcher$AppClassLoader@18b4aac2 å°è¯äº†å‰é¢çš„ç»“è®ºï¼Œä¸»çº¿ç¨‹ã€å­çº¿ç¨‹ã€å­™å­çº¿ç¨‹çš„çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨éƒ½æ˜¯AppClassLoaderç±»å‹ï¼Œå¹¶ä¸”æŒ‡å‘åŒä¸€ä¸ªå®ä¾‹sun.misc.Launcher$AppClassLoader@18b4aac2ã€‚ ContextClassLoaderè®¾ç½®ä¸å½“å¯¼è‡´å†…å­˜æ³„æ¼çš„éšæ‚£ åªè¦æœ‰å¤§é‡çƒ­åŠ è½½å’Œå¸è½½åŠ¨æ€ç±»çš„åœºæ™¯ï¼Œå°±éœ€è¦è­¦æƒ•åä»£çº¿ç¨‹ContextClassLoaderè®¾ç½®ä¸å½“å¯¼è‡´å†…å­˜æ³„æ¼ã€‚ç”»ä¸ªå›¾å°±èƒ½æ¯”è¾ƒæ¸…æ¥šï¼š çˆ¶çº¿ç¨‹ä¸­è®¾ç½®äº†ä¸€ä¸ªè‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼Œç”¨äºåŠ è½½åŠ¨æ€ç±»ï¼Œå­çº¿ç¨‹æ–°å»ºçš„æ—¶å€™ç›´æ¥ä½¿ç”¨äº†çˆ¶çº¿ç¨‹çš„è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼Œå¯¼è‡´è¯¥è‡ªå®šä¹‰ç±»åŠ è½½å™¨ä¸€ç›´è¢«å­çº¿ç¨‹å¼ºå¼•ç”¨ï¼Œç»“åˆå‰é¢çš„ç±»å¸è½½æ¡ä»¶åˆ†æï¼Œæ‰€æœ‰ç”±è¯¥è‡ªå®šä¹‰ç±»åŠ è½½å™¨åŠ è½½å‡ºæ¥çš„åŠ¨æ€ç±»éƒ½ä¸èƒ½è¢«å¸è½½ï¼Œå¯¼è‡´äº†å†…å­˜æ³„æ¼ã€‚è¿™é‡Œè¿˜æ˜¯åŸºäºæ–‡ç« å‰é¢çš„é‚£ä¸ªä¾‹å­åšæ”¹é€ ï¼š æ–°å¢ä¸€ä¸ªçº¿ç¨‹Xç”¨äºè¿›è¡Œç±»åŠ è½½ï¼Œæ–°å»ºä¸€ä¸ªè‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼Œè®¾ç½®çº¿ç¨‹Xçš„ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ä¸ºè¯¥è‡ªå®šä¹‰ç±»åŠ è½½å™¨ã€‚ çº¿ç¨‹Xè¿è¡Œæ–¹æ³•ä¸­åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹Yï¼Œç”¨äºæ¥æ”¶ç±»åŠ è½½æˆåŠŸçš„äº‹ä»¶å¹¶ä¸”è¿›è¡Œæ‰“å°ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081public interface HelloService &#123; String sayHello(); BlockingQueue&lt;String&gt; CLASSES = new LinkedBlockingQueue&lt;&gt;(); BlockingQueue&lt;String&gt; EVENTS = new LinkedBlockingQueue&lt;&gt;(); AtomicBoolean START = new AtomicBoolean(false); static void main(String[] args) throws Exception &#123; Thread thread = new Thread(() -&gt; &#123; ClassLoader loader = new ClassLoader() &#123; @Override protected Class&lt;?&gt; findClass(String name) throws ClassNotFoundException &#123; String location = \"I:\\\\DefaultHelloService1.class\"; if (name.contains(\"DefaultHelloService2\")) &#123; location = \"I:\\\\DefaultHelloService2.class\"; &#125; File classFile = new File(location); ByteArrayOutputStream outputStream = new ByteArrayOutputStream(); try &#123; InputStream stream = new FileInputStream(classFile); int b; while ((b = stream.read()) != -1) &#123; outputStream.write(b); &#125; &#125; catch (IOException e) &#123; throw new IllegalArgumentException(e); &#125; byte[] bytes = outputStream.toByteArray(); Class&lt;?&gt; defineClass = super.defineClass(name, bytes, 0, bytes.length); try &#123; EVENTS.put(String.format(\"åŠ è½½ç±»æˆåŠŸ,ç±»å:%s\", defineClass.getName())); &#125; catch (Exception ignore) &#123; &#125; return defineClass; &#125; &#125;; Thread x = new Thread(() -&gt; &#123; try &#123; if (START.compareAndSet(false, true)) &#123; Thread y = new Thread(() -&gt; &#123; try &#123; for (; ; ) &#123; String event = EVENTS.take(); System.out.println(\"æ¥æ”¶åˆ°äº‹ä»¶,äº‹ä»¶å†…å®¹:\" + event); &#125; &#125; catch (Exception ignore) &#123; &#125; &#125;, \"Y\"); y.setDaemon(true); y.start(); &#125; for (; ; ) &#123; String take = CLASSES.take(); Class&lt;?&gt; klass = loader.loadClass(take); HelloService helloService = (HelloService) klass.newInstance(); System.out.println(helloService.sayHello()); &#125; &#125; catch (Exception ignore) &#123; &#125; &#125;, \"X\"); x.setContextClassLoader(loader); x.setDaemon(true); x.start(); &#125;); thread.start(); CLASSES.put(\"club.throwable.loader.DefaultHelloService1\"); CLASSES.put(\"club.throwable.loader.DefaultHelloService2\"); Thread.sleep(5000); System.gc(); Thread.sleep(5000); System.gc(); Thread.sleep(Long.MAX_VALUE); &#125;&#125; æ§åˆ¶å°è¾“å‡ºï¼š 1234æ¥æ”¶åˆ°äº‹ä»¶,äº‹ä»¶å†…å®¹:åŠ è½½ç±»æˆåŠŸ,ç±»å:club.throwable.loader.DefaultHelloService11 say hello!æ¥æ”¶åˆ°äº‹ä»¶,äº‹ä»¶å†…å®¹:åŠ è½½ç±»æˆåŠŸ,ç±»å:club.throwable.loader.DefaultHelloService22 say hello! æ‰“å¼€VisualVMï¼ŒDumpå¯¹åº”è¿›ç¨‹çš„å†…å­˜å¿«ç…§ï¼Œå¤šæ‰§è¡Œå‡ æ¬¡GCï¼Œå‘ç°äº†æ‰€æœ‰åŠ¨æ€ç±»éƒ½æ²¡æœ‰è¢«å¸è½½ï¼ˆè¿™é‡Œé™¤éä¸»åŠ¨ç»ˆæ­¢çº¿ç¨‹Yé‡Šæ”¾è‡ªå®šä¹‰ClassLoaderï¼Œå¦åˆ™æ°¸è¿œéƒ½ä¸å¯èƒ½é‡Šæ”¾è¯¥å¼ºå¼•ç”¨ï¼‰ï¼ŒéªŒè¯äº†å‰é¢çš„ç»“è®ºã€‚ å½“ç„¶ï¼Œè¿™é‡Œåªæ˜¯åŠ è½½äº†ä¸¤ä¸ªåŠ¨æ€ç±»ï¼Œå¦‚æœåœ¨ç‰¹æ®Šåœºæ™¯ä¹‹ä¸‹ï¼Œä¾‹å¦‚åœ¨çº¿ç¼–ç å’Œè¿è¡Œä»£ç ï¼Œé‚£ä¹ˆæœ‰å¯èƒ½æåº¦é¢‘ç¹åŠ¨æ€ç¼–è¯‘å’ŒåŠ¨æ€ç±»åŠ è½½ï¼Œå¦‚æœå‡ºç°äº†ä¸Šé¢ç±»ä¼¼çš„å†…å­˜æ³„æ¼ï¼Œé‚£ä¹ˆå¾ˆå®¹æ˜“å¯¼è‡´æœåŠ¡å™¨å†…å­˜è€—å°½ã€‚ è§£å†³æ–¹æ¡ˆ å‚è€ƒé‚£ä¸¤ä¸ªIssueï¼Œè§£å†³æ–¹æ¡ˆï¼ˆæˆ–è€…è¯´é¢„é˜²æ‰‹æ®µï¼‰åŸºæœ¬ä¸Šæœ‰ä¸¤ä¸ªï¼š ä¸éœ€è¦ä½¿ç”¨è‡ªå®šä¹‰ç±»åŠ è½½å™¨çš„çº¿ç¨‹ï¼ˆå¦‚äº‹ä»¶æ´¾å‘çº¿ç¨‹ç­‰ï¼‰ä¼˜å…ˆåˆå§‹åŒ–ï¼Œé‚£ä¹ˆä¸€èˆ¬å®ƒçš„çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨æ˜¯åº”ç”¨ç±»åŠ è½½å™¨ã€‚ æ–°å»ºåä»£çº¿ç¨‹çš„æ—¶å€™ï¼Œæ‰‹åŠ¨è¦†ç›–å®ƒçš„çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼Œå‚è€ƒNettyçš„åšæ³•ï¼Œåœ¨çº¿ç¨‹åˆå§‹åŒ–çš„æ—¶å€™åšå¦‚ä¸‹çš„æ“ä½œï¼š 12345678// ThreadDeathWatcher || GlobalEventExecutorAccessController.doPrivileged(new PrivilegedAction&lt;Void&gt;() &#123; @Override public Void run() &#123; watcherThread.setContextClassLoader(null); return null; &#125;&#125;); å°ç»“ è¿™ç¯‡æ–‡ç« ç®—æ˜¯è¿‘æœŸç ”ç©¶å¾—æ¯”è¾ƒæ·±å…¥çš„ä¸€ç¯‡æ–‡ç« ï¼ŒContextClassLoaderå†…å­˜æ³„æ¼çš„éšæ‚£å½’æ ¹åˆ°åº•æ˜¯å¼•ç”¨ä½¿ç”¨ä¸å½“å¯¼è‡´ä¸€äº›æœ¬æ¥åœ¨æ–¹æ³•æ ˆé€€å‡ºä¹‹åéœ€è¦é‡Šæ”¾çš„å¼•ç”¨æ— æ³•é‡Šæ”¾å¯¼è‡´çš„ã€‚è¿™ç§é—®é¢˜æœ‰äº›æ—¶å€™éšè—å¾—å¾ˆæ·±ï¼Œè€Œä¸€æ—¦å‘½ä¸­äº†åŒæ ·çš„é—®é¢˜å¹¶ä¸”åœ¨å¹¶å‘çš„åœºæ™¯ä¹‹ä¸‹ï¼Œé‚£ä¹ˆå†…å­˜æ³„æ¼çš„é—®é¢˜ä¼šæ¶åŒ–å¾—ååˆ†å¿«ã€‚è¿™ç±»é—®é¢˜å½’ç±»ä¸ºæ€§èƒ½ä¼˜åŒ–ï¼Œè€Œæ€§èƒ½ä¼˜åŒ–æ˜¯ååˆ†å¤§çš„ä¸“é¢˜ï¼Œä»¥ååº”è¯¥ä¹Ÿä¼šé‡åˆ°ç±»ä¼¼çš„å„ç±»é—®é¢˜ï¼Œè¿™äº›ç»éªŒå¸Œæœ›èƒ½å¯¹æœªæ¥äº§ç”Ÿæ­£å‘çš„ä½œç”¨ã€‚ å‚è€ƒèµ„æ–™ï¼š ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœº - 3rdã€‹ ï¼ˆæœ¬æ–‡å®Œ c-2-d e-a-20200119ï¼‰","categories":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/categories/Java/"},{"name":"Concurrency","slug":"Java/Concurrency","permalink":"http://throwable.club/blog/categories/Java/Concurrency/"}],"tags":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/tags/Java/"},{"name":"Thread","slug":"Thread","permalink":"http://throwable.club/blog/tags/Thread/"}]},{"title":"åŸºäºNettyå’ŒSpringBootå®ç°ä¸€ä¸ªè½»é‡çº§RPCæ¡†æ¶-Clientç«¯è¯·æ±‚å“åº”åŒæ­¥åŒ–å¤„ç†","slug":"netty-custom-rpc-framework-client-sync","date":"2020-01-18T06:52:32.000Z","updated":"2020-01-18T06:53:02.380Z","comments":true,"path":"2020/01/18/netty-custom-rpc-framework-client-sync/","link":"","permalink":"http://throwable.club/2020/01/18/netty-custom-rpc-framework-client-sync/","excerpt":"å‰æ å‰ç½®æ–‡ç« ï¼š ã€ŠåŸºäºNettyå’ŒSpringBootå®ç°ä¸€ä¸ªè½»é‡çº§RPCæ¡†æ¶-åè®®ç¯‡ã€‹ ã€ŠåŸºäºNettyå’ŒSpringBootå®ç°ä¸€ä¸ªè½»é‡çº§RPCæ¡†æ¶-Serverç¯‡ã€‹ ã€ŠåŸºäºNettyå’ŒSpringBootå®ç°ä¸€ä¸ªè½»é‡çº§RPCæ¡†æ¶-Clientç¯‡ã€‹ å‰ä¸€ç¯‡æ–‡ç« ç®€å•ä»‹ç»äº†é€šè¿‡åŠ¨æ€ä»£ç†å®Œæˆäº†Clientç«¯å¥‘çº¦æ¥å£è°ƒç”¨è½¬æ¢ä¸ºå‘é€RPCåè®®è¯·æ±‚çš„åŠŸèƒ½ã€‚è¿™ç¯‡æ–‡ç« ä¸»è¦è§£å†³ä¸€ä¸ªé—ç•™çš„æŠ€æœ¯éš¾é¢˜ï¼šè¯·æ±‚-å“åº”åŒæ­¥åŒ–å¤„ç†ã€‚ éœ€è¦çš„ä¾èµ–å¦‚ä¸‹ï¼š JDK1.8+ Netty:4.1.44.Final SpringBoot:2.2.2.RELEASE","text":"å‰æ å‰ç½®æ–‡ç« ï¼š ã€ŠåŸºäºNettyå’ŒSpringBootå®ç°ä¸€ä¸ªè½»é‡çº§RPCæ¡†æ¶-åè®®ç¯‡ã€‹ ã€ŠåŸºäºNettyå’ŒSpringBootå®ç°ä¸€ä¸ªè½»é‡çº§RPCæ¡†æ¶-Serverç¯‡ã€‹ ã€ŠåŸºäºNettyå’ŒSpringBootå®ç°ä¸€ä¸ªè½»é‡çº§RPCæ¡†æ¶-Clientç¯‡ã€‹ å‰ä¸€ç¯‡æ–‡ç« ç®€å•ä»‹ç»äº†é€šè¿‡åŠ¨æ€ä»£ç†å®Œæˆäº†Clientç«¯å¥‘çº¦æ¥å£è°ƒç”¨è½¬æ¢ä¸ºå‘é€RPCåè®®è¯·æ±‚çš„åŠŸèƒ½ã€‚è¿™ç¯‡æ–‡ç« ä¸»è¦è§£å†³ä¸€ä¸ªé—ç•™çš„æŠ€æœ¯éš¾é¢˜ï¼šè¯·æ±‚-å“åº”åŒæ­¥åŒ–å¤„ç†ã€‚ éœ€è¦çš„ä¾èµ–å¦‚ä¸‹ï¼š JDK1.8+ Netty:4.1.44.Final SpringBoot:2.2.2.RELEASE ç®€å•åˆ†æNettyè¯·æ±‚-å“åº”çš„å¤„ç†æµç¨‹ å›¾ä¸­å·²ç»å¿½ç•¥äº†ç¼–ç è§£ç å™¨å’Œå…¶ä»–å…¥ç«™å‡ºç«™å¤„ç†å™¨ï¼Œä¸åŒé¢œè‰²çš„çº¿ç¨‹ä»£è¡¨å®Œå…¨ä¸ç›¸åŒçš„çº¿ç¨‹ï¼Œä¸åŒçº¿ç¨‹ä¹‹é—´çš„å¤„ç†é€»è¾‘æ˜¯å®Œå…¨å¼‚æ­¥ï¼Œä¹Ÿå°±æ˜¯Netty IOçº¿ç¨‹ï¼ˆn-l-g-1ï¼‰æ¥æ”¶åˆ°Serverç«¯çš„æ¶ˆæ¯å¹¶ä¸”è§£æå®Œæˆçš„æ—¶å€™ï¼Œç”¨æˆ·è°ƒç”¨çº¿ç¨‹ï¼ˆu-t-1ï¼‰æ— æ³•æ„ŸçŸ¥åˆ°è§£æå®Œæ¯•çš„æ¶ˆæ¯åŒ…ï¼Œé‚£ä¹ˆè¿™é‡Œè¦åšçš„äº‹æƒ…å°±æ˜¯è®©ç”¨æˆ·è°ƒç”¨çº¿ç¨‹ï¼ˆu-t-1ï¼‰è·å–åˆ°Netty IOçº¿ç¨‹ï¼ˆn-l-g-1ï¼‰æ¥æ”¶å¹¶ä¸”è§£æå®Œæˆçš„æ¶ˆæ¯åŒ…ã€‚ è¿™é‡Œå¯ä»¥ç”¨ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥è¯´æ˜æ¨¡æ‹ŸClientç«¯è°ƒç”¨çº¿ç¨‹ç­‰å¾…Netty IOçº¿ç¨‹çš„å¤„ç†ç»“æœå†åŒæ­¥è¿”å›çš„è¿‡ç¨‹ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114@Slf4jpublic class NettyThreadSyncTest &#123; @ToString private static class ResponseFuture &#123; private final long beginTimestamp = System.currentTimeMillis(); @Getter private final long timeoutMilliseconds; @Getter private final String requestId; @Setter @Getter private volatile boolean sendRequestSucceed = false; @Setter @Getter private volatile Throwable cause; @Getter private volatile Object response; private final CountDownLatch latch = new CountDownLatch(1); public ResponseFuture(String requestId, long timeoutMilliseconds) &#123; this.requestId = requestId; this.timeoutMilliseconds = timeoutMilliseconds; &#125; public boolean timeout() &#123; return System.currentTimeMillis() - beginTimestamp &gt; timeoutMilliseconds; &#125; public Object waitResponse(final long timeoutMilliseconds) throws InterruptedException &#123; latch.await(timeoutMilliseconds, TimeUnit.MILLISECONDS); return response; &#125; public void putResponse(Object response) throws InterruptedException &#123; this.response = response; latch.countDown(); &#125; &#125; static ExecutorService REQUEST_THREAD; static ExecutorService NETTY_IO_THREAD; static Callable&lt;Object&gt; REQUEST_TASK; static Runnable RESPONSE_TASK; static String processBusiness(String name) &#123; return String.format(\"%s say hello!\", name); &#125; private static final Map&lt;String /* request id */, ResponseFuture&gt; RESPONSE_FUTURE_TABLE = Maps.newConcurrentMap(); @BeforeClass public static void beforeClass() throws Exception &#123; String requestId = UUID.randomUUID().toString(); String requestContent = \"throwable\"; REQUEST_TASK = () -&gt; &#123; try &#123; // 3ç§’æ²¡æœ‰å¾—åˆ°å“åº”è®¤ä¸ºè¶…æ—¶ ResponseFuture responseFuture = new ResponseFuture(requestId, 3000); RESPONSE_FUTURE_TABLE.put(requestId, responseFuture); // è¿™é‡Œå¿½ç•¥å‘é€è¯·æ±‚çš„æ“ä½œ,åªæ‰“å°æ—¥å¿—å’Œæ¨¡æ‹Ÿè€—æ—¶1ç§’ Thread.sleep(1000); log.info(\"å‘é€è¯·æ±‚æˆåŠŸ,è¯·æ±‚ID:&#123;&#125;,è¯·æ±‚å†…å®¹:&#123;&#125;\", requestId, requestContent); // æ›´æ–°æ ‡è®°å±æ€§ responseFuture.setSendRequestSucceed(true); // å‰©ä½™2ç§’ç­‰å¾…æ—¶é—´ - è¿™é‡Œåªæ˜¯ç²—ç•¥è®¡ç®— return responseFuture.waitResponse(3000 - 1000); &#125; catch (Exception e) &#123; log.info(\"å‘é€è¯·æ±‚å¤±è´¥,è¯·æ±‚ID:&#123;&#125;,è¯·æ±‚å†…å®¹:&#123;&#125;\", requestId, requestContent); throw new RuntimeException(e); &#125; &#125;; RESPONSE_TASK = () -&gt; &#123; String responseContent = processBusiness(requestContent); try &#123; ResponseFuture responseFuture = RESPONSE_FUTURE_TABLE.get(requestId); if (null != responseFuture) &#123; log.warn(\"å¤„ç†å“åº”æˆåŠŸ,è¯·æ±‚ID:&#123;&#125;,å“åº”å†…å®¹:&#123;&#125;\", requestId, responseContent); responseFuture.putResponse(responseContent); &#125; else &#123; log.warn(\"è¯·æ±‚ID[&#123;&#125;]å¯¹åº”çš„ResponseFutureä¸å­˜åœ¨,å¿½ç•¥å¤„ç†\", requestId); &#125; &#125; catch (Exception e) &#123; log.info(\"å¤„ç†å“åº”å¤±è´¥,è¯·æ±‚ID:&#123;&#125;,å“åº”å†…å®¹:&#123;&#125;\", requestId, responseContent); throw new RuntimeException(e); &#125; &#125;; REQUEST_THREAD = Executors.newSingleThreadExecutor(runnable -&gt; &#123; Thread thread = new Thread(runnable, \"REQUEST_THREAD\"); thread.setDaemon(true); return thread; &#125;); NETTY_IO_THREAD = Executors.newSingleThreadExecutor(runnable -&gt; &#123; Thread thread = new Thread(runnable, \"NETTY_IO_THREAD\"); thread.setDaemon(true); return thread; &#125;); &#125; @Test public void testProcessSync() throws Exception &#123; log.info(\"å¼‚æ­¥æäº¤è¯·æ±‚å¤„ç†ä»»åŠ¡......\"); Future&lt;Object&gt; future = REQUEST_THREAD.submit(REQUEST_TASK); // æ¨¡æ‹Ÿè¯·æ±‚è€—æ—¶ Thread.sleep(1500); log.info(\"å¼‚æ­¥æäº¤å“åº”å¤„ç†ä»»åŠ¡......\"); NETTY_IO_THREAD.execute(RESPONSE_TASK); // è¿™é‡Œå¯ä»¥è®¾ç½®è¶…æ—¶ log.info(\"åŒæ­¥è·å–è¯·æ±‚ç»“æœ:&#123;&#125;\", future.get()); Thread.sleep(Long.MAX_VALUE); &#125;&#125; æ‰§è¡ŒtestProcessSync()æ–¹æ³•ï¼Œæ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š 123452020-01-18 13:17:07 [main] INFO c.t.client.NettyThreadSyncTest - å¼‚æ­¥æäº¤è¯·æ±‚å¤„ç†ä»»åŠ¡......2020-01-18 13:17:08 [REQUEST_THREAD] INFO c.t.client.NettyThreadSyncTest - å‘é€è¯·æ±‚æˆåŠŸ,è¯·æ±‚ID:71f47e27-c17c-458d-b271-4e74fad33a7b,è¯·æ±‚å†…å®¹:throwable2020-01-18 13:17:09 [main] INFO c.t.client.NettyThreadSyncTest - å¼‚æ­¥æäº¤å“åº”å¤„ç†ä»»åŠ¡......2020-01-18 13:17:09 [NETTY_IO_THREAD] WARN c.t.client.NettyThreadSyncTest - å¤„ç†å“åº”æˆåŠŸ,è¯·æ±‚ID:71f47e27-c17c-458d-b271-4e74fad33a7b,å“åº”å†…å®¹:throwable say hello!2020-01-18 13:17:09 [main] INFO c.t.client.NettyThreadSyncTest - åŒæ­¥è·å–è¯·æ±‚ç»“æœ:throwable say hello! ä¸Šé¢è¿™ä¸ªä¾‹å­é‡Œé¢çš„çº¿ç¨‹åŒæ­¥å¤„ç†ä¸»è¦å‚è€ƒä¸»æµçš„Nettyæ¡†æ¶å®¢æˆ·ç«¯éƒ¨åˆ†çš„å®ç°é€»è¾‘ï¼šRocketMQï¼ˆå…·ä½“æ˜¯NettyRemotingClientç±»ï¼‰ä»¥åŠRedissonï¼ˆå…·ä½“æ˜¯RedisExecutorç±»ï¼‰ï¼Œå®ƒä»¬å°±æ˜¯ç”¨è¿™ç§æ–¹å¼ä½¿å¾—å¼‚æ­¥çº¿ç¨‹å¤„ç†è½¬åŒ–ä¸ºåŒæ­¥å¤„ç†ã€‚ Clientç«¯è¯·æ±‚å“åº”åŒæ­¥åŒ–å¤„ç† æŒ‰ç…§å‰é¢çš„ä¾‹å­ï¼Œé¦–å…ˆæ–°å¢ä¸€ä¸ªResponseFutureç”¨äºæ‰¿è½½å·²å‘é€ä½†æœªå“åº”çš„è¯·æ±‚ï¼š 1234567891011121314151617181920212223242526272829303132333435363738@ToStringpublic class ResponseFuture &#123; private final long beginTimestamp = System.currentTimeMillis(); @Getter private final long timeoutMilliseconds; @Getter private final String requestId; @Setter @Getter private volatile boolean sendRequestSucceed = false; @Setter @Getter private volatile Throwable cause; @Getter private volatile ResponseMessagePacket response; private final CountDownLatch latch = new CountDownLatch(1); public ResponseFuture(String requestId, long timeoutMilliseconds) &#123; this.requestId = requestId; this.timeoutMilliseconds = timeoutMilliseconds; &#125; public boolean timeout() &#123; return System.currentTimeMillis() - beginTimestamp &gt; timeoutMilliseconds; &#125; public ResponseMessagePacket waitResponse(final long timeoutMilliseconds) throws InterruptedException &#123; latch.await(timeoutMilliseconds, TimeUnit.MILLISECONDS); return response; &#125; public void putResponse(ResponseMessagePacket response) throws InterruptedException &#123; this.response = response; latch.countDown(); &#125;&#125; æ¥ç€éœ€è¦æ–°å¢ä¸€ä¸ªHashMapå»ç¼“å­˜è¿™äº›è¿”é€æˆåŠŸä½†æ˜¯æœªå¾—åˆ°å“åº”å¤„ç†çš„ResponseFutureï¼š 1Map&lt;String /* request id */, ResponseFuture&gt; RESPONSE_FUTURE_TABLE = Maps.newConcurrentMap(); è¿™é‡Œçš„KEYé€‰ç”¨requestIdï¼Œè€ŒrequestIdä¹‹å‰å·²ç»å®šä¹‰ä¸ºUUIDï¼Œç¡®ä¿æ¯ä¸ªè¯·æ±‚ä¸ä¼šé‡å¤ã€‚ä¸ºäº†ç®€å•èµ·è§ï¼Œç›®å‰æ‰€æœ‰çš„é€»è¾‘éƒ½ç¼–å†™åœ¨å¥‘çº¦ä»£ç†å·¥å‚ContractProxyFactoryï¼Œæ·»åŠ ä¸‹é¢çš„åŠŸèƒ½ï¼š æ·»åŠ ä¸€ä¸ªåŒæ­¥å‘é€æ–¹æ³•sendRequestSync()å¤„ç†æ¶ˆæ¯åŒ…çš„å‘é€å’ŒåŒæ­¥å“åº”ï¼ŒRequestMessagePacketè½¬æ¢ä¸ºè°ƒç”¨ä»£ç†ç›®æ ‡æ–¹æ³•è¿”å›å€¼ç±»å‹çš„é€»è¾‘æš‚æ—¶ä¹Ÿç¼–å†™åœ¨æ­¤æ–¹æ³•ä¸­ã€‚ æ·»åŠ ä¸€ä¸ªæ ¸å¿ƒçº¿ç¨‹æ•°é‡ä¸ºé€»è¾‘æ ¸å¿ƒæ•°é‡ * 2çš„çº¿ç¨‹æ± ç”¨äºå¤„ç†è¯·æ±‚ã€‚ æ·»åŠ ä¸€ä¸ªå•çº¿ç¨‹çš„è°ƒåº¦çº¿ç¨‹æ± ç”¨äºå®šæ—¶æ¸…ç†é‚£äº›è¿‡æœŸçš„ResponseFutureï¼Œæ¸…ç†æ–¹æ³•ä¸ºscanResponseFutureTable()ã€‚ ä¿®æ”¹åçš„ContractProxyFactoryå¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107@Slf4jpublic class ContractProxyFactory &#123; private static final RequestArgumentExtractor EXTRACTOR = new DefaultRequestArgumentExtractor(); private static final ConcurrentMap&lt;Class&lt;?&gt;, Object&gt; CACHE = Maps.newConcurrentMap(); static final ConcurrentMap&lt;String /* request id */, ResponseFuture&gt; RESPONSE_FUTURE_TABLE = Maps.newConcurrentMap(); // å®šä¹‰è¯·æ±‚çš„æœ€å¤§è¶…æ—¶æ—¶é—´ä¸º3ç§’ private static final long REQUEST_TIMEOUT_MS = 3000; private static final ExecutorService EXECUTOR; private static final ScheduledExecutorService CLIENT_HOUSE_KEEPER; private static final Serializer SERIALIZER = FastJsonSerializer.X; @SuppressWarnings(\"unchecked\") public static &lt;T&gt; T ofProxy(Class&lt;T&gt; interfaceKlass) &#123; // ç¼“å­˜å¥‘çº¦æ¥å£çš„ä»£ç†ç±»å®ä¾‹ return (T) CACHE.computeIfAbsent(interfaceKlass, x -&gt; Proxy.newProxyInstance(interfaceKlass.getClassLoader(), new Class[]&#123;interfaceKlass&#125;, (target, method, args) -&gt; &#123; RequestArgumentExtractInput input = new RequestArgumentExtractInput(); input.setInterfaceKlass(interfaceKlass); input.setMethod(method); RequestArgumentExtractOutput output = EXTRACTOR.extract(input); // å°è£…è¯·æ±‚å‚æ•° RequestMessagePacket packet = new RequestMessagePacket(); packet.setMagicNumber(ProtocolConstant.MAGIC_NUMBER); packet.setVersion(ProtocolConstant.VERSION); packet.setSerialNumber(SerialNumberUtils.X.generateSerialNumber()); packet.setMessageType(MessageType.REQUEST); packet.setInterfaceName(output.getInterfaceName()); packet.setMethodName(output.getMethodName()); packet.setMethodArgumentSignatures(output.getMethodArgumentSignatures().toArray(new String[0])); packet.setMethodArguments(args); Channel channel = ClientChannelHolder.CHANNEL_REFERENCE.get(); return sendRequestSync(channel, packet, method.getReturnType()); &#125;)); &#125; /** * åŒæ­¥å‘é€è¯·æ±‚ * * @param channel channel * @param packet packet * @return Object */ static Object sendRequestSync(Channel channel, RequestMessagePacket packet, Class&lt;?&gt; returnType) &#123; long beginTimestamp = System.currentTimeMillis(); ResponseFuture responseFuture = new ResponseFuture(packet.getSerialNumber(), REQUEST_TIMEOUT_MS); RESPONSE_FUTURE_TABLE.put(packet.getSerialNumber(), responseFuture); try &#123; // è·å–åˆ°æ‰¿è½½å“åº”Packetçš„Future Future&lt;ResponseMessagePacket&gt; packetFuture = EXECUTOR.submit(() -&gt; &#123; channel.writeAndFlush(packet).addListener((ChannelFutureListener) future -&gt; responseFuture.setSendRequestSucceed(true)); return responseFuture.waitResponse(REQUEST_TIMEOUT_MS - (System.currentTimeMillis() - beginTimestamp)); &#125;); ResponseMessagePacket responsePacket = packetFuture.get( REQUEST_TIMEOUT_MS - (System.currentTimeMillis() - beginTimestamp), TimeUnit.MILLISECONDS); if (null == responsePacket) &#123; // è¶…æ—¶å¯¼è‡´å“åº”åŒ…è·å–å¤±è´¥ throw new SendRequestException(String.format(\"ResponseMessagePacketè·å–è¶…æ—¶,è¯·æ±‚ID:%s\", packet.getSerialNumber())); &#125; else &#123; ByteBuf payload = (ByteBuf) responsePacket.getPayload(); byte[] bytes = ByteBufferUtils.X.readBytes(payload); return SERIALIZER.decode(bytes, returnType); &#125; &#125; catch (Exception e) &#123; log.error(\"åŒæ­¥å‘é€è¯·æ±‚å¼‚å¸¸,è¯·æ±‚åŒ…:&#123;&#125;\", JSON.toJSONString(packet), e); if (e instanceof RuntimeException) &#123; throw (RuntimeException) e; &#125; else &#123; throw new SendRequestException(e); &#125; &#125; &#125; static void scanResponseFutureTable() &#123; log.info(\"å¼€å§‹æ‰§è¡ŒResponseFutureTableæ¸…ç†ä»»åŠ¡......\"); Iterator&lt;Map.Entry&lt;String, ResponseFuture&gt;&gt; iterator = RESPONSE_FUTURE_TABLE.entrySet().iterator(); while (iterator.hasNext()) &#123; Map.Entry&lt;String, ResponseFuture&gt; entry = iterator.next(); ResponseFuture responseFuture = entry.getValue(); if (responseFuture.timeout()) &#123; iterator.remove(); log.warn(\"ç§»é™¤è¿‡æœŸçš„è¯·æ±‚ResponseFuture,è¯·æ±‚ID:&#123;&#125;\", entry.getKey()); &#125; &#125; log.info(\"æ‰§è¡ŒResponseFutureTableæ¸…ç†ä»»åŠ¡ç»“æŸ......\"); &#125; static &#123; int n = Runtime.getRuntime().availableProcessors(); EXECUTOR = new ThreadPoolExecutor(n * 2, n * 2, 0, TimeUnit.SECONDS, new ArrayBlockingQueue&lt;&gt;(50), runnable -&gt; &#123; Thread thread = new Thread(runnable); thread.setDaemon(true); thread.setName(\"CLIENT_REQUEST_EXECUTOR\"); return thread; &#125;); CLIENT_HOUSE_KEEPER = new ScheduledThreadPoolExecutor(1, runnable -&gt; &#123; Thread thread = new Thread(runnable); thread.setDaemon(true); thread.setName(\"CLIENT_HOUSE_KEEPER\"); return thread; &#125;); CLIENT_HOUSE_KEEPER.scheduleWithFixedDelay(ContractProxyFactory::scanResponseFutureTable, 5, 5, TimeUnit.SECONDS); &#125;&#125; æ¥ç€æ·»åŠ ä¸€ä¸ªå®¢æˆ·ç«¯å…¥ç«™å¤„ç†å™¨ï¼Œç”¨äºé€šè¿‡reuqestIdåŒ¹é…ç›®æ ‡ResponseFutureå®ä¾‹ï¼ŒåŒæ—¶è®¾ç½®ResponseFutureå®ä¾‹ä¸­çš„responseå±æ€§ä¸ºå“åº”åŒ…ï¼ŒåŒæ—¶é‡Šæ”¾é—­é”ï¼š 1234567891011121314@Slf4jpublic class ClientHandler extends SimpleChannelInboundHandler&lt;ResponseMessagePacket&gt; &#123; @Override protected void channelRead0(ChannelHandlerContext ctx, ResponseMessagePacket packet) throws Exception &#123; log.info(\"æ¥æ”¶åˆ°å“åº”åŒ…,å†…å®¹:&#123;&#125;\", JSON.toJSONString(packet)); ResponseFuture responseFuture = ContractProxyFactory.RESPONSE_FUTURE_TABLE.get(packet.getSerialNumber()); if (null != responseFuture) &#123; responseFuture.putResponse(packet); &#125; else &#123; log.warn(\"æ¥æ”¶å“åº”åŒ…æŸ¥è¯¢ResponseFutureä¸å­˜åœ¨,è¯·æ±‚ID:&#123;&#125;\", packet.getSerialNumber()); &#125; &#125;&#125; æœ€åï¼Œå®¢æˆ·ç«¯å¯åŠ¨ç±»ClientApplicationä¸­æ·»åŠ ClientHandleråˆ°Nettyçš„å¤„ç†å™¨æµæ°´çº¿ä¸­å³å¯ï¼š 123456789101112bootstrap.handler(new ChannelInitializer&lt;SocketChannel&gt;() &#123; @Override protected void initChannel(SocketChannel ch) throws Exception &#123; ch.pipeline().addLast(new LengthFieldBasedFrameDecoder(1024, 0, 4, 0, 4)); ch.pipeline().addLast(new LengthFieldPrepender(4)); ch.pipeline().addLast(new LoggingHandler(LogLevel.DEBUG)); ch.pipeline().addLast(new RequestMessagePacketEncoder(FastJsonSerializer.X)); ch.pipeline().addLast(new ResponseMessagePacketDecoder()); ch.pipeline().addLast(new ClientHandler()); &#125;&#125;); å…ˆè¿è¡Œä¹‹å‰- ã€ŠåŸºäºNettyå’ŒSpringBootå®ç°ä¸€ä¸ªè½»é‡çº§RPCæ¡†æ¶-Serverç¯‡ã€‹ä¸­ç¼–å†™å¥½çš„ServerApplicationï¼Œå†å¯åŠ¨ClientApplicationï¼Œæ—¥å¿—è¾“å‡ºå¦‚ä¸‹ï¼š 12345678910// æœåŠ¡ç«¯2020-01-18 14:32:59 [nioEventLoopGroup-3-2] INFO club.throwable.server.ServerHandler - æœåŠ¡ç«¯æ¥æ”¶åˆ°:RequestMessagePacket(interfaceName=club.throwable.contract.HelloService, methodName=sayHello, methodArgumentSignatures=[java.lang.String], methodArguments=[PooledUnsafeDirectByteBuf(ridx: 0, widx: 11, cap: 11/144)])2020-01-18 14:32:59 [nioEventLoopGroup-3-2] INFO club.throwable.server.ServerHandler - æŸ¥æ‰¾ç›®æ ‡å®ç°æ–¹æ³•æˆåŠŸ,ç›®æ ‡ç±»:club.throwable.server.contract.DefaultHelloService,å®¿ä¸»ç±»:club.throwable.server.contract.DefaultHelloService,å®¿ä¸»æ–¹æ³•:sayHello2020-01-18 14:32:59 [nioEventLoopGroup-3-2] INFO club.throwable.server.ServerHandler - æœåŠ¡ç«¯è¾“å‡º:&#123;\"attachments\":&#123;&#125;,\"errorCode\":200,\"magicNumber\":10086,\"message\":\"Success\",\"messageType\":\"RESPONSE\",\"payload\":\"\\\"throwable say hello!\\\"\",\"serialNumber\":\"21d131d26fc74f91b4691e0207826b90\",\"version\":1&#125;// å®¢æˆ·ç«¯2020-01-18 14:32:59 [nioEventLoopGroup-2-1] INFO club.throwable.client.ClientHandler - æ¥æ”¶åˆ°å“åº”åŒ…,å†…å®¹:&#123;\"attachments\":&#123;&#125;,\"errorCode\":200,\"magicNumber\":10086,\"message\":\"Success\",\"messageType\":\"RESPONSE\",\"payload\":&#123;\"contiguous\":true,\"direct\":true,\"readOnly\":false,\"readable\":true,\"writable\":false&#125;,\"serialNumber\":\"21d131d26fc74f91b4691e0207826b90\",\"version\":1&#125;2020-01-18 14:32:59 [main] INFO c.throwable.client.ClientApplication - HelloService[throwable]è°ƒç”¨ç»“æœ:\"throwable say hello!\"2020-01-18 14:33:04 [CLIENT_HOUSE_KEEPER] INFO c.t.client.ContractProxyFactory - å¼€å§‹æ‰§è¡ŒResponseFutureTableæ¸…ç†ä»»åŠ¡......2020-01-18 14:33:04 [CLIENT_HOUSE_KEEPER] WARN c.t.client.ContractProxyFactory - ç§»é™¤è¿‡æœŸçš„è¯·æ±‚ResponseFuture,è¯·æ±‚ID:21d131d26fc74f91b4691e0207826b90 å¯è§å¼‚æ­¥çº¿ç¨‹æ¨¡å‹å·²ç»è¢«æ”¹é€ ä¸ºåŒæ­¥åŒ–ï¼Œç°åœ¨å¯ä»¥é€šè¿‡å¥‘çº¦æ¥å£é€šè¿‡RPCåŒæ­¥è°ƒç”¨æœåŠ¡ç«¯ã€‚ å°ç»“ Clientç«¯çš„è¯·æ±‚-å“åº”åŒæ­¥åŒ–å¤„ç†åŸºæœ¬æ”¹é€ å®Œæ¯•ï¼Œåˆ°æ­¤ä¸ºæ­¢ï¼Œä¸€ä¸ªRPCæ¡†æ¶å¤§è‡´å·²ç»å®Œæˆï¼Œæ¥ä¸‹æ¥ä¼šå¯¹Clientç«¯å’ŒServerç«¯è¿›è¡Œä¸€äº›æ”¹é€ ï¼Œè®©å¥‘çº¦ç›¸å…³ç»„ä»¶æ‰˜ç®¡åˆ°IOCå®¹å™¨ï¼Œå®ç°å¥‘çº¦æ¥å£è‡ªåŠ¨æ³¨å…¥ç­‰ç­‰åŠŸèƒ½ã€‚ Demoé¡¹ç›®åœ°å€ï¼š ch0-custom-rpc-protocol ï¼ˆæœ¬æ–‡å®Œe-a-20200118 c-2-dï¼‰","categories":[{"name":"Netty","slug":"Netty","permalink":"http://throwable.club/blog/categories/Netty/"},{"name":"Java","slug":"Netty/Java","permalink":"http://throwable.club/blog/categories/Netty/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/tags/Java/"},{"name":"Netty","slug":"Netty","permalink":"http://throwable.club/blog/tags/Netty/"}]},{"title":"åŸºäºNettyå’ŒSpringBootå®ç°ä¸€ä¸ªè½»é‡çº§RPCæ¡†æ¶-Clientç¯‡","slug":"netty-custom-rpc-framework-client","date":"2020-01-16T14:56:51.000Z","updated":"2020-01-16T14:57:36.225Z","comments":true,"path":"2020/01/16/netty-custom-rpc-framework-client/","link":"","permalink":"http://throwable.club/2020/01/16/netty-custom-rpc-framework-client/","excerpt":"å‰æ å‰ç½®æ–‡ç« ï¼š ã€ŠåŸºäºNettyå’ŒSpringBootå®ç°ä¸€ä¸ªè½»é‡çº§RPCæ¡†æ¶-åè®®ç¯‡ã€‹ ã€ŠåŸºäºNettyå’ŒSpringBootå®ç°ä¸€ä¸ªè½»é‡çº§RPCæ¡†æ¶-Serverç¯‡ã€‹ å‰ä¸€ç¯‡æ–‡ç« ç›¸å¯¹ç®€ç•¥åœ°ä»‹ç»äº†RPCæœåŠ¡ç«¯çš„ç¼–å†™ï¼Œè€Œè¿™ç¯‡åšæ–‡æœ€è¦ä»‹ç»æœåŠ¡ç«¯ï¼ˆClientï¼‰çš„å®ç°ã€‚RPCè°ƒç”¨ä¸€èˆ¬æ˜¯é¢å‘å¥‘çº¦ç¼–ç¨‹çš„ï¼Œè€ŒClientçš„æ ¸å¿ƒåŠŸèƒ½å°±æ˜¯ï¼šæŠŠå¥‘çº¦æ¥å£æ–¹æ³•çš„è°ƒç”¨æŠ½è±¡ä¸ºä½¿ç”¨Nettyå‘RPCæœåŠ¡ç«¯é€šè¿‡ç§æœ‰åè®®å‘é€ä¸€ä¸ªè¯·æ±‚ã€‚è¿™é‡Œæœ€åº•å±‚çš„å®ç°ä¾èµ–äºåŠ¨æ€ä»£ç†ï¼Œå› æ­¤åŠ¨æ€ä»£ç†æ˜¯åŠ¨æ€å®ç°æ¥å£çš„æœ€ç®€å•æ–¹å¼ï¼ˆå¦‚æœå­—èŠ‚ç ç ”ç©¶å¾—æ¯”è¾ƒæ·±å…¥ï¼Œå¯ä»¥é€šè¿‡å­—èŠ‚ç ç¼–ç¨‹å®ç°æ¥å£ï¼‰ã€‚éœ€è¦çš„ä¾èµ–å¦‚ä¸‹ï¼š JDK1.8+ Netty:4.1.44.Final SpringBoot:2.2.2.RELEASE","text":"å‰æ å‰ç½®æ–‡ç« ï¼š ã€ŠåŸºäºNettyå’ŒSpringBootå®ç°ä¸€ä¸ªè½»é‡çº§RPCæ¡†æ¶-åè®®ç¯‡ã€‹ ã€ŠåŸºäºNettyå’ŒSpringBootå®ç°ä¸€ä¸ªè½»é‡çº§RPCæ¡†æ¶-Serverç¯‡ã€‹ å‰ä¸€ç¯‡æ–‡ç« ç›¸å¯¹ç®€ç•¥åœ°ä»‹ç»äº†RPCæœåŠ¡ç«¯çš„ç¼–å†™ï¼Œè€Œè¿™ç¯‡åšæ–‡æœ€è¦ä»‹ç»æœåŠ¡ç«¯ï¼ˆClientï¼‰çš„å®ç°ã€‚RPCè°ƒç”¨ä¸€èˆ¬æ˜¯é¢å‘å¥‘çº¦ç¼–ç¨‹çš„ï¼Œè€ŒClientçš„æ ¸å¿ƒåŠŸèƒ½å°±æ˜¯ï¼šæŠŠå¥‘çº¦æ¥å£æ–¹æ³•çš„è°ƒç”¨æŠ½è±¡ä¸ºä½¿ç”¨Nettyå‘RPCæœåŠ¡ç«¯é€šè¿‡ç§æœ‰åè®®å‘é€ä¸€ä¸ªè¯·æ±‚ã€‚è¿™é‡Œæœ€åº•å±‚çš„å®ç°ä¾èµ–äºåŠ¨æ€ä»£ç†ï¼Œå› æ­¤åŠ¨æ€ä»£ç†æ˜¯åŠ¨æ€å®ç°æ¥å£çš„æœ€ç®€å•æ–¹å¼ï¼ˆå¦‚æœå­—èŠ‚ç ç ”ç©¶å¾—æ¯”è¾ƒæ·±å…¥ï¼Œå¯ä»¥é€šè¿‡å­—èŠ‚ç ç¼–ç¨‹å®ç°æ¥å£ï¼‰ã€‚éœ€è¦çš„ä¾èµ–å¦‚ä¸‹ï¼š JDK1.8+ Netty:4.1.44.Final SpringBoot:2.2.2.RELEASE åŠ¨æ€ä»£ç†çš„ç®€å•ä½¿ç”¨ ä¸€èˆ¬å¯ä»¥é€šè¿‡JDKåŠ¨æ€ä»£ç†æˆ–è€…Cglibçš„å­—èŠ‚ç å¢å¼ºæ¥å®ç°æ­¤åŠŸèƒ½ï¼Œä¸ºäº†ç®€å•èµ·è§ï¼Œä¸å¼•å…¥é¢å¤–çš„ä¾èµ–ï¼Œè¿™é‡Œé€‰ç”¨JDKåŠ¨æ€ä»£ç†ã€‚è¿™é‡Œé‡æ–°æ¬å‡ºå‰é¢æåˆ°çš„å¥‘çº¦æ¥å£HelloServiceï¼š 1234public interface HelloService &#123; String sayHello(String name);&#125; æ¥ä¸‹æ¥éœ€è¦é€šè¿‡åŠ¨æ€ä»£ç†ä¸ºæ­¤æ¥å£æ·»åŠ ä¸€ä¸ªå®ç°ï¼š 12345678910111213141516171819202122232425public class TestDynamicProxy &#123; public static void main(String[] args) throws Exception &#123; Class&lt;HelloService&gt; interfaceKlass = HelloService.class; InvocationHandler handler = new HelloServiceImpl(interfaceKlass); HelloService helloService = (HelloService) Proxy.newProxyInstance(interfaceKlass.getClassLoader(), new Class[]&#123;interfaceKlass&#125;, handler); System.out.println(helloService.sayHello(\"throwable\")); &#125; @RequiredArgsConstructor private static class HelloServiceImpl implements InvocationHandler &#123; private final Class&lt;?&gt; interfaceKlass; @Override public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123; // è¿™é‡Œåº”è¯¥æ ¹æ®æ–¹æ³•çš„è¿”å›å€¼ç±»å‹å»å†³å®šè¿”å›ç»“æœ return String.format(\"[%s#%s]æ–¹æ³•è¢«è°ƒç”¨,å‚æ•°åˆ—è¡¨:%s\", interfaceKlass.getName(), method.getName(), JSON.toJSONString(args)); &#125; &#125;&#125;// æ§åˆ¶å°è¾“å‡ºç»“æœ[club.throwable.contract.HelloService#sayHello]æ–¹æ³•è¢«è°ƒç”¨,å‚æ•°åˆ—è¡¨:[\"throwable\"] è¿™é‡Œå¯ä»¥ç¡®è®¤ä¸¤ç‚¹ï¼š InvocationHandlerå®ç°åä¼šå¯¹è¢«ä»£ç†æ¥å£ç”Ÿæˆä¸€ä¸ªåŠ¨æ€å®ç°ç±»ã€‚ åŠ¨æ€å®ç°ç±»ï¼ˆæ¥å£ï¼‰æ–¹æ³•è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œå®é™…ä¸Šæ˜¯è°ƒç”¨InvocationHandlerå¯¹åº”å®ä¾‹çš„invoke()æ–¹æ³•ï¼Œä¼ å…¥çš„å‚æ•°å°±æ˜¯å½“å‰æ–¹æ³•è°ƒç”¨çš„å…ƒæ•°æ®ã€‚ Clientç«¯ä»£ç å®ç° Clientç«¯éœ€è¦é€šè¿‡åŠ¨æ€ä»£ç†ä¸ºå¥‘çº¦æ¥å£ç”Ÿæˆä¸€ä¸ªåŠ¨æ€å®ç°ç±»ï¼Œç„¶åæå–å¥‘çº¦æ¥å£è°ƒç”¨æ–¹æ³•æ—¶å€™æ‰€èƒ½æä¾›çš„å…ƒæ•°æ®ï¼Œé€šè¿‡è¿™äº›å…ƒæ•°æ®å’ŒNettyå®¢æˆ·ç«¯çš„æ”¯æŒï¼ˆä¾‹å¦‚Nettyçš„Channelï¼‰åŸºäºç§æœ‰RPCåè®®ç»„è£…è¯·æ±‚ä¿¡æ¯å¹¶ä¸”å‘é€è¯·æ±‚ã€‚è¿™é‡Œå…ˆå®šä¹‰ä¸€ä¸ªè¯·æ±‚å‚æ•°æå–å™¨æ¥å£RequestArgumentExtractorï¼š 1234567891011121314151617181920212223@Datapublic class RequestArgumentExtractInput &#123; private Class&lt;?&gt; interfaceKlass; private Method method;&#125;@Datapublic class RequestArgumentExtractOutput &#123; private String interfaceName; private String methodName; private List&lt;String&gt; methodArgumentSignatures;&#125;// æ¥å£public interface RequestArgumentExtractor &#123; RequestArgumentExtractOutput extract(RequestArgumentExtractInput input);&#125; ç®€å•å®ç°ä¸€ä¸‹ï¼Œè§£æç»“æœæ·»åŠ åˆ°ç¼“å­˜ä¸­ï¼Œå®ç°ç±»DefaultRequestArgumentExtractorä»£ç å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748public class DefaultRequestArgumentExtractor implements RequestArgumentExtractor &#123; private final ConcurrentMap&lt;CacheKey, RequestArgumentExtractOutput&gt; cache = Maps.newConcurrentMap(); @Override public RequestArgumentExtractOutput extract(RequestArgumentExtractInput input) &#123; Class&lt;?&gt; interfaceKlass = input.getInterfaceKlass(); Method method = input.getMethod(); String methodName = method.getName(); Class&lt;?&gt;[] parameterTypes = method.getParameterTypes(); return cache.computeIfAbsent(new CacheKey(interfaceKlass.getName(), methodName, Lists.newArrayList(parameterTypes)), x -&gt; &#123; RequestArgumentExtractOutput output = new RequestArgumentExtractOutput(); output.setInterfaceName(interfaceKlass.getName()); List&lt;String&gt; methodArgumentSignatures = Lists.newArrayList(); for (Class&lt;?&gt; klass : parameterTypes) &#123; methodArgumentSignatures.add(klass.getName()); &#125; output.setMethodArgumentSignatures(methodArgumentSignatures); output.setMethodName(methodName); return output; &#125;); &#125; @RequiredArgsConstructor private static class CacheKey &#123; private final String interfaceName; private final String methodName; private final List&lt;Class&lt;?&gt;&gt; parameterTypes; @Override public boolean equals(Object o) &#123; if (this == o) return true; if (o == null || getClass() != o.getClass()) return false; CacheKey cacheKey = (CacheKey) o; return Objects.equals(interfaceName, cacheKey.interfaceName) &amp;&amp; Objects.equals(methodName, cacheKey.methodName) &amp;&amp; Objects.equals(parameterTypes, cacheKey.parameterTypes); &#125; @Override public int hashCode() &#123; return Objects.hash(interfaceName, methodName, parameterTypes); &#125; &#125;&#125; åœ¨ä¸è€ƒè™‘é‡è¿ã€æ–­è¿ç­‰æƒ…å†µä¸‹ï¼Œæ–°å¢ä¸€ä¸ªç±»ClientChannelHolderç”¨äºä¿å­˜Nettyå®¢æˆ·ç«¯çš„Channelå®ä¾‹ï¼š 1234public class ClientChannelHolder &#123; public static final AtomicReference&lt;Channel&gt; CHANNEL_REFERENCE = new AtomicReference&lt;&gt;();&#125; æ¥ç€æ–°å¢ä¸€ä¸ªå¥‘çº¦åŠ¨æ€ä»£ç†å·¥å‚ï¼ˆå·¥å…·ç±»ï¼‰ContractProxyFactoryï¼Œç”¨äºä¸ºå¥‘çº¦æ¥å£ç”Ÿæˆä»£ç†ç±»å®ä¾‹ï¼š 12345678910111213141516171819202122232425262728293031323334public class ContractProxyFactory &#123; private static final RequestArgumentExtractor EXTRACTOR = new DefaultRequestArgumentExtractor(); private static final ConcurrentMap&lt;Class&lt;?&gt;, Object&gt; CACHE = Maps.newConcurrentMap(); @SuppressWarnings(\"unchecked\") public static &lt;T&gt; T ofProxy(Class&lt;T&gt; interfaceKlass) &#123; // ç¼“å­˜å¥‘çº¦æ¥å£çš„ä»£ç†ç±»å®ä¾‹ return (T) CACHE.computeIfAbsent(interfaceKlass, x -&gt; Proxy.newProxyInstance(interfaceKlass.getClassLoader(), new Class[]&#123;interfaceKlass&#125;, (target, method, args) -&gt; &#123; RequestArgumentExtractInput input = new RequestArgumentExtractInput(); input.setInterfaceKlass(interfaceKlass); input.setMethod(method); RequestArgumentExtractOutput output = EXTRACTOR.extract(input); // å°è£…è¯·æ±‚å‚æ•° RequestMessagePacket packet = new RequestMessagePacket(); packet.setMagicNumber(ProtocolConstant.MAGIC_NUMBER); packet.setVersion(ProtocolConstant.VERSION); packet.setSerialNumber(SerialNumberUtils.X.generateSerialNumber()); packet.setMessageType(MessageType.REQUEST); packet.setInterfaceName(output.getInterfaceName()); packet.setMethodName(output.getMethodName()); packet.setMethodArgumentSignatures(output.getMethodArgumentSignatures().toArray(new String[0])); packet.setMethodArguments(args); Channel channel = ClientChannelHolder.CHANNEL_REFERENCE.get(); // å‘èµ·è¯·æ±‚ channel.writeAndFlush(packet); // è¿™é‡Œæ–¹æ³•è¿”å›å€¼éœ€è¦è¿›è¡ŒåŒæ­¥å¤„ç†,ç›¸å¯¹å¤æ‚,åé¢ä¸“é—¨å¼€ä¸€ç¯‡æ–‡ç« è®²è§£,æš‚æ—¶ç»Ÿä¸€è¿”å›å­—ç¬¦ä¸² // å¦‚æœå¥‘çº¦æ¥å£çš„è¿”å›å€¼ç±»å‹ä¸æ˜¯å­—ç¬¦ä¸²,è¿™é‡Œæ–¹æ³•è¿”å›åä¼šæŠ›å‡ºå¼‚å¸¸ return String.format(\"[%s#%s]è°ƒç”¨æˆåŠŸ,å‘é€äº†[%s]åˆ°NettyServer[%s]\", output.getInterfaceName(), output.getMethodName(), JSON.toJSONString(packet), channel.remoteAddress()); &#125;)); &#125;&#125; æœ€åç¼–å†™å®¢æˆ·ç«¯ClientApplicationçš„ä»£ç : 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152@Slf4jpublic class ClientApplication &#123; public static void main(String[] args) throws Exception &#123; int port = 9092; EventLoopGroup workerGroup = new NioEventLoopGroup(); Bootstrap bootstrap = new Bootstrap(); try &#123; bootstrap.group(workerGroup); bootstrap.channel(NioSocketChannel.class); bootstrap.option(ChannelOption.SO_KEEPALIVE, Boolean.TRUE); bootstrap.option(ChannelOption.TCP_NODELAY, Boolean.TRUE); bootstrap.handler(new ChannelInitializer&lt;SocketChannel&gt;() &#123; @Override protected void initChannel(SocketChannel ch) throws Exception &#123; ch.pipeline().addLast(new LengthFieldBasedFrameDecoder(1024, 0, 4, 0, 4)); ch.pipeline().addLast(new LengthFieldPrepender(4)); ch.pipeline().addLast(new LoggingHandler(LogLevel.DEBUG)); ch.pipeline().addLast(new RequestMessagePacketEncoder(FastJsonSerializer.X)); ch.pipeline().addLast(new ResponseMessagePacketDecoder()); ch.pipeline().addLast(new SimpleChannelInboundHandler&lt;ResponseMessagePacket&gt;() &#123; @Override protected void channelRead0(ChannelHandlerContext ctx, ResponseMessagePacket packet) throws Exception &#123; Object targetPayload = packet.getPayload(); if (targetPayload instanceof ByteBuf) &#123; ByteBuf byteBuf = (ByteBuf) targetPayload; int readableByteLength = byteBuf.readableBytes(); byte[] bytes = new byte[readableByteLength]; byteBuf.readBytes(bytes); targetPayload = FastJsonSerializer.X.decode(bytes, String.class); byteBuf.release(); &#125; packet.setPayload(targetPayload); log.info(\"æ¥æ”¶åˆ°æ¥è‡ªæœåŠ¡ç«¯çš„å“åº”æ¶ˆæ¯,æ¶ˆæ¯å†…å®¹:&#123;&#125;\", JSON.toJSONString(packet)); &#125; &#125;); &#125; &#125;); ChannelFuture future = bootstrap.connect(\"localhost\", port).sync(); // ä¿å­˜Channelå®ä¾‹,æš‚æ—¶ä¸è€ƒè™‘æ–­è¿é‡è¿ ClientChannelHolder.CHANNEL_REFERENCE.set(future.channel()); // æ„é€ å¥‘çº¦æ¥å£ä»£ç†ç±»å®ä¾‹ HelloService helloService = ContractProxyFactory.ofProxy(HelloService.class); String result = helloService.sayHello(\"throwable\"); log.info(result); future.channel().closeFuture().sync(); &#125; finally &#123; workerGroup.shutdownGracefully(); &#125; &#125;&#125; å…ˆå¯åŠ¨ã€ŠåŸºäºNettyå’ŒSpringBootå®ç°ä¸€ä¸ªè½»é‡çº§RPCæ¡†æ¶-Serverç¯‡ã€‹ä¸€æ–‡ä¸­çš„ServerApplicationï¼Œå†å¯åŠ¨ClientApplicationï¼Œæ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š 123456789// æœåŠ¡ç«¯æ—¥å¿—2020-01-16 22:34:51 [main] INFO c.throwable.server.ServerApplication - å¯åŠ¨NettyServer[9092]æˆåŠŸ...2020-01-16 22:36:35 [nioEventLoopGroup-3-1] INFO club.throwable.server.ServerHandler - æœåŠ¡ç«¯æ¥æ”¶åˆ°:RequestMessagePacket(interfaceName=club.throwable.contract.HelloService, methodName=sayHello, methodArgumentSignatures=[java.lang.String], methodArguments=[PooledUnsafeDirectByteBuf(ridx: 0, widx: 11, cap: 11/144)])2020-01-16 22:36:35 [nioEventLoopGroup-3-1] INFO club.throwable.server.ServerHandler - æŸ¥æ‰¾ç›®æ ‡å®ç°æ–¹æ³•æˆåŠŸ,ç›®æ ‡ç±»:club.throwable.server.contract.DefaultHelloService,å®¿ä¸»ç±»:club.throwable.server.contract.DefaultHelloService,å®¿ä¸»æ–¹æ³•:sayHello2020-01-16 22:36:35 [nioEventLoopGroup-3-1] INFO club.throwable.server.ServerHandler - æœåŠ¡ç«¯è¾“å‡º:&#123;\"attachments\":&#123;&#125;,\"errorCode\":200,\"magicNumber\":10086,\"message\":\"Success\",\"messageType\":\"RESPONSE\",\"payload\":\"\\\"throwable say hello!\\\"\",\"serialNumber\":\"63d386214d30410c9e5f04de03d8b2da\",\"version\":1&#125;// å®¢æˆ·ç«¯æ—¥å¿—2020-01-16 22:36:35 [main] INFO c.throwable.client.ClientApplication - [club.throwable.contract.HelloService#sayHello]è°ƒç”¨æˆåŠŸ,å‘é€äº†[&#123;\"attachments\":&#123;&#125;,\"interfaceName\":\"club.throwable.contract.HelloService\",\"magicNumber\":10086,\"messageType\":\"REQUEST\",\"methodArgumentSignatures\":[\"java.lang.String\"],\"methodArguments\":[\"throwable\"],\"methodName\":\"sayHello\",\"serialNumber\":\"63d386214d30410c9e5f04de03d8b2da\",\"version\":1&#125;]åˆ°NettyServer[localhost/127.0.0.1:9092]2020-01-16 22:36:35 [nioEventLoopGroup-2-1] INFO c.throwable.client.ClientApplication - æ¥æ”¶åˆ°æ¥è‡ªæœåŠ¡ç«¯çš„å“åº”æ¶ˆæ¯,æ¶ˆæ¯å†…å®¹:&#123;\"attachments\":&#123;&#125;,\"errorCode\":200,\"magicNumber\":10086,\"message\":\"Success\",\"messageType\":\"RESPONSE\",\"payload\":\"\\\"throwable say hello!\\\"\",\"serialNumber\":\"63d386214d30410c9e5f04de03d8b2da\",\"version\":1&#125; å°ç»“ Clientç«¯ä¸»è¦è´Ÿè´£å¥‘çº¦æ¥å£è°ƒç”¨è½¬æ¢ä¸ºå‘é€RPCåè®®è¯·æ±‚è¿™ä¸€æ­¥ï¼Œæ ¸å¿ƒæŠ€æœ¯å°±æ˜¯åŠ¨æ€ä»£ç†ï¼Œåœ¨ä¸è¿›è¡Œæ¨¡å—å°è£…ä¼˜åŒ–çš„å‰æä¸‹å®ç°æ˜¯ç›¸å¯¹ç®€å•çš„ã€‚è¿™é‡Œå…¶å®Clientç«¯è¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒå¤§çš„æŠ€æœ¯éš¾é¢˜æ²¡æœ‰è§£å†³ï¼Œä¸Šé¢ä¾‹å­ä¸­å®¢æˆ·ç«¯æ—¥å¿—è¾“å‡ºå¦‚æœçœ¼å°–çš„ä¼™ä¼´ä¼šå‘ç°ï¼ŒClientç«¯å‘é€RPCè¯·æ±‚çš„çº¿ç¨‹ï¼ˆmainçº¿ç¨‹ï¼‰å’ŒClientç«¯æ¥æ”¶Serverç«¯RPCå“åº”å¤„ç†çš„çº¿ç¨‹ï¼ˆnioEventLoopGroup-2-1çº¿ç¨‹ï¼‰å¹¶ä¸ç›¸åŒï¼Œè¿™ä¸€ç‚¹æ˜¯Nettyå¤„ç†ç½‘ç»œè¯·æ±‚ä¹‹æ‰€ä»¥èƒ½å¤Ÿå¦‚æ­¤é«˜æ•ˆçš„æ ¹æºï¼ˆç®€å•æ¥è¯´å°±æ˜¯è¯·æ±‚å’Œå“åº”æ˜¯å¼‚æ­¥çš„ï¼Œä¸¤ä¸ªæµç¨‹æœ¬æ¥æ˜¯äº’ä¸æ„ŸçŸ¥çš„ï¼‰ã€‚ä½†æ˜¯æ›´å¤šæƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¸Œæœ›å¤–éƒ¨è¯·æ±‚æ˜¯åŒæ­¥çš„ï¼Œå¸Œæœ›å‘é€RPCè¯·æ±‚çš„çº¿ç¨‹å¾—åˆ°å“åº”ç»“æœå†è¿”å›ï¼ˆè¿™é‡Œè¯·æ±‚å’Œå“åº”æœ‰å¯èƒ½ä¾ç„¶æ˜¯å¼‚æ­¥æµç¨‹ï¼‰ã€‚ä¸‹ä¸€ç¯‡æ–‡ç« ä¼šè¯¦ç»†åˆ†æä¸€ä¸‹å¦‚æœå¯¹è¯·æ±‚-å“åº”åšåŒæ­¥åŒ–å¤„ç†ã€‚ Demoé¡¹ç›®åœ°å€ï¼š ch0-custom-rpc-protocol ï¼ˆc-2-d e-a-20200116ï¼‰","categories":[{"name":"Netty","slug":"Netty","permalink":"http://throwable.club/blog/categories/Netty/"},{"name":"Java","slug":"Netty/Java","permalink":"http://throwable.club/blog/categories/Netty/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/tags/Java/"},{"name":"Netty","slug":"Netty","permalink":"http://throwable.club/blog/tags/Netty/"}]},{"title":"åŸºäºNettyå’ŒSpringBootå®ç°ä¸€ä¸ªè½»é‡çº§RPCæ¡†æ¶-Serverç¯‡","slug":"netty-custom-rpc-framework-server","date":"2020-01-14T16:13:38.000Z","updated":"2020-01-15T13:27:37.832Z","comments":true,"path":"2020/01/15/netty-custom-rpc-framework-server/","link":"","permalink":"http://throwable.club/2020/01/15/netty-custom-rpc-framework-server/","excerpt":"å‰æ å‰ç½®æ–‡ç« ï¼š Github Pageï¼šã€ŠåŸºäºNettyå’ŒSpringBootå®ç°ä¸€ä¸ªè½»é‡çº§RPCæ¡†æ¶-åè®®ç¯‡ã€‹ Coding Pageï¼šã€ŠåŸºäºNettyå’ŒSpringBootå®ç°ä¸€ä¸ªè½»é‡çº§RPCæ¡†æ¶-åè®®ç¯‡ã€‹ åœ¨å‰ç½®çš„ã€ŠåŸºäºNettyå’ŒSpringBootå®ç°ä¸€ä¸ªè½»é‡çº§RPCæ¡†æ¶-åè®®ç¯‡ã€‹ä¸€æ–‡ä¸­å·²ç»å®šä¹‰äº†ä¸€ä¸ªç›¸å¯¹ç®€å•çš„RPCç§æœ‰åè®®ï¼Œå¹¶ä¸”å®ç°äº†å¯¹åº”çš„ç¼–ç å’Œè§£ç æ¨¡å—ã€‚è¿™ç¯‡æ–‡ç« åŸºäºåè®®ç¯‡ï¼Œå®ŒæˆServerç«¯ä»£ç è°ƒç”¨çš„ç¼–å†™ã€‚è€ƒè™‘åˆ°ç›®å‰ç›¸å¯¹ä¸»æµçš„IOCå®¹å™¨æ˜¯Springï¼Œè¿™é‡Œé€‰ç”¨äº†spring-boot-starterï¼ˆéMVCå®¹å™¨ï¼Œåªæ˜¯å•çº¯ç®¡ç†Beanï¼‰ï¼Œä¾èµ–JDK1.8+ã€‚","text":"å‰æ å‰ç½®æ–‡ç« ï¼š Github Pageï¼šã€ŠåŸºäºNettyå’ŒSpringBootå®ç°ä¸€ä¸ªè½»é‡çº§RPCæ¡†æ¶-åè®®ç¯‡ã€‹ Coding Pageï¼šã€ŠåŸºäºNettyå’ŒSpringBootå®ç°ä¸€ä¸ªè½»é‡çº§RPCæ¡†æ¶-åè®®ç¯‡ã€‹ åœ¨å‰ç½®çš„ã€ŠåŸºäºNettyå’ŒSpringBootå®ç°ä¸€ä¸ªè½»é‡çº§RPCæ¡†æ¶-åè®®ç¯‡ã€‹ä¸€æ–‡ä¸­å·²ç»å®šä¹‰äº†ä¸€ä¸ªç›¸å¯¹ç®€å•çš„RPCç§æœ‰åè®®ï¼Œå¹¶ä¸”å®ç°äº†å¯¹åº”çš„ç¼–ç å’Œè§£ç æ¨¡å—ã€‚è¿™ç¯‡æ–‡ç« åŸºäºåè®®ç¯‡ï¼Œå®ŒæˆServerç«¯ä»£ç è°ƒç”¨çš„ç¼–å†™ã€‚è€ƒè™‘åˆ°ç›®å‰ç›¸å¯¹ä¸»æµçš„IOCå®¹å™¨æ˜¯Springï¼Œè¿™é‡Œé€‰ç”¨äº†spring-boot-starterï¼ˆéMVCå®¹å™¨ï¼Œåªæ˜¯å•çº¯ç®¡ç†Beanï¼‰ï¼Œä¾èµ–JDK1.8+ã€‚ æ€è·¯ é¦–å…ˆRPCç§æœ‰åè®®å®šä¹‰äº†Clientç«¯ä¼šä¼ è¿‡æ¥å››ä¸ªå’ŒæœåŠ¡è°ƒç”¨æ¯æ¯ç›¸å…³çš„å­—æ®µï¼šæ¥å£å…¨ç±»åinterfaceNameã€æ–¹æ³•åmethodNameã€æ–¹æ³•å‚æ•°ç­¾åå­—ç¬¦ä¸²æ•°ç»„methodArgumentSignaturesï¼ˆå¯é€‰ï¼Œè¿™ä¸ªå‚æ•°ä¸æ˜¯å¿…é¡»ä¼ å…¥çš„ï¼‰ä»¥åŠæ–¹æ³•å‚æ•°æ•°ç»„methodArgumentsï¼ˆå¯é€‰ï¼Œç©ºæ–¹æ³•åˆ—è¡¨çš„æ—¶å€™ä¸éœ€è¦ä¼ å…¥å‚æ•°ï¼‰ã€‚ä¸»è¦æµç¨‹å¦‚ä¸‹ï¼š æŠŠServerç«¯çš„æ‰€æœ‰æœåŠ¡ç«¯ï¼ˆå®ç°ï¼‰ç±»äº¤ç”±IOCå®¹å™¨æ‰˜ç®¡ã€‚ Clientç«¯å‘èµ·RPCè¯·æ±‚ã€‚ é€šè¿‡å‰é¢æåˆ°çš„æœ€å¤šå››ä¸ªå‚æ•°ï¼Œä»ServeræœåŠ¡å®ä¾‹çš„IOCå®¹å™¨ä¸­åŒ¹é…å‡ºå»åˆåº¦æœ€é«˜çš„ä¸€ä¸ªæ–¹æ³•java.lang.reflect.Methodå®ä¾‹ã€è¯¥æ–¹æ³•å®ä¾‹çš„å®¿ä¸»ç±»ä»¥åŠå®¿ä¸»ç±»å¯¹åº”çš„Beanå®ä¾‹ï¼Œå¦‚æœè¿™ä¸€æ­¥åŒ¹é…çš„ç›®æ ‡æ–¹æ³•è¶…è¿‡1ä¸ªæˆ–è€…ä¸º0ä¸ªï¼Œå¯ä»¥ç›´æ¥è¿”å›å¼‚å¸¸ä¿¡æ¯ã€‚ æŠŠå‰ä¸€æ­¥å¾—åˆ°çš„Methodå®ä¾‹ã€å®¿ä¸»ç±»Beanå®ä¾‹ï¼Œç»“åˆæ–¹æ³•å‚æ•°æ•°ç»„methodArgumentsè¿›è¡Œåå°„è°ƒç”¨ï¼Œå¾—åˆ°è°ƒç”¨ç»“æœã€‚ Serverç«¯æŠŠå“åº”ç»“æœå°è£…åˆ°payloadé€šè¿‡ç§æœ‰åè®®å‘é€å›Clientç«¯ã€‚ Serverç«¯ä»£ç å®ç° ä¸ºäº†æš‚æ—¶æ–¹ä¾¿èµ·è§ï¼Œéƒ¨åˆ†æ•°ç»„å…¥å‚è¢«é‡æ–°å°è£…ä¸ºArrayListï¼Œå®é™…ä¸Šç¼–å†™RPCæ¡†æ¶çš„æ—¶å€™åº”è¯¥ä¼˜å…ˆè€ƒè™‘æ€§èƒ½é—®é¢˜ï¼ŒåƒJDKæä¾›çš„é›†åˆç±»åº“ç­‰ç­‰åº”è¯¥å°½å¯èƒ½å°‘ç”¨ï¼ˆä»¥ArrayListä¸ºä¾‹ï¼Œæ‰©å®¹çš„æ—¶å€™å­˜åœ¨åº•å±‚Object[]æ‹·è´ï¼Œé€ æˆæ€§èƒ½æŸå¤±å’Œé¢å¤–çš„å†…å­˜æ¶ˆè€—ï¼‰ï¼Œæå°½å¯èƒ½ä½¿ç”¨åŸºæœ¬ç±»å‹å’Œæ•°ç»„ã€‚ å…ˆå®šä¹‰æ–¹æ³•åŒ¹é…å™¨MethodMatcherç›¸å…³çš„ç±»ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354public interface MethodMatcher &#123; /** * æŸ¥æ‰¾ä¸€ä¸ªåŒ¹é…åº¦æœ€é«˜çš„æ–¹æ³•ä¿¡æ¯ * * @param input input * @return output */ MethodMatchOutput selectOneBestMatchMethod(MethodMatchInput input);&#125;// è¾“å…¥å€¼@EqualsAndHashCode@Datapublic class MethodMatchInput &#123; private String interfaceName; private String methodName; private List&lt;String&gt; methodArgumentSignatures; private int methodArgumentArraySize;&#125;// è¾“å‡ºå€¼@Datapublic class MethodMatchOutput &#123; /** * ç›®æ ‡æ–¹æ³•å®ä¾‹ */ private Method targetMethod; /** * ç›®æ ‡å®ç°ç±» - è¿™ä¸ªæœ‰å¯èƒ½æ˜¯è¢«Cglibå¢å¼ºè¿‡çš„ç±»å‹,æ˜¯å®¿ä¸»ç±»çš„å­ç±»,å¦‚æœæ²¡æœ‰è¢«Cglibå¢å¼ºè¿‡,é‚£ä¹ˆå®ƒå°±æ˜¯å®¿ä¸»ç±» */ private Class&lt;?&gt; targetClass; /** * å®¿ä¸»ç±» */ private Class&lt;?&gt; targetUserClass; /** * å®¿ä¸»ç±»Beanå®ä¾‹ */ private Object target; /** * æ–¹æ³•å‚æ•°ç±»å‹åˆ—è¡¨ */ private List&lt;Class&lt;?&gt;&gt; parameterTypes;&#125; ç›®æ ‡æ–¹æ³•åŒ¹é…çš„é€»è¾‘å¤§è‡´å¦‚ä¸‹ï¼š æ–¹æ³•åç§°å’Œæ–¹æ³•å®ä¾‹çš„å®¿ä¸»ç±»å‹ä¸€å®šä½œä¸ºåŒ¹é…æ¡ä»¶çš„ä¸€éƒ¨åˆ†ã€‚ å¦‚æœä¼ å…¥äº†å‚æ•°ç­¾ååˆ—è¡¨ï¼Œä¼˜å…ˆä½¿ç”¨å‚æ•°ç­¾ååˆ—è¡¨ç±»å‹è¿›è¡ŒåŒ¹é…ã€‚ å¦‚æœæ²¡æœ‰ä¼ å…¥å‚æ•°ç­¾ååˆ—è¡¨ï¼Œé‚£ä¹ˆä½¿ç”¨å‚æ•°çš„æ•°é‡è¿›è¡ŒåŒ¹é…ã€‚ å¦‚æœå‚æ•°ç­¾ååˆ—è¡¨å’Œå‚æ•°åˆ—è¡¨éƒ½æ²¡æœ‰ä¼ å…¥ï¼Œé‚£ä¹ˆåªèƒ½é€šè¿‡æ–¹æ³•åç§°å’Œæ–¹æ³•å®ä¾‹çš„å®¿ä¸»ç±»å‹åŒ¹é…ã€‚ è€ƒè™‘åˆ°æ–¹æ³•åŒ¹é…è§£æçš„è¿‡ç¨‹ç›¸å¯¹è€—æ—¶ï¼Œéœ€è¦æŠŠç»“æœç¼“å­˜èµ·æ¥ã€‚ åˆ†æè‡³æ­¤ï¼Œå¯ä»¥åŸºäºåå°„ï¼Œç¼–å†™ä¸€ä¸ªæŠ½è±¡çš„æ–¹æ³•åŒ¹é…å™¨BaseMethodMatcherï¼Œç„¶åæŠŠè·å–å®¿ä¸»ç±»ä¿¡æ¯çš„åŠŸèƒ½å§”æ‰˜åˆ°å­ç±»ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596public class MethodMatchException extends RuntimeException &#123; public MethodMatchException(String message) &#123; super(message); &#125; public MethodMatchException(String message, Throwable cause) &#123; super(message, cause); &#125; public MethodMatchException(Throwable cause) &#123; super(cause); &#125;&#125;@Datapublic class HostClassMethodInfo &#123; private Class&lt;?&gt; hostClass; private Class&lt;?&gt; hostUserClass; private Object hostTarget;&#125;@Slf4jabstract class BaseMethodMatcher implements MethodMatcher &#123; private final ConcurrentMap&lt;MethodMatchInput, MethodMatchOutput&gt; cache = Maps.newConcurrentMap(); @Override public MethodMatchOutput selectOneBestMatchMethod(MethodMatchInput input) &#123; return cache.computeIfAbsent(input, in -&gt; &#123; try &#123; MethodMatchOutput output = new MethodMatchOutput(); Class&lt;?&gt; interfaceClass = Class.forName(in.getInterfaceName()); // è·å–å®¿ä¸»ç±»ä¿¡æ¯ HostClassMethodInfo info = findHostClassMethodInfo(interfaceClass); List&lt;Method&gt; targetMethods = Lists.newArrayList(); ReflectionUtils.doWithMethods(info.getHostUserClass(), targetMethods::add, method -&gt; &#123; String methodName = method.getName(); Class&lt;?&gt; declaringClass = method.getDeclaringClass(); List&lt;Class&lt;?&gt;&gt; inputParameterTypes = Optional.ofNullable(in.getMethodArgumentSignatures()) .map(mas -&gt; &#123; List&lt;Class&lt;?&gt;&gt; list = Lists.newArrayList(); mas.forEach(ma -&gt; list.add(ClassUtils.resolveClassName(ma, null))); return list; &#125;).orElse(Lists.newArrayList()); output.setParameterTypes(inputParameterTypes); // å¦‚æœä¼ å…¥äº†å‚æ•°ç­¾ååˆ—è¡¨ï¼Œä¼˜å…ˆä½¿ç”¨å‚æ•°ç­¾ååˆ—è¡¨ç±»å‹è¿›è¡ŒåŒ¹é… if (!inputParameterTypes.isEmpty()) &#123; List&lt;Class&lt;?&gt;&gt; parameterTypes = Lists.newArrayList(method.getParameterTypes()); return Objects.equals(methodName, in.getMethodName()) &amp;&amp; Objects.equals(info.getHostUserClass(), declaringClass) &amp;&amp; Objects.equals(parameterTypes, inputParameterTypes); &#125; // å¦‚æœæ²¡æœ‰ä¼ å…¥å‚æ•°ç­¾ååˆ—è¡¨ï¼Œé‚£ä¹ˆä½¿ç”¨å‚æ•°çš„æ•°é‡è¿›è¡ŒåŒ¹é… if (in.getMethodArgumentArraySize() &gt; 0) &#123; List&lt;Class&lt;?&gt;&gt; parameterTypes = Lists.newArrayList(method.getParameterTypes()); return Objects.equals(methodName, in.getMethodName()) &amp;&amp; Objects.equals(info.getHostUserClass(), declaringClass) &amp;&amp; in.getMethodArgumentArraySize() == parameterTypes.size(); &#125; // å¦‚æœå‚æ•°ç­¾ååˆ—è¡¨å’Œå‚æ•°åˆ—è¡¨éƒ½æ²¡æœ‰ä¼ å…¥ï¼Œé‚£ä¹ˆåªèƒ½é€šè¿‡æ–¹æ³•åç§°å’Œæ–¹æ³•å®ä¾‹çš„å®¿ä¸»ç±»å‹åŒ¹é… return Objects.equals(methodName, in.getMethodName()) &amp;&amp; Objects.equals(info.getHostUserClass(), declaringClass); &#125;); if (targetMethods.size() != 1) &#123; throw new MethodMatchException(String.format(\"æŸ¥æ‰¾åˆ°ç›®æ ‡æ–¹æ³•æ•°é‡ä¸ç­‰äº1,interface:%s,method:%s\", in.getInterfaceName(), in.getMethodName())); &#125; Method targetMethod = targetMethods.get(0); output.setTargetClass(info.getHostClass()); output.setTargetMethod(targetMethod); output.setTargetUserClass(info.getHostUserClass()); output.setTarget(info.getHostTarget()); return output; &#125; catch (Exception e) &#123; log.error(\"æŸ¥æ‰¾åŒ¹é…åº¦æœ€é«˜çš„æ–¹æ³•å¤±è´¥,è¾“å…¥å‚æ•°:&#123;&#125;\", JSON.toJSONString(in), e); if (e instanceof MethodMatchException) &#123; throw (MethodMatchException) e; &#125; else &#123; throw new MethodMatchException(e); &#125; &#125; &#125;); &#125; /** * è·å–å®¿ä¸»ç±»çš„ä¿¡æ¯ * * @param interfaceClass interfaceClass * @return HostClassMethodInfo */ abstract HostClassMethodInfo findHostClassMethodInfo(Class&lt;?&gt; interfaceClass);&#125; æ¥ç€ï¼Œé€šè¿‡æ¥å£ç±»å‹è·å–å®¿ä¸»ç±»çš„åŠŸèƒ½å°±å§”æ‰˜ç»™Springå®ç°ï¼Œä»IOCå®¹å™¨ä¸­è·å–ï¼Œå®šä¹‰SpringMethodMatcherï¼š 123456789101112131415161718192021@Componentpublic class SpringMethodMatcher extends BaseMethodMatcher implements BeanFactoryAware &#123; private DefaultListableBeanFactory beanFactory; @Override public void setBeanFactory(@NonNull BeanFactory beanFactory) throws BeansException &#123; this.beanFactory = (DefaultListableBeanFactory) beanFactory; &#125; @Override HostClassMethodInfo findHostClassMethodInfo(Class&lt;?&gt; interfaceClass) &#123; HostClassMethodInfo info = new HostClassMethodInfo(); // ä»å®¹å™¨ä¸­é€šè¿‡æ¥å£ç±»å‹è·å–å¯¹åº”çš„å®ç°,å®ç°å¿…é¡»åªæœ‰ä¸€ä¸ª Object bean = beanFactory.getBean(interfaceClass); info.setHostTarget(bean); info.setHostClass(bean.getClass()); info.setHostUserClass(ClassUtils.getUserClass(bean.getClass())); return info; &#125;&#125; è‡³æ­¤ï¼Œç›®æ ‡æ–¹æ³•åŒ¹é…çš„æ¨¡å—å·²ç»ç¼–å†™å®Œæ¯•ï¼Œæ¥ä¸‹æ¥éœ€è¦å¤„ç†æ–¹æ³•å‚æ•°åˆ—è¡¨çš„ååºåˆ—åŒ–ã€‚ç¼–å†™åè®®çš„æ—¶å€™ï¼Œç¬”è€…æŠŠæ–¹æ³•å‚æ•°åˆ—è¡¨methodArgumentså­˜æ”¾åœ¨Objectæ•°ç»„ä¸­ï¼Œä¼ è¾“çš„æ—¶å€™åºåˆ—åŒ–ä¸ºbyteæ•°ç»„ï¼Œç»è¿‡åè®®è§£æä¹‹åï¼Œæ–¹æ³•å‚æ•°åˆ—è¡¨çš„å®é™…ç±»å‹ä¸ºByteBufæ•°ç»„ï¼ˆè¿™æ˜¯å› ä¸ºNettyä¸­çš„å­—èŠ‚å®¹å™¨å°±æ˜¯ByteBufï¼‰ï¼Œé‚£ä¹ˆéœ€è¦è€ƒè™‘æŠŠByteBufæ•°ç»„è½¬æ¢ä¸ºç›®æ ‡æ–¹æ³•çš„å‚æ•°ç±»å‹å®ä¾‹ã€‚ä¸»è¦æ­¥éª¤å¦‚ä¸‹ï¼š å¦‚æœæ–¹æ³•å‚æ•°åˆ—è¡¨ä¸ºç©ºï¼Œé‚£ä¹ˆä»€ä¹ˆéƒ½ä¸ç”¨åšï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨äº†æ— å‚æ•°çš„æ–¹æ³•ã€‚ å¦‚æœæ–¹æ³•å‚æ•°åˆ—è¡¨ä¸ä¸ºç©ºåŒæ—¶æ–¹æ³•å‚æ•°ç±»å‹åˆ—è¡¨ä¸ä¸ºç©ºï¼Œä¼˜å…ˆé€‰ç”¨æ–¹æ³•å‚æ•°ç±»å‹åˆ—è¡¨è¿›è¡Œè½¬æ¢ã€‚ å¦‚æœæ–¹æ³•å‚æ•°åˆ—è¡¨ä¸ä¸ºç©ºåŒæ—¶æ–¹æ³•å‚æ•°ç±»å‹åˆ—è¡¨ä¸ºç©ºï¼Œåˆ™ä½¿ç”¨Method#getParameterTypes()å¾—åˆ°çš„æ–¹æ³•å‚æ•°åˆ—è¡¨ç±»å‹è¿›è¡Œè½¬æ¢ã€‚ å®šä¹‰ä¸€ä¸ªæ–¹æ³•å‚æ•°è½¬æ¢å™¨æ¥å£MethodArgumentConverterï¼š 123456789101112131415161718192021222324252627282930public interface MethodArgumentConverter &#123; ArgumentConvertOutput convert(ArgumentConvertInput input);&#125;@Datapublic class ArgumentConvertInput &#123; /** * ç›®æ ‡æ–¹æ³• */ private Method method; /** * æ–¹æ³•å‚æ•°ç±»å‹åˆ—è¡¨ */ private List&lt;Class&lt;?&gt;&gt; parameterTypes; /** * æ–¹æ³•å‚æ•°åˆ—è¡¨ */ private List&lt;Object&gt; arguments;&#125;@Datapublic class ArgumentConvertOutput &#123; private Object[] arguments;&#125; æ–¹æ³•å‚æ•°è½¬æ¢å™¨çš„é»˜è®¤å®ç°å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647@Slf4j@Componentpublic class DefaultMethodArgumentConverter implements MethodArgumentConverter &#123; private final Serializer serializer = FastJsonSerializer.X; @Override public ArgumentConvertOutput convert(ArgumentConvertInput input) &#123; ArgumentConvertOutput output = new ArgumentConvertOutput(); try &#123; if (null == input.getArguments() || input.getArguments().isEmpty()) &#123; output.setArguments(new Object[0]); return output; &#125; List&lt;Class&lt;?&gt;&gt; inputParameterTypes = input.getParameterTypes(); int size = inputParameterTypes.size(); if (size &gt; 0) &#123; Object[] arguments = new Object[size]; for (int i = 0; i &lt; size; i++) &#123; ByteBuf byteBuf = (ByteBuf) input.getArguments().get(i); int readableBytes = byteBuf.readableBytes(); byte[] bytes = new byte[readableBytes]; byteBuf.readBytes(bytes); arguments[i] = serializer.decode(bytes, inputParameterTypes.get(i)); byteBuf.release(); &#125; output.setArguments(arguments); return output; &#125; Class&lt;?&gt;[] parameterTypes = input.getMethod().getParameterTypes(); int len = parameterTypes.length; Object[] arguments = new Object[len]; for (int i = 0; i &lt; len; i++) &#123; ByteBuf byteBuf = (ByteBuf) input.getArguments().get(i); int readableBytes = byteBuf.readableBytes(); byte[] bytes = new byte[readableBytes]; byteBuf.readBytes(bytes); arguments[i] = serializer.decode(bytes, parameterTypes[i]); byteBuf.release(); &#125; output.setArguments(arguments); return output; &#125; catch (Exception e) &#123; throw new ArgumentConvertException(e); &#125; &#125;&#125; æ‰€æœ‰å‰ç½®å·¥ä½œéƒ½å®Œæˆäº†ï¼Œç°åœ¨ç¼–å†™ä¸€ä¸ªServerç«¯çš„å…¥ç«™å¤„ç†å™¨ServerHandlerï¼Œæš‚æ—¶ä¸åšä»£ç é€»è¾‘ä¼˜åŒ–ï¼Œåªåšå®ç°ï¼ŒæŠŠåå°„è°ƒç”¨çš„æ¨¡å—ç›´æ¥åœ¨æ­¤ç±»ä¸­ç¼–å†™ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748@Component@Slf4jpublic class ServerHandler extends SimpleChannelInboundHandler&lt;RequestMessagePacket&gt; &#123; @Autowired private MethodMatcher methodMatcher; @Autowired private MethodArgumentConverter methodArgumentConverter; @Override protected void channelRead0(ChannelHandlerContext ctx, RequestMessagePacket packet) throws Exception &#123; log.info(\"æœåŠ¡ç«¯æ¥æ”¶åˆ°:&#123;&#125;\", packet); MethodMatchInput input = new MethodMatchInput(); input.setInterfaceName(packet.getInterfaceName()); input.setMethodArgumentSignatures(Optional.ofNullable(packet.getMethodArgumentSignatures()) .map(Lists::newArrayList).orElse(Lists.newArrayList())); input.setMethodName(packet.getMethodName()); Object[] methodArguments = packet.getMethodArguments(); input.setMethodArgumentArraySize(null != methodArguments ? methodArguments.length : 0); MethodMatchOutput output = methodMatcher.selectOneBestMatchMethod(input); log.info(\"æŸ¥æ‰¾ç›®æ ‡å®ç°æ–¹æ³•æˆåŠŸ,ç›®æ ‡ç±»:&#123;&#125;,å®¿ä¸»ç±»:&#123;&#125;,å®¿ä¸»æ–¹æ³•:&#123;&#125;\", output.getTargetClass().getCanonicalName(), output.getTargetUserClass().getCanonicalName(), output.getTargetMethod().getName() ); Method targetMethod = output.getTargetMethod(); ArgumentConvertInput convertInput = new ArgumentConvertInput(); convertInput.setArguments(input.getMethodArgumentArraySize() &gt; 0 ? Lists.newArrayList(methodArguments) : Lists.newArrayList()); convertInput.setMethod(output.getTargetMethod()); convertInput.setParameterTypes(output.getParameterTypes()); ArgumentConvertOutput convertOutput = methodArgumentConverter.convert(convertInput); ReflectionUtils.makeAccessible(targetMethod); // åå°„è°ƒç”¨ Object result = targetMethod.invoke(output.getTarget(), convertOutput.getArguments()); ResponseMessagePacket response = new ResponseMessagePacket(); response.setMagicNumber(packet.getMagicNumber()); response.setVersion(packet.getVersion()); response.setSerialNumber(packet.getSerialNumber()); response.setAttachments(packet.getAttachments()); response.setMessageType(MessageType.RESPONSE); response.setErrorCode(200L); response.setMessage(\"Success\"); response.setPayload(JSON.toJSONString(result)); log.info(\"æœåŠ¡ç«¯è¾“å‡º:&#123;&#125;\", JSON.toJSONString(response)); ctx.writeAndFlush(response); &#125;&#125; ç¼–å†™ä¸€ä¸ªServerçš„å¯åŠ¨ç±»ServerApplicationï¼Œåœ¨Springå®¹å™¨å¯åŠ¨ä¹‹åï¼Œå¯åŠ¨NettyæœåŠ¡ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243@SpringBootApplication(scanBasePackages = \"club.throwable.server\")@Slf4jpublic class ServerApplication implements CommandLineRunner &#123; @Value(\"$&#123;netty.port:9092&#125;\") private Integer nettyPort; @Autowired private ServerHandler serverHandler; public static void main(String[] args) throws Exception &#123; SpringApplication.run(ServerApplication.class, args); &#125; @Override public void run(String... args) throws Exception &#123; int port = nettyPort; ServerBootstrap bootstrap = new ServerBootstrap(); EventLoopGroup bossGroup = new NioEventLoopGroup(); EventLoopGroup workerGroup = new NioEventLoopGroup(); try &#123; bootstrap.group(bossGroup, workerGroup) .channel(NioServerSocketChannel.class) .childHandler(new ChannelInitializer&lt;SocketChannel&gt;() &#123; @Override protected void initChannel(SocketChannel ch) throws Exception &#123; ch.pipeline().addLast(new LengthFieldBasedFrameDecoder(1024, 0, 4, 0, 4)); ch.pipeline().addLast(new LengthFieldPrepender(4)); ch.pipeline().addLast(new RequestMessagePacketDecoder()); ch.pipeline().addLast(new ResponseMessagePacketEncoder(FastJsonSerializer.X)); ch.pipeline().addLast(serverHandler); &#125; &#125;); ChannelFuture future = bootstrap.bind(port).sync(); log.info(\"å¯åŠ¨NettyServer[&#123;&#125;]æˆåŠŸ...\", port); future.channel().closeFuture().sync(); &#125; finally &#123; workerGroup.shutdownGracefully(); bossGroup.shutdownGracefully(); &#125; &#125;&#125; æœ€åï¼Œç¼–å†™å¥‘çº¦åŒ…å’Œå¥‘çº¦å®ç°ï¼š 12345678910- ch0-custom-rpc-protocol é¡¹ç›®æ ¹ç›®å½• - club.throwable - utils å·¥å…·ç±» - protocol åè®® - exception å¼‚å¸¸ - contract å¥‘çº¦ - HelloService å¥‘çº¦æ¥å£ - server æœåŠ¡ç«¯ - contract - DefaultHelloService å¥‘çº¦æ¥å£å®ç° 1234567891011121314public interface HelloService &#123; String sayHello(String name);&#125;// å®ç°@Servicepublic class DefaultHelloService implements HelloService &#123; @Override public String sayHello(String name) &#123; return String.format(\"%s say hello!\", name); &#125;&#125; å…ˆå¯åŠ¨æœåŠ¡ç«¯ServerApplicationï¼Œå†å¯åŠ¨ä¸Šä¸€èŠ‚æåˆ°çš„TestProtocolClientï¼Œè¾“å‡ºç»“æœï¼š 12345678910// æœåŠ¡ç«¯æ—¥å¿—2020-01-15 00:05:57.898 INFO 14420 --- [ main] club.throwable.server.ServerApplication : å¯åŠ¨NettyServer[9092]æˆåŠŸ...2020-01-15 00:06:05.980 INFO 14420 --- [ntLoopGroup-3-1] club.throwable.server.ServerHandler : æœåŠ¡ç«¯æ¥æ”¶åˆ°:RequestMessagePacket(interfaceName=club.throwable.contract.HelloService, methodName=sayHello, methodArgumentSignatures=[java.lang.String], methodArguments=[PooledUnsafeDirectByteBuf(ridx: 0, widx: 6, cap: 6/139)])2020-01-15 00:06:07.448 INFO 14420 --- [ntLoopGroup-3-1] club.throwable.server.ServerHandler : æŸ¥æ‰¾ç›®æ ‡å®ç°æ–¹æ³•æˆåŠŸ,ç›®æ ‡ç±»:club.throwable.server.contract.DefaultHelloService,å®¿ä¸»ç±»:club.throwable.server.contract.DefaultHelloService,å®¿ä¸»æ–¹æ³•:sayHello2020-01-15 00:06:07.521 INFO 14420 --- [ntLoopGroup-3-1] club.throwable.server.ServerHandler : æœåŠ¡ç«¯è¾“å‡º:&#123;\"attachments\":&#123;&#125;,\"errorCode\":200,\"magicNumber\":10086,\"message\":\"Success\",\"messageType\":\"RESPONSE\",\"payload\":\"\\\"doge say hello!\\\"\",\"serialNumber\":\"65f01b8e89bb479b8a36a60bd6519617\",\"version\":1&#125;// å®¢æˆ·ç«¯æ—¥å¿—00:06:05.891 [main] INFO club.throwable.protocol.TestProtocolClient - å¯åŠ¨NettyClient[9092]æˆåŠŸ......çœç•¥...00:06:13.197 [nioEventLoopGroup-2-1] INFO club.throwable.protocol.TestProtocolClient - æ¥æ”¶åˆ°æ¥è‡ªæœåŠ¡ç«¯çš„å“åº”æ¶ˆæ¯,æ¶ˆæ¯å†…å®¹:&#123;\"attachments\":&#123;&#125;,\"errorCode\":200,\"magicNumber\":10086,\"message\":\"Success\",\"messageType\":\"RESPONSE\",\"payload\":\"\\\"doge say hello!\\\"\",\"serialNumber\":\"65f01b8e89bb479b8a36a60bd6519617\",\"version\":1&#125; å¯è§RPCè°ƒç”¨æˆåŠŸã€‚ å°ç»“ ç¼–å†™RPCçš„Serverç«¯æŠ€å·§åœ¨äºå¤„ç†ç›®æ ‡æ–¹æ³•å’Œå®¿ä¸»ç±»çš„æŸ¥æ‰¾ï¼Œåœ¨è½¬æ¢æ–¹æ³•å‚æ•°çš„æ—¶å€™ï¼Œéœ€è¦è€ƒè™‘ç®€åŒ–å¤„ç†å’Œæé«˜æ•ˆç‡ï¼Œå‰©ä¸‹çš„å°±æ˜¯åšå¥½å¼‚å¸¸å¤„ç†å’Œæ¨¡å—å°è£…ã€‚é™äºç¯‡å¹…ï¼Œåé¢ä¼šå…ˆåˆ†æClientç«¯çš„å¤„ç†ï¼Œå†åˆ†æå¿ƒè·³å¤„ç†ã€æœåŠ¡ç«¯ä¼˜åŒ–ã€ç”šè‡³æ˜¯å¯¹æ¥æ³¨å†Œä¸­å¿ƒç­‰ç­‰ï¼Œåœ¨Nettyã€SpringBootç­‰ä¼˜ç§€æ¡†æ¶çš„åŠ æŒä¸‹ç¼–å†™ä¸€ä¸ªRPCæ¡†æ¶å…¶å®å¹¶ä¸å›°éš¾ï¼Œå›°éš¾çš„æ˜¯æ€§èƒ½ä¼˜åŒ–å’Œç”Ÿæ€åœˆçš„æ”¯æŒã€‚ Demoé¡¹ç›®åœ°å€ï¼š ch0-custom-rpc-protocol ï¼ˆæœ¬æ–‡å®Œ c-1-d e-a-20200115ï¼‰","categories":[{"name":"Netty","slug":"Netty","permalink":"http://throwable.club/blog/categories/Netty/"},{"name":"Java","slug":"Netty/Java","permalink":"http://throwable.club/blog/categories/Netty/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/tags/Java/"},{"name":"Netty","slug":"Netty","permalink":"http://throwable.club/blog/tags/Netty/"}]},{"title":"åŸºäºNettyå’ŒSpringBootå®ç°ä¸€ä¸ªè½»é‡çº§RPCæ¡†æ¶-åè®®ç¯‡","slug":"netty-custom-rpc-framework-protocol","date":"2020-01-12T14:47:21.000Z","updated":"2020-01-15T13:25:44.253Z","comments":true,"path":"2020/01/12/netty-custom-rpc-framework-protocol/","link":"","permalink":"http://throwable.club/2020/01/12/netty-custom-rpc-framework-protocol/","excerpt":"å‰æ æœ€è¿‘å¯¹ç½‘ç»œç¼–ç¨‹æ–¹é¢æ¯”è¾ƒæœ‰å…´è¶£ï¼Œåœ¨å¾®æœåŠ¡å®è·µä¸Šä¹Ÿç”¨åˆ°äº†ç›¸å¯¹ä¸»æµçš„RPCæ¡†æ¶å¦‚Spring Cloud Gatewayåº•å±‚ä¹Ÿåˆ‡æ¢ä¸ºReactor-Nettyï¼ŒåƒRedissonåº•å±‚ä¹Ÿæ˜¯ä½¿ç”¨Nettyå°è£…é€šè®¯åè®®ï¼Œæœ€è¿‘è°ƒç ”å’Œå‡†å¤‡ä½¿ç”¨çš„SOFARpcä¹Ÿæ˜¯åŸºäºNettyå°è£…å®ç°äº†å¤šç§åè®®çš„å…¼å®¹ã€‚å› æ­¤ï¼ŒåŸºäºNettyé€ ä¸€ä¸ªè½®å­ï¼Œåœ¨SpringBootçš„åŠ æŒä¸‹ï¼Œå®ç°ä¸€ä¸ªè½»é‡çº§çš„RPCæ¡†æ¶ã€‚è¿™ç¯‡åšæ–‡ä»‹ç»çš„æ˜¯RPCæ¡†æ¶åè®®çš„å®šä¹‰ä»¥åŠå¯¹åº”çš„ç¼–ç è§£ç å¤„ç†çš„å®ç°ã€‚","text":"å‰æ æœ€è¿‘å¯¹ç½‘ç»œç¼–ç¨‹æ–¹é¢æ¯”è¾ƒæœ‰å…´è¶£ï¼Œåœ¨å¾®æœåŠ¡å®è·µä¸Šä¹Ÿç”¨åˆ°äº†ç›¸å¯¹ä¸»æµçš„RPCæ¡†æ¶å¦‚Spring Cloud Gatewayåº•å±‚ä¹Ÿåˆ‡æ¢ä¸ºReactor-Nettyï¼ŒåƒRedissonåº•å±‚ä¹Ÿæ˜¯ä½¿ç”¨Nettyå°è£…é€šè®¯åè®®ï¼Œæœ€è¿‘è°ƒç ”å’Œå‡†å¤‡ä½¿ç”¨çš„SOFARpcä¹Ÿæ˜¯åŸºäºNettyå°è£…å®ç°äº†å¤šç§åè®®çš„å…¼å®¹ã€‚å› æ­¤ï¼ŒåŸºäºNettyé€ ä¸€ä¸ªè½®å­ï¼Œåœ¨SpringBootçš„åŠ æŒä¸‹ï¼Œå®ç°ä¸€ä¸ªè½»é‡çº§çš„RPCæ¡†æ¶ã€‚è¿™ç¯‡åšæ–‡ä»‹ç»çš„æ˜¯RPCæ¡†æ¶åè®®çš„å®šä¹‰ä»¥åŠå¯¹åº”çš„ç¼–ç è§£ç å¤„ç†çš„å®ç°ã€‚ ä¾èµ–å¼•å…¥ æˆªæ­¢æœ¬æ–‡ï¼ˆ2020-01-12ï¼‰ç¼–å†™å®Œæˆä¹‹æ—¶ï¼ŒNettyçš„æœ€æ–°ç‰ˆæœ¬ä¸º4.1.44.Finalï¼Œè€ŒSpringBootçš„æœ€æ–°ç‰ˆæœ¬ä¸º2.2.2.RELEASEï¼Œå› æ­¤å¼•å…¥è¿™ä¸¤ä¸ªç‰ˆæœ¬çš„ä¾èµ–ï¼ŒåŠ ä¸Šå…¶ä»–å·¥å…·åŒ…å’Œåºåˆ—åŒ–ç­‰ç­‰çš„æ”¯æŒï¼Œpomæ–‡ä»¶çš„æ ¸å¿ƒå†…å®¹å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132333435363738&lt;dependencyManagement&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-dependencies&lt;/artifactId&gt; &lt;version&gt;$&#123;spring.boot.version&#125;&lt;/version&gt; &lt;type&gt;pom&lt;/type&gt; &lt;scope&gt;import&lt;/scope&gt; &lt;/dependency&gt; &lt;/dependencies&gt;&lt;/dependencyManagement&gt;&lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;io.netty&lt;/groupId&gt; &lt;artifactId&gt;netty-all&lt;/artifactId&gt; &lt;version&gt;$&#123;netty.version&#125;&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.projectlombok&lt;/groupId&gt; &lt;artifactId&gt;lombok&lt;/artifactId&gt; &lt;version&gt;1.18.10&lt;/version&gt; &lt;scope&gt;provided&lt;/scope&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.alibaba&lt;/groupId&gt; &lt;artifactId&gt;fastjson&lt;/artifactId&gt; &lt;version&gt;1.2.61&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.google.guava&lt;/groupId&gt; &lt;artifactId&gt;guava&lt;/artifactId&gt; &lt;version&gt;28.1-jre&lt;/version&gt; &lt;/dependency&gt;&lt;/dependencies&gt; éƒ¨åˆ†å‚æ•°çš„åºåˆ—åŒ–ä¼šä¾èµ–åˆ°FastJsonæˆ–è€…Jacksonï¼Œå…·ä½“çœ‹åå¥½è€Œå®šã€‚ è‡ªå®šä¹‰åè®®çš„å®šä¹‰ ä¸ºäº†æé«˜åè®®ä¼ è¾“çš„æ•ˆç‡ï¼Œéœ€è¦å®šåˆ¶ä¸€å¥—é«˜æ•ˆçš„RPCåè®®ï¼Œè®¾è®¡åè®®æ‰€éœ€çš„å­—æ®µå’Œç±»å‹ã€‚ åŸºç¡€Packetå­—æ®µï¼š å­—æ®µå å­—æ®µç±»å‹ å­—èŠ‚æ•°(byte) å­—æ®µåŠŸèƒ½ å¤‡æ³¨ magicNumber int 2 é­”æ•°ï¼Œç±»ä¼¼äºJavaçš„å­—èŠ‚ç æ–‡ä»¶çš„é­”æ•°æ˜¯0xcafebase version int 2 ç‰ˆæœ¬å· é¢„ç•™å­—æ®µï¼Œé»˜è®¤ä¸º1 serialNumber java.lang.String 4 è¯·æ±‚æµæ°´å· ååˆ†é‡è¦ï¼Œæ¯ä¸ªè¯·æ±‚çš„å”¯ä¸€æ ‡è¯† messageType MessageType 1 æ¶ˆæ¯ç±»å‹ è‡ªå®šä¹‰çš„æšä¸¾ç±»å‹ï¼Œè§ä¸‹é¢çš„MessageTypeç±» attachments Map&lt;String, String&gt; è§†å®é™…æƒ…å†µè€Œå®š é™„ä»¶ K-Vå½¢å¼ï¼Œç±»ä¼¼äºHTTPåè®®ä¸­çš„Header 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980// æ¶ˆæ¯æšä¸¾ç±»å‹@RequiredArgsConstructorpublic enum MessageType &#123; /** * è¯·æ±‚ */ REQUEST((byte) 1), /** * å“åº” */ RESPONSE((byte) 2), /** * PING */ PING((byte) 3), /** * PONG */ PONG((byte) 4), /** * NULL */ NULL((byte) 5), ; @Getter private final Byte type; public static MessageType fromValue(byte value) &#123; for (MessageType type : MessageType.values()) &#123; if (type.getType() == value) &#123; return type; &#125; &#125; throw new IllegalArgumentException(String.format(\"value = %s\", value)); &#125;&#125;// åŸºç¡€Packet@Datapublic abstract class BaseMessagePacket implements Serializable &#123; /** * é­”æ•° */ private int magicNumber; /** * ç‰ˆæœ¬å· */ private int version; /** * æµæ°´å· */ private String serialNumber; /** * æ¶ˆæ¯ç±»å‹ */ private MessageType messageType; /** * é™„ä»¶ - K-Vå½¢å¼ */ private Map&lt;String, String&gt; attachments = new HashMap&lt;&gt;(); /** * æ·»åŠ é™„ä»¶ */ public void addAttachment(String key, String value) &#123; attachments.put(key, value); &#125;&#125; è¯·æ±‚Packetæ‰©å±•å­—æ®µï¼š å­—æ®µå å­—æ®µç±»å‹ å­—èŠ‚æ•°(byte) å­—æ®µåŠŸèƒ½ å¤‡æ³¨ interfaceName java.lang.String è§†å®é™…æƒ…å†µè€Œå®š æ¥å£å…¨ç±»å methodName java.lang.String è§†å®é™…æƒ…å†µè€Œå®š æ–¹æ³•å methodArgumentSignatures java.lang.String[] è§†å®é™…æƒ…å†µè€Œå®š æ–¹æ³•å‚æ•°ç­¾åå­—ç¬¦ä¸²æ•°ç»„ å­˜æ”¾æ–¹æ³•å‚æ•°ç±»å‹å…¨ç±»åå­—ç¬¦ä¸²æ•°ç»„ methodArguments java.lang.Object[] è§†å®é™…æƒ…å†µè€Œå®š æ–¹æ³•å‚æ•°æ•°ç»„ å› ä¸ºæœªçŸ¥æ–¹æ³•å‚æ•°ç±»å‹ï¼Œæ‰€ä»¥ç”¨Objectè¡¨ç¤º 123456789101112131415161718192021222324@EqualsAndHashCode(callSuper = true)@Datapublic class RequestMessagePacket extends BaseMessagePacket &#123; /** * æ¥å£å…¨ç±»å */ private String interfaceName; /** * æ–¹æ³•å */ private String methodName; /** * æ–¹æ³•å‚æ•°ç­¾å */ private String[] methodArgumentSignatures; /** * æ–¹æ³•å‚æ•° */ private Object[] methodArguments;&#125; å“åº”Packetæ‰©å±•å­—æ®µï¼š å­—æ®µå å­—æ®µç±»å‹ å­—èŠ‚æ•°(byte) å­—æ®µåŠŸèƒ½ å¤‡æ³¨ errorCode java.lang.Long 4 å“åº”ç  message java.lang.String è§†å®é™…æƒ…å†µè€Œå®š å“åº”æ¶ˆæ¯ å¦‚æœå‡ºç°å¼‚å¸¸ï¼Œmessageå°±æ˜¯å¯¹åº”çš„å¼‚å¸¸ä¿¡æ¯ payload java.lang.Object è§†å®é™…æƒ…å†µè€Œå®š æ¶ˆæ¯è½½è· ä¸šåŠ¡å¤„ç†è¿”å›çš„æ¶ˆæ¯è½½è·ï¼Œå®šä¹‰ä¸ºObjectç±»å‹ 12345678910111213141516171819@EqualsAndHashCode(callSuper = true)@Datapublic class ResponseMessagePacket extends BaseMessagePacket &#123; /** * error code */ private Long errorCode; /** * æ¶ˆæ¯æè¿° */ private String message; /** * æ¶ˆæ¯è½½è· */ private Object payload;&#125; éœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š éåŸºæœ¬ç±»å‹åœ¨åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„æ—¶å€™ï¼Œä¸€å®šæ³¨æ„è¦å…ˆå†™å…¥æˆ–è€…å…ˆè¯»å–åºåˆ—çš„é•¿åº¦ï¼Œä»¥java.lang.Stringç±»å‹ä¸ºä¾‹ï¼š 1234567// åºåˆ—åŒ– - æµæ°´å·out.writeInt(packet.getSerialNumber().length());out.writeCharSequence(packet.getSerialNumber(), ProtocolConstant.UTF_8);// ååºåˆ—åŒ– - æµæ°´å·int serialNumberLength = in.readInt();packet.setSerialNumber(in.readCharSequence(serialNumberLength, ProtocolConstant.UTF_8).toString()); ç‰¹æ®Šç¼–ç çš„å­—ç¬¦ä¸²åœ¨åºåˆ—åŒ–çš„æ—¶å€™ï¼Œè¦æ³¨æ„å­—ç¬¦ä¸²ç¼–ç çš„é•¿åº¦ï¼Œä¾‹å¦‚UTF-8ç¼–ç ä¸‹ä¸€ä¸ªä¸­æ–‡å­—ç¬¦å 3ä¸ªå­—èŠ‚ï¼Œè¿™ä¸€ç‚¹å¯ä»¥æŠ½å–ä¸€ä¸ªå·¥å…·ç±»ä¸“é—¨å¤„ç†å­—ç¬¦ä¸²çš„åºåˆ—åŒ–ï¼š 123456789101112public enum ByteBufferUtils &#123; // å•ä¾‹ X; public void encodeUtf8CharSequence(ByteBuf byteBuf, CharSequence charSequence) &#123; int writerIndex = byteBuf.writerIndex(); byteBuf.writeInt(0); int length = ByteBufUtil.writeUtf8(byteBuf, charSequence); byteBuf.setInt(writerIndex, length); &#125;&#125; æ–¹æ³•å‚æ•°æ•°ç»„çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ–¹æ¡ˆéœ€è¦å®šåˆ¶ï¼Œç¬”è€…ä¸ºäº†ç®€åŒ–è‡ªå®šä¹‰åè®®ï¼Œå®šä¹‰äº†æ–¹æ³•å‚æ•°ç­¾åæ•°ç»„ï¼Œé•¿åº¦å’Œæ–¹æ³•å‚æ•°æ•°ç»„ä¸€è‡´ï¼Œè¿™æ ·åšæ–¹ä¾¿åé¢ç¼–å†™æœåŠ¡ç«¯ä»£ç çš„æ—¶å€™ï¼Œç®€åŒ–å¯¹æ–¹æ³•å‚æ•°æ•°ç»„è¿›è¡Œååºåˆ—åŒ–ä»¥åŠå®¿ä¸»ç±»ç›®æ ‡æ–¹æ³•çš„æŸ¥æ‰¾ã€‚æ³¨æ„ä¸€ä¸‹Object[]çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ç›¸å¯¹ç‰¹æ®Šï¼Œå› ä¸ºByteBufæ— æ³•å¤„ç†è‡ªå®šä¹‰ç±»å‹çš„å†™å…¥å’Œè¯»å–ï¼ˆè¿™ä¸ªå¾ˆå¥½ç†è§£ï¼Œç½‘ç»œç¼–ç¨‹å°±æ˜¯é¢å‘0å’Œ1çš„ç¼–ç¨‹ï¼‰ï¼š 123write Object --&gt; ByteBuf#writeInt() &amp;&amp; ByteBuf#writeBytes()read Object --&gt; ByteBuf#readInt() &amp;&amp; ByteBuf#readBytes() [&lt;== è¿™ä¸ªæ–¹æ³•è¿”å›å€¼æ˜¯ByteBufå®ä¾‹] æœ€åæ³¨æ„é‡Šæ”¾ByteBufçš„å¼•ç”¨ï¼Œå¦åˆ™æœ‰å¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼ã€‚ è‡ªå®šä¹‰åè®®ç¼–ç è§£ç å®ç° è‡ªå®šä¹‰åè®®ç¼–ç è§£ç ä¸»è¦åŒ…æ‹¬å››ä¸ªéƒ¨åˆ†çš„ç¼–ç è§£ç å™¨ï¼š è¯·æ±‚Packetç¼–ç å™¨ï¼šRequestMessagePacketEncoderï¼Œä¸»è¦ç”¨äºå®¢æˆ·ç«¯æŠŠRequestMessagePacketå®ä¾‹åºåˆ—åŒ–ä¸ºäºŒè¿›åˆ¶åºåˆ—ã€‚ è¯·æ±‚Packetè§£ç å™¨ï¼šRequestMessagePacketDecoderï¼Œä¸»è¦ç”¨äºæœåŠ¡ç«¯æŠŠäºŒè¿›åˆ¶åºåˆ—ååºåˆ—åŒ–ä¸ºRequestMessagePacketå®ä¾‹ã€‚ å“åº”Packetç¼–ç å™¨ï¼šResponseMessagePacketEncoderï¼Œä¸»è¦ç”¨äºæœåŠ¡ç«¯æŠŠResponseMessagePacketå®ä¾‹åºåˆ—åŒ–ä¸ºäºŒè¿›åˆ¶åºåˆ—ã€‚ å“åº”Packetè§£ç å™¨ï¼šResponseMessagePacketDecoderï¼Œä¸»è¦ç”¨äºå®¢æˆ·ç«¯æŠŠäºŒè¿›åˆ¶åºåˆ—ååºåˆ—åŒ–ä¸ºResponseMessagePacketå®ä¾‹ã€‚ ç”»ä¸ªå›¾æè¿°ä¸€ä¸‹å‡ ä¸ªç»„ä»¶çš„äº¤äº’æµç¨‹ï¼ˆçœç•¥äº†éƒ¨åˆ†å…¥ç«™å’Œå‡ºç«™å¤„ç†å™¨ï¼‰ï¼š åºåˆ—åŒ–å™¨Serializerçš„ä»£ç å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223public interface Serializer &#123; byte[] encode(Object target); Object decode(byte[] bytes, Class&lt;?&gt; targetClass);&#125;// FastJsonå®ç°public enum FastJsonSerializer implements Serializer &#123; // å•ä¾‹ X; @Override public byte[] encode(Object target) &#123; return JSON.toJSONBytes(target); &#125; @Override public Object decode(byte[] bytes, Class&lt;?&gt; targetClass) &#123; return JSON.parseObject(bytes, targetClass); &#125;&#125; è¯·æ±‚Packetç¼–ç å™¨RequestMessagePacketEncoderçš„ä»£ç å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960@RequiredArgsConstructorpublic class RequestMessagePacketEncoder extends MessageToByteEncoder&lt;RequestMessagePacket&gt; &#123; private final Serializer serializer; @Override protected void encode(ChannelHandlerContext context, RequestMessagePacket packet, ByteBuf out) throws Exception &#123; // é­”æ•° out.writeInt(packet.getMagicNumber()); // ç‰ˆæœ¬ out.writeInt(packet.getVersion()); // æµæ°´å· out.writeInt(packet.getSerialNumber().length()); out.writeCharSequence(packet.getSerialNumber(), ProtocolConstant.UTF_8); // æ¶ˆæ¯ç±»å‹ out.writeByte(packet.getMessageType().getType()); // é™„ä»¶size Map&lt;String, String&gt; attachments = packet.getAttachments(); out.writeInt(attachments.size()); // é™„ä»¶å†…å®¹ attachments.forEach((k, v) -&gt; &#123; out.writeInt(k.length()); out.writeCharSequence(k, ProtocolConstant.UTF_8); out.writeInt(v.length()); out.writeCharSequence(v, ProtocolConstant.UTF_8); &#125;); // æ¥å£å…¨ç±»å out.writeInt(packet.getInterfaceName().length()); out.writeCharSequence(packet.getInterfaceName(), ProtocolConstant.UTF_8); // æ–¹æ³•å out.writeInt(packet.getMethodName().length()); out.writeCharSequence(packet.getMethodName(), ProtocolConstant.UTF_8); // æ–¹æ³•å‚æ•°ç­¾å(String[]ç±»å‹) - éå¿…é¡» if (null != packet.getMethodArgumentSignatures()) &#123; int len = packet.getMethodArgumentSignatures().length; // æ–¹æ³•å‚æ•°ç­¾åæ•°ç»„é•¿åº¦ out.writeInt(len); for (int i = 0; i &lt; len; i++) &#123; String methodArgumentSignature = packet.getMethodArgumentSignatures()[i]; out.writeInt(methodArgumentSignature.length()); out.writeCharSequence(methodArgumentSignature, ProtocolConstant.UTF_8); &#125; &#125; else &#123; out.writeInt(0); &#125; // æ–¹æ³•å‚æ•°(Object[]ç±»å‹) - éå¿…é¡» if (null != packet.getMethodArguments()) &#123; int len = packet.getMethodArguments().length; // æ–¹æ³•å‚æ•°æ•°ç»„é•¿åº¦ out.writeInt(len); for (int i = 0; i &lt; len; i++) &#123; byte[] bytes = serializer.encode(packet.getMethodArguments()[i]); out.writeInt(bytes.length); out.writeBytes(bytes); &#125; &#125; else &#123; out.writeInt(0); &#125; &#125;&#125; è¯·æ±‚Packetè§£ç å™¨RequestMessagePacketDecoderçš„ä»£ç å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859@RequiredArgsConstructorpublic class RequestMessagePacketDecoder extends ByteToMessageDecoder &#123; @Override protected void decode(ChannelHandlerContext context, ByteBuf in, List&lt;Object&gt; list) throws Exception &#123; RequestMessagePacket packet = new RequestMessagePacket(); // é­”æ•° packet.setMagicNumber(in.readInt()); // ç‰ˆæœ¬ packet.setVersion(in.readInt()); // æµæ°´å· int serialNumberLength = in.readInt(); packet.setSerialNumber(in.readCharSequence(serialNumberLength, ProtocolConstant.UTF_8).toString()); // æ¶ˆæ¯ç±»å‹ byte messageTypeByte = in.readByte(); packet.setMessageType(MessageType.fromValue(messageTypeByte)); // é™„ä»¶ Map&lt;String, String&gt; attachments = Maps.newHashMap(); packet.setAttachments(attachments); int attachmentSize = in.readInt(); if (attachmentSize &gt; 0) &#123; for (int i = 0; i &lt; attachmentSize; i++) &#123; int keyLength = in.readInt(); String key = in.readCharSequence(keyLength, ProtocolConstant.UTF_8).toString(); int valueLength = in.readInt(); String value = in.readCharSequence(valueLength, ProtocolConstant.UTF_8).toString(); attachments.put(key, value); &#125; &#125; // æ¥å£å…¨ç±»å int interfaceNameLength = in.readInt(); packet.setInterfaceName(in.readCharSequence(interfaceNameLength, ProtocolConstant.UTF_8).toString()); // æ–¹æ³•å int methodNameLength = in.readInt(); packet.setMethodName(in.readCharSequence(methodNameLength, ProtocolConstant.UTF_8).toString()); // æ–¹æ³•å‚æ•°ç­¾å int methodArgumentSignatureArrayLength = in.readInt(); if (methodArgumentSignatureArrayLength &gt; 0) &#123; String[] methodArgumentSignatures = new String[methodArgumentSignatureArrayLength]; for (int i = 0; i &lt; methodArgumentSignatureArrayLength; i++) &#123; int methodArgumentSignatureLength = in.readInt(); methodArgumentSignatures[i] = in.readCharSequence(methodArgumentSignatureLength, ProtocolConstant.UTF_8).toString(); &#125; packet.setMethodArgumentSignatures(methodArgumentSignatures); &#125; // æ–¹æ³•å‚æ•° int methodArgumentArrayLength = in.readInt(); if (methodArgumentArrayLength &gt; 0) &#123; // è¿™é‡Œçš„Object[]å®é™…ä¸Šæ˜¯ByteBuf[] - åé¢éœ€è¦äºŒæ¬¡åŠ å·¥ä¸ºå¯¹åº”ç±»å‹çš„å®ä¾‹ Object[] methodArguments = new Object[methodArgumentArrayLength]; for (int i = 0; i &lt; methodArgumentArrayLength; i++) &#123; int byteLength = in.readInt(); methodArguments[i] = in.readBytes(byteLength); &#125; packet.setMethodArguments(methodArguments); &#125; list.add(packet); &#125;&#125; å“åº”Packetç¼–ç å™¨ResponseMessagePacketEncoderçš„ä»£ç å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637@RequiredArgsConstructorpublic class ResponseMessagePacketEncoder extends MessageToByteEncoder&lt;ResponseMessagePacket&gt; &#123; private final Serializer serializer; @Override protected void encode(ChannelHandlerContext ctx, ResponseMessagePacket packet, ByteBuf out) throws Exception &#123; // é­”æ•° out.writeInt(packet.getMagicNumber()); // ç‰ˆæœ¬ out.writeInt(packet.getVersion()); // æµæ°´å· out.writeInt(packet.getSerialNumber().length()); out.writeCharSequence(packet.getSerialNumber(), ProtocolConstant.UTF_8); // æ¶ˆæ¯ç±»å‹ out.writeByte(packet.getMessageType().getType()); // é™„ä»¶size Map&lt;String, String&gt; attachments = packet.getAttachments(); out.writeInt(attachments.size()); // é™„ä»¶å†…å®¹ attachments.forEach((k, v) -&gt; &#123; out.writeInt(k.length()); out.writeCharSequence(k, ProtocolConstant.UTF_8); out.writeInt(v.length()); out.writeCharSequence(v, ProtocolConstant.UTF_8); &#125;); // error code out.writeLong(packet.getErrorCode()); // message String message = packet.getMessage(); ByteBufferUtils.X.encodeUtf8CharSequence(out, message); // payload byte[] bytes = serializer.encode(packet.getPayload()); out.writeInt(bytes.length); out.writeBytes(bytes); &#125;&#125; å“åº”Packetè§£ç å™¨ResponseMessagePacketDecoderçš„ä»£ç å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839public class ResponseMessagePacketDecoder extends ByteToMessageDecoder &#123; @Override protected void decode(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out) throws Exception &#123; ResponseMessagePacket packet = new ResponseMessagePacket(); // é­”æ•° packet.setMagicNumber(in.readInt()); // ç‰ˆæœ¬ packet.setVersion(in.readInt()); // æµæ°´å· int serialNumberLength = in.readInt(); packet.setSerialNumber(in.readCharSequence(serialNumberLength, ProtocolConstant.UTF_8).toString()); // æ¶ˆæ¯ç±»å‹ byte messageTypeByte = in.readByte(); packet.setMessageType(MessageType.fromValue(messageTypeByte)); // é™„ä»¶ Map&lt;String, String&gt; attachments = Maps.newHashMap(); packet.setAttachments(attachments); int attachmentSize = in.readInt(); if (attachmentSize &gt; 0) &#123; for (int i = 0; i &lt; attachmentSize; i++) &#123; int keyLength = in.readInt(); String key = in.readCharSequence(keyLength, ProtocolConstant.UTF_8).toString(); int valueLength = in.readInt(); String value = in.readCharSequence(valueLength, ProtocolConstant.UTF_8).toString(); attachments.put(key, value); &#125; &#125; // error code packet.setErrorCode(in.readLong()); // message int messageLength = in.readInt(); packet.setMessage(in.readCharSequence(messageLength, ProtocolConstant.UTF_8).toString()); // payload - ByteBufå®ä¾‹ int payloadLength = in.readInt(); packet.setPayload(in.readBytes(payloadLength)); out.add(packet); &#125;&#125; æ ¸å¿ƒçš„ç¼–ç è§£ç å™¨å·²ç»ç¼–å†™å®Œï¼Œæ¥ç€è¦æ³¨æ„ä¸€ä¸‹TCPåè®®äºŒè¿›åˆ¶åŒ…å‘é€çš„æ—¶å€™åªä¿è¯äº†åŒ…çš„å‘é€é¡ºåºã€ç¡®è®¤å‘é€ä»¥åŠé‡ä¼ ï¼Œæ— æ³•ä¿è¯äºŒè¿›åˆ¶åŒ…æ˜¯å¦å®Œæ•´ï¼ˆæœ‰äº›åšå®¢ä¹Ÿç§°æ­¤ç±»åœºæ™¯ä¸ºç²˜åŒ…ã€åŠåŒ…ç­‰ç­‰ï¼Œå…¶å®ç½‘ç»œåè®®é‡Œé¢å¹¶æ²¡æœ‰å®šä¹‰è¿™äº›æœ¯è¯­ï¼Œä¼°è®¡æ˜¯æœ‰äººæœæ’°å‡ºæ¥ï¼‰ï¼Œå› æ­¤è¿™é‡Œé‡‡å–äº†å®šé•¿å¸§ç¼–ç å’Œè§£ç å™¨LengthFieldPrependerå’ŒLengthFieldBasedFrameDecoderï¼Œç®€å•æ¥è¯´å°±æ˜¯åœ¨æ¶ˆæ¯å¸§çš„å¼€å¤´å‡ ä½å®šä¹‰äº†æ•´ä¸ªå¸§çš„é•¿åº¦ï¼Œè¯»å–åˆ°æ•´ä¸ªé•¿åº¦çš„æ¶ˆæ¯å¸§æ‰è®¤ä¸ºæ˜¯ä¸€ä¸ªå®Œæ•´çš„äºŒè¿›åˆ¶æŠ¥æ–‡ã€‚ä¸¾ä¸ªå‡ ä¸ªä¾‹å­ï¼š 12|&lt;--------packet frame---------&gt;|| Length Field | Actual Content | åºå· Length Field Actual Content 0 4 abcd 1 9 throwable 2 14 {â€œnameâ€:â€œdogeâ€} ç¼–å†™æµ‹è¯•å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ å®¢æˆ·ç«¯ä»£ç å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657@Slf4jpublic class TestProtocolClient &#123; public static void main(String[] args) throws Exception &#123; int port = 9092; EventLoopGroup workerGroup = new NioEventLoopGroup(); Bootstrap bootstrap = new Bootstrap(); try &#123; bootstrap.group(workerGroup); bootstrap.channel(NioSocketChannel.class); bootstrap.option(ChannelOption.SO_KEEPALIVE, Boolean.TRUE); bootstrap.option(ChannelOption.TCP_NODELAY, Boolean.TRUE); bootstrap.handler(new ChannelInitializer&lt;SocketChannel&gt;() &#123; @Override protected void initChannel(SocketChannel ch) throws Exception &#123; ch.pipeline().addLast(new LengthFieldBasedFrameDecoder(1024, 0, 4, 0, 4)); ch.pipeline().addLast(new LengthFieldPrepender(4)); ch.pipeline().addLast(new RequestMessagePacketEncoder(FastJsonSerializer.X)); ch.pipeline().addLast(new ResponseMessagePacketDecoder()); ch.pipeline().addLast(new SimpleChannelInboundHandler&lt;ResponseMessagePacket&gt;() &#123; @Override protected void channelRead0(ChannelHandlerContext ctx, ResponseMessagePacket packet) throws Exception &#123; Object targetPayload = packet.getPayload(); if (targetPayload instanceof ByteBuf) &#123; ByteBuf byteBuf = (ByteBuf) targetPayload; int readableByteLength = byteBuf.readableBytes(); byte[] bytes = new byte[readableByteLength]; byteBuf.readBytes(bytes); targetPayload = FastJsonSerializer.X.decode(bytes, String.class); byteBuf.release(); &#125; packet.setPayload(targetPayload); log.info(\"æ¥æ”¶åˆ°æ¥è‡ªæœåŠ¡ç«¯çš„å“åº”æ¶ˆæ¯,æ¶ˆæ¯å†…å®¹:&#123;&#125;\", JSON.toJSONString(packet)); &#125; &#125;); &#125; &#125;); ChannelFuture future = bootstrap.connect(\"localhost\", port).sync(); log.info(\"å¯åŠ¨NettyClient[&#123;&#125;]æˆåŠŸ...\", port); Channel channel = future.channel(); RequestMessagePacket packet = new RequestMessagePacket(); packet.setMagicNumber(ProtocolConstant.MAGIC_NUMBER); packet.setVersion(ProtocolConstant.VERSION); packet.setSerialNumber(SerialNumberUtils.X.generateSerialNumber()); packet.setMessageType(MessageType.REQUEST); packet.setInterfaceName(\"club.throwable.contract.HelloService\"); packet.setMethodName(\"sayHello\"); packet.setMethodArgumentSignatures(new String[]&#123;\"java.lang.String\"&#125;); packet.setMethodArguments(new Object[]&#123;\"doge\"&#125;); channel.writeAndFlush(packet); future.channel().closeFuture().sync(); &#125; finally &#123; workerGroup.shutdownGracefully(); &#125; &#125;&#125; æœåŠ¡ç«¯ä»£ç å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647@Slf4jpublic class TestProtocolServer &#123; public static void main(String[] args) throws Exception &#123; int port = 9092; ServerBootstrap bootstrap = new ServerBootstrap(); EventLoopGroup bossGroup = new NioEventLoopGroup(); EventLoopGroup workerGroup = new NioEventLoopGroup(); try &#123; bootstrap.group(bossGroup, workerGroup) .channel(NioServerSocketChannel.class) .childHandler(new ChannelInitializer&lt;SocketChannel&gt;() &#123; @Override protected void initChannel(SocketChannel ch) throws Exception &#123; ch.pipeline().addLast(new LengthFieldBasedFrameDecoder(1024, 0, 4, 0, 4)); ch.pipeline().addLast(new LengthFieldPrepender(4)); ch.pipeline().addLast(new RequestMessagePacketDecoder()); ch.pipeline().addLast(new ResponseMessagePacketEncoder(FastJsonSerializer.X)); ch.pipeline().addLast(new SimpleChannelInboundHandler&lt;RequestMessagePacket&gt;() &#123; @Override protected void channelRead0(ChannelHandlerContext ctx, RequestMessagePacket packet) throws Exception &#123; log.info(\"æ¥æ”¶åˆ°æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚æ¶ˆæ¯,æ¶ˆæ¯å†…å®¹:&#123;&#125;\", JSON.toJSONString(packet)); ResponseMessagePacket response = new ResponseMessagePacket(); response.setMagicNumber(packet.getMagicNumber()); response.setVersion(packet.getVersion()); response.setSerialNumber(packet.getSerialNumber()); response.setAttachments(packet.getAttachments()); response.setMessageType(MessageType.RESPONSE); response.setErrorCode(200L); response.setMessage(\"Success\"); response.setPayload(\"&#123;\\\"name\\\":\\\"throwable\\\"&#125;\"); ctx.writeAndFlush(response); &#125; &#125;); &#125; &#125;); ChannelFuture future = bootstrap.bind(port).sync(); log.info(\"å¯åŠ¨NettyServer[&#123;&#125;]æˆåŠŸ...\", port); future.channel().closeFuture().sync(); &#125; finally &#123; workerGroup.shutdownGracefully(); bossGroup.shutdownGracefully(); &#125; &#125;&#125; è¿™é‡Œåœ¨æµ‹è¯•çš„ç¯å¢ƒä¸­ï¼Œæœ€å¤§çš„æ¶ˆæ¯å¸§é•¿åº¦æš‚æ—¶å®šä¹‰ä¸º1024ã€‚å…ˆå¯åŠ¨æœåŠ¡ç«¯ï¼Œå†å¯åŠ¨å®¢æˆ·ç«¯ï¼Œè§æ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š 123456789// æœåŠ¡ç«¯22:29:32.596 [main] INFO club.throwable.protocol.TestProtocolServer - å¯åŠ¨NettyServer[9092]æˆåŠŸ......çœç•¥å…¶ä»–æ—¥å¿—...22:29:53.538 [nioEventLoopGroup-3-1] INFO club.throwable.protocol.TestProtocolServer - æ¥æ”¶åˆ°æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚æ¶ˆæ¯,æ¶ˆæ¯å†…å®¹:&#123;\"attachments\":&#123;&#125;,\"interfaceName\":\"club.throwable.contract.HelloService\",\"magicNumber\":10086,\"messageType\":\"REQUEST\",\"methodArgumentSignatures\":[\"java.lang.String\"],\"methodArguments\":[&#123;\"contiguous\":true,\"direct\":true,\"readOnly\":false,\"readable\":true,\"writable\":false&#125;],\"methodName\":\"sayHello\",\"serialNumber\":\"7f992c7cf9f445258601def1cac9bec0\",\"version\":1&#125;// å®¢æˆ·ç«¯22:31:28.360 [main] INFO club.throwable.protocol.TestProtocolClient - å¯åŠ¨NettyClient[9092]æˆåŠŸ......çœç•¥å…¶ä»–æ—¥å¿—...22:31:39.320 [nioEventLoopGroup-2-1] INFO club.throwable.protocol.TestProtocolClient - æ¥æ”¶åˆ°æ¥è‡ªæœåŠ¡ç«¯çš„å“åº”æ¶ˆæ¯,æ¶ˆæ¯å†…å®¹:&#123;\"attachments\":&#123;&#125;,\"errorCode\":200,\"magicNumber\":10086,\"message\":\"Success\",\"messageType\":\"RESPONSE\",\"payload\":\"&#123;\\\"name\\\":\\\"throwable\\\"&#125;\",\"serialNumber\":\"320808e709b34edbb91ba557780b58ad\",\"version\":1&#125; å°ç»“ ä¸€ä¸ªåŸºäºNettyå®ç°çš„ç®€å•çš„è‡ªå®šä¹‰åè®®åŸºæœ¬å®Œæˆï¼Œä½†æ˜¯è¦ç¼–å†™ä¸€ä¸ªä¼˜ç§€çš„RPCæ¡†æ¶ï¼Œè¿˜éœ€è¦åšæœåŠ¡ç«¯çš„å®¿ä¸»ç±»å’Œç›®æ ‡æ–¹æ³•æŸ¥è¯¢ã€è°ƒç”¨ï¼Œå®¢æˆ·ç«¯çš„åŠ¨æ€ä»£ç†ï¼ŒNettyçš„NIOæ¨¡å¼ä¸‹çš„åŒæ­¥è°ƒç”¨æ”¹é€ ï¼Œå¿ƒè·³å¤„ç†ï¼Œå¼‚å¸¸å¤„ç†ç­‰ç­‰ã€‚åé¢ä¼šä½¿ç”¨å¤šç¯‡æ–‡ç« é€ä¸ªé—®é¢˜è§£å†³ï¼Œç½‘ç»œç¼–ç¨‹å…¶å®æŒºå¥½ç©äº†ï¼Œå°±æ˜¯ç¼–ç é‡ä¼šæ¯”è¾ƒå¤§(ã‚œ-ã‚œ)ã¤ãƒ­ã€‚ Demoé¡¹ç›®ï¼š ch0-custom-rpc-protocol ï¼ˆe-a-20200112 c-1-dï¼‰","categories":[{"name":"Netty","slug":"Netty","permalink":"http://throwable.club/blog/categories/Netty/"},{"name":"Java","slug":"Netty/Java","permalink":"http://throwable.club/blog/categories/Netty/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/tags/Java/"},{"name":"Netty","slug":"Netty","permalink":"http://throwable.club/blog/tags/Netty/"}]},{"title":"SofaBootä½¿ç”¨Nacosè¿›è¡ŒæœåŠ¡æ³¨å†Œå‘ç°","slug":"sofa-boot-nacos-get-start","date":"2020-01-01T15:30:41.000Z","updated":"2020-01-02T09:35:56.367Z","comments":true,"path":"2020/01/01/sofa-boot-nacos-get-start/","link":"","permalink":"http://throwable.club/2020/01/01/sofa-boot-nacos-get-start/","excerpt":"å‰æ æœ€è¿‘åˆ›ä¸šå…¬å¸çš„é¡¹ç›®ç»„åŸºäºä¸šåŠ¡éœ€è¦ï¼Œå¼€å‘ä¸€å¥—æ–°çš„å¾®æœåŠ¡ï¼Œè€ƒè™‘åˆ°é€‰ç”¨çš„ç»„ä»¶å¿…é¡»æ˜¯ä¸»æµã€ç¤¾åŒºæ´»è·ƒã€ç”Ÿæ€å®Œå–„ä»¥åŠæ–¹ä¾¿è¿ç§»åˆ°äº‘ä¸Šç­‰å› ç´ ï¼Œå¼•å…¥äº†SOFAStackå…¨å®¶æ¡¶ã€‚å¾®æœåŠ¡å¼€å‘é‡Œé¢ï¼Œä¸€ä¸ªå¾ˆé‡è¦çš„åŠŸèƒ½å°±æ˜¯æœåŠ¡å‘ç°ä¸æ³¨å†Œï¼Œç¬”è€…èŠ±äº†ç‚¹æ—¶é—´åšäº†ä¸€ä¸ªSOFABootã€SOFARpcç»“åˆNacoså®ç°å¾®æœåŠ¡å‘ç°æ³¨å†Œä¸è¿œç¨‹è°ƒç”¨çš„ç¤ºä¾‹ã€‚","text":"å‰æ æœ€è¿‘åˆ›ä¸šå…¬å¸çš„é¡¹ç›®ç»„åŸºäºä¸šåŠ¡éœ€è¦ï¼Œå¼€å‘ä¸€å¥—æ–°çš„å¾®æœåŠ¡ï¼Œè€ƒè™‘åˆ°é€‰ç”¨çš„ç»„ä»¶å¿…é¡»æ˜¯ä¸»æµã€ç¤¾åŒºæ´»è·ƒã€ç”Ÿæ€å®Œå–„ä»¥åŠæ–¹ä¾¿è¿ç§»åˆ°äº‘ä¸Šç­‰å› ç´ ï¼Œå¼•å…¥äº†SOFAStackå…¨å®¶æ¡¶ã€‚å¾®æœåŠ¡å¼€å‘é‡Œé¢ï¼Œä¸€ä¸ªå¾ˆé‡è¦çš„åŠŸèƒ½å°±æ˜¯æœåŠ¡å‘ç°ä¸æ³¨å†Œï¼Œç¬”è€…èŠ±äº†ç‚¹æ—¶é—´åšäº†ä¸€ä¸ªSOFABootã€SOFARpcç»“åˆNacoså®ç°å¾®æœåŠ¡å‘ç°æ³¨å†Œä¸è¿œç¨‹è°ƒç”¨çš„ç¤ºä¾‹ã€‚ ä¾èµ–ç‰ˆæœ¬è¸©å‘ ç¬”è€…èŠ±äº†ç‚¹æ—¶é—´å»å°è¯•SOFABootã€SOFARpcç»“åˆNacoså®¢æˆ·ç«¯çš„ä¾èµ–ç‰ˆæœ¬å…³ç³»ï¼Œæˆªæ­¢æœ¬æ–‡ç¼–å†™å®Œæˆçš„æ—¶å€™ï¼ˆ2020-01-01ï¼‰ï¼Œsofaboot-dependenciesçš„æœ€æ–°ç‰ˆæœ¬ä¸º3.2.1ï¼Œå¯¹åº”äºSOFABoot-3.2.1ã€SOFARpc-5.6.3å’ŒSpringBoot-2.1.x.RELEASEã€‚åœ¨è¿™ä¸¤ä¸ªæœ€æ–°ç‰ˆæœ¬çš„é¡¹ç›®ä¸­ï¼Œæ— è®ºå¼•å…¥ä»€ä¹ˆç‰ˆæœ¬çš„nacos-clinetï¼Œéƒ½æ²¡æœ‰åŠæ³•å‘Nacos-Serveræ³¨å†ŒæœåŠ¡ä¿¡æ¯ã€‚å…³äºè¿™ä¸€ç‚¹ï¼Œç¬”è€…æ›¾ç»ä»Issuesé‡Œé¢æŸ¥æ‰¾ç›¸å…³çš„å†…å®¹ï¼Œæš‚æ—¶æ— æœï¼Œäºæ˜¯æŠŠç¤ºä¾‹é¡¹ç›®åˆ†äº«ç»™ç¤¾åŒºçš„å¤§ä½¬è¿›è¡Œåˆ†æï¼Œå¦‚æœæœ‰è§£å†³æ–¹æ¡ˆï¼Œä¼šåœ¨è¿™ç¯‡åšæ–‡ä¸­æ›´æ–°ã€‚è¯•å‡ºæ¥çš„å¯ç”¨çš„ç‰ˆæœ¬ç»„åˆä¸ºï¼š sofaboot-dependencies:3.2.0 spring-boot-dependencies:2.1.0.RELEASE nacos-api:0.6.0å’Œnacos-client:0.6.0 å¼•å…¥ä¾èµ–å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647&lt;properties&gt; &lt;sofa.boot.version&gt;3.2.0&lt;/sofa.boot.version&gt; &lt;spring.boot.version&gt;2.1.0.RELEASE&lt;/spring.boot.version&gt; &lt;nacos.version&gt;0.6.0&lt;/nacos.version&gt;&lt;/properties&gt;&lt;dependencyManagement&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-dependencies&lt;/artifactId&gt; &lt;version&gt;$&#123;spring.boot.version&#125;&lt;/version&gt; &lt;scope&gt;import&lt;/scope&gt; &lt;type&gt;pom&lt;/type&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.alipay.sofa&lt;/groupId&gt; &lt;artifactId&gt;sofaboot-dependencies&lt;/artifactId&gt; &lt;version&gt;$&#123;sofa.boot.version&#125;&lt;/version&gt; &lt;scope&gt;import&lt;/scope&gt; &lt;type&gt;pom&lt;/type&gt; &lt;/dependency&gt; &lt;/dependencies&gt;&lt;/dependencyManagement&gt;&lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;com.alipay.sofa&lt;/groupId&gt; &lt;artifactId&gt;healthcheck-sofa-boot-starter&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.alipay.sofa&lt;/groupId&gt; &lt;artifactId&gt;rpc-sofa-boot-starter&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.alibaba.nacos&lt;/groupId&gt; &lt;artifactId&gt;nacos-client&lt;/artifactId&gt; &lt;version&gt;$&#123;nacos.version&#125;&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.alibaba.nacos&lt;/groupId&gt; &lt;artifactId&gt;nacos-api&lt;/artifactId&gt; &lt;version&gt;$&#123;nacos.version&#125;&lt;/version&gt; &lt;/dependency&gt;&lt;/dependencies&gt; ç¼–å†™æœåŠ¡æä¾›æ–¹å’ŒæœåŠ¡æ¶ˆè´¹æ–¹ä»£ç  è¿™é‡Œæœ‰ä¸€ä¸ªå‰æï¼Œéœ€è¦å¯åŠ¨ä¸€ä¸ªNacos-Serverï¼Œä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œä½¿ç”¨å•æœºæ¨¡å¼æœ¬åœ°å¯åŠ¨å³å¯ï¼Œé‚£ä¹ˆæœåŠ¡æ³¨å†Œçš„åœ°å€å°±æ˜¯http://127.0.0.1:8848ã€‚ç¤ºä¾‹é¡¹ç›®çš„ç»“æ„å¦‚ä¸‹ï¼š 123456789101112131415161718â”œâ”€srcâ”‚ â””â”€mainâ”‚ â”œâ”€javaâ”‚ â”‚ â””â”€clubâ”‚ â”‚ â””â”€throwableâ”‚ â”‚ â”œâ”€clientâ”‚ â”‚ â”‚ ClientApplication.javaâ”‚ â”‚ â”‚ â”‚ â”‚ â”œâ”€contractâ”‚ â”‚ â”‚ HelloService.javaâ”‚ â”‚ â”‚ â”‚ â”‚ â””â”€serverâ”‚ â”‚ DefaultHelloService.javaâ”‚ â”‚ ServerApplication.javaâ”‚ â”‚ â”‚ â””â”€resourcesâ”‚ application-client.propertiesâ”‚ application-server.properties å…¶ä¸­contractä¸ºå¥‘çº¦åŒ…ï¼Œå¯ä»¥æä¾›ç»™å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä½¿ç”¨ï¼ŒclientåŒ…é‡Œé¢ç¼–å†™å®¢æˆ·ç«¯ï¼ˆcomsumerï¼‰çš„ä»£ç ï¼Œè€ŒserveråŒ…é‡Œé¢ç¼–å†™æœåŠ¡ç«¯ï¼ˆproviderï¼‰çš„ä»£ç ã€‚ å¥‘çº¦æ¥å£HelloServiceå¾ˆç®€å•ï¼š 1234public interface HelloService &#123; String sayHello(String name);&#125; æœåŠ¡æä¾›æ–¹éœ€è¦å®ç°æ­¤æ¥å£ï¼Œå®ç°ç±»æ˜¯DefaultHelloServiceï¼š 1234567891011@Service@SofaService(interfaceType = HelloService.class, bindings = &#123; @SofaServiceBinding(bindingType = \"bolt\")&#125;)public class DefaultHelloService implements HelloService &#123; @Override public String sayHello(String name) &#123; return String.format(\"%s say hello!\", name); &#125;&#125; è¿™é‡Œä½¿ç”¨çš„æœåŠ¡åè®®ç»‘å®šç±»å‹ä¸ºboltï¼Œæ˜¯å®˜æ–¹ç¤ºä¾‹å»ºè®®çš„åè®®ï¼Œå½“ç„¶è¿˜æœ‰dubboã€httpç­‰ç­‰ï¼Œå¯ä»¥æ··åˆé…ç½®ã€‚æ¥ç€ç¼–å†™æœåŠ¡æä¾›æ–¹å¯åŠ¨ç±»ServerApplicationï¼š 1234567@SpringBootApplication(scanBasePackages = &#123;\"club.throwable.server\", \"club.throwable.contract\"&#125;)public class ServerApplication &#123; public static void main(String[] args) &#123; SpringApplication.run(ServerApplication.class, args); &#125;&#125; æœåŠ¡æä¾›æ–¹åº”ç”¨çš„é…ç½®æ–‡ä»¶application-server.propertieså¦‚ä¸‹ï¼š 1234spring.application.name=sofa-rpc-providerserver.port=9092# ç”¨Nacosåšæ³¨å†Œä¸­å¿ƒcom.alipay.sofa.rpc.registry-address=nacos://127.0.0.1:8848 ä½¿ç”¨spring.profiles.active=serverå¯åŠ¨ServerApplicationï¼Œå¯åŠ¨æˆåŠŸåç”¨æµè§ˆå™¨æ‰“å¼€Nacos-Consoleï¼š å¯è§ç›®å‰sofa-rpc-provideræœåŠ¡å·²ç»æˆåŠŸæ³¨å†Œåˆ°Nacos-Serverã€‚æ¥ç€ç¼–å†™å®¢æˆ·ç«¯ä»£ç ï¼Œä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œæ‰€æœ‰çš„ä»£ç ç¼–å†™åœ¨å¯åŠ¨ç±»ClientApplicationï¼š 12345678910111213141516@Slf4j@SpringBootApplication(scanBasePackages = &#123;\"club.throwable.client\", \"club.throwable.contract\"&#125;)public class ClientApplication implements CommandLineRunner &#123; @SofaReference(binding = @SofaReferenceBinding(bindingType = \"bolt\")) private HelloService helloService; public static void main(String[] args) &#123; SpringApplication.run(ClientApplication.class, args); &#125; @Override public void run(String... args) throws Exception &#123; log.info(\"è°ƒç”¨HelloService#sayHello(),ç»“æœ:&#123;&#125;\", helloService.sayHello(\"throwable\")); &#125;&#125; æœåŠ¡æ¶ˆè´¹æ–¹çš„é…ç½®æ–‡ä»¶application-client.propertieså¦‚ä¸‹ï¼š 1234spring.application.name=sofa-rpc-consumerserver.port=9091# ç”¨Nacosåšæ³¨å†Œä¸­å¿ƒcom.alipay.sofa.rpc.registry-address=nacos://127.0.0.1:8848 ä½¿ç”¨spring.profiles.active=clientå¯åŠ¨ClientApplicationï¼Œå¯åŠ¨å®Œæˆåæ§åˆ¶å°è¾“å‡ºï¼š 12020-01-02 17:07:58.782 INFO 2900 --- [main] club.throwable.client.ClientApplication : è°ƒç”¨HelloService#sayHello(),ç»“æœ:throwable say hello! åŸºæœ¬åŸç†å¦‚ä¸‹ï¼š å°ç»“ SOFABootã€SOFARpcåº•å±‚ä¾èµ–äºSpringå®¹å™¨ï¼Œå¯ä»¥è·ŸéšSpringBootç‰ˆæœ¬è¿­ä»£å‡çº§ï¼Œåº•å±‚é€šè®¯ä½¿ç”¨Nettyï¼Œåœ¨æ€§èƒ½ä¸Šæœ‰ä¿éšœï¼Œè€Œä¸”çœŸæ­£åšåˆ°äº†å…¼å®¹HTTPã€Dubboã€Service Meshï¼ˆåé¢åº”è¯¥ä¼šæŠŠService Meshä½œä¸ºé€šè®¯åè®®è¿›è¡Œå…¼å®¹ï¼‰ç­‰ç­‰åè®®ï¼Œå¯¹äºå¼€å‘è€…è€Œè¨€ç›¸å¯¹å‹å¥½ï¼Œå­¦ä¹ æˆæœ¬ä½ï¼Œåšåˆ°çœŸæ­£çš„å¼€ç®±æ·»åŠ å°‘é‡é…ç½®å³å¯ä½¿ç”¨ã€‚é™¤äº†ç›®å‰å‘ç°ä¾èµ–ç‰ˆæœ¬çš„é—®é¢˜ï¼Œæš‚æ—¶æ²¡æœ‰å¤§çš„å‘ï¼Œå°å°é²œçš„æ„Ÿè§‰è¿˜æ˜¯æŒºä¸é”™çš„ã€‚ ç¤ºä¾‹é¡¹ç›®ï¼š sofa-boot-nacos ï¼ˆæœ¬æ–‡å®Œ c-1-d e-a-20200101ï¼‰","categories":[{"name":"SOFAStack","slug":"SOFAStack","permalink":"http://throwable.club/blog/categories/SOFAStack/"},{"name":"Nacos","slug":"SOFAStack/Nacos","permalink":"http://throwable.club/blog/categories/SOFAStack/Nacos/"}],"tags":[{"name":"SOFAStack","slug":"SOFAStack","permalink":"http://throwable.club/blog/tags/SOFAStack/"},{"name":"Nacos","slug":"Nacos","permalink":"http://throwable.club/blog/tags/Nacos/"}]},{"title":"SpringBootä½¿ç”¨Nacosè¿›è¡ŒæœåŠ¡æ³¨å†Œå‘ç°ä¸é…ç½®ç®¡ç†","slug":"spring-boot-nacos-get-start","date":"2020-01-01T15:20:41.000Z","updated":"2020-01-02T03:31:05.133Z","comments":true,"path":"2020/01/01/spring-boot-nacos-get-start/","link":"","permalink":"http://throwable.club/2020/01/01/spring-boot-nacos-get-start/","excerpt":"å‰æ æœ€è¿‘ç”±äºä¸šåŠ¡å‘å±•ï¼Œéœ€è¦è°ƒç ”ä¸€å¥—å®Œå–„å’Œä¸»æµçš„åŸºç¡€æ¶æ„ï¼Œè¿›è¡Œä¸­å°åŒ–ï¼ˆå¾®æœåŠ¡ï¼‰çš„å®æ–½ï¼Œè€ƒè™‘åˆ°æŠ€æœ¯æ ˆåˆ‡æ¢åˆ°SOFAStackã€‚æ—¢ç„¶æ•´ä¸ªä½“ç³»éƒ½åˆ‡æ¢åˆ°èš‚èšé‡‘æœçš„æŠ€æœ¯æ ˆï¼Œé‚£ä¹ˆè‡ªç„¶è€ƒè™‘ä¸€äº›åŸºç¡€ç»„ä»¶å¦‚æœåŠ¡æ³¨å†Œå‘ç°ã€é…ç½®ç®¡ç†ç­‰éƒ½åˆ‡æ¢ä¸ºé˜¿é‡Œçš„æŠ€æœ¯æ ˆã€‚è€ƒè™‘åˆ°ç›®å‰æ¯”è¾ƒçƒ­çš„æœåŠ¡å‘ç°ç»„ä»¶æ˜¯Nacosï¼Œéœ€è¦è°ƒç ”SpringBootæœåŠ¡æ¥å…¥Nacosçš„å¯è¡Œæ€§ï¼Œä¸ºä»¥åå¼ºåˆ¶è¦æ±‚æ–°æœåŠ¡ä½¿ç”¨SOFAStack + Nacosçš„æŠ€æœ¯æ ˆè¿›è¡ŒæœåŠ¡å¼€å‘æ‰“ä¸‹åŸºç¡€ã€‚","text":"å‰æ æœ€è¿‘ç”±äºä¸šåŠ¡å‘å±•ï¼Œéœ€è¦è°ƒç ”ä¸€å¥—å®Œå–„å’Œä¸»æµçš„åŸºç¡€æ¶æ„ï¼Œè¿›è¡Œä¸­å°åŒ–ï¼ˆå¾®æœåŠ¡ï¼‰çš„å®æ–½ï¼Œè€ƒè™‘åˆ°æŠ€æœ¯æ ˆåˆ‡æ¢åˆ°SOFAStackã€‚æ—¢ç„¶æ•´ä¸ªä½“ç³»éƒ½åˆ‡æ¢åˆ°èš‚èšé‡‘æœçš„æŠ€æœ¯æ ˆï¼Œé‚£ä¹ˆè‡ªç„¶è€ƒè™‘ä¸€äº›åŸºç¡€ç»„ä»¶å¦‚æœåŠ¡æ³¨å†Œå‘ç°ã€é…ç½®ç®¡ç†ç­‰éƒ½åˆ‡æ¢ä¸ºé˜¿é‡Œçš„æŠ€æœ¯æ ˆã€‚è€ƒè™‘åˆ°ç›®å‰æ¯”è¾ƒçƒ­çš„æœåŠ¡å‘ç°ç»„ä»¶æ˜¯Nacosï¼Œéœ€è¦è°ƒç ”SpringBootæœåŠ¡æ¥å…¥Nacosçš„å¯è¡Œæ€§ï¼Œä¸ºä»¥åå¼ºåˆ¶è¦æ±‚æ–°æœåŠ¡ä½¿ç”¨SOFAStack + Nacosçš„æŠ€æœ¯æ ˆè¿›è¡ŒæœåŠ¡å¼€å‘æ‰“ä¸‹åŸºç¡€ã€‚ Nacosç®€ä»‹ ä¸‹é¢çš„ç®€ä»‹æ¥æºäºNacosçš„å®˜ç½‘ï¼š Nacosè‡´åŠ›äºå¸®åŠ©æ‚¨å‘ç°ã€é…ç½®å’Œç®¡ç†å¾®æœåŠ¡ã€‚Nacosæä¾›äº†ä¸€ç»„ç®€å•æ˜“ç”¨çš„ç‰¹æ€§é›†ï¼Œå¸®åŠ©æ‚¨å¿«é€Ÿå®ç°åŠ¨æ€æœåŠ¡å‘ç°ã€æœåŠ¡é…ç½®ã€æœåŠ¡å…ƒæ•°æ®åŠæµé‡ç®¡ç†ã€‚ Nacoså¸®åŠ©æ‚¨æ›´æ•æ·å’Œå®¹æ˜“åœ°æ„å»ºã€äº¤ä»˜å’Œç®¡ç†å¾®æœåŠ¡å¹³å°ã€‚Nacosæ˜¯æ„å»ºä»¥æœåŠ¡ä¸ºä¸­å¿ƒçš„ç°ä»£åº”ç”¨æ¶æ„ï¼ˆä¾‹å¦‚å¾®æœåŠ¡èŒƒå¼ã€äº‘åŸç”ŸèŒƒå¼ï¼‰çš„æœåŠ¡åŸºç¡€è®¾æ–½ã€‚ Nacosåœ°å›¾ï¼š Nacosç”Ÿæ€å›¾ï¼š ä»Nacosæä¾›çš„å‘å±•åœ°å›¾æ¥çœ‹ï¼Œå®ƒåŸºæœ¬æä¾›äº†ç›®å‰å¾®æœåŠ¡å®æ–½ä¸­ä¸€äº›æ ¸å¿ƒé—®é¢˜ï¼šç›‘æ§ã€æœåŠ¡å‘ç°æ³¨å†Œã€é…ç½®ç°åº¦å‘å¸ƒã€é…ç½®å›æ»šç­‰ç­‰ã€‚å¦å¤–ï¼Œå®ƒåœ¨ç”Ÿæ€ä¸Šèƒ½å¤Ÿèå…¥ç›®å‰ä¸»æµçš„K8Sã€Dockerã€SpringCloudã€Consulã€Zookeeperç­‰ç­‰ï¼ˆæœ‰ç‚¹åƒå±è”½åº•å±‚ç»†èŠ‚ï¼Œåªéœ€å°‘é‡é…ç½®å°±å¯ä»¥åˆ‡æ¢åº•å±‚æ¶æ„çš„å®ç°ï¼‰ï¼Œè¿™ä¸€ç‚¹ååˆ†é‡è¦ã€‚ç›®å‰Nacosåœ¨é˜¿é‡Œäº‘ä¸Šæä¾›äº†å•†ç”¨ç‰ˆæœ¬ï¼ˆè®°å¾—æœ‰å‰è¾ˆè¯´è¿‡å¼€æºçš„ç»ˆæç›®æ ‡å°±æ˜¯å•†ç”¨ï¼Œå¤§æ¦‚å¦‚æ­¤ï¼‰ã€‚å¦‚æœåœ¨é¡¹ç›®ä¸­ä½¿ç”¨çš„æ˜¯SpringCloudå…¨å®¶æ¡¶ï¼Œå¼•å…¥Nacosä»¥åŠå®ƒå’ŒSpringCloudä¹‹é—´çš„èƒ¶æ°´å±‚ï¼Œå¯ä»¥å®Œå…¨æ›¿ä»£Eurekaç»„ä»¶çš„åŠŸèƒ½ï¼Œæ›¿ä»£å’Œå¼ºåŒ–éƒ¨åˆ†Spring Cloud Configçš„åŠŸèƒ½ã€‚ NacosæœåŠ¡éƒ¨ç½² Nacos-Serveréƒ¨ç½²ç›¸å¯¹ç®€å•ï¼Œå®ƒçš„å‘å¸ƒç‰ˆæœ¬è§Githubçš„Releasesé¡µé¢ã€‚ä¸‹è½½å®Œæˆåè¿›è¡Œè§£å‹ï¼ŒWindowsç³»ä¸‹å¯åŠ¨Nacos-Serveråªéœ€è¿›å…¥è§£å‹åçš„${è§£å‹ç›®å½•}\\nacos\\binç›®å½•ï¼Œæ‰§è¡Œstartup.cmdå³å¯ï¼ŒæœåŠ¡å¯åŠ¨æˆåŠŸçš„ç»“æœå¦‚ä¸‹ï¼š å•æœºæ¨¡å¼åœ¨ä¸ä¿®æ”¹é…ç½®çš„å‰æä¸‹ç›´æ¥å¯åŠ¨ï¼Œä½¿ç”¨çš„æ˜¯å†…å­˜æ•°æ®åº“ï¼Œé‡å¯åæ•°æ®ä¼šè¢«æ¸…ç©ºã€‚å¦‚æœéœ€è¦æ•°æ®æŒä¹…åŒ–ï¼Œåˆ™éœ€è¦å»ºç«‹æ•°æ®åº“ï¼Œå…·ä½“çš„æ­¥éª¤æ˜¯ï¼š å»ºè¡¨çš„è„šæœ¬åœ¨${è§£å‹ç›®å½•}\\nacos\\confç›®å½•ä¸‹ï¼Œè§schema.sqlå’Œnacos-mysql.sqlä¸¤ä¸ªæ–‡ä»¶ã€‚ è‡ªè¡Œé€šè¿‡å»ºè¡¨çš„è„šæœ¬å»ºç«‹æ•°æ®åº“ã€‚ éœ€è¦æŒ‡å®šæ•°æ®åº“ï¼Œåˆ™éœ€è¦ä¿®æ”¹${è§£å‹ç›®å½•}\\nacos\\conf\\application.propertiesï¼Œåœ¨æ–‡ä»¶çš„å°¾éƒ¨è¿½åŠ æ•°æ®æºçš„è¿æ¥é…ç½®ï¼Œä¸‹é¢æ˜¯å®˜æ–¹ç»™å‡ºçš„å¤šæ•°æ®æºçš„ä¾‹å­ï¼š 123456# éœ€è¦ç¡®ä¿å¤šä¸ªæ•°æ®æºçš„ç”¨æˆ·åå’Œå¯†ç ä¸€è‡´db.num=2db.url.0=jdbc:mysql://11.162.196.16:3306/nacos_devtest?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=truedb.url.1=jdbc:mysql://11.163.152.9:3306/nacos_devtest?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=truedb.user=nacos_devtestdb.password=nacos æµ‹è¯•è·å–å·²ç»æ³¨å†Œçš„æœåŠ¡ï¼š 12Î» curl -X GET http://127.0.0.1:8848/nacos/v1/ns/instance/list?serviceName=nacos.naming.serviceName&#123;\"hosts\":[],\"name\":\"DEFAULT_GROUP@@nacos.naming.serviceName\",\"clusters\":\"\"&#125; è®¿é—®http://127.0.0.1:8848/nacoså³å¯æ‰“å¼€Nacos-Consoleï¼Œåˆå§‹çš„ç™»å½•è´¦å·å’Œå¯†ç éƒ½æ˜¯nacosï¼š æ›´å¤šè¿ç»´éƒ¨ç½²ç›¸å…³çš„å†…å®¹è§æ–‡æ¡£è¿ç»´æŒ‡å—ä¸­çš„ä¸€èŠ‚ã€‚ SpirngBootåº”ç”¨ä½¿ç”¨Nacosä½œä¸ºæ³¨å†Œä¸­å¿ƒ SpringBootåº”ç”¨ä½¿ç”¨Nacosä½œä¸ºæ³¨å†Œä¸­å¿ƒéœ€è¦å¼•å…¥ä¾èµ–nacos-discovery-spring-boot-starterï¼Œç¬”è€…ç¼–å†™æœ¬æ–‡çš„æ—¶å€™ï¼ˆ2020-01-01ï¼‰ï¼Œè¯¥ä¾èµ–çš„æœ€æ–°ç‰ˆæœ¬ä¸º0.2.4ï¼Œå¯¹åº”äºSpringBootçš„ç‰ˆæœ¬ä¸º2.0.3.RELEASEï¼Œå¼•å…¥å¦‚ä¸‹ä¾èµ–ï¼š 12345678910111213141516171819202122&lt;dependencyManagement&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-dependencies&lt;/artifactId&gt; &lt;version&gt;2.0.3.RELEASE&lt;/version&gt; &lt;type&gt;pom&lt;/type&gt; &lt;scope&gt;import&lt;/scope&gt; &lt;/dependency&gt; &lt;/dependencies&gt;&lt;/dependencyManagement&gt;&lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.alibaba.boot&lt;/groupId&gt; &lt;artifactId&gt;nacos-discovery-spring-boot-starter&lt;/artifactId&gt; &lt;version&gt;0.2.4&lt;/version&gt; &lt;/dependency&gt;&lt;/dependencies&gt; ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œç¬”è€…æŠŠæ§åˆ¶å™¨ã€æœåŠ¡æ³¨å†Œçš„ä»£ç éƒ½å†™åœ¨å¯åŠ¨ç±»ProvideApplicationä¸­ï¼š 12345678910111213141516171819202122232425262728@RestController@SpringBootApplication(scanBasePackages = \"club.throwable.provide\")public class ProvideApplication implements CommandLineRunner &#123; @NacosInjected private NamingService namingService; @Value(\"$&#123;spring.application.name&#125;\") private String applicationName; @Value(\"$&#123;server.port&#125;\") private Integer serverPort; public static void main(String[] args) &#123; SpringApplication.run(ProvideApplication.class, args); &#125; @GetMapping(path = \"/hello\") public String hello(@RequestParam(name = \"name\") String name) &#123; return String.format(\"%s say hello!\", name); &#125; @Override public void run(String... args) throws Exception &#123; // é€šè¿‡NamingæœåŠ¡æ³¨å†Œå®ä¾‹åˆ°æ³¨å†Œä¸­å¿ƒ namingService.registerInstance(applicationName, \"127.0.0.1\", serverPort); &#125;&#125; é…ç½®æ–‡ä»¶application-provide.propertieså†…å®¹å¦‚ä¸‹ï¼š 123spring.application.name=provide-serviceserver.port=9092nacos.discovery.server-addr=127.0.0.1:8848 ä½¿ç”¨spring.profiles.active=provideå¯åŠ¨ProvideApplicationï¼Œå¯åŠ¨æˆåŠŸåç”¨æµè§ˆå™¨æ‰“å¼€Nacos-Consoleï¼š æš‚æ—¶å¯çŸ¥æœåŠ¡çš„æä¾›æ–¹å·²ç»æ³¨å†ŒæˆåŠŸã€‚æ¥ç€ç¼–å†™æœåŠ¡çš„æ¶ˆè´¹æ–¹ä»£ç ï¼Œå¼•å…¥çš„æœ€å°ä¾èµ–å’ŒæœåŠ¡æä¾›æ–¹å®Œå…¨ä¸€è‡´ï¼Œç¼–å†™å¯åŠ¨ç±»ConsumeApplicationå¦‚ä¸‹ï¼š 123456789101112131415161718192021@SpringBootApplication(scanBasePackages = \"club.throwable.consume\")public class ConsumeApplication implements CommandLineRunner &#123; @NacosInjected private NamingService namingService; public static void main(String[] args) &#123; SpringApplication.run(ConsumeApplication.class, args); &#125; @Override public void run(String... args) throws Exception &#123; // æ ¹æ®æœåŠ¡åä»æ³¨å†Œä¸­å¿ƒè·å–ä¸€ä¸ªå¥åº·çš„æœåŠ¡å®ä¾‹ Instance instance = namingService.selectOneHealthyInstance(\"provide-service\"); // è¿™é‡Œåªæ˜¯ä¸ºäº†æ–¹ä¾¿æ‰æ–°å»ºRestTemplateå®ä¾‹ RestTemplate template = new RestTemplate(); String url = String.format(\"http://%s:%d/hello?name=throwable\", instance.getIp(), instance.getPort()); String result = template.getForObject(url, String.class); System.out.println(String.format(\"è¯·æ±‚URL:%s,å“åº”ç»“æœ:%s\", url, result)); &#125;&#125; æ¶ˆè´¹æœåŠ¡çš„é…ç½®æ–‡ä»¶application-consume.propertieså†…å®¹å¦‚ä¸‹ï¼š 123spring.application.name=consume-serviceserver.port=9091nacos.discovery.server-addr=127.0.0.1:8848 ä½¿ç”¨spring.profiles.active=consumeå¯åŠ¨ConsumeApplicationï¼ŒCommandLineRunneræ‰§è¡Œå®Œæ¯•åæ§åˆ¶å°æ‰“å°ï¼š 1è¯·æ±‚URL:http://127.0.0.1:9092/hello?name=throwable,å“åº”ç»“æœ:throwable say hello! è¿™ç§æ–¹å¼ä½¿ç”¨èµ·æ¥ä¼šæ„Ÿè§‰æ¨¡æ¿ä»£ç æ¯”è¾ƒå¤šï¼Œä¸å¤Ÿç®€æ´ã€‚å¦‚æœåœ¨SpringCloudä½“ç³»ä¸­ï¼Œç»“åˆFeignå®¢æˆ·ç«¯åˆ™å¯ä»¥çœç•¥è¿™äº›æ¨¡æ¿ä»£ç ã€‚ SpirngBootåº”ç”¨ä½¿ç”¨Nacosç®¡ç†é…ç½® å¦‚æœä½¿ç”¨Nacosè¿›è¡Œé…ç½®ç®¡ç†ï¼Œåˆ™éœ€è¦å¼•å…¥nacos-config-spring-boot-starterä¾èµ–ï¼Œç¬”è€…ç¼–å†™æœ¬æ–‡çš„æ—¶å€™ï¼ˆ2020-01-01ï¼‰ï¼Œè¯¥ä¾èµ–çš„æœ€æ–°ç‰ˆæœ¬ä¸º0.2.4ï¼š 12345&lt;dependency&gt; &lt;groupId&gt;com.alibaba.boot&lt;/groupId&gt; &lt;artifactId&gt;nacos-config-spring-boot-starter&lt;/artifactId&gt; &lt;version&gt;0.2.4&lt;/version&gt;&lt;/dependency&gt; æ–°å»ºä¸€ä¸ªå¯åŠ¨ç±»ConfigApplicationå¦‚ä¸‹ï¼š 1234567891011121314151617@RestController@NacosPropertySource(dataId = \"example\", autoRefreshed = true)@SpringBootApplication(scanBasePackages = \"club.throwable.config\")public class ConfigApplication &#123; @NacosValue(value = \"$&#123;counter:0&#125;\", autoRefreshed = true) public Long counter; public static void main(String[] args) &#123; SpringApplication.run(ConfigApplication.class, args); &#125; @GetMapping(path = \"/get\") public String get() &#123; return String.format(\"Counter value:%d\", counter); &#125;&#125; ç¬”è€…å®šä¹‰äº†ä¸€ä¸ªé•¿æ•´å‹çš„è®¡æ•°å™¨ï¼Œè®¾ç½®äº†autoRefreshedï¼ˆè‡ªåŠ¨åˆ·æ–°ï¼‰ä¸ºtrueï¼Œæ–°å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶application-config.propertiesï¼š 123spring.application.name=config-serviceserver.port=9093nacos.config.server-addr=127.0.0.1:8848 ä½¿ç”¨spring.profiles.active=configå¯åŠ¨ConfigApplicationï¼Œå¯åŠ¨æˆåŠŸåé€šè¿‡CURLè°ƒç”¨ä¸‹é¢çš„æ¥å£ï¼š 12Î» curl -X GET http://127.0.0.1:9093/getCounter value:0 æ¥ç€é€šè¿‡Nacos-Consoleæ·»åŠ ä¸€ä¸ªé…ç½®ï¼š ç‚¹å‡»å‘å¸ƒæŒ‰é’®åå†æ¬¡è°ƒç”¨æ¥å£ï¼š 12Î» curl -X GET http://127.0.0.1:9093/getCounter value:10086 å¯è§è®¡æ•°å™¨çš„å€¼å·²ç»åŠ¨æ€åˆ·æ–°ã€‚é…ç½®é¡¹é‡Œé¢è¿˜æœ‰å¾ˆå¤šé«˜çº§é…ç½®å¦‚ï¼šæŒ‡å®šé…ç½®ç”Ÿæ•ˆçš„æœåŠ¡ã€Betaå‘å¸ƒç­‰ç­‰ï¼Œå¯ä»¥æŒ‰ç…§åˆé€‚çš„åœºæ™¯è¿›è¡Œè®¾ç½®ã€‚ å¦å¤–ï¼ŒNacos Serveræä¾›Open APIä»è€Œå¯ä»¥ä½¿ç”¨HTTPå®¢æˆ·ç«¯å°±å¯ä»¥è½»æ¾è¿›è¡Œé…ç½®æŸ¥è¯¢ã€é…ç½®æ›´æ–°å‘å¸ƒç­‰æ“ä½œï¼ˆç›®å‰è¿™äº›APIæ²¡æœ‰åšé‰´æƒï¼Œç¤¾åŒºä¹Ÿæœ‰äººæ›¾æå‡ºè¿™æ ·ä¼šå¼•å‘å®‰å…¨æ€§é—®é¢˜ï¼ŒNacoså®˜æ–¹å·²ç»ç«‹é¡¹åœ¨åç»­æ–°ç‰ˆæœ¬ä¸­åŠ å…¥é‰´æƒçš„åŠŸèƒ½ï¼Œç›®å‰å»ºè®®å±è”½æˆ–è€…ä»…å…è®¸å†…ç½‘è®¿é—®è¿™äº›Open APIï¼‰ï¼š è·å–é…ç½®ï¼šcurl -X GET http://127.0.0.1:8848/nacos/v1/cs/configs?dataId=${DATA_ID}&amp;group=${GROUP} å‘å¸ƒé…ç½®ï¼šcurl -X POST http://127.0.0.1:8848/nacos/v1/cs/configs?dataId=${DATA_ID}&amp;group=${GROUP}&amp;content=${CONFIG_CONTENT} å°ç»“ æœ¬æ–‡åªæ˜¯ç®€å•ä»‹ç»äº†SpringBootä¸­ä½¿ç”¨Nacosä½œä¸ºæ³¨å†Œä¸­å¿ƒä»¥åŠè¿›è¡Œé…ç½®ç®¡ç†ã€‚Nacosé¡¹ç›®Githubä»“åº“å½“å‰ï¼ˆ2020-01-01ï¼‰çš„staræ•°å·²ç»æ¥è¿‘10000ï¼Œç¤¾åŒºä¹Ÿååˆ†æ´»è·ƒï¼ŒIssueså’Œäº¤æµç¾¤çš„å“åº”éƒ½ååˆ†è¿…é€Ÿã€‚åŠ ä¹‹Netflixçš„éƒ¨åˆ†å¼€æºäº§å“å¦‚Eurekaã€Hystrixç­‰å·²ç»åœæ­¢è¿­ä»£ï¼Œä½†Nacosè¿˜åœ¨é£é€Ÿè¿­ä»£ï¼Œç”šè‡³å·²ç»åœ¨é˜¿é‡Œäº‘è¡ç”Ÿå‡ºå•†ä¸šç‰ˆæœ¬ï¼Œæ‰€ä»¥ç¬”è€…è®¤ä¸ºNacoså€¼å¾—ä½¿ç”¨ï¼Œåœ¨ç›¸å¯¹ç†Ÿæ‚‰å®ƒçš„å¤§éƒ¨åˆ†ç‰¹æ€§ä¹‹åä¼šä»˜ä¹‹äºç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ã€‚ å‚è€ƒèµ„æ–™ï¼š Nacosæ–‡æ¡£ æœ¬æ–‡çš„Demoé¡¹ç›®ï¼š spring-boot-nacos ä¸‹ä¸€ç¯‡åšæ–‡ä¼šä»‹ç»ä¸€ä¸‹SOFAStackä¸­åŸºäºSOFABootã€SOFARpcä»¥åŠNacosç­‰ç»„ä»¶ä½œä¸ºåŸºç¡€æ¶æ„æ­å»ºä¸€å¥—å¾®æœåŠ¡çš„è¯¦ç»†è¿‡ç¨‹ã€‚ ï¼ˆæœ¬æ–‡å®Œ c-2-d e-a-20200101 23:11ï¼‰","categories":[{"name":"SpringBoot","slug":"SpringBoot","permalink":"http://throwable.club/blog/categories/SpringBoot/"},{"name":"Nacos","slug":"SpringBoot/Nacos","permalink":"http://throwable.club/blog/categories/SpringBoot/Nacos/"}],"tags":[{"name":"Nacos","slug":"Nacos","permalink":"http://throwable.club/blog/tags/Nacos/"},{"name":"SpringBoot","slug":"SpringBoot","permalink":"http://throwable.club/blog/tags/SpringBoot/"}]},{"title":"èŠèŠJavaå†…çœIntrospector","slug":"java-introspector-usage","date":"2019-12-25T00:45:06.000Z","updated":"2020-01-18T07:07:04.344Z","comments":true,"path":"2019/12/25/java-introspector-usage/","link":"","permalink":"http://throwable.club/2019/12/25/java-introspector-usage/","excerpt":"å‰æ è¿™ç¯‡æ–‡ç« ä¸»è¦åˆ†æä¸€ä¸‹Introspector(å†…çœ)çš„ç”¨æ³•ã€‚Introspectoræ˜¯ä¸€ä¸ªä¸“é—¨å¤„ç†JavaBeançš„å·¥å…·ç±»ï¼Œç”¨æ¥è·å–JavaBeané‡Œæè¿°ç¬¦å·ï¼Œå¸¸ç”¨çš„JavaBeançš„æè¿°ç¬¦å·ç›¸å…³ç±»æœ‰BeanInfoã€PropertyDescriptorï¼ŒMethodDescriptorã€BeanDescriptorã€EventSetDescriptorå’ŒParameterDescriptorã€‚ä¸‹é¢ä¼šæ…¢æ…¢åˆ†æè¿™äº›ç±»çš„ä½¿ç”¨æ–¹å¼ï¼Œä»¥åŠIntrospectorçš„ä¸€äº›ç‰¹ç‚¹ã€‚","text":"å‰æ è¿™ç¯‡æ–‡ç« ä¸»è¦åˆ†æä¸€ä¸‹Introspector(å†…çœ)çš„ç”¨æ³•ã€‚Introspectoræ˜¯ä¸€ä¸ªä¸“é—¨å¤„ç†JavaBeançš„å·¥å…·ç±»ï¼Œç”¨æ¥è·å–JavaBeané‡Œæè¿°ç¬¦å·ï¼Œå¸¸ç”¨çš„JavaBeançš„æè¿°ç¬¦å·ç›¸å…³ç±»æœ‰BeanInfoã€PropertyDescriptorï¼ŒMethodDescriptorã€BeanDescriptorã€EventSetDescriptorå’ŒParameterDescriptorã€‚ä¸‹é¢ä¼šæ…¢æ…¢åˆ†æè¿™äº›ç±»çš„ä½¿ç”¨æ–¹å¼ï¼Œä»¥åŠIntrospectorçš„ä¸€äº›ç‰¹ç‚¹ã€‚ JavaBeanæ˜¯ä»€ä¹ˆ JavaBeanæ˜¯ä¸€ç§ç‰¹æ®Šï¼ˆå…¶å®è¯´æ™®é€šä¹Ÿå¯ä»¥ï¼Œä¹Ÿä¸æ˜¯ååˆ†ç‰¹æ®Šï¼‰çš„ç±»ï¼Œä¸»è¦ç”¨äºä¼ é€’æ•°æ®ä¿¡æ¯ï¼Œè¿™ç§ç±»ä¸­çš„æ–¹æ³•ä¸»è¦ç”¨äºè®¿é—®ç§æœ‰çš„å­—æ®µï¼Œä¸”æ–¹æ³•åç¬¦åˆæŸç§å‘½åè§„åˆ™ï¼ˆå­—æ®µéƒ½æ˜¯ç§æœ‰ï¼Œæ¯ä¸ªå­—æ®µå…·å¤‡Setterå’ŒGetteræ–¹æ³•ï¼Œæ–¹æ³•å’Œå­—æ®µå‘½åæ»¡è¶³é¦–å­—æ¯å°å†™é©¼å³°å‘½åè§„åˆ™ï¼‰ã€‚å¦‚æœåœ¨ä¸¤ä¸ªæ¨¡å—ä¹‹é—´ä¼ é€’ä¿¡æ¯ï¼Œå¯ä»¥å°†ä¿¡æ¯å°è£…è¿›JavaBeanä¸­ï¼Œè¿™ç§å¯¹è±¡ç§°ä¸ºå€¼å¯¹è±¡(Value Object)æˆ–è€…VOã€‚è¿™äº›ä¿¡æ¯å‚¨å­˜åœ¨ç±»çš„ç§æœ‰å˜é‡ä¸­ï¼Œé€šè¿‡Setterã€Getteræ–¹æ³•è·å¾—ã€‚JavaBeançš„ä¿¡æ¯åœ¨Introspectoré‡Œå¯¹åº”çš„æ¦‚å¿µæ˜¯BeanInfoï¼Œå®ƒåŒ…å«äº†JavaBeanæ‰€æœ‰çš„Descriptor(æè¿°ç¬¦)ï¼Œä¸»è¦æœ‰PropertyDescriptorï¼ŒMethodDescriptor(MethodDescriptoré‡Œé¢åŒ…å«ParameterDescriptor)ã€BeanDescriptorå’ŒEventSetDescriptorã€‚ å±æ€§Fieldå’Œå±æ€§æè¿°PropertiesDescriptorçš„åŒºåˆ« å¦‚æœæ˜¯ä¸¥æ ¼çš„JavaBean(Fieldåç§°ä¸é‡å¤ï¼Œå¹¶ä¸”Fieldå…·å¤‡Setterå’ŒGetteræ–¹æ³•)ï¼Œå®ƒçš„PropertyDescriptorä¼šé€šè¿‡è§£æSetterå’ŒGetteræ–¹æ³•ï¼Œåˆå¹¶è§£æç»“æœï¼Œæœ€ç»ˆå¾—åˆ°å¯¹åº”çš„PropertyDescriptorå®ä¾‹ã€‚æ‰€ä»¥PropertyDescriptoråŒ…å«äº†å±æ€§åç§°å’Œå±æ€§çš„Setterå’ŒGetteræ–¹æ³•(å¦‚æœå­˜åœ¨çš„è¯)ã€‚ å†…çœIntrospectorå’Œåå°„Reflectionçš„åŒºåˆ« Reflectionï¼šåå°„å°±æ˜¯è¿è¡Œæ—¶è·å–ä¸€ä¸ªç±»çš„æ‰€æœ‰ä¿¡æ¯ï¼Œå¯ä»¥è·å–åˆ°ç±»çš„æ‰€æœ‰å®šä¹‰çš„ä¿¡æ¯ï¼ˆåŒ…æ‹¬æˆå‘˜å˜é‡ï¼Œæˆå‘˜æ–¹æ³•ï¼Œæ„é€ å™¨ç­‰ï¼‰å¯ä»¥æ“çºµç±»çš„å­—æ®µã€æ–¹æ³•ã€æ„é€ å™¨ç­‰éƒ¨åˆ†ã€‚å¯ä»¥æƒ³è±¡ä¸ºé•œé¢åå°„æˆ–è€…ç…§é•œå­ï¼Œè¿™æ ·çš„æ“ä½œæ˜¯å¸¦æœ‰å®¢è§‚è‰²å½©çš„ï¼Œä¹Ÿå°±æ˜¯åå°„è·å–åˆ°çš„ç±»ä¿¡æ¯æ˜¯å¿…å®šæ­£ç¡®çš„ã€‚ Introspectorï¼šå†…çœåŸºäºåå°„å®ç°ï¼Œä¸»è¦ç”¨äºæ“ä½œJavaBeanï¼ŒåŸºäºJavaBeançš„è§„èŒƒè¿›è¡ŒBeanä¿¡æ¯æè¿°ç¬¦çš„è§£æï¼Œä¾æ®äºç±»çš„Setterå’ŒGetteræ–¹æ³•ï¼Œå¯ä»¥è·å–åˆ°ç±»çš„æè¿°ç¬¦ã€‚å¯ä»¥æƒ³è±¡ä¸ºâ€œè‡ªæˆ‘åçœâ€ï¼Œè¿™æ ·çš„æ“ä½œå¸¦æœ‰ä¸»è§‚çš„è‰²å½©ï¼Œä¸ä¸€å®šæ˜¯æ­£ç¡®çš„(å¦‚æœä¸€ä¸ªç±»ä¸­çš„å±æ€§æ²¡æœ‰Setterå’ŒGetteræ–¹æ³•ï¼Œæ— æ³•ä½¿ç”¨å†…çœ)ã€‚ å¸¸ç”¨çš„å†…çœç›¸å…³ç±» ä¸»è¦ä»‹ç»ä¸€ä¸‹å‡ ä¸ªæ ¸å¿ƒç±»æ‰€æä¾›çš„æ–¹æ³•ã€‚ Introspector Introspectorç±»ä¼¼äºBeanInfoçš„é™æ€å·¥å‚ç±»ï¼Œä¸»è¦æ˜¯æä¾›é™æ€æ–¹æ³•é€šè¿‡Classå®ä¾‹è·å–åˆ°BeanInfoï¼Œå¾—åˆ°BeanInfoä¹‹åï¼Œå°±èƒ½å¤Ÿè·å–åˆ°å…¶ä»–æè¿°ç¬¦ã€‚ä¸»è¦æ–¹æ³•ï¼š public static BeanInfo getBeanInfo(Class&lt;?&gt; beanClass)ï¼šé€šè¿‡Classå®ä¾‹è·å–åˆ°BeanInfoå®ä¾‹ã€‚ BeanInfo BeanInfoæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå…·ä½“å®ç°æ˜¯GenericBeanInfoï¼Œé€šè¿‡è¿™ä¸ªæ¥å£å¯ä»¥è·å–ä¸€ä¸ªç±»çš„å„ç§ç±»å‹çš„æè¿°ç¬¦ã€‚ä¸»è¦æ–¹æ³•ï¼š BeanDescriptor getBeanDescriptor()ï¼šè·å–JavaBeanæè¿°ç¬¦ã€‚ EventSetDescriptor[] getEventSetDescriptors()ï¼šè·å–JavaBeançš„æ‰€æœ‰çš„EventSetDescriptorã€‚ PropertyDescriptor[] getPropertyDescriptors()ï¼šè·å–JavaBeançš„æ‰€æœ‰çš„PropertyDescriptorã€‚ MethodDescriptor[] getMethodDescriptors()ï¼šè·å–JavaBeançš„æ‰€æœ‰çš„MethodDescriptorã€‚ è¿™é‡Œè¦æ³¨æ„ä¸€ç‚¹ï¼Œé€šè¿‡BeanInfo#getPropertyDescriptors()è·å–åˆ°çš„PropertyDescriptoræ•°ç»„ä¸­ï¼Œé™¤äº†Beanå±æ€§çš„ä¹‹å¤–ï¼Œè¿˜ä¼šå¸¦æœ‰ä¸€ä¸ªå±æ€§åä¸ºclassçš„PropertyDescriptorå®ä¾‹ï¼Œå®ƒçš„æ¥æºæ˜¯Classçš„getClassæ–¹æ³•ï¼Œå¦‚æœä¸éœ€è¦è¿™ä¸ªå±æ€§é‚£ä¹ˆæœ€å¥½åˆ¤æ–­åè¿‡æ»¤ã€‚ PropertyDescriptor PropertyDescriptorç±»è¡¨ç¤ºJavaBeanç±»é€šè¿‡å­˜å‚¨å™¨(Setterå’ŒGetter)å¯¼å‡ºä¸€ä¸ªå±æ€§ï¼Œå®ƒåº”è¯¥æ˜¯å†…çœä½“ç³»ä¸­æœ€å¸¸è§çš„ç±»ã€‚ä¸»è¦æ–¹æ³•ï¼š synchronized Class&lt;?&gt; getPropertyType()ï¼šè·å¾—å±æ€§çš„Classå¯¹è±¡ã€‚ synchronized Method getReadMethod()ï¼šè·å¾—ç”¨äºè¯»å–å±æ€§å€¼çš„æ–¹æ³•ï¼› synchronized Method getWriteMethod()ï¼šè·å¾—ç”¨äºå†™å…¥å±æ€§å€¼çš„æ–¹æ³•ã€‚ int hashCode()ï¼šè·å–å¯¹è±¡çš„å“ˆå¸Œå€¼ã€‚ synchronized void setReadMethod(Method readMethod)ï¼šè®¾ç½®ç”¨äºè¯»å–å±æ€§(Getter)å€¼çš„æ–¹æ³•ã€‚ synchronized void setWriteMethod(Method writeMethod)ï¼šè®¾ç½®ç”¨äºå†™å…¥å±æ€§å€¼(Setter)çš„æ–¹æ³•ã€‚ ä¸¾ä¸ªä¾‹å­ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546public class Main &#123; public static void main(String[] args) throws Exception &#123; BeanInfo beanInfo = Introspector.getBeanInfo(Person.class); PropertyDescriptor[] propertyDescriptors = beanInfo.getPropertyDescriptors(); for (PropertyDescriptor propertyDescriptor : propertyDescriptors) &#123; if (!\"class\".equals(propertyDescriptor.getName())) &#123; System.out.println(propertyDescriptor.getName()); System.out.println(propertyDescriptor.getWriteMethod().getName()); System.out.println(propertyDescriptor.getReadMethod().getName()); System.out.println(\"=======================\"); &#125; &#125; &#125; public static class Person &#123; private Long id; private String name; private Integer age; public Long getId() &#123; return id; &#125; public void setId(Long id) &#123; this.id = id; &#125; public String getName() &#123; return name; &#125; public void setName(String name) &#123; this.name = name; &#125; public Integer getAge() &#123; return age; &#125; public void setAge(Integer age) &#123; this.age = age; &#125; &#125;&#125; è¾“å‡ºç»“æœï¼š 123456789101112agesetAgegetAge=======================idsetIdgetId=======================namesetNamegetName======================= ä¸æ­£å½“ä½¿ç”¨Introspectorä¼šå¯¼è‡´å†…å­˜æº¢å‡º å¦‚æœæ¡†æ¶æˆ–è€…ç¨‹åºç”¨åˆ°äº†JavaBeans Introspectorï¼Œé‚£ä¹ˆå°±ç›¸å½“äºå¯ç”¨äº†ä¸€ä¸ªç³»ç»Ÿçº§åˆ«çš„ç¼“å­˜ï¼Œè¿™ä¸ªç¼“å­˜ä¼šå­˜æ”¾ä¸€äº›æ›¾åŠ è½½å¹¶åˆ†æè¿‡çš„Javabeançš„å¼•ç”¨ï¼Œå½“webæœåŠ¡å™¨å…³é—­çš„æ—¶å€™ï¼Œç”±äºè¿™ä¸ªç¼“å­˜ä¸­å­˜æ”¾ç€è¿™äº›Javabeançš„å¼•ç”¨ï¼Œæ‰€ä»¥åƒåœ¾å›æ”¶å™¨ä¸èƒ½å¯¹Webå®¹å™¨ä¸­çš„JavaBeanå¯¹è±¡è¿›è¡Œå›æ”¶ï¼Œå¯¼è‡´å†…å­˜è¶Šæ¥è¶Šå¤§ã€‚è¿˜æœ‰ä¸€ç‚¹å€¼å¾—æ³¨æ„ï¼Œæ¸…é™¤Introspectorç¼“å­˜çš„å”¯ä¸€æ–¹å¼æ˜¯åˆ·æ–°æ•´ä¸ªç¼“å­˜ç¼“å†²åŒºï¼Œè¿™æ˜¯å› ä¸ºJDKæ²¡æ³•åˆ¤æ–­å“ªäº›æ˜¯å±äºå½“å‰çš„åº”ç”¨çš„å¼•ç”¨ï¼Œæ‰€ä»¥åˆ·æ–°æ•´ä¸ªIntrospectorç¼“å­˜ç¼“å†²åŒºä¼šå¯¼è‡´æŠŠæœåŠ¡å™¨çš„æ‰€æœ‰åº”ç”¨çš„Introspectorç¼“å­˜éƒ½åˆ æ‰ã€‚Springä¸­æä¾›çš„org.springframework.web.util.IntrospectorCleanupListenerå°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå®ƒä¼šåœ¨WebæœåŠ¡å™¨åœæ­¢çš„æ—¶å€™ï¼Œæ¸…ç†ä¸€ä¸‹è¿™ä¸ªIntrospectorç¼“å­˜ï¼Œä½¿é‚£äº›Javabeanèƒ½è¢«åƒåœ¾å›æ”¶å™¨æ­£ç¡®å›æ”¶ã€‚ ä¹Ÿå°±æ˜¯è¯´JDKçš„Introspectorç¼“å­˜ç®¡ç†æ˜¯æœ‰ä¸€å®šç¼ºé™·çš„ã€‚ä½†æ˜¯å¦‚æœä½¿ç”¨åœ¨Springä½“ç³»åˆ™ä¸ä¼šå‡ºç°è¿™ç§é—®é¢˜ï¼Œå› ä¸ºSpringæŠŠIntrospectorç¼“å­˜çš„ç®¡ç†ç§»äº¤åˆ°Springè‡ªèº«è€Œä¸æ˜¯JDKï¼ˆæˆ–è€…åœ¨Webå®¹å™¨é”€æ¯åå®Œå…¨ä¸ç®¡ï¼‰ï¼Œåœ¨åŠ è½½å¹¶åˆ†æå®Œæ‰€æœ‰ç±»ä¹‹åï¼Œä¼šé’ˆå¯¹ç±»åŠ è½½å™¨å¯¹Introspectorç¼“å­˜è¿›è¡Œæ¸…ç†ï¼Œé¿å…å†…å­˜æ³„æ¼çš„é—®é¢˜ï¼Œè¯¦æƒ…å¯ä»¥çœ‹CachedIntrospectionResultså’ŒSpringBootåˆ·æ–°ä¸Šä¸‹æ–‡çš„æ–¹æ³•AbstractApplicationContext#refresh()ä¸­finallyä»£ç å—ä¸­å­˜åœ¨æ¸…ç†ç¼“å­˜çš„æ–¹æ³•AbstractApplicationContext#resetCommonCaches();ã€‚ä½†æ˜¯æœ‰å¾ˆå¤šç¨‹åºå’Œæ¡†æ¶åœ¨ä½¿ç”¨äº†JavaBeans Introspectorä¹‹åï¼Œéƒ½æ²¡æœ‰è¿›è¡Œæ¸…ç†å·¥ä½œï¼Œæ¯”å¦‚Quartzã€Strutsç­‰ï¼Œè¿™ç±»æ“ä½œä¼šæˆä¸ºå†…å­˜æ³„æ¼çš„éšæ‚£ã€‚ å°ç»“ åœ¨æ ‡å‡†çš„JavaBeanä¸­ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨Introspectorä½“ç³»è§£æJavaBeanï¼Œä¸»è¦æ˜¯æ–¹ä¾¿ä½¿ç”¨åå°„ä¹‹å‰çš„æ—¶å€™å¿«é€Ÿè·å–åˆ°JavaBeançš„Setterå’ŒGetteræ–¹æ³•ã€‚ åœ¨Springä½“ç³»ä¸­ï¼Œä¸ºäº†é˜²æ­¢JDKå¯¹å†…çœä¿¡æ¯çš„ç¼“å­˜æ— æ³•è¢«åƒåœ¾å›æ”¶æœºåˆ¶å›æ”¶å¯¼è‡´å†…å­˜æº¢å‡ºï¼Œä¸»è¦çš„æ“ä½œé™¤äº†å¯ä»¥é€šè¿‡é…ç½®IntrospectorCleanupListeneré¢„é˜²ï¼Œè¿˜æœ‰å¦å¤–ä¸€ç§æ–¹å¼ï¼Œå°±æ˜¯é€šè¿‡CachedIntrospectionResultsç±»è‡ªè¡Œç®¡ç†Introspectorä¸­çš„ç¼“å­˜(è¿™ç§æ–¹å¼æ‰æ˜¯ä¼˜é›…çš„æ–¹å¼ï¼Œè¿™æ ·å¯ä»¥é¿å…åˆ·æ–°æ•´ä¸ªIntrospectorçš„ç¼“å­˜ç¼“å†²åŒºè€Œå¯¼è‡´å…¶ä»–åº”ç”¨çš„Introspectorä¹Ÿè¢«æ¸…ç©º)ï¼Œä¹Ÿå°±æ˜¯æŠŠJdkè‡ªè¡Œç®¡ç†çš„Introspectorç›¸å…³ç¼“å­˜äº¤ç»™Springè‡ªå·±å»ç®¡ç†ã€‚åœ¨SpringBootåˆ·æ–°ä¸Šä¸‹æ–‡çš„æ–¹æ³•AbstractApplicationContext#refresh()ä¸­finallyä»£ç å—ä¸­å­˜åœ¨æ¸…ç†ç¼“å­˜çš„æ–¹æ³•AbstractApplicationContext#resetCommonCaches();ï¼Œé‡Œé¢è°ƒç”¨åˆ°çš„CachedIntrospectionResults#clearClassLoader(getClassLoader())æ–¹æ³•å°±æ˜¯æ¸…ç†æŒ‡å®šçš„ClassLoaderä¸‹çš„æ‰€æœ‰Introspectorä¸­çš„ç¼“å­˜çš„å¼•ç”¨ã€‚ ï¼ˆæœ¬æ–‡å®Œ e-a-20191225 c-1-d æ›´æ–°äº†åšå®¢ä¸»é¢˜ï¼Œæ„Ÿè§‰æ¯”ä»¥å‰å¥½çœ‹ä¸€ç‚¹ç‚¹â€¦ï¼‰","categories":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/categories/Java/"},{"name":"Introspector","slug":"Java/Introspector","permalink":"http://throwable.club/blog/categories/Java/Introspector/"}],"tags":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/tags/Java/"},{"name":"Introspector","slug":"Introspector","permalink":"http://throwable.club/blog/tags/Introspector/"}]},{"title":"Goè¯­è¨€åŸºæœ¬ç¯å¢ƒå˜é‡ä¸ä¾èµ–ç®¡ç†","slug":"golang-module-usage","date":"2019-12-22T16:29:00.000Z","updated":"2019-12-22T16:36:18.310Z","comments":true,"path":"2019/12/23/golang-module-usage/","link":"","permalink":"http://throwable.club/2019/12/23/golang-module-usage/","excerpt":"å‰æ æœ€è¿‘å¼€å§‹ç³»ç»Ÿå­¦ä¹ ä¸€ä¸‹Golangè¿™ä¹ˆæ–°è¯­è¨€ï¼Œè®°å½•ä¸€ä¸‹å®ƒçš„åŸºæœ¬ç¯å¢ƒå˜é‡é…ç½®ä»¥åŠä¾èµ–ç®¡ç†æ–¹å¼ã€‚ç¼–å†™æœ¬æ–‡çš„æ—¶å€™ä½¿ç”¨çš„Golangç‰ˆæœ¬ä¸ºgo1.13.5 windows/amd64ï¼Œå…¶ä»–ç‰ˆæœ¬ä¸ä¸€å®šä¿è¯é€‚åˆæœ¬æ–‡çš„å†…å®¹ã€‚å› ä¸ºä¹ æƒ¯ï¼Œå¯èƒ½æœ‰æ—¶å€™æŠŠGoè¯­è¨€ç§°ä¸ºGoï¼Œæœ‰æ—¶å€™ç§°ä¸ºGolangã€‚","text":"å‰æ æœ€è¿‘å¼€å§‹ç³»ç»Ÿå­¦ä¹ ä¸€ä¸‹Golangè¿™ä¹ˆæ–°è¯­è¨€ï¼Œè®°å½•ä¸€ä¸‹å®ƒçš„åŸºæœ¬ç¯å¢ƒå˜é‡é…ç½®ä»¥åŠä¾èµ–ç®¡ç†æ–¹å¼ã€‚ç¼–å†™æœ¬æ–‡çš„æ—¶å€™ä½¿ç”¨çš„Golangç‰ˆæœ¬ä¸ºgo1.13.5 windows/amd64ï¼Œå…¶ä»–ç‰ˆæœ¬ä¸ä¸€å®šä¿è¯é€‚åˆæœ¬æ–‡çš„å†…å®¹ã€‚å› ä¸ºä¹ æƒ¯ï¼Œå¯èƒ½æœ‰æ—¶å€™æŠŠGoè¯­è¨€ç§°ä¸ºGoï¼Œæœ‰æ—¶å€™ç§°ä¸ºGolangã€‚ ç†è§£ä¸€ä¸‹Golangçš„ç¯å¢ƒå˜é‡ å®‰è£…å®ŒGolangä¹‹åï¼Œå¯ä»¥é€šè¿‡go envå‘½ä»¤æŸ¥çœ‹ç¯å¢ƒå˜é‡é…ç½®ï¼Œä¸‹é¢æ˜¯ç¬”è€…æ‰§è¡Œæ­¤å‘½ä»¤çš„ç»“æœï¼š 123456789101112131415161718192021222324252627282930313233Î» go envset GO111MODULE=set GOARCH=amd64set GOBIN=set GOCACHE=C:\\Users\\doge\\AppData\\Local\\go-buildset GOENV=C:\\Users\\doge\\AppData\\Roaming\\go\\envset GOEXE=.exeset GOFLAGS=set GOHOSTARCH=amd64set GOHOSTOS=windowsset GONOPROXY=set GONOSUMDB=set GOOS=windowsset GOPATH=C:\\Users\\doge\\goset GOPRIVATE=set GOPROXY=https://goproxy.cn,directset GOROOT=I:\\Environment\\Goset GOSUMDB=sum.golang.orgset GOTMPDIR=set GOTOOLDIR=I:\\Environment\\Go\\pkg\\tool\\windows_amd64set GCCGO=gccgoset AR=arset CC=gccset CXX=g++set CGO_ENABLED=1set GOMOD=set CGO_CFLAGS=-g -O2set CGO_CPPFLAGS=set CGO_CXXFLAGS=-g -O2set CGO_FFLAGS=-g -O2set CGO_LDFLAGS=-g -O2set PKG_CONFIG=pkg-configset GOGCCFLAGS=-m64 -mthreads -fmessage-length=0 -fdebug-prefix-map=C:\\Users\\doge\\AppData\\Local\\Temp\\go-build779409438=/tmp/go-build -gno-record-gcc-switches åœ¨æ—¥å¸¸å¼€å‘ä¸­ï¼Œæˆ‘ä»¬éœ€è¦é‡ç‚¹å…³æ³¨GOPROXYã€GOROOTã€GOPATHå’ŒGOBINï¼Œå…¶ä»–é…ç½®é¡¹å¯ä»¥åœ¨éœ€è¦çš„æ—¶å€™å†æŸ¥è¯¢æ–‡æ¡£è¿›è¡Œé…ç½®ã€‚ GOPROXY GOPROXYå°±æ˜¯è®¾ç½®Golangçš„å…¨å±€ä»£ç†ã€‚åœ¨ä¸‹è½½ä¾èµ–åŒ…çš„æ—¶å€™ï¼Œä¸€èˆ¬æ˜¯è®¿é—®githubçš„ä»“åº“ï¼Œå›½å†…çš„ç¯å¢ƒå¾ˆå®¹æ˜“è¢«å¢™ï¼Œæ‰€ä»¥æœ€å¥½è®¾ç½®ä¸€ä¸ªé€Ÿåº¦å¿«çš„ä»£ç†ã€‚Goåœ¨æ­¤ç‰ˆæœ¬ä¸­GOPROXYçš„é»˜è®¤å€¼ä¸ºhttps://proxy.golang.orgï¼Œå›½å†…æ˜¯æ— æ³•è®¿é—®çš„ã€‚å› æ­¤ï¼Œè¿™é‡Œæ¨èä½¿ç”¨ä¸ƒç‰›äº‘çš„ä»£ç†https://goproxy.cnï¼š 1go env -w GOPROXY=https://goproxy.cn,direct è®¾ç½®å®Œæ­¤ä»£ç†ä¹‹åï¼Œä¸‹è½½ä¾èµ–çš„é€Ÿåº¦å°±èƒ½ç›¸å¯¹æ­£å¸¸ã€‚ GOROOT GOROOTå…¶å®å°±æ˜¯Golangå®‰è£…çš„ç»å¯¹è·¯å¾„ï¼Œä¾‹å¦‚ç¬”è€…æŠŠä»–å®‰è£…åœ¨I:\\Environment\\Goç›®å½•ä¸‹ï¼Œæ‰€ä»¥ï¼š 1234Î» go env...set GOROOT=I:\\Environment\\Go... GOROOTéœ€è¦åŠ å…¥åˆ°ç³»ç»Ÿå˜é‡Pathé‡Œé¢ï¼Œæ·»åŠ æˆåŠŸåæ‰èƒ½åœ¨å‘½ä»¤è¡Œä½¿ç”¨go [Command]ã€‚ GOPATHå’ŒGOBIN GOPATHå¯ä»¥ç®€å•ç†è§£ä¸ºå·¥ä½œç›®å½•ï¼Œå¦‚æœç”¨è¿‡Eclipseï¼Œé‚£ä¹ˆGOPATHå¯ä»¥ç±»æ¯”ä¸ºEclipseä¸­çš„WorkSpaceçš„æ¦‚å¿µã€‚GOPATHç›®å½•çº¦å®šç”±ä¸‰ä¸ªå­ç›®å½•ï¼š 1234$GOPATH - src --- å­˜æ”¾æºä»£ç ï¼Œgo runã€go installç­‰å‘½ä»¤å°±æ˜¯åœ¨å½“å‰çš„å·¥ä½œè·¯å¾„ä¸­æ‰§è¡Œï¼ˆä¹Ÿå°±æ˜¯è¿™äº›å‘½ä»¤æ‰§è¡Œçš„ç›®æ ‡æ–‡ä»¶å¤¹å°±æ˜¯è¿™ä¸ªsrcæ–‡ä»¶å¤¹ï¼‰ - pkg --- å­˜æ”¾ç¼–è¯‘æ—¶ç”Ÿæˆçš„ä¸­é—´æ–‡ä»¶ - bin --- å­˜æ”¾ç¼–è¯‘åç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶ GOPATHå˜é‡å¯ä»¥è®¾ç½®å¤šä¸ªå€¼ï¼Œå¤šä¸ªå€¼ä¹‹é—´ä½¿ç”¨ç‰¹å®šçš„åˆ†éš”ç¬¦éš”å¼€ï¼Œä¾‹å¦‚åœ¨Windowsç³»ç»Ÿï¼Œåˆ†éš”ç¬¦æ˜¯è‹±æ–‡çš„åˆ†å·;ï¼š 1234Î» go env...set GOPATH=C:\\Users\\doge\\go;I:G-Projects... å€¼å¾—æ³¨æ„çš„æ˜¯ï¼šgo getå‘½ä»¤ä¸‹è½½çš„ä¾èµ–åŒ…ä¼šä¸‹è½½åœ¨GOPATHæŒ‡å®šçš„ç¬¬ä¸€ä¸ªå€¼å¯¹åº”çš„ç›®å½•ä¸­ï¼Œä¹Ÿå°±æ˜¯$Users/$User/goç›®å½•ä¸‹ã€‚ GOBINç”¨äºæŒ‡å®šgo installç›®æ ‡ä¿å­˜è·¯å¾„ï¼Œç›®çš„æ˜¯é¿å…å°†æ‰€æœ‰å·¥ä½œç©ºé—´çš„binè·¯å¾„æ·»åŠ åˆ°PATHç¯å¢ƒå˜é‡ä¸­ï¼ˆå› æ­¤åœ¨ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶æ—¶ï¼Œå°½é‡å¿½ç•¥binã€pkgï¼Œå»ºè®®ç›´æ¥åœ¨srcï¼Œæˆ–è€…å…·ä½“çš„å­åŒ…ä¸‹åˆ›å»ºä»£ç ä»“åº“ï¼‰ã€‚äºæ­¤ç›¸åçš„åšæ³•ï¼Œå°±æ˜¯åœ¨Linuxæˆ–è€…Unixç³»ç»Ÿä¸­ï¼Œå¯ä»¥åœ¨PATHä¸­æ·»åŠ export PATH=$PATH:${GOPATH//://bin:}/binä¸‹æŠŠæ¯ä¸ªGOPATHä¸‹çš„binéƒ½åŠ å…¥åˆ°PATHä¸­ã€‚ é‡ç‚¹æ¥äº†ï¼šModuleçš„å‡ºç°ï¼Œå°±æ˜¯ä¸ºäº†å¼±åŒ–GOPATHçš„æ¦‚å¿µï¼Œä½¿ç”¨Moduleå»ç®¡ç†é¡¹ç›®çš„ä¾èµ–ï¼Œé‚£ä¹ˆå¯ä»¥åŸºæœ¬å¿½ç•¥GOPATHçš„åŸæœ‰çš„åŠŸèƒ½ã€‚ Golangæä¾›çš„å‘½ä»¤ å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œgo helpæŸ¥çœ‹Goæä¾›çš„å‘½ä»¤è¡Œå·¥å…·ï¼š è¿™é‡Œå¯ä»¥å…³æ³¨ä¸€ä¸‹å‰é¢ä¸€ä¸ªæ ç›®çš„åŸºç¡€å‘½ä»¤å³å¯ï¼š å‘½ä»¤ åŠŸèƒ½ ä½¿ç”¨ä¾‹å­ go bug æŠ¥å‘Šä¸€ä¸ªBUGï¼Œä¼šè°ƒç”¨ç³»ç»Ÿé»˜è®¤æµè§ˆå™¨æ‰“å¼€æäº¤BUGæŠ¥å‘Šçš„é¡µé¢ go bug go build ç¼–è¯‘æ‰€æœ‰çš„åŒ…å’Œä¾èµ– go build [-o output] [-i] [build flags] [packages] go clean æ¸…ç†æ‰§è¡Œå…¶å®ƒå‘½ä»¤æ—¶äº§ç”Ÿçš„ä¸€äº›æ–‡ä»¶å’Œç›®å½• go clean [clean flags] [build flags] [packages] go doc æ‰“å°é™„äºGoè¯­è¨€ç¨‹åºå®ä½“ä¸Šçš„æ–‡æ¡£ go doc pkg.app go env å±•ç¤ºGoçš„ç¯å¢ƒå˜é‡é…ç½® go env go fix æŠŠæŒ‡å®šä»£ç åŒ…çš„æ‰€æœ‰Goè¯­è¨€æºç æ–‡ä»¶ä¸­çš„æ—§ç‰ˆæœ¬ä»£ç ä¿®æ­£ä¸ºæ–°ç‰ˆæœ¬çš„ä»£ç ï¼Œè¿™é‡Œçš„ç‰ˆæœ¬æ˜¯æŒ‡Goçš„ç‰ˆæœ¬ - go fmt æ ¼å¼åŒ–æŒ‡å®šä»£ç ä¸ºç»Ÿä¸€çš„é£æ ¼ - go generate æ‰«æä¸å½“å‰åŒ…ç›¸å…³çš„æºä»£ç æ–‡ä»¶ï¼Œæ‰¾å‡ºæ‰€æœ‰åŒ…å«&quot;//go:generate&quot;çš„ç‰¹æ®Šæ³¨é‡Šï¼Œæå–å¹¶æ‰§è¡Œè¯¥ç‰¹æ®Šæ³¨é‡Šåé¢çš„å‘½ä»¤ï¼Œå‘½ä»¤ä¸ºå¯æ‰§è¡Œç¨‹åº - go get æ ¹æ®è¦æ±‚å’Œå®é™…æƒ…å†µä»äº’è”ç½‘ä¸Šä¸‹è½½æˆ–æ›´æ–°æŒ‡å®šçš„ä»£ç åŒ…åŠå…¶ä¾èµ–åŒ…ï¼Œå¹¶å¯¹å®ƒä»¬è¿›è¡Œç¼–è¯‘å’Œå®‰è£… go get github.com/x/y go install ç¼–è¯‘å¹¶å®‰è£…æŒ‡å®šçš„ä»£ç åŒ…åŠå®ƒä»¬çš„ä¾èµ–åŒ… go install go list åˆ—å‡ºæŒ‡å®šçš„ä»£ç åŒ…çš„ä¿¡æ¯ - go mod Moduleç›¸å…³å‘½ä»¤ è§ä¸‹æ–‡åˆ†æ go run ç¼–è¯‘å¹¶è¿è¡Œå‘½ä»¤æºç æ–‡ä»¶ - go test å¯¹Goè¯­è¨€ç¼–å†™çš„ç¨‹åºè¿›è¡Œæµ‹è¯•ï¼Œç®€å•æ¥è¯´å°±æ˜¯è¿è¡Œæµ‹è¯•ä»£ç  go test mine_test.go go tool è¿è¡Œç‰¹å®šçš„Goæä¾›çš„å·¥å…· go tool fix go version æ‰“å°Golangçš„ç‰ˆæœ¬ go version go vet æ£€æŸ¥Goè¯­è¨€æºç ä¸­é™æ€é”™è¯¯ go vet å¦‚æœæƒ³äº†è§£æ¯ä¸ªå‘½ä»¤çš„è¯¦ç»†ä½¿ç”¨æ•™ç¨‹å¯ä»¥é€šè¿‡go help å‘½ä»¤Topicå¾—åˆ°å¯¹åº”çš„ç»“æœï¼Œæ›´å¤šæˆ–æ›´è¯¦ç»†çš„ç”¨æ³•åé¢åœ¨æ¢ç©¶Golangç¼–ç å’ŒåŸºç¡€çŸ¥è¯†çš„æ—¶å€™å†æ·±å…¥å±•å¼€ã€‚ Golangä¾èµ–ç®¡ç† ä¹‹å‰è·Ÿä¸€ä¸ªå‰è¾ˆè®¨è®ºå¯¹æ¯”Javaå’ŒGolangçš„ç”Ÿæ€çš„æ—¶å€™ï¼Œç¬”è€…æŒ‡å‡ºäº†Golangåœ¨å·¥ç¨‹åŒ–æ–¹é¢å¯¹æ¯”Javaæ„Ÿè§‰åå¼±ï¼Œæœ€å¸¸è§çš„ä¾‹å­å°±æ˜¯Javaæœ‰å…¨çƒé€šç”¨çš„ä¾èµ–ä¸­å¤®ä»“åº“ï¼Œå›½å†…ä¹Ÿæœ‰é˜¿é‡Œçš„Mavenä»“åº“åšåŠ é€Ÿï¼Œå¼€å‘è€…å¯ä»¥å¾ˆè½»æ˜“é€šè¿‡GAVï¼ˆGroupIdã€ArtifactIdå’ŒVersionï¼‰å»æ‹‰å–ä¸åŒç‰ˆæœ¬çš„ä¾èµ–åŒ…ï¼Œè¿™ä¸€ç‚¹åœ¨Golangä¸­å±•ç°å‡ºäº†å¼±åŠ¿ã€‚å›æƒ³èµ·æ¥æ—¶é—´å·²ç»è¿‡å»ä¸€å¹´äº†ï¼ŒGolangä¹Ÿåœ¨è¿›æ­¥ï¼Œä¾èµ–ç®¡ç†ä¹Ÿå¼€å§‹å®Œå–„ï¼Œç¬”è€…çš„è¿‡å»ç‹­éš˜çš„æ€ç»´ä¹Ÿæ”¹å˜äº†ï¼ˆå…¶å®ä¸èƒ½æ€»ç”¨Javaçš„è§’åº¦å»å­¦ä¹ å…¶ä»–ç¼–ç¨‹è¯­è¨€ï¼Œå¦åˆ™å¾ˆéš¾ä½“ä¼šåˆ°å…¶ä»–è¯­è¨€çš„ç²¾é«“ï¼Œç”šè‡³æœ‰æ—¶å€™ä¼šè¡ç”Ÿä¸€äº›å¥‡æ€ªçš„æƒ³æ³•ï¼Œä¾‹å¦‚ï¼šæ€»æ˜¯æƒ³Golangä¸­æ˜¯å¦å­˜åœ¨ç±»ä¼¼Javaä¸­çš„Springæˆ–è€…Mybatisè¿™ç±»æ¡†æ¶ï¼‰ã€‚ Golangä»1.11ç‰ˆæœ¬ä¹‹åå¼•å…¥äº†Moduleä½œä¸ºä¾èµ–ç®¡ç†å·¥å…·ï¼Œä»1.13æˆ–è€…ä¹‹åçš„ç‰ˆæœ¬ï¼ŒModuleä½œä¸ºå®˜æ–¹é»˜è®¤çš„ä¾èµ–ç®¡ç†å·¥å…·ï¼Œå¯¹åº”çš„å‘½ä»¤æ˜¯go mod [Command]ã€‚ModuleåŠŸèƒ½çš„å¯ç”¨ä¸å¦ç”±ç¯å¢ƒå˜é‡ä¸­çš„GO111MODULEå†³å®šï¼Œè€ŒGO111MODULEæœ‰ä¸‰ä¸ªå¯é€‰å€¼ï¼š GO111MODULE=offï¼Œç¦ç”¨ModuleåŠŸèƒ½ï¼Œåˆ™ç¼–è¯‘çš„æ—¶å€™ä¼šä»GOPATHå’Œvendoræ–‡ä»¶å¤¹ä¸­æŸ¥æ‰¾ä¾èµ–åŒ…ã€‚ GO111MODULE=onï¼Œå¯ç”¨ModuleåŠŸèƒ½ï¼Œåˆ™ç¼–è¯‘çš„æ—¶å€™ä¼šå¿½ç•¥GOPATHå’Œvendoræ–‡ä»¶å¤¹ï¼Œç¼–è¯‘æ‰€éœ€çš„ä¾èµ–ç”±go.modæ–‡ä»¶æè¿°ï¼Œä»æœ¬åœ°ç¼“å­˜$GOPATH/pkg/modç›®å½•ä¸­åŠ è½½ã€‚ GO111MODULE=autoï¼Œè‡ªåŠ¨åˆ¤æ–­æ˜¯å¦å¯ç”¨ModuleåŠŸèƒ½ï¼Œæ­¤é€‰é¡¹æ˜¯é»˜è®¤å€¼ï¼Œå½“é¡¹ç›®åœ¨$GOPATH/srcå¤–ä¸”é¡¹ç›®æ ¹ç›®å½•æœ‰go.modæ–‡ä»¶æ—¶ï¼Œåˆ™å¯ç”¨ModuleåŠŸèƒ½ã€‚ Moduleå­˜åœ¨çš„æ„ä¹‰æ˜¯ï¼šæ²¡æœ‰å¿…è¦åœ¨GOPATHä¸­åˆ›å»ºé¡¹ç›®ï¼Œç®¡ç†é¡¹ç›®ä¾èµ–çš„ç¬¬ä¸‰æ–¹åŒ…ä¿¡æ¯å¯ä»¥ç‹¬ç«‹ç®¡ç†ã€‚go modæ”¯æŒçš„æ‰€æœ‰å‘½ä»¤å¦‚ä¸‹ï¼š go modå‘½ä»¤ åŠŸèƒ½ go mod download ä¸‹è½½ä¾èµ–çš„æ¨¡å—åˆ°æœ¬åœ°ç¼“å­˜ä¸­ï¼Œæœ¬åœ°ç¼“å­˜çš„é»˜è®¤è·¯å¾„æ˜¯$GOPATH/pkg/modç›®å½• go mod edit ç¼–è¾‘go.modæ–‡ä»¶ go mod graph æ‰“å°æ¨¡å—ä¾èµ–å›¾ go mod init åŸºäºå½“å‰æ–‡ä»¶å¤¹åˆå§‹åŒ–ä¸€ä¸ªæ–°æ¨¡å—,ï¼Œåˆ›å»ºgo.modæ–‡ä»¶ go mod tidy æ·»åŠ ç¼ºå¤±çš„æ¨¡å—ï¼Œç§»é™¤æ— ç”¨çš„æ¨¡å— go mod vendor æŠŠæ‰€æœ‰ä¾èµ–æ‹·è´åˆ°vendoræ–‡ä»¶å¤¹ä¸­ go mod verify æ ¡éªŒä¾èµ–ï¼Œæ£€æŸ¥ä¾èµ–å†…å®¹æ˜¯å¦å’Œé¢„æœŸä¸€è‡´ go mod why è§£é‡Šä¸ºä»€ä¹ˆéœ€è¦å¼•å…¥åŒ…ï¼ˆpackagesï¼‰å’Œæ¨¡å—ï¼ˆmodulesï¼‰ ä½¿ç”¨Moduleè¿›è¡Œä¾èµ–ç®¡ç† å…ˆä½¿ç”¨JetBrains Golandåˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®ï¼Œé¡¹ç›®é‡Œé¢åˆ›å»ºbinã€pkgå’Œsrcä¸‰ä¸ªç›®å½•ï¼š é¡¹ç›®åˆ›å»ºå®Œæˆåï¼Œæ ¹ç›®å½•ä¸­å·²ç»å­˜åœ¨äº†ä¸€ä¸ªgo.modæ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯JetBrains Golandå·²ç»å¸®æˆ‘ä»¬åœ¨å½“å‰ç›®å½•æ‰§è¡Œè¿‡go mod initï¼Œæ–‡ä»¶å†…å®¹æ˜¯ï¼š 1module \"module-sample\" srcç›®å½•ä¸‹å¼•å…¥ä¸€ä¸ªapp.goæ–‡ä»¶ï¼š 123456789101112131415161718192021222324252627package mainimport ( \"fmt\" \"github.com/garyburd/redigo/redis\")func main() &#123; connection, err := redis.Dial(\"tcp\", \"127.0.0.1:6379\", redis.DialDatabase(0)) if nil != err &#123; fmt.Println(\"è¿æ¥åˆ°Rediså¼‚å¸¸\", err) return &#125; defer connection.Close() n, err := connection.Do(\"SET\", \"name\", \"throwable\") if nil != err &#123; fmt.Println(err) &#125; if n == \"OK\" &#123; fmt.Println(\"æ‰§è¡ŒSetå‘½ä»¤æˆåŠŸ\") &#125; value, err := redis.String(connection.Do(\"GET\", \"name\")) if nil != err &#123; fmt.Println(err) &#125; fmt.Println(\"Getå‘½ä»¤æ‰§è¡Œç»“æœ:\", value)&#125; ä¼šå‘ç°ï¼Œæ•´ä¸ªæ–‡ä»¶çš„ä¾èµ–éƒ½æ˜¯æ ‡çº¢çš„ï¼Œä¹Ÿå°±æ˜¯ä¾èµ–æ²¡æœ‰ä¸‹è½½å’Œå¯¼å…¥ï¼š æ­¤æ—¶ä½¿ç”¨go mod tidyè¿›è¡Œä¾èµ–æ•´ç†ï¼Œæ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œå‘ç°æ ¹ç›®å½•ç”Ÿæˆäº†ä¸€ä¸ªæ–°çš„go.sumï¼Œå®ƒç”¨äºè®°å½•é”å®šçš„ä¾èµ–è®°å½•ï¼ˆä¾èµ–çš„åŒ…ã€è·¯å¾„ã€ç‰ˆæœ¬ä»¥åŠå“ˆå¸Œå€¼ï¼‰ã€‚go.sumæ–‡ä»¶å¦‚ä¸‹ï¼š 12github.com/garyburd/redigo v1.6.0 h1:0VruCpn7yAIIu7pWVClQC8wxCJEcG3nyzpMSHKi1PQc=github.com/garyburd/redigo v1.6.0/go.mod h1:NR3MbYisc3/PwhQ00EMzDiPmrwpPxAn5GI05/YaO1SY= è€Œgo.modæ–‡ä»¶ä¹Ÿè¢«ä¿®æ”¹ï¼š 12345module module-samplego 1.13require github.com/garyburd/redigo v1.6.0 ç„¶åä½¿ç”¨go mod downloadä¸‹è½½ä¾èµ–åˆ°æœ¬åœ°ç¼“å­˜ä¸­ï¼Œä¸‹è½½å®Œæˆåï¼Œä½¿ç”¨go mod vendoræŠŠä¾èµ–æ‹·è´åˆ°å½“å‰æ¨¡å—çš„vendorç›®å½•ä¸‹ï¼Œé‚£ä¹ˆåŸæ¥æ ‡çº¢çš„æ–‡ä»¶å°±èƒ½æ­£å¸¸ç¼–è¯‘äº†ã€‚ go modç®¡ç†ä¾èµ–æ”¯æŒè¯­ä¹‰åŒ–ç‰ˆæœ¬å·ï¼Œä¾‹å¦‚ï¼š ä¾èµ–ç‰ˆæœ¬ï¼šfoo@v1.2.3ã€‚ Gitåˆ†æ”¯çš„Tagï¼šfoo@masterã€‚ Gitæäº¤ç‚¹çš„SHA-1å€¼ï¼šfoo@e3702bed2ã€‚ å…¶ä»–å€¼ï¼šå¦‚&lt;=v1.1.1ã€latestç­‰ç­‰ã€‚ go.modæ–‡ä»¶ä¸­å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å…³é”®å­—ï¼š moduleï¼šæ¨¡å—åã€‚ requireï¼šå¼•å…¥æ‰€éœ€ä¾èµ–ï¼Œæ³¨æ„åŒ…åå’Œç‰ˆæœ¬ï¼Œä¾‹å¦‚ï¼š 1require github.com/garyburd/redigo v1.6.0 replaceï¼šæ›¿æ¢ä¾èµ–ï¼Œä¾‹å¦‚ï¼š 12345replace ( golang.org/x/crypto v0.0.0-20180820150726-614d502a4dac =&gt; github.com/golang/crypto v0.0.0-20180820150726-614d502a4dac golang.org/x/net v0.0.0-20180821023952-922f4815f713 =&gt; github.com/golang/net v0.0.0-20180826012351-8a410e7b638d golang.org/x/text v0.3.0 =&gt; github.com/golang/text v0.3.0) indirectï¼šæŒ‡æ˜æ˜¯é—´æ¥å¼•ç”¨ï¼Œä¾‹å¦‚ï¼š 1234require ( github.com/garyburd/redigo v1.6.0 github.com/garyburd/xx v1.0.0 // indirect) å¦å¤–ï¼Œå¯ä»¥å•ç‹¬ä½¿ç”¨go getå‘½ä»¤ä¸‹è½½å¯¹åº”çš„ä¾èµ–ï¼Œè€Œgo mod downloadä¼šä¸‹è½½æ‰€æœ‰ç”¨åˆ°çš„ä¾èµ–ã€‚æœ€åé™„ä¸Šä¸€äº›å°æŠ€å·§ï¼š å‘½ä»¤ åŠŸèƒ½ go mod edit -fmt æ ¼å¼åŒ–go.modæ–‡ä»¶ go mod edit -require=éœ€è¦çš„ä¾èµ– æ·»åŠ ä¾èµ–åˆ°go.modæ–‡ä»¶ go mod edit -droprequire=æŒ‡å®šçš„ä¾èµ– ä»go.modæ–‡ä»¶ç§»é™¤å¯¹åº”çš„ä¾èµ– go mod tidyã€go mod downloadã€go mod vendor ä¸‰ä¸ªå‘½ä»¤ç»„åˆä½¿ç”¨ï¼Œç›¸å½“äºå…¨å±€æ›´æ–°ä¸€æ¬¡æ‰€éœ€çš„ä¾èµ– å¦‚æœç†Ÿç»ƒä½¿ç”¨è¿™äº›å‘½ä»¤ï¼Œé‚£ä¹ˆä¾èµ–ç®¡ç†å°±ä¼šå˜å¾—ç›¸å¯¹å®¹æ˜“ã€‚ å°ç»“ æœ¬æ–‡ç®€å•ä»‹ç»äº†Golangçš„Moduleä¾èµ–ç®¡ç†åŠŸèƒ½ï¼Œè¿™é‡Œç®€å•è®°å½•å‡ ä¸ªè¦ç‚¹ï¼š go mod downloadä¸‹è½½çš„ä¾èµ–åŒ…ä¼šå­˜æ”¾åœ¨Goæœ¬åœ°ç¼“å­˜ä¸­ï¼Œå…·ä½“ä½ç½®æ˜¯$GOPATH/pkg/modï¼ˆè¿™é‡Œçš„GOPATHä¸€èˆ¬æ˜¯å°±æ˜¯å…¨å±€çš„é‚£ä¸ªGOPATHï¼Œå€¼ä¸º$Users/$User/goï¼‰ å¯ç”¨ModuleåŠŸèƒ½åï¼Œæ¨¡å—æ ¹ç›®å½•ç”Ÿæˆä¸€ä¸ªgo.modç”¨äºè®°å½•å½“å‰æ¨¡å—çš„ä¾èµ–å…³ç³»ã€‚ å¯ç”¨ModuleåŠŸèƒ½åï¼Œä¸€æ—¦ä¸‹è½½äº†æ–°çš„ä¾èµ–ï¼Œå°±ä¼šåœ¨æ¨¡å—æ ¹ç›®å½•ç”Ÿæˆä¸€ä¸ªgo.sumç”¨äºè®°å½•è¢«é”å®šçš„ä¾èµ–è®°å½•ã€‚ go.modå’Œgo.sumæœ€ç»ˆå†³å®šäº†ä¸€æ£µé”å®šå¥½çš„ä¾èµ–æ ‘ï¼Œæœ€ç»ˆç¼–è¯‘ä»¥åŠå®‰è£…éƒ½æ˜¯é€šè¿‡è¿™ä¸¤ä¸ªæè¿°æ–‡ä»¶ï¼Œå…³è”åˆ°æœ¬åœ°ç¼“å­˜ä¸‹è½½å¥½çš„ä¾èµ–åŒ…å®Œæˆåç»­çš„å·¥ä½œã€‚ ï¼ˆæœ¬æ–‡å®Œ c-1-d e-a-20191222ï¼‰","categories":[{"name":"Go","slug":"Go","permalink":"http://throwable.club/blog/categories/Go/"},{"name":"Golang","slug":"Go/Golang","permalink":"http://throwable.club/blog/categories/Go/Golang/"}],"tags":[{"name":"Go","slug":"Go","permalink":"http://throwable.club/blog/tags/Go/"},{"name":"Golang","slug":"Golang","permalink":"http://throwable.club/blog/tags/Golang/"}]},{"title":"Mybatisä»£ç ç”Ÿæˆå™¨Mybatis-Generatorä½¿ç”¨è¯¦è§£","slug":"mybatis-generator-usage","date":"2019-12-15T17:06:00.000Z","updated":"2019-12-15T17:07:59.251Z","comments":true,"path":"2019/12/16/mybatis-generator-usage/","link":"","permalink":"http://throwable.club/2019/12/16/mybatis-generator-usage/","excerpt":"å‰æ æœ€è¿‘åœ¨åšåˆ›ä¸šé¡¹ç›®çš„æ—¶å€™å› ä¸ºæœ‰æ¯”è¾ƒå¤šçš„æ–°éœ€æ±‚ï¼Œéœ€è¦é¢‘ç¹åŸºäºDDLç”ŸæˆMybatisé€‚åˆçš„å®ä½“ã€Mapperæ¥å£å’Œæ˜ å°„æ–‡ä»¶ã€‚å…¶ä¸­ï¼Œä»£ç ç”Ÿæˆå™¨æ˜¯MyBatis Generator(MBG)ï¼Œç”¨åˆ°äº†Mybatis-Generator-Coreç›¸å…³ä¾èµ–ï¼Œè¿™é‡Œé€šè¿‡ä¸€ç¯‡æ–‡ç« è¯¦ç»†åœ°åˆ†æè¿™ä¸ªä»£ç ç”Ÿæˆå™¨çš„ä½¿ç”¨æ–¹å¼ã€‚æœ¬æ–‡ç¼–å†™çš„æ—¶å€™ä½¿ç”¨çš„Mybatis-Generatorç‰ˆæœ¬ä¸º1.4.0ï¼Œå…¶ä»–ç‰ˆæœ¬æ²¡æœ‰è¿›è¡Œè¿‡è°ƒç ”ã€‚","text":"å‰æ æœ€è¿‘åœ¨åšåˆ›ä¸šé¡¹ç›®çš„æ—¶å€™å› ä¸ºæœ‰æ¯”è¾ƒå¤šçš„æ–°éœ€æ±‚ï¼Œéœ€è¦é¢‘ç¹åŸºäºDDLç”ŸæˆMybatisé€‚åˆçš„å®ä½“ã€Mapperæ¥å£å’Œæ˜ å°„æ–‡ä»¶ã€‚å…¶ä¸­ï¼Œä»£ç ç”Ÿæˆå™¨æ˜¯MyBatis Generator(MBG)ï¼Œç”¨åˆ°äº†Mybatis-Generator-Coreç›¸å…³ä¾èµ–ï¼Œè¿™é‡Œé€šè¿‡ä¸€ç¯‡æ–‡ç« è¯¦ç»†åœ°åˆ†æè¿™ä¸ªä»£ç ç”Ÿæˆå™¨çš„ä½¿ç”¨æ–¹å¼ã€‚æœ¬æ–‡ç¼–å†™çš„æ—¶å€™ä½¿ç”¨çš„Mybatis-Generatorç‰ˆæœ¬ä¸º1.4.0ï¼Œå…¶ä»–ç‰ˆæœ¬æ²¡æœ‰è¿›è¡Œè¿‡è°ƒç ”ã€‚ å¼•å…¥æ’ä»¶ Mybatis-Generatorçš„è¿è¡Œæ–¹å¼æœ‰å¾ˆå¤šç§ï¼š åŸºäºmybatis-generator-core-x.x.x.jarå’Œå…¶XMLé…ç½®æ–‡ä»¶ï¼Œé€šè¿‡å‘½ä»¤è¡Œè¿è¡Œã€‚ é€šè¿‡Antçš„Taskç»“åˆå…¶XMLé…ç½®æ–‡ä»¶è¿è¡Œã€‚ é€šè¿‡Mavenæ’ä»¶è¿è¡Œã€‚ é€šè¿‡Javaä»£ç å’Œå…¶XMLé…ç½®æ–‡ä»¶è¿è¡Œã€‚ é€šè¿‡Javaä»£ç å’Œç¼–ç¨‹å¼é…ç½®è¿è¡Œã€‚ é€šè¿‡Eclipse Featureè¿è¡Œã€‚ è¿™é‡Œåªä»‹ç»é€šè¿‡Mavenæ’ä»¶è¿è¡Œå’Œé€šè¿‡Javaä»£ç å’Œå…¶XMLé…ç½®æ–‡ä»¶è¿è¡Œè¿™ä¸¤ç§æ–¹å¼ï¼Œä¸¤ç§æ–¹å¼æœ‰ä¸ªç‰¹ç‚¹ï¼šéƒ½è¦æå‰ç¼–å†™å¥½XMLé…ç½®æ–‡ä»¶ã€‚ä¸ªäººæ„Ÿè§‰XMLé…ç½®æ–‡ä»¶ç›¸å¯¹ç›´è§‚ï¼Œåæ–‡ä¼šèŠ±å¤§é‡ç¯‡å¹…å»è¯´æ˜XMLé…ç½®æ–‡ä»¶ä¸­çš„é…ç½®é¡¹åŠå…¶ä½œç”¨ã€‚è¿™é‡Œå…ˆæ³¨æ„ä¸€ç‚¹ï¼šé»˜è®¤çš„é…ç½®æ–‡ä»¶ä¸ºClassPath:generatorConfig.xmlã€‚ é€šè¿‡ç¼–ç å’Œé…ç½®æ–‡ä»¶è¿è¡Œ é€šè¿‡ç¼–ç æ–¹å¼å»è¿è¡Œæ’ä»¶å…ˆéœ€è¦å¼•å…¥mybatis-generator-coreä¾èµ–ï¼Œç¼–å†™æœ¬æ–‡çš„æ—¶å€™æœ€æ–°çš„ç‰ˆæœ¬ä¸ºï¼š 12345&lt;dependency&gt; &lt;groupId&gt;org.mybatis.generator&lt;/groupId&gt; &lt;artifactId&gt;mybatis-generator-core&lt;/artifactId&gt; &lt;version&gt;1.4.0&lt;/version&gt;&lt;/dependency&gt; å‡è®¾ç¼–å†™å¥½çš„XMLé…ç½®æ–‡ä»¶æ˜¯ClassPathä¸‹çš„generator-configuration.xmlï¼Œé‚£ä¹ˆä½¿ç”¨ä»£ç ç”Ÿæˆå™¨çš„ç¼–ç æ–¹å¼å¤§è‡´å¦‚ä¸‹ï¼š 123456789List&lt;String&gt; warnings = new ArrayList&lt;&gt;();// å¦‚æœå·²ç»å­˜åœ¨ç”Ÿæˆè¿‡çš„æ–‡ä»¶æ˜¯å¦è¿›è¡Œè¦†ç›–boolean overwrite = true;File configFile = new File(\"ClassPathè·¯å¾„/generator-configuration.xml\");ConfigurationParser cp = new ConfigurationParser(warnings);Configuration config = cp.parseConfiguration(configFile);DefaultShellCallback callback = new DefaultShellCallback(overwrite);MyBatisGenerator generator = new MyBatisGenerator(config, callback, warnings);generator.generate(null); é€šè¿‡Mavenæ’ä»¶è¿è¡Œ å¦‚æœä½¿ç”¨Mavenæ’ä»¶ï¼Œé‚£ä¹ˆä¸éœ€è¦å¼•å…¥mybatis-generator-coreä¾èµ–ï¼Œåªéœ€è¦å¼•å…¥ä¸€ä¸ªMavençš„æ’ä»¶mybatis-generator-maven-pluginï¼š 1234567891011121314151617181920212223&lt;plugins&gt; &lt;plugin&gt; &lt;groupId&gt;org.mybatis.generator&lt;/groupId&gt; &lt;artifactId&gt;mybatis-generator-maven-plugin&lt;/artifactId&gt; &lt;version&gt;1.4.0&lt;/version&gt; &lt;executions&gt; &lt;execution&gt; &lt;id&gt;Generate MyBatis Artifacts&lt;/id&gt; &lt;goals&gt; &lt;goal&gt;generate&lt;/goal&gt; &lt;/goals&gt; &lt;/execution&gt; &lt;/executions&gt; &lt;configuration&gt; &lt;!-- è¾“å‡ºè¯¦ç»†ä¿¡æ¯ --&gt; &lt;verbose&gt;true&lt;/verbose&gt; &lt;!-- è¦†ç›–ç”Ÿæˆæ–‡ä»¶ --&gt; &lt;overwrite&gt;true&lt;/overwrite&gt; &lt;!-- å®šä¹‰é…ç½®æ–‡ä»¶ --&gt; &lt;configurationFile&gt;$&#123;basedir&#125;/src/main/resources/generator-configuration.xml&lt;/configurationFile&gt; &lt;/configuration&gt; &lt;/plugin&gt;&lt;/plugins&gt; mybatis-generator-maven-pluginçš„æ›´è¯¦ç»†é…ç½®å’Œå¯é€‰å‚æ•°å¯ä»¥å‚è€ƒï¼šRunning With Mavenã€‚æ’ä»¶é…ç½®å®Œæ¯•ä¹‹åï¼Œä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å³å¯è¿è¡Œï¼š 1mvn mybatis-generator:generate XMLé…ç½®æ–‡ä»¶è¯¦è§£ XMLé…ç½®æ–‡ä»¶æ‰æ˜¯Mybatis-Generatorçš„æ ¸å¿ƒï¼Œå®ƒç”¨äºæ§åˆ¶ä»£ç ç”Ÿæˆçš„æ‰€æœ‰è¡Œä¸ºã€‚æ‰€æœ‰éæ ‡ç­¾ç‹¬æœ‰çš„å…¬å…±é…ç½®çš„Keyå¯ä»¥åœ¨mybatis-generator-coreçš„PropertyRegistryç±»ä¸­æ‰¾åˆ°ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç›¸å¯¹å®Œæ•´çš„é…ç½®æ–‡ä»¶çš„æ¨¡æ¿ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;&lt;!DOCTYPE generatorConfiguration PUBLIC \"-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN\" \"http://mybatis.org/dtd/mybatis-generator-config_1_0.dtd\"&gt;&lt;generatorConfiguration&gt; &lt;properties resource=\"db.properties\"/&gt; &lt;classPathEntry location=\"/Program Files/IBM/SQLLIB/java/db2java.zip\" /&gt; &lt;context id=\"DB2Tables\" targetRuntime=\"MyBatis3\"&gt; &lt;jdbcConnection driverClass=\"COM.ibm.db2.jdbc.app.DB2Driver\" connectionURL=\"jdbc:db2:TEST\" userId=\"db2admin\" password=\"db2admin\"&gt; &lt;/jdbcConnection&gt; &lt;plugin type=\"org.mybatis.generator.plugins.SerializablePlugin\"/&gt; &lt;commentGenerator&gt; &lt;property name=\"suppressDate\" value=\"true\"/&gt; &lt;property name=\"suppressAllComments\" value=\"true\"/&gt; &lt;/commentGenerator&gt; &lt;javaTypeResolver&gt; &lt;property name=\"forceBigDecimals\" value=\"false\" /&gt; &lt;/javaTypeResolver&gt; &lt;javaModelGenerator targetPackage=\"test.model\" targetProject=\"\\MBGTestProject\\src\"&gt; &lt;property name=\"enableSubPackages\" value=\"true\" /&gt; &lt;property name=\"trimStrings\" value=\"true\" /&gt; &lt;/javaModelGenerator&gt; &lt;sqlMapGenerator targetPackage=\"test.xml\" targetProject=\"\\MBGTestProject\\src\"&gt; &lt;property name=\"enableSubPackages\" value=\"true\" /&gt; &lt;/sqlMapGenerator&gt; &lt;javaClientGenerator type=\"XMLMAPPER\" targetPackage=\"test.dao\" targetProject=\"\\MBGTestProject\\src\"&gt; &lt;property name=\"enableSubPackages\" value=\"true\" /&gt; &lt;/javaClientGenerator&gt; &lt;table schema=\"DB2ADMIN\" tableName=\"ALLTYPES\" domainObjectName=\"Customer\" &gt; &lt;property name=\"useActualColumnNames\" value=\"true\"/&gt; &lt;generatedKey column=\"ID\" sqlStatement=\"DB2\" identity=\"true\" /&gt; &lt;columnOverride column=\"DATE_FIELD\" property=\"startDate\" /&gt; &lt;ignoreColumn column=\"FRED\" /&gt; &lt;columnOverride column=\"LONG_VARCHAR_FIELD\" jdbcType=\"VARCHAR\" /&gt; &lt;/table&gt; &lt;/context&gt;&lt;/generatorConfiguration&gt; é…ç½®æ–‡ä»¶ä¸­ï¼Œæœ€å¤–å±‚çš„æ ‡ç­¾ä¸º&lt;generatorConfiguration&gt;ï¼Œå®ƒçš„å­æ ‡ç­¾åŒ…æ‹¬ï¼š 0æˆ–è€…1ä¸ª&lt;properties&gt;æ ‡ç­¾ï¼Œç”¨äºæŒ‡å®šå…¨å±€é…ç½®æ–‡ä»¶ï¼Œä¸‹é¢å¯ä»¥é€šè¿‡å ä½ç¬¦çš„å½¢å¼è¯»å–&lt;properties&gt;æŒ‡å®šæ–‡ä»¶ä¸­çš„å€¼ã€‚ 0æˆ–è€…Nä¸ª&lt;classPathEntry&gt;æ ‡ç­¾ï¼Œ&lt;classPathEntry&gt;åªæœ‰ä¸€ä¸ªlocationå±æ€§ï¼Œç”¨äºæŒ‡å®šæ•°æ®æºé©±åŠ¨åŒ…ï¼ˆjaræˆ–è€…zipï¼‰çš„ç»å¯¹è·¯å¾„ï¼Œå…·ä½“é€‰æ‹©ä»€ä¹ˆé©±åŠ¨åŒ…å–å†³äºè¿æ¥ä»€ä¹ˆç±»å‹çš„æ•°æ®æºã€‚ 1æˆ–è€…Nä¸ª&lt;context&gt;æ ‡ç­¾ï¼Œç”¨äºè¿è¡Œæ—¶çš„è§£ææ¨¡å¼å’Œå…·ä½“çš„ä»£ç ç”Ÿæˆè¡Œä¸ºï¼Œæ‰€ä»¥è¿™ä¸ªæ ‡ç­¾é‡Œé¢çš„é…ç½®æ˜¯æœ€é‡è¦çš„ã€‚ ä¸‹é¢åˆ†åˆ«åˆ—ä¸¾å’Œåˆ†æä¸€ä¸‹&lt;context&gt;æ ‡ç­¾å’Œå®ƒçš„ä¸»è¦å­æ ‡ç­¾çš„ä¸€äº›å±æ€§é…ç½®å’ŒåŠŸèƒ½ã€‚ contextæ ‡ç­¾ &lt;context&gt;æ ‡ç­¾åœ¨mybatis-generator-coreä¸­å¯¹åº”çš„å®ç°ç±»ä¸ºorg.mybatis.generator.config.Contextï¼Œå®ƒé™¤äº†å¤§é‡çš„å­æ ‡ç­¾é…ç½®ä¹‹å¤–ï¼Œæ¯”è¾ƒä¸»è¦çš„å±æ€§æ˜¯ï¼š idï¼šContextç¤ºä¾‹çš„å”¯ä¸€IDï¼Œç”¨äºè¾“å‡ºé”™è¯¯ä¿¡æ¯æ—¶å€™ä½œä¸ºå”¯ä¸€æ ‡è®°ã€‚ targetRuntimeï¼šç”¨äºæ‰§è¡Œä»£ç ç”Ÿæˆæ¨¡å¼ã€‚ defaultModelTypeï¼šæ§åˆ¶Domainç±»çš„ç”Ÿæˆè¡Œä¸ºã€‚æ‰§è¡Œå¼•æ“ä¸ºMyBatis3DynamicSqlæˆ–è€…MyBatis3Kotlinæ—¶å¿½ç•¥æ­¤é…ç½®ï¼Œå¯é€‰å€¼ï¼š conditionalï¼šé»˜è®¤å€¼ï¼Œç±»ä¼¼hierarchicalï¼Œä½†æ˜¯åªæœ‰ä¸€ä¸ªä¸»é”®çš„æ—¶å€™ä¼šåˆå¹¶æ‰€æœ‰å±æ€§ç”Ÿæˆåœ¨åŒä¸€ä¸ªç±»ã€‚ flatï¼šæ‰€æœ‰å†…å®¹å…¨éƒ¨ç”Ÿæˆåœ¨ä¸€ä¸ªå¯¹è±¡ä¸­ã€‚ hierarchicalï¼šé”®ç”Ÿæˆä¸€ä¸ªXXKeyå¯¹è±¡ï¼ŒBlobç­‰å•ç‹¬ç”Ÿæˆä¸€ä¸ªå¯¹è±¡ï¼Œå…¶ä»–ç®€å•å±æ€§åœ¨ä¸€ä¸ªå¯¹è±¡ä¸­ã€‚ targetRuntimeå±æ€§çš„å¯é€‰å€¼æ¯”è¾ƒå¤šï¼Œè¿™é‡Œåšä¸ªç®€å•çš„å°ç»“ï¼š å±æ€§ åŠŸèƒ½æè¿° MyBatis3DynamicSql é»˜è®¤å€¼ï¼Œå…¼å®¹JDK8+å’ŒMyBatis 3.4.2+ï¼Œä¸ä¼šç”ŸæˆXMLæ˜ å°„æ–‡ä»¶ï¼Œå¿½ç•¥&lt;sqlMapGenerator&gt;çš„é…ç½®é¡¹ï¼Œä¹Ÿå°±æ˜¯Mapperå…¨éƒ¨æ³¨è§£åŒ–ï¼Œä¾èµ–äºMyBatis Dynamic SQLç±»åº“ MyBatis3Kotlin è¡Œä¸ºç±»ä¼¼äºMyBatis3DynamicSqlï¼Œä¸è¿‡å…¼å®¹Kotlinçš„ä»£ç ç”Ÿæˆ MyBatis3 æä¾›åŸºæœ¬çš„åŸºäºåŠ¨æ€SQLçš„CRUDæ–¹æ³•å’ŒXXXByExampleæ–¹æ³•ï¼Œä¼šç”ŸæˆXMLæ˜ å°„æ–‡ä»¶ MyBatis3Simple æä¾›åŸºæœ¬çš„åŸºäºåŠ¨æ€SQLçš„CRUDæ–¹æ³•ï¼Œä¼šç”ŸæˆXMLæ˜ å°„æ–‡ä»¶ MyBatis3DynamicSqlV1 å·²ç»è¿‡æ—¶ï¼Œä¸æ¨èä½¿ç”¨ ç¬”è€…åå‘äºæŠŠSQLæ–‡ä»¶å’Œä»£ç åˆ†ç¦»ï¼Œæ‰€ä»¥ä¸€èˆ¬é€‰ç”¨MyBatis3æˆ–è€…MyBatis3Simpleã€‚ä¾‹å¦‚ï¼š 1&lt;context id=\"default\" targetRuntime=\"MyBatis3\"&gt; &lt;context&gt;æ ‡ç­¾æ”¯æŒ0æˆ–Nä¸ª&lt;property&gt;æ ‡ç­¾ï¼Œ&lt;property&gt;çš„å¯é€‰å±æ€§æœ‰ï¼š propertyå±æ€§ åŠŸèƒ½æè¿° é»˜è®¤å€¼ å¤‡æ³¨ autoDelimitKeywords æ˜¯å¦ä½¿ç”¨åˆ†éš”ç¬¦å·æ‹¬ä½æ•°æ®åº“å…³é”®å­— false ä¾‹å¦‚MySQLä¸­ä¼šä½¿ç”¨åå¼•å·æ‹¬ä½å…³é”®å­— beginningDelimiter åˆ†éš”ç¬¦å·çš„å¼€å§‹ç¬¦å· &quot; endingDelimiter åˆ†éš”ç¬¦å·çš„ç»“æŸå· &quot; javaFileEncoding æ–‡ä»¶çš„ç¼–ç  ç³»ç»Ÿé»˜è®¤å€¼ æ¥æºäºjava.nio.charset.Charset javaFormatter ç±»åå’Œæ–‡ä»¶æ ¼å¼åŒ–å™¨ DefaultJavaFormatter è§JavaFormatterå’ŒDefaultJavaFormatter targetJava8 æ˜¯å¦JDK8å’Œå¯åŠ¨å…¶ç‰¹æ€§ true kotlinFileEncoding Kotlinæ–‡ä»¶ç¼–ç  ç³»ç»Ÿé»˜è®¤å€¼ æ¥æºäºjava.nio.charset.Charset kotlinFormatter Kotlinç±»åå’Œæ–‡ä»¶æ ¼å¼åŒ–å™¨ DefaultKotlinFormatter è§KotlinFormatterå’ŒDefaultKotlinFormatter xmlFormatter XMLæ–‡ä»¶æ ¼å¼åŒ–å™¨ DefaultXmlFormatter è§XmlFormatterå’ŒDefaultXmlFormatter jdbcConnectionæ ‡ç­¾ &lt;jdbcConnection&gt;æ ‡ç­¾ç”¨äºæŒ‡å®šæ•°æ®æºçš„è¿æ¥ä¿¡æ¯ï¼Œå®ƒåœ¨mybatis-generator-coreä¸­å¯¹åº”çš„å®ç°ç±»ä¸ºorg.mybatis.generator.config.JDBCConnectionConfigurationï¼Œä¸»è¦å±æ€§åŒ…æ‹¬ï¼š å±æ€§ åŠŸèƒ½æè¿° æ˜¯å¦å¿…é¡» driverClass æ•°æ®æºé©±åŠ¨çš„å…¨ç±»å Y connectionURL JDBCçš„è¿æ¥URL Y userId è¿æ¥åˆ°æ•°æ®æºçš„ç”¨æˆ·å N password è¿æ¥åˆ°æ•°æ®æºçš„å¯†ç  N commentGeneratoræ ‡ç­¾ &lt;commentGenerator&gt;æ ‡ç­¾æ˜¯å¯é€‰çš„ï¼Œç”¨äºæ§åˆ¶ç”Ÿæˆçš„å®ä½“çš„æ³¨é‡Šå†…å®¹ã€‚å®ƒåœ¨mybatis-generator-coreä¸­å¯¹åº”çš„å®ç°ç±»ä¸ºorg.mybatis.generator.internal.DefaultCommentGeneratorï¼Œå¯ä»¥é€šè¿‡å¯é€‰çš„typeå±æ€§æŒ‡å®šä¸€ä¸ªè‡ªå®šä¹‰çš„CommentGeneratorå®ç°ã€‚&lt;commentGenerator&gt;æ ‡ç­¾æ”¯æŒ0æˆ–Nä¸ª&lt;property&gt;æ ‡ç­¾ï¼Œ&lt;property&gt;çš„å¯é€‰å±æ€§æœ‰ï¼š propertyå±æ€§ åŠŸèƒ½æè¿° é»˜è®¤å€¼ suppressAllComments æ˜¯å¦ç”Ÿæˆæ³¨é‡Š false suppressDate æ˜¯å¦åœ¨æ³¨é‡Šä¸­æ·»åŠ ç”Ÿæˆçš„æ—¶é—´æˆ³ false dateFormat é…åˆsuppressDateä½¿ç”¨ï¼ŒæŒ‡å®šè¾“å‡ºæ—¶é—´æˆ³çš„æ ¼å¼ java.util.Date#toString() addRemarkComments æ˜¯å¦è¾“å‡ºè¡¨å’Œåˆ—çš„Commentä¿¡æ¯ false ç¬”è€…å»ºè®®ä¿æŒé»˜è®¤å€¼ï¼Œä¹Ÿå°±æ˜¯ä»€ä¹ˆæ³¨é‡Šéƒ½ä¸è¾“å‡ºï¼Œç”Ÿæˆä»£ç å¹²å‡€çš„å®ä½“ã€‚ javaTypeResolveræ ‡ç­¾ &lt;javaTypeResolver&gt;æ ‡ç­¾æ˜¯&lt;context&gt;çš„å­æ ‡ç­¾ï¼Œç”¨äºè§£æå’Œè®¡ç®—æ•°æ®åº“åˆ—ç±»å‹å’ŒJavaç±»å‹çš„æ˜ å°„å…³ç³»ï¼Œè¯¥æ ‡ç­¾åªåŒ…å«ä¸€ä¸ªtypeå±æ€§ï¼Œç”¨äºæŒ‡å®šorg.mybatis.generator.api.JavaTypeResolveræ¥å£çš„å®ç°ç±»ã€‚&lt;javaTypeResolver&gt;æ ‡ç­¾æ”¯æŒ0æˆ–Nä¸ª&lt;property&gt;æ ‡ç­¾ï¼Œ&lt;property&gt;çš„å¯é€‰å±æ€§æœ‰ï¼š propertyå±æ€§ åŠŸèƒ½æè¿° é»˜è®¤å€¼ forceBigDecimals æ˜¯å¦å¼ºåˆ¶æŠŠæ‰€æœ‰çš„æ•°å­—ç±»å‹å¼ºåˆ¶ä½¿ç”¨java.math.BigDecimalç±»å‹è¡¨ç¤º false useJSR310Types æ˜¯å¦æ”¯æŒJSR310ï¼Œä¸»è¦æ˜¯JSR310çš„æ–°æ—¥æœŸç±»å‹ false å¦‚æœuseJSR310Typeså±æ€§è®¾ç½®ä¸ºtrueï¼Œé‚£ä¹ˆç”Ÿæˆä»£ç çš„æ—¶å€™ç±»å‹æ˜ å°„å…³ç³»å¦‚ä¸‹ï¼ˆä¸»è¦é’ˆå¯¹æ—¥æœŸæ—¶é—´ç±»å‹ï¼‰ï¼š æ•°æ®åº“ï¼ˆJDBCï¼‰ç±»å‹ Javaç±»å‹ DATE java.time.LocalDate TIME java.time.LocalTime TIMESTAMP java.time.LocalDateTime TIME_WITH_TIMEZONE java.time.OffsetTime TIMESTAMP_WITH_TIMEZONE java.time.OffsetDateTime å¼•å…¥mybatis-generator-coreåï¼Œå¯ä»¥æŸ¥çœ‹JavaTypeResolverçš„é»˜è®¤å®ç°ä¸ºJavaTypeResolverDefaultImplï¼Œä»å®ƒçš„æºç å¯ä»¥å¾—çŸ¥ä¸€äº›æ˜ å°„å…³ç³»ï¼š 123456BIGINT --&gt; LongBIT --&gt; BooleanINTEGER --&gt; IntegerSMALLINT --&gt; ShortTINYINT --&gt; Byte...... æœ‰äº›æ—¶å€™ï¼Œæˆ‘ä»¬å¸Œæœ›INTEGERã€SMALLINTå’ŒTINYINTéƒ½æ˜ å°„ä¸ºIntegerï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦è¦†ç›–JavaTypeResolverDefaultImplçš„æ„é€ æ–¹æ³•ï¼š 12345678910public class DefaultJavaTypeResolver extends JavaTypeResolverDefaultImpl &#123; public DefaultJavaTypeResolver() &#123; super(); typeMap.put(Types.SMALLINT, new JdbcTypeInformation(\"SMALLINT\", new FullyQualifiedJavaType(Integer.class.getName()))); typeMap.put(Types.TINYINT, new JdbcTypeInformation(\"TINYINT\", new FullyQualifiedJavaType(Integer.class.getName()))); &#125;&#125; æ³¨æ„ä¸€ç‚¹çš„æ˜¯è¿™ç§è‡ªå®šä¹‰å®ç°JavaTypeResolveræ¥å£çš„æ–¹å¼ä½¿ç”¨ç¼–ç¨‹å¼è¿è¡ŒMBGä¼šç›¸å¯¹æ–¹ä¾¿ï¼Œå¦‚æœéœ€è¦ä½¿ç”¨Mavenæ’ä»¶è¿è¡Œï¼Œé‚£ä¹ˆéœ€è¦æŠŠä¸Šé¢çš„DefaultJavaTypeResolverç±»æ‰“åŒ…åˆ°æ’ä»¶ä¸­ã€‚ javaModelGeneratoræ ‡ç­¾ &lt;javaModelGeneratoræ ‡ç­¾&gt;æ ‡ç­¾æ˜¯&lt;context&gt;çš„å­æ ‡ç­¾ï¼Œä¸»è¦ç”¨äºæ§åˆ¶å®ä½“ï¼ˆModelï¼‰ç±»çš„ä»£ç ç”Ÿæˆè¡Œä¸ºã€‚å®ƒæ”¯æŒçš„å±æ€§å¦‚ä¸‹ï¼š å±æ€§ åŠŸèƒ½æè¿° æ˜¯å¦å¿…é¡» å¤‡æ³¨ targetPackage ç”Ÿæˆçš„å®ä½“ç±»çš„åŒ…å Y ä¾‹å¦‚club.throwable.model targetProject ç”Ÿæˆçš„å®ä½“ç±»æ–‡ä»¶ç›¸å¯¹äºé¡¹ç›®ï¼ˆæ ¹ç›®å½•ï¼‰çš„ä½ç½® Y ä¾‹å¦‚src/main/java &lt;javaModelGeneratoræ ‡ç­¾&gt;æ ‡ç­¾æ”¯æŒ0æˆ–Nä¸ª&lt;property&gt;æ ‡ç­¾ï¼Œ&lt;property&gt;çš„å¯é€‰å±æ€§æœ‰ï¼š propertyå±æ€§ åŠŸèƒ½æè¿° é»˜è®¤å€¼ å¤‡æ³¨ constructorBased æ˜¯å¦ç”Ÿæˆä¸€ä¸ªå¸¦æœ‰æ‰€æœ‰å­—æ®µå±æ€§çš„æ„é€ å‡½æ•° false MyBatis3Kotlinæ¨¡å¼ä¸‹å¿½ç•¥æ­¤å±æ€§é…ç½® enableSubPackages æ˜¯å¦å…è®¸é€šè¿‡Schemaç”Ÿæˆå­åŒ… false å¦‚æœä¸ºtrueï¼Œä¾‹å¦‚åŒ…åä¸ºclub.throwableï¼Œå¦‚æœSchemaä¸ºxyzï¼Œé‚£ä¹ˆå®ä½“ç±»æ–‡ä»¶æœ€ç»ˆä¼šç”Ÿæˆåœ¨club.throwable.xyzç›®å½• exampleTargetPackage ç”Ÿæˆçš„ä¼´éšå®ä½“ç±»çš„Exampleç±»çš„åŒ…å - - exampleTargetProject ç”Ÿæˆçš„ä¼´éšå®ä½“ç±»çš„Exampleç±»æ–‡ä»¶ç›¸å¯¹äºé¡¹ç›®ï¼ˆæ ¹ç›®å½•ï¼‰çš„ä½ç½® - - immutable æ˜¯å¦ä¸å¯å˜ false å¦‚æœä¸ºtrueï¼Œåˆ™ä¸ä¼šç”ŸæˆSetteræ–¹æ³•ï¼Œæ‰€æœ‰å­—æ®µéƒ½ä½¿ç”¨finalä¿®é¥°ï¼Œæä¾›ä¸€ä¸ªå¸¦æœ‰æ‰€æœ‰å­—æ®µå±æ€§çš„æ„é€ å‡½æ•° rootClass ä¸ºç”Ÿæˆçš„å®ä½“ç±»æ·»åŠ çˆ¶ç±» - é€šè¿‡valueæŒ‡å®šçˆ¶ç±»çš„å…¨ç±»åå³å¯ trimStrings Setteræ–¹æ³•æ˜¯å¦å¯¹å­—ç¬¦ä¸²ç±»å‹è¿›è¡Œä¸€æ¬¡trimæ“ä½œ false - javaClientGeneratoræ ‡ç­¾ &lt;javaClientGenerator&gt;æ ‡ç­¾æ˜¯&lt;context&gt;çš„å­æ ‡ç­¾ï¼Œä¸»è¦ç”¨äºæ§åˆ¶Mapperæ¥å£çš„ä»£ç ç”Ÿæˆè¡Œä¸ºã€‚å®ƒæ”¯æŒçš„å±æ€§å¦‚ä¸‹ï¼š å±æ€§ åŠŸèƒ½æè¿° æ˜¯å¦å¿…é¡» å¤‡æ³¨ type Mapperæ¥å£ç”Ÿæˆç­–ç•¥ Y &lt;context&gt;æ ‡ç­¾çš„targetRuntimeå±æ€§ä¸ºMyBatis3DynamicSqlæˆ–è€…MyBatis3Kotlinæ—¶æ­¤å±æ€§é…ç½®å¿½ç•¥ targetPackage ç”Ÿæˆçš„Mapperæ¥å£çš„åŒ…å Y ä¾‹å¦‚club.throwable.mapper targetProject ç”Ÿæˆçš„Mapperæ¥å£æ–‡ä»¶ç›¸å¯¹äºé¡¹ç›®ï¼ˆæ ¹ç›®å½•ï¼‰çš„ä½ç½® Y ä¾‹å¦‚src/main/java typeå±æ€§çš„å¯é€‰å€¼å¦‚ä¸‹ï¼š ANNOTATEDMAPPERï¼šMapperæ¥å£ç”Ÿæˆçš„æ—¶å€™ä¾èµ–äºæ³¨è§£å’ŒSqlProvidersï¼ˆä¹Ÿå°±æ˜¯çº¯æ³¨è§£å®ç°ï¼‰ï¼Œä¸ä¼šç”ŸæˆXMLæ˜ å°„æ–‡ä»¶ã€‚ XMLMAPPERï¼šMapperæ¥å£ç”Ÿæˆæ¥å£æ–¹æ³•ï¼Œå¯¹åº”çš„å®ç°ä»£ç ç”Ÿæˆåœ¨XMLæ˜ å°„æ–‡ä»¶ä¸­ï¼ˆä¹Ÿå°±æ˜¯çº¯æ˜ å°„æ–‡ä»¶å®ç°ï¼‰ã€‚ MIXEDMAPPERï¼šMapperæ¥å£ç”Ÿæˆçš„æ—¶å€™å¤æ‚çš„æ–¹æ³•å®ç°ç”Ÿæˆåœ¨XMLæ˜ å°„æ–‡ä»¶ä¸­ï¼Œè€Œç®€å•çš„å®ç°é€šè¿‡æ³¨è§£å’ŒSqlProviderså®ç°ï¼ˆä¹Ÿå°±æ˜¯æ³¨è§£å’Œæ˜ å°„æ–‡ä»¶æ··åˆå®ç°ï¼‰ã€‚ æ³¨æ„ä¸¤ç‚¹ï¼š &lt;context&gt;æ ‡ç­¾çš„targetRuntimeå±æ€§æŒ‡å®šä¸ºMyBatis3Simpleçš„æ—¶å€™ï¼Œtypeåªèƒ½é€‰ç”¨ANNOTATEDMAPPERæˆ–è€…XMLMAPPERã€‚ &lt;context&gt;æ ‡ç­¾çš„targetRuntimeå±æ€§æŒ‡å®šä¸ºMyBatis3çš„æ—¶å€™ï¼Œtypeå¯ä»¥é€‰ç”¨ANNOTATEDMAPPERã€XMLMAPPERæˆ–è€…MIXEDMAPPERã€‚ &lt;javaClientGenerator&gt;æ ‡ç­¾æ”¯æŒ0æˆ–Nä¸ª&lt;property&gt;æ ‡ç­¾ï¼Œ&lt;property&gt;çš„å¯é€‰å±æ€§æœ‰ï¼š propertyå±æ€§ åŠŸèƒ½æè¿° é»˜è®¤å€¼ å¤‡æ³¨ enableSubPackages æ˜¯å¦å…è®¸é€šè¿‡Schemaç”Ÿæˆå­åŒ… false å¦‚æœä¸ºtrueï¼Œä¾‹å¦‚åŒ…åä¸ºclub.throwableï¼Œå¦‚æœSchemaä¸ºxyzï¼Œé‚£ä¹ˆMapperæ¥å£æ–‡ä»¶æœ€ç»ˆä¼šç”Ÿæˆåœ¨club.throwable.xyzç›®å½• useLegacyBuilder æ˜¯å¦é€šè¿‡SQL Builderç”ŸæˆåŠ¨æ€SQL false rootInterface ä¸ºç”Ÿæˆçš„Mapperæ¥å£æ·»åŠ çˆ¶æ¥å£ - é€šè¿‡valueæŒ‡å®šçˆ¶æ¥å£çš„å…¨ç±»åå³å¯ sqlMapGeneratoræ ‡ç­¾ &lt;sqlMapGenerator&gt;æ ‡ç­¾æ˜¯&lt;context&gt;çš„å­æ ‡ç­¾ï¼Œä¸»è¦ç”¨äºæ§åˆ¶XMLæ˜ å°„æ–‡ä»¶çš„ä»£ç ç”Ÿæˆè¡Œä¸ºã€‚å®ƒæ”¯æŒçš„å±æ€§å¦‚ä¸‹ï¼š å±æ€§ åŠŸèƒ½æè¿° æ˜¯å¦å¿…é¡» å¤‡æ³¨ targetPackage ç”Ÿæˆçš„XMLæ˜ å°„æ–‡ä»¶çš„åŒ…å Y ä¾‹å¦‚mappings targetProject ç”Ÿæˆçš„XMLæ˜ å°„æ–‡ä»¶ç›¸å¯¹äºé¡¹ç›®ï¼ˆæ ¹ç›®å½•ï¼‰çš„ä½ç½® Y ä¾‹å¦‚src/main/resources &lt;sqlMapGenerator&gt;æ ‡ç­¾æ”¯æŒ0æˆ–Nä¸ª&lt;property&gt;æ ‡ç­¾ï¼Œ&lt;property&gt;çš„å¯é€‰å±æ€§æœ‰ï¼š propertyå±æ€§ åŠŸèƒ½æè¿° é»˜è®¤å€¼ å¤‡æ³¨ enableSubPackages æ˜¯å¦å…è®¸é€šè¿‡Schemaç”Ÿæˆå­åŒ… false - pluginæ ‡ç­¾ &lt;plugin&gt;æ ‡ç­¾æ˜¯&lt;context&gt;çš„å­æ ‡ç­¾ï¼Œç”¨äºå¼•å…¥ä¸€äº›æ’ä»¶å¯¹ä»£ç ç”Ÿæˆçš„ä¸€äº›ç‰¹æ€§è¿›è¡Œæ‰©å±•ï¼Œè¯¥æ ‡ç­¾åªåŒ…å«ä¸€ä¸ªtypeå±æ€§ï¼Œç”¨äºæŒ‡å®šorg.mybatis.generator.api.Pluginæ¥å£çš„å®ç°ç±»ã€‚å†…ç½®çš„æ’ä»¶å®ç°è§Supplied Pluginsã€‚ä¾‹å¦‚ï¼šå¼•å…¥org.mybatis.generator.plugins.SerializablePluginæ’ä»¶ä¼šè®©ç”Ÿæˆçš„å®ä½“ç±»è‡ªåŠ¨å®ç°java.io.Serializableæ¥å£å¹¶ä¸”æ·»åŠ serialVersionUIDå±æ€§ã€‚ tableæ ‡ç­¾ &lt;table&gt;æ ‡ç­¾æ˜¯&lt;context&gt;çš„å­æ ‡ç­¾ï¼Œä¸»è¦ç”¨äºé…ç½®è¦ç”Ÿæˆä»£ç çš„æ•°æ®åº“è¡¨æ ¼ï¼Œå®šåˆ¶ä¸€äº›ä»£ç ç”Ÿæˆè¡Œä¸ºç­‰ç­‰ã€‚å®ƒæ”¯æŒçš„å±æ€§ä¼—å¤šï¼Œåˆ—ä¸¾å¦‚ä¸‹ï¼š å±æ€§ åŠŸèƒ½æè¿° æ˜¯å¦å¿…é¡» å¤‡æ³¨ tableName æ•°æ®åº“è¡¨åç§° Y ä¾‹å¦‚t_order schema æ•°æ®åº“Schema N - catalog æ•°æ®åº“Catalog N - alias è¡¨åç§°æ ‡ç­¾ N å¦‚æœæŒ‡å®šäº†æ­¤å€¼ï¼Œåˆ™æŸ¥è¯¢åˆ—çš„æ—¶å€™ç»“æœæ ¼å¼ä¸ºalias_column domainObjectName è¡¨å¯¹åº”çš„å®ä½“ç±»åç§°ï¼Œå¯ä»¥é€šè¿‡.æŒ‡å®šåŒ…è·¯å¾„ N å¦‚æœæŒ‡å®šäº†bar.Userï¼Œåˆ™åŒ…åä¸ºbarï¼Œå®ä½“ç±»åç§°ä¸ºUser mapperName è¡¨å¯¹åº”çš„Mapperæ¥å£ç±»åç§°ï¼Œå¯ä»¥é€šè¿‡.æŒ‡å®šåŒ…è·¯å¾„ N å¦‚æœæŒ‡å®šäº†bar.UserMapperï¼Œåˆ™åŒ…åä¸ºbarï¼ŒMapperæ¥å£ç±»åç§°ä¸ºUserMapper sqlProviderName åŠ¨æ€SQLæä¾›ç±»SqlProviderçš„ç±»åç§° N - enableInsert æ˜¯å¦å…è®¸ç”Ÿæˆinsertæ–¹æ³• N é»˜è®¤å€¼ä¸ºtrueï¼Œæ‰§è¡Œå¼•æ“ä¸ºMyBatis3DynamicSqlæˆ–è€…MyBatis3Kotlinæ—¶å¿½ç•¥æ­¤é…ç½® enableSelectByPrimaryKey æ˜¯å¦å…è®¸ç”ŸæˆselectByPrimaryKeyæ–¹æ³• N é»˜è®¤å€¼ä¸ºtrueï¼Œæ‰§è¡Œå¼•æ“ä¸ºMyBatis3DynamicSqlæˆ–è€…MyBatis3Kotlinæ—¶å¿½ç•¥æ­¤é…ç½® enableSelectByExample æ˜¯å¦å…è®¸ç”ŸæˆselectByExampleæ–¹æ³• N é»˜è®¤å€¼ä¸ºtrueï¼Œæ‰§è¡Œå¼•æ“ä¸ºMyBatis3DynamicSqlæˆ–è€…MyBatis3Kotlinæ—¶å¿½ç•¥æ­¤é…ç½® enableUpdateByPrimaryKey æ˜¯å¦å…è®¸ç”ŸæˆupdateByPrimaryKeyæ–¹æ³• N é»˜è®¤å€¼ä¸ºtrueï¼Œæ‰§è¡Œå¼•æ“ä¸ºMyBatis3DynamicSqlæˆ–è€…MyBatis3Kotlinæ—¶å¿½ç•¥æ­¤é…ç½® enableDeleteByPrimaryKey æ˜¯å¦å…è®¸ç”ŸæˆdeleteByPrimaryKeyæ–¹æ³• N é»˜è®¤å€¼ä¸ºtrueï¼Œæ‰§è¡Œå¼•æ“ä¸ºMyBatis3DynamicSqlæˆ–è€…MyBatis3Kotlinæ—¶å¿½ç•¥æ­¤é…ç½® enableDeleteByExample æ˜¯å¦å…è®¸ç”ŸæˆdeleteByExampleæ–¹æ³• N é»˜è®¤å€¼ä¸ºtrueï¼Œæ‰§è¡Œå¼•æ“ä¸ºMyBatis3DynamicSqlæˆ–è€…MyBatis3Kotlinæ—¶å¿½ç•¥æ­¤é…ç½® enableCountByExample æ˜¯å¦å…è®¸ç”ŸæˆcountByExampleæ–¹æ³• N é»˜è®¤å€¼ä¸ºtrueï¼Œæ‰§è¡Œå¼•æ“ä¸ºMyBatis3DynamicSqlæˆ–è€…MyBatis3Kotlinæ—¶å¿½ç•¥æ­¤é…ç½® enableUpdateByExample æ˜¯å¦å…è®¸ç”ŸæˆupdateByExampleæ–¹æ³• N é»˜è®¤å€¼ä¸ºtrueï¼Œæ‰§è¡Œå¼•æ“ä¸ºMyBatis3DynamicSqlæˆ–è€…MyBatis3Kotlinæ—¶å¿½ç•¥æ­¤é…ç½® selectByPrimaryKeyQueryId valueæŒ‡å®šå¯¹åº”çš„ä¸»é”®åˆ—æä¾›åˆ—è¡¨æŸ¥è¯¢åŠŸèƒ½ N æ‰§è¡Œå¼•æ“ä¸ºMyBatis3DynamicSqlæˆ–è€…MyBatis3Kotlinæ—¶å¿½ç•¥æ­¤é…ç½® selectByExampleQueryId valueæŒ‡å®šå¯¹åº”çš„æŸ¥è¯¢IDæä¾›åˆ—è¡¨æŸ¥è¯¢åŠŸèƒ½ N æ‰§è¡Œå¼•æ“ä¸ºMyBatis3DynamicSqlæˆ–è€…MyBatis3Kotlinæ—¶å¿½ç•¥æ­¤é…ç½® modelType è¦†ç›–&lt;context&gt;çš„defaultModelTypeå±æ€§ N è§&lt;context&gt;çš„defaultModelTypeå±æ€§ escapeWildcards æ˜¯å¦å¯¹é€šé…ç¬¦è¿›è¡Œè½¬ä¹‰ N - delimitIdentifiers æ ‡è®°åŒ¹é…è¡¨åç§°çš„æ—¶å€™æ˜¯å¦éœ€è¦ä½¿ç”¨åˆ†éš”ç¬¦å»æ ‡è®°ç”Ÿæˆçš„SQL N - delimitAllColumns æ˜¯å¦æ‰€æœ‰çš„åˆ—éƒ½æ·»åŠ åˆ†éš”ç¬¦ N é»˜è®¤å€¼ä¸ºfalseï¼Œå¦‚æœè®¾ç½®ä¸ºtrueï¼Œæ‰€æœ‰åˆ—åä¼šæ·»åŠ èµ·å§‹å’Œç»“æŸåˆ†éš”ç¬¦ &lt;table&gt;æ ‡ç­¾æ”¯æŒ0æˆ–Nä¸ª&lt;property&gt;æ ‡ç­¾ï¼Œ&lt;property&gt;çš„å¯é€‰å±æ€§æœ‰ï¼š propertyå±æ€§ åŠŸèƒ½æè¿° é»˜è®¤å€¼ å¤‡æ³¨ constructorBased æ˜¯å¦ä¸ºå®ä½“ç±»ç”Ÿæˆä¸€ä¸ªå¸¦æœ‰æ‰€æœ‰å­—æ®µçš„æ„é€ å‡½æ•° false æ‰§è¡Œå¼•æ“ä¸ºMyBatis3Kotlinçš„æ—¶å€™æ­¤å±æ€§å¿½ç•¥ ignoreQualifiersAtRuntime æ˜¯å¦åœ¨è¿è¡Œæ—¶å¿½ç•¥åˆ«å false å¦‚æœä¸ºtrueï¼Œåˆ™ä¸ä¼šåœ¨ç”Ÿæˆè¡¨çš„æ—¶å€™æŠŠschemaå’Œcatalogä½œä¸ºè¡¨çš„å‰ç¼€ immutable å®ä½“ç±»æ˜¯å¦ä¸å¯å˜ false æ‰§è¡Œå¼•æ“ä¸ºMyBatis3Kotlinçš„æ—¶å€™æ­¤å±æ€§å¿½ç•¥ modelOnly æ˜¯å¦ä»…ä»…ç”Ÿæˆå®ä½“ç±» false - rootClass å¦‚æœé…ç½®æ­¤å±æ€§ï¼Œåˆ™å®ä½“ç±»ä¼šç»§æ‰¿æ­¤æŒ‡å®šçš„è¶…ç±» - å¦‚æœæœ‰ä¸»é”®å±æ€§ä¼šæŠŠä¸»é”®å±æ€§åœ¨è¶…ç±»ç”Ÿæˆ rootInterface å¦‚æœé…ç½®æ­¤å±æ€§ï¼Œåˆ™å®ä½“ç±»ä¼šå®ç°æ­¤æŒ‡å®šçš„æ¥å£ - æ‰§è¡Œå¼•æ“ä¸ºMyBatis3Kotlinæˆ–è€…MyBatis3DynamicSqlçš„æ—¶å€™æ­¤å±æ€§å¿½ç•¥ runtimeCatalog æŒ‡å®šè¿è¡Œæ—¶çš„Catalog - å½“ç”Ÿæˆè¡¨å’Œè¿è¡Œæ—¶çš„è¡¨çš„Catalogä¸ä¸€æ ·çš„æ—¶å€™å¯ä»¥ä½¿ç”¨è¯¥å±æ€§è¿›è¡Œé…ç½® runtimeSchema æŒ‡å®šè¿è¡Œæ—¶çš„Schema - å½“ç”Ÿæˆè¡¨å’Œè¿è¡Œæ—¶çš„è¡¨çš„Schemaä¸ä¸€æ ·çš„æ—¶å€™å¯ä»¥ä½¿ç”¨è¯¥å±æ€§è¿›è¡Œé…ç½® runtimeTableName æŒ‡å®šè¿è¡Œæ—¶çš„è¡¨åç§° - å½“ç”Ÿæˆè¡¨å’Œè¿è¡Œæ—¶çš„è¡¨çš„è¡¨åç§°ä¸ä¸€æ ·çš„æ—¶å€™å¯ä»¥ä½¿ç”¨è¯¥å±æ€§è¿›è¡Œé…ç½® selectAllOrderByClause æŒ‡å®šå­—å¥å†…å®¹æ·»åŠ åˆ°selectAll()æ–¹æ³•çš„order byå­å¥ä¹‹ä¸­ - æ‰§è¡Œå¼•æ“ä¸ºMyBatis3Simpleçš„æ—¶å€™æ­¤å±æ€§æ‰é€‚ç”¨ trimStrings å®ä½“ç±»çš„å­—ç¬¦ä¸²ç±»å‹å±æ€§ä¼šåštrimå¤„ç† - æ‰§è¡Œå¼•æ“ä¸ºMyBatis3Kotlinçš„æ—¶å€™æ­¤å±æ€§å¿½ç•¥ useActualColumnNames æ˜¯å¦ä½¿ç”¨åˆ—åä½œä¸ºå®ä½“ç±»çš„å±æ€§å false - useColumnIndexes XMLæ˜ å°„æ–‡ä»¶ä¸­ç”Ÿæˆçš„ResultMapä½¿ç”¨åˆ—ç´¢å¼•å®šä¹‰è€Œä¸æ˜¯åˆ—åç§° false æ‰§è¡Œå¼•æ“ä¸ºMyBatis3Kotlinæˆ–è€…MyBatis3DynamicSqlçš„æ—¶å€™æ­¤å±æ€§å¿½ç•¥ useCompoundPropertyNames æ˜¯å¦æŠŠåˆ—åå’Œåˆ—å¤‡æ³¨æ‹¼æ¥èµ·æ¥ç”Ÿæˆå®ä½“ç±»å±æ€§å false - &lt;table&gt;æ ‡ç­¾è¿˜æ”¯æŒä¼—å¤šçš„épropertyçš„å­æ ‡ç­¾ï¼š 0æˆ–1ä¸ª&lt;generatedKey&gt;ç”¨äºæŒ‡å®šä¸»é”®ç”Ÿæˆçš„è§„åˆ™ï¼ŒæŒ‡å®šæ­¤æ ‡ç­¾åä¼šç”Ÿæˆä¸€ä¸ª&lt;selectKey&gt;æ ‡ç­¾ï¼š 12345&lt;!-- columnï¼šæŒ‡å®šä¸»é”®åˆ— --&gt;&lt;!-- sqlStatementï¼šæŸ¥è¯¢ä¸»é”®çš„SQLè¯­å¥ï¼Œä¾‹å¦‚å¡«å†™äº†MySqlï¼Œåˆ™ä½¿ç”¨SELECT LAST_INSERT_ID() --&gt;&lt;!-- typeï¼šå¯é€‰å€¼ä¸ºpreæˆ–è€…postï¼ŒpreæŒ‡å®šselectKeyæ ‡ç­¾çš„orderä¸ºBEFOREï¼ŒpostæŒ‡å®šselectKeyæ ‡ç­¾çš„orderä¸ºAFTER --&gt;&lt;!-- identityï¼štrueçš„æ—¶å€™ï¼ŒæŒ‡å®šselectKeyæ ‡ç­¾çš„orderä¸ºAFTER --&gt;&lt;generatedKey column=\"id\" sqlStatement=\"MySql\" type=\"post\" identity=\"true\" /&gt; 0æˆ–1ä¸ª&lt;domainObjectRenamingRule&gt;ç”¨äºæŒ‡å®šå®ä½“ç±»é‡å‘½åè§„åˆ™ï¼š 1234&lt;!-- searchStringä¸­æ­£åˆ™å‘½ä¸­çš„å®ä½“ç±»åéƒ¨åˆ†ä¼šæ›¿æ¢ä¸ºreplaceString --&gt;&lt;domainObjectRenamingRule searchString=\"^Sys\" replaceString=\"\"/&gt;&lt;!-- ä¾‹å¦‚ SysUserä¼šå˜æˆUser --&gt;&lt;!-- ä¾‹å¦‚ SysUserMapperä¼šå˜æˆUserMapper --&gt; 0æˆ–1ä¸ª&lt;columnRenamingRule&gt;ç”¨äºæŒ‡å®šåˆ—é‡å‘½åè§„åˆ™ï¼š 1234&lt;!-- searchStringä¸­æ­£åˆ™å‘½ä¸­çš„åˆ—åéƒ¨åˆ†ä¼šæ›¿æ¢ä¸ºreplaceString --&gt;&lt;columnRenamingRule searchString=\"^CUST_\" replaceString=\"\"/&gt;&lt;!-- ä¾‹å¦‚ CUST_BUSINESS_NAMEä¼šå˜æˆBUSINESS_NAMEï¼ˆuseActualColumnNames=trueï¼‰ --&gt;&lt;!-- ä¾‹å¦‚ CUST_BUSINESS_NAMEä¼šå˜æˆbusinessNameï¼ˆuseActualColumnNames=falseï¼‰ --&gt; 0æˆ–Nä¸ª&lt;columnOverride&gt;ç”¨äºæŒ‡å®šå…·ä½“åˆ—çš„è¦†ç›–æ˜ å°„è§„åˆ™ï¼š 12345678&lt;!-- columnï¼šæŒ‡å®šè¦è¦†ç›–é…ç½®çš„åˆ— --&gt;&lt;!-- propertyï¼šæŒ‡å®šè¦è¦†ç›–é…ç½®çš„å±æ€§ --&gt;&lt;!-- delimitedColumnNameï¼šæ˜¯å¦ä¸ºåˆ—åæ·»åŠ å®šç•Œç¬¦ï¼Œä¾‹å¦‚`&#123;column&#125;` --&gt;&lt;!-- isGeneratedAlwaysï¼šæ˜¯å¦ä¸€å®šç”Ÿæˆæ­¤åˆ— --&gt;&lt;columnOverride column=\"customer_name\" property=\"customerName\" javaType=\"\" jdbcType=\"\" typeHandler=\"\" delimitedColumnName=\"\" isGeneratedAlways=\"\"&gt; &lt;!-- è¦†ç›–tableæˆ–è€…javaModelGeneratorçº§åˆ«çš„trimStringså±æ€§é…ç½® --&gt; &lt;property name=\"trimStrings\" value=\"true\"/&gt;&lt;columnOverride/&gt; 0æˆ–Nä¸ª&lt;ignoreColumn&gt;ç”¨äºæŒ‡å®šå¿½ç•¥ç”Ÿæˆçš„åˆ—ï¼š 1&lt;ignoreColumn column=\"version\" delimitedColumnName=\"false\"/&gt; å®æˆ˜ å¦‚æœéœ€è¦æ·±åº¦å®šåˆ¶ä¸€äº›ä»£ç ç”Ÿæˆè¡Œä¸ºï¼Œå»ºè®®å¼•å…¥mybatis-generator-coreå¹¶ä¸”é€šè¿‡ç¼–ç¨‹å¼æ‰§è¡Œä»£ç ç”Ÿæˆæ–¹æ³•ï¼Œå¦åˆ™å¯ä»¥é€‰ç”¨Mavenæ’ä»¶ã€‚å‡è®¾æˆ‘ä»¬åœ¨æœ¬åœ°æ•°æ®localæœ‰ä¸€å¼ t_orderè¡¨å¦‚ä¸‹ï¼š 123456789CREATE TABLE `t_order`( id BIGINT UNSIGNED PRIMARY KEY COMMENT 'ä¸»é”®', order_id VARCHAR(64) NOT NULL COMMENT 'è®¢å•ID', create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´', amount DECIMAL(10, 2) NOT NULL DEFAULT 0 COMMENT 'é‡‘é¢', order_status TINYINT NOT NULL DEFAULT 0 COMMENT 'è®¢å•çŠ¶æ€', UNIQUE uniq_order_id (`order_id`)) COMMENT 'è®¢å•è¡¨'; å‡è®¾é¡¹ç›®çš„ç»“æ„å¦‚ä¸‹ï¼š 123456mbg-sample - main - java - club - throwable - resources ä¸‹é¢ä¼šåŸºäºæ­¤å‰æä¸¾ä¸‰ä¸ªä¾‹å­ã€‚ç¼–å†™åŸºç¡€çš„XMLé…ç½®æ–‡ä»¶ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;&lt;!DOCTYPE generatorConfiguration PUBLIC \"-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN\" \"http://mybatis.org/dtd/mybatis-generator-config_1_0.dtd\"&gt;&lt;generatorConfiguration&gt; &lt;!-- é©±åŠ¨åŒ…ç»å¯¹è·¯å¾„ --&gt; &lt;classPathEntry location=\"I:\\Develop\\Maven-Repository\\mysql\\mysql-connector-java\\5.1.48\\mysql-connector-java-5.1.48.jar\"/&gt; &lt;context id=\"default\" targetRuntime=\"è¿™é‡Œé€‰æ‹©åˆé€‚çš„å¼•æ“\"&gt; &lt;property name=\"javaFileEncoding\" value=\"UTF-8\"/&gt; &lt;!-- ä¸è¾“å‡ºæ³¨é‡Š --&gt; &lt;commentGenerator&gt; &lt;property name=\"suppressDate\" value=\"true\"/&gt; &lt;property name=\"suppressAllComments\" value=\"true\"/&gt; &lt;/commentGenerator&gt; &lt;jdbcConnection driverClass=\"com.mysql.jdbc.Driver\" connectionURL=\"jdbc:mysql://localhost:3306/local\" userId=\"root\" password=\"root\"&gt; &lt;/jdbcConnection&gt; &lt;!-- ä¸å¼ºåˆ¶æŠŠæ‰€æœ‰çš„æ•°å­—ç±»å‹è½¬åŒ–ä¸ºBigDecimal --&gt; &lt;javaTypeResolver&gt; &lt;property name=\"forceBigDecimals\" value=\"false\"/&gt; &lt;/javaTypeResolver&gt; &lt;javaModelGenerator targetPackage=\"club.throwable.entity\" targetProject=\"src/main/java\"&gt; &lt;property name=\"enableSubPackages\" value=\"true\"/&gt; &lt;/javaModelGenerator&gt; &lt;sqlMapGenerator targetPackage=\"mappings\" targetProject=\"src/main/resources\"&gt; &lt;property name=\"enableSubPackages\" value=\"true\"/&gt; &lt;/sqlMapGenerator&gt; &lt;javaClientGenerator type=\"è¿™é‡Œé€‰æ‹©åˆé€‚çš„Mapperç±»å‹\" targetPackage=\"club.throwable.dao\" targetProject=\"src/main/java\"&gt; &lt;property name=\"enableSubPackages\" value=\"true\"/&gt; &lt;/javaClientGenerator&gt; &lt;table tableName=\"t_order\" enableCountByExample=\"false\" enableDeleteByExample=\"false\" enableSelectByExample=\"false\" enableUpdateByExample=\"false\" domainObjectName=\"Order\" mapperName=\"OrderMapper\"&gt; &lt;generatedKey column=\"id\" sqlStatement=\"MySql\"/&gt; &lt;/table&gt; &lt;/context&gt;&lt;/generatorConfiguration&gt; çº¯æ³¨è§£ ä½¿ç”¨çº¯æ³¨è§£éœ€è¦å¼•å…¥mybatis-dynamic-sqlï¼š 12345&lt;dependency&gt; &lt;groupId&gt;org.mybatis.dynamic-sql&lt;/groupId&gt; &lt;artifactId&gt;mybatis-dynamic-sql&lt;/artifactId&gt; &lt;version&gt;1.1.4&lt;/version&gt;&lt;/dependency&gt; éœ€è¦ä¿®æ”¹ä¸¤ä¸ªä½ç½®ï¼š 12345&lt;context id=\"default\" targetRuntime=\"MyBatis3DynamicSql\"&gt;...&lt;javaClientGenerator type=\"ANNOTATEDMAPPER\"... è¿è¡Œç»“æœä¼šç”Ÿæˆä¸‰ä¸ªç±»ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256// club.throwable.entitypublic class Order &#123; @Generated(\"org.mybatis.generator.api.MyBatisGenerator\") private Long id; @Generated(\"org.mybatis.generator.api.MyBatisGenerator\") private String orderId; @Generated(\"org.mybatis.generator.api.MyBatisGenerator\") private Date createTime; @Generated(\"org.mybatis.generator.api.MyBatisGenerator\") private BigDecimal amount; @Generated(\"org.mybatis.generator.api.MyBatisGenerator\") private Byte orderStatus; @Generated(\"org.mybatis.generator.api.MyBatisGenerator\") public Long getId() &#123; return id; &#125; @Generated(\"org.mybatis.generator.api.MyBatisGenerator\") public void setId(Long id) &#123; this.id = id; &#125; @Generated(\"org.mybatis.generator.api.MyBatisGenerator\") public String getOrderId() &#123; return orderId; &#125; @Generated(\"org.mybatis.generator.api.MyBatisGenerator\") public void setOrderId(String orderId) &#123; this.orderId = orderId; &#125; @Generated(\"org.mybatis.generator.api.MyBatisGenerator\") public Date getCreateTime() &#123; return createTime; &#125; @Generated(\"org.mybatis.generator.api.MyBatisGenerator\") public void setCreateTime(Date createTime) &#123; this.createTime = createTime; &#125; @Generated(\"org.mybatis.generator.api.MyBatisGenerator\") public BigDecimal getAmount() &#123; return amount; &#125; @Generated(\"org.mybatis.generator.api.MyBatisGenerator\") public void setAmount(BigDecimal amount) &#123; this.amount = amount; &#125; @Generated(\"org.mybatis.generator.api.MyBatisGenerator\") public Byte getOrderStatus() &#123; return orderStatus; &#125; @Generated(\"org.mybatis.generator.api.MyBatisGenerator\") public void setOrderStatus(Byte orderStatus) &#123; this.orderStatus = orderStatus; &#125;&#125;// club.throwable.daopublic final class OrderDynamicSqlSupport &#123; @Generated(\"org.mybatis.generator.api.MyBatisGenerator\") public static final Order order = new Order(); @Generated(\"org.mybatis.generator.api.MyBatisGenerator\") public static final SqlColumn&lt;Long&gt; id = order.id; @Generated(\"org.mybatis.generator.api.MyBatisGenerator\") public static final SqlColumn&lt;String&gt; orderId = order.orderId; @Generated(\"org.mybatis.generator.api.MyBatisGenerator\") public static final SqlColumn&lt;Date&gt; createTime = order.createTime; @Generated(\"org.mybatis.generator.api.MyBatisGenerator\") public static final SqlColumn&lt;BigDecimal&gt; amount = order.amount; @Generated(\"org.mybatis.generator.api.MyBatisGenerator\") public static final SqlColumn&lt;Byte&gt; orderStatus = order.orderStatus; @Generated(\"org.mybatis.generator.api.MyBatisGenerator\") public static final class Order extends SqlTable &#123; public final SqlColumn&lt;Long&gt; id = column(\"id\", JDBCType.BIGINT); public final SqlColumn&lt;String&gt; orderId = column(\"order_id\", JDBCType.VARCHAR); public final SqlColumn&lt;Date&gt; createTime = column(\"create_time\", JDBCType.TIMESTAMP); public final SqlColumn&lt;BigDecimal&gt; amount = column(\"amount\", JDBCType.DECIMAL); public final SqlColumn&lt;Byte&gt; orderStatus = column(\"order_status\", JDBCType.TINYINT); public Order() &#123; super(\"t_order\"); &#125; &#125;&#125;@Mapperpublic interface OrderMapper &#123; @Generated(\"org.mybatis.generator.api.MyBatisGenerator\") BasicColumn[] selectList = BasicColumn.columnList(id, orderId, createTime, amount, orderStatus); @Generated(\"org.mybatis.generator.api.MyBatisGenerator\") @SelectProvider(type=SqlProviderAdapter.class, method=\"select\") long count(SelectStatementProvider selectStatement); @Generated(\"org.mybatis.generator.api.MyBatisGenerator\") @DeleteProvider(type=SqlProviderAdapter.class, method=\"delete\") int delete(DeleteStatementProvider deleteStatement); @Generated(\"org.mybatis.generator.api.MyBatisGenerator\") @InsertProvider(type=SqlProviderAdapter.class, method=\"insert\") @SelectKey(statement=\"SELECT LAST_INSERT_ID()\", keyProperty=\"record.id\", before=true, resultType=Long.class) int insert(InsertStatementProvider&lt;Order&gt; insertStatement); @Generated(\"org.mybatis.generator.api.MyBatisGenerator\") @SelectProvider(type=SqlProviderAdapter.class, method=\"select\") @Results(id=\"OrderResult\", value = &#123; @Result(column=\"id\", property=\"id\", jdbcType=JdbcType.BIGINT, id=true), @Result(column=\"order_id\", property=\"orderId\", jdbcType=JdbcType.VARCHAR), @Result(column=\"create_time\", property=\"createTime\", jdbcType=JdbcType.TIMESTAMP), @Result(column=\"amount\", property=\"amount\", jdbcType=JdbcType.DECIMAL), @Result(column=\"order_status\", property=\"orderStatus\", jdbcType=JdbcType.TINYINT) &#125;) Optional&lt;Order&gt; selectOne(SelectStatementProvider selectStatement); @Generated(\"org.mybatis.generator.api.MyBatisGenerator\") @SelectProvider(type=SqlProviderAdapter.class, method=\"select\") @Results(id=\"OrderResult\", value = &#123; @Result(column=\"id\", property=\"id\", jdbcType=JdbcType.BIGINT, id=true), @Result(column=\"order_id\", property=\"orderId\", jdbcType=JdbcType.VARCHAR), @Result(column=\"create_time\", property=\"createTime\", jdbcType=JdbcType.TIMESTAMP), @Result(column=\"amount\", property=\"amount\", jdbcType=JdbcType.DECIMAL), @Result(column=\"order_status\", property=\"orderStatus\", jdbcType=JdbcType.TINYINT) &#125;) List&lt;Order&gt; selectMany(SelectStatementProvider selectStatement); @Generated(\"org.mybatis.generator.api.MyBatisGenerator\") @UpdateProvider(type=SqlProviderAdapter.class, method=\"update\") int update(UpdateStatementProvider updateStatement); @Generated(\"org.mybatis.generator.api.MyBatisGenerator\") default long count(CountDSLCompleter completer) &#123; return MyBatis3Utils.countFrom(this::count, order, completer); &#125; @Generated(\"org.mybatis.generator.api.MyBatisGenerator\") default int delete(DeleteDSLCompleter completer) &#123; return MyBatis3Utils.deleteFrom(this::delete, order, completer); &#125; @Generated(\"org.mybatis.generator.api.MyBatisGenerator\") default int deleteByPrimaryKey(Long id_) &#123; return delete(c -&gt; c.where(id, isEqualTo(id_)) ); &#125; @Generated(\"org.mybatis.generator.api.MyBatisGenerator\") default int insert(Order record) &#123; return MyBatis3Utils.insert(this::insert, record, order, c -&gt; c.map(id).toProperty(\"id\") .map(orderId).toProperty(\"orderId\") .map(createTime).toProperty(\"createTime\") .map(amount).toProperty(\"amount\") .map(orderStatus).toProperty(\"orderStatus\") ); &#125; @Generated(\"org.mybatis.generator.api.MyBatisGenerator\") default int insertSelective(Order record) &#123; return MyBatis3Utils.insert(this::insert, record, order, c -&gt; c.map(id).toProperty(\"id\") .map(orderId).toPropertyWhenPresent(\"orderId\", record::getOrderId) .map(createTime).toPropertyWhenPresent(\"createTime\", record::getCreateTime) .map(amount).toPropertyWhenPresent(\"amount\", record::getAmount) .map(orderStatus).toPropertyWhenPresent(\"orderStatus\", record::getOrderStatus) ); &#125; @Generated(\"org.mybatis.generator.api.MyBatisGenerator\") default Optional&lt;Order&gt; selectOne(SelectDSLCompleter completer) &#123; return MyBatis3Utils.selectOne(this::selectOne, selectList, order, completer); &#125; @Generated(\"org.mybatis.generator.api.MyBatisGenerator\") default List&lt;Order&gt; select(SelectDSLCompleter completer) &#123; return MyBatis3Utils.selectList(this::selectMany, selectList, order, completer); &#125; @Generated(\"org.mybatis.generator.api.MyBatisGenerator\") default List&lt;Order&gt; selectDistinct(SelectDSLCompleter completer) &#123; return MyBatis3Utils.selectDistinct(this::selectMany, selectList, order, completer); &#125; @Generated(\"org.mybatis.generator.api.MyBatisGenerator\") default Optional&lt;Order&gt; selectByPrimaryKey(Long id_) &#123; return selectOne(c -&gt; c.where(id, isEqualTo(id_)) ); &#125; @Generated(\"org.mybatis.generator.api.MyBatisGenerator\") default int update(UpdateDSLCompleter completer) &#123; return MyBatis3Utils.update(this::update, order, completer); &#125; @Generated(\"org.mybatis.generator.api.MyBatisGenerator\") static UpdateDSL&lt;UpdateModel&gt; updateAllColumns(Order record, UpdateDSL&lt;UpdateModel&gt; dsl) &#123; return dsl.set(id).equalTo(record::getId) .set(orderId).equalTo(record::getOrderId) .set(createTime).equalTo(record::getCreateTime) .set(amount).equalTo(record::getAmount) .set(orderStatus).equalTo(record::getOrderStatus); &#125; @Generated(\"org.mybatis.generator.api.MyBatisGenerator\") static UpdateDSL&lt;UpdateModel&gt; updateSelectiveColumns(Order record, UpdateDSL&lt;UpdateModel&gt; dsl) &#123; return dsl.set(id).equalToWhenPresent(record::getId) .set(orderId).equalToWhenPresent(record::getOrderId) .set(createTime).equalToWhenPresent(record::getCreateTime) .set(amount).equalToWhenPresent(record::getAmount) .set(orderStatus).equalToWhenPresent(record::getOrderStatus); &#125; @Generated(\"org.mybatis.generator.api.MyBatisGenerator\") default int updateByPrimaryKey(Order record) &#123; return update(c -&gt; c.set(orderId).equalTo(record::getOrderId) .set(createTime).equalTo(record::getCreateTime) .set(amount).equalTo(record::getAmount) .set(orderStatus).equalTo(record::getOrderStatus) .where(id, isEqualTo(record::getId)) ); &#125; @Generated(\"org.mybatis.generator.api.MyBatisGenerator\") default int updateByPrimaryKeySelective(Order record) &#123; return update(c -&gt; c.set(orderId).equalToWhenPresent(record::getOrderId) .set(createTime).equalToWhenPresent(record::getCreateTime) .set(amount).equalToWhenPresent(record::getAmount) .set(orderStatus).equalToWhenPresent(record::getOrderStatus) .where(id, isEqualTo(record::getId)) ); &#125;&#125; æç®€XMLæ˜ å°„æ–‡ä»¶ æç®€XMLæ˜ å°„æ–‡ä»¶ç”Ÿæˆåªéœ€è¦ç®€å•ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼š 12345&lt;context id=\"default\" targetRuntime=\"MyBatis3Simple\"&gt;...&lt;javaClientGenerator type=\"XMLMAPPER\"... ç”Ÿæˆä¸‰ä¸ªæ–‡ä»¶ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147// club.throwable.entitypublic class Order &#123; private Long id; private String orderId; private Date createTime; private BigDecimal amount; private Byte orderStatus; public Long getId() &#123; return id; &#125; public void setId(Long id) &#123; this.id = id; &#125; public String getOrderId() &#123; return orderId; &#125; public void setOrderId(String orderId) &#123; this.orderId = orderId; &#125; public Date getCreateTime() &#123; return createTime; &#125; public void setCreateTime(Date createTime) &#123; this.createTime = createTime; &#125; public BigDecimal getAmount() &#123; return amount; &#125; public void setAmount(BigDecimal amount) &#123; this.amount = amount; &#125; public Byte getOrderStatus() &#123; return orderStatus; &#125; public void setOrderStatus(Byte orderStatus) &#123; this.orderStatus = orderStatus; &#125;&#125;// club.throwable.daopublic interface OrderMapper &#123; int deleteByPrimaryKey(Long id); int insert(Order record); Order selectByPrimaryKey(Long id); List&lt;Order&gt; selectAll(); int updateByPrimaryKey(Order record);&#125;// mappings&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;&lt;!DOCTYPE mapper PUBLIC \"-//mybatis.org//DTD Mapper 3.0//EN\" \"http://mybatis.org/dtd/mybatis-3-mapper.dtd\"&gt;&lt;mapper namespace=\"club.throwable.dao.OrderMapper\"&gt; &lt;resultMap id=\"BaseResultMap\" type=\"club.throwable.entity.Order\"&gt; &lt;id column=\"id\" jdbcType=\"BIGINT\" property=\"id\"/&gt; &lt;result column=\"order_id\" jdbcType=\"VARCHAR\" property=\"orderId\"/&gt; &lt;result column=\"create_time\" jdbcType=\"TIMESTAMP\" property=\"createTime\"/&gt; &lt;result column=\"amount\" jdbcType=\"DECIMAL\" property=\"amount\"/&gt; &lt;result column=\"order_status\" jdbcType=\"TINYINT\" property=\"orderStatus\"/&gt; &lt;/resultMap&gt; &lt;delete id=\"deleteByPrimaryKey\" parameterType=\"java.lang.Long\"&gt; delete from t_order where id = #&#123;id,jdbcType=BIGINT&#125; &lt;/delete&gt; &lt;insert id=\"insert\" parameterType=\"club.throwable.entity.Order\"&gt; &lt;selectKey keyProperty=\"id\" order=\"AFTER\" resultType=\"java.lang.Long\"&gt; SELECT LAST_INSERT_ID() &lt;/selectKey&gt; insert into t_order (order_id, create_time, amount, order_status) values (#&#123;orderId,jdbcType=VARCHAR&#125;, #&#123;createTime,jdbcType=TIMESTAMP&#125;, #&#123;amount,jdbcType=DECIMAL&#125;, #&#123;orderStatus,jdbcType=TINYINT&#125;) &lt;/insert&gt; &lt;update id=\"updateByPrimaryKey\" parameterType=\"club.throwable.entity.Order\"&gt; update t_order set order_id = #&#123;orderId,jdbcType=VARCHAR&#125;, create_time = #&#123;createTime,jdbcType=TIMESTAMP&#125;, amount = #&#123;amount,jdbcType=DECIMAL&#125;, order_status = #&#123;orderStatus,jdbcType=TINYINT&#125; where id = #&#123;id,jdbcType=BIGINT&#125; &lt;/update&gt; &lt;select id=\"selectByPrimaryKey\" parameterType=\"java.lang.Long\" resultMap=\"BaseResultMap\"&gt; select id, order_id, create_time, amount, order_status from t_order where id = #&#123;id,jdbcType=BIGINT&#125; &lt;/select&gt; &lt;select id=\"selectAll\" resultMap=\"BaseResultMap\"&gt; select id, order_id, create_time, amount, order_status from t_order &lt;/select&gt; &lt;resultMap id=\"BaseResultMap\" type=\"club.throwable.entity.Order\"&gt; &lt;id column=\"id\" jdbcType=\"BIGINT\" property=\"id\"/&gt; &lt;result column=\"order_id\" jdbcType=\"VARCHAR\" property=\"orderId\"/&gt; &lt;result column=\"create_time\" jdbcType=\"TIMESTAMP\" property=\"createTime\"/&gt; &lt;result column=\"amount\" jdbcType=\"DECIMAL\" property=\"amount\"/&gt; &lt;result column=\"order_status\" jdbcType=\"TINYINT\" property=\"orderStatus\"/&gt; &lt;/resultMap&gt; &lt;delete id=\"deleteByPrimaryKey\" parameterType=\"java.lang.Long\"&gt; delete from t_order where id = #&#123;id,jdbcType=BIGINT&#125; &lt;/delete&gt; &lt;insert id=\"insert\" parameterType=\"club.throwable.entity.Order\"&gt; &lt;selectKey keyProperty=\"id\" order=\"BEFORE\" resultType=\"java.lang.Long\"&gt; SELECT LAST_INSERT_ID() &lt;/selectKey&gt; insert into t_order (id, order_id, create_time, amount, order_status) values (#&#123;id,jdbcType=BIGINT&#125;, #&#123;orderId,jdbcType=VARCHAR&#125;, #&#123;createTime,jdbcType=TIMESTAMP&#125;, #&#123;amount,jdbcType=DECIMAL&#125;, #&#123;orderStatus,jdbcType=TINYINT&#125;) &lt;/insert&gt; &lt;update id=\"updateByPrimaryKey\" parameterType=\"club.throwable.entity.Order\"&gt; update t_order set order_id = #&#123;orderId,jdbcType=VARCHAR&#125;, create_time = #&#123;createTime,jdbcType=TIMESTAMP&#125;, amount = #&#123;amount,jdbcType=DECIMAL&#125;, order_status = #&#123;orderStatus,jdbcType=TINYINT&#125; where id = #&#123;id,jdbcType=BIGINT&#125; &lt;/update&gt; &lt;select id=\"selectByPrimaryKey\" parameterType=\"java.lang.Long\" resultMap=\"BaseResultMap\"&gt; select id, order_id, create_time, amount, order_status from t_order where id = #&#123;id,jdbcType=BIGINT&#125; &lt;/select&gt; &lt;select id=\"selectAll\" resultMap=\"BaseResultMap\"&gt; select id, order_id, create_time, amount, order_status from t_order &lt;/select&gt;&lt;/mapper&gt; ç¼–ç¨‹å¼è‡ªå®šä¹‰ç±»å‹æ˜ å°„ ç¬”è€…å–œæ¬¢æŠŠæ‰€æœ‰çš„éé•¿æ•´å‹çš„æ•°å­—ï¼Œç»Ÿä¸€ä½¿ç”¨Integeræ¥æ”¶ï¼Œå› æ­¤éœ€è¦è‡ªå®šä¹‰ç±»å‹æ˜ å°„ã€‚ç¼–å†™æ˜ å°„å™¨å¦‚ä¸‹ï¼š 12345678910public class DefaultJavaTypeResolver extends JavaTypeResolverDefaultImpl &#123; public DefaultJavaTypeResolver() &#123; super(); typeMap.put(Types.SMALLINT, new JdbcTypeInformation(\"SMALLINT\", new FullyQualifiedJavaType(Integer.class.getName()))); typeMap.put(Types.TINYINT, new JdbcTypeInformation(\"TINYINT\", new FullyQualifiedJavaType(Integer.class.getName()))); &#125;&#125; æ­¤æ—¶æœ€å¥½ä½¿ç”¨ç¼–ç¨‹å¼è¿è¡Œä»£ç ç”Ÿæˆå™¨ï¼Œä¿®æ”¹XMLé…ç½®æ–‡ä»¶ï¼š 1234&lt;javaTypeResolver type=\"club.throwable.mbg.DefaultJavaTypeResolver\"&gt; &lt;property name=\"forceBigDecimals\" value=\"false\"/&gt;&lt;/javaTypeResolver&gt;... è¿è¡Œæ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š 12345678910111213public class Main &#123; public static void main(String[] args) throws Exception &#123; List&lt;String&gt; warnings = new ArrayList&lt;&gt;(); // å¦‚æœå·²ç»å­˜åœ¨ç”Ÿæˆè¿‡çš„æ–‡ä»¶æ˜¯å¦è¿›è¡Œè¦†ç›– boolean overwrite = true; ConfigurationParser cp = new ConfigurationParser(warnings); Configuration config = cp.parseConfiguration(Main.class.getResourceAsStream(\"/generator-configuration.xml\")); DefaultShellCallback callback = new DefaultShellCallback(overwrite); MyBatisGenerator generator = new MyBatisGenerator(config, callback, warnings); generator.generate(null); &#125;&#125; æ•°æ®åº“çš„order_statusæ˜¯TINYINTç±»å‹ï¼Œç”Ÿæˆå‡ºæ¥çš„æ–‡ä»¶ä¸­çš„orderStatuså­—æ®µå…¨éƒ¨æ›¿æ¢ä½¿ç”¨Integerç±»å‹å®šä¹‰ã€‚ å°ç»“ æœ¬æ–‡ç›¸å¯¹è¯¦å°½åœ°ä»‹ç»äº†Mybatis Generatorçš„ä½¿ç”¨æ–¹å¼ï¼Œå…·ä½“åˆ†æäº†XMLé…ç½®æ–‡ä»¶ä¸­ä¸»è¦æ ‡ç­¾ä»¥åŠæ ‡ç­¾å±æ€§çš„åŠŸèƒ½ã€‚å› ä¸ºMybatisåœ¨Javaçš„ORMæ¡†æ¶ä½“ç³»ä¸­è¿˜ä¼šæœ‰ä¸€æ®µå¾ˆé•¿çš„æ—¶é—´å¤„äºä¸»æµåœ°ä½ï¼Œäº†è§£Mybatis Generatorå¯ä»¥ç®€åŒ–CRUDæ–¹æ³•æ¨¡æ¿ä»£ç ã€å®ä½“ä»¥åŠMapperæ¥å£ä»£ç ç”Ÿæˆï¼Œä»è€Œè§£æ”¾å¤§é‡ç”Ÿäº§åŠ›ã€‚Mybatis Generatoræœ‰ä¸å°‘ç¬¬ä¸‰æ–¹çš„æ‰©å±•ï¼Œä¾‹å¦‚tk.mapperæˆ–è€…mybatis-plusè‡ªèº«çš„æ‰©å±•ï¼Œå¯èƒ½é™„åŠ çš„åŠŸèƒ½ä¸ä¸€æ ·ï¼Œä½†æ˜¯åŸºæœ¬çš„ä½¿ç”¨æ˜¯ä¸€è‡´çš„ã€‚ å‚è€ƒèµ„æ–™ï¼š MyBatis Generator ï¼ˆæœ¬æ–‡å®Œ c-5-d e-a-20191216 1:00ï¼‰","categories":[{"name":"Framework","slug":"Framework","permalink":"http://throwable.club/blog/categories/Framework/"},{"name":"Mybatis","slug":"Framework/Mybatis","permalink":"http://throwable.club/blog/categories/Framework/Mybatis/"}],"tags":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/tags/Java/"},{"name":"Mybatis","slug":"Mybatis","permalink":"http://throwable.club/blog/tags/Mybatis/"}]},{"title":"ä½ çš„SpringBootåº”ç”¨çœŸçš„éƒ¨ç½²æ›´æ–°æˆåŠŸäº†å—","slug":"spring-boot-server-deploy-monitor","date":"2019-12-08T17:44:12.000Z","updated":"2019-12-08T17:45:46.863Z","comments":true,"path":"2019/12/09/spring-boot-server-deploy-monitor/","link":"","permalink":"http://throwable.club/2019/12/09/spring-boot-server-deploy-monitor/","excerpt":"å‰æ å½“æˆ‘ä»¬åœ¨ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²äº†SpringBootåº”ç”¨çš„æ—¶å€™ï¼Œè™½ç„¶å¯ä»¥é€šè¿‡Jenkinsçš„æ„å»ºçŠ¶æ€å’ŒLinuxçš„pså‘½ä»¤å»æ„ŸçŸ¥åº”ç”¨æ˜¯å¦åœ¨æ–°çš„ä¸€æ¬¡å‘å¸ƒä¸­éƒ¨ç½²å’Œå¯åŠ¨æˆåŠŸï¼Œä½†æ˜¯è¿™ç§ç›‘æ§æ‰‹æ®µæ˜¯è¿ç»´å±‚é¢çš„ã€‚é‚£ä¹ˆï¼Œå¯ä»¥æä¾›ä¸€ç§æ‰‹æ®µèƒ½å¤Ÿåœ¨åº”ç”¨å±‚é¢æ„ŸçŸ¥æœåŠ¡åœ¨æ–°çš„ä¸€æ¬¡å‘å¸ƒä¸­çš„æ„å»ºéƒ¨ç½²å’Œå¯åŠ¨æ˜¯å¦æˆåŠŸå—ï¼Ÿè¿™ä¸ªé—®é¢˜ç¬”è€…èŠ±äº†ä¸€ç‚¹æ—¶é—´æƒ³é€šäº†è¿™ä¸ªé—®é¢˜ï¼Œé€šè¿‡è¿™ç¯‡æ–‡ç« æä¾›ä¸€ä¸ªç®€å•çš„å®ç°æ€è·¯ã€‚","text":"å‰æ å½“æˆ‘ä»¬åœ¨ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²äº†SpringBootåº”ç”¨çš„æ—¶å€™ï¼Œè™½ç„¶å¯ä»¥é€šè¿‡Jenkinsçš„æ„å»ºçŠ¶æ€å’ŒLinuxçš„pså‘½ä»¤å»æ„ŸçŸ¥åº”ç”¨æ˜¯å¦åœ¨æ–°çš„ä¸€æ¬¡å‘å¸ƒä¸­éƒ¨ç½²å’Œå¯åŠ¨æˆåŠŸï¼Œä½†æ˜¯è¿™ç§ç›‘æ§æ‰‹æ®µæ˜¯è¿ç»´å±‚é¢çš„ã€‚é‚£ä¹ˆï¼Œå¯ä»¥æä¾›ä¸€ç§æ‰‹æ®µèƒ½å¤Ÿåœ¨åº”ç”¨å±‚é¢æ„ŸçŸ¥æœåŠ¡åœ¨æ–°çš„ä¸€æ¬¡å‘å¸ƒä¸­çš„æ„å»ºéƒ¨ç½²å’Œå¯åŠ¨æ˜¯å¦æˆåŠŸå—ï¼Ÿè¿™ä¸ªé—®é¢˜ç¬”è€…èŠ±äº†ä¸€ç‚¹æ—¶é—´æƒ³é€šäº†è¿™ä¸ªé—®é¢˜ï¼Œé€šè¿‡è¿™ç¯‡æ–‡ç« æä¾›ä¸€ä¸ªç®€å•çš„å®ç°æ€è·¯ã€‚ åŸºæœ¬æ€è·¯ å…¶å®åŸºæœ¬æ€è·¯å¾ˆç®€å•ï¼Œä¸€èˆ¬SpringBootåº”ç”¨ä¼šä½¿ç”¨Mavenæ’ä»¶æ‰“åŒ…ï¼ˆç¬”è€…ä¸ç†Ÿæ‚‰Gradleï¼Œæ‰€ä»¥æš‚æ—¶ä¸å¯¹Gradleåšåˆ†æï¼‰ï¼Œæ‰€ä»¥å¯ä»¥è¿™æ ·è€ƒè™‘ï¼š Mavenæ’ä»¶æ‰“åŒ…çš„æ—¶å€™ï¼ŒæŠŠæ„å»ºæ—¶é—´å’Œpomæ–‡ä»¶ä¸­çš„ç‰ˆæœ¬å·éƒ½å†™åˆ°jaråŒ…çš„æè¿°æ–‡ä»¶ä¸­ï¼Œæ­£ç¡®æ¥è¯´å°±æ˜¯MANIFEST.MFæ–‡ä»¶ä¸­ã€‚ å¼•å…¥spring-boot-starter-actuatorï¼Œé€šè¿‡/actuator/infoç«¯ç‚¹å»æš´éœ²åº”ç”¨çš„ä¿¡æ¯ï¼ˆæœ€å¥½æ§åˆ¶ç½‘ç»œè®¿é—®æƒé™ä¸ºåªå…è®¸å†…ç½‘è®¿é—®ï¼‰ã€‚ æŠŠç¬¬1æ­¥ä¸­æ‰“åŒ…åˆ°jaråŒ…ä¸­çš„MANIFEST.MFæ–‡ä»¶çš„å†…å®¹è¯»å–å¹¶ä¸”åŠ è½½åˆ°SpringBootç¯å¢ƒå±æ€§ä¸­çš„info.*å±æ€§ä¸­ï¼Œä»¥ä¾¿å¯ä»¥é€šè¿‡/actuator/infoè®¿é—®ã€‚ æ€è·¯å®šå¥½äº†ï¼Œé‚£ä¹ˆä¸‹é¢å¼€å§‹å®æ–½ç¼–ç ã€‚ ç¼–ç å®ç° æœ€è¿‘åˆšå¥½åœ¨è°ƒç ”èš‚èšé‡‘æœçš„SofaStackä½“ç³»ï¼Œè¿™é‡Œå¼•å…¥SofaBootç¼–å†™ç¤ºä¾‹ã€‚pomæ–‡ä»¶å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596&lt;?xml version=\"1.0\" encoding=\"UTF-8\"?&gt;&lt;project xmlns=\"http://maven.apache.org/POM/4.0.0\" xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\" xsi:schemaLocation=\"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd\"&gt; &lt;modelVersion&gt;4.0.0&lt;/modelVersion&gt; &lt;groupId&gt;club.throwable&lt;/groupId&gt; &lt;artifactId&gt;sofa-boot-sample&lt;/artifactId&gt; &lt;version&gt;1.0-SNAPSHOT&lt;/version&gt; &lt;packaging&gt;jar&lt;/packaging&gt; &lt;name&gt;sofa-boot-sample&lt;/name&gt; &lt;properties&gt; &lt;project.build.sourceEncoding&gt;UTF-8&lt;/project.build.sourceEncoding&gt; &lt;maven.compiler.source&gt;1.8&lt;/maven.compiler.source&gt; &lt;maven.compiler.target&gt;1.8&lt;/maven.compiler.target&gt; &lt;sofa.boot.version&gt;3.2.0&lt;/sofa.boot.version&gt; &lt;spring.boot.version&gt;2.1.0.RELEASE&lt;/spring.boot.version&gt; &lt;maven.build.timestamp.format&gt;yyyy-MM-dd HH:mm:ss.SSS&lt;/maven.build.timestamp.format&gt; &lt;/properties&gt; &lt;dependencyManagement&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-dependencies&lt;/artifactId&gt; &lt;version&gt;$&#123;spring.boot.version&#125;&lt;/version&gt; &lt;type&gt;pom&lt;/type&gt; &lt;scope&gt;import&lt;/scope&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.alipay.sofa&lt;/groupId&gt; &lt;artifactId&gt;sofaboot-dependencies&lt;/artifactId&gt; &lt;version&gt;$&#123;sofa.boot.version&#125;&lt;/version&gt; &lt;type&gt;pom&lt;/type&gt; &lt;scope&gt;import&lt;/scope&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;/dependencyManagement&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;junit&lt;/groupId&gt; &lt;artifactId&gt;junit&lt;/artifactId&gt; &lt;version&gt;4.12&lt;/version&gt; &lt;scope&gt;test&lt;/scope&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.alipay.sofa&lt;/groupId&gt; &lt;artifactId&gt;healthcheck-sofa-boot-starter&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;build&gt; &lt;finalName&gt;sofa-boot-sample&lt;/finalName&gt; &lt;plugins&gt; &lt;plugin&gt; &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt; &lt;version&gt;3.8.1&lt;/version&gt; &lt;configuration&gt; &lt;source&gt;$&#123;maven.compiler.source&#125;&lt;/source&gt; &lt;target&gt;$&#123;maven.compiler.target&#125;&lt;/target&gt; &lt;encoding&gt;$&#123;project.build.sourceEncoding&#125;&lt;/encoding&gt; &lt;/configuration&gt; &lt;/plugin&gt; &lt;plugin&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt; &lt;version&gt;$&#123;spring.boot.version&#125;&lt;/version&gt; &lt;executions&gt; &lt;execution&gt; &lt;goals&gt; &lt;goal&gt;repackage&lt;/goal&gt; &lt;/goals&gt; &lt;/execution&gt; &lt;/executions&gt; &lt;/plugin&gt; &lt;plugin&gt; &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt; &lt;artifactId&gt;maven-jar-plugin&lt;/artifactId&gt; &lt;version&gt;3.2.0&lt;/version&gt; &lt;configuration&gt; &lt;archive&gt; &lt;manifest&gt; &lt;addBuildEnvironmentEntries&gt;true&lt;/addBuildEnvironmentEntries&gt; &lt;/manifest&gt; &lt;manifestEntries&gt; &lt;Application-Name&gt;$&#123;project.groupId&#125;:$&#123;project.artifactId&#125;:$&#123;project.version&#125;&lt;/Application-Name&gt; &lt;Build-Timestamp&gt;$&#123;maven.build.timestamp&#125;&lt;/Build-Timestamp&gt; &lt;/manifestEntries&gt; &lt;/archive&gt; &lt;/configuration&gt; &lt;/plugin&gt; &lt;/plugins&gt; &lt;/build&gt;&lt;/project&gt; pomæ–‡ä»¶ä¸­ä¸€äº›å±æ€§å’Œå ä½ç¬¦çš„è®¾ç½®ï¼Œå¯ä»¥å‚è€ƒä¸€ä¸‹è¿™ä¸¤ä¸ªé“¾æ¥ï¼šMaven-Archiverå’ŒAvailable Variablesã€‚SpringBootçš„é…ç½®æ–‡ä»¶application.yamlå¦‚ä¸‹ï¼š 12345678910111213141516server: port: 9091management: server: port: 10091 endpoints: enabled-by-default: false web: exposure: include: info endpoint: info: enabled: truespring: application: name: sofa-boot-sample è¿™é‡Œè¦æ³¨æ„ä¸€ç‚¹ï¼šSpringBootåº”ç”¨é€šè¿‡å…¶Mavenæ’ä»¶æ‰“å‡ºæ¥çš„jaråŒ…è§£å‹åçš„ç›®å½•å¦‚ä¸‹ï¼š 12345678910sofa-boot-sample.jar - META-INF - MANIFEST.MF - maven ... - org - springframework - boot ... - BOOT-INF - classes ... - lib ... äº†è§£æ­¤è§£å‹ç›®å½•æ˜¯æˆ‘ä»¬ç¼–å†™MANIFEST.MFæ–‡ä»¶çš„è§£æå®ç°è¿‡ç¨‹çš„å‰æã€‚ç¼–å†™MANIFEST.MFæ–‡ä»¶çš„è§£æç±»ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243@SuppressWarnings(\"ConstantConditions\")public enum ManiFestFileExtractUtils &#123; /** * å•ä¾‹ */ X; private static Map&lt;String, String&gt; RESULT = new HashMap&lt;&gt;(16); private static final Logger LOGGER = LoggerFactory.getLogger(ManiFestFileExtractUtils.class); static &#123; String jarFilePath = ClassUtils.getDefaultClassLoader().getResource(\"\").getPath().replace(\"!/BOOT-INF/classes!/\", \"\"); if (jarFilePath.startsWith(\"file\")) &#123; jarFilePath = jarFilePath.substring(5); &#125; LOGGER.info(\"è¯»å–çš„Jarè·¯å¾„ä¸º:&#123;&#125;\", jarFilePath); try (JarFile jarFile = new JarFile(jarFilePath)) &#123; JarEntry entry = jarFile.getJarEntry(\"META-INF/MANIFEST.MF\"); if (null != entry) &#123; BufferedReader reader = new BufferedReader(new InputStreamReader(jarFile.getInputStream(entry), StandardCharsets.UTF_8)); String line; while (null != (line = reader.readLine())) &#123; LOGGER.info(\"è¯»å–åˆ°è¡Œ:&#123;&#125;\", line); int i = line.indexOf(\":\"); if (i &gt; -1) &#123; String key = line.substring(0, i).trim(); String value = line.substring(i + 1).trim(); RESULT.put(key, value); &#125; &#125; &#125; &#125; catch (Exception e) &#123; LOGGER.warn(\"è§£æMANIFEST.MFæ–‡ä»¶å¼‚å¸¸\", e); &#125; &#125; public Map&lt;String, String&gt; extract() &#123; return RESULT; &#125;&#125; å¯ä»¥é€šè¿‡ä¸€ä¸ªCommandLineRunnerçš„å®ç°æŠŠMANIFEST.MFæ–‡ä»¶çš„å†…å®¹å†™åˆ°Environmentå®ä¾‹ä¸­ï¼š 1234567891011121314151617181920@Componentpublic class SofaBootSampleRunner implements CommandLineRunner &#123; @Autowired private ConfigurableEnvironment configurableEnvironment; @Override public void run(String... args) throws Exception &#123; MutablePropertySources propertySources = configurableEnvironment.getPropertySources(); Map&lt;String, String&gt; result = ManiFestFileExtractUtils.X.extract(); Properties properties = new Properties(); for (Map.Entry&lt;String, String&gt; entry : result.entrySet()) &#123; String key = \"info.\" + entry.getKey(); properties.setProperty(key, entry.getValue()); &#125; if (!properties.isEmpty()) &#123; propertySources.addFirst(new PropertiesPropertySource(\"infoProperties\", properties)); &#125; &#125;&#125; å¯åŠ¨ç±»å¦‚ä¸‹ï¼š 1234567@SpringBootApplicationpublic class SofaBootSampleApplication &#123; public static void main(String[] args) &#123; SpringApplication.run(SofaBootSampleApplication.class, args); &#125;&#125; æœ€ç»ˆæ•ˆæœ åœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä½¿ç”¨å‘½ä»¤mvn packageï¼Œæ‰“å‡ºjaråŒ…åç›´æ¥å¯åŠ¨ï¼š 12cd JaråŒ…çš„ç›®å½•java -jar sofa-boot-sample.jar è°ƒç”¨http://localhost:10091/actuator/infoæ¥å£è¾“å‡ºå¦‚ä¸‹ï¼š 123456789101112&#123; \"Spring-Boot-Version\": \"2.1.0.RELEASE\", \"Start-Class\": \"club.throwable.sofa.SofaBootSampleApplication\", \"Main-Class\": \"org.springframework.boot.loader.JarLauncher\", \"Manifest-Version\": \"1.0\", \"Build-Jdk-Spec\": \"1.8\", \"Spring-Boot-Classes\": \"BOOT-INF/classes/\", \"Created-By\": \"Maven Jar Plugin 3.2.0\", \"Build-Timestamp\": \"2019-12-08 17:41:21.844\", \"Spring-Boot-Lib\": \"BOOT-INF/lib/\", \"Application-Name\": \"club.throwable:sofa-boot-sample:1.0-SNAPSHOT\"&#125; æ”¹å˜pomæ–‡ä»¶ä¸­çš„ç‰ˆæœ¬æ ‡ç­¾&lt;version&gt;ä¸º1.0.0ï¼Œå†æ¬¡æ‰“åŒ…å¹¶ä¸”å¯åŠ¨æˆåŠŸåè°ƒç”¨http://localhost:10091/actuator/infoæ¥å£è¾“å‡ºå¦‚ä¸‹ï¼š 123456789101112&#123; \"Spring-Boot-Version\": \"2.1.0.RELEASE\", \"Start-Class\": \"club.throwable.sofa.SofaBootSampleApplication\", \"Main-Class\": \"org.springframework.boot.loader.JarLauncher\", \"Manifest-Version\": \"1.0\", \"Build-Jdk-Spec\": \"1.8\", \"Spring-Boot-Classes\": \"BOOT-INF/classes/\", \"Created-By\": \"Maven Jar Plugin 3.2.0\", \"Build-Timestamp\": \"2019-12-08 17:42:07.273\", \"Spring-Boot-Lib\": \"BOOT-INF/lib/\", \"Application-Name\": \"club.throwable:sofa-boot-sample:1.0.0\"&#125; å¯è§æ„å»ºæ—¶é—´æˆ³Build-Timestampå’ŒæœåŠ¡åApplication-Nameéƒ½å‘ç”Ÿäº†å˜åŒ–ï¼Œè¾¾åˆ°äº†ç›‘æ§æœåŠ¡æ˜¯å¦æ­£å¸¸éƒ¨ç½²å’Œå¯åŠ¨çš„ç›®çš„ã€‚å¦‚æœæœ‰å¤šä¸ªæœåŠ¡èŠ‚ç‚¹ï¼Œå¯ä»¥æ·»åŠ ä¸€ä¸ªipå±æ€§åŠ ä»¥åŒºåˆ†ã€‚ å°ç»“ è¿™ç¯‡æ–‡ç« é€šè¿‡SpringBootä¸€äº›å®ç”¨æŠ€å·§å®ç°äº†åº”ç”¨å±‚é¢ç›‘æ§åº”ç”¨æ˜¯å¦æ­£å¸¸æ‰“åŒ…éƒ¨ç½²æ›´æ–°å’Œå¯åŠ¨æˆåŠŸçš„é—®é¢˜ã€‚ ï¼ˆæœ¬æ–‡å®Œ e-a-20191209:1:39 c-1-dï¼‰","categories":[{"name":"Spring","slug":"Spring","permalink":"http://throwable.club/blog/categories/Spring/"},{"name":"SpringBoot","slug":"Spring/SpringBoot","permalink":"http://throwable.club/blog/categories/Spring/SpringBoot/"}],"tags":[{"name":"Spring","slug":"Spring","permalink":"http://throwable.club/blog/tags/Spring/"},{"name":"SpringBoot","slug":"SpringBoot","permalink":"http://throwable.club/blog/tags/SpringBoot/"}]},{"title":"SpringMVCè¯·æ±‚å‚æ•°æ¥æ”¶æ€»ç»“(ä¸€)","slug":"spring-mvc-param-handle-summary-1","date":"2019-12-03T17:21:58.000Z","updated":"2019-12-03T17:24:23.170Z","comments":true,"path":"2019/12/04/spring-mvc-param-handle-summary-1/","link":"","permalink":"http://throwable.club/2019/12/04/spring-mvc-param-handle-summary-1/","excerpt":"å‰æ åœ¨æ—¥å¸¸ä½¿ç”¨SpringMVCè¿›è¡Œå¼€å‘çš„æ—¶å€™ï¼Œæœ‰å¯èƒ½é‡åˆ°å‰ç«¯å„ç§ç±»å‹çš„è¯·æ±‚å‚æ•°ï¼Œè¿™é‡Œåšä¸€æ¬¡ç›¸å¯¹å…¨é¢çš„æ€»ç»“ã€‚SpringMVCä¸­å¤„ç†æ§åˆ¶å™¨å‚æ•°çš„æ¥å£æ˜¯HandlerMethodArgumentResolverï¼Œæ­¤æ¥å£æœ‰ä¼—å¤šå­ç±»ï¼Œåˆ†åˆ«å¤„ç†ä¸åŒ(æ³¨è§£ç±»å‹)çš„å‚æ•°ï¼Œä¸‹é¢åªåˆ—ä¸¾å‡ ä¸ªå­ç±»ï¼š RequestParamMethodArgumentResolverï¼šè§£æå¤„ç†ä½¿ç”¨äº†@RequestParamæ³¨è§£çš„å‚æ•°ã€MultipartFileç±»å‹å‚æ•°å’ŒSimpleç±»å‹(å¦‚longã€intç­‰ç±»å‹)å‚æ•°ã€‚ RequestResponseBodyMethodProcessorï¼šè§£æå¤„ç†@RequestBodyæ³¨è§£çš„å‚æ•°ã€‚ PathVariableMapMethodArgumentResolverï¼šè§£æå¤„ç†@PathVariableæ³¨è§£çš„å‚æ•°ã€‚","text":"å‰æ åœ¨æ—¥å¸¸ä½¿ç”¨SpringMVCè¿›è¡Œå¼€å‘çš„æ—¶å€™ï¼Œæœ‰å¯èƒ½é‡åˆ°å‰ç«¯å„ç§ç±»å‹çš„è¯·æ±‚å‚æ•°ï¼Œè¿™é‡Œåšä¸€æ¬¡ç›¸å¯¹å…¨é¢çš„æ€»ç»“ã€‚SpringMVCä¸­å¤„ç†æ§åˆ¶å™¨å‚æ•°çš„æ¥å£æ˜¯HandlerMethodArgumentResolverï¼Œæ­¤æ¥å£æœ‰ä¼—å¤šå­ç±»ï¼Œåˆ†åˆ«å¤„ç†ä¸åŒ(æ³¨è§£ç±»å‹)çš„å‚æ•°ï¼Œä¸‹é¢åªåˆ—ä¸¾å‡ ä¸ªå­ç±»ï¼š RequestParamMethodArgumentResolverï¼šè§£æå¤„ç†ä½¿ç”¨äº†@RequestParamæ³¨è§£çš„å‚æ•°ã€MultipartFileç±»å‹å‚æ•°å’ŒSimpleç±»å‹(å¦‚longã€intç­‰ç±»å‹)å‚æ•°ã€‚ RequestResponseBodyMethodProcessorï¼šè§£æå¤„ç†@RequestBodyæ³¨è§£çš„å‚æ•°ã€‚ PathVariableMapMethodArgumentResolverï¼šè§£æå¤„ç†@PathVariableæ³¨è§£çš„å‚æ•°ã€‚ å®é™…ä¸Šï¼Œä¸€èˆ¬åœ¨è§£æä¸€ä¸ªæ§åˆ¶å™¨çš„è¯·æ±‚å‚æ•°çš„æ—¶å€™ï¼Œç”¨åˆ°çš„æ˜¯HandlerMethodArgumentResolverCompositeï¼Œé‡Œé¢è£…è½½äº†æ‰€æœ‰å¯ç”¨çš„HandlerMethodArgumentResolverå­ç±»ã€‚è€ŒHandlerMethodArgumentResolverå­ç±»åœ¨è§£æå‚æ•°çš„æ—¶å€™ä½¿ç”¨åˆ°HttpMessageConverterï¼ˆå®é™…ä¸Šä¹Ÿæ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œè¿›è¡Œéå†åŒ¹é…è§£æï¼‰å­ç±»è¿›è¡ŒåŒ¹é…è§£æï¼Œå¸¸è§çš„å¦‚MappingJackson2HttpMessageConverterï¼ˆä½¿ç”¨Jacksonè¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼‰ã€‚è€ŒHandlerMethodArgumentResolverå­ç±»åˆ°åº•ä¾èµ–ä»€ä¹ˆHttpMessageConverterå®ä¾‹å®é™…ä¸Šæ˜¯ç”±è¯·æ±‚å¤´ä¸­çš„Content-Typeï¼ˆåœ¨SpringMVCä¸­ç»Ÿä¸€å‘½åä¸ºMediaTypeï¼Œè§org.springframework.http.MediaTypeï¼‰å†³å®šçš„ï¼Œå› æ­¤æˆ‘ä»¬åœ¨å¤„ç†æ§åˆ¶å™¨çš„è¯·æ±‚å‚æ•°ä¹‹å‰å¿…é¡»è¦æ˜ç¡®å¤–éƒ¨è¯·æ±‚çš„Content-Typeåˆ°åº•æ˜¯ä»€ä¹ˆã€‚ä¸Šé¢çš„é€»è¾‘å¯ä»¥ç›´æ¥çœ‹æºç AbstractMessageConverterMethodArgumentResolver#readWithMessageConvertersï¼Œæ€è·¯æ˜¯æ¯”è¾ƒæ¸…æ™°çš„ã€‚åœ¨@RequestMappingæ³¨è§£ä¸­ï¼Œproduceså’Œconsumeså±æ€§å°±æ˜¯å’Œè¯·æ±‚æˆ–è€…å“åº”çš„Content-Typeç›¸å…³çš„ï¼š consumeså±æ€§ï¼šæŒ‡å®šå¤„ç†è¯·æ±‚çš„æäº¤å†…å®¹ç±»å‹ï¼ˆContent-Typeï¼‰ï¼Œä¾‹å¦‚application/jsonã€text/htmlç­‰ç­‰ï¼Œåªæœ‰å‘½ä¸­äº†å¯¹åº”çš„Content-Typeçš„å€¼æ‰ä¼šæ¥å—è¯¥è¯·æ±‚ã€‚ produceså±æ€§ï¼šæŒ‡å®šè¿”å›çš„å†…å®¹ç±»å‹ï¼Œä»…å½“æŸä¸ªè¯·æ±‚çš„è¯·æ±‚å¤´ä¸­çš„ï¼ˆAcceptï¼‰ç±»å‹ä¸­åŒ…å«è¯¥æŒ‡å®šç±»å‹æ‰è¿”å›ï¼Œå¦‚æœè¿”å›çš„æ˜¯JSONæ•°æ®ä¸€èˆ¬è€ƒè™‘ä½¿ç”¨application/json;charset=UTF-8ã€‚ å¦å¤–æä¸€ç‚¹ï¼ŒSpringMVCä¸­é»˜è®¤ä½¿ç”¨Jacksonä½œä¸ºJSONçš„å·¥å…·åŒ…ï¼Œå¦‚æœä¸æ˜¯å®Œå…¨ç†è§£é€æ•´å¥—æºç çš„è¿ä½œï¼Œä¸€èˆ¬ä¸æ˜¯ååˆ†å»ºè®®ä¿®æ”¹é»˜è®¤ä½¿ç”¨çš„MappingJackson2HttpMessageConverterï¼ˆä¾‹å¦‚æœ‰äº›äººå–œæ¬¢ä½¿ç”¨FastJsonï¼Œå®ç°HttpMessageConverterå¼•å…¥FastJsonåšHTTPæ¶ˆæ¯è½¬æ¢å™¨ï¼Œè¿™ç§åšæ³•å¹¶ä¸æ¨èï¼‰ã€‚ SpringMVCè¯·æ±‚å‚æ•°æ¥æ”¶ å…¶å®ä¸€èˆ¬çš„è¡¨å•æˆ–è€…JSONæ•°æ®çš„è¯·æ±‚éƒ½æ˜¯ç›¸å¯¹ç®€å•çš„ï¼Œä¸€äº›å¤æ‚çš„å¤„ç†ä¸»è¦åŒ…æ‹¬URLè·¯å¾„å‚æ•°ã€æ–‡ä»¶ä¸Šä¼ ã€æ•°ç»„æˆ–è€…åˆ—è¡¨ç±»å‹æ•°æ®ç­‰ã€‚å¦å¤–ï¼Œå…³äºå‚æ•°ç±»å‹ä¸­å­˜åœ¨æ—¥æœŸç±»å‹å±æ€§ï¼ˆä¾‹å¦‚java.util.Dateã€java.sql.Dateã€java.time.LocalDateã€java.time.LocalDateTimeã€java.time.ZonedDateTimeç­‰ç­‰ï¼‰ï¼Œè§£æçš„æ—¶å€™ä¸€èˆ¬éœ€è¦è‡ªå®šä¹‰å®ç°çš„é€»è¾‘å®ç°String--&gt;æ—¥æœŸç±»å‹çš„è½¬æ¢ã€‚å…¶å®é“ç†å¾ˆç®€å•ï¼Œæ—¥æœŸç›¸å…³çš„ç±»å‹å¯¹äºæ¯ä¸ªå›½å®¶ã€æ¯ä¸ªæ—¶åŒºç”šè‡³æ¯ä¸ªä½¿ç”¨è€…æ¥è¯´è®¤çŸ¥éƒ½ä¸ä¸€å®šç›¸åŒï¼Œæ‰€ä»¥SpringMVCå¹¶æ²¡æœ‰å¯¹äºæ—¥æœŸæ—¶é—´ç±»å‹çš„è§£ææä¾›ä¸€ä¸ªé€šç”¨çš„è§£å†³æ–¹æ¡ˆã€‚åœ¨æ¼”ç¤ºä¸€äº›ä¾‹å­å¯èƒ½ç”¨åˆ°ä¸‹é¢çš„æ¨¡ç‰¹ç±»ï¼š 1234567891011121314@Datapublic class User &#123; private String name; private Integer age; private List&lt;Contact&gt; contacts;&#125;@Datapublic class Contact &#123; private String name; private String phone;&#125; ä¸‹é¢ä¸»è¦ä»¥HTTPçš„GETæ–¹æ³•å’ŒPOSTæ–¹æ³•æäº¤åœ¨SpringMVCä½“ç³»ä¸­æ­£ç¡®å¤„ç†å‚æ•°çš„ä¾‹å­è¿›è¡Œåˆ†æï¼Œè¿˜ä¼šèŠ±ç²¾åŠ›æ•´ç†SpringMVCä½“ç³»ä¸­ç‹¬æœ‰çš„URLè·¯å¾„å‚æ•°å¤„ç†çš„ä¸€äº›æŠ€å·§ä»¥åŠæœ€å¸¸è§çš„æ—¥æœŸå‚æ•°å¤„ç†çš„åˆç†å®è·µï¼ˆå¯¹äºGETæ–¹æ³•å’ŒPOSTæ–¹æ³•æäº¤çš„å‚æ•°å¤„ç†ï¼ŒåŸºæœ¬å›Šæ‹¬äº†å…¶ä»–å¦‚DELETEã€PUTç­‰æ–¹æ³•çš„å‚æ•°å¤„ç†ï¼Œéšæœºåº”å˜å³å¯ï¼‰ã€‚ GETæ–¹æ³•è¯·æ±‚å‚æ•°å¤„ç† HTTP(s)åè®®ä½¿ç”¨GETæ–¹æ³•è¿›è¡Œè¯·æ±‚çš„æ—¶å€™ï¼Œæäº¤çš„å‚æ•°ä½äºURLæ¨¡å¼çš„Queryéƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯URLçš„?ä¹‹åçš„å‚æ•°ï¼Œæ ¼å¼æ˜¯key1=value1&amp;key2=value2ã€‚GETæ–¹æ³•è¯·æ±‚å‚æ•°å¯ä»¥æœ‰å¤šç§æ–¹æ³•è·å–ï¼š ä½¿ç”¨@RequestParamæ³¨è§£å¤„ç†ã€‚ ä½¿ç”¨å¯¹è±¡æ¥æ”¶ï¼Œæ³¨æ„å¯¹è±¡çš„å±æ€§åç§°è¦å’ŒQueryä¸­çš„å‚æ•°åç§°ä¸€è‡´ã€‚ ä½¿ç”¨HttpServletRequestå®ä¾‹æä¾›çš„æ–¹æ³•ï¼ˆä¸æ¨èï¼Œå­˜åœ¨ç¡¬ç¼–ç ï¼‰ã€‚ å‡è®¾è¯·æ±‚çš„URLä¸ºhttp://localhost:8080/get?name=doge&amp;age=26ï¼Œé‚£ä¹ˆæ§åˆ¶å™¨å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829@Slf4j@RestControllerpublic class SampleController &#123; @GetMapping(path = \"/get1\") public void get1(@RequestParam(name = \"name\") String name, @RequestParam(name = \"age\") Integer age) &#123; log.info(\"name:&#123;&#125;,age:&#123;&#125;\", name, age); &#125; @GetMapping(path = \"/get2\") public void get2(UserVo vo) &#123; log.info(\"name:&#123;&#125;,age:&#123;&#125;\", vo.getName(), vo.getAge()); &#125; @GetMapping(path = \"/get3\") public void get3(HttpServletRequest request) &#123; String name = request.getParameter(\"name\"); String age = request.getParameter(\"age\"); log.info(\"name:&#123;&#125;,age:&#123;&#125;\", name, age); &#125; @Data public static class UserVo &#123; private String name; private Integer age; &#125;&#125; è¡¨å•å‚æ•° è¡¨å•å‚æ•°ï¼Œä¸€èˆ¬å¯¹åº”äºé¡µé¢ä¸Š&lt;form&gt;æ ‡ç­¾å†…çš„æ‰€æœ‰&lt;input&gt;æ ‡ç­¾çš„name-valueèšåˆè€Œæˆçš„å‚æ•°ï¼Œä¸€èˆ¬Content-TypeæŒ‡å®šä¸ºapplication/x-www-form-urlencodedï¼Œä¹Ÿå°±æ˜¯ä¼šè¿›è¡ŒURLç¼–ç ã€‚ä¸‹é¢ä»‹ç»å‡ ç§å¸¸è§çš„è¡¨å•å‚æ•°æäº¤çš„å‚æ•°å½¢å¼ã€‚ ã€éå¯¹è±¡ã€‘- éå¯¹è±¡ç±»å‹å•ä¸ªå‚æ•°æ¥æ”¶ã€‚ å¯¹åº”çš„æ§åˆ¶å™¨å¦‚ä¸‹ï¼š 1234567@PostMapping(value = \"/post\")public String post(@RequestParam(name = \"name\") String name, @RequestParam(name = \"age\") Integer age) &#123; String content = String.format(\"name = %s,age = %d\", name, age); log.info(content); return content;&#125; è¯´å®è¯ï¼Œå¦‚æœæœ‰æ¯…åŠ›çš„è¯ï¼Œæ‰€æœ‰çš„å¤æ‚å‚æ•°çš„æäº¤æœ€ç»ˆéƒ½å¯ä»¥è½¬åŒ–ä¸ºå¤šä¸ªå•å‚æ•°æ¥æ”¶ï¼Œä¸è¿‡è¿™æ ·åšä¼šäº§ç”Ÿååˆ†å¤šå†—ä½™çš„ä»£ç ï¼Œè€Œä¸”å¯ç»´æŠ¤æ€§æ¯”è¾ƒä½ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œç”¨åˆ°çš„å‚æ•°å¤„ç†å™¨æ˜¯RequestParamMapMethodArgumentResolverã€‚ ã€å¯¹è±¡ã€‘ - å¯¹è±¡ç±»å‹å‚æ•°æ¥æ”¶ã€‚ æˆ‘ä»¬æ¥ç€å†™ä¸€ä¸ªæ¥å£ç”¨äºæäº¤ç”¨æˆ·ä¿¡æ¯ï¼Œç”¨åˆ°çš„æ˜¯ä¸Šé¢æåˆ°çš„æ¨¡ç‰¹ç±»ï¼Œä¸»è¦åŒ…æ‹¬ç”¨æˆ·å§“åã€å¹´é¾„å’Œè”ç³»äººä¿¡æ¯åˆ—è¡¨ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬ç›®æ ‡çš„æ§åˆ¶å™¨æœ€ç»ˆç¼–ç å¦‚ä¸‹ï¼š 12345@PostMapping(value = \"/user\")public User saveUser(User user) &#123; log.info(user.toString()); return user;&#125; æˆ‘ä»¬è¿˜æ˜¯æŒ‡å®šContent-Typeä¸ºapplication/x-www-form-urlencodedï¼Œæ¥ç€æˆ‘ä»¬éœ€è¦æ„é€ è¯·æ±‚å‚æ•°ï¼š å› ä¸ºæ²¡æœ‰ä½¿ç”¨æ³¨è§£ï¼Œæœ€ç»ˆçš„å‚æ•°å¤„ç†å™¨ä¸ºServletModelAttributeMethodProcessorï¼Œä¸»è¦æ˜¯æŠŠHttpServletRequestä¸­çš„è¡¨å•å‚æ•°å°è£…åˆ°MutablePropertyValueså®ä¾‹ä¸­ï¼Œå†é€šè¿‡å‚æ•°ç±»å‹å®ä¾‹åŒ–(é€šè¿‡æ„é€ åå°„åˆ›å»ºUserå®ä¾‹)ï¼Œåå°„åŒ¹é…å±æ€§è¿›è¡Œå€¼çš„å¡«å……ã€‚å¦å¤–ï¼Œè¯·æ±‚å¤æ‚å‚æ•°é‡Œé¢çš„åˆ—è¡¨å±æ€§è¯·æ±‚å‚æ•°çœ‹èµ·æ¥æ¯”è¾ƒå¥‡è‘©ï¼Œå®é™…ä¸Šå’Œåœ¨.propertiesæ–‡ä»¶ä¸­æ·»åŠ æœ€ç»ˆæ˜ å°„åˆ°Mapç±»å‹çš„å‚æ•°çš„å†™æ³•æ˜¯ä¸€è‡´çš„ã€‚é‚£ä¹ˆï¼Œèƒ½ä¸èƒ½æŠŠæ•´ä¸ªè¯·æ±‚å‚æ•°å¡åœ¨ä¸€ä¸ªå­—æ®µä¸­æäº¤å‘¢ï¼Ÿ ç›´æ¥è¿™æ ·åšæ˜¯ä¸è¡Œçš„ï¼Œå› ä¸ºå®é™…æäº¤çš„Formè¡¨å•ï¼Œkeyæ˜¯userå­—ç¬¦ä¸²ï¼Œvalueå®é™…ä¸Šä¹Ÿæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œç¼ºå°‘ä¸€ä¸ªString-&gt;Userç±»å‹çš„è½¬æ¢å™¨ï¼Œå®é™…ä¸ŠRequestParamMethodArgumentResolverä¾èµ–WebConversionServiceä¸­Converterå®ä¾‹åˆ—è¡¨è¿›è¡Œå‚æ•°è½¬æ¢ï¼š è§£å†³åŠæ³•è¿˜æ˜¯æœ‰çš„ï¼Œæ·»åŠ ä¸€ä¸ªorg.springframework.core.convert.converter.Converterå®ç°å³å¯ï¼š 123456789101112131415@Componentpublic class StringUserConverter implements Converter&lt;String, User&gt; &#123; @Autowaired private ObjectMapper objectMapper; @Override public User convert(String source) &#123; try &#123; return objectMapper.readValue(source, User.class); &#125; catch (IOException e) &#123; throw new IllegalArgumentException(e); &#125; &#125;&#125; ä¸Šé¢è¿™ç§åšæ³•å±äºæ›²çº¿æ•‘å›½çš„åšæ³•ï¼Œä¸æ¨èä½¿ç”¨åœ¨ç”Ÿäº§ç¯å¢ƒï¼Œä½†æ˜¯å¦‚æœæœ‰äº›ç¬¬ä¸‰æ–¹æ¥å£çš„å¯¹æ¥æ— æ³•é¿å…è¿™ç§å‚æ•°ï¼Œå¯ä»¥é€‰æ‹©è¿™ç§å®ç°æ–¹å¼ã€‚ ã€æ•°ç»„ã€‘ - åˆ—è¡¨æˆ–è€…æ•°ç»„ç±»å‹å‚æ•°ã€‚ æåº¦ä¸æ¨èä½¿ç”¨åœ¨application/x-www-form-urlencodedè¿™ç§åª’ä½“ç±»å‹çš„è¡¨å•æäº¤çš„å½¢å¼ä¸‹å¼ºè¡Œä½¿ç”¨åˆ—è¡¨æˆ–è€…æ•°ç»„ç±»å‹å‚æ•°ï¼Œé™¤éæ˜¯ä¸ºäº†å…¼å®¹å¤„ç†å†å²é—ç•™ç³»ç»Ÿçš„å‚æ•°æäº¤å¤„ç†ã€‚ä¾‹å¦‚æäº¤çš„å‚æ•°å½¢å¼æ˜¯ï¼š 1list &#x3D; [&quot;string-1&quot;, &quot;string-2&quot;, &quot;string-3&quot;] é‚£ä¹ˆè¡¨å•å‚æ•°çš„å½¢å¼è¦å†™æˆï¼š name value list[0] string-1 list[1] string-2 list[2] string-3 æ§åˆ¶å™¨çš„ä»£ç å¦‚ä¸‹ï¼š 1234@PostMapping(path = \"/list\")public void list(@RequestParam(name=\"list\") List&lt;String&gt; list) &#123; log.info(list);&#125; ä¸€ä¸ªæ›´åŠ å¤æ‚çš„ä¾‹å­å¦‚ä¸‹ï¼Œå‡è®¾æƒ³è¦æäº¤çš„æŠ¥æ–‡æ ¼å¼å¦‚ä¸‹ï¼š 1user &#x3D; [&#123;&quot;name&quot;:&quot;doge-1&quot;,&quot;age&quot;: 21&#125;,&#123;&quot;name&quot;:&quot;doge-2&quot;,&quot;age&quot;: 22&#125;] é‚£ä¹ˆè¡¨å•å‚æ•°çš„å½¢å¼è¦å†™æˆï¼š name value user[0].name doge-1 user[0].age 21 user[1].name doge-2 user[1].age 22 æ§åˆ¶å™¨çš„ä»£ç å¦‚ä¸‹ï¼š 1234567891011@PostMapping(path = \"/user\")public void saveUsers(@RequestParam(name=\"user\") List&lt;UserVo&gt; users) &#123; log.info(users);&#125;@Datapublic class UserVo&#123; private String name; private Integer age;&#125; JSONå‚æ•° ä¸€èˆ¬æ¥è¯´ï¼Œç›´æ¥åœ¨POSTè¯·æ±‚ä¸­çš„è¯·æ±‚ä½“æäº¤ä¸€ä¸ªJSONå­—ç¬¦ä¸²è¿™ç§æ–¹å¼å¯¹äºSpringMVCæ¥è¯´æ˜¯æ¯”è¾ƒå‹å¥½çš„ï¼Œåªéœ€è¦æŠŠContent-Typeè®¾ç½®ä¸ºapplication/jsonï¼Œæäº¤ä¸€ä¸ªåŸå§‹çš„JSONå­—ç¬¦ä¸²å³å¯ï¼Œæ§åˆ¶å™¨æ–¹æ³•å‚æ•°ä½¿ç”¨@RequestBodyæ³¨è§£å¤„ç†ï¼š åç«¯æ§åˆ¶å™¨çš„ä»£ç ä¹Ÿæ¯”è¾ƒç®€å•ï¼š 12345@PostMapping(value = \"/user-2\")public User saveUser2(@RequestBody User user) &#123; log.info(user.toString()); return user;&#125; å› ä¸ºä½¿ç”¨äº†@RequestBodyæ³¨è§£ï¼Œæœ€ç»ˆä½¿ç”¨åˆ°çš„å‚æ•°å¤„ç†å™¨ä¸ºRequestResponseBodyMethodProcessorï¼Œå®é™…ä¸Šä¼šç”¨åˆ°MappingJackson2HttpMessageConverterè¿›è¡Œå‚æ•°ç±»å‹çš„è½¬æ¢ï¼Œåº•å±‚ä¾èµ–åˆ°Jacksonç›¸å…³çš„åŒ…ã€‚æ¨èä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œè¿™æ˜¯æœ€å¸¸ç”¨ä¹Ÿæ˜¯æœ€ç¨³å¥çš„JSONå‚æ•°å¤„ç†æ–¹å¼ã€‚ URLè·¯å¾„å‚æ•° URLè·¯å¾„å‚æ•°ï¼Œæˆ–è€…å«è¯·æ±‚è·¯å¾„å‚æ•°æ˜¯åŸºäºURLæ¨¡æ¿è·å–åˆ°çš„å‚æ•°ï¼Œä¾‹å¦‚/user/{userId}æ˜¯ä¸€ä¸ªURLæ¨¡æ¿(URLæ¨¡æ¿ä¸­çš„å‚æ•°å ä½ç¬¦æ˜¯{})ï¼Œå®é™…è¯·æ±‚çš„URLä¸º/user/1ï¼Œé‚£ä¹ˆé€šè¿‡åŒ¹é…å®é™…è¯·æ±‚çš„URLå’ŒURLæ¨¡æ¿å°±èƒ½æå–åˆ°userIdä¸º1ã€‚åœ¨SpringMVCä¸­ï¼ŒURLæ¨¡æ¿ä¸­çš„è·¯å¾„å‚æ•°å«åšPathVariableï¼Œå¯¹åº”æ³¨è§£@PathVariableï¼Œå¯¹åº”çš„å‚æ•°å¤„ç†å™¨ä¸ºPathVariableMethodArgumentResolverã€‚æ³¨æ„ä¸€ç‚¹æ˜¯ï¼Œ@PathVariableçš„è§£ææ˜¯æŒ‰ç…§value(name)å±æ€§è¿›è¡ŒåŒ¹é…ï¼Œå’ŒURLå‚æ•°çš„é¡ºåºæ˜¯æ— å…³çš„ã€‚ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼š åå°çš„æ§åˆ¶å™¨å¦‚ä¸‹ï¼š 1234567@GetMapping(value = \"/user/&#123;name&#125;/&#123;age&#125;\")public String findUser1(@PathVariable(value = \"age\") Integer age, @PathVariable(value = \"name\") String name) &#123; String content = String.format(\"name = %s,age = %d\", name, age); log.info(content); return content;&#125; è¿™ç§ç”¨æ³•è¢«å¹¿æ³›ä½¿ç”¨äºRepresentational State Transfer(REST)çš„è½¯ä»¶æ¶æ„é£æ ¼ï¼Œä¸ªäººè§‰å¾—è¿™ç§é£æ ¼æ˜¯æ¯”è¾ƒçµæ´»å’Œæ¸…æ™°çš„(ä»URLå’Œè¯·æ±‚æ–¹æ³•å°±èƒ½å®Œå…¨ç†è§£æ¥å£çš„æ„ä¹‰å’ŒåŠŸèƒ½)ã€‚ä¸‹é¢å†ä»‹ç»ä¸¤ç§ç›¸å¯¹ç‰¹æ®Šçš„ä½¿ç”¨æ–¹å¼ã€‚ å¸¦æ¡ä»¶çš„URLå‚æ•°ã€‚ å…¶å®è·¯å¾„å‚æ•°æ”¯æŒæ­£åˆ™è¡¨è¾¾å¼ï¼Œä¾‹å¦‚æˆ‘ä»¬åœ¨ä½¿ç”¨/sex/{sex}æ¥å£çš„æ—¶å€™ï¼Œè¦æ±‚sexå¿…é¡»æ˜¯F(Female)æˆ–è€…M(Male)ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„URLæ¨¡æ¿å¯ä»¥å®šä¹‰ä¸º/sex/{sex:M|F}ï¼Œä»£ç å¦‚ä¸‹ï¼š 12345@GetMapping(value = \"/sex/&#123;sex:M|F&#125;\")public String findUser2(@PathVariable(value = \"sex\") String sex)&#123; log.info(sex); return sex;&#125; åªæœ‰/sex/Fæˆ–è€…/sex/Mçš„è¯·æ±‚æ‰ä¼šè¿›å…¥findUser2()æ§åˆ¶å™¨æ–¹æ³•ï¼Œå…¶ä»–è¯¥è·¯å¾„å‰ç¼€çš„è¯·æ±‚éƒ½æ˜¯éæ³•çš„ï¼Œä¼šè¿”å›404çŠ¶æ€ç ã€‚è¿™é‡Œä»…ä»…æ˜¯ä»‹ç»äº†ä¸€ä¸ªæœ€ç®€å•çš„URLå‚æ•°æ­£åˆ™è¡¨è¾¾å¼çš„ä½¿ç”¨æ–¹å¼ï¼Œæ›´å¼ºå¤§çš„ç”¨æ³•å¯ä»¥è‡ªè¡Œæ‘¸ç´¢ã€‚ @MatrixVariableçš„ä½¿ç”¨ã€‚ MatrixVariableä¹Ÿæ˜¯URLå‚æ•°çš„ä¸€ç§ï¼Œå¯¹åº”æ³¨è§£@MatrixVariableï¼Œä¸è¿‡å®ƒå¹¶ä¸æ˜¯URLä¸­çš„ä¸€ä¸ªå€¼(è¿™é‡Œçš„å€¼æŒ‡å®šæ˜¯ä¸¤ä¸ª&quot;/â€œä¹‹é—´çš„éƒ¨åˆ†)ï¼Œè€Œæ˜¯å€¼çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒé€šè¿‡â€;â€œè¿›è¡Œåˆ†éš”ï¼Œé€šè¿‡â€=&quot;è¿›è¡ŒK-Vè®¾ç½®ã€‚è¯´èµ·æ¥æœ‰ç‚¹æŠ½è±¡ï¼Œä¸¾ä¸ªä¾‹å­ï¼šå‡å¦‚æˆ‘ä»¬éœ€è¦æ‰“ç”µè¯ç»™ä¸€ä¸ªåå­—ä¸ºdogeï¼Œæ€§åˆ«æ˜¯ç”·ï¼Œåˆ†ç»„æ˜¯ç ç•œçš„ç¨‹åºå‘˜ï¼ŒGETè¯·æ±‚çš„URLå¯ä»¥è¡¨ç¤ºä¸ºï¼š/call/doge;gender=male;group=programmerï¼Œæˆ‘ä»¬è®¾è®¡çš„æ§åˆ¶å™¨æ–¹æ³•å¦‚ä¸‹ï¼š 12345678@GetMapping(value = \"/call/&#123;name&#125;\")public String find(@PathVariable(value = \"name\") String name, @MatrixVariable(value = \"gender\") String gender, @MatrixVariable(value = \"group\") String group) &#123; String content = String.format(\"name = %s,gender = %s,group = %s\", name, gender, group); log.info(content); return content;&#125; å½“ç„¶ï¼Œå¦‚æœä½ æŒ‰ç…§ä¸Šé¢çš„ä¾‹å­å†™å¥½ä»£ç ï¼Œå°è¯•è¯·æ±‚ä¸€ä¸‹è¯¥æ¥å£å‘ç°æ˜¯æŠ¥é”™çš„ï¼š400 Bad Request - Missing matrix variable 'gender' for method parameter of type Stringã€‚è¿™æ˜¯å› ä¸º@MatrixVariableæ³¨è§£çš„ä½¿ç”¨æ˜¯ä¸å®‰å…¨çš„ï¼Œåœ¨SpringMVCä¸­é»˜è®¤æ˜¯å…³é—­å¯¹å…¶æ”¯æŒã€‚è¦å¼€å¯å¯¹@MatrixVariableçš„æ”¯æŒï¼Œéœ€è¦è®¾ç½®RequestMappingHandlerMapping#setRemoveSemicolonContentæ–¹æ³•ä¸ºfalseï¼š 1234567891011@Configurationpublic class CustomMvcConfiguration implements InitializingBean &#123; @Autowired private RequestMappingHandlerMapping requestMappingHandlerMapping; @Override public void afterPropertiesSet() throws Exception &#123; requestMappingHandlerMapping.setRemoveSemicolonContent(false); &#125;&#125; é™¤éæœ‰å¾ˆç‰¹æ®Šçš„éœ€è¦ï¼Œå¦åˆ™ä¸å»ºè®®ä½¿ç”¨@MatrixVariableã€‚ æ–‡ä»¶ä¸Šä¼  æ–‡ä»¶ä¸Šä¼ åœ¨ä½¿ç”¨POSTMANæ¨¡æ‹Ÿè¯·æ±‚çš„æ—¶å€™éœ€è¦é€‰æ‹©form-dataï¼ŒPOSTæ–¹å¼è¿›è¡Œæäº¤ï¼š å‡è®¾æˆ‘ä»¬åœ¨Dç›˜æœ‰ä¸€ä¸ªå›¾ç‰‡æ–‡ä»¶å«doge.jpgï¼Œç°åœ¨è¦é€šè¿‡æœ¬åœ°æœåŠ¡æ¥å£æŠŠæ–‡ä»¶ä¸Šä¼ ï¼Œæ§åˆ¶å™¨çš„ä»£ç å¦‚ä¸‹ï¼š 1234567@PostMapping(value = \"/file1\")public String file1(@RequestPart(name = \"file1\") MultipartFile multipartFile) &#123; String content = String.format(\"name = %s,originName = %s,size = %d\", multipartFile.getName(), multipartFile.getOriginalFilename(), multipartFile.getSize()); log.info(content); return content;&#125; æ§åˆ¶å°è¾“å‡ºæ˜¯ï¼š 1name = file1,originName = doge.jpg,size = 68727 å¯èƒ½æœ‰ç‚¹ç–‘æƒ‘ï¼Œå‚æ•°æ˜¯æ€ä¹ˆæ¥çš„ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨Fildderè½¯ä»¶æŠ“ä¸ªåŒ…çœ‹ä¸‹ï¼š å¯çŸ¥MultipartFileå®ä¾‹çš„ä¸»è¦å±æ€§åˆ†åˆ«æ¥è‡ªContent-Dispositionã€Content-Typeå’ŒContent-Lengthï¼Œå¦å¤–ï¼ŒInputStreamç”¨äºè¯»å–è¯·æ±‚ä½“çš„æœ€åéƒ¨åˆ†(æ–‡ä»¶çš„å­—èŠ‚åºåˆ—)ã€‚å‚æ•°å¤„ç†å™¨ç”¨åˆ°çš„æ˜¯RequestPartMethodArgumentResolver(è®°ä½ä¸€ç‚¹ï¼Œä½¿ç”¨äº†@RequestPartå’ŒMultipartFileä¸€å®šæ˜¯ä½¿ç”¨æ­¤å‚æ•°å¤„ç†å™¨)ã€‚åœ¨å…¶ä»–æƒ…å†µä¸‹ï¼Œä½¿ç”¨@RequestParamå’ŒMultipartFileæˆ–è€…ä»…ä»…ä½¿ç”¨MultipartFile(å‚æ•°çš„åå­—å¿…é¡»å’ŒPOSTè¡¨å•ä¸­çš„Content-Dispositionæè¿°çš„nameä¸€è‡´)ä¹Ÿå¯ä»¥æ¥æ”¶ä¸Šä¼ çš„æ–‡ä»¶æ•°æ®ï¼Œä¸»è¦æ˜¯é€šè¿‡RequestParamMethodArgumentResolverè¿›è¡Œè§£æå¤„ç†çš„ï¼Œå®ƒçš„åŠŸèƒ½æ¯”è¾ƒå¼ºå¤§ï¼Œå…·ä½“å¯ä»¥çœ‹å…¶supportsParameteræ–¹æ³•ï¼Œè¿™ä¸¤ç§æƒ…å†µçš„æ§åˆ¶å™¨æ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š 123456789101112131415@PostMapping(value = \"/file2\")public String file2(MultipartFile file1) &#123; String content = String.format(\"name = %s,originName = %s,size = %d\", file1.getName(), file1.getOriginalFilename(), file1.getSize()); log.info(content); return content;&#125;@PostMapping(value = \"/file3\")public String file3(@RequestParam(name = \"file1\") MultipartFile multipartFile) &#123; String content = String.format(\"name = %s,originName = %s,size = %d\", multipartFile.getName(), multipartFile.getOriginalFilename(), multipartFile.getSize()); log.info(content); return content;&#125; å…¶ä»–å‚æ•° å…¶ä»–å‚æ•°ä¸»è¦åŒ…æ‹¬è¯·æ±‚å¤´ã€Cookieã€Modelã€Mapç­‰ç›¸å…³å‚æ•°ï¼Œè¿˜æœ‰ä¸€äº›å¹¶ä¸æ˜¯å¾ˆå¸¸ç”¨æˆ–è€…ä¸€äº›ç›¸å¯¹åŸç”Ÿçš„å±æ€§å€¼è·å–(ä¾‹å¦‚HttpServletRequestã€HttpServletResponseç­‰)ä¸åšè®¨è®ºã€‚ è¯·æ±‚å¤´ è¯·æ±‚å¤´çš„å€¼ä¸»è¦é€šè¿‡@RequestHeaderæ³¨è§£çš„å‚æ•°è·å–ï¼Œå‚æ•°å¤„ç†å™¨æ˜¯RequestHeaderMethodArgumentResolverï¼Œéœ€è¦åœ¨æ³¨è§£ä¸­æŒ‡å®šè¯·æ±‚å¤´çš„Keyã€‚ç®€å•å®ç”¨å¦‚ä¸‹ï¼š æ§åˆ¶å™¨æ–¹æ³•ä»£ç ï¼š 1234@PostMapping(value = \"/header\")public String header(@RequestHeader(name = \"Content-Type\") String Content-Type) &#123; return Content-Type;&#125; Cookie Cookieçš„å€¼ä¸»è¦é€šè¿‡@CookieValueæ³¨è§£çš„å‚æ•°è·å–ï¼Œå‚æ•°å¤„ç†å™¨ä¸ºServletCookieValueMethodArgumentResolverï¼Œéœ€è¦åœ¨æ³¨è§£ä¸­æŒ‡å®šCookieçš„Keyã€‚æ§åˆ¶å™¨æ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š 1234@PostMapping(value = \"/cookie\")public String cookie(@CookieValue(name = \"JSESSIONID\") String sessionId) &#123; return sessionId;&#125; Modelç±»å‹å‚æ•° Modelç±»å‹å‚æ•°çš„å¤„ç†å™¨æ˜¯ModelMethodProcessorï¼Œå®é™…ä¸Šå¤„ç†æ­¤å‚æ•°æ˜¯ç›´æ¥è¿”å›ModelAndViewContainerå®ä¾‹ä¸­çš„Model(ModelMapç±»å‹)ï¼Œå› ä¸ºè¦æ¡¥æ¥ä¸åŒçš„æ¥å£å’Œç±»çš„åŠŸèƒ½ï¼Œå› æ­¤å›è°ƒçš„å®ä¾‹æ˜¯BindingAwareModelMapç±»å‹ï¼Œæ­¤ç±»å‹ç»§æ‰¿è‡ªModelMapåŒæ—¶å®ç°äº†Modelæ¥å£ã€‚ä¸¾ä¸ªä¾‹å­ï¼š 12345@GetMapping(value = \"/model\")public String model(Model model, ModelMap modelMap) &#123; log.info(\"&#123;&#125;\", model == modelMap); return \"success\";&#125; æ³¨æ„è°ƒç”¨æ­¤æ¥å£ï¼Œæ§åˆ¶å°è¾“å‡ºINFOæ—¥å¿—å†…å®¹ä¸ºï¼štrueã€‚è¿˜è¦æ³¨æ„ä¸€ç‚¹ï¼šModelMapæˆ–è€…Modelä¸­æ·»åŠ çš„å±æ€§é¡¹ä¼šé™„åŠ åˆ°HttpRequestServletå®ä¾‹ä¸­å¸¦åˆ°é¡µé¢ä¸­è¿›è¡Œæ¸²æŸ“ã€‚ @ModelAttributeå‚æ•° @ModelAttributeæ³¨è§£å¤„ç†çš„å‚æ•°å¤„ç†å™¨ä¸ºModelAttributeMethodProcessorï¼Œ@ModelAttributeçš„åŠŸèƒ½æºç çš„æ³¨é‡Šå¦‚ä¸‹ï¼š 1Annotation that binds a method parameter or method return value to a named model attribute, exposed to a web view. ç®€å•æ¥è¯´ï¼Œå°±æ˜¯é€šè¿‡key-valueå½¢å¼ç»‘å®šæ–¹æ³•å‚æ•°æˆ–è€…æ–¹æ³•è¿”å›å€¼åˆ°Model(Map)ä¸­ï¼ŒåŒºåˆ«ä¸‹é¢ä¸‰ç§æƒ…å†µï¼š @ModelAttributeä½¿ç”¨åœ¨æ–¹æ³•(è¿”å›å€¼)ä¸Šï¼Œæ–¹æ³•æ²¡æœ‰è¿”å›å€¼(voidç±»å‹)ï¼Œ Model(Map)å‚æ•°éœ€è¦è‡ªè¡Œè®¾ç½®ã€‚ @ModelAttributeä½¿ç”¨åœ¨æ–¹æ³•(è¿”å›å€¼)ä¸Šï¼Œæ–¹æ³•æœ‰è¿”å›å€¼(évoidç±»å‹)ï¼Œè¿”å›å€¼ä¼šæ·»åŠ åˆ°Model(Map)å‚æ•°ï¼Œkeyç”±@ModelAttributeçš„valueæŒ‡å®šï¼Œå¦åˆ™ä¼šä½¿ç”¨è¿”å›å€¼ç±»å‹å­—ç¬¦ä¸²(é¦–å†™å­—æ¯å˜ä¸ºå°å†™ï¼Œå¦‚è¿”å›å€¼ç±»å‹ä¸ºIntegerï¼Œåˆ™keyä¸ºinteger)ã€‚ @ModelAttributeä½¿ç”¨åœ¨æ–¹æ³•å‚æ•°ä¸­ï¼Œåˆ™å¯ä»¥è·å–åŒä¸€ä¸ªæ§åˆ¶å™¨ä¸­çš„å·²ç»è®¾ç½®çš„@ModelAttributeå¯¹åº”çš„å€¼ã€‚ åœ¨ä¸€ä¸ªæ§åˆ¶å™¨(ä½¿ç”¨äº†@Controller)ä¸­ï¼Œå¦‚æœå­˜åœ¨ä¸€åˆ°å¤šä¸ªä½¿ç”¨äº†@ModelAttributeçš„æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•æ€»æ˜¯åœ¨è¿›å…¥æ§åˆ¶å™¨æ–¹æ³•ä¹‹å‰æ‰§è¡Œï¼Œå¹¶ä¸”æ‰§è¡Œé¡ºåºæ˜¯ç”±åŠ è½½é¡ºåºå†³å®šçš„(å…·ä½“çš„é¡ºåºæ˜¯å¸¦å‚æ•°çš„ä¼˜å…ˆï¼Œå¹¶ä¸”æŒ‰ç…§æ–¹æ³•é¦–å­—æ¯å‡åºæ’åº)ï¼Œä¸¾ä¸ªä¾‹å­ï¼š 123456789101112131415161718192021222324252627282930313233343536@Slf4j@RestControllerpublic class ModelAttributeController &#123; @ModelAttribute public void before(Model model) &#123; log.info(\"before..........\"); model.addAttribute(\"before\", \"beforeValue\"); &#125; @ModelAttribute(value = \"beforeArg\") public String beforeArg() &#123; log.info(\"beforeArg..........\"); return \"beforeArgValue\"; &#125; @GetMapping(value = \"/modelAttribute\") public String modelAttribute(Model model, @ModelAttribute(value = \"beforeArg\") String beforeArg) &#123; log.info(\"modelAttribute..........\"); log.info(\"beforeArg..........&#123;&#125;\", beforeArg); log.info(\"&#123;&#125;\", model); return \"success\"; &#125; @ModelAttribute public void after(Model model) &#123; log.info(\"after..........\"); model.addAttribute(\"after\", \"afterValue\"); &#125; @ModelAttribute(value = \"afterArg\") public String afterArg() &#123; log.info(\"afterArg..........\"); return \"afterArgValue\"; &#125;&#125; è°ƒç”¨æ­¤æ¥å£ï¼Œæ§åˆ¶å°è¾“å‡ºæ—¥å¿—å¦‚ä¸‹ï¼š 1234567after..........before..........afterArg..........beforeArg..........modelAttribute..........beforeArg..........beforeArgValue&#123;after&#x3D;afterValue, before&#x3D;beforeValue, afterArg&#x3D;afterArgValue, beforeArg&#x3D;beforeArgValue&#125; å¯ä»¥å°è¯æ’åºè§„åˆ™å’Œå‚æ•°è®¾ç½®ã€è·å–çš„ç»“æœå’Œå‰é¢çš„åˆ†ææ˜¯ä¸€è‡´çš„ã€‚ Errorsæˆ–è€…BindingResultå‚æ•° Errorså…¶å®æ˜¯BindingResultçš„çˆ¶æ¥å£ï¼ŒBindingResultä¸»è¦ç”¨äºå›è°ƒJSRå‚æ•°æ ¡éªŒå¼‚å¸¸çš„å±æ€§é¡¹ï¼Œå¦‚æœJSRæ ¡éªŒå¼‚å¸¸ï¼Œä¸€èˆ¬ä¼šæŠ›å‡ºMethodArgumentNotValidExceptionå¼‚å¸¸ï¼Œå¹¶ä¸”ä¼šè¿”å›400(Bad Request)ï¼Œè§å…¨å±€å¼‚å¸¸å¤„ç†å™¨DefaultHandlerExceptionResolverã€‚Errorsç±»å‹çš„å‚æ•°å¤„ç†å™¨ä¸ºErrorsMethodArgumentResolverã€‚ä¸¾ä¸ªä¾‹å­ï¼š 12345678910111213141516171819@PostMapping(value = \"/errors\")public String errors(@RequestBody @Validated ErrorsModel errors, BindingResult bindingResult) &#123; if (bindingResult.hasErrors()) &#123; for (ObjectError objectError : bindingResult.getAllErrors()) &#123; log.warn(\"name=&#123;&#125;,message=&#123;&#125;\", objectError.getObjectName(), objectError.getDefaultMessage()); &#125; &#125; return errors.toString();&#125;//ErrorsModel@Data@NoArgsConstructorpublic class ErrorsModel &#123; @NotNull(message = \"id must not be null!\") private Integer id; @NotEmpty(message = \"errors name must not be empty!\") private String name;&#125; è°ƒç”¨æ¥å£æ§åˆ¶å°Warnæ—¥å¿—å¦‚ä¸‹ï¼š 1name&#x3D;errors,message&#x3D;errors name must not be empty! ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸å»ºè®®ç”¨è¿™ç§æ–¹å¼å¤„ç†JSRæ ¡éªŒå¼‚å¸¸çš„å±æ€§é¡¹ï¼Œå› ä¸ºä¼šæ¶‰åŠåˆ°å¤§é‡çš„é‡å¤çš„ç¡¬ç¼–ç å·¥ä½œï¼Œå»ºè®®ï¼šæ–¹å¼ä¸€ç›´æ¥ç»§æ‰¿ResponseEntityExceptionHandlerè¦†ç›–å¯¹åº”çš„æ–¹æ³•æˆ–è€…æ–¹å¼äºŒåŒæ—¶ä½¿ç”¨@ExceptionHandlerå’Œ@(Rest)ControllerAdviceæ³¨è§£è¿›è¡Œå¼‚å¸¸å¤„ç†ã€‚ä¾‹å¦‚ï¼š 12345678@RestControllerAdvicepublic class ApplicationRestControllerAdvice&#123; @ExceptionHandler(BusinessException.class) public Response handleBusinessException(BusinessException e, HttpServletRequest request)&#123; // è¿™é‡Œå¤„ç†å¼‚å¸¸å’Œè¿”å›å€¼ &#125;&#125; @Valueå‚æ•° æ§åˆ¶å™¨æ–¹æ³•çš„å‚æ•°å¯ä»¥æ˜¯@Valueæ³¨è§£ä¿®é¥°çš„å‚æ•°ï¼Œä¼šä»Environmentå®ä¾‹ä¸­è£…é…å’Œè½¬æ¢å±æ€§å€¼åˆ°å¯¹åº”çš„å‚æ•°ä¸­(ä¹Ÿå°±æ˜¯å‚æ•°çš„æ¥æºå¹¶ä¸æ˜¯è¯·æ±‚ä½“)ï¼Œå‚æ•°å¤„ç†å™¨ä¸ºExpressionValueMethodArgumentResolverã€‚ä¸¾ä¸ªä¾‹å­ï¼š 12345@GetMapping(value = \"/value\")public String value(@Value(value = \"$&#123;spring.application.name&#125;\") String name) &#123; log.info(\"spring.application.name=&#123;&#125;\", name); return name;&#125; spring.application.nameå±æ€§ä¸€èˆ¬åœ¨é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šï¼Œåœ¨åŠ è½½é…ç½®æ–‡ä»¶å±æ€§çš„æ—¶å€™æ·»åŠ åˆ°å…¨å±€çš„Environmentä¸­ã€‚ Mapç±»å‹å‚æ•° Mapç±»å‹å‚æ•°çš„èŒƒå›´ç›¸å¯¹æ¯”è¾ƒå¹¿ï¼Œå¯¹åº”ä¸€ç³»åˆ—çš„å‚æ•°å¤„ç†å™¨ï¼Œæ³¨æ„åŒºåˆ«ä½¿ç”¨äº†ä¸Šé¢æåˆ°çš„éƒ¨åˆ†æ³¨è§£çš„Mapç±»å‹å’Œå®Œå…¨ä¸ä½¿ç”¨æ³¨è§£çš„Mapç±»å‹å‚æ•°ï¼Œä¸¤è€…çš„å¤„ç†æ–¹å¼ä¸ç›¸åŒã€‚ä¸‹é¢åˆ—ä¸¾å‡ ä¸ªç›¸å¯¹å…¸å‹çš„Mapç±»å‹å‚æ•°å¤„ç†ä¾‹å­ã€‚ ä¸ä½¿ç”¨ä»»ä½•æ³¨è§£çš„Map&lt;String,Object&gt;å‚æ•° è¿™ç§æƒ…å†µä¸‹å‚æ•°å®é™…ä¸Šç›´æ¥å›è°ƒModelAndViewContainerä¸­çš„ModelMapå®ä¾‹ï¼Œå‚æ•°å¤„ç†å™¨ä¸ºMapMethodProcessorï¼Œå¾€Mapå‚æ•°ä¸­æ·»åŠ çš„å±æ€§å°†ä¼šå¸¦åˆ°é¡µé¢ä¸­ã€‚ ä½¿ç”¨@RequestParamæ³¨è§£çš„Map&lt;String,Object&gt;å‚æ•° è¿™ç§æƒ…å†µä¸‹çš„å‚æ•°å¤„ç†å™¨ä¸ºRequestParamMapMethodArgumentResolverï¼Œä½¿ç”¨çš„è¯·æ±‚æ–¹å¼éœ€è¦æŒ‡å®šContent-Typeä¸ºx-www-form-urlencodedï¼Œä¸èƒ½ä½¿ç”¨application/jsonçš„æ–¹å¼ï¼š æ§åˆ¶å™¨ä»£ç ä¸ºï¼š 12345@PostMapping(value = \"/map\")public String mapArgs(@RequestParam Map&lt;String, Object&gt; map) &#123; log.info(\"&#123;&#125;\", map); return map.toString();&#125; ä½¿ç”¨@RequestHeaderæ³¨è§£çš„Map&lt;String,Object&gt;å‚æ•° è¿™ç§æƒ…å†µä¸‹çš„å‚æ•°å¤„ç†å™¨ä¸ºRequestHeaderMapMethodArgumentResolverï¼Œä½œç”¨æ˜¯è·å–è¯·æ±‚çš„æ‰€æœ‰è¯·æ±‚å¤´çš„Key-Valueã€‚ ä½¿ç”¨@PathVariableæ³¨è§£çš„Map&lt;String,Object&gt;å‚æ•° è¿™ç§æƒ…å†µä¸‹çš„å‚æ•°å¤„ç†å™¨ä¸ºPathVariableMapMethodArgumentResolverï¼Œä½œç”¨æ˜¯è·å–æ‰€æœ‰è·¯å¾„å‚æ•°å°è£…ä¸ºKey-Valueç»“æ„ã€‚ MultipartFileé›†åˆ-æ‰¹é‡æ–‡ä»¶ä¸Šä¼  æ‰¹é‡æ–‡ä»¶ä¸Šä¼ çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¸€èˆ¬éœ€è¦æ¥æ”¶ä¸€ä¸ªMultipartFileé›†åˆï¼Œå¯ä»¥æœ‰ä¸¤ç§é€‰æ‹©ï¼š ä½¿ç”¨MultipartHttpServletRequestå‚æ•°ï¼Œç›´æ¥è°ƒç”¨getFilesæ–¹æ³•è·å–MultipartFileåˆ—è¡¨ã€‚ ä½¿ç”¨@RequestParamæ³¨è§£ä¿®é¥°MultipartFileåˆ—è¡¨ï¼Œå‚æ•°å¤„ç†å™¨æ˜¯RequestParamMethodArgumentResolverï¼Œå…¶å®å°±æ˜¯ç¬¬1ç§æ–¹å¼çš„å°è£…è€Œå·²ã€‚ æ§åˆ¶å™¨æ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š 12345@PostMapping(value = \"/parts\")public String partArgs(@RequestParam(name = \"file\") List&lt;MultipartFile&gt; parts) &#123; log.info(\"&#123;&#125;\", parts); return parts.toString();&#125; æ—¥æœŸç±»å‹å‚æ•°å¤„ç† æ—¥æœŸå‚æ•°å¤„ç†ä¸ªäººè®¤ä¸ºæ˜¯è¯·æ±‚å‚æ•°å¤„ç†ä¸­æœ€å¤æ‚çš„ï¼Œå› ä¸ºä¸€èˆ¬æ—¥æœŸå¤„ç†çš„é€»è¾‘ä¸æ˜¯é€šç”¨çš„ï¼Œè¿‡å¤šçš„å®šåˆ¶åŒ–å¤„ç†å¯¼è‡´å¾ˆéš¾æœ‰ä¸€ä¸ªç»Ÿä¸€çš„æ ‡å‡†å¤„ç†é€»è¾‘å»å¤„ç†å’Œè½¬æ¢æ—¥æœŸç±»å‹çš„å‚æ•°ã€‚ä¸è¿‡ï¼Œè¿™é‡Œä»‹ç»å‡ ä¸ªé€šç”¨çš„æ–¹æ³•ï¼Œä»¥åº”å¯¹å„ç§å¥‡è‘©çš„æ—¥æœŸæ ¼å¼ã€‚ä¸‹é¢ä»‹ç»çš„ä¾‹å­ä¸­å…¨éƒ¨ä½¿ç”¨Jdk8ä¸­å¼•å…¥çš„æ—¥æœŸæ—¶é—´APIï¼Œå›´ç»•java.util.Dateä¸ºæ ¸å¿ƒçš„æ—¥æœŸæ—¶é—´APIçš„ä½¿ç”¨æ–¹å¼ç±»åŒã€‚ ä¸€ã€ç»Ÿä¸€ä»¥å­—ç¬¦ä¸²å½¢å¼æ¥æ”¶ è¿™ç§æ˜¯æœ€åŸå§‹ä½†æ˜¯æœ€å¥æ•ˆçš„æ–¹å¼ï¼Œç»Ÿä¸€ä»¥å­—ç¬¦ä¸²å½¢å¼æ¥æ”¶ï¼Œç„¶åè‡ªè¡Œå¤„ç†ç±»å‹è½¬æ¢ï¼Œä¸‹é¢ç»™ä¸ªå°ä¾‹å­ï¼š 12345678910111213141516171819202122232425@PostMapping(value = \"/date1\")public String date1(@RequestBody UserDto userDto) &#123; UserEntity userEntity = new UserEntity(); userEntity.setUserId(userDto.getUserId()); userEntity.setBirthdayTime(LocalDateTime.parse(userDto.getBirthdayTime(), FORMATTER)); userEntity.setGraduationTime(LocalDateTime.parse(userDto.getGraduationTime(), FORMATTER)); log.info(userEntity.toString()); return \"success\";&#125;@Datapublic class UserDto &#123; private String userId; private String birthdayTime; private String graduationTime;&#125;@Datapublic class UserEntity &#123; private String userId; private LocalDateTime birthdayTime; private LocalDateTime graduationTime;&#125; ä½¿ç”¨å­—ç¬¦ä¸²æ¥æ”¶åå†è½¬æ¢çš„ç¼ºç‚¹å°±æ˜¯æ¨¡æ¿ä»£ç å¤ªå¤šï¼Œç¼–ç é£æ ¼ä¸å¤Ÿç®€æ´ï¼Œé‡å¤æ€§å·¥ä½œå¤ªå¤šã€‚ äºŒã€ä½¿ç”¨æ³¨è§£@DateTimeFormatæˆ–è€…@JsonFormat @DateTimeFormatæ³¨è§£é…åˆ@RequestBodyçš„å‚æ•°ä½¿ç”¨çš„æ—¶å€™ï¼Œä¼šå‘ç°æŠ›å‡ºInvalidFormatExceptionå¼‚å¸¸ï¼Œæç¤ºè½¬æ¢å¤±è´¥ï¼Œè¿™æ˜¯å› ä¸ºåœ¨å¤„ç†æ­¤æ³¨è§£çš„æ—¶å€™ï¼Œåªæ”¯æŒFormè¡¨å•æäº¤(Content-Typeä¸ºx-www-form-urlencoded)ï¼Œä¾‹å­å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324@Datapublic class UserDto2 &#123; private String userId; @DateTimeFormat(pattern = \"yyyy-MM-dd HH:mm:ss\") private LocalDateTime birthdayTime; @DateTimeFormat(pattern = \"yyyy-MM-dd HH:mm:ss\") private LocalDateTime graduationTime;&#125;@PostMapping(value = \"/date2\")public String date2(UserDto2 userDto2) &#123; log.info(userDto2.toString()); return \"success\";&#125;//æˆ–è€…åƒä¸‹é¢è¿™æ ·@PostMapping(value = \"/date2\")public String date2(@RequestParam(\"name\"=\"userId\")String userId, @RequestParam(\"name\"=\"birthdayTime\") @DateTimeFormat(pattern = \"yyyy-MM-dd HH:mm:ss\") LocalDateTime birthdayTime, @RequestParam(\"name\"=\"graduationTime\") @DateTimeFormat(pattern = \"yyyy-MM-dd HH:mm:ss\") LocalDateTime graduationTime) &#123; return \"success\";&#125; è€Œ@JsonFormatæ³¨è§£å¯ä½¿ç”¨åœ¨Formè¡¨å•æˆ–è€…JSONè¯·æ±‚å‚æ•°çš„åœºæ™¯ï¼Œå› æ­¤æ›´æ¨èä½¿ç”¨@JsonFormatæ³¨è§£ï¼Œä¸è¿‡æ³¨æ„éœ€è¦æŒ‡å®šæ—¶åŒº(timezoneå±æ€§ï¼Œä¾‹å¦‚åœ¨ä¸­å›½æ˜¯ä¸œå…«åŒºGMT+8)ï¼Œå¦åˆ™æœ‰å¯èƒ½å¯¼è‡´å‡ºç°æ—¶å·®ï¼Œä¸¾ä¸ªä¾‹å­ï¼š 123456789101112131415@PostMapping(value = \"/date2\")public String date2(@RequestBody UserDto2 userDto2) &#123; log.info(userDto2.toString()); return \"success\";&#125;@Datapublic class UserDto2 &#123; private String userId; @JsonFormat(pattern = \"yyyy-MM-dd HH:mm:ss\", timezone = \"GMT+8\") private LocalDateTime birthdayTime; @JsonFormat(pattern = \"yyyy-MM-dd HH:mm:ss\", timezone = \"GMT+8\") private LocalDateTime graduationTime;&#125; ä¸‰ã€Jacksonåºåˆ—åŒ–å’Œååºåˆ—åŒ–å®šåˆ¶ å› ä¸ºSpringMVCé»˜è®¤ä½¿ç”¨Jacksonå¤„ç†@RequestBodyçš„å‚æ•°è½¬æ¢ï¼Œå› æ­¤å¯ä»¥é€šè¿‡å®šåˆ¶åºåˆ—åŒ–å™¨å’Œååºåˆ—åŒ–å™¨æ¥å®ç°æ—¥æœŸç±»å‹çš„è½¬æ¢ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨application/jsonçš„å½¢å¼æäº¤è¯·æ±‚å‚æ•°ã€‚è¿™é‡Œçš„ä¾‹å­æ˜¯è½¬æ¢è¯·æ±‚Jsonå‚æ•°ä¸­çš„å­—ç¬¦ä¸²ä¸ºLocalDateTimeç±»å‹ï¼Œå±äºJsonååºåˆ—åŒ–ï¼Œå› æ­¤éœ€è¦å®šåˆ¶ååºåˆ—åŒ–å™¨ï¼š 12345678910111213141516171819202122@PostMapping(value = \"/date3\")public String date3(@RequestBody UserDto3 userDto3) &#123; log.info(userDto3.toString()); return \"success\";&#125;@Datapublic class UserDto3 &#123; private String userId; @JsonDeserialize(using = CustomLocalDateTimeDeserializer.class) private LocalDateTime birthdayTime; @JsonDeserialize(using = CustomLocalDateTimeDeserializer.class) private LocalDateTime graduationTime;&#125;public class CustomLocalDateTimeDeserializer extends LocalDateTimeDeserializer &#123; public CustomLocalDateTimeDeserializer() &#123; super(DateTimeFormatter.ofPattern(\"yyyy-MM-dd HH:mm:ss\")); &#125;&#125; å››ã€æœ€ä½³å®è·µ å‰é¢ä¸‰ç§æ–¹å¼éƒ½å­˜åœ¨ç¡¬ç¼–ç ç­‰é—®é¢˜ï¼Œå…¶å®æœ€ä½³å®è·µæ˜¯ç›´æ¥ä¿®æ”¹MappingJackson2HttpMessageConverterä¸­çš„ObjectMapperå¯¹äºæ—¥æœŸç±»å‹å¤„ç†é»˜è®¤çš„åºåˆ—åŒ–å™¨å’Œååºåˆ—åŒ–å™¨ï¼Œè¿™æ ·å°±èƒ½å…¨å±€ç”Ÿæ•ˆï¼Œä¸éœ€è¦å†ä½¿ç”¨å…¶ä»–æ³¨è§£æˆ–è€…å®šåˆ¶åºåˆ—åŒ–æ–¹æ¡ˆ(å½“ç„¶ï¼Œæœ‰äº›æ—¶å€™éœ€è¦ç‰¹æ®Šå¤„ç†å®šåˆ¶)ï¼Œæˆ–è€…è¯´ï¼Œåœ¨éœ€è¦ç‰¹æ®Šå¤„ç†çš„åœºæ™¯æ‰ä½¿ç”¨å…¶ä»–æ³¨è§£æˆ–è€…å®šåˆ¶åºåˆ—åŒ–æ–¹æ¡ˆã€‚ä½¿ç”¨é’©å­æ¥å£Jackson2ObjectMapperBuilderCustomizerå¯ä»¥å®ç°å¯¹å®¹å™¨ä¸­çš„ObjectMapperå•ä¾‹ä¸­çš„å±æ€§å®šåˆ¶ï¼š 123456789@Beanpublic Jackson2ObjectMapperBuilderCustomizer jackson2ObjectMapperBuilderCustomizer()&#123; return customizer-&gt;&#123; customizer.serializerByType(LocalDateTime.class,new LocalDateTimeSerializer( DateTimeFormatter.ofPattern(\"yyyy-MM-dd HH:mm:ss\"))); customizer.deserializerByType(LocalDateTime.class,new LocalDateTimeDeserializer( DateTimeFormatter.ofPattern(\"yyyy-MM-dd HH:mm:ss\"))); &#125;;&#125; è¿™æ ·å°±èƒ½å®šåˆ¶åŒ–MappingJackson2HttpMessageConverterä¸­æŒæœ‰çš„ObjectMapperï¼Œä¸Šé¢çš„LocalDateTimeåºåˆ—åŒ–å’Œååºåˆ—åŒ–å™¨å¯¹å…¨å±€ç”Ÿæ•ˆã€‚ è¯·æ±‚URLåŒ¹é… å‰é¢åŸºæœ¬ä»‹ç»å®Œäº†ä¸»æµçš„è¯·æ±‚å‚æ•°å¤„ç†ï¼Œå…¶å®SpringMVCä¸­è¿˜ä¼šæŒ‰ç…§URLçš„æ¨¡å¼è¿›è¡ŒåŒ¹é…ï¼Œä½¿ç”¨çš„æ˜¯Antè·¯å¾„é£æ ¼ï¼Œå¤„ç†å·¥å…·ç±»ä¸ºorg.springframework.util.AntPathMatcherï¼Œä»æ­¤ç±»çš„æ³¨é‡Šæ¥çœ‹ï¼ŒåŒ¹é…è§„åˆ™ä¸»è¦åŒ…æ‹¬ä¸‹é¢å››ç‚¹ ï¼š ?åŒ¹é…1ä¸ªå­—ç¬¦ã€‚ *åŒ¹é…0ä¸ªæˆ–è€…å¤šä¸ªå­—ç¬¦ã€‚ **åŒ¹é…è·¯å¾„ä¸­0ä¸ªæˆ–è€…å¤šä¸ªç›®å½•ã€‚ æ­£åˆ™æ”¯æŒï¼Œå¦‚{spring:[a-z]+}å°†æ­£åˆ™è¡¨è¾¾å¼[a-z]+åŒ¹é…åˆ°çš„å€¼ï¼Œèµ‹å€¼ç»™åä¸ºspringçš„è·¯å¾„å˜é‡ã€‚ ä¸¾äº›ä¾‹å­ï¼š â€™?'å½¢å¼çš„URLï¼š 12345678910@GetMapping(value = \"/pattern?\")public String pattern() &#123; return \"success\";&#125;/pattern 404 Not Found/patternd 200 OK/patterndd 404 Not Found/pattern/ 404 Not Found/patternd/s 404 Not Found â€™*'å½¢å¼çš„URLï¼š 123456789@GetMapping(value = \"/pattern*\")public String pattern() &#123; return \"success\";&#125;/pattern 200 OK/pattern/ 200 OK/patternd 200 OK/pattern/a 404 Not Found â€™**'å½¢å¼çš„URLï¼š 12345678@GetMapping(value = \"/pattern/**/p\")public String pattern() &#123; return \"success\";&#125;/pattern/p 200 OK/pattern/x/p 200 OK/pattern/x/y/p 200 OK {spring:[a-z]+}å½¢å¼çš„URLï¼š 12345678910@GetMapping(value = \"/pattern/&#123;key:[a-c]+&#125;\")public String pattern(@PathVariable(name = \"key\") String key) &#123; return \"success\";&#125;/pattern/a 200 OK/pattern/ab 200 OK/pattern/abc 200 OK/pattern 404 Not Found/pattern/abcd 404 Not Found ä¸Šé¢çš„å››ç§URLæ¨¡å¼å¯ä»¥ç»„åˆä½¿ç”¨ï¼Œåƒå˜ä¸‡åŒ–ã€‚ URLåŒ¹é…è¿˜éµå¾ªç²¾ç¡®åŒ¹é…åŸåˆ™ï¼Œä¹Ÿå°±æ˜¯å­˜åœ¨ä¸¤ä¸ªæ¨¡å¼å¯¹åŒä¸€ä¸ªURLéƒ½èƒ½å¤ŸåŒ¹é…æˆåŠŸï¼Œåˆ™é€‰å–æœ€ç²¾ç¡®çš„URLåŒ¹é…ï¼Œè¿›å…¥å¯¹åº”çš„æ§åˆ¶å™¨æ–¹æ³•ï¼Œä¸¾ä¸ªä¾‹å­ï¼š 123456789@GetMapping(value = \"/pattern/**/p\")public String pattern1() &#123; return \"success\";&#125;@GetMapping(value = \"/pattern/p\")public String pattern2() &#123; return \"success\";&#125; ä¸Šé¢ä¸¤ä¸ªæ§åˆ¶å™¨ï¼Œå¦‚æœè¯·æ±‚URLä¸º/pattern/pï¼Œæœ€ç»ˆè¿›å…¥çš„æ–¹æ³•ä¸ºpattern2ã€‚ æœ€åï¼Œorg.springframework.util.AntPathMatcherä½œä¸ºä¸€ä¸ªå·¥å…·ç±»ï¼Œå¯ä»¥å•ç‹¬ä½¿ç”¨ï¼Œä¸ä»…ä»…å¯ä»¥ç”¨äºåŒ¹é…URLï¼Œä¹Ÿå¯ä»¥ç”¨äºåŒ¹é…ç³»ç»Ÿæ–‡ä»¶è·¯å¾„ï¼Œä¸è¿‡éœ€è¦ä½¿ç”¨å…¶å¸¦å‚æ•°æ„é€ æ”¹å˜å†…éƒ¨çš„pathSeparatorå˜é‡ï¼Œä¾‹å¦‚ï¼š 1AntPathMatcher antPathMatcher = new AntPathMatcher(File.separator); å°ç»“ ç¬”è€…åœ¨å‰ä¸€æ®µæ—¶é—´æ›¾ç»èŠ±å¤§é‡æ—¶é—´æ¢³ç†å’Œåˆ†æè¿‡Springã€SpringMVCçš„æºç ï¼Œä½†æ˜¯åé¢ä¸€æ®µå¾ˆé•¿çš„æ—¶é—´éœ€è¦è¿›è¡Œä¸šåŠ¡å¼€å‘ï¼Œå¯¹æ¶æ„æ–¹é¢çš„ä¸œè¥¿æœ‰ç‚¹ç”Ÿç–äº†ï¼Œæ¯•ç«Ÿä¸œè¥¿ä¸ç”¨å°±ä¼šç”Ÿç–ï¼Œè¿™ä¸ªæ˜¯å¸¸ç†ã€‚è¿™ç¯‡æ–‡ç« åŸºäºä¸€äº›SpringMVCçš„æºç ç»éªŒæ€»ç»“äº†è¯·æ±‚å‚æ•°çš„å¤„ç†ç›¸å…³çš„ä¸€äº›çŸ¥è¯†ï¼Œå¸Œæœ›å¸®åˆ°è‡ªå·±å’Œå¤§å®¶ã€‚ å‚è€ƒèµ„æ–™ï¼š spring-boot-web-starter:2.0.3.RELEASEæºç ã€‚ ï¼ˆæœ¬æ–‡å®Œ c-7-d e-a-20180512 æ—§æ–‡é‡å‘ï¼‰","categories":[{"name":"Spring","slug":"Spring","permalink":"http://throwable.club/blog/categories/Spring/"},{"name":"SpringMVC","slug":"Spring/SpringMVC","permalink":"http://throwable.club/blog/categories/Spring/SpringMVC/"}],"tags":[{"name":"Spring","slug":"Spring","permalink":"http://throwable.club/blog/tags/Spring/"},{"name":"SpringMVC","slug":"SpringMVC","permalink":"http://throwable.club/blog/tags/SpringMVC/"}]},{"title":"SpringMVCè¯·æ±‚å‚æ•°å’Œå“åº”ç»“æœå…¨å±€åŠ å¯†å’Œè§£å¯†","slug":"spring-mvc-param-global-encryption-decryption-in-action","date":"2019-11-28T16:57:38.000Z","updated":"2019-11-28T16:59:32.793Z","comments":true,"path":"2019/11/29/spring-mvc-param-global-encryption-decryption-in-action/","link":"","permalink":"http://throwable.club/2019/11/29/spring-mvc-param-global-encryption-decryption-in-action/","excerpt":"å‰æ å‰æ®µæ—¶é—´åœ¨åšä¸€ä¸ªå¯¹å¤–çš„ç½‘å…³é¡¹ç›®ï¼Œæ¶‰åŠåˆ°åŠ å¯†å’Œè§£å¯†æ¨¡å—ï¼Œè¿™é‡Œè¯¦ç»†åˆ†æè§£å†³æ–¹æ¡ˆå’Œé€‚ç”¨çš„åœºæ™¯ã€‚ä¸ºäº†æ¨¡æ‹ŸçœŸå®çš„äº¤äº’åœºæ™¯ï¼Œå…ˆå®šåˆ¶ä¸€ä¸‹æ•´ä¸ªäº¤äº’æµç¨‹ã€‚ç¬¬ä¸‰æ–¹ä¼ è¾“(åŒ…æ‹¬è¯·æ±‚å’Œå“åº”)æ•°æ®æŠ¥æ–‡åŒ…æ‹¬ä¸‰ä¸ªéƒ¨åˆ†ï¼š 1ã€timestampï¼Œlongç±»å‹ï¼Œæ—¶é—´æˆ³ã€‚ 2ã€dataï¼ŒStringç±»å‹ï¼Œå®é™…çš„ä¸šåŠ¡è¯·æ±‚æ•°æ®è½¬åŒ–æˆçš„Jsonå­—ç¬¦ä¸²å†è¿›è¡ŒåŠ å¯†å¾—åˆ°çš„å¯†æ–‡ã€‚ 3ã€signï¼Œç­¾åï¼Œç”Ÿæˆè§„åˆ™ç®—æ³•ä¼ªä»£ç æ˜¯SHA-256(data=xxx&amp;timestamp=11111)ï¼Œé˜²ç¯¡æ”¹ã€‚ ä¸ºäº†ç®€å•èµ·è§ï¼ŒåŠ å¯†å’Œè§£å¯†é‡‡ç”¨AESï¼Œå¯¹ç§°ç§˜é’¥ä¸º&quot;throwable&quot;ã€‚ä¸Šé¢çš„åœºæ™¯å’ŒåŠ è§£å¯†ä¾‹å­ä»…ä»…æ˜¯ä¸ºäº†æ¨¡æ‹ŸçœŸå®åœºæ™¯ï¼Œå®‰å…¨ç³»æ•°ä½ï¼Œåˆ‡å‹¿ç›´æ¥ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚","text":"å‰æ å‰æ®µæ—¶é—´åœ¨åšä¸€ä¸ªå¯¹å¤–çš„ç½‘å…³é¡¹ç›®ï¼Œæ¶‰åŠåˆ°åŠ å¯†å’Œè§£å¯†æ¨¡å—ï¼Œè¿™é‡Œè¯¦ç»†åˆ†æè§£å†³æ–¹æ¡ˆå’Œé€‚ç”¨çš„åœºæ™¯ã€‚ä¸ºäº†æ¨¡æ‹ŸçœŸå®çš„äº¤äº’åœºæ™¯ï¼Œå…ˆå®šåˆ¶ä¸€ä¸‹æ•´ä¸ªäº¤äº’æµç¨‹ã€‚ç¬¬ä¸‰æ–¹ä¼ è¾“(åŒ…æ‹¬è¯·æ±‚å’Œå“åº”)æ•°æ®æŠ¥æ–‡åŒ…æ‹¬ä¸‰ä¸ªéƒ¨åˆ†ï¼š 1ã€timestampï¼Œlongç±»å‹ï¼Œæ—¶é—´æˆ³ã€‚ 2ã€dataï¼ŒStringç±»å‹ï¼Œå®é™…çš„ä¸šåŠ¡è¯·æ±‚æ•°æ®è½¬åŒ–æˆçš„Jsonå­—ç¬¦ä¸²å†è¿›è¡ŒåŠ å¯†å¾—åˆ°çš„å¯†æ–‡ã€‚ 3ã€signï¼Œç­¾åï¼Œç”Ÿæˆè§„åˆ™ç®—æ³•ä¼ªä»£ç æ˜¯SHA-256(data=xxx&amp;timestamp=11111)ï¼Œé˜²ç¯¡æ”¹ã€‚ ä¸ºäº†ç®€å•èµ·è§ï¼ŒåŠ å¯†å’Œè§£å¯†é‡‡ç”¨AESï¼Œå¯¹ç§°ç§˜é’¥ä¸º&quot;throwable&quot;ã€‚ä¸Šé¢çš„åœºæ™¯å’ŒåŠ è§£å¯†ä¾‹å­ä»…ä»…æ˜¯ä¸ºäº†æ¨¡æ‹ŸçœŸå®åœºæ™¯ï¼Œå®‰å…¨ç³»æ•°ä½ï¼Œåˆ‡å‹¿ç›´æ¥ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚ ç°åœ¨è¿˜æœ‰ä¸€ä¸ªåœ°æ–¹è¦è€ƒè™‘ï¼Œå°±æ˜¯æ— æ³•å¾—çŸ¥ç¬¬ä¸‰æ–¹å¦‚ä½•æäº¤è¯·æ±‚æ•°æ®ï¼Œå‡å®šéƒ½æ˜¯é‡‡ç”¨POSTçš„Httpè¯·æ±‚æ–¹æ³•ï¼Œæäº¤æŠ¥æ–‡çš„æ—¶å€™æŒ‡å®šContentTypeä¸ºapplication/jsonæˆ–è€…application/x-www-form-urlencodedï¼Œä¸¤ç§ContentTypeæäº¤æ–¹å¼çš„è¯·æ±‚ä½“æ˜¯ä¸ç›¸åŒçš„ï¼š 12345//application/x-www-form-urlencodedtimestamp=xxxx&amp;data=yyyyyy&amp;sign=zzzzzzz//application/json&#123;\"timestamp\":xxxxxx,\"data\":\"yyyyyyyy\",\"sign\":\"zzzzzzz\"&#125; æœ€åä¸€ä¸ªè¦è€ƒè™‘çš„åœ°æ–¹æ˜¯ï¼Œç¬¬ä¸‰æ–¹å¼ºåˆ¶è¦æ±‚éƒ¨åˆ†æ¥å£éœ€è¦ç”¨æ˜æ–‡è¿›è¡Œè¯·æ±‚ï¼Œåœ¨æä¾›ä¸€äº›æ¥å£æ–¹æ³•çš„æ—¶å€™ï¼Œå…è®¸ä½¿ç”¨æ˜æ–‡äº¤äº’ã€‚æ€»ç»“ä¸€ä¸‹å°±æ˜¯è¦åšåˆ°ä»¥ä¸‹ä¸‰ç‚¹ï¼š 1ã€éœ€è¦åŠ è§£å¯†çš„æ¥å£è¯·æ±‚å‚æ•°è¦è¿›è¡Œè§£å¯†ï¼Œå“åº”ç»“æœè¦è¿›è¡ŒåŠ å¯†ã€‚ 2ã€ä¸éœ€è¦åŠ è§£å¯†çš„æ¥å£å¯ä»¥ç”¨æ˜æ–‡è¯·æ±‚ã€‚ 3ã€å…¼å®¹ContentTypeä¸ºapplication/jsonæˆ–è€…application/x-www-form-urlencodedä¸¤ç§æ–¹å¼ã€‚ ä¸Šé¢ä¸‰ç§æƒ…å†µè¦åŒæ—¶å…¼å®¹ç®—æ˜¯ååˆ†ä¸¥è‹›çš„åœºæ™¯ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­å¯èƒ½ä¹Ÿæ˜¯æå°‘æƒ…å†µä¸‹æ‰é‡åˆ°ï¼Œä¸è¿‡è¿˜æ˜¯èƒ½æ‰¾åˆ°ç›¸å¯¹ä¼˜é›…çš„è§£å†³æ–¹æ¡ˆã€‚å…ˆå®šä¹‰ä¸¤ä¸ªç‰¹å®šåœºæ™¯çš„æ¥å£ï¼š 1ã€ä¸‹å•æ¥å£(åŠ å¯†) URLï¼š/order/save HTTP METHODï¼šPOST ContentTypeï¼šapplication/x-www-form-urlencoded åŸå§‹å‚æ•°ï¼šorderId=yyyyyyyyy&amp;userId=xxxxxxxxx&amp;amount=zzzzzzzzz åŠ å¯†å‚æ•°ï¼štimestamp=xxxx&amp;data=yyyyyy&amp;sign=zzzzzzz 2ã€è®¢å•æŸ¥è¯¢æ¥å£(æ˜æ–‡) URLï¼š/order/query ContentTypeï¼šapplication/json HTTP METHODï¼šPOST åŸå§‹å‚æ•°ï¼š{â€œuserIdâ€:â€œxxxxxxxxâ€} ä¸¤ä¸ªæ¥å£çš„ContentTypeä¸ç›¸åŒæ˜¯ä¸ºäº†æ•…æ„å¤æ‚åŒ–åœºæ™¯ï¼Œåœ¨ä¸‹é¢çš„å¯å–æ–¹æ¡ˆä¸­ï¼Œåšæ³•æ˜¯æŠŠapplication/x-www-form-urlencodedä¸­çš„å½¢å¼å¦‚xxx=yyy&amp;aaa=bbbçš„è¡¨å•å‚æ•°å’Œapplication/jsonä¸­å½¢å¼å¦‚{â€œkeyâ€:â€œvalueâ€}çš„è¯·æ±‚å‚æ•°ç»Ÿä¸€å½“åšapplication/jsonå½¢å¼çš„å‚æ•°å¤„ç†ï¼Œè¿™æ ·çš„è¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥åœ¨æ§åˆ¶å™¨æ–¹æ³•ä¸­ä½¿ç”¨@RequestBodyã€‚ æ–¹æ¡ˆ æˆ‘ä»¬é¦–å…ˆåŸºäºä¸Šé¢è¯´åˆ°çš„åŠ è§£å¯†æ–¹æ¡ˆï¼Œæä¾›ä¸€ä¸ªåŠ è§£å¯†å·¥å…·ç±»ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142public enum EncryptUtils &#123; /** * SINGLETON */ SINGLETON; private static final String SECRET = \"throwable\"; private static final String CHARSET = \"UTF-8\"; public String sha(String raw) throws Exception &#123; MessageDigest messageDigest = MessageDigest.getInstance(\"SHA-256\"); messageDigest.update(raw.getBytes(CHARSET)); return Hex.encodeHexString(messageDigest.digest()); &#125; private Cipher createAesCipher() throws Exception &#123; return Cipher.getInstance(\"AES\"); &#125; public String encryptByAes(String raw) throws Exception &#123; Cipher aesCipher = createAesCipher(); KeyGenerator keyGenerator = KeyGenerator.getInstance(\"AES\"); keyGenerator.init(128, new SecureRandom(SECRET.getBytes(CHARSET))); SecretKey secretKey = keyGenerator.generateKey(); SecretKeySpec secretKeySpec = new SecretKeySpec(secretKey.getEncoded(), \"AES\"); aesCipher.init(Cipher.ENCRYPT_MODE, secretKeySpec); byte[] bytes = aesCipher.doFinal(raw.getBytes(CHARSET)); return Hex.encodeHexString(bytes); &#125; public String decryptByAes(String raw) throws Exception &#123; byte[] bytes = Hex.decodeHex(raw); Cipher aesCipher = createAesCipher(); KeyGenerator keyGenerator = KeyGenerator.getInstance(\"AES\"); keyGenerator.init(128, new SecureRandom(SECRET.getBytes(CHARSET))); SecretKey secretKey = keyGenerator.generateKey(); SecretKeySpec secretKeySpec = new SecretKeySpec(secretKey.getEncoded(), \"AES\"); aesCipher.init(Cipher.DECRYPT_MODE, secretKeySpec); return new String(aesCipher.doFinal(bytes), CHARSET); &#125;&#125; æ³¨æ„ä¸ºäº†ç®€åŒ–åŠ è§£å¯†æ“ä½œå¼•å…¥äº†apacheçš„codecä¾èµ–ï¼š 12345&lt;dependency&gt; &lt;groupId&gt;commons-codec&lt;/groupId&gt; &lt;artifactId&gt;commons-codec&lt;/artifactId&gt; &lt;version&gt;1.11&lt;/version&gt;&lt;/dependency&gt; ä¸Šé¢çš„åŠ è§£å¯†è¿‡ç¨‹ä¸­è¦æ³¨æ„ä¸¤ç‚¹ï¼š 1ã€åŠ å¯†åçš„ç»“æœæ˜¯byteæ•°ç»„ï¼Œè¦æŠŠäºŒè¿›åˆ¶è½¬åŒ–ä¸ºåå…­è¿›åˆ¶å­—ç¬¦ä¸²ã€‚ 2ã€è§£å¯†çš„æ—¶å€™è¦æŠŠåŸå§‹å¯†æ–‡ç”±åå…­è¿›åˆ¶è½¬åŒ–ä¸ºäºŒè¿›åˆ¶çš„byteæ•°ç»„ã€‚ ä¸Šé¢ä¸¤ç‚¹å¿…é¡»æ³¨æ„ï¼Œå¦åˆ™ä¼šäº§ç”Ÿä¹±ç ï¼Œè¿™ä¸ªå’Œç¼–ç ç›¸å…³ï¼Œå…·ä½“å¯ä»¥çœ‹ä¹‹å‰å†™çš„ä¸€ç¯‡åšå®¢ã€‚ ä¸æ¨èçš„æ–¹æ¡ˆ å…¶å®æœ€æš´åŠ›çš„æ–¹æ¡ˆæ˜¯ç›´æ¥å®šåˆ¶æ¯ä¸ªæ§åˆ¶å™¨çš„æ–¹æ³•å‚æ•°ç±»å‹ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥å’Œç¬¬ä¸‰æ–¹ç£‹å•†å“ªäº›è¯·æ±‚è·¯å¾„éœ€è¦åŠ å¯†ï¼Œå“ªäº›æ˜¯ä¸éœ€è¦åŠ å¯†ï¼Œç”šè‡³å“ªäº›æ˜¯application/x-www-form-urlencodedï¼Œå“ªäº›æ˜¯application/jsonçš„è¯·æ±‚ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥é€šè¿‡å¤§é‡çš„ç¡¬ç¼–ç è¾¾åˆ°æœ€ç»ˆçš„ç›®æ ‡ã€‚ä¸¾ä¸ªä¾‹å­ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142@RestControllerpublic class Controller1 &#123; @Autowired private ObjectMapper objectMapper; @PostMapping(value = \"/order/save\", consumes = MediaType.APPLICATION_FORM_URLENCODED_VALUE, produces = MediaType.APPLICATION_JSON_UTF8_VALUE) public ResponseEntity&lt;EncryptModel&gt; saveOrder(@RequestParam(name = \"sign\") String sign, @RequestParam(name = \"timestamp\") Long timestamp, @RequestParam(name = \"data\") String data) throws Exception &#123; EncryptModel model = new EncryptModel(); model.setData(data); model.setTimestamp(timestamp); model.setSign(sign); String inRawSign = String.format(\"data=%s&amp;timestamp=%d\", model.getData(), model.getTimestamp()); String inSign = EncryptUtils.SINGLETON.sha(inRawSign); if (!inSign.equals(model.getSign()))&#123; throw new IllegalArgumentException(\"éªŒè¯å‚æ•°ç­¾åå¤±è´¥!\"); &#125; //è¿™é‡Œå¿½ç•¥å®é™…çš„ä¸šåŠ¡é€»è¾‘,ç®€å•è®¾ç½®è¿”å›çš„dataä¸ºä¸€ä¸ªmap Map&lt;String, Object&gt; result = new HashMap&lt;&gt;(8); result.put(\"code\", \"200\"); result.put(\"message\", \"success\"); EncryptModel out = new EncryptModel(); out.setTimestamp(System.currentTimeMillis()); out.setData(EncryptUtils.SINGLETON.encryptByAes(objectMapper.writeValueAsString(result))); String rawSign = String.format(\"data=%s&amp;timestamp=%d\", out.getData(), out.getTimestamp()); out.setSign(EncryptUtils.SINGLETON.sha(rawSign)); return ResponseEntity.ok(out); &#125; @PostMapping(value = \"/order/query\", consumes = MediaType.APPLICATION_JSON_VALUE, produces = MediaType.APPLICATION_JSON_UTF8_VALUE) public ResponseEntity&lt;Order&gt; queryOrder(@RequestBody User user)&#123; Order order = new Order(); //è¿™é‡Œå¿½ç•¥å®é™…çš„ä¸šåŠ¡é€»è¾‘ return ResponseEntity.ok(order); &#125;&#125; è¿™ç§åšæ³•èƒ½åœ¨çŸ­æ—¶é—´å®Œæˆå¯¹åº”çš„åŠ è§£å¯†åŠŸèƒ½ï¼Œä¸éœ€è¦åŠ è§£å¯†çš„æ¥å£ä¸ç”¨å¼•å…¥ç›¸å…³çš„ä»£ç å³å¯ã€‚ç¼ºé™·ååˆ†æ˜æ˜¾ï¼Œå­˜åœ¨ç¡¬ç¼–ç ã€ä»£ç å†—ä½™ç­‰é—®é¢˜ï¼Œä¸€æ—¦æ¥å£å¢å¤šï¼Œé¡¹ç›®çš„ç»´æŠ¤éš¾åº¦å¤§å¤§æé«˜ã€‚å› æ­¤ï¼Œè¿™ç§åšæ³•æ˜¯ä¸å¯å–çš„ã€‚ æ··åˆæ–¹æ¡ˆä¹‹Filterå’ŒSpringMVCçš„Httpæ¶ˆæ¯è½¬æ¢å™¨ è¿™é‡Œå…ˆè¯´ä¸€ç‚¹ï¼Œè¿™é‡Œæ˜¯åœ¨SpringMVCä¸­ä½¿ç”¨Filterã€‚å› ä¸ºè¦å…¼å®¹ä¸¤ç§contentTypeï¼Œæˆ‘ä»¬éœ€è¦åšåˆ°å‡ ç‚¹ï¼š 1ã€ä¿®æ”¹è¯·æ±‚å¤´çš„ContentTypeä¸ºapplication/jsonã€‚ 2ã€ä¿®æ”¹è¯·æ±‚ä½“ä¸­çš„å‚æ•°ï¼Œç»Ÿä¸€è½¬åŒ–ä¸ºInputStreamã€‚ 3ã€å®šåˆ¶URLè§„åˆ™ï¼ŒåŒºåˆ«éœ€è¦åŠ è§£å¯†å’Œä¸éœ€è¦åŠ è§£å¯†çš„URLã€‚ ä½¿ç”¨Filteræœ‰ä¸€ä¸ªä¼˜ç‚¹ï¼šä¸éœ€è¦ç†è§£SpringMVCçš„æµç¨‹ï¼Œä¹Ÿä¸éœ€è¦æ‰©å±•SpringMVCçš„ç›¸å…³ç»„ä»¶ã€‚ç¼ºç‚¹ä¹Ÿæ¯”è¾ƒæ˜æ˜¾ï¼š 1ã€å¦‚æœéœ€è¦åŒºåˆ†åŠ è§£å¯†ï¼Œåªèƒ½é€šè¿‡URLè§„åˆ™è¿›è¡Œè¿‡æ»¤ã€‚ 2ã€éœ€è¦åŠ å¯†çš„æ¥å£çš„SpringMVCæ§åˆ¶å™¨çš„è¿”å›å‚æ•°å¿…é¡»æ˜¯åŠ å¯†åçš„å®ä½“ç±»ï¼Œæ— æ³•åšåˆ°åŠ å¯†é€»è¾‘å’Œä¸šåŠ¡é€»è¾‘å®Œå…¨æ‹†åˆ†ï¼Œä¹Ÿå°±æ˜¯è§£å¯†é€»è¾‘å¯¹æ¥æ”¶çš„å‚æ•°æ˜¯æ— æ„ŸçŸ¥ï¼Œä½†æ˜¯åŠ å¯†é€»è¾‘å¯¹è¿”å›ç»“æœæ˜¯æœ‰æ„ŸçŸ¥çš„ã€‚ PSï¼šä¸Šé¢æåˆ°çš„å‡ ä¸ªéœ€è¦ä¿®æ”¹è¯·æ±‚å‚æ•°ã€è¯·æ±‚å¤´ç­‰æ˜¯å› ä¸ºç‰¹æ®Šåœºæ™¯çš„å®šåˆ¶ï¼Œæ‰€ä»¥å¦‚æœæ— æ­¤åœºæ™¯å¯ä»¥ç›´æ¥çœ‹ä¸‹é¢çš„&quot;å•çº¯çš„Jsonè¯·æ±‚å‚æ•°å’ŒJsonå“åº”ç»“æœ&quot;å°èŠ‚ã€‚æµç¨‹å¤§è‡´å¦‚ä¸‹ï¼š ç¼–å†™Filterçš„å®ç°å’ŒHttpServletRequestWrapperçš„å®ç°ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127//CustomEncryptFilter@RequiredArgsConstructorpublic class CustomEncryptFilter extends OncePerRequestFilter &#123; private final ObjectMapper objectMapper; @Override protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain filterChain) throws ServletException, IOException &#123; //Content-Type String contentType = request.getContentType(); String requestBody = null; boolean shouldEncrypt = false; if (StringUtils.substringMatch(contentType, 0, MediaType.APPLICATION_FORM_URLENCODED_VALUE)) &#123; shouldEncrypt = true; requestBody = convertFormToString(request); &#125; else if (StringUtils.substringMatch(contentType, 0, MediaType.APPLICATION_JSON_VALUE)) &#123; shouldEncrypt = true; requestBody = convertInputStreamToString(request.getInputStream()); &#125; if (!shouldEncrypt) &#123; filterChain.doFilter(request, response); &#125; else &#123; CustomEncryptHttpWrapper wrapper = new CustomEncryptHttpWrapper(request, requestBody); wrapper.putHeader(\"Content-Type\", MediaType.APPLICATION_PROBLEM_JSON_UTF8_VALUE); filterChain.doFilter(wrapper, response); &#125; &#125; private String convertFormToString(HttpServletRequest request) &#123; Map&lt;String, String&gt; result = new HashMap&lt;&gt;(8); Enumeration&lt;String&gt; parameterNames = request.getParameterNames(); while (parameterNames.hasMoreElements()) &#123; String name = parameterNames.nextElement(); result.put(name, request.getParameter(name)); &#125; try &#123; return objectMapper.writeValueAsString(result); &#125; catch (JsonProcessingException e) &#123; throw new IllegalArgumentException(e); &#125; &#125; private String convertInputStreamToString(InputStream inputStream) throws IOException &#123; return StreamUtils.copyToString(inputStream, Charset.forName(\"UTF-8\")); &#125;&#125;//CustomEncryptHttpWrapperpublic class CustomEncryptHttpWrapper extends HttpServletRequestWrapper &#123; private final Map&lt;String, String&gt; headers = new HashMap&lt;&gt;(8); private final byte[] data; public CustomEncryptHttpWrapper(HttpServletRequest request, String content) &#123; super(request); data = content.getBytes(Charset.forName(\"UTF-8\")); Enumeration&lt;String&gt; headerNames = request.getHeaderNames(); while (headerNames.hasMoreElements()) &#123; String key = headerNames.nextElement(); headers.put(key, request.getHeader(key)); &#125; &#125; public void putHeader(String key, String value) &#123; headers.put(key, value); &#125; @Override public String getHeader(String name) &#123; return headers.get(name); &#125; @Override public Enumeration&lt;String&gt; getHeaders(String name) &#123; return Collections.enumeration(Collections.singletonList(headers.get(name))); &#125; @Override public Enumeration&lt;String&gt; getHeaderNames() &#123; return Collections.enumeration(headers.keySet()); &#125; @Override public ServletInputStream getInputStream() throws IOException &#123; ByteArrayInputStream inputStream = new ByteArrayInputStream(data); return new ServletInputStream() &#123; @Override public boolean isFinished() &#123; return !isReady(); &#125; @Override public boolean isReady() &#123; return inputStream.available() &gt; 0; &#125; @Override public void setReadListener(ReadListener listener) &#123; &#125; @Override public int read() throws IOException &#123; return inputStream.read(); &#125; &#125;; &#125; @Override public BufferedReader getReader() throws IOException &#123; return super.getReader(); &#125;&#125;//CustomEncryptConfiguration@Configurationpublic class CustomEncryptConfiguration &#123; @Bean public FilterRegistrationBean&lt;CustomEncryptFilter&gt; customEncryptFilter(ObjectMapper objectMapper)&#123; FilterRegistrationBean&lt;CustomEncryptFilter&gt; bean = new FilterRegistrationBean&lt;&gt;(new CustomEncryptFilter(objectMapper)); bean.addUrlPatterns(\"/e/*\"); return bean; &#125;&#125; æ§åˆ¶å™¨ä»£ç ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344//å¯åŠ å¯†çš„ï¼Œç©ºæ¥å£ï¼Œç”¨äºæ ‡è¯†è§£å¯†çš„æ¨¡å‹å¯¹è±¡public interface Encryptable &#123;&#125;@Datapublic class Order implements Encryptable&#123; private Long userId;&#125;@Datapublic class EncryptResponse&lt;T&gt; implements Encryptable &#123; private Integer code; private T data;&#125;@RequiredArgsConstructor@RestControllerpublic class Controller &#123; private final ObjectMapper objectMapper; @PostMapping(value = \"/e/order/save\", consumes = MediaType.APPLICATION_JSON_VALUE, produces = MediaType.APPLICATION_JSON_UTF8_VALUE) public EncryptResponse&lt;Order&gt; saveOrder(@RequestBody Order order) throws Exception &#123; //è¿™é‡Œå¿½ç•¥å®é™…çš„ä¸šåŠ¡é€»è¾‘,ç®€å•è®¾ç½®è¿”å›çš„dataä¸ºä¸€ä¸ªmap EncryptResponse&lt;Order&gt; response = new EncryptResponse&lt;&gt;(); response.setCode(200); response.setData(order); return response; &#125; @PostMapping(value = \"/c/order/query\", consumes = MediaType.APPLICATION_JSON_VALUE, produces = MediaType.APPLICATION_JSON_UTF8_VALUE) public ResponseEntity&lt;Order&gt; queryOrder(@RequestBody User user) &#123; Order order = new Order(); //è¿™é‡Œå¿½ç•¥å®é™…çš„ä¸šåŠ¡é€»è¾‘ return ResponseEntity.ok(order); &#125;&#125; è¿™é‡Œå¯èƒ½æœ‰äººæœ‰ç–‘é—®ï¼Œä¸ºä»€ä¹ˆä¸åœ¨FilteråšåŠ è§£å¯†çš„æ“ä½œï¼Ÿå› ä¸ºè€ƒè™‘åˆ°åœºæ™¯å¤ªç‰¹æ®Šï¼Œè¦å…¼å®¹ä¸¤ç§å½¢å¼çš„è¡¨å•æäº¤å‚æ•°ï¼Œå¦‚æœåœ¨FilteråšåŠ è§£å¯†æ“ä½œï¼Œä¼šå½±å“åˆ°Controllerçš„ç¼–ç ï¼Œè¿™å°±è¿åäº†å…¨å±€åŠ è§£å¯†ä¸å½±å“åˆ°é‡Œå±‚ä¸šåŠ¡ä»£ç çš„ç›®æ ‡ã€‚ä¸Šé¢çš„Filteråªä¼šæ‹¦æˆªURLæ»¡è¶³/e/*çš„è¯·æ±‚ï¼Œå› æ­¤æŸ¥è¯¢æ¥å£/c/order/queryä¸ä¼šå—åˆ°å½±å“ã€‚è¿™é‡Œä½¿ç”¨äº†æ ‡è¯†æ¥å£ç”¨äºå†³å®šè¯·æ±‚å‚æ•°æˆ–è€…å“åº”ç»“æœæ˜¯å¦éœ€è¦åŠ è§£å¯†ï¼Œä¹Ÿå°±æ˜¯åªéœ€è¦åœ¨HttpMessageConverterä¸­åˆ¤æ–­è¯·æ±‚å‚æ•°çš„ç±»å‹æˆ–è€…å“åº”ç»“æœçš„ç±»å‹æ˜¯å¦åŠ è§£å¯†æ ‡è¯†æ¥å£çš„å­ç±»ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950@RequiredArgsConstructorpublic class CustomEncryptHttpMessageConverter extends MappingJackson2HttpMessageConverter &#123; private final ObjectMapper objectMapper; @Override protected Object readInternal(Class&lt;?&gt; clazz, HttpInputMessage inputMessage) throws IOException, HttpMessageNotReadableException &#123; if (Encryptable.class.isAssignableFrom(clazz)) &#123; EncryptModel in = objectMapper.readValue(StreamUtils.copyToByteArray(inputMessage.getBody()), EncryptModel.class); String inRawSign = String.format(\"data=%s&amp;timestamp=%d\", in.getData(), in.getTimestamp()); String inSign; try &#123; inSign = EncryptUtils.SINGLETON.sha(inRawSign); &#125; catch (Exception e) &#123; throw new IllegalArgumentException(\"éªŒè¯å‚æ•°ç­¾åå¤±è´¥!\"); &#125; if (!inSign.equals(in.getSign())) &#123; throw new IllegalArgumentException(\"éªŒè¯å‚æ•°ç­¾åå¤±è´¥!\"); &#125; try &#123; return objectMapper.readValue(EncryptUtils.SINGLETON.decryptByAes(in.getData()), clazz); &#125; catch (Exception e) &#123; throw new IllegalArgumentException(\"è§£å¯†å¤±è´¥!\"); &#125; &#125; else &#123; return super.readInternal(clazz, inputMessage); &#125; &#125; @Override protected void writeInternal(Object object, Type type, HttpOutputMessage outputMessage) throws IOException, HttpMessageNotWritableException &#123; Class&lt;?&gt; clazz = (Class) type; if (Encryptable.class.isAssignableFrom(clazz)) &#123; EncryptModel out = new EncryptModel(); out.setTimestamp(System.currentTimeMillis()); try &#123; out.setData(EncryptUtils.SINGLETON.encryptByAes(objectMapper.writeValueAsString(object))); String rawSign = String.format(\"data=%s&amp;timestamp=%d\", out.getData(), out.getTimestamp()); out.setSign(EncryptUtils.SINGLETON.sha(rawSign)); &#125; catch (Exception e) &#123; throw new IllegalArgumentException(\"å‚æ•°ç­¾åå¤±è´¥!\"); &#125; super.writeInternal(out, type, outputMessage); &#125; else &#123; super.writeInternal(object, type, outputMessage); &#125; &#125;&#125; è‡ªå®ç°çš„HttpMessageConverterä¸»è¦éœ€è¦åˆ¤æ–­è¯·æ±‚å‚æ•°çš„ç±»å‹å’Œè¿”å›å€¼çš„ç±»å‹ï¼Œä»è€Œåˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡ŒåŠ è§£å¯†ã€‚ å•çº¯çš„Jsonè¯·æ±‚å‚æ•°å’ŒJsonå“åº”ç»“æœçš„åŠ è§£å¯†å¤„ç†æœ€ä½³å®è·µ ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¯¹æ¥æ–¹çš„è¯·æ±‚å‚æ•°å’Œå“åº”ç»“æœæ˜¯å®Œå…¨è§„èŒƒç»Ÿä¸€ä½¿ç”¨Json(ContentTypeæŒ‡å®šä¸ºapplication/jsonï¼Œä½¿ç”¨@RequestBodyæ¥æ”¶å‚æ•°)ï¼Œé‚£ä¹ˆæ‰€æœ‰çš„äº‹æƒ…å°±ä¼šå˜å¾—ç®€å•ï¼Œå› ä¸ºä¸éœ€è¦è€ƒè™‘è¯·æ±‚å‚æ•°ç”±xxx=yyy&amp;aaa=bbbè½¬æ¢ä¸ºInputStreamå†äº¤ç»™SpringMVCå¤„ç†ï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦æä¾›ä¸€ä¸ªMappingJackson2HttpMessageConverterå­ç±»å®ç°(ç»§æ‰¿å®ƒå¹¶ä¸”è¦†ç›–å¯¹åº”æ–¹æ³•ï¼Œæ·»åŠ åŠ è§£å¯†ç‰¹æ€§)ã€‚æˆ‘ä»¬è¿˜æ˜¯ä½¿ç”¨æ ‡è¯†æ¥å£ç”¨äºå†³å®šè¯·æ±‚å‚æ•°æˆ–è€…å“åº”ç»“æœæ˜¯å¦éœ€è¦åŠ è§£å¯†ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950@RequiredArgsConstructorpublic class CustomEncryptHttpMessageConverter extends MappingJackson2HttpMessageConverter &#123; private final ObjectMapper objectMapper; @Override protected Object readInternal(Class&lt;?&gt; clazz, HttpInputMessage inputMessage) throws IOException, HttpMessageNotReadableException &#123; if (Encryptable.class.isAssignableFrom(clazz)) &#123; EncryptModel in = objectMapper.readValue(StreamUtils.copyToByteArray(inputMessage.getBody()), EncryptModel.class); String inRawSign = String.format(\"data=%s&amp;timestamp=%d\", in.getData(), in.getTimestamp()); String inSign; try &#123; inSign = EncryptUtils.SINGLETON.sha(inRawSign); &#125; catch (Exception e) &#123; throw new IllegalArgumentException(\"éªŒè¯å‚æ•°ç­¾åå¤±è´¥!\"); &#125; if (!inSign.equals(in.getSign())) &#123; throw new IllegalArgumentException(\"éªŒè¯å‚æ•°ç­¾åå¤±è´¥!\"); &#125; try &#123; return objectMapper.readValue(EncryptUtils.SINGLETON.decryptByAes(in.getData()), clazz); &#125; catch (Exception e) &#123; throw new IllegalArgumentException(\"è§£å¯†å¤±è´¥!\"); &#125; &#125; else &#123; return super.readInternal(clazz, inputMessage); &#125; &#125; @Override protected void writeInternal(Object object, Type type, HttpOutputMessage outputMessage) throws IOException, HttpMessageNotWritableException &#123; Class&lt;?&gt; clazz = (Class) type; if (Encryptable.class.isAssignableFrom(clazz)) &#123; EncryptModel out = new EncryptModel(); out.setTimestamp(System.currentTimeMillis()); try &#123; out.setData(EncryptUtils.SINGLETON.encryptByAes(objectMapper.writeValueAsString(object))); String rawSign = String.format(\"data=%s&amp;timestamp=%d\", out.getData(), out.getTimestamp()); out.setSign(EncryptUtils.SINGLETON.sha(rawSign)); &#125; catch (Exception e) &#123; throw new IllegalArgumentException(\"å‚æ•°ç­¾åå¤±è´¥!\"); &#125; super.writeInternal(out, type, outputMessage); &#125; else &#123; super.writeInternal(object, type, outputMessage); &#125; &#125;&#125; æ²¡é”™ï¼Œä»£ç æ˜¯æ‹·è´ä¸Šä¸€èŠ‚æä¾›çš„HttpMessageConverterå®ç°ï¼Œç„¶åæ§åˆ¶å™¨æ–¹æ³•çš„å‚æ•°ä½¿ç”¨@RequestBodyæ³¨è§£å¹¶ä¸”ç±»å‹å®ç°åŠ è§£å¯†æ ‡è¯†æ¥å£Encryptableå³å¯ï¼Œè¿”å›å€¼çš„ç±»å‹ä¹Ÿéœ€è¦å®ç°åŠ è§£å¯†æ ‡è¯†æ¥å£Encryptableã€‚è¿™ç§åšæ³•å¯ä»¥è®©æ§åˆ¶å™¨çš„ä»£ç å¯¹åŠ è§£å¯†å®Œå…¨æ— æ„ŸçŸ¥ã€‚å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ä¸æ”¹å˜åŸæ¥çš„MappingJackson2HttpMessageConverterå®ç°ï¼Œä½¿ç”¨RequestBodyAdviceå’ŒResponseBodyAdviceå®Œæˆç›¸åŒçš„åŠŸèƒ½ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869@RequiredArgsConstructorpublic class CustomRequestBodyAdvice extends RequestBodyAdviceAdapter &#123; private final ObjectMapper objectMapper; @Override public boolean supports(MethodParameter methodParameter, Type targetType, Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt; converterType) &#123; Class&lt;?&gt; clazz = (Class) targetType; return Encryptable.class.isAssignableFrom(clazz); &#125; @Override public HttpInputMessage beforeBodyRead(HttpInputMessage inputMessage, MethodParameter parameter, Type targetType, Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt; converterType) throws IOException &#123; Class&lt;?&gt; clazz = (Class) targetType; if (Encryptable.class.isAssignableFrom(clazz)) &#123; String content = StreamUtils.copyToString(inputMessage.getBody(), Charset.forName(\"UTF-8\")); EncryptModel in = objectMapper.readValue(content, EncryptModel.class); String inRawSign = String.format(\"data=%s&amp;timestamp=%d\", in.getData(), in.getTimestamp()); String inSign; try &#123; inSign = EncryptUtils.SINGLETON.sha(inRawSign); &#125; catch (Exception e) &#123; throw new IllegalArgumentException(\"éªŒè¯å‚æ•°ç­¾åå¤±è´¥!\"); &#125; if (!inSign.equals(in.getSign())) &#123; throw new IllegalArgumentException(\"éªŒè¯å‚æ•°ç­¾åå¤±è´¥!\"); &#125; ByteArrayInputStream inputStream = new ByteArrayInputStream(in.getData().getBytes(Charset.forName(\"UTF-8\"))); return new MappingJacksonInputMessage(inputStream, inputMessage.getHeaders()); &#125; else &#123; return super.beforeBodyRead(inputMessage, parameter, targetType, converterType); &#125; &#125;&#125;@RequiredArgsConstructorpublic class CustomResponseBodyAdvice extends JsonViewResponseBodyAdvice &#123; private final ObjectMapper objectMapper; @Override public boolean supports(MethodParameter returnType, Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt; converterType) &#123; Class&lt;?&gt; parameterType = returnType.getParameterType(); return Encryptable.class.isAssignableFrom(parameterType); &#125; @Override protected void beforeBodyWriteInternal(MappingJacksonValue bodyContainer, MediaType contentType, MethodParameter returnType, ServerHttpRequest request, ServerHttpResponse response) &#123; Class&lt;?&gt; parameterType = returnType.getParameterType(); if (Encryptable.class.isAssignableFrom(parameterType)) &#123; EncryptModel out = new EncryptModel(); out.setTimestamp(System.currentTimeMillis()); try &#123; out.setData(EncryptUtils.SINGLETON.encryptByAes(objectMapper.writeValueAsString(bodyContainer.getValue()))); String rawSign = String.format(\"data=%s&amp;timestamp=%d\", out.getData(), out.getTimestamp()); out.setSign(EncryptUtils.SINGLETON.sha(rawSign)); out.setSign(EncryptUtils.SINGLETON.sha(rawSign)); &#125; catch (Exception e) &#123; throw new IllegalArgumentException(\"å‚æ•°ç­¾åå¤±è´¥!\"); &#125; &#125; else &#123; super.beforeBodyWriteInternal(bodyContainer, contentType, returnType, request, response); &#125; &#125;&#125; å•çº¯çš„application/x-www-form-urlencodedè¡¨å•è¯·æ±‚å‚æ•°å’ŒJsonå“åº”ç»“æœçš„åŠ è§£å¯†å¤„ç†æœ€ä½³å®è·µ ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¯¹æ¥æ–¹çš„è¯·æ±‚å‚æ•°å®Œå…¨é‡‡ç”¨application/x-www-form-urlencodedè¡¨å•è¯·æ±‚å‚æ•°è¿”å›ç»“æœå…¨éƒ¨æŒ‰ç…§Jsonæ¥æ”¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ä¸€ä¸ªHttpMessageConverterå®ç°å°±å®ŒæˆåŠ è§£å¯†æ¨¡å—ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091public class FormHttpMessageConverter implements HttpMessageConverter&lt;Object&gt; &#123; private final List&lt;MediaType&gt; mediaTypes; private final ObjectMapper objectMapper; public FormHttpMessageConverter(ObjectMapper objectMapper) &#123; this.objectMapper = objectMapper; this.mediaTypes = new ArrayList&lt;&gt;(1); this.mediaTypes.add(MediaType.APPLICATION_FORM_URLENCODED); &#125; @Override public boolean canRead(Class&lt;?&gt; clazz, MediaType mediaType) &#123; return Encryptable.class.isAssignableFrom(clazz) &amp;&amp; mediaTypes.contains(mediaType); &#125; @Override public boolean canWrite(Class&lt;?&gt; clazz, MediaType mediaType) &#123; return Encryptable.class.isAssignableFrom(clazz) &amp;&amp; mediaTypes.contains(mediaType); &#125; @Override public List&lt;MediaType&gt; getSupportedMediaTypes() &#123; return mediaTypes; &#125; @Override public Object read(Class&lt;?&gt; clazz, HttpInputMessage inputMessage) throws IOException, HttpMessageNotReadableException &#123; if (Encryptable.class.isAssignableFrom(clazz)) &#123; String content = StreamUtils.copyToString(inputMessage.getBody(), Charset.forName(\"UTF-8\")); EncryptModel in = objectMapper.readValue(content, EncryptModel.class); String inRawSign = String.format(\"data=%s&amp;timestamp=%d\", in.getData(), in.getTimestamp()); String inSign; try &#123; inSign = EncryptUtils.SINGLETON.sha(inRawSign); &#125; catch (Exception e) &#123; throw new IllegalArgumentException(\"éªŒè¯å‚æ•°ç­¾åå¤±è´¥!\"); &#125; if (!inSign.equals(in.getSign())) &#123; throw new IllegalArgumentException(\"éªŒè¯å‚æ•°ç­¾åå¤±è´¥!\"); &#125; try &#123; return objectMapper.readValue(EncryptUtils.SINGLETON.decryptByAes(in.getData()), clazz); &#125; catch (Exception e) &#123; throw new IllegalArgumentException(\"è§£å¯†å¤±è´¥!\"); &#125; &#125; else &#123; MediaType contentType = inputMessage.getHeaders().getContentType(); Charset charset = (contentType != null &amp;&amp; contentType.getCharset() != null ? contentType.getCharset() : Charset.forName(\"UTF-8\")); String body = StreamUtils.copyToString(inputMessage.getBody(), charset); String[] pairs = StringUtils.tokenizeToStringArray(body, \"&amp;\"); MultiValueMap&lt;String, String&gt; result = new LinkedMultiValueMap&lt;&gt;(pairs.length); for (String pair : pairs) &#123; int idx = pair.indexOf('='); if (idx == -1) &#123; result.add(URLDecoder.decode(pair, charset.name()), null); &#125; else &#123; String name = URLDecoder.decode(pair.substring(0, idx), charset.name()); String value = URLDecoder.decode(pair.substring(idx + 1), charset.name()); result.add(name, value); &#125; &#125; return result; &#125; &#125; @Override public void write(Object o, MediaType contentType, HttpOutputMessage outputMessage) throws IOException, HttpMessageNotWritableException &#123; Class&lt;?&gt; clazz = o.getClass(); if (Encryptable.class.isAssignableFrom(clazz)) &#123; EncryptModel out = new EncryptModel(); out.setTimestamp(System.currentTimeMillis()); try &#123; out.setData(EncryptUtils.SINGLETON.encryptByAes(objectMapper.writeValueAsString(o))); String rawSign = String.format(\"data=%s&amp;timestamp=%d\", out.getData(), out.getTimestamp()); out.setSign(EncryptUtils.SINGLETON.sha(rawSign)); StreamUtils.copy(objectMapper.writeValueAsString(out) .getBytes(Charset.forName(\"UTF-8\")), outputMessage.getBody()); &#125; catch (Exception e) &#123; throw new IllegalArgumentException(\"å‚æ•°ç­¾åå¤±è´¥!\"); &#125; &#125; else &#123; String out = objectMapper.writeValueAsString(o); StreamUtils.copy(out.getBytes(Charset.forName(\"UTF-8\")), outputMessage.getBody()); &#125; &#125;&#125; ä¸Šé¢çš„HttpMessageConverterçš„å®ç°å¯ä»¥å‚è€ƒorg.springframework.http.converter.FormHttpMessageConverterã€‚ å°ç»“ è¿™ç¯‡æ–‡ç« å¼ºè¡Œå¤æ‚åŒ–äº†å®é™…çš„æƒ…å†µ(ä½†æ˜¯åœ¨å®é™…ä¸­çœŸçš„ç¢°åˆ°è¿‡)ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œç°åœ¨æµè¡Œä½¿ç”¨Jsonè¿›è¡Œæ•°æ®ä¼ è¾“ï¼Œåœ¨SpringMVCé¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦é’ˆå¯¹æ€§åœ°æ”¹é€ MappingJackson2HttpMessageConverterå³å¯(ç»§æ‰¿å¹¶ä¸”æ·»åŠ ç‰¹æ€§)ï¼Œå¦‚æœå¯¹SpringMVCçš„æºç ç›¸å¯¹ç†Ÿæ‚‰çš„è¯ï¼Œç›´æ¥æ·»åŠ è‡ªå®šä¹‰çš„RequestBodyAdvice(RequestBodyAdviceAdapter)å’ŒResponseBodyAdvice(JsonViewResponseBodyAdvice)å®ç°ä¹Ÿå¯ä»¥è¾¾åˆ°ç›®çš„ã€‚è‡³äºä¸ºä»€ä¹ˆä½¿ç”¨HttpMessageConverteråšåŠ è§£å¯†åŠŸèƒ½ï¼Œè¿™é‡ŒåŸºäºSpringMVCæºç çš„å¯¹è¯·æ±‚å‚æ•°å¤„ç†çš„è¿‡ç¨‹æ•´ç†äº†ä¸€å¼ å¤„ç†æµç¨‹å›¾ï¼š ä¸Šé¢æµç¨‹æœ€æ ¸å¿ƒçš„ä»£ç å¯ä»¥çœ‹AbstractMessageConverterMethodArgumentResolver#readWithMessageConverterså’ŒHandlerMethodArgumentResolverComposite#resolveArgumentï¼Œæ¯•ç«Ÿæºç ä¸ä¼šéª—äººã€‚æ§åˆ¶å™¨æ–¹æ³•è¿”å›å€¼çš„å¤„ç†åŸºäºæ˜¯å¯¹ç§°çš„ï¼Œé˜…è¯»èµ·æ¥ä¹Ÿæ¯”è¾ƒè½»æ¾ã€‚ å‚è€ƒèµ„æ–™ï¼š spring-boot-web-starter:2.0.3.RELEASEæºç ã€‚ ï¼ˆæœ¬æ–‡å®Œ c-d-4 e-a-2018-8-14 è€æ–‡é‡å‘ï¼‰","categories":[{"name":"Spring","slug":"Spring","permalink":"http://throwable.club/blog/categories/Spring/"},{"name":"SpringMVC","slug":"Spring/SpringMVC","permalink":"http://throwable.club/blog/categories/Spring/SpringMVC/"}],"tags":[{"name":"Spring","slug":"Spring","permalink":"http://throwable.club/blog/tags/Spring/"},{"name":"SpringMVC","slug":"SpringMVC","permalink":"http://throwable.club/blog/tags/SpringMVC/"}]},{"title":"åˆè¯†Redisçš„æ•°æ®ç±»å‹HyperLogLog","slug":"redis-type-hll-introduction","date":"2019-11-17T05:10:16.000Z","updated":"2019-11-28T17:03:45.812Z","comments":true,"path":"2019/11/17/redis-type-hll-introduction/","link":"","permalink":"http://throwable.club/2019/11/17/redis-type-hll-introduction/","excerpt":"å‰æ æœªæ¥ä¸€æ®µæ—¶é—´å¼€å‘çš„é¡¹ç›®æˆ–è€…éœ€æ±‚ä¼šå¤§é‡ä½¿ç”¨åˆ°Redisï¼Œè¶ç€è¿™æ®µæ—¶é—´ä¸šåŠ¡å¹¶ä¸å¤ªç¹å¿™ï¼ŒæŠ½ç‚¹æ—¶é—´é¢„ä¹ å’Œå¤ä¹ Redisçš„ç›¸å…³å†…å®¹ã€‚åˆšå¥½çœ‹åˆ°åšå®¢ä¸‹é¢çš„UVå’ŒPVç»Ÿè®¡ï¼Œæƒ³åˆ°äº†æœ€è¿‘çœ‹ä¹¦é‡Œé¢æåˆ°çš„HyperLogLogæ•°æ®ç±»å‹ï¼Œäºæ˜¯èŠ±ç‚¹æ—¶é—´åˆ†æä¸€ä¸‹å®ƒçš„ä½¿ç”¨æ–¹å¼å’Œä½¿ç”¨åœºæ™¯ï¼ˆæš‚æ—¶ä¸æ¢ç©¶HyperLogLogçš„å®ç°åŸç†ï¼‰ã€‚Redisä¸­HyperLogLogæ•°æ®ç±»å‹æ˜¯Redid 2.8.9å¼•å…¥çš„ï¼Œä½¿ç”¨çš„æ—¶å€™ç¡®ä¿Redisç‰ˆæœ¬&gt;= 2.8.9ã€‚","text":"å‰æ æœªæ¥ä¸€æ®µæ—¶é—´å¼€å‘çš„é¡¹ç›®æˆ–è€…éœ€æ±‚ä¼šå¤§é‡ä½¿ç”¨åˆ°Redisï¼Œè¶ç€è¿™æ®µæ—¶é—´ä¸šåŠ¡å¹¶ä¸å¤ªç¹å¿™ï¼ŒæŠ½ç‚¹æ—¶é—´é¢„ä¹ å’Œå¤ä¹ Redisçš„ç›¸å…³å†…å®¹ã€‚åˆšå¥½çœ‹åˆ°åšå®¢ä¸‹é¢çš„UVå’ŒPVç»Ÿè®¡ï¼Œæƒ³åˆ°äº†æœ€è¿‘çœ‹ä¹¦é‡Œé¢æåˆ°çš„HyperLogLogæ•°æ®ç±»å‹ï¼Œäºæ˜¯èŠ±ç‚¹æ—¶é—´åˆ†æä¸€ä¸‹å®ƒçš„ä½¿ç”¨æ–¹å¼å’Œä½¿ç”¨åœºæ™¯ï¼ˆæš‚æ—¶ä¸æ¢ç©¶HyperLogLogçš„å®ç°åŸç†ï¼‰ã€‚Redisä¸­HyperLogLogæ•°æ®ç±»å‹æ˜¯Redid 2.8.9å¼•å…¥çš„ï¼Œä½¿ç”¨çš„æ—¶å€™ç¡®ä¿Redisç‰ˆæœ¬&gt;= 2.8.9ã€‚ HyperLogLogç®€ä»‹ åŸºæ•°è®¡æ•°(cardinality counting)ï¼Œé€šå¸¸ç”¨æ¥ç»Ÿè®¡ä¸€ä¸ªé›†åˆä¸­ä¸é‡å¤çš„å…ƒç´ ä¸ªæ•°ã€‚ä¸€ä¸ªå¾ˆå¸¸è§çš„ä¾‹å­å°±æ˜¯ç»Ÿè®¡æŸä¸ªæ–‡ç« çš„UVï¼ˆUnique Visitorï¼Œç‹¬ç«‹è®¿å®¢ï¼Œä¸€èˆ¬å¯ä»¥ç†è§£ä¸ºå®¢æˆ·ç«¯IPï¼‰ã€‚å¤§æ•°æ®é‡èƒŒæ™¯ä¸‹ï¼Œè¦å®ç°åŸºæ•°è®¡æ•°ï¼Œå¤šæ•°æƒ…å†µä¸‹ä¸ä¼šé€‰æ‹©å­˜å‚¨å…¨é‡çš„åŸºæ•°é›†åˆçš„å…ƒç´ ï¼Œå› ä¸ºå¯ä»¥è®¡ç®—å‡ºå­˜å‚¨çš„å†…å­˜æˆæœ¬ï¼Œå‡è®¾ä¸€ä¸ªæ¯ä¸ªè¢«ç»Ÿè®¡çš„å…ƒç´ çš„å¹³å‡å¤§å°ä¸º32bitï¼Œé‚£ä¹ˆå¦‚æœç»Ÿè®¡ä¸€äº¿ä¸ªæ•°æ®ï¼Œå ç”¨çš„å†…å­˜å¤§å°ä¸ºï¼š 32 * 100000000 / 8 / 1024 / 1024 â‰ˆ 381Mã€‚ å¦‚æœæœ‰å¤šä¸ªé›†åˆï¼Œå¹¶ä¸”å…è®¸è®¡ç®—å¤šä¸ªé›†åˆçš„åˆå¹¶è®¡æ•°ç»“æœï¼Œé‚£ä¹ˆè¿™ä¸ªæ“ä½œå¸¦æ¥çš„å¤æ‚åº¦å¯èƒ½æ˜¯æ¯ç­æ€§çš„ã€‚å› æ­¤ï¼Œä¸ä¼šä½¿ç”¨Bitmapã€Treeæˆ–è€…HashSetç­‰æ•°æ®ç»“æ„ç›´æ¥å­˜å‚¨è®¡æ•°å…ƒç´ é›†åˆçš„æ–¹å¼è¿›è¡Œè®¡æ•°ï¼Œè€Œæ˜¯åœ¨ä¸è¿½æ±‚ç»å¯¹å‡†ç¡®è®¡æ•°ç»“æœçš„å‰æä¹‹ä¸‹ï¼Œä½¿ç”¨åŸºæ•°è®¡æ•°çš„æ¦‚ç‡ç®—æ³•è¿›è¡Œè®¡æ•°ï¼Œç›®å‰å¸¸è§çš„æœ‰æ¦‚ç‡ç®—æ³•ä»¥ä¸‹ä¸‰ç§ï¼š Linear Counting(LC)ã€‚ LogLog Counting(LLC)ã€‚ HyperLogLog Counting(HLL)ã€‚ æ‰€ä»¥ï¼ŒHyperLogLogå…¶å®æ˜¯ä¸€ç§åŸºæ•°è®¡æ•°æ¦‚ç‡ç®—æ³•ï¼Œå¹¶ä¸æ˜¯Redisç‰¹æœ‰çš„ï¼ŒRedisåŸºäºCè¯­è¨€å®ç°äº†HyperLogLogå¹¶ä¸”æä¾›äº†ç›¸å…³å‘½ä»¤APIå…¥å£ã€‚ Redisçš„ä½œè€…Antirezä¸ºäº†çºªå¿µPhilippe Flajoletå¯¹ç»„åˆæ•°å­¦å’ŒåŸºæ•°è®¡ç®—ç®—æ³•åˆ†æçš„ç ”ç©¶ï¼Œæ‰€ä»¥åœ¨è®¾è®¡HyperLogLogå‘½ä»¤çš„æ—¶å€™ä½¿ç”¨äº†Philippe Flajoletå§“åçš„è‹±æ–‡é¦–å­—æ¯PFä½œä¸ºå‰ç¼€ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒPhilippe Flajoletåšå£«æ˜¯HLLç®—æ³•çš„é‡å¤§è´¡çŒ®è€…ï¼Œä½†æ˜¯ä»–å…¶å®å¹¶ä¸æ˜¯Redisä¸­HyperLogLogæ•°æ®ç±»å‹çš„å¼€å‘è€…ã€‚é—æ†¾çš„æ˜¯Philippe Flajoletåšå£«äº2011å¹´3æœˆ22æ—¥å› ç—…åœ¨å·´é»è¾ä¸–ã€‚è¿™ä¸ªæ˜¯Philippe Flajoletåšå£«çš„ç»´åŸºç™¾ç§‘ç…§ç‰‡ï¼š Redisæä¾›çš„HyperLogLogæ•°æ®ç±»å‹çš„ç‰¹å¾ï¼š åŸºæœ¬ç‰¹å¾ï¼šä½¿ç”¨HyperLogLog Counting(HLL)å®ç°ï¼ŒåªåšåŸºæ•°è®¡ç®—ï¼Œä¸ä¼šä¿å­˜å…ƒæ•°æ®ã€‚ å†…å­˜å ç”¨ï¼šHyperLogLogæ¯ä¸ªKEYæœ€å¤šå ç”¨12Kçš„å†…å­˜ç©ºé—´ï¼Œå¯ä»¥è®¡ç®—æ¥è¿‘2^64ä¸ªä¸åŒå…ƒç´ çš„åŸºæ•°ï¼Œå®ƒçš„å­˜å‚¨ç©ºé—´é‡‡ç”¨ç¨€ç–çŸ©é˜µå­˜å‚¨ï¼Œç©ºé—´å ç”¨å¾ˆå°ï¼Œä»…ä»…åœ¨è®¡æ•°åŸºæ•°ä¸ªæ•°æ…¢æ…¢å˜å¤§ï¼Œç¨€ç–çŸ©é˜µå ç”¨ç©ºé—´æ¸æ¸è¶…è¿‡äº†é˜ˆå€¼æ—¶æ‰ä¼šä¸€æ¬¡æ€§è½¬å˜æˆç¨ å¯†çŸ©é˜µï¼Œè½¬å˜æˆç¨ å¯†çŸ©é˜µä¹‹åæ‰ä¼šå ç”¨12Kçš„å†…å­˜ç©ºé—´ã€‚ è®¡æ•°è¯¯å·®èŒƒå›´ï¼šåŸºæ•°è®¡æ•°çš„ç»“æœæ˜¯ä¸€ä¸ªæ ‡å‡†è¯¯å·®ï¼ˆStandard Errorï¼‰ä¸º0.81%çš„è¿‘ä¼¼å€¼ï¼Œå½“æ•°æ®é‡ä¸å¤§çš„æ—¶å€™ï¼Œå¾—åˆ°çš„ç»“æœä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ªå‡†ç¡®å€¼ã€‚ å†…å­˜å ç”¨å°ï¼ˆæ¯ä¸ªKEYæœ€é«˜å ç”¨12Kï¼‰æ˜¯HyperLogLogçš„æœ€å¤§ä¼˜åŠ¿ï¼Œè€Œå®ƒå­˜åœ¨ä¸¤ä¸ªç›¸å¯¹æ˜æ˜¾çš„é™åˆ¶ï¼š è®¡ç®—ç»“æœå¹¶ä¸æ˜¯å‡†ç¡®å€¼ï¼Œå­˜åœ¨æ ‡å‡†è¯¯å·®ï¼Œè¿™æ˜¯ç”±äºå®ƒæœ¬è´¨ä¸Šæ˜¯ç”¨æ¦‚ç‡ç®—æ³•å¯¼è‡´çš„ã€‚ ä¸ä¿å­˜åŸºæ•°çš„å…ƒæ•°æ®ï¼Œè¿™ä¸€ç‚¹å¯¹éœ€è¦ä½¿ç”¨å…ƒæ•°æ®è¿›è¡Œæ•°æ®åˆ†æçš„åœºæ™¯å¹¶ä¸å‹å¥½ã€‚ HyperLogLogå‘½ä»¤ä½¿ç”¨ Redisæä¾›çš„HyperLogLogæ•°æ®ç±»å‹ä¸€å…±æœ‰ä¸‰ä¸ªå‘½ä»¤APIï¼šPFADDã€PFCOUNTå’ŒPFMERGEã€‚ PFADD PFADDå‘½ä»¤å‚æ•°å¦‚ä¸‹ï¼š 1PFADD key element [element â€¦] æ”¯æŒæ­¤å‘½ä»¤çš„Redisç‰ˆæœ¬æ˜¯ï¼š&gt;= 2.8.9 æ—¶é—´å¤æ‚åº¦ï¼šæ¯æ·»åŠ ä¸€ä¸ªå…ƒç´ çš„å¤æ‚åº¦ä¸ºO(1) åŠŸèƒ½ï¼šå°†æ‰€æœ‰å…ƒç´ å‚æ•°elementæ·»åŠ åˆ°é”®ä¸ºkeyçš„HyperLogLogæ•°æ®ç»“æ„ä¸­ã€‚ PFADDå‘½ä»¤çš„æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š PFADDå‘½ä»¤çš„ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š 12345678910127.0.0.1:6379&gt; PFADD food apple fish(integer) 1127.0.0.1:6379&gt; PFADD food apple(integer) 0127.0.0.1:6379&gt; PFADD throwable(integer) 1127.0.0.1:6379&gt; SET name dogeOK127.0.0.1:6379&gt; PFADD name throwable(error) WRONGTYPE Key is not a valid HyperLogLog string value. è™½ç„¶HyperLogLogæ•°æ®ç»“æ„æœ¬è´¨æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä½†æ˜¯ä¸èƒ½åœ¨Stringç±»å‹çš„KEYä½¿ç”¨HyperLogLogçš„ç›¸å…³å‘½ä»¤ã€‚ PFCOUNT PFCOUNTå‘½ä»¤å‚æ•°å¦‚ä¸‹ï¼š 1PFCOUNT key [key â€¦] æ”¯æŒæ­¤å‘½ä»¤çš„Redisç‰ˆæœ¬æ˜¯ï¼š&gt;= 2.8.9 æ—¶é—´å¤æ‚åº¦ï¼šè¿”å›å•ä¸ªHyperLogLogçš„åŸºæ•°è®¡æ•°å€¼çš„å¤æ‚åº¦ä¸ºO(1)ï¼Œå¹³å‡å¸¸æ•°æ—¶é—´æ¯”è¾ƒä½ã€‚å½“å‚æ•°ä¸ºå¤šä¸ªkeyçš„æ—¶å€™ï¼Œå¤æ‚åº¦ä¸ºO(N)ï¼ŒNä¸ºkeyçš„ä¸ªæ•°ã€‚ å½“PFCOUNTå‘½ä»¤ä½¿ç”¨å•ä¸ªkeyçš„æ—¶å€™ï¼Œè¿”å›å‚¨å­˜åœ¨ç»™å®šé”®çš„HyperLogLogæ•°æ®ç»“æ„çš„è¿‘ä¼¼åŸºæ•°ï¼Œå¦‚æœé”®ä¸å­˜åœ¨ï¼Œ åˆ™è¿”å›0ã€‚ å½“PFCOUNTå‘½ä»¤ä½¿ç”¨å¤šä¸ªkeyçš„æ—¶å€™ï¼Œè¿”å›å‚¨å­˜åœ¨ç»™å®šçš„æ‰€æœ‰HyperLogLogæ•°æ®ç»“æ„çš„å¹¶é›†çš„è¿‘ä¼¼åŸºæ•°ï¼Œä¹Ÿå°±æ˜¯ä¼šæŠŠæ‰€æœ‰çš„HyperLogLogæ•°æ®ç»“æ„åˆå¹¶åˆ°ä¸€ä¸ªä¸´æ—¶çš„HyperLogLogæ•°æ®ç»“æ„ï¼Œç„¶åè®¡ç®—å‡ºè¿‘ä¼¼åŸºæ•°ã€‚ PFCOUNTå‘½ä»¤çš„ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š 12345678910127.0.0.1:6379&gt; PFADD POST:1 ip-1 ip-2(integer) 1127.0.0.1:6379&gt; PFADD POST:2 ip-2 ip-3 ip-4(integer) 1127.0.0.1:6379&gt; PFCOUNT POST:1(integer) 2127.0.0.1:6379&gt; PFCOUNT POST:1 POST:2(integer) 4127.0.0.1:6379&gt; PFCOUNT NOT_EXIST_KEY(integer) 0 PFMERGE PFMERGEå‘½ä»¤å‚æ•°å¦‚ä¸‹ï¼š 1PFMERGE destkey sourcekey [sourcekey ...] æ”¯æŒæ­¤å‘½ä»¤çš„Redisç‰ˆæœ¬æ˜¯ï¼š&gt;= 2.8.9 æ—¶é—´å¤æ‚åº¦ï¼šO(N)ï¼Œå…¶ä¸­Nä¸ºè¢«åˆå¹¶çš„HyperLogLogæ•°æ®ç»“æ„çš„æ•°é‡ï¼Œæ­¤å‘½ä»¤çš„å¸¸æ•°æ—¶é—´æ¯”è¾ƒé«˜ åŠŸèƒ½ï¼šæŠŠå¤šä¸ªHyperLogLogæ•°æ®ç»“æ„åˆå¹¶ä¸ºä¸€ä¸ªæ–°çš„é”®ä¸ºdestkeyçš„HyperLogLogæ•°æ®ç»“æ„ï¼Œåˆå¹¶åçš„HyperLogLogçš„åŸºæ•°æ¥è¿‘äºæ‰€æœ‰è¾“å…¥HyperLogLogçš„å¯è§é›†åˆï¼ˆObserved Setï¼‰çš„å¹¶é›†çš„åŸºæ•°ã€‚ å‘½ä»¤è¿”å›å€¼ï¼šåªä¼šè¿”å›å­—ç¬¦ä¸²OKã€‚ PFMERGEå‘½ä»¤çš„ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ 12345678127.0.0.1:6379&gt; PFADD POST:1 ip-1 ip-2(integer) 1127.0.0.1:6379&gt; PFADD POST:2 ip-2 ip-3 ip-4(integer) 1127.0.0.1:6379&gt; PFMERGE POST:1-2 POST:1 POST:2OK127.0.0.1:6379&gt; PFCOUNT POST:1-2(integer) 4 ä½¿ç”¨HyperLogLogç»Ÿè®¡UVçš„æ¡ˆä¾‹ å‡è®¾ç°åœ¨æœ‰ä¸ªç®€å•çš„åœºæ™¯ï¼Œå°±æ˜¯ç»Ÿè®¡åšå®¢æ–‡ç« çš„UVï¼Œè¦æ±‚UVçš„è®¡æ•°ä¸éœ€è¦å‡†ç¡®ï¼Œä¹Ÿä¸éœ€è¦ä¿å­˜å®¢æˆ·ç«¯çš„IPæ•°æ®ã€‚ä¸‹é¢å°±è¿™ä¸ªåœºæ™¯ï¼Œä½¿ç”¨HyperLogLogåšä¸€ä¸ªç®€å•çš„æ–¹æ¡ˆå’Œç¼–ç å®æ–½ã€‚ è¿™ä¸ªæµç¨‹å¯èƒ½æ­¥éª¤çš„å…ˆåé¡ºåºå¯èƒ½ä¼šæœ‰æ‰€è°ƒæ•´ï¼Œä½†æ˜¯è¦åšçš„æ“ä½œæ˜¯åŸºæœ¬ä¸å˜çš„ã€‚å…ˆç®€å•å‡è®¾ï¼Œæ–‡ç« çš„å†…å®¹å’Œç»Ÿè®¡æ•°æ®éƒ½æ˜¯åå°æœåŠ¡è¿”å›çš„ï¼Œä¸¤ä¸ªæ¥å£æ˜¯åˆ†å¼€è®¾è®¡ã€‚å¼•å…¥Redisçš„é«˜çº§å®¢æˆ·ç«¯Lettuceä¾èµ–ï¼š 12345&lt;dependency&gt; &lt;groupId&gt;io.lettuce&lt;/groupId&gt; &lt;artifactId&gt;lettuce-core&lt;/artifactId&gt; &lt;version&gt;5.2.1.RELEASE&lt;/version&gt;&lt;/dependency&gt; ç¼–ç å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849public class UvTest &#123; private static RedisCommands&lt;String, String&gt; COMMANDS; @BeforeClass public static void beforeClass() throws Exception &#123; // åˆå§‹åŒ–Rediså®¢æˆ·ç«¯ RedisURI uri = RedisURI.builder().withHost(\"localhost\").withPort(6379).build(); RedisClient redisClient = RedisClient.create(uri); StatefulRedisConnection&lt;String, String&gt; connect = redisClient.connect(); COMMANDS = connect.sync(); &#125; @Data public static class PostDetail &#123; private Long id; private String content; &#125; private PostDetail selectPostDetail(Long id) &#123; PostDetail detail = new PostDetail(); detail.setContent(\"content\"); detail.setId(id); return detail; &#125; private PostDetail getPostDetail(String clientIp, Long postId) &#123; PostDetail detail = selectPostDetail(postId); String key = \"puv:\" + postId; COMMANDS.pfadd(key, clientIp); return detail; &#125; private Long getPostUv(Long postId) &#123; String key = \"puv:\" + postId; return COMMANDS.pfcount(key); &#125; @Test public void testViewPost() throws Exception &#123; Long postId = 1L; getPostDetail(\"111.111.111.111\", postId); getPostDetail(\"111.111.111.222\", postId); getPostDetail(\"111.111.111.333\", postId); getPostDetail(\"111.111.111.444\", postId); System.out.println(String.format(\"The uv count of post [%d] is %d\", postId, getPostUv(postId))); &#125;&#125; è¾“å‡ºç»“æœï¼š 1The uv count of post [1] is 4 å¯ä»¥é€‚å½“ä½¿ç”¨æ›´å¤šæ•°é‡çš„ä¸åŒå®¢æˆ·ç«¯IPè°ƒç”¨getPostDetail()ï¼Œç„¶åç»Ÿè®¡ä¸€ä¸‹è¯¯å·®ã€‚ é¢˜å¤–è¯-å¦‚ä½•å‡†ç¡®åœ°ç»Ÿè®¡UV å¦‚æœæƒ³è¦å‡†ç¡®ç»Ÿè®¡UVï¼Œåˆ™éœ€è¦æ³¨æ„å‡ ä¸ªç‚¹ï¼š å†…å­˜æˆ–è€…ç£ç›˜å®¹é‡éœ€è¦å‡†å¤‡å……è¶³ï¼Œå› ä¸ºå°±ç›®å‰çš„åŸºæ•°è®¡æ•°ç®—æ³•æ¥çœ‹ï¼Œæ²¡æœ‰ä»»ä½•ç®—æ³•å¯ä»¥åœ¨ä¸ä¿å­˜å…ƒæ•°æ®çš„å‰æä¸‹è¿›è¡Œå‡†ç¡®è®¡æ•°ã€‚ å¦‚æœéœ€è¦åšç”¨æˆ·è¡Œä¸ºåˆ†æï¼Œé‚£ä¹ˆå…ƒæ•°æ®æœ€ç»ˆéœ€è¦æŒä¹…åŒ–ï¼Œè¿™ä¸€ç‚¹åº”è¯¥ä¾æ‰˜äºå¤§æ•°æ®ä½“ç³»ï¼Œåœ¨è¿™ä¸€æ–¹é¢ç¬”è€…æ²¡æœ‰ç»éªŒï¼Œæ‰€ä»¥æš‚æ—¶ä¸å¤šè¯´ã€‚ å‡è®¾åœ¨ä¸è€ƒè™‘å†…å­˜æˆæœ¬çš„å‰æä¸‹ï¼Œæˆ‘ä»¬ä¾ç„¶å¯ä»¥ä½¿ç”¨Redisåšå‡†ç¡®å’Œå®æ—¶çš„UVç»Ÿè®¡ï¼Œç®€å•å°±å¯ä»¥ä½¿ç”¨Setæ•°æ®ç±»å‹ï¼Œå¢åŠ UVåªéœ€è¦ä½¿ç”¨SADDå‘½ä»¤ï¼Œç»Ÿè®¡UVåªéœ€è¦ä½¿ç”¨SCARDå‘½ä»¤ï¼ˆæ—¶é—´å¤æ‚åº¦ä¸ºO(1)ï¼Œå¯ä»¥æ”¾å¿ƒä½¿ç”¨ï¼‰ã€‚ä¸¾ä¾‹ï¼š 123456127.0.0.1:6379&gt; SADD puv:1 ip-1 ip-2(integer) 2127.0.0.1:6379&gt; SADD puv:1 ip-3 ip-4(integer) 2127.0.0.1:6379&gt; SCARD puv:1(integer) 4 å¦‚æœè¿™äº›ç»Ÿè®¡æ•°æ®ä»…ä»…æ˜¯ç”¨æˆ·ç«¯å±•ç¤ºï¼Œé‚£ä¹ˆå¯ä»¥é‡‡ç”¨å¼‚æ­¥è®¾è®¡ï¼š åœ¨ä½“é‡å°çš„æ—¶å€™ï¼Œä¸Šé¢çš„æ‰€æœ‰åº”ç”¨çš„åŠŸèƒ½å¯ä»¥åœ¨åŒä¸€ä¸ªæœåŠ¡ä¸­å®Œæˆï¼Œæ¶ˆæ¯é˜Ÿåˆ—å¯ä»¥ç”¨çº¿ç¨‹æ± çš„å¼‚æ­¥æ–¹æ¡ˆæ›¿ä»£ã€‚ å°ç»“ è¿™ç¯‡æ–‡ç« åªæ˜¯ç®€å•ä»‹ç»äº†HyperLogLogçš„ä½¿ç”¨å’Œç»Ÿè®¡UVçš„ä½¿ç”¨åœºæ™¯ã€‚æ€»çš„æ¥è¯´å°±æ˜¯ï¼šåœ¨ï¼ˆ1ï¼‰åŸå§‹æ•°æ®é‡å·¨å¤§ï¼Œï¼ˆ2ï¼‰å†…å­˜å ç”¨è¦æ±‚å°½å¯èƒ½å°ï¼Œï¼ˆ3ï¼‰å…è®¸è®¡æ•°å­˜åœ¨ä¸€å®šè¯¯å·®å¹¶ä¸”ï¼ˆ4ï¼‰ä¸è¦æ±‚å­˜æ”¾å…ƒæ•°æ®çš„åœºæ™¯ä¸‹ï¼Œå¯ä»¥ä¼˜å…ˆè€ƒè™‘ä½¿ç”¨HyperLogLogè¿›è¡Œè®¡æ•°ã€‚ å‚è€ƒèµ„æ–™ï¼š antirez-Redis new data structure: the HyperLogLog Redis Commands ç»´åŸºç™¾ç§‘ ï¼ˆæœ¬æ–‡å®Œ c-3-d e-a-20191117ï¼‰","categories":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/categories/Middleware/"},{"name":"Redis","slug":"Middleware/Redis","permalink":"http://throwable.club/blog/categories/Middleware/Redis/"}],"tags":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/tags/Middleware/"},{"name":"Redis","slug":"Redis","permalink":"http://throwable.club/blog/tags/Redis/"}]},{"title":"ä½¿ç”¨Rediså®ç°UAæ± ","slug":"redis-in-action-ua-pool","date":"2019-11-13T17:02:36.000Z","updated":"2019-11-28T17:00:58.743Z","comments":true,"path":"2019/11/14/redis-in-action-ua-pool/","link":"","permalink":"http://throwable.club/2019/11/14/redis-in-action-ua-pool/","excerpt":"å‰æ æœ€è¿‘å¿™äºä¸šåŠ¡å¼€å‘ã€äº¤æ¥å’Œæ¸¸æˆï¼ŒåŠ ä¸Šç¢°ä¸Šäº†ä¸å®šæ—¶å‡ºç°çš„çŠ¹è±«æœŸå’Œå›°æƒ‘æœŸï¼Œè’åºŸå­¦ä¸šäº†ä¸€æ®µæ—¶é—´ã€‚å¤©å†·äº†ï¼Œè¦é‡æ–°æ‹¾èµ·å¼€å§‹ä¸‹é˜¶æ®µçš„å­¦ä¹ äº†ã€‚ä¹‹å‰æ¥è§¦åˆ°çš„ä¸€äº›æ•°æ®æœç´¢é¡¹ç›®ï¼Œæ¶‰åŠåˆ°è¯·æ±‚æ¨¡æ‹Ÿï¼ŒåŸºäºåçˆ¬éœ€è¦ä½¿ç”¨éšæœºçš„User Agentï¼Œäºæ˜¯ä½¿ç”¨Rediså®ç°äº†ä¸€ä¸ªååˆ†ç®€æ˜“çš„UAæ± ã€‚","text":"å‰æ æœ€è¿‘å¿™äºä¸šåŠ¡å¼€å‘ã€äº¤æ¥å’Œæ¸¸æˆï¼ŒåŠ ä¸Šç¢°ä¸Šäº†ä¸å®šæ—¶å‡ºç°çš„çŠ¹è±«æœŸå’Œå›°æƒ‘æœŸï¼Œè’åºŸå­¦ä¸šäº†ä¸€æ®µæ—¶é—´ã€‚å¤©å†·äº†ï¼Œè¦é‡æ–°æ‹¾èµ·å¼€å§‹ä¸‹é˜¶æ®µçš„å­¦ä¹ äº†ã€‚ä¹‹å‰æ¥è§¦åˆ°çš„ä¸€äº›æ•°æ®æœç´¢é¡¹ç›®ï¼Œæ¶‰åŠåˆ°è¯·æ±‚æ¨¡æ‹Ÿï¼ŒåŸºäºåçˆ¬éœ€è¦ä½¿ç”¨éšæœºçš„User Agentï¼Œäºæ˜¯ä½¿ç”¨Rediså®ç°äº†ä¸€ä¸ªååˆ†ç®€æ˜“çš„UAæ± ã€‚ èƒŒæ™¯ æœ€è¿‘çš„ä¸€ä¸ªéœ€æ±‚ï¼Œæœ‰æ¨¡æ‹Ÿè¯·æ±‚çš„é€»è¾‘ï¼Œè¦æ±‚æ¯æ¬¡è¯·æ±‚çš„è¯·æ±‚å¤´ä¸­çš„User Agentè¦æ»¡è¶³ä¸‹é¢å‡ ç‚¹ï¼š æ¯æ¬¡è·å–çš„User Agentæ˜¯éšæœºçš„ã€‚ æ¯æ¬¡è·å–çš„User Agentï¼ˆçŸ­æ—¶é—´å†…ï¼‰ä¸èƒ½é‡å¤ã€‚ æ¯æ¬¡è·å–çš„User Agentå¿…é¡»å¸¦æœ‰ä¸»æµçš„æ“ä½œç³»ç»Ÿä¿¡æ¯ï¼ˆå¯ä»¥æ˜¯Uinuxã€Windowsã€IOSå’Œå®‰å“ç­‰ç­‰ï¼‰ã€‚ è¿™é‡Œä¸‰ç‚¹éƒ½å¯ä»¥ä»UAæ•°æ®çš„æ¥æºè§£å†³ï¼Œå®é™…ä¸Šæˆ‘ä»¬åº”è¯¥å…³æ³¨å…·ä½“çš„å®ç°æ–¹æ¡ˆã€‚ç®€å•åˆ†æä¸€ä¸‹ï¼Œæµç¨‹å¦‚ä¸‹ï¼š åœ¨è®¾è®¡UAæ± çš„æ—¶å€™ï¼Œå®ƒçš„æ•°æ®ç»“æ„å’Œç¯å½¢é˜Ÿåˆ—ååˆ†ç±»ä¼¼ï¼š ä¸Šå›¾ä¸­ï¼Œå‡è®¾ä¸åŒé¢œè‰²çš„UAæ˜¯å®Œå…¨ä¸åŒçš„UAï¼Œå®ƒä»¬é€šè¿‡æ´—ç‰Œç®—æ³•æ‰“æ•£æ”¾è¿›å»ç¯å½¢é˜Ÿåˆ—ä¸­ï¼Œå®é™…ä¸Šæ¯æ¬¡å–å‡ºä¸€ä¸ªUAä¹‹åï¼Œåªéœ€è¦æŠŠæ¸¸æ ‡cursorå‰è¿›æˆ–è€…åé€€ä¸€æ ¼å³å¯ï¼ˆç”šè‡³å¯ä»¥æŠŠæ¸¸æ ‡è®¾ç½®åˆ°é˜Ÿåˆ—ä¸­çš„ä»»æ„å…ƒç´ ï¼‰ã€‚æœ€ç»ˆçš„å®ç°å°±æ˜¯ï¼šéœ€è¦é€šè¿‡ä¸­é—´ä»¶å®ç°åˆ†å¸ƒå¼é˜Ÿåˆ—ï¼ˆåªæ˜¯é˜Ÿåˆ—ï¼Œä¸æ˜¯æ¶ˆæ¯é˜Ÿåˆ—ï¼‰ã€‚ å…·ä½“å®ç°æ–¹æ¡ˆ æ¯«æ— ç–‘é—®éœ€è¦ä¸€ä¸ªåˆ†å¸ƒå¼æ•°æ®åº“ç±»å‹çš„ä¸­é—´ä»¶æ‰èƒ½å­˜æ”¾å·²ç»å‡†å¤‡å¥½çš„UAï¼Œç¬¬ä¸€å°è±¡å°±æ„Ÿè§‰Redisä¼šæ¯”è¾ƒåˆé€‚ã€‚æ¥ä¸‹æ¥éœ€è¦é€‰ç”¨Redisçš„æ•°æ®ç±»å‹ï¼Œä¸»è¦è€ƒè™‘å‡ ä¸ªæ–¹é¢ï¼š å…·å¤‡é˜Ÿåˆ—æ€§è´¨ã€‚ æœ€å¥½æ”¯æŒéšæœºè®¿é—®ã€‚ å…ƒç´ å…¥é˜Ÿã€å‡ºé˜Ÿå’Œéšæœºè®¿é—®çš„æ—¶é—´å¤æ‚åº¦è¦ä½ï¼Œæ¯•ç«Ÿè·å–UAçš„æ¥å£è®¿é—®é‡ä¼šæ¯”è¾ƒå¤§ã€‚ æ”¯æŒè¿™å‡ ä¸ªæ–¹é¢çš„Redisæ•°æ®ç±»å‹å°±æ˜¯Listï¼Œä¸è¿‡æ³¨æ„Listæœ¬èº«ä¸èƒ½å»é‡ï¼Œå»é‡çš„å·¥ä½œå¯ä»¥ç”¨ä»£ç é€»è¾‘å®ç°ã€‚ç„¶åå¯ä»¥æƒ³è±¡å®¢æˆ·ç«¯è·å–UAçš„æµç¨‹å¤§è‡´å¦‚ä¸‹ï¼š ç»“åˆå‰é¢çš„åˆ†æï¼Œç¼–ç è¿‡ç¨‹æœ‰å¦‚ä¸‹å‡ æ­¥ï¼š å‡†å¤‡å¥½éœ€è¦å¯¼å…¥çš„UAæ•°æ®ï¼Œå¯ä»¥ä»æ•°æ®æºè¯»å–ï¼Œä¹Ÿå¯ä»¥ç›´æ¥æ–‡ä»¶è¯»å–ã€‚ å› ä¸ºéœ€è¦å¯¼å…¥çš„UAæ•°æ®é›†åˆä¸€èˆ¬ä¸ä¼šå¤ªå¤§ï¼Œè€ƒè™‘å…ˆæŠŠè¿™ä¸ªé›†åˆçš„æ•°æ®éšæœºæ‰“æ•£ï¼Œå¦‚æœä½¿ç”¨Javaå¼€å‘å¯ä»¥ç›´æ¥ä½¿ç”¨Collections#shuffle()æ´—ç‰Œç®—æ³•ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥è‡ªè¡Œå®ç°è¿™ä¸ªæ•°æ®éšæœºåˆ†å¸ƒçš„ç®—æ³•ï¼Œè¿™ä¸€æ­¥å¯¹äºä¸€äº›è¢«æ¨¡æ‹Ÿæ–¹ä¼šä¸¥æ ¼æ£€éªŒUAåˆæ³•æ€§çš„åœºæ™¯æ˜¯å¿…é¡»çš„ã€‚ å¯¼å…¥UAæ•°æ®åˆ°Redisåˆ—è¡¨ä¸­ã€‚ ç¼–å†™RPOP + LPUSHçš„Luaè„šæœ¬ï¼Œå®ç°åˆ†å¸ƒå¼å¾ªç¯é˜Ÿåˆ—ã€‚ ç¼–ç å’Œæµ‹è¯•ç¤ºä¾‹ å¼•å…¥Redisçš„é«˜çº§å®¢æˆ·ç«¯Lettuceä¾èµ–ï¼š 12345&lt;dependency&gt; &lt;groupId&gt;io.lettuce&lt;/groupId&gt; &lt;artifactId&gt;lettuce-core&lt;/artifactId&gt; &lt;version&gt;5.2.1.RELEASE&lt;/version&gt;&lt;/dependency&gt; ç¼–å†™RPOP + LPUSHçš„Luaè„šæœ¬ï¼ŒLuaè„šæœ¬åå­—æš‚ç§°ä¸ºL_RPOP_LPUSH.luaï¼Œæ”¾åœ¨resources/scripts/luaç›®å½•ä¸‹ï¼š 1234local key = KEYS[1]local value = redis.call('RPOP', key)redis.call('LPUSH', key, value)return value è¿™ä¸ªè„šæœ¬ååˆ†ç®€å•ï¼Œä½†æ˜¯å·²ç»å®ç°äº†å¾ªç¯é˜Ÿåˆ—çš„åŠŸèƒ½ã€‚å‰©ä¸‹æ¥çš„æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041public class UaPoolTest &#123; private static RedisCommands&lt;String, String&gt; COMMANDS; private static AtomicReference&lt;String&gt; LUA_SHA = new AtomicReference&lt;&gt;(); private static final String KEY = \"UA_POOL\"; @BeforeClass public static void beforeClass() throws Exception &#123; // åˆå§‹åŒ–Rediså®¢æˆ·ç«¯ RedisURI uri = RedisURI.builder().withHost(\"localhost\").withPort(6379).build(); RedisClient redisClient = RedisClient.create(uri); StatefulRedisConnection&lt;String, String&gt; connect = redisClient.connect(); COMMANDS = connect.sync(); // æ¨¡æ‹Ÿæ„å»ºUAæ± çš„åŸå§‹æ•°æ®,å‡è®¾æœ‰10ä¸ªUA,åˆ†åˆ«æ˜¯UA-0 ... UA-9 List&lt;String&gt; uaList = Lists.newArrayList(); IntStream.range(0, 10).forEach(e -&gt; uaList.add(String.format(\"UA-%d\", e))); // æ´—ç‰Œ Collections.shuffle(uaList); // åŠ è½½Luaè„šæœ¬ ClassPathResource resource = new ClassPathResource(\"/scripts/lua/L_RPOP_LPUSH.lua\"); String content = StreamUtils.copyToString(resource.getInputStream(), StandardCharsets.UTF_8); String sha = COMMANDS.scriptLoad(content); LUA_SHA.compareAndSet(null, sha); // Redisé˜Ÿåˆ—ä¸­å†™å…¥UAæ•°æ®,æ•°æ®é‡å¤šçš„æ—¶å€™å¯ä»¥è€ƒè™‘åˆ†æ‰¹å†™å…¥é˜²æ­¢é•¿æ—¶é—´é˜»å¡RedisæœåŠ¡ COMMANDS.lpush(KEY, uaList.toArray(new String[0])); &#125; @AfterClass public static void afterClass() throws Exception &#123; COMMANDS.del(KEY); &#125; @Test public void testUaPool() &#123; IntStream.range(1, 21).forEach(e -&gt; &#123; String result = COMMANDS.evalsha(LUA_SHA.get(), ScriptOutputType.VALUE, KEY); System.out.println(String.format(\"ç¬¬%dæ¬¡è·å–åˆ°çš„UAæ˜¯:%s\", e, result)); &#125;); &#125;&#125; æŸæ¬¡è¿è¡Œç»“æœå¦‚ä¸‹ï¼š 1234567891011121314151617181920ç¬¬1æ¬¡è·å–åˆ°çš„UAæ˜¯:UA-0ç¬¬2æ¬¡è·å–åˆ°çš„UAæ˜¯:UA-8ç¬¬3æ¬¡è·å–åˆ°çš„UAæ˜¯:UA-2ç¬¬4æ¬¡è·å–åˆ°çš„UAæ˜¯:UA-4ç¬¬5æ¬¡è·å–åˆ°çš„UAæ˜¯:UA-7ç¬¬6æ¬¡è·å–åˆ°çš„UAæ˜¯:UA-5ç¬¬7æ¬¡è·å–åˆ°çš„UAæ˜¯:UA-1ç¬¬8æ¬¡è·å–åˆ°çš„UAæ˜¯:UA-3ç¬¬9æ¬¡è·å–åˆ°çš„UAæ˜¯:UA-6ç¬¬10æ¬¡è·å–åˆ°çš„UAæ˜¯:UA-9ç¬¬11æ¬¡è·å–åˆ°çš„UAæ˜¯:UA-0ç¬¬12æ¬¡è·å–åˆ°çš„UAæ˜¯:UA-8ç¬¬13æ¬¡è·å–åˆ°çš„UAæ˜¯:UA-2ç¬¬14æ¬¡è·å–åˆ°çš„UAæ˜¯:UA-4ç¬¬15æ¬¡è·å–åˆ°çš„UAæ˜¯:UA-7ç¬¬16æ¬¡è·å–åˆ°çš„UAæ˜¯:UA-5ç¬¬17æ¬¡è·å–åˆ°çš„UAæ˜¯:UA-1ç¬¬18æ¬¡è·å–åˆ°çš„UAæ˜¯:UA-3ç¬¬19æ¬¡è·å–åˆ°çš„UAæ˜¯:UA-6ç¬¬20æ¬¡è·å–åˆ°çš„UAæ˜¯:UA-9 å¯è§æ´—ç‰Œç®—æ³•çš„æ•ˆæœä¸å·®ï¼Œæ•°æ®ç›¸å¯¹åˆ†æ•£ã€‚ å°ç»“ å…¶å®UAæ± çš„è®¾è®¡éš¾åº¦å¹¶ä¸å¤§ï¼Œéœ€è¦æ³¨æ„å‡ ä¸ªè¦ç‚¹ï¼š ä¸€èˆ¬ä¸»æµçš„ç§»åŠ¨è®¾å¤‡æˆ–è€…æ¡Œé¢è®¾å¤‡çš„ç³»ç»Ÿç‰ˆæœ¬ä¸ä¼šå¤ªå¤šï¼Œæ‰€ä»¥æ¥æºUAæ•°æ®ä¸ä¼šå¤ªå¤šï¼Œæœ€ç®€å•çš„å®ç°å¯ä»¥ä½¿ç”¨æ–‡ä»¶å­˜æ”¾ï¼Œä¸€æ¬¡è¯»å–ç›´æ¥å†™å…¥Redisä¸­ã€‚ æ³¨æ„éœ€è¦éšæœºæ‰“æ•£UAæ•°æ®ï¼Œé¿å…åŒä¸€ä¸ªè®¾å¤‡ç³»ç»Ÿç±»å‹çš„UAæ•°æ®è¿‡äºå¯†é›†ï¼Œè¿™æ ·å¯ä»¥é¿å…è§¦å‘æ¨¡æ‹ŸæŸäº›è¯·æ±‚æ—¶å€™çš„é£æ§è§„åˆ™ã€‚ éœ€è¦ç†Ÿæ‚‰Luaçš„è¯­æ³•ï¼Œæ¯•ç«ŸRedisçš„åŸå­æŒ‡ä»¤ä¸€å®šç¦»ä¸å¼€Luaè„šæœ¬ã€‚ ï¼ˆæœ¬æ–‡å®Œ c-2-d e-a-20191114ï¼‰","categories":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/categories/Middleware/"},{"name":"Redis","slug":"Middleware/Redis","permalink":"http://throwable.club/blog/categories/Middleware/Redis/"}],"tags":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/tags/Middleware/"},{"name":"Redis","slug":"Redis","permalink":"http://throwable.club/blog/tags/Redis/"}]},{"title":"ä¸€æ–‡å½»åº•ç†è§£Redisåºåˆ—åŒ–åè®®ï¼Œä½ ä¹Ÿå¯ä»¥ç¼–å†™Rediså®¢æˆ·ç«¯","slug":"redis-serialization-protocol-decode-guide","date":"2019-10-09T14:40:13.000Z","updated":"2019-11-28T17:01:03.790Z","comments":true,"path":"2019/10/09/redis-serialization-protocol-decode-guide/","link":"","permalink":"http://throwable.club/2019/10/09/redis-serialization-protocol-decode-guide/","excerpt":"å‰æ æœ€è¿‘å­¦ä¹ Nettyçš„æ—¶å€™æƒ³åšä¸€ä¸ªåŸºäºRedisæœåŠ¡åè®®çš„ç¼–ç è§£ç æ¨¡å—ï¼Œè¿‡ç¨‹ä¸­é¡ºä¾¿é˜…è¯»äº†RedisæœåŠ¡åºåˆ—åŒ–åè®®RESPï¼Œç»“åˆè‡ªå·±çš„ç†è§£å¯¹æ–‡æ¡£è¿›è¡Œäº†ç¿»è¯‘å¹¶ä¸”ç®€å•å®ç°äº†RESPåŸºäºJavaè¯­è¨€çš„è§£æã€‚ç¼–å†™æœ¬æ–‡çš„ä½¿ç”¨ä½¿ç”¨çš„JDKç‰ˆæœ¬ä¸º[8+]ã€‚","text":"å‰æ æœ€è¿‘å­¦ä¹ Nettyçš„æ—¶å€™æƒ³åšä¸€ä¸ªåŸºäºRedisæœåŠ¡åè®®çš„ç¼–ç è§£ç æ¨¡å—ï¼Œè¿‡ç¨‹ä¸­é¡ºä¾¿é˜…è¯»äº†RedisæœåŠ¡åºåˆ—åŒ–åè®®RESPï¼Œç»“åˆè‡ªå·±çš„ç†è§£å¯¹æ–‡æ¡£è¿›è¡Œäº†ç¿»è¯‘å¹¶ä¸”ç®€å•å®ç°äº†RESPåŸºäºJavaè¯­è¨€çš„è§£æã€‚ç¼–å†™æœ¬æ–‡çš„ä½¿ç”¨ä½¿ç”¨çš„JDKç‰ˆæœ¬ä¸º[8+]ã€‚ RESPç®€ä»‹ Rediså®¢æˆ·ç«¯ä¸RedisæœåŠ¡ç«¯åŸºäºä¸€ä¸ªç§°ä½œRESPçš„åè®®è¿›è¡Œé€šä¿¡ï¼ŒRESPå…¨ç§°ä¸ºRedis Serialization Protocolï¼Œä¹Ÿå°±æ˜¯Redisåºåˆ—åŒ–åè®®ã€‚è™½ç„¶RESPä¸ºRedisè®¾è®¡ï¼Œä½†æ˜¯å®ƒä¹Ÿå¯ä»¥åº”ç”¨åœ¨å…¶ä»–å®¢æˆ·ç«¯-æœåŠ¡ç«¯ï¼ˆClient-Serverï¼‰çš„è½¯ä»¶é¡¹ç›®ä¸­ã€‚RESPåœ¨è®¾è®¡çš„æ—¶å€™æŠ˜ä¸­è€ƒè™‘äº†å¦‚ä¸‹å‡ ç‚¹ï¼š æ˜“äºå®ç°ã€‚ å¿«é€Ÿè§£æã€‚ å¯è¯»æ€§é«˜ã€‚ RESPå¯ä»¥åºåˆ—åŒ–ä¸åŒçš„æ•°æ®ç±»å‹ï¼Œå¦‚æ•´å‹ã€å­—ç¬¦ä¸²ã€æ•°ç»„è¿˜æœ‰ä¸€ç§ç‰¹æ®Šçš„Errorç±»å‹ã€‚éœ€è¦æ‰§è¡Œçš„Rediså‘½ä»¤ä¼šå°è£…ä¸ºç±»ä¼¼äºå­—ç¬¦ä¸²æ•°ç»„çš„è¯·æ±‚ç„¶åé€šè¿‡Rediså®¢æˆ·ç«¯å‘é€åˆ°RedisæœåŠ¡ç«¯ã€‚RedisæœåŠ¡ç«¯ä¼šåŸºäºç‰¹å®šçš„å‘½ä»¤ç±»å‹é€‰æ‹©å¯¹åº”çš„ä¸€ç§æ•°æ®ç±»å‹è¿›è¡Œå›å¤ï¼ˆè¿™ä¸€å¥æ˜¯æ„è¯‘ï¼ŒåŸæ–‡æ˜¯ï¼šRedis replies with a command-specific data typeï¼‰ã€‚ RESPæ˜¯äºŒè¿›åˆ¶å®‰å…¨çš„ï¼ˆbinary-safeï¼‰ï¼Œå¹¶ä¸”åœ¨RESPä¸‹ä¸éœ€è¦å¤„ç†ä»ä¸€ä¸ªè¿›ç¨‹ä¼ è¾“åˆ°å¦ä¸€ä¸ªè¿›ç¨‹çš„æ‰¹é‡æ•°æ®ï¼Œå› ä¸ºå®ƒä½¿ç”¨äº†å‰ç¼€é•¿åº¦ï¼ˆprefixed-lengthï¼Œåé¢ä¼šåˆ†æï¼Œå°±æ˜¯åœ¨æ¯ä¸ªæ•°æ®å—çš„å‰ç¼€å·²ç»å®šä¹‰å¥½æ•°æ®å—çš„ä¸ªæ•°ï¼Œç±»ä¼¼äºNettyé‡Œé¢çš„å®šé•¿ç¼–ç è§£ç ï¼‰æ¥ä¼ è¾“æ‰¹é‡æ•°æ®ã€‚ æ³¨æ„ï¼šæ­¤å¤„æ¦‚è¿°çš„åè®®ä»…ä»…ä½¿ç”¨åœ¨å®¢æˆ·ç«¯-æœåŠ¡ç«¯é€šä¿¡ï¼ŒRedis Clusterä½¿ç”¨ä¸åŒçš„äºŒè¿›åˆ¶åè®®åœ¨å¤šä¸ªèŠ‚ç‚¹ä¹‹é—´äº¤æ¢æ¶ˆæ¯ï¼ˆä¹Ÿå°±æ˜¯Redisé›†ç¾¤ä¸­çš„èŠ‚ç‚¹ä¹‹é—´å¹¶ä¸ä½¿ç”¨RESPé€šä¿¡ï¼‰ã€‚ ç½‘ç»œå±‚ Rediså®¢æˆ·ç«¯é€šè¿‡åˆ›å»ºä¸€ä¸ªåœ¨6379ç«¯å£çš„TCPè¿æ¥ï¼Œè¿æ¥åˆ°RedisæœåŠ¡ç«¯ã€‚ è™½ç„¶RESPåœ¨åº•å±‚é€šä¿¡åè®®æŠ€æœ¯ä¸Šæ˜¯éTCPç‰¹å®šçš„ï¼Œä½†åœ¨Redisçš„ä¸Šä¸‹æ–‡ä¸­ï¼ŒRESPä»…ç”¨äºTCPè¿æ¥ï¼ˆæˆ–ç±»ä¼¼çš„é¢å‘æµçš„è¿æ¥ï¼Œå¦‚Unixå¥—æ¥å­—ï¼‰ã€‚ è¯·æ±‚-å“åº”æ¨¡å‹ RedisæœåŠ¡ç«¯æ¥æ”¶ç”±ä¸åŒå‚æ•°ç»„æˆçš„å‘½ä»¤ï¼Œæ¥æ”¶åˆ°å‘½ä»¤å¹¶å°†å…¶å¤„ç†ä¹‹åä¼šæŠŠå›å¤å‘é€å›Rediså®¢æˆ·ç«¯ã€‚è¿™æ˜¯æœ€ç®€å•çš„æ¨¡å‹ï¼Œä½†æ˜¯æœ‰ä¸¤ç§ä¾‹å¤–çš„æƒ…å†µï¼š Redisæ”¯æŒç®¡é“ï¼ˆPipeliningï¼Œæµæ°´çº¿ï¼Œå¤šæ•°æƒ…å†µä¸‹ä¹ æƒ¯ç§°ä¸ºç®¡é“ï¼‰æ“ä½œã€‚ä½¿ç”¨ç®¡é“çš„æƒ…å†µä¸‹ï¼ŒRediså®¢æˆ·ç«¯å¯ä»¥ä¸€æ¬¡å‘é€å¤šä¸ªå‘½ä»¤ï¼Œç„¶åç­‰å¾…ä¸€æ¬¡æ€§çš„å›å¤ï¼ˆæ–‡ä¸­çš„å›å¤æ˜¯repliesï¼Œç†è§£ä¸ºRedisæœåŠ¡ç«¯ä¼šä¸€æ¬¡æ€§è¿”å›ä¸€ä¸ªæ‰¹é‡å›å¤ç»“æœï¼‰ã€‚ å½“Rediså®¢æˆ·ç«¯è®¢é˜…Pub/Subä¿¡é“æ—¶ï¼Œè¯¥åè®®ä¼šæ›´æ”¹è¯­ä¹‰å¹¶æˆä¸ºæ¨é€åè®®ï¼ˆpush protocolï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå®¢æˆ·ç«¯ä¸å†éœ€è¦å‘é€å‘½ä»¤ï¼Œå› ä¸ºRedisæœåŠ¡ç«¯å°†è‡ªåŠ¨å‘å®¢æˆ·ç«¯ï¼ˆè®¢é˜…äº†æ”¹ä¿¡é“çš„å®¢æˆ·ç«¯ï¼‰å‘é€æ–°æ¶ˆæ¯ï¼ˆè¿™é‡Œçš„æ„æ€æ˜¯ï¼šåœ¨è®¢é˜…/å‘å¸ƒæ¨¡å¼ä¸‹ï¼Œæ¶ˆæ¯æ˜¯ç”±RedisæœåŠ¡ç«¯ä¸»åŠ¨æ¨é€ç»™è®¢é˜…äº†ç‰¹å®šä¿¡é“çš„Rediså®¢æˆ·ç«¯ï¼‰ã€‚ é™¤äº†ä¸Šè¿°ä¸¤ä¸ªç‰¹ä¾‹ä¹‹å¤–ï¼ŒRedisåè®®æ˜¯ä¸€ç§ç®€å•çš„è¯·æ±‚-å“åº”åè®®ã€‚ RESPæ”¯æŒçš„æ•°æ®ç±»å‹ RESPåœ¨Redis 1.2ä¸­å¼•å…¥ï¼Œåœ¨Redis 2.0ï¼ŒRESPæ­£å¼æˆä¸ºä¸RedisæœåŠ¡ç«¯é€šä¿¡çš„æ ‡å‡†æ–¹æ¡ˆã€‚ä¹Ÿå°±æ˜¯å¦‚æœéœ€è¦ç¼–å†™Rediså®¢æˆ·ç«¯ï¼Œä½ å°±å¿…é¡»åœ¨å®¢æˆ·ç«¯ä¸­å®ç°æ­¤åè®®ã€‚ RESPæœ¬è´¨ä¸Šæ˜¯ä¸€ç§åºåˆ—åŒ–åè®®ï¼Œå®ƒæ”¯æŒçš„æ•°æ®ç±»å‹å¦‚ä¸‹ï¼šå•è¡Œå­—ç¬¦ä¸²ã€é”™è¯¯æ¶ˆæ¯ã€æ•´å‹æ•°å­—ã€å®šé•¿å­—ç¬¦ä¸²å’ŒRESPæ•°ç»„ã€‚ RESPåœ¨Redisä¸­ç”¨ä½œè¯·æ±‚-å“åº”åè®®çš„æ–¹å¼å¦‚ä¸‹ï¼š Rediså®¢æˆ·ç«¯å°†å‘½ä»¤å°è£…ä¸ºRESPçš„æ•°ç»„ç±»å‹ï¼ˆæ•°ç»„å…ƒç´ éƒ½æ˜¯å®šé•¿å­—ç¬¦ä¸²ç±»å‹ï¼Œæ³¨æ„è¿™ä¸€ç‚¹ï¼Œå¾ˆé‡è¦ï¼‰å‘é€åˆ°RedisæœåŠ¡å™¨ã€‚ RedisæœåŠ¡ç«¯æ ¹æ®å‘½ä»¤å®ç°é€‰æ‹©å¯¹åº”çš„RESPæ•°æ®ç±»å‹ä¹‹ä¸€è¿›è¡Œå›å¤ã€‚ åœ¨RESPä¸­ï¼Œæ•°æ®ç±»å‹å–å†³äºæ•°æ®æŠ¥çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼š å•è¡Œå­—ç¬¦ä¸²çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º+ã€‚ é”™è¯¯æ¶ˆæ¯çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º-ã€‚ æ•´å‹æ•°å­—çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º:ã€‚ å®šé•¿å­—ç¬¦ä¸²çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º$ã€‚ RESPæ•°ç»„çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º*ã€‚ å¦å¤–ï¼Œåœ¨RESPä¸­å¯ä»¥ä½¿ç”¨å®šé•¿å­—ç¬¦ä¸²æˆ–è€…æ•°ç»„çš„ç‰¹æ®Šå˜ä½“æ¥è¡¨ç¤ºNullå€¼ï¼Œåé¢ä¼šæåŠã€‚åœ¨RESPä¸­ï¼Œåè®®çš„ä¸åŒéƒ¨åˆ†å§‹ç»ˆä»¥\\r\\nï¼ˆCRLFï¼‰ç»ˆæ­¢ã€‚ ç›®å‰RESPä¸­5ç§æ•°æ®ç±»å‹çš„å°ç»“å¦‚ä¸‹ï¼š æ•°æ®ç±»å‹ æœ¬æ–‡ç¿»è¯‘åç§° åŸºæœ¬ç‰¹å¾ ä¾‹å­ Simple String å•è¡Œå­—ç¬¦ä¸² ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯+ï¼Œæœ€åä¸¤ä¸ªå­—èŠ‚æ˜¯\\r\\nï¼Œå…¶ä»–å­—èŠ‚æ˜¯å­—ç¬¦ä¸²å†…å®¹ +OK\\r\\n Error é”™è¯¯æ¶ˆæ¯ ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯-ï¼Œæœ€åä¸¤ä¸ªå­—èŠ‚æ˜¯\\r\\nï¼Œå…¶ä»–å­—èŠ‚æ˜¯å¼‚å¸¸æ¶ˆæ¯çš„æ–‡æœ¬å†…å®¹ -ERR\\r\\n Integer æ•´å‹æ•°å­— ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯:ï¼Œæœ€åä¸¤ä¸ªå­—èŠ‚æ˜¯\\r\\nï¼Œå…¶ä»–å­—èŠ‚æ˜¯æ•°å­—çš„æ–‡æœ¬å†…å®¹ :100\\r\\n Bulk String å®šé•¿å­—ç¬¦ä¸² ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯$ï¼Œç´§æ¥ç€çš„å­—èŠ‚æ˜¯å†…å®¹å­—ç¬¦ä¸²é•¿åº¦\\r\\nï¼Œæœ€åä¸¤ä¸ªå­—èŠ‚æ˜¯\\r\\nï¼Œå…¶ä»–å­—èŠ‚æ˜¯å­—ç¬¦ä¸²å†…å®¹ $4\\r\\ndoge\\r\\n Array RESPæ•°ç»„ ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯*ï¼Œç´§æ¥ç€çš„å­—èŠ‚æ˜¯å…ƒç´ ä¸ªæ•°\\r\\nï¼Œæœ€åä¸¤ä¸ªå­—èŠ‚æ˜¯\\r\\nï¼Œå…¶ä»–å­—èŠ‚æ˜¯å„ä¸ªå…ƒç´ çš„å†…å®¹ï¼Œæ¯ä¸ªå…ƒç´ å¯ä»¥æ˜¯ä»»æ„ä¸€ç§æ•°æ®ç±»å‹ *2\\r\\n:100\\r\\n$4\\r\\ndoge\\r\\n ä¸‹é¢çš„å°èŠ‚æ˜¯å¯¹æ¯ç§æ•°æ®ç±»å‹çš„æ›´ç»†è‡´çš„åˆ†æã€‚ RESPç®€å•å­—ç¬¦ä¸²-Simple String ç®€å•å­—ç¬¦ä¸²çš„ç¼–ç æ–¹å¼å¦‚ä¸‹ï¼š ï¼ˆ1ï¼‰ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º+ã€‚ ï¼ˆ2ï¼‰ç´§æ¥ç€çš„æ˜¯ä¸€ä¸ªä¸èƒ½åŒ…å«CRæˆ–è€…LFå­—ç¬¦çš„å­—ç¬¦ä¸²ã€‚ ï¼ˆ3ï¼‰ä»¥CRLFç»ˆæ­¢ã€‚ ç®€å•å­—ç¬¦ä¸²èƒ½å¤Ÿä¿è¯åœ¨æœ€å°å¼€é”€çš„å‰æä¸‹ä¼ è¾“éäºŒè¿›åˆ¶å®‰å…¨çš„å­—ç¬¦ä¸²ã€‚ä¾‹å¦‚å¾ˆå¤šRediså‘½ä»¤æ‰§è¡ŒæˆåŠŸåæœåŠ¡ç«¯éœ€è¦å›å¤OKå­—ç¬¦ä¸²ï¼Œæ­¤æ—¶é€šè¿‡ç®€å•å­—ç¬¦ä¸²ç¼–ç ä¸º5å­—èŠ‚çš„æ•°æ®æŠ¥å¦‚ä¸‹ï¼š 1+OK\\r\\n å¦‚æœéœ€è¦å‘é€äºŒè¿›åˆ¶å®‰å…¨çš„å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆéœ€è¦ä½¿ç”¨å®šé•¿å­—ç¬¦ä¸²ã€‚ å½“RedisæœåŠ¡ç«¯ç”¨ç®€å•å­—ç¬¦ä¸²å“åº”æ—¶ï¼ŒRediså®¢æˆ·ç«¯åº“åº”è¯¥å‘è°ƒç”¨è€…è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¯¥å“åº”åˆ°è°ƒç”¨è€…çš„å­—ç¬¦ä¸²ç”±+ä¹‹åç›´åˆ°å­—ç¬¦ä¸²å†…å®¹æœ«å°¾çš„å­—ç¬¦ç»„æˆï¼ˆå…¶å®å°±æ˜¯ä¸Šé¢æåˆ°çš„ç¬¬ï¼ˆ2ï¼‰éƒ¨åˆ†çš„å†…å®¹ï¼‰ï¼Œä¸åŒ…æ‹¬æœ€åçš„CRLFå­—èŠ‚ã€‚ RESPé”™è¯¯æ¶ˆæ¯-Error é”™è¯¯æ¶ˆæ¯ç±»å‹æ˜¯RESPç‰¹å®šçš„æ•°æ®ç±»å‹ã€‚å®é™…ä¸Šï¼Œé”™è¯¯æ¶ˆæ¯ç±»å‹å’Œç®€å•å­—ç¬¦ä¸²ç±»å‹åŸºæœ¬ä¸€è‡´ï¼Œåªæ˜¯å…¶ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º-ã€‚é”™è¯¯æ¶ˆæ¯ç±»å‹è·Ÿç®€å•å­—ç¬¦ä¸²ç±»å‹çš„æœ€å¤§åŒºåˆ«æ˜¯ï¼šé”™è¯¯æ¶ˆæ¯ä½œä¸ºRedisæœåŠ¡ç«¯å“åº”çš„æ—¶å€™ï¼Œå¯¹äºå®¢æˆ·ç«¯è€Œè¨€åº”è¯¥æ„ŸçŸ¥ä¸ºå¼‚å¸¸ï¼Œè€Œé”™è¯¯æ¶ˆæ¯ä¸­çš„å­—ç¬¦ä¸²å†…å®¹åº”è¯¥æ„ŸçŸ¥ä¸ºRedisæœåŠ¡ç«¯è¿”å›çš„é”™è¯¯ä¿¡æ¯ã€‚é”™è¯¯æ¶ˆæ¯çš„ç¼–ç æ–¹å¼å¦‚ä¸‹ï¼š ï¼ˆ1ï¼‰ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º-ã€‚ ï¼ˆ2ï¼‰ç´§æ¥ç€çš„æ˜¯ä¸€ä¸ªä¸èƒ½åŒ…å«CRæˆ–è€…LFå­—ç¬¦çš„å­—ç¬¦ä¸²ã€‚ ï¼ˆ3ï¼‰ä»¥CRLFç»ˆæ­¢ã€‚ ä¸€ä¸ªç®€å•çš„ä¾‹å­å¦‚ä¸‹ï¼š 1-Error message\\r\\n RedisæœåŠ¡ç«¯åªæœ‰åœ¨çœŸæ­£å‘ç”Ÿé”™è¯¯æˆ–è€…æ„ŸçŸ¥é”™è¯¯çš„æ—¶å€™æ‰ä¼šå›å¤é”™è¯¯æ¶ˆæ¯ï¼Œä¾‹å¦‚å°è¯•å¯¹é”™è¯¯çš„æ•°æ®ç±»å‹æ‰§è¡Œæ“ä½œæˆ–è€…å‘½ä»¤ä¸å­˜åœ¨ç­‰ç­‰ã€‚Rediså®¢æˆ·ç«¯æ¥æ”¶åˆ°é”™è¯¯æ¶ˆæ¯çš„æ—¶å€™ï¼Œåº”è¯¥è§¦å‘å¼‚å¸¸ï¼ˆä¸€èˆ¬æƒ…å†µå°±æ˜¯ç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œå¯ä»¥æ ¹æ®é”™è¯¯æ¶ˆæ¯çš„å†…å®¹è¿›è¡Œå¼‚å¸¸åˆ†ç±»ï¼‰ã€‚ä¸‹é¢æ˜¯é”™è¯¯æ¶ˆæ¯å“åº”çš„ä¸€äº›ä¾‹å­ï¼š 12-ERR unknown command 'foobar'-WRONGTYPE Operation against a key holding the wrong kind of value -ä¹‹åçš„ç¬¬ä¸€ä¸ªå•è¯åˆ°ç¬¬ä¸€ä¸ªç©ºæ ¼æˆ–æ¢è¡Œç¬¦ä¹‹é—´çš„å†…å®¹ï¼Œä»£è¡¨è¿”å›çš„é”™è¯¯ç±»å‹ã€‚è¿™åªæ˜¯Redisä½¿ç”¨çš„çº¦å®šï¼Œä¸æ˜¯RESPé”™è¯¯æ¶ˆæ¯æ ¼å¼çš„ä¸€éƒ¨åˆ†ã€‚ ä¾‹å¦‚ï¼ŒERRæ˜¯é€šç”¨é”™è¯¯ï¼ŒWRONGTYPEåˆ™æ˜¯æ›´å…·ä½“çš„é”™è¯¯ï¼Œè¡¨ç¤ºå®¢æˆ·ç«¯è¯•å›¾é’ˆå¯¹é”™è¯¯çš„æ•°æ®ç±»å‹æ‰§è¡Œæ“ä½œã€‚è¿™ç§å®šä¹‰æ–¹å¼ç§°ä¸ºé”™è¯¯å‰ç¼€ï¼Œæ˜¯ä¸€ç§ä½¿å®¢æˆ·ç«¯èƒ½å¤Ÿç†è§£æœåŠ¡å™¨è¿”å›çš„é”™è¯¯ç±»å‹çš„æ–¹æ³•ï¼Œè€Œä¸å¿…ä¾èµ–äºæ‰€ç»™å‡ºçš„ç¡®åˆ‡æ¶ˆæ¯å®šä¹‰ï¼Œè¯¥æ¶ˆæ¯å¯èƒ½ä¼šéšæ—¶é—´è€Œå˜åŒ–ã€‚ å®¢æˆ·ç«¯å®ç°å¯ä»¥é’ˆå¯¹ä¸åŒçš„é”™è¯¯ç±»å‹è¿”å›ä¸åŒç§ç±»çš„å¼‚å¸¸ï¼Œæˆ–è€…å¯ä»¥é€šè¿‡å°†é”™è¯¯ç±»å‹çš„åç§°ä½œä¸ºå­—ç¬¦ä¸²ç›´æ¥æä¾›ç»™è°ƒç”¨æ–¹æ¥æä¾›æ•è·é”™è¯¯çš„é€šç”¨æ–¹æ³•ã€‚ ä½†æ˜¯ï¼Œä¸åº”è¯¥å°†é”™è¯¯æ¶ˆæ¯åˆ†ç±»å¤„ç†çš„åŠŸèƒ½è§†ä¸ºè‡³å…³é‡è¦çš„åŠŸèƒ½ï¼Œå› ä¸ºå®ƒä½œç”¨å¹¶ä¸å·¨å¤§ï¼Œå¹¶ä¸”æœ‰äº›çš„å®¢æˆ·ç«¯å®ç°å¯èƒ½ä¼šç®€å•åœ°è¿”å›ç‰¹å®šå€¼å»å±è”½é”™è¯¯æ¶ˆæ¯ä½œä¸ºé€šç”¨çš„å¼‚å¸¸å¤„ç†ï¼Œä¾‹å¦‚ç›´æ¥è¿”å›falseã€‚ RESPæ•´å‹æ•°å­—-Integer æ•´å‹æ•°å­—çš„ç¼–ç æ–¹å¼å¦‚ä¸‹ï¼š ï¼ˆ1ï¼‰ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸ºï¼šã€‚ ï¼ˆ2ï¼‰ç´§æ¥ç€çš„æ˜¯ä¸€ä¸ªä¸èƒ½åŒ…å«CRæˆ–è€…LFå­—ç¬¦çš„å­—ç¬¦ä¸²ï¼Œä¹Ÿå°±æ˜¯æ•°å­—è¦å…ˆè½¬æ¢ä¸ºå­—ç¬¦åºåˆ—ï¼Œæœ€ç»ˆè¦è¾“å‡ºä¸ºå­—èŠ‚ã€‚ ï¼ˆ3ï¼‰ä»¥CRLFç»ˆæ­¢ã€‚ ä¾‹å¦‚ï¼š 12:0\\r\\n:1000\\r\\n è®¸å¤šRediså‘½ä»¤è¿”å›æ•´å‹æ•°å­—ï¼ŒåƒINCRï¼ŒLLENå’ŒLASTSAVEå‘½ä»¤ç­‰ç­‰ã€‚ è¿”å›çš„æ•´å‹æ•°å­—æ²¡æœ‰ç‰¹æ®Šçš„å«ä¹‰ï¼ŒåƒINCRè¿”å›çš„æ˜¯å¢é‡çš„æ€»é‡ï¼Œè€ŒLASTSAVEæ˜¯UNIXæ—¶é—´æˆ³ã€‚ä½†æ˜¯RedisæœåŠ¡ç«¯ä¿è¯è¿”å›çš„æ•´å‹æ•°å­—åœ¨å¸¦ç¬¦å·çš„64ä½æ•´æ•°èŒƒå›´å†…ã€‚ æœ‰äº›æƒ…å†µä¸‹ï¼Œè¿”å›çš„æ•´å‹æ•°å­—ä¼šæŒ‡ä»£trueæˆ–è€…falseã€‚å¦‚EXISTSæˆ–è€…SISMEMBERå‘½ä»¤æ‰§è¡Œè¿”å›1ä»£è¡¨trueï¼Œ0ä»£è¡¨falseã€‚ æœ‰äº›æƒ…å†µä¸‹ï¼Œè¿”å›çš„æ•´å‹æ•°å­—ä¼šæŒ‡ä»£å‘½ä»¤æ˜¯å¦çœŸæ­£äº§ç”Ÿäº†æ•ˆæœã€‚å¦‚SADDï¼ŒSREMå’ŒSETNXå‘½ä»¤æ‰§è¡Œè¿”å›1ä»£è¡¨å‘½ä»¤æ‰§è¡Œç”Ÿæ•ˆï¼Œ0ä»£è¡¨å‘½ä»¤æ‰§è¡Œä¸ç”Ÿæ•ˆï¼ˆç­‰ä»·äºå‘½ä»¤æ²¡æœ‰æ‰§è¡Œï¼‰ã€‚ ä¸‹é¢çš„ä¸€ç»„å‘½ä»¤æ‰§è¡Œåéƒ½æ˜¯è¿”å›æ•´å‹æ•°å­—ï¼šSETNX, DEL, EXISTS, INCR, INCRBY, DECR, DECRBY, DBSIZE, LASTSAVE, RENAMENX, MOVE, LLEN, SADD, SREM, SISMEMBER, SCARDã€‚ RESPå®šé•¿å­—ç¬¦ä¸²-Bulk String å®šé•¿å­—ç¬¦ä¸²ç”¨äºè¡¨ç¤ºä¸€ä¸ªæœ€å¤§é•¿åº¦ä¸º512MBçš„äºŒè¿›åˆ¶å®‰å…¨çš„å­—ç¬¦ä¸²ï¼ˆBulkï¼Œæœ¬èº«æœ‰ä½“ç§¯å¤§çš„å«ä¹‰ï¼‰ã€‚å®šé•¿å­—ç¬¦ä¸²çš„ç¼–ç æ–¹å¼å¦‚ä¸‹ï¼š ï¼ˆ1ï¼‰ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º$ã€‚ ï¼ˆ2ï¼‰ç´§æ¥ç€çš„æ˜¯ç»„æˆå­—ç¬¦ä¸²çš„å­—èŠ‚æ•°é•¿åº¦ï¼ˆç§°ä¸ºprefixed lengthï¼Œä¹Ÿå°±æ˜¯å‰ç¼€é•¿åº¦ï¼‰ï¼Œå‰ç¼€é•¿åº¦åˆ†å—ä»¥CRLFç»ˆæ­¢ã€‚ ï¼ˆ3ï¼‰ç„¶åæ˜¯ä¸€ä¸ªä¸èƒ½åŒ…å«CRæˆ–è€…LFå­—ç¬¦çš„å­—ç¬¦ä¸²ï¼Œä¹Ÿå°±æ˜¯æ•°å­—è¦å…ˆè½¬æ¢ä¸ºå­—ç¬¦åºåˆ—ï¼Œæœ€ç»ˆè¦è¾“å‡ºä¸ºå­—èŠ‚ã€‚ ï¼ˆ4ï¼‰ä»¥CRLFç»ˆæ­¢ã€‚ ä¸¾ä¸ªä¾‹å­ï¼Œdogeä½¿ç”¨å®šé•¿å­—ç¬¦ä¸²ç¼–ç å¦‚ä¸‹ï¼š ç¬¬ä¸€ä¸ªå­—èŠ‚ å‰ç¼€é•¿åº¦ CRLF å­—ç¬¦ä¸²å†…å®¹ CRLF å®šé•¿å­—ç¬¦ä¸² $ 4 \\r\\n doge \\r\\n ===&gt; $4\\r\\ndoge\\r\\n foobarä½¿ç”¨å®šé•¿å­—ç¬¦ä¸²ç¼–ç å¦‚ä¸‹ï¼š ç¬¬ä¸€ä¸ªå­—èŠ‚ å‰ç¼€é•¿åº¦ CRLF å­—ç¬¦ä¸²å†…å®¹ CRLF å®šé•¿å­—ç¬¦ä¸² $ 6 \\r\\n foobar \\r\\n ===&gt; $6\\r\\nfoobar\\r\\n è¡¨ç¤ºç©ºå­—ç¬¦ä¸²ï¼ˆEmpty Stringï¼Œå¯¹åº”Javaä¸­çš„&quot;&quot;ï¼‰ çš„æ—¶å€™ï¼Œä½¿ç”¨å®šé•¿å­—ç¬¦ä¸²ç¼–ç å¦‚ä¸‹ï¼š ç¬¬ä¸€ä¸ªå­—èŠ‚ å‰ç¼€é•¿åº¦ CRLF CRLF å®šé•¿å­—ç¬¦ä¸² $ 0 \\r\\n \\r\\n ===&gt; $0\\r\\n\\r\\n å®šé•¿å­—ç¬¦ä¸²ä¹Ÿå¯ä»¥ä½¿ç”¨ç‰¹æ®Šçš„æ ¼å¼æ¥è¡¨ç¤ºNullå€¼ï¼ŒæŒ‡ä»£å€¼ä¸å­˜åœ¨ã€‚åœ¨è¿™ç§ç‰¹æ®Šæ ¼å¼ä¸­ï¼Œå‰ç¼€é•¿åº¦ä¸º-1ï¼Œå¹¶ä¸”æ²¡æœ‰æ•°æ®ï¼Œå› æ­¤ä½¿ç”¨å®šé•¿å­—ç¬¦ä¸²å¯¹Nullå€¼è¿›è¡Œç¼–ç å¦‚ä¸‹ï¼š ç¬¬ä¸€ä¸ªå­—èŠ‚ å‰ç¼€é•¿åº¦ CRLF å®šé•¿å­—ç¬¦ä¸² $ -1 \\r\\n ===&gt; $-1\\r\\n å½“RedisæœåŠ¡ç«¯è¿”å›å®šé•¿å­—ç¬¦ä¸²ç¼–ç çš„Nullå€¼çš„æ—¶å€™ï¼Œå®¢æˆ·ç«¯ä¸åº”è¯¥è¿”å›ç©ºå­—ç¬¦ä¸²ï¼Œè€Œåº”è¯¥è¿”å›å¯¹åº”ç¼–ç¨‹è¯­è¨€ä¸­çš„Nullå¯¹è±¡ã€‚ä¾‹å¦‚Rubyä¸­å¯¹åº”nilï¼ŒCè¯­è¨€ä¸­å¯¹åº”NULLï¼ŒJavaä¸­å¯¹åº”nullï¼Œä»¥æ­¤ç±»æ¨ã€‚ RESPæ•°ç»„-Array Rediså®¢æˆ·ç«¯ä½¿ç”¨RESPæ•°ç»„å‘é€å‘½ä»¤åˆ°RedisæœåŠ¡ç«¯ã€‚ä¸æ­¤ç›¸ä¼¼ï¼ŒæŸäº›Rediså‘½ä»¤æ‰§è¡Œå®Œæ¯•åæœåŠ¡ç«¯éœ€è¦ä½¿ç”¨RESPæ•°ç»„ç±»å‹å°†å…ƒç´ é›†åˆè¿”å›ç»™å®¢æˆ·ç«¯ï¼Œå¦‚è¿”å›ä¸€ä¸ªå…ƒç´ åˆ—è¡¨çš„LRANGEå‘½ä»¤ã€‚RESPæ•°ç»„å’Œæˆ‘ä»¬è®¤çŸ¥ä¸­çš„æ•°ç»„å¹¶ä¸å®Œå…¨ä¸€è‡´ï¼Œå®ƒçš„ç¼–ç æ ¼å¼å¦‚ä¸‹ï¼š ï¼ˆ1ï¼‰ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º*ã€‚ ï¼ˆ2ï¼‰ç´§æ¥ç€çš„æ˜¯ç»„æˆRESPæ•°ç»„çš„å…ƒç´ ä¸ªæ•°ï¼ˆåè¿›åˆ¶æ•°ï¼Œä½†æ˜¯æœ€ç»ˆéœ€è¦è½¬æ¢ä¸ºå­—èŠ‚åºåˆ—ï¼Œå¦‚10éœ€è¦è½¬æ¢ä¸º1å’Œ0ä¸¤ä¸ªç›¸é‚»çš„å­—èŠ‚ï¼‰ï¼Œå…ƒç´ ä¸ªæ•°åˆ†å—ä»¥CRLFç»ˆæ­¢ã€‚ ï¼ˆ3ï¼‰RESPæ•°ç»„çš„æ¯ä¸ªå…ƒç´ å†…å®¹ï¼Œæ¯ä¸ªå…ƒç´ å¯ä»¥æ˜¯ä»»æ„çš„RESPæ•°æ®ç±»å‹ã€‚ ä¸€ä¸ªç©ºçš„RESPæ•°ç»„çš„ç¼–ç å¦‚ä¸‹ï¼š 1*0\\r\\n ä¸€ä¸ªåŒ…å«2ä¸ªå®šé•¿å­—ç¬¦ä¸²å…ƒç´ å†…å®¹åˆ†åˆ«ä¸ºfooå’Œbarçš„RESPæ•°ç»„çš„ç¼–ç å¦‚ä¸‹ï¼š 1*2\\r\\n$3\\r\\nfoo\\r\\n$3\\r\\nbar\\r\\n é€šç”¨æ ¼å¼å°±æ˜¯ï¼š*&lt;count&gt;CRLFä½œä¸ºRESPæ•°ç»„çš„å‰ç¼€éƒ¨åˆ†ï¼Œè€Œç»„æˆRESPæ•°ç»„çš„å…¶ä»–æ•°æ®ç±»å‹çš„å…ƒç´ åªæ˜¯ä¸€ä¸ªæ¥ä¸€ä¸ªåœ°ä¸²è”åœ¨ä¸€èµ·ã€‚ä¾‹å¦‚ä¸€ä¸ªåŒ…å«3ä¸ªæ•´æ•°ç±»å‹å…ƒç´ çš„RESPæ•°ç»„çš„ç¼–ç å¦‚ä¸‹ï¼š 1*3\\r\\n:1\\r\\n:2\\r\\n:3\\r\\n RESPæ•°ç»„çš„å…ƒç´ ä¸ä¸€å®šæ˜¯åŒä¸€ç§æ•°æ®ç±»å‹ï¼Œå¯ä»¥åŒ…å«æ··åˆç±»å‹çš„å…ƒç´ ã€‚ä¾‹å¦‚ä¸‹é¢æ˜¯ä¸€ä¸ªåŒ…å«4ä¸ªæ•´æ•°ç±»å‹å…ƒç´ å’Œ1ä¸ªå®šé•¿å­—ç¬¦ä¸²ç±»å‹å…ƒç´ ï¼ˆä¸€å…±æœ‰5ä¸ªå…ƒç´ ï¼‰çš„RESPæ•°ç»„çš„ç¼–ç ï¼ˆä¸ºäº†çœ‹å¾—æ›´æ¸…æ¥šï¼Œåˆ†å¤šè¡Œè¿›è¡Œç¼–ç ï¼Œå®é™…ä¸Šä¸èƒ½è¿™æ ·åšï¼‰ï¼š 12345678910111213# å…ƒç´ ä¸ªæ•°*5\\r\\n# ç¬¬1ä¸ªæ•´å‹ç±»å‹çš„å…ƒç´ :1\\r\\n# ç¬¬2ä¸ªæ•´å‹ç±»å‹çš„å…ƒç´ :2\\r\\n# ç¬¬3ä¸ªæ•´å‹ç±»å‹çš„å…ƒç´ :3\\r\\n# ç¬¬4ä¸ªæ•´å‹ç±»å‹çš„å…ƒç´ :4\\r\\n# å®šé•¿å­—ç¬¦ä¸²ç±»å‹çš„å…ƒç´ $6\\r\\nfoobar\\r\\n RedisæœåŠ¡ç«¯å“åº”æŠ¥çš„é¦–è¡Œ*5\\r\\nå®šä¹‰äº†åé¢ä¼šç´§è·Ÿç€5ä¸ªå›å¤æ•°æ®ï¼Œç„¶åæ¯ä¸ªå›å¤æ•°æ®åˆ†åˆ«ä½œå…ƒç´ é¡¹ï¼Œæ„æˆäº†ç”¨äºä¼ è¾“çš„å¤šå…ƒç´ å®šé•¿å›å¤ï¼ˆMulti Bulk Replyï¼Œæ„Ÿè§‰æ¯”è¾ƒéš¾ç¿»è¯‘ï¼Œè¿™é‡Œçš„å¤§æ¦‚æ„æ€å°±æ˜¯æ¯ä¸ªå›å¤è¡Œéƒ½æ˜¯æ•´ä¸ªå›å¤æŠ¥ä¸­çš„ä¸€ä¸ªé¡¹ï¼‰ã€‚ è¿™é‡Œå¯ä»¥ç±»æ¯”ä¸ºJavaä¸­çš„ArrayListï¼ˆæ³›å‹æ“¦é™¤ï¼‰ï¼Œæœ‰ç‚¹ç±»ä¼¼äºä¸‹é¢çš„ä¼ªä»£ç ï¼š 123456789101112131415161718192021222324252627List encode = new ArrayList();// æ·»åŠ å…ƒç´ ä¸ªæ•°encode.add(elementCount);encode.add(CRLF);// æ·»åŠ ç¬¬1ä¸ªæ•´å‹ç±»å‹çš„å…ƒç´  - 1encode.add(':');encode.add(1);encode.add(CRLF);// æ·»åŠ ç¬¬2ä¸ªæ•´å‹ç±»å‹çš„å…ƒç´  - 2encode.add(':');encode.add(2);encode.add(CRLF);// æ·»åŠ ç¬¬3ä¸ªæ•´å‹ç±»å‹çš„å…ƒç´  - 3encode.add(':');encode.add(3);encode.add(CRLF);// æ·»åŠ ç¬¬4ä¸ªæ•´å‹ç±»å‹çš„å…ƒç´  - 4encode.add(':');encode.add(4);encode.add(CRLF);// æ·»åŠ å®šé•¿å­—ç¬¦ä¸²ç±»å‹çš„å…ƒç´ encode.add('$');// å‰ç¼€é•¿åº¦encode.add(6);// å­—ç¬¦ä¸²å†…å®¹encode.add(\"foobar\");encode.add(CRLF); RESPæ•°ç»„ä¸­ä¹Ÿå­˜åœ¨Nullå€¼çš„æ¦‚å¿µï¼Œä¸‹é¢ç§°ä¸ºRESP Null Arrayã€‚å¤„äºå†å²åŸå› ï¼ŒRESPæ•°ç»„ä¸­é‡‡ç”¨äº†å¦ä¸€ç§ç‰¹æ®Šçš„ç¼–ç æ ¼å¼å®šä¹‰Nullå€¼ï¼ŒåŒºåˆ«äºå®šé•¿å­—ç¬¦ä¸²ä¸­çš„Nullå€¼å­—ç¬¦ä¸²ã€‚ä¾‹å¦‚ï¼ŒBLPOPå‘½ä»¤æ‰§è¡Œè¶…æ—¶çš„æ—¶å€™ï¼Œå°±ä¼šè¿”å›ä¸€ä¸ªRESP Null Arrayç±»å‹çš„å“åº”ã€‚RESP Null Arrayçš„ç¼–ç å¦‚ä¸‹ï¼š 1*-1\\r\\n å½“RedisæœåŠ¡ç«¯çš„å›å¤æ˜¯RESP Null Arrayç±»å‹çš„æ—¶å€™ï¼Œå®¢æˆ·ç«¯åº”è¯¥è¿”å›ä¸€ä¸ªNullå¯¹è±¡ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªç©ºæ•°ç»„æˆ–è€…ç©ºåˆ—è¡¨ã€‚è¿™ä¸€ç‚¹æ¯”è¾ƒé‡è¦ï¼Œå®ƒæ˜¯åŒºåˆ†å›å¤æ˜¯ç©ºæ•°ç»„ï¼ˆä¹Ÿå°±æ˜¯å‘½ä»¤æ­£ç¡®æ‰§è¡Œå®Œæ¯•ï¼Œè¿”å›ç»“æœæ­£å¸¸ï¼‰æˆ–è€…å…¶ä»–åŸå› ï¼ˆå¦‚BLPOPå‘½ä»¤çš„è¶…æ—¶ç­‰ï¼‰çš„å…³é”®ã€‚ RESPæ•°ç»„çš„å…ƒç´ ä¹Ÿå¯ä»¥æ˜¯RESPæ•°ç»„ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªåŒ…å«2ä¸ªRESPæ•°ç»„ç±»å‹çš„å…ƒç´ çš„RESPæ•°ç»„ï¼Œç¼–ç å¦‚ä¸‹ï¼ˆä¸ºäº†çœ‹å¾—æ›´æ¸…æ¥šï¼Œåˆ†å¤šè¡Œè¿›è¡Œç¼–ç ï¼Œå®é™…ä¸Šä¸èƒ½è¿™æ ·åšï¼‰ï¼š 1234567891011# å…ƒç´ ä¸ªæ•°*2\\r\\n# ç¬¬1ä¸ªRESPæ•°ç»„å…ƒç´ *3\\r\\n:1\\r\\n:2\\r\\n:3\\r\\n# ç¬¬2ä¸ªRESPæ•°ç»„å…ƒç´ *2\\r\\n+Foo\\r\\n-Bar\\r\\n ä¸Šé¢çš„RESPæ•°ç»„çš„åŒ…å«2ä¸ªRESPæ•°ç»„ç±»å‹çš„å…ƒç´ ï¼Œç¬¬1ä¸ªRESPæ•°ç»„å…ƒç´ åŒ…å«3ä¸ªæ•´å‹ç±»å‹çš„å…ƒç´ ï¼Œè€Œç¬¬2ä¸ªRESPæ•°ç»„å…ƒç´ åŒ…å«1ä¸ªç®€å•å­—ç¬¦ä¸²ç±»å‹çš„å…ƒç´ å’Œ1ä¸ªé”™è¯¯æ¶ˆæ¯ç±»å‹çš„å…ƒç´ ã€‚ RESPæ•°ç»„ä¸­çš„Nullå…ƒç´  RESPæ•°ç»„ä¸­çš„å•ä¸ªå…ƒç´ ä¹Ÿæœ‰Nullå€¼çš„æ¦‚å¿µï¼Œä¸‹é¢ç§°ä¸ºNullå…ƒç´ ã€‚RedisæœåŠ¡ç«¯å›å¤å¦‚æœæ˜¯RESPæ•°ç»„ç±»å‹ï¼Œå¹¶ä¸”RESPæ•°ç»„ä¸­å­˜åœ¨Nullå…ƒç´ ï¼Œé‚£ä¹ˆæ„å‘³ç€å…ƒç´ ä¸¢å¤±ï¼Œç»å¯¹ä¸èƒ½ç”¨ç©ºå­—ç¬¦ä¸²æ›¿ä»£ã€‚ç¼ºå°‘æŒ‡å®šé”®çš„å‰æä¸‹ï¼Œå½“ä¸GETæ¨¡å¼é€‰é¡¹ä¸€èµ·ä½¿ç”¨æ—¶ï¼ŒSORTå‘½ä»¤å¯èƒ½ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µã€‚ ä¸‹é¢æ˜¯ä¸€ä¸ªåŒ…å«Nullå…ƒç´ çš„RESPæ•°ç»„çš„ä¾‹å­ï¼ˆä¸ºäº†çœ‹å¾—æ›´æ¸…æ¥šï¼Œåˆ†å¤šè¡Œè¿›è¡Œç¼–ç ï¼Œå®é™…ä¸Šä¸èƒ½è¿™æ ·åšï¼‰ï¼š 123456*3\\r\\n$3\\r\\nfoo\\r\\n$-1\\r\\n$3\\r\\nbar\\r\\n RESPæ•°ç»„ä¸­çš„ç¬¬2ä¸ªå…ƒç´ æ˜¯Nullå…ƒç´ ï¼Œå®¢æˆ·ç«¯APIæœ€ç»ˆè¿”å›çš„å†…å®¹åº”è¯¥æ˜¯ï¼š 1234# Ruby[\"foo\",nil,\"bar\"]# Java[\"foo\",null,\"bar\"] RESPå…¶ä»–ç›¸å…³å†…å®¹ ä¸»è¦åŒ…æ‹¬ï¼š å°†å‘½ä»¤å‘é€åˆ°RedisæœåŠ¡ç«¯çš„ç¤ºä¾‹ã€‚ æ‰¹é‡å‘½ä»¤ä¸ç®¡é“ã€‚ å†…è”å‘½ä»¤ï¼ˆInline Commandsï¼‰ã€‚ å…¶å®æ–‡æ¡£ä¸­è¿˜æœ‰ä¸€èŠ‚ä½¿ç”¨Cè¯­è¨€ç¼–å†™é«˜æ€§èƒ½RESPè§£æå™¨ï¼Œè¿™é‡Œä¸åšç¿»è¯‘ï¼Œå› ä¸ºæŒæ¡RESPçš„ç›¸å…³å†…å®¹åï¼Œå¯ä»¥åŸºäºä»»ä½•è¯­è¨€ç¼–å†™è§£æå™¨ã€‚ å°†å‘½ä»¤å‘é€åˆ°RedisæœåŠ¡ç«¯ å¦‚æœå·²ç»ç›¸å¯¹ç†Ÿæ‚‰RESPä¸­çš„åºåˆ—åŒ–æ ¼å¼ï¼Œé‚£ä¹ˆç¼–å†™Rediså®¢æˆ·ç«¯ç±»åº“å°±ä¼šå˜å¾—å¾ˆå®¹æ˜“ã€‚æˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥æŒ‡å®šå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„äº¤äº’æ–¹å¼ï¼š Rediså®¢æˆ·ç«¯å‘RedisæœåŠ¡ç«¯å‘é€ä»…ä»…åŒ…å«å®šé•¿å­—ç¬¦ä¸²ç±»å‹å…ƒç´ çš„RESPæ•°ç»„ã€‚ RedisæœåŠ¡ç«¯å¯ä»¥é‡‡ç”¨ä»»æ„ä¸€ç§RESPæ•°æ®ç±»å‹å‘Rediså®¢æˆ·ç«¯è¿›è¡Œå›å¤ï¼Œå…·ä½“çš„æ•°æ®ç±»å‹ä¸€èˆ¬å–å†³äºå‘½ä»¤ç±»å‹ã€‚ ä¸‹é¢æ˜¯å…¸å‹çš„äº¤äº’ä¾‹å­ï¼šRediså®¢æˆ·ç«¯å‘é€å‘½ä»¤LLEN mylistä»¥è·å¾—KEYä¸ºmylistçš„é•¿åº¦ï¼ŒRedisæœåŠ¡ç«¯å°†ä»¥æ•´æ•°ç±»å‹è¿›è¡Œå›å¤ï¼Œå¦‚ä»¥ä¸‹ç¤ºä¾‹æ‰€ç¤ºï¼ˆCæ˜¯å®¢æˆ·ç«¯ï¼ŒSæœåŠ¡å™¨ï¼‰ï¼Œä¼ªä»£ç å¦‚ä¸‹ï¼š 1234567C: *2\\r\\nC: $4\\r\\nC: LLEN\\r\\nC: $6\\r\\nC: mylist\\r\\nS: :48293\\r\\n ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬ä½¿ç”¨æ¢è¡Œç¬¦æ¥åˆ†éš”åè®®çš„ä¸åŒéƒ¨åˆ†ï¼ˆè¿™é‡ŒæŒ‡ä¸Šé¢çš„ä»£ç åˆ†è¡Œå±•ç¤ºï¼‰ï¼Œä½†æ˜¯å®é™…äº¤äº’çš„æ—¶å€™Rediså®¢æˆ·ç«¯åœ¨å‘é€*2\\r\\n$4\\r\\nLLEN\\r\\n$6\\r\\nmylist\\r\\nçš„æ—¶å€™æ˜¯æ•´ä½“å‘é€çš„ã€‚ æ‰¹é‡å‘½ä»¤ä¸ç®¡é“ Rediså®¢æˆ·ç«¯å¯ä»¥ä½¿ç”¨ç›¸åŒçš„è¿æ¥å‘é€æ‰¹é‡å‘½ä»¤ã€‚Redisæ”¯æŒç®¡é“ç‰¹æ€§ï¼Œå› æ­¤Rediså®¢æˆ·ç«¯å¯ä»¥é€šè¿‡ä¸€æ¬¡å†™æ“ä½œå‘é€å¤šä¸ªå‘½ä»¤ï¼Œè€Œæ— éœ€åœ¨å‘é€ä¸‹ä¸€ä¸ªå‘½ä»¤ä¹‹å‰è¯»å–RedisæœåŠ¡ç«¯å¯¹ä¸Šä¸€ä¸ªå‘½ä»¤çš„å›å¤ã€‚æ‰¹é‡å‘é€å‘½ä»¤ä¹‹åï¼Œæ‰€æœ‰çš„å›å¤å¯ä»¥åœ¨æœ€åå¾—åˆ°ï¼ˆåˆå¹¶ä¸ºä¸€ä¸ªå›å¤ï¼‰ã€‚æ›´å¤šç›¸å…³ä¿¡æ¯å¯ä»¥æŸ¥çœ‹Using pipelining to speedup Redis queriesã€‚ å†…è”å‘½ä»¤ æœ‰äº›åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬å¯èƒ½åªæœ‰telnetå‘½ä»¤å¯ä»¥ä½¿ç”¨ï¼Œåœ¨è¿™ç§æ¡ä»¶ä¸‹ï¼Œæˆ‘ä»¬éœ€è¦å‘é€å‘½ä»¤åˆ°RedisæœåŠ¡ç«¯ã€‚å°½ç®¡Redisåè®®æ˜“äºå®ç°ï¼Œä½†åœ¨äº¤äº’å¼ä¼šè¯ä¸­å¹¶ä¸ç†æƒ³ï¼Œå¹¶ä¸”redis-cliæœ‰äº›æƒ…å†µä¸‹ä¸ä¸€å®šå¯ç”¨ã€‚å¤„äºè¿™ç±»åŸå› ï¼ŒRedisè®¾è®¡äº†ä¸€ç§ä¸“ä¸ºäººç±»è®¾è®¡çš„å‘½ä»¤æ ¼å¼ï¼Œç§°ä¸ºå†…è”å‘½ä»¤ï¼ˆInline Commandæ ¼å¼ã€‚ ä»¥ä¸‹æ˜¯æœåŠ¡å™¨/å®¢æˆ·ç«¯ä½¿ç”¨å†…è”å‘½ä»¤è¿›è¡ŒèŠå¤©çš„ç¤ºä¾‹ï¼ˆSä»£è¡¨æœåŠ¡ç«¯ï¼ŒCä»£è¡¨å®¢æˆ·ç«¯ï¼‰ï¼š 12C: PINGS: +PONG ä»¥ä¸‹æ˜¯ä½¿ç”¨å†…è”å‘½ä»¤è¿”å›æ•´æ•°çš„å¦ä¸€ä¸ªç¤ºä¾‹ï¼š 12C: EXISTS somekeyS: :0 åŸºæœ¬ä¸Šåªéœ€åœ¨telnetä¼šè¯ä¸­ç¼–å†™ä»¥ç©ºæ ¼åˆ†éš”çš„å‚æ•°ã€‚ç”±äºé™¤äº†ç»Ÿä¸€çš„è¯·æ±‚åè®®ä¹‹å¤–æ²¡æœ‰å‘½ä»¤ä¼šä»¥*å¼€å¤´ï¼ŒRedisèƒ½å¤Ÿæ£€æµ‹åˆ°è¿™ç§æƒ…å†µå¹¶è§£æè¾“å…¥çš„å‘½ä»¤ã€‚ åŸºäºRESPç¼–å†™é«˜æ€§èƒ½è§£æå™¨ å› ä¸ºJDKåŸç”Ÿæä¾›çš„å­—èŠ‚ç¼“å†²åŒºjava.nio.ByteBufferå­˜åœ¨ä¸èƒ½è‡ªåŠ¨æ‰©å®¹ã€éœ€è¦åˆ‡æ¢è¯»å†™æ¨¡å¼ç­‰ç­‰é—®é¢˜ï¼Œè¿™é‡Œç›´æ¥å¼•å…¥Nettyå¹¶ä¸”ä½¿ç”¨Nettyæä¾›çš„ByteBufè¿›è¡ŒRESPæ•°æ®ç±»å‹è§£æã€‚ç¼–å†™æœ¬æ–‡çš„æ—¶å€™ï¼ˆ2019-10-09ï¼‰Nettyçš„æœ€æ–°ç‰ˆæœ¬ä¸º4.1.42.Finalã€‚å¼•å…¥ä¾èµ–ï¼š 12345&lt;dependency&gt; &lt;groupId&gt;io.netty&lt;/groupId&gt; &lt;artifactId&gt;netty-buffer&lt;/artifactId&gt; &lt;version&gt;4.1.42.Final&lt;/version&gt;&lt;/dependency&gt; å®šä¹‰è§£ç å™¨æ¥å£ï¼š 1234public interface RespDecoder&lt;V&gt;&#123; V decode(ByteBuf buffer);&#125; å®šä¹‰å¸¸é‡ï¼š 12345678910111213141516171819202122232425262728293031public class RespConstants &#123; public static final Charset ASCII = StandardCharsets.US_ASCII; public static final Charset UTF_8 = StandardCharsets.UTF_8; public static final byte DOLLAR_BYTE = '$'; public static final byte ASTERISK_BYTE = '*'; public static final byte PLUS_BYTE = '+'; public static final byte MINUS_BYTE = '-'; public static final byte COLON_BYTE = ':'; public static final String EMPTY_STRING = \"\"; public static final Long ZERO = 0L; public static final Long NEGATIVE_ONE = -1L; public static final byte CR = (byte) '\\r'; public static final byte LF = (byte) '\\n'; public static final byte[] CRLF = \"\\r\\n\".getBytes(ASCII); public enum ReplyType &#123; SIMPLE_STRING, ERROR, INTEGER, BULK_STRING, RESP_ARRAY &#125;&#125; ä¸‹é¢çš„ç« èŠ‚ä¸­è§£ææ¨¡å—çš„å®ç°å·²ç»å¿½ç•¥ç¬¬ä¸€ä¸ªå­—èŠ‚çš„è§£æï¼Œå› ä¸ºç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯å†³å®šå…·ä½“çš„æ•°æ®ç±»å‹ã€‚ è§£æç®€å•å­—ç¬¦ä¸² ç®€å•å­—ç¬¦ä¸²ç±»å‹å°±æ˜¯å•è¡Œå­—ç¬¦ä¸²ï¼Œå®ƒçš„è§£æç»“æœå¯¹åº”çš„å°±æ˜¯Javaä¸­çš„Stringç±»å‹ã€‚è§£ç å™¨å®ç°å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132333435363738// è§£æå•è¡Œå­—ç¬¦ä¸²public class LineStringDecoder implements RespDecoder&lt;String&gt; &#123; @Override public String decode(ByteBuf buffer) &#123; return CodecUtils.X.readLine(buffer); &#125;&#125;public enum CodecUtils &#123; X; public int findLineEndIndex(ByteBuf buffer) &#123; int index = buffer.forEachByte(ByteProcessor.FIND_LF); return (index &gt; 0 &amp;&amp; buffer.getByte(index - 1) == '\\r') ? index : -1; &#125; public String readLine(ByteBuf buffer) &#123; int lineEndIndex = findLineEndIndex(buffer); if (lineEndIndex &gt; -1) &#123; int lineStartIndex = buffer.readerIndex(); // è®¡ç®—å­—èŠ‚é•¿åº¦ int size = lineEndIndex - lineStartIndex - 1; byte[] bytes = new byte[size]; buffer.readBytes(bytes); // é‡ç½®è¯»æ¸¸æ ‡ä¸º\\r\\nä¹‹åçš„ç¬¬ä¸€ä¸ªå­—èŠ‚ buffer.readerIndex(lineEndIndex + 1); buffer.markReaderIndex(); return new String(bytes, RespConstants.UTF_8); &#125; return null; &#125;&#125;public class RespSimpleStringDecoder extends LineStringDecoder &#123; &#125; è¿™é‡ŒæŠ½å–å‡ºä¸€ä¸ªç±»LineStringDecoderç”¨äºè§£æå•è¡Œå­—ç¬¦ä¸²ï¼Œè¿™æ ·åœ¨è§£æé”™è¯¯æ¶ˆæ¯çš„æ—¶å€™å¯ä»¥åšä¸€æ¬¡ç»§æ‰¿å³å¯ã€‚æµ‹è¯•ä¸€ä¸‹ï¼š 123456789public static void main(String[] args) throws Exception &#123; ByteBuf buffer = ByteBufAllocator.DEFAULT.buffer(); // +OK\\r\\n buffer.writeBytes(\"+OK\".getBytes(RespConstants.UTF_8)); buffer.writeBytes(RespConstants.CRLF); String value = RespCodec.X.decode(buffer); log.info(\"Decode result:&#123;&#125;\", value);&#125;// Decode result:OK è§£æé”™è¯¯æ¶ˆæ¯ é”™è¯¯æ¶ˆæ¯çš„æœ¬è´¨ä¹Ÿæ˜¯å•è¡Œå­—ç¬¦ä¸²ï¼Œæ‰€ä»¥å…¶è§£ç çš„å®ç°å¯ä»¥å’Œç®€å•å­—ç¬¦ä¸²çš„è§£ç å®ç°ä¸€è‡´ã€‚é”™è¯¯æ¶ˆæ¯æ•°æ®ç±»å‹çš„è§£ç å™¨å¦‚ä¸‹ï¼š 123public class RespErrorDecoder extends LineStringDecoder &#123;&#125; æµ‹è¯•ä¸€ä¸‹ï¼š 123456789public static void main(String[] args) throws Exception &#123; ByteBuf buffer = ByteBufAllocator.DEFAULT.buffer(); // -ERR unknown command 'foobar'\\r\\n buffer.writeBytes(\"-ERR unknown command 'foobar'\".getBytes(RespConstants.UTF_8)); buffer.writeBytes(RespConstants.CRLF); String value = RespCodec.X.decode(buffer); log.info(\"Decode result:&#123;&#125;\", value);&#125;// Decode result:ERR unknown command 'foobar' è§£ææ•´å‹æ•°å­— æ•´å‹æ•°å­—ç±»å‹ï¼Œæœ¬è´¨å°±æ˜¯éœ€è¦ä»å­—èŠ‚åºåˆ—ä¸­è¿˜åŸå‡ºå¸¦ç¬¦å·çš„64bitçš„é•¿æ•´å‹ï¼Œå› ä¸ºæ˜¯å¸¦ç¬¦å·çš„ï¼Œç±»å‹æ ‡è¯†ä½:åçš„ç¬¬ä¸€ä¸ªå­—èŠ‚éœ€è¦åˆ¤æ–­æ˜¯å¦è´Ÿæ•°å­—ç¬¦-ï¼Œå› ä¸ºæ˜¯ä»å·¦å‘å³è§£æï¼Œç„¶åæ¯è§£æå‡ºä¸€ä¸ªæ–°çš„ä½ï¼Œå½“å‰çš„æ•°å­—å€¼è¦ä¹˜10ã€‚å…¶è§£ç å™¨çš„å®ç°å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233public class RespIntegerDecoder implements RespDecoder&lt;Long&gt; &#123; @Override public Long decode(ByteBuf buffer) &#123; int lineEndIndex = CodecUtils.X.findLineEndIndex(buffer); // æ²¡æœ‰è¡Œå°¾ï¼Œå¼‚å¸¸ if (-1 == lineEndIndex) &#123; return null; &#125; long result = 0L; int lineStartIndex = buffer.readerIndex(); boolean negative = false; byte firstByte = buffer.getByte(lineStartIndex); // è´Ÿæ•° if (RespConstants.MINUS_BYTE == firstByte) &#123; negative = true; &#125; else &#123; int digit = firstByte - '0'; result = result * 10 + digit; &#125; for (int i = lineStartIndex + 1; i &lt; (lineEndIndex - 1); i++) &#123; byte value = buffer.getByte(i); int digit = value - '0'; result = result * 10 + digit; &#125; if (negative) &#123; result = -result; &#125; // é‡ç½®è¯»æ¸¸æ ‡ä¸º\\r\\nä¹‹åçš„ç¬¬ä¸€ä¸ªå­—èŠ‚ buffer.readerIndex(lineEndIndex + 1); return result; &#125;&#125; æ•´å‹æ•°å­—ç±»å‹çš„è§£æç›¸å¯¹å¤æ‚ï¼Œä¸€å®šè¦æ³¨æ„è´Ÿæ•°åˆ¤æ–­ã€‚æµ‹è¯•ä¸€ä¸‹ï¼š 123456789public static void main(String[] args) throws Exception &#123; ByteBuf buffer = ByteBufAllocator.DEFAULT.buffer(); // :-1000\\r\\n buffer.writeBytes(\":-1000\".getBytes(RespConstants.UTF_8)); buffer.writeBytes(RespConstants.CRLF); Long value = RespCodec.X.decode(buffer); log.info(\"Decode result:&#123;&#125;\", value);&#125;// Decode result:-1000 è§£æå®šé•¿å­—ç¬¦ä¸² å®šé•¿å­—ç¬¦ä¸²ç±»å‹è§£æçš„å…³é”®æ˜¯å…ˆè¯»å–ç±»å‹æ ‡è¯†ç¬¦$åçš„ç¬¬ä¸€ä¸ªå­—èŠ‚åºåˆ—åˆ†å—è§£ææˆ64bitå¸¦ç¬¦å·çš„æ•´æ•°ï¼Œç”¨æ¥ç¡®å®šåé¢éœ€è¦è§£æçš„å­—ç¬¦ä¸²å†…å®¹çš„å­—èŠ‚é•¿åº¦ï¼Œç„¶åå†æŒ‰ç…§è¯¥é•¿åº¦è¯»å–åé¢çš„å­—èŠ‚ã€‚å…¶è§£ç å™¨å®ç°å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233public class RespBulkStringDecoder implements RespDecoder&lt;String&gt; &#123; @Override public String decode(ByteBuf buffer) &#123; int lineEndIndex = CodecUtils.X.findLineEndIndex(buffer); if (-1 == lineEndIndex) &#123; return null; &#125; // ä½¿ç”¨RespIntegerDecoderè¯»å–é•¿åº¦ Long length = (Long) DefaultRespCodec.DECODERS.get(ReplyType.INTEGER).decode(buffer); if (null == length) &#123; return null; &#125; // Bulk Null String if (RespConstants.NEGATIVE_ONE.equals(length)) &#123; return null; &#125; // Bulk Empty String if (RespConstants.ZERO.equals(length)) &#123; return RespConstants.EMPTY_STRING; &#125; // çœŸå®å­—èŠ‚å†…å®¹çš„é•¿åº¦ int readLength = (int) length.longValue(); if (buffer.readableBytes() &gt; readLength) &#123; byte[] bytes = new byte[readLength]; buffer.readBytes(bytes); // é‡ç½®è¯»æ¸¸æ ‡ä¸º\\r\\nä¹‹åçš„ç¬¬ä¸€ä¸ªå­—èŠ‚ buffer.readerIndex(buffer.readerIndex() + 2); return new String(bytes, RespConstants.UTF_8); &#125; return null; &#125;&#125; æµ‹è¯•ä¸€ä¸‹ï¼š 123456789101112public static void main(String[] args) throws Exception&#123; ByteBuf buffer = ByteBufAllocator.DEFAULT.buffer(); // $6\\r\\nthrowable\\r\\n buffer = ByteBufAllocator.DEFAULT.buffer(); buffer.writeBytes(\"$9\".getBytes(RespConstants.UTF_8)); buffer.writeBytes(RespConstants.CRLF); buffer.writeBytes(\"throwable\".getBytes(RespConstants.UTF_8)); buffer.writeBytes(RespConstants.CRLF); String value = RespCodec.X.decode(buffer); log.info(\"Decode result:&#123;&#125;\", value);&#125;// Decode result:throwable è§£æRESPæ•°ç»„ RESPæ•°ç»„ç±»å‹è§£æçš„å…³é”®ï¼š å…ˆè¯»å–ç±»å‹æ ‡è¯†ç¬¦*åçš„ç¬¬ä¸€ä¸ªå­—èŠ‚åºåˆ—åˆ†å—è§£ææˆ64bitå¸¦ç¬¦å·çš„æ•´æ•°ï¼Œç¡®å®šæ•°ç»„ä¸­çš„å…ƒç´ ä¸ªæ•°ã€‚ é€’å½’è§£ææ¯ä¸ªå…ƒç´ ã€‚ å‚è€ƒè¿‡ä¸å°‘Redisåè®®è§£ææ¡†æ¶ï¼Œä¸å°‘æ˜¯ç”¨æ ˆæˆ–è€…çŠ¶æ€æœºå®ç°ï¼Œè¿™é‡Œå…ˆç®€å•ç‚¹ç”¨é€’å½’å®ç°ï¼Œè§£ç å™¨ä»£ç å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829public class RespArrayDecoder implements RespDecoder &#123; @Override public Object decode(ByteBuf buffer) &#123; int lineEndIndex = CodecUtils.X.findLineEndIndex(buffer); if (-1 == lineEndIndex) &#123; return null; &#125; // è§£æå…ƒç´ ä¸ªæ•° Long length = (Long) DefaultRespCodec.DECODERS.get(ReplyType.INTEGER).decode(buffer); if (null == length) &#123; return null; &#125; // Null Array if (RespConstants.NEGATIVE_ONE.equals(length)) &#123; return null; &#125; // Array Empty List if (RespConstants.ZERO.equals(length)) &#123; return Lists.newArrayList(); &#125; List&lt;Object&gt; result = Lists.newArrayListWithCapacity((int) length.longValue()); // é€’å½’ for (int i = 0; i &lt; length; i++) &#123; result.add(DefaultRespCodec.X.decode(buffer)); &#125; return result; &#125;&#125; æµ‹è¯•ä¸€ä¸‹ï¼š 123456789101112131415161718public static void main(String[] args) throws Exception &#123; ByteBuf buffer = ByteBufAllocator.DEFAULT.buffer(); //*2\\r\\n$3\\r\\nfoo\\r\\n$3\\r\\nbar\\r\\n buffer = ByteBufAllocator.DEFAULT.buffer(); buffer.writeBytes(\"*2\".getBytes(RespConstants.UTF_8)); buffer.writeBytes(RespConstants.CRLF); buffer.writeBytes(\"$3\".getBytes(RespConstants.UTF_8)); buffer.writeBytes(RespConstants.CRLF); buffer.writeBytes(\"foo\".getBytes(RespConstants.UTF_8)); buffer.writeBytes(RespConstants.CRLF); buffer.writeBytes(\"$3\".getBytes(RespConstants.UTF_8)); buffer.writeBytes(RespConstants.CRLF); buffer.writeBytes(\"bar\".getBytes(RespConstants.UTF_8)); buffer.writeBytes(RespConstants.CRLF); List value = RespCodec.X.decode(buffer); log.info(\"Decode result:&#123;&#125;\", value);&#125;// Decode result:[foo, bar] å°ç»“ å¯¹RESPçš„å†…å®¹å’Œå…¶ç¼–ç è§£ç çš„è¿‡ç¨‹æœ‰ç›¸å¯¹æ·±åˆ»çš„è®¤è¯†åï¼Œå°±å¯ä»¥åŸºäºNettyç¼–å†™RedisæœåŠ¡çš„ç¼–ç è§£ç æ¨¡å—ï¼Œä½œä¸ºNettyå…¥é—¨çš„ååˆ†æœ‰æ„ä¹‰çš„ä¾‹å­ã€‚æœ¬æ–‡çš„æœ€åä¸€èŠ‚åªæ¼”ç¤ºäº†RESPçš„è§£ç éƒ¨åˆ†ï¼Œç¼–ç æ¨¡å—å’Œæ›´å¤šç»†èŠ‚ä¼šåœ¨å¦ä¸€ç¯‡ç”¨Nettyå®ç°Rediså®¢æˆ·ç«¯çš„æ–‡ç« ä¸­å±•ç¤ºã€‚ å‚è€ƒèµ„æ–™ï¼š Redis Protocol specification é™„å½• æœ¬æ–‡æ¶‰åŠçš„æ‰€æœ‰ä»£ç ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246public class RespConstants &#123; public static final Charset ASCII = StandardCharsets.US_ASCII; public static final Charset UTF_8 = StandardCharsets.UTF_8; public static final byte DOLLAR_BYTE = '$'; public static final byte ASTERISK_BYTE = '*'; public static final byte PLUS_BYTE = '+'; public static final byte MINUS_BYTE = '-'; public static final byte COLON_BYTE = ':'; public static final String EMPTY_STRING = \"\"; public static final Long ZERO = 0L; public static final Long NEGATIVE_ONE = -1L; public static final byte CR = (byte) '\\r'; public static final byte LF = (byte) '\\n'; public static final byte[] CRLF = \"\\r\\n\".getBytes(ASCII); public enum ReplyType &#123; SIMPLE_STRING, ERROR, INTEGER, BULK_STRING, RESP_ARRAY &#125;&#125;public enum CodecUtils &#123; X; public int findLineEndIndex(ByteBuf buffer) &#123; int index = buffer.forEachByte(ByteProcessor.FIND_LF); return (index &gt; 0 &amp;&amp; buffer.getByte(index - 1) == '\\r') ? index : -1; &#125; public String readLine(ByteBuf buffer) &#123; int lineEndIndex = findLineEndIndex(buffer); if (lineEndIndex &gt; -1) &#123; int lineStartIndex = buffer.readerIndex(); // è®¡ç®—å­—èŠ‚é•¿åº¦ int size = lineEndIndex - lineStartIndex - 1; byte[] bytes = new byte[size]; buffer.readBytes(bytes); // é‡ç½®è¯»æ¸¸æ ‡ä¸º\\r\\nä¹‹åçš„ç¬¬ä¸€ä¸ªå­—èŠ‚ buffer.readerIndex(lineEndIndex + 1); buffer.markReaderIndex(); return new String(bytes, RespConstants.UTF_8); &#125; return null; &#125;&#125;public interface RespCodec &#123; RespCodec X = DefaultRespCodec.X; &lt;IN, OUT&gt; OUT decode(ByteBuf buffer); &lt;IN, OUT&gt; ByteBuf encode(IN in);&#125;public enum DefaultRespCodec implements RespCodec &#123; X; static final Map&lt;ReplyType, RespDecoder&gt; DECODERS = Maps.newConcurrentMap(); private static final RespDecoder DEFAULT_DECODER = new DefaultRespDecoder(); static &#123; DECODERS.put(ReplyType.SIMPLE_STRING, new RespSimpleStringDecoder()); DECODERS.put(ReplyType.ERROR, new RespErrorDecoder()); DECODERS.put(ReplyType.INTEGER, new RespIntegerDecoder()); DECODERS.put(ReplyType.BULK_STRING, new RespBulkStringDecoder()); DECODERS.put(ReplyType.RESP_ARRAY, new RespArrayDecoder()); &#125; @SuppressWarnings(\"unchecked\") @Override public &lt;IN, OUT&gt; OUT decode(ByteBuf buffer) &#123; return (OUT) DECODERS.getOrDefault(determineReplyType(buffer), DEFAULT_DECODER).decode(buffer); &#125; private ReplyType determineReplyType(ByteBuf buffer) &#123; byte firstByte = buffer.readByte(); ReplyType replyType; switch (firstByte) &#123; case RespConstants.PLUS_BYTE: replyType = ReplyType.SIMPLE_STRING; break; case RespConstants.MINUS_BYTE: replyType = ReplyType.ERROR; break; case RespConstants.COLON_BYTE: replyType = ReplyType.INTEGER; break; case RespConstants.DOLLAR_BYTE: replyType = ReplyType.BULK_STRING; break; case RespConstants.ASTERISK_BYTE: replyType = ReplyType.RESP_ARRAY; break; default: &#123; throw new IllegalArgumentException(\"first byte:\" + firstByte); &#125; &#125; return replyType; &#125; @Override public &lt;IN, OUT&gt; ByteBuf encode(IN in) &#123; // TODO throw new UnsupportedOperationException(\"encode\"); &#125;&#125;public interface RespDecoder&lt;V&gt; &#123; V decode(ByteBuf buffer);&#125;public class DefaultRespDecoder implements RespDecoder &#123; @Override public Object decode(ByteBuf buffer) &#123; throw new IllegalStateException(\"decoder\"); &#125;&#125;public class LineStringDecoder implements RespDecoder&lt;String&gt; &#123; @Override public String decode(ByteBuf buffer) &#123; return CodecUtils.X.readLine(buffer); &#125;&#125;public class RespSimpleStringDecoder extends LineStringDecoder &#123;&#125;public class RespErrorDecoder extends LineStringDecoder &#123;&#125;public class RespIntegerDecoder implements RespDecoder&lt;Long&gt; &#123; @Override public Long decode(ByteBuf buffer) &#123; int lineEndIndex = CodecUtils.X.findLineEndIndex(buffer); // æ²¡æœ‰è¡Œå°¾ï¼Œå¼‚å¸¸ if (-1 == lineEndIndex) &#123; return null; &#125; long result = 0L; int lineStartIndex = buffer.readerIndex(); boolean negative = false; byte firstByte = buffer.getByte(lineStartIndex); // è´Ÿæ•° if (RespConstants.MINUS_BYTE == firstByte) &#123; negative = true; &#125; else &#123; int digit = firstByte - '0'; result = result * 10 + digit; &#125; for (int i = lineStartIndex + 1; i &lt; (lineEndIndex - 1); i++) &#123; byte value = buffer.getByte(i); int digit = value - '0'; result = result * 10 + digit; &#125; if (negative) &#123; result = -result; &#125; // é‡ç½®è¯»æ¸¸æ ‡ä¸º\\r\\nä¹‹åçš„ç¬¬ä¸€ä¸ªå­—èŠ‚ buffer.readerIndex(lineEndIndex + 1); return result; &#125;&#125;public class RespBulkStringDecoder implements RespDecoder&lt;String&gt; &#123; @Override public String decode(ByteBuf buffer) &#123; int lineEndIndex = CodecUtils.X.findLineEndIndex(buffer); if (-1 == lineEndIndex) &#123; return null; &#125; Long length = (Long) DefaultRespCodec.DECODERS.get(ReplyType.INTEGER).decode(buffer); if (null == length) &#123; return null; &#125; // Bulk Null String if (RespConstants.NEGATIVE_ONE.equals(length)) &#123; return null; &#125; // Bulk Empty String if (RespConstants.ZERO.equals(length)) &#123; return RespConstants.EMPTY_STRING; &#125; // çœŸå®å­—èŠ‚å†…å®¹çš„é•¿åº¦ int readLength = (int) length.longValue(); if (buffer.readableBytes() &gt; readLength) &#123; byte[] bytes = new byte[readLength]; buffer.readBytes(bytes); // é‡ç½®è¯»æ¸¸æ ‡ä¸º\\r\\nä¹‹åçš„ç¬¬ä¸€ä¸ªå­—èŠ‚ buffer.readerIndex(buffer.readerIndex() + 2); return new String(bytes, RespConstants.UTF_8); &#125; return null; &#125;&#125;public class RespArrayDecoder implements RespDecoder &#123; @Override public Object decode(ByteBuf buffer) &#123; int lineEndIndex = CodecUtils.X.findLineEndIndex(buffer); if (-1 == lineEndIndex) &#123; return null; &#125; // è§£æå…ƒç´ ä¸ªæ•° Long length = (Long) DefaultRespCodec.DECODERS.get(ReplyType.INTEGER).decode(buffer); if (null == length) &#123; return null; &#125; // Null Array if (RespConstants.NEGATIVE_ONE.equals(length)) &#123; return null; &#125; // Array Empty List if (RespConstants.ZERO.equals(length)) &#123; return Lists.newArrayList(); &#125; List&lt;Object&gt; result = Lists.newArrayListWithCapacity((int) length.longValue()); // é€’å½’ for (int i = 0; i &lt; length; i++) &#123; result.add(DefaultRespCodec.X.decode(buffer)); &#125; return result; &#125;&#125; ï¼ˆæœ¬æ–‡å®Œ e-a-20191009 c-2-dï¼‰","categories":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/categories/Middleware/"},{"name":"Redis","slug":"Middleware/Redis","permalink":"http://throwable.club/blog/categories/Middleware/Redis/"}],"tags":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/tags/Middleware/"},{"name":"Redis","slug":"Redis","permalink":"http://throwable.club/blog/tags/Redis/"}]},{"title":"Redis5.xå“¨å…µæ­å»ºæ‰‹è®°","slug":"redis-server-sentinel-install-guide","date":"2019-10-06T17:48:24.000Z","updated":"2019-11-28T17:01:08.179Z","comments":true,"path":"2019/10/07/redis-server-sentinel-install-guide/","link":"","permalink":"http://throwable.club/2019/10/07/redis-server-sentinel-install-guide/","excerpt":"å‰æ Redis5.xä¹‹åï¼Œå•æœºã€å“¨å…µã€é›†ç¾¤æ­å»ºçš„éš¾åº¦å·²ç»ç®€åŒ–ã€‚é‰´äºç›®å‰çœ‹åˆ°å¤ªå¤šæ–‡ç« éƒ½æ˜¯å¤åˆ¶ç²˜è´´ä»¥å¾€ä¸€äº›3.xç‰ˆæœ¬çš„ä¸€äº›å†…å®¹ï¼Œæ‰€ä»¥æ‰“ç®—åŸºäºå½“å‰Redisçš„æœ€æ–°ç‰ˆæœ¬åšä¸€æ¬¡å•æœºã€å“¨å…µå’Œé›†ç¾¤çš„æ­å»ºï¼Œè®°å½•ä¸€ä¸‹è¿‡ç¨‹æ­¥éª¤å’Œé‡åˆ°çš„é—®é¢˜ã€‚ç¼–å†™æœ¬æ–‡çš„æ—¶é—´æ˜¯2019å¹´10æœˆ6æ—¥ï¼ˆå›½åº†å‡æœŸâ€¦ï¼‰ï¼Œå½“å‰Redisçš„æœ€æ–°ç‰ˆæœ¬ä¸º5.0.5ã€‚æ“ä½œç³»ç»Ÿç”¨çš„æ˜¯è™šæ‹Ÿæœºé‡Œé¢å®‰è£…çš„CentOS 7ã€‚å…ˆç¡®å®šå·²ç»å®‰è£…å¥½RedisæœåŠ¡ï¼Œå¯ä»¥å‚è€ƒç¬”è€…å†™çš„å‰ä¸€ç¯‡æ–‡ç« ï¼šã€ŠRedis5.xå•æœºæœåŠ¡æ­å»ºæ‰‹è®°ã€‹ã€‚å‡ºäºä¹¦å†™ä¹ æƒ¯ï¼Œæœ¬æ–‡æœ‰å¯èƒ½æŠŠå“¨å…µç§°ä¸ºSentinelã€Redis Sentinelã€å“¨å…µæˆ–è€…Rediså“¨å…µï¼Œè¿™å››ä¸ªåè¯æ˜¯ç­‰ä»·çš„ã€‚","text":"å‰æ Redis5.xä¹‹åï¼Œå•æœºã€å“¨å…µã€é›†ç¾¤æ­å»ºçš„éš¾åº¦å·²ç»ç®€åŒ–ã€‚é‰´äºç›®å‰çœ‹åˆ°å¤ªå¤šæ–‡ç« éƒ½æ˜¯å¤åˆ¶ç²˜è´´ä»¥å¾€ä¸€äº›3.xç‰ˆæœ¬çš„ä¸€äº›å†…å®¹ï¼Œæ‰€ä»¥æ‰“ç®—åŸºäºå½“å‰Redisçš„æœ€æ–°ç‰ˆæœ¬åšä¸€æ¬¡å•æœºã€å“¨å…µå’Œé›†ç¾¤çš„æ­å»ºï¼Œè®°å½•ä¸€ä¸‹è¿‡ç¨‹æ­¥éª¤å’Œé‡åˆ°çš„é—®é¢˜ã€‚ç¼–å†™æœ¬æ–‡çš„æ—¶é—´æ˜¯2019å¹´10æœˆ6æ—¥ï¼ˆå›½åº†å‡æœŸâ€¦ï¼‰ï¼Œå½“å‰Redisçš„æœ€æ–°ç‰ˆæœ¬ä¸º5.0.5ã€‚æ“ä½œç³»ç»Ÿç”¨çš„æ˜¯è™šæ‹Ÿæœºé‡Œé¢å®‰è£…çš„CentOS 7ã€‚å…ˆç¡®å®šå·²ç»å®‰è£…å¥½RedisæœåŠ¡ï¼Œå¯ä»¥å‚è€ƒç¬”è€…å†™çš„å‰ä¸€ç¯‡æ–‡ç« ï¼šã€ŠRedis5.xå•æœºæœåŠ¡æ­å»ºæ‰‹è®°ã€‹ã€‚å‡ºäºä¹¦å†™ä¹ æƒ¯ï¼Œæœ¬æ–‡æœ‰å¯èƒ½æŠŠå“¨å…µç§°ä¸ºSentinelã€Redis Sentinelã€å“¨å…µæˆ–è€…Rediså“¨å…µï¼Œè¿™å››ä¸ªåè¯æ˜¯ç­‰ä»·çš„ã€‚ å“¨å…µç®€ä»‹ ä¸€å®šè¦æœ‰ä¸€ä¸ªæ¦‚å¿µï¼šå“¨å…µå®ä¾‹ä¹Ÿæ˜¯ç‰¹æ®Šçš„Rediså®ä¾‹ï¼Œä¹Ÿå°±æ˜¯å“¨å…µå®ä¾‹æ˜¯ç‹¬ç«‹çš„è¿›ç¨‹ï¼Œå¤šä¸ªå“¨å…µå®ä¾‹å¯ä»¥æ­å»ºä¸»ä»ï¼ˆMaster-Slaveï¼‰ï¼Œå®ƒä»¬æ‰¿æ‹…çš„èŒè´£å’Œæ™®é€šçš„Rediså®ä¾‹ä¸ä¸€æ ·ã€‚ä¸‹é¢æ˜¯å®˜æ–¹æ–‡æ¡£ä¸­å¯¹å“¨å…µçš„ä»‹ç»ï¼š Rediså“¨å…µä¸ºRedisæä¾›äº†é«˜å¯ç”¨æ€§ï¼Œæ„å‘³ç€å¯ä»¥ä½¿ç”¨å“¨å…µåˆ›å»ºRedisæœåŠ¡éƒ¨ç½²ï¼Œè¯¥éƒ¨ç½²å¯ä»¥åœ¨æ— éœ€äººå·¥å¹²é¢„çš„æƒ…å†µä¸‹æŠµå¾¡æŸäº›ç±»å‹çš„æ•…éšœã€‚Rediså“¨å…µè¿˜æä¾›å…¶ä»–åŠŸèƒ½ï¼Œå¦‚ç›‘è§†ã€é€šçŸ¥ï¼Œå¹¶ä¸”ä¸ºå®¢æˆ·ç«¯æä¾›é…ç½®å…¥å£ï¼ˆacts as a configuration provider for clientsï¼‰ã€‚ä¸‹é¢æ˜¯Rediså“¨å…µæä¾›çš„å®Œæ•´åŠŸèƒ½åˆ—è¡¨ï¼š ç›‘æ§ï¼ˆMonitoringï¼‰ï¼šSentinelä¼šä¸æ–­æ£€æŸ¥Masterå®ä¾‹å’ŒSlaveå®ä¾‹æ˜¯å¦æŒ‰é¢„æœŸå·¥ä½œã€‚ é€šçŸ¥ï¼ˆNotificationï¼‰ï¼šSentinelå¯ä»¥é€šè¿‡APIè¿›è¡Œé€šçŸ¥å—ç›‘æ§çš„Rediså®ä¾‹å‡ºç°é—®é¢˜ã€‚ è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼ˆAutomatic Failoverï¼‰ï¼šå¦‚æœMasterå®ä¾‹æœªæŒ‰é¢„æœŸå·¥ä½œï¼Œåˆ™Sentinelå¯ä»¥å¯åŠ¨æ•…éšœè½¬ç§»ç¨‹åºï¼Œåœ¨è¯¥è¿‡ç¨‹ä¸­ï¼Œä¼šå°†ä¸€ä¸ªSlaveå®ä¾‹æå‡ä¸ºMasterå®ä¾‹ï¼Œå°†å…¶ä»–Slaveå®ä¾‹é‡æ–°é…ç½®ä¸ºä½¿ç”¨æ–°çš„Masterå®ä¾‹ï¼Œå¹¶ä¸”ä¼šé€šçŸ¥ä½¿ç”¨Rediså®ä¾‹çš„åº”ç”¨ç¨‹åºè·å–æ–°çš„åœ°å€ã€è¿æ¥ä¿¡æ¯ã€‚ æä¾›é…ç½®å…¥å£ï¼ˆConfiguration providerï¼‰ï¼šSentinelå……å½“å®¢æˆ·ç«¯æœåŠ¡å‘ç°çš„æˆæƒæ¥æºï¼ˆa source of authorityï¼‰ï¼šå®¢æˆ·ç«¯è¿æ¥åˆ°Sentinelï¼Œå¯ä»¥è¯¢é—®RedisæœåŠ¡ç¾¤ä¸­çš„Masterå®ä¾‹çš„åœ°å€ã€‚å¦‚æœå‘ç”Ÿæ•…éšœè½¬ç§»ï¼ŒSentinelå°†é€šçŸ¥å®¢æˆ·ç«¯æ–°çš„Masterå®ä¾‹çš„åœ°å€ã€‚ Sentinelçš„åˆ†å¸ƒå¼æ€§è´¨ Redis Sentinelæ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿï¼ŒSentinelé‡‡ç”¨åŒä¸€ä»½é…ç½®å¤šä¸ªSentinelè¿›ç¨‹å…±åŒåä½œè¿è¡Œçš„è®¾è®¡ï¼Œå¤šSentinelè¿›ç¨‹åä½œçš„ä¼˜åŠ¿å¦‚ä¸‹ï¼š å¤šä¸ªSentinelå®ä¾‹å°±ç»™å®šçš„ä¸»æœºä¸å†å¯ç”¨è¿™ä¸€äº‹å®è¾¾æˆå…±è¯†æ—¶ï¼Œå°†æ‰§è¡Œæ•…éšœæ£€æµ‹ï¼Œä»è€Œé™ä½äº†è¯¯æŠ¥çš„å¯èƒ½æ€§ã€‚ Sentinelç¾¤ä¸­å³ä½¿ä¸æ˜¯æ‰€æœ‰Sentinelå¤„äºå¯ç”¨çŠ¶æ€ï¼ŒSentinelç¾¤ä»ç„¶èƒ½å¤Ÿæ­£å¸¸å·¥ä½œï¼Œè¿›è¡Œæ•…éšœè½¬ç§»ã€‚ å“¨å…µæ­å»º å½“å‰çš„Rediså“¨å…µç‰ˆæœ¬ç§°ä¸ºå“¨å…µ2ï¼Œå“¨å…µç‰ˆæœ¬1æ˜¯Redis 2.6çš„æ—¶å€™å¼•å…¥ï¼Œç°åœ¨å·²ç»è¿‡æœŸï¼Œä¸æ¨èä½¿ç”¨ã€‚å®˜æ–¹æ–‡æ¡£ä¸­éƒ¨ç½²å“¨å…µçš„ç¤ºä¾‹ä¸­æŒ‡å‡ºï¼šä¸€ä¸ªå¥å£®çš„éƒ¨ç½²è‡³å°‘éœ€è¦ä¸‰ä¸ªSentinelå®ä¾‹ã€‚å†åŠ ä¸Šä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ™®é€šçš„RedisæœåŠ¡å®ä¾‹ä¸ºäº†ä¿è¯å¥å£®æ€§éœ€è¦æ­å»ºæ ‘çŠ¶ä¸»ä»ï¼Œè‡³å°‘å»ºè®®éƒ¨ç½²ä¸‰ä¸ªå®ä¾‹ã€‚è¿™é‡Œçš„éƒ¨ç½²æ‹“æ‰‘å›¾å¦‚ä¸‹ï¼š ç¯å¢ƒé…ç½® æŒ‰ç…§éƒ¨ç½²æ‹“æ‰‘å›¾ï¼Œä¸€å…±éƒ¨ç½²6ä¸ªRediså®ä¾‹ï¼Œ3ä¸ªæ™®é€šçš„Rediså®ä¾‹ç»„æˆMaster-Slaveï¼Œå¹¶ä¸”æ˜¯æ ‘çŠ¶ä¸»ä»ï¼Œ3ä¸ªRediså“¨å…µå®ä¾‹ã€‚ä¸ºäº†ç®€å•èµ·è§ï¼Œ6ä¸ªRediså®ä¾‹éƒ¨ç½²åœ¨åŒä¸€ä¸ªè™šæ‹Ÿæœºä¸­ï¼Œæ³¨æ„åœ¨ç”Ÿäº§æˆ–è€…æµ‹è¯•ç¯å¢ƒè¦åˆ†æ•£æœºå™¨éƒ¨ç½²ï¼Œé¿å…æ‰€æœ‰é¸¡è›‹æ”¾åœ¨åŒä¸€ä¸ªç¯®å­å‡ºç°æœºå™¨å•ç‚¹æ•…éšœã€‚å…·ä½“ä¿¡æ¯å¦‚ä¸‹ï¼š å®ä¾‹æ ‡è¯† è§’è‰² ä¸»æœºIP ç«¯å£ å¤‡æ³¨ Sentinel-1 - 192.168.56.200 26379 - Sentinel-2 - 192.168.56.200 26380 - Sentinel-3 - 192.168.56.200 26381 - Redis-1 Master 192.168.56.200 6380 - Redis-11 Slave 192.168.56.200 6381 Redis-1çš„ä»èŠ‚ç‚¹ Redis-111 Slave 192.168.56.200 6382 Redis-11çš„ä»èŠ‚ç‚¹ Sentinelé…ç½®å’Œé…ç½®æ–‡ä»¶åˆ›å»º å…ˆçœ‹æ ·æ¿é…ç½®æ–‡ä»¶sentinel.confçš„å†…å®¹ï¼š 12345678910111213port 26379daemonize nopidfile /var/run/redis-sentinel.pidlogfile \"\"dir /tmpsentinel monitor mymaster 127.0.0.1 6379 2sentinel down-after-milliseconds mymaster 30000sentinel parallel-syncs mymaster 1sentinel failover-timeout mymaster 180000sentinel deny-scripts-reconfig yes# sentinel auth-pass mymaster 123456# bind 127.0.0.1# ...... å®Œæ•´çš„é…ç½®å±æ€§åˆ—è¡¨æ¯”è¾ƒå°‘ï¼Œè€Œportã€daemonizeã€pidfileã€logfileã€dirã€bindç­‰å±æ€§ä¸Šä¸€ç¯‡æ–‡ç« å·²ç»åˆ†æè¿‡ï¼Œè¿™é‡Œä¸å†å¤è¿°ã€‚ sentinel monitor &lt;master-group-name&gt; &lt;ip&gt; &lt;port&gt; &lt;quorum&gt; master-group-nameï¼šè¢«ç›‘æ§çš„ç›®æ ‡Masterå®ä¾‹çš„åç§°ï¼Œè¿™ä¸ªå€¼å¯ä»¥è‡ªå®šä¹‰ã€‚ ipï¼šè¢«ç›‘æ§çš„ç›®æ ‡Masterå®ä¾‹çš„æœåŠ¡å™¨åœ°å€ã€‚ portï¼šè¢«ç›‘æ§çš„ç›®æ ‡Masterå®ä¾‹çš„ç«¯å£ã€‚ quorumï¼šä»²è£å‚æ•°ï¼Œè®¾ç½®éœ€è¦å¤šå°‘ä¸ªSentinelå®ä¾‹åŒæ„æ‰èƒ½åˆ¤æ–­ä¸€ä¸ªè¢«ç›‘æ§çš„Rediså®ä¾‹å¤±æ•ˆã€‚æ¢è¨€ä¹‹ï¼Œä¸€ä¸ª Sentinelç¾¤éœ€è¦è·å¾—ç³»ç»Ÿä¸­å¤šæ•°Sentinelçš„æ”¯æŒï¼Œ æ‰èƒ½å‘èµ·ä¸€æ¬¡è‡ªåŠ¨æ•…éšœè¿ç§»ã€‚å¦‚æœæˆ‘ä»¬ä½¿ç”¨3ä¸ªSentinelå®ä¾‹ï¼Œé‚£ä¹ˆè¿™ä¸ªå€¼å¯ä»¥å®šä¹‰ä¸º2ã€‚ sentinel monitoré…ç½®é¡¹æ¯”è¾ƒç‰¹æ®Šï¼Œä¸»è¦ç”¨æ¥æŒ‡å®šMasterè§’è‰²RedisæœåŠ¡çš„é“¾æ¥ä¿¡æ¯ã€‚å…¶ä»–5ä¸ªé…ç½®é¡¹é‡‡ç”¨ä¸‹é¢çš„æ ¼å¼ï¼š 1sentinel &lt;option_name&gt; &lt;master-group-name&gt; &lt;option_value&gt; down-after-millisecondsï¼šå®šäº†Sentinelè®¤ä¸ºè¢«ç›‘æ§çš„RedisæœåŠ¡å·²ç»æ–­çº¿çš„æ€»æ¯«ç§’æ•°ã€‚å¦‚æœåœ¨æŒ‡å®šçš„æ¯«ç§’æ•°ä¹‹å†…ï¼Œè¢«ç›‘æ§çš„RedisæœåŠ¡æ²¡æœ‰å‘Sentinelå›å¤PINGä¿¡æ¯æˆ–è€…å›å¤äº†Errorä¿¡æ¯ï¼Œé‚£ä¹ˆSentinelä¼šå¼€å§‹è®¤ä¸ºè¢«ç›‘æ§çš„RedisæœåŠ¡ä¸‹çº¿ï¼ˆå…¶å®è¿™é‡Œæ˜¯ä¸»è§‚ä¸‹çº¿ï¼ˆsubjectively downï¼Œç®€ç§°SDOWNï¼‰ã€‚ parallel-syncsï¼šæŒ‡å®šäº†åœ¨æ‰§è¡Œæ•…éšœè½¬ç§»æ—¶ï¼Œæœ€å¤šå¯ä»¥æœ‰å¤šå°‘Slaveå®ä¾‹åŒæ—¶å¯¹æ–°çš„Masterå®ä¾‹è¿›è¡ŒåŒæ­¥ï¼Œè¿™ä¸ªæ•°å­—è¶Šå°ï¼Œå®Œæˆæ•…éšœè½¬ç§»æ‰€éœ€çš„æ—¶é—´å°±è¶Šé•¿ã€‚è¿™é‡Œå»ºè®®å‚è€ƒæ ·æ¿é…ç½®ä¸­çš„å€¼ï¼Œè®¾ç½®ä¸º1ã€‚ failover-timeoutï¼šæ•…éšœè½¬ç§»è¶…æ—¶æ—¶é—´ï¼Œå•ä½ä¸ºæ¯«ç§’ã€‚ deny-scripts-reconfigï¼šæ˜¯å¦ç¦ç”¨SENTINEL SETå‘½ä»¤è¿è¡Œæ—¶ä¿®æ”¹notification-scriptå’Œclient-reconfig-scriptï¼Œé»˜è®¤å€¼ä¸ºyesã€‚ auth-passï¼šé…ç½®è¿æ¥Masterå®ä¾‹çš„è®¤è¯å¯†ç ï¼Œå¦‚æœMasterå®ä¾‹æ²¡æœ‰è®¾ç½®å¯†ç ï¼Œå¯ä»¥ä¸é…ç½®æ­¤é¡¹å±æ€§ã€‚ åˆ›å»º3ä»½Sentinelé…ç½®æ–‡ä»¶26379.confã€26380.confã€26381.confï¼Œå®ƒä»¬çš„å†…å®¹ååˆ†ç›¸ä¼¼ï¼Œè¿™é‡Œåªåˆ—å‡º26379.confçš„å†…å®¹ï¼ˆ192.168.56.200æ˜¯ç¬”è€…è™šæ‹Ÿæœºçš„ä¸»æœºåœ°å€ï¼‰ï¼š 1234567891011port 26379daemonize yesbind 0.0.0.0protected-mode nopidfile /var/run/sentinel-26379.pidlogfile \"/data/redis/sentinel-26379.log\"dir /data/redissentinel monitor doge-master 192.168.56.200 6380 2sentinel down-after-milliseconds doge-master 30000sentinel parallel-syncs doge-master 1sentinel failover-timeout doge-master 180000 å¦å¤–ï¼Œåˆ›å»º3ä»½RedisæœåŠ¡çš„é…ç½®æ–‡ä»¶6380.confã€6381.confã€6382.confï¼Œå®ƒä»¬çš„å†…å®¹ååˆ†ç›¸ä¼¼ï¼Œè¿™é‡Œåªåˆ—å‡º6380.confï¼ˆä¸»èŠ‚ç‚¹ï¼‰çš„å†…å®¹ï¼š 12345678port 6380daemonize yesbind 0.0.0.0protected-mode nopidfile /var/run/redis-6380.pidlogfile \"/data/redis/redis-6380.log\"dir /data/redisdbfilename \"dump-6380.rdb\" 6381.confï¼ˆä»èŠ‚ç‚¹ï¼‰å°¾éƒ¨æ·»åŠ é¢å¤–é…ç½®ï¼š 1slaveof 192.168.56.200 6380 6382.confï¼ˆä»èŠ‚ç‚¹ï¼‰å°¾éƒ¨æ·»åŠ é¢å¤–é…ç½®ï¼š 1slaveof 192.168.56.200 6381 æ¯ä»½é…ç½®è®°å¾—æ›¿æ¢å¥½å¯¹åº”çš„ç«¯å£å·ï¼Œéƒ½å‡†å¤‡å¥½äº†ä¹‹åï¼Œä¾æ¬¡å¯åŠ¨ä¸»èŠ‚ç‚¹ã€ä¸¤ä¸ªä»èŠ‚ç‚¹å’Œ3ä¸ªSentinelï¼ˆå¯ä»¥æŠŠå‘½ä»¤å†™æˆä¸€ä¸ªstart.shï¼Œè°ƒç”¨sh start.shï¼‰ï¼š 1234567/data/redis/redis-5.0.5/src/redis-server /data/redis/6380.conf/data/redis/redis-5.0.5/src/redis-server /data/redis/6381.conf/data/redis/redis-5.0.5/src/redis-server /data/redis/6382.conf/data/redis/redis-5.0.5/src/redis-sentinel /data/redis/26379.conf/data/redis/redis-5.0.5/src/redis-sentinel /data/redis/26380.conf/data/redis/redis-5.0.5/src/redis-sentinel /data/redis/26381.conf æ­¤æ—¶æŸ¥çœ‹å“¨å…µçš„é…ç½®ï¼Œå‘ç°è¢«Redisä¿®æ”¹ï¼Œæ–°å¢äº†å‘ç°çš„ä¸»ä»ä¿¡æ¯å’Œå“¨å…µå®ä¾‹ä¿¡æ¯ï¼š æŸ¥çœ‹ä¸€ä¸‹å“¨å…µå®ä¾‹çš„æ—¥å¿—ï¼š ç›®å‰å“¨å…µå’ŒRedisæœåŠ¡éƒ½æ­£å¸¸è¿ä½œã€‚ æ¨¡æ‹Ÿæ•…éšœè½¬ç§» å®˜æ–¹æ–‡æ¡£ä¸­å»ºè®®ä½¿ç”¨æµ‹è¯•å‘½ä»¤è®©Rediså®ä¾‹Sleepä¸€ä¸ªæ—¶é—´ï¼Œä»è€Œè§¦å‘æ•…éšœè½¬ç§»ï¼š 1redis-cli -p [port] DEBUG sleep 30 å…ˆæŸ¥çœ‹å½“å‰çš„Masterå®ä¾‹ï¼š 1234[root@localhost ~]# redis-cli -p 26379 127.0.0.1:26379&gt; SENTINEL get-master-addr-by-name doge-master1) \"127.0.0.1\"2) \"6380\" å†å¯¹Masterå®ä¾‹æ‰§è¡ŒSleepå‘½ä»¤ï¼š 1redis-cli -p 6380 DEBUG sleep 40 è¯¥å‘½ä»¤ä¼šé˜»å¡ç›´åˆ°40ç§’åï¼Œæ§åˆ¶å°é‡Šæ”¾åï¼Œå†æŸ¥çœ‹å½“å‰çš„Masterå®ä¾‹ï¼š 1234127.0.0.1:26379&gt; SENTINEL get-master-addr-by-name doge-master1) \"127.0.0.1\"2) \"6381\"127.0.0.1:26379&gt; å¯è§ï¼Œå·²ç»æˆåŠŸåˆ‡æ¢Masterå®ä¾‹ä¸º6381ã€‚é‚£ä¹ˆï¼Œå½“å‰çš„Master-Slaveçš„æ‹“æ‰‘å…³ç³»åˆ°åº•æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿè¿™ä¸ªæ—¶å€™å…ˆçœ‹ä¸€ä¸‹Sentinelçš„æ—¥å¿—ï¼š è¿™é‡Œå¯ä»¥çœ‹å‡ºäº†ï¼Œæ¢å¤åçš„6380å®ä¾‹é‡æ–°æˆä¸ºäº†Slaveè§’è‰²ï¼Œæ„Ÿè§‰æœ‰ç‚¹ç¿»è½¦äº†ï¼ŒåŸæ¥çš„æ ‘çŠ¶ä¸»ä»éƒ¨ç½²å˜å›äº†ä¸€ä¸»å¤šä»ï¼Œç¬”è€…å¼€å§‹ä¸ç›¸ä¿¡ï¼Œäºæ˜¯ä»å½“å‰çš„Masterå®ä¾‹æŸ¥çœ‹äº†ä¸€ä¸‹ä¸»ä»ä¿¡æ¯ï¼š ç¡®å®å¦‚æ­¤ï¼Œå†æ£€æŸ¥äº†ä¸€ä¸‹æ—§çš„ä¸»èŠ‚ç‚¹6380çš„é…ç½®ï¼š 12345678910port 6380daemonize yesbind 0.0.0.0protected-mode nopidfile \"/var/run/redis-6380.pid\"logfile \"/data/redis/redis-6380.log\"dir \"/data/redis\"dbfilename \"dump-6380.rdb\"# Generated by CONFIG REWRITEreplicaof 192.168.56.200 6381 å‘ç°ï¼Œæœ€åä¸€è¡Œè¢«æ–°å¢äº†å†…å®¹ï¼Œå®ƒæˆä¸ºäº†ä»èŠ‚ç‚¹ã€‚è¿™ä¸€ç‚¹å¦‚æœä¸å®è·µï¼Œææ€•ä¸çŸ¥é“ä¼šè¡ç”Ÿå‡ºè¿™ç§ç»“æœã€‚ç”»äº†ä¸ªå›¾è¡¨æ˜ä¸€ä¸‹æ•´ä¸ªè¿‡ç¨‹ï¼š è¿™ä¸ªé—®é¢˜æš‚æ—¶ä¸æ·±å…¥æ¢ç©¶ï¼Œç›®å‰çŸ¥é“ç»“æœå¦‚æ­¤å³å¯ã€‚ å®¢æˆ·ç«¯ä»£ç æµ‹è¯• æ—¢ç„¶å“¨å…µæ­å»ºå®Œäº†ï¼Œå¯ä»¥ç”¨Javaå®¢æˆ·ç«¯è¿æ¥è¿›è¡Œä¸€äº›ç®€å•çš„æ“ä½œã€‚ä½¿ç”¨çš„æ˜¯Lettuceé©±åŠ¨ï¼š 12345&lt;dependency&gt; &lt;groupId&gt;io.lettuce&lt;/groupId&gt; &lt;artifactId&gt;lettuce-core&lt;/artifactId&gt; &lt;version&gt;5.1.8.RELEASE&lt;/version&gt;&lt;/dependency&gt; æµ‹è¯•ä»£ç ï¼š 123456789101112131415161718@Testpublic void testSentinel() throws Exception &#123; RedisURI uri = RedisURI.builder() .withSentinelMasterId(\"doge-master\") .withSentinel(\"192.168.56.200\", 26379) .build(); RedisClient redisClient = RedisClient.create(uri); StatefulRedisMasterSlaveConnection&lt;String, String&gt; connection = MasterSlave.connect(redisClient, new Utf8StringCodec(), uri); connection.setReadFrom(ReadFrom.SLAVE_PREFERRED); RedisCommands&lt;String, String&gt; commands = connection.sync(); String result = commands.ping(); log.info(\"PING:&#123;&#125;\", result); commands.setex(\"name\", 5, \"throwable\"); result = commands.get(\"name\"); log.info(\"Get value:&#123;&#125;\", result); connection.close(); redisClient.shutdown();&#125; è¾“å‡ºç»“æœï¼š 12PING:PONGGet value:throwable å°ç»“ Rediså“¨å…µæ­å»ºç›¸å¯¹ç®€å•ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„Redisä¸»ä»é…ç½®å’ŒSentinelé…ç½®ï¼Œä¸€äº›å‘½ä»¤å¯ä»¥ç›´æ¥å†™æˆshellè„šæœ¬æ–¹ä¾¿ä¸€é”®shutdownæˆ–è€…é‡å¯ã€‚åœ¨æµ‹è¯•æ•…éšœè½¬ç§»çš„æ—¶å€™å‘ç°äº†æ ‘çŠ¶ä¸»ä»ä¼šå˜æˆä¸€ä¸»å¤šä»ï¼Œè¿™ä¸ªé—®é¢˜åé¢ä¼šåˆ†æã€‚ å‚è€ƒèµ„æ–™ï¼š Redis Sentinel Documentation ï¼ˆæœ¬æ–‡å®Œ c-1-d e-a-20191007ï¼‰","categories":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/categories/Middleware/"},{"name":"Redis","slug":"Middleware/Redis","permalink":"http://throwable.club/blog/categories/Middleware/Redis/"}],"tags":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/tags/Middleware/"},{"name":"Redis","slug":"Redis","permalink":"http://throwable.club/blog/tags/Redis/"}]},{"title":"Redis5.xå•æœºæœåŠ¡æ­å»ºæ‰‹è®°","slug":"redis-server-single-install-guide","date":"2019-10-06T01:58:53.000Z","updated":"2019-11-28T17:01:12.773Z","comments":true,"path":"2019/10/06/redis-server-single-install-guide/","link":"","permalink":"http://throwable.club/2019/10/06/redis-server-single-install-guide/","excerpt":"Redis5.xä¹‹åï¼Œå•æœºã€å“¨å…µã€é›†ç¾¤æ­å»ºçš„éš¾åº¦å·²ç»ç®€åŒ–ã€‚é‰´äºç›®å‰çœ‹åˆ°å¤ªå¤šæ–‡ç« éƒ½æ˜¯å¤åˆ¶ç²˜è´´ä»¥å¾€ä¸€äº›3.xç‰ˆæœ¬çš„ä¸€äº›å†…å®¹ï¼Œæ‰€ä»¥æ‰“ç®—åŸºäºå½“å‰Redisçš„æœ€æ–°ç‰ˆæœ¬åšä¸€æ¬¡å•æœºã€å“¨å…µå’Œé›†ç¾¤çš„æ­å»ºï¼Œè®°å½•ä¸€ä¸‹è¿‡ç¨‹æ­¥éª¤å’Œé‡åˆ°çš„é—®é¢˜ã€‚ç¼–å†™æœ¬æ–‡çš„æ—¶é—´æ˜¯2019å¹´10æœˆ5æ—¥ï¼ˆå›½åº†å‡æœŸâ€¦ï¼‰ï¼Œå½“å‰Redisçš„æœ€æ–°ç‰ˆæœ¬ä¸º5.0.5ã€‚æ“ä½œç³»ç»Ÿç”¨çš„æ˜¯è™šæ‹Ÿæœºé‡Œé¢å®‰è£…çš„CentOS 7ã€‚","text":"Redis5.xä¹‹åï¼Œå•æœºã€å“¨å…µã€é›†ç¾¤æ­å»ºçš„éš¾åº¦å·²ç»ç®€åŒ–ã€‚é‰´äºç›®å‰çœ‹åˆ°å¤ªå¤šæ–‡ç« éƒ½æ˜¯å¤åˆ¶ç²˜è´´ä»¥å¾€ä¸€äº›3.xç‰ˆæœ¬çš„ä¸€äº›å†…å®¹ï¼Œæ‰€ä»¥æ‰“ç®—åŸºäºå½“å‰Redisçš„æœ€æ–°ç‰ˆæœ¬åšä¸€æ¬¡å•æœºã€å“¨å…µå’Œé›†ç¾¤çš„æ­å»ºï¼Œè®°å½•ä¸€ä¸‹è¿‡ç¨‹æ­¥éª¤å’Œé‡åˆ°çš„é—®é¢˜ã€‚ç¼–å†™æœ¬æ–‡çš„æ—¶é—´æ˜¯2019å¹´10æœˆ5æ—¥ï¼ˆå›½åº†å‡æœŸâ€¦ï¼‰ï¼Œå½“å‰Redisçš„æœ€æ–°ç‰ˆæœ¬ä¸º5.0.5ã€‚æ“ä½œç³»ç»Ÿç”¨çš„æ˜¯è™šæ‹Ÿæœºé‡Œé¢å®‰è£…çš„CentOS 7ã€‚ å•æœºç‰ˆå®‰è£…å’Œå¯åŠ¨ ç¼–è¯‘è¿‡ç¨‹ä¾èµ–äºgccï¼Œè®°å¾—å…ˆæå‰å®‰è£…gccï¼š 1yum install -y gcc é¢„å…ˆå»ºä¸€ä¸ªç›®å½•/data/redisï¼Œä¸‹è½½å¹¶ä¸”è§£å‹å®‰è£…åŒ…ï¼š 1234mkdir /data/rediscd /data/rediswget http://download.redis.io/releases/redis-5.0.5.tar.gztar zxvf redis-5.0.5.tar.gz æ¥ç€è¿›å…¥è§£å‹åçš„ç›®å½•/data/redis/redis-5.0.5ï¼Œè¿›è¡Œç¼–è¯‘ï¼š 123cd /data/redis/redis-5.0.5# è¿™é‡Œçš„MALLOC=libcä¸èƒ½å°‘make MALLOC=libc ç¼–è¯‘å®Œæˆä¹‹åï¼Œå¯ä»¥çœ‹åˆ°ç±»ä¼¼å¦‚ä¸‹çš„æ—¥å¿—ï¼š å¯é€‰å®‰è£…é¡¹ï¼šå¯ä»¥ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤æŠŠ/data/redis/redis-5.0.5/srcç›®å½•ä¸‹çš„ç¼–è¯‘å®Œæˆåçš„æ–‡ä»¶æ·»åŠ åˆ°ç³»ç»Ÿçš„/usr/local/binç›®å½•ï¼š 1cd /data/redis/redis-5.0.5/src &amp;&amp; make install ç¼–è¯‘å®Œæˆä¹‹åï¼Œæ³¨æ„/data/redis/redis-5.0.5/srcç›®å½•ä¸‹çš„å‡ ä¸ªé‡è¦çš„å¯æ‰§è¡Œè„šæœ¬ï¼š 123456789......redis-benchmark - benchmarkæµ‹è¯•ç›¸å…³redis-check-aof - AOEç›¸å…³redis-check-rdb - RDBç›¸å…³redis-cli - å‘½ä»¤è¡Œæç¤ºç¬¦å…¥å£redis-sentinel - å“¨å…µç›¸å…³redis-server - RedisæœåŠ¡ç«¯æŒ‡ä»¤redis-trib.rb - Rubyè„šæœ¬ï¼Œé›†ç¾¤ç›¸å…³...... å•æœºå¯åŠ¨éœ€è¦ä½¿ç”¨redis-serverè„šæœ¬ï¼Œå®ƒä¼šè¯»å–/data/redis/redis-5.0.5ç›®å½•ä¸‹çš„redis.confé…ç½®æ–‡ä»¶ï¼Œåœ¨/data/redis/redis-5.0.5ç›®å½•ä¸‹æœ‰ä¸¤ä¸ªæ ·æ¿é…ç½®æ–‡ä»¶ï¼š 12redis.conf - å•æœºé…ç½®æ–‡ä»¶sentinel.conf - å“¨å…µé…ç½®æ–‡ä»¶ è¿˜æœ‰ä¸€ç‚¹éœ€è¦é‡ç‚¹æç¤ºä¸€ä¸‹ï¼š/data/redis/redis-5.0.5/utilsç›®å½•ä¸‹è‡ªå¸¦äº†ä¸€äº›ååˆ†æœ‰ç”¨çš„RedisæœåŠ¡å®‰è£…ã€ç®¡ç†ã€é›†ç¾¤åˆ›å»ºç­‰ç­‰çš„ç›¸å…³è„šæœ¬ï¼Œæœ‰ä½¿ç”¨åœºæ™¯çš„æ—¶å€™å¯ä»¥ç›´æ¥ä»é‡Œé¢æ‹¿å‡ºæ¥ä½¿ç”¨ã€‚ éåå°å¯åŠ¨RedisæœåŠ¡ï¼š 1234567891011# ä½¿ç”¨é»˜è®¤é…ç½®/data/redis/redis-5.0.5/src/redis-server# å·²ç»è¿›å…¥äº† /data/redis/redis-5.0.5/srcç›®å½•ä¸‹./redis-server# æˆ–è€…æŒ‡å®šé…ç½®å¦‚ä¸‹/data/redis/redis-5.0.5/src/redis-server /é…ç½®ç›®å½•/ä½ çš„é…ç½®æ–‡ä»¶.conf# å·²ç»è¿›å…¥äº† /data/redis/redis-5.0.5/srcç›®å½•ä¸‹./redis-server /é…ç½®ç›®å½•/ä½ çš„é…ç½®æ–‡ä»¶.conf éåå°å¯åŠ¨RedisæœåŠ¡ï¼Œçª—å£éœ€è¦ä¸€ç›´æ‰“å¼€ï¼Œéœ€è¦é€€å‡ºè¿›ç¨‹åˆ™æŒ‰Ctrl + Cï¼Œæ˜¾ç„¶ä¸æ˜¯å¤ªæ–¹ä¾¿ã€‚ åå°å¯åŠ¨RedisæœåŠ¡ï¼š 1234# ä¿®æ”¹redis.confæ–‡ä»¶çš„daemonizeé…ç½®ï¼Œç¬”è€…ä¿®æ”¹å’Œä½¿ç”¨/data/redis/redis-5.0.5/redis.confæŠŠdaemonize no ä¿®æ”¹ä¸º daemonize yesä¿å­˜# å¯åŠ¨RedisæœåŠ¡./redis-server /data/redis/redis-5.0.5/redis.conf æŸ¥çœ‹RedisæœåŠ¡è¿›ç¨‹ä¿¡æ¯ï¼š 1ps -ef | grep redis å¼ºæ€RedisæœåŠ¡è¿›ç¨‹ 12# ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè¯·å‹¿ä½¿ç”¨kill -9ï¼Œå¦åˆ™æœ‰å¯èƒ½é€ æˆæ•°æ®ä¸¢å¤±kill -9 5365 å®‰è£…Redisä½œä¸ºç³»ç»ŸæœåŠ¡ï¼ˆå¯ä»¥ä½¿ç”¨ç³»ç»Ÿå‘½ä»¤ç®¡ç†ï¼Œè®¾ç½®è‡ªå¯åŠ¨ç­‰ç­‰ï¼‰ï¼š 123456789101112131415# æ³¨æ„ï¼šè¿™é‡Œè¦å…ˆæŠŠ../redis-5.0.5/srcç›®å½•ä¸‹çš„æ–‡ä»¶åŠ åˆ°/usr/local/binç›®å½•ï¼Œå¦‚æœå·²ç»æ·»åŠ è¿‡å¯ä»¥å¿½ç•¥è¿™ä¸€æ­¥cd /data/redis/redis-5.0.5/src/ &amp;&amp; make install# é¢„å…ˆå»ºç«‹/etc/redisç›®å½•mkdir /etc/redis# ä¾èµ–redis_init_scriptè„šæœ¬ï¼Œé‡Œé¢ä¼šè¯»å–/etc/redis/$&#123;PORT&#125;.confé…ç½®ï¼Œéœ€è¦æå‰å»ºå¥½cp /data/redis/redis-5.0.5/utils/redis_init_script /etc/init.d/redis-doge# æ‹·è´é…ç½®æ–‡ä»¶cp /data/redis/redis-5.0.5/redis.conf /etc/redis/6379.conf# é…ç½®ç³»ç»Ÿåº”ç”¨cd /etc/init.dchkconfig redis-doge on è¿™é‡Œçš„redis-dogeå‘½åæ˜¯ç¬”è€…éšæ„è‡ªå®šä¹‰ï¼Œåœ¨ä¸ªäººå¼€å‘ç¯å¢ƒå¯ä»¥è¿™æ ·åšï¼Œæµ‹è¯•æˆ–è€…ç”Ÿäº§ç¯å¢ƒå°½é‡è§„èŒƒå‘½åä¸ºredisæˆ–è€…redisdã€‚åšå¥½ä¸Šé¢çš„è®¾ç½®ä¹‹åï¼Œå°±å¯ä»¥ç”¨ç³»ç»ŸæœåŠ¡çš„å½¢å¼å¯åŠ¨å’Œå…³é—­RedisæœåŠ¡ï¼š é…ç½®æ–‡ä»¶redis.confçš„å¸¸ç”¨é…ç½®é¡¹ è§£å‹ç›®å½•ä¸‹çš„æ ·æ¿é…ç½®æ–‡ä»¶redis.confé‡Œé¢å·²ç»åˆ—ä¸¾äº†RedisæœåŠ¡å¯åŠ¨é…ç½®æ”¯æŒçš„å…¨é‡é…ç½®é¡¹ï¼Œé‡Œé¢çš„å†…å®¹å¤ªå¤šï¼Œè¿™é‡Œæš‚æ—¶æŒ‘å‡ ä¸ªç›¸å¯¹é‡è¦å’Œå¸¸ç”¨çš„é¡¹åšåˆ†æï¼š é…ç½®é¡¹ æè¿° é»˜è®¤å€¼ port RedisæœåŠ¡çš„å¯åŠ¨ç«¯å£ 6379 daemoniz RedisæœåŠ¡æ˜¯å¦åå°è¿è¡Œ no pidfile RedisæœåŠ¡PIDå¯„å­˜æ–‡ä»¶ /var/run/redis_6379.pid logfile RedisæœåŠ¡è¾“å‡ºæ—¥å¿—æ–‡ä»¶ &quot;&quot;ï¼ŒæŒ‡å‘/dev/null dbfilename RedisæœåŠ¡æ•°æ®åº“dumpæ–‡ä»¶çš„åç§° dump.rdb dir RedisæœåŠ¡æ•°æ®åº“dumpæ–‡ä»¶çš„è¾“å‡ºç›®å½•ï¼Œä¹Ÿå°±æ˜¯å·¥ä½œç›®å½• ./ï¼Œä¹Ÿå°±æ˜¯å½“å‰ç›®å½• appendonly æ˜¯å¦å¯ç”¨AOF no appendfilename å¯ç”¨AOFåè¾“å‡ºçš„æ–‡ä»¶åç§° appendonly.aof appendfsync AOFç­–ç•¥ everysec requirepass RedisæœåŠ¡æ•°è®¿é—®è®¤è¯å¯†ç  - è¿˜æœ‰ä¸¤ä¸ªæ¯”è¾ƒéš¾ç†è§£çš„bindå’Œprotected-modeé…ç½®ã€‚ bindï¼šé»˜è®¤å€¼ä¸º127.0.0.1ã€‚ bindé…ç½®çš„æ³¨é‡Šæ¯”è¾ƒé•¿ï¼Œè¿™é‡Œç¿»è¯‘å’Œæµ“ç¼©ä¸€ä¸‹ï¼šé»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šbindé…ç½®ï¼Œåˆ™RedisæœåŠ¡ç›‘å¬æ¥è‡ªæœåŠ¡å™¨ä¸Šæ‰€æœ‰å¯ç”¨ç½‘ç»œæ¥å£ï¼ˆNetwork Interfaceï¼‰ çš„è¿æ¥ã€‚å¯ä»¥ä½¿ç”¨bindé…ç½®æŒ‡ä»¤æ¥ç›‘å¬ä¸€ä¸ªæˆ–å¤šä¸ªé€‰å®šçš„ç½‘ç»œæ¥å£ï¼Œåœ¨bindåæ‹¼æ¥ä¸€ä¸ªæˆ–å¤šä¸ªIPåœ°å€å³å¯ï¼Œå¦‚bind 127.0.0.1 192.168.56.101ã€‚bindå‚æ•°é…ç½®é‡Œé¢ç»‘å®šçš„æ˜¯ç½‘ç»œæ¥å£è€Œä¸æ˜¯å…·ä½“çš„å¤–éƒ¨IPåœ°å€ï¼Œè¿™ä¸€ç‚¹å¾ˆé‡è¦ï¼Œä¸èƒ½é”™è¯¯è®¤ä¸ºè¿™ä¸ªé…ç½®é¡¹çš„åŠŸèƒ½ç±»ä¼¼äºé˜²æŠ¤å¢™æˆ–è€…ç™½åå•æä¾›çš„åŠŸèƒ½ã€‚127.0.0.1å…¶å®å¯¹åº”çš„ç½‘ç»œæ¥å£æ˜¯æœ¬åœ°çš„å›ç¯ç½‘å¡ï¼Œä¸‹é¢æ˜¯ç¬”è€…è™šæ‹Ÿæœºçš„ç½‘å¡ä¿¡æ¯ï¼š protected-modeï¼šé»˜è®¤å€¼ä¸ºyesã€‚ protected-modeé…ç½®è¡¨ç¤ºä¿æŠ¤æ¨¡å¼æ˜¯å¦å¼€å¯ï¼ŒæŒ‡å®šä¸ºyesè¡¨ç¤ºä¸ºå¼€å¯ä¿æŠ¤æ¨¡å¼ï¼ŒæŒ‡å®šä¸ºnoè¡¨ç¤ºå…³é—­ã€‚å¼€å¯ä¿æŠ¤æ¨¡å¼ä¹‹åï¼Œå¦‚æœbindé…ç½®é¡¹æ²¡æœ‰ç»‘å®šä¸€äº›åˆ—çš„åœ°å€å¹¶ä¸”æ²¡æœ‰é…ç½®è®¤è¯å¯†ç requirepassï¼Œé‚£ä¹ˆRedisæœåŠ¡åªå…è®¸é€šè¿‡æœ¬åœ°å›ç¯åœ°å€127.0.0.1(IPV4)å’Œ::1(IPV6)è®¿é—®ã€‚ åœ¨ä¸ªäººå¼€å‘ç¯å¢ƒä¸­ï¼Œä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œå¯ä»¥ä¸è®¾ç½®å¯†ç ï¼Œå»æ‰ç½‘ç»œé™åˆ¶å’Œä¿æŠ¤æ¨¡å¼ï¼š 12protected-mode nobind 0.0.0.0 ä¸Šé¢çš„é…ç½®åˆ‡å‹¿åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ã€‚ ä¸Šé¢çš„é…ç½®åˆ‡å‹¿åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ã€‚ ä¸Šé¢çš„é…ç½®åˆ‡å‹¿åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ã€‚ å°ç»“ å¦‚æœå±æ€§Linuxçš„ç›¸å…³å‘½ä»¤ï¼ŒRediså•æœºæœåŠ¡æ­å»ºæ˜¯æ¯”è¾ƒç®€å•çš„ã€‚RedisæœåŠ¡çš„é…ç½®æ–‡ä»¶ä¸­é…ç½®é¡¹æå¤šï¼Œä¸€æ—¶é—´ä¸å¯èƒ½å…¨éƒ¨åˆ—å‡ºï¼Œä½†æ˜¯å¸¸ç”¨çš„é…ç½®å¿…é¡»æ¸…æ¥šå…¶çš„ä½œç”¨ã€‚ä¸‹ä¸€ç¯‡æ–‡ç« ä¼šè¯¦ç»†ä»‹ç»Redis5.xçš„å“¨å…µæ­å»ºè¿‡ç¨‹ä»¥åŠé‡åˆ°çš„é—®é¢˜ã€‚ ï¼ˆæœ¬æ–‡å®Œ c-1-d e-a-20191005ï¼‰","categories":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/categories/Middleware/"},{"name":"Redis","slug":"Middleware/Redis","permalink":"http://throwable.club/blog/categories/Middleware/Redis/"}],"tags":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/tags/Middleware/"},{"name":"Redis","slug":"Redis","permalink":"http://throwable.club/blog/tags/Redis/"}]},{"title":"é’¢é“å®…çš„å›½åº†è€å¹¿å·å°é£Ÿä¹‹æ—…","slug":"national-day-2019-travel","date":"2019-10-03T11:07:12.000Z","updated":"2019-10-06T02:00:23.808Z","comments":true,"path":"2019/10/03/national-day-2019-travel/","link":"","permalink":"http://throwable.club/2019/10/03/national-day-2019-travel/","excerpt":"èƒŒæ™¯ å›½åº†é•¿å‡ç®—æ˜¯è¿‡åŠï¼Œå®…äº†ä¸¤å¤©æ„Ÿè§‰æ²¡ä»€ä¹ˆä½œä¸ºï¼Œå¤©å¤©ç¡åˆ°ä¸­åˆï¼Œç„¶ååƒåˆé¥­ï¼ˆä¸å‡ºé—¨ï¼Œåƒå¤–å–ï¼‰ï¼Œåˆé¥­ååˆç¡åˆ°æ™šé¤æ—¶é—´åƒç¬¬äºŒé¡¿å¤–å–ã€‚å¿ƒé‡Œæ„Ÿè§‰æœ‰ç‚¹å’¸é±¼ã€‚ æƒ³äº†ä¸‹ï¼Œè¿™æ ·ä¸‹å»ä¸è¡Œï¼Œå¿…é¡»å‡ºå»èµ°èµ°ï¼Œåšä¸€æ¡æ´»åŠ¨çš„ä¸é‚£ä¹ˆå’¸çš„å’¸é±¼ã€‚äºæ˜¯2019å¹´10æœˆ2æ—¥å‡Œæ™¨æ‰¾äº†ä¸€äº›è€å¹¿å·å°é£Ÿæ”»ç•¥ï¼Œä»é‡Œé¢æŒ‘å‡ºä¸€äº›æƒ³åƒçš„æˆ–è€…æ–°å¥‡çš„ä¸œä¸œï¼ˆå’¸é±¼å¯¹ç©çš„å’Œçœ‹çš„æä¸èµ·å…´è¶£ï¼Œè€Œå¯¹åƒçš„å…´è¶£æ¯”è¾ƒå¤§ï¼‰ã€‚å‚è€ƒäº†ä¸‹é¢ä¸¤ä¸ªå¸–å­ï¼š å²ä¸Šæœ€å¼ºå¹¿å·è€å­—å·æ”»ç•¥ï¼ŒåŠ¡å¿…å¸¦ä¸Šä½ 256Gçš„èƒƒ å¹¿å·è¥¿åè·¯è”ææ¹¾æ¢åº—7æ¬¡ä»¥ä¸Šç¾é£Ÿæ”»ç•¥ æ•´ç†äº†å‡ ä¸ªçªç„¶æƒ³å»è¯•è¯•çš„åº—ï¼š æ—©ä¸Šèµ·æ¥ä¸´æ—¶å†™çš„å¤‡å¿˜å½•ï¼Œå‡†å¤‡äº†ä¸€ä¸‹å°±éšç¼˜å‡ºå‘ã€‚","text":"èƒŒæ™¯ å›½åº†é•¿å‡ç®—æ˜¯è¿‡åŠï¼Œå®…äº†ä¸¤å¤©æ„Ÿè§‰æ²¡ä»€ä¹ˆä½œä¸ºï¼Œå¤©å¤©ç¡åˆ°ä¸­åˆï¼Œç„¶ååƒåˆé¥­ï¼ˆä¸å‡ºé—¨ï¼Œåƒå¤–å–ï¼‰ï¼Œåˆé¥­ååˆç¡åˆ°æ™šé¤æ—¶é—´åƒç¬¬äºŒé¡¿å¤–å–ã€‚å¿ƒé‡Œæ„Ÿè§‰æœ‰ç‚¹å’¸é±¼ã€‚ æƒ³äº†ä¸‹ï¼Œè¿™æ ·ä¸‹å»ä¸è¡Œï¼Œå¿…é¡»å‡ºå»èµ°èµ°ï¼Œåšä¸€æ¡æ´»åŠ¨çš„ä¸é‚£ä¹ˆå’¸çš„å’¸é±¼ã€‚äºæ˜¯2019å¹´10æœˆ2æ—¥å‡Œæ™¨æ‰¾äº†ä¸€äº›è€å¹¿å·å°é£Ÿæ”»ç•¥ï¼Œä»é‡Œé¢æŒ‘å‡ºä¸€äº›æƒ³åƒçš„æˆ–è€…æ–°å¥‡çš„ä¸œä¸œï¼ˆå’¸é±¼å¯¹ç©çš„å’Œçœ‹çš„æä¸èµ·å…´è¶£ï¼Œè€Œå¯¹åƒçš„å…´è¶£æ¯”è¾ƒå¤§ï¼‰ã€‚å‚è€ƒäº†ä¸‹é¢ä¸¤ä¸ªå¸–å­ï¼š å²ä¸Šæœ€å¼ºå¹¿å·è€å­—å·æ”»ç•¥ï¼ŒåŠ¡å¿…å¸¦ä¸Šä½ 256Gçš„èƒƒ å¹¿å·è¥¿åè·¯è”ææ¹¾æ¢åº—7æ¬¡ä»¥ä¸Šç¾é£Ÿæ”»ç•¥ æ•´ç†äº†å‡ ä¸ªçªç„¶æƒ³å»è¯•è¯•çš„åº—ï¼š æ—©ä¸Šèµ·æ¥ä¸´æ—¶å†™çš„å¤‡å¿˜å½•ï¼Œå‡†å¤‡äº†ä¸€ä¸‹å°±éšç¼˜å‡ºå‘ã€‚ å‡ºå‘ 2019å¹´10æœˆ3æ—¥ç¡åˆ°æ¥è¿‘è‡ªç„¶é†’ï¼Œæ—©ä¸Š9ç‚¹å¤šè®°å½•äº†å‡ ä¸ªå°é£Ÿåº—çš„åæ ‡ä¹‹åï¼Œ10ç‚¹å·¦å³å¼€å§‹å‡ºå‘ã€‚ å‘ä¸¤å¼ é’¢é“å®…æ‰€ä½å°åŒºé£æ™¯ç…§ï¼Œå¤©æ°”å¾ˆå¥½ï¼Œå‡ºé—¨çš„æ—¶å€™æ¯”è¾ƒå‡‰å¿«ï¼Œå…‰ç…§å¼ºåº¦èˆ’é€‚ã€‚ç›´å¥”åœ°é“ç«™ä¸Šè½¦ï¼Œåˆšå¥½ç›®çš„åœ°éƒ½åœ¨1å·çº¿ï¼Œä¸‰ä¸ªç«™çš„æ˜¯ç›¸è¿çš„ã€‚ ç¬¬ä¸€ç«™ï¼šæ— åé¸¡æ‚æ±¤ ä»å¹¿å·åœ°é“1å·çº¿é™ˆå®¶ç¥ åœ°é“ç«™Cå‡ºå£èµ°å‡ºæ¥ï¼Œå†ç”¨åœ°å›¾è½¯ä»¶æœä¸€ä¸‹å°åº—çš„å…·ä½“åœ°å€ã€‚å°è±¡ä¸­æ˜¯ç©¿è¿‡ä¸€ä¸ªçº¢ç»¿ç¯ï¼Œå†æ²¿ç€ä¸€ä¸ªå›´å¢™èµ°å‡ ç™¾ç±³å·¦è½¬åˆ°ä¸€ä¸ªå°å··å­å°±åˆ°äº†ã€‚ç¬¬ä¸€ç«™é€‰æ— åé¸¡æ‚æ±¤æ˜¯å› ä¸ºä¼ é—»è¯¥åº—ä¸€å¤©åªç…®ä¸€é”…é¸¡æ‚æ±¤ï¼Œä¸€é”…çŒªçº¢æ±¤ï¼Œæ—©ä¸Š11ç‚¹å¼€åº—ï¼Œå–å®Œå°±æ”¶æ‘Šã€‚æ‰€ä»¥ï¼Œæœ€å¥½èµ¶åœ¨ä¸­åˆä¹‹å‰åˆ°åº—å»è§…é£Ÿã€‚ æ— åé¸¡æ‚æ±¤ï¼Œä¸€èˆ¬åˆå«å¤«å¦»æ¡£é¸¡ä»€çŒªçº¢æ±¤ï¼Œå…¶å®è¯¥å°åº—æ˜¯æ²¡æœ‰åº—åçš„ã€‚å°åº—ç»è¥20å¤šå¹´ï¼Œåå¹³çš„å°å±‹ï¼Œä¸Šäº†å¹´çºªçš„ä¸¤å¤«å¦»ï¼Œä¼ é—»å¤«è´Ÿè´£ç†¬æ±¤ï¼Œå¦»è´Ÿè´£å–æ±¤ã€‚ å’¸é±¼åˆšè½¬å…¥å°å··ï¼Œå°±çœ‹åˆ°å°åº—é—¨å£æ”¾ç€å¾ˆå¤šå¡‘æ–™å‡³å­ï¼Œå¾ˆå°‘ç”·å¥³è€å°‘å°±ååœ¨é—¨å£çš„å¡‘æ–™å‡³ä¸Šï¼Œä¸é¡¾å½¢è±¡åœ°å–æ±¤ã€‚ èµ°åˆ°åº—é‡Œå‡†å¤‡ç‚¹å•ï¼Œå‘ç°äº†å°åº—åªæ”¶ç°é‡‘ï¼Œä¸èƒ½ç½‘é“¶ã€å¾®ä¿¡æˆ–è€…æ”¯ä»˜å®æ”¯ä»˜ã€‚çœ‹äº†çœ‹å¢™ä¸Šè´´ç€çš„çº¸çš®ï¼Œå‘ç°è¿æ°”æ¯”è¾ƒå¥½ï¼Œæ˜å¤©å’Œåå¤©å°åº—ä¼‘æ¯ã€‚ æ’é˜Ÿçš„æ—¶å€™ï¼Œèº«åçš„çƒ­å¿ƒé˜¿å§¨å¸®æˆ‘ç”¨å¾®ä¿¡æ”¯ä»˜å…‘æ¢äº†10å—é’±çš„ç°é‡‘ï¼Œäºæ˜¯ä¹°äº†ä¸€ç¢—é¸¡æ‚æ±¤ï¼ˆå’¸é±¼ä¸å–œæ¬¢çŒªçº¢â€¦ï¼‰ã€‚ é¸¡æ‚æ±¤è¶³æ–™ï¼Œé¸¡å‘³å’Œè¯æå‘³ååˆ†æµ“éƒï¼Œä¸»è¦ç”¨æ–™æ˜¯é¸¡å†…è„ã€é¸¡å­ã€çº¢æ£ã€å…šå‚ç­‰ç­‰ã€‚ä¸€ç¢—æ±¤ç®¡é¥±ã€‚è¯´å®è¯ï¼Œç°åœ¨å¹¿å·å¾ˆå°‘åœ°æ–¹èƒ½10å—é’±åƒåˆ°è¿™ä¹ˆè¶³æ–™ç¾å‘³çš„è¡¥å“ã€‚ åº—åï¼šæ— å åœ°å€ï¼šä¸­å±±ä¸ƒè·¯220å·ï¼ˆå¹¿å·åœ°é“1å·çº¿é™ˆå®¶ç¥ Cå‡ºå£å†æ­¥è¡Œ200ç±³ï¼‰ ç‰¹è‰²ï¼š20å¹´è€å­—å·åº—ï¼Œåªå–ä¸¤æ¬¾æ±¤ï¼Œ10å—é’±çš„é¸¡æ‚æ±¤å’Œ3å—é’±çš„çŒªçº¢æ±¤ å¤‡æ³¨ï¼šå°åº—åªèƒ½ç°é‡‘æ”¯ä»˜ï¼›æ¯å¤©é™é‡ï¼›2019å¹´10æœˆ4 - 5æ—¥ä¼‘æ¯ æ¶ˆè´¹ï¼šå’¸é±¼ç”¨äº†10å—é’± ä¸‹å•çš„æ—¶å€™ï¼Œæ•´é”…é¸¡æ‚æ±¤å‰©ä¸‹å››åˆ†ä¹‹ä¸€ï¼Œåƒå®Œèµ°çš„æ—¶å€™ï¼Œåé¢è¿˜æ’ç€å¾ˆé•¿çš„é˜Ÿä¼ï¼ˆä¼°è®¡åé¢æ¥çš„äººéƒ½æ²¡æœºä¼šäº†â€¦ï¼‰ã€‚ ç¬¬äºŒç«™ï¼šé£Ÿç›ˆç¢—ä»”ç¿… è¯´å®è¯ï¼Œåƒå®Œé¸¡æ‚æ±¤ï¼Œå·²ç»æœ‰å…­æˆé¥±ã€‚äºæ˜¯ï¼Œå’¸é±¼æ•…æ„èµ°æ…¢ç‚¹ç»•è¿œè·¯å»æ‰¾ç¢—ä»”ç¿…çš„åº—é¢ï¼Œè·¯ä¸Šé¡ºä¾¿æ¶ˆæ¶ˆè‚šå­ã€‚ä»å¹¿å·åœ°é“1å·çº¿è¥¿å®‰é—¨å£ç«™Då‡ºå£å‡ºæ¥ï¼Œèµ°å‡ ç™¾ç±³å°±èƒ½çœ‹åˆ°é‡‘å¹³å¤§å¦ã€‚é£Ÿç›ˆç¢—ä»”ç¿…åº—é¢å°±åœ¨é‡‘å¹³å¤§å¦1æ¥¼çš„è§’è½å¤„ï¼Œæ¯”è¾ƒä¸æ˜¾çœ¼ï¼Œé¢å‘è¥¿åè·¯å’Œé‡‘èŠ±ç›´è¡—çš„äº¤ç•Œå¤„åå­—è·¯å£ã€‚ åº—é“ºé—¨å£æ¯”è¾ƒå°ï¼Œé‡Œé¢çš„ç©ºé—´è¿˜ç®—æ¯”è¾ƒå®½æ•ã€‚åˆšå¥½ç‚¹å•çš„æ—¶å€™æ˜¯ä¸­åˆï¼Œäººä¸ç®—å¤šã€‚èœå“ä¸»è¦æœ‰ï¼šäººæ¯”èŠ±èƒ¶ç¿…ã€æ¤°çš‡å†»ã€è›‹é»„ç²½ã€å’–å•¡ç­‰ç­‰ã€‚å…¶ä¸­ï¼Œäººæ¯”èŠ±èƒ¶ç¿…ç®—æ˜¯æ˜æ˜Ÿäº§å“ï¼Œäºæ˜¯ç‚¹äº†ä¸ª26å—çš„äººæ¯”èŠ±èƒ¶ç¿… + æŸ ä¸ƒå¥—é¤ã€‚ ä¸Šèœçš„æ—¶å€™ç”¨çš„æ˜¯ä¸€æ¬¡æ€§çš„å¡‘æ–™ç¢—ã€‚ç¬¬ä¸€å£åƒä¸‹å»æ„Ÿè§‰æ˜¯ååˆ†æµ“éƒçš„é²œå‘³ï¼Œå®é™…ä¸Šæ•´ç¢—æ˜¯ç”¨èŸ¹å­ã€èŠ±èƒ¶ã€ç‘¶æŸ±ã€é±¼ç¿…ã€è¹„ç­‹ã€æ¡‚åœ†ç­‰ç†¬å‡ºæ¥çš„æµ“æ±¤ï¼Œæ‰€æœ‰é£Ÿæç†¬çš„æ—¶é—´éƒ½æ¯”è¾ƒé•¿ï¼Œå…¥å£æ„Ÿè§‰æ¯”è¾ƒä¸æ»‘ã€‚å¯èƒ½ç¾ä¸­ä¸è¶³çš„æ˜¯ï¼Œæ„Ÿè§‰æ”¾äº†å¤ªå¤šè°ƒå‘³æ–™ï¼Œè°ƒå‘³æ–™çš„å‘³é“æœ‰ç‚¹æ©ç›–äº†é£Ÿææœ¬èº«çš„é²œå‘³ï¼Œè€Œä¸”åƒèµ·æ¥æ„Ÿè§‰å¾ˆè…»ã€‚å¦‚æœä½ æ²¡åƒè¿‡ç¢—ä»”ç¿…ï¼Œç¬¬ä¸€å£åº”è¯¥ä¼šè¢«æƒŠè‰³åˆ°ã€‚ åº—åï¼šé£Ÿç›ˆç¢—ä»”ç¿… åœ°å€ï¼šè¥¿åè·¯é‡‘å¹³å¤§å¦æ˜Ÿçºå¹¿åœº1152é“ºï¼ˆå¹¿å·åœ°é“1å·çº¿è¥¿é—¨å£ç«™Då‡ºå£èµ°å‡ ç™¾ç±³ï¼‰ ç‰¹è‰²ï¼šé•‡åº—ç¢—ä»”ç¿…ï¼Œç‰¹è‰²æ¤°çš‡å†»ï¼ˆè¿˜æ²¡è¯•è¿‡æ¤°çš‡å†»ï¼Œä¸‹æ¬¡å»è¯•è¯•ï¼‰ å¤‡æ³¨ï¼šæ—  æ¶ˆè´¹ï¼šå’¸é±¼ç”¨äº†26å—é’± ä¸­åœºä¼‘æ¯é—²é€› åƒå®Œç¢—ä»”ç¿…æ„Ÿè§‰æœ‰ç‚¹è…»ï¼Œæš‚æ—¶ä¸å»ä¸‹ä¸€ç«™ï¼Œå…ˆé€›ä¸€ä¸‹è¥¿åè·¯ã€‚è¥¿åè·¯å¾ˆæœ‰è€å¹¿å·çš„ç‰¹è‰²ï¼Œè¡—é“ä¸å®½å¹¿ï¼Œæ•´è¡—ä¸é•¿ï¼Œè€Œä¸”ä¸¤æ—çš„å»ºç­‘éƒ½æ¯”è¾ƒä½çŸ®ï¼Œæ¥¼é¾„åº”è¯¥éƒ½æ¯”è¾ƒå¤§ã€‚å°é£Ÿåº—æ¯”è¾ƒå¤šï¼Œä¸€é—´æŒ¨ç€ä¸€é—´çš„ã€‚ä¾‹å¦‚è¡—å¤´å°±æœ‰ä¸€é—´æ¯”è¾ƒå¤§çš„ç²¥é“ºï¼Œä¸­åˆäº†è¿˜å¾ˆå¤šäººåœ¨åº—é‡Œåƒç²¥ã€‚è¡—å¤´è¿˜çœ‹åˆ°ä¸€é—´æ¯”è¾ƒå‡ºåçš„ç”Ÿç…åº—ï¼š é—¨å£çš„åº”è¯¥å°±æ˜¯ç»„é˜Ÿä¸“é—¨è¿‡æ¥åƒç”Ÿç…çš„ã€‚åœ¨è·¯çš„ä¸­æ®µè¿˜æœ‰ä¸€å®¶æ¯”è¾ƒå‡ºåçš„èŠéº»ç³Šåº—é“ºï¼š åœ¨è¡—å°¾è¿˜æœ‰å¾ˆå‡ºåçš„èŠ³è®°å°é£Ÿåº—ï¼š æ•´æ¡è¡—çš„ç”Ÿæ´»èŠ‚å¥å¾ˆæ…¢ï¼Œå¹¿åœºæœ‰å¸­åœ°è€Œåä¸‹æ£‹çš„è€å¤§çˆ·ï¼Œè¿˜æœ‰åœ¨åœ°ä¸Šæ‘†æ‘Šå–èœçš„å¤§å¦ˆï¼Œæœ‰æ¨ç€æ‰‹æ¨è½¦å«å–çš„å°ä¼™ï¼Œè¿˜æœ‰å¾ˆå¤šåƒæˆ‘è¿™æ ·æ…•åè€Œæ¥è§…é£Ÿã€ä¸æ˜¯å’¸é±¼çš„å°‘ç”·å°‘å¥³ã€‚ç”Ÿæ´»èŠ‚å¥æ…¢æ‰é€‚åˆç”Ÿæ´»ï¼Œåœ¨è¿™é‡Œæ¸¸è¡åƒå–ï¼Œå¯ä»¥æš‚æ—¶å¿˜è®°å·¥ä½œæ—¥æˆ–è€…åŒä¼‘åŒ†åŒ†å¿™å¿™ä¹°æ—©é¤æŒ¤åœ°é“çš„æ—¥å­ï¼ŒçœŸæ˜¯æŒºèˆ’é€‚æ„‰å¿«çš„ã€‚ ç¬¬ä¸‰ç«™ï¼šç‰›ä½¬ç‰›æ‚æ±¤ ç‰›ä½¬ç‰›æ‚æ±¤çš„åº—é¢å…¶å®å°±åœ¨é£Ÿç›ˆç¢—ä»”ç¿…çš„é™„è¿‘ã€‚å¼„ä¸€å¼ çµé­‚ç”»å›¾ï¼š æ­£åˆæ—¶åˆ†ï¼Œåƒå®¢å¾ˆå¤šï¼Œåˆè¦æ’é˜Ÿã€‚ æ’äº†æ¥è¿‘20åˆ†é’Ÿï¼Œç‚¹äº†ä¸€ä»½èåœç‰›æ‚ï¼Œ19å—ã€‚å¾ˆå¤šé£Ÿå®¢ç›´æ¥åœ¨è¿™é‡Œåƒåˆé¤ï¼Œå…¶ä»–èœå“æœ‰ç‰›ä¸‰æ˜Ÿï¼ˆæœ¬æ¥åº”è¯¥ç‚¹è¿™ä¸ªæ‰å¯¹ï¼Œä¼ é—»ä¸­æ˜¯æ‹›ç‰Œï¼‰å’Œç‰›æ‚æ±¤ç²‰é¢ç­‰ç­‰ã€‚ é¦–å…ˆï¼Œèåœç‰›æ‚ä¸­ç‰›è‚šå±…å¤šï¼ˆæˆ‘è¿™ä»½å¥½åƒåªæœ‰ä¸€å—ç‰›è‚‰ï¼Œå…¶ä»–å…¨æ˜¯ç‰›è‚šå’Œèåœï¼‰ï¼Œåƒä¸€å£æ„Ÿè§‰ç¿»è½¦äº†ã€‚å’¸é±¼å£å‘³åå‘äºæ¸…æ·¡ï¼Œç‰›æ‚åå’¸ï¼Œä¸è¿‡å£æ„Ÿæ¯”è¾ƒå«©å’Œè½¯ï¼Œåº”è¯¥æ˜¯ç†¬è¶³æ—¶é—´ã€‚ä¸çŸ¥é“æ˜¯ä¸æ˜¯ä¹‹å‰åƒå¾—å¤ªé¥±ï¼Œè¿™ä¸€å®¶çš„ç‰›æ‚ä¸ªäººæ„Ÿè§‰æ²¡æœ‰è®©äººçœ¼å‰ä¸€äº®çš„æ„Ÿè§‰ï¼Œå»ºè®®å°è¯•ä¸€ä¸‹ç‰›ä¸‰æ˜Ÿå’Œç‰›æ‚æ±¤ç²‰ã€‚ åº—åï¼šç‰›ä½¬ç‰›æ‚æ±¤ åœ°å€ï¼šè¥¿åè·¯ä¸é‡‘èŠ±ç›´è¡—äº¤ç•Œå£å¤„é‡‘èŠ±åº™åè¡—3å·ï¼ˆå¹¿å·åœ°é“1å·çº¿è¥¿é—¨å£ç«™Då‡ºå£èµ°å‡ ç™¾ç±³ï¼‰ ç‰¹è‰²ï¼šèåœç‰›æ‚19å—ä¸€ä»½ï¼Œå…¶ä»–èœå“10å‡ å—ä¸€ä»½ å¤‡æ³¨ï¼šå£å‘³åå’¸ï¼Œåƒæƒ¯æ¸…æ·¡çš„å¯èƒ½ä¸é€‚åº” æ¶ˆè´¹ï¼šå’¸é±¼ç”¨äº†19å—é’± ç¬¬å››ç«™ï¼šé¡ºè®°å†°å®¤ åƒå®Œç‰›æ‚ï¼Œä¸Šåœ°é“å‘é•¿å¯¿è·¯è¿›å‘ï¼Œè¦åƒç‚¹ç”œå“æ¶ˆæ¶ˆè…»æ°”ã€‚æ—§æ—¶å€™ï¼Œè€å¹¿ä¸œäººä¸€èˆ¬ç§°å–ç³–æ°´æˆ–è€…åƒç”œå“ä¸ºé¥®å†°ï¼Œé‚£ä¸ªæ—¶å€™åœ°é“çš„ç”œå“åº—ä¸€èˆ¬å«åšå†°å®¤ã€‚è€Œé•¿å¯¿è·¯çš„é¡ºè®°å†°å®¤å°±æ˜¯ä¸€é—´è€å­—å·çš„ç”œå“åº—ï¼Œå°è±¡ä¸­å‡ å¹´å‰è¿˜åœ¨è¯»å¤§å­¦çš„æ—¶å€™å°±å»è¿‡ä¸€æ¬¡ã€‚å…ˆé™„ä¸Šä¸€å¼ çµé­‚ç”»å›¾çš„åœ°å›¾ï¼š å¤©æ°”ç‚çƒ­ï¼Œé¥®å†°çš„äººç‰¹åˆ«å¤šã€‚å¦å¤–ï¼Œå®åè·¯çš„é£æ ¼å’Œè¥¿åè·¯å®Œå…¨ä¸ä¸€æ ·ï¼Œç®€ç›´æ˜¯åŠ¨å¦‚è„±å…”å’Œé™å¦‚å¤„å­çš„åŒºåˆ«ï¼Œæ•´æ¡è¡—éƒ½å¡æ»¡äº†å¹´è½»çš„ç”·å¥³ï¼Œè·¯å†µæ¯”è¾ƒå¤æ‚ï¼Œå‡ºæ¸¸çš„æ—¶å€™éœ€è¦å°½é‡æ³¨æ„å®‰å…¨ã€‚èµ°äº†ä¸ä¹…å°±åˆ°äº†é¡ºè®°å†°å®¤çš„åº—é¢ï¼š è¯´å®è¯ï¼Œåº—é‡Œé‡Œé¢ä¹Ÿå¡æ»¡äº†äººï¼Œå¾ˆå¤šäººç«™ç€ç­‰ä½ç½®ï¼ˆæƒ…ä¾£å±…å¤šï¼‰ã€‚ç”±äºå’¸é±¼å•èº«ï¼ŒæŒ¤è¿›å»åº—é‡Œé¢å¾ˆå¿«å°±è®©åº—å‘˜å®‰æ’æ‹¼æ¡Œã€‚å…ˆçœ‹çœ‹èœç‰Œå¦‚ä¸‹ï¼š æ¬¾å¼ååˆ†ä¸°å¯Œã€‚æƒ³äº†ä¸‹å°æ—¶å€™ç»å¸¸åƒåŒè‰²é›ªçƒï¼ŒåŠ ä¸Šå¤©æ°”ç‡¥çƒ­ï¼Œç‚¹äº†ä¸ªæ¦´è²æ¤°å­åŒè‰²é›ªçƒï¼ˆ25å—ï¼‰å’Œä¸€ä¸ªç‚¼å¥¶é¾Ÿè‹“è†ï¼ˆ9å—ï¼‰ã€‚ç­‰äº†å¾ˆé•¿æ—¶é—´æ‰ä¸Šèœï¼š å‘³é“å¾ˆå¥½ï¼Œé›ªç³•è½¯æ»‘ï¼Œæ¦´è²å’Œæ¤°å­çš„é¦™å‘³æµ“éƒï¼Œé¾Ÿè‹“è†çš„å‘³é“ç®—æ˜¯æ­£å®—ã€‚ä¸è¿‡æ„Ÿè§‰ç”œåº¦ä¸å¤Ÿï¼Œæ¯•ç«Ÿå’¸é±¼å¹³æ—¶ç‚¹å–œèŒ¶å¿…é¡»å‹¾é€‰å¤šç³–çš„é€‰é¡¹ï¼Œå¯èƒ½å’Œä¸ªä½“å¯¹ç”œåº¦çš„è€å—æ€§æœ‰å…³ã€‚ åº—åï¼šé¡ºè®°å†°å®¤ åœ°å€ï¼šå®åè·¯ä¸­æ®µï¼ˆå¹¿å·åœ°é“1å·çº¿é•¿å¯¿è·¯ç«™D2å‡ºå£èµ°å‡ ç™¾ç±³ï¼‰ ç‰¹è‰²ï¼šç§ç±»ä¸°å¯Œçš„ç”œå“ï¼Œè¿˜æœ‰ç²¥ç²‰é¢é¥­ç­‰æ­£é¤ å¤‡æ³¨ï¼šäººå¤ªå¤šï¼Œéœ€è¦æ‹¼åº§ æ¶ˆè´¹ï¼šå’¸é±¼ç”¨äº†34å—é’± æœ€åä¸€ç«™ï¼šé™ˆæ·»è®° é™ˆæ·»è®°å°±åœ¨é¡ºè®°å†°å®¤é™„è¿‘ï¼Œåœ¨ä¸€ä¸ªå°å··å­æ‹è¿›å»å°±èƒ½çœ‹åˆ°ã€‚æœ‰ä¸ªå¾ˆå¤§çš„é—®é¢˜å°±æ˜¯é£Ÿå®¢å¤ªå¤ªå¤ªå¤šäº†ï¼Œå’¸é±¼å½“æ—¶åœ¨æ’é˜Ÿï¼Œæ‹äº†ç…§çœ‹çœ‹æ’é˜Ÿçš„é•¿é¾™ï¼š ä¸€ä½ç–‘ä¼¼è€æ¿çš„å¤§å”è¿˜è¦å‡ºæ¥ç»´æŒç§©åºã€‚é‰´äºå®¤å¤–å¤©æ°”ç‚çƒ­ï¼Œäººå‘˜å¤ªå¯†é›†ï¼Œå’¸é±¼é€‰æ‹©æ‰“åŒ…ä¸€ä»½å‡‰æ‹Œé±¼çš®ï¼ˆ25å—ï¼‰ã€‚ ä¸å¾—ä¸è¯´ï¼Œé™ˆæ·»è®°çš„é±¼çš®ç¡®å®çˆ½è„†å¼¹ç‰™ï¼Œå£æ„Ÿæ¯”è¾ƒç‹¬ç‰¹ï¼ŒèŠéº»æ²¹ç‰¹åˆ«é¦™ï¼ŒåŠ ä¸Šçˆ†ç‚’çš„èŠ±ç”Ÿä»å’Œé…æ–™ï¼Œå¤šåƒä¹Ÿä¸ä¼šè…»ï¼Œéš¾æ€ªè¿™ä¹ˆå¤šäººæ’é˜Ÿã€‚ åº—åï¼šé™ˆæ·»è®° åœ°å€ï¼šå®åè·¯ä¸­æ®µå°å··å­ï¼ˆå¹¿å·åœ°é“1å·çº¿é•¿å¯¿è·¯ç«™D2å‡ºå£èµ°å‡ ç™¾ç±³ï¼‰ ç‰¹è‰²ï¼šç‰¹è‰²å‡‰æ‹Œé±¼çš®å’Œå…¶ä»–å°é£Ÿ å¤‡æ³¨ï¼šäººå¤ªå¤ªå¤ªå¤šï¼Œå ‚é£Ÿç¯å¢ƒæ¯”è¾ƒä¸€èˆ¬ æ¶ˆè´¹ï¼šå’¸é±¼ç”¨äº†25å—é’± ç»“æŸ å¸¦ç€é¼“èµ·çš„è‚šå­å›åˆ°å®¶é‡Œå·²ç»æ¥è¿‘å‚æ™šï¼Œåƒè¶³ä¸€å¤©çš„èŠ±é”€ä¸è¶…è¿‡200å—ï¼Œæ—¢èƒ½æ»¡è¶³èƒƒå£ï¼Œå“å°ä¸€ä¸‹è€å¹¿å·çš„ç‰¹è‰²ç¾é£Ÿï¼Œåˆå¯èƒ½æ”¾æ¾ä¸€ä¸‹åšä¸€æ¡æ´»è·ƒçš„å’¸é±¼ï¼Œæš‚æ—¶å¿˜è®°ç´§å¼ çš„å·¥ä½œç”Ÿæ´»ï¼ŒçœŸæ˜¯å¾ˆå¼€å¿ƒã€‚è¿™é‡Œåšä¸€ä¸ªç®€å•çš„è¡¨æ ¼ï¼Œä»…ä»…ä»£è¡¨ä¸ªäººçš„è§’åº¦ï¼ˆå’¸é±¼æ²¡å¿…è¦ä¸ºè¿™äº›åº—æ‰“å¹¿å‘Šï¼Œåªåœ¨ä¹è‡ªå·±çš„æ„Ÿå—ï¼‰ï¼š åœ°ç‚¹ æ— åé¸¡æ‚æ±¤ é£Ÿç›ˆç¢—ä»”ç¿… ç‰›ä½¬ç‰›æ‚æ±¤ é¡ºè®°å†°å®¤ é™ˆæ·»è®° äººå‡æ¶ˆè´¹ï¼ˆå…ƒï¼‰ 10 20+ 20 30+ 25+ æ¨èæŒ‡æ•°ï¼ˆå‡è®¾æ»¡ä¸º5ï¼‰ 5 4 3 4.5 5 åŠæ—¶è¡Œä¹ï¼Œä½•ä¸å¿«å“‰ï¼Ÿ ï¼ˆæœ¬æ–‡å®Œ c-1-d e-a-20191003 å›½åº†å¿«ä¹(*^â–½^*)ï¼‰","categories":[{"name":"Life","slug":"Life","permalink":"http://throwable.club/blog/categories/Life/"}],"tags":[{"name":"Life","slug":"Life","permalink":"http://throwable.club/blog/tags/Life/"}]},{"title":"ä¸€ä¸ªä½çº§é”™è¯¯å¼•å‘Nettyç¼–ç è§£ç ä¸­æ–‡å¼‚å¸¸","slug":"netty-codec-chinese-exception","date":"2019-10-03T01:05:34.000Z","updated":"2019-10-03T01:34:15.489Z","comments":true,"path":"2019/10/03/netty-codec-chinese-exception/","link":"","permalink":"http://throwable.club/2019/10/03/netty-codec-chinese-exception/","excerpt":"å‰è¨€ æœ€è¿‘åœ¨è°ƒç ”Nettyçš„ä½¿ç”¨ï¼Œåœ¨ç¼–å†™ç¼–ç è§£ç æ¨¡å—çš„æ—¶å€™é‡åˆ°äº†ä¸€ä¸ªä¸­æ–‡å­—ç¬¦ä¸²ç¼–ç å’Œè§£ç å¼‚å¸¸çš„æƒ…å†µï¼Œåæ¥å‘ç°æ˜¯ç¬”è€…çŠ¯äº†ä¸ªä½çº§é”™è¯¯ã€‚è¿™é‡Œåšä¸€ä¸ªå°å°çš„å›é¡¾ã€‚","text":"å‰è¨€ æœ€è¿‘åœ¨è°ƒç ”Nettyçš„ä½¿ç”¨ï¼Œåœ¨ç¼–å†™ç¼–ç è§£ç æ¨¡å—çš„æ—¶å€™é‡åˆ°äº†ä¸€ä¸ªä¸­æ–‡å­—ç¬¦ä¸²ç¼–ç å’Œè§£ç å¼‚å¸¸çš„æƒ…å†µï¼Œåæ¥å‘ç°æ˜¯ç¬”è€…çŠ¯äº†ä¸ªä½çº§é”™è¯¯ã€‚è¿™é‡Œåšä¸€ä¸ªå°å°çš„å›é¡¾ã€‚ é”™è¯¯é‡ç° åœ¨è®¾è®¡Nettyçš„è‡ªå®šä¹‰åè®®çš„æ—¶å€™ï¼Œå‘ç°äº†å­—ç¬¦ä¸²ç±»å‹çš„å±æ€§ï¼Œä¸€æ—¦å‡ºç°ä¸­æ–‡å°±ä¼šå‡ºç°è§£ç å¼‚å¸¸çš„ç°è±¡ï¼Œè¿™ä¸ªå¼‚å¸¸å¹¶ä¸ä¸€å®šå‡ºç°äº†Exceptionï¼Œè€Œæ˜¯å‡ºç°äº†è§£ç ä¹‹åå­—ç¬¦æˆªæ–­å‡ºç°äº†äººç±»ä¸å¯è¯»çš„å­—ç¬¦ã€‚ç¼–ç å’Œè§£ç å™¨çš„å®ç°å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041// å®ä½“@Datapublic class ChineseMessage implements Serializable &#123; private long id; private String message;&#125;// ç¼–ç å™¨ - &lt;é”™è¯¯ç¤ºèŒƒï¼Œä¸è¦æ‹·è´&gt;public class ChineseMessageEncoder extends MessageToByteEncoder&lt;ChineseMessage&gt; &#123; @Override protected void encode(ChannelHandlerContext ctx, ChineseMessage target, ByteBuf out) throws Exception &#123; // å†™å…¥ID out.writeLong(target.getId()); String message = target.getMessage(); int length = message.length(); // å†™å…¥Messageé•¿åº¦ out.writeInt(length); // å†™å…¥Messageå­—ç¬¦åºåˆ— out.writeCharSequence(message, StandardCharsets.UTF_8); &#125;&#125;// è§£ç å™¨public class ChineseMessageDecoder extends ByteToMessageDecoder &#123; @Override protected void decode(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out) throws Exception &#123; // è¯»å–ID long id = in.readLong(); // è¯»å–Messageé•¿åº¦ int length = in.readInt(); // è¯»å–Messageå­—ç¬¦åºåˆ— CharSequence charSequence = in.readCharSequence(length, StandardCharsets.UTF_8); ChineseMessage message = new ChineseMessage(); message.setId(id); message.setMessage(charSequence.toString()); out.add(message); &#125;&#125; ç®€å•åœ°ç¼–å†™å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä»£ç ï¼Œç„¶åç”¨å®¢æˆ·ç«¯æœåŠ¡ç«¯å‘é€ä¸€æ¡å¸¦ä¸­æ–‡çš„æ¶ˆæ¯ï¼š 123456// æœåŠ¡ç«¯æ—¥å¿—æ¥æ”¶åˆ°å®¢æˆ·ç«¯çš„è¯·æ±‚:ChineseMessage(id=1, message=å¼ )io.netty.handler.codec.DecoderException: java.lang.IndexOutOfBoundsException: readerIndex(15) + length(8) exceeds writerIndex(21) ......// å®¢æˆ·ç«¯æ—¥å¿—æ¥æ”¶åˆ°æœåŠ¡ç«¯çš„å“åº”:ChineseMessage(id=2, message=å¼ )io.netty.handler.codec.DecoderException: java.lang.IndexOutOfBoundsException: readerIndex(15) + length(8) exceeds writerIndex(21) ...... å…¶å®ï¼Œé—®é¢˜å°±éšè—åœ¨ç¼–ç è§£ç æ¨¡å—ä¸­ã€‚ç”±äºç¬”è€…å‰ä¸¤ä¸ªæœˆä¸€ç›´996ï¼Œåœ¨ç–¯ç‹‚ç¼–å†™CRUDä»£ç ï¼Œä¸šä½™åœ¨çœ‹Nettyçš„æ—¶å€™ï¼Œæœ‰ä¸€äº›åŸºç¡€çŸ¥è¯†ä¸€æ—¶çŸ­è·¯æ²¡æœ‰å›å¿†èµ·æ¥ã€‚ç¬”è€…å¸¦ç€è¿™ä¸ªé—®é¢˜åœ¨å„å¤§æœç´¢å¼•æ“ä¸­æœç´¢ï¼Œæœ‰å¯èƒ½æ˜¯å§¿åŠ¿ä¸å¯¹æˆ–è€…å…³é”®å­—ä¸å‡†ï¼Œæ²¡æœ‰å¾—åˆ°ç­”æ¡ˆï¼ŒåŠ ä¹‹ï¼Œå¾ˆå¤šåšå®¢æ–‡ç« éƒ½æ˜¯ç…§æ¬å…¶ä»–äººçš„Demoï¼Œè€Œè¿™äº›Demoé‡Œé¢æ°å¥½éƒ½æ˜¯ç”¨è‹±æ–‡ç¼–å†™æ¶ˆæ¯ä½“ä¾‹å­ï¼Œæ‰€ä»¥è¿™ä¸ªé—®é¢˜ä¸€æ—¶é™·å…¥äº†å›°å±€ï¼ˆ2019å¹´å›½åº†å‡æœŸä¹‹å‰å¡ä½äº†å¤§æ¦‚å‡ å¤©ï¼Œä¸šåŠ¡å¿™ä¹Ÿæ²¡æœ‰èŠ±æ—¶é—´å»æƒ³ï¼‰ã€‚ çµå…‰ä¸€ç° 2019å¹´å›½åº†å‡æœŸå‰å¤•ï¼Œç”±äºå›¢é˜Ÿä¸€ç›´åœ¨èµ¶è¿›åº¦åšä¸€ä¸ªå‰åç«¯ä¸åˆ†ç¦»çš„CRUDåå°ç®¡ç†ç³»ç»Ÿï¼Œå½“æ—¶æœ‰å‡ ä¸ªåŒäº‹åœ¨åšä¸€ä¸ªé¡µé¢çš„æ—¶å€™è®¨è®ºä¸€ä¸ªä¹±ç çš„é—®é¢˜ã€‚åœ¨ä»–ä»¬è®¨è®ºçš„è¿‡ç¨‹ä¸­ï¼Œæ— æ„è¹¦å‡ºäº†ä¸¤ä¸ªè®©ç¬”è€…çªç„¶æ¸…é†’çš„è¯è¯­ï¼šä¹±ç å’ŒUTF-8ã€‚ç¬”è€…ç¬¬ä¸€æ—¶é—´æƒ³åˆ°çš„æ˜¯åˆšç”¨Cnblogsçš„æ—¶å€™å†™è¿‡çš„ä¸€ç¯‡æ–‡ç« ï¼šã€Šå°ä¼™å­åˆä¹±ç äº†å§-Javaå­—ç¬¦ç¼–ç åŸç†æ€»ç»“ã€‹ï¼ˆç°åœ¨çœ‹èµ·æ¥æ ‡é¢˜èµ·å¾—æŒºäºŒçš„ï¼‰ã€‚å½“æ—¶æœ‰å¯¹å­—ç¬¦ç¼–ç çš„åŸç†åšè¿‡ä¸€äº›æ¢ç©¶ï¼Œæƒ³æƒ³æœ‰ç‚¹æƒ­æ„§ï¼Œ1å¹´å¤šå‰çœ‹è¿‡çš„ä¸œè¥¿å·®ä¸å¤šå¿˜è®°å¾—ä¸€å¹²äºŒå‡€ã€‚ ç›´æ¥è¯´åŸå› ï¼šUTF-8ç¼–ç çš„ä¸­æ–‡ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹ä¸€ä¸ªä¸­æ–‡å­—ç¬¦é•¿åº¦å æ®3ä¸ªå­—èŠ‚ï¼ˆ3 byteï¼Œä¹Ÿå°±æ˜¯32 x 3æˆ–è€…32 x 4ä¸ªä½ï¼‰ï¼Œè€ŒJavaä¸­å­—ç¬¦ä¸²é•¿åº¦çš„è·å–æ–¹æ³•String#length()æ˜¯è¿”å›Stringå®ä¾‹ä¸­çš„Charæ•°ç»„çš„é•¿åº¦ã€‚ä½†æ˜¯æˆ‘ä»¬å¤šæ•°æƒ…å†µä¸‹ä¼šä½¿ç”¨Nettyçš„å­—èŠ‚ç¼“å†²åŒºByteBufï¼Œè€ŒByteBufè¯»å–å­—ç¬¦åºåˆ—çš„æ–¹æ³•éœ€è¦é¢„å…ˆæŒ‡å®šè¯»å–çš„é•¿åº¦ByteBuf#readCharSequence(int length, Charset charset);ï¼Œå› æ­¤ï¼Œåœ¨ç¼–ç çš„æ—¶å€™éœ€è¦é¢„å…ˆå†™å…¥å­—ç¬¦ä¸²åºåˆ—çš„é•¿åº¦ã€‚ä½†æ˜¯æœ‰ä¸€ä¸ªéšè—çš„é—®é¢˜æ˜¯ï¼šByteBuf#readCharSequence(int length, Charset charset)æ–¹æ³•åº•å±‚ä¼šåˆ›å»ºä¸€ä¸ªlengthé•¿åº¦çš„byteæ•°ç»„ä½œä¸ºç¼“å†²åŒºè¯»å–æ•°æ®ï¼Œç”±äºUTF-8ä¸­1 char = 3 or 4 byteï¼Œå› æ­¤ChineseMessageEncoderåœ¨å†™å…¥å­—ç¬¦åºåˆ—é•¿åº¦çš„æ—¶å€™è™½ç„¶å­—ç¬¦ä¸ªæ•°æ˜¯å¯¹çš„ï¼Œä½†æ˜¯æ¯ä¸ªå­—ç¬¦æ€»æ˜¯ä¸¢å¤±2ä¸ª-3ä¸ªbyteçš„é•¿åº¦ï¼Œè€ŒChineseMessageDecoderåœ¨è¯»å–å­—ç¬¦åºåˆ—é•¿åº¦çš„æ—¶å€™æ€»æ˜¯è¯»åˆ°ä¸€ä¸ªæ¯”åŸæ¥çŸ­çš„é•¿åº¦ï¼Œä¹Ÿå°±æ˜¯æœ€ç»ˆä¼šæ‹¿åˆ°ä¸€ä¸ªä¸å®Œæ•´æˆ–è€…é”™è¯¯çš„å­—ç¬¦ä¸²åºåˆ—ã€‚ è§£å†³æ–¹æ¡ˆ UTF-8ç¼–ç çš„ä¸­æ–‡åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹å 3ä¸ªå­—èŠ‚ï¼Œåœ¨ä¸€äº›æœ‰ç”Ÿåƒ»å­—çš„æƒ…å†µä¸‹å¯èƒ½å 4ä¸ªå­—èŠ‚ã€‚å¯ä»¥æš´åŠ›ç‚¹ç›´æ¥è®©å†™å…¥å­—èŠ‚ç¼“å†²åŒºçš„å­—ç¬¦åºåˆ—é•¿åº¦æ‰©å¤§ä¸‰å€ï¼Œåªéœ€ä¿®æ”¹ç¼–ç å™¨çš„ä»£ç ï¼š 1234567891011121314public class ChineseMessageEncoder extends MessageToByteEncoder&lt;ChineseMessage&gt; &#123; @Override protected void encode(ChannelHandlerContext ctx, ChineseMessage target, ByteBuf out) throws Exception &#123; // å†™å…¥ID out.writeLong(target.getId()); String message = target.getMessage(); int length = message.length() * 3; // &lt;1&gt; ç›´æ¥æ‰©å¤§å­—èŠ‚åºåˆ—çš„é¢„è¯»é•¿åº¦ // å†™å…¥Messageé•¿åº¦ out.writeInt(length); // å†™å…¥Messageå­—ç¬¦åºåˆ— out.writeCharSequence(message, StandardCharsets.UTF_8); &#125;&#125; å½“ç„¶ï¼Œè¿™æ ·åšå¤ªæš´åŠ›ï¼Œç¡¬ç¼–ç çš„åšæ³•æ—¢ä¸è§„èŒƒä¹Ÿä¸å‹å¥½ã€‚å…¶å®Nettyå·²ç»æä¾›äº†å†…ç½®çš„å·¥å…·ç±»io.netty.buffer.ByteBufUtilï¼š 12345// è·å–UTF-8å­—ç¬¦çš„æœ€å¤§å­—èŠ‚åºåˆ—é•¿åº¦public static int utf8MaxBytes(CharSequence seq)&#123;&#125;// å†™å…¥UTF-8å­—ç¬¦åºåˆ—ï¼Œè¿”å›å†™å…¥çš„å­—èŠ‚é•¿åº¦ - å»ºè®®ä½¿ç”¨æ­¤æ–¹æ³•public static int writeUtf8(ByteBuf buf, CharSequence seq)&#123;&#125; æˆ‘ä»¬å¯ä»¥å…ˆè®°å½•ä¸€ä¸‹writerIndexï¼Œå…ˆå†™ä¸€ä¸ªå‡çš„å€¼ï¼ˆä¾‹å¦‚0ï¼‰ï¼Œå†ä½¿ç”¨ByteBufUtil#writeUtf8()å†™å­—ç¬¦åºåˆ—ï¼Œç„¶åæ ¹æ®è¿”å›çš„å†™å…¥çš„å­—èŠ‚é•¿åº¦ï¼Œé€šè¿‡writerIndexè¦†ç›–ä¹‹å‰å†™å…¥çš„å‡å€¼ï¼š 12345678910111213141516public class ChineseMessageEncoder extends MessageToByteEncoder&lt;ChineseMessage&gt; &#123; @Override protected void encode(ChannelHandlerContext ctx, ChineseMessage target, ByteBuf out) throws Exception &#123; out.writeLong(target.getId()); String message = target.getMessage(); // è®°å½•å†™å…¥æ¸¸æ ‡ int writerIndex = out.writerIndex(); // é¢„å†™å…¥ä¸€ä¸ªå‡çš„length out.writeInt(0); // å†™å…¥UTF-8å­—ç¬¦åºåˆ— int length = ByteBufUtil.writeUtf8(out, message); // è¦†ç›–length out.setInt(writerIndex, length); &#125;&#125; è‡³æ­¤ï¼Œé—®é¢˜è§£å†³ã€‚å¦‚æœé‡åˆ°å…¶ä»–Nettyç¼–ç è§£ç é—®é¢˜ï¼Œè§£å†³çš„æ€è·¯æ˜¯ä¸€è‡´çš„ã€‚ å°ç»“ Nettyå­¦ä¹ è¿‡ç¨‹ä¸­ï¼Œç¼–ç è§£ç å ä¸€åŠï¼Œç½‘ç»œåè®®çŸ¥è¯†å’Œè°ƒä¼˜å å¦ä¸€åŠã€‚ Nettyçš„æºç å¾ˆä¼˜ç§€ï¼Œå¾ˆæœ‰ç¾æ„Ÿï¼Œé˜…è¯»èµ·æ¥å¾ˆèˆ’é€‚ã€‚ NettyçœŸå¥½ç©ã€‚ é™„å½• å¼•å…¥ä¾èµ–ï¼š 1234567891011&lt;dependency&gt; &lt;groupId&gt;io.netty&lt;/groupId&gt; &lt;artifactId&gt;netty-all&lt;/artifactId&gt; &lt;version&gt;4.1.41.Final&lt;/version&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.projectlombok&lt;/groupId&gt; &lt;artifactId&gt;lombok&lt;/artifactId&gt; &lt;version&gt;1.18.10&lt;/version&gt; &lt;scope&gt;provided&lt;/scope&gt;&lt;/dependency&gt; ä»£ç ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123// å®ä½“@Datapublic class ChineseMessage implements Serializable &#123; private long id; private String message;&#125;// ç¼–ç å™¨public class ChineseMessageEncoder extends MessageToByteEncoder&lt;ChineseMessage&gt; &#123; @Override protected void encode(ChannelHandlerContext ctx, ChineseMessage target, ByteBuf out) throws Exception &#123; out.writeLong(target.getId()); String message = target.getMessage(); int writerIndex = out.writerIndex(); out.writeInt(0); int length = ByteBufUtil.writeUtf8(out, message); out.setInt(writerIndex, length); &#125;&#125;// è§£ç å™¨public class ChineseMessageDecoder extends ByteToMessageDecoder &#123; @Override protected void decode(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out) throws Exception &#123; long id = in.readLong(); int length = in.readInt(); CharSequence charSequence = in.readCharSequence(length, StandardCharsets.UTF_8); ChineseMessage message = new ChineseMessage(); message.setId(id); message.setMessage(charSequence.toString()); out.add(message); &#125;&#125;// å®¢æˆ·ç«¯@Slf4jpublic class ChineseNettyClient &#123; public static void main(String[] args) throws Exception &#123; EventLoopGroup workerGroup = new NioEventLoopGroup(); Bootstrap bootstrap = new Bootstrap(); try &#123; bootstrap.group(workerGroup); bootstrap.channel(NioSocketChannel.class); bootstrap.option(ChannelOption.SO_KEEPALIVE, true); bootstrap.option(ChannelOption.TCP_NODELAY, Boolean.TRUE); bootstrap.handler(new ChannelInitializer&lt;SocketChannel&gt;() &#123; @Override protected void initChannel(SocketChannel ch) throws Exception &#123; ch.pipeline().addLast(new LengthFieldBasedFrameDecoder(1024, 0, 4, 0, 4)); ch.pipeline().addLast(new LengthFieldPrepender(4)); ch.pipeline().addLast(new ChineseMessageEncoder()); ch.pipeline().addLast(new ChineseMessageDecoder()); ch.pipeline().addLast(new SimpleChannelInboundHandler&lt;ChineseMessage&gt;() &#123; @Override protected void channelRead0(ChannelHandlerContext ctx, ChineseMessage message) throws Exception &#123; log.info(\"æ¥æ”¶åˆ°æœåŠ¡ç«¯çš„å“åº”:&#123;&#125;\", message); &#125; &#125;); &#125; &#125;); ChannelFuture future = bootstrap.connect(\"localhost\", 9092).sync(); System.out.println(\"å®¢æˆ·ç«¯å¯åŠ¨æˆåŠŸ...\"); Channel channel = future.channel(); ChineseMessage message = new ChineseMessage(); message.setId(1L); message.setMessage(\"å¼ å¤§ç‹—\"); channel.writeAndFlush(message); future.channel().closeFuture().sync(); &#125; finally &#123; workerGroup.shutdownGracefully(); &#125; &#125;&#125;// æœåŠ¡ç«¯@Slf4jpublic class ChineseNettyServer &#123; public static void main(String[] args) throws Exception &#123; int port = 9092; ServerBootstrap bootstrap = new ServerBootstrap(); EventLoopGroup bossGroup = new NioEventLoopGroup(); EventLoopGroup workerGroup = new NioEventLoopGroup(); try &#123; bootstrap.group(bossGroup, workerGroup) .channel(NioServerSocketChannel.class) .childHandler(new ChannelInitializer&lt;SocketChannel&gt;() &#123; @Override protected void initChannel(SocketChannel ch) throws Exception &#123; ch.pipeline().addLast(new LengthFieldBasedFrameDecoder(1024, 0, 4, 0, 4)); ch.pipeline().addLast(new LengthFieldPrepender(4)); ch.pipeline().addLast(new ChineseMessageEncoder()); ch.pipeline().addLast(new ChineseMessageDecoder()); ch.pipeline().addLast(new SimpleChannelInboundHandler&lt;ChineseMessage&gt;() &#123; @Override protected void channelRead0(ChannelHandlerContext ctx, ChineseMessage message) throws Exception &#123; log.info(\"æ¥æ”¶åˆ°å®¢æˆ·ç«¯çš„è¯·æ±‚:&#123;&#125;\", message); ChineseMessage chineseMessage = new ChineseMessage(); chineseMessage.setId(message.getId() + 1L); chineseMessage.setMessage(\"å¼ å°ç‹—\"); ctx.writeAndFlush(chineseMessage); &#125; &#125;); &#125; &#125;); ChannelFuture future = bootstrap.bind(port).sync(); log.info(\"å¯åŠ¨ServeræˆåŠŸ...\"); future.channel().closeFuture().sync(); &#125; finally &#123; workerGroup.shutdownGracefully(); bossGroup.shutdownGracefully(); &#125; &#125;&#125; ï¼ˆæœ¬æ–‡å®Œ c-2-d e-a-20191003 å›½åº†å¿«ä¹(*^â–½^*)ï¼‰","categories":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/categories/Java/"},{"name":"Netty","slug":"Java/Netty","permalink":"http://throwable.club/blog/categories/Java/Netty/"}],"tags":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/tags/Java/"},{"name":"Netty","slug":"Netty","permalink":"http://throwable.club/blog/tags/Netty/"}]},{"title":"Redisé«˜çº§å®¢æˆ·ç«¯Lettuceè¯¦è§£","slug":"redis-client-driver-lettuce-usage","date":"2019-09-28T01:24:22.000Z","updated":"2019-11-28T17:00:33.282Z","comments":true,"path":"2019/09/28/redis-client-driver-lettuce-usage/","link":"","permalink":"http://throwable.club/2019/09/28/redis-client-driver-lettuce-usage/","excerpt":"å‰æ Lettuceæ˜¯ä¸€ä¸ªRedisçš„Javaé©±åŠ¨åŒ…ï¼Œåˆè¯†å¥¹çš„æ—¶å€™æ˜¯ä½¿ç”¨RedisTemplateçš„æ—¶å€™é‡åˆ°ç‚¹é—®é¢˜Debugåˆ°åº•å±‚çš„ä¸€äº›æºç ï¼Œå‘ç°spring-data-redisçš„é©±åŠ¨åŒ…åœ¨æŸä¸ªç‰ˆæœ¬ä¹‹åæ›¿æ¢ä¸ºLettuceã€‚Lettuceç¿»è¯‘ä¸ºç”Ÿèœï¼Œæ²¡é”™ï¼Œå°±æ˜¯åƒçš„é‚£ç§ç”Ÿèœï¼Œæ‰€ä»¥å®ƒçš„Logoé•¿è¿™æ ·ï¼š æ—¢ç„¶èƒ½è¢«Springç”Ÿæ€æ‰€è®¤å¯ï¼ŒLettuceæƒ³å¿…æœ‰è¿‡äººä¹‹å¤„ï¼Œäºæ˜¯ç¬”è€…èŠ±æ—¶é—´é˜…è¯»å¥¹çš„å®˜æ–¹æ–‡æ¡£ï¼Œæ•´ç†æµ‹è¯•ç¤ºä¾‹ï¼Œå†™ä¸‹è¿™ç¯‡æ–‡ç« ã€‚ç¼–å†™æœ¬æ–‡æ—¶æ‰€ä½¿ç”¨çš„ç‰ˆæœ¬ä¸ºLettuce 5.1.8.RELEASEï¼ŒSpringBoot 2.1.8.RELEASEï¼ŒJDK [8,11]ã€‚è¶…é•¿è­¦å‘Šï¼šè¿™ç¯‡æ–‡ç« æ–­æ–­ç»­ç»­èŠ±äº†ä¸¤å‘¨å®Œæˆï¼Œè¶…è¿‡4ä¸‡å­—â€¦","text":"å‰æ Lettuceæ˜¯ä¸€ä¸ªRedisçš„Javaé©±åŠ¨åŒ…ï¼Œåˆè¯†å¥¹çš„æ—¶å€™æ˜¯ä½¿ç”¨RedisTemplateçš„æ—¶å€™é‡åˆ°ç‚¹é—®é¢˜Debugåˆ°åº•å±‚çš„ä¸€äº›æºç ï¼Œå‘ç°spring-data-redisçš„é©±åŠ¨åŒ…åœ¨æŸä¸ªç‰ˆæœ¬ä¹‹åæ›¿æ¢ä¸ºLettuceã€‚Lettuceç¿»è¯‘ä¸ºç”Ÿèœï¼Œæ²¡é”™ï¼Œå°±æ˜¯åƒçš„é‚£ç§ç”Ÿèœï¼Œæ‰€ä»¥å®ƒçš„Logoé•¿è¿™æ ·ï¼š æ—¢ç„¶èƒ½è¢«Springç”Ÿæ€æ‰€è®¤å¯ï¼ŒLettuceæƒ³å¿…æœ‰è¿‡äººä¹‹å¤„ï¼Œäºæ˜¯ç¬”è€…èŠ±æ—¶é—´é˜…è¯»å¥¹çš„å®˜æ–¹æ–‡æ¡£ï¼Œæ•´ç†æµ‹è¯•ç¤ºä¾‹ï¼Œå†™ä¸‹è¿™ç¯‡æ–‡ç« ã€‚ç¼–å†™æœ¬æ–‡æ—¶æ‰€ä½¿ç”¨çš„ç‰ˆæœ¬ä¸ºLettuce 5.1.8.RELEASEï¼ŒSpringBoot 2.1.8.RELEASEï¼ŒJDK [8,11]ã€‚è¶…é•¿è­¦å‘Šï¼šè¿™ç¯‡æ–‡ç« æ–­æ–­ç»­ç»­èŠ±äº†ä¸¤å‘¨å®Œæˆï¼Œè¶…è¿‡4ä¸‡å­—â€¦ Lettuceç®€ä»‹ Lettuceæ˜¯ä¸€ä¸ªé«˜æ€§èƒ½åŸºäºJavaç¼–å†™çš„Redisé©±åŠ¨æ¡†æ¶ï¼Œåº•å±‚é›†æˆäº†Project Reactoræä¾›å¤©ç„¶çš„ååº”å¼ç¼–ç¨‹ï¼Œé€šä¿¡æ¡†æ¶é›†æˆäº†Nettyä½¿ç”¨äº†éé˜»å¡IOï¼Œ5.xç‰ˆæœ¬ä¹‹åèåˆäº†JDK1.8çš„å¼‚æ­¥ç¼–ç¨‹ç‰¹æ€§ï¼Œåœ¨ä¿è¯é«˜æ€§èƒ½çš„åŒæ—¶æä¾›äº†ååˆ†ä¸°å¯Œæ˜“ç”¨çš„APIï¼Œ5.1ç‰ˆæœ¬çš„æ–°ç‰¹æ€§å¦‚ä¸‹ï¼š æ”¯æŒRedisçš„æ–°å¢å‘½ä»¤ZPOPMIN, ZPOPMAX, BZPOPMIN, BZPOPMAXã€‚ æ”¯æŒé€šè¿‡Braveæ¨¡å—è·Ÿè¸ªRediså‘½ä»¤æ‰§è¡Œã€‚ æ”¯æŒRedis Streamsã€‚ æ”¯æŒå¼‚æ­¥çš„ä¸»ä»è¿æ¥ã€‚ æ”¯æŒå¼‚æ­¥è¿æ¥æ± ã€‚ æ–°å¢å‘½ä»¤æœ€å¤šæ‰§è¡Œä¸€æ¬¡æ¨¡å¼ï¼ˆç¦æ­¢è‡ªåŠ¨é‡è¿ï¼‰ã€‚ å…¨å±€å‘½ä»¤è¶…æ—¶è®¾ç½®ï¼ˆå¯¹å¼‚æ­¥å’Œååº”å¼å‘½ä»¤ä¹Ÿæœ‰æ•ˆï¼‰ã€‚ â€¦ç­‰ç­‰ æ³¨æ„ä¸€ç‚¹ï¼šRedisçš„ç‰ˆæœ¬è‡³å°‘éœ€è¦2.6ï¼Œå½“ç„¶è¶Šé«˜è¶Šå¥½ï¼ŒAPIçš„å…¼å®¹æ€§æ¯”è¾ƒå¼ºå¤§ã€‚ åªéœ€è¦å¼•å…¥å•ä¸ªä¾èµ–å°±å¯ä»¥å¼€å§‹æ„‰å¿«åœ°ä½¿ç”¨Lettuceï¼š Maven 12345&lt;dependency&gt; &lt;groupId&gt;io.lettuce&lt;/groupId&gt; &lt;artifactId&gt;lettuce-core&lt;/artifactId&gt; &lt;version&gt;5.1.8.RELEASE&lt;/version&gt;&lt;/dependency&gt; Gradle 123dependencies &#123; compile 'io.lettuce:lettuce-core:5.1.8.RELEASE'&#125; è¿æ¥Redis å•æœºã€å“¨å…µã€é›†ç¾¤æ¨¡å¼ä¸‹è¿æ¥Rediséœ€è¦ä¸€ä¸ªç»Ÿä¸€çš„æ ‡å‡†å»è¡¨ç¤ºè¿æ¥çš„ç»†èŠ‚ä¿¡æ¯ï¼Œåœ¨Lettuceä¸­è¿™ä¸ªç»Ÿä¸€çš„æ ‡å‡†æ˜¯RedisURIã€‚å¯ä»¥é€šè¿‡ä¸‰ç§æ–¹å¼æ„é€ ä¸€ä¸ªRedisURIå®ä¾‹ï¼š å®šåˆ¶çš„å­—ç¬¦ä¸²URIè¯­æ³•ï¼š 1RedisURI uri = RedisURI.create(\"redis://localhost/\"); ä½¿ç”¨å»ºé€ å™¨ï¼ˆRedisURI.Builderï¼‰ï¼š 1RedisURI uri = RedisURI.builder().withHost(\"localhost\").withPort(6379).build(); ç›´æ¥é€šè¿‡æ„é€ å‡½æ•°å®ä¾‹åŒ–ï¼š 1RedisURI uri = new RedisURI(\"localhost\", 6379, 60, TimeUnit.SECONDS); å®šåˆ¶çš„è¿æ¥URIè¯­æ³• å•æœºï¼ˆå‰ç¼€ä¸ºredis://ï¼‰ 123æ ¼å¼ï¼šredis://[password@]host[:port][/databaseNumber][?[timeout=timeout[d|h|m|s|ms|us|ns]]å®Œæ•´ï¼šredis://mypassword@127.0.0.1:6379/0?timeout=10sç®€å•ï¼šredis://localhost å•æœºå¹¶ä¸”ä½¿ç”¨SSLï¼ˆå‰ç¼€ä¸ºrediss://ï¼‰ &lt;== æ³¨æ„åé¢å¤šäº†ä¸ªs 123æ ¼å¼ï¼šrediss://[password@]host[:port][/databaseNumber][?[timeout=timeout[d|h|m|s|ms|us|ns]]å®Œæ•´ï¼šrediss://mypassword@127.0.0.1:6379/0?timeout=10sç®€å•ï¼šrediss://localhost å•æœºUnix Domain Socketsæ¨¡å¼ï¼ˆå‰ç¼€ä¸ºredis-socket://ï¼‰ 12æ ¼å¼ï¼šredis-socket://path[?[timeout=timeout[d|h|m|s|ms|us|ns]][&amp;_database=database_]]å®Œæ•´ï¼šredis-socket:///tmp/redis?timeout=10s&amp;_database=0 å“¨å…µï¼ˆå‰ç¼€ä¸ºredis-sentinel://ï¼‰ 12æ ¼å¼ï¼šredis-sentinel://[password@]host[:port][,host2[:port2]][/databaseNumber][?[timeout=timeout[d|h|m|s|ms|us|ns]]#sentinelMasterIdå®Œæ•´ï¼šredis-sentinel://mypassword@127.0.0.1:6379,127.0.0.1:6380/0?timeout=10s#mymaster è¶…æ—¶æ—¶é—´å•ä½ï¼š d å¤© h å°æ—¶ m åˆ†é’Ÿ s ç§’é’Ÿ ms æ¯«ç§’ us å¾®ç§’ ns çº³ç§’ ä¸ªäººå»ºè®®ä½¿ç”¨RedisURIæä¾›çš„å»ºé€ å™¨ï¼Œæ¯•ç«Ÿå®šåˆ¶çš„URIè™½ç„¶ç®€æ´ï¼Œä½†æ˜¯æ¯”è¾ƒå®¹æ˜“å‡ºç°äººä¸ºé”™è¯¯ã€‚é‰´äºç¬”è€…æ²¡æœ‰SSLå’ŒUnix Domain Socketçš„ä½¿ç”¨åœºæ™¯ï¼Œä¸‹é¢ä¸å¯¹è¿™ä¸¤ç§è¿æ¥æ–¹å¼è¿›è¡Œåˆ—ä¸¾ã€‚ åŸºæœ¬ä½¿ç”¨ Lettuceä½¿ç”¨çš„æ—¶å€™ä¾èµ–äºå››ä¸ªä¸»è¦ç»„ä»¶ï¼š RedisURIï¼šè¿æ¥ä¿¡æ¯ã€‚ RedisClientï¼šRediså®¢æˆ·ç«¯ï¼Œç‰¹æ®Šåœ°ï¼Œé›†ç¾¤è¿æ¥æœ‰ä¸€ä¸ªå®šåˆ¶çš„RedisClusterClientã€‚ Connectionï¼šRedisè¿æ¥ï¼Œä¸»è¦æ˜¯StatefulConnectionæˆ–è€…StatefulRedisConnectionçš„å­ç±»ï¼Œè¿æ¥çš„ç±»å‹ä¸»è¦ç”±è¿æ¥çš„å…·ä½“æ–¹å¼ï¼ˆå•æœºã€å“¨å…µã€é›†ç¾¤ã€è®¢é˜…å‘å¸ƒç­‰ç­‰ï¼‰é€‰å®šï¼Œæ¯”è¾ƒé‡è¦ã€‚ RedisCommandsï¼šRediså‘½ä»¤APIæ¥å£ï¼ŒåŸºæœ¬ä¸Šè¦†ç›–äº†Rediså‘è¡Œç‰ˆæœ¬çš„æ‰€æœ‰å‘½ä»¤ï¼Œæä¾›äº†åŒæ­¥ï¼ˆsyncï¼‰ã€å¼‚æ­¥ï¼ˆasyncï¼‰ã€ååº”å¼ï¼ˆreativeï¼‰çš„è°ƒç”¨æ–¹å¼ï¼Œå¯¹äºä½¿ç”¨è€…è€Œè¨€ï¼Œä¼šç»å¸¸è·ŸRedisCommandsç³»åˆ—æ¥å£æ‰“äº¤é“ã€‚ ä¸€ä¸ªåŸºæœ¬ä½¿ç”¨ä¾‹å­å¦‚ä¸‹ï¼š 12345678910111213141516171819@Testpublic void testSetGet() throws Exception &#123; RedisURI redisUri = RedisURI.builder() // &lt;1&gt; åˆ›å»ºå•æœºè¿æ¥çš„è¿æ¥ä¿¡æ¯ .withHost(\"localhost\") .withPort(6379) .withTimeout(Duration.of(10, ChronoUnit.SECONDS)) .build(); RedisClient redisClient = RedisClient.create(redisUri); // &lt;2&gt; åˆ›å»ºå®¢æˆ·ç«¯ StatefulRedisConnection&lt;String, String&gt; connection = redisClient.connect(); // &lt;3&gt; åˆ›å»ºçº¿ç¨‹å®‰å…¨çš„è¿æ¥ RedisCommands&lt;String, String&gt; redisCommands = connection.sync(); // &lt;4&gt; åˆ›å»ºåŒæ­¥å‘½ä»¤ SetArgs setArgs = SetArgs.Builder.nx().ex(5); String result = redisCommands.set(\"name\", \"throwable\", setArgs); Assertions.assertThat(result).isEqualToIgnoringCase(\"OK\"); result = redisCommands.get(\"name\"); Assertions.assertThat(result).isEqualTo(\"throwable\"); // ... å…¶ä»–æ“ä½œ connection.close(); // &lt;5&gt; å…³é—­è¿æ¥ redisClient.shutdown(); // &lt;6&gt; å…³é—­å®¢æˆ·ç«¯&#125; æ³¨æ„ï¼š &lt;5&gt;ï¼šå…³é—­è¿æ¥ä¸€èˆ¬åœ¨åº”ç”¨ç¨‹åºåœæ­¢ä¹‹å‰æ“ä½œï¼Œä¸€ä¸ªåº”ç”¨ç¨‹åºä¸­çš„ä¸€ä¸ªRedisé©±åŠ¨å®ä¾‹ä¸éœ€è¦å¤ªå¤šçš„è¿æ¥ï¼ˆä¸€èˆ¬æƒ…å†µä¸‹åªéœ€è¦ä¸€ä¸ªè¿æ¥å®ä¾‹å°±å¯ä»¥ï¼Œå¦‚æœæœ‰å¤šä¸ªè¿æ¥çš„éœ€è¦å¯ä»¥è€ƒè™‘ä½¿ç”¨è¿æ¥æ± ï¼Œå…¶å®Redisç›®å‰å¤„ç†å‘½ä»¤çš„æ¨¡å—æ˜¯å•çº¿ç¨‹ï¼Œåœ¨å®¢æˆ·ç«¯å¤šä¸ªè¿æ¥å¤šçº¿ç¨‹è°ƒç”¨ç†è®ºä¸Šæ²¡æœ‰æ•ˆæœï¼‰ã€‚ &lt;6&gt;ï¼šå…³é—­å®¢æˆ·ç«¯ä¸€èˆ¬åº”ç”¨ç¨‹åºåœæ­¢ä¹‹å‰æ“ä½œï¼Œå¦‚æœæ¡ä»¶å…è®¸çš„è¯ï¼ŒåŸºäºåå¼€å…ˆé—­åŸåˆ™ï¼Œå®¢æˆ·ç«¯å…³é—­åº”è¯¥åœ¨è¿æ¥å…³é—­ä¹‹åæ“ä½œã€‚ API Lettuceä¸»è¦æä¾›ä¸‰ç§APIï¼š åŒæ­¥ï¼ˆsyncï¼‰ï¼šRedisCommandsã€‚ å¼‚æ­¥ï¼ˆasyncï¼‰ï¼šRedisAsyncCommandsã€‚ ååº”å¼ï¼ˆreactiveï¼‰ï¼šRedisReactiveCommandsã€‚ å…ˆå‡†å¤‡å¥½ä¸€ä¸ªå•æœºRedisè¿æ¥å¤‡ç”¨ï¼š 12345678910111213141516171819private static StatefulRedisConnection&lt;String, String&gt; CONNECTION;private static RedisClient CLIENT;@BeforeClasspublic static void beforeClass() &#123; RedisURI redisUri = RedisURI.builder() .withHost(\"localhost\") .withPort(6379) .withTimeout(Duration.of(10, ChronoUnit.SECONDS)) .build(); CLIENT = RedisClient.create(redisUri); CONNECTION = CLIENT.connect();&#125;@AfterClasspublic static void afterClass() throws Exception &#123; CONNECTION.close(); CLIENT.shutdown();&#125; Rediså‘½ä»¤APIçš„å…·ä½“å®ç°å¯ä»¥ç›´æ¥ä»StatefulRedisConnectionå®ä¾‹è·å–ï¼Œè§å…¶æ¥å£å®šä¹‰ï¼š 12345678910public interface StatefulRedisConnection&lt;K, V&gt; extends StatefulConnection&lt;K, V&gt; &#123; boolean isMulti(); RedisCommands&lt;K, V&gt; sync(); RedisAsyncCommands&lt;K, V&gt; async(); RedisReactiveCommands&lt;K, V&gt; reactive();&#125; å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œåœ¨ä¸æŒ‡å®šç¼–ç è§£ç å™¨RedisCodecçš„å‰æä¸‹ï¼ŒRedisClientåˆ›å»ºçš„StatefulRedisConnectionå®ä¾‹ä¸€èˆ¬æ˜¯æ³›å‹å®ä¾‹StatefulRedisConnection&lt;String,String&gt;ï¼Œä¹Ÿå°±æ˜¯æ‰€æœ‰å‘½ä»¤APIçš„KEYå’ŒVALUEéƒ½æ˜¯Stringç±»å‹ï¼Œè¿™ç§ä½¿ç”¨æ–¹å¼èƒ½æ»¡è¶³å¤§éƒ¨åˆ†çš„ä½¿ç”¨åœºæ™¯ã€‚å½“ç„¶ï¼Œå¿…è¦çš„æ—¶å€™å¯ä»¥å®šåˆ¶ç¼–ç è§£ç å™¨RedisCodec&lt;K,V&gt;ã€‚ åŒæ­¥API å…ˆæ„å»ºRedisCommandså®ä¾‹ï¼š 123456private static RedisCommands&lt;String, String&gt; COMMAND;@BeforeClasspublic static void beforeClass() &#123; COMMAND = CONNECTION.sync();&#125; åŸºæœ¬ä½¿ç”¨ï¼š 12345678910111213141516@Testpublic void testSyncPing() throws Exception &#123; String pong = COMMAND.ping(); Assertions.assertThat(pong).isEqualToIgnoringCase(\"PONG\");&#125;@Testpublic void testSyncSetAndGet() throws Exception &#123; SetArgs setArgs = SetArgs.Builder.nx().ex(5); COMMAND.set(\"name\", \"throwable\", setArgs); String value = COMMAND.get(\"name\"); log.info(\"Get value: &#123;&#125;\", value);&#125;// Get value: throwable åŒæ­¥APIåœ¨æ‰€æœ‰å‘½ä»¤è°ƒç”¨ä¹‹åä¼šç«‹å³è¿”å›ç»“æœã€‚å¦‚æœç†Ÿæ‚‰Jedisçš„è¯ï¼ŒRedisCommandsçš„ç”¨æ³•å…¶å®å’Œå®ƒç›¸å·®ä¸å¤§ã€‚ å¼‚æ­¥API å…ˆæ„å»ºRedisAsyncCommandså®ä¾‹ï¼š 123456private static RedisAsyncCommands&lt;String, String&gt; ASYNC_COMMAND;@BeforeClasspublic static void beforeClass() &#123; ASYNC_COMMAND = CONNECTION.async();&#125; åŸºæœ¬ä½¿ç”¨ï¼š 123456@Testpublic void testAsyncPing() throws Exception &#123; RedisFuture&lt;String&gt; redisFuture = ASYNC_COMMAND.ping(); log.info(\"Ping result:&#123;&#125;\", redisFuture.get());&#125;// Ping result:PONG RedisAsyncCommandsæ‰€æœ‰æ–¹æ³•æ‰§è¡Œè¿”å›ç»“æœéƒ½æ˜¯RedisFutureå®ä¾‹ï¼Œè€ŒRedisFutureæ¥å£çš„å®šä¹‰å¦‚ä¸‹ï¼š 123456public interface RedisFuture&lt;V&gt; extends CompletionStage&lt;V&gt;, Future&lt;V&gt; &#123; String getError(); boolean await(long timeout, TimeUnit unit) throws InterruptedException;&#125; ä¹Ÿå°±æ˜¯ï¼ŒRedisFutureå¯ä»¥æ— ç¼ä½¿ç”¨Futureæˆ–è€…JDK1.8ä¸­å¼•å…¥çš„CompletableFutureæä¾›çš„æ–¹æ³•ã€‚ä¸¾ä¸ªä¾‹å­ï¼š 12345678910111213141516171819202122232425@Testpublic void testAsyncSetAndGet1() throws Exception &#123; SetArgs setArgs = SetArgs.Builder.nx().ex(5); RedisFuture&lt;String&gt; future = ASYNC_COMMAND.set(\"name\", \"throwable\", setArgs); // CompletableFuture#thenAccept() future.thenAccept(value -&gt; log.info(\"Setå‘½ä»¤è¿”å›:&#123;&#125;\", value)); // Future#get() future.get();&#125;// Setå‘½ä»¤è¿”å›:OK@Testpublic void testAsyncSetAndGet2() throws Exception &#123; SetArgs setArgs = SetArgs.Builder.nx().ex(5); CompletableFuture&lt;Void&gt; result = (CompletableFuture&lt;Void&gt;) ASYNC_COMMAND.set(\"name\", \"throwable\", setArgs) .thenAcceptBoth(ASYNC_COMMAND.get(\"name\"), (s, g) -&gt; &#123; log.info(\"Setå‘½ä»¤è¿”å›:&#123;&#125;\", s); log.info(\"Getå‘½ä»¤è¿”å›:&#123;&#125;\", g); &#125;); result.get();&#125;// Setå‘½ä»¤è¿”å›:OK// Getå‘½ä»¤è¿”å›:throwable å¦‚æœèƒ½ç†Ÿç»ƒä½¿ç”¨CompletableFutureå’Œå‡½æ•°å¼ç¼–ç¨‹æŠ€å·§ï¼Œå¯ä»¥ç»„åˆå¤šä¸ªRedisFutureå®Œæˆä¸€äº›åˆ—å¤æ‚çš„æ“ä½œã€‚ ååº”å¼API Lettuceå¼•å…¥çš„ååº”å¼ç¼–ç¨‹æ¡†æ¶æ˜¯Project Reactorï¼Œå¦‚æœæ²¡æœ‰ååº”å¼ç¼–ç¨‹ç»éªŒå¯ä»¥å…ˆè‡ªè¡Œäº†è§£ä¸€ä¸‹Project Reactorã€‚ æ„å»ºRedisReactiveCommandså®ä¾‹ï¼š 123456private static RedisReactiveCommands&lt;String, String&gt; REACTIVE_COMMAND;@BeforeClasspublic static void beforeClass() &#123; REACTIVE_COMMAND = CONNECTION.reactive();&#125; æ ¹æ®Project Reactorï¼ŒRedisReactiveCommandsçš„æ–¹æ³•å¦‚æœè¿”å›çš„ç»“æœåªåŒ…å«0æˆ–1ä¸ªå…ƒç´ ï¼Œé‚£ä¹ˆè¿”å›å€¼ç±»å‹æ˜¯Monoï¼Œå¦‚æœè¿”å›çš„ç»“æœåŒ…å«0åˆ°Nï¼ˆNå¤§äº0ï¼‰ä¸ªå…ƒç´ ï¼Œé‚£ä¹ˆè¿”å›å€¼æ˜¯Fluxã€‚ä¸¾ä¸ªä¾‹å­ï¼š 12345678910111213141516171819202122232425262728@Testpublic void testReactivePing() throws Exception &#123; Mono&lt;String&gt; ping = REACTIVE_COMMAND.ping(); ping.subscribe(v -&gt; log.info(\"Ping result:&#123;&#125;\", v)); Thread.sleep(1000);&#125;// Ping result:PONG@Testpublic void testReactiveSetAndGet() throws Exception &#123; SetArgs setArgs = SetArgs.Builder.nx().ex(5); REACTIVE_COMMAND.set(\"name\", \"throwable\", setArgs).block(); REACTIVE_COMMAND.get(\"name\").subscribe(value -&gt; log.info(\"Getå‘½ä»¤è¿”å›:&#123;&#125;\", value)); Thread.sleep(1000);&#125;// Getå‘½ä»¤è¿”å›:throwable@Testpublic void testReactiveSet() throws Exception &#123; REACTIVE_COMMAND.sadd(\"food\", \"bread\", \"meat\", \"fish\").block(); Flux&lt;String&gt; flux = REACTIVE_COMMAND.smembers(\"food\"); flux.subscribe(log::info); REACTIVE_COMMAND.srem(\"food\", \"bread\", \"meat\", \"fish\").block(); Thread.sleep(1000);&#125;// meat// bread// fish ä¸¾ä¸ªæ›´åŠ å¤æ‚çš„ä¾‹å­ï¼ŒåŒ…å«äº†äº‹åŠ¡ã€å‡½æ•°è½¬æ¢ç­‰ï¼š 12345678910111213@Testpublic void testReactiveFunctional() throws Exception &#123; REACTIVE_COMMAND.multi().doOnSuccess(r -&gt; &#123; REACTIVE_COMMAND.set(\"counter\", \"1\").doOnNext(log::info).subscribe(); REACTIVE_COMMAND.incr(\"counter\").doOnNext(c -&gt; log.info(String.valueOf(c))).subscribe(); &#125;).flatMap(s -&gt; REACTIVE_COMMAND.exec()) .doOnNext(transactionResult -&gt; log.info(\"Discarded:&#123;&#125;\", transactionResult.wasDiscarded())) .subscribe(); Thread.sleep(1000);&#125;// OK// 2// Discarded:false è¿™ä¸ªæ–¹æ³•å¼€å¯ä¸€ä¸ªäº‹åŠ¡ï¼Œå…ˆæŠŠcounterè®¾ç½®ä¸º1ï¼Œå†å°†counterè‡ªå¢1ã€‚ å‘å¸ƒå’Œè®¢é˜… éé›†ç¾¤æ¨¡å¼ä¸‹çš„å‘å¸ƒè®¢é˜…ä¾èµ–äºå®šåˆ¶çš„è¿æ¥StatefulRedisPubSubConnectionï¼Œé›†ç¾¤æ¨¡å¼ä¸‹çš„å‘å¸ƒè®¢é˜…ä¾èµ–äºå®šåˆ¶çš„è¿æ¥StatefulRedisClusterPubSubConnectionï¼Œä¸¤è€…åˆ†åˆ«æ¥æºäºRedisClient#connectPubSub()ç³»åˆ—æ–¹æ³•å’ŒRedisClusterClient#connectPubSub()ï¼š éé›†ç¾¤æ¨¡å¼ï¼š 123456789101112131415161718// å¯èƒ½æ˜¯å•æœºã€æ™®é€šä¸»ä»ã€å“¨å…µç­‰éé›†ç¾¤æ¨¡å¼çš„å®¢æˆ·ç«¯RedisClient client = ...StatefulRedisPubSubConnection&lt;String, String&gt; connection = client.connectPubSub();connection.addListener(new RedisPubSubListener&lt;String, String&gt;() &#123; ... &#125;);// åŒæ­¥å‘½ä»¤RedisPubSubCommands&lt;String, String&gt; sync = connection.sync();sync.subscribe(\"channel\");// å¼‚æ­¥å‘½ä»¤RedisPubSubAsyncCommands&lt;String, String&gt; async = connection.async();RedisFuture&lt;Void&gt; future = async.subscribe(\"channel\");// ååº”å¼å‘½ä»¤RedisPubSubReactiveCommands&lt;String, String&gt; reactive = connection.reactive();reactive.subscribe(\"channel\").subscribe();reactive.observeChannels().doOnNext(patternMessage -&gt; &#123;...&#125;).subscribe() é›†ç¾¤æ¨¡å¼ï¼š 1234567// ä½¿ç”¨æ–¹å¼å…¶å®å’Œéé›†ç¾¤æ¨¡å¼åŸºæœ¬ä¸€è‡´RedisClusterClient clusterClient = ...StatefulRedisClusterPubSubConnection&lt;String, String&gt; connection = clusterClient.connectPubSub();connection.addListener(new RedisPubSubListener&lt;String, String&gt;() &#123; ... &#125;);RedisPubSubCommands&lt;String, String&gt; sync = connection.sync();sync.subscribe(\"channel\");// ... è¿™é‡Œç”¨å•æœºåŒæ­¥å‘½ä»¤çš„æ¨¡å¼ä¸¾ä¸€ä¸ªRedisé”®ç©ºé—´é€šçŸ¥ï¼ˆRedis Keyspace Notificationsï¼‰çš„ä¾‹å­ï¼š 12345678910111213141516171819202122232425262728293031323334353637@Testpublic void testSyncKeyspaceNotification() throws Exception &#123; RedisURI redisUri = RedisURI.builder() .withHost(\"localhost\") .withPort(6379) // æ³¨æ„è¿™é‡Œåªèƒ½æ˜¯0å·åº“ .withDatabase(0) .withTimeout(Duration.of(10, ChronoUnit.SECONDS)) .build(); RedisClient redisClient = RedisClient.create(redisUri); StatefulRedisConnection&lt;String, String&gt; redisConnection = redisClient.connect(); RedisCommands&lt;String, String&gt; redisCommands = redisConnection.sync(); // åªæ¥æ”¶é”®è¿‡æœŸçš„äº‹ä»¶ redisCommands.configSet(\"notify-keyspace-events\", \"Ex\"); StatefulRedisPubSubConnection&lt;String, String&gt; connection = redisClient.connectPubSub(); connection.addListener(new RedisPubSubAdapter&lt;&gt;() &#123; @Override public void psubscribed(String pattern, long count) &#123; log.info(\"pattern:&#123;&#125;,count:&#123;&#125;\", pattern, count); &#125; @Override public void message(String pattern, String channel, String message) &#123; log.info(\"pattern:&#123;&#125;,channel:&#123;&#125;,message:&#123;&#125;\", pattern, channel, message); &#125; &#125;); RedisPubSubCommands&lt;String, String&gt; commands = connection.sync(); commands.psubscribe(\"__keyevent@0__:expired\"); redisCommands.setex(\"name\", 2, \"throwable\"); Thread.sleep(10000); redisConnection.close(); connection.close(); redisClient.shutdown();&#125;// pattern:__keyevent@0__:expired,count:1// pattern:__keyevent@0__:expired,channel:__keyevent@0__:expired,message:name å®é™…ä¸Šï¼Œåœ¨å®ç°RedisPubSubListenerçš„æ—¶å€™å¯ä»¥å•ç‹¬æŠ½ç¦»ï¼Œå°½é‡ä¸è¦è®¾è®¡æˆåŒ¿åå†…éƒ¨ç±»çš„å½¢å¼ã€‚ äº‹åŠ¡å’Œæ‰¹é‡å‘½ä»¤æ‰§è¡Œ äº‹åŠ¡ç›¸å…³çš„å‘½ä»¤å°±æ˜¯WATCHã€UNWATCHã€EXECã€MULTIå’ŒDISCARDï¼Œåœ¨RedisCommandsç³»åˆ—æ¥å£ä¸­æœ‰å¯¹åº”çš„æ–¹æ³•ã€‚ä¸¾ä¸ªä¾‹å­ï¼š 123456789101112131415// åŒæ­¥æ¨¡å¼@Testpublic void testSyncMulti() throws Exception &#123; COMMAND.multi(); COMMAND.setex(\"name-1\", 2, \"throwable\"); COMMAND.setex(\"name-2\", 2, \"doge\"); TransactionResult result = COMMAND.exec(); int index = 0; for (Object r : result) &#123; log.info(\"Result-&#123;&#125;:&#123;&#125;\", index, r); index++; &#125;&#125;// Result-0:OK// Result-1:OK Redisçš„Pipelineä¹Ÿå°±æ˜¯ç®¡é“æœºåˆ¶å¯ä»¥ç†è§£ä¸ºæŠŠå¤šä¸ªå‘½ä»¤æ‰“åŒ…åœ¨ä¸€æ¬¡è¯·æ±‚å‘é€åˆ°RedisæœåŠ¡ç«¯ï¼Œç„¶åRedisæœåŠ¡ç«¯æŠŠæ‰€æœ‰çš„å“åº”ç»“æœæ‰“åŒ…å¥½ä¸€æ¬¡æ€§è¿”å›ï¼Œä»è€ŒèŠ‚çœä¸å¿…è¦çš„ç½‘ç»œèµ„æºï¼ˆæœ€ä¸»è¦æ˜¯å‡å°‘ç½‘ç»œè¯·æ±‚æ¬¡æ•°ï¼‰ã€‚Rediså¯¹äºPipelineæœºåˆ¶å¦‚ä½•å®ç°å¹¶æ²¡æœ‰æ˜ç¡®çš„è§„å®šï¼Œä¹Ÿæ²¡æœ‰æä¾›ç‰¹æ®Šçš„å‘½ä»¤æ”¯æŒPipelineæœºåˆ¶ã€‚Jedisä¸­åº•å±‚é‡‡ç”¨BIOï¼ˆé˜»å¡IOï¼‰é€šè®¯ï¼Œæ‰€ä»¥å®ƒçš„åšæ³•æ˜¯å®¢æˆ·ç«¯ç¼“å­˜å°†è¦å‘é€çš„å‘½ä»¤ï¼Œæœ€åéœ€è¦è§¦å‘ç„¶ååŒæ­¥å‘é€ä¸€ä¸ªå·¨å¤§çš„å‘½ä»¤åˆ—è¡¨åŒ…ï¼Œå†æ¥æ”¶å’Œè§£æä¸€ä¸ªå·¨å¤§çš„å“åº”åˆ—è¡¨åŒ…ã€‚Pipelineåœ¨Lettuceä¸­å¯¹ä½¿ç”¨è€…æ˜¯é€æ˜çš„ï¼Œç”±äºåº•å±‚çš„é€šè®¯æ¡†æ¶æ˜¯Nettyï¼Œæ‰€ä»¥ç½‘ç»œé€šè®¯å±‚é¢çš„ä¼˜åŒ–Lettuceä¸éœ€è¦è¿‡å¤šå¹²é¢„ï¼Œæ¢è¨€ä¹‹å¯ä»¥è¿™æ ·ç†è§£ï¼šNettyå¸®Lettuceä»åº•å±‚å®ç°äº†Redisçš„Pipelineæœºåˆ¶ã€‚ä½†æ˜¯ï¼ŒLettuceçš„å¼‚æ­¥APIä¹Ÿæä¾›äº†æ‰‹åŠ¨Flushçš„æ–¹æ³•ï¼š 12345678910111213141516171819@Testpublic void testAsyncManualFlush() &#123; // å–æ¶ˆè‡ªåŠ¨flush ASYNC_COMMAND.setAutoFlushCommands(false); List&lt;RedisFuture&lt;?&gt;&gt; redisFutures = Lists.newArrayList(); int count = 5000; for (int i = 0; i &lt; count; i++) &#123; String key = \"key-\" + (i + 1); String value = \"value-\" + (i + 1); redisFutures.add(ASYNC_COMMAND.set(key, value)); redisFutures.add(ASYNC_COMMAND.expire(key, 2)); &#125; long start = System.currentTimeMillis(); ASYNC_COMMAND.flushCommands(); boolean result = LettuceFutures.awaitAll(10, TimeUnit.SECONDS, redisFutures.toArray(new RedisFuture[0])); Assertions.assertThat(result).isTrue(); log.info(\"Lettuce cost:&#123;&#125; ms\", System.currentTimeMillis() - start);&#125;// Lettuce cost:1302 ms ä¸Šé¢åªæ˜¯ä»æ–‡æ¡£çœ‹åˆ°çš„ä¸€äº›ç†è®ºæœ¯è¯­ï¼Œä½†æ˜¯ç°å®æ˜¯éª¨æ„Ÿçš„ï¼Œå¯¹æ¯”äº†ä¸‹Jedisçš„Pipelineæä¾›çš„æ–¹æ³•ï¼Œå‘ç°äº†Jedisçš„Pipelineæ‰§è¡Œè€—æ—¶æ¯”è¾ƒä½ï¼š 12345678910111213141516@Testpublic void testJedisPipeline() throws Exception &#123; Jedis jedis = new Jedis(); Pipeline pipeline = jedis.pipelined(); int count = 5000; for (int i = 0; i &lt; count; i++) &#123; String key = \"key-\" + (i + 1); String value = \"value-\" + (i + 1); pipeline.set(key, value); pipeline.expire(key, 2); &#125; long start = System.currentTimeMillis(); pipeline.syncAndReturnAll(); log.info(\"Jedis cost:&#123;&#125; ms\", System.currentTimeMillis() - start);&#125;// Jedis cost:9 ms ä¸ªäººçŒœæµ‹Lettuceå¯èƒ½åº•å±‚å¹¶éåˆå¹¶æ‰€æœ‰å‘½ä»¤ä¸€æ¬¡å‘é€ï¼ˆç”šè‡³å¯èƒ½æ˜¯å•æ¡å‘é€ï¼‰ï¼Œå…·ä½“å¯èƒ½éœ€è¦æŠ“åŒ…æ‰èƒ½å®šä½ã€‚ä¾æ­¤æ¥çœ‹ï¼Œå¦‚æœçœŸçš„æœ‰å¤§é‡æ‰§è¡ŒRediså‘½ä»¤çš„åœºæ™¯ï¼Œä¸å¦¨å¯ä»¥ä½¿ç”¨Jedisçš„Pipelineã€‚ æ³¨æ„ï¼šç”±ä¸Šé¢çš„æµ‹è¯•æ¨æ–­RedisTemplateçš„executePipelined()æ–¹æ³•æ˜¯å‡çš„Pipelineæ‰§è¡Œæ–¹æ³•ï¼Œä½¿ç”¨RedisTemplateçš„æ—¶å€™è¯·åŠ¡å¿…æ³¨æ„è¿™ä¸€ç‚¹ã€‚ Luaè„šæœ¬æ‰§è¡Œ Lettuceä¸­æ‰§è¡ŒRedisçš„Luaå‘½ä»¤çš„åŒæ­¥æ¥å£å¦‚ä¸‹ï¼š 1234567891011121314151617181920public interface RedisScriptingCommands&lt;K, V&gt; &#123; &lt;T&gt; T eval(String var1, ScriptOutputType var2, K... var3); &lt;T&gt; T eval(String var1, ScriptOutputType var2, K[] var3, V... var4); &lt;T&gt; T evalsha(String var1, ScriptOutputType var2, K... var3); &lt;T&gt; T evalsha(String var1, ScriptOutputType var2, K[] var3, V... var4); List&lt;Boolean&gt; scriptExists(String... var1); String scriptFlush(); String scriptKill(); String scriptLoad(V var1); String digest(V var1);&#125; å¼‚æ­¥å’Œååº”å¼çš„æ¥å£æ–¹æ³•å®šä¹‰å·®ä¸å¤šï¼Œä¸åŒçš„åœ°æ–¹å°±æ˜¯è¿”å›å€¼ç±»å‹ï¼Œä¸€èˆ¬æˆ‘ä»¬å¸¸ç”¨çš„æ˜¯eval()ã€evalsha()å’ŒscriptLoad()æ–¹æ³•ã€‚ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼š 123456789101112131415161718private static RedisCommands&lt;String, String&gt; COMMANDS;private static String RAW_LUA = \"local key = KEYS[1]\\n\" + \"local value = ARGV[1]\\n\" + \"local timeout = ARGV[2]\\n\" + \"redis.call('SETEX', key, tonumber(timeout), value)\\n\" + \"local result = redis.call('GET', key)\\n\" + \"return result;\";private static AtomicReference&lt;String&gt; LUA_SHA = new AtomicReference&lt;&gt;();@Testpublic void testLua() throws Exception &#123; LUA_SHA.compareAndSet(null, COMMANDS.scriptLoad(RAW_LUA)); String[] keys = new String[]&#123;\"name\"&#125;; String[] args = new String[]&#123;\"throwable\", \"5000\"&#125;; String result = COMMANDS.evalsha(LUA_SHA.get(), ScriptOutputType.VALUE, keys, args); log.info(\"Get value:&#123;&#125;\", result);&#125;// Get value:throwable é«˜å¯ç”¨å’Œåˆ†ç‰‡ ä¸ºäº†Redisçš„é«˜å¯ç”¨ï¼Œä¸€èˆ¬ä¼šé‡‡ç”¨æ™®é€šä¸»ä»ï¼ˆMaster/Replicaï¼Œè¿™é‡Œç¬”è€…ç§°ä¸ºæ™®é€šä¸»ä»æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯ä»…ä»…åšäº†ä¸»ä»å¤åˆ¶ï¼Œæ•…éšœéœ€è¦æ‰‹åŠ¨åˆ‡æ¢ï¼‰ã€å“¨å…µå’Œé›†ç¾¤ã€‚æ™®é€šä¸»ä»æ¨¡å¼å¯ä»¥ç‹¬ç«‹è¿è¡Œï¼Œä¹Ÿå¯ä»¥é…åˆå“¨å…µè¿è¡Œï¼Œåªæ˜¯å“¨å…µæä¾›è‡ªåŠ¨æ•…éšœè½¬ç§»å’Œä¸»èŠ‚ç‚¹æå‡åŠŸèƒ½ã€‚æ™®é€šä¸»ä»å’Œå“¨å…µéƒ½å¯ä»¥ä½¿ç”¨MasterSlaveï¼Œé€šè¿‡å…¥å‚åŒ…æ‹¬RedisClientã€ç¼–ç è§£ç å™¨ä»¥åŠä¸€ä¸ªæˆ–è€…å¤šä¸ªRedisURIè·å–å¯¹åº”çš„Connectionå®ä¾‹ã€‚ è¿™é‡Œæ³¨æ„ä¸€ç‚¹ï¼ŒMasterSlaveä¸­æä¾›çš„æ–¹æ³•å¦‚æœåªè¦æ±‚ä¼ å…¥ä¸€ä¸ªRedisURIå®ä¾‹ï¼Œé‚£ä¹ˆLettuceä¼šè¿›è¡Œæ‹“æ‰‘å‘ç°æœºåˆ¶ï¼Œè‡ªåŠ¨è·å–Redisä¸»ä»èŠ‚ç‚¹ä¿¡æ¯ï¼›å¦‚æœè¦æ±‚ä¼ å…¥ä¸€ä¸ªRedisURIé›†åˆï¼Œé‚£ä¹ˆå¯¹äºæ™®é€šä¸»ä»æ¨¡å¼æ¥è¯´æ‰€æœ‰èŠ‚ç‚¹ä¿¡æ¯æ˜¯é™æ€çš„ï¼Œä¸ä¼šè¿›è¡Œå‘ç°å’Œæ›´æ–°ã€‚ æ‹“æ‰‘å‘ç°çš„è§„åˆ™å¦‚ä¸‹ï¼š å¯¹äºæ™®é€šä¸»ä»ï¼ˆMaster/Replicaï¼‰æ¨¡å¼ï¼Œä¸éœ€è¦æ„ŸçŸ¥RedisURIæŒ‡å‘ä»èŠ‚ç‚¹è¿˜æ˜¯ä¸»èŠ‚ç‚¹ï¼Œåªä¼šè¿›è¡Œä¸€æ¬¡æ€§çš„æ‹“æ‰‘æŸ¥æ‰¾æ‰€æœ‰èŠ‚ç‚¹ä¿¡æ¯ï¼Œæ­¤åèŠ‚ç‚¹ä¿¡æ¯ä¼šä¿å­˜åœ¨é™æ€ç¼“å­˜ä¸­ï¼Œä¸ä¼šæ›´æ–°ã€‚ å¯¹äºå“¨å…µæ¨¡å¼ï¼Œä¼šè®¢é˜…æ‰€æœ‰å“¨å…µå®ä¾‹å¹¶ä¾¦å¬è®¢é˜…/å‘å¸ƒæ¶ˆæ¯ä»¥è§¦å‘æ‹“æ‰‘åˆ·æ–°æœºåˆ¶ï¼Œæ›´æ–°ç¼“å­˜çš„èŠ‚ç‚¹ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯å“¨å…µå¤©ç„¶å°±æ˜¯åŠ¨æ€å‘ç°èŠ‚ç‚¹ä¿¡æ¯ï¼Œä¸æ”¯æŒé™æ€é…ç½®ã€‚ æ‹“æ‰‘å‘ç°æœºåˆ¶çš„æä¾›APIä¸ºTopologyProviderï¼Œéœ€è¦äº†è§£å…¶åŸç†çš„å¯ä»¥å‚è€ƒå…·ä½“çš„å®ç°ã€‚ å¯¹äºé›†ç¾¤ï¼ˆClusterï¼‰æ¨¡å¼ï¼ŒLettuceæä¾›äº†ä¸€å¥—ç‹¬ç«‹çš„APIã€‚ å¦å¤–ï¼Œå¦‚æœLettuceè¿æ¥é¢å‘çš„æ˜¯éå•ä¸ªRedisèŠ‚ç‚¹ï¼Œè¿æ¥å®ä¾‹æä¾›äº†æ•°æ®è¯»å–èŠ‚ç‚¹åå¥½ï¼ˆReadFromï¼‰è®¾ç½®ï¼Œå¯é€‰å€¼æœ‰ï¼š MASTERï¼šåªä»MasterèŠ‚ç‚¹ä¸­è¯»å–ã€‚ MASTER_PREFERREDï¼šä¼˜å…ˆä»MasterèŠ‚ç‚¹ä¸­è¯»å–ã€‚ SLAVE_PREFERREDï¼šä¼˜å…ˆä»SlavorèŠ‚ç‚¹ä¸­è¯»å–ã€‚ SLAVEï¼šåªä»SlavorèŠ‚ç‚¹ä¸­è¯»å–ã€‚ NEARESTï¼šä½¿ç”¨æœ€è¿‘ä¸€æ¬¡è¿æ¥çš„Rediså®ä¾‹è¯»å–ã€‚ æ™®é€šä¸»ä»æ¨¡å¼ å‡è®¾ç°åœ¨æœ‰ä¸‰ä¸ªRedisæœåŠ¡å½¢æˆæ ‘çŠ¶ä¸»ä»å…³ç³»å¦‚ä¸‹ï¼š èŠ‚ç‚¹ä¸€ï¼šlocalhost:6379ï¼Œè§’è‰²ä¸ºMasterã€‚ èŠ‚ç‚¹äºŒï¼šlocalhost:6380ï¼Œè§’è‰²ä¸ºSlavorï¼ŒèŠ‚ç‚¹ä¸€çš„ä»èŠ‚ç‚¹ã€‚ èŠ‚ç‚¹ä¸‰ï¼šlocalhost:6381ï¼Œè§’è‰²ä¸ºSlavorï¼ŒèŠ‚ç‚¹äºŒçš„ä»èŠ‚ç‚¹ã€‚ é¦–æ¬¡åŠ¨æ€èŠ‚ç‚¹å‘ç°ä¸»ä»æ¨¡å¼çš„èŠ‚ç‚¹ä¿¡æ¯éœ€è¦å¦‚ä¸‹æ„å»ºè¿æ¥ï¼š 123456789101112@Testpublic void testDynamicReplica() throws Exception &#123; // è¿™é‡Œåªéœ€è¦é…ç½®ä¸€ä¸ªèŠ‚ç‚¹çš„è¿æ¥ä¿¡æ¯ï¼Œä¸ä¸€å®šéœ€è¦æ˜¯ä¸»èŠ‚ç‚¹çš„ä¿¡æ¯ï¼Œä»èŠ‚ç‚¹ä¹Ÿå¯ä»¥ RedisURI uri = RedisURI.builder().withHost(\"localhost\").withPort(6379).build(); RedisClient redisClient = RedisClient.create(uri); StatefulRedisMasterSlaveConnection&lt;String, String&gt; connection = MasterSlave.connect(redisClient, new Utf8StringCodec(), uri); // åªä»ä»èŠ‚ç‚¹è¯»å–æ•°æ® connection.setReadFrom(ReadFrom.SLAVE); // æ‰§è¡Œå…¶ä»–Rediså‘½ä»¤ connection.close(); redisClient.shutdown();&#125; å¦‚æœéœ€è¦æŒ‡å®šé™æ€çš„Redisä¸»ä»èŠ‚ç‚¹è¿æ¥å±æ€§ï¼Œé‚£ä¹ˆå¯ä»¥è¿™æ ·æ„å»ºè¿æ¥ï¼š 123456789101112131415161718@Testpublic void testStaticReplica() throws Exception &#123; List&lt;RedisURI&gt; uris = new ArrayList&lt;&gt;(); RedisURI uri1 = RedisURI.builder().withHost(\"localhost\").withPort(6379).build(); RedisURI uri2 = RedisURI.builder().withHost(\"localhost\").withPort(6380).build(); RedisURI uri3 = RedisURI.builder().withHost(\"localhost\").withPort(6381).build(); uris.add(uri1); uris.add(uri2); uris.add(uri3); RedisClient redisClient = RedisClient.create(); StatefulRedisMasterSlaveConnection&lt;String, String&gt; connection = MasterSlave.connect(redisClient, new Utf8StringCodec(), uris); // åªä»ä¸»èŠ‚ç‚¹è¯»å–æ•°æ® connection.setReadFrom(ReadFrom.MASTER); // æ‰§è¡Œå…¶ä»–Rediså‘½ä»¤ connection.close(); redisClient.shutdown();&#125; å“¨å…µæ¨¡å¼ ç”±äºLettuceè‡ªèº«æä¾›äº†å“¨å…µçš„æ‹“æ‰‘å‘ç°æœºåˆ¶ï¼Œæ‰€ä»¥åªéœ€è¦éšä¾¿é…ç½®ä¸€ä¸ªå“¨å…µèŠ‚ç‚¹çš„RedisURIå®ä¾‹å³å¯ï¼š 123456789101112131415161718@Testpublic void testDynamicSentinel() throws Exception &#123; RedisURI redisUri = RedisURI.builder() .withPassword(\"ä½ çš„å¯†ç \") .withSentinel(\"localhost\", 26379) .withSentinelMasterId(\"å“¨å…µMasterçš„ID\") .build(); RedisClient redisClient = RedisClient.create(); StatefulRedisMasterSlaveConnection&lt;String, String&gt; connection = MasterSlave.connect(redisClient, new Utf8StringCodec(), redisUri); // åªå…è®¸ä»ä»èŠ‚ç‚¹è¯»å–æ•°æ® connection.setReadFrom(ReadFrom.SLAVE); RedisCommands&lt;String, String&gt; command = connection.sync(); SetArgs setArgs = SetArgs.Builder.nx().ex(5); command.set(\"name\", \"throwable\", setArgs); String value = command.get(\"name\"); log.info(\"Get value:&#123;&#125;\", value);&#125;// Get value:throwable é›†ç¾¤æ¨¡å¼ é‰´äºç¬”è€…å¯¹Redisé›†ç¾¤æ¨¡å¼å¹¶ä¸ç†Ÿæ‚‰ï¼ŒClusteræ¨¡å¼ä¸‹çš„APIä½¿ç”¨æœ¬èº«å°±æœ‰æ¯”è¾ƒå¤šçš„é™åˆ¶ï¼Œæ‰€ä»¥è¿™é‡Œåªç®€å•ä»‹ç»ä¸€ä¸‹æ€ä¹ˆç”¨ã€‚å…ˆè¯´å‡ ä¸ªç‰¹æ€§ï¼š ä¸‹é¢çš„APIæä¾›è·¨æ§½ä½ï¼ˆSlotï¼‰è°ƒç”¨çš„åŠŸèƒ½ï¼š RedisAdvancedClusterCommandsã€‚ RedisAdvancedClusterAsyncCommandsã€‚ RedisAdvancedClusterReactiveCommandsã€‚ é™æ€èŠ‚ç‚¹é€‰æ‹©åŠŸèƒ½ï¼š mastersï¼šé€‰æ‹©æ‰€æœ‰ä¸»èŠ‚ç‚¹æ‰§è¡Œå‘½ä»¤ã€‚ slavesï¼šé€‰æ‹©æ‰€æœ‰ä»èŠ‚ç‚¹æ‰§è¡Œå‘½ä»¤ï¼Œå…¶å®å°±æ˜¯åªè¯»æ¨¡å¼ã€‚ all nodesï¼šå‘½ä»¤å¯ä»¥åœ¨æ‰€æœ‰èŠ‚ç‚¹æ‰§è¡Œã€‚ é›†ç¾¤æ‹“æ‰‘è§†å›¾åŠ¨æ€æ›´æ–°åŠŸèƒ½ï¼š æ‰‹åŠ¨æ›´æ–°ï¼Œä¸»åŠ¨è°ƒç”¨RedisClusterClient#reloadPartitions()ã€‚ åå°å®šæ—¶æ›´æ–°ã€‚ è‡ªé€‚åº”æ›´æ–°ï¼ŒåŸºäºè¿æ¥æ–­å¼€å’ŒMOVED/ASKå‘½ä»¤é‡å®šå‘è‡ªåŠ¨æ›´æ–°ã€‚ Redisé›†ç¾¤æ­å»ºè¯¦ç»†è¿‡ç¨‹å¯ä»¥å‚è€ƒå®˜æ–¹æ–‡æ¡£ï¼Œå‡è®¾å·²ç»æ­å»ºå¥½é›†ç¾¤å¦‚ä¸‹ï¼ˆ192.168.56.200æ˜¯ç¬”è€…çš„è™šæ‹ŸæœºHostï¼‰ï¼š 192.168.56.200:7001 =&gt; ä¸»èŠ‚ç‚¹ï¼Œæ§½ä½0-5460ã€‚ 192.168.56.200:7002 =&gt; ä¸»èŠ‚ç‚¹ï¼Œæ§½ä½5461-10922ã€‚ 192.168.56.200:7003 =&gt; ä¸»èŠ‚ç‚¹ï¼Œæ§½ä½10923-16383ã€‚ 192.168.56.200:7004 =&gt; 7001çš„ä»èŠ‚ç‚¹ã€‚ 192.168.56.200:7005 =&gt; 7002çš„ä»èŠ‚ç‚¹ã€‚ 192.168.56.200:7006 =&gt; 7003çš„ä»èŠ‚ç‚¹ã€‚ ç®€å•çš„é›†ç¾¤è¿æ¥å’Œä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š 1234567891011@Testpublic void testSyncCluster()&#123; RedisURI uri = RedisURI.builder().withHost(\"192.168.56.200\").build(); RedisClusterClient redisClusterClient = RedisClusterClient.create(uri); StatefulRedisClusterConnection&lt;String, String&gt; connection = redisClusterClient.connect(); RedisAdvancedClusterCommands&lt;String, String&gt; commands = connection.sync(); commands.setex(\"name\",10, \"throwable\"); String value = commands.get(\"name\"); log.info(\"Get value:&#123;&#125;\", value);&#125;// Get value:throwable èŠ‚ç‚¹é€‰æ‹©ï¼š 1234567891011121314151617@Testpublic void testSyncNodeSelection() &#123; RedisURI uri = RedisURI.builder().withHost(\"192.168.56.200\").withPort(7001).build(); RedisClusterClient redisClusterClient = RedisClusterClient.create(uri); StatefulRedisClusterConnection&lt;String, String&gt; connection = redisClusterClient.connect(); RedisAdvancedClusterCommands&lt;String, String&gt; commands = connection.sync();// commands.all(); // æ‰€æœ‰èŠ‚ç‚¹// commands.masters(); // ä¸»èŠ‚ç‚¹ // ä»èŠ‚ç‚¹åªè¯» NodeSelection&lt;String, String&gt; replicas = commands.slaves(); NodeSelectionCommands&lt;String, String&gt; nodeSelectionCommands = replicas.commands(); // è¿™é‡Œåªæ˜¯æ¼”ç¤º,ä¸€èˆ¬åº”è¯¥ç¦ç”¨keys *å‘½ä»¤ Executions&lt;List&lt;String&gt;&gt; keys = nodeSelectionCommands.keys(\"*\"); keys.forEach(key -&gt; log.info(\"key: &#123;&#125;\", key)); connection.close(); redisClusterClient.shutdown();&#125; å®šæ—¶æ›´æ–°é›†ç¾¤æ‹“æ‰‘è§†å›¾ï¼ˆæ¯éš”ååˆ†é’Ÿæ›´æ–°ä¸€æ¬¡ï¼Œè¿™ä¸ªæ—¶é—´è‡ªè¡Œè€ƒé‡ï¼Œä¸èƒ½å¤ªé¢‘ç¹ï¼‰ï¼š 123456789101112131415161718@Testpublic void testPeriodicClusterTopology() throws Exception &#123; RedisURI uri = RedisURI.builder().withHost(\"192.168.56.200\").withPort(7001).build(); RedisClusterClient redisClusterClient = RedisClusterClient.create(uri); ClusterTopologyRefreshOptions options = ClusterTopologyRefreshOptions .builder() .enablePeriodicRefresh(Duration.of(10, ChronoUnit.MINUTES)) .build(); redisClusterClient.setOptions(ClusterClientOptions.builder().topologyRefreshOptions(options).build()); StatefulRedisClusterConnection&lt;String, String&gt; connection = redisClusterClient.connect(); RedisAdvancedClusterCommands&lt;String, String&gt; commands = connection.sync(); commands.setex(\"name\", 10, \"throwable\"); String value = commands.get(\"name\"); log.info(\"Get value:&#123;&#125;\", value); Thread.sleep(Integer.MAX_VALUE); connection.close(); redisClusterClient.shutdown();&#125; è‡ªé€‚åº”æ›´æ–°é›†ç¾¤æ‹“æ‰‘è§†å›¾ï¼š 123456789101112131415161718192021@Testpublic void testAdaptiveClusterTopology() throws Exception &#123; RedisURI uri = RedisURI.builder().withHost(\"192.168.56.200\").withPort(7001).build(); RedisClusterClient redisClusterClient = RedisClusterClient.create(uri); ClusterTopologyRefreshOptions options = ClusterTopologyRefreshOptions.builder() .enableAdaptiveRefreshTrigger( ClusterTopologyRefreshOptions.RefreshTrigger.MOVED_REDIRECT, ClusterTopologyRefreshOptions.RefreshTrigger.PERSISTENT_RECONNECTS ) .adaptiveRefreshTriggersTimeout(Duration.of(30, ChronoUnit.SECONDS)) .build(); redisClusterClient.setOptions(ClusterClientOptions.builder().topologyRefreshOptions(options).build()); StatefulRedisClusterConnection&lt;String, String&gt; connection = redisClusterClient.connect(); RedisAdvancedClusterCommands&lt;String, String&gt; commands = connection.sync(); commands.setex(\"name\", 10, \"throwable\"); String value = commands.get(\"name\"); log.info(\"Get value:&#123;&#125;\", value); Thread.sleep(Integer.MAX_VALUE); connection.close(); redisClusterClient.shutdown();&#125; åŠ¨æ€å‘½ä»¤å’Œè‡ªå®šä¹‰å‘½ä»¤ è‡ªå®šä¹‰å‘½ä»¤æ˜¯Rediså‘½ä»¤æœ‰é™é›†ï¼Œä¸è¿‡å¯ä»¥æ›´ç»†ç²’åº¦æŒ‡å®šKEYã€ARGVã€å‘½ä»¤ç±»å‹ã€ç¼–ç è§£ç å™¨å’Œè¿”å›å€¼ç±»å‹ï¼Œä¾èµ–äºdispatch()æ–¹æ³•ï¼š 123456789101112131415161718192021222324252627282930313233343536373839// è‡ªå®šä¹‰å®ç°PINGæ–¹æ³•@Testpublic void testCustomPing() throws Exception &#123; RedisURI redisUri = RedisURI.builder() .withHost(\"localhost\") .withPort(6379) .withTimeout(Duration.of(10, ChronoUnit.SECONDS)) .build(); RedisClient redisClient = RedisClient.create(redisUri); StatefulRedisConnection&lt;String, String&gt; connect = redisClient.connect(); RedisCommands&lt;String, String&gt; sync = connect.sync(); RedisCodec&lt;String, String&gt; codec = StringCodec.UTF8; String result = sync.dispatch(CommandType.PING, new StatusOutput&lt;&gt;(codec)); log.info(\"PING:&#123;&#125;\", result); connect.close(); redisClient.shutdown();&#125;// PING:PONG// è‡ªå®šä¹‰å®ç°Setæ–¹æ³•@Testpublic void testCustomSet() throws Exception &#123; RedisURI redisUri = RedisURI.builder() .withHost(\"localhost\") .withPort(6379) .withTimeout(Duration.of(10, ChronoUnit.SECONDS)) .build(); RedisClient redisClient = RedisClient.create(redisUri); StatefulRedisConnection&lt;String, String&gt; connect = redisClient.connect(); RedisCommands&lt;String, String&gt; sync = connect.sync(); RedisCodec&lt;String, String&gt; codec = StringCodec.UTF8; sync.dispatch(CommandType.SETEX, new StatusOutput&lt;&gt;(codec), new CommandArgs&lt;&gt;(codec).addKey(\"name\").add(5).addValue(\"throwable\")); String result = sync.get(\"name\"); log.info(\"Get value:&#123;&#125;\", result); connect.close(); redisClient.shutdown();&#125;// Get value:throwable åŠ¨æ€å‘½ä»¤æ˜¯åŸºäºRediså‘½ä»¤æœ‰é™é›†ï¼Œå¹¶ä¸”é€šè¿‡æ³¨è§£å’ŒåŠ¨æ€ä»£ç†å®Œæˆä¸€äº›å¤æ‚å‘½ä»¤ç»„åˆçš„å®ç°ã€‚ä¸»è¦æ³¨è§£åœ¨io.lettuce.core.dynamic.annotationåŒ…è·¯å¾„ä¸‹ã€‚ç®€å•ä¸¾ä¸ªä¾‹å­ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142public interface CustomCommand extends Commands &#123; // SET [key] [value] @Command(\"SET ?0 ?1\") String setKey(String key, String value); // SET [key] [value] @Command(\"SET :key :value\") String setKeyNamed(@Param(\"key\") String key, @Param(\"value\") String value); // MGET [key1] [key2] @Command(\"MGET ?0 ?1\") List&lt;String&gt; mGet(String key1, String key2); /** * æ–¹æ³•åä½œä¸ºå‘½ä»¤ */ @CommandNaming(strategy = CommandNaming.Strategy.METHOD_NAME) String mSet(String key1, String value1, String key2, String value2);&#125;@Testpublic void testCustomDynamicSet() throws Exception &#123; RedisURI redisUri = RedisURI.builder() .withHost(\"localhost\") .withPort(6379) .withTimeout(Duration.of(10, ChronoUnit.SECONDS)) .build(); RedisClient redisClient = RedisClient.create(redisUri); StatefulRedisConnection&lt;String, String&gt; connect = redisClient.connect(); RedisCommandFactory commandFactory = new RedisCommandFactory(connect); CustomCommand commands = commandFactory.getCommands(CustomCommand.class); commands.setKey(\"name\", \"throwable\"); commands.setKeyNamed(\"throwable\", \"doge\"); log.info(\"MGET ===&gt; \" + commands.mGet(\"name\", \"throwable\")); commands.mSet(\"key1\", \"value1\",\"key2\", \"value2\"); log.info(\"MGET ===&gt; \" + commands.mGet(\"key1\", \"key2\")); connect.close(); redisClient.shutdown();&#125;// MGET ===&gt; [throwable, doge]// MGET ===&gt; [value1, value2] é«˜é˜¶ç‰¹æ€§ Lettuceæœ‰å¾ˆå¤šé«˜é˜¶ä½¿ç”¨ç‰¹æ€§ï¼Œè¿™é‡Œåªåˆ—ä¸¾ä¸ªäººè®¤ä¸ºå¸¸ç”¨çš„ä¸¤ç‚¹ï¼š é…ç½®å®¢æˆ·ç«¯èµ„æºã€‚ ä½¿ç”¨è¿æ¥æ± ã€‚ æ›´å¤šå…¶ä»–ç‰¹æ€§å¯ä»¥è‡ªè¡Œå‚çœ‹å®˜æ–¹æ–‡æ¡£ã€‚ é…ç½®å®¢æˆ·ç«¯èµ„æº å®¢æˆ·ç«¯èµ„æºçš„è®¾ç½®ä¸Lettuceçš„æ€§èƒ½ã€å¹¶å‘å’Œäº‹ä»¶å¤„ç†ç›¸å…³ã€‚çº¿ç¨‹æ± æˆ–è€…çº¿ç¨‹ç»„ç›¸å…³é…ç½®å æ®å®¢æˆ·ç«¯èµ„æºé…ç½®çš„å¤§éƒ¨åˆ†ï¼ˆEventLoopGroupså’ŒEventExecutorGroupï¼‰ï¼Œè¿™äº›çº¿ç¨‹æ± æˆ–è€…çº¿ç¨‹ç»„æ˜¯è¿æ¥ç¨‹åºçš„åŸºç¡€ç»„ä»¶ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå®¢æˆ·ç«¯èµ„æºåº”è¯¥åœ¨å¤šä¸ªRediså®¢æˆ·ç«¯ä¹‹é—´å…±äº«ï¼Œå¹¶ä¸”åœ¨ä¸å†ä½¿ç”¨çš„æ—¶å€™éœ€è¦è‡ªè¡Œå…³é—­ã€‚ç¬”è€…è®¤ä¸ºï¼Œå®¢æˆ·ç«¯èµ„æºæ˜¯é¢å‘Nettyçš„ã€‚æ³¨æ„ï¼šé™¤éç‰¹åˆ«ç†Ÿæ‚‰æˆ–è€…èŠ±é•¿æ—¶é—´å»æµ‹è¯•è°ƒæ•´ä¸‹é¢æåˆ°çš„å‚æ•°ï¼Œå¦åˆ™åœ¨æ²¡æœ‰ç»éªŒçš„å‰æä¸‹å‡­ç›´è§‰ä¿®æ”¹é»˜è®¤å€¼ï¼Œæœ‰å¯èƒ½ä¼šè¸©å‘ã€‚ å®¢æˆ·ç«¯èµ„æºæ¥å£æ˜¯ClientResourcesï¼Œå®ç°ç±»æ˜¯DefaultClientResourcesã€‚ æ„å»ºDefaultClientResourceså®ä¾‹ï¼š 12345678// é»˜è®¤ClientResources resources = DefaultClientResources.create();// å»ºé€ å™¨ClientResources resources = DefaultClientResources.builder() .ioThreadPoolSize(4) .computationThreadPoolSize(4) .build() ä½¿ç”¨ï¼š 12345678910ClientResources resources = DefaultClientResources.create();// éé›†ç¾¤RedisClient client = RedisClient.create(resources, uri);// é›†ç¾¤RedisClusterClient clusterClient = RedisClusterClient.create(resources, uris);// ......client.shutdown();clusterClient.shutdown();// å…³é—­èµ„æºresources.shutdown(); å®¢æˆ·ç«¯èµ„æºåŸºæœ¬é…ç½®ï¼š å±æ€§ æè¿° é»˜è®¤å€¼ ioThreadPoolSize I/Oçº¿ç¨‹æ•° Runtime.getRuntime().availableProcessors() computationThreadPoolSize ä»»åŠ¡çº¿ç¨‹æ•° Runtime.getRuntime().availableProcessors() å®¢æˆ·ç«¯èµ„æºé«˜çº§é…ç½®ï¼š å±æ€§ æè¿° é»˜è®¤å€¼ eventLoopGroupProvider EventLoopGroupæä¾›å•† - eventExecutorGroupProvider EventExecutorGroupæä¾›å•† - eventBus äº‹ä»¶æ€»çº¿ DefaultEventBus commandLatencyCollectorOptions å‘½ä»¤å»¶æ—¶æ”¶é›†å™¨é…ç½® DefaultCommandLatencyCollectorOptions commandLatencyCollector å‘½ä»¤å»¶æ—¶æ”¶é›†å™¨ DefaultCommandLatencyCollector commandLatencyPublisherOptions å‘½ä»¤å»¶æ—¶å‘å¸ƒå™¨é…ç½® DefaultEventPublisherOptions dnsResolver DNSå¤„ç†å™¨ JDKæˆ–è€…Nettyæä¾› reconnectDelay é‡è¿å»¶æ—¶é…ç½® Delay.exponential() nettyCustomizer Nettyè‡ªå®šä¹‰é…ç½®å™¨ - tracing è½¨è¿¹è®°å½•å™¨ - éé›†ç¾¤å®¢æˆ·ç«¯RedisClientçš„å±æ€§é…ç½®ï¼š Rediséé›†ç¾¤å®¢æˆ·ç«¯RedisClientæœ¬èº«æä¾›äº†é…ç½®å±æ€§æ–¹æ³•ï¼š 12345RedisClient client = RedisClient.create(uri);client.setOptions(ClientOptions.builder() .autoReconnect(false) .pingBeforeActivateConnection(true) .build()); éé›†ç¾¤å®¢æˆ·ç«¯çš„é…ç½®å±æ€§åˆ—è¡¨ï¼š å±æ€§ æè¿° é»˜è®¤å€¼ pingBeforeActivateConnection è¿æ¥æ¿€æ´»ä¹‹å‰æ˜¯å¦æ‰§è¡ŒPINGå‘½ä»¤ false autoReconnect æ˜¯å¦è‡ªåŠ¨é‡è¿ true cancelCommandsOnReconnectFailure é‡è¿å¤±è´¥æ˜¯å¦æ‹’ç»å‘½ä»¤æ‰§è¡Œ false suspendReconnectOnProtocolFailure åº•å±‚åè®®å¤±è´¥æ˜¯å¦æŒ‚èµ·é‡è¿æ“ä½œ false requestQueueSize è¯·æ±‚é˜Ÿåˆ—å®¹é‡ 2147483647(Integer#MAX_VALUE) disconnectedBehavior å¤±å»è¿æ¥æ—¶å€™çš„è¡Œä¸º DEFAULT sslOptions SSLé…ç½® - socketOptions Socketé…ç½® 10 seconds Connection-Timeout, no keep-alive, no TCP noDelay timeoutOptions è¶…æ—¶é…ç½® - publishOnScheduler å‘å¸ƒååº”å¼ä¿¡å·æ•°æ®çš„è°ƒåº¦å™¨ ä½¿ç”¨I/Oçº¿ç¨‹ é›†ç¾¤å®¢æˆ·ç«¯å±æ€§é…ç½®ï¼š Redisé›†ç¾¤å®¢æˆ·ç«¯RedisClusterClientæœ¬èº«æä¾›äº†é…ç½®å±æ€§æ–¹æ³•ï¼š 123456789RedisClusterClient client = RedisClusterClient.create(uri);ClusterTopologyRefreshOptions topologyRefreshOptions = ClusterTopologyRefreshOptions.builder() .enablePeriodicRefresh(refreshPeriod(10, TimeUnit.MINUTES)) .enableAllAdaptiveRefreshTriggers() .build();client.setOptions(ClusterClientOptions.builder() .topologyRefreshOptions(topologyRefreshOptions) .build()); é›†ç¾¤å®¢æˆ·ç«¯çš„é…ç½®å±æ€§åˆ—è¡¨ï¼š å±æ€§ æè¿° é»˜è®¤å€¼ enablePeriodicRefresh æ˜¯å¦å…è®¸å‘¨æœŸæ€§æ›´æ–°é›†ç¾¤æ‹“æ‰‘è§†å›¾ false refreshPeriod æ›´æ–°é›†ç¾¤æ‹“æ‰‘è§†å›¾å‘¨æœŸ 60ç§’ enableAdaptiveRefreshTrigger è®¾ç½®è‡ªé€‚åº”æ›´æ–°é›†ç¾¤æ‹“æ‰‘è§†å›¾è§¦å‘å™¨RefreshTrigger - adaptiveRefreshTriggersTimeout è‡ªé€‚åº”æ›´æ–°é›†ç¾¤æ‹“æ‰‘è§†å›¾è§¦å‘å™¨è¶…æ—¶è®¾ç½® 30ç§’ refreshTriggersReconnectAttempts è‡ªé€‚åº”æ›´æ–°é›†ç¾¤æ‹“æ‰‘è§†å›¾è§¦å‘é‡è¿æ¬¡æ•° 5 dynamicRefreshSources æ˜¯å¦å…è®¸åŠ¨æ€åˆ·æ–°æ‹“æ‰‘èµ„æº true closeStaleConnections æ˜¯å¦å…è®¸å…³é—­é™ˆæ—§çš„è¿æ¥ true maxRedirects é›†ç¾¤é‡å®šå‘æ¬¡æ•°ä¸Šé™ 5 validateClusterNodeMembership æ˜¯å¦æ ¡éªŒé›†ç¾¤èŠ‚ç‚¹çš„æˆå‘˜å…³ç³» true ä½¿ç”¨è¿æ¥æ±  å¼•å…¥è¿æ¥æ± ä¾èµ–commons-pool2ï¼š 12345&lt;dependency&gt; &lt;groupId&gt;org.apache.commons&lt;/groupId&gt; &lt;artifactId&gt;commons-pool2&lt;/artifactId&gt; &lt;version&gt;2.7.0&lt;/version&gt;&lt;/dependency åŸºæœ¬ä½¿ç”¨å¦‚ä¸‹ï¼š 123456789101112131415161718192021@Testpublic void testUseConnectionPool() throws Exception &#123; RedisURI redisUri = RedisURI.builder() .withHost(\"localhost\") .withPort(6379) .withTimeout(Duration.of(10, ChronoUnit.SECONDS)) .build(); RedisClient redisClient = RedisClient.create(redisUri); GenericObjectPoolConfig poolConfig = new GenericObjectPoolConfig(); GenericObjectPool&lt;StatefulRedisConnection&lt;String, String&gt;&gt; pool = ConnectionPoolSupport.createGenericObjectPool(redisClient::connect, poolConfig); try (StatefulRedisConnection&lt;String, String&gt; connection = pool.borrowObject()) &#123; RedisCommands&lt;String, String&gt; command = connection.sync(); SetArgs setArgs = SetArgs.Builder.nx().ex(5); command.set(\"name\", \"throwable\", setArgs); String n = command.get(\"name\"); log.info(\"Get value:&#123;&#125;\", n); &#125; pool.close(); redisClient.shutdown();&#125; å…¶ä¸­ï¼ŒåŒæ­¥è¿æ¥çš„æ± åŒ–æ”¯æŒéœ€è¦ç”¨ConnectionPoolSupportï¼Œå¼‚æ­¥è¿æ¥çš„æ± åŒ–æ”¯æŒéœ€è¦ç”¨AsyncConnectionPoolSupportï¼ˆLettuce5.1ä¹‹åæ‰æ”¯æŒï¼‰ã€‚ å‡ ä¸ªå¸¸è§çš„æ¸è¿›å¼åˆ é™¤ä¾‹å­ æ¸è¿›å¼åˆ é™¤Hashä¸­çš„åŸŸ-å±æ€§ï¼š 1234567891011121314151617181920212223242526272829303132@Testpublic void testDelBigHashKey() throws Exception &#123; // SCANå‚æ•° ScanArgs scanArgs = ScanArgs.Builder.limit(2); // TEMPæ¸¸æ ‡ ScanCursor cursor = ScanCursor.INITIAL; // ç›®æ ‡KEY String key = \"BIG_HASH_KEY\"; prepareHashTestData(key); log.info(\"å¼€å§‹æ¸è¿›å¼åˆ é™¤Hashçš„å…ƒç´ ...\"); int counter = 0; do &#123; MapScanCursor&lt;String, String&gt; result = COMMAND.hscan(key, cursor, scanArgs); // é‡ç½®TEMPæ¸¸æ ‡ cursor = ScanCursor.of(result.getCursor()); cursor.setFinished(result.isFinished()); Collection&lt;String&gt; fields = result.getMap().values(); if (!fields.isEmpty()) &#123; COMMAND.hdel(key, fields.toArray(new String[0])); &#125; counter++; &#125; while (!(ScanCursor.FINISHED.getCursor().equals(cursor.getCursor()) &amp;&amp; ScanCursor.FINISHED.isFinished() == cursor.isFinished())); log.info(\"æ¸è¿›å¼åˆ é™¤Hashçš„å…ƒç´ å®Œæ¯•,è¿­ä»£æ¬¡æ•°:&#123;&#125; ...\", counter);&#125;private void prepareHashTestData(String key) throws Exception &#123; COMMAND.hset(key, \"1\", \"1\"); COMMAND.hset(key, \"2\", \"2\"); COMMAND.hset(key, \"3\", \"3\"); COMMAND.hset(key, \"4\", \"4\"); COMMAND.hset(key, \"5\", \"5\");&#125; æ¸è¿›å¼åˆ é™¤é›†åˆä¸­çš„å…ƒç´ ï¼š 123456789101112131415161718192021222324252627@Testpublic void testDelBigSetKey() throws Exception &#123; String key = \"BIG_SET_KEY\"; prepareSetTestData(key); // SCANå‚æ•° ScanArgs scanArgs = ScanArgs.Builder.limit(2); // TEMPæ¸¸æ ‡ ScanCursor cursor = ScanCursor.INITIAL; log.info(\"å¼€å§‹æ¸è¿›å¼åˆ é™¤Setçš„å…ƒç´ ...\"); int counter = 0; do &#123; ValueScanCursor&lt;String&gt; result = COMMAND.sscan(key, cursor, scanArgs); // é‡ç½®TEMPæ¸¸æ ‡ cursor = ScanCursor.of(result.getCursor()); cursor.setFinished(result.isFinished()); List&lt;String&gt; values = result.getValues(); if (!values.isEmpty()) &#123; COMMAND.srem(key, values.toArray(new String[0])); &#125; counter++; &#125; while (!(ScanCursor.FINISHED.getCursor().equals(cursor.getCursor()) &amp;&amp; ScanCursor.FINISHED.isFinished() == cursor.isFinished())); log.info(\"æ¸è¿›å¼åˆ é™¤Setçš„å…ƒç´ å®Œæ¯•,è¿­ä»£æ¬¡æ•°:&#123;&#125; ...\", counter);&#125;private void prepareSetTestData(String key) throws Exception &#123; COMMAND.sadd(key, \"1\", \"2\", \"3\", \"4\", \"5\");&#125; æ¸è¿›å¼åˆ é™¤æœ‰åºé›†åˆä¸­çš„å…ƒç´ ï¼š 1234567891011121314151617181920212223242526272829303132@Testpublic void testDelBigZSetKey() throws Exception &#123; // SCANå‚æ•° ScanArgs scanArgs = ScanArgs.Builder.limit(2); // TEMPæ¸¸æ ‡ ScanCursor cursor = ScanCursor.INITIAL; // ç›®æ ‡KEY String key = \"BIG_ZSET_KEY\"; prepareZSetTestData(key); log.info(\"å¼€å§‹æ¸è¿›å¼åˆ é™¤ZSetçš„å…ƒç´ ...\"); int counter = 0; do &#123; ScoredValueScanCursor&lt;String&gt; result = COMMAND.zscan(key, cursor, scanArgs); // é‡ç½®TEMPæ¸¸æ ‡ cursor = ScanCursor.of(result.getCursor()); cursor.setFinished(result.isFinished()); List&lt;ScoredValue&lt;String&gt;&gt; scoredValues = result.getValues(); if (!scoredValues.isEmpty()) &#123; COMMAND.zrem(key, scoredValues.stream().map(ScoredValue&lt;String&gt;::getValue).toArray(String[]::new)); &#125; counter++; &#125; while (!(ScanCursor.FINISHED.getCursor().equals(cursor.getCursor()) &amp;&amp; ScanCursor.FINISHED.isFinished() == cursor.isFinished())); log.info(\"æ¸è¿›å¼åˆ é™¤ZSetçš„å…ƒç´ å®Œæ¯•,è¿­ä»£æ¬¡æ•°:&#123;&#125; ...\", counter);&#125;private void prepareZSetTestData(String key) throws Exception &#123; COMMAND.zadd(key, 0, \"1\"); COMMAND.zadd(key, 0, \"2\"); COMMAND.zadd(key, 0, \"3\"); COMMAND.zadd(key, 0, \"4\"); COMMAND.zadd(key, 0, \"5\");&#125; åœ¨SpringBootä¸­ä½¿ç”¨Lettuce ä¸ªäººè®¤ä¸ºï¼Œspring-data-redisä¸­çš„APIå°è£…å¹¶ä¸æ˜¯å¾ˆä¼˜ç§€ï¼Œç”¨èµ·æ¥æ¯”è¾ƒé‡ï¼Œä¸å¤Ÿçµæ´»ï¼Œè¿™é‡Œç»“åˆå‰é¢çš„ä¾‹å­å’Œä»£ç ï¼Œåœ¨SpringBootè„šæ‰‹æ¶é¡¹ç›®ä¸­é…ç½®å’Œæ•´åˆLettuceã€‚å…ˆå¼•å…¥ä¾èµ–ï¼š 12345678910111213141516171819202122232425262728&lt;dependencyManagement&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-dependencies&lt;/artifactId&gt; &lt;version&gt;2.1.8.RELEASE&lt;/version&gt; &lt;type&gt;pom&lt;/type&gt; &lt;scope&gt;import&lt;/scope&gt; &lt;/dependency&gt; &lt;/dependencies&gt;&lt;/dependencyManagement&gt;&lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;io.lettuce&lt;/groupId&gt; &lt;artifactId&gt;lettuce-core&lt;/artifactId&gt; &lt;version&gt;5.1.8.RELEASE&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.projectlombok&lt;/groupId&gt; &lt;artifactId&gt;lombok&lt;/artifactId&gt; &lt;version&gt;1.18.10&lt;/version&gt; &lt;scope&gt;provided&lt;/scope&gt; &lt;/dependency&gt;&lt;/dependencies&gt; ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ¯ä¸ªåº”ç”¨åº”è¯¥ä½¿ç”¨å•ä¸ªRediså®¢æˆ·ç«¯å®ä¾‹å’Œå•ä¸ªè¿æ¥å®ä¾‹ï¼Œè¿™é‡Œè®¾è®¡ä¸€ä¸ªè„šæ‰‹æ¶ï¼Œé€‚é…å•æœºã€æ™®é€šä¸»ä»ã€å“¨å…µå’Œé›†ç¾¤å››ç§ä½¿ç”¨åœºæ™¯ã€‚å¯¹äºå®¢æˆ·ç«¯èµ„æºï¼Œé‡‡ç”¨é»˜è®¤çš„å®ç°å³å¯ã€‚å¯¹äºRedisçš„è¿æ¥å±æ€§ï¼Œæ¯”è¾ƒä¸»è¦çš„æœ‰Hostã€Portå’ŒPasswordï¼Œå…¶ä»–å¯ä»¥æš‚æ—¶å¿½ç•¥ã€‚åŸºäºçº¦å®šå¤§äºé…ç½®çš„åŸåˆ™ï¼Œå…ˆå®šåˆ¶ä¸€ç³»åˆ—å±æ€§é…ç½®ç±»ï¼ˆå…¶å®æœ‰äº›é…ç½®æ˜¯å¯ä»¥å®Œå…¨å…±ç”¨ï¼Œä½†æ˜¯è€ƒè™‘åˆ°è¦æ¸…æ™°æè¿°ç±»ä¹‹é—´çš„å…³ç³»ï¼Œè¿™é‡Œæ‹†åˆ†å¤šä¸ªé…ç½®å±æ€§ç±»å’Œå¤šä¸ªé…ç½®æ–¹æ³•ï¼‰ï¼š 12345678910111213141516171819202122232425262728293031323334353637@Data@ConfigurationProperties(prefix = \"lettuce\")public class LettuceProperties &#123; private LettuceSingleProperties single; private LettuceReplicaProperties replica; private LettuceSentinelProperties sentinel; private LettuceClusterProperties cluster;&#125;@Datapublic class LettuceSingleProperties &#123; private String host; private Integer port; private String password;&#125;@EqualsAndHashCode(callSuper = true)@Datapublic class LettuceReplicaProperties extends LettuceSingleProperties &#123;&#125;@EqualsAndHashCode(callSuper = true)@Datapublic class LettuceSentinelProperties extends LettuceSingleProperties &#123; private String masterId;&#125;@EqualsAndHashCode(callSuper = true)@Datapublic class LettuceClusterProperties extends LettuceSingleProperties &#123;&#125; é…ç½®ç±»å¦‚ä¸‹ï¼Œä¸»è¦ä½¿ç”¨@ConditionalOnPropertyåšéš”ç¦»ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¾ˆå°‘æœ‰äººä¼šåœ¨ä¸€ä¸ªåº”ç”¨ä½¿ç”¨ä¸€ç§ä»¥ä¸Šçš„Redisè¿æ¥åœºæ™¯ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107@RequiredArgsConstructor@Configuration@ConditionalOnClass(name = \"io.lettuce.core.RedisURI\")@EnableConfigurationProperties(value = LettuceProperties.class)public class LettuceAutoConfiguration &#123; private final LettuceProperties lettuceProperties; @Bean(destroyMethod = \"shutdown\") public ClientResources clientResources() &#123; return DefaultClientResources.create(); &#125; @Bean @ConditionalOnProperty(name = \"lettuce.single.host\") public RedisURI singleRedisUri() &#123; LettuceSingleProperties singleProperties = lettuceProperties.getSingle(); return RedisURI.builder() .withHost(singleProperties.getHost()) .withPort(singleProperties.getPort()) .withPassword(singleProperties.getPassword()) .build(); &#125; @Bean(destroyMethod = \"shutdown\") @ConditionalOnProperty(name = \"lettuce.single.host\") public RedisClient singleRedisClient(ClientResources clientResources, @Qualifier(\"singleRedisUri\") RedisURI redisUri) &#123; return RedisClient.create(clientResources, redisUri); &#125; @Bean(destroyMethod = \"close\") @ConditionalOnProperty(name = \"lettuce.single.host\") public StatefulRedisConnection&lt;String, String&gt; singleRedisConnection(@Qualifier(\"singleRedisClient\") RedisClient singleRedisClient) &#123; return singleRedisClient.connect(); &#125; @Bean @ConditionalOnProperty(name = \"lettuce.replica.host\") public RedisURI replicaRedisUri() &#123; LettuceReplicaProperties replicaProperties = lettuceProperties.getReplica(); return RedisURI.builder() .withHost(replicaProperties.getHost()) .withPort(replicaProperties.getPort()) .withPassword(replicaProperties.getPassword()) .build(); &#125; @Bean(destroyMethod = \"shutdown\") @ConditionalOnProperty(name = \"lettuce.replica.host\") public RedisClient replicaRedisClient(ClientResources clientResources, @Qualifier(\"replicaRedisUri\") RedisURI redisUri) &#123; return RedisClient.create(clientResources, redisUri); &#125; @Bean(destroyMethod = \"close\") @ConditionalOnProperty(name = \"lettuce.replica.host\") public StatefulRedisMasterSlaveConnection&lt;String, String&gt; replicaRedisConnection(@Qualifier(\"replicaRedisClient\") RedisClient replicaRedisClient, @Qualifier(\"replicaRedisUri\") RedisURI redisUri) &#123; return MasterSlave.connect(replicaRedisClient, new Utf8StringCodec(), redisUri); &#125; @Bean @ConditionalOnProperty(name = \"lettuce.sentinel.host\") public RedisURI sentinelRedisUri() &#123; LettuceSentinelProperties sentinelProperties = lettuceProperties.getSentinel(); return RedisURI.builder() .withPassword(sentinelProperties.getPassword()) .withSentinel(sentinelProperties.getHost(), sentinelProperties.getPort()) .withSentinelMasterId(sentinelProperties.getMasterId()) .build(); &#125; @Bean(destroyMethod = \"shutdown\") @ConditionalOnProperty(name = \"lettuce.sentinel.host\") public RedisClient sentinelRedisClient(ClientResources clientResources, @Qualifier(\"sentinelRedisUri\") RedisURI redisUri) &#123; return RedisClient.create(clientResources, redisUri); &#125; @Bean(destroyMethod = \"close\") @ConditionalOnProperty(name = \"lettuce.sentinel.host\") public StatefulRedisMasterSlaveConnection&lt;String, String&gt; sentinelRedisConnection(@Qualifier(\"sentinelRedisClient\") RedisClient sentinelRedisClient, @Qualifier(\"sentinelRedisUri\") RedisURI redisUri) &#123; return MasterSlave.connect(sentinelRedisClient, new Utf8StringCodec(), redisUri); &#125; @Bean @ConditionalOnProperty(name = \"lettuce.cluster.host\") public RedisURI clusterRedisUri() &#123; LettuceClusterProperties clusterProperties = lettuceProperties.getCluster(); return RedisURI.builder() .withHost(clusterProperties.getHost()) .withPort(clusterProperties.getPort()) .withPassword(clusterProperties.getPassword()) .build(); &#125; @Bean(destroyMethod = \"shutdown\") @ConditionalOnProperty(name = \"lettuce.cluster.host\") public RedisClusterClient redisClusterClient(ClientResources clientResources, @Qualifier(\"clusterRedisUri\") RedisURI redisUri) &#123; return RedisClusterClient.create(clientResources, redisUri); &#125; @Bean(destroyMethod = \"close\") @ConditionalOnProperty(name = \"lettuce.cluster\") public StatefulRedisClusterConnection&lt;String, String&gt; clusterConnection(RedisClusterClient clusterClient) &#123; return clusterClient.connect(); &#125;&#125; æœ€åä¸ºäº†è®©IDEè¯†åˆ«æˆ‘ä»¬çš„é…ç½®ï¼Œå¯ä»¥æ·»åŠ IDEäº²ç¼˜æ€§ï¼Œ/META-INFæ–‡ä»¶å¤¹ä¸‹æ–°å¢ä¸€ä¸ªæ–‡ä»¶spring-configuration-metadata.jsonï¼Œå†…å®¹å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728&#123; \"properties\": [ &#123; \"name\": \"lettuce.single\", \"type\": \"club.throwable.spring.lettuce.LettuceSingleProperties\", \"description\": \"å•æœºé…ç½®\", \"sourceType\": \"club.throwable.spring.lettuce.LettuceProperties\" &#125;, &#123; \"name\": \"lettuce.replica\", \"type\": \"club.throwable.spring.lettuce.LettuceReplicaProperties\", \"description\": \"ä¸»ä»é…ç½®\", \"sourceType\": \"club.throwable.spring.lettuce.LettuceProperties\" &#125;, &#123; \"name\": \"lettuce.sentinel\", \"type\": \"club.throwable.spring.lettuce.LettuceSentinelProperties\", \"description\": \"å“¨å…µé…ç½®\", \"sourceType\": \"club.throwable.spring.lettuce.LettuceProperties\" &#125;, &#123; \"name\": \"lettuce.single\", \"type\": \"club.throwable.spring.lettuce.LettuceClusterProperties\", \"description\": \"é›†ç¾¤é…ç½®\", \"sourceType\": \"club.throwable.spring.lettuce.LettuceProperties\" &#125; ]&#125; å¦‚æœæƒ³IDEäº²ç¼˜æ€§åšå¾—æ›´å¥½ï¼Œå¯ä»¥æ·»åŠ /META-INF/additional-spring-configuration-metadata.jsonè¿›è¡Œæ›´å¤šç»†èŠ‚å®šä¹‰ã€‚ç®€å•ä½¿ç”¨å¦‚ä¸‹ï¼š 12345678910111213141516@Slf4j@Componentpublic class RedisCommandLineRunner implements CommandLineRunner &#123; @Autowired @Qualifier(\"singleRedisConnection\") private StatefulRedisConnection&lt;String, String&gt; connection; @Override public void run(String... args) throws Exception &#123; RedisCommands&lt;String, String&gt; redisCommands = connection.sync(); redisCommands.setex(\"name\", 5, \"throwable\"); log.info(\"Get value:&#123;&#125;\", redisCommands.get(\"name\")); &#125;&#125;// Get value:throwable å°ç»“ æœ¬æ–‡ç®—æ˜¯åŸºäºLettuceçš„å®˜æ–¹æ–‡æ¡£ï¼Œå¯¹å®ƒçš„ä½¿ç”¨è¿›è¡Œå…¨æ–¹ä½çš„åˆ†æï¼ŒåŒ…æ‹¬ä¸»è¦åŠŸèƒ½ã€é…ç½®éƒ½åšäº†ä¸€äº›ç¤ºä¾‹ï¼Œé™äºç¯‡å¹…éƒ¨åˆ†ç‰¹æ€§å’Œé…ç½®ç»†èŠ‚æ²¡æœ‰åˆ†æã€‚Lettuceå·²ç»è¢«spring-data-redisæ¥çº³ä½œä¸ºå®˜æ–¹çš„Rediså®¢æˆ·ç«¯é©±åŠ¨ï¼Œæ‰€ä»¥å€¼å¾—ä¿¡èµ–ï¼Œå®ƒçš„ä¸€äº›APIè®¾è®¡ç¡®å®æ¯”è¾ƒåˆç†ï¼Œæ‰©å±•æ€§é«˜çš„åŒæ—¶çµæ´»æ€§ä¹Ÿé«˜ã€‚ä¸ªäººå»ºè®®ï¼ŒåŸºäºLettuceåŒ…è‡ªè¡Œæ·»åŠ é…ç½®åˆ°SpringBootåº”ç”¨ç”¨èµ·æ¥ä¼šå¾—å¿ƒåº”æ‰‹ï¼Œæ¯•ç«ŸRedisTemplateå®åœ¨å¤ªç¬¨é‡ï¼Œè€Œä¸”è¿˜å±è”½äº†Lettuceä¸€äº›é«˜çº§ç‰¹æ€§å’Œçµæ´»çš„APIã€‚ å‚è€ƒèµ„æ–™ï¼š Lettuce Reference Guide ï¼ˆæœ¬æ–‡å®Œ c-14-d e-a-20190928 æœ€è¿‘äº‹å¤ªå¤šâ€¦ï¼‰","categories":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/categories/Middleware/"},{"name":"Redis","slug":"Middleware/Redis","permalink":"http://throwable.club/blog/categories/Middleware/Redis/"}],"tags":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/tags/Middleware/"},{"name":"Redis","slug":"Redis","permalink":"http://throwable.club/blog/tags/Redis/"}]},{"title":"ä½¿ç”¨Rediså®ç°å»¶æ—¶ä»»åŠ¡(äºŒ)","slug":"redis-delay-task-second","date":"2019-09-01T12:50:09.000Z","updated":"2019-11-28T17:00:53.907Z","comments":true,"path":"2019/09/01/redis-delay-task-second/","link":"","permalink":"http://throwable.club/2019/09/01/redis-delay-task-second/","excerpt":"å‰æ å‰ä¸€ç¯‡æ–‡ç« é€šè¿‡Redisçš„æœ‰åºé›†åˆSorted Setå’Œè°ƒåº¦æ¡†æ¶Quartzå®ä¾‹ä¸€ç‰ˆç®€å•çš„å»¶æ—¶ä»»åŠ¡ï¼Œä½†æ˜¯æœ‰ä¸¤ä¸ªç›¸å¯¹é‡è¦çš„é—®é¢˜æ²¡æœ‰è§£å†³ï¼š åˆ†ç‰‡ã€‚ ç›‘æ§ã€‚ è¿™ç¯‡æ–‡ç« çš„å†…å®¹å°±æ˜¯è¦å®Œå–„è¿™ä¸¤ä¸ªæ–¹é¢çš„åŠŸèƒ½ã€‚å‰ç½®æ–‡ç« ï¼šä½¿ç”¨Rediså®ç°å»¶æ—¶ä»»åŠ¡(ä¸€)ã€‚","text":"å‰æ å‰ä¸€ç¯‡æ–‡ç« é€šè¿‡Redisçš„æœ‰åºé›†åˆSorted Setå’Œè°ƒåº¦æ¡†æ¶Quartzå®ä¾‹ä¸€ç‰ˆç®€å•çš„å»¶æ—¶ä»»åŠ¡ï¼Œä½†æ˜¯æœ‰ä¸¤ä¸ªç›¸å¯¹é‡è¦çš„é—®é¢˜æ²¡æœ‰è§£å†³ï¼š åˆ†ç‰‡ã€‚ ç›‘æ§ã€‚ è¿™ç¯‡æ–‡ç« çš„å†…å®¹å°±æ˜¯è¦å®Œå–„è¿™ä¸¤ä¸ªæ–¹é¢çš„åŠŸèƒ½ã€‚å‰ç½®æ–‡ç« ï¼šä½¿ç”¨Rediså®ç°å»¶æ—¶ä»»åŠ¡(ä¸€)ã€‚ ä¸ºä»€ä¹ˆéœ€è¦åˆ†ç‰‡ è¿™é‡Œé‡æ–°è´´ä¸€ä¸‹æŸ¥è¯¢è„šæœ¬dequeue.luaçš„å†…å®¹ï¼š 12345678910111213141516171819202122-- å‚è€ƒjesqueçš„éƒ¨åˆ†Luaè„šæœ¬å®ç°local zset_key = KEYS[1]local hash_key = KEYS[2]local min_score = ARGV[1]local max_score = ARGV[2]local offset = ARGV[3]local limit = ARGV[4]-- TYPEå‘½ä»¤çš„è¿”å›ç»“æœæ˜¯&#123;'ok':'zset'&#125;è¿™æ ·å­,è¿™é‡Œåˆ©ç”¨nextåšä¸€è½®è¿­ä»£local status, type = next(redis.call('TYPE', zset_key))if status ~= nil and status == 'ok' then if type == 'zset' then local list = redis.call('ZREVRANGEBYSCORE', zset_key, max_score, min_score, 'LIMIT', offset, limit) if list ~= nil and #list &gt; 0 then -- unpackå‡½æ•°èƒ½æŠŠtableè½¬åŒ–ä¸ºå¯å˜å‚æ•° redis.call('ZREM', zset_key, unpack(list)) local result = redis.call('HMGET', hash_key, unpack(list)) redis.call('HDEL', hash_key, unpack(list)) return result end endendreturn nil è¿™ä¸ªè„šæœ¬ä¸€å…±ç”¨åˆ°äº†å››ä¸ªå‘½ä»¤ZREVRANGEBYSCOREã€ZREMã€HMGETå’ŒHDELï¼ˆTYPEå‘½ä»¤çš„æ—¶é—´å¤æ‚åº¦å¯ä»¥å¿½ç•¥ï¼‰ï¼š å‘½ä»¤ æ—¶é—´å¤æ‚åº¦ å‚æ•°è¯´æ˜ ZREVRANGEBYSCORE O(log(N)+M) Næ˜¯æœ‰åºé›†åˆä¸­çš„å…ƒç´ æ€»æ•°ï¼ŒMæ˜¯è¿”å›çš„å…ƒç´ çš„æ•°é‡ ZREM O(M*log(N)) Næ˜¯æœ‰åºé›†åˆä¸­çš„å…ƒç´ æ€»æ•°ï¼ŒMæ˜¯æˆåŠŸç§»é™¤çš„å…ƒç´ çš„æ•°é‡ HMGET O(L) Læ˜¯æˆåŠŸè¿”å›çš„åŸŸçš„æ•°é‡ HDEL O(L) Læ˜¯è¦åˆ é™¤çš„åŸŸçš„æ•°é‡ æ¥ä¸‹æ¥éœ€è¦ç»“åˆåœºæ™¯å’Œå…·ä½“å‚æ•°åˆ†æï¼Œå‡å¦‚åœ¨ç”Ÿäº§ç¯å¢ƒï¼Œæœ‰åºé›†åˆçš„å…ƒç´ æ€»é‡ç»´æŒåœ¨10000æ¯å°æ—¶ï¼ˆä¹Ÿå°±æ˜¯è¯´ä¸šåŠ¡é‡æ˜¯æ¯å°æ—¶ä¸‹å•1ä¸‡ç¬”ï¼‰ï¼Œç”±äºæŸ¥è¯¢Sorted Setå’ŒHashçš„æ•°æ®åŒæ—¶åšäº†åˆ é™¤ï¼Œé‚£ä¹ˆ30åˆ†é’Ÿå†…å¸¸é©»åœ¨è¿™ä¸¤ä¸ªé›†åˆä¸­çš„æ•°æ®æœ‰5000æ¡ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢è¡¨ä¸­çš„N = 5000ã€‚å‡è®¾æˆ‘ä»¬åˆæ­¥å®šä¹‰æŸ¥è¯¢çš„LIMITå€¼ä¸º100ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢çš„Må€¼ä¸º100ï¼Œå‡è®¾Redisä¸­æ¯ä¸ªæ“ä½œå•å…ƒçš„è€—æ—¶ç®€å•è®¤ä¸ºæ˜¯Tï¼Œé‚£ä¹ˆåˆ†æä¸€ä¸‹5000æ¡æ•°æ®å¤„ç†çš„è€—æ—¶ï¼š åºå· é›†åˆåŸºæ•° ZREVRANGEBYSCORE ZREM HMGET HDEL 1 5000 log(5000T) + 100T log(5000T) * 100 100T 100T 2 4900 log(4900T) + 100T log(4900T) * 100 100T 100T 3 4800 log(4800T) + 100T log(4800T) * 100 100T 100T â€¦ â€¦ â€¦ â€¦ â€¦ â€¦ ç†è®ºä¸Šï¼Œè„šæœ¬ç”¨åˆ°çš„å››ä¸ªå‘½ä»¤ä¸­ï¼ŒZREMå‘½ä»¤çš„è€—æ—¶æ˜¯æœ€å¤§çš„ï¼Œè€ŒZREVRANGEBYSCOREå’ŒZREMçš„æ—¶é—´å¤æ‚åº¦å‡½æ•°éƒ½æ˜¯M * log(N)ï¼Œå› æ­¤æ§åˆ¶é›†åˆå…ƒç´ åŸºæ•°Nå¯¹äºé™ä½Luaè„šæœ¬è¿è¡Œçš„è€—æ—¶æ˜¯æœ‰ä¸€å®šå¸®åŠ©çš„ã€‚ åˆ†ç‰‡ ä¸Šé¢åˆ†æäº†dequeue.luaçš„æ—¶é—´å¤æ‚åº¦ï¼Œå‡†å¤‡å¥½çš„åˆ†ç‰‡æ–¹æ¡ˆæœ‰ä¸¤ä¸ªï¼š æ–¹æ¡ˆä¸€ï¼šå•Rediså®ä¾‹ï¼Œå¯¹Sorted Setå’ŒHashä¸¤ä¸ªé›†åˆçš„æ•°æ®è¿›è¡Œåˆ†ç‰‡ã€‚ æ–¹æ¡ˆäºŒï¼šåŸºäºå¤šä¸ªRediså®ä¾‹ï¼ˆå¯ä»¥æ˜¯å“¨å…µæˆ–è€…é›†ç¾¤ï¼‰ï¼Œå®æ–½æ–¹æ¡ˆä¸€çš„åˆ†ç‰‡æ“ä½œã€‚ ä¸ºäº†ç®€å•èµ·è§ï¼Œåé¢çš„ä¾‹å­ä¸­åˆ†ç‰‡çš„æ•°é‡ï¼ˆshardingCountï¼‰è®¾è®¡ä¸º2ï¼Œç”Ÿäº§ä¸­åˆ†ç‰‡æ•°é‡åº”è¯¥æ ¹æ®å®é™…æƒ…å†µå®šåˆ¶ã€‚é¢„è®¾ä½¿ç”¨é•¿æ•´å‹çš„ç”¨æˆ·IDå­—æ®µuserIdå–æ¨¡è¿›è¡Œåˆ†ç‰‡ï¼Œå‡å®šæµ‹è¯•æ•°æ®ä¸­çš„userIdæ˜¯å‡åŒ€åˆ†å¸ƒçš„ã€‚ é€šç”¨å®ä½“ï¼š 12345678@Datapublic class OrderMessage &#123; private String orderId; private BigDecimal amount; private Long userId; private String timestamp;&#125; å»¶è¿Ÿé˜Ÿåˆ—æ¥å£ï¼š 123456789101112public interface OrderDelayQueue &#123; void enqueue(OrderMessage message); List&lt;OrderMessage&gt; dequeue(String min, String max, String offset, String limit, int index); List&lt;OrderMessage&gt; dequeue(int index); String enqueueSha(); String dequeueSha();&#125; å•Rediså®ä¾‹åˆ†ç‰‡ å•Rediså®ä¾‹åˆ†ç‰‡æ¯”è¾ƒç®€å•ï¼Œç¤ºæ„å›¾å¦‚ä¸‹ï¼š ç¼–å†™é˜Ÿåˆ—å®ç°ä»£ç å¦‚ä¸‹ï¼ˆéƒ¨åˆ†å‚æ•°å†™æ­»ï¼Œä»…ä¾›å‚è€ƒï¼Œåˆ‡å‹¿ç…§æ¬åˆ°ç”Ÿäº§ä¸­ï¼‰ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495@RequiredArgsConstructor@Componentpublic class RedisOrderDelayQueue implements OrderDelayQueue, InitializingBean &#123; private static final String MIN_SCORE = \"0\"; private static final String OFFSET = \"0\"; private static final String LIMIT = \"10\"; /** * åˆ†ç‰‡æ•°é‡ */ private static final long SHARDING_COUNT = 2L; private static final String ORDER_QUEUE_PREFIX = \"ORDER_QUEUE_\"; private static final String ORDER_DETAIL_QUEUE_PREFIX = \"ORDER_DETAIL_QUEUE_\"; private static final String ENQUEUE_LUA_SCRIPT_LOCATION = \"/lua/enqueue.lua\"; private static final String DEQUEUE_LUA_SCRIPT_LOCATION = \"/lua/dequeue.lua\"; private static final AtomicReference&lt;String&gt; ENQUEUE_LUA_SHA = new AtomicReference&lt;&gt;(); private static final AtomicReference&lt;String&gt; DEQUEUE_LUA_SHA = new AtomicReference&lt;&gt;(); private final JedisProvider jedisProvider; @Override public void enqueue(OrderMessage message) &#123; List&lt;String&gt; args = Lists.newArrayList(); args.add(message.getOrderId()); args.add(String.valueOf(System.currentTimeMillis())); args.add(message.getOrderId()); args.add(JSON.toJSONString(message)); List&lt;String&gt; keys = Lists.newArrayList(); long index = message.getUserId() % SHARDING_COUNT; keys.add(ORDER_QUEUE_PREFIX + index); keys.add(ORDER_DETAIL_QUEUE_PREFIX + index); try (Jedis jedis = jedisProvider.provide()) &#123; jedis.evalsha(ENQUEUE_LUA_SHA.get(), keys, args); &#125; &#125; @Override public List&lt;OrderMessage&gt; dequeue(int index) &#123; // 30åˆ†é’Ÿä¹‹å‰ String maxScore = String.valueOf(System.currentTimeMillis() - 30 * 60 * 1000); return dequeue(MIN_SCORE, maxScore, OFFSET, LIMIT, index); &#125; @SuppressWarnings(\"unchecked\") @Override public List&lt;OrderMessage&gt; dequeue(String min, String max, String offset, String limit, int index) &#123; List&lt;String&gt; args = new ArrayList&lt;&gt;(); args.add(min); args.add(max); args.add(offset); args.add(limit); List&lt;OrderMessage&gt; result = Lists.newArrayList(); List&lt;String&gt; keys = Lists.newArrayList(); keys.add(ORDER_QUEUE_PREFIX + index); keys.add(ORDER_DETAIL_QUEUE_PREFIX + index); try (Jedis jedis = jedisProvider.provide()) &#123; List&lt;String&gt; eval = (List&lt;String&gt;) jedis.evalsha(DEQUEUE_LUA_SHA.get(), keys, args); if (null != eval) &#123; for (String e : eval) &#123; result.add(JSON.parseObject(e, OrderMessage.class)); &#125; &#125; &#125; return result; &#125; @Override public String enqueueSha() &#123; return ENQUEUE_LUA_SHA.get(); &#125; @Override public String dequeueSha() &#123; return DEQUEUE_LUA_SHA.get(); &#125; @Override public void afterPropertiesSet() throws Exception &#123; // åŠ è½½Luaè„šæœ¬ loadLuaScript(); &#125; private void loadLuaScript() throws Exception &#123; try (Jedis jedis = jedisProvider.provide()) &#123; ClassPathResource resource = new ClassPathResource(ENQUEUE_LUA_SCRIPT_LOCATION); String luaContent = StreamUtils.copyToString(resource.getInputStream(), StandardCharsets.UTF_8); String sha = jedis.scriptLoad(luaContent); ENQUEUE_LUA_SHA.compareAndSet(null, sha); resource = new ClassPathResource(DEQUEUE_LUA_SCRIPT_LOCATION); luaContent = StreamUtils.copyToString(resource.getInputStream(), StandardCharsets.UTF_8); sha = jedis.scriptLoad(luaContent); DEQUEUE_LUA_SHA.compareAndSet(null, sha); &#125; &#125;&#125; æ¶ˆè´¹è€…å®šæ—¶ä»»åŠ¡çš„å®ç°å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859DisallowConcurrentExecution@Componentpublic class OrderMessageConsumer implements Job &#123; private static final Logger LOGGER = LoggerFactory.getLogger(OrderMessageConsumer.class); private static final AtomicInteger COUNTER = new AtomicInteger(); /** * åˆå§‹åŒ–ä¸šåŠ¡çº¿ç¨‹æ±  */ private static final ExecutorService BUSINESS_WORKER_POOL = Executors.newFixedThreadPool(Runtime.getRuntime().availableProcessors(), r -&gt; &#123; Thread thread = new Thread(r); thread.setDaemon(true); thread.setName(\"OrderMessageConsumerWorker-\" + COUNTER.getAndIncrement()); return thread; &#125;); @Autowired private OrderDelayQueue orderDelayQueue; @Override public void execute(JobExecutionContext context) throws JobExecutionException &#123; // è¿™é‡Œä¸ºäº†ç®€å•èµ·è§ï¼Œåˆ†ç‰‡çš„ä¸‹æ ‡æš‚æ—¶ä½¿ç”¨Quartzçš„ä»»åŠ¡æ‰§è¡Œä¸Šä¸‹æ–‡å­˜æ”¾ int shardingIndex = context.getMergedJobDataMap().getInt(\"shardingIndex\"); LOGGER.info(\"è®¢å•æ¶ˆæ¯æ¶ˆè´¹è€…å®šæ—¶ä»»åŠ¡å¼€å§‹æ‰§è¡Œ,shardingIndex:[&#123;&#125;]...\", shardingIndex); List&lt;OrderMessage&gt; dequeue = orderDelayQueue.dequeue(shardingIndex); if (null != dequeue) &#123; final CountDownLatch latch = new CountDownLatch(1); BUSINESS_WORKER_POOL.execute(new ConsumeTask(latch, dequeue, shardingIndex)); try &#123; latch.await(); &#125; catch (InterruptedException ignore) &#123; //ignore &#125; &#125; LOGGER.info(\"è®¢å•æ¶ˆæ¯æ¶ˆè´¹è€…å®šæ—¶ä»»åŠ¡æ‰§è¡Œå®Œæ¯•,shardingIndex:[&#123;&#125;]...\", shardingIndex); &#125; @RequiredArgsConstructor private static class ConsumeTask implements Runnable &#123; private final CountDownLatch latch; private final List&lt;OrderMessage&gt; messages; private final int shardingIndex; @Override public void run() &#123; try &#123; for (OrderMessage message : messages) &#123; LOGGER.info(\"shardingIndex:[&#123;&#125;],å¤„ç†è®¢å•æ¶ˆæ¯,å†…å®¹:&#123;&#125;\", shardingIndex, JSON.toJSONString(message)); // æ¨¡æ‹Ÿè€—æ—¶ TimeUnit.MILLISECONDS.sleep(50); &#125; &#125; catch (Exception ignore) &#123; &#125; finally &#123; latch.countDown(); &#125; &#125; &#125;&#125; å¯åŠ¨å®šæ—¶ä»»åŠ¡å’Œå†™å…¥æµ‹è¯•æ•°æ®çš„CommandLineRunnerå®ç°å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465@Componentpublic class QuartzJobStartCommandLineRunner implements CommandLineRunner &#123; @Autowired private Scheduler scheduler; @Autowired private JedisProvider jedisProvider; @Override public void run(String... args) throws Exception &#123; int shardingCount = 2; // å‡†å¤‡æµ‹è¯•æ•°æ® prepareOrderMessageData(shardingCount); for (ConsumerTask task : prepareConsumerTasks(shardingCount)) &#123; scheduler.scheduleJob(task.getJobDetail(), task.getTrigger()); &#125; &#125; private void prepareOrderMessageData(int shardingCount) throws Exception &#123; DateTimeFormatter f = DateTimeFormatter.ofPattern(\"yyyy-MM-dd HH:mm:ss.SSS\"); try (Jedis jedis = jedisProvider.provide()) &#123; List&lt;OrderMessage&gt; messages = Lists.newArrayList(); for (int i = 0; i &lt; 100; i++) &#123; OrderMessage message = new OrderMessage(); message.setAmount(BigDecimal.valueOf(i)); message.setOrderId(\"ORDER_ID_\" + i); message.setUserId((long) i); message.setTimestamp(LocalDateTime.now().format(f)); messages.add(message); &#125; for (OrderMessage message : messages) &#123; // 30åˆ†é’Ÿå‰ Double score = Double.valueOf(String.valueOf(System.currentTimeMillis() - 30 * 60 * 1000)); long index = message.getUserId() % shardingCount; jedis.hset(\"ORDER_DETAIL_QUEUE_\" + index, message.getOrderId(), JSON.toJSONString(message)); jedis.zadd(\"ORDER_QUEUE_\" + index, score, message.getOrderId()); &#125; &#125; &#125; private List&lt;ConsumerTask&gt; prepareConsumerTasks(int shardingCount) &#123; List&lt;ConsumerTask&gt; tasks = Lists.newArrayList(); for (int i = 0; i &lt; shardingCount; i++) &#123; JobDetail jobDetail = JobBuilder.newJob(OrderMessageConsumer.class) .withIdentity(\"OrderMessageConsumer-\" + i, \"DelayTask\") .usingJobData(\"shardingIndex\", i) .build(); Trigger trigger = TriggerBuilder.newTrigger() .withIdentity(\"OrderMessageConsumerTrigger-\" + i, \"DelayTask\") .withSchedule(SimpleScheduleBuilder.simpleSchedule().withIntervalInSeconds(10).repeatForever()) .build(); tasks.add(new ConsumerTask(jobDetail, trigger)); &#125; return tasks; &#125; @Getter @RequiredArgsConstructor private static class ConsumerTask &#123; private final JobDetail jobDetail; private final Trigger trigger; &#125;&#125; å¯åŠ¨åº”ç”¨ï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š 12345678910112019-08-28 00:13:20.648 INFO 50248 --- [ main] c.t.s.s.NoneJdbcSpringApplication : Started NoneJdbcSpringApplication in 1.35 seconds (JVM running for 5.109)2019-08-28 00:13:20.780 INFO 50248 --- [ryBean_Worker-1] c.t.s.sharding.OrderMessageConsumer : è®¢å•æ¶ˆæ¯æ¶ˆè´¹è€…å®šæ—¶ä»»åŠ¡å¼€å§‹æ‰§è¡Œ,shardingIndex:[0]...2019-08-28 00:13:20.781 INFO 50248 --- [ryBean_Worker-2] c.t.s.sharding.OrderMessageConsumer : è®¢å•æ¶ˆæ¯æ¶ˆè´¹è€…å®šæ—¶ä»»åŠ¡å¼€å§‹æ‰§è¡Œ,shardingIndex:[1]...2019-08-28 00:13:20.788 INFO 50248 --- [onsumerWorker-1] c.t.s.sharding.OrderMessageConsumer : shardingIndex:[1],å¤„ç†è®¢å•æ¶ˆæ¯,å†…å®¹:&#123;\"amount\":99,\"orderId\":\"ORDER_ID_99\",\"timestamp\":\"2019-08-28 00:13:20.657\",\"userId\":99&#125;2019-08-28 00:13:20.788 INFO 50248 --- [onsumerWorker-0] c.t.s.sharding.OrderMessageConsumer : shardingIndex:[0],å¤„ç†è®¢å•æ¶ˆæ¯,å†…å®¹:&#123;\"amount\":98,\"orderId\":\"ORDER_ID_98\",\"timestamp\":\"2019-08-28 00:13:20.657\",\"userId\":98&#125;2019-08-28 00:13:20.840 INFO 50248 --- [onsumerWorker-1] c.t.s.sharding.OrderMessageConsumer : shardingIndex:[1],å¤„ç†è®¢å•æ¶ˆæ¯,å†…å®¹:&#123;\"amount\":97,\"orderId\":\"ORDER_ID_97\",\"timestamp\":\"2019-08-28 00:13:20.657\",\"userId\":97&#125;2019-08-28 00:13:20.840 INFO 50248 --- [onsumerWorker-0] c.t.s.sharding.OrderMessageConsumer : shardingIndex:[0],å¤„ç†è®¢å•æ¶ˆæ¯,å†…å®¹:&#123;\"amount\":96,\"orderId\":\"ORDER_ID_96\",\"timestamp\":\"2019-08-28 00:13:20.657\",\"userId\":96&#125;// ... çœç•¥å¤§é‡è¾“å‡º2019-08-28 00:13:21.298 INFO 50248 --- [ryBean_Worker-1] c.t.s.sharding.OrderMessageConsumer : è®¢å•æ¶ˆæ¯æ¶ˆè´¹è€…å®šæ—¶ä»»åŠ¡æ‰§è¡Œå®Œæ¯•,shardingIndex:[0]...2019-08-28 00:13:21.298 INFO 50248 --- [ryBean_Worker-2] c.t.s.sharding.OrderMessageConsumer : è®¢å•æ¶ˆæ¯æ¶ˆè´¹è€…å®šæ—¶ä»»åŠ¡æ‰§è¡Œå®Œæ¯•,shardingIndex:[1]...// ... çœç•¥å¤§é‡è¾“å‡º å¤šRediså®ä¾‹åˆ†ç‰‡ å•Rediså®ä¾‹åˆ†ç‰‡å…¶å®å­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯Rediså®ä¾‹æ€»æ˜¯å•çº¿ç¨‹å¤„ç†å®¢æˆ·ç«¯çš„å‘½ä»¤ï¼Œå³ä½¿å®¢æˆ·ç«¯æ˜¯å¤šä¸ªçº¿ç¨‹æ‰§è¡ŒRediså‘½ä»¤ï¼Œç¤ºæ„å›¾å¦‚ä¸‹ï¼š è¿™ç§æƒ…å†µä¸‹ï¼Œè™½ç„¶é€šè¿‡åˆ†ç‰‡é™ä½äº†Luaè„šæœ¬å‘½ä»¤çš„å¤æ‚åº¦ï¼Œä½†æ˜¯Redisçš„å‘½ä»¤å¤„ç†æ¨¡å‹ï¼ˆå•çº¿ç¨‹ï¼‰ä¹Ÿæœ‰å¯èƒ½æˆä¸ºå¦ä¸€ä¸ªæ€§èƒ½ç“¶é¢ˆéšæ‚£ã€‚å› æ­¤ï¼Œå¯ä»¥è€ƒè™‘åŸºäºå¤šRediså®ä¾‹è¿›è¡Œåˆ†ç‰‡ã€‚ è¿™é‡Œä¸ºäº†ç®€å•èµ·è§ï¼Œç”¨ä¸¤ä¸ªå•ç‚¹çš„Rediså®ä¾‹åšç¼–ç ç¤ºä¾‹ã€‚ä»£ç å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296// Jedisæä¾›è€…@Componentpublic class JedisProvider implements InitializingBean &#123; private final Map&lt;Long, JedisPool&gt; pools = Maps.newConcurrentMap(); private JedisPool defaultPool; @Override public void afterPropertiesSet() throws Exception &#123; JedisPool pool = new JedisPool(\"localhost\"); defaultPool = pool; pools.put(0L, pool); // è¿™ä¸ªæ˜¯è™šæ‹Ÿæœºä¸Šçš„rediså®ä¾‹ pool = new JedisPool(\"192.168.56.200\"); pools.put(1L, pool); &#125; public Jedis provide(Long index) &#123; return pools.getOrDefault(index, defaultPool).getResource(); &#125;&#125;// è®¢å•æ¶ˆæ¯@Datapublic class OrderMessage &#123; private String orderId; private BigDecimal amount; private Long userId;&#125;// è®¢å•å»¶æ—¶é˜Ÿåˆ—æ¥å£public interface OrderDelayQueue &#123; void enqueue(OrderMessage message); List&lt;OrderMessage&gt; dequeue(String min, String max, String offset, String limit, long index); List&lt;OrderMessage&gt; dequeue(long index); String enqueueSha(long index); String dequeueSha(long index);&#125;// å»¶æ—¶é˜Ÿåˆ—å®ç°@RequiredArgsConstructor@Componentpublic class RedisOrderDelayQueue implements OrderDelayQueue, InitializingBean &#123; private static final String MIN_SCORE = \"0\"; private static final String OFFSET = \"0\"; private static final String LIMIT = \"10\"; private static final long SHARDING_COUNT = 2L; private static final String ORDER_QUEUE = \"ORDER_QUEUE\"; private static final String ORDER_DETAIL_QUEUE = \"ORDER_DETAIL_QUEUE\"; private static final String ENQUEUE_LUA_SCRIPT_LOCATION = \"/lua/enqueue.lua\"; private static final String DEQUEUE_LUA_SCRIPT_LOCATION = \"/lua/dequeue.lua\"; private static final ConcurrentMap&lt;Long, String&gt; ENQUEUE_LUA_SHA = Maps.newConcurrentMap(); private static final ConcurrentMap&lt;Long, String&gt; DEQUEUE_LUA_SHA = Maps.newConcurrentMap(); private final JedisProvider jedisProvider; @Override public void enqueue(OrderMessage message) &#123; List&lt;String&gt; args = Lists.newArrayList(); args.add(message.getOrderId()); args.add(String.valueOf(System.currentTimeMillis() - 30 * 60 * 1000)); args.add(message.getOrderId()); args.add(JSON.toJSONString(message)); List&lt;String&gt; keys = Lists.newArrayList(); long index = message.getUserId() % SHARDING_COUNT; keys.add(ORDER_QUEUE); keys.add(ORDER_DETAIL_QUEUE); try (Jedis jedis = jedisProvider.provide(index)) &#123; jedis.evalsha(ENQUEUE_LUA_SHA.get(index), keys, args); &#125; &#125; @Override public List&lt;OrderMessage&gt; dequeue(long index) &#123; // 30åˆ†é’Ÿä¹‹å‰ String maxScore = String.valueOf(System.currentTimeMillis() - 30 * 60 * 1000); return dequeue(MIN_SCORE, maxScore, OFFSET, LIMIT, index); &#125; @SuppressWarnings(\"unchecked\") @Override public List&lt;OrderMessage&gt; dequeue(String min, String max, String offset, String limit, long index) &#123; List&lt;String&gt; args = new ArrayList&lt;&gt;(); args.add(min); args.add(max); args.add(offset); args.add(limit); List&lt;OrderMessage&gt; result = Lists.newArrayList(); List&lt;String&gt; keys = Lists.newArrayList(); keys.add(ORDER_QUEUE); keys.add(ORDER_DETAIL_QUEUE); try (Jedis jedis = jedisProvider.provide(index)) &#123; List&lt;String&gt; eval = (List&lt;String&gt;) jedis.evalsha(DEQUEUE_LUA_SHA.get(index), keys, args); if (null != eval) &#123; for (String e : eval) &#123; result.add(JSON.parseObject(e, OrderMessage.class)); &#125; &#125; &#125; return result; &#125; @Override public String enqueueSha(long index) &#123; return ENQUEUE_LUA_SHA.get(index); &#125; @Override public String dequeueSha(long index) &#123; return DEQUEUE_LUA_SHA.get(index); &#125; @Override public void afterPropertiesSet() throws Exception &#123; // åŠ è½½Luaè„šæœ¬ loadLuaScript(); &#125; private void loadLuaScript() throws Exception &#123; for (long i = 0; i &lt; SHARDING_COUNT; i++) &#123; try (Jedis jedis = jedisProvider.provide(i)) &#123; ClassPathResource resource = new ClassPathResource(ENQUEUE_LUA_SCRIPT_LOCATION); String luaContent = StreamUtils.copyToString(resource.getInputStream(), StandardCharsets.UTF_8); String sha = jedis.scriptLoad(luaContent); ENQUEUE_LUA_SHA.put(i, sha); resource = new ClassPathResource(DEQUEUE_LUA_SCRIPT_LOCATION); luaContent = StreamUtils.copyToString(resource.getInputStream(), StandardCharsets.UTF_8); sha = jedis.scriptLoad(luaContent); DEQUEUE_LUA_SHA.put(i, sha); &#125; &#125; &#125;&#125;// æ¶ˆè´¹è€…public class OrderMessageConsumer implements Job &#123; private static final Logger LOGGER = LoggerFactory.getLogger(OrderMessageConsumer.class); private static final AtomicInteger COUNTER = new AtomicInteger(); // åˆå§‹åŒ–ä¸šåŠ¡çº¿ç¨‹æ±  private final ExecutorService businessWorkerPool = Executors.newSingleThreadExecutor(r -&gt; &#123; Thread thread = new Thread(r); thread.setDaemon(true); thread.setName(\"OrderMessageConsumerWorker-\" + COUNTER.getAndIncrement()); return thread; &#125;); @Autowired private OrderDelayQueue orderDelayQueue; @Override public void execute(JobExecutionContext context) throws JobExecutionException &#123; long shardingIndex = context.getMergedJobDataMap().getLong(\"shardingIndex\"); LOGGER.info(\"è®¢å•æ¶ˆæ¯æ¶ˆè´¹è€…å®šæ—¶ä»»åŠ¡å¼€å§‹æ‰§è¡Œ,shardingIndex:[&#123;&#125;]...\", shardingIndex); List&lt;OrderMessage&gt; dequeue = orderDelayQueue.dequeue(shardingIndex); if (null != dequeue) &#123; // è¿™é‡Œçš„å€’æ•°æ …æ ï¼Œåœ¨çº¿ç¨‹æ± èµ„æºå……è¶³çš„å‰æä¸‹å¯ä»¥å»æ‰ final CountDownLatch latch = new CountDownLatch(1); businessWorkerPool.execute(new ConsumeTask(latch, dequeue, shardingIndex)); try &#123; latch.await(); &#125; catch (InterruptedException ignore) &#123; //ignore &#125; &#125; LOGGER.info(\"è®¢å•æ¶ˆæ¯æ¶ˆè´¹è€…å®šæ—¶ä»»åŠ¡æ‰§è¡Œå®Œæ¯•,shardingIndex:[&#123;&#125;]...\", shardingIndex); &#125; @RequiredArgsConstructor private static class ConsumeTask implements Runnable &#123; private final CountDownLatch latch; private final List&lt;OrderMessage&gt; messages; private final long shardingIndex; @Override public void run() &#123; try &#123; for (OrderMessage message : messages) &#123; LOGGER.info(\"shardingIndex:[&#123;&#125;],å¤„ç†è®¢å•æ¶ˆæ¯,å†…å®¹:&#123;&#125;\", shardingIndex, JSON.toJSONString(message)); // æ¨¡æ‹Ÿå¤„ç†è€—æ—¶50æ¯«ç§’ TimeUnit.MILLISECONDS.sleep(50); &#125; &#125; catch (Exception ignore) &#123; &#125; finally &#123; latch.countDown(); &#125; &#125; &#125;&#125;// é…ç½®@Configurationpublic class QuartzConfiguration &#123; @Bean public AutowiredSupportQuartzJobFactory autowiredSupportQuartzJobFactory() &#123; return new AutowiredSupportQuartzJobFactory(); &#125; @Bean public SchedulerFactoryBean schedulerFactoryBean(AutowiredSupportQuartzJobFactory autowiredSupportQuartzJobFactory) &#123; SchedulerFactoryBean factory = new SchedulerFactoryBean(); factory.setSchedulerName(\"RamScheduler\"); factory.setAutoStartup(true); factory.setJobFactory(autowiredSupportQuartzJobFactory); return factory; &#125; public static class AutowiredSupportQuartzJobFactory extends AdaptableJobFactory implements BeanFactoryAware &#123; private AutowireCapableBeanFactory autowireCapableBeanFactory; @Override public void setBeanFactory(BeanFactory beanFactory) throws BeansException &#123; this.autowireCapableBeanFactory = (AutowireCapableBeanFactory) beanFactory; &#125; @Override protected Object createJobInstance(@Nonnull TriggerFiredBundle bundle) throws Exception &#123; Object jobInstance = super.createJobInstance(bundle); autowireCapableBeanFactory.autowireBean(jobInstance); return jobInstance; &#125; &#125;&#125;// CommandLineRunner@Componentpublic class QuartzJobStartCommandLineRunner implements CommandLineRunner &#123; @Autowired private Scheduler scheduler; @Autowired private JedisProvider jedisProvider; @Override public void run(String... args) throws Exception &#123; long shardingCount = 2; prepareData(shardingCount); for (ConsumerTask task : prepareConsumerTasks(shardingCount)) &#123; scheduler.scheduleJob(task.getJobDetail(), task.getTrigger()); &#125; &#125; private void prepareData(long shardingCount) &#123; for (long i = 0L; i &lt; shardingCount; i++) &#123; Map&lt;String, Double&gt; z = Maps.newHashMap(); Map&lt;String, String&gt; h = Maps.newHashMap(); for (int k = 0; k &lt; 100; k++) &#123; OrderMessage message = new OrderMessage(); message.setAmount(BigDecimal.valueOf(k)); message.setUserId((long) k); message.setOrderId(\"ORDER_ID_\" + k); // 30 min ago z.put(message.getOrderId(), Double.valueOf(String.valueOf(System.currentTimeMillis() - 30 * 60 * 1000))); h.put(message.getOrderId(), JSON.toJSONString(message)); &#125; Jedis jedis = jedisProvider.provide(i); jedis.hmset(\"ORDER_DETAIL_QUEUE\", h); jedis.zadd(\"ORDER_QUEUE\", z); &#125; &#125; private List&lt;ConsumerTask&gt; prepareConsumerTasks(long shardingCount) &#123; List&lt;ConsumerTask&gt; tasks = Lists.newArrayList(); for (long i = 0; i &lt; shardingCount; i++) &#123; JobDetail jobDetail = JobBuilder.newJob(OrderMessageConsumer.class) .withIdentity(\"OrderMessageConsumer-\" + i, \"DelayTask\") .usingJobData(\"shardingIndex\", i) .build(); Trigger trigger = TriggerBuilder.newTrigger() .withIdentity(\"OrderMessageConsumerTrigger-\" + i, \"DelayTask\") .withSchedule(SimpleScheduleBuilder.simpleSchedule().withIntervalInSeconds(10).repeatForever()) .build(); tasks.add(new ConsumerTask(jobDetail, trigger)); &#125; return tasks; &#125; @Getter @RequiredArgsConstructor private static class ConsumerTask &#123; private final JobDetail jobDetail; private final Trigger trigger; &#125;&#125; æ–°å¢ä¸€ä¸ªå¯åŠ¨å‡½æ•°å¹¶ä¸”å¯åŠ¨ï¼Œæ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š 123456789101112// ...çœç•¥å¤§é‡è¾“å‡º2019-09-01 14:08:27.664 INFO 13056 --- [ main] c.t.multi.NoneJdbcSpringApplication : Started NoneJdbcSpringApplication in 1.333 seconds (JVM running for 5.352)2019-09-01 14:08:27.724 INFO 13056 --- [eduler_Worker-2] c.throwable.multi.OrderMessageConsumer : è®¢å•æ¶ˆæ¯æ¶ˆè´¹è€…å®šæ—¶ä»»åŠ¡å¼€å§‹æ‰§è¡Œ,shardingIndex:[1]...2019-09-01 14:08:27.724 INFO 13056 --- [eduler_Worker-1] c.throwable.multi.OrderMessageConsumer : è®¢å•æ¶ˆæ¯æ¶ˆè´¹è€…å®šæ—¶ä»»åŠ¡å¼€å§‹æ‰§è¡Œ,shardingIndex:[0]...2019-09-01 14:08:27.732 INFO 13056 --- [onsumerWorker-1] c.throwable.multi.OrderMessageConsumer : shardingIndex:[1],å¤„ç†è®¢å•æ¶ˆæ¯,å†…å®¹:&#123;\"amount\":99,\"orderId\":\"ORDER_ID_99\",\"userId\":99&#125;2019-09-01 14:08:27.732 INFO 13056 --- [onsumerWorker-0] c.throwable.multi.OrderMessageConsumer : shardingIndex:[0],å¤„ç†è®¢å•æ¶ˆæ¯,å†…å®¹:&#123;\"amount\":99,\"orderId\":\"ORDER_ID_99\",\"userId\":99&#125;2019-09-01 14:08:27.782 INFO 13056 --- [onsumerWorker-0] c.throwable.multi.OrderMessageConsumer : shardingIndex:[0],å¤„ç†è®¢å•æ¶ˆæ¯,å†…å®¹:&#123;\"amount\":98,\"orderId\":\"ORDER_ID_98\",\"userId\":98&#125;2019-09-01 14:08:27.782 INFO 13056 --- [onsumerWorker-1] c.throwable.multi.OrderMessageConsumer : shardingIndex:[1],å¤„ç†è®¢å•æ¶ˆæ¯,å†…å®¹:&#123;\"amount\":98,\"orderId\":\"ORDER_ID_98\",\"userId\":98&#125;// ...çœç•¥å¤§é‡è¾“å‡º2019-09-01 14:08:28.239 INFO 13056 --- [eduler_Worker-2] c.throwable.multi.OrderMessageConsumer : è®¢å•æ¶ˆæ¯æ¶ˆè´¹è€…å®šæ—¶ä»»åŠ¡æ‰§è¡Œå®Œæ¯•,shardingIndex:[1]...2019-09-01 14:08:28.240 INFO 13056 --- [eduler_Worker-1] c.throwable.multi.OrderMessageConsumer : è®¢å•æ¶ˆæ¯æ¶ˆè´¹è€…å®šæ—¶ä»»åŠ¡æ‰§è¡Œå®Œæ¯•,shardingIndex:[0]...// ...çœç•¥å¤§é‡è¾“å‡º ç”Ÿäº§ä¸­åº”è¯¥é¿å…RedisæœåŠ¡å•ç‚¹ï¼Œä¸€èˆ¬å¸¸ç”¨å“¨å…µé…åˆæ ‘çŠ¶ä¸»ä»çš„éƒ¨ç½²æ–¹å¼ï¼ˆå‚è€ƒã€ŠRediså¼€å‘ä¸è¿ç»´ã€‹ï¼‰ï¼Œ2å¥—Rediså“¨å…µçš„éƒ¨ç½²ç¤ºæ„å›¾å¦‚ä¸‹ï¼š éœ€è¦ä»€ä¹ˆç›‘æ§é¡¹ æˆ‘ä»¬éœ€è¦ç›¸å¯¹å®æ—¶åœ°çŸ¥é“Redisä¸­çš„å»¶æ—¶é˜Ÿåˆ—é›†åˆæœ‰å¤šå°‘ç§¯å‹æ•°æ®ï¼Œæ¯æ¬¡å‡ºé˜Ÿçš„è€—æ—¶å¤§æ¦‚æ˜¯å¤šå°‘ç­‰ç­‰ç›‘æ§é¡¹å‚æ•°ï¼Œè¿™æ ·æˆ‘ä»¬æ‰èƒ½æ›´å¥½åœ°çŸ¥é“å»¶æ—¶é˜Ÿåˆ—æ¨¡å—æ˜¯å¦æ­£å¸¸è¿è¡Œã€æ˜¯å¦å­˜åœ¨æ€§èƒ½ç“¶é¢ˆç­‰ç­‰ã€‚å…·ä½“çš„ç›‘æ§é¡¹ï¼Œéœ€è¦æŒ‰éœ€å®šåˆ¶ï¼Œè¿™é‡Œä¸ºäº†æ–¹ä¾¿ä¸¾ä¾‹ï¼Œåªåšä¸¤ä¸ªç›‘æ§é¡¹çš„ç›‘æ§ï¼š æœ‰åºé›†åˆSorted Setä¸­ç§¯å‹çš„å…ƒç´ æ•°é‡ã€‚ æ¯æ¬¡è°ƒç”¨dequeue.luaçš„è€—æ—¶ã€‚ é‡‡ç”¨çš„æ˜¯åº”ç”¨å®æ—¶ä¸ŠæŠ¥æ•°æ®çš„æ–¹å¼ï¼Œä¾èµ–äºspring-boot-starter-actuatorã€Prometheusã€Grafanaæ­å»ºçš„ç›‘æ§ä½“ç³»ï¼Œå¦‚æœå¹¶ä¸ç†Ÿæ‚‰è¿™ä¸ªä½“ç³»å¯ä»¥çœ‹ä¸¤ç¯‡å‰ç½®æ–‡ç« ï¼š JVMåº”ç”¨åº¦é‡æ¡†æ¶Micrometerå®æˆ˜ é€šè¿‡micrometerå®æ—¶ç›‘æ§çº¿ç¨‹æ± çš„å„é¡¹æŒ‡æ ‡ ç›‘æ§ å¼•å…¥ä¾èµ–ï¼š 123456789&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;io.micrometer&lt;/groupId&gt; &lt;artifactId&gt;micrometer-registry-prometheus&lt;/artifactId&gt; &lt;version&gt;1.2.0&lt;/version&gt;&lt;/dependency&gt; è¿™é‡Œé€‰ç”¨Gaugeçš„Meterè¿›è¡Œç›‘æ§æ•°æ®æ”¶é›†ï¼Œæ·»åŠ ç›‘æ§ç±»OrderDelayQueueMonitorï¼šã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556// OrderDelayQueueMonitor@Componentpublic class OrderDelayQueueMonitor implements InitializingBean &#123; private static final long SHARDING_COUNT = 2L; private final ConcurrentMap&lt;Long, AtomicLong&gt; remain = Maps.newConcurrentMap(); private final ConcurrentMap&lt;Long, AtomicLong&gt; lua = Maps.newConcurrentMap(); private ScheduledExecutorService executor; @Autowired private JedisProvider jedisProvider; @Override public void afterPropertiesSet() throws Exception &#123; executor = Executors.newSingleThreadScheduledExecutor(r -&gt; &#123; Thread thread = new Thread(r, \"OrderDelayQueueMonitor\"); thread.setDaemon(true); return thread; &#125;); for (long i = 0L; i &lt; SHARDING_COUNT; i++) &#123; AtomicLong l = new AtomicLong(); Metrics.gauge(\"order.delay.queue.lua.cost\", Collections.singleton(Tag.of(\"index\", String.valueOf(i))), l, AtomicLong::get); lua.put(i, l); AtomicLong r = new AtomicLong(); Metrics.gauge(\"order.delay.queue.remain\", Collections.singleton(Tag.of(\"index\", String.valueOf(i))), r, AtomicLong::get); remain.put(i, r); &#125; // æ¯äº”ç§’ä¸ŠæŠ¥ä¸€æ¬¡é›†åˆä¸­çš„å‰©ä½™æ•°æ® executor.scheduleWithFixedDelay(new MonitorTask(jedisProvider), 0, 5, TimeUnit.SECONDS); &#125; public void recordRemain(Long index, long count) &#123; remain.get(index).set(count); &#125; public void recordLuaCost(Long index, long count) &#123; lua.get(index).set(count); &#125; @RequiredArgsConstructor private class MonitorTask implements Runnable &#123; private final JedisProvider jedisProvider; @Override public void run() &#123; for (long i = 0L; i &lt; SHARDING_COUNT; i++) &#123; try (Jedis jedis = jedisProvider.provide(i)) &#123; recordRemain(i, jedis.zcount(\"ORDER_QUEUE\", \"-inf\", \"+inf\")); &#125; &#125; &#125; &#125;&#125; åŸæ¥çš„RedisOrderDelayQueue#dequeue()è¿›è¡Œæ”¹é€ ï¼š 1234567891011121314151617181920212223242526272829303132333435363738@RequiredArgsConstructor@Componentpublic class RedisOrderDelayQueue implements OrderDelayQueue, InitializingBean &#123; // ... çœç•¥æ²¡æœ‰æ”¹åŠ¨çš„ä»£ç  private final OrderDelayQueueMonitor orderDelayQueueMonitor; // ... çœç•¥æ²¡æœ‰æ”¹åŠ¨çš„ä»£ç  @Override public List&lt;OrderMessage&gt; dequeue(String min, String max, String offset, String limit, long index) &#123; List&lt;String&gt; args = new ArrayList&lt;&gt;(); args.add(min); args.add(max); args.add(offset); args.add(limit); List&lt;OrderMessage&gt; result = Lists.newArrayList(); List&lt;String&gt; keys = Lists.newArrayList(); keys.add(ORDER_QUEUE); keys.add(ORDER_DETAIL_QUEUE); try (Jedis jedis = jedisProvider.provide(index)) &#123; long start = System.nanoTime(); List&lt;String&gt; eval = (List&lt;String&gt;) jedis.evalsha(DEQUEUE_LUA_SHA.get(index), keys, args); long end = System.nanoTime(); // æ·»åŠ dequeueçš„è€—æ—¶ç›‘æ§-å•ä½å¾®ç§’ orderDelayQueueMonitor.recordLuaCost(index, TimeUnit.NANOSECONDS.toMicros(end - start)); if (null != eval) &#123; for (String e : eval) &#123; result.add(JSON.parseObject(e, OrderMessage.class)); &#125; &#125; &#125; return result; &#125; // ... çœç•¥æ²¡æœ‰æ”¹åŠ¨çš„ä»£ç &#125; å…¶ä»–é…ç½®è¿™é‡Œç®€å•è¯´ä¸€ä¸‹ã€‚ application.yamlè¦å¼€æ”¾prometheusç«¯ç‚¹çš„è®¿é—®æƒé™ï¼š 1234567server: port: 9091management: endpoints: web: exposure: include: 'prometheus' PrometheusæœåŠ¡é…ç½®å°½é‡å‡å°‘æŸ¥è¯¢çš„é—´éš”æ—¶é—´ï¼Œæš‚å®šä¸º5ç§’ï¼š 12345678910111213141516171819202122232425262728# my global configglobal: scrape_interval: 5s # Set the scrape interval to every 15 seconds. Default is every 1 minute. evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute. # scrape_timeout is set to the global default (10s).# Alertmanager configurationalerting: alertmanagers: - static_configs: - targets: # - alertmanager:9093# Load rules once and periodically evaluate them according to the global 'evaluation_interval'.rule_files: # - \"first_rules.yml\" # - \"second_rules.yml\"# A scrape configuration containing exactly one endpoint to scrape:# Here it's Prometheus itself.scrape_configs: # The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config. - job_name: 'prometheus' metrics_path: '/actuator/prometheus' # metrics_path defaults to '/metrics' # scheme defaults to 'http'. static_configs: - targets: ['localhost:9091'] Grafanaçš„åŸºæœ¬é…ç½®é¡¹å¦‚ä¸‹ï¼š 12å‡ºé˜Ÿè€—æ—¶ order_delay_queue_lua_cost åˆ†ç‰‡ç¼–å·-&#123;&#123;index&#125;&#125;è®¢å•å»¶æ—¶é˜Ÿåˆ—ç§¯å‹é‡ order_delay_queue_remain åˆ†ç‰‡ç¼–å·-&#123;&#123;index&#125;&#125; æœ€ç»ˆå¯ä»¥åœ¨Grafanaé…ç½®æ¯5ç§’åˆ·æ–°ï¼Œè§æ•ˆæœå¦‚ä¸‹ï¼š è¿™é‡Œçš„ç›‘æ§é¡¹æ›´å¤šæ—¶å€™åº”è¯¥æŒ‰éœ€å®šåˆ¶ï¼Œè¯´å®è¯ï¼Œç›‘æ§çš„å·¥ä½œå¾€å¾€æ˜¯æœ€å¤æ‚å’Œç¹ççš„ã€‚ å°ç»“ å…¨æ–‡ç›¸å¯¹è¯¦ç»†åœ°ä»‹ç»äº†åŸºäºRediså®ç°å»¶æ—¶ä»»åŠ¡çš„åˆ†ç‰‡å’Œç›‘æ§çš„å…·ä½“å®æ–½è¿‡ç¨‹ï¼Œæ ¸å¿ƒä»£ç ä»…ä¾›å‚è€ƒï¼Œè¿˜æœ‰ä¸€äº›å…·ä½“çš„ç»†èŠ‚ä¾‹å¦‚Prometheusã€Grafanaçš„ä¸€äº›åº”ç”¨ï¼Œè¿™é‡Œé™äºç¯‡å¹…ä¸ä¼šè¯¦ç»†åœ°å±•å¼€ã€‚è¯´å®è¯ï¼ŒåŸºäºå®é™…åœºæ™¯åšä¸€æ¬¡ä¸­é—´ä»¶å’Œæ¶æ„çš„é€‰å‹å¹¶ä¸æ˜¯ä¸€ä»¶ç®€å•çš„äº‹ï¼Œè€Œä¸”å¾€å¾€åˆæœŸçš„å®æ–½å¹¶ä¸æ˜¯æœ€å¤§çš„éš¾ç‚¹ï¼Œæ›´å¤§çš„éš¾é¢˜åœ¨åé¢çš„ä¼˜åŒ–ä»¥åŠç›‘æ§ã€‚ é™„ä»¶ MarkdownåŸä»¶ï¼šhttps://github.com/zjcscut/blog-article-file/tree/master/20190901/redis-delay-task-second ï¼ˆæœ¬æ–‡å®Œ c-3-d 20190901 èº«ä½“ä¸é€‚ï¼Œæ‹–äº†ä¸€ä¸‹ï¼‰","categories":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/categories/Middleware/"},{"name":"Redis","slug":"Middleware/Redis","permalink":"http://throwable.club/blog/categories/Middleware/Redis/"}],"tags":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/tags/Middleware/"},{"name":"Redis","slug":"Redis","permalink":"http://throwable.club/blog/tags/Redis/"}]},{"title":"ä½¿ç”¨Rediså®ç°å»¶æ—¶ä»»åŠ¡(ä¸€)","slug":"redis-delay-task-first","date":"2019-08-21T15:32:30.000Z","updated":"2019-11-28T17:00:48.265Z","comments":true,"path":"2019/08/21/redis-delay-task-first/","link":"","permalink":"http://throwable.club/2019/08/21/redis-delay-task-first/","excerpt":"å‰æ æœ€è¿‘åœ¨ç”Ÿäº§ç¯å¢ƒåˆšå¥½é‡åˆ°äº†å»¶æ—¶ä»»åŠ¡çš„åœºæ™¯ï¼Œè°ƒç ”äº†ä¸€ä¸‹ç›®å‰ä¸»æµçš„æ–¹æ¡ˆï¼Œåˆ†æäº†ä¸€ä¸‹ä¼˜åŠ£å¹¶ä¸”æ•²å®šäº†æœ€ç»ˆçš„æ–¹æ¡ˆã€‚è¿™ç¯‡æ–‡ç« è®°å½•äº†è°ƒç ”çš„è¿‡ç¨‹ï¼Œä»¥åŠåˆæ­¥æ–¹æ¡ˆçš„å®ç°ã€‚","text":"å‰æ æœ€è¿‘åœ¨ç”Ÿäº§ç¯å¢ƒåˆšå¥½é‡åˆ°äº†å»¶æ—¶ä»»åŠ¡çš„åœºæ™¯ï¼Œè°ƒç ”äº†ä¸€ä¸‹ç›®å‰ä¸»æµçš„æ–¹æ¡ˆï¼Œåˆ†æäº†ä¸€ä¸‹ä¼˜åŠ£å¹¶ä¸”æ•²å®šäº†æœ€ç»ˆçš„æ–¹æ¡ˆã€‚è¿™ç¯‡æ–‡ç« è®°å½•äº†è°ƒç ”çš„è¿‡ç¨‹ï¼Œä»¥åŠåˆæ­¥æ–¹æ¡ˆçš„å®ç°ã€‚ å€™é€‰æ–¹æ¡ˆå¯¹æ¯” ä¸‹é¢æ˜¯æƒ³åˆ°çš„å‡ ç§å®ç°å»¶æ—¶ä»»åŠ¡çš„æ–¹æ¡ˆï¼Œæ€»ç»“äº†ä¸€ä¸‹ç›¸åº”çš„ä¼˜åŠ¿å’ŒåŠ£åŠ¿ã€‚ æ–¹æ¡ˆ ä¼˜åŠ¿ åŠ£åŠ¿ é€‰ç”¨åœºæ™¯ JDKå†…ç½®çš„å»¶è¿Ÿé˜Ÿåˆ—DelayQueue å®ç°ç®€å• æ•°æ®å†…å­˜æ€ï¼Œä¸å¯é  ä¸€è‡´æ€§ç›¸å¯¹ä½çš„åœºæ™¯ è°ƒåº¦æ¡†æ¶å’ŒMySQLè¿›è¡ŒçŸ­é—´éš”è½®è¯¢ å®ç°ç®€å•ï¼Œå¯é æ€§é«˜ å­˜åœ¨æ˜æ˜¾çš„æ€§èƒ½ç“¶é¢ˆ æ•°æ®é‡è¾ƒå°‘å®æ—¶æ€§ç›¸å¯¹ä½çš„åœºæ™¯ RabbitMQçš„DLXå’ŒTTLï¼Œä¸€èˆ¬ç§°ä¸ºæ­»ä¿¡é˜Ÿåˆ—æ–¹æ¡ˆ å¼‚æ­¥äº¤äº’å¯ä»¥å‰Šå³° å»¶æ—¶çš„æ—¶é—´é•¿åº¦ä¸å¯æ§ï¼Œå¦‚æœæ•°æ®éœ€è¦æŒä¹…åŒ–åˆ™æ€§èƒ½ä¼šé™ä½ - è°ƒåº¦æ¡†æ¶å’ŒRedisè¿›è¡ŒçŸ­é—´éš”è½®è¯¢ æ•°æ®æŒä¹…åŒ–ï¼Œé«˜æ€§èƒ½ å®ç°éš¾åº¦å¤§ å¸¸è§äºæ”¯ä»˜ç»“æœå›è°ƒæ–¹æ¡ˆ æ—¶é—´è½® å®æ—¶æ€§é«˜ å®ç°éš¾åº¦å¤§ï¼Œå†…å­˜æ¶ˆè€—å¤§ å®æ—¶æ€§é«˜çš„åœºæ™¯ å¦‚æœåº”ç”¨çš„æ•°æ®é‡ä¸é«˜ï¼Œå®æ—¶æ€§è¦æ±‚æ¯”è¾ƒä½ï¼Œé€‰ç”¨è°ƒåº¦æ¡†æ¶å’ŒMySQLè¿›è¡ŒçŸ­é—´éš”è½®è¯¢è¿™ä¸ªæ–¹æ¡ˆæ˜¯æœ€ä¼˜çš„æ–¹æ¡ˆã€‚ä½†æ˜¯ç¬”è€…é‡åˆ°çš„åœºæ™¯æ•°æ®é‡ç›¸å¯¹æ¯”è¾ƒå¤§ï¼Œå®æ—¶æ€§å¹¶ä¸é«˜ï¼Œé‡‡ç”¨æ‰«åº“çš„æ–¹æ¡ˆä¸€å®šä¼šå¯¹MySQLå®ä¾‹é€ æˆæ¯”è¾ƒå¤§çš„å‹åŠ›ã€‚è®°å¾—å¾ˆæ—©ä¹‹å‰ï¼Œçœ‹è¿‡ä¸€ä¸ªPPTå«ã€Šç›’å­ç§‘æŠ€èšåˆæ”¯ä»˜ç³»ç»Ÿæ¼”è¿›ã€‹ï¼Œå…¶ä¸­é‡Œé¢æœ‰ä¸€å¼ å›¾ç‰‡ç»™äºˆç¬”è€…ä¸€ç‚¹å¯å‘ï¼š é‡Œé¢åˆšå¥½ç”¨åˆ°äº†è°ƒåº¦æ¡†æ¶å’ŒRedisè¿›è¡ŒçŸ­é—´éš”è½®è¯¢å®ç°å»¶æ—¶ä»»åŠ¡çš„æ–¹æ¡ˆï¼Œä¸è¿‡ä¸ºäº†åˆ†æ‘Šåº”ç”¨çš„å‹åŠ›ï¼Œå›¾ä¸­çš„æ–¹æ¡ˆè¿˜åšäº†åˆ†ç‰‡å¤„ç†ã€‚é‰´äºç¬”è€…å½“å‰ä¸šåŠ¡ç´§è¿«ï¼Œæ‰€ä»¥åœ¨ç¬¬ä¸€æœŸçš„æ–¹æ¡ˆæš‚æ—¶ä¸è€ƒè™‘åˆ†ç‰‡ï¼Œåªåšäº†ä¸€ä¸ªç®€åŒ–ç‰ˆçš„å®ç°ã€‚ ç”±äºPPTä¸­æ²¡æœ‰ä»»ä½•çš„ä»£ç æˆ–è€…æ¡†æ¶è´´å‡ºï¼Œæœ‰äº›éœ€è¦è§£å†³çš„æŠ€æœ¯ç‚¹éœ€è¦è‡ªè¡Œæ€è€ƒï¼Œä¸‹é¢ä¼šé‡ç°ä¸€æ¬¡æ•´ä¸ªæ–¹æ¡ˆå®ç°çš„è¯¦ç»†è¿‡ç¨‹ã€‚ åœºæ™¯è®¾è®¡ å®é™…çš„ç”Ÿäº§åœºæ™¯æ˜¯ç¬”è€…è´Ÿè´£çš„æŸä¸ªç³»ç»Ÿéœ€è¦å¯¹æ¥ä¸€ä¸ªå¤–éƒ¨çš„èµ„é‡‘æ–¹ï¼Œæ¯ä¸€ç¬”èµ„é‡‘ä¸‹å•åéœ€è¦å»¶æ—¶30åˆ†é’Ÿæ¨é€å¯¹åº”çš„é™„ä»¶ã€‚è¿™é‡Œç®€åŒ–ä¸ºä¸€ä¸ªè®¢å•ä¿¡æ¯æ•°æ®å»¶è¿Ÿå¤„ç†çš„åœºæ™¯ï¼Œå°±æ˜¯æ¯ä¸€ç¬”ä¸‹å•è®°å½•ä¸€æ¡è®¢å•æ¶ˆæ¯(æš‚æ—¶å«åšOrderMessage)ï¼Œè®¢å•æ¶ˆæ¯éœ€è¦å»¶è¿Ÿ5åˆ°15ç§’åè¿›è¡Œå¼‚æ­¥å¤„ç†ã€‚ å¦å†³çš„å€™é€‰æ–¹æ¡ˆå®ç°æ€è·¯ ä¸‹é¢ä»‹ç»ä¸€ä¸‹å…¶å®ƒå››ä¸ªä¸é€‰ç”¨çš„å€™é€‰æ–¹æ¡ˆï¼Œç»“åˆä¸€äº›ä¼ªä»£ç å’Œæµç¨‹åˆ†æä¸€ä¸‹å®ç°è¿‡ç¨‹ã€‚ JDKå†…ç½®å»¶è¿Ÿé˜Ÿåˆ— DelayQueueæ˜¯ä¸€ä¸ªé˜»å¡é˜Ÿåˆ—çš„å®ç°ï¼Œå®ƒçš„é˜Ÿåˆ—å…ƒç´ å¿…é¡»æ˜¯Delayedçš„å­ç±»ï¼Œè¿™é‡Œåšä¸ªç®€å•çš„ä¾‹å­ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109public class DelayQueueMain &#123; private static final Logger LOGGER = LoggerFactory.getLogger(DelayQueueMain.class); public static void main(String[] args) throws Exception &#123; DelayQueue&lt;OrderMessage&gt; queue = new DelayQueue&lt;&gt;(); // é»˜è®¤å»¶è¿Ÿ5ç§’ OrderMessage message = new OrderMessage(\"ORDER_ID_10086\"); queue.add(message); // å»¶è¿Ÿ6ç§’ message = new OrderMessage(\"ORDER_ID_10087\", 6); queue.add(message); // å»¶è¿Ÿ10ç§’ message = new OrderMessage(\"ORDER_ID_10088\", 10); queue.add(message); ExecutorService executorService = Executors.newSingleThreadExecutor(r -&gt; &#123; Thread thread = new Thread(r); thread.setName(\"DelayWorker\"); thread.setDaemon(true); return thread; &#125;); LOGGER.info(\"å¼€å§‹æ‰§è¡Œè°ƒåº¦çº¿ç¨‹...\"); executorService.execute(() -&gt; &#123; while (true) &#123; try &#123; OrderMessage task = queue.take(); LOGGER.info(\"å»¶è¿Ÿå¤„ç†è®¢å•æ¶ˆæ¯,&#123;&#125;\", task.getDescription()); &#125; catch (Exception e) &#123; LOGGER.error(e.getMessage(), e); &#125; &#125; &#125;); Thread.sleep(Integer.MAX_VALUE); &#125; private static class OrderMessage implements Delayed &#123; private static final DateTimeFormatter F = DateTimeFormatter.ofPattern(\"yyyy-MM-dd HH:mm:ss\"); /** * é»˜è®¤å»¶è¿Ÿ5000æ¯«ç§’ */ private static final long DELAY_MS = 1000L * 5; /** * è®¢å•ID */ private final String orderId; /** * åˆ›å»ºæ—¶é—´æˆ³ */ private final long timestamp; /** * è¿‡æœŸæ—¶é—´ */ private final long expire; /** * æè¿° */ private final String description; public OrderMessage(String orderId, long expireSeconds) &#123; this.orderId = orderId; this.timestamp = System.currentTimeMillis(); this.expire = this.timestamp + expireSeconds * 1000L; this.description = String.format(\"è®¢å•[%s]-åˆ›å»ºæ—¶é—´ä¸º:%s,è¶…æ—¶æ—¶é—´ä¸º:%s\", orderId, LocalDateTime.ofInstant(Instant.ofEpochMilli(timestamp), ZoneId.systemDefault()).format(F), LocalDateTime.ofInstant(Instant.ofEpochMilli(expire), ZoneId.systemDefault()).format(F)); &#125; public OrderMessage(String orderId) &#123; this.orderId = orderId; this.timestamp = System.currentTimeMillis(); this.expire = this.timestamp + DELAY_MS; this.description = String.format(\"è®¢å•[%s]-åˆ›å»ºæ—¶é—´ä¸º:%s,è¶…æ—¶æ—¶é—´ä¸º:%s\", orderId, LocalDateTime.ofInstant(Instant.ofEpochMilli(timestamp), ZoneId.systemDefault()).format(F), LocalDateTime.ofInstant(Instant.ofEpochMilli(expire), ZoneId.systemDefault()).format(F)); &#125; public String getOrderId() &#123; return orderId; &#125; public long getTimestamp() &#123; return timestamp; &#125; public long getExpire() &#123; return expire; &#125; public String getDescription() &#123; return description; &#125; @Override public long getDelay(TimeUnit unit) &#123; return unit.convert(this.expire - System.currentTimeMillis(), TimeUnit.MILLISECONDS); &#125; @Override public int compareTo(Delayed o) &#123; return (int) (this.getDelay(TimeUnit.MILLISECONDS) - o.getDelay(TimeUnit.MILLISECONDS)); &#125; &#125;&#125; æ³¨æ„ä¸€ä¸‹ï¼ŒOrderMessageå®ç°Delayedæ¥å£ï¼Œå…³é”®æ˜¯éœ€è¦å®ç°Delayed#getDelay()å’ŒDelayed#compareTo()ã€‚è¿è¡Œä¸€ä¸‹main()æ–¹æ³•ï¼š 123410:16:08.240 [main] INFO club.throwable.delay.DelayQueueMain - å¼€å§‹æ‰§è¡Œè°ƒåº¦çº¿ç¨‹...10:16:13.224 [DelayWorker] INFO club.throwable.delay.DelayQueueMain - å»¶è¿Ÿå¤„ç†è®¢å•æ¶ˆæ¯,è®¢å•[ORDER_ID_10086]-åˆ›å»ºæ—¶é—´ä¸º:2019-08-20 10:16:08,è¶…æ—¶æ—¶é—´ä¸º:2019-08-20 10:16:1310:16:14.237 [DelayWorker] INFO club.throwable.delay.DelayQueueMain - å»¶è¿Ÿå¤„ç†è®¢å•æ¶ˆæ¯,è®¢å•[ORDER_ID_10087]-åˆ›å»ºæ—¶é—´ä¸º:2019-08-20 10:16:08,è¶…æ—¶æ—¶é—´ä¸º:2019-08-20 10:16:1410:16:18.237 [DelayWorker] INFO club.throwable.delay.DelayQueueMain - å»¶è¿Ÿå¤„ç†è®¢å•æ¶ˆæ¯,è®¢å•[ORDER_ID_10088]-åˆ›å»ºæ—¶é—´ä¸º:2019-08-20 10:16:08,è¶…æ—¶æ—¶é—´ä¸º:2019-08-20 10:16:18 è°ƒåº¦æ¡†æ¶ + MySQL ä½¿ç”¨è°ƒåº¦æ¡†æ¶å¯¹MySQLè¡¨è¿›è¡ŒçŸ­é—´éš”è½®è¯¢æ˜¯å®ç°éš¾åº¦æ¯”è¾ƒä½çš„æ–¹æ¡ˆï¼Œé€šå¸¸æœåŠ¡åˆšä¸Šçº¿ï¼Œè¡¨æ•°æ®ä¸å¤šå¹¶ä¸”å®æ—¶æ€§ä¸é«˜çš„æƒ…å†µä¸‹åº”è¯¥é¦–é€‰è¿™ä¸ªæ–¹æ¡ˆã€‚ä¸è¿‡è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹ï¼š æ³¨æ„è½®è¯¢é—´éš”ä¸èƒ½å¤ªçŸ­ï¼Œå¦åˆ™ä¼šå¯¹MySQLå®ä¾‹äº§ç”Ÿå½±å“ã€‚ æ³¨æ„æ¯æ¬¡æŸ¥è¯¢çš„æ•°é‡ï¼Œç»“æœé›†æ•°é‡å¤ªå¤šæœ‰å¯èƒ½ä¼šå¯¼è‡´è°ƒåº¦é˜»å¡å’Œå ç”¨åº”ç”¨å¤§é‡å†…å­˜ï¼Œä»è€Œå½±å“æ—¶æ•ˆæ€§ã€‚ æ³¨æ„è¦è®¾è®¡çŠ¶æ€å€¼å’Œæœ€å¤§é‡è¯•æ¬¡æ•°ï¼Œè¿™æ ·æ‰èƒ½å°½é‡é¿å…å¤§é‡æ•°æ®ç§¯å‹å’Œé‡å¤æŸ¥è¯¢çš„é—®é¢˜ã€‚ æœ€å¥½é€šè¿‡æ—¶é—´åˆ—åšç´¢å¼•ï¼ŒæŸ¥è¯¢æŒ‡å®šæ—¶é—´èŒƒå›´å†…çš„æ•°æ®ã€‚ å¼•å…¥Quartzã€MySQLçš„Javaé©±åŠ¨åŒ…å’Œspring-boot-starter-jdbcï¼ˆè¿™é‡Œåªæ˜¯ä¸ºäº†æ–¹ä¾¿ç”¨ç›¸å¯¹è½»é‡çº§çš„æ¡†æ¶å®ç°ï¼Œç”Ÿäº§ä¸­å¯ä»¥æŒ‰åœºæ™¯æŒ‰éœ€é€‰æ‹©å…¶ä»–æ›´åˆç†çš„æ¡†æ¶ï¼‰ï¼š 123456789101112131415161718&lt;dependency&gt; &lt;groupId&gt;mysql&lt;/groupId&gt; &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt; &lt;version&gt;5.1.48&lt;/version&gt; &lt;scope&gt;test&lt;/scope&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-jdbc&lt;/artifactId&gt; &lt;version&gt;2.1.7.RELEASE&lt;/version&gt; &lt;scope&gt;test&lt;/scope&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.quartz-scheduler&lt;/groupId&gt; &lt;artifactId&gt;quartz&lt;/artifactId&gt; &lt;version&gt;2.3.1&lt;/version&gt; &lt;scope&gt;test&lt;/scope&gt;&lt;/dependency&gt; å‡è®¾è¡¨è®¾è®¡å¦‚ä¸‹ï¼š 123456789101112131415161718CREATE DATABASE `delayTask` CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_520_ci;USE `delayTask`;CREATE TABLE `t_order_message`( id BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT, order_id VARCHAR(50) NOT NULL COMMENT 'è®¢å•ID', create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¥æœŸæ—¶é—´', edit_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'ä¿®æ”¹æ—¥æœŸæ—¶é—´', retry_times TINYINT NOT NULL DEFAULT 0 COMMENT 'é‡è¯•æ¬¡æ•°', order_status TINYINT NOT NULL DEFAULT 0 COMMENT 'è®¢å•çŠ¶æ€', INDEX idx_order_id (order_id), INDEX idx_create_time (create_time)) COMMENT 'è®¢å•ä¿¡æ¯è¡¨';# å†™å…¥ä¸¤æ¡æµ‹è¯•æ•°æ®INSERT INTO t_order_message(order_id) VALUES ('10086'),('10087'); ç¼–å†™ä»£ç ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149// å¸¸é‡public class OrderConstants &#123; public static final int MAX_RETRY_TIMES = 5; public static final int PENDING = 0; public static final int SUCCESS = 1; public static final int FAIL = -1; public static final int LIMIT = 10;&#125;// å®ä½“@Builder@Datapublic class OrderMessage &#123; private Long id; private String orderId; private LocalDateTime createTime; private LocalDateTime editTime; private Integer retryTimes; private Integer orderStatus;&#125;// DAO@RequiredArgsConstructorpublic class OrderMessageDao &#123; private final JdbcTemplate jdbcTemplate; private static final ResultSetExtractor&lt;List&lt;OrderMessage&gt;&gt; M = r -&gt; &#123; List&lt;OrderMessage&gt; list = Lists.newArrayList(); while (r.next()) &#123; list.add(OrderMessage.builder() .id(r.getLong(\"id\")) .orderId(r.getString(\"order_id\")) .createTime(r.getTimestamp(\"create_time\").toLocalDateTime()) .editTime(r.getTimestamp(\"edit_time\").toLocalDateTime()) .retryTimes(r.getInt(\"retry_times\")) .orderStatus(r.getInt(\"order_status\")) .build()); &#125; return list; &#125;; public List&lt;OrderMessage&gt; selectPendingRecords(LocalDateTime start, LocalDateTime end, List&lt;Integer&gt; statusList, int maxRetryTimes, int limit) &#123; StringJoiner joiner = new StringJoiner(\",\"); statusList.forEach(s -&gt; joiner.add(String.valueOf(s))); return jdbcTemplate.query(\"SELECT * FROM t_order_message WHERE create_time &gt;= ? AND create_time &lt;= ? \" + \"AND order_status IN (?) AND retry_times &lt; ? LIMIT ?\", p -&gt; &#123; p.setTimestamp(1, Timestamp.valueOf(start)); p.setTimestamp(2, Timestamp.valueOf(end)); p.setString(3, joiner.toString()); p.setInt(4, maxRetryTimes); p.setInt(5, limit); &#125;, M); &#125; public int updateOrderStatus(Long id, int status) &#123; return jdbcTemplate.update(\"UPDATE t_order_message SET order_status = ?,edit_time = ? WHERE id =?\", p -&gt; &#123; p.setInt(1, status); p.setTimestamp(2, Timestamp.valueOf(LocalDateTime.now())); p.setLong(3, id); &#125;); &#125;&#125;// Service@RequiredArgsConstructorpublic class OrderMessageService &#123; private static final Logger LOGGER = LoggerFactory.getLogger(OrderMessageService.class); private final OrderMessageDao orderMessageDao; private static final List&lt;Integer&gt; STATUS = Lists.newArrayList(); static &#123; STATUS.add(OrderConstants.PENDING); STATUS.add(OrderConstants.FAIL); &#125; public void executeDelayJob() &#123; LOGGER.info(\"è®¢å•å¤„ç†å®šæ—¶ä»»åŠ¡å¼€å§‹æ‰§è¡Œ......\"); LocalDateTime end = LocalDateTime.now(); // ä¸€å¤©å‰ LocalDateTime start = end.minusDays(1); List&lt;OrderMessage&gt; list = orderMessageDao.selectPendingRecords(start, end, STATUS, OrderConstants.MAX_RETRY_TIMES, OrderConstants.LIMIT); if (!list.isEmpty()) &#123; for (OrderMessage m : list) &#123; LOGGER.info(\"å¤„ç†è®¢å•[&#123;&#125;],çŠ¶æ€ç”±&#123;&#125;æ›´æ–°ä¸º&#123;&#125;\", m.getOrderId(), m.getOrderStatus(), OrderConstants.SUCCESS); // è¿™é‡Œå…¶å®å¯ä»¥ä¼˜åŒ–ä¸ºæ‰¹é‡æ›´æ–° orderMessageDao.updateOrderStatus(m.getId(), OrderConstants.SUCCESS); &#125; &#125; LOGGER.info(\"è®¢å•å¤„ç†å®šæ—¶ä»»åŠ¡å¼€å§‹å®Œæ¯•......\"); &#125;&#125;// Job@DisallowConcurrentExecutionpublic class OrderMessageDelayJob implements Job &#123; @Override public void execute(JobExecutionContext jobExecutionContext) throws JobExecutionException &#123; OrderMessageService service = (OrderMessageService) jobExecutionContext.getMergedJobDataMap().get(\"orderMessageService\"); service.executeDelayJob(); &#125; public static void main(String[] args) throws Exception &#123; HikariConfig config = new HikariConfig(); config.setJdbcUrl(\"jdbc:mysql://localhost:3306/delayTask?useSSL=false&amp;characterEncoding=utf8\"); config.setDriverClassName(Driver.class.getName()); config.setUsername(\"root\"); config.setPassword(\"root\"); HikariDataSource dataSource = new HikariDataSource(config); OrderMessageDao orderMessageDao = new OrderMessageDao(new JdbcTemplate(dataSource)); OrderMessageService service = new OrderMessageService(orderMessageDao); // å†…å­˜æ¨¡å¼çš„è°ƒåº¦å™¨ StdSchedulerFactory factory = new StdSchedulerFactory(); Scheduler scheduler = factory.getScheduler(); // è¿™é‡Œæ²¡æœ‰ç”¨åˆ°IOCå®¹å™¨,ç›´æ¥ç”¨Quartzæ•°æ®é›†åˆä¼ é€’æœåŠ¡å¼•ç”¨ JobDataMap jobDataMap = new JobDataMap(); jobDataMap.put(\"orderMessageService\", service); // æ–°å»ºJob JobDetail job = JobBuilder.newJob(OrderMessageDelayJob.class) .withIdentity(\"orderMessageDelayJob\", \"delayJob\") .usingJobData(jobDataMap) .build(); // æ–°å»ºè§¦å‘å™¨,10ç§’æ‰§è¡Œä¸€æ¬¡ Trigger trigger = TriggerBuilder.newTrigger() .withIdentity(\"orderMessageDelayTrigger\", \"delayJob\") .withSchedule(SimpleScheduleBuilder.simpleSchedule().withIntervalInSeconds(10).repeatForever()) .build(); scheduler.scheduleJob(job, trigger); // å¯åŠ¨è°ƒåº¦å™¨ scheduler.start(); Thread.sleep(Integer.MAX_VALUE); &#125;&#125; è¿™ä¸ªä¾‹å­é‡Œé¢ç”¨äº†create_timeåšè½®è¯¢ï¼Œå®é™…ä¸Šå¯ä»¥æ·»åŠ ä¸€ä¸ªè°ƒåº¦æ—¶é—´schedule_timeåˆ—åšè½®è¯¢ï¼Œè¿™æ ·å­æ‰èƒ½æ›´å®¹æ˜“å®šåˆ¶ç©ºé—²æ—¶å’Œå¿™ç¢Œæ—¶å€™çš„è°ƒåº¦ç­–ç•¥ã€‚ä¸Šé¢çš„ç¤ºä¾‹çš„è¿è¡Œæ•ˆæœå¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637383911:58:27.202 [main] INFO org.quartz.core.QuartzScheduler - Scheduler meta-data: Quartz Scheduler (v2.3.1) 'DefaultQuartzScheduler' with instanceId 'NON_CLUSTERED' Scheduler class: 'org.quartz.core.QuartzScheduler' - running locally. NOT STARTED. Currently in standby mode. Number of jobs executed: 0 Using thread pool 'org.quartz.simpl.SimpleThreadPool' - with 10 threads. Using job-store 'org.quartz.simpl.RAMJobStore' - which does not support persistence. and is not clustered.11:58:27.202 [main] INFO org.quartz.impl.StdSchedulerFactory - Quartz scheduler 'DefaultQuartzScheduler' initialized from default resource file in Quartz package: 'quartz.properties'11:58:27.202 [main] INFO org.quartz.impl.StdSchedulerFactory - Quartz scheduler version: 2.3.111:58:27.209 [main] INFO org.quartz.core.QuartzScheduler - Scheduler DefaultQuartzScheduler_$_NON_CLUSTERED started.11:58:27.212 [DefaultQuartzScheduler_QuartzSchedulerThread] DEBUG org.quartz.core.QuartzSchedulerThread - batch acquisition of 1 triggers11:58:27.217 [DefaultQuartzScheduler_QuartzSchedulerThread] DEBUG org.quartz.simpl.PropertySettingJobFactory - Producing instance of Job 'delayJob.orderMessageDelayJob', class=club.throwable.jdbc.OrderMessageDelayJob11:58:27.219 [HikariPool-1 connection adder] DEBUG com.zaxxer.hikari.pool.HikariPool - HikariPool-1 - Added connection com.mysql.jdbc.JDBC4Connection@10eb8c5311:58:27.220 [DefaultQuartzScheduler_QuartzSchedulerThread] DEBUG org.quartz.core.QuartzSchedulerThread - batch acquisition of 0 triggers11:58:27.221 [DefaultQuartzScheduler_Worker-1] DEBUG org.quartz.core.JobRunShell - Calling execute on job delayJob.orderMessageDelayJob11:58:34.440 [DefaultQuartzScheduler_Worker-1] INFO club.throwable.jdbc.OrderMessageService - è®¢å•å¤„ç†å®šæ—¶ä»»åŠ¡å¼€å§‹æ‰§è¡Œ......11:58:34.451 [HikariPool-1 connection adder] DEBUG com.zaxxer.hikari.pool.HikariPool - HikariPool-1 - Added connection com.mysql.jdbc.JDBC4Connection@3d27ece411:58:34.459 [HikariPool-1 connection adder] DEBUG com.zaxxer.hikari.pool.HikariPool - HikariPool-1 - Added connection com.mysql.jdbc.JDBC4Connection@64e808af11:58:34.470 [HikariPool-1 connection adder] DEBUG com.zaxxer.hikari.pool.HikariPool - HikariPool-1 - Added connection com.mysql.jdbc.JDBC4Connection@79c8c2b711:58:34.477 [HikariPool-1 connection adder] DEBUG com.zaxxer.hikari.pool.HikariPool - HikariPool-1 - Added connection com.mysql.jdbc.JDBC4Connection@19a6236911:58:34.485 [HikariPool-1 connection adder] DEBUG com.zaxxer.hikari.pool.HikariPool - HikariPool-1 - Added connection com.mysql.jdbc.JDBC4Connection@1673d01711:58:34.485 [HikariPool-1 connection adder] DEBUG com.zaxxer.hikari.pool.HikariPool - HikariPool-1 - After adding stats (total=10, active=0, idle=10, waiting=0)11:58:34.559 [DefaultQuartzScheduler_Worker-1] DEBUG org.springframework.jdbc.core.JdbcTemplate - Executing prepared SQL query11:58:34.565 [DefaultQuartzScheduler_Worker-1] DEBUG org.springframework.jdbc.core.JdbcTemplate - Executing prepared SQL statement [SELECT * FROM t_order_message WHERE create_time &gt;= ? AND create_time &lt;= ? AND order_status IN (?) AND retry_times &lt; ? LIMIT ?]11:58:34.645 [DefaultQuartzScheduler_Worker-1] DEBUG org.springframework.jdbc.datasource.DataSourceUtils - Fetching JDBC Connection from DataSource11:58:35.210 [DefaultQuartzScheduler_Worker-1] DEBUG org.springframework.jdbc.core.JdbcTemplate - SQLWarning ignored: SQL state '22007', error code '1292', message [Truncated incorrect DOUBLE value: '0,-1']11:58:35.335 [DefaultQuartzScheduler_Worker-1] INFO club.throwable.jdbc.OrderMessageService - å¤„ç†è®¢å•[10086],çŠ¶æ€ç”±0æ›´æ–°ä¸º111:58:35.342 [DefaultQuartzScheduler_Worker-1] DEBUG org.springframework.jdbc.core.JdbcTemplate - Executing prepared SQL update11:58:35.346 [DefaultQuartzScheduler_Worker-1] DEBUG org.springframework.jdbc.core.JdbcTemplate - Executing prepared SQL statement [UPDATE t_order_message SET order_status = ?,edit_time = ? WHERE id =?]11:58:35.347 [DefaultQuartzScheduler_Worker-1] DEBUG org.springframework.jdbc.datasource.DataSourceUtils - Fetching JDBC Connection from DataSource11:58:35.354 [DefaultQuartzScheduler_Worker-1] INFO club.throwable.jdbc.OrderMessageService - å¤„ç†è®¢å•[10087],çŠ¶æ€ç”±0æ›´æ–°ä¸º111:58:35.355 [DefaultQuartzScheduler_Worker-1] DEBUG org.springframework.jdbc.core.JdbcTemplate - Executing prepared SQL update11:58:35.355 [DefaultQuartzScheduler_Worker-1] DEBUG org.springframework.jdbc.core.JdbcTemplate - Executing prepared SQL statement [UPDATE t_order_message SET order_status = ?,edit_time = ? WHERE id =?]11:58:35.355 [DefaultQuartzScheduler_Worker-1] DEBUG org.springframework.jdbc.datasource.DataSourceUtils - Fetching JDBC Connection from DataSource11:58:35.361 [DefaultQuartzScheduler_Worker-1] INFO club.throwable.jdbc.OrderMessageService - è®¢å•å¤„ç†å®šæ—¶ä»»åŠ¡å¼€å§‹å®Œæ¯•......11:58:35.363 [DefaultQuartzScheduler_QuartzSchedulerThread] DEBUG org.quartz.core.QuartzSchedulerThread - batch acquisition of 1 triggers11:58:37.206 [DefaultQuartzScheduler_QuartzSchedulerThread] DEBUG org.quartz.simpl.PropertySettingJobFactory - Producing instance of Job 'delayJob.orderMessageDelayJob', class=club.throwable.jdbc.OrderMessageDelayJob11:58:37.206 [DefaultQuartzScheduler_QuartzSchedulerThread] DEBUG org.quartz.core.QuartzSchedulerThread - batch acquisition of 0 triggers RabbitMQæ­»ä¿¡é˜Ÿåˆ— ä½¿ç”¨RabbitMQæ­»ä¿¡é˜Ÿåˆ—ä¾èµ–äºRabbitMQçš„ä¸¤ä¸ªç‰¹æ€§ï¼šTTLå’ŒDLXã€‚ TTLï¼šTime To Liveï¼Œæ¶ˆæ¯å­˜æ´»æ—¶é—´ï¼ŒåŒ…æ‹¬ä¸¤ä¸ªç»´åº¦ï¼šé˜Ÿåˆ—æ¶ˆæ¯å­˜æ´»æ—¶é—´å’Œæ¶ˆæ¯æœ¬èº«çš„å­˜æ´»æ—¶é—´ã€‚ DLXï¼šDead Letter Exchangeï¼Œæ­»ä¿¡äº¤æ¢å™¨ã€‚ ç”»ä¸ªå›¾æè¿°ä¸€ä¸‹è¿™ä¸¤ä¸ªç‰¹æ€§ï¼š ä¸‹é¢ä¸ºäº†ç®€å•èµ·è§ï¼ŒTTLä½¿ç”¨äº†é’ˆå¯¹é˜Ÿåˆ—çš„ç»´åº¦ã€‚å¼•å…¥RabbitMQçš„Javaé©±åŠ¨ï¼š 123456&lt;dependency&gt; &lt;groupId&gt;com.rabbitmq&lt;/groupId&gt; &lt;artifactId&gt;amqp-client&lt;/artifactId&gt; &lt;version&gt;5.7.3&lt;/version&gt; &lt;scope&gt;test&lt;/scope&gt;&lt;/dependency&gt; ä»£ç å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192939495public class DlxMain &#123; private static final DateTimeFormatter F = DateTimeFormatter.ofPattern(\"yyyy-MM-dd HH:mm:ss\"); private static final Logger LOGGER = LoggerFactory.getLogger(DlxMain.class); public static void main(String[] args) throws Exception &#123; ConnectionFactory factory = new ConnectionFactory(); Connection connection = factory.newConnection(); Channel producerChannel = connection.createChannel(); Channel consumerChannel = connection.createChannel(); // dlxäº¤æ¢å™¨åç§°ä¸ºdlx.exchange,ç±»å‹æ˜¯direct,ç»‘å®šé”®ä¸ºdlx.key,é˜Ÿåˆ—åä¸ºdlx.queue producerChannel.exchangeDeclare(\"dlx.exchange\", \"direct\"); producerChannel.queueDeclare(\"dlx.queue\", false, false, false, null); producerChannel.queueBind(\"dlx.queue\", \"dlx.exchange\", \"dlx.key\"); Map&lt;String, Object&gt; queueArgs = new HashMap&lt;&gt;(); // è®¾ç½®é˜Ÿåˆ—æ¶ˆæ¯è¿‡æœŸæ—¶é—´,5ç§’ queueArgs.put(\"x-message-ttl\", 5000); // æŒ‡å®šDLXç›¸å…³å‚æ•° queueArgs.put(\"x-dead-letter-exchange\", \"dlx.exchange\"); queueArgs.put(\"x-dead-letter-routing-key\", \"dlx.key\"); // å£°æ˜ä¸šåŠ¡é˜Ÿåˆ— producerChannel.queueDeclare(\"business.queue\", false, false, false, queueArgs); ExecutorService executorService = Executors.newSingleThreadExecutor(r -&gt; &#123; Thread thread = new Thread(r); thread.setDaemon(true); thread.setName(\"DlxConsumer\"); return thread; &#125;); // å¯åŠ¨æ¶ˆè´¹è€… executorService.execute(() -&gt; &#123; try &#123; consumerChannel.basicConsume(\"dlx.queue\", true, new DlxConsumer(consumerChannel)); &#125; catch (IOException e) &#123; LOGGER.error(e.getMessage(), e); &#125; &#125;); OrderMessage message = new OrderMessage(\"10086\"); producerChannel.basicPublish(\"\", \"business.queue\", MessageProperties.TEXT_PLAIN, message.getDescription().getBytes(StandardCharsets.UTF_8)); LOGGER.info(\"å‘é€æ¶ˆæ¯æˆåŠŸ,è®¢å•ID:&#123;&#125;\", message.getOrderId()); message = new OrderMessage(\"10087\"); producerChannel.basicPublish(\"\", \"business.queue\", MessageProperties.TEXT_PLAIN, message.getDescription().getBytes(StandardCharsets.UTF_8)); LOGGER.info(\"å‘é€æ¶ˆæ¯æˆåŠŸ,è®¢å•ID:&#123;&#125;\", message.getOrderId()); message = new OrderMessage(\"10088\"); producerChannel.basicPublish(\"\", \"business.queue\", MessageProperties.TEXT_PLAIN, message.getDescription().getBytes(StandardCharsets.UTF_8)); LOGGER.info(\"å‘é€æ¶ˆæ¯æˆåŠŸ,è®¢å•ID:&#123;&#125;\", message.getOrderId()); Thread.sleep(Integer.MAX_VALUE); &#125; private static class DlxConsumer extends DefaultConsumer &#123; DlxConsumer(Channel channel) &#123; super(channel); &#125; @Override public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException &#123; LOGGER.info(\"å¤„ç†æ¶ˆæ¯æˆåŠŸ:&#123;&#125;\", new String(body, StandardCharsets.UTF_8)); &#125; &#125; private static class OrderMessage &#123; private final String orderId; private final long timestamp; private final String description; OrderMessage(String orderId) &#123; this.orderId = orderId; this.timestamp = System.currentTimeMillis(); this.description = String.format(\"è®¢å•[%s],è®¢å•åˆ›å»ºæ—¶é—´ä¸º:%s\", orderId, LocalDateTime.ofInstant(Instant.ofEpochMilli(timestamp), ZoneId.systemDefault()).format(F)); &#125; public String getOrderId() &#123; return orderId; &#125; public long getTimestamp() &#123; return timestamp; &#125; public String getDescription() &#123; return description; &#125; &#125;&#125; è¿è¡Œmain()æ–¹æ³•ç»“æœå¦‚ä¸‹ï¼š 12345616:35:58.638 [main] INFO club.throwable.dlx.DlxMain - å‘é€æ¶ˆæ¯æˆåŠŸ,è®¢å•ID:1008616:35:58.641 [main] INFO club.throwable.dlx.DlxMain - å‘é€æ¶ˆæ¯æˆåŠŸ,è®¢å•ID:1008716:35:58.641 [main] INFO club.throwable.dlx.DlxMain - å‘é€æ¶ˆæ¯æˆåŠŸ,è®¢å•ID:1008816:36:03.646 [pool-1-thread-4] INFO club.throwable.dlx.DlxMain - å¤„ç†æ¶ˆæ¯æˆåŠŸ:è®¢å•[10086],è®¢å•åˆ›å»ºæ—¶é—´ä¸º:2019-08-20 16:35:5816:36:03.670 [pool-1-thread-5] INFO club.throwable.dlx.DlxMain - å¤„ç†æ¶ˆæ¯æˆåŠŸ:è®¢å•[10087],è®¢å•åˆ›å»ºæ—¶é—´ä¸º:2019-08-20 16:35:5816:36:03.670 [pool-1-thread-6] INFO club.throwable.dlx.DlxMain - å¤„ç†æ¶ˆæ¯æˆåŠŸ:è®¢å•[10088],è®¢å•åˆ›å»ºæ—¶é—´ä¸º:2019-08-20 16:35:58 æ—¶é—´è½® æ—¶é—´è½®TimingWheelæ˜¯ä¸€ç§é«˜æ•ˆã€ä½å»¶è¿Ÿçš„è°ƒåº¦æ•°æ®ç»“æ„ï¼Œåº•å±‚é‡‡ç”¨æ•°ç»„å®ç°å­˜å‚¨ä»»åŠ¡åˆ—è¡¨çš„ç¯å½¢é˜Ÿåˆ—ï¼Œç¤ºæ„å›¾å¦‚ä¸‹ï¼š è¿™é‡Œæš‚æ—¶ä¸å¯¹æ—¶é—´è½®å’Œå…¶å®ç°ä½œåˆ†æï¼Œåªç®€å•ä¸¾ä¾‹è¯´æ˜æ€ä¹ˆä½¿ç”¨æ—¶é—´è½®å®ç°å»¶æ—¶ä»»åŠ¡ã€‚è¿™é‡Œä½¿ç”¨Nettyæä¾›çš„HashedWheelTimerï¼Œå¼•å…¥ä¾èµ–ï¼š 12345&lt;dependency&gt; &lt;groupId&gt;io.netty&lt;/groupId&gt; &lt;artifactId&gt;netty-common&lt;/artifactId&gt; &lt;version&gt;4.1.39.Final&lt;/version&gt;&lt;/dependency&gt; ä»£ç å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142public class HashedWheelTimerMain &#123; private static final DateTimeFormatter F = DateTimeFormatter.ofPattern(\"yyyy-MM-dd HH:mm:ss.SSS\"); public static void main(String[] args) throws Exception &#123; AtomicInteger counter = new AtomicInteger(); ThreadFactory factory = r -&gt; &#123; Thread thread = new Thread(r); thread.setDaemon(true); thread.setName(\"HashedWheelTimerWorker-\" + counter.getAndIncrement()); return thread; &#125;; // tickDuration - æ¯tickä¸€æ¬¡çš„æ—¶é—´é—´éš”, æ¯tickä¸€æ¬¡å°±ä¼šåˆ°è¾¾ä¸‹ä¸€ä¸ªæ§½ä½ // unit - tickDurationçš„æ—¶é—´å•ä½ // ticksPerWhee - æ—¶é—´è½®ä¸­çš„æ§½ä½æ•° Timer timer = new HashedWheelTimer(factory, 1, TimeUnit.SECONDS, 60); TimerTask timerTask = new DefaultTimerTask(\"10086\"); timer.newTimeout(timerTask, 5, TimeUnit.SECONDS); timerTask = new DefaultTimerTask(\"10087\"); timer.newTimeout(timerTask, 10, TimeUnit.SECONDS); timerTask = new DefaultTimerTask(\"10088\"); timer.newTimeout(timerTask, 15, TimeUnit.SECONDS); Thread.sleep(Integer.MAX_VALUE); &#125; private static class DefaultTimerTask implements TimerTask &#123; private final String orderId; private final long timestamp; public DefaultTimerTask(String orderId) &#123; this.orderId = orderId; this.timestamp = System.currentTimeMillis(); &#125; @Override public void run(Timeout timeout) throws Exception &#123; System.out.println(String.format(\"ä»»åŠ¡æ‰§è¡Œæ—¶é—´:%s,è®¢å•åˆ›å»ºæ—¶é—´:%s,è®¢å•ID:%s\", LocalDateTime.now().format(F), LocalDateTime.ofInstant(Instant.ofEpochMilli(timestamp), ZoneId.systemDefault()).format(F), orderId)); &#125; &#125;&#125; è¿è¡Œç»“æœï¼š 123ä»»åŠ¡æ‰§è¡Œæ—¶é—´:2019-08-20 17:19:49.310,è®¢å•åˆ›å»ºæ—¶é—´:2019-08-20 17:19:43.294,è®¢å•ID:10086ä»»åŠ¡æ‰§è¡Œæ—¶é—´:2019-08-20 17:19:54.297,è®¢å•åˆ›å»ºæ—¶é—´:2019-08-20 17:19:43.301,è®¢å•ID:10087ä»»åŠ¡æ‰§è¡Œæ—¶é—´:2019-08-20 17:19:59.297,è®¢å•åˆ›å»ºæ—¶é—´:2019-08-20 17:19:43.301,è®¢å•ID:10088 ä¸€èˆ¬æ¥è¯´ï¼Œä»»åŠ¡æ‰§è¡Œçš„æ—¶å€™åº”è¯¥ä½¿ç”¨å¦å¤–çš„ä¸šåŠ¡çº¿ç¨‹æ± ï¼Œä»¥å…é˜»å¡æ—¶é—´è½®æœ¬èº«çš„è¿åŠ¨ã€‚ é€‰ç”¨çš„æ–¹æ¡ˆå®ç°è¿‡ç¨‹ æœ€ç»ˆé€‰ç”¨äº†åŸºäºRedisçš„æœ‰åºé›†åˆSorted Setå’ŒQuartzçŸ­è½®è¯¢è¿›è¡Œå®ç°ã€‚å…·ä½“æ–¹æ¡ˆæ˜¯ï¼š è®¢å•åˆ›å»ºçš„æ—¶å€™ï¼Œè®¢å•IDå’Œå½“å‰æ—¶é—´æˆ³åˆ†åˆ«ä½œä¸ºSorted Setçš„memberå’Œscoreæ·»åŠ åˆ°è®¢å•é˜Ÿåˆ—Sorted Setä¸­ã€‚ è®¢å•åˆ›å»ºçš„æ—¶å€™ï¼Œè®¢å•IDå’Œæ¨é€å†…å®¹JSONå­—ç¬¦ä¸²åˆ†åˆ«ä½œä¸ºfieldå’Œvalueæ·»åŠ åˆ°è®¢å•é˜Ÿåˆ—å†…å®¹Hashä¸­ã€‚ ç¬¬1æ­¥å’Œç¬¬2æ­¥æ“ä½œçš„æ—¶å€™ç”¨Luaè„šæœ¬ä¿è¯åŸå­æ€§ã€‚ ä½¿ç”¨ä¸€ä¸ªå¼‚æ­¥çº¿ç¨‹é€šè¿‡Sorted Setçš„å‘½ä»¤ZREVRANGEBYSCOREå¼¹å‡ºæŒ‡å®šæ•°é‡çš„è®¢å•IDå¯¹åº”çš„è®¢å•é˜Ÿåˆ—å†…å®¹Hashä¸­çš„è®¢å•æ¨é€å†…å®¹æ•°æ®è¿›è¡Œå¤„ç†ã€‚ å¯¹äºç¬¬4ç‚¹å¤„ç†æœ‰ä¸¤ç§æ–¹æ¡ˆï¼š æ–¹æ¡ˆä¸€ï¼šå¼¹å‡ºè®¢å•å†…å®¹æ•°æ®çš„åŒæ—¶è¿›è¡Œæ•°æ®åˆ é™¤ï¼Œä¹Ÿå°±æ˜¯ZREVRANGEBYSCOREã€ZREMå’ŒHDELå‘½ä»¤è¦åœ¨åŒä¸€ä¸ªLuaè„šæœ¬ä¸­æ‰§è¡Œï¼Œè¿™æ ·çš„è¯Luaè„šæœ¬çš„ç¼–å†™éš¾åº¦å¤§ï¼Œå¹¶ä¸”ç”±äºå¼¹å‡ºæ•°æ®å·²ç»åœ¨Redisä¸­åˆ é™¤ï¼Œå¦‚æœæ•°æ®å¤„ç†å¤±è´¥åˆ™å¯èƒ½éœ€è¦ä»æ•°æ®åº“é‡æ–°æŸ¥è¯¢è¡¥å¿ã€‚ æ–¹æ¡ˆäºŒï¼šå¼¹å‡ºè®¢å•å†…å®¹æ•°æ®ä¹‹åï¼Œåœ¨æ•°æ®å¤„ç†å®Œæˆçš„æ—¶å€™å†ä¸»åŠ¨åˆ é™¤è®¢å•é˜Ÿåˆ—Sorted Setå’Œè®¢å•é˜Ÿåˆ—å†…å®¹Hashä¸­å¯¹åº”çš„æ•°æ®ï¼Œè¿™æ ·çš„è¯éœ€è¦æ§åˆ¶å¹¶å‘ï¼Œæœ‰é‡å¤æ‰§è¡Œçš„å¯èƒ½æ€§ã€‚ æœ€ç»ˆæš‚æ—¶é€‰ç”¨äº†æ–¹æ¡ˆä¸€ï¼Œä¹Ÿå°±æ˜¯ä»Sorted Setå¼¹å‡ºè®¢å•IDå¹¶ä¸”ä»Hashä¸­è·å–å®Œæ¨é€æ•°æ®ä¹‹åé©¬ä¸Šåˆ é™¤è¿™ä¸¤ä¸ªé›†åˆä¸­å¯¹åº”çš„æ•°æ®ã€‚æ–¹æ¡ˆçš„æµç¨‹å›¾å¤§æ¦‚æ˜¯è¿™æ ·ï¼š è¿™é‡Œå…ˆè¯¦ç»†è¯´æ˜ä¸€ä¸‹ç”¨åˆ°çš„Rediså‘½ä»¤ã€‚ Sorted Setç›¸å…³å‘½ä»¤ ZADDå‘½ä»¤ - å°†ä¸€ä¸ªæˆ–å¤šä¸ªæˆå‘˜å…ƒç´ åŠå…¶åˆ†æ•°å€¼åŠ å…¥åˆ°æœ‰åºé›†å½“ä¸­ã€‚ ZADD KEY SCORE1 VALUE1.. SCOREN VALUEN ZREVRANGEBYSCOREå‘½ä»¤ - è¿”å›æœ‰åºé›†ä¸­æŒ‡å®šåˆ†æ•°åŒºé—´å†…çš„æ‰€æœ‰çš„æˆå‘˜ã€‚æœ‰åºé›†æˆå‘˜æŒ‰åˆ†æ•°å€¼é€’å‡(ä»å¤§åˆ°å°)çš„æ¬¡åºæ’åˆ—ã€‚ ZREVRANGEBYSCORE key max min [WITHSCORES] [LIMIT offset count] maxï¼šåˆ†æ•°åŒºé—´ - æœ€å¤§åˆ†æ•°ã€‚ minï¼šåˆ†æ•°åŒºé—´ - æœ€å°åˆ†æ•°ã€‚ WITHSCORESï¼šå¯é€‰å‚æ•°ï¼Œæ˜¯å¦è¿”å›åˆ†æ•°å€¼ï¼ŒæŒ‡å®šåˆ™ä¼šè¿”å›å¾—åˆ†å€¼ã€‚ LIMITï¼šå¯é€‰å‚æ•°ï¼Œoffsetå’ŒcountåŸç†å’ŒMySQLçš„LIMIT offset,sizeä¸€è‡´ï¼Œå¦‚æœä¸æŒ‡å®šæ­¤å‚æ•°åˆ™è¿”å›æ•´ä¸ªé›†åˆçš„æ•°æ®ã€‚ ZREMå‘½ä»¤ - ç”¨äºç§»é™¤æœ‰åºé›†ä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªæˆå‘˜ï¼Œä¸å­˜åœ¨çš„æˆå‘˜å°†è¢«å¿½ç•¥ã€‚ ZREM key member [member ...] Hashç›¸å…³å‘½ä»¤ HMSETå‘½ä»¤ - åŒæ—¶å°†å¤šä¸ªfield-value(å­—æ®µ-å€¼)å¯¹è®¾ç½®åˆ°å“ˆå¸Œè¡¨ä¸­ã€‚ HMSET KEY_NAME FIELD1 VALUE1 ...FIELDN VALUEN HDELå‘½ä»¤ - åˆ é™¤å“ˆå¸Œè¡¨keyä¸­çš„ä¸€ä¸ªæˆ–å¤šä¸ªæŒ‡å®šå­—æ®µï¼Œä¸å­˜åœ¨çš„å­—æ®µå°†è¢«å¿½ç•¥ã€‚ HDEL KEY_NAME FIELD1.. FIELDN Luaç›¸å…³ åŠ è½½Luaè„šæœ¬å¹¶ä¸”è¿”å›è„šæœ¬çš„SHA-1å­—ç¬¦ä¸²ï¼šSCRIPT LOAD scriptã€‚ æ‰§è¡Œå·²ç»åŠ è½½çš„Luaè„šæœ¬ï¼šEVALSHA sha1 numkeys key [key ...] arg [arg ...]ã€‚ unpackå‡½æ•°å¯ä»¥æŠŠtableç±»å‹çš„å‚æ•°è½¬åŒ–ä¸ºå¯å˜å‚æ•°ï¼Œä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯unpackå‡½æ•°å¿…é¡»ä½¿ç”¨åœ¨éå˜é‡å®šä¹‰çš„å‡½æ•°è°ƒç”¨çš„æœ€åä¸€ä¸ªå‚æ•°ï¼Œå¦åˆ™ä¼šå¤±æ•ˆï¼Œè¯¦ç»†è§Stackoverflowçš„æé—®table.unpack() only returns the first elementã€‚ PSï¼šå¦‚æœä¸ç†Ÿæ‚‰Luaè¯­è¨€ï¼Œå»ºè®®ç³»ç»Ÿå­¦ä¹ ä¸€ä¸‹ï¼Œå› ä¸ºæƒ³ç”¨å¥½Redisï¼Œä¸€å®šç¦»ä¸å¼€Luaã€‚ å¼•å…¥ä¾èµ–ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748&lt;dependencyManagement&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-dependencies&lt;/artifactId&gt; &lt;version&gt;2.1.7.RELEASE&lt;/version&gt; &lt;type&gt;pom&lt;/type&gt; &lt;scope&gt;import&lt;/scope&gt; &lt;/dependency&gt; &lt;/dependencies&gt;&lt;/dependencyManagement&gt;&lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.quartz-scheduler&lt;/groupId&gt; &lt;artifactId&gt;quartz&lt;/artifactId&gt; &lt;version&gt;2.3.1&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;redis.clients&lt;/groupId&gt; &lt;artifactId&gt;jedis&lt;/artifactId&gt; &lt;version&gt;3.1.0&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-jdbc&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework&lt;/groupId&gt; &lt;artifactId&gt;spring-context-support&lt;/artifactId&gt; &lt;version&gt;5.1.9.RELEASE&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.projectlombok&lt;/groupId&gt; &lt;artifactId&gt;lombok&lt;/artifactId&gt; &lt;version&gt;1.18.8&lt;/version&gt; &lt;scope&gt;provided&lt;/scope&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;com.alibaba&lt;/groupId&gt; &lt;artifactId&gt;fastjson&lt;/artifactId&gt; &lt;version&gt;1.2.59&lt;/version&gt; &lt;/dependency&gt; &lt;/dependencies&gt; ç¼–å†™Luaè„šæœ¬/lua/enqueue.luaå’Œ/lua/dequeue.luaï¼š 12345678910111213141516171819202122232425262728293031323334-- /lua/enqueue.lualocal zset_key = KEYS[1]local hash_key = KEYS[2]local zset_value = ARGV[1]local zset_score = ARGV[2]local hash_field = ARGV[3]local hash_value = ARGV[4]redis.call('ZADD', zset_key, zset_score, zset_value)redis.call('HSET', hash_key, hash_field, hash_value)return nil-- /lua/dequeue.lua-- å‚è€ƒjesqueçš„éƒ¨åˆ†Luaè„šæœ¬å®ç°local zset_key = KEYS[1]local hash_key = KEYS[2]local min_score = ARGV[1]local max_score = ARGV[2]local offset = ARGV[3]local limit = ARGV[4]-- TYPEå‘½ä»¤çš„è¿”å›ç»“æœæ˜¯&#123;'ok':'zset'&#125;è¿™æ ·å­,è¿™é‡Œåˆ©ç”¨nextåšä¸€è½®è¿­ä»£local status, type = next(redis.call('TYPE', zset_key))if status ~= nil and status == 'ok' then if type == 'zset' then local list = redis.call('ZREVRANGEBYSCORE', zset_key, max_score, min_score, 'LIMIT', offset, limit) if list ~= nil and #list &gt; 0 then -- unpackå‡½æ•°èƒ½æŠŠtableè½¬åŒ–ä¸ºå¯å˜å‚æ•° redis.call('ZREM', zset_key, unpack(list)) local result = redis.call('HMGET', hash_key, unpack(list)) redis.call('HDEL', hash_key, unpack(list)) return result end endendreturn nil ç¼–å†™æ ¸å¿ƒAPIä»£ç ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155// Jedisæä¾›è€…@Componentpublic class JedisProvider implements InitializingBean &#123; private JedisPool jedisPool; @Override public void afterPropertiesSet() throws Exception &#123; jedisPool = new JedisPool(); &#125; public Jedis provide()&#123; return jedisPool.getResource(); &#125;&#125;// OrderMessage@Datapublic class OrderMessage &#123; private String orderId; private BigDecimal amount; private Long userId;&#125;// å»¶è¿Ÿé˜Ÿåˆ—æ¥å£public interface OrderDelayQueue &#123; void enqueue(OrderMessage message); List&lt;OrderMessage&gt; dequeue(String min, String max, String offset, String limit); List&lt;OrderMessage&gt; dequeue(); String enqueueSha(); String dequeueSha();&#125;// å»¶è¿Ÿé˜Ÿåˆ—å®ç°ç±»@RequiredArgsConstructor@Componentpublic class RedisOrderDelayQueue implements OrderDelayQueue, InitializingBean &#123; private static final String MIN_SCORE = \"0\"; private static final String OFFSET = \"0\"; private static final String LIMIT = \"10\"; private static final String ORDER_QUEUE = \"ORDER_QUEUE\"; private static final String ORDER_DETAIL_QUEUE = \"ORDER_DETAIL_QUEUE\"; private static final String ENQUEUE_LUA_SCRIPT_LOCATION = \"/lua/enqueue.lua\"; private static final String DEQUEUE_LUA_SCRIPT_LOCATION = \"/lua/dequeue.lua\"; private static final AtomicReference&lt;String&gt; ENQUEUE_LUA_SHA = new AtomicReference&lt;&gt;(); private static final AtomicReference&lt;String&gt; DEQUEUE_LUA_SHA = new AtomicReference&lt;&gt;(); private static final List&lt;String&gt; KEYS = Lists.newArrayList(); private final JedisProvider jedisProvider; static &#123; KEYS.add(ORDER_QUEUE); KEYS.add(ORDER_DETAIL_QUEUE); &#125; @Override public void enqueue(OrderMessage message) &#123; List&lt;String&gt; args = Lists.newArrayList(); args.add(message.getOrderId()); args.add(String.valueOf(System.currentTimeMillis())); args.add(message.getOrderId()); args.add(JSON.toJSONString(message)); try (Jedis jedis = jedisProvider.provide()) &#123; jedis.evalsha(ENQUEUE_LUA_SHA.get(), KEYS, args); &#125; &#125; @Override public List&lt;OrderMessage&gt; dequeue() &#123; // 30åˆ†é’Ÿä¹‹å‰ String maxScore = String.valueOf(System.currentTimeMillis() - 30 * 60 * 1000); return dequeue(MIN_SCORE, maxScore, OFFSET, LIMIT); &#125; @SuppressWarnings(\"unchecked\") @Override public List&lt;OrderMessage&gt; dequeue(String min, String max, String offset, String limit) &#123; List&lt;String&gt; args = new ArrayList&lt;&gt;(); args.add(min); args.add(max); args.add(offset); args.add(limit); List&lt;OrderMessage&gt; result = Lists.newArrayList(); try (Jedis jedis = jedisProvider.provide()) &#123; List&lt;String&gt; eval = (List&lt;String&gt;) jedis.evalsha(DEQUEUE_LUA_SHA.get(), KEYS, args); if (null != eval) &#123; for (String e : eval) &#123; result.add(JSON.parseObject(e, OrderMessage.class)); &#125; &#125; &#125; return result; &#125; @Override public String enqueueSha() &#123; return ENQUEUE_LUA_SHA.get(); &#125; @Override public String dequeueSha() &#123; return DEQUEUE_LUA_SHA.get(); &#125; @Override public void afterPropertiesSet() throws Exception &#123; // åŠ è½½Luaè„šæœ¬ loadLuaScript(); &#125; private void loadLuaScript() throws Exception &#123; try (Jedis jedis = jedisProvider.provide()) &#123; ClassPathResource resource = new ClassPathResource(ENQUEUE_LUA_SCRIPT_LOCATION); String luaContent = StreamUtils.copyToString(resource.getInputStream(), StandardCharsets.UTF_8); String sha = jedis.scriptLoad(luaContent); ENQUEUE_LUA_SHA.compareAndSet(null, sha); resource = new ClassPathResource(DEQUEUE_LUA_SCRIPT_LOCATION); luaContent = StreamUtils.copyToString(resource.getInputStream(), StandardCharsets.UTF_8); sha = jedis.scriptLoad(luaContent); DEQUEUE_LUA_SHA.compareAndSet(null, sha); &#125; &#125; public static void main(String[] as) throws Exception &#123; DateTimeFormatter f = DateTimeFormatter.ofPattern(\"yyyy-MM-dd HH:mm:ss.SSS\"); JedisProvider jedisProvider = new JedisProvider(); jedisProvider.afterPropertiesSet(); RedisOrderDelayQueue queue = new RedisOrderDelayQueue(jedisProvider); queue.afterPropertiesSet(); // å†™å…¥æµ‹è¯•æ•°æ® OrderMessage message = new OrderMessage(); message.setAmount(BigDecimal.valueOf(10086)); message.setOrderId(\"ORDER_ID_10086\"); message.setUserId(10086L); message.setTimestamp(LocalDateTime.now().format(f)); List&lt;String&gt; args = Lists.newArrayList(); args.add(message.getOrderId()); // æµ‹è¯•éœ€è¦,scoreè®¾ç½®ä¸º30åˆ†é’Ÿä¹‹å‰ args.add(String.valueOf(System.currentTimeMillis() - 30 * 60 * 1000)); args.add(message.getOrderId()); args.add(JSON.toJSONString(message)); try (Jedis jedis = jedisProvider.provide()) &#123; jedis.evalsha(ENQUEUE_LUA_SHA.get(), KEYS, args); &#125; List&lt;OrderMessage&gt; dequeue = queue.dequeue(); System.out.println(dequeue); &#125;&#125; è¿™é‡Œå…ˆæ‰§è¡Œä¸€æ¬¡main()æ–¹æ³•éªŒè¯ä¸€ä¸‹å»¶è¿Ÿé˜Ÿåˆ—æ˜¯å¦ç”Ÿæ•ˆï¼š 1[OrderMessage(orderId=ORDER_ID_10086, amount=10086, userId=10086, timestamp=2019-08-21 08:32:22.885)] ç¡®å®šå»¶è¿Ÿé˜Ÿåˆ—çš„ä»£ç æ²¡æœ‰é—®é¢˜ï¼Œæ¥ç€ç¼–å†™ä¸€ä¸ªQuartzçš„Jobç±»å‹çš„æ¶ˆè´¹è€…OrderMessageConsumerï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859@DisallowConcurrentExecution@Componentpublic class OrderMessageConsumer implements Job &#123; private static final AtomicInteger COUNTER = new AtomicInteger(); private static final ExecutorService BUSINESS_WORKER_POOL = Executors.newFixedThreadPool(Runtime.getRuntime().availableProcessors(), r -&gt; &#123; Thread thread = new Thread(r); thread.setDaemon(true); thread.setName(\"OrderMessageConsumerWorker-\" + COUNTER.getAndIncrement()); return thread; &#125;); private static final Logger LOGGER = LoggerFactory.getLogger(OrderMessageConsumer.class); @Autowired private OrderDelayQueue orderDelayQueue; @Override public void execute(JobExecutionContext jobExecutionContext) throws JobExecutionException &#123; StopWatch stopWatch = new StopWatch(); stopWatch.start(); LOGGER.info(\"è®¢å•æ¶ˆæ¯å¤„ç†å®šæ—¶ä»»åŠ¡å¼€å§‹æ‰§è¡Œ......\"); List&lt;OrderMessage&gt; messages = orderDelayQueue.dequeue(); if (!messages.isEmpty()) &#123; // ç®€å•çš„åˆ—è¡¨ç­‰åˆ†æ”¾åˆ°çº¿ç¨‹æ± ä¸­æ‰§è¡Œ List&lt;List&lt;OrderMessage&gt;&gt; partition = Lists.partition(messages, 2); int size = partition.size(); final CountDownLatch latch = new CountDownLatch(size); for (List&lt;OrderMessage&gt; p : partition) &#123; BUSINESS_WORKER_POOL.execute(new ConsumeTask(p, latch)); &#125; try &#123; latch.await(); &#125; catch (InterruptedException ignore) &#123; //ignore &#125; &#125; stopWatch.stop(); LOGGER.info(\"è®¢å•æ¶ˆæ¯å¤„ç†å®šæ—¶ä»»åŠ¡æ‰§è¡Œå®Œæ¯•,è€—æ—¶:&#123;&#125; ms......\", stopWatch.getTotalTimeMillis()); &#125; @RequiredArgsConstructor private static class ConsumeTask implements Runnable &#123; private final List&lt;OrderMessage&gt; messages; private final CountDownLatch latch; @Override public void run() &#123; try &#123; // å®é™…ä¸Šè¿™é‡Œåº”è¯¥å•æ¡æ•è·å¼‚å¸¸ for (OrderMessage message : messages) &#123; LOGGER.info(\"å¤„ç†è®¢å•ä¿¡æ¯,å†…å®¹:&#123;&#125;\", message); &#125; &#125; finally &#123; latch.countDown(); &#125; &#125; &#125;&#125; ä¸Šé¢çš„æ¶ˆè´¹è€…è®¾è®¡çš„æ—¶å€™éœ€è¦æœ‰ä»¥ä¸‹è€ƒé‡ï¼š ä½¿ç”¨@DisallowConcurrentExecutionæ³¨è§£ä¸å…è®¸Jobå¹¶å‘æ‰§è¡Œï¼Œå…¶å®å¤šä¸ªJobå¹¶å‘æ‰§è¡Œæ„ä¹‰ä¸å¤§ï¼Œå› ä¸ºæˆ‘ä»¬é‡‡ç”¨çš„æ˜¯çŸ­é—´éš”çš„è½®è¯¢ï¼Œè€ŒRedisæ˜¯å•çº¿ç¨‹å¤„ç†å‘½ä»¤ï¼Œåœ¨å®¢æˆ·ç«¯åšå¤šçº¿ç¨‹å…¶å®æ•ˆæœä¸ä½³ã€‚ çº¿ç¨‹æ± BUSINESS_WORKER_POOLçš„çº¿ç¨‹å®¹é‡æˆ–è€…é˜Ÿåˆ—åº”è¯¥ç»¼åˆLIMITå€¼ã€ç­‰åˆ†è®¢å•ä¿¡æ¯åˆ—è¡¨ä¸­ä½¿ç”¨çš„sizeå€¼ä»¥åŠConsumeTaské‡Œé¢å…·ä½“çš„æ‰§è¡Œæ—¶é—´è¿›è¡Œè€ƒè™‘ï¼Œè¿™é‡Œåªæ˜¯ä¸ºäº†æ–¹ä¾¿ä½¿ç”¨äº†å›ºå®šå®¹é‡çš„çº¿ç¨‹æ± ã€‚ ConsumeTaskä¸­åº”è¯¥å¯¹æ¯ä¸€æ¡è®¢å•ä¿¡æ¯çš„å¤„ç†å•ç‹¬æ•è·å¼‚å¸¸å’Œåå¹¶å¼‚å¸¸ï¼Œæˆ–è€…æŠŠå¤„ç†å•ä¸ªè®¢å•ä¿¡æ¯çš„é€»è¾‘å°è£…æˆä¸€ä¸ªä¸æŠ›å‡ºå¼‚å¸¸çš„æ–¹æ³•ã€‚ å…¶ä»–Quartzç›¸å…³çš„ä»£ç ï¼š 1234567891011121314151617181920212223242526272829303132333435// Quartzé…ç½®ç±»@Configurationpublic class QuartzAutoConfiguration &#123; @Bean public SchedulerFactoryBean schedulerFactoryBean(QuartzAutowiredJobFactory quartzAutowiredJobFactory) &#123; SchedulerFactoryBean factory = new SchedulerFactoryBean(); factory.setAutoStartup(true); factory.setJobFactory(quartzAutowiredJobFactory); return factory; &#125; @Bean public QuartzAutowiredJobFactory quartzAutowiredJobFactory() &#123; return new QuartzAutowiredJobFactory(); &#125; public static class QuartzAutowiredJobFactory extends AdaptableJobFactory implements BeanFactoryAware &#123; private AutowireCapableBeanFactory autowireCapableBeanFactory; @Override public void setBeanFactory(BeanFactory beanFactory) throws BeansException &#123; this.autowireCapableBeanFactory = (AutowireCapableBeanFactory) beanFactory; &#125; @Override protected Object createJobInstance(TriggerFiredBundle bundle) throws Exception &#123; Object jobInstance = super.createJobInstance(bundle); // è¿™é‡Œåˆ©ç”¨AutowireCapableBeanFactoryä»æ–°å»ºçš„Jobå®ä¾‹åšä¸€æ¬¡è‡ªåŠ¨è£…é…,å¾—åˆ°ä¸€ä¸ªåŸå‹(prototype)çš„JobBeanå®ä¾‹ autowireCapableBeanFactory.autowireBean(jobInstance); return jobInstance; &#125; &#125;&#125; è¿™é‡Œæš‚æ—¶ä½¿ç”¨äº†å†…å­˜æ€çš„RAMJobStoreå»å­˜æ”¾ä»»åŠ¡å’Œè§¦å‘å™¨çš„ç›¸å…³ä¿¡æ¯ï¼Œå¦‚æœåœ¨ç”Ÿäº§ç¯å¢ƒæœ€å¥½æ›¿æ¢æˆåŸºäºMySQLä¹Ÿå°±æ˜¯JobStoreTXè¿›è¡Œé›†ç¾¤åŒ–ï¼Œæœ€åæ˜¯å¯åŠ¨å‡½æ•°å’ŒCommandLineRunnerçš„å®ç°ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253@SpringBootApplication(exclude = &#123;DataSourceAutoConfiguration.class, TransactionAutoConfiguration.class&#125;)public class Application implements CommandLineRunner &#123; @Autowired private Scheduler scheduler; @Autowired private JedisProvider jedisProvider; public static void main(String[] args) &#123; SpringApplication.run(Application.class, args); &#125; @Override public void run(String... args) throws Exception &#123; // å‡†å¤‡ä¸€äº›æµ‹è¯•æ•°æ® prepareOrderMessageData(); JobDetail job = JobBuilder.newJob(OrderMessageConsumer.class) .withIdentity(\"OrderMessageConsumer\", \"DelayTask\") .build(); // è§¦å‘å™¨5ç§’è§¦å‘ä¸€æ¬¡ Trigger trigger = TriggerBuilder.newTrigger() .withIdentity(\"OrderMessageConsumerTrigger\", \"DelayTask\") .withSchedule(SimpleScheduleBuilder.simpleSchedule().withIntervalInSeconds(5).repeatForever()) .build(); scheduler.scheduleJob(job, trigger); &#125; private void prepareOrderMessageData() throws Exception &#123; DateTimeFormatter f = DateTimeFormatter.ofPattern(\"yyyy-MM-dd HH:mm:ss.SSS\"); try (Jedis jedis = jedisProvider.provide()) &#123; List&lt;OrderMessage&gt; messages = Lists.newArrayList(); for (int i = 0; i &lt; 100; i++) &#123; OrderMessage message = new OrderMessage(); message.setAmount(BigDecimal.valueOf(i)); message.setOrderId(\"ORDER_ID_\" + i); message.setUserId((long) i); message.setTimestamp(LocalDateTime.now().format(f)); messages.add(message); &#125; // è¿™é‡Œæš‚æ—¶ä¸ä½¿ç”¨Lua Map&lt;String, Double&gt; map = Maps.newHashMap(); Map&lt;String, String&gt; hash = Maps.newHashMap(); for (OrderMessage message : messages) &#123; // æ•…æ„æŠŠscoreè®¾è®¡æˆ30åˆ†é’Ÿå‰ map.put(message.getOrderId(), Double.valueOf(String.valueOf(System.currentTimeMillis() - 30 * 60 * 1000))); hash.put(message.getOrderId(), JSON.toJSONString(message)); &#125; jedis.zadd(\"ORDER_QUEUE\", map); jedis.hmset(\"ORDER_DETAIL_QUEUE\", hash); &#125; &#125;&#125; è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252019-08-21 22:45:59.518 INFO 33000 --- [ryBean_Worker-1] club.throwable.OrderMessageConsumer : è®¢å•æ¶ˆæ¯å¤„ç†å®šæ—¶ä»»åŠ¡å¼€å§‹æ‰§è¡Œ......2019-08-21 22:45:59.525 INFO 33000 --- [onsumerWorker-4] club.throwable.OrderMessageConsumer : å¤„ç†è®¢å•ä¿¡æ¯,å†…å®¹:OrderMessage(orderId=ORDER_ID_91, amount=91, userId=91, timestamp=2019-08-21 22:45:59.475)2019-08-21 22:45:59.525 INFO 33000 --- [onsumerWorker-2] club.throwable.OrderMessageConsumer : å¤„ç†è®¢å•ä¿¡æ¯,å†…å®¹:OrderMessage(orderId=ORDER_ID_95, amount=95, userId=95, timestamp=2019-08-21 22:45:59.475)2019-08-21 22:45:59.525 INFO 33000 --- [onsumerWorker-1] club.throwable.OrderMessageConsumer : å¤„ç†è®¢å•ä¿¡æ¯,å†…å®¹:OrderMessage(orderId=ORDER_ID_97, amount=97, userId=97, timestamp=2019-08-21 22:45:59.475)2019-08-21 22:45:59.525 INFO 33000 --- [onsumerWorker-0] club.throwable.OrderMessageConsumer : å¤„ç†è®¢å•ä¿¡æ¯,å†…å®¹:OrderMessage(orderId=ORDER_ID_99, amount=99, userId=99, timestamp=2019-08-21 22:45:59.475)2019-08-21 22:45:59.525 INFO 33000 --- [onsumerWorker-3] club.throwable.OrderMessageConsumer : å¤„ç†è®¢å•ä¿¡æ¯,å†…å®¹:OrderMessage(orderId=ORDER_ID_93, amount=93, userId=93, timestamp=2019-08-21 22:45:59.475)2019-08-21 22:45:59.539 INFO 33000 --- [onsumerWorker-2] club.throwable.OrderMessageConsumer : å¤„ç†è®¢å•ä¿¡æ¯,å†…å®¹:OrderMessage(orderId=ORDER_ID_94, amount=94, userId=94, timestamp=2019-08-21 22:45:59.475)2019-08-21 22:45:59.539 INFO 33000 --- [onsumerWorker-1] club.throwable.OrderMessageConsumer : å¤„ç†è®¢å•ä¿¡æ¯,å†…å®¹:OrderMessage(orderId=ORDER_ID_96, amount=96, userId=96, timestamp=2019-08-21 22:45:59.475)2019-08-21 22:45:59.539 INFO 33000 --- [onsumerWorker-3] club.throwable.OrderMessageConsumer : å¤„ç†è®¢å•ä¿¡æ¯,å†…å®¹:OrderMessage(orderId=ORDER_ID_92, amount=92, userId=92, timestamp=2019-08-21 22:45:59.475)2019-08-21 22:45:59.539 INFO 33000 --- [onsumerWorker-0] club.throwable.OrderMessageConsumer : å¤„ç†è®¢å•ä¿¡æ¯,å†…å®¹:OrderMessage(orderId=ORDER_ID_98, amount=98, userId=98, timestamp=2019-08-21 22:45:59.475)2019-08-21 22:45:59.539 INFO 33000 --- [onsumerWorker-4] club.throwable.OrderMessageConsumer : å¤„ç†è®¢å•ä¿¡æ¯,å†…å®¹:OrderMessage(orderId=ORDER_ID_90, amount=90, userId=90, timestamp=2019-08-21 22:45:59.475)2019-08-21 22:45:59.540 INFO 33000 --- [ryBean_Worker-1] club.throwable.OrderMessageConsumer : è®¢å•æ¶ˆæ¯å¤„ç†å®šæ—¶ä»»åŠ¡æ‰§è¡Œå®Œæ¯•,è€—æ—¶:22 ms......2019-08-21 22:46:04.515 INFO 33000 --- [ryBean_Worker-2] club.throwable.OrderMessageConsumer : è®¢å•æ¶ˆæ¯å¤„ç†å®šæ—¶ä»»åŠ¡å¼€å§‹æ‰§è¡Œ......2019-08-21 22:46:04.516 INFO 33000 --- [onsumerWorker-5] club.throwable.OrderMessageConsumer : å¤„ç†è®¢å•ä¿¡æ¯,å†…å®¹:OrderMessage(orderId=ORDER_ID_89, amount=89, userId=89, timestamp=2019-08-21 22:45:59.475)2019-08-21 22:46:04.516 INFO 33000 --- [onsumerWorker-6] club.throwable.OrderMessageConsumer : å¤„ç†è®¢å•ä¿¡æ¯,å†…å®¹:OrderMessage(orderId=ORDER_ID_87, amount=87, userId=87, timestamp=2019-08-21 22:45:59.475)2019-08-21 22:46:04.516 INFO 33000 --- [onsumerWorker-7] club.throwable.OrderMessageConsumer : å¤„ç†è®¢å•ä¿¡æ¯,å†…å®¹:OrderMessage(orderId=ORDER_ID_85, amount=85, userId=85, timestamp=2019-08-21 22:45:59.475)2019-08-21 22:46:04.516 INFO 33000 --- [onsumerWorker-5] club.throwable.OrderMessageConsumer : å¤„ç†è®¢å•ä¿¡æ¯,å†…å®¹:OrderMessage(orderId=ORDER_ID_88, amount=88, userId=88, timestamp=2019-08-21 22:45:59.475)2019-08-21 22:46:04.516 INFO 33000 --- [onsumerWorker-2] club.throwable.OrderMessageConsumer : å¤„ç†è®¢å•ä¿¡æ¯,å†…å®¹:OrderMessage(orderId=ORDER_ID_83, amount=83, userId=83, timestamp=2019-08-21 22:45:59.475)2019-08-21 22:46:04.516 INFO 33000 --- [onsumerWorker-1] club.throwable.OrderMessageConsumer : å¤„ç†è®¢å•ä¿¡æ¯,å†…å®¹:OrderMessage(orderId=ORDER_ID_81, amount=81, userId=81, timestamp=2019-08-21 22:45:59.475)2019-08-21 22:46:04.516 INFO 33000 --- [onsumerWorker-6] club.throwable.OrderMessageConsumer : å¤„ç†è®¢å•ä¿¡æ¯,å†…å®¹:OrderMessage(orderId=ORDER_ID_86, amount=86, userId=86, timestamp=2019-08-21 22:45:59.475)2019-08-21 22:46:04.516 INFO 33000 --- [onsumerWorker-2] club.throwable.OrderMessageConsumer : å¤„ç†è®¢å•ä¿¡æ¯,å†…å®¹:OrderMessage(orderId=ORDER_ID_82, amount=82, userId=82, timestamp=2019-08-21 22:45:59.475)2019-08-21 22:46:04.516 INFO 33000 --- [onsumerWorker-7] club.throwable.OrderMessageConsumer : å¤„ç†è®¢å•ä¿¡æ¯,å†…å®¹:OrderMessage(orderId=ORDER_ID_84, amount=84, userId=84, timestamp=2019-08-21 22:45:59.475)2019-08-21 22:46:04.516 INFO 33000 --- [onsumerWorker-1] club.throwable.OrderMessageConsumer : å¤„ç†è®¢å•ä¿¡æ¯,å†…å®¹:OrderMessage(orderId=ORDER_ID_80, amount=80, userId=80, timestamp=2019-08-21 22:45:59.475)2019-08-21 22:46:04.516 INFO 33000 --- [ryBean_Worker-2] club.throwable.OrderMessageConsumer : è®¢å•æ¶ˆæ¯å¤„ç†å®šæ—¶ä»»åŠ¡æ‰§è¡Œå®Œæ¯•,è€—æ—¶:1 ms............ é¦–æ¬¡æ‰§è¡Œçš„æ—¶å€™æ¶‰åŠåˆ°ä¸€äº›ç»„ä»¶çš„åˆå§‹åŒ–ï¼Œä¼šæ¯”è¾ƒæ…¢ï¼Œåé¢çœ‹åˆ°ç”±äºæˆ‘ä»¬åªæ˜¯ç®€å•æ‰“å°è®¢å•ä¿¡æ¯ï¼Œæ‰€ä»¥å®šæ—¶ä»»åŠ¡æ‰§è¡Œæ¯”è¾ƒå¿«ã€‚å¦‚æœåœ¨ä¸è°ƒæ•´å½“å‰æ¶æ„çš„æƒ…å†µä¸‹ï¼Œç”Ÿäº§ä¸­éœ€è¦æ³¨æ„ï¼š åˆ‡æ¢JobStoreä¸ºJDBCæ¨¡å¼ï¼ŒQuartzå®˜æ–¹æœ‰å®Œæ•´æ•™ç¨‹ï¼Œæˆ–è€…çœ‹ç¬”è€…ä¹‹å‰ç¿»è¯‘çš„Quartzæ–‡æ¡£ã€‚ éœ€è¦ç›‘æ§æˆ–è€…æ”¶é›†ä»»åŠ¡çš„æ‰§è¡ŒçŠ¶æ€ï¼Œæ·»åŠ é¢„è­¦ç­‰ç­‰ã€‚ è¿™é‡Œå…¶å®æœ‰ä¸€ä¸ªæ€§èƒ½éšæ‚£ï¼Œå‘½ä»¤ZREVRANGEBYSCOREçš„æ—¶é—´å¤æ‚åº¦å¯ä»¥è§†ä¸ºä¸ºO(N)ï¼ŒNæ˜¯é›†åˆçš„å…ƒç´ ä¸ªæ•°ï¼Œç”±äºè¿™é‡ŒæŠŠæ‰€æœ‰çš„è®¢å•ä¿¡æ¯éƒ½æ”¾è¿›äº†åŒä¸€ä¸ªSorted Set(ORDER_QUEUE)ä¸­ï¼Œæ‰€ä»¥åœ¨ä¸€ç›´æœ‰æ–°å¢æ•°æ®çš„æ—¶å€™ï¼Œdequeueè„šæœ¬çš„æ—¶é—´å¤æ‚åº¦ä¸€ç›´æ¯”è¾ƒé«˜ï¼Œåç»­è®¢å•é‡å‡é«˜ä¹‹åä¼šæ­¤å¤„ä¸€å®šä¼šæˆä¸ºæ€§èƒ½ç“¶é¢ˆï¼Œåé¢ä¼šç»™å‡ºè§£å†³çš„æ–¹æ¡ˆã€‚ å°ç»“ è¿™ç¯‡æ–‡ç« ä¸»è¦ä»ä¸€ä¸ªå®é™…ç”Ÿäº§æ¡ˆä¾‹çš„ä»¿çœŸä¾‹å­å…¥æ‰‹ï¼Œåˆ†æäº†å½“å‰å»¶æ—¶ä»»åŠ¡çš„ä¸€äº›å®ç°æ–¹æ¡ˆï¼Œè¿˜åŸºäºRediså’ŒQuartzç»™å‡ºäº†ä¸€ä¸ªå®Œæ•´çš„ç¤ºä¾‹ã€‚å½“å‰çš„ç¤ºä¾‹åªæ˜¯å¤„äºå¯è¿è¡Œçš„çŠ¶æ€ï¼Œæœ‰äº›é—®é¢˜å°šæœªè§£å†³ã€‚ä¸‹ä¸€ç¯‡æ–‡ç« ä¼šç€çœ¼äºè§£å†³ä¸¤ä¸ªæ–¹é¢çš„é—®é¢˜ï¼š åˆ†ç‰‡ã€‚ ç›‘æ§ã€‚ è¿˜æœ‰ä¸€ç‚¹ï¼Œæ¶æ„æ˜¯åŸºäºä¸šåŠ¡å½¢æ€æ¼”è¿›å‡ºæ¥çš„ï¼Œå¾ˆå¤šä¸œè¥¿éœ€è¦ç»“åˆåœºæ™¯è¿›è¡Œæ–¹æ¡ˆè®¾è®¡å’Œæ”¹è¿›ï¼Œæ€è·¯ä»…ä¾›å‚è€ƒï¼Œåˆ‡å‹¿ç…§æ¬ä»£ç ã€‚ é™„ä»¶ Markdownå’ŒPPTåŸä»¶ï¼š ï¼ˆæœ¬æ–‡å®Œ c-5-d e-a-20190821 é¡ºä¾¿å¼€é€šäº†RSSæ’ä»¶ï¼Œè§ä¸»é¡µçš„å›¾æ ‡ï¼Œæ¬¢è¿è®¢é˜… r-a-20190904ï¼‰","categories":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/categories/Middleware/"},{"name":"Redis","slug":"Middleware/Redis","permalink":"http://throwable.club/blog/categories/Middleware/Redis/"}],"tags":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/tags/Middleware/"},{"name":"Redis","slug":"Redis","permalink":"http://throwable.club/blog/tags/Redis/"}]},{"title":"Redisçš„å¤åˆSETå‘½ä»¤å’Œç®€æ˜“çš„åˆ†å¸ƒå¼é”ä¼˜åŒ–","slug":"middleware-redis-set-command-distributed-lock","date":"2019-08-14T16:36:32.000Z","updated":"2019-08-14T16:42:42.590Z","comments":true,"path":"2019/08/15/middleware-redis-set-command-distributed-lock/","link":"","permalink":"http://throwable.club/2019/08/15/middleware-redis-set-command-distributed-lock/","excerpt":"å‰æ æœ€è¿‘åœ¨è·Ÿè¿›ä¸€ä¸ªæ¯”è¾ƒè€çš„ç³»ç»Ÿçš„æ—¶å€™ï¼Œå‘ç°äº†æ‰€æœ‰è°ƒåº¦ä»»åŠ¡ä½¿ç”¨äº†spring-contexté‡Œé¢çš„@Scheduledæ³¨è§£å’Œè‡ªè¡ŒåŸºäºRediså°è£…çš„ç®€æ˜“åˆ†å¸ƒå¼é”æ§åˆ¶ä»»åŠ¡ä¸å¹¶å‘æ‰§è¡Œã€‚ä¸ºäº†ä¸å¼•å…¥å…¶ä»–æ¡†æ¶çš„æƒ…å†µä¸‹åšä¸€äº›ç®€å•ä¼˜åŒ–ï¼Œç¬”è€…èŠ±ç‚¹æ—¶é—´å»ç ”è¯»äº†ä¸€ä¸‹Redisçš„SETå‘½ä»¤çš„ç›¸å…³æ–‡æ¡£ã€‚","text":"å‰æ æœ€è¿‘åœ¨è·Ÿè¿›ä¸€ä¸ªæ¯”è¾ƒè€çš„ç³»ç»Ÿçš„æ—¶å€™ï¼Œå‘ç°äº†æ‰€æœ‰è°ƒåº¦ä»»åŠ¡ä½¿ç”¨äº†spring-contexté‡Œé¢çš„@Scheduledæ³¨è§£å’Œè‡ªè¡ŒåŸºäºRediså°è£…çš„ç®€æ˜“åˆ†å¸ƒå¼é”æ§åˆ¶ä»»åŠ¡ä¸å¹¶å‘æ‰§è¡Œã€‚ä¸ºäº†ä¸å¼•å…¥å…¶ä»–æ¡†æ¶çš„æƒ…å†µä¸‹åšä¸€äº›ç®€å•ä¼˜åŒ–ï¼Œç¬”è€…èŠ±ç‚¹æ—¶é—´å»ç ”è¯»äº†ä¸€ä¸‹Redisçš„SETå‘½ä»¤çš„ç›¸å…³æ–‡æ¡£ã€‚ åœºæ™¯è¿˜åŸ ä½¿ç”¨@Scheduledæ³¨è§£å®ç°å®šæ—¶ä»»åŠ¡ï¼Œä½¿ç”¨spring-data-redisæä¾›çš„APIå®ç°ç®€æ˜“çš„Redisåˆ†å¸ƒå¼é”çš„ä¼ªä»£ç å¦‚ä¸‹ï¼š 123456789101112// æ¯30åˆ†é’Ÿè·‘ä¸€æ¬¡@Scheduled(cron = \"* */30 * * * ? \")public void scheduledMethod()&#123; // åˆ¤æ–­KEYå­˜åœ¨æ€§å¹¶ä¸”è®¾ç½®KEYï¼Œå¸¦è¶…æ—¶æ—¶é—´5åˆ†é’Ÿ if (StringRedisTemplate#opsForValue()#hasKey(\"å®šæ—¶ä»»åŠ¡å”¯ä¸€å­—ç¬¦ä¸²æ ‡è¯†\"))&#123; StringRedisTemplate#opsForValue()#set(\"å®šæ—¶ä»»åŠ¡å”¯ä¸€å­—ç¬¦ä¸²æ ‡è¯†\", \"1[è¿™é‡Œæš‚æ—¶å¯ä»¥ä½¿ç”¨ä»»ä½•å€¼]\", 5 , TimeUnit.MINUTES); &#125; // è¿™é‡Œåšè°ƒåº¦æ­£å¸¸ä¸šåŠ¡é€»è¾‘ doBusiness(); // åˆ é™¤KEY StringRedisTemplate#opsForValue()#delete(\"å®šæ—¶ä»»åŠ¡å”¯ä¸€å­—ç¬¦ä¸²æ ‡è¯†\");&#125; ä¸Šé¢çš„ä»£ç å­˜åœ¨å¦‚ä¸‹æ˜¾ç„¶çš„ç¼ºé™·ï¼š å¦‚æœåº”ç”¨éƒ¨ç½²å¤šä¸ªèŠ‚ç‚¹ï¼Œç”±äºåˆ¤æ–­KEYçš„å­˜åœ¨æ€§å’ŒSETæ“ä½œæ˜¯ä¸¤ä¸ªæ“ä½œï¼ˆéåŸå­æ“ä½œï¼‰ï¼Œè¯¥å®šæ—¶ä»»åŠ¡æœ‰å¯èƒ½åœ¨åŒä¸€ä¸ªæ—¶åˆ»å¹¶å‘æ‰§è¡Œå¤šæ¬¡ã€‚ å¦‚æœä¸šåŠ¡é€»è¾‘æ‰§è¡Œæ–¹æ³•doBusiness()æŠ›å‡ºäº†å¼‚å¸¸ï¼Œä¼šå¯¼è‡´åˆ é™¤KEYçš„æ“ä½œæ— æ³•æ‰§è¡Œï¼ŒKEYä¼šåˆ°è¾¾è¶…æ—¶æ—¶é—´åè¢«åˆ é™¤ï¼Œè¿™ä¸ªæ—¶å€™ç›¸å½“äºåŠ é”æ—¶é—´é•¿è¾¾5åˆ†é’Ÿï¼Œæ˜¾ç„¶æ˜¯æ— æ³•æ¥å—çš„ã€‚ ä½†æ˜¯å®é™…ä¸Šï¼Œä»¥ä¸Šä¸¤ä¸ªé—®é¢˜åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å¹¶æ²¡æœ‰å‡ºç°è¿‡ï¼Œåˆ†æä¸€ä¸‹å…·ä½“åŸå› æ˜¯ï¼š å¯¹äºç¬¬1ç‚¹ï¼Œè¯¥åº”ç”¨åœ¨ç”Ÿäº§ç¯å¢ƒåªéƒ¨ç½²äº†2ä¸ªèŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹çš„é‡å¯æ—¶é—´å¹¶ä¸ç›¸åŒï¼Œæ‰€ä»¥ä»å¤©ç„¶ä¸Šé¿å…äº†é‡å¤æ‰§è¡Œçš„é—®é¢˜ï¼Œå¦‚æœCRONè¡¨è¾¾å¼è®¾è®¡ä¸º0 */30 * * * ? ï¼ˆ0ç§’å¼€å§‹æ¯30åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼‰å°±æœ‰å¯èƒ½å‡ºç°å¹¶å‘é—®é¢˜ã€‚ å¯¹äºç¬¬2ç‚¹ï¼Œå¼€å‘è€…åœ¨å¤„ç†ä¸šåŠ¡æ–¹æ³•é‡Œé¢å…¨å±€æ•è·å¼‚å¸¸å¹¶ä¸”æ²¡æœ‰å¤–æŠ›ï¼Œæ‰€ä»¥è°ƒåº¦æ–¹æ³•æ€»æ˜¯ä¼šæ‰§è¡Œåˆ°åˆ é™¤KEYçš„é€»è¾‘ã€‚ ä»¥ä¸Šä»…ä»…æ˜¯å·§åˆçš„æƒ…å†µä¸‹è§„é¿äº†é—®é¢˜å‡ºç°çš„å› å­ï¼Œä½†æ˜¯ä»ç¼–ç è§„èŒƒçš„è§’åº¦æ¥çœ‹æ˜¾ç„¶æ˜¯å­˜åœ¨é—®é¢˜ã€‚åŸºäºRediså®ç°çš„åˆ†å¸ƒå¼é”çš„æ–¹æ¡ˆåœ¨Rediså®˜æ–¹æ–‡æ¡£ä¸­æœ‰ä¸€ç¯‡æ–‡ç« åšäº†è¯¦ç»†çš„åˆ†æ-Distributed locks with Redisï¼Œå¯¹äºJavaè¯­è¨€æ¥è¯´ï¼Œæœ‰ç°æˆçš„ç±»åº“Redissonæä¾›å¯¹åº”çš„å®ç°ã€‚ä½†æ˜¯åœ¨è§£å†³è¿™ä¸ªé—®é¢˜çš„æ—¶å€™ï¼Œä¸ºäº†ç®€æ˜“èµ·è§å¹¶æ²¡æœ‰å¼•å…¥Redissonï¼Œè€Œæ˜¯æƒ³åŠæ³•é€šè¿‡åŸæ¥çš„SETå’ŒDELä¸¤ä¸ªæ“ä½œçš„ç›¸å…³æ€è·¯è¿›è¡Œä¼˜åŒ–ã€‚ SETå¤åˆå‘½ä»¤ è‡ªä»Redisçš„2.6.12ç‰ˆæœ¬èµ·ï¼ŒSETå‘½ä»¤å·²ç»æä¾›äº†å¯é€‰çš„å¤åˆæ“ä½œç¬¦ï¼š 1SET key value [expiration EX seconds|PX milliseconds] [NX|XX] æ—¶é—´å¤æ‚åº¦ï¼šO(1)ã€‚ å¯é€‰å‚æ•°ï¼š EXï¼šè®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œå•ä½æ˜¯ç§’ã€‚ PXï¼šè®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œå•ä½æ˜¯æ¯«ç§’ã€‚ NXï¼šIF NOT EXISTçš„ç¼©å†™ï¼Œåªæœ‰KEYä¸å­˜åœ¨çš„å‰æä¸‹æ‰ä¼šè®¾ç½®å€¼ã€‚ XXï¼šIF EXISTçš„ç¼©å†™ï¼Œåªæœ‰åœ¨KEYå­˜åœ¨çš„å‰æä¸‹æ‰ä¼šè®¾ç½®å€¼ã€‚ åˆ—ä¸¾ä¸€äº›ç­‰ä»·çš„å‘½ä»¤ï¼š åŸå§‹å‘½ä»¤ ç­‰ä»·å‘½ä»¤ SETEX KEY_1 1 SET KEY_1 EX 1 SETNX KEY_1 SET KEY_1 NX SETNX KEY_1 &amp;&amp; EXPIRE KEY_1 1 SET KEY_1 EX 1 NX SETNX KEY_1 &amp;&amp; PEXPIRE KEY_1 1000 SET KEY_1 PX 1000 NX å¯¹æ¯”ä¸€ä¸‹ï¼Œå‘ç°SETå¤åˆå‘½ä»¤ååˆ†ç®€ä¾¿ï¼Œå¯ä»¥æŠŠä¸¤ä¸ªå‘½ä»¤åˆå¹¶æˆä¸€ä¸ªåŸå­å‘½ä»¤ã€‚ä¸è¿‡æ³¨æ„ä¸€ä¸‹ï¼Œspring-data-redisé‡Œé¢çš„å°è£…åšå¾—ä¸å¤ªå¥½ï¼ŒValueOperationså¹¶æ²¡æœ‰æä¾›ç›¸å…³çš„æ–¹æ³•ï¼Œå› æ­¤æœ€å¥½è¿˜æ˜¯ä½¿ç”¨Redisçš„Javaå®¢æˆ·ç«¯Jedisã€‚ ç®€æ˜“çš„åˆ†å¸ƒå¼é”å®ç° å…¶å®å®˜æ–¹æ–‡æ¡£é‡Œé¢å·²ç»æœ‰å¾ˆè¯¦ç»†çš„Redisåˆ†å¸ƒå¼é”æ–¹æ¡ˆï¼ˆå°½ç®¡è¿™ä¸ªæ–¹æ¡ˆåœ¨æŸäº›è®ºæ–‡é‡Œé¢è¢«çƒ­çƒˆè®¨è®ºå®ƒå­˜åœ¨çš„é—®é¢˜ï¼Œä½†æ˜¯ç”Ÿäº§ä¸­å®ƒå·²ç»è¢«å¹¿æ³›ä½¿ç”¨ï¼‰ï¼Œè·å–é”çš„ä¼ªä»£ç å¦‚ä¸‹ï¼š 1SET RESOURCE_NAME RANDOM_VALUE NX PX 30000 é‡Šæ”¾é”çš„ä¼ªä»£ç ï¼ˆLuaè„šæœ¬ï¼‰å¦‚ä¸‹ï¼š 12345if redis.call(\"get\",KEYS[1]) == ARGV[1] then return redis.call(\"del\",KEYS[1])else return 0end æ”¹é€ å‰æ–‡ä¸­æåŠåˆ°çš„ä¾‹å­ï¼š 123456789101112131415// æ¯30åˆ†é’Ÿè·‘ä¸€æ¬¡@Scheduled(cron = \"* */30 * * * ? \")public void scheduledMethod()&#123; try (Jedis jedis = getJedis())&#123; SetParams params = new SetParams().ex(300).nx(); String code = jedis.set(\"å®šæ—¶ä»»åŠ¡å”¯ä¸€å­—ç¬¦ä¸²æ ‡è¯†\", \"1\", params); // åŠ é”æˆåŠŸ if (\"OK\".equals(code))&#123; // è¿™é‡Œåšè°ƒåº¦æ­£å¸¸ä¸šåŠ¡é€»è¾‘ doBusiness(); &#125; &#125;finally&#123; jedis.del(\"å®šæ—¶ä»»åŠ¡å”¯ä¸€å­—ç¬¦ä¸²æ ‡è¯†\"); &#125;&#125; è¿™é‡Œç›´æ¥åœ¨finallyä»£ç å—ä¸­è¿›è¡ŒKEYçš„åˆ é™¤ï¼Œå®é™…ä¸Šï¼Œæˆ‘ä»¬ä¸éœ€è¦å…³æ³¨è¿™ä¸ªåˆ é™¤åŠ¨ä½œæ˜¯å¦æˆåŠŸï¼ˆå‡å¦‚åœ¨æœ€åé˜¶æ®µåˆ é™¤KEYå‡ºç°RedisæœåŠ¡æ•…éšœï¼Œæ— è®ºä½¿ç”¨Luaè¿˜æ˜¯ç›´æ¥åˆ é™¤å¯¼è‡´çš„ç»“æœéƒ½æ˜¯ä¸€æ ·çš„ï¼‰ã€‚ä¸ºäº†é¿å…å¤šä½™çš„DELæ“ä½œï¼Œå¯ä»¥ç®€å•ä¼˜åŒ–ä¸ºï¼š 12345678910111213141516171819// æ¯30åˆ†é’Ÿè·‘ä¸€æ¬¡@Scheduled(cron = \"* */30 * * * ? \")public void scheduledMethod()&#123; boolean lock = false; try (Jedis jedis = getJedis())&#123; SetParams params = new SetParams().ex(300).nx(); String code = jedis.set(\"å®šæ—¶ä»»åŠ¡å”¯ä¸€å­—ç¬¦ä¸²æ ‡è¯†\", \"1\", params); // åŠ é”æˆåŠŸ if (\"OK\".equals(code))&#123; lock = true; // è¿™é‡Œåšè°ƒåº¦æ­£å¸¸ä¸šåŠ¡é€»è¾‘ doBusiness(); &#125; &#125;finally&#123; if (lock)&#123; jedis.del(\"å®šæ—¶ä»»åŠ¡å”¯ä¸€å­—ç¬¦ä¸²æ ‡è¯†\"); &#125; &#125;&#125; é€šè¿‡SET RESOURCE_NAME RANDOM_VALUE NX PX 30000å’ŒRediså•çº¿ç¨‹å¤„ç†çš„ç‰¹æ€§ï¼Œå°±èƒ½é¿å…å®šæ—¶ä»»åŠ¡é‡å¤æ‰§è¡Œã€‚å…¶å®è¿™é‡Œè¿˜å­˜åœ¨ä¸€äº›éšæ‚£ï¼š å¦‚æœä¸€ä¸ªçº¿ç¨‹åŠ é”æ—¶å€™æŒ‡å®šçš„è¶…æ—¶æ—¶é—´å¾ˆé•¿ï¼Œå¹¶ä¸”åœ¨è·‘åˆ°finallyä»£ç å—ä¹‹å‰ç”±äºä¸å¯æŠ—å› ç´ ï¼ˆä¾‹å¦‚å¾ˆå¤šäººå–œæ¬¢æåˆ°çš„æ–­ç”µï¼‰ä¸­æ–­å¯¼è‡´é”æ²¡æœ‰é‡Šæ”¾ï¼Œé‚£ä¹ˆè¿™ä¸ªé”å°±ç›¸å½“äºä¸€ä¸ªåƒµå°¸é”ã€‚ é”çš„æŒæœ‰å’Œé”çš„é‡Šæ”¾åº”è¯¥ç”±åŒä¸€ä¸ªæ“ä½œè€…è¿›è¡Œï¼Œå¦åˆ™æ“ä½œè€…Aè¿›è¡Œäº†åŠ é”ï¼Œå¦‚æœæœ‰æ¶æ„æ“ä½œè€…Bè¿›è¡Œè§£é”ï¼Œé‚£ä¹ˆä¼šå¯¼è‡´é”å¹¶ä¸å®‰å…¨ã€‚ ä¸Šé¢è¿™äº›éšæ‚£åœ¨Redissonä¸­éƒ½æœ‰å¯¹åº”çš„è§£å†³æ–¹æ¡ˆï¼Œè¿Ÿç‚¹åˆ†æä¸€ä¸‹Redissonçš„æºç å®ç°ã€‚ å°ç»“ æœ¬æ–‡åœ¨æ”¹é€ ä¸€ä¸ªè€ç³»ç»Ÿçš„æ—¶å€™å°è¯•ä½¿ç”¨æ”¹åŠ¨æœ€å°çš„æ–¹å¼è¿›è¡Œç®€æ˜“çš„åŸºäºRediså®ç°çš„åˆ†å¸ƒå¼é”ä¼˜åŒ–ï¼Œå®é™…ç”Ÿäº§ç¯å¢ƒä¸­åº”è¯¥å°½é‡ä½¿ç”¨ä¸»æµçš„å¯é çš„ç±»åº“ï¼Œå¦‚Redissonï¼ˆç¼–å†™æœ¬æ–‡çš„æ—¶å€™Githubçš„æ˜Ÿæ˜Ÿæ•°å·²ç»è¶…è¿‡10200ï¼Œæäº¤å’ŒIssueéƒ½æ¯”è¾ƒæ´»è·ƒï¼Œé‡åˆ°å‘äº†æ¯”è¾ƒå®¹æ˜“æ‰¾åˆ°è§£å†³æ–¹æ¡ˆï¼Œå€¼å¾—ä¿¡èµ–ï¼‰ã€‚å¦‚æœéœ€è¦é€ è½®å­ï¼Œé‚£ä¹ˆå°±éœ€è¦ç†Ÿç»ƒä½¿ç”¨ä¸­é—´ä»¶æä¾›çš„APIï¼ŒåŒæ—¶æ³¨æ„ä¸€ä¸‹ç¼–ç è§„èŒƒï¼Œå°½å¯èƒ½é¿å…å› ä¸ºè§„èŒƒå’Œä½¿ç”¨æ–¹å¼ä¸å½“å¸¦æ¥çš„é—®é¢˜ã€‚ é™„ä»¶ Markdownæ–‡ä»¶ï¼šhttps://github.com/zjcscut/blog-article-file/tree/master/20190815/middleware-redis-set-command-distributed-lock ï¼ˆæœ¬æ–‡å®Œ c-1-d e-a-20190815ï¼‰","categories":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/categories/Middleware/"},{"name":"Redis","slug":"Middleware/Redis","permalink":"http://throwable.club/blog/categories/Middleware/Redis/"}],"tags":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/tags/Middleware/"},{"name":"Redis","slug":"Redis","permalink":"http://throwable.club/blog/tags/Redis/"}]},{"title":"ä½¿ç”¨Redisçš„HSCANå‘½ä»¤é‡åˆ°çš„ä¸€ä¸ªé—®é¢˜","slug":"middleware-redis-hash-problem-first","date":"2019-08-12T13:59:52.000Z","updated":"2019-08-12T14:12:21.984Z","comments":true,"path":"2019/08/12/middleware-redis-hash-problem-first/","link":"","permalink":"http://throwable.club/2019/08/12/middleware-redis-hash-problem-first/","excerpt":"å‰æ ç¬”è€…æœ€è¿‘åœ¨åšä¸€ä¸ªé¡¹ç›®æ—¶å€™ä½¿ç”¨Rediså­˜æ”¾å®¢æˆ·ç«¯å±•ç¤ºçš„è®¢å•åˆ—è¡¨ï¼Œåˆ—è¡¨éœ€è¦è¿›è¡Œåˆ†é¡µã€‚ç”±äºç¬”è€…å…ˆå‰å¯¹Redisçš„å„ç§æ•°æ®ç±»å‹çš„ä½¿ç”¨åœºæ™¯å¹¶ä¸æ˜¯ååˆ†ç†Ÿæ‚‰ï¼Œäºæ˜¯å…ˆå…¥ä¸ºä¸»åœ°çœ‹åˆ°Hashç±»å‹ï¼š 123USER_ID:1 ORDER_ID:ORDER_XX: &#123;\"amount\": \"100\",\"orderId\":\"ORDER_XX\"&#125; ORDER_ID:ORDER_YY: &#123;\"amount\": \"200\",\"orderId\":\"ORDER_YY\"&#125; æ„Ÿè§‰Hashç±»å‹å®Œå…¨æ»¡è¶³éœ€æ±‚å®ç°çš„åœºæ™¯ã€‚ç„¶åæƒ³å½“ç„¶åœ°è€ƒè™‘ä½¿ç”¨HSCANå‘½ä»¤è¿›è¡Œåˆ†é¡µï¼Œå¼•å‘äº†åé¢é‡åˆ°çš„é—®é¢˜ã€‚","text":"å‰æ ç¬”è€…æœ€è¿‘åœ¨åšä¸€ä¸ªé¡¹ç›®æ—¶å€™ä½¿ç”¨Rediså­˜æ”¾å®¢æˆ·ç«¯å±•ç¤ºçš„è®¢å•åˆ—è¡¨ï¼Œåˆ—è¡¨éœ€è¦è¿›è¡Œåˆ†é¡µã€‚ç”±äºç¬”è€…å…ˆå‰å¯¹Redisçš„å„ç§æ•°æ®ç±»å‹çš„ä½¿ç”¨åœºæ™¯å¹¶ä¸æ˜¯ååˆ†ç†Ÿæ‚‰ï¼Œäºæ˜¯å…ˆå…¥ä¸ºä¸»åœ°çœ‹åˆ°Hashç±»å‹ï¼š 123USER_ID:1 ORDER_ID:ORDER_XX: &#123;\"amount\": \"100\",\"orderId\":\"ORDER_XX\"&#125; ORDER_ID:ORDER_YY: &#123;\"amount\": \"200\",\"orderId\":\"ORDER_YY\"&#125; æ„Ÿè§‰Hashç±»å‹å®Œå…¨æ»¡è¶³éœ€æ±‚å®ç°çš„åœºæ™¯ã€‚ç„¶åæƒ³å½“ç„¶åœ°è€ƒè™‘ä½¿ç”¨HSCANå‘½ä»¤è¿›è¡Œåˆ†é¡µï¼Œå¼•å‘äº†åé¢é‡åˆ°çš„é—®é¢˜ã€‚ SCANå’ŒHSCANå‘½ä»¤ SCANå‘½ä»¤å¦‚ä¸‹ï¼š 1234SCAN cursor [MATCH pattern] [COUNT count] [TYPE type]// è¿”å›å€¼å¦‚ä¸‹ï¼š// 1. cursorï¼Œæ•°å€¼ç±»å‹ï¼Œä¸‹ä¸€è½®çš„èµ·å§‹æ¸¸æ ‡å€¼ï¼Œ0ä»£è¡¨éå†ç»“æŸ// 2. éå†çš„ç»“æœé›†åˆï¼Œåˆ—è¡¨ SCANå‘½ä»¤åœ¨Redis2.8.0ç‰ˆæœ¬ä¸­æ–°å¢ï¼Œæ—¶é—´å¤æ‚åº¦è®¡ç®—å¦‚ä¸‹ï¼šæ¯ä¸€è½®éå†çš„æ—¶é—´å¤æ‚åº¦ä¸ºO(1)ï¼Œæ‰€æœ‰å…ƒç´ éå†å®Œæ¯•ç›´åˆ°æ¸¸æ ‡cursorè¿”å›0çš„æ—¶é—´å¤æ‚åº¦ä¸ºO(N)ï¼Œå…¶ä¸­Nä¸ºé›†åˆå†…å…ƒç´ çš„æ•°é‡ã€‚SCANæ˜¯é’ˆå¯¹æ•´ä¸ªDatabaseå†…çš„æ‰€æœ‰KEYè¿›è¡Œæ¸è¿›å¼çš„éå†ï¼Œå®ƒä¸ä¼šé˜»å¡Redisï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨SCANå‘½ä»¤éå†KEYçš„æ€§èƒ½ä¼šä¼˜äºKEY *å‘½ä»¤ã€‚å¯¹äºHashç±»å‹æœ‰ä¸€ä¸ªè¡ç”Ÿçš„å‘½ä»¤HSCANä¸“é—¨ç”¨äºéå†Hashç±»å‹åŠå…¶ç›¸å…³å±æ€§(Field)çš„å­—æ®µï¼š 1234HSCAN key cursor [MATCH pattern] [COUNT count]// è¿”å›å€¼å¦‚ä¸‹ï¼š// 1. cursorï¼Œæ•°å€¼ç±»å‹ï¼Œä¸‹ä¸€è½®çš„èµ·å§‹æ¸¸æ ‡å€¼ï¼Œ0ä»£è¡¨éå†ç»“æŸ// 2. éå†çš„ç»“æœé›†åˆï¼Œæ˜¯ä¸€ä¸ªæ˜ å°„ ç¬”è€…å½“æ—¶æ²¡æœ‰è¯¦ç»†æŸ¥é˜…Redisçš„å®˜æ–¹æ–‡æ¡£ï¼Œæƒ³å½“ç„¶åœ°è®¤ä¸ºHashç±»å‹çš„åˆ†é¡µç®€å•å¦‚ä¸‹ï¼ˆå‡è®¾æ¯é¡µæ•°æ®åªæœ‰1æ¡ï¼‰ï¼š 1234// ç¬¬ä¸€é¡µHSCAN USER_ID:1 0 COUNT 1 &lt;= è¿™é‡Œè®¤ä¸ºè¿”å›çš„æ¸¸æ ‡å€¼ä¸º1// ç¬¬äºŒé¡µHSCAN USER_ID:1 1 COUNT 1 &lt;= è¿™é‡Œè®¤ä¸ºè¿”å›çš„æ¸¸æ ‡å€¼ä¸º0ï¼Œç»“æŸè¿­ä»£ å®é™…ä¸Šï¼Œæ‰§è¡Œçš„ç»“æœå¦‚ä¸‹ï¼š 12345678HSCAN USER_ID:1 0 COUNT 1// ç»“æœ0 ORDER_ID:ORDER_XX &#123;\"amount\": \"100\",\"orderId\":\"ORDER_XX\"&#125; ORDER_ID:ORDER_YY &#123;\"amount\": \"200\",\"orderId\":\"ORDER_YY\"&#125; ä¹Ÿå°±æ˜¯åœ¨ç¬¬ä¸€è½®éå†çš„æ—¶å€™ï¼ŒKEYå¯¹åº”çš„æ‰€æœ‰Field-Valueå·²ç»å…¨é‡è¿”å›ã€‚ç¬”è€…å°è¯•å¢åŠ å“ˆå¸Œé›†åˆKEY = USER_ID:1é‡Œé¢çš„å…ƒç´ ï¼Œä½†æ˜¯æ•°æ®é‡ç›¸å¯¹è¾ƒå¤§çš„æ—¶å€™ï¼Œä¾ç„¶æ²¡æœ‰è¾¾åˆ°é¢„æœŸçš„åˆ†é¡µæ•ˆæœï¼›å¦ä¸€ä¸ªæ–¹é¢ï¼Œå°è¯•ä¿®æ”¹å‘½ä»¤ä¸­çš„COUNTå€¼ï¼Œå‘ç°æ— è®ºå¦‚ä½•ä¿®æ”¹COUNTå€¼éƒ½ä¸ä¼šå¯¹éå†çš„ç»“æœäº§ç”Ÿä»»ä½•å½±å“ï¼ˆä¹Ÿå°±æ˜¯è¿˜æ˜¯åœ¨ç¬¬ä¸€è½®è¿­ä»£è¿”å›å…¨éƒ¨ç»“æœï¼‰ã€‚ç™¾æ€ä¸å¾—å…¶è§£çš„æƒ…å†µä¸‹ï¼Œåªèƒ½ä»”ç»†ç¿»é˜…å®˜æ–¹æ–‡æ¡£å¯»æ‰¾è§£å†³æ–¹æ¡ˆã€‚åœ¨SCANå‘½ä»¤çš„COUNTå±æ€§æè¿°ä¸­æ‰¾åˆ°äº†åŸå› ï¼š ç®€å•ç¿»è¯‘ç†è§£ä¸€ä¸‹ï¼š SCANå‘½ä»¤ä»¥åŠå…¶è¡ç”Ÿå‘½ä»¤å¹¶ä¸ä¿è¯æ¯ä¸€è½®è¿­ä»£è¿”å›çš„å…ƒç´ æ•°é‡ï¼Œä½†æ˜¯å¯ä»¥ä½¿ç”¨COUNTå±æ€§å‡­ç»éªŒè°ƒæ•´SCANå‘½ä»¤çš„è¡Œä¸ºã€‚COUNTæŒ‡å®šæ¯æ¬¡è°ƒç”¨åº”è¯¥å®Œæˆéå†çš„å…ƒç´ çš„æ•°é‡ï¼Œä»¥ä¾¿äºéå†é›†åˆï¼Œæœ¬è´¨åªæ˜¯ä¸€ä¸ªæç¤ºå€¼ã€‚ COUNTé»˜è®¤å€¼ä¸º10ã€‚ å½“éå†çš„ç›®æ ‡Setã€Hashã€Sorted Setæˆ–è€…Keyç©ºé—´è¶³å¤Ÿå¤§å¯ä»¥ä½¿ç”¨ä¸€ä¸ªå“ˆå¸Œè¡¨è¡¨ç¤ºå¹¶ä¸”ä¸ä½¿ç”¨MATCHå±æ€§çš„å‰æä¸‹ï¼ŒRedisæœåŠ¡ç«¯ä¼šè¿”å›COUNTæˆ–è€…æ¯”COUNTå¤§çš„éå†å…ƒç´ ç»“æœé›†åˆã€‚ å½“éå†åªåŒ…å«Integerå€¼çš„Seté›†åˆï¼ˆä¹Ÿç§°ä¸ºintsetsï¼‰ï¼Œæˆ–è€…ziplistsç±»å‹ç¼–ç çš„Hashæˆ–è€…Sorted Seté›†åˆï¼ˆè¯´æ˜è¿™äº›é›†åˆé‡Œé¢çš„å…ƒç´ å ç”¨çš„ç©ºé—´è¶³å¤Ÿå°ï¼‰ï¼Œé‚£ä¹ˆSCANå‘½ä»¤ä¼šè¿”å›é›†åˆä¸­çš„æ‰€æœ‰å…ƒç´ ï¼Œç›´æ¥å¿½ç•¥COUNTå±æ€§ã€‚ æ³¨æ„ç¬¬3ç‚¹ï¼Œè¿™ä¸ªå°±æ˜¯åœ¨Hashé›†åˆä¸­ä½¿ç”¨HSCANå‘½ä»¤COUNTå±æ€§å¤±æ•ˆçš„æ ¹æœ¬åŸå› ã€‚Redisé…ç½®ä¸­æœ‰ä¸¤ä¸ªå’ŒHashç±»å‹ziplistç¼–ç çš„ç›¸å…³é…ç½®å€¼ï¼š 12hash-max-ziplist-entries 512hash-max-ziplist-value 64 åœ¨å¦‚ä¸‹ä¸¤ä¸ªæ¡ä»¶ä¹‹ä¸€æ»¡è¶³çš„æ—¶å€™ï¼ŒHashé›†åˆçš„ç¼–ç ä¼šç”±ziplistä¼šè½¬æˆdictï¼š å½“Hashé›†åˆä¸­çš„æ•°æ®é¡¹ï¼ˆå³Field-Valueå¯¹ï¼‰çš„æ•°ç›®è¶…è¿‡512çš„æ—¶å€™ã€‚ å½“Hashé›†åˆä¸­æ’å…¥çš„ä»»æ„ä¸€ä¸ªField-Valueå¯¹ä¸­çš„Valueé•¿åº¦è¶…è¿‡64ã€‚ å½“Hashé›†åˆçš„ç¼–ç ä¼šç”±ziplistä¼šè½¬æˆdictï¼ŒRedisä¸ºHashç±»å‹çš„å†…å­˜ç©ºé—´å ç”¨ä¼˜åŒ–ç›¸å½“äºå¤±è´¥äº†ï¼Œé™çº§ä¸ºç›¸å¯¹æ¶ˆè€—æ›´å¤šå†…å­˜çš„å­—å…¸ç±»å‹ç¼–ç ï¼Œè¿™ä¸ªæ—¶å€™ï¼ŒHSCANå‘½ä»¤COUNTå±æ€§æ‰ä¼šèµ·æ•ˆã€‚ æ¡ˆä¾‹éªŒè¯ ç®€å•éªŒè¯ä¸€ä¸‹ä¸Šä¸€èŠ‚å¾—å‡ºçš„ç»“è®ºï¼Œå†™å…¥ä¸€ä¸ªæµ‹è¯•æ•°æ®å¦‚ä¸‹ï¼š 1234// 70ä¸ªXHSET USER_ID:2 ORDER_ID:ORDER_XXX XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX // 70ä¸ªYHSET USER_ID:2 ORDER_ID:ORDER_YYY YYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYY æ¥ç€å¼€å§‹æµ‹è¯•ä¸€ä¸‹HSCANå‘½ä»¤ï¼š 1234567891011121314151617// æŸ¥çœ‹ç¼–ç object encoding USER_ID:2// ç¼–ç ç»“æœhashtable// ç¬¬ä¸€è½®è¿­ä»£HSCAN USER_ID:2 0 COUNT 1// ç¬¬ä¸€è½®è¿­ä»£è¿”å›ç»“æœ2 ORDER_ID:ORDER_YYY YYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYYY// ç¬¬äºŒè½®è¿­ä»£ HSCAN USER_ID:2 2 COUNT 10 ORDER_ID:ORDER_XXX XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX æµ‹è¯•æ¡ˆä¾‹ä¸­æ•…æ„è®©ä¸¤ä¸ªå€¼çš„é•¿åº¦ä¸º70ï¼Œå¤§äº64ï¼Œä¹Ÿå°±æ˜¯è®©Hashé›†åˆè½¬å˜ä¸ºdict(hashtable)ç±»å‹ï¼Œä½¿å¾—COUNTå±æ€§ç”Ÿæ•ˆã€‚ä½†æ˜¯ï¼Œè¿™ç§åšæ³•æ˜¯æ”¾å¼ƒäº†Redisä¸ºHashé›†åˆçš„å†…å­˜ä¼˜åŒ–ã€‚æ˜¾ç„¶ï¼ŒHSCANå‘½ä»¤å¤©ç„¶ä¸æ˜¯ä¸ºäº†åšæ•°æ®åˆ†é¡µè€Œè®¾è®¡çš„ï¼Œè€Œæ˜¯ä¸ºäº†æ¸è¿›å¼çš„è¿­ä»£ï¼ˆä¹Ÿå°±æ˜¯å¦‚æœéœ€è¦è¿­ä»£çš„é›†åˆå¾ˆå¤§ï¼Œä¹Ÿä¸ä¼šé˜»å¡RedisæœåŠ¡ï¼‰ã€‚æ‰€ä»¥ç¬”è€…æœ€åæ”¾å¼ƒäº†ä½¿ç”¨HSCANå‘½ä»¤ï¼Œå¯»æ‰¾æ›´é€‚åˆåšæ•°æ®åˆ†é¡µæŸ¥è¯¢çš„å…¶ä»–Rediså‘½ä»¤ã€‚ å°ç»“ é€šè¿‡è¿™ç®€å•çš„è¸©å‘æ¡ˆä¾‹ï¼Œç¬”è€…å¾—åˆ°ä¸€äº›ç»éªŒï¼š åˆ‡å¿Œå…ˆå…¥ä¸ºä¸»ï¼Œä½¿ç”¨ä¸­é—´ä»¶çš„æ—¶å€™è¦ç»“åˆå®é™…çš„åœºæ™¯ã€‚ ä½¿ç”¨å·¥å…·çš„ä¹‹å‰è¦ä»”ç»†é˜…è¯»å·¥å…·çš„ä½¿ç”¨æ‰‹å†Œã€‚ è¦é€šè¿‡ä¸€äº›æ¡ˆä¾‹éªŒè¯è‡ªå·±çš„çŒœæƒ³æˆ–è€…æ¨å¯¼çš„ç»“æœã€‚ Redisæä¾›çš„APIååˆ†ä¸°å¯Œï¼Œåé¢åº”è¯¥è¿˜ä¼šé‡åˆ°æ›´å¤šçš„è¸©å‘ç»éªŒã€‚ é™„ä»¶ Markdownæ–‡ä»¶ï¼šhttps://github.com/zjcscut/blog-article-file/tree/master/20190812/middleware-redis-hash-problem-first ï¼ˆæœ¬æ–‡å®Œ e-a-20190812 c-1-dï¼‰","categories":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/categories/Middleware/"},{"name":"Redis","slug":"Middleware/Redis","permalink":"http://throwable.club/blog/categories/Middleware/Redis/"}],"tags":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/tags/Middleware/"},{"name":"Redis","slug":"Redis","permalink":"http://throwable.club/blog/tags/Redis/"}]},{"title":"Javaå‡½æ•°å¼ç¼–ç¨‹ä¹‹Optional","slug":"java-functional-programming-optional","date":"2019-08-07T00:15:24.000Z","updated":"2019-08-11T15:22:56.528Z","comments":true,"path":"2019/08/07/java-functional-programming-optional/","link":"","permalink":"http://throwable.club/2019/08/07/java-functional-programming-optional/","excerpt":"å‰æ java.util.Optionalæ˜¯JDK8ä¸­å¼•å…¥çš„ç±»ï¼Œå®ƒæ˜¯JDKä»è‘—åçš„Javaå·¥å…·åŒ…Guavaä¸­ç§»æ¤è¿‡æ¥ã€‚æœ¬æ–‡ç¼–å†™çš„æ—¶å€™ä½¿ç”¨çš„æ˜¯JDK11ã€‚Optionalæ˜¯ä¸€ä¸ªåŒ…å«äº†NULLå€¼æˆ–è€…éNULLå€¼çš„å¯¹è±¡å®¹å™¨ï¼Œå®ƒå¸¸ç”¨ä½œæ˜ç¡®è¡¨æ˜æ²¡æœ‰ç»“æœï¼ˆå…¶å®æ˜ç¡®è¡¨æ˜å­˜åœ¨ç»“æœä¹Ÿå¯ä»¥ç”¨Optionalè¡¨ç¤ºï¼‰çš„æ–¹æ³•è¿”å›ç±»å‹ï¼Œè¿™æ ·å¯ä»¥é¿å…NULLå€¼å¸¦æ¥çš„å¯èƒ½çš„å¼‚å¸¸ï¼ˆä¸€èˆ¬æ˜¯NullPointerExceptionï¼‰ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ªæ–¹æ³•çš„è¿”å›å€¼ç±»å‹æ˜¯Optionalï¼Œåˆ™åº”è¯¥é¿å…è¿”å›NULLï¼Œè€Œåº”è¯¥è®©è¿”å›å€¼æŒ‡å‘ä¸€ä¸ªåŒ…å«NULLå¯¹è±¡çš„Optionalå®ä¾‹ã€‚Optionalçš„å‡ºç°ä¸ºNULLåˆ¤æ–­ã€è¿‡æ»¤æ“ä½œã€æ˜ å°„æ“ä½œç­‰æä¾›äº†å‡½æ•°å¼é€‚é…å…¥å£ï¼Œå®ƒç®—æ˜¯Javaå¼•å…¥å‡½æ•°å¼ç¼–ç¨‹çš„ä¸€ä¸ªé‡è¦çš„é‡Œç¨‹ç¢‘ã€‚ æœ¬æ–‡æ–°å¢ä¸€ä¸ªAsciidocçš„é¢„è§ˆæ¨¡å¼ï¼Œå¯ä»¥ä½“éªŒä¸€ä¸‹Springå®˜æ–¹æ–‡æ¡£çš„æ„Ÿè§‰ï¼š Github Pageï¼šhttp://www.throwable.club/adoc/20190807/java-functional-programming-optional Coding Pageï¼šhttp://throwable.coding.me/adoc/20190807/java-functional-programming-optional","text":"å‰æ java.util.Optionalæ˜¯JDK8ä¸­å¼•å…¥çš„ç±»ï¼Œå®ƒæ˜¯JDKä»è‘—åçš„Javaå·¥å…·åŒ…Guavaä¸­ç§»æ¤è¿‡æ¥ã€‚æœ¬æ–‡ç¼–å†™çš„æ—¶å€™ä½¿ç”¨çš„æ˜¯JDK11ã€‚Optionalæ˜¯ä¸€ä¸ªåŒ…å«äº†NULLå€¼æˆ–è€…éNULLå€¼çš„å¯¹è±¡å®¹å™¨ï¼Œå®ƒå¸¸ç”¨ä½œæ˜ç¡®è¡¨æ˜æ²¡æœ‰ç»“æœï¼ˆå…¶å®æ˜ç¡®è¡¨æ˜å­˜åœ¨ç»“æœä¹Ÿå¯ä»¥ç”¨Optionalè¡¨ç¤ºï¼‰çš„æ–¹æ³•è¿”å›ç±»å‹ï¼Œè¿™æ ·å¯ä»¥é¿å…NULLå€¼å¸¦æ¥çš„å¯èƒ½çš„å¼‚å¸¸ï¼ˆä¸€èˆ¬æ˜¯NullPointerExceptionï¼‰ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€ä¸ªæ–¹æ³•çš„è¿”å›å€¼ç±»å‹æ˜¯Optionalï¼Œåˆ™åº”è¯¥é¿å…è¿”å›NULLï¼Œè€Œåº”è¯¥è®©è¿”å›å€¼æŒ‡å‘ä¸€ä¸ªåŒ…å«NULLå¯¹è±¡çš„Optionalå®ä¾‹ã€‚Optionalçš„å‡ºç°ä¸ºNULLåˆ¤æ–­ã€è¿‡æ»¤æ“ä½œã€æ˜ å°„æ“ä½œç­‰æä¾›äº†å‡½æ•°å¼é€‚é…å…¥å£ï¼Œå®ƒç®—æ˜¯Javaå¼•å…¥å‡½æ•°å¼ç¼–ç¨‹çš„ä¸€ä¸ªé‡è¦çš„é‡Œç¨‹ç¢‘ã€‚ æœ¬æ–‡æ–°å¢ä¸€ä¸ªAsciidocçš„é¢„è§ˆæ¨¡å¼ï¼Œå¯ä»¥ä½“éªŒä¸€ä¸‹Springå®˜æ–¹æ–‡æ¡£çš„æ„Ÿè§‰ï¼š Github Pageï¼šhttp://www.throwable.club/adoc/20190807/java-functional-programming-optional Coding Pageï¼šhttp://throwable.coding.me/adoc/20190807/java-functional-programming-optional Optionalå„ä¸ªæ–¹æ³•æºç åˆ†æå’Œä½¿ç”¨åœºæ™¯ Optionalçš„æºç æ¯”è¾ƒç®€å•ï¼Œå½’æ ¹äºå®ƒæ˜¯ä¸€ä¸ªç®€å•çš„å¯¹è±¡å®¹å™¨ã€‚ä¸‹é¢ä¼šç»“åˆæºç åˆ†æå®ƒçš„æ‰€æœ‰æ„é€ ã€å±æ€§ã€æ–¹æ³•å’Œå¯¹åº”çš„ä½¿ç”¨åœºæ™¯ã€‚ Optionalå±æ€§å’Œæ„é€  Optionalçš„å±æ€§å’Œæ„é€ å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637public final class Optional&lt;T&gt; &#123; // è¿™ä¸ªæ˜¯é€šç”¨çš„ä»£è¡¨NULLå€¼çš„Optionalå®ä¾‹ private static final Optional&lt;?&gt; EMPTY = new Optional&lt;&gt;(); // æ³›å‹ç±»å‹çš„å¯¹è±¡å®ä¾‹ private final T value; // å®ä¾‹åŒ–Optionalï¼Œæ³¨æ„æ˜¯ç§æœ‰ä¿®é¥°ç¬¦ï¼Œvalueç½®ä¸ºNULL private Optional() &#123; this.value = null; &#125; // ç›´æ¥è¿”å›å†…éƒ¨çš„EMPTYå®ä¾‹ public static&lt;T&gt; Optional&lt;T&gt; empty() &#123; @SuppressWarnings(\"unchecked\") Optional&lt;T&gt; t = (Optional&lt;T&gt;) EMPTY; return t; &#125; // é€šè¿‡valueå®ä¾‹åŒ–Optionalï¼Œå¦‚æœvalueä¸ºNULLåˆ™æŠ›å‡ºNPE private Optional(T value) &#123; this.value = Objects.requireNonNull(value); &#125; // é€šè¿‡valueå®ä¾‹åŒ–Optionalï¼Œå¦‚æœvalueä¸ºNULLåˆ™æŠ›å‡ºNPEï¼Œå®é™…ä¸Šå°±æ˜¯ä½¿ç”¨Optional(T value) public static &lt;T&gt; Optional&lt;T&gt; of(T value) &#123; return new Optional&lt;&gt;(value); &#125; // å¦‚æœvalueä¸ºNULLåˆ™è¿”å›EMPTYå®ä¾‹ï¼Œå¦åˆ™è°ƒç”¨Optional#of(value) public static &lt;T&gt; Optional&lt;T&gt; ofNullable(T value) &#123; return value == null ? empty() : of(value); &#125; // æš‚æ—¶çœç•¥å…¶ä»–ä»£ç &#125; å¦‚æœæ˜ç¡®ä¸€ä¸ªå¯¹è±¡å®ä¾‹ä¸ä¸ºNULLçš„æ—¶å€™ï¼Œåº”è¯¥ä½¿ç”¨Optional#of()ï¼Œä¾‹å¦‚ï¼š 123Order o = selectByOrderId(orderId);assert null != oOptional op = Optional.of(o); å¦‚æœæ— æ³•æ˜ç¡®ä¸€ä¸ªå¯¹è±¡å®ä¾‹æ˜¯å¦ä¸ºNULLçš„æ—¶å€™ï¼Œåº”è¯¥ä½¿ç”¨Optional#ofNullable()ï¼Œä¾‹å¦‚ï¼š 1Optional op = Optional.ofNullable(selectByOrderId(orderId)); æ˜ç¡®è¡¨ç¤ºä¸€ä¸ªæŒæœ‰NULLå€¼çš„Optionalå®ä¾‹å¯ä»¥ä½¿ç”¨Optional.empty()ã€‚ get()æ–¹æ³• 1234567// å¦‚æœvalueä¸ºç©ºï¼Œåˆ™æŠ›å‡ºNPEï¼Œå¦åˆ™ç›´æ¥è¿”å›valuepublic T get() &#123; if (value == null) &#123; throw new NoSuchElementException(\"No value present\"); &#125; return value;&#125; get()æ–¹æ³•ä¸€èˆ¬æ˜¯éœ€è¦æ˜ç¡®valueä¸ä¸ºNULLçš„æ—¶å€™ä½¿ç”¨ï¼Œå®ƒåšäº†å…ˆéªŒvalueçš„å­˜åœ¨æ€§ã€‚ä¾‹å¦‚ï¼š 1234Order o = selectByOrderId(orderId);assert null != oOptional op = Optional.of(o);Order value = op.get(); isPresent()æ–¹æ³• 1234// åˆ¤æ–­valueæ˜¯å¦å­˜åœ¨ï¼Œä¸ä¸ºNULLåˆ™è¿”å›trueï¼Œå¦‚æœä¸ºNULLåˆ™è¿”å›falsepublic boolean isPresent() &#123; return value != null;&#125; ä¸¾ä¸ªä¾‹å­ï¼š 12Order o = selectByOrderId(orderId);boolean existed = Optional.ofNullable(o).isPresent(); isEmpty()æ–¹æ³• isEmpty()æ˜¯JDK11å¼•å…¥çš„æ–¹æ³•ï¼Œæ˜¯isPresent()çš„åå‘åˆ¤æ–­ï¼š 1234// åˆ¤æ–­valueæ˜¯å¦å­˜åœ¨ï¼Œä¸ºNULLåˆ™è¿”å›trueï¼Œä¸ºéNULLåˆ™è¿”å›falsepublic boolean isEmpty() &#123; return value == null;&#125; ifPresent()æ–¹æ³• ifPresent()æ–¹æ³•çš„ä½œç”¨æ˜¯ï¼šå¦‚æœvalueä¸ä¸ºNULLï¼Œåˆ™ä½¿ç”¨valueè°ƒç”¨æ¶ˆè´¹è€…å‡½æ•°å¼æ¥å£çš„æ¶ˆè´¹æ–¹æ³•Consumer#accept()ï¼š 12345public void ifPresent(Consumer&lt;? super T&gt; action) &#123; if (value != null) &#123; action.accept(value); &#125;&#125; ä¾‹å¦‚ï¼š 1Optional.ofNullable(selectByOrderId(orderId)).ifPresent(o-&gt; LOGGER.info(\"è®¢å•ID:&#123;&#125;\",o.getOrderId()); ifPresentOrElse()æ–¹æ³• ifPresentOrElse()æ–¹æ³•æ˜¯JDK9æ–°å¢çš„æ–¹æ³•ï¼Œå®ƒæ˜¯ifPresent()æ–¹æ³•çš„åŠ å¼ºç‰ˆï¼Œå¦‚æœvalueä¸ä¸ºNULLï¼Œåˆ™ä½¿ç”¨valueè°ƒç”¨æ¶ˆè´¹è€…å‡½æ•°å¼æ¥å£çš„æ¶ˆè´¹æ–¹æ³•Consumer#accept()ï¼Œå¦‚æœvalueä¸ºNULLåˆ™æ‰§è¡ŒRunnable#run()ï¼š 1234567public void ifPresentOrElse(Consumer&lt;? super T&gt; action, Runnable emptyAction) &#123; if (value != null) &#123; action.accept(value); &#125; else &#123; emptyAction.run(); &#125;&#125; ä¾‹å¦‚ï¼š 12String orderId = \"xxxx\"; Optional.ofNullable(selectByOrderId(orderId)).ifPresentOrElse(o-&gt; LOGGER.info(\"è®¢å•ID:&#123;&#125;\",o.getOrderId()), ()-&gt; LOGGER.info(\"è®¢å•&#123;&#125;ä¸å­˜åœ¨\",o.getOrderId())); filter()æ–¹æ³• 1234567891011public Optional&lt;T&gt; filter(Predicate&lt;? super T&gt; predicate) &#123; // åˆ¤æ–­predicateä¸èƒ½ä¸ºNULL Objects.requireNonNull(predicate); // valueä¸ºNULLï¼Œè¯´æ˜æ˜¯ç©ºå®ä¾‹ï¼Œåˆ™ç›´æ¥è¿”å›è‡ªèº« if (!isPresent()) &#123; return this; &#125; else &#123; // valueä¸ä¸ºNULLï¼Œåˆ™é€šè¿‡predicateåˆ¤æ–­ï¼Œå‘½ä¸­è¿”å›è‡ªèº«ï¼Œä¸å‘½ä¸­åˆ™è¿”å›ç©ºå®ä¾‹empty return predicate.test(value) ? this : empty(); &#125;&#125; è¿™ä¸ªæ–¹æ³•çš„åŠŸèƒ½æ˜¯ç®€å•çš„è¿‡æ»¤åŠŸèƒ½ï¼Œå®¹å™¨æŒæœ‰å¯¹è±¡valueéNULLä¼šåšä¸€æ¬¡åˆ¤æ–­ï¼Œå†³å®šè¿”å›è‡ªèº«å®ä¾‹è¿˜æ˜¯empty()ã€‚ä¾‹å¦‚ï¼š 1Optional.ofNullable(selectByOrderId(orderId)).filter(o -&gt; o.getStatus() == 1).ifPresent(o-&gt; LOGGER.info(\"è®¢å•&#123;&#125;çš„çŠ¶æ€ä¸º1\",o.getOrderId)); map()æ–¹æ³• map()æ˜¯ç®€å•çš„å€¼æ˜ å°„æ“ä½œï¼š 1234567891011public &lt;U&gt; Optional&lt;U&gt; map(Function&lt;? super T, ? extends U&gt; mapper) &#123; // åˆ¤æ–­mapperä¸èƒ½ä¸ºNULL Objects.requireNonNull(mapper); // valueä¸ºNULLï¼Œè¯´æ˜æ˜¯ç©ºå®ä¾‹ï¼Œåˆ™ç›´æ¥è¿”å›empty() if (!isPresent()) &#123; return empty(); &#125; else &#123; // valueä¸ä¸ºNULLï¼Œé€šè¿‡mapperè½¬æ¢ç±»å‹ï¼Œé‡æ–°å°è£…ä¸ºå¯ç©ºçš„Optionalå®ä¾‹ return Optional.ofNullable(mapper.apply(value)); &#125;&#125; APIæ³¨é‡Šé‡Œé¢çš„ä¸€ä¸ªä¾‹å­ï¼š 123List&lt;URI&gt; uris = ...;// æ‰¾åˆ°URIåˆ—è¡¨ä¸­æœªå¤„ç†çš„URIå¯¹åº”çš„è·¯å¾„Optional&lt;Path&gt; p = uris.stream().filter(uri -&gt; !isProcessedYet(uri)).findFirst().map(Paths::get); flatMap()æ–¹æ³• flatMap()æ–¹æ³•ä¹Ÿæ˜¯ä¸€ä¸ªæ˜ å°„æ“ä½œï¼Œä¸è¿‡æ˜ å°„çš„Optionalç±»å‹è¿”å›å€¼ç›´æ¥ç”±å¤–éƒ¨å†³å®šï¼Œä¸éœ€è¦é€šè¿‡å€¼é‡æ–°å°è£…ä¸ºOptionalå®ä¾‹ï¼š 12345678910111213public &lt;U&gt; Optional&lt;U&gt; flatMap(Function&lt;? super T, ? extends Optional&lt;? extends U&gt;&gt; mapper) &#123; // mapperå­˜åœ¨æ€§åˆ¤æ–­ Objects.requireNonNull(mapper); // valueä¸ºNULLï¼Œè¯´æ˜æ˜¯ç©ºå®ä¾‹ï¼Œåˆ™ç›´æ¥è¿”å›empty() if (!isPresent()) &#123; return empty(); &#125; else &#123; // valueä¸ä¸ºNULLï¼Œé€šè¿‡mapperè½¬æ¢ï¼Œç›´æ¥è¿”å›mapperçš„è¿”å›å€¼ï¼Œåšä¸€æ¬¡ç©ºåˆ¤æ–­ @SuppressWarnings(\"unchecked\") Optional&lt;U&gt; r = (Optional&lt;U&gt;) mapper.apply(value); return Objects.requireNonNull(r); &#125;&#125; ä¾‹å¦‚ï¼š 123456789class OptionalOrderFactory&#123; static Optional&lt;Order&gt; create(String id)&#123; //çœç•¥... &#125;&#125;String orderId = \"xxx\";Optional&lt;Order&gt; op = Optional.of(orderId).flatMap(id -&gt; OptionalOrderFactory.create(id)); or()æ–¹æ³• 12345678910111213public Optional&lt;T&gt; or(Supplier&lt;? extends Optional&lt;? extends T&gt;&gt; supplier) &#123; // supplierå­˜åœ¨æ€§åˆ¤æ–­ Objects.requireNonNull(supplier); // valueä¸ä¸ºNULLï¼Œåˆ™ç›´æ¥è¿”å›è‡ªèº« if (isPresent()) &#123; return this; &#125; else &#123; // valueä¸ºNULLï¼Œåˆ™è¿”å›supplieræä¾›çš„Optionalå®ä¾‹ï¼Œåšä¸€æ¬¡ç©ºåˆ¤æ–­ @SuppressWarnings(\"unchecked\") Optional&lt;T&gt; r = (Optional&lt;T&gt;) supplier.get(); return Objects.requireNonNull(r); &#125;&#125; ä¾‹å¦‚ï¼š 1234Order a = null;Order b = select();// æ‹¿åˆ°çš„å°±æ˜¯bè®¢å•å®ä¾‹åŒ…è£…çš„OptionalOptional&lt;Order&gt; op = Optional.ofNullable(a).or(b); stream()æ–¹æ³• 12345678// å¯¹valueåšNULLåˆ¤æ–­ï¼Œè½¬æ¢ä¸ºStreamç±»å‹public Stream&lt;T&gt; stream() &#123; if (!isPresent()) &#123; return Stream.empty(); &#125; else &#123; return Stream.of(value); &#125;&#125; orElse()æ–¹æ³• 1234// å€¼ä¸ä¸ºNULLåˆ™ç›´æ¥è¿”å›valueï¼Œå¦åˆ™è¿”å›otherpublic T orElse(T other) &#123; return value != null ? value : other;&#125; orElse()å°±æ˜¯å¸¸è§çš„æä¾›é»˜è®¤å€¼å…œåº•çš„æ–¹æ³•ï¼Œä¾‹å¦‚ï¼š 1234String v1 = null;String v2 = \"default\";// æ‹¿åˆ°çš„å°±æ˜¯v2å¯¹åº”çš„\"default\"å€¼String value = Optional.ofNullable(v1).orElse(v2); orElseGet()æ–¹æ³• 1234// å€¼ä¸ä¸ºNULLåˆ™ç›´æ¥è¿”å›valueï¼Œå¦åˆ™è¿”å›Supplier#get()public T orElseGet(Supplier&lt;? extends T&gt; supplier) &#123; return value != null ? value : supplier.get();&#125; orElseGet()åªæ˜¯orElse()æ–¹æ³•çš„å‡çº§ç‰ˆï¼Œä¾‹å¦‚ï¼š 1234String v1 = null;Supplier&lt;String&gt; v2 = () -&gt; \"default\";// æ‹¿åˆ°çš„å°±æ˜¯v2å¯¹åº”çš„\"default\"å€¼String value = Optional.ofNullable(v1).orElseGet(v2); orElseThrow()æ–¹æ³• 12345678910111213141516// å¦‚æœå€¼ä¸ºNULLï¼Œåˆ™æŠ›å‡ºNoSuchElementExceptionï¼Œå¦åˆ™ç›´æ¥è¿”å›valuepublic T orElseThrow() &#123; if (value == null) &#123; throw new NoSuchElementException(\"No value present\"); &#125; return value;&#125;// å¦‚æœå€¼ä¸ä¸ºNULLï¼Œåˆ™ç›´æ¥è¿”å›valueï¼Œå¦åˆ™è¿”å›Supplier#get()æä¾›çš„å¼‚å¸¸å®ä¾‹public &lt;X extends Throwable&gt; T orElseThrow(Supplier&lt;? extends X&gt; exceptionSupplier) throws X &#123; if (value != null) &#123; return value; &#125; else &#123; throw exceptionSupplier.get(); &#125;&#125; ä¾‹å¦‚ï¼š 1Optional.ofNullable(orderInfoVo.getAmount()).orElseThrow(()-&gt; new IllegalArgumentException(String.format(\"%sè®¢å•çš„amountä¸èƒ½ä¸ºNULL\",orderInfoVo.getOrderId()))); equals()å’ŒhashCode()æ–¹æ³• 12345678910111213141516public boolean equals(Object obj) &#123; if (this == obj) &#123; return true; &#125; if (!(obj instanceof Optional)) &#123; return false; &#125; Optional&lt;?&gt; other = (Optional&lt;?&gt;) obj; return Objects.equals(value, other.value);&#125;public int hashCode() &#123; return Objects.hashCode(value);&#125; è¿™ä¸¤ä¸ªæ–¹æ³•éƒ½æ˜¯æ¯”è¾ƒvalueï¼Œè¯´æ˜äº†Optionalå®ä¾‹å¦‚æœä½¿ç”¨äºHashMapçš„KEYï¼Œåªè¦valueç›¸åŒï¼Œå¯¹äºHashMapå°±æ˜¯åŒä¸€ä¸ªKEYã€‚å¦‚ï¼š 1234567Map&lt;Optional,Boolean&gt; map = new HashMap&lt;&gt;();Optional&lt;String&gt; op1 = Optional.of(\"throwable\");map.put(op1, true);Optional&lt;String&gt; op2 = Optional.of(\"throwable\");map.put(op2, false);// è¾“å‡ºfalseSystem.out.println(map.get(op1)); Optionalå®æˆ˜ ä¸‹é¢å±•ç¤ºä¸€ä¸‹Optionalçš„ä¸€äº›å¸¸è§çš„ä½¿ç”¨åœºæ™¯ã€‚ ç©ºåˆ¤æ–­ ç©ºåˆ¤æ–­ä¸»è¦æ˜¯ç”¨äºä¸çŸ¥é“å½“å‰å¯¹è±¡æ˜¯å¦ä¸ºNULLçš„æ—¶å€™ï¼Œéœ€è¦è®¾ç½®å¯¹è±¡çš„å±æ€§ã€‚ä¸ä½¿ç”¨Optionalæ—¶å€™çš„ä»£ç å¦‚ä¸‹ï¼š 123if(null != order)&#123; order.setAmount(orderInfoVo.getAmount());&#125; ä½¿ç”¨Optionalæ—¶å€™çš„ä»£ç å¦‚ä¸‹ï¼š 123456Optional.ofNullable(order).ifPresent(o -&gt; o.setAmount(orderInfoVo.getAmount()));// å¦‚æœåˆ¤æ–­ç©ºçš„å¯¹è±¡æ˜¯OrderInfoVoå¦‚ä¸‹Order o = select();OrderInfoVo vo = ...Optional.ofNullable(vo).ifPresent(v -&gt; o.setAmount(v.getAmount())); ä½¿ç”¨Optionalå®ç°ç©ºåˆ¤æ–­çš„å¥½å¤„æ˜¯åªæœ‰ä¸€ä¸ªå±æ€§è®¾å€¼çš„æ—¶å€™å¯ä»¥å‹ç¼©ä»£ç ä¸ºä¸€è¡Œï¼Œè¿™æ ·åšçš„è¯ï¼Œä»£ç ä¼šç›¸å¯¹ç®€æ´ã€‚ æ–­è¨€ åœ¨ç»´æŠ¤ä¸€äº›è€æ—§çš„ç³»ç»Ÿçš„æ—¶å€™ï¼Œå¾ˆå¤šæƒ…å†µä¸‹å¤–éƒ¨çš„ä¼ å‚æ²¡æœ‰åšç©ºåˆ¤æ–­ï¼Œå› æ­¤éœ€è¦å†™ä¸€äº›æ–­è¨€ä»£ç å¦‚ï¼š 123456if (null == orderInfoVo.getAmount())&#123; throw new IllegalArgumentException(String.format(\"%sè®¢å•çš„amountä¸èƒ½ä¸ºNULL\",orderInfoVo.getOrderId()));&#125;if (StringUtils.isBlank(orderInfoVo.getAddress())&#123; throw new IllegalArgumentException(String.format(\"%sè®¢å•çš„addressä¸èƒ½ä¸ºç©º\",orderInfoVo.getOrderId()));&#125; ä½¿ç”¨Optionalåçš„æ–­è¨€ä»£ç å¦‚ä¸‹ï¼š 12Optional.ofNullable(orderInfoVo.getAmount()).orElseThrow(()-&gt; new IllegalArgumentException(String.format(\"%sè®¢å•çš„amountä¸èƒ½ä¸ºNULL\",orderInfoVo.getOrderId())));Optional.ofNullable(orderInfoVo.getAddress()).orElseThrow(()-&gt; new IllegalArgumentException(String.format(\"%sè®¢å•çš„addressä¸èƒ½ä¸ºç©º\",orderInfoVo.getOrderId()))); ç»¼åˆä»¿çœŸæ¡ˆä¾‹ ä¸‹é¢æ˜¯ä¸€ä¸ªä»¿çœŸæ¡ˆä¾‹ï¼Œæ¨¡æ‹Ÿçš„æ­¥éª¤å¦‚ä¸‹ï¼š ç»™å‡ºå®¢æˆ·IDåˆ—è¡¨æŸ¥è¯¢å®¢æˆ·åˆ—è¡¨ã€‚ åŸºäºå­˜åœ¨çš„å®¢æˆ·åˆ—è¡¨ä¸­çš„å®¢æˆ·IDæŸ¥è¯¢è®¢å•åˆ—è¡¨ã€‚ åŸºäºè®¢å•åˆ—è¡¨è½¬æ¢ä¸ºè®¢å•DTOè§†å›¾åˆ—è¡¨ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546@Datastatic class Customer &#123; private Long id;&#125;@Datastatic class Order &#123; private Long id; private String orderId; private Long customerId;&#125;@Datastatic class OrderDto &#123; private String orderId;&#125;// æ¨¡æ‹Ÿå®¢æˆ·æŸ¥è¯¢private static List&lt;Customer&gt; selectCustomers(List&lt;Long&gt; ids) &#123; return null;&#125;// æ¨¡æ‹Ÿè®¢å•æŸ¥è¯¢private static List&lt;Order&gt; selectOrders(List&lt;Long&gt; customerIds) &#123; return null;&#125;// mainæ–¹æ³•public static void main(String[] args) throws Exception &#123; List&lt;Long&gt; ids = new ArrayList&lt;&gt;(); List&lt;OrderDto&gt; view = Optional.ofNullable(selectCustomers(ids)) .filter(cs -&gt; !cs.isEmpty()) .map(cs -&gt; selectOrders(cs.stream().map(Customer::getId).collect(Collectors.toList()))) .map(orders -&gt; &#123; List&lt;OrderDto&gt; dtoList = new ArrayList&lt;&gt;(); orders.forEach(o -&gt; &#123; OrderDto dto = new OrderDto(); dto.setOrderId(o.getOrderId()); dtoList.add(dto); &#125;); return dtoList; &#125;).orElse(Collections.emptyList());&#125; å°ç»“ Optionalæœ¬è´¨æ˜¯ä¸€ä¸ªå¯¹è±¡å®¹å™¨ï¼Œå®ƒçš„ç‰¹å¾å¦‚ä¸‹ï¼š Optionalä½œä¸ºä¸€ä¸ªå®¹å™¨æ‰¿è½½å¯¹è±¡ï¼Œæä¾›æ–¹æ³•é€‚é…éƒ¨åˆ†å‡½æ•°å¼æ¥å£ï¼Œç»“åˆéƒ¨åˆ†å‡½æ•°å¼æ¥å£æä¾›æ–¹æ³•å®ç°NULLåˆ¤æ–­ã€è¿‡æ»¤æ“ä½œã€å®‰å…¨å–å€¼ã€æ˜ å°„æ“ä½œç­‰ç­‰ã€‚ Optionalä¸€èˆ¬ä½¿ç”¨åœºæ™¯æ˜¯ç”¨äºæ–¹æ³•è¿”å›å€¼çš„åŒ…è£…ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ä½œä¸ºä¸´æ—¶å˜é‡ä»è€Œäº«å—å‡½æ•°å¼æ¥å£çš„ä¾¿æ·åŠŸèƒ½ã€‚ Optionalåªæ˜¯ä¸€ä¸ªç®€åŒ–æ“ä½œçš„å·¥å…·ï¼Œå¯ä»¥è§£å†³å¤šå±‚åµŒå¥—ä»£ç çš„èŠ‚ç‚¹ç©ºåˆ¤æ–­é—®é¢˜ï¼ˆä¾‹å¦‚ç®€åŒ–ç®­å¤´å‹ä»£ç ï¼‰ã€‚ Optionalå¹¶éé“¶å¼¹ã€‚ è¿™é‡Œæåˆ°ç®­å¤´å‹ä»£ç ï¼Œä¸‹é¢å°è¯•ç”¨å¸¸è§„æ–¹æ³•å’ŒOptionalåˆ†åˆ«è§£å†³ï¼š 12345678910111213141516171819202122232425262728// å‡è®¾VOæœ‰å¤šä¸ªå±‚çº§ï¼Œæ¯ä¸ªå±‚çº§éƒ½ä¸çŸ¥é“çˆ¶èŠ‚ç‚¹æ˜¯å¦ä¸ºNULLï¼Œå¦‚ä¸‹// - OrderInfoVo// - UserInfoVo// - AddressInfoVo// - address(å±æ€§)// å‡è®¾æˆ‘è¦ä¸ºaddresså±æ€§èµ‹å€¼ï¼Œé‚£ä¹ˆå°±ä¼šäº§ç”Ÿç®­å¤´å‹ä»£ç ã€‚// å¸¸è§„æ–¹æ³•String address = \"xxx\";OrderInfoVo o = ...;if(null != o)&#123; UserInfoVo uiv = o.getUserInfoVo(); if (null != uiv)&#123; AddressInfoVo aiv = uiv.getAddressInfoVo(); if (null != aiv)&#123; aiv.setAddress(address); &#125; &#125;&#125;// ä½¿ç”¨OptionalString address = \"xxx\";OrderInfoVo o = null;Optional.ofNullable(o) .map(OrderInfoVo::getUserInfoVo) .map(UserInfoVo::getAddressInfoVo) .ifPresent(a -&gt; a.setAddress(address)); ä½¿ç”¨Optionalè§£å†³ç®­å¤´å‹ä»£ç ï¼Œé€šè¿‡æ˜ å°„æ“ä½œmap()èƒ½å‡å°‘å¤§é‡çš„ifå’ŒNULLåˆ¤æ–­åˆ†æ”¯ï¼Œä½¿å¾—ä»£ç æ›´åŠ ç®€æ´ã€‚ æœ‰äº›å¼€å‘è€…æè®®æŠŠDAOæ–¹æ³•çš„è¿”å›å€¼ç±»å‹å®šä¹‰ä¸ºOptionalï¼Œç¬”è€…å¯¹æ­¤æŒä¸­ç«‹æ€åº¦ï¼ŒåŸå› æ˜¯ï¼š Optionalæ˜¯JDK1.8å¼•å…¥ï¼Œä½ç‰ˆæœ¬çš„JDKå¹¶ä¸èƒ½ä½¿ç”¨ï¼Œä¸æ˜¯æ‰€æœ‰çš„ç³»ç»Ÿéƒ½èƒ½å¹³æ»‘è¿ç§»åˆ°JDK1.8+ã€‚ å¹¶ä¸æ˜¯æ‰€æœ‰äººéƒ½çƒ­è¡·äºå‡½æ•°å¼ç¼–ç¨‹ï¼Œå› ä¸ºå®ƒå¸¦æ¥äº†ä¾¿æ·çš„åŒæ—¶è½¬å˜äº†ä»£ç çš„é˜…è¯»é€»è¾‘ï¼ˆæœ‰äº›äººç”šè‡³ä¼šè®¤ä¸ºé™ä½äº†ä»£ç çš„å¯è¯»æ€§ï¼‰ã€‚ é™„ä»¶ Github Pageï¼šhttp://www.throwable.club/2019/08/07/java-functional-programming-optional Coding Pageï¼šhttp://throwable.coding.me/2019/08/07/java-functional-programming-optional Markdownæˆ–Asciidocæ–‡ä»¶ï¼šhttps://github.com/zjcscut/blog-article-file/tree/master/20190807/java-functional-programming-optional ï¼ˆæœ¬æ–‡å®Œ c-2-d e-a-20190805 by throwableï¼‰","categories":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/categories/Java/"},{"name":"Functional Programming","slug":"Java/Functional-Programming","permalink":"http://throwable.club/blog/categories/Java/Functional-Programming/"}],"tags":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/tags/Java/"},{"name":"Optional","slug":"Optional","permalink":"http://throwable.club/blog/tags/Optional/"}]},{"title":"JUCçº¿ç¨‹æ± æœåŠ¡ExecutorServiceæ¥å£å®ç°æºç åˆ†æ","slug":"java-concurrency-executor-service","date":"2019-07-27T02:05:15.000Z","updated":"2019-07-27T02:10:11.616Z","comments":true,"path":"2019/07/27/java-concurrency-executor-service/","link":"","permalink":"http://throwable.club/2019/07/27/java-concurrency-executor-service/","excerpt":"å‰æ ä¹‹å‰çš„ä¸€ç¯‡æ–‡ç« JUCçº¿ç¨‹æ± ThreadPoolExecutoræºç åˆ†ææ·±å…¥åˆ†æäº†JUCçº¿ç¨‹æ± çš„æºç å®ç°ï¼Œç‰¹åˆ«å¯¹Executor#execute()æ¥å£çš„å®ç°åšäº†è¡Œçº§åˆ«çš„æºç åˆ†æã€‚è¿™ç¯‡æ–‡ç« ä¸»è¦åˆ†æä¸€ä¸‹çº¿ç¨‹æ± æ‰©å±•æœåŠ¡ExecutorServiceæ¥å£çš„å®ç°æºç ï¼ŒåŒæ—¶ä¼šé‡ç‚¹åˆ†æFutureçš„åº•å±‚å®ç°ã€‚ThreadPoolExecutorå’Œå…¶æŠ½è±¡çˆ¶ç±»AbstractExecutorServiceçš„æºç ä»JDK8åˆ°JDK11åŸºæœ¬æ²¡æœ‰å˜åŒ–ï¼Œæœ¬æ–‡ç¼–å†™çš„æ—¶å€™ä½¿ç”¨çš„æ˜¯JDK11ï¼Œç”±äºExecutorServiceæ¥å£çš„å®šä¹‰åœ¨JDK[8,11]éƒ½æ²¡æœ‰å˜åŒ–ï¼Œæœ¬æ–‡çš„åˆ†æé€‚ç”¨äºè¿™ä¸ªJDKç‰ˆæœ¬èŒƒå›´çš„ä»»æ„ç‰ˆæœ¬ã€‚æœ€è¿‘å°è¯•æ‰¾Hexoå¯ä»¥æ¸²æŸ“Asciidocçš„æ’ä»¶ï¼Œä½†æ˜¯æ²¡æœ‰æ‰¾åˆ°ï¼Œäºæ˜¯å°±å…ˆç§»æ¤äº†Asciidocä¸­çš„äº”ç§Tipã€‚","text":"å‰æ ä¹‹å‰çš„ä¸€ç¯‡æ–‡ç« JUCçº¿ç¨‹æ± ThreadPoolExecutoræºç åˆ†ææ·±å…¥åˆ†æäº†JUCçº¿ç¨‹æ± çš„æºç å®ç°ï¼Œç‰¹åˆ«å¯¹Executor#execute()æ¥å£çš„å®ç°åšäº†è¡Œçº§åˆ«çš„æºç åˆ†æã€‚è¿™ç¯‡æ–‡ç« ä¸»è¦åˆ†æä¸€ä¸‹çº¿ç¨‹æ± æ‰©å±•æœåŠ¡ExecutorServiceæ¥å£çš„å®ç°æºç ï¼ŒåŒæ—¶ä¼šé‡ç‚¹åˆ†æFutureçš„åº•å±‚å®ç°ã€‚ThreadPoolExecutorå’Œå…¶æŠ½è±¡çˆ¶ç±»AbstractExecutorServiceçš„æºç ä»JDK8åˆ°JDK11åŸºæœ¬æ²¡æœ‰å˜åŒ–ï¼Œæœ¬æ–‡ç¼–å†™çš„æ—¶å€™ä½¿ç”¨çš„æ˜¯JDK11ï¼Œç”±äºExecutorServiceæ¥å£çš„å®šä¹‰åœ¨JDK[8,11]éƒ½æ²¡æœ‰å˜åŒ–ï¼Œæœ¬æ–‡çš„åˆ†æé€‚ç”¨äºè¿™ä¸ªJDKç‰ˆæœ¬èŒƒå›´çš„ä»»æ„ç‰ˆæœ¬ã€‚æœ€è¿‘å°è¯•æ‰¾Hexoå¯ä»¥æ¸²æŸ“Asciidocçš„æ’ä»¶ï¼Œä½†æ˜¯æ²¡æœ‰æ‰¾åˆ°ï¼Œäºæ˜¯å°±å…ˆç§»æ¤äº†Asciidocä¸­çš„äº”ç§Tipã€‚ ExecutorServiceæ¥å£ç®€ä»‹ ExecutorServiceæ¥å£æ˜¯çº¿ç¨‹æ± æ‰©å±•åŠŸèƒ½æœåŠ¡æ¥å£ï¼Œå®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445public interface ExecutorService extends Executor &#123; // åœæ­¢çº¿ç¨‹æ±  void shutdown(); // ç«‹å³åœæ­¢çº¿ç¨‹æ± ï¼Œè¿”å›å°šæœªæ‰§è¡Œçš„ä»»åŠ¡åˆ—è¡¨ List&lt;Runnable&gt; shutdownNow(); // çº¿ç¨‹æ± æ˜¯å¦åœæ­¢ boolean isShutdown(); // çº¿ç¨‹æ± æ˜¯å¦ç»ˆç»“ boolean isTerminated(); // ç­‰å¾…çº¿ç¨‹æ± ç»ˆç»“ boolean awaitTermination(long timeout, TimeUnit unit) throws InterruptedException; // æäº¤Callableç±»å‹ä»»åŠ¡ &lt;T&gt; Future&lt;T&gt; submit(Callable&lt;T&gt; task); // æäº¤Runnableç±»å‹ä»»åŠ¡ï¼Œé¢„å…ˆçŸ¥é“è¿”å›å€¼ &lt;T&gt; Future&lt;T&gt; submit(Runnable task, T result); // æäº¤Runnableç±»å‹ä»»åŠ¡ï¼Œå¯¹è¿”å›å€¼æ— æ„ŸçŸ¥ Future&lt;?&gt; submit(Runnable task); // æ°¸ä¹…é˜»å¡ - æäº¤å’Œæ‰§è¡Œä¸€ä¸ªä»»åŠ¡åˆ—è¡¨çš„æ‰€æœ‰ä»»åŠ¡ &lt;T&gt; List&lt;Future&lt;T&gt;&gt; invokeAll(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks) throws InterruptedException; // å¸¦è¶…æ—¶é˜»å¡ - æäº¤å’Œæ‰§è¡Œä¸€ä¸ªä»»åŠ¡åˆ—è¡¨çš„æ‰€æœ‰ä»»åŠ¡ &lt;T&gt; List&lt;Future&lt;T&gt;&gt; invokeAll(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks, long timeout, TimeUnit unit) throws InterruptedException; // æ°¸ä¹…é˜»å¡ - æäº¤å’Œæ‰§è¡Œä¸€ä¸ªä»»åŠ¡åˆ—è¡¨çš„æŸä¸€ä¸ªä»»åŠ¡ &lt;T&gt; T invokeAny(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks) throws InterruptedException, ExecutionException; // å¸¦è¶…æ—¶é˜»å¡ - æäº¤å’Œæ‰§è¡Œä¸€ä¸ªä»»åŠ¡åˆ—è¡¨çš„æŸä¸€ä¸ªä»»åŠ¡ &lt;T&gt; T invokeAny(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks, long timeout, TimeUnit unit) throws InterruptedException, ExecutionException, TimeoutException;&#125; ExecutorServiceç»§æ‰¿è‡ªExecutorï¼Œä¸»è¦æä¾›äº†çº¿ç¨‹æ± çš„å…³é—­ã€çŠ¶æ€æŸ¥è¯¢æŸ¥è¯¢ã€å¯è·å–è¿”å›å€¼çš„ä»»åŠ¡æäº¤ã€æ•´ä¸ªä»»åŠ¡åˆ—è¡¨æˆ–è€…æ‰§è¡Œä»»åŠ¡åˆ—è¡¨ä¸­ä»»æ„ä¸€ä¸ªä»»åŠ¡ï¼ˆè¿”å›æ‰§è¡Œæœ€å¿«çš„ä»»åŠ¡çš„ç»“æœï¼‰ç­‰åŠŸèƒ½ã€‚ Futureå®ç°çš„é€šä¿—åŸç† ExecutorServiceæ¥å£çš„æ‰©å±•æ–¹æ³•éƒ½æ˜¯è¿”å›Futureç›¸å…³çš„å®ä¾‹ã€‚java.util.concurrent.Futureï¼ˆä¸­æ–‡ç¿»è¯‘å°±æ˜¯æœªæ¥ï¼Œè¿˜æ˜¯æŒºæœ‰æ„æ€çš„ï¼‰ï¼Œä»£è¡¨ç€ä¸€æ¬¡å¼‚æ­¥è®¡ç®—çš„ç»“æœï¼Œå®ƒæä¾›äº†æ£€æŸ¥è®¡ç®—æ˜¯å¦å·²ç»å®Œæˆã€ç­‰å¾…è®¡ç®—å®Œæˆã€è·å–è®¡ç®—ç»“æœç­‰ä¸€ç³»åˆ—æ–¹æ³•ã€‚ç¬”è€…ä¹‹å‰å¼ºè°ƒè¿‡ï¼šçº¿ç¨‹æ± ThreadPoolExecutorçš„é¡¶çº§æ¥å£Executoråªæä¾›äº†ä¸€ä¸ªæ— çŠ¶æ€çš„è¿”å›å€¼ç±»å‹ä¸ºvoidçš„execute(Runnable command)æ–¹æ³•ï¼Œæ— æ³•æ„ŸçŸ¥å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œçš„å®Œæˆæ—¶é—´å’Œè·å–ä»»åŠ¡è®¡ç®—ç»“æœã€‚å¦‚æœæˆ‘ä»¬éœ€è¦æ„ŸçŸ¥å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œçš„è¿”å›å€¼æˆ–è€…è®¡ç®—ç»“æœï¼Œå°±å¿…é¡»æä¾›å¸¦è¿”å›å€¼çš„æ¥å£æ–¹æ³•å»æ‰¿è½½è®¡ç®—ç»“æœçš„æ“ä½œã€‚è¿™äº›æ–¹æ³•ä¸Šä¸€èŠ‚å·²ç»ä»‹ç»è¿‡ï¼Œè€ŒFutureå°±æ˜¯ä¸€ä¸ªæ‹…ä»»äº†æ‰¿è½½è®¡ç®—ç»“æœï¼ˆåŒ…æ‹¬ç»“æœå€¼ã€çŠ¶æ€ã€é˜»å¡ç­‰å¾…è·å–ç»“æœæ“ä½œç­‰ï¼‰çš„å·¥å…·ã€‚è¿™é‡Œä¸¾ä¸€ä¸ªæ¨¡æ‹ŸFutureå®ç°è¿‡ç¨‹çš„ä¾‹å­ï¼Œä¾‹å­æ˜¯ä¼ªä»£ç å’ŒçœŸå®ä»£ç çš„æ··åˆå®ç°ï¼Œä¸éœ€è¦å¤ªè¾ƒçœŸã€‚ é¦–å…ˆï¼Œå‡è®¾æˆ‘ä»¬å®šä¹‰äº†ä¸€ä¸ªåŠ¨ä½œå‡½æ•°å¼æ¥å£Actionï¼š 12345// å¸¦æ³›å‹çš„åŠ¨ä½œæ¥å£ï¼Œå¯ä»¥è¿”å›ä¸€ä¸ªæ³›å‹ç»“æœpublic interface Action&lt;V&gt;&#123; V doAction();&#125; æˆ‘ä»¬å¯ä»¥å°è¯•å®ç°ä¸€ä¸‹Actionæ¥å£ï¼š 12345678910111213// å‡è®¾1ä¸ªåŠ¨ä½œåšçš„æ˜¯ä¸€ä¸ªååˆ†å¤æ‚çš„è¿ç®—ï¼Œè¿”å›ä¸€ä¸ªBigDecimalç±»å‹çš„ç»“æœAction&lt;BigDecimal&gt; action1 = () -&gt; &#123; // æ¨¡æ‹Ÿéšæœºè€—æ—¶ sleep(xç§’); return BigDecimal.valueOf(result);&#125;;// å‡è®¾1ä¸ªåŠ¨ä½œåšçš„æ˜¯åˆ¶ä½œä¸€ä¸ªé¢åŒ…çš„è¿‡ç¨‹ï¼Œè¿”å›ä¸€ä¸ªBreadé¢åŒ…å®ä¾‹Action&lt;Bread&gt; action2 = () -&gt; &#123; // æ¨¡æ‹Ÿéšæœºè€—æ—¶ sleep(xç§’); return new Bread();&#125;; ç”±äºActionæ²¡æœ‰å®ç°Runnableæ¥å£ï¼Œä¸Šé¢çš„ä¸¤ä¸ªåŠ¨ä½œæ— æ³•é€šè¿‡Executor#execute()æ–¹æ³•æäº¤å¼‚æ­¥ä»»åŠ¡ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æ·»åŠ ä¸€ä¸ªé€‚é…å™¨ActionAdapterï¼š 1234567891011121314151617public class ActionAdapter&lt;V&gt; implements Runnable &#123; private Action&lt;V&gt; action; private ActionAdapter(Action&lt;V&gt; action) &#123; this.action = action; &#125; public static &lt;V&gt; ActionAdapter&lt;V&gt; newActionAdapter(Action&lt;V&gt; action) &#123; return new ActionAdapter&lt;&gt;(action); &#125; @Override public void run() &#123; action.doAction(); &#125;&#125; è¿™é‡Œåªåšäº†ç®€å•ç²—æš´çš„é€‚é…ï¼Œè™½ç„¶å¯ä»¥æäº¤åˆ°çº¿ç¨‹æ± ä¸­æ‰§è¡Œï¼Œä½†æ˜¯åŠŸèƒ½å¤ªè¿‡ç®€é™‹ã€‚å¾ˆå¤šæ—¶å€™ï¼Œæˆ‘ä»¬è¿˜éœ€è¦æ·»åŠ ä»»åŠ¡æ‰§è¡ŒçŠ¶æ€åˆ¤æ–­å’Œè·å–ç»“æœçš„åŠŸèƒ½ï¼Œäºæ˜¯æ–°å¢ä¸€ä¸ªæ¥å£ActionFutureï¼š 123456public interface ActionFuture&lt;V&gt; extends Runnable&#123; V get() throws Exception; boolean isDone();&#125; ç„¶åActionAdapterå®ç°ActionFutureæ¥å£ï¼Œå†…éƒ¨æ·»åŠ ç®€å•çš„çŠ¶æ€æ§åˆ¶ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546public class ActionAdapter&lt;V&gt; implements Runnable, ActionFuture&lt;V&gt; &#123; private static final int NEW = 0; private static final int DONE = 1; private int state; private final Action&lt;V&gt; action; private Object result; private ActionAdapter(Action&lt;V&gt; action) &#123; this.action = action; this.state = NEW; &#125; public static &lt;V&gt; ActionAdapter&lt;V&gt; newActionAdapter(Action&lt;V&gt; action) &#123; return new ActionAdapter&lt;&gt;(action); &#125; @Override public void run() &#123; try &#123; result = action.doAction(); &#125; catch (Throwable e) &#123; result = e; &#125; finally &#123; state = DONE; &#125; &#125; @Override public V get() throws Exception&#123; while (state &lt; DONE)&#123; // è¿™ä¸ªç­‰å¾…æ–¹æ³•æ²¡æœ‰å®ç°ï¼Œåªæ˜¯è¡¨æ˜é€»è¾‘ currentThreadWaitForResult(); &#125; if (result instanceof Throwable)&#123; throw new ExecutionException((Throwable) result); &#125;else &#123; return (V) result; &#125; &#125; @Override public boolean isDone() &#123; return state == DONE; &#125;&#125; è¿™é‡Œæœ‰ä¸ªæŠ€å·§æ˜¯ç”¨Objectç±»å‹çš„å¯¹è±¡å­˜æ”¾Actionæ‰§è¡Œçš„ç»“æœæˆ–è€…æŠ›å‡ºçš„å¼‚å¸¸å®ä¾‹ï¼Œè¿™æ ·å¯ä»¥åœ¨ActionFuture#get()æ–¹æ³•ä¸­è¿›è¡Œåˆ¤æ–­å’Œå¤„ç†ã€‚æœ€åä¸€æ­¥ï¼Œä¾èµ–Executor#execute()æ–°å¢ä¸€ä¸ªæäº¤å¼‚æ­¥ä»»åŠ¡çš„æ–¹æ³•ï¼š 123456789101112131415161718192021222324252627282930public class ActionPool &#123; private final Executor executor; public ActionPool(Executor executor) &#123; this.executor = executor; &#125; public &lt;V&gt; ActionFuture&lt;V&gt; submit(Action&lt;V&gt; action) &#123; ActionFuture&lt;V&gt; actionFuture = ActionAdapter.newActionAdapter(action); executor.execute(actionFuture); return actionFuture; &#125; public static void main(String[] args) throws Exception&#123; ActionPool pool = new ActionPool(Executors.newSingleThreadExecutor()); Action&lt;BigDecimal&gt; action1 = () -&gt; &#123; // æ¨¡æ‹Ÿéšæœºè€—æ—¶ sleep(xç§’); return BigDecimal.valueOf(result); &#125;; pool.submit(action1); Action&lt;Bread&gt; action2 = () -&gt; &#123; // æ¨¡æ‹Ÿéšæœºè€—æ—¶ sleep(xç§’); return new Bread(); &#125;; pool.submit(action2); &#125;&#125; ä¸Šé¢ä¾‹å­æåˆ°çš„è™šæ‹Ÿæ ¸å¿ƒç»„ä»¶ï¼Œåœ¨JUCåŒ…ä¸­æœ‰å¯¹åº”çš„å®ç°ï¼ˆå½“æ—¶ï¼ŒJUCåŒ…å¯¹é€»è¾‘å’ŒçŠ¶æ€æ§åˆ¶ä¼šæ¯”è™šæ‹Ÿä¾‹å­æ›´åŠ ä¸¥è°¨ï¼‰ï¼Œå¯¹åº”å…³ç³»å¦‚ä¸‹ï¼š è™šæ‹Ÿç»„ä»¶ JUCä¸­çš„ç»„ä»¶ Action Callable ActionFuture RunnableFuture ActionAdapter FutureTask ActionPool ExecutorService(ThreadPoolExecutor) å…¶ä¸­å¤§éƒ¨åˆ†å®ç°é€»è¾‘éƒ½ç”±FutureTaskå’ŒThreadPoolExecutorçš„æŠ½è±¡çˆ¶ç±»AbstractExecutorServiceæ‰¿æ‹…ï¼Œä¸‹é¢ä¼šé‡ç‚¹åˆ†æè¿™ä¸¤ä¸ªç±»æ ¸å¿ƒåŠŸèƒ½çš„æºç å®ç°ã€‚ Tipå®é™…ä¸Šï¼ŒFutureçš„å®ç°ä½¿ç”¨çš„æ˜¯Promiseæ¨¡å¼ï¼Œå…·ä½“å¯ä»¥æŸ¥é˜…ç›¸å…³çš„èµ„æ–™ã€‚ FutureTaskæºç å®ç° æä¾›å›è°ƒçš„Runnableç±»å‹ä»»åŠ¡å®é™…æœ€ç»ˆéƒ½ä¼šåŒ…è£…ä¸ºFutureTaskå†æäº¤åˆ°çº¿ç¨‹æ± ä¸­æ‰§è¡Œï¼Œè€ŒFutureTaskæ˜¯Runnableã€Futureå’ŒCallableä¸‰è€…çš„æ¡¥æ¢ã€‚å…ˆçœ‹FutureTaskçš„ç±»ç»§æ‰¿å…³ç³»ï¼š åˆ©ç”¨æ¥å£å¯ä»¥å¤šç»§æ‰¿çš„ç‰¹æ€§ï¼ŒRunnableFutureæ¥å£ç»§æ‰¿è‡ªRunnableå’ŒFutureæ¥å£ï¼š 1234567891011121314151617181920212223242526272829public interface RunnableFuture&lt;V&gt; extends Runnable, Future&lt;V&gt; &#123; void run();&#125;@FunctionalInterfacepublic interface Runnable &#123; public abstract void run();&#125; public interface Future&lt;V&gt; &#123; // å–æ¶ˆï¼ŒmayInterruptIfRunningç”¨äºæ§åˆ¶æ˜¯å¦ä¸­æ–­ï¼Œå®é™…ä¸Šè¿™ä¸ªæ–¹æ³•å¹¶ä¸èƒ½ç»ˆæ­¢å·²ç»æäº¤çš„ä»»åŠ¡ï¼Œåé¢ä¼šè¯¦ç»†è¯´æ˜ boolean cancel(boolean mayInterruptIfRunning); // æ˜¯å¦å–æ¶ˆ boolean isCancelled(); // æ˜¯å¦å®Œæˆï¼ŒåŒ…æ‹¬æ­£å¸¸å’Œå¼‚å¸¸çš„æƒ…å†µ boolean isDone(); // æ°¸ä¹…é˜»å¡è·å–ç»“æœï¼Œå“åº”ä¸­æ–­ V get() throws InterruptedException, ExecutionException; // å¸¦è¶…æ—¶çš„é˜»å¡è·å–ç»“æœï¼Œå“åº”ä¸­æ–­ V get(long timeout, TimeUnit unit) throws InterruptedException, ExecutionException, TimeoutException;&#125; è€ŒFutureTaskå®ç°äº†RunnableFutureæ¥å£ï¼Œæœ¬è´¨å°±æ˜¯å®ç°Runnableå’ŒFutureæ¥å£çš„æ–¹æ³•ã€‚å…ˆçœ‹FutureTaskçš„é‡è¦å±æ€§ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748// çŠ¶æ€private volatile int state;// åˆå§‹åŒ–çŠ¶æ€private static final int NEW = 0;// å®Œæˆä¸­çŠ¶æ€private static final int COMPLETING = 1;// æ­£å¸¸æƒ…å†µä¸‹çš„å®ŒæˆçŠ¶æ€private static final int NORMAL = 2;// å¼‚å¸¸æƒ…å†µä¸‹çš„å®ŒæˆçŠ¶æ€private static final int EXCEPTIONAL = 3;// å–æ¶ˆçŠ¶æ€private static final int CANCELLED = 4;// ä¸­æ–­ä¸­çŠ¶æ€private static final int INTERRUPTING = 5;// å·²ä¸­æ–­çŠ¶æ€private static final int INTERRUPTED = 6;// åº•å±‚çš„Callableå®ç°ï¼Œæ‰§è¡Œå®Œæ¯•åéœ€è¦ç½®ä¸ºnullprivate Callable&lt;V&gt; callable;// è¾“å‡ºç»“æœï¼Œå¦‚æœæ˜¯æ­£å¸¸æ‰§è¡Œå®Œæˆï¼Œget()æ–¹æ³•ä¼šè¿”å›æ­¤ç»“æœï¼Œå¦‚æœæ˜¯å¼‚å¸¸æ‰§è¡Œå®Œæˆï¼Œget()æ–¹æ³•ä¼šæŠ›å‡ºoutcomeåŒ…è£…ä¸ºExecutionExceptionçš„å¼‚å¸¸private Object outcome; // çœŸæ­£çš„æ‰§è¡ŒCallableå¯¹è±¡çš„çº¿ç¨‹å®ä¾‹ï¼Œè¿è¡ŒæœŸé—´é€šè¿‡CASæ“ä½œæ­¤çº¿ç¨‹å®ä¾‹private volatile Thread runner;// ç­‰å¾…çº¿ç¨‹é›†åˆï¼ŒTreiber Stackå®ç°private volatile WaitNode waiters;// ä¸‹é¢æ˜¯å˜é‡å¥æŸ„ï¼Œåº•å±‚æ˜¯åŸºäºUnsafeå®ç°ï¼Œé€šè¿‡ç›¸å¯¹é¡¶å±‚çš„æ“ä½œåŸè¯­ï¼Œå¦‚CASç­‰private static final VarHandle STATE;private static final VarHandle RUNNER;private static final VarHandle WAITERS;static &#123; try &#123; MethodHandles.Lookup l = MethodHandles.lookup(); STATE = l.findVarHandle(FutureTask.class, \"state\", int.class); RUNNER = l.findVarHandle(FutureTask.class, \"runner\", Thread.class); WAITERS = l.findVarHandle(FutureTask.class, \"waiters\", WaitNode.class); &#125; catch (ReflectiveOperationException e) &#123; throw new ExceptionInInitializerError(e); &#125; // Reduce the risk of rare disastrous classloading in first call to // LockSupport.park: https://bugs.openjdk.java.net/browse/JDK-8074773 Class&lt;?&gt; ensureLoaded = LockSupport.class;&#125;// ... çœç•¥å…¶ä»–ä»£ç  ä¸Šé¢çš„ä¸»è¦å±æ€§ä¸­ï¼Œæœ‰ä¸¤ç‚¹æ¯”è¾ƒå¤æ‚ï¼Œä½†å´æ˜¯æœ€é‡è¦çš„ï¼š FutureTaskç”Ÿå‘½å‘¨æœŸçš„çŠ¶æ€ç®¡ç†æˆ–è€…è·ƒè¿ã€‚ ç­‰å¾…ï¼ˆè·å–ç»“æœï¼‰çº¿ç¨‹é›†åˆWaitNodeåŸºäºTreiber Stackå®ç°ï¼Œéœ€è¦å½»åº•å¼„æ¸…æ¥šTreiber Stackçš„å·¥ä½œåŸç†ã€‚ FutureTaskçš„çŠ¶æ€ç®¡ç† FutureTaskçš„å†…å»ºçŠ¶æ€åŒ…æ‹¬äº†ä¸ƒç§ï¼Œä¹Ÿå°±æ˜¯å±æ€§stateæœ‰ä¸ƒç§å¯é€‰çŠ¶æ€å€¼ï¼Œæ€»ç»“æˆè¡¨æ ¼å¦‚ä¸‹ï¼š çŠ¶æ€ çŠ¶æ€å€¼ æè¿° NEW 0 åˆå§‹åŒ–çŠ¶æ€ï¼ŒFutureTaskå®ä¾‹åˆ›å»ºæ—¶å€™åœ¨æ„é€ å‡½æ•°ä¸­æ ‡è®°ä¸ºæ­¤çŠ¶æ€ COMPLETING 1 å®Œæˆä¸­çŠ¶æ€ï¼Œè¿™ä¸ªæ˜¯ä¸­é—´çŠ¶æ€ï¼Œæ‰§è¡Œå®Œæˆåè®¾ç½®outcomeä¹‹å‰æ ‡è®°ä¸ºæ­¤çŠ¶æ€ NORMAL 2 æ­£å¸¸æ‰§è¡Œå®Œæˆï¼Œé€šè¿‡è°ƒç”¨get()æ–¹æ³•èƒ½å¤Ÿè·å–æ­£ç¡®çš„è®¡ç®—ç»“æœ EXCEPTIONAL 3 å¼‚å¸¸æ‰§è¡Œå®Œæˆï¼Œé€šè¿‡è°ƒç”¨get()æ–¹æ³•ä¼šæŠ›å‡ºåŒ…è£…åçš„ExecutionExceptionå¼‚å¸¸ CANCELLED 4 å–æ¶ˆçŠ¶æ€ INTERRUPTING 5 ä¸­æ–­ä¸­çŠ¶æ€ï¼Œæ‰§è¡Œçº¿ç¨‹å®ä¾‹Thread#interrupt()ä¹‹å‰ä¼šæ ‡è®°ä¸ºæ­¤çŠ¶æ€ INTERRUPTED 6 ä¸­æ–­å®ŒæˆçŠ¶æ€ è¿™äº›çŠ¶æ€ä¹‹é—´çš„è·ƒè¿æµç¨‹å›¾å¦‚ä¸‹ï¼š æ¯ä¸€ç§çŠ¶æ€è·ƒè¿éƒ½æ˜¯ç”±äºè°ƒç”¨æˆ–è€…è§¦å‘äº†æŸä¸ªæ–¹æ³•ï¼Œä¸‹æ–‡çš„ä¸€ä¸ªå°èŠ‚ä¼šåˆ†æè¿™äº›æ–¹æ³•çš„å®ç°ã€‚ ç­‰å¾…çº¿ç¨‹é›†åˆæ•°æ®ç»“æ„Treiber Stackçš„åŸç† Treiber Stackï¼Œä¸­æ–‡ç¿»è¯‘æ˜¯é©±åŠ¨æ ˆï¼Œå¬èµ·æ¥æ¯”è¾ƒæ€ªã€‚å®é™…ä¸Šï¼ŒTreiber Stackç®—æ³•æ˜¯R. Kent Treiberåœ¨å…¶1986å¹´çš„è®ºæ–‡Systems Programming: Coping with Parallelismä¸­é¦–æ¬¡æå‡ºï¼Œè¿™ç§ç®—æ³•æä¾›äº†ä¸€ç§å¯æ‰©å±•çš„æ— é”æ ˆï¼ŒåŸºäºç»†ç²’åº¦çš„å¹¶å‘åŸè¯­CAS(Compare And Swap)å®ç°ã€‚ç¬”è€…å¹¶æ²¡æœ‰èŠ±æ—¶é—´å»ç ”è¯»Treiberçš„è®ºæ–‡ï¼Œå› ä¸ºåœ¨Doug Leaå¤§ç¥å‚ä¸ç¼–å†™çš„ã€ŠJava Concurrency in Practiceï¼ˆJavaå¹¶å‘ç¼–ç¨‹å®æˆ˜ï¼‰ã€‹ä¸­çš„ç¬¬15.4.1å°èŠ‚ä¸­æœ‰ç®€å•åˆ†æéé˜»å¡ç®—æ³•ä¸­çš„éé˜»å¡æ ˆã€‚ åœ¨å®ç°ç›¸åŒåŠŸèƒ½çš„å‰æä¸‹ï¼Œéé˜»å¡ç®—æ³•é€šå¸¸æ¯”åŸºäºé”çš„ç®—æ³•æ›´åŠ å¤æ‚ã€‚åˆ›å»ºéé˜»å¡ç®—æ³•çš„å…³é”®åœ¨äºï¼Œæ‰¾å‡ºå¦‚ä½•å°†åŸå­ä¿®æ”¹çš„èŒƒå›´ç¼©å°åˆ°å•ä¸ªå˜é‡ä¸Šï¼ŒåŒæ—¶è¿˜è¦ç»´æŠ¤æ•°æ®çš„ä¸€è‡´æ€§ã€‚ä¸‹é¢çš„ConcurrentStackæ˜¯åŸºäºJavaè¯­è¨€å®ç°çš„Treiberç®—æ³•ï¼š 123456789101112131415161718192021222324252627282930313233343536public class ConcurrentStack&lt;E&gt; &#123; private AtomicReference&lt;Node&lt;E&gt;&gt; top = new AtomicReference&lt;&gt;(); public void push(E item) &#123; Node&lt;E&gt; newHead = new Node&lt;&gt;(item); Node&lt;E&gt; oldHead; do &#123; oldHead = top.get(); newHead.next = oldHead; &#125; while (!top.compareAndSet(oldHead, newHead)); &#125; public E pop() &#123; Node&lt;E&gt; oldHead; Node&lt;E&gt; newHead; do &#123; oldHead = top.get(); if (null == oldHead) &#123; return null; &#125; newHead = oldHead.next; &#125; while (!top.compareAndSet(oldHead, newHead)); return oldHead.item; &#125; private static class Node&lt;E&gt; &#123; final E item; Node&lt;E&gt; next; Node(E item) &#123; this.item = item; &#125; &#125;&#125; ConcurrentStackæ˜¯ä¸€ä¸ªæ ˆï¼Œå®ƒæ˜¯ç”±Nodeå…ƒç´ æ„æˆçš„ä¸€ä¸ªé“¾è¡¨ï¼Œå…¶ä¸­æ ˆé¡¶ä½œä¸ºæ ¹èŠ‚ç‚¹ï¼Œå¹¶ä¸”æ¯ä¸ªå…ƒç´ éƒ½åŒ…å«äº†ä¸€ä¸ªå€¼ä»¥åŠæŒ‡å‘ä¸‹ä¸€ä¸ªå…ƒç´ çš„é“¾æ¥ã€‚push()æ–¹æ³•åˆ›å»ºä¸€ä¸ªæ–°çš„èŠ‚ç‚¹ï¼Œè¯¥èŠ‚ç‚¹çš„nextåŸŸæŒ‡å‘äº†å½“å‰çš„æ ˆé¡¶ï¼Œç„¶åé€šè¿‡CASæŠŠè¿™ä¸ªæ–°èŠ‚ç‚¹æ”¾å…¥æ ˆé¡¶ã€‚å¦‚æœåœ¨å¼€å§‹æ’å…¥èŠ‚ç‚¹æ—¶ï¼Œä½äºæ ˆé¡¶çš„èŠ‚ç‚¹æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œé‚£ä¹ˆCASå°±ä¼šæˆåŠŸï¼Œå¦‚æœæ ˆé¡¶èŠ‚ç‚¹å‘ç”Ÿå˜åŒ–ï¼ˆä¾‹å¦‚ç”±äºå…¶ä»–çº¿ç¨‹åœ¨å½“å‰çº¿ç¨‹å¼€å§‹ä¹‹å‰æ’å…¥æˆ–è€…ç§»é™¤äº†å…ƒç´ ï¼‰ï¼Œé‚£ä¹ˆCASå°±ä¼šå¤±è´¥ï¼Œè€Œpush()æ–¹æ³•ä¼šæ ¹æ®æ ˆçš„å½“å‰çŠ¶æ€æ¥æ›´æ–°èŠ‚ç‚¹ï¼ˆå…¶å®å°±æ˜¯whileå¾ªç¯ä¼šè¿›å…¥ä¸‹ä¸€è½®ï¼‰ï¼Œå¹¶ä¸”å†æ¬¡å°è¯•ã€‚æ— è®ºå“ªç§æƒ…å†µï¼Œåœ¨CASæ‰§è¡Œå®Œæˆä¹‹åï¼Œæ ˆä»ç„¶å›å¤„äºä¸€è‡´çš„çŠ¶æ€ã€‚è¿™é‡Œé€šè¿‡ä¸€ä¸ªå›¾æ¥æ¨¡æ‹Ÿä¸€ä¸‹push()æ–¹æ³•çš„æµç¨‹ï¼š è€Œpop()æ–¹æ³•å¯ä»¥ç®€å•ç†è§£ä¸ºpush()æ–¹æ³•çš„é€†å‘æ“ä½œï¼Œå…·ä½“æµç¨‹æ˜¯ï¼š åˆ›å»ºä¸€ä¸ªå¼•ç”¨newHeadæŒ‡å‘å½“å‰topçš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯top.nextï¼Œtopæ‰€åœ¨å¼•ç”¨ç§°ä¸ºoldHeadã€‚ é€šè¿‡CASæ›´æ–°topçš„å€¼ï¼Œä¼ªä»£ç æ˜¯CAS(expect=oldHead,update=newHead)ï¼Œå¦‚æœæ›´æ–°æˆåŠŸï¼Œé‚£ä¹ˆtopå°±æŒ‡å‘top.nextï¼Œä¹Ÿå°±æ˜¯newHeadã€‚ Warningè¿™é‡Œå¯ä»¥çœ‹å‡ºTreiber Stackç®—æ³•æœ‰ä¸ªæ¯”è¾ƒå¤§çš„é—®é¢˜æ˜¯æœ‰å¯èƒ½äº§ç”Ÿæ— æ•ˆçš„èŠ‚ç‚¹ï¼Œæ‰€ä»¥FutureTaskä¹Ÿå­˜åœ¨å¯èƒ½äº§ç”Ÿæ— æ•ˆçš„ç­‰å¾…èŠ‚ç‚¹çš„é—®é¢˜ã€‚ FutureTaskæ–¹æ³•æºç åˆ†æ å…ˆçœ‹FutureTaskæä¾›çš„éé˜»å¡æ ˆèŠ‚ç‚¹çš„å®ç°ï¼š 12345678// ç­‰å¾…è·å–ç»“æœçš„çº¿ç¨‹èŠ‚ç‚¹ï¼ˆé›†åˆï¼‰ï¼Œå®é™…ä¸Šæ˜¯ä¸€ä¸ªå•é“¾è¡¨ï¼Œå®ç°äº†ä¸€ä¸ªéé˜»å¡æ ˆstatic final class WaitNode &#123; // è®°å½•ç­‰å¾…çº¿ç¨‹å®ä¾‹ volatile Thread thread; // æŒ‡å‘ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„å¼•ç”¨ volatile WaitNode next; WaitNode() &#123; thread = Thread.currentThread(); &#125;&#125; å’Œæˆ‘ä»¬ä¸Šé¢åˆ†æTreiber Stackæ—¶å€™ä½¿ç”¨çš„å•é“¾è¡¨å¦‚å‡ºä¸€è¾™ã€‚æ¥ç€çœ‹FutureTaskçš„æ„é€ å‡½æ•°ï¼š 12345678910111213141516171819202122232425262728293031323334353637// é€‚é…ä½¿ç”¨Callableç±»å‹ä»»åŠ¡çš„åœºæ™¯public FutureTask(Callable&lt;V&gt; callable) &#123; if (callable == null) throw new NullPointerException(); this.callable = callable; this.state = NEW; &#125;// é€‚é…ä½¿ç”¨Runnableç±»å‹ä»»åŠ¡å’Œå·²ç»æä¾›äº†æœ€ç»ˆè®¡ç®—ç»“æœçš„åœºæ™¯public FutureTask(Runnable runnable, V result) &#123; this.callable = Executors.callable(runnable, result); this.state = NEW; &#125;// Executorsä¸­public static &lt;T&gt; Callable&lt;T&gt; callable(Runnable task, T result) &#123; if (task == null) throw new NullPointerException(); return new RunnableAdapter&lt;T&gt;(task, result);&#125;// Runnableå’ŒCallableçš„é€‚é…å™¨ï¼Œè®¾è®¡ååˆ†å·§å¦™ï¼Œå®é™…ä¸Šrun()æ–¹æ³•å§”æ‰˜ç»™ä¼ å…¥çš„Runnableå®ä¾‹æ‰§è¡Œï¼Œå®ç°äº†Callableçš„call()æ–¹æ³•ï¼Œä½¿ç”¨çš„æ˜¯å¤–éƒ¨ä¼ å…¥çš„å€¼ä½œä¸ºè¿”å›ç»“æœprivate static final class RunnableAdapter&lt;T&gt; implements Callable&lt;T&gt; &#123; private final Runnable task; private final T result; RunnableAdapter(Runnable task, T result) &#123; this.task = task; this.result = result; &#125; public T call() &#123; task.run(); return result; &#125; public String toString() &#123; return super.toString() + \"[Wrapped task = \" + task + \"]\"; &#125;&#125; ä¸»è¦æ˜¯é’ˆå¯¹ä¸¤ç§ä¸åŒåœºæ™¯çš„ä»»åŠ¡ç±»å‹è¿›è¡Œé€‚é…ï¼Œæ„é€ å‡½æ•°ä¸­ç›´æ¥è®¾ç½®çŠ¶æ€state = NEW(0)ã€‚å› ä¸ºFutureTaskæ˜¯æœ€ç»ˆçš„ä»»åŠ¡åŒ…è£…ç±»ï¼Œå®ƒçš„æ ¸å¿ƒåŠŸèƒ½éƒ½åœ¨å…¶å®ç°çš„Runnable#run()æ–¹æ³•ä¸­ï¼Œè¿™é‡Œé‡ç‚¹åˆ†æä¸€ä¸‹run()æ–¹æ³•ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110// FutureTaskå®ç°çš„Runnable#run()æ–¹æ³•public void run() &#123; // å¦‚æœçŠ¶æ€ä¸ä¸ºNEW(0)æˆ–è€…CAS(null,å½“å‰çº¿ç¨‹å®ä¾‹)æ›´æ–°runner-çœŸæ­£çš„æ‰§è¡ŒCallableå¯¹è±¡çš„çº¿ç¨‹å®ä¾‹å¤±è´¥ï¼Œé‚£ä¹ˆç›´æ¥è¿”å›ï¼Œä¸æ‰§è¡Œä»»åŠ¡ if (state != NEW || !RUNNER.compareAndSet(this, null, Thread.currentThread())) return; try &#123; // è·å–Callableä»»åŠ¡å®ä¾‹èµ‹å€¼åˆ°ä¸´æ—¶å˜é‡c Callable&lt;V&gt; c = callable; // åˆ¤æ–­ä»»åŠ¡ä¸èƒ½ä¸ºç©ºï¼ŒäºŒæ¬¡æ ¡éªŒçŠ¶æ€å¿…é¡»ä¸ºNEW(0) if (c != null &amp;&amp; state == NEW) &#123; V result; boolean ran; try &#123; // è°ƒç”¨ä»»åŠ¡å®ä¾‹Callable#call()æ–¹æ³•ï¼Œæ­£å¸¸æƒ…å†µä¸‹çš„æ‰§è¡Œå®Œæ¯•ï¼Œæ²¡æœ‰æŠ›å‡ºå¼‚å¸¸ï¼Œåˆ™è®°å½•æ‰§è¡Œç»“æœ result = c.call(); // è®°å½•æ­£å¸¸æ‰§è¡Œå®Œæ¯• ran = true; &#125; catch (Throwable ex) &#123; // å¼‚å¸¸æƒ…å†µä¸‹çš„æ‰§è¡Œå®Œæ¯•ï¼Œæ‰§è¡Œç»“æœè®°å½•ä¸ºnull result = null; // è®°å½•å¼‚å¸¸æ‰§è¡Œå®Œæ¯• ran = false; // è®¾ç½®å¼‚å¸¸å®ä¾‹ setException(ex); &#125; // æ­£å¸¸æ‰§è¡Œå®Œæ¯•è®¾ç½®ç»“æœ if (ran) set(result); &#125; &#125; finally &#123; // runneræ›´æ–°ä¸ºnullï¼Œé˜²æ­¢å¹¶å‘æ‰§è¡Œrun()æ–¹æ³• runner = null; // è®°å½•æ–°çš„çŠ¶æ€å€¼ï¼Œå› ä¸ºrun()æ–¹æ³•æ‰§è¡Œçš„æ—¶å€™ï¼ŒçŠ¶æ€å€¼æœ‰å¯èƒ½è¢«å…¶ä»–æ–¹æ³•æ›´æ–°äº† int s = state; if (s &gt;= INTERRUPTING) // å¤„ç†run()æ–¹æ³•æ‰§è¡ŒæœŸé—´è°ƒç”¨äº†cancel(true)æ–¹æ³•çš„æƒ…å†µ handlePossibleCancellationInterrupt(s); &#125;&#125;// å¼‚å¸¸æ‰§è¡ŒæŒ–é¼»çš„æƒ…å†µä¸‹ï¼Œè®¾ç½®å¼‚å¸¸å®ä¾‹protected void setException(Throwable t) &#123; // CASæ›´æ–°çŠ¶æ€stateï¼Œç”±NEW(0)æ›´æ–°ä¸ºCOMPLETING(1) if (STATE.compareAndSet(this, NEW, COMPLETING)) &#123; // è®¾ç½®å¼‚å¸¸å®ä¾‹åˆ°outcomeå±æ€§ä¸­ outcome = t; // è®¾ç½®æœ€ç»ˆçŠ¶æ€state = EXCEPTIONAL(3)ï¼Œæ„å‘³ç€ä»»åŠ¡æœ€ç»ˆå¼‚å¸¸æ‰§è¡Œå®Œæ¯• STATE.setRelease(this, EXCEPTIONAL); // final state // å®Œæˆåçš„é€šçŸ¥æ–¹æ³• finishCompletion(); &#125;&#125;// å®Œæˆä»»åŠ¡åçš„é€šçŸ¥æ–¹æ³•ï¼Œæœ€è¦ä½œç”¨æ˜¯ç§»é™¤å’Œå”¤é†’æ‰€æœ‰çš„ç­‰å¾…ç»“æœçº¿ç¨‹ï¼Œè°ƒç”¨é’©å­æ–¹æ³•done()å’Œè®¾ç½®ä»»åŠ¡å®ä¾‹callableä¸ºnullprivate void finishCompletion() &#123; // éå†æ ˆï¼Œç»ˆæ­¢æ¡ä»¶æ˜¯ä¸‹ä¸€ä¸ªå…ƒç´ ä¸ºnull for (WaitNode q; (q = waiters) != null;) &#123; // CASè®¾ç½®æ ˆé¡¶ä¸ºnull if (WAITERS.weakCompareAndSet(this, q, null)) &#123; // éå†æ ˆä¸­çš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œå”¤é†’èŠ‚ç‚¹ä¸­çš„çº¿ç¨‹ï¼Œè¿™æ˜¯ä¸€ä¸ªååˆ†å¸¸è§„çš„éå†å•é“¾è¡¨çš„æ–¹æ³•ï¼Œæ³¨æ„å‡ ç‚¹ï¼š // 1. ä½¿ç”¨LockSupport.unpark()å”¤é†’çº¿ç¨‹ï¼Œå› ä¸ºåé¢ä¼šåˆ†æï¼Œçº¿ç¨‹é˜»å¡ç­‰å¾…çš„æ—¶å€™ä½¿ç”¨çš„æ˜¯LockSupport.park()æ–¹æ³• // 2. æ–­å¼€é“¾è¡¨èŠ‚ç‚¹çš„æ—¶å€™åç»§èŠ‚ç‚¹éœ€è¦ç½®ä¸ºnullï¼Œè¿™æ ·æ¸¸ç¦»èŠ‚ç‚¹æ‰èƒ½æ›´å®¹æ˜“è¢«JVMå›æ”¶ for (;;) &#123; Thread t = q.thread; if (t != null) &#123; q.thread = null; LockSupport.unpark(t); &#125; WaitNode next = q.next; if (next == null) break; q.next = null; q = next; &#125; break; &#125; &#125; // å›è°ƒé’©å­æ–¹æ³•done()ï¼Œè¿™ä¸ªå¯ä»¥é€šè¿‡å­ç±»è¿›è¡Œæ‰©å±• done(); // ç½®ä»»åŠ¡å®ä¾‹callableä¸ºnullï¼Œä»è€Œå‡å°‘JVM memory footprintï¼ˆè¿™ä¸ªä¸œè¥¿æœ‰å…´è¶£å¯ä»¥è‡ªè¡Œæ‰©å±•é˜…è¯»ï¼‰ callable = null; // to reduce footprint&#125;// æ­£å¸¸æ‰§è¡Œå®Œæ¯•çš„æƒ…å†µä¸‹è®¾ç½®æ‰§è¡Œç»“æœprotected void set(V v) &#123; // CASæ›´æ–°çŠ¶æ€stateï¼Œç”±NEW(0)æ›´æ–°ä¸ºCOMPLETING(1) if (STATE.compareAndSet(this, NEW, COMPLETING)) &#123; // æœ€ç»ˆæ‰§è¡Œç»“æœå€¼æ›´æ–°åˆ°outcomeä¸­ outcome = v; // è®¾ç½®æœ€ç»ˆçŠ¶æ€state = NORMAL(2)ï¼Œæ„å‘³ç€ä»»åŠ¡æœ€ç»ˆæ­£å¸¸æ‰§è¡Œå®Œæ¯• STATE.setRelease(this, NORMAL); // å®Œæˆåçš„é€šçŸ¥æ–¹æ³• finishCompletion(); &#125;&#125;// å¤„ç†run()æ–¹æ³•æ‰§è¡ŒæœŸé—´è°ƒç”¨äº†cancel(true)æ–¹æ³•çš„æƒ…å†µ// è¿™é‡Œè¿˜æ²¡åˆ†æcancel()æ–¹æ³•ï¼Œä½†æ˜¯å¯ä»¥æå‰å‘ŠçŸ¥ï¼šå®ƒä¼šå…ˆæŠŠçŠ¶æ€æ›´æ–°ä¸ºINTERRUPTINGï¼Œå†è¿›è¡Œçº¿ç¨‹ä¸­æ–­ï¼Œæœ€åæ›´æ–°çŠ¶æ€ä¸ºINTERRUPTED// æ‰€ä»¥å¦‚æœå‘ç°å½“å‰çŠ¶æ€ä¸ºINTERRUPTINGï¼Œå½“å‰çº¿ç¨‹éœ€è¦è®©å‡ºCPUæ§åˆ¶æƒç­‰å¾…åˆ°çŠ¶æ€æ›´å˜ä¸ºINTERRUPTEDå³å¯ï¼Œè¿™ä¸ªæ—¶é—´åº”è¯¥ååˆ†çŸ­æš‚private void handlePossibleCancellationInterrupt(int s) &#123; if (s == INTERRUPTING) while (state == INTERRUPTING) Thread.yield(); &#125;// é’©å­æ–¹æ³•ï¼Œå¯ä»¥é€šè¿‡å­ç±»æ‰©å±•æ­¤æ–¹æ³•ï¼Œæ–¹æ³•å›è°ƒçš„æ—¶æœºæ˜¯ä»»åŠ¡å·²ç»æ‰§è¡Œå®Œæ¯•ï¼Œé˜»å¡è·å–ç»“æœçš„çº¿ç¨‹è¢«å”¤é†’ä¹‹åprotected void done() &#123; &#125; run()æ–¹æ³•çš„æ‰§è¡Œæµç¨‹æ¯”è¾ƒç›´è§‚ï¼Œè¿™é‡Œæä¾›ä¸€ä¸ªç®€å•çš„æµç¨‹å›¾ï¼š FutureTaskè¿˜æä¾›äº†ä¸€ä¸ªèƒ½å¤Ÿé‡ç½®çŠ¶æ€ï¼ˆå‡†ç¡®æ¥è¯´æ˜¯ä¿æŒçŠ¶æ€ï¼‰çš„runAndReset()æ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•ä¸“é—¨æä¾›ç»™ScheduledThreadPoolExecutorä½¿ç”¨ï¼š 123456789101112131415161718192021222324252627282930// æ‰§è¡Œä»»åŠ¡å¹¶ä¸”é‡ç½®çŠ¶æ€// ç”±äºæ²¡æœ‰æ‰§è¡Œset()æ–¹æ³•è®¾ç½®æ‰§è¡Œç»“æœï¼Œè¿™ä¸ªæ–¹æ³•é™¤äº†æ‰§è¡Œè¿‡ç¨‹ä¸­æŠ›å‡ºå¼‚å¸¸æˆ–è€…ä¸»åŠ¨å–æ¶ˆä¼šåˆ°å¯¼è‡´stateç”±NEWæ›´å˜ä¸ºå…¶ä»–å€¼ï¼Œæ­£å¸¸æ‰§è¡Œå®Œæ¯•ä¸€ä¸ªä»»åŠ¡ä¹‹åï¼Œstateæ˜¯ä¿æŒä¸ºNEWä¸å˜protected boolean runAndReset() &#123; // å¦‚æœçŠ¶æ€ä¸ä¸ºNEW(0)æˆ–è€…CAS(null,å½“å‰çº¿ç¨‹å®ä¾‹)æ›´æ–°runner-çœŸæ­£çš„æ‰§è¡ŒCallableå¯¹è±¡çš„çº¿ç¨‹å®ä¾‹å¤±è´¥ï¼Œé‚£ä¹ˆç›´æ¥è¿”å›falseï¼Œä¸æ‰§è¡Œä»»åŠ¡ if (state != NEW || !RUNNER.compareAndSet(this, null, Thread.currentThread())) return false; boolean ran = false; int s = state; try &#123; Callable&lt;V&gt; c = callable; if (c != null &amp;&amp; s == NEW) &#123; try &#123; // è¿™é‡Œä¼šå¿½ç•¥æ‰§è¡Œç»“æœï¼Œåªè®°å½•æ˜¯å¦æ­£å¸¸æ‰§è¡Œ c.call(); ran = true; &#125; catch (Throwable ex) &#123; // è®°å½•æ‰§è¡Œå¼‚å¸¸ç»“æœ setException(ex); &#125; &#125; &#125; finally &#123; runner = null; s = state; if (s &gt;= INTERRUPTING) handlePossibleCancellationInterrupt(s); &#125; // æ­£å¸¸æƒ…å†µä¸‹çš„æ‰§è¡Œå®Œæ¯•ï¼Œranä¼šæ›´æ–°ä¸ºtrueï¼Œstateæ­¤æ—¶ä¹Ÿä¿æŒä¸ºNEWï¼Œè¿™ä¸ªæ—¶å€™æ–¹æ³•è¿”å›true return ran &amp;&amp; s == NEW;&#125; runAndReset()æ–¹æ³•ä¿è¯äº†åœ¨ä»»åŠ¡æ­£å¸¸æ‰§è¡Œå®Œæˆä¹‹åè¿”å›trueï¼Œæ­¤æ—¶FutureTaskçš„çŠ¶æ€stateä¿æŒä¸ºNEWï¼Œç”±äºæ²¡æœ‰è°ƒç”¨set()æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰è°ƒç”¨finishCompletion()æ–¹æ³•ï¼Œå®ƒå†…éƒ¨æŒæœ‰çš„Callableä»»åŠ¡å¼•ç”¨ä¸ä¼šç½®ä¸ºnullï¼Œç­‰å¾…è·å–ç»“æœçš„çº¿ç¨‹é›†åˆä¹Ÿä¸ä¼šè§£é™¤é˜»å¡ã€‚è¿™ç§è®¾è®¡æ–¹æ¡ˆä¸“é—¨é’ˆå¯¹å¯ä»¥å‘¨æœŸæ€§é‡å¤æ‰§è¡Œçš„ä»»åŠ¡ã€‚å¼‚å¸¸æ‰§è¡Œæƒ…å†µå’Œå–æ¶ˆçš„æƒ…å†µå¯¼è‡´çš„æœ€ç»ˆç»“æœå’Œrun()æ–¹æ³•æ˜¯ä¸€è‡´çš„ã€‚æ¥ä¸‹æ¥åˆ†æä¸€ä¸‹è·å–æ‰§è¡Œç»“æœçš„get()æ–¹æ³•ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137// è·å–æ‰§è¡Œç»“æœ - æ°¸ä¹…é˜»å¡public V get() throws InterruptedException, ExecutionException &#123; int s = state; // å¦‚æœçŠ¶æ€å°äºç­‰äºCOMPLETING(1)ï¼Œä¹Ÿå°±æ˜¯COMPLETING(1)å’ŒNEW(0)ï¼Œé‚£ä¹ˆå°±éœ€è¦ç­‰å¾…ä»»åŠ¡å®Œæˆ if (s &lt;= COMPLETING) // æ³¨æ„è¿™é‡Œè°ƒç”¨awaitDoneæ–¹æ³•çš„å‚æ•°ä¸ºæ°¸ä¹…é˜»å¡å‚æ•°ï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰è¶…æ—¶æœŸé™ï¼Œè¿”å›æœ€æ–°çš„çŠ¶æ€å€¼ s = awaitDone(false, 0L); // æ ¹æ®çŠ¶æ€å€¼æŠ¥å‘Šç»“æœ return report(s);&#125;// è·å–æ‰§è¡Œç»“æœ - å¸¦è¶…æ—¶çš„é˜»å¡public V get(long timeout, TimeUnit unit) throws InterruptedException, ExecutionException, TimeoutException &#123; if (unit == null) throw new NullPointerException(); int s = state; // å¦‚æœçŠ¶æ€å°äºç­‰äºCOMPLETING(1)ï¼Œä¹Ÿå°±æ˜¯COMPLETING(1)å’ŒNEW(0)ï¼Œé‚£ä¹ˆå°±éœ€è¦ç­‰å¾…ä»»åŠ¡å®Œæˆ // æ³¨æ„è¿™é‡Œè°ƒç”¨awaitDoneæ–¹æ³•çš„å‚æ•°ä¸ºå¸¦è¶…æ—¶ä¸Šé™çš„é˜»å¡å‚æ•° // å¦‚æœè¶…è¿‡äº†æŒ‡å®šçš„ç­‰å¾…æœŸé™ï¼ˆæ³¨æ„ä¼šæŠŠæ—¶é—´è½¬åŒ–ä¸ºçº³ç§’ï¼‰ï¼Œè¿”å›çš„æœ€æ–°çŠ¶æ€ä¾ç„¶ä¸ºCOMPLETING(1)æˆ–è€…NEW(0)ï¼Œé‚£ä¹ˆæŠ›å‡ºTimeoutExceptionå¼‚å¸¸ if (s &lt;= COMPLETING &amp;&amp; (s = awaitDone(true, unit.toNanos(timeout))) &lt;= COMPLETING) throw new TimeoutException(); // æ ¹æ®çŠ¶æ€å€¼æŠ¥å‘Šç»“æœ return report(s);&#125;// ç­‰å¾…ä»»åŠ¡å®Œæˆï¼ŒåŒºåˆ†æ°¸ä¹…é˜»å¡ç­‰å¾…å’Œå¸¦è¶…æ—¶ä¸Šé™çš„é˜»å¡ç­‰å¾…ä¸¤ç§åœºæ™¯private int awaitDone(boolean timed, long nanos) throws InterruptedException &#123; long startTime = 0L; WaitNode q = null; boolean queued = false; for (;;) &#123; int s = state; // å¦‚æœçŠ¶æ€å€¼å·²ç»å¤§äºCOMPLETING(1)ï¼Œè¯´æ˜ä»»åŠ¡å·²ç»æ‰§è¡Œå®Œæ¯•ï¼Œå¯ä»¥ç›´æ¥è¿”å›ï¼Œå¦‚æœç­‰å¾…èŠ‚ç‚¹å·²ç»åˆå§‹åŒ–ï¼Œåˆ™ç½®ç©ºå…¶çº¿ç¨‹å®ä¾‹å¼•ç”¨ï¼Œä¾¿äºGCå›æ”¶ if (s &gt; COMPLETING) &#123; if (q != null) q.thread = null; return s; &#125; else if (s == COMPLETING) // çŠ¶æ€å€¼ç­‰äºCOMPLETING(1)ï¼Œè¯´æ˜ä»»åŠ¡æ‰§è¡Œåˆ°è¾¾å°¾å£°ï¼Œåœ¨æ‰§è¡Œset()æˆ–è€…setException()ï¼Œåªéœ€è®©å‡ºCPUæ§åˆ¶æƒç­‰å¾…å®Œæˆå³å¯ç­‰å¾…ä¸‹ä¸€è½®å¾ªç¯é‡è¯•å³å¯ Thread.yield(); else if (Thread.interrupted()) &#123; // å¦‚æœçº¿ç¨‹è¢«ä¸­æ–­ï¼Œåˆ™æ¸…é™¤å…¶ä¸­æ–­çŠ¶æ€ï¼Œå¹¶ä¸”æ–­å¼€è¶…æ—¶æˆ–ä¸­æ–­çš„ç­‰å¾…èŠ‚ç‚¹çš„é“¾æ¥ removeWaiter(q); // æŠ›å‡ºInterruptedExceptionå¼‚å¸¸ throw new InterruptedException(); &#125; else if (q == null) &#123; // ç­‰å¾…èŠ‚ç‚¹å°šæœªåˆå§‹åŒ–ï¼Œå¦‚æœè®¾ç½®äº†è¶…æ—¶æœŸé™å¹¶ä¸”è¶…æ—¶æ—¶é—´å°äºç­‰äº0ï¼Œåˆ™ç›´æ¥è¿”å›çŠ¶æ€å¹¶ä¸”ç»ˆæ­¢ç­‰å¾…ï¼Œè¯´æ˜å·²ç»è¶…æ—¶äº† // è¿™é‡Œçš„é€»è¾‘å±äºå…ˆè¡Œæ ¡éªŒï¼Œå¦‚æœå‘½ä¸­äº†å°±ä¸ç”¨è¿›è¡Œè¶…æ—¶é˜»å¡ if (timed &amp;&amp; nanos &lt;= 0L) return s; // åˆå§‹åŒ–ç­‰å¾…èŠ‚ç‚¹ q = new WaitNode(); &#125; else if (!queued) //å¦‚æœç­‰å¾…èŠ‚ç‚¹å°šæœªåŠ å…¥åˆ°æ ˆä¸­ï¼Œåˆ™æŠŠå½“å‰çº¿ç¨‹æ‰€åœ¨çš„èŠ‚ç‚¹å‹å…¥æ ˆä¸­ï¼Œtopå¼•ç”¨æŒ‡å‘å½“å‰ç­‰å¾…èŠ‚ç‚¹ // è¿™é‡Œå°±æ˜¯Treiber Stackç®—æ³•çš„å…¥æ ˆæ“ä½œ queued = WAITERS.weakCompareAndSet(this, q.next = waiters, q); else if (timed) &#123; // è®¡ç®—å¼€å§‹æ—¶é—´ç­‰å¾…æ—¶é—´äºå½“å‰æ—¶é—´çš„ç›¸å·®å€¼ä½œä¸ºé˜»å¡çš„æ—¶é—´parkNanosï¼Œå› ä¸ºè¿™é‡Œæ¶‰åŠåˆ°å¾ªç¯ï¼ŒstartTimeå°±æ˜¯ç¬¬ä¸€è½®å¾ªç¯æ—¶å€™çš„å½“å‰ç³»ç»Ÿçº³ç§’ final long parkNanos; if (startTime == 0L) &#123; startTime = System.nanoTime(); if (startTime == 0L) startTime = 1L; parkNanos = nanos; &#125; else &#123; long elapsed = System.nanoTime() - startTime; if (elapsed &gt;= nanos) &#123; removeWaiter(q); return state; &#125; parkNanos = nanos - elapsed; &#125; // å¦‚æœçŠ¶æ€ä¸ºNEW(0)ï¼Œåˆ™è¿›è¡Œè¶…æ—¶é˜»å¡ï¼Œé˜»å¡çš„æ˜¯å½“å‰çš„çº¿ç¨‹ if (state &lt; COMPLETING) LockSupport.parkNanos(this, parkNanos); &#125; else // è¿™ç§å°±æ˜¯æœ€åä¸€ä¸ªifåˆ†æ”¯ï¼Œå°±æ˜¯ä¸å‘½ä¸­ä»»ä½•æ¡ä»¶çš„æ°¸ä¹…é˜»å¡ï¼Œé˜»å¡çš„æ˜¯å½“å‰çš„çº¿ç¨‹ LockSupport.park(this); &#125;&#125;// ç§»é™¤ç­‰å¾…èŠ‚ç‚¹ï¼Œè¿™ä¸ªæ–¹æ³•æœ‰ä¸¤æ¬¡ä½¿ç”¨çš„åœ°æ–¹ï¼š// 1. è·å–ç»“æœçš„çº¿ç¨‹è¿›è¡Œé˜»å¡ç­‰å¾…çš„æ—¶å€™è¢«ä¸­æ–­çš„åœºæ™¯ï¼ˆå¤„ç†ä¸­æ–­ï¼‰// 2. è·å–ç»“æœçš„çº¿ç¨‹é‡‡ç”¨å¸¦è¶…æ—¶çš„é˜»å¡ç­‰å¾…å¹¶ä¸”åœ¨è¿›è¡Œé˜»å¡ä¹‹å‰å·²ç»åˆ¤æ–­åˆ°è¶…æ—¶æ—¶é—´å·²ç»åˆ°æœŸï¼ˆå¤„ç†ä¸å°å¿ƒè¿›æ ˆçš„æ— æ•ˆèŠ‚ç‚¹ï¼‰// å®é™…ä¸Šï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯Treiber Stackç®—æ³•çš„å‡ºæ ˆæ“ä½œprivate void removeWaiter(WaitNode node) &#123; // åªæœ‰ç›®æ ‡ç­‰å¾…èŠ‚ç‚¹ä¸ç©ºæ—¶å€™æ‰å¤„ç† if (node != null) &#123; // ç›®æ ‡ç­‰å¾…èŠ‚ç‚¹çš„çº¿ç¨‹å¼•ç”¨ç½®ä¸ºç©º node.thread = null; // è¿™é‡Œå¾ªç¯æ ‡è®°ç”¨äºå› ä¸ºæ­¤æ–¹æ³•æ‰§è¡Œçš„ç«æ€æ¡ä»¶éœ€è¦é‡è¯•çš„èµ·ç‚¹ retry: for (;;) &#123; // éå†çš„ç»ˆæ­¢æ¡ä»¶ï¼šq != nullï¼Œç”±äºå˜åŒ–æ¡ä»¶æ˜¯q = sï¼Œå¹¶ä¸”æ¯è½®å¾ªç¯s = q.nextï¼Œå› æ­¤ç»ˆæ­¢æ¡ä»¶æ˜¯æ ˆèŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹nextä¸ºnull for (WaitNode pred = null, q = waiters, s; q != null; q = s) &#123; // ç¬¬ä¸€è½®å¾ªç¯ï¼Œqå…¶å®å°±æ˜¯æ ˆé¡¶èŠ‚ç‚¹ï¼Œæ ˆé¡¶èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ä¸ºsï¼Œè·å–è¯´qæ˜¯å½“å‰éœ€è¦å¤„ç†çš„èŠ‚ç‚¹ï¼Œsæ˜¯å…¶åç»§èŠ‚ç‚¹ s = q.next; // å¦‚æœå½“å‰èŠ‚ç‚¹æ—¶æœ‰æ•ˆï¼ˆæŒæœ‰çš„çº¿ç¨‹å¼•ç”¨éç©ºï¼‰çš„èŠ‚ç‚¹ï¼Œåˆ™å‰é©±èŠ‚ç‚¹predæ›´æ–°ä¸ºå½“å‰èŠ‚ç‚¹ï¼Œè¿›è¡Œä¸‹ä¸€è½®éå† if (q.thread != null) pred = q; // å¦‚æœå½“å‰èŠ‚ç‚¹å·²ç»æ— æ•ˆï¼Œå¹¶ä¸”å®ƒå­˜åœ¨å‰é©±èŠ‚ç‚¹ï¼Œé‚£ä¹ˆå‰é©±èŠ‚ç‚¹predçš„åç»§èŠ‚ç‚¹å¼•ç”¨è¿æ¥åˆ°å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹sï¼Œå®ç°å½“å‰èŠ‚ç‚¹çš„åˆ é™¤ // è¿™ä¸ªæ˜¯å•é“¾è¡¨åˆ é™¤ä¸­é—´æŸä¸€ä¸ªèŠ‚ç‚¹çš„å¸¸è§„æ“ä½œ else if (pred != null) &#123; pred.next = s; // å¦‚æœåœ¨å½“å‰èŠ‚ç‚¹å·²ç»æ— æ•ˆï¼Œå¹¶ä¸”å®ƒå­˜åœ¨å‰é©±èŠ‚ç‚¹ï¼Œä½†æ˜¯å‰é©±èŠ‚ç‚¹äºŒæ¬¡åˆ¤æ–­ä¸ºæ— æ•ˆï¼Œè¯´æ˜å‡ºç°äº†ç«æ€ï¼Œéœ€è¦é‡æ–°è¿›è¡Œæ ˆwaitersçš„éå† if (pred.thread == null) // check for race continue retry; &#125; // å½“å‰èŠ‚ç‚¹å·²ç»æ— æ•ˆï¼Œå®ƒä¸å­˜åœ¨å‰é©±èŠ‚ç‚¹ï¼Œåˆ™ç›´æ¥æŠŠå½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹sé€šè¿‡CASæ›´æ–°æ ˆé¡¶èŠ‚ç‚¹ // ç±»æ¯”å‰é¢åˆ†æè¿‡çš„ConcurrentStackçš„pop()æ–¹æ³•ï¼Œè¿™é‡Œçš„qå°±æ˜¯oldHeadï¼Œså°±æ˜¯newHeadã€‚ // CASæ›´æ–°å¤±è´¥è¯´æ˜å­˜åœ¨ç«æ€ï¼Œåˆ™éœ€è¦é‡æ–°è¿›è¡Œæ ˆwaitersçš„éå† else if (!WAITERS.compareAndSet(this, q, s)) continue retry; &#125; break; &#125; &#125;&#125;// æŠ¥å‘Šç»“æœçš„æ–¹æ³•ï¼Œå…¥å‚æ˜¯awaitDone()æ–¹æ³•è¿”å›çš„çŠ¶æ€å€¼private V report(int s) throws ExecutionException &#123; Object x = outcome; // å¦‚æœçŠ¶æ€å€¼ä¸ºNORMAL(2)æ­£å¸¸æ‰§è¡Œå®Œæ¯•ï¼Œåˆ™ç›´æ¥åŸºäºoutcomeå¼ºè½¬ä¸ºç›®æ ‡ç±»å‹å®ä¾‹ if (s == NORMAL) return (V)x; // å¦‚æœçŠ¶æ€å€¼å¤§äºç­‰äºCANCELLED(4)ï¼Œåˆ™æŠ›å‡ºCancellationExceptionå¼‚å¸¸ if (s &gt;= CANCELLED) throw new CancellationException(); // å…¶ä»–æƒ…å†µï¼Œå®é™…ä¸Šåªå‰©ä¸‹çŠ¶æ€å€¼ä¸ºEXCEPTIONAL(3)ï¼Œåˆ™åŸºäºoutcomeå¼ºè½¬ä¸ºThrowableç±»å‹ï¼Œåˆ™åŒ…è£…æˆExecutionExceptionæŠ›å‡º throw new ExecutionException((Throwable)x);&#125; ä¸Šé¢çš„æ–¹æ³•ä¸­ï¼ŒremoveWaiter()æ–¹æ³•ç›¸å¯¹å¤æ‚ï¼Œå®ƒæ¶‰åŠåˆ°å•é“¾è¡¨ç§»é™¤ä¸­é—´èŠ‚ç‚¹ã€è€ƒè™‘å¤šç§ç«æ€æƒ…å†µè¿›è¡Œé‡è¯•ç­‰è®¾è®¡ï¼Œéœ€è¦èŠ±å¤§é‡å¿ƒæ€å»ç†è§£ã€‚æ¥ç€çœ‹cancel()æ–¹æ³•ï¼š 123456789101112131415161718192021222324public boolean cancel(boolean mayInterruptIfRunning) &#123; // çŠ¶æ€å¿…é¡»ä¸ºNEW(0) // å¦‚æœmayInterruptIfRunningä¸ºtrueï¼Œåˆ™æŠŠçŠ¶æ€é€šè¿‡CASæ›´æ–°ä¸ºINTERRUPTING(5) // å¦‚æœmayInterruptIfRunningä¸ºfalseï¼Œåˆ™æŠŠçŠ¶æ€é€šè¿‡CASæ›´æ–°ä¸ºCANCELLED(4) // å¦‚æœçŠ¶æ€ä¸ä¸ºNEW(0)æˆ–è€…CASæ›´æ–°å¤±è´¥ï¼Œç›´æ¥è¿”å›falseï¼Œè¯´æ˜ä»»åŠ¡å·²ç»æ‰§è¡Œåˆ°set()æˆ–setException()ï¼Œæ— æ³•å–æ¶ˆ if (!(state == NEW &amp;&amp; STATE.compareAndSet(this, NEW, mayInterruptIfRunning ? INTERRUPTING : CANCELLED))) return false; try &#123; // mayInterruptIfRunningä¸ºtrueï¼Œè°ƒç”¨æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹å®ä¾‹çš„Thread#interrupt()è¿›è¡Œä¸­æ–­ï¼Œæ›´æ–°æœ€ç»ˆçŠ¶æ€ä¸ºINTERRUPTED(6) if (mayInterruptIfRunning) &#123; try &#123; Thread t = runner; if (t != null) t.interrupt(); &#125; finally &#123; // final state STATE.setRelease(this, INTERRUPTED); &#125; &#125; &#125; finally &#123; // å®Œæˆåçš„é€šçŸ¥æ–¹æ³• finishCompletion(); &#125; return true;&#125; cancel()æ–¹æ³•åªèƒ½å¤Ÿä¸­æ–­çŠ¶æ€ä¸ºNEW(0)çš„çº¿ç¨‹ï¼Œå¹¶ä¸”ç”±äºçº¿ç¨‹åªåœ¨æŸäº›ç‰¹æ®Šæƒ…å†µä¸‹ï¼ˆä¾‹å¦‚é˜»å¡åœ¨åŒæ­¥ä»£ç å—æˆ–è€…åŒæ­¥æ–¹æ³•ä¸­é˜»å¡åœ¨Object#wait()æ–¹æ³•ã€ä¸»åŠ¨åˆ¤æ–­çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€ç­‰ç­‰ï¼‰æ‰èƒ½å“åº”ä¸­æ–­ï¼Œæ‰€ä»¥éœ€è¦æ€è€ƒè¿™ä¸ªæ–¹æ³•æ˜¯å¦å¯ä»¥è¾¾åˆ°é¢„æƒ³çš„ç›®çš„ã€‚æœ€åçœ‹å‰©ä¸‹çš„çŠ¶æ€åˆ¤æ–­æ–¹æ³•ï¼š 123456789// åˆ¤æ–­æ˜¯å¦å–æ¶ˆçŠ¶æ€ï¼ŒåŒ…æ‹¬CANCELLED(4)ã€INTERRUPTING(5)ã€INTERRUPTED(6)ä¸‰ç§çŠ¶æ€public boolean isCancelled() &#123; return state &gt;= CANCELLED;&#125;// åˆ¤æ–­æ˜¯å¦å·²ç»å®Œæˆï¼Œè¿™é‡Œåªæ˜¯ç®€å•åˆ¤æ–­çŠ¶æ€å€¼ä¸ä¸ºNEW(0)ï¼ŒåŸå› æ˜¯æ‰€æœ‰çš„ä¸­é—´çŠ¶æ€éƒ½æ˜¯ååˆ†çŸ­æš‚çš„public boolean isDone() &#123; return state != NEW;&#125; AbstractExecutorServiceæºç å®ç° AbstractExecutorServiceè™½ç„¶åªæ˜¯ThreadPoolExecutorçš„æŠ½è±¡çˆ¶ç±»ï¼Œä½†æ˜¯å®ƒå·²ç»å®ç°äº†ExecutorServiceæ¥å£ä¸­é™¤äº†shutdown()ã€shutdownNow()ã€isShutdown()ã€isTerminated()å’ŒawaitTermination()äº”ä¸ªæ–¹æ³•ä¹‹å¤–çš„å…¶ä»–æ‰€æœ‰æ–¹æ³•ï¼ˆè¿™äº”ä¸ªæ–¹æ³•åœ¨ThreadPoolExecutorå®ç°ï¼Œå› ä¸ºå®ƒä»¬æ˜¯å’Œçº¿ç¨‹æ± çš„çŠ¶æ€ç›¸å…³çš„ï¼‰ã€‚å®ƒçš„æºç ä½“ç§¯æ¯”è¾ƒå°ï¼Œä¸‹é¢å…¨é‡è´´å‡ºåˆ†æï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213public abstract class AbstractExecutorService implements ExecutorService &#123; // é™æ€å·¥å‚æ–¹æ³•ï¼Œé€šè¿‡Runnableå’Œå…·ä½“çš„è¿”å›ç»“æœåˆ›å»ºFutureTaskå®ä¾‹ protected &lt;T&gt; RunnableFuture&lt;T&gt; newTaskFor(Runnable runnable, T value) &#123; return new FutureTask&lt;T&gt;(runnable, value); &#125; // é™æ€å·¥å‚æ–¹æ³•ï¼Œé€šè¿‡Callableå®ä¾‹åˆ›å»ºFutureTaskå®ä¾‹ protected &lt;T&gt; RunnableFuture&lt;T&gt; newTaskFor(Callable&lt;T&gt; callable) &#123; return new FutureTask&lt;T&gt;(callable); &#125; // æäº¤Runnableç±»å‹ä»»åŠ¡ public Future&lt;?&gt; submit(Runnable task) &#123; if (task == null) throw new NullPointerException(); // é€‚é…ä»»åŠ¡ä¸ºFutureTaskå®ä¾‹ï¼Œæ³¨æ„æœ€ç»ˆè®¡ç®—ç»“æœå·²ç»æå‰è®¾ç½®ä¸ºnull RunnableFuture&lt;Void&gt; ftask = newTaskFor(task, null); // æäº¤åˆ°çº¿ç¨‹æ±  execute(ftask); return ftask; &#125; // æäº¤Runnableç±»å‹ä»»åŠ¡ï¼ŒåŒæ—¶ä¼ å…¥æœ€ç»ˆè®¡ç®—ç»“æœ public &lt;T&gt; Future&lt;T&gt; submit(Runnable task, T result) &#123; if (task == null) throw new NullPointerException(); // é€‚é…ä»»åŠ¡ä¸ºFutureTaskå®ä¾‹ RunnableFuture&lt;T&gt; ftask = newTaskFor(task, result); // æäº¤åˆ°çº¿ç¨‹æ±  execute(ftask); return ftask; &#125; // æäº¤Callableç±»å‹ä»»åŠ¡ public &lt;T&gt; Future&lt;T&gt; submit(Callable&lt;T&gt; task) &#123; if (task == null) throw new NullPointerException(); // é€‚é…ä»»åŠ¡ä¸ºFutureTaskå®ä¾‹ RunnableFuture&lt;T&gt; ftask = newTaskFor(task); // æäº¤åˆ°çº¿ç¨‹æ±  execute(ftask); return ftask; &#125; // æ‰§è¡Œä»»åŠ¡åˆ—è¡¨ä¸­çš„ä»»æ„ä¸€ä¸ªä»»åŠ¡ï¼ˆå®é™…ä¸Šæœ‰å¯èƒ½ä¼šæ‰§è¡Œå¤šä¸ªä»»åŠ¡ï¼Œç¡®ä¿æœ€å…ˆå®Œæˆçš„ä»»åŠ¡å¯¹åº”çš„ç»“æœè¿”å›ï¼‰ private &lt;T&gt; T doInvokeAny(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks, boolean timed, long nanos) throws InterruptedException, ExecutionException, TimeoutException &#123; if (tasks == null) throw new NullPointerException(); int ntasks = tasks.size(); if (ntasks == 0) throw new IllegalArgumentException(); ArrayList&lt;Future&lt;T&gt;&gt; futures = new ArrayList&lt;&gt;(ntasks); // é€šè¿‡å½“å‰çš„çº¿ç¨‹æ± å®ä¾‹æ„å»ºExecutorCompletionServiceå®ä¾‹ ExecutorCompletionService&lt;T&gt; ecs = new ExecutorCompletionService&lt;T&gt;(this); try &#123; ExecutionException ee = null; // è®¡ç®—deadline final long deadline = timed ? System.nanoTime() + nanos : 0L; Iterator&lt;? extends Callable&lt;T&gt;&gt; it = tasks.iterator(); // æäº¤ä»»åŠ¡åˆ—è¡¨çš„ç¬¬ä¸€ä¸ªä»»åŠ¡å®ä¾‹ futures.add(ecs.submit(it.next())); --ntasks; int active = 1; for (;;) &#123; // è¿™é‡Œè·å–ä¸Šä¸€è½®ï¼ˆæˆ–è€…ç¬¬ä¸€ä¸ªä»»åŠ¡ï¼‰ä»»åŠ¡æ‰§è¡Œçš„Futureå®ä¾‹ Future&lt;T&gt; f = ecs.poll(); // å¦‚æœæ‹¿åˆ°Futureå®ä¾‹ä¸ºnullè¯´æ˜ä¸Šä¸€è½®çš„ä»»åŠ¡å°šæœªæ‰§è¡Œå®Œæ¯• if (f == null) &#123; // å¦‚æœä»»åŠ¡é˜Ÿåˆ—ä¸­è¿˜æœ‰ä»»åŠ¡ä»»åŠ¡ï¼Œåˆ™æ·»åŠ åˆ°çº¿ç¨‹æ± ä¸­æ‰§è¡Œ if (ntasks &gt; 0) &#123; --ntasks; futures.add(ecs.submit(it.next())); ++active; &#125; // æ´»è·ƒè®¡ç®—ä»»åŠ¡ä¸º0ï¼Œè¯´æ˜è‡³å°‘æœ‰ä¸€ä¸ªä»»åŠ¡æˆåŠŸè¿”å›äº†Futureå®ä¾‹ else if (active == 0) break; else if (timed) &#123; // å…è®¸è¶…æ—¶çš„æ¨¡å¼ä¸‹ç”¨è¶…æ—¶é˜»å¡è·å–Futureå®ä¾‹ f = ecs.poll(nanos, NANOSECONDS); if (f == null) throw new TimeoutException(); nanos = deadline - System.nanoTime(); &#125; // éè¶…æ—¶çš„æ¨¡å¼ä¸‹æ°¸ä¹…é˜»å¡è·å–Futureå®ä¾‹ else f = ecs.take(); &#125; // è·å–åˆ°çš„Futureå®ä¾‹ä¸ä¸ºnullï¼Œè¯´æ˜å·²ç»æœ‰è‡³å°‘ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæ¯• if (f != null) &#123; --active; try &#123; return f.get(); &#125; catch (ExecutionException eex) &#123; ee = eex; &#125; catch (RuntimeException rex) &#123; ee = new ExecutionException(rex); &#125; &#125; &#125; if (ee == null) ee = new ExecutionException(); throw ee; &#125; finally &#123; // å–æ¶ˆæ‰€æœ‰ä»»åŠ¡ï¼Œç¡®ä¿è‡³å°‘æœ‰ä¸€ä¸ªä»»åŠ¡å®Œæˆï¼Œå³ä½¿å–æ¶ˆæ‰€æœ‰ä»»åŠ¡ï¼Œç”±äºçŠ¶æ€ç®¡ç†ï¼ŒæˆåŠŸçš„ä»»åŠ¡ä¸å—å¹²æ‰° cancelAll(futures); &#125; &#125; // æ°¸ä¹…é˜»å¡ - æ‰§è¡Œä»»åŠ¡åˆ—è¡¨ä¸­çš„ä»»æ„ä¸€ä¸ªä»»åŠ¡ï¼ˆå®é™…ä¸Šæœ‰å¯èƒ½ä¼šæ‰§è¡Œå¤šä¸ªä»»åŠ¡ï¼Œç¡®ä¿æœ€å…ˆå®Œæˆçš„ä»»åŠ¡å¯¹åº”çš„ç»“æœè¿”å›ï¼‰ public &lt;T&gt; T invokeAny(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks) throws InterruptedException, ExecutionException &#123; try &#123; return doInvokeAny(tasks, false, 0); &#125; catch (TimeoutException cannotHappen) &#123; assert false; return null; &#125; &#125; // å¸¦è¶…æ—¶é˜»å¡ - æ‰§è¡Œä»»åŠ¡åˆ—è¡¨ä¸­çš„ä»»æ„ä¸€ä¸ªä»»åŠ¡ï¼ˆå®é™…ä¸Šæœ‰å¯èƒ½ä¼šæ‰§è¡Œå¤šä¸ªä»»åŠ¡ï¼Œç¡®ä¿æœ€å…ˆå®Œæˆçš„ä»»åŠ¡å¯¹åº”çš„ç»“æœè¿”å›ï¼‰ public &lt;T&gt; T invokeAny(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks, long timeout, TimeUnit unit) throws InterruptedException, ExecutionException, TimeoutException &#123; return doInvokeAny(tasks, true, unit.toNanos(timeout)); &#125; // æ°¸ä¹…é˜»å¡ - æ‰§è¡Œä»»åŠ¡åˆ—è¡¨ä¸­çš„æ‰€æœ‰ä»»åŠ¡ public &lt;T&gt; List&lt;Future&lt;T&gt;&gt; invokeAll(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks) throws InterruptedException &#123; if (tasks == null) throw new NullPointerException(); ArrayList&lt;Future&lt;T&gt;&gt; futures = new ArrayList&lt;&gt;(tasks.size()); try &#123; // éå†ä»»åŠ¡åˆ—è¡¨è¿›è¡ŒFutureTaskå¹¶ä¸”æäº¤åˆ°çº¿ç¨‹æ± ï¼ŒFutureTaskå®ä¾‹æ·»åŠ åˆ°futuresåˆ—è¡¨ä¸­ for (Callable&lt;T&gt; t : tasks) &#123; RunnableFuture&lt;T&gt; f = newTaskFor(t); futures.add(f); execute(f); &#125; // éå†futuresåˆ—è¡¨è°ƒç”¨get()æ–¹æ³•è·å–ç»“æœï¼Œæ³¨æ„ä¼šå¿½ç•¥æ‰€æœ‰çš„CancellationExceptionã€ExecutionException for (int i = 0, size = futures.size(); i &lt; size; i++) &#123; Future&lt;T&gt; f = futures.get(i); if (!f.isDone()) &#123; try &#123; f.get(); &#125; catch (CancellationException | ExecutionException ignore) &#123;&#125; &#125; &#125; return futures; &#125; catch (Throwable t) &#123; // åªè¦å‡ºç°éCancellationExceptionæˆ–è€…ExecutionExceptionå¼‚å¸¸ï¼Œåˆ™å–æ¶ˆæ‰€æœ‰ä»»åŠ¡ï¼Œå°šæœªæ‰§è¡Œæˆ–è€…å°šæœªæ‰§è¡Œå®Œæ¯•çš„ä»»åŠ¡æœ‰å¯èƒ½å—åˆ°å½±å“ cancelAll(futures); throw t; &#125; &#125; // å¸¦è¶…æ—¶é˜»å¡ - æ‰§è¡Œä»»åŠ¡åˆ—è¡¨ä¸­çš„æ‰€æœ‰ä»»åŠ¡ public &lt;T&gt; List&lt;Future&lt;T&gt;&gt; invokeAll(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks, long timeout, TimeUnit unit) throws InterruptedException &#123; if (tasks == null) throw new NullPointerException(); // è½¬æ¢è¶…æ—¶æ—¶é—´å•ä½ä¸ºçº³ç§’ final long nanos = unit.toNanos(timeout); // è®¡ç®—deadline final long deadline = System.nanoTime() + nanos; ArrayList&lt;Future&lt;T&gt;&gt; futures = new ArrayList&lt;&gt;(tasks.size()); int j = 0; timedOut: try &#123; // éå†ä»»åŠ¡åˆ—è¡¨è¿›è¡ŒFutureTaskï¼ŒFutureTaskå®ä¾‹æ·»åŠ åˆ°futuresåˆ—è¡¨ä¸­ for (Callable&lt;T&gt; t : tasks) futures.add(newTaskFor(t)); final int size = futures.size(); // éå†futuresåˆ—è¡¨ï¼Œè¿›è¡Œä¸€æ¬¡è¶…æ—¶å…ˆéªŒï¼Œå¦‚æœå·²ç»è¶…æ—¶ï¼Œåˆ™ç›´æ¥è·³å‡ºï¼Œæ— é¡»æ‰§è¡Œä»»åŠ¡ for (int i = 0; i &lt; size; i++) &#123; // è¿™é‡Œæœ‰ä¸ªç‰¹æ®Šå¤„ç†ï¼Œç¬¬ä¸€ä¸ªä»»åŠ¡åªè¦timeoutä¸ä¸º0ï¼Œå¿…å®šä¼šè¿›è¡Œæäº¤ç¬¬äºŒä¸ªä»»åŠ¡èµ·æ‰åˆ¤æ–­deadline if (((i == 0) ? nanos : deadline - System.nanoTime()) &lt;= 0L) break timedOut; // æäº¤FutureTaskåˆ°çº¿ç¨‹æ±  execute((Runnable)futures.get(i)); &#125; // jè®°å½•äº†è¶…æ—¶çš„é‚£ä¸ªä»»åŠ¡çš„Futureçš„ç´¢å¼•å€¼ï¼Œéå†futuresåˆ—è¡¨è¿›è¡Œè¶…æ—¶é˜»å¡çš„get()æ–¹æ³•è°ƒç”¨ for (; j &lt; size; j++) &#123; Future&lt;T&gt; f = futures.get(j); if (!f.isDone()) &#123; try &#123; f.get(deadline - System.nanoTime(), NANOSECONDS); &#125; catch (CancellationException | ExecutionException ignore) &#123;&#125; catch (TimeoutException timedOut) &#123; break timedOut; &#125; &#125; &#125; return futures; &#125; catch (Throwable t) &#123; cancelAll(futures); throw t; &#125; // æ‰€æœ‰ä»»åŠ¡å®Œæˆä¹‹å‰å‘ç°å·²ç»è¶…æ—¶ï¼Œåˆ™å–æ¶ˆè¶…æ—¶ä»»åŠ¡ç´¢å¼•ä¹‹åçš„æ‰€æœ‰ä»»åŠ¡ï¼Œå·²ç»å®Œæˆçš„ä¸å—å½±å“ cancelAll(futures, j); return futures; &#125; // å–æ¶ˆæ‰€æœ‰çš„Futureå®ä¾‹ private static &lt;T&gt; void cancelAll(ArrayList&lt;Future&lt;T&gt;&gt; futures) &#123; cancelAll(futures, 0); &#125; // éå†æ‰€æœ‰çš„Futureå®ä¾‹è°ƒç”¨å…¶cancelæ–¹æ³•ï¼Œå› ä¸ºå‚æ•°ä¸ºtrueï¼Œæ‰€ä»¥ä¼šå“åº”ä¸­æ–­ // jå‚æ•°æ˜¯å†³å®šéå†çš„èµ·ç‚¹ï¼Œ0è¡¨ç¤ºæ•´ä¸ªåˆ—è¡¨éå† private static &lt;T&gt; void cancelAll(ArrayList&lt;Future&lt;T&gt;&gt; futures, int j) &#123; for (int size = futures.size(); j &lt; size; j++) futures.get(j).cancel(true); &#125;&#125; æ•´ä¸ªç±»çš„æºç å¹¶ä¸å¤æ‚ï¼Œæ³¨æ„åˆ°Callableå’ŒRunnableçš„ä»»åŠ¡æœ€é‡éƒ½ä¼šåŒ…è£…ä¸ºé€‚é…å™¨FutureTaskçš„å®ä¾‹ï¼Œç„¶åé€šè¿‡execute()æ–¹æ³•æäº¤åŒ…è£…å¥½çš„FutureTaskä»»åŠ¡å®ä¾‹ï¼Œè¿”å›å€¼æ˜¯Futureæˆ–è€…Futureçš„é›†åˆæ—¶å€™ï¼Œå®é™…ä¸Šæ˜¯RunnableFutureæˆ–è€…RunnableFutureçš„é›†åˆï¼Œåªå› ä¸ºRunnableFutureæ˜¯Futureçš„å­æ¥å£ï¼Œè¿™ç§è®¾è®¡éµå¾ªäº†è®¾è®¡æ¨¡å¼åŸåˆ™é‡Œé¢çš„ä¾èµ–å€’ç½®åŸåˆ™ã€‚è¿™é‡Œå°ç»“ä¸€ä¸‹åˆ†æè¿‡çš„å‡ ä¸ªæ–¹æ³•çš„ç‰¹å¾ï¼š æ–¹æ³• ç‰¹å¾ submit(Runnable task) å¼‚æ­¥æ‰§è¡Œï¼Œæ‰§è¡Œç»“æœæ— æ„ŸçŸ¥ï¼Œé€šè¿‡get()æ–¹æ³•è™½ç„¶è¿”å›nullä½†æ˜¯å¯ä»¥ç¡®å®šæ‰§è¡Œå®Œæ¯•çš„æ—¶åˆ» submit(Runnable task, T result) å¼‚æ­¥æ‰§è¡Œï¼Œé¢„å…ˆä¼ å…¥æ‰§è¡Œç»“æœï¼Œæœ€ç»ˆé€šè¿‡get()æ–¹æ³•è¿”å›çš„å°±æ˜¯åˆå§‹ä¼ å…¥çš„ç»“æœ submit(Callable&lt;T&gt; task) å¼‚æ­¥æ‰§è¡Œï¼Œæœ€ç»ˆé€šè¿‡get()æ–¹æ³•è¿”å›çš„æ˜¯Callable#call()çš„ç»“æœ invokeAny(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks) å¼‚æ­¥æ‰§è¡Œä»»åŠ¡åˆ—è¡¨ä¸­çš„ä»»æ„ä¸€ä¸ªä»»åŠ¡ï¼ˆå®é™…ä¸Šæœ‰å¯èƒ½ä¼šæ‰§è¡Œå¤šä¸ªä»»åŠ¡ï¼Œç¡®ä¿æœ€å…ˆå®Œæˆçš„ä»»åŠ¡å¯¹åº”çš„ç»“æœè¿”å›ï¼‰ï¼Œæ°¸ä¹…é˜»å¡åŒæ­¥è¿”å›ç»“æœ invokeAny(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks, long timeout, TimeUnit unit) åŠŸèƒ½åŒä¸Šï¼Œè·å–ç»“æœçš„æ—¶å€™æ˜¯è¶…æ—¶é˜»å¡è·å– invokeAll(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks) å¼‚æ­¥æ‰§è¡Œä»»åŠ¡åˆ—è¡¨ä¸­çš„æ‰€æœ‰ä»»åŠ¡ï¼Œå¿…é¡»ç­‰å¾…æ‰€æœ‰Future#get()æ°¸ä¹…é˜»å¡æ–¹æ³•éƒ½è¿”å›äº†ç»“æœæ‰è¿”å›Futureåˆ—è¡¨ invokeAll(Collection&lt;? extends Callable&lt;T&gt;&gt; tasks, long timeout, TimeUnit unit) å¼‚æ­¥æ‰§è¡Œä»»åŠ¡åˆ—è¡¨ä¸­çš„æ‰€æœ‰ä»»åŠ¡ï¼Œåªè¦å…¶ä¸­ä¸€ä¸ªä»»åŠ¡Future#get()è¶…æ—¶é˜»å¡æ–¹æ³•è¶…æ—¶å°±ä¼šå–æ¶ˆè¯¥ä»»åŠ¡ç´¢å¼•ä¹‹åçš„æ‰€æœ‰ä»»åŠ¡å¹¶ä¸”è¿”å›Futureåˆ—è¡¨ å°ç»“ ExecutorServiceæä¾›äº†ä¸€ç³»åˆ—ä¾¿æ·çš„å¼‚æ­¥ä»»åŠ¡æäº¤æ–¹æ³•ï¼Œå®ƒä½¿ç”¨åˆ°å¤šç§æŠ€æœ¯ï¼š ç›¸å¯¹åº•å±‚çš„CASåŸè¯­ã€‚ åŸºäºCASå®ç°çš„æ— é”å¹¶å‘æ ˆã€‚ ä¾èµ–äºçº¿ç¨‹æ± å®ç°çš„execute()æ–¹æ³•è¿›è¡Œå¼‚æ­¥ä»»åŠ¡æäº¤ã€‚ ä½¿ç”¨é€‚é…å™¨æ¨¡å¼è®¾è®¡FutureTaské€‚é…Futrueã€Runnableå’ŒCallableï¼Œæä¾›äº†çŠ¶æ€çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ã€‚ ä¸‹ä¸€ç¯‡æ–‡ç« å°†ä¼šåˆ†æä¸€ä¸‹è°ƒåº¦çº¿ç¨‹æ± ScheduledThreadPoolExecutorçš„åº•å±‚å®ç°å’Œæºç ã€‚ ï¼ˆæœ¬æ–‡å®Œ c-7-d e-a-20190727ï¼‰","categories":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/categories/Java/"},{"name":"Concurrency","slug":"Java/Concurrency","permalink":"http://throwable.club/blog/categories/Java/Concurrency/"}],"tags":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/tags/Java/"},{"name":"ExecutorService","slug":"ExecutorService","permalink":"http://throwable.club/blog/tags/ExecutorService/"}]},{"title":"JUCçº¿ç¨‹æ± ThreadPoolExecutoræºç åˆ†æ","slug":"java-concurrency-thread-pool-executor","date":"2019-07-15T15:58:25.000Z","updated":"2019-07-21T15:56:36.342Z","comments":true,"path":"2019/07/15/java-concurrency-thread-pool-executor/","link":"","permalink":"http://throwable.club/2019/07/15/java-concurrency-thread-pool-executor/","excerpt":"å‰æ å¾ˆæ—©ä¹‹å‰å°±æ‰“ç®—çœ‹ä¸€æ¬¡JUCçº¿ç¨‹æ± ThreadPoolExecutorçš„æºç å®ç°ï¼Œç”±äºè¿‘æ®µæ—¶é—´æ¯”è¾ƒå¿™ï¼Œä¸€ç›´æ²¡æœ‰æ—¶é—´æ•´ç†å‡ºæºç åˆ†æçš„æ–‡ç« ã€‚ä¹‹å‰åœ¨åˆ†ææ‰©å±•çº¿ç¨‹æ± å®ç°å¯å›è°ƒçš„Futureæ—¶å€™æ›¾ç»æåˆ°å¹¶å‘å¤§å¸ˆDoug Leaåœ¨è®¾è®¡çº¿ç¨‹æ± ThreadPoolExecutorçš„æäº¤ä»»åŠ¡çš„é¡¶å±‚æ¥å£Executoråªæœ‰ä¸€ä¸ªæ— çŠ¶æ€çš„æ‰§è¡Œæ–¹æ³•ï¼š 1234public interface Executor &#123; void execute(Runnable command);&#125; è€ŒExecutorServiceæä¾›äº†å¾ˆå¤šæ‰©å±•æ–¹æ³•åº•å±‚åŸºæœ¬ä¸Šæ˜¯åŸºäºExecutor#execute()æ–¹æ³•è¿›è¡Œæ‰©å±•ã€‚æœ¬æ–‡ç€é‡åˆ†æThreadPoolExecutor#execute()çš„å®ç°ï¼Œç¬”è€…ä¼šä»å®ç°åŸç†ã€æºç å®ç°ç­‰è§’åº¦ç»“åˆç®€åŒ–ä¾‹å­è¿›è¡Œè¯¦ç»†çš„åˆ†æã€‚ThreadPoolExecutorçš„æºç ä»JDK8åˆ°JDK11åŸºæœ¬æ²¡æœ‰å˜åŒ–ï¼Œæœ¬æ–‡ç¼–å†™çš„æ—¶å€™ä½¿ç”¨çš„æ˜¯JDK11ã€‚","text":"å‰æ å¾ˆæ—©ä¹‹å‰å°±æ‰“ç®—çœ‹ä¸€æ¬¡JUCçº¿ç¨‹æ± ThreadPoolExecutorçš„æºç å®ç°ï¼Œç”±äºè¿‘æ®µæ—¶é—´æ¯”è¾ƒå¿™ï¼Œä¸€ç›´æ²¡æœ‰æ—¶é—´æ•´ç†å‡ºæºç åˆ†æçš„æ–‡ç« ã€‚ä¹‹å‰åœ¨åˆ†ææ‰©å±•çº¿ç¨‹æ± å®ç°å¯å›è°ƒçš„Futureæ—¶å€™æ›¾ç»æåˆ°å¹¶å‘å¤§å¸ˆDoug Leaåœ¨è®¾è®¡çº¿ç¨‹æ± ThreadPoolExecutorçš„æäº¤ä»»åŠ¡çš„é¡¶å±‚æ¥å£Executoråªæœ‰ä¸€ä¸ªæ— çŠ¶æ€çš„æ‰§è¡Œæ–¹æ³•ï¼š 1234public interface Executor &#123; void execute(Runnable command);&#125; è€ŒExecutorServiceæä¾›äº†å¾ˆå¤šæ‰©å±•æ–¹æ³•åº•å±‚åŸºæœ¬ä¸Šæ˜¯åŸºäºExecutor#execute()æ–¹æ³•è¿›è¡Œæ‰©å±•ã€‚æœ¬æ–‡ç€é‡åˆ†æThreadPoolExecutor#execute()çš„å®ç°ï¼Œç¬”è€…ä¼šä»å®ç°åŸç†ã€æºç å®ç°ç­‰è§’åº¦ç»“åˆç®€åŒ–ä¾‹å­è¿›è¡Œè¯¦ç»†çš„åˆ†æã€‚ThreadPoolExecutorçš„æºç ä»JDK8åˆ°JDK11åŸºæœ¬æ²¡æœ‰å˜åŒ–ï¼Œæœ¬æ–‡ç¼–å†™çš„æ—¶å€™ä½¿ç”¨çš„æ˜¯JDK11ã€‚ ThreadPoolExecutorçš„åŸç† ThreadPoolExecutoré‡Œé¢ä½¿ç”¨åˆ°JUCåŒæ­¥å™¨æ¡†æ¶AbstractQueuedSynchronizerï¼ˆä¿—ç§°AQSï¼‰ã€å¤§é‡çš„ä½æ“ä½œã€CASæ“ä½œã€‚ThreadPoolExecutoræä¾›äº†å›ºå®šæ´»è·ƒçº¿ç¨‹ï¼ˆæ ¸å¿ƒçº¿ç¨‹ï¼‰ã€é¢å¤–çš„çº¿ç¨‹ï¼ˆçº¿ç¨‹æ± å®¹é‡ - æ ¸å¿ƒçº¿ç¨‹æ•°è¿™éƒ¨åˆ†é¢å¤–åˆ›å»ºçš„çº¿ç¨‹ï¼Œä¸‹é¢ç§°ä¸ºéæ ¸å¿ƒçº¿ç¨‹ï¼‰ã€ä»»åŠ¡é˜Ÿåˆ—ä»¥åŠæ‹’ç»ç­–ç•¥è¿™å‡ ä¸ªé‡è¦çš„åŠŸèƒ½ã€‚ JUCåŒæ­¥å™¨æ¡†æ¶ ThreadPoolExecutoré‡Œé¢ä½¿ç”¨åˆ°JUCåŒæ­¥å™¨æ¡†æ¶ï¼Œä¸»è¦ç”¨äºå››ä¸ªæ–¹é¢ï¼š å…¨å±€é”mainLockæˆå‘˜å±æ€§ï¼Œæ˜¯å¯é‡å…¥é”ReentrantLockç±»å‹ï¼Œä¸»è¦æ˜¯ç”¨äºè®¿é—®å·¥ä½œçº¿ç¨‹Workeré›†åˆå’Œè¿›è¡Œæ•°æ®ç»Ÿè®¡è®°å½•æ—¶å€™çš„åŠ é”æ“ä½œã€‚ æ¡ä»¶å˜é‡terminationï¼ŒConditionç±»å‹ï¼Œä¸»è¦ç”¨äºçº¿ç¨‹è¿›è¡Œç­‰å¾…ç»ˆç»“awaitTermination()æ–¹æ³•æ—¶çš„å¸¦æœŸé™é˜»å¡ã€‚ ä»»åŠ¡é˜Ÿåˆ—workQueueï¼ŒBlockingQueue&lt;Runnable&gt;ç±»å‹ï¼Œä»»åŠ¡é˜Ÿåˆ—ï¼Œç”¨äºå­˜æ”¾å¾…æ‰§è¡Œçš„ä»»åŠ¡ã€‚ å·¥ä½œçº¿ç¨‹ï¼Œå†…éƒ¨ç±»Workerç±»å‹ï¼Œæ˜¯çº¿ç¨‹æ± ä¸­çœŸæ­£çš„å·¥ä½œçº¿ç¨‹å¯¹è±¡ã€‚ å…³äºAQSç¬”è€…ä¹‹å‰å†™è¿‡ä¸€ç¯‡ç›¸å…³æºç åˆ†æçš„æ–‡ç« ï¼šJUCåŒæ­¥å™¨æ¡†æ¶AbstractQueuedSynchronizeræºç å›¾æ–‡åˆ†æã€‚ æ ¸å¿ƒçº¿ç¨‹ è¿™é‡Œå…ˆå‚è€ƒThreadPoolExecutorçš„å®ç°å¹¶ä¸”è¿›è¡Œç®€åŒ–ï¼Œå®ç°ä¸€ä¸ªåªæœ‰æ ¸å¿ƒçº¿ç¨‹çš„çº¿ç¨‹æ± ï¼Œè¦æ±‚å¦‚ä¸‹ï¼š æš‚æ—¶ä¸è€ƒè™‘ä»»åŠ¡æ‰§è¡Œå¼‚å¸¸æƒ…å†µä¸‹çš„å¤„ç†ã€‚ ä»»åŠ¡é˜Ÿåˆ—ä¸ºæ— ç•Œé˜Ÿåˆ—ã€‚ çº¿ç¨‹æ± å®¹é‡å›ºå®šä¸ºæ ¸å¿ƒçº¿ç¨‹æ•°é‡ã€‚ æš‚æ—¶ä¸è€ƒè™‘æ‹’ç»ç­–ç•¥ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162public class CoreThreadPool implements Executor &#123; private BlockingQueue&lt;Runnable&gt; workQueue; private static final AtomicInteger COUNTER = new AtomicInteger(); private int coreSize; private int threadCount = 0; public CoreThreadPool(int coreSize) &#123; this.coreSize = coreSize; this.workQueue = new LinkedBlockingQueue&lt;&gt;(); &#125; @Override public void execute(Runnable command) &#123; if (++threadCount &lt;= coreSize) &#123; new Worker(command).start(); &#125; else &#123; try &#123; workQueue.put(command); &#125; catch (InterruptedException e) &#123; throw new IllegalStateException(e); &#125; &#125; &#125; private class Worker extends Thread &#123; private Runnable firstTask; public Worker(Runnable runnable) &#123; super(String.format(\"Worker-%d\", COUNTER.getAndIncrement())); this.firstTask = runnable; &#125; @Override public void run() &#123; Runnable task = this.firstTask; while (null != task || null != (task = getTask())) &#123; try &#123; task.run(); &#125; finally &#123; task = null; &#125; &#125; &#125; &#125; private Runnable getTask() &#123; try &#123; return workQueue.take(); &#125; catch (InterruptedException e) &#123; throw new IllegalStateException(e); &#125; &#125; public static void main(String[] args) throws Exception &#123; CoreThreadPool pool = new CoreThreadPool(5); IntStream.range(0, 10) .forEach(i -&gt; pool.execute(() -&gt; System.out.println(String.format(\"Thread:%s,value:%d\", Thread.currentThread().getName(), i)))); Thread.sleep(Integer.MAX_VALUE); &#125;&#125; æŸæ¬¡è¿è¡Œç»“æœå¦‚ä¸‹ï¼š 12345678910Thread:Worker-0,value:0Thread:Worker-3,value:3Thread:Worker-2,value:2Thread:Worker-1,value:1Thread:Worker-4,value:4Thread:Worker-1,value:5Thread:Worker-2,value:8Thread:Worker-4,value:7Thread:Worker-0,value:6Thread:Worker-3,value:9 è®¾è®¡æ­¤çº¿ç¨‹æ± çš„æ—¶å€™ï¼Œæ ¸å¿ƒçº¿ç¨‹æ˜¯æ‡’åˆ›å»ºçš„ï¼Œå¦‚æœçº¿ç¨‹ç©ºé—²çš„æ—¶å€™åˆ™é˜»å¡åœ¨ä»»åŠ¡é˜Ÿåˆ—çš„take()æ–¹æ³•ï¼Œå…¶å®å¯¹äºThreadPoolExecutorä¹Ÿæ˜¯ç±»ä¼¼è¿™æ ·å®ç°ï¼Œåªæ˜¯å¦‚æœä½¿ç”¨äº†keepAliveTimeå¹¶ä¸”å…è®¸æ ¸å¿ƒçº¿ç¨‹è¶…æ—¶ï¼ˆallowCoreThreadTimeOutè®¾ç½®ä¸ºtrueï¼‰åˆ™ä¼šä½¿ç”¨BlockingQueue#poll(keepAliveTime)è¿›è¡Œè½®è¯¢ä»£æ›¿æ°¸ä¹…é˜»å¡ã€‚ å…¶ä»–é™„åŠ åŠŸèƒ½ æ„å»ºThreadPoolExecutorå®ä¾‹çš„æ—¶å€™ï¼Œéœ€è¦å®šä¹‰maximumPoolSizeï¼ˆçº¿ç¨‹æ± æœ€å¤§çº¿ç¨‹æ•°ï¼‰å’ŒcorePoolSizeï¼ˆæ ¸å¿ƒçº¿ç¨‹æ•°ï¼‰ã€‚å½“ä»»åŠ¡é˜Ÿåˆ—æ˜¯æœ‰ç•Œçš„é˜»å¡é˜Ÿåˆ—ï¼Œæ ¸å¿ƒçº¿ç¨‹æ»¡è´Ÿè½½ï¼Œä»»åŠ¡é˜Ÿåˆ—å·²ç»æ»¡çš„æƒ…å†µä¸‹ï¼Œä¼šå°è¯•åˆ›å»ºé¢å¤–çš„maximumPoolSize - corePoolSizeä¸ªçº¿ç¨‹å»æ‰§è¡Œæ–°æäº¤çš„ä»»åŠ¡ã€‚å½“ThreadPoolExecutorè¿™é‡Œå®ç°çš„ä¸¤ä¸ªä¸»è¦é™„åŠ åŠŸèƒ½æ˜¯ï¼š ä¸€å®šæ¡ä»¶ä¸‹ä¼šåˆ›å»ºéæ ¸å¿ƒçº¿ç¨‹å»æ‰§è¡Œä»»åŠ¡ï¼Œéæ ¸å¿ƒçº¿ç¨‹çš„å›æ”¶å‘¨æœŸï¼ˆçº¿ç¨‹ç”Ÿå‘½å‘¨æœŸç»ˆç»“æ—¶åˆ»ï¼‰æ˜¯keepAliveTimeï¼Œçº¿ç¨‹ç”Ÿå‘½å‘¨æœŸç»ˆç»“çš„æ¡ä»¶æ˜¯ï¼šä¸‹ä¸€æ¬¡é€šè¿‡ä»»åŠ¡é˜Ÿåˆ—è·å–ä»»åŠ¡çš„æ—¶å€™å¹¶ä¸”å­˜æ´»æ—¶é—´è¶…è¿‡keepAliveTimeã€‚ æä¾›æ‹’ç»ç­–ç•¥ï¼Œä¹Ÿå°±æ˜¯åœ¨æ ¸å¿ƒçº¿ç¨‹æ»¡è´Ÿè½½ã€ä»»åŠ¡é˜Ÿåˆ—å·²æ»¡ã€éæ ¸å¿ƒçº¿ç¨‹æ»¡è´Ÿè½½çš„æ¡ä»¶ä¸‹ä¼šè§¦å‘æ‹’ç»ç­–ç•¥ã€‚ æºç åˆ†æ å…ˆåˆ†æçº¿ç¨‹æ± çš„å…³é”®å±æ€§ï¼Œæ¥ç€åˆ†æå…¶çŠ¶æ€æ§åˆ¶ï¼Œæœ€åé‡ç‚¹åˆ†æThreadPoolExecutor#execute()æ–¹æ³•ã€‚ å…³é”®å±æ€§ 12345678910111213141516171819202122232425262728293031323334353637383940414243public class ThreadPoolExecutor extends AbstractExecutorService &#123; // æ§åˆ¶å˜é‡-å­˜æ”¾çŠ¶æ€å’Œçº¿ç¨‹æ•° private final AtomicInteger ctl = new AtomicInteger(ctlOf(RUNNING, 0)); // ä»»åŠ¡é˜Ÿåˆ—ï¼Œå¿…é¡»æ˜¯é˜»å¡é˜Ÿåˆ— private final BlockingQueue&lt;Runnable&gt; workQueue; // å·¥ä½œçº¿ç¨‹é›†åˆï¼Œå­˜æ”¾çº¿ç¨‹æ± ä¸­æ‰€æœ‰çš„ï¼ˆæ´»è·ƒçš„ï¼‰å·¥ä½œçº¿ç¨‹ï¼Œåªæœ‰åœ¨æŒæœ‰å…¨å±€é”mainLockçš„å‰æä¸‹æ‰èƒ½è®¿é—®æ­¤é›†åˆ private final HashSet&lt;Worker&gt; workers = new HashSet&lt;&gt;(); // å…¨å±€é” private final ReentrantLock mainLock = new ReentrantLock(); // awaitTerminationæ–¹æ³•ä½¿ç”¨çš„ç­‰å¾…æ¡ä»¶å˜é‡ private final Condition termination = mainLock.newCondition(); // è®°å½•å³°å€¼çº¿ç¨‹æ•° private int largestPoolSize; // è®°å½•å·²ç»æˆåŠŸæ‰§è¡Œå®Œæ¯•çš„ä»»åŠ¡æ•° private long completedTaskCount; // çº¿ç¨‹å·¥å‚ï¼Œç”¨äºåˆ›å»ºæ–°çš„çº¿ç¨‹å®ä¾‹ private volatile ThreadFactory threadFactory; // æ‹’ç»æ‰§è¡Œå¤„ç†å™¨ï¼Œå¯¹åº”ä¸åŒçš„æ‹’ç»ç­–ç•¥ private volatile RejectedExecutionHandler handler; // ç©ºé—²çº¿ç¨‹ç­‰å¾…ä»»åŠ¡çš„æ—¶é—´å‘¨æœŸï¼Œå•ä½æ˜¯çº³ç§’ private volatile long keepAliveTime; // æ˜¯å¦å…è®¸æ ¸å¿ƒçº¿ç¨‹è¶…æ—¶ï¼Œå¦‚æœä¸ºtrueåˆ™keepAliveTimeå¯¹æ ¸å¿ƒçº¿ç¨‹ä¹Ÿç”Ÿæ•ˆ private volatile boolean allowCoreThreadTimeOut; // æ ¸å¿ƒçº¿ç¨‹æ•° private volatile int corePoolSize; // çº¿ç¨‹æ± å®¹é‡ private volatile int maximumPoolSize; // çœç•¥å…¶ä»–ä»£ç &#125; ä¸‹é¢çœ‹å‚æ•°åˆ—è¡¨æœ€é•¿çš„æ„é€ å‡½æ•°ï¼š 123456789101112131415161718192021public ThreadPoolExecutor(int corePoolSize, int maximumPoolSize, long keepAliveTime, TimeUnit unit, BlockingQueue&lt;Runnable&gt; workQueue, ThreadFactory threadFactory, RejectedExecutionHandler handler) &#123; if (corePoolSize &lt; 0 || maximumPoolSize &lt;= 0 || maximumPoolSize &lt; corePoolSize || keepAliveTime &lt; 0) throw new IllegalArgumentException(); if (workQueue == null || threadFactory == null || handler == null) throw new NullPointerException(); this.corePoolSize = corePoolSize; this.maximumPoolSize = maximumPoolSize; this.workQueue = workQueue; this.keepAliveTime = unit.toNanos(keepAliveTime); this.threadFactory = threadFactory; this.handler = handler;&#125; å¯ä»¥è‡ªå®šä¹‰æ ¸å¿ƒçº¿ç¨‹æ•°ã€çº¿ç¨‹æ± å®¹é‡ï¼ˆæœ€å¤§çº¿ç¨‹æ•°ï¼‰ã€ç©ºé—²çº¿ç¨‹ç­‰å¾…ä»»åŠ¡å‘¨æœŸã€ä»»åŠ¡é˜Ÿåˆ—ã€çº¿ç¨‹å·¥å‚ã€æ‹’ç»ç­–ç•¥ã€‚ä¸‹é¢ç®€å•åˆ†æä¸€ä¸‹æ¯ä¸ªå‚æ•°çš„å«ä¹‰å’Œä½œç”¨ï¼š corePoolSizeï¼šintç±»å‹ï¼Œæ ¸å¿ƒçº¿ç¨‹æ•°é‡ã€‚ maximumPoolSizeï¼šintç±»å‹ï¼Œæœ€å¤§çº¿ç¨‹æ•°é‡ï¼Œä¹Ÿå°±æ˜¯çº¿ç¨‹æ± çš„å®¹é‡ã€‚ keepAliveTimeï¼šlongç±»å‹ï¼Œçº¿ç¨‹ç©ºé—²ç­‰å¾…æ—¶é—´ï¼Œä¹Ÿå’Œå·¥ä½œçº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸæœ‰å…³ï¼Œä¸‹æ–‡ä¼šåˆ†æã€‚ unitï¼šTimeUnitç±»å‹ï¼ŒkeepAliveTimeå‚æ•°çš„æ—¶é—´å•ä½ï¼Œå®é™…ä¸ŠkeepAliveTimeæœ€ç»ˆä¼šè½¬åŒ–ä¸ºçº³ç§’ã€‚ workQueueï¼šBlockingQueue&lt;Runnable&gt;ç±»å‹ï¼Œç­‰å¾…é˜Ÿåˆ—æˆ–è€…å«ä»»åŠ¡é˜Ÿåˆ—ã€‚ threadFactoryï¼šThreadFactoryç±»å‹ï¼Œçº¿ç¨‹å·¥å‚ï¼Œç”¨äºåˆ›å»ºå·¥ä½œçº¿ç¨‹ï¼ˆåŒ…æ‹¬æ ¸å¿ƒçº¿ç¨‹å’Œéæ ¸å¿ƒçº¿ç¨‹ï¼‰ï¼Œé»˜è®¤ä½¿ç”¨Executors.defaultThreadFactory()ä½œä¸ºå†…å»ºçº¿ç¨‹å·¥å‚å®ä¾‹ï¼Œä¸€èˆ¬è‡ªå®šä¹‰çº¿ç¨‹å·¥å‚æ‰èƒ½æ›´å¥½åœ°è·Ÿè¸ªå·¥ä½œçº¿ç¨‹ã€‚ handlerï¼šRejectedExecutionHandlerç±»å‹ï¼Œçº¿ç¨‹æ± çš„æ‹’ç»æ‰§è¡Œå¤„ç†å™¨ï¼Œæ›´å¤šæ—¶å€™ç§°ä¸ºæ‹’ç»ç­–ç•¥ï¼Œæ‹’ç»ç­–ç•¥æ‰§è¡Œçš„æ—¶æœºæ˜¯å½“é˜»å¡é˜Ÿåˆ—å·²æ»¡ã€æ²¡æœ‰ç©ºé—²çš„çº¿ç¨‹ï¼ˆåŒ…æ‹¬æ ¸å¿ƒçº¿ç¨‹å’Œéæ ¸å¿ƒçº¿ç¨‹ï¼‰å¹¶ä¸”ç»§ç»­æäº¤ä»»åŠ¡ã€‚æä¾›äº†4ç§å†…å»ºçš„æ‹’ç»ç­–ç•¥å®ç°ï¼š AbortPolicyï¼šç›´æ¥æ‹’ç»ç­–ç•¥ï¼Œä¹Ÿå°±æ˜¯ä¸ä¼šæ‰§è¡Œä»»åŠ¡ï¼Œç›´æ¥æŠ›å‡ºRejectedExecutionExceptionï¼Œè¿™æ˜¯é»˜è®¤çš„æ‹’ç»ç­–ç•¥ã€‚ DiscardPolicyï¼šæŠ›å¼ƒç­–ç•¥ï¼Œä¹Ÿå°±æ˜¯ç›´æ¥å¿½ç•¥æäº¤çš„ä»»åŠ¡ï¼ˆé€šä¿—æ¥è¯´å°±æ˜¯ç©ºå®ç°ï¼‰ã€‚ DiscardOldestPolicyï¼šæŠ›å¼ƒæœ€è€ä»»åŠ¡ç­–ç•¥ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡poll()æ–¹æ³•å–å‡ºä»»åŠ¡é˜Ÿåˆ—é˜Ÿå¤´çš„ä»»åŠ¡æŠ›å¼ƒï¼Œç„¶åæ‰§è¡Œå½“å‰æäº¤çš„ä»»åŠ¡ã€‚ CallerRunsPolicyï¼šè°ƒç”¨è€…æ‰§è¡Œç­–ç•¥ï¼Œä¹Ÿå°±æ˜¯å½“å‰è°ƒç”¨Executor#execute()çš„çº¿ç¨‹ç›´æ¥è°ƒç”¨ä»»åŠ¡Runnable#run()ï¼Œä¸€èˆ¬ä¸å¸Œæœ›ä»»åŠ¡ä¸¢å¤±ä¼šé€‰ç”¨è¿™ç§ç­–ç•¥ï¼Œä½†ä»å®é™…è§’åº¦æ¥çœ‹ï¼ŒåŸæ¥çš„å¼‚æ­¥è°ƒç”¨æ„å›¾ä¼šé€€åŒ–ä¸ºåŒæ­¥è°ƒç”¨ã€‚ çŠ¶æ€æ§åˆ¶ çŠ¶æ€æ§åˆ¶ä¸»è¦å›´ç»•åŸå­æ•´å‹æˆå‘˜å˜é‡ctlï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344private final AtomicInteger ctl = new AtomicInteger(ctlOf(RUNNING, 0));private static final int COUNT_BITS = Integer.SIZE - 3;private static final int COUNT_MASK = (1 &lt;&lt; COUNT_BITS) - 1;private static final int RUNNING = -1 &lt;&lt; COUNT_BITS;private static final int SHUTDOWN = 0 &lt;&lt; COUNT_BITS;private static final int STOP = 1 &lt;&lt; COUNT_BITS;private static final int TIDYING = 2 &lt;&lt; COUNT_BITS;private static final int TERMINATED = 3 &lt;&lt; COUNT_BITS;// é€šè¿‡ctlå€¼è·å–è¿è¡ŒçŠ¶æ€private static int runStateOf(int c) &#123; return c &amp; ~COUNT_MASK; &#125;// é€šè¿‡ctlå€¼è·å–å·¥ä½œçº¿ç¨‹æ•°private static int workerCountOf(int c) &#123; return c &amp; COUNT_MASK; &#125;// é€šè¿‡è¿è¡ŒçŠ¶æ€å’Œå·¥ä½œçº¿ç¨‹æ•°è®¡ç®—ctlçš„å€¼ï¼Œæˆ–è¿ç®—private static int ctlOf(int rs, int wc) &#123; return rs | wc; &#125;private static boolean runStateLessThan(int c, int s) &#123; return c &lt; s;&#125;private static boolean runStateAtLeast(int c, int s) &#123; return c &gt;= s;&#125;private static boolean isRunning(int c) &#123; return c &lt; SHUTDOWN;&#125;// CASæ“ä½œçº¿ç¨‹æ•°å¢åŠ 1private boolean compareAndIncrementWorkerCount(int expect) &#123; return ctl.compareAndSet(expect, expect + 1);&#125;// CASæ“ä½œçº¿ç¨‹æ•°å‡å°‘1private boolean compareAndDecrementWorkerCount(int expect) &#123; return ctl.compareAndSet(expect, expect - 1);&#125;// çº¿ç¨‹æ•°ç›´æ¥å‡å°‘1private void decrementWorkerCount() &#123; ctl.addAndGet(-1);&#125; æ¥ä¸‹æ¥åˆ†æä¸€ä¸‹çº¿ç¨‹æ± çš„çŠ¶æ€å˜é‡ï¼Œå·¥ä½œçº¿ç¨‹ä¸Šé™æ•°é‡ä½çš„é•¿åº¦æ˜¯COUNT_BITSï¼Œå®ƒçš„å€¼æ˜¯Integer.SIZE - 3ï¼Œä¹Ÿå°±æ˜¯æ­£æ•´æ•°29ï¼š æˆ‘ä»¬çŸ¥é“ï¼Œæ•´å‹åŒ…è£…ç±»å‹Integerå®ä¾‹çš„å¤§å°æ˜¯4 byteï¼Œä¸€å…±32 bitï¼Œä¹Ÿå°±æ˜¯ä¸€å…±æœ‰32ä¸ªä½ç”¨äºå­˜æ”¾0æˆ–è€…1ã€‚ åœ¨ThreadPoolExecutorå®ç°ä¸­ï¼Œä½¿ç”¨32ä½çš„æ•´å‹åŒ…è£…ç±»å‹å­˜æ”¾å·¥ä½œçº¿ç¨‹æ•°å’Œçº¿ç¨‹æ± çŠ¶æ€ã€‚ å…¶ä¸­ï¼Œä½29ä½ç”¨äºå­˜æ”¾å·¥ä½œçº¿ç¨‹æ•°ï¼Œè€Œé«˜3ä½ç”¨äºå­˜æ”¾çº¿ç¨‹æ± çŠ¶æ€ï¼Œæ‰€ä»¥çº¿ç¨‹æ± çš„çŠ¶æ€æœ€å¤šåªèƒ½æœ‰2^3ç§ã€‚ å·¥ä½œçº¿ç¨‹ä¸Šé™æ•°é‡ä¸º2^29 - 1ï¼Œè¶…è¿‡5äº¿ï¼Œè¿™ä¸ªæ•°é‡åœ¨çŸ­æ—¶é—´å†…ä¸ç”¨è€ƒè™‘ä¼šè¶…é™ã€‚ æ¥ç€çœ‹å·¥ä½œçº¿ç¨‹ä¸Šé™æ•°é‡æ©ç COUNT_MASKï¼Œå®ƒçš„å€¼æ˜¯(1 &lt; COUNT_BITS) - lï¼Œä¹Ÿå°±æ˜¯1å·¦ç§»29ä½ï¼Œå†å‡å»1ï¼Œå¦‚æœè¡¥å…¨32ä½ï¼Œå®ƒçš„ä½è§†å›¾å¦‚ä¸‹ï¼š ç„¶åå°±æ˜¯çº¿ç¨‹æ± çš„çŠ¶æ€å¸¸é‡ï¼Œè¿™é‡Œåªè¯¦ç»†åˆ†æå…¶ä¸­ä¸€ä¸ªï¼Œå…¶ä»–ç±»åŒï¼Œè¿™é‡Œçœ‹RUNNINGçŠ¶æ€ï¼š 12345// -1çš„è¡¥ç ä¸ºï¼š111-11111111111111111111111111111// å·¦ç§»29ä½åï¼š111-00000000000000000000000000000// 10è¿›åˆ¶å€¼ä¸ºï¼š-536870912 // é«˜3ä½111çš„å€¼å°±æ˜¯è¡¨ç¤ºçº¿ç¨‹æ± æ­£åœ¨å¤„äºè¿è¡ŒçŠ¶æ€private static final int RUNNING = -1 &lt;&lt; COUNT_BITS; æ§åˆ¶å˜é‡ctlçš„ç»„æˆå°±æ˜¯é€šè¿‡çº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€rså’Œå·¥ä½œçº¿ç¨‹æ•°wcé€šè¿‡æˆ–è¿ç®—å¾—åˆ°çš„ï¼š 1234567// rs=RUNNINGå€¼ä¸ºï¼š111-00000000000000000000000000000// wcçš„å€¼ä¸º0ï¼š000-00000000000000000000000000000// rs | wcçš„ç»“æœä¸ºï¼š111-00000000000000000000000000000private final AtomicInteger ctl = new AtomicInteger(ctlOf(RUNNING, 0));private static int ctlOf(int rs, int wc) &#123; return rs | wc; &#125; é‚£ä¹ˆæˆ‘ä»¬æ€ä¹ˆä»ctlä¸­å–å‡ºé«˜3ä½çš„çº¿ç¨‹æ± çŠ¶æ€ï¼Ÿä¸Šé¢æºç ä¸­æä¾›çš„runStateOf()æ–¹æ³•å°±æ˜¯æå–è¿è¡ŒçŠ¶æ€ï¼š 123456// å…ˆæŠŠCOUNT_MASKå–å(~COUNT_MASK)ï¼Œå¾—åˆ°ï¼š111-00000000000000000000000000000// ctlä½å›¾ç‰¹ç‚¹æ˜¯ï¼šxxx-yyyyyyyyyyyyyyyyyyyyyyyyyyyyyy// ä¸¤è€…åšä¸€æ¬¡ä¸è¿ç®—å³å¯å¾—åˆ°é«˜3ä½xxxprivate static int runStateOf(int c)&#123; return c &amp; ~COUNT_MASK; &#125; åŒç†ï¼Œå–å‡ºä½29ä½çš„å·¥ä½œçº¿ç¨‹æ•°é‡åªéœ€è¦æŠŠctlå’ŒCOUNT_MASK(000-11111111111111111111111111111)åšä¸€æ¬¡ä¸è¿ç®—å³å¯ã€‚ å·¥ä½œçº¿ç¨‹æ•°ä¸º0çš„å‰æä¸‹ï¼Œå°ç»“ä¸€ä¸‹çº¿ç¨‹æ± çš„è¿è¡ŒçŠ¶æ€å¸¸é‡ï¼š çŠ¶æ€åç§° ä½å›¾ åè¿›åˆ¶å€¼ æè¿° RUNNING 111-00000000000000000000000000000 -536870912 è¿è¡Œä¸­çŠ¶æ€ï¼Œå¯ä»¥æ¥æ”¶æ–°çš„ä»»åŠ¡å’Œæ‰§è¡Œä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ SHUTDOWN 000-00000000000000000000000000000 0 shutdownçŠ¶æ€ï¼Œä¸å†æ¥æ”¶æ–°çš„ä»»åŠ¡ï¼Œä½†æ˜¯ä¼šæ‰§è¡Œä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ STOP 001-00000000000000000000000000000 536870912 åœæ­¢çŠ¶æ€ï¼Œä¸å†æ¥æ”¶æ–°çš„ä»»åŠ¡ï¼Œä¹Ÿä¸ä¼šæ‰§è¡Œä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼Œä¸­æ–­æ‰€æœ‰æ‰§è¡Œä¸­çš„ä»»åŠ¡ TIDYING 010-00000000000000000000000000000 1073741824 æ•´ç†ä¸­çŠ¶æ€ï¼Œæ‰€æœ‰ä»»åŠ¡å·²ç»ç»ˆç»“ï¼Œå·¥ä½œçº¿ç¨‹æ•°ä¸º0ï¼Œè¿‡æ¸¡åˆ°æ­¤çŠ¶æ€çš„å·¥ä½œçº¿ç¨‹ä¼šè°ƒç”¨é’©å­æ–¹æ³•terminated() TERMINATED 011-00000000000000000000000000000 1610612736 ç»ˆç»“çŠ¶æ€ï¼Œé’©å­æ–¹æ³•terminated()æ‰§è¡Œå®Œæ¯• è¿™é‡Œæœ‰ä¸€ä¸ªæ¯”è¾ƒç‰¹æ®Šçš„æŠ€å·§ï¼Œç”±äºè¿è¡ŒçŠ¶æ€å€¼å­˜æ”¾åœ¨é«˜3ä½ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥é€šè¿‡åè¿›åˆ¶å€¼ï¼ˆç”šè‡³å¯ä»¥å¿½ç•¥ä½29ä½ï¼Œç›´æ¥ç”¨ctlè¿›è¡Œæ¯”è¾ƒï¼Œæˆ–è€…ä½¿ç”¨ctlå’Œçº¿ç¨‹æ± çŠ¶æ€å¸¸é‡è¿›è¡Œæ¯”è¾ƒï¼‰æ¥æ¯”è¾ƒå’Œåˆ¤æ–­çº¿ç¨‹æ± çš„çŠ¶æ€ï¼š å·¥ä½œçº¿ç¨‹æ•°ä¸º0çš„å‰æä¸‹ï¼šRUNNING(-536870912) &lt; SHUTDOWN(0) &lt; STOP(536870912) &lt; TIDYING(1073741824) &lt; TERMINATED(1610612736) ä¸‹é¢è¿™ä¸‰ä¸ªæ–¹æ³•å°±æ˜¯ä½¿ç”¨è¿™ç§æŠ€å·§ï¼š 1234567891011121314// ctlå’ŒçŠ¶æ€å¸¸é‡æ¯”è¾ƒï¼Œåˆ¤æ–­æ˜¯å¦å°äºprivate static boolean runStateLessThan(int c, int s) &#123; return c &lt; s;&#125;// ctlå’ŒçŠ¶æ€å¸¸é‡æ¯”è¾ƒï¼Œåˆ¤æ–­æ˜¯å¦å°äºæˆ–ç­‰äºprivate static boolean runStateAtLeast(int c, int s) &#123; return c &gt;= s;&#125;// ctlå’ŒçŠ¶æ€å¸¸é‡SHUTDOWNæ¯”è¾ƒï¼Œåˆ¤æ–­æ˜¯å¦å¤„äºRUNNINGçŠ¶æ€private static boolean isRunning(int c) &#123; return c &lt; SHUTDOWN;&#125; æœ€åæ˜¯çº¿ç¨‹æ± çŠ¶æ€çš„è·ƒè¿å›¾ï¼š PSï¼šçº¿ç¨‹æ± æºç ä¸­æœ‰å¾ˆå¤šä¸­é—´å˜é‡ç”¨äº†ç®€å•çš„å•å­—æ¯è¡¨ç¤ºï¼Œä¾‹å¦‚cå°±æ˜¯è¡¨ç¤ºctlã€wcå°±æ˜¯è¡¨ç¤ºworker countã€rså°±æ˜¯è¡¨ç¤ºrunning statusã€‚ executeæ–¹æ³•æºç åˆ†æ çº¿ç¨‹æ± å¼‚æ­¥æ‰§è¡Œä»»åŠ¡çš„æ–¹æ³•å®ç°æ˜¯ThreadPoolExecutor#execute()ï¼Œæºç å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344// æ‰§è¡Œå‘½ä»¤ï¼Œå…¶ä¸­å‘½ä»¤ï¼ˆä¸‹é¢ç§°ä»»åŠ¡ï¼‰å¯¹è±¡æ˜¯Runnableçš„å®ä¾‹public void execute(Runnable command) &#123; // åˆ¤æ–­å‘½ä»¤ï¼ˆä»»åŠ¡ï¼‰å¯¹è±¡éç©º if (command == null) throw new NullPointerException(); // è·å–ctlçš„å€¼ int c = ctl.get(); // åˆ¤æ–­å¦‚æœå½“å‰å·¥ä½œçº¿ç¨‹æ•°å°äºæ ¸å¿ƒçº¿ç¨‹æ•°ï¼Œåˆ™åˆ›å»ºæ–°çš„æ ¸å¿ƒçº¿ç¨‹å¹¶ä¸”æ‰§è¡Œä¼ å…¥çš„ä»»åŠ¡ if (workerCountOf(c) &lt; corePoolSize) &#123; if (addWorker(command, true)) // å¦‚æœåˆ›å»ºæ–°çš„æ ¸å¿ƒçº¿ç¨‹æˆåŠŸåˆ™ç›´æ¥è¿”å› return; // è¿™é‡Œè¯´æ˜åˆ›å»ºæ ¸å¿ƒçº¿ç¨‹å¤±è´¥ï¼Œéœ€è¦æ›´æ–°ctlçš„ä¸´æ—¶å˜é‡c c = ctl.get(); &#125; // èµ°åˆ°è¿™é‡Œè¯´æ˜åˆ›å»ºæ–°çš„æ ¸å¿ƒçº¿ç¨‹å¤±è´¥ï¼Œä¹Ÿå°±æ˜¯å½“å‰å·¥ä½œçº¿ç¨‹æ•°å¤§äºç­‰äºcorePoolSize // åˆ¤æ–­çº¿ç¨‹æ± æ˜¯å¦å¤„äºè¿è¡Œä¸­çŠ¶æ€ï¼ŒåŒæ—¶å°è¯•ç”¨éé˜»å¡æ–¹æ³•å‘ä»»åŠ¡é˜Ÿåˆ—æ”¾å…¥ä»»åŠ¡ï¼ˆæ”¾å…¥ä»»åŠ¡å¤±è´¥è¿”å›falseï¼‰ if (isRunning(c) &amp;&amp; workQueue.offer(command)) &#123; int recheck = ctl.get(); // è¿™é‡Œæ˜¯å‘ä»»åŠ¡é˜Ÿåˆ—æŠ•æ”¾ä»»åŠ¡æˆåŠŸï¼Œå¯¹çº¿ç¨‹æ± çš„è¿è¡Œä¸­çŠ¶æ€åšäºŒæ¬¡æ£€æŸ¥ // å¦‚æœçº¿ç¨‹æ± äºŒæ¬¡æ£€æŸ¥çŠ¶æ€æ˜¯éè¿è¡Œä¸­çŠ¶æ€ï¼Œåˆ™ä»ä»»åŠ¡é˜Ÿåˆ—ç§»é™¤å½“å‰çš„ä»»åŠ¡è°ƒç”¨æ‹’ç»ç­–ç•¥å¤„ç†ä¹‹ï¼ˆä¹Ÿå°±æ˜¯ç§»é™¤å‰é¢æˆåŠŸå…¥é˜Ÿçš„ä»»åŠ¡å®ä¾‹ï¼‰ if (! isRunning(recheck) &amp;&amp; remove(command)) // è°ƒç”¨æ‹’ç»ç­–ç•¥å¤„ç†ä»»åŠ¡ - è¿”å› reject(command); // èµ°åˆ°ä¸‹é¢çš„else ifåˆ†æ”¯ï¼Œè¯´æ˜æœ‰ä»¥ä¸‹çš„å‰æï¼š // 0ã€å¾…æ‰§è¡Œçš„ä»»åŠ¡å·²ç»æˆåŠŸåŠ å…¥ä»»åŠ¡é˜Ÿåˆ— // 1ã€çº¿ç¨‹æ± å¯èƒ½æ˜¯RUNNINGçŠ¶æ€ // 2ã€ä¼ å…¥çš„ä»»åŠ¡å¯èƒ½ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­ç§»é™¤å¤±è´¥ï¼ˆç§»é™¤å¤±è´¥çš„å”¯ä¸€å¯èƒ½å°±æ˜¯ä»»åŠ¡å·²ç»è¢«æ‰§è¡Œäº†ï¼‰ // å¦‚æœå½“å‰å·¥ä½œçº¿ç¨‹æ•°é‡ä¸º0ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªéæ ¸å¿ƒçº¿ç¨‹å¹¶ä¸”ä¼ å…¥çš„ä»»åŠ¡å¯¹è±¡ä¸ºnull - è¿”å› // ä¹Ÿå°±æ˜¯åˆ›å»ºçš„éæ ¸å¿ƒçº¿ç¨‹ä¸ä¼šé©¬ä¸Šè¿è¡Œï¼Œè€Œæ˜¯ç­‰å¾…è·å–ä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡å»æ‰§è¡Œ // å¦‚æœå‰å·¥ä½œçº¿ç¨‹æ•°é‡ä¸ä¸º0ï¼ŒåŸæ¥åº”è¯¥æ˜¯æœ€åçš„elseåˆ†æ”¯ï¼Œä½†æ˜¯å¯ä»¥ä»€ä¹ˆä¹Ÿä¸åšï¼Œå› ä¸ºä»»åŠ¡å·²ç»æˆåŠŸå…¥é˜Ÿåˆ—ï¼Œæ€»ä¼šæœ‰åˆé€‚çš„æ—¶æœºåˆ†é…å…¶ä»–ç©ºé—²çº¿ç¨‹å»æ‰§è¡Œå®ƒ else if (workerCountOf(recheck) == 0) addWorker(null, false); &#125; // èµ°åˆ°è¿™é‡Œè¯´æ˜æœ‰ä»¥ä¸‹çš„å‰æï¼š // 0ã€çº¿ç¨‹æ± ä¸­çš„å·¥ä½œçº¿ç¨‹æ€»æ•°å·²ç»å¤§äºç­‰äºcorePoolSizeï¼ˆç®€å•æ¥è¯´å°±æ˜¯æ ¸å¿ƒçº¿ç¨‹å·²ç»å…¨éƒ¨æ‡’åˆ›å»ºå®Œæ¯•ï¼‰ // 1ã€çº¿ç¨‹æ± å¯èƒ½ä¸æ˜¯RUNNINGçŠ¶æ€ // 2ã€çº¿ç¨‹æ± å¯èƒ½æ˜¯RUNNINGçŠ¶æ€åŒæ—¶ä»»åŠ¡é˜Ÿåˆ—å·²ç»æ»¡äº† // å¦‚æœå‘ä»»åŠ¡é˜Ÿåˆ—æŠ•æ”¾ä»»åŠ¡å¤±è´¥ï¼Œåˆ™ä¼šå°è¯•åˆ›å»ºéæ ¸å¿ƒçº¿ç¨‹ä¼ å…¥ä»»åŠ¡æ‰§è¡Œ // åˆ›å»ºéæ ¸å¿ƒçº¿ç¨‹å¤±è´¥ï¼Œæ­¤æ—¶éœ€è¦æ‹’ç»æ‰§è¡Œä»»åŠ¡ else if (!addWorker(command, false)) // è°ƒç”¨æ‹’ç»ç­–ç•¥å¤„ç†ä»»åŠ¡ - è¿”å› reject(command);&#125; è¿™é‡Œç®€å•åˆ†æä¸€ä¸‹æ•´ä¸ªæµç¨‹ï¼š å¦‚æœå½“å‰å·¥ä½œçº¿ç¨‹æ€»æ•°å°äºcorePoolSizeï¼Œåˆ™ç›´æ¥åˆ›å»ºæ ¸å¿ƒçº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼ˆä»»åŠ¡å®ä¾‹ä¼šä¼ å…¥ç›´æ¥ç”¨äºæ„é€ å·¥ä½œçº¿ç¨‹å®ä¾‹ï¼‰ã€‚ å¦‚æœå½“å‰å·¥ä½œçº¿ç¨‹æ€»æ•°å¤§äºç­‰äºcorePoolSizeï¼Œåˆ¤æ–­çº¿ç¨‹æ± æ˜¯å¦å¤„äºè¿è¡Œä¸­çŠ¶æ€ï¼ŒåŒæ—¶å°è¯•ç”¨éé˜»å¡æ–¹æ³•å‘ä»»åŠ¡é˜Ÿåˆ—æ”¾å…¥ä»»åŠ¡ï¼Œè¿™é‡Œä¼šäºŒæ¬¡æ£€æŸ¥çº¿ç¨‹æ± è¿è¡ŒçŠ¶æ€ï¼Œå¦‚æœå½“å‰å·¥ä½œçº¿ç¨‹æ•°é‡ä¸º0ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªéæ ¸å¿ƒçº¿ç¨‹å¹¶ä¸”ä¼ å…¥çš„ä»»åŠ¡å¯¹è±¡ä¸ºnullã€‚ å¦‚æœå‘ä»»åŠ¡é˜Ÿåˆ—æŠ•æ”¾ä»»åŠ¡å¤±è´¥ï¼ˆä»»åŠ¡é˜Ÿåˆ—å·²ç»æ»¡äº†ï¼‰ï¼Œåˆ™ä¼šå°è¯•åˆ›å»ºéæ ¸å¿ƒçº¿ç¨‹ä¼ å…¥ä»»åŠ¡å®ä¾‹æ‰§è¡Œã€‚ å¦‚æœåˆ›å»ºéæ ¸å¿ƒçº¿ç¨‹å¤±è´¥ï¼Œæ­¤æ—¶éœ€è¦æ‹’ç»æ‰§è¡Œä»»åŠ¡ï¼Œè°ƒç”¨æ‹’ç»ç­–ç•¥å¤„ç†ä»»åŠ¡ã€‚ è¿™é‡Œæ˜¯ä¸€ä¸ªç–‘æƒ‘ç‚¹ï¼šä¸ºä»€ä¹ˆéœ€è¦äºŒæ¬¡æ£€æŸ¥çº¿ç¨‹æ± çš„è¿è¡ŒçŠ¶æ€ï¼Œå½“å‰å·¥ä½œçº¿ç¨‹æ•°é‡ä¸º0ï¼Œå°è¯•åˆ›å»ºä¸€ä¸ªéæ ¸å¿ƒçº¿ç¨‹å¹¶ä¸”ä¼ å…¥çš„ä»»åŠ¡å¯¹è±¡ä¸ºnullï¼Ÿè¿™ä¸ªå¯ä»¥çœ‹APIæ³¨é‡Šï¼š å¦‚æœä¸€ä¸ªä»»åŠ¡æˆåŠŸåŠ å…¥ä»»åŠ¡é˜Ÿåˆ—ï¼Œæˆ‘ä»¬ä¾ç„¶éœ€è¦äºŒæ¬¡æ£€æŸ¥æ˜¯å¦éœ€è¦æ·»åŠ ä¸€ä¸ªå·¥ä½œçº¿ç¨‹ï¼ˆå› ä¸ºæ‰€æœ‰å­˜æ´»çš„å·¥ä½œçº¿ç¨‹æœ‰å¯èƒ½åœ¨æœ€åä¸€æ¬¡æ£€æŸ¥ä¹‹åå·²ç»ç»ˆç»“ï¼‰æˆ–è€…æ‰§è¡Œå½“å‰æ–¹æ³•çš„æ—¶å€™çº¿ç¨‹æ± æ˜¯å¦å·²ç»shutdownäº†ã€‚æ‰€ä»¥æˆ‘ä»¬éœ€è¦äºŒæ¬¡æ£€æŸ¥çº¿ç¨‹æ± çš„çŠ¶æ€ï¼Œå¿…é¡»æ—¶æŠŠä»»åŠ¡ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­ç§»é™¤æˆ–è€…åœ¨æ²¡æœ‰å¯ç”¨çš„å·¥ä½œçº¿ç¨‹çš„å‰æä¸‹æ–°å»ºä¸€ä¸ªå·¥ä½œçº¿ç¨‹ã€‚ ä»»åŠ¡æäº¤æµç¨‹ä»è°ƒç”¨è€…çš„è§’åº¦æ¥çœ‹å¦‚ä¸‹ï¼š addWorkeræ–¹æ³•æºç åˆ†æ boolean addWorker(Runnable firstTask, boolean core)æ–¹æ³•çš„ç¬¬ä¸€çš„å‚æ•°å¯ä»¥ç”¨äºç›´æ¥ä¼ å…¥ä»»åŠ¡å®ä¾‹ï¼Œç¬¬äºŒä¸ªå‚æ•°ç”¨äºæ ‡è¯†å°†è¦åˆ›å»ºçš„å·¥ä½œçº¿ç¨‹æ˜¯å¦æ ¸å¿ƒçº¿ç¨‹ã€‚æ–¹æ³•æºç å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105// æ·»åŠ å·¥ä½œçº¿ç¨‹ï¼Œå¦‚æœè¿”å›falseè¯´æ˜æ²¡æœ‰æ–°åˆ›å»ºå·¥ä½œçº¿ç¨‹ï¼Œå¦‚æœè¿”å›trueè¯´æ˜åˆ›å»ºå’Œå¯åŠ¨å·¥ä½œçº¿ç¨‹æˆåŠŸprivate boolean addWorker(Runnable firstTask, boolean core) &#123; retry: // æ³¨æ„è¿™æ˜¯ä¸€ä¸ªæ­»å¾ªç¯ - æœ€å¤–å±‚å¾ªç¯ for (int c = ctl.get();;) &#123; // è¿™ä¸ªæ˜¯ååˆ†å¤æ‚çš„æ¡ä»¶ï¼Œè¿™é‡Œå…ˆæ‹†åˆ†å¤šä¸ªä¸ï¼ˆ&amp;&amp;ï¼‰æ¡ä»¶ï¼š // 1. çº¿ç¨‹æ± çŠ¶æ€è‡³å°‘ä¸ºSHUTDOWNçŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯rs &gt;= SHUTDOWN(0) // 2. çº¿ç¨‹æ± çŠ¶æ€è‡³å°‘ä¸ºSTOPçŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯rs &gt;= STOP(1)ï¼Œæˆ–è€…ä¼ å…¥çš„ä»»åŠ¡å®ä¾‹firstTaskä¸ä¸ºnullï¼Œæˆ–è€…ä»»åŠ¡é˜Ÿåˆ—ä¸ºç©º // å…¶å®è¿™ä¸ªåˆ¤æ–­çš„è¾¹ç•Œæ˜¯çº¿ç¨‹æ± çŠ¶æ€ä¸ºshutdownçŠ¶æ€ä¸‹ï¼Œä¸ä¼šå†æ¥å—æ–°çš„ä»»åŠ¡ï¼Œåœ¨æ­¤å‰æä¸‹å¦‚æœçŠ¶æ€å·²ç»åˆ°äº†STOPã€æˆ–è€…ä¼ å…¥ä»»åŠ¡ä¸ä¸ºç©ºã€æˆ–è€…ä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºï¼ˆå·²ç»æ²¡æœ‰ç§¯å‹ä»»åŠ¡ï¼‰éƒ½ä¸éœ€è¦æ·»åŠ æ–°çš„çº¿ç¨‹ if (runStateAtLeast(c, SHUTDOWN) &amp;&amp; (runStateAtLeast(c, STOP) || firstTask != null || workQueue.isEmpty())) return false; // æ³¨æ„è¿™ä¹Ÿæ˜¯ä¸€ä¸ªæ­»å¾ªç¯ - äºŒå±‚å¾ªç¯ for (;;) &#123; // è¿™é‡Œæ¯ä¸€è½®å¾ªç¯éƒ½ä¼šé‡æ–°è·å–å·¥ä½œçº¿ç¨‹æ•°wc // 1. å¦‚æœä¼ å…¥çš„coreä¸ºtrueï¼Œè¡¨ç¤ºå°†è¦åˆ›å»ºæ ¸å¿ƒçº¿ç¨‹ï¼Œé€šè¿‡wcå’ŒcorePoolSizeåˆ¤æ–­ï¼Œå¦‚æœwc &gt;= corePoolSizeï¼Œåˆ™è¿”å›falseè¡¨ç¤ºåˆ›å»ºæ ¸å¿ƒçº¿ç¨‹å¤±è´¥ // 1. å¦‚æœä¼ å…¥çš„coreä¸ºfalseï¼Œè¡¨ç¤ºå°†è¦åˆ›éå»ºæ ¸å¿ƒçº¿ç¨‹ï¼Œé€šè¿‡wcå’ŒmaximumPoolSizeåˆ¤æ–­ï¼Œå¦‚æœwc &gt;= maximumPoolSizeï¼Œåˆ™è¿”å›falseè¡¨ç¤ºåˆ›å»ºéæ ¸å¿ƒçº¿ç¨‹å¤±è´¥ if (workerCountOf(c) &gt;= ((core ? corePoolSize : maximumPoolSize) &amp; COUNT_MASK)) return false; // æˆåŠŸé€šè¿‡CASæ›´æ–°å·¥ä½œçº¿ç¨‹æ•°wcï¼Œåˆ™breakåˆ°æœ€å¤–å±‚çš„å¾ªç¯ if (compareAndIncrementWorkerCount(c)) break retry; // èµ°åˆ°è¿™é‡Œè¯´æ˜äº†é€šè¿‡CASæ›´æ–°å·¥ä½œçº¿ç¨‹æ•°wcå¤±è´¥ï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦é‡æ–°åˆ¤æ–­çº¿ç¨‹æ± çš„çŠ¶æ€æ˜¯å¦ç”±RUNNINGå·²ç»å˜ä¸ºSHUTDOWN c = ctl.get(); // Re-read ctl // å¦‚æœçº¿ç¨‹æ± çŠ¶æ€å·²ç»ç”±RUNNINGå·²ç»å˜ä¸ºSHUTDOWNï¼Œåˆ™é‡æ–°è·³å‡ºåˆ°å¤–å±‚å¾ªç¯ç»§ç»­æ‰§è¡Œ if (runStateAtLeast(c, SHUTDOWN)) continue retry; // å¦‚æœçº¿ç¨‹æ± çŠ¶æ€ä¾ç„¶æ˜¯RUNNINGï¼ŒCASæ›´æ–°å·¥ä½œçº¿ç¨‹æ•°wcå¤±è´¥è¯´æ˜æœ‰å¯èƒ½æ˜¯å¹¶å‘æ›´æ–°å¯¼è‡´çš„å¤±è´¥ï¼Œåˆ™åœ¨å†…å±‚å¾ªç¯é‡è¯•å³å¯ // else CAS failed due to workerCount change; retry inner loop &#125; &#125; // æ ‡è®°å·¥ä½œçº¿ç¨‹æ˜¯å¦å¯åŠ¨æˆåŠŸ boolean workerStarted = false; // æ ‡è®°å·¥ä½œçº¿ç¨‹æ˜¯å¦åˆ›å»ºæˆåŠŸ boolean workerAdded = false; Worker w = null; try &#123; // ä¼ å…¥ä»»åŠ¡å®ä¾‹firstTaskåˆ›å»ºWorkerå®ä¾‹ï¼ŒWorkeræ„é€ é‡Œé¢ä¼šé€šè¿‡çº¿ç¨‹å·¥å‚åˆ›å»ºæ–°çš„Threadå¯¹è±¡ï¼Œæ‰€ä»¥ä¸‹é¢å¯ä»¥ç›´æ¥æ“ä½œThread t = w.thread // è¿™ä¸€æ­¥Workerå®ä¾‹å·²ç»åˆ›å»ºï¼Œä½†æ˜¯æ²¡æœ‰åŠ å…¥å·¥ä½œçº¿ç¨‹é›†åˆæˆ–è€…å¯åŠ¨å®ƒæŒæœ‰çš„çº¿ç¨‹Threadå®ä¾‹ w = new Worker(firstTask); final Thread t = w.thread; if (t != null) &#123; // è¿™é‡Œéœ€è¦å…¨å±€åŠ é”ï¼Œå› ä¸ºä¼šæ”¹å˜ä¸€äº›æŒ‡æ ‡å€¼å’Œéçº¿ç¨‹å®‰å…¨çš„é›†åˆ final ReentrantLock mainLock = this.mainLock; mainLock.lock(); try &#123; // Recheck while holding lock. // Back out on ThreadFactory failure or if // shut down before lock acquired. int c = ctl.get(); // è¿™é‡Œä¸»è¦åœ¨åŠ é”çš„å‰æä¸‹åˆ¤æ–­ThreadFactoryåˆ›å»ºçš„çº¿ç¨‹æ˜¯å¦å­˜æ´»æˆ–è€…åˆ¤æ–­è·å–é”æˆåŠŸä¹‹åçº¿ç¨‹æ± çŠ¶æ€æ˜¯å¦å·²ç»æ›´å˜ä¸ºSHUTDOWN // 1. å¦‚æœçº¿ç¨‹æ± çŠ¶æ€ä¾ç„¶ä¸ºRUNNINGï¼Œåˆ™åªéœ€è¦åˆ¤æ–­çº¿ç¨‹å®ä¾‹æ˜¯å¦å­˜æ´»ï¼Œéœ€è¦æ·»åŠ åˆ°å·¥ä½œçº¿ç¨‹é›†åˆå’Œå¯åŠ¨æ–°çš„Worker // 2. å¦‚æœçº¿ç¨‹æ± çŠ¶æ€å°äºSTOPï¼Œä¹Ÿå°±æ˜¯RUNNINGæˆ–è€…SHUTDOWNçŠ¶æ€ä¸‹ï¼ŒåŒæ—¶ä¼ å…¥çš„ä»»åŠ¡å®ä¾‹firstTaskä¸ºnullï¼Œåˆ™éœ€è¦æ·»åŠ åˆ°å·¥ä½œçº¿ç¨‹é›†åˆå’Œå¯åŠ¨æ–°çš„Worker // å¯¹äº2ï¼Œæ¢è¨€ä¹‹ï¼Œå¦‚æœçº¿ç¨‹æ± å¤„äºSHUTDOWNçŠ¶æ€ä¸‹ï¼ŒåŒæ—¶ä¼ å…¥çš„ä»»åŠ¡å®ä¾‹firstTaskä¸ä¸ºnullï¼Œåˆ™ä¸ä¼šæ·»åŠ åˆ°å·¥ä½œçº¿ç¨‹é›†åˆå’Œå¯åŠ¨æ–°çš„Worker // è¿™ä¸€æ­¥å…¶å®æœ‰å¯èƒ½åˆ›å»ºäº†æ–°çš„Workerå®ä¾‹ä½†æ˜¯å¹¶ä¸å¯åŠ¨ï¼ˆä¸´æ—¶å¯¹è±¡ï¼Œæ²¡æœ‰ä»»ä½•å¼ºå¼•ç”¨ï¼‰ï¼Œè¿™ç§Workeræœ‰å¯èƒ½æˆåŠŸä¸‹ä¸€è½®GCè¢«æ”¶é›†çš„åƒåœ¾å¯¹è±¡ if (isRunning(c) || (runStateLessThan(c, STOP) &amp;&amp; firstTask == null)) &#123; if (t.isAlive()) // precheck that t is startable throw new IllegalThreadStateException(); // æŠŠåˆ›å»ºçš„å·¥ä½œçº¿ç¨‹å®ä¾‹æ·»åŠ åˆ°å·¥ä½œçº¿ç¨‹é›†åˆ workers.add(w); int s = workers.size(); // å°è¯•æ›´æ–°å†å²å³°å€¼å·¥ä½œçº¿ç¨‹æ•°ï¼Œä¹Ÿå°±æ˜¯çº¿ç¨‹æ± å³°å€¼å®¹é‡ if (s &gt; largestPoolSize) largestPoolSize = s; // è¿™é‡Œæ›´æ–°å·¥ä½œçº¿ç¨‹æ˜¯å¦å¯åŠ¨æˆåŠŸæ ‡è¯†ä¸ºtrueï¼Œåé¢æ‰ä¼šè°ƒç”¨Thread#start()æ–¹æ³•å¯åŠ¨çœŸå®çš„çº¿ç¨‹å®ä¾‹ workerAdded = true; &#125; &#125; finally &#123; mainLock.unlock(); &#125; // å¦‚æœæˆåŠŸæ·»åŠ å·¥ä½œçº¿ç¨‹ï¼Œåˆ™è°ƒç”¨Workerå†…éƒ¨çš„çº¿ç¨‹å®ä¾‹tçš„Thread#start()æ–¹æ³•å¯åŠ¨çœŸå®çš„çº¿ç¨‹å®ä¾‹ if (workerAdded) &#123; t.start(); // æ ‡è®°çº¿ç¨‹å¯åŠ¨æˆåŠŸ workerStarted = true; &#125; &#125; &#125; finally &#123; // çº¿ç¨‹å¯åŠ¨å¤±è´¥ï¼Œéœ€è¦ä»å·¥ä½œçº¿ç¨‹é›†åˆç§»é™¤å¯¹åº”çš„Worker if (! workerStarted) addWorkerFailed(w); &#125; return workerStarted;&#125;// æ·»åŠ Workerå¤±è´¥private void addWorkerFailed(Worker w) &#123; final ReentrantLock mainLock = this.mainLock; mainLock.lock(); try &#123; // ä»å·¥ä½œçº¿ç¨‹é›†åˆç§»é™¤ä¹‹ if (w != null) workers.remove(w); // wcæ•°é‡å‡1 decrementWorkerCount(); // åŸºäºçŠ¶æ€åˆ¤æ–­å°è¯•ç»ˆç»“çº¿ç¨‹æ±  tryTerminate(); &#125; finally &#123; mainLock.unlock(); &#125;&#125; ç¬”è€…å‘ç°äº†Doug Leaå¤§ç¥ååˆ†å–œæ¬¢å¤æ‚çš„æ¡ä»¶åˆ¤æ–­ï¼Œè€Œä¸”å•è¡Œå¤æ‚åˆ¤æ–­ä¸å–œæ¬¢åŠ èŠ±æ‹¬å·ï¼Œåƒä¸‹é¢è¿™ç§ä»£ç åœ¨ä»–ç¼–å†™çš„å¾ˆå¤šç±»åº“ä¸­éƒ½æ¯”è¾ƒå¸¸è§ï¼š 123456789101112if (runStateAtLeast(c, SHUTDOWN) &amp;&amp; (runStateAtLeast(c, STOP) || firstTask != null || workQueue.isEmpty())) return false;// ....// ä»£ç æ‹†åˆ†ä¸€ä¸‹å¦‚ä¸‹ boolean atLeastShutdown = runStateAtLeast(c, SHUTDOWN); # rs &gt;= SHUTDOWN(0)boolean atLeastStop = runStateAtLeast(c, STOP) || firstTask != null || workQueue.isEmpty(); if (atLeastShutdown &amp;&amp; atLeastStop)&#123; return false;&#125; ä¸Šé¢çš„åˆ†æé€»è¾‘ä¸­éœ€è¦æ³¨æ„ä¸€ç‚¹ï¼ŒWorkerå®ä¾‹åˆ›å»ºçš„åŒæ—¶ï¼Œåœ¨å…¶æ„é€ å‡½æ•°ä¸­ä¼šé€šè¿‡ThreadFactoryåˆ›å»ºä¸€ä¸ªJavaçº¿ç¨‹Threadå®ä¾‹ï¼Œåé¢ä¼šåŠ é”åäºŒæ¬¡æ£€æŸ¥æ˜¯å¦éœ€è¦æŠŠWorkerå®ä¾‹æ·»åŠ åˆ°å·¥ä½œçº¿ç¨‹é›†åˆworkersä¸­å’Œæ˜¯å¦éœ€è¦å¯åŠ¨Workerä¸­æŒæœ‰çš„Threadå®ä¾‹ï¼Œåªæœ‰å¯åŠ¨äº†Threadå®ä¾‹å®ä¾‹ï¼ŒWorkeræ‰çœŸæ­£å¼€å§‹è¿ä½œï¼Œå¦åˆ™åªæ˜¯ä¸€ä¸ªæ— ç”¨çš„ä¸´æ—¶å¯¹è±¡ã€‚Workeræœ¬èº«ä¹Ÿå®ç°äº†Runnableæ¥å£ï¼Œå®ƒå¯ä»¥çœ‹æˆæ˜¯ä¸€ä¸ªRunnableçš„é€‚é…å™¨ã€‚ å·¥ä½œçº¿ç¨‹å†…éƒ¨ç±»Workeræºç åˆ†æ çº¿ç¨‹æ± ä¸­çš„æ¯ä¸€ä¸ªå…·ä½“çš„å·¥ä½œçº¿ç¨‹è¢«åŒ…è£…ä¸ºå†…éƒ¨ç±»Workerå®ä¾‹ï¼ŒWorkerç»§æ‰¿äºAbstractQueuedSynchronizer(AQS)ï¼Œå®ç°äº†Runnableæ¥å£ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576private final class Worker extends AbstractQueuedSynchronizer implements Runnable&#123; /** * This class will never be serialized, but we provide a * serialVersionUID to suppress a javac warning. */ private static final long serialVersionUID = 6138294804551838833L; // ä¿å­˜ThreadFactoryåˆ›å»ºçš„çº¿ç¨‹å®ä¾‹ï¼Œå¦‚æœThreadFactoryåˆ›å»ºçº¿ç¨‹å¤±è´¥åˆ™ä¸ºnull final Thread thread; // ä¿å­˜ä¼ å…¥çš„Runnableä»»åŠ¡å®ä¾‹ Runnable firstTask; // è®°å½•æ¯ä¸ªçº¿ç¨‹å®Œæˆçš„ä»»åŠ¡æ€»æ•° volatile long completedTasks; // å”¯ä¸€çš„æ„é€ å‡½æ•°ï¼Œä¼ å…¥ä»»åŠ¡å®ä¾‹firstTaskï¼Œæ³¨æ„å¯ä»¥ä¸ºnull Worker(Runnable firstTask) &#123; // ç¦æ­¢çº¿ç¨‹ä¸­æ–­ï¼Œç›´åˆ°runWorker()æ–¹æ³•æ‰§è¡Œ setState(-1); // inhibit interrupts until runWorker this.firstTask = firstTask; // é€šè¿‡ThreadFactoryåˆ›å»ºçº¿ç¨‹å®ä¾‹ï¼Œæ³¨æ„ä¸€ä¸‹Workerå®ä¾‹è‡ªèº«ä½œä¸ºRunnableç”¨äºåˆ›å»ºæ–°çš„çº¿ç¨‹å®ä¾‹ this.thread = getThreadFactory().newThread(this); &#125; // å§”æ‰˜åˆ°å¤–éƒ¨çš„runWorker()æ–¹æ³•ï¼Œæ³¨æ„runWorker()æ–¹æ³•æ˜¯çº¿ç¨‹æ± çš„æ–¹æ³•ï¼Œè€Œä¸æ˜¯Workerçš„æ–¹æ³• public void run() &#123; runWorker(this); &#125; // Lock methods // // The value 0 represents the unlocked state. // The value 1 represents the locked state. // æ˜¯å¦æŒæœ‰ç‹¬å é”ï¼Œstateå€¼ä¸º1çš„æ—¶å€™è¡¨ç¤ºæŒæœ‰é”ï¼Œstateå€¼ä¸º0çš„æ—¶å€™è¡¨ç¤ºå·²ç»é‡Šæ”¾é” protected boolean isHeldExclusively() &#123; return getState() != 0; &#125; // ç‹¬å æ¨¡å¼ä¸‹å°è¯•è·å–èµ„æºï¼Œè¿™é‡Œæ²¡æœ‰åˆ¤æ–­ä¼ å…¥çš„å˜é‡ï¼Œç›´æ¥CASåˆ¤æ–­0æ›´æ–°ä¸º1æ˜¯å¦æˆåŠŸï¼ŒæˆåŠŸåˆ™è®¾ç½®ç‹¬å çº¿ç¨‹ä¸ºå½“å‰çº¿ç¨‹ protected boolean tryAcquire(int unused) &#123; if (compareAndSetState(0, 1)) &#123; setExclusiveOwnerThread(Thread.currentThread()); return true; &#125; return false; &#125; // ç‹¬å æ¨¡å¼ä¸‹å°è¯•æ˜¯å¦èµ„æºï¼Œè¿™é‡Œæ²¡æœ‰åˆ¤æ–­ä¼ å…¥çš„å˜é‡ï¼Œç›´æ¥æŠŠstateè®¾ç½®ä¸º0 protected boolean tryRelease(int unused) &#123; setExclusiveOwnerThread(null); setState(0); return true; &#125; // åŠ é” public void lock() &#123; acquire(1); &#125; // å°è¯•åŠ é” public boolean tryLock() &#123; return tryAcquire(1); &#125; // è§£é” public void unlock() &#123; release(1); &#125; // æ˜¯å¦é”å®š public boolean isLocked() &#123; return isHeldExclusively(); &#125; // å¯åŠ¨åè¿›è¡Œçº¿ç¨‹ä¸­æ–­ï¼Œæ³¨æ„è¿™é‡Œä¼šåˆ¤æ–­çº¿ç¨‹å®ä¾‹çš„ä¸­æ–­æ ‡å¿—ä½æ˜¯å¦ä¸ºfalseï¼Œåªæœ‰ä¸­æ–­æ ‡å¿—ä½ä¸ºfalseæ‰ä¼šä¸­æ–­ void interruptIfStarted() &#123; Thread t; if (getState() &gt;= 0 &amp;&amp; (t = thread) != null &amp;&amp; !t.isInterrupted()) &#123; try &#123; t.interrupt(); &#125; catch (SecurityException ignore) &#123; &#125; &#125; &#125;&#125; Workerçš„æ„é€ å‡½æ•°é‡Œé¢çš„é€»è¾‘ååˆ†é‡è¦ï¼Œé€šè¿‡ThreadFactoryåˆ›å»ºçš„Threadå®ä¾‹åŒæ—¶ä¼ å…¥Workerå®ä¾‹ï¼Œå› ä¸ºWorkeræœ¬èº«å®ç°äº†Runnableï¼Œæ‰€ä»¥å¯ä»¥ä½œä¸ºä»»åŠ¡æäº¤åˆ°çº¿ç¨‹ä¸­æ‰§è¡Œã€‚åªè¦WorkeræŒæœ‰çš„çº¿ç¨‹å®ä¾‹wè°ƒç”¨Thread#start()æ–¹æ³•å°±èƒ½åœ¨åˆé€‚æ—¶æœºæ‰§è¡ŒWorker#run()ã€‚ç®€åŒ–ä¸€ä¸‹é€»è¾‘å¦‚ä¸‹ï¼š 12345678// addWorker()æ–¹æ³•ä¸­æ„é€ Worker worker = createWorker();// é€šè¿‡çº¿ç¨‹æ± æ„é€ æ—¶å€™ä¼ å…¥ThreadFactory threadFactory = getThreadFactory();// Workeræ„é€ å‡½æ•°ä¸­Thread thread = threadFactory.newThread(worker);// addWorker()æ–¹æ³•ä¸­å¯åŠ¨thread.start(); Workerç»§æ‰¿è‡ªAQSï¼Œè¿™é‡Œä½¿ç”¨äº†AQSçš„ç‹¬å æ¨¡å¼ï¼Œæœ‰ä¸ªæŠ€å·§æ˜¯æ„é€ Workerçš„æ—¶å€™ï¼ŒæŠŠAQSçš„èµ„æºï¼ˆçŠ¶æ€ï¼‰é€šè¿‡setState(-1)è®¾ç½®ä¸º-1ï¼Œè¿™æ˜¯å› ä¸ºWorkerå®ä¾‹åˆšåˆ›å»ºæ—¶AQSä¸­stateçš„é»˜è®¤å€¼ä¸º0ï¼Œæ­¤æ—¶çº¿ç¨‹å°šæœªå¯åŠ¨ï¼Œä¸èƒ½åœ¨è¿™ä¸ªæ—¶å€™è¿›è¡Œçº¿ç¨‹ä¸­æ–­ï¼Œè§Worker#interruptIfStarted()æ–¹æ³•ã€‚Workerä¸­ä¸¤ä¸ªè¦†ç›–AQSçš„æ–¹æ³•tryAcquire()å’ŒtryRelease()éƒ½æ²¡æœ‰åˆ¤æ–­å¤–éƒ¨ä¼ å…¥çš„å˜é‡ï¼Œå‰è€…ç›´æ¥CAS(0,1)ï¼Œåè€…ç›´æ¥setState(0)ã€‚æ¥ç€çœ‹æ ¸å¿ƒæ–¹æ³•ThreadPoolExecutor#runWorker()ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556final void runWorker(Worker w) &#123; // è·å–å½“å‰çº¿ç¨‹ï¼Œå®é™…ä¸Šå’ŒWorkeræŒæœ‰çš„çº¿ç¨‹å®ä¾‹æ˜¯ç›¸åŒçš„ Thread wt = Thread.currentThread(); // è·å–Workerä¸­æŒæœ‰çš„åˆå§‹åŒ–æ—¶ä¼ å…¥çš„ä»»åŠ¡å¯¹è±¡ï¼Œè¿™é‡Œæ³¨æ„å­˜æ”¾åœ¨ä¸´æ—¶å˜é‡taskä¸­ Runnable task = w.firstTask; // è®¾ç½®Workerä¸­æŒæœ‰çš„åˆå§‹åŒ–æ—¶ä¼ å…¥çš„ä»»åŠ¡å¯¹è±¡ä¸ºnull w.firstTask = null; // ç”±äºWorkeråˆå§‹åŒ–æ—¶AQSä¸­stateè®¾ç½®ä¸º-1ï¼Œè¿™é‡Œè¦å…ˆåšä¸€æ¬¡è§£é”æŠŠstateæ›´æ–°ä¸º0ï¼Œå…è®¸çº¿ç¨‹ä¸­æ–­ w.unlock(); // allow interrupts // è®°å½•çº¿ç¨‹æ˜¯å¦å› ä¸ºç”¨æˆ·å¼‚å¸¸ç»ˆç»“ï¼Œé»˜è®¤æ˜¯true boolean completedAbruptly = true; try &#123; // åˆå§‹åŒ–ä»»åŠ¡å¯¹è±¡ä¸ä¸ºnullï¼Œæˆ–è€…ä»ä»»åŠ¡é˜Ÿåˆ—è·å–ä»»åŠ¡ä¸ä¸ºç©ºï¼ˆä»ä»»åŠ¡é˜Ÿåˆ—è·å–åˆ°çš„ä»»åŠ¡ä¼šæ›´æ–°åˆ°ä¸´æ—¶å˜é‡taskä¸­ï¼‰ // getTask()ç”±äºä½¿ç”¨äº†é˜»å¡é˜Ÿåˆ—ï¼Œè¿™ä¸ªwhileå¾ªç¯å¦‚æœå‘½ä¸­ååŠæ®µä¼šå¤„äºé˜»å¡æˆ–è€…è¶…æ—¶é˜»å¡çŠ¶æ€ï¼ŒgetTask()è¿”å›ä¸ºnullä¼šå¯¼è‡´çº¿ç¨‹è·³å‡ºæ­»å¾ªç¯ä½¿çº¿ç¨‹ç»ˆç»“ while (task != null || (task = getTask()) != null) &#123; // WorkeråŠ é”ï¼Œæœ¬è´¨æ˜¯AQSè·å–èµ„æºå¹¶ä¸”å°è¯•CASæ›´æ–°stateç”±0æ›´å˜ä¸º1 w.lock(); // If pool is stopping, ensure thread is interrupted; // if not, ensure thread is not interrupted. This // requires a recheck in second case to deal with // shutdownNow race while clearing interrupt // å¦‚æœçº¿ç¨‹æ± æ­£åœ¨åœæ­¢ï¼ˆä¹Ÿå°±æ˜¯ç”±RUNNINGæˆ–è€…SHUTDOWNçŠ¶æ€å‘STOPçŠ¶æ€å˜æ›´ï¼‰ï¼Œé‚£ä¹ˆè¦ç¡®ä¿å½“å‰å·¥ä½œçº¿ç¨‹æ˜¯ä¸­æ–­çŠ¶æ€ // å¦åˆ™ï¼Œè¦ä¿è¯å½“å‰çº¿ç¨‹ä¸æ˜¯ä¸­æ–­çŠ¶æ€ if ((runStateAtLeast(ctl.get(), STOP) || (Thread.interrupted() &amp;&amp; runStateAtLeast(ctl.get(), STOP))) &amp;&amp; !wt.isInterrupted()) wt.interrupt(); try &#123; // é’©å­æ–¹æ³•ï¼Œä»»åŠ¡æ‰§è¡Œå‰ beforeExecute(wt, task); try &#123; task.run(); // é’©å­æ–¹æ³•ï¼Œä»»åŠ¡æ‰§è¡Œå - æ­£å¸¸æƒ…å†µ afterExecute(task, null); &#125; catch (Throwable ex) &#123; // é’©å­æ–¹æ³•ï¼Œä»»åŠ¡æ‰§è¡Œå - å¼‚å¸¸æƒ…å†µ afterExecute(task, ex); throw ex; &#125; &#125; finally &#123; // æ¸…ç©ºtaskä¸´æ—¶å˜é‡ï¼Œè¿™ä¸ªå¾ˆé‡è¦ï¼Œå¦åˆ™whileä¼šæ­»å¾ªç¯æ‰§è¡ŒåŒä¸€ä¸ªtask task = null; // ç´¯åŠ Workerå®Œæˆçš„ä»»åŠ¡æ•° w.completedTasks++; // Workerè§£é”ï¼Œæœ¬è´¨æ˜¯AQSé‡Šæ”¾èµ„æºï¼Œè®¾ç½®stateä¸º0 w.unlock(); &#125; &#125; // èµ°åˆ°è¿™é‡Œè¯´æ˜æŸä¸€æ¬¡getTask()è¿”å›ä¸ºnullï¼Œçº¿ç¨‹æ­£å¸¸é€€å‡º completedAbruptly = false; &#125; finally &#123; // å¤„ç†çº¿ç¨‹é€€å‡ºï¼ŒcompletedAbruptlyä¸ºtrueè¯´æ˜ç”±äºç”¨æˆ·å¼‚å¸¸å¯¼è‡´çº¿ç¨‹éæ­£å¸¸é€€å‡º processWorkerExit(w, completedAbruptly); &#125;&#125; è¿™é‡Œé‡ç‚¹æ‹†è§£åˆ†æä¸€ä¸‹åˆ¤æ–­å½“å‰å·¥ä½œçº¿ç¨‹ä¸­æ–­çŠ¶æ€çš„ä»£ç ï¼š 12345678910111213if ((runStateAtLeast(ctl.get(), STOP) || (Thread.interrupted() &amp;&amp; runStateAtLeast(ctl.get(), STOP))) &amp;&amp; !wt.isInterrupted()) wt.interrupt();// å…ˆç®€åŒ–ä¸€ä¸‹åˆ¤æ–­é€»è¾‘ï¼Œå¦‚ä¸‹// åˆ¤æ–­çº¿ç¨‹æ± çŠ¶æ€æ˜¯å¦è‡³å°‘ä¸ºSTOPï¼Œrs &gt;= STOP(1)boolean atLeastStop = runStateAtLeast(ctl.get(), STOP);// åˆ¤æ–­çº¿ç¨‹æ± çŠ¶æ€æ˜¯å¦è‡³å°‘ä¸ºSTOPï¼ŒåŒæ—¶åˆ¤æ–­å½“å‰çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€å¹¶ä¸”æ¸…ç©ºå½“å‰çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€boolean interruptedAndAtLeastStop = Thread.interrupted() &amp;&amp; runStateAtLeast(ctl.get(), STOP);if (atLeastStop || interruptedAndAtLeastStop &amp;&amp; !wt.isInterrupted())&#123; wt.interrupt();&#125; Thread.interrupted()æ–¹æ³•è·å–çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€åŒæ—¶ä¼šæ¸…ç©ºè¯¥ä¸­æ–­çŠ¶æ€ï¼Œè¿™é‡Œä¹‹æ‰€ä»¥ä¼šè°ƒç”¨è¿™ä¸ªæ–¹æ³•æ˜¯å› ä¸ºåœ¨æ‰§è¡Œä¸Šé¢è¿™ä¸ªifé€»è¾‘åŒæ—¶å¤–éƒ¨æœ‰å¯èƒ½è°ƒç”¨shutdownNow()æ–¹æ³•ï¼ŒshutdownNow()æ–¹æ³•ä¸­ä¹Ÿå­˜åœ¨ä¸­æ–­æ‰€æœ‰Workerçº¿ç¨‹çš„é€»è¾‘ï¼Œä½†æ˜¯ç”±äºshutdownNow()æ–¹æ³•ä¸­ä¼šéå†æ‰€æœ‰Workeråšçº¿ç¨‹ä¸­æ–­ï¼Œæœ‰å¯èƒ½æ— æ³•åŠæ—¶åœ¨ä»»åŠ¡æäº¤åˆ°Workeræ‰§è¡Œä¹‹å‰è¿›è¡Œä¸­æ–­ï¼Œæ‰€ä»¥è¿™ä¸ªä¸­æ–­é€»è¾‘ä¼šåœ¨Workerå†…éƒ¨æ‰§è¡Œï¼Œå°±æ˜¯ifä»£ç å—çš„é€»è¾‘ã€‚è¿™é‡Œè¿˜è¦æ³¨æ„çš„æ˜¯ï¼šSTOPçŠ¶æ€ä¸‹ä¼šæ‹’ç»æ‰€æœ‰æ–°æäº¤çš„ä»»åŠ¡ï¼Œä¸ä¼šå†æ‰§è¡Œä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡ï¼ŒåŒæ—¶ä¼šä¸­æ–­æ‰€æœ‰Workerçº¿ç¨‹ã€‚ä¹Ÿå°±æ˜¯ï¼Œå³ä½¿ä»»åŠ¡Runnableå·²ç»runWorker()ä¸­å‰åŠæ®µé€»è¾‘å–å‡ºï¼Œåªè¦è¿˜æ²¡èµ°åˆ°è°ƒç”¨å…¶Runnable#run()ï¼Œéƒ½æœ‰å¯èƒ½è¢«ä¸­æ–­ã€‚å‡è®¾åˆšå¥½å‘ç”Ÿäº†è¿›å…¥ifä»£ç å—çš„é€»è¾‘åŒæ—¶å¤–éƒ¨è°ƒç”¨äº†shutdownNow()æ–¹æ³•ï¼Œé‚£ä¹ˆifé€»è¾‘å†…ä¼šåˆ¤æ–­çº¿ç¨‹ä¸­æ–­çŠ¶æ€å¹¶ä¸”é‡ç½®ï¼Œé‚£ä¹ˆshutdownNow()æ–¹æ³•ä¸­è°ƒç”¨çš„interruptWorkers()å°±ä¸ä¼šå› ä¸ºä¸­æ–­çŠ¶æ€åˆ¤æ–­å‡ºç°é—®é¢˜å¯¼è‡´äºŒæ¬¡ä¸­æ–­çº¿ç¨‹ï¼ˆä¼šå¯¼è‡´å¼‚å¸¸ï¼‰ã€‚ å°ç»“ä¸€ä¸‹ä¸Šé¢runWorker()æ–¹æ³•çš„æ ¸å¿ƒæµç¨‹ï¼š Workerå…ˆæ‰§è¡Œä¸€æ¬¡è§£é”æ“ä½œï¼Œç”¨äºè§£é™¤ä¸å¯ä¸­æ–­çŠ¶æ€ã€‚ é€šè¿‡whileå¾ªç¯è°ƒç”¨getTask()æ–¹æ³•ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡ï¼ˆå½“ç„¶ï¼Œé¦–è½®å¾ªç¯ä¹Ÿæœ‰å¯èƒ½æ˜¯å¤–éƒ¨ä¼ å…¥çš„firstTaskä»»åŠ¡å®ä¾‹ï¼‰ã€‚ å¦‚æœçº¿ç¨‹æ± æ›´å˜ä¸ºSTOPçŠ¶æ€ï¼Œåˆ™éœ€è¦ç¡®ä¿å·¥ä½œçº¿ç¨‹æ˜¯ä¸­æ–­çŠ¶æ€å¹¶ä¸”è¿›è¡Œä¸­æ–­å¤„ç†ï¼Œå¦åˆ™è¦ä¿è¯å·¥ä½œçº¿ç¨‹å¿…é¡»ä¸æ˜¯ä¸­æ–­çŠ¶æ€ã€‚ æ‰§è¡Œä»»åŠ¡å®ä¾‹Runnale#run()æ–¹æ³•ï¼Œä»»åŠ¡å®ä¾‹æ‰§è¡Œä¹‹å‰å’Œä¹‹åï¼ˆåŒ…æ‹¬æ­£å¸¸æ‰§è¡Œå®Œæ¯•å’Œå¼‚å¸¸æ‰§è¡Œæƒ…å†µï¼‰åˆ†åˆ«ä¼šè°ƒç”¨é’©å­æ–¹æ³•beforeExecute()å’ŒafterExecute()ã€‚ whileå¾ªç¯è·³å‡ºæ„å‘³ç€runWorker()æ–¹æ³•ç»“æŸå’Œå·¥ä½œçº¿ç¨‹ç”Ÿå‘½å‘¨æœŸç»“æŸï¼ˆWorker#run()ç”Ÿå‘½å‘¨æœŸå®Œç»“ï¼‰ï¼Œä¼šè°ƒç”¨processWorkerExit()å¤„ç†å·¥ä½œçº¿ç¨‹é€€å‡ºçš„åç»­å·¥ä½œã€‚ æ¥ä¸‹æ¥åˆ†æä¸€ä¸‹ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡çš„getTask()æ–¹æ³•å’Œå¤„ç†çº¿ç¨‹é€€å‡ºçš„åç»­å·¥ä½œçš„processWorkerExit()æ–¹æ³•ã€‚ getTaskæ–¹æ³•æºç åˆ†æ getTask()æ–¹æ³•æ˜¯å·¥ä½œçº¿ç¨‹åœ¨whileæ­»å¾ªç¯ä¸­è·å–ä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡å¯¹è±¡çš„æ–¹æ³•ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253private Runnable getTask() &#123; // è®°å½•ä¸Šä¸€æ¬¡ä»é˜Ÿåˆ—ä¸­æ‹‰å–çš„æ—¶å€™æ˜¯å¦è¶…æ—¶ boolean timedOut = false; // Did the last poll() time out? // æ³¨æ„è¿™æ˜¯æ­»å¾ªç¯ for (;;) &#123; int c = ctl.get(); // Check if queue empty only if necessary. // ç¬¬ä¸€ä¸ªifï¼šå¦‚æœçº¿ç¨‹æ± çŠ¶æ€è‡³å°‘ä¸ºSHUTDOWNï¼Œä¹Ÿå°±æ˜¯rs &gt;= SHUTDOWN(0)ï¼Œåˆ™éœ€è¦åˆ¤æ–­ä¸¤ç§æƒ…å†µï¼ˆæˆ–é€»è¾‘ï¼‰ï¼š // 1. çº¿ç¨‹æ± çŠ¶æ€è‡³å°‘ä¸ºSTOP(1)ï¼Œä¹Ÿå°±æ˜¯çº¿ç¨‹æ± æ­£åœ¨åœæ­¢ï¼Œä¸€èˆ¬æ˜¯è°ƒç”¨äº†shutdownNow()æ–¹æ³• // 2. ä»»åŠ¡é˜Ÿåˆ—ä¸ºç©º // å¦‚æœåœ¨çº¿ç¨‹æ± è‡³å°‘ä¸ºSHUTDOWNçŠ¶æ€å¹¶ä¸”æ»¡è¶³ä¸Šé¢ä¸¤ä¸ªæ¡ä»¶ä¹‹ä¸€ï¼Œåˆ™å·¥ä½œçº¿ç¨‹æ•°wcå‡å»1ï¼Œç„¶åç›´æ¥è¿”å›null if (runStateAtLeast(c, SHUTDOWN) &amp;&amp; (runStateAtLeast(c, STOP) || workQueue.isEmpty())) &#123; decrementWorkerCount(); return null; &#125; // è·‘åˆ°è¿™é‡Œè¯´æ˜çº¿ç¨‹æ± è¿˜å¤„äºRUNNINGçŠ¶æ€ï¼Œé‡æ–°è·å–ä¸€æ¬¡å·¥ä½œçº¿ç¨‹æ•° int wc = workerCountOf(c); // Are workers subject to culling? // timedä¸´æ—¶å˜é‡å‹‡äºçº¿ç¨‹è¶…æ—¶æ§åˆ¶ï¼Œå†³å®šæ˜¯å¦éœ€è¦é€šè¿‡poll()æ­¤å¸¦è¶…æ—¶çš„éé˜»å¡æ–¹æ³•è¿›è¡Œä»»åŠ¡é˜Ÿåˆ—çš„ä»»åŠ¡æ‹‰å– // 1.allowCoreThreadTimeOuté»˜è®¤å€¼ä¸ºfalseï¼Œå¦‚æœè®¾ç½®ä¸ºtrueï¼Œåˆ™å…è®¸æ ¸å¿ƒçº¿ç¨‹ä¹Ÿèƒ½é€šè¿‡poll()æ–¹æ³•ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­æ‹‰å–ä»»åŠ¡ // 2.å·¥ä½œçº¿ç¨‹æ•°å¤§äºæ ¸å¿ƒçº¿ç¨‹æ•°çš„æ—¶å€™ï¼Œè¯´æ˜çº¿ç¨‹æ± ä¸­åˆ›å»ºäº†é¢å¤–çš„éæ ¸å¿ƒçº¿ç¨‹ï¼Œè¿™äº›éæ ¸å¿ƒçº¿ç¨‹ä¸€å®šæ˜¯é€šè¿‡poll()æ–¹æ³•ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­æ‹‰å–ä»»åŠ¡ boolean timed = allowCoreThreadTimeOut || wc &gt; corePoolSize; // ç¬¬äºŒä¸ªifï¼š // 1.wc &gt; maximumPoolSizeè¯´æ˜å½“å‰çš„å·¥ä½œçº¿ç¨‹æ€»æ•°å¤§äºmaximumPoolSizeï¼Œè¯´æ˜äº†é€šè¿‡setMaximumPoolSize()æ–¹æ³•å‡å°‘äº†çº¿ç¨‹æ± å®¹é‡ // æˆ–è€… 2.timed &amp;&amp; timedOutè¯´æ˜äº†çº¿ç¨‹å‘½ä¸­äº†è¶…æ—¶æ§åˆ¶å¹¶ä¸”ä¸Šä¸€è½®å¾ªç¯é€šè¿‡poll()æ–¹æ³•ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­æ‹‰å–ä»»åŠ¡ä¸ºnull // å¹¶ä¸” 3. å·¥ä½œçº¿ç¨‹æ€»æ•°å¤§äº1æˆ–è€…ä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™é€šè¿‡CASæŠŠçº¿ç¨‹æ•°å‡å»1ï¼ŒåŒæ—¶è¿”å›nullï¼Œ // CASæŠŠçº¿ç¨‹æ•°å‡å»1å¤±è´¥ä¼šè¿›å…¥ä¸‹ä¸€è½®å¾ªç¯åšé‡è¯• if ((wc &gt; maximumPoolSize || (timed &amp;&amp; timedOut)) &amp;&amp; (wc &gt; 1 || workQueue.isEmpty())) &#123; if (compareAndDecrementWorkerCount(c)) return null; continue; &#125; try &#123; // å¦‚æœtimedä¸ºtrueï¼Œé€šè¿‡poll()æ–¹æ³•åšè¶…æ—¶æ‹‰å–ï¼ŒkeepAliveTimeæ—¶é—´å†…æ²¡æœ‰ç­‰å¾…åˆ°æœ‰æ•ˆçš„ä»»åŠ¡ï¼Œåˆ™è¿”å›null // å¦‚æœtimedä¸ºfalseï¼Œé€šè¿‡take()åšé˜»å¡æ‹‰å–ï¼Œä¼šé˜»å¡åˆ°æœ‰ä¸‹ä¸€ä¸ªæœ‰æ•ˆçš„ä»»åŠ¡æ—¶å€™å†è¿”å›ï¼ˆä¸€èˆ¬ä¸ä¼šæ˜¯nullï¼‰ Runnable r = timed ? workQueue.poll(keepAliveTime, TimeUnit.NANOSECONDS) : workQueue.take(); // è¿™é‡Œå¾ˆé‡è¦ï¼Œåªæœ‰énullæ—¶å€™æ‰è¿”å›ï¼Œnullçš„æƒ…å†µä¸‹ä¼šè¿›å…¥ä¸‹ä¸€è½®å¾ªç¯ if (r != null) return r; // è·‘åˆ°è¿™é‡Œè¯´æ˜ä¸Šä¸€æ¬¡ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­è·å–åˆ°çš„ä»»åŠ¡ä¸ºnullï¼Œä¸€èˆ¬æ˜¯workQueue.poll()æ–¹æ³•è¶…æ—¶è¿”å›null timedOut = true; &#125; catch (InterruptedException retry) &#123; timedOut = false; &#125; &#125;&#125; è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œæœ‰ä¸¤å¤„ååˆ†åºå¤§çš„ifé€»è¾‘ï¼Œå¯¹äºç¬¬ä¸€å¤„ifå¯èƒ½å¯¼è‡´å·¥ä½œçº¿ç¨‹æ•°å‡å»1ç›´æ¥è¿”å›nullçš„åœºæ™¯æœ‰ï¼š çº¿ç¨‹æ± çŠ¶æ€ä¸ºSHUTDOWNï¼Œä¸€èˆ¬æ˜¯è°ƒç”¨äº†shutdown()æ–¹æ³•ï¼Œå¹¶ä¸”ä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºã€‚ çº¿ç¨‹æ± çŠ¶æ€ä¸ºSTOPã€‚ å¯¹äºç¬¬äºŒå¤„ifï¼Œé€»è¾‘æœ‰ç‚¹å¤æ‚ï¼Œå…ˆæ‹†è§£ä¸€ä¸‹ï¼š 12345678910111213141516// å·¥ä½œçº¿ç¨‹æ€»æ•°å¤§äºmaximumPoolSizeï¼Œè¯´æ˜äº†é€šè¿‡setMaximumPoolSize()æ–¹æ³•å‡å°‘äº†çº¿ç¨‹æ± å®¹é‡boolean b1 = wc &gt; maximumPoolSize;// å…è®¸çº¿ç¨‹è¶…æ—¶åŒæ—¶ä¸Šä¸€è½®é€šè¿‡poll()æ–¹æ³•ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­æ‹‰å–ä»»åŠ¡ä¸ºnullboolean b2 = timed &amp;&amp; timedOut;// å·¥ä½œçº¿ç¨‹æ€»æ•°å¤§äº1boolean b3 = wc &gt; 1;// ä»»åŠ¡é˜Ÿåˆ—ä¸ºç©ºboolean b4 = workQueue.isEmpty();boolean r = (b1 || b2) &amp;&amp; (b3 || b4);if (r) &#123; if (compareAndDecrementWorkerCount(c))&#123; return null; &#125;else&#123; continue; &#125;&#125; è¿™æ®µé€»è¾‘å¤§å¤šæ•°æƒ…å†µä¸‹æ˜¯é’ˆå¯¹éæ ¸å¿ƒçº¿ç¨‹ã€‚åœ¨execute()æ–¹æ³•ä¸­ï¼Œå½“çº¿ç¨‹æ± æ€»æ•°å·²ç»è¶…è¿‡äº†corePoolSizeå¹¶ä¸”è¿˜å°äºmaximumPoolSizeæ—¶ï¼Œå½“ä»»åŠ¡é˜Ÿåˆ—å·²ç»æ»¡äº†çš„æ—¶å€™ï¼Œä¼šé€šè¿‡addWorker(task,false)æ·»åŠ éæ ¸å¿ƒçº¿ç¨‹ã€‚è€Œè¿™é‡Œçš„é€»è¾‘æ°å¥½ç±»ä¼¼äºaddWorker(task,false)çš„åå‘æ“ä½œï¼Œç”¨äºå‡å°‘éæ ¸å¿ƒçº¿ç¨‹ï¼Œä½¿å¾—å·¥ä½œçº¿ç¨‹æ€»æ•°è¶‹å‘äºcorePoolSizeã€‚å¦‚æœå¯¹äºéæ ¸å¿ƒçº¿ç¨‹ï¼Œä¸Šä¸€è½®å¾ªç¯è·å–ä»»åŠ¡å¯¹è±¡ä¸ºnullï¼Œè¿™ä¸€è½®å¾ªç¯å¾ˆå®¹æ˜“æ»¡è¶³timed &amp;&amp; timedOutä¸ºtrueï¼Œè¿™ä¸ªæ—¶å€™getTask()è¿”å›nullä¼šå¯¼è‡´Worker#runWorker()æ–¹æ³•è·³å‡ºæ­»å¾ªç¯ï¼Œä¹‹åæ‰§è¡ŒprocessWorkerExit()æ–¹æ³•å¤„ç†åç»­å·¥ä½œï¼Œè€Œè¯¥éæ ¸å¿ƒçº¿ç¨‹å¯¹åº”çš„Workeråˆ™å˜æˆâ€œæ¸¸ç¦»å¯¹è±¡â€ï¼Œç­‰å¾…è¢«JVMå›æ”¶ã€‚å½“allowCoreThreadTimeOutè®¾ç½®ä¸ºtrueçš„æ—¶å€™ï¼Œè¿™é‡Œåˆ†æçš„éæ ¸å¿ƒçº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸç»ˆç»“é€»è¾‘åŒæ—¶ä¼šé€‚ç”¨äºæ ¸å¿ƒçº¿ç¨‹ã€‚é‚£ä¹ˆå¯ä»¥æ€»ç»“å‡ºkeepAliveTimeçš„æ„ä¹‰ï¼š å½“å…è®¸æ ¸å¿ƒçº¿ç¨‹è¶…æ—¶ï¼Œä¹Ÿå°±æ˜¯allowCoreThreadTimeOutè®¾ç½®ä¸ºtrueçš„æ—¶å€™ï¼Œæ­¤æ—¶keepAliveTimeè¡¨ç¤ºç©ºé—²çš„å·¥ä½œçº¿ç¨‹çš„å­˜æ´»å‘¨æœŸã€‚ é»˜è®¤æƒ…å†µä¸‹ä¸å…è®¸æ ¸å¿ƒçº¿ç¨‹è¶…æ—¶ï¼Œæ­¤æ—¶keepAliveTimeè¡¨ç¤ºç©ºé—²çš„éæ ¸å¿ƒçº¿ç¨‹çš„å­˜æ´»å‘¨æœŸã€‚ åœ¨ä¸€äº›ç‰¹å®šçš„åœºæ™¯ä¸‹ï¼Œé…ç½®åˆç†çš„keepAliveTimeèƒ½å¤Ÿæ›´å¥½åœ°åˆ©ç”¨çº¿ç¨‹æ± çš„å·¥ä½œçº¿ç¨‹èµ„æºã€‚ processWorkerExitæ–¹æ³•æºç åˆ†æ processWorkerExit()æ–¹æ³•æ˜¯ä¸ºå°†è¦ç»ˆç»“çš„Workeråšä¸€æ¬¡æ¸…ç†å’Œæ•°æ®è®°å½•å·¥ä½œï¼ˆå› ä¸ºprocessWorkerExit()æ–¹æ³•ä¹ŸåŒ…è£¹åœ¨runWorker()æ–¹æ³•finallyä»£ç å—ä¸­ï¼Œå…¶å®å·¥ä½œçº¿ç¨‹åœ¨æ‰§è¡Œå®ŒprocessWorkerExit()æ–¹æ³•æ‰ç®—çœŸæ­£çš„ç»ˆç»“ï¼‰ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738private void processWorkerExit(Worker w, boolean completedAbruptly) &#123; // å› ä¸ºæŠ›å‡ºç”¨æˆ·å¼‚å¸¸å¯¼è‡´çº¿ç¨‹ç»ˆç»“ï¼Œç›´æ¥ä½¿å·¥ä½œçº¿ç¨‹æ•°å‡1å³å¯ // å¦‚æœæ²¡æœ‰ä»»ä½•å¼‚å¸¸æŠ›å‡ºçš„æƒ…å†µä¸‹æ˜¯é€šè¿‡getTask()è¿”å›nullå¼•å¯¼çº¿ç¨‹æ­£å¸¸è·³å‡ºrunWorker()æ–¹æ³•çš„whileæ­»å¾ªç¯ä»è€Œæ­£å¸¸ç»ˆç»“ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œåœ¨getTask()ä¸­å·²ç»æŠŠçº¿ç¨‹æ•°å‡1 if (completedAbruptly) // If abrupt, then workerCount wasn't adjusted decrementWorkerCount(); final ReentrantLock mainLock = this.mainLock; mainLock.lock(); try &#123; // å…¨å±€çš„å·²å®Œæˆä»»åŠ¡è®°å½•æ•°åŠ ä¸Šæ­¤å°†è¦ç»ˆç»“çš„Workerä¸­çš„å·²å®Œæˆä»»åŠ¡æ•° completedTaskCount += w.completedTasks; // å·¥ä½œçº¿ç¨‹é›†åˆä¸­ç§»é™¤æ­¤å°†è¦ç»ˆç»“çš„Worker workers.remove(w); &#125; finally &#123; mainLock.unlock(); &#125; // è§ä¸‹ä¸€å°èŠ‚åˆ†æï¼Œç”¨äºæ ¹æ®å½“å‰çº¿ç¨‹æ± çš„çŠ¶æ€åˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡Œçº¿ç¨‹æ± terminateå¤„ç† tryTerminate(); int c = ctl.get(); // å¦‚æœçº¿ç¨‹æ± çš„çŠ¶æ€å°äºSTOPï¼Œä¹Ÿå°±æ˜¯å¤„äºRUNNINGæˆ–è€…SHUTDOWNçŠ¶æ€çš„å‰æä¸‹ï¼š // 1.å¦‚æœçº¿ç¨‹ä¸æ˜¯ç”±äºæŠ›å‡ºç”¨æˆ·å¼‚å¸¸ç»ˆç»“ï¼Œå¦‚æœå…è®¸æ ¸å¿ƒçº¿ç¨‹è¶…æ—¶ï¼Œåˆ™ä¿æŒçº¿ç¨‹æ± ä¸­è‡³å°‘å­˜åœ¨ä¸€ä¸ªå·¥ä½œçº¿ç¨‹ // 2.å¦‚æœçº¿ç¨‹ç”±äºæŠ›å‡ºç”¨æˆ·å¼‚å¸¸ç»ˆç»“ï¼Œæˆ–è€…å½“å‰å·¥ä½œçº¿ç¨‹æ•°ï¼Œé‚£ä¹ˆç›´æ¥æ·»åŠ ä¸€ä¸ªæ–°çš„éæ ¸å¿ƒçº¿ç¨‹ if (runStateLessThan(c, STOP)) &#123; if (!completedAbruptly) &#123; // å¦‚æœå…è®¸æ ¸å¿ƒçº¿ç¨‹è¶…æ—¶ï¼Œæœ€å°å€¼ä¸º0ï¼Œå¦åˆ™ä¸ºcorePoolSize int min = allowCoreThreadTimeOut ? 0 : corePoolSize; // å¦‚æœæœ€å°å€¼ä¸º0ï¼ŒåŒæ—¶ä»»åŠ¡é˜Ÿåˆ—ä¸ç©ºï¼Œåˆ™æ›´æ–°æœ€å°å€¼ä¸º1 if (min == 0 &amp;&amp; ! workQueue.isEmpty()) min = 1; // å·¥ä½œçº¿ç¨‹æ•°å¤§äºç­‰äºæœ€å°å€¼ï¼Œç›´æ¥è¿”å›ä¸æ–°å¢éæ ¸å¿ƒçº¿ç¨‹ if (workerCountOf(c) &gt;= min) return; // replacement not needed &#125; addWorker(null, false); &#125;&#125; ä»£ç çš„åé¢éƒ¨åˆ†åŒºåŸŸï¼Œä¼šåˆ¤æ–­çº¿ç¨‹æ± çš„çŠ¶æ€ï¼Œå¦‚æœçº¿ç¨‹æ± æ˜¯RUNNINGæˆ–è€…SHUTDOWNçŠ¶æ€çš„å‰æä¸‹ï¼Œå¦‚æœå½“å‰çš„å·¥ä½œçº¿ç¨‹ç”±äºæŠ›å‡ºç”¨æˆ·å¼‚å¸¸è¢«ç»ˆç»“ï¼Œé‚£ä¹ˆä¼šæ–°åˆ›å»ºä¸€ä¸ªéæ ¸å¿ƒçº¿ç¨‹ã€‚å¦‚æœå½“å‰çš„å·¥ä½œçº¿ç¨‹å¹¶ä¸æ˜¯æŠ›å‡ºç”¨æˆ·å¼‚å¸¸è¢«ç»ˆç»“ï¼ˆæ­£å¸¸æƒ…å†µä¸‹çš„ç»ˆç»“ï¼‰ï¼Œé‚£ä¹ˆä¼šè¿™æ ·å¤„ç†ï¼š allowCoreThreadTimeOutä¸ºtrueï¼Œä¹Ÿå°±æ˜¯å…è®¸æ ¸å¿ƒçº¿ç¨‹è¶…æ—¶çš„å‰æä¸‹ï¼Œå¦‚æœä»»åŠ¡é˜Ÿåˆ—ç©ºï¼Œåˆ™ä¼šé€šè¿‡åˆ›å»ºä¸€ä¸ªéæ ¸å¿ƒçº¿ç¨‹ä¿æŒçº¿ç¨‹æ± ä¸­è‡³å°‘æœ‰ä¸€ä¸ªå·¥ä½œçº¿ç¨‹ã€‚ allowCoreThreadTimeOutä¸ºfalseï¼Œå¦‚æœå·¥ä½œçº¿ç¨‹æ€»æ•°å¤§äºcorePoolSizeåˆ™ç›´æ¥è¿”å›ï¼Œå¦åˆ™åˆ›å»ºä¸€ä¸ªéæ ¸å¿ƒçº¿ç¨‹ï¼Œä¹Ÿå°±æ˜¯ä¼šè¶‹å‘äºä¿æŒçº¿ç¨‹æ± ä¸­çš„å·¥ä½œçº¿ç¨‹æ•°é‡è¶‹å‘äºcorePoolSizeã€‚ processWorkerExit()æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œæ„å‘³ç€è¯¥å·¥ä½œçº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸå·²ç»å®Œç»“ã€‚ tryTerminateæ–¹æ³•æºç åˆ†æ æ¯ä¸ªå·¥ä½œçº¿ç¨‹ç»ˆç»“çš„æ—¶å€™éƒ½ä¼šè°ƒç”¨tryTerminate()æ–¹æ³•ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263final void tryTerminate() &#123; for (;;) &#123; int c = ctl.get(); // åˆ¤æ–­çº¿ç¨‹æ± çš„çŠ¶æ€ï¼Œå¦‚æœæ˜¯ä¸‹é¢ä¸‰ç§æƒ…å†µä¸‹çš„ä»»æ„ä¸€ç§åˆ™ç›´æ¥è¿”å›ï¼š // 1.çº¿ç¨‹æ± å¤„äºRUNNINGçŠ¶æ€ // 2.çº¿ç¨‹æ± è‡³å°‘ä¸ºTIDYINGçŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯TIDYINGæˆ–è€…TERMINATEDçŠ¶æ€ï¼Œæ„å‘³ç€å·²ç»èµ°åˆ°äº†ä¸‹é¢çš„æ­¥éª¤ï¼Œçº¿ç¨‹æ± å³å°†ç»ˆç»“ // 3.çº¿ç¨‹æ± è‡³å°‘ä¸ºSTOPçŠ¶æ€å¹¶ä¸”ä»»åŠ¡é˜Ÿåˆ—ä¸ä¸ºç©º if (isRunning(c) || runStateAtLeast(c, TIDYING) || (runStateLessThan(c, STOP) &amp;&amp; ! workQueue.isEmpty())) return; // å·¥ä½œçº¿ç¨‹æ•°ä¸ä¸º0ï¼Œåˆ™ä¸­æ–­å·¥ä½œçº¿ç¨‹é›†åˆä¸­çš„ç¬¬ä¸€ä¸ªç©ºé—²çš„å·¥ä½œçº¿ç¨‹ if (workerCountOf(c) != 0) &#123; // Eligible to terminate interruptIdleWorkers(ONLY_ONE); return; &#125; final ReentrantLock mainLock = this.mainLock; mainLock.lock(); try &#123; // CASè®¾ç½®çº¿ç¨‹æ± çŠ¶æ€ä¸ºTIDYINGï¼Œå¦‚æœè®¾ç½®æˆåŠŸåˆ™æ‰§è¡Œé’©å­æ–¹æ³•terminated() if (ctl.compareAndSet(c, ctlOf(TIDYING, 0))) &#123; try &#123; terminated(); &#125; finally &#123; // æœ€åæ›´æ–°çº¿ç¨‹æ± çŠ¶æ€ä¸ºTERMINATED ctl.set(ctlOf(TERMINATED, 0)); // å”¤é†’é˜»å¡åœ¨terminationæ¡ä»¶çš„æ‰€æœ‰çº¿ç¨‹ï¼Œè¿™ä¸ªå˜é‡çš„await()æ–¹æ³•åœ¨awaitTermination()ä¸­è°ƒç”¨ termination.signalAll(); &#125; return; &#125; &#125; finally &#123; mainLock.unlock(); &#125; // else retry on failed CAS &#125;&#125;// ä¸­æ–­ç©ºé—²çš„å·¥ä½œçº¿ç¨‹ï¼ŒonlyOneä¸ºtrueçš„æ—¶å€™ï¼Œåªä¼šä¸­æ–­å·¥ä½œçº¿ç¨‹é›†åˆä¸­çš„æŸä¸€ä¸ªçº¿ç¨‹private void interruptIdleWorkers(boolean onlyOne) &#123; final ReentrantLock mainLock = this.mainLock; mainLock.lock(); try &#123; for (Worker w : workers) &#123; Thread t = w.thread; // è¿™é‡Œåˆ¤æ–­çº¿ç¨‹ä¸æ˜¯ä¸­æ–­çŠ¶æ€å¹¶ä¸”å°è¯•è·å–é”æˆåŠŸçš„æ—¶å€™æ‰è¿›è¡Œçº¿ç¨‹ä¸­æ–­ if (!t.isInterrupted() &amp;&amp; w.tryLock()) &#123; try &#123; t.interrupt(); &#125; catch (SecurityException ignore) &#123; &#125; finally &#123; w.unlock(); &#125; &#125; // è¿™é‡Œè·³å‡ºå¾ªç¯ï¼Œä¹Ÿå°±æ˜¯åªä¸­æ–­é›†åˆä¸­ç¬¬ä¸€ä¸ªå·¥ä½œçº¿ç¨‹ if (onlyOne) break; &#125; &#125; finally &#123; mainLock.unlock(); &#125;&#125; è¿™é‡Œæœ‰ç–‘æƒ‘çš„åœ°æ–¹æ˜¯tryTerminate()æ–¹æ³•çš„ç¬¬äºŒä¸ªifä»£ç é€»è¾‘ï¼šå·¥ä½œçº¿ç¨‹æ•°ä¸ä¸º0ï¼Œåˆ™ä¸­æ–­å·¥ä½œçº¿ç¨‹é›†åˆä¸­çš„ç¬¬ä¸€ä¸ªç©ºé—²çš„å·¥ä½œçº¿ç¨‹ã€‚æ–¹æ³•APIæ³¨é‡Šä¸­æœ‰è¿™æ ·ä¸€æ®µè¯ï¼š If otherwise eligible to terminate but workerCount is nonzero, interrupts an idle worker to ensure that shutdown signals propagate. å½“æ»¡è¶³ç»ˆç»“çº¿ç¨‹æ± çš„æ¡ä»¶ä½†æ˜¯å·¥ä½œçº¿ç¨‹æ•°ä¸ä¸º0ï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦ä¸­æ–­ä¸€ä¸ªç©ºé—²çš„å·¥ä½œçº¿ç¨‹å»ç¡®ä¿çº¿ç¨‹æ± å…³é—­çš„ä¿¡å·å¾—ä»¥ä¼ æ’­ã€‚ ä¸‹é¢å°†ä¼šåˆ†æçš„shutdown()æ–¹æ³•ä¸­ä¼šé€šè¿‡interruptIdleWorkers()ä¸­æ–­æ‰€æœ‰çš„ç©ºé—²çº¿ç¨‹ï¼Œè¿™ä¸ªæ—¶å€™æœ‰å¯èƒ½æœ‰éç©ºé—²çš„çº¿ç¨‹åœ¨æ‰§è¡ŒæŸä¸ªä»»åŠ¡ï¼Œæ‰§è¡Œä»»åŠ¡å®Œæ¯•ä¹‹åï¼Œå¦‚æœå®ƒåˆšå¥½æ˜¯æ ¸å¿ƒçº¿ç¨‹ï¼Œå°±ä¼šåœ¨ä¸‹ä¸€è½®å¾ªç¯é˜»å¡åœ¨ä»»åŠ¡é˜Ÿåˆ—çš„take()æ–¹æ³•ï¼Œå¦‚æœä¸åšé¢å¤–çš„å¹²é¢„ï¼Œå®ƒç”šè‡³ä¼šåœ¨çº¿ç¨‹æ± å…³é—­ä¹‹åæ°¸ä¹…é˜»å¡åœ¨ä»»åŠ¡é˜Ÿåˆ—çš„take()æ–¹æ³•ä¸­ã€‚ä¸ºäº†é¿å…è¿™ç§æƒ…å†µï¼Œæ¯ä¸ªå·¥ä½œçº¿ç¨‹é€€å‡ºçš„æ—¶å€™éƒ½ä¼šå°è¯•ä¸­æ–­å·¥ä½œçº¿ç¨‹é›†åˆä¸­çš„æŸä¸€ä¸ªç©ºé—²çš„çº¿ç¨‹ï¼Œç¡®ä¿æ‰€æœ‰ç©ºé—²çš„çº¿ç¨‹éƒ½èƒ½å¤Ÿæ­£å¸¸é€€å‡ºã€‚ interruptIdleWorkers()æ–¹æ³•ä¸­ä¼šå¯¹æ¯ä¸€ä¸ªå·¥ä½œçº¿ç¨‹å…ˆè¿›è¡ŒtryLock()åˆ¤æ–­ï¼Œåªæœ‰è¿”å›trueæ‰æœ‰å¯èƒ½è¿›è¡Œçº¿ç¨‹ä¸­æ–­ã€‚æˆ‘ä»¬çŸ¥é“runWorker()æ–¹æ³•ä¸­ï¼Œå·¥ä½œçº¿ç¨‹åœ¨æ¯æ¬¡ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­è·å–åˆ°énullçš„ä»»åŠ¡ä¹‹åï¼Œä¼šå…ˆè¿›è¡ŒåŠ é”Worker#lock()æ“ä½œï¼Œè¿™æ ·å°±èƒ½é¿å…çº¿ç¨‹åœ¨æ‰§è¡Œä»»åŠ¡çš„è¿‡ç¨‹ä¸­è¢«ä¸­æ–­ï¼Œä¿è¯è¢«ä¸­æ–­çš„ä¸€å®šæ˜¯ç©ºé—²çš„å·¥ä½œçº¿ç¨‹ã€‚ shutdownæ–¹æ³•æºç åˆ†æ çº¿ç¨‹æ± å…³é—­æ“ä½œæœ‰å‡ ä¸ªç›¸å…³çš„å˜ä½“æ–¹æ³•ï¼Œå…ˆçœ‹shutdown()ï¼š 1234567891011121314151617181920212223242526272829303132333435public void shutdown() &#123; final ReentrantLock mainLock = this.mainLock; mainLock.lock(); try &#123; // æƒé™æ ¡éªŒï¼Œå®‰å…¨ç­–ç•¥ç›¸å…³åˆ¤æ–­ checkShutdownAccess(); // è®¾ç½®SHUTDOWNçŠ¶æ€ advanceRunState(SHUTDOWN); // ä¸­æ–­æ‰€æœ‰çš„ç©ºé—²çš„å·¥ä½œçº¿ç¨‹ interruptIdleWorkers(); // é’©å­æ–¹æ³• onShutdown(); // hook for ScheduledThreadPoolExecutor &#125; finally &#123; mainLock.unlock(); &#125; // è°ƒç”¨ä¸Šé¢åˆ†ææœæ•¢çš„å°è¯•terminateæ–¹æ³•ï¼Œä½¿çŠ¶æ€æ›´å˜ä¸ºTIDYINGï¼Œæ‰§è¡Œé’©å­æ–¹æ³•terminated()åï¼Œæœ€ç»ˆçŠ¶æ€æ›´æ–°ä¸ºTERMINATED tryTerminate();&#125;// å‡æçŠ¶æ€private void advanceRunState(int targetState) &#123; // assert targetState == SHUTDOWN || targetState == STOP; for (;;) &#123; int c = ctl.get(); // çº¿ç¨‹æ± çŠ¶æ€è‡³å°‘ä¸ºtargetStateæˆ–è€…CASè®¾ç½®çŠ¶æ€ä¸ºtargetStateåˆ™è·³å‡ºå¾ªç¯ if (runStateAtLeast(c, targetState) || ctl.compareAndSet(c, ctlOf(targetState, workerCountOf(c)))) break; &#125;&#125;// ä¸­æ–­æ‰€æœ‰çš„ç©ºé—²çš„å·¥ä½œçº¿ç¨‹private void interruptIdleWorkers() &#123; interruptIdleWorkers(false);&#125; æ¥ç€çœ‹shutdownNow()æ–¹æ³•ï¼š 1234567891011121314151617181920public List&lt;Runnable&gt; shutdownNow() &#123; List&lt;Runnable&gt; tasks; final ReentrantLock mainLock = this.mainLock; mainLock.lock(); try &#123; // æƒé™æ ¡éªŒï¼Œå®‰å…¨ç­–ç•¥ç›¸å…³åˆ¤æ–­ checkShutdownAccess(); // è®¾ç½®STOPçŠ¶æ€ advanceRunState(STOP); // ä¸­æ–­æ‰€æœ‰çš„ç©ºé—²çš„å·¥ä½œçº¿ç¨‹ interruptWorkers(); // æ¸…ç©ºå·¥ä½œé˜Ÿåˆ—å¹¶ä¸”å–å‡ºæ‰€æœ‰çš„æœªæ‰§è¡Œçš„ä»»åŠ¡ tasks = drainQueue(); &#125; finally &#123; mainLock.unlock(); &#125; // è°ƒç”¨ä¸Šé¢åˆ†ææœæ•¢çš„å°è¯•terminateæ–¹æ³•ï¼Œä½¿çŠ¶æ€æ›´å˜ä¸ºTIDYINGï¼Œæ‰§è¡Œé’©å­æ–¹æ³•terminated()åï¼Œæœ€ç»ˆçŠ¶æ€æ›´æ–°ä¸ºTERMINATED tryTerminate(); return tasks;&#125; shutdownNow()æ–¹æ³•ä¼šæŠŠçº¿ç¨‹æ± çŠ¶æ€å…ˆæ›´å˜ä¸ºSTOPï¼Œç„¶åéå†ä»»åŠ¡é˜Ÿåˆ—ï¼Œå–å‡ºï¼ˆç§»é™¤ï¼‰æ‰€æœ‰ä»»åŠ¡å­˜æ”¾åœ¨ä¸€ä¸ªåˆ—è¡¨ä¸­è¿”å›ã€‚ æœ€åçœ‹awaitTermination()æ–¹æ³•ï¼š 123456789101112131415161718public boolean awaitTermination(long timeout, TimeUnit unit) throws InterruptedException &#123; // è½¬æ¢timeoutçš„å•ä½ä¸ºçº³ç§’ long nanos = unit.toNanos(timeout); final ReentrantLock mainLock = this.mainLock; mainLock.lock(); try &#123; // å¾ªç¯ç­‰å¾…ç›´åˆ°çº¿ç¨‹æ± çŠ¶æ€æ›´å˜ä¸ºTERMINATEDï¼Œæ¯è½®å¾ªç¯ç­‰å¾…nanosçº³ç§’ while (runStateLessThan(ctl.get(), TERMINATED)) &#123; if (nanos &lt;= 0L) return false; nanos = termination.awaitNanos(nanos); &#125; return true; &#125; finally &#123; mainLock.unlock(); &#125;&#125; awaitTermination()è™½ç„¶ä¸æ˜¯shutdown()æ–¹æ³•ä½“ç³»ï¼Œä½†æ˜¯å®ƒçš„å¤„ç†é€»è¾‘å°±æ˜¯ç¡®ä¿è°ƒç”¨æ­¤æ–¹æ³•çš„çº¿ç¨‹ä¼šé˜»å¡åˆ°tryTerminate()æ–¹æ³•æˆåŠŸæŠŠçº¿ç¨‹æ± çŠ¶æ€æ›´æ–°ä¸ºTERMINATEDåå†è¿”å›ï¼Œå¯ä»¥ä½¿ç”¨åœ¨æŸäº›éœ€è¦æ„ŸçŸ¥çº¿ç¨‹æ± ç»ˆç»“æ—¶åˆ»çš„åœºæ™¯ã€‚ æœ‰ä¸€ç‚¹å€¼å¾—å…³æ³¨çš„æ˜¯ï¼šshutdown()æˆ–è€…shutdownNow()æ–¹æ³•åªä¼šä¸­æ–­ç©ºé—²çš„å·¥ä½œçº¿ç¨‹ï¼Œå¦‚æœå·¥ä½œçº¿ç¨‹æ­£åœ¨æ‰§è¡Œä»»åŠ¡å¯¹è±¡Runnable#run()ï¼Œè¿™ç§æƒ…å†µä¸‹çš„å·¥ä½œçº¿ç¨‹ä¸ä¼šä¸­æ–­ï¼Œè€Œæ˜¯ç­‰å¾…ä¸‹ä¸€è½®æ‰§è¡ŒgetTask()æ–¹æ³•çš„æ—¶å€™é€šè¿‡çº¿ç¨‹æ± çŠ¶æ€åˆ¤æ–­æ­£å¸¸ç»ˆç»“è¯¥å·¥ä½œçº¿ç¨‹ã€‚ rejectæ–¹æ³•æºç åˆ†æ reject(Runnable command)æ–¹æ³•å¾ˆç®€å•ï¼š 123final void reject(Runnable command) &#123; handler.rejectedExecution(command, this);&#125; è°ƒç”¨çº¿ç¨‹æ± æŒæœ‰çš„æˆå‘˜RejectedExecutionHandlerå®ä¾‹å›è°ƒä»»åŠ¡å®ä¾‹å’Œå½“å‰çº¿ç¨‹æ± å®ä¾‹ã€‚ é’©å­æ–¹æ³•åˆ†æ åˆ°JDK11ä¸ºæ­¢ï¼ŒThreadPoolExecutoræä¾›çš„é’©å­æ–¹æ³•æ²¡æœ‰å¢åŠ ï¼Œæœ‰ä»¥ä¸‹å‡ ä¸ªï¼š beforeExecute(Thread t, Runnable r)ï¼šä»»åŠ¡å¯¹è±¡Runnable#run()æ‰§è¡Œä¹‹å‰è§¦å‘å›è°ƒã€‚ afterExecute(Runnable r, Throwable t)ï¼šä»»åŠ¡å¯¹è±¡Runnable#run()æ‰§è¡Œä¹‹åï¼ˆåŒ…æ‹¬å¼‚å¸¸å®Œæˆæƒ…å†µå’Œæ­£å¸¸å®Œæˆæƒ…å†µï¼‰è§¦å‘å›è°ƒã€‚ terminated()ï¼šçº¿ç¨‹æ± å…³é—­çš„æ—¶å€™ï¼ŒçŠ¶æ€æ›´å˜ä¸ºTIDYINGæˆåŠŸä¹‹åä¼šå›è°ƒæ­¤æ–¹æ³•ï¼Œæ‰§è¡Œæ­¤æ–¹æ³•å®Œæ¯•åï¼Œçº¿ç¨‹æ± çŠ¶æ€ä¼šæ›´æ–°ä¸ºTERMINATEDã€‚ onShutdown()ï¼šshutdown()æ–¹æ³•æ‰§è¡Œæ—¶å€™ä¼šå›è°ƒæ­¤æ–¹æ³•ï¼ŒAPIæ³¨é‡Šä¸­æåˆ°æ­¤æ–¹æ³•ä¸»è¦æä¾›ç»™ScheduledThreadPoolExecutorä½¿ç”¨ã€‚ å…¶ä¸­onShutdown()çš„æ–¹æ³•ä¿®é¥°ç¬¦ä¸ºdefaultï¼Œå…¶ä»–ä¸‰ä¸ªæ–¹æ³•çš„ä¿®é¥°ç¬¦ä¸ºprotectedï¼Œå¿…è¦æ—¶å€™å¯ä»¥è‡ªè¡Œæ‰©å±•è¿™äº›æ–¹æ³•ï¼Œå¯ä»¥å®ç°ç›‘æ§ã€åŸºäºç‰¹å®šæ—¶æœºè§¦å‘å…·ä½“æ“ä½œç­‰ç­‰ã€‚ å…¶ä»–æ–¹æ³• çº¿ç¨‹æ± æœ¬èº«æä¾›äº†å¤§é‡æ•°æ®ç»Ÿè®¡ç›¸å…³çš„æ–¹æ³•ã€æ‰©å®¹æ–¹æ³•ã€é¢„åˆ›å»ºæ–¹æ³•ç­‰ç­‰ï¼Œè¿™äº›æ–¹æ³•çš„æºç å¹¶ä¸å¤æ‚ï¼Œè¿™é‡Œä¸åšå±•å¼€åˆ†æã€‚ æ ¸å¿ƒçº¿ç¨‹ç›¸å…³ï¼š getCorePoolSize()ï¼šè·å–æ ¸å¿ƒçº¿ç¨‹æ•°ã€‚ setCorePoolSize()ï¼šé‡æ–°è®¾ç½®çº¿ç¨‹æ± çš„æ ¸å¿ƒçº¿ç¨‹æ•°ã€‚ prestartCoreThread()ï¼šé¢„å¯åŠ¨ä¸€ä¸ªæ ¸å¿ƒçº¿ç¨‹ï¼Œå½“ä¸”ä»…å½“å·¥ä½œçº¿ç¨‹æ•°é‡å°äºæ ¸å¿ƒçº¿ç¨‹æ•°é‡ã€‚ prestartAllCoreThreads()ï¼šé¢„å¯åŠ¨æ‰€æœ‰æ ¸å¿ƒçº¿ç¨‹ã€‚ çº¿ç¨‹æ± å®¹é‡ç›¸å…³ï¼š getMaximumPoolSize()ï¼šè·å–çº¿ç¨‹æ± å®¹é‡ã€‚ setMaximumPoolSize()ï¼šé‡æ–°è®¾ç½®çº¿ç¨‹æ± çš„æœ€å¤§å®¹é‡ã€‚ çº¿ç¨‹å­˜æ´»å‘¨æœŸç›¸å…³ï¼š setKeepAliveTime()ï¼šè®¾ç½®ç©ºé—²å·¥ä½œçº¿ç¨‹çš„å­˜æ´»å‘¨æœŸã€‚ getKeepAliveTime()ï¼šè·å–ç©ºé—²å·¥ä½œçº¿ç¨‹çš„å­˜æ´»å‘¨æœŸã€‚ å…¶ä»–ç›‘æ§ç»Ÿè®¡ç›¸å…³æ–¹æ³•ï¼š getTaskCount()ï¼šè·å–æ‰€æœ‰å·²ç»è¢«æ‰§è¡Œçš„ä»»åŠ¡æ€»æ•°çš„è¿‘ä¼¼å€¼ã€‚ getCompletedTaskCount()ï¼šè·å–æ‰€æœ‰å·²ç»æ‰§è¡Œå®Œæˆçš„ä»»åŠ¡æ€»æ•°çš„è¿‘ä¼¼å€¼ã€‚ getLargestPoolSize()ï¼šè·å–çº¿ç¨‹æ± çš„å³°å€¼çº¿ç¨‹æ•°ï¼ˆæœ€å¤§æ± å®¹é‡ï¼‰ã€‚ getActiveCount()ï¼šè·å–æ‰€æœ‰æ´»è·ƒçº¿ç¨‹æ€»æ•°ï¼ˆæ­£åœ¨æ‰§è¡Œä»»åŠ¡çš„å·¥ä½œçº¿ç¨‹ï¼‰çš„è¿‘ä¼¼å€¼ã€‚ getPoolSize()ï¼šè·å–å·¥ä½œçº¿ç¨‹é›†åˆçš„å®¹é‡ï¼ˆå½“å‰çº¿ç¨‹æ± ä¸­çš„æ€»å·¥ä½œçº¿ç¨‹æ•°ï¼‰ã€‚ ä»»åŠ¡é˜Ÿåˆ—æ“ä½œç›¸å…³æ–¹æ³•ï¼š purge()ï¼šç§»é™¤ä»»åŠ¡é˜Ÿåˆ—ä¸­æ‰€æœ‰æ˜¯Futureç±»å‹å¹¶ä¸”å·²ç»å¤„äºCancelledçŠ¶æ€çš„ä»»åŠ¡ã€‚ remove()ï¼šä»ä»»åŠ¡é˜Ÿåˆ—ä¸­ç§»é™¤æŒ‡å®šçš„ä»»åŠ¡ã€‚ BlockingQueue&lt;Runnable&gt; getQueue()ï¼šè·å–ä»»åŠ¡é˜Ÿåˆ—çš„å¼•ç”¨ã€‚ å°ç»“ æœ¬æ–‡èŠ±å¤§é‡åŠŸå¤«åŸºäºæ¯ä¸€è¡Œä»£ç åˆ†æJUCçº¿ç¨‹æ± ThreadPoolExecutorçš„æ ¸å¿ƒæ–¹æ³•execute()çš„å®ç°ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯æ•´ä¸ªçº¿ç¨‹æ± ç›¸å…³ä½“ç³»çš„åŸºçŸ³ï¼Œæœ‰äº†å®ƒæ‰èƒ½æ‰©å±•å‡ºå¸¦å›è°ƒçš„å¼‚æ­¥æ‰§è¡Œå’ŒåŸºäºæ—¶é—´è¿›è¡Œä»»åŠ¡è°ƒåº¦çš„åŠŸèƒ½ï¼Œåé¢å°†ä¼šç¼–å†™ä¸¤ç¯‡æ–‡ç« åˆ†åˆ«è¯¦ç»†åˆ†æçº¿ç¨‹æ± æ‰©å±•æœåŠ¡ExecutorServiceçš„åŠŸèƒ½æºç å®ç°ä»¥åŠè°ƒåº¦çº¿ç¨‹æ± ScheduledThreadPoolExecutorçš„æºç å®ç°ï¼Œé¢„è®¡è¦è€—æ—¶2-3å‘¨ã€‚ ï¼ˆæœ¬æ–‡å®Œ e-a-20190715 c-7-d æœ€è¿‘é¡¹ç›®æ¯”è¾ƒç´§ï¼Œæ²¡åŠæ³•åŠæ—¶æ›´æ–°ï¼‰","categories":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/categories/Java/"},{"name":"Concurrency","slug":"Java/Concurrency","permalink":"http://throwable.club/blog/categories/Java/Concurrency/"}],"tags":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/tags/Java/"},{"name":"ThreadPoolExecutor","slug":"ThreadPoolExecutor","permalink":"http://throwable.club/blog/tags/ThreadPoolExecutor/"}]},{"title":"JUCçº¿ç¨‹æ± æ‰©å±•å¯å›è°ƒçš„Future","slug":"java-concurrency-listenable-future","date":"2019-07-02T00:35:01.000Z","updated":"2019-07-07T07:00:41.203Z","comments":true,"path":"2019/07/02/java-concurrency-listenable-future/","link":"","permalink":"http://throwable.club/2019/07/02/java-concurrency-listenable-future/","excerpt":"å‰æ æœ€è¿‘åœ¨çœ‹JUCçº¿ç¨‹æ± java.util.concurrent.ThreadPoolExecutorçš„æºç å®ç°ï¼Œå…¶ä¸­äº†è§£åˆ°java.util.concurrent.Futureçš„å®ç°åŸç†ã€‚ä»ç›®å‰java.util.concurrent.Futureçš„å®ç°æ¥çœ‹ï¼Œè™½ç„¶å®ç°äº†å¼‚æ­¥æäº¤ä»»åŠ¡ï¼Œä½†æ˜¯ä»»åŠ¡ç»“æœçš„è·å–è¿‡ç¨‹éœ€è¦ä¸»åŠ¨è°ƒç”¨Future#get()æˆ–è€…Future#get(long timeout, TimeUnit unit)ï¼Œè€Œå‰è€…æ˜¯é˜»å¡çš„ï¼Œåè€…åœ¨å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œæ—¶é—´ä¸ç¡®å®šçš„æƒ…å†µä¸‹æœ‰å¯èƒ½éœ€è¦è¿›è¡Œè½®è¯¢ï¼Œè¿™ä¸¤ç§æƒ…å†µå’Œå¼‚æ­¥è°ƒç”¨çš„åˆè¡·æœ‰ç‚¹ç›¸è¿èƒŒã€‚äºæ˜¯ç¬”è€…æƒ³ç»“åˆç›®å‰äº†è§£åˆ°çš„Futureå®ç°åŸç†çš„å‰æä¸‹æ‰©å±•å‡ºæ”¯æŒï¼ˆç›‘å¬ï¼‰å›è°ƒçš„Futureï¼Œæ€è·¯ä¸Šå‚è€ƒäº†Guavaå¢å¼ºçš„ListenableFutureã€‚æœ¬æ–‡ç¼–å†™çš„æ—¶å€™ä½¿ç”¨çš„JDKæ˜¯JDK11ï¼Œä»£ç å¯ä»¥åœ¨JDK[8,12]ç‰ˆæœ¬ä¸Šè¿è¡Œï¼Œå…¶ä»–ç‰ˆæœ¬å¯èƒ½ä¸é€‚åˆã€‚","text":"å‰æ æœ€è¿‘åœ¨çœ‹JUCçº¿ç¨‹æ± java.util.concurrent.ThreadPoolExecutorçš„æºç å®ç°ï¼Œå…¶ä¸­äº†è§£åˆ°java.util.concurrent.Futureçš„å®ç°åŸç†ã€‚ä»ç›®å‰java.util.concurrent.Futureçš„å®ç°æ¥çœ‹ï¼Œè™½ç„¶å®ç°äº†å¼‚æ­¥æäº¤ä»»åŠ¡ï¼Œä½†æ˜¯ä»»åŠ¡ç»“æœçš„è·å–è¿‡ç¨‹éœ€è¦ä¸»åŠ¨è°ƒç”¨Future#get()æˆ–è€…Future#get(long timeout, TimeUnit unit)ï¼Œè€Œå‰è€…æ˜¯é˜»å¡çš„ï¼Œåè€…åœ¨å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œæ—¶é—´ä¸ç¡®å®šçš„æƒ…å†µä¸‹æœ‰å¯èƒ½éœ€è¦è¿›è¡Œè½®è¯¢ï¼Œè¿™ä¸¤ç§æƒ…å†µå’Œå¼‚æ­¥è°ƒç”¨çš„åˆè¡·æœ‰ç‚¹ç›¸è¿èƒŒã€‚äºæ˜¯ç¬”è€…æƒ³ç»“åˆç›®å‰äº†è§£åˆ°çš„Futureå®ç°åŸç†çš„å‰æä¸‹æ‰©å±•å‡ºæ”¯æŒï¼ˆç›‘å¬ï¼‰å›è°ƒçš„Futureï¼Œæ€è·¯ä¸Šå‚è€ƒäº†Guavaå¢å¼ºçš„ListenableFutureã€‚æœ¬æ–‡ç¼–å†™çš„æ—¶å€™ä½¿ç”¨çš„JDKæ˜¯JDK11ï¼Œä»£ç å¯ä»¥åœ¨JDK[8,12]ç‰ˆæœ¬ä¸Šè¿è¡Œï¼Œå…¶ä»–ç‰ˆæœ¬å¯èƒ½ä¸é€‚åˆã€‚ ç®€å•åˆ†æFutureçš„å®ç°åŸç† è™šæ‹Ÿä¾‹å­æ¨æ¼” å¹¶å‘å¤§å¸ˆDoug Leaåœ¨è®¾è®¡JUCçº¿ç¨‹æ± çš„æ—¶å€™ï¼Œæä¾›äº†ä¸€ä¸ªé¡¶å±‚æ‰§è¡Œå™¨æ¥å£Executorï¼š 1234public interface Executor &#123; void execute(Runnable command);&#125; å®é™…ä¸Šï¼Œè¿™é‡Œå®šä¹‰çš„æ–¹æ³•Executor#execute()æ˜¯æ•´å¥—çº¿ç¨‹æ± ä½“ç³»æœ€æ ¸å¿ƒçš„æ¥å£ï¼Œä¹Ÿå°±æ˜¯ThreadPoolExecutorå®šä¹‰çš„æ ¸å¿ƒçº¿ç¨‹ã€é¢å¤–åˆ›å»ºçš„çº¿ç¨‹ï¼ˆçº¿ç¨‹æ± æœ€å¤§çº¿ç¨‹å®¹é‡ - æ ¸å¿ƒçº¿ç¨‹æ•°ï¼‰éƒ½æ˜¯åœ¨è¿™ä¸ªæ¥å£æäº¤ä»»åŠ¡çš„æ—¶å€™æ‡’åˆ›å»ºçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ExecutorServiceæ¥å£æ‰©å±•çš„åŠŸèƒ½éƒ½æ˜¯åŸºäºExecutor#execute()çš„åŸºç¡€è¿›è¡Œæ‰©å±•ã€‚Executor#execute()æ–¹æ³•åªæ˜¯å•çº¯åœ°æŠŠä»»åŠ¡å®ä¾‹Runnableå¯¹è±¡æŠ•æ”¾åˆ°çº¿ç¨‹æ± ä¸­åˆ†é…åˆé€‚çš„çº¿ç¨‹æ‰§è¡Œï¼Œä½†æ˜¯ç”±äºæ–¹æ³•è¿”å›å€¼æ˜¯voidç±»å‹ï¼Œæˆ‘ä»¬æ˜¯æ— æ³•æ„ŸçŸ¥ä»»åŠ¡ä»€ä¹ˆæ—¶å€™æ‰§è¡Œå®Œæ¯•ã€‚è¿™ä¸ªæ—¶å€™å°±éœ€è¦å¯¹Runnableä»»åŠ¡å®ä¾‹è¿›è¡ŒåŒ…è£…ï¼ˆä¸‹é¢æ˜¯ä¼ªä»£ç  + ä¼ªé€»è¾‘ï¼‰ï¼š 1234567891011121314151617// ä¸‹é¢è¿™ä¸ªWrapperå’ŒStatusç±»æ˜¯ç¬”è€…è™šæ„å‡ºæ¥@RequiredArgsConstructorclass Wrapper implements Runnable&#123; private final Runnable target; private Status status = Status.of(\"åˆå§‹åŒ–\"); @Override public void run()&#123; try&#123; target.run(); status = Status.of(\"æ‰§è¡ŒæˆåŠŸ\"); &#125;catch(Throwable t)&#123; status = Status.of(\"æ‰§è¡Œå¼‚å¸¸\"); &#125; &#125;&#125; æˆ‘ä»¬åªéœ€è¦æŠŠnew Wrapper(åŸå§‹Runnableå®ä¾‹)æŠ•æ”¾åˆ°çº¿ç¨‹æ± æ‰§è¡Œï¼Œé‚£ä¹ˆé€šè¿‡å®šä¹‰å¥½çš„StatusçŠ¶æ€è®°å½•å˜é‡å°±èƒ½å¾—çŸ¥å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œçš„çŠ¶æ€ï¼Œä»¥åŠä»€ä¹ˆæ—¶å€™æ‰§è¡Œå®Œæ¯•ï¼ˆåŒ…æ‹¬æ­£å¸¸çš„æ‰§è¡Œå®Œæ¯•å’Œå¼‚å¸¸çš„æ‰§è¡Œå®Œæ¯•ï¼‰ã€‚è¿™é‡Œä»…ä»…è§£å†³äº†ä»»åŠ¡æ‰§è¡Œçš„çŠ¶æ€è·å–ï¼Œä½†æ˜¯Executor#execute()æ–¹æ³•æ³•è¿”å›å€¼æ˜¯voidç±»å‹çš„ç‰¹ç‚¹ä½¿å¾—æˆ‘ä»¬æ— æ³•å›è°ƒRunnableå¯¹è±¡æ‰§è¡Œçš„ç»“æœã€‚è¿™ä¸ªæ—¶å€™éœ€è¦å®šä¹‰ä¸€ä¸ªå¯ä»¥å›è°ƒæ‰§è¡Œç»“æœçš„æ¥å£ï¼Œå…¶å®å·²ç»æœ‰ç°æˆçš„æ¥å£Callableï¼š 12345@FunctionalInterfacepublic interface Callable&lt;V&gt; &#123; V call() throws Exception;&#125; è¿™é‡Œé‡åˆ°äº†ä¸€ä¸ªé—®é¢˜ï¼šç”±äºExecutor#execute()åªæ¥æ”¶Runnableå‚æ•°ï¼Œæˆ‘ä»¬éœ€è¦æŠŠCallableæ¥å£é€‚é…åˆ°Runnableæ¥å£ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œåšä¸€æ¬¡ç®€å•çš„å§”æ‰˜å³å¯ï¼š 12345678910111213141516171819@RequiredArgsConstructorclass Wrapper implements Runnable&#123; private final Callable callable; private Status status = Status.of(\"åˆå§‹åŒ–\"); @Getter private Object outcome; @Override public void run()&#123; try&#123; outcome = callable.call(); status = Status.of(\"æ‰§è¡ŒæˆåŠŸ\"); &#125;catch(Throwable t)&#123; status = Status.of(\"æ‰§è¡Œå¼‚å¸¸\"); outcome = t; &#125; &#125;&#125; è¿™é‡ŒæŠŠCallableå®ä¾‹ç›´æ¥å§”æ‰˜ç»™Wrapperï¼Œè€ŒWrapperå®ç°äº†Runnableæ¥å£ï¼Œæ‰§è¡Œç»“æœç›´æ¥å­˜æ”¾åœ¨å®šä¹‰å¥½çš„Objectç±»å‹çš„å¯¹è±¡outcomeä¸­å³å¯ã€‚å½“æˆ‘ä»¬æ„ŸçŸ¥åˆ°æ‰§è¡ŒçŠ¶æ€å·²ç»ç»“æŸï¼Œå°±å¯ä»¥ä»outcomeä¸­æå–åˆ°æ‰§è¡Œç»“æœã€‚ Futureçš„å®ç° ä¸Šé¢ä¸€ä¸ªå°ç»“ä»…ä»…å¯¹Futureå®ç°åšä¸€ä¸ªç›¸å¯¹åˆç†çš„è™šæ‹Ÿæ¨æ¼”ï¼Œå®é™…ä¸Šï¼ŒRunnableFutureæ‰æ˜¯JUCä¸­å¸¸ç”¨çš„å¤åˆæ¥å£ï¼Œå®ƒåŒæ—¶å®ç°äº†Runnableå’ŒFutureï¼š 1234public interface RunnableFuture&lt;V&gt; extends Runnable, Future&lt;V&gt; &#123; void run();&#125; ä¸Šä¸€èŠ‚æåˆ°çš„è™šæ„å‡ºæ¥çš„Wrapperç±»ï¼Œåœ¨JUCä¸­ç±»ä¼¼çš„å®ç°æ˜¯java.util.concurrent.FutureTaskï¼Œå®ƒå°±æ˜¯Callableå’ŒRunnableçš„é€‚é…å™¨ï¼ŒFutureTaskå®ç°äº†RunnableFutureæ¥å£ï¼š 12345678910111213141516171819202122public class FutureTask&lt;V&gt; implements RunnableFuture&lt;V&gt; &#123; private volatile int state; private static final int NEW = 0; private static final int COMPLETING = 1; private static final int NORMAL = 2; private static final int EXCEPTIONAL = 3; private static final int CANCELLED = 4; private static final int INTERRUPTING = 5; private static final int INTERRUPTED = 6; /** The underlying callable; nulled out after running */ private Callable&lt;V&gt; callable; /** The result to return or exception to throw from get() */ private Object outcome; // non-volatile, protected by state reads/writes /** The thread running the callable; CASed during run() */ private volatile Thread runner; /** Treiber stack of waiting threads */ private volatile WaitNode waiters; // çœç•¥å…¶ä»–ä»£ç &#125; æ³¨æ„åˆ°æ ¸å¿ƒå±æ€§stateè¡¨ç¤ºæ‰§è¡ŒçŠ¶æ€ï¼Œoutcomeæ‰¿è½½æ‰§è¡Œç»“æœã€‚æ¥ç€çœ‹æäº¤Callableç±»å‹ä»»åŠ¡çš„æ–¹æ³•ExecutorService#submit()ï¼š 123456public interface ExecutorService extends Executor &#123; // çœç•¥å…¶ä»–æ¥å£æ–¹æ³• &lt;T&gt; Future&lt;T&gt; submit(Callable&lt;T&gt; task);&#125; å½“æˆ‘ä»¬é€šè¿‡ä¸Šè¿°ExecutorService#submit()æ–¹æ³•æäº¤Callableç±»å‹ä»»åŠ¡çš„æ—¶å€™ï¼Œå®é™…ä¸Šåšäº†å¦‚ä¸‹çš„æ­¥éª¤ï¼š æ£€æŸ¥å…¥å‚taskçš„å­˜åœ¨æ€§ï¼Œå¦‚æœä¸ºnullæŠ›å‡ºNullPointerExceptionã€‚ æŠŠCallableç±»å‹çš„taskåŒ…è£…ä¸ºFutureTaskå®ä¾‹ã€‚ æŠŠæ–°å»ºçš„FutureTaskå®ä¾‹æ”¾åˆ°çº¿ç¨‹æ± ä¸­æ‰§è¡Œï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨Executor#execute(FutureTaskå®ä¾‹)ã€‚ è¿”å›FutureTaskå®ä¾‹çš„æ¥å£å®ä¾‹RunnableFutureï¼ˆå®é™…ä¸Šæ˜¯è¿”å›å­æ¥å£Futureå®ä¾‹ï¼‰ã€‚ å¦‚æœæˆ‘ä»¬éœ€è¦è·å–ç»“æœï¼Œå¯ä»¥Future#get()æˆ–è€…Future#get(long timeout, TimeUnit unit)è·å–ï¼Œè°ƒç”¨è¿™ä¸¤ä¸ªæ–¹æ³•çš„æ—¶å€™å‚çœ‹FutureTaské‡Œé¢çš„æ–¹æ³•å®ç°ï¼Œå¾—çŸ¥æ­¥éª¤å¦‚ä¸‹ï¼š å¦‚æœçŠ¶æ€stateå°äºç­‰äºCOMPLETING(1)ï¼Œè¯´æ˜ä»»åŠ¡è¿˜åœ¨æ‰§è¡Œä¸­ï¼Œè·å–ç»“æœçš„è¯·æ±‚çº¿ç¨‹ä¼šæ”¾å…¥WaitNodeç±»å‹çš„é˜Ÿåˆ—ä¸­è¿›è¡Œé˜»å¡ã€‚ å¦‚æœä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œä¸ç®¡å¼‚å¸¸å®Œæ¯•è¿˜æ˜¯æ­£å¸¸å®Œæ¯•ï¼Œé™¤äº†ä¼šæ›´æ–°çŠ¶æ€stateå’ŒæŠŠç»“æœèµ‹å€¼åˆ°outcomeä¹‹å¤–ï¼Œè¿˜ä¼šå”¤é†’æ‰€æœ‰é˜»å¡è·å–ç»“æœçš„çº¿ç¨‹ï¼Œç„¶åè°ƒç”¨é’©å­æ–¹æ³•FutureTask#done()ï¼ˆå…·ä½“è§æºç FutureTask#finishCompletion()ï¼‰ã€‚ å…¶å®åˆ†æäº†è¿™ä¹ˆå¤šï¼Œç¬”è€…æƒ³æŒ‡å‡ºçš„ç»“è®ºå°±æ˜¯ï¼šCallableç±»å‹ä»»åŠ¡æäº¤åˆ°çº¿ç¨‹æ± ä¸­æ‰§è¡Œå®Œæ¯•ï¼ˆåŒ…æ‹¬æ­£å¸¸æ‰§è¡Œå®Œæ¯•å’Œå¼‚å¸¸æ‰§è¡Œå®Œæ¯•ï¼‰ä¹‹åï¼Œéƒ½ä¼šå›è°ƒé’©å­æ–¹æ³•FutureTask#done()ã€‚è¿™ä¸ªå°±æ˜¯æˆ‘ä»¬æ‰©å±•å¯ç›‘å¬Futureçš„ç†è®ºä¾æ®ã€‚ æ‰©å±•å¯å›è°ƒçš„Future å…ˆåšä¸€æ¬¡ç¼–ç å®ç°ï¼Œå†ç®€å•æµ‹è¯•å…¶åŠŸèƒ½ã€‚ ç¼–ç å®ç° å…ˆå®šä¹‰ä¸€ä¸ªFutureæ¥å£çš„å­æ¥å£ListenableFutureï¼Œç”¨äºæ·»åŠ å¯ç›‘å¬çš„å›è°ƒï¼š 1234public interface ListenableFuture&lt;V&gt; extends Future&lt;V&gt; &#123; void addCallback(ListenableFutureCallback&lt;V&gt; callback, Executor executor);&#125; ListenableFutureCallbackæ˜¯ä¸€ä¸ªå‡½æ•°å¼å›è°ƒæ¥å£ï¼š 12345@FunctionalInterfacepublic interface ListenableFutureCallback&lt;V&gt; &#123; void callback(V value, Throwable throwable);&#125; å¯¹äºListenableFutureCallbackè€Œè¨€ï¼Œå›è°ƒçš„ç»“æœvalueå’Œthrowableæ˜¯äº’æ–¥çš„ã€‚æ­£å¸¸æ‰§è¡Œå®Œæ¯•çš„æƒ…å†µä¸‹valueå°†ä¼šæ˜¯æ‰§è¡Œç»“æœå€¼ï¼Œthrowableä¸ºnullï¼›å¼‚å¸¸æ‰§è¡Œå®Œæ¯•çš„æƒ…å†µä¸‹ï¼Œvalueå°†ä¼šæ˜¯nullï¼Œthrowableå°†ä¼šæ˜¯æŠ›å‡ºçš„å¼‚å¸¸å®ä¾‹ã€‚å¦‚æœæ›´ä¹ æƒ¯äºåˆ†å¼€å¤„ç†æ­£å¸¸æ‰§è¡Œå®Œæ¯•çš„ç»“æœå’Œå¼‚å¸¸æ‰§è¡Œå®Œæ¯•çš„ç»“æœï¼ŒListenableFutureCallbackå¯ä»¥è¿™æ ·å®šä¹‰ï¼š 123456public interface ListenableFutureCallback&lt;V&gt; &#123; void onSuccess(V value); void onError(Throwable throwable);&#125; æ¥ç€å®šä¹‰ListenableExecutorServiceæ¥å£ç»§æ‰¿ExecutorServiceæ¥å£ï¼š 1234567891011121314public interface ListenableExecutorService extends ExecutorService &#123; &lt;T&gt; ListenableFuture&lt;T&gt; listenableSubmit(Callable&lt;T&gt; callable); /** * å®šä¹‰è¿™ä¸ªæ–¹æ³•æ˜¯å› ä¸ºæœ‰äº›æ—¶å€™ç”±äºä»»åŠ¡æ‰§è¡Œæ—¶é—´éå¸¸çŸ­ï¼Œæœ‰å¯èƒ½é€šè¿‡è¿”å›çš„ListenableFutureå®ä¾‹æ·»åŠ å›è°ƒä¹‹å‰å·²ç»æ‰§è¡Œå®Œæ¯•ï¼Œå› æ­¤å¯ä»¥æ”¯æŒæ˜¾å¼ä¼ å…¥å›è°ƒ * * @param callable callable * @param callbacks callbacks * @param executor executor * @return ListenableFuture */ &lt;T&gt; ListenableFuture&lt;T&gt; listenableSubmit(Callable&lt;T&gt; callable, List&lt;ListenableFutureCallback&lt;T&gt;&gt; callbacks, Executor executor);&#125; ç„¶åæ·»åŠ ä¸€ä¸ªæ‰§è¡Œå•å…ƒé€‚é…å™¨ListenableFutureCallbackRunnableï¼Œæ‰¿è½½æ¯æ¬¡å›è°ƒè§¦å‘çš„è°ƒç”¨ï¼ˆå®ç°Runnableæ¥å£ï¼Œä»è€Œæ”¯æŒå¼‚æ­¥æ‰§è¡Œï¼‰ï¼š 123456789101112@RequiredArgsConstructorpublic class ListenableFutureCallbackRunnable&lt;V&gt; implements Runnable &#123; private final ListenableFutureCallback&lt;V&gt; callback; private final V value; private final Throwable throwable; @Override public void run() &#123; callback.callback(value, throwable); &#125;&#125; æ¥ç€éœ€è¦å®šä¹‰ä¸€ä¸ªFutureTaskçš„å­ç±»ListenableFutureTaskï¼Œæ ¸å¿ƒé€»è¾‘æ˜¯è¦†ç›–FutureTask#done()æ–¹æ³•è§¦å‘å›è°ƒï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657// ListenableFutureTaskpublic class ListenableFutureTask&lt;V&gt; extends FutureTask&lt;V&gt; implements ListenableFuture&lt;V&gt; &#123; private final List&lt;Execution&lt;V&gt;&gt; executions = new ArrayList&lt;&gt;(); public ListenableFutureTask(Callable&lt;V&gt; callable) &#123; super(callable); &#125; public ListenableFutureTask(Runnable runnable, V result) &#123; super(runnable, result); &#125; public static &lt;V&gt; ListenableFutureTask&lt;V&gt; newTaskFor(Callable&lt;V&gt; callable) &#123; return new ListenableFutureTask&lt;&gt;(callable); &#125; @Override protected void done() &#123; Iterator&lt;Execution&lt;V&gt;&gt; iterator = executions.iterator(); Throwable throwable = null; V value = null; try &#123; value = get(); &#125; catch (Throwable t) &#123; throwable = t; &#125; while (iterator.hasNext()) &#123; Execution&lt;V&gt; execution = iterator.next(); ListenableFutureCallbackRunnable&lt;V&gt; callbackRunnable = new ListenableFutureCallbackRunnable&lt;&gt;(execution.getCallback(), value, throwable); // å¼‚æ­¥å›è°ƒ if (null != execution.getExecutor()) &#123; execution.getExecutor().execute(callbackRunnable); &#125; else &#123; // åŒæ­¥å›è°ƒ callbackRunnable.run(); &#125; &#125; &#125; @Override public void addCallback(ListenableFutureCallback&lt;V&gt; callback, Executor executor) &#123; Execution&lt;V&gt; execution = new Execution&lt;&gt;(); execution.setCallback(callback); execution.setExecutor(executor); executions.add(execution); &#125;&#125;// Execution - æ‰¿è½½æ¯ä¸ªå›è°ƒå®ä¾‹å’Œå¯¹åº”çš„Executorï¼ŒExecutorå®ä¾‹ä¸ºnullåˆ™è¿›è¡ŒåŒæ­¥å›è°ƒ@Datapublic class Execution &lt;V&gt;&#123; private Executor executor; private ListenableFutureCallback&lt;V&gt; callback;&#125; æœ€åä¸€æ­¥å°±æ˜¯ç¼–å†™çº¿ç¨‹æ± ListenableThreadPoolExecutorï¼Œç»§æ‰¿è‡ªThreadPoolExecutorå¹¶ä¸”å®ç°ListenableExecutorServiceæ¥å£ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647public class ListenableThreadPoolExecutor extends ThreadPoolExecutor implements ListenableExecutorService &#123; public ListenableThreadPoolExecutor(int corePoolSize, int maximumPoolSize, long keepAliveTime, TimeUnit unit, BlockingQueue&lt;Runnable&gt; workQueue) &#123; super(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue); &#125; public ListenableThreadPoolExecutor(int corePoolSize, int maximumPoolSize, long keepAliveTime, TimeUnit unit, BlockingQueue&lt;Runnable&gt; workQueue, ThreadFactory threadFactory) &#123; super(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue, threadFactory); &#125; public ListenableThreadPoolExecutor(int corePoolSize, int maximumPoolSize, long keepAliveTime, TimeUnit unit, BlockingQueue&lt;Runnable&gt; workQueue, RejectedExecutionHandler handler) &#123; super(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue, handler); &#125; public ListenableThreadPoolExecutor(int corePoolSize, int maximumPoolSize, long keepAliveTime, TimeUnit unit, BlockingQueue&lt;Runnable&gt; workQueue, ThreadFactory threadFactory, RejectedExecutionHandler handler) &#123; super(corePoolSize, maximumPoolSize, keepAliveTime, unit, workQueue, threadFactory, handler); &#125; @Override public &lt;T&gt; ListenableFuture&lt;T&gt; listenableSubmit(Callable&lt;T&gt; callable) &#123; if (null == callable) &#123; throw new IllegalArgumentException(\"callable\"); &#125; ListenableFutureTask&lt;T&gt; listenableFutureTask = ListenableFutureTask.newTaskFor(callable); execute(listenableFutureTask); return listenableFutureTask; &#125; @Override public &lt;T&gt; ListenableFuture&lt;T&gt; listenableSubmit(Callable&lt;T&gt; callable, List&lt;ListenableFutureCallback&lt;T&gt;&gt; callbacks, Executor executor) &#123; if (null == callable) &#123; throw new IllegalArgumentException(\"callable\"); &#125; if (null == callbacks) &#123; throw new IllegalArgumentException(\"callbacks\"); &#125; ListenableFutureTask&lt;T&gt; listenableFutureTask = ListenableFutureTask.newTaskFor(callable); for (ListenableFutureCallback&lt;T&gt; callback : callbacks) &#123; listenableFutureTask.addCallback(callback, executor); &#125; execute(listenableFutureTask); return listenableFutureTask; &#125;&#125; æµ‹è¯• å¼•å…¥junitï¼Œç¼–å†™æµ‹è¯•ç±»å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273public class ListenableFutureTest &#123; private static ListenableExecutorService EXECUTOR; private static Executor E; @BeforeClass public static void before() &#123; EXECUTOR = new ListenableThreadPoolExecutor(1, 3, 0, TimeUnit.SECONDS, new ArrayBlockingQueue&lt;&gt;(10), new ThreadFactory() &#123; private final AtomicInteger counter = new AtomicInteger(); @Override public Thread newThread(Runnable r) &#123; Thread thread = new Thread(r); thread.setDaemon(true); thread.setName(String.format(\"ListenableWorker-%d\", counter.getAndIncrement())); return thread; &#125; &#125;); E = Executors.newFixedThreadPool(3); &#125; @Test public void testListenableFuture1() throws Exception &#123; ListenableFuture&lt;String&gt; future = EXECUTOR.listenableSubmit(() -&gt; &#123; Thread.sleep(1000); return \"message\"; &#125;); future.addCallback((v, t) -&gt; &#123; System.out.println(String.format(\"Value = %s,Throwable = %s\", v, t)); &#125;, null); Thread.sleep(2000); &#125; @Test public void testListenableFuture2() throws Exception &#123; ListenableFuture&lt;String&gt; future = EXECUTOR.listenableSubmit(() -&gt; &#123; Thread.sleep(1000); throw new RuntimeException(\"exception\"); &#125;); future.addCallback((v, t) -&gt; &#123; System.out.println(String.format(\"Value = %s,Throwable = %s\", v, t)); &#125;, null); Thread.sleep(2000); &#125; @Test public void testListenableFuture3() throws Exception &#123; ListenableFuture&lt;String&gt; future = EXECUTOR.listenableSubmit(() -&gt; &#123; Thread.sleep(1000); return \"message\"; &#125;); future.addCallback((v, t) -&gt; &#123; System.out.println(String.format(\"Value = %s,Throwable = %s\", v, t)); &#125;, E); System.out.println(\"testListenableFuture3 end...\"); Thread.sleep(2000); &#125; @Test public void testListenableFuture4() throws Exception &#123; ListenableFuture&lt;String&gt; future = EXECUTOR.listenableSubmit(() -&gt; &#123; Thread.sleep(1000); throw new RuntimeException(\"exception\"); &#125;); future.addCallback((v, t) -&gt; &#123; System.out.println(String.format(\"Value = %s,Throwable = %s\", v, t)); &#125;, E); System.out.println(\"testListenableFuture4 end...\"); Thread.sleep(2000); &#125;&#125; æ‰§è¡Œç»“æœ: 12345678910111213// testListenableFuture1Value = message,Throwable = null// testListenableFuture2Value = null,Throwable = java.util.concurrent.ExecutionException: java.lang.RuntimeException: exception// testListenableFuture3testListenableFuture3 end...Value = message,Throwable = null// testListenableFuture4testListenableFuture4 end...Value = null,Throwable = java.util.concurrent.ExecutionException: java.lang.RuntimeException: exception å’Œé¢„æœŸçš„ç»“æœä¸€è‡´ï¼Œæ³¨æ„ä¸€ä¸‹å¦‚æœCallableæ‰§è¡ŒæŠ›å‡ºå¼‚å¸¸ï¼Œå¼‚å¸¸è¢«åŒ…è£…ä¸ºExecutionExceptionï¼Œè¦è°ƒç”¨Throwable#getCause()æ‰èƒ½å¾—åˆ°åŸå§‹çš„å¼‚å¸¸å®ä¾‹ã€‚ å°ç»“ æœ¬æ–‡é€šè¿‡äº†è§£ThreadPoolExecutorå’ŒFutureçš„å®ç°åŸç†åšç®€å•çš„æ‰©å±•ï¼Œä½¿å¾—å¼‚æ­¥æäº¤ä»»åŠ¡å˜å¾—æ›´åŠ ä¼˜é›…å’Œç®€ä¾¿ã€‚å¼ºåŒ–äº†åŠ¨æ‰‹èƒ½åŠ›çš„åŒæ—¶ï¼Œä¹Ÿèƒ½åŠ æ·±å¯¹å¹¶å‘ç¼–ç¨‹çš„ä¸€äº›è®¤çŸ¥ã€‚å½“ç„¶ï¼Œæœ¬æ–‡åªæ˜¯æä¾›ä¸€ä¸ªååˆ†ç®€é™‹çš„å®ç°ï¼Œç¬”è€…å…¶å®è¿˜æƒ³åˆ°äº†å¦‚å¯¹å›è°ƒå¤„ç†çš„è€—æ—¶åšç›‘æ§ã€å›è°ƒæ‰“ä¸Šåˆ†ç»„æ ‡ç­¾æ‰§è¡Œç­‰ç­‰æ›´å®Œå–„çš„åŠŸèƒ½ï¼Œç­‰åˆ°æœ‰éœ€è¦çš„åœºæ™¯å†è¿›è¡Œå®ç°ã€‚ è¿™é‡Œè®°å½•ä¸€ä¸‹è¿‡ç¨‹ä¸­çš„ä¸€äº›é¢†æ‚Ÿï¼š Executor#execute()æ˜¯çº¿ç¨‹æ± çš„æ ¸å¿ƒæ¥å£ï¼Œæ‰€æœ‰å…¶ä»–åŠŸèƒ½éƒ½æ˜¯åŸºäºæ­¤æ¥å£åšæ‰©å±•ï¼Œå®ƒçš„è®¾è®¡æœ¬èº«æ˜¯æ— çŠ¶æ€çš„ã€‚ çµæ´»ä½¿ç”¨é€‚é…å™¨æ¨¡å¼ï¼Œå¯ä»¥åœ¨ä¸æ”¹å˜å·²å‘å¸ƒçš„æ¥å£çš„åŠŸèƒ½åŒæ—¶å®ç°æ–°çš„æ¥å£çš„åŠŸèƒ½é€‚é…ã€‚ è¦å–„äºå‘æ˜å’Œä½¿ç”¨JDKç±»åº“è®¾è®¡è€…ç•™ç»™å¼€å‘è€…çš„æ‰©å±•æ¥å£ã€‚ ï¼ˆæœ¬æ–‡å®Œ c-1-d e-a-20190702ï¼‰","categories":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/categories/Java/"},{"name":"Concurrency","slug":"Java/Concurrency","permalink":"http://throwable.club/blog/categories/Java/Concurrency/"}],"tags":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/tags/Java/"},{"name":"ListenableFuture","slug":"ListenableFuture","permalink":"http://throwable.club/blog/tags/ListenableFuture/"}]},{"title":"æ·±å…¥ç†è§£Instrument(ä¸€)","slug":"java-understand-instrument-first","date":"2019-06-29T10:22:39.000Z","updated":"2019-06-30T02:29:22.568Z","comments":true,"path":"2019/06/29/java-understand-instrument-first/","link":"","permalink":"http://throwable.club/2019/06/29/java-understand-instrument-first/","excerpt":"å‰æ å¾ˆæ—©ä¹‹å‰å°±äº†è§£åˆ°ç›®å‰ä¸»æµçš„APMå¼€æºæ¡†æ¶å¦‚Pinpointã€SkyWalkingç­‰ç­‰éƒ½æ˜¯é€šè¿‡java.lang.instrumentåŒ…æä¾›çš„å­—èŠ‚ç å¢å¼ºåŠŸèƒ½æ¥å®ç°çš„ã€‚è¶ç€å¯¹è¿™å—çš„çƒ­æƒ…è¿˜æ²¡æ¶ˆé€€ï¼ŒæŠ½æ—¶é—´åˆ†æä¸€ä¸‹java.lang.instrumentåŒ…çš„ä½¿ç”¨æ–¹å¼ï¼Œè®°å½•ä¸‹æ¥å†™æˆä¸€ä¸ªç³»åˆ—çš„æ–‡ç« ã€‚æœ¬ç³»åˆ—åšæ–‡é’ˆå¯¹çš„æ˜¯JDK11ï¼Œå…¶ä»–ç‰ˆæœ¬çš„JDKå¯èƒ½ä¸é€‚åˆã€‚","text":"å‰æ å¾ˆæ—©ä¹‹å‰å°±äº†è§£åˆ°ç›®å‰ä¸»æµçš„APMå¼€æºæ¡†æ¶å¦‚Pinpointã€SkyWalkingç­‰ç­‰éƒ½æ˜¯é€šè¿‡java.lang.instrumentåŒ…æä¾›çš„å­—èŠ‚ç å¢å¼ºåŠŸèƒ½æ¥å®ç°çš„ã€‚è¶ç€å¯¹è¿™å—çš„çƒ­æƒ…è¿˜æ²¡æ¶ˆé€€ï¼ŒæŠ½æ—¶é—´åˆ†æä¸€ä¸‹java.lang.instrumentåŒ…çš„ä½¿ç”¨æ–¹å¼ï¼Œè®°å½•ä¸‹æ¥å†™æˆä¸€ä¸ªç³»åˆ—çš„æ–‡ç« ã€‚æœ¬ç³»åˆ—åšæ–‡é’ˆå¯¹çš„æ˜¯JDK11ï¼Œå…¶ä»–ç‰ˆæœ¬çš„JDKå¯èƒ½ä¸é€‚åˆã€‚ instrumentç®€ä»‹ java.lang.instrumentåŒ…çš„ç»“æ„å¦‚ä¸‹ï¼š 1234567java.lang.instrument - ClassDefinition - ClassFileTransformer - IllegalClassFormatException - Instrumentation - UnmodifiableClassException - UnmodifiableModuleException å…¶ä¸­ï¼Œæ ¸å¿ƒåŠŸèƒ½ç”±æ¥å£java.lang.instrument.Instrumentationæä¾›ï¼Œè¿™é‡Œå¯ä»¥é€šè¿‡Instrumentationç±»çš„APIæ³¨é‡Šæ¥ç†è§£ä¸€ä¸‹ä»€ä¹ˆæ˜¯instrumentï¼š Instrumentationç±»æä¾›æ§åˆ¶Javaè¯­è¨€ç¨‹åºä»£ç çš„æœåŠ¡ã€‚Instrumentationå¯ä»¥å®ç°åœ¨æ–¹æ³•æ’å…¥é¢å¤–çš„å­—èŠ‚ç ä»è€Œè¾¾åˆ°æ”¶é›†ä½¿ç”¨ä¸­çš„æ•°æ®åˆ°æŒ‡å®šå·¥å…·çš„ç›®çš„ã€‚ç”±äºæ’å…¥çš„å­—èŠ‚ç æ˜¯é™„åŠ çš„ï¼Œè¿™äº›æ›´å˜ä¸ä¼šä¿®æ”¹åŸæ¥ç¨‹åºçš„çŠ¶æ€æˆ–è€…è¡Œä¸ºã€‚é€šè¿‡è¿™ç§æ–¹å¼å®ç°çš„è‰¯æ€§å·¥å…·åŒ…æ‹¬ç›‘æ§ä»£ç†ã€åˆ†æå™¨ã€è¦†ç›–åˆ†æç¨‹åºå’Œäº‹ä»¶æ—¥å¿—è®°å½•ç¨‹åºç­‰ç­‰ã€‚ ä¹Ÿå°±æ˜¯è¯´ï¼Œjava.lang.instrumentåŒ…çš„æœ€å¤§åŠŸèƒ½å°±æ˜¯å¯ä»¥åœ¨å·²æœ‰çš„ç±»ä¸Šé™„åŠ ï¼ˆä¿®æ”¹ï¼‰å­—èŠ‚ç æ¥å®ç°å¢å¼ºçš„é€»è¾‘ï¼Œå¦‚æœè‰¯æ€§ä½¿ç”¨å½“ç„¶ä¸ä¼šå½±å“ç¨‹åºçš„æ­£å¸¸è¡Œä¸ºï¼Œå¦‚æœæ¶æ€§ä½¿ç”¨å°±å¯èƒ½äº§ç”Ÿä¸€äº›è´Ÿé¢çš„å½±å“ï¼ˆå…¶å®å¾ˆå¤šå•†ç”¨Javaç¨‹åºå¦‚IntelliJ IDEAçš„Licenseçš„ç ´è§£éƒ½å¯ä»¥åŸºäºInstrumentationçš„åŠŸèƒ½å®ç°ï¼Œå‰ææ˜¯æ‰¾åˆ°ç¨‹åºè®¤è¯Licenseçš„å…¥å£ï¼‰ã€‚ instrumentåŸç† instrumentçš„åº•å±‚å®ç°ä¾èµ–äºJVMTIï¼Œä¹Ÿå°±æ˜¯JVM Tool Interfaceï¼Œå®ƒæ˜¯JVMæš´éœ²å‡ºæ¥çš„ä¸€äº›ä¾›ç”¨æˆ·æ‰©å±•çš„æ¥å£é›†åˆï¼ŒJVMTIæ˜¯åŸºäºäº‹ä»¶é©±åŠ¨çš„ï¼ŒJVMæ¯æ‰§è¡Œåˆ°ä¸€å®šçš„é€»è¾‘å°±ä¼šè°ƒç”¨ä¸€äº›äº‹ä»¶çš„å›è°ƒæ¥å£ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ï¼Œè¿™äº›æ¥å£å¯ä»¥ä¾›å¼€å‘è€…å»æ‰©å±•è‡ªå·±çš„é€»è¾‘ã€‚JVMTIAgentæ˜¯ä¸€ä¸ªåˆ©ç”¨JVMTIæš´éœ²å‡ºæ¥çš„æ¥å£æä¾›äº†ä»£ç†å¯åŠ¨æ—¶åŠ è½½(agent on load)ã€ä»£ç†é€šè¿‡attachå½¢å¼åŠ è½½(agent on attach)å’Œä»£ç†å¸è½½(agent on unload)åŠŸèƒ½çš„åŠ¨æ€åº“ã€‚è€Œinstrument agentå¯ä»¥ç†è§£ä¸ºä¸€ç±»JVMTIAgentåŠ¨æ€åº“ï¼Œåˆ«åæ˜¯JPLISAgent(Java Programming Language Instrumentation Services Agent)ï¼Œä¹Ÿå°±æ˜¯ä¸“é—¨ä¸ºjavaè¯­è¨€ç¼–å†™çš„æ’æ¡©æœåŠ¡æä¾›æ”¯æŒçš„ä»£ç†ã€‚å› ä¸ºæ¶‰åŠåˆ°æºç åˆ†æï¼Œç¬”è€…æš‚æ—¶æ²¡èƒ½åŠ›å±•å¼€ï¼Œå¯ä»¥è¯¦ç»†é˜…è¯»å‚è€ƒèµ„æ–™ä¸­ä½ å‡ç¬¨å¤§ç¥çš„é‚£ç¯‡ä¸“é—¨åˆ†æJVMç›¸å…³æºç å®ç°çš„æ–‡ç« ã€‚ å…¶ä¸­ï¼ŒVMå¯åŠ¨æ—¶åŠ è½½Agentå¯ä»¥ä½¿ç”¨å‘½ä»¤è¡Œå‚æ•°-javaagent:yourAgent.jarçš„å½¢å¼å®ç°ã€‚ Instrumentationæ¥å£è¯¦è§£ void addTransformer(ClassFileTransformer transformer, boolean canRetransform) æ³¨å†ŒClassFileTransformerå®ä¾‹ï¼Œæ³¨å†Œå¤šä¸ªä¼šæŒ‰ç…§æ³¨å†Œé¡ºåºè¿›è¡Œè°ƒç”¨ã€‚æ‰€æœ‰çš„ç±»è¢«åŠ è½½å®Œæ¯•ä¹‹åä¼šè°ƒç”¨ClassFileTransformerå®ä¾‹ï¼Œç›¸å½“äºå®ƒä»¬é€šè¿‡äº†redefineClassesæ–¹æ³•è¿›è¡Œé‡å®šä¹‰ã€‚å¸ƒå°”å€¼å‚æ•°canRetransformå†³å®šè¿™é‡Œè¢«é‡å®šä¹‰çš„ç±»æ˜¯å¦èƒ½å¤Ÿé€šè¿‡retransformClassesæ–¹æ³•è¿›è¡Œå›æ»šã€‚ void addTransformer(ClassFileTransformer transformer) ç›¸å½“äºaddTransformer(transformer, false)ï¼Œä¹Ÿå°±æ˜¯é€šè¿‡ClassFileTransformerå®ä¾‹é‡å®šä¹‰çš„ç±»ä¸èƒ½è¿›è¡Œå›æ»šã€‚ boolean removeTransformer(ClassFileTransformer transformer) ç§»é™¤(åæ³¨å†Œ)ClassFileTransformerå®ä¾‹ã€‚ boolean isRetransformClassesSupported() è¿”å›å½“å‰JVMé…ç½®æ˜¯å¦æ”¯æŒç±»é‡æ–°è½¬æ¢çš„ç‰¹æ€§ã€‚ void retransformClasses(Class&lt;?&gt;... classes) throws UnmodifiableClassException å·²åŠ è½½ç±»è¿›è¡Œé‡æ–°è½¬æ¢çš„æ–¹æ³•ï¼Œé‡æ–°è½¬æ¢çš„ç±»ä¼šè¢«å›è°ƒåˆ°ClassFileTransformerçš„åˆ—è¡¨ä¸­è¿›è¡Œå¤„ç†ï¼Œæƒ³æ·±å…¥ç†è§£å»ºè®®é˜…è¯»APIæ³¨é‡Šã€‚ boolean isRedefineClassesSupported() è¿”å›å½“å‰JVMé…ç½®æ˜¯å¦æ”¯æŒé‡å®šä¹‰ç±»ï¼ˆä¿®æ”¹ç±»çš„å­—èŠ‚ç ï¼‰çš„ç‰¹æ€§ã€‚ void redefineClasses(ClassDefinition... definitions) throws ClassNotFoundException, UnmodifiableClassException é‡å®šä¹‰ç±»ï¼Œä¹Ÿå°±æ˜¯å¯¹å·²ç»åŠ è½½çš„ç±»è¿›è¡Œé‡å®šä¹‰ï¼ŒClassDefinitionç±»å‹çš„å…¥å‚åŒ…æ‹¬äº†å¯¹åº”çš„ç±»å‹Class&lt;?&gt;å¯¹è±¡å’Œå­—èŠ‚ç æ–‡ä»¶å¯¹åº”çš„å­—èŠ‚æ•°ç»„ã€‚ å…¶ä»–åŠŸèƒ½ï¼š boolean isModifiableClass(Class&lt;?&gt; theClass)ï¼šåˆ¤æ–­å¯¹åº”ç±»æ˜¯å¦è¢«ä¿®æ”¹è¿‡ã€‚ Class[] getAllLoadedClasses()ï¼šè·å–æ‰€æœ‰å·²ç»è¢«åŠ è½½çš„ç±»ã€‚ Class[] getInitiatedClasses(ClassLoader loader)ï¼šè·å–æ‰€æœ‰å·²ç»è¢«åˆå§‹åŒ–è¿‡äº†çš„ç±»ã€‚ long getObjectSize(Object objectToSize)ï¼šè·å–æŸä¸ªå¯¹è±¡çš„(å­—èŠ‚)å¤§å°ï¼Œæ³¨æ„åµŒå¥—å¯¹è±¡æˆ–è€…å¯¹è±¡ä¸­çš„å±æ€§å¼•ç”¨éœ€è¦å¦å¤–å•ç‹¬è®¡ç®—ã€‚ void appendToBootstrapClassLoaderSearch(JarFile jarfile)ï¼šå°†æŸä¸ªjaråŠ å…¥åˆ°Bootstrap Classpathé‡Œä¼˜å…ˆå…¶ä»–jarè¢«åŠ è½½ã€‚ void appendToSystemClassLoaderSearch(JarFile jarfile)ï¼šå°†æŸä¸ªjaråŠ å…¥åˆ°Classpathé‡Œä¾›AppClassloardå»åŠ è½½ã€‚ void setNativeMethodPrefix(ClassFileTransformer transformer, String prefix)ï¼šè®¾ç½®æŸäº›nativeæ–¹æ³•çš„å‰ç¼€ï¼Œä¸»è¦åœ¨æ‰¾nativeæ–¹æ³•çš„æ—¶å€™åšè§„åˆ™åŒ¹é…ã€‚ boolean isNativeMethodPrefixSupported()ï¼šæ˜¯å¦æ”¯æŒè®¾ç½®nativeæ–¹æ³•çš„å‰ç¼€ã€‚ void redefineModule(...)ï¼šé‡å®šä¹‰Moduleã€‚ boolean isModifiableModule(Module module)ï¼šåˆ¤æ–­æŒ‡å®šModuleæ˜¯å¦é‡å®šä¹‰è¿‡ã€‚ å¦‚ä½•ä½¿ç”¨Instrumentation Instrumentationç±»åœ¨APIæ³¨é‡Šä¸­æœ‰ååˆ†ç®€æ´çš„ä½¿ç”¨æ–¹å¼æè¿°ï¼š æœ‰ä¸¤ç§æ–¹å¼å¯ä»¥è·å–Instrumentationæ¥å£çš„å®ä¾‹ï¼š JVMåœ¨æŒ‡å®šä»£ç†çš„æ–¹å¼ä¸‹å¯åŠ¨ï¼Œæ­¤æ—¶Instrumentationå®ä¾‹ä¼šä¼ é€’åˆ°ä»£ç†ç±»çš„premainæ–¹æ³•ã€‚ JVMæä¾›ä¸€ç§åœ¨å¯åŠ¨ä¹‹åçš„æŸä¸ªæ—¶åˆ»å¯åŠ¨ä»£ç†çš„æœºåˆ¶ï¼Œæ­¤æ—¶Instrumentationå®ä¾‹ä¼šä¼ é€’åˆ°ä»£ç†ç±»ä»£ç çš„agentmainæ–¹æ³•ã€‚ é¦–å…ˆæˆ‘ä»¬çŸ¥é“Instrumentationçš„å®ç°ç±»æ˜¯sun.instrument.InstrumentationImplï¼Œåœ¨JDK9ä¹‹åï¼Œç”±äºæ¨¡å—æƒé™æ§åˆ¶ï¼Œä¸å¯èƒ½é€šè¿‡åå°„æ„é€ å…¶å®ä¾‹ï¼Œä¸€èˆ¬æƒ…å†µä¸‹åå°„åšä¸åˆ°çš„ä¸œè¥¿åªèƒ½é€šè¿‡JVMå®ç°ã€‚è€Œä¸”æ ¹æ®ä¸Šé¢ç®€æ´çš„APIæ³¨é‡Šæˆ‘ä»¬æ˜¯æ— æ³•å¾—çŸ¥å¦‚ä½•ä½¿ç”¨Instrumentationã€‚å…¶å®ï¼Œpremainå¯¹åº”çš„å°±æ˜¯VMå¯åŠ¨æ—¶çš„Instrument AgentåŠ è½½ï¼Œä¹Ÿå°±æ˜¯ä¸Šæ–‡æåˆ°çš„agent on loadï¼Œè€Œagentmainå¯¹åº”çš„æ˜¯VMè¿è¡Œæ—¶çš„Instrument AgentåŠ è½½ï¼Œä¹Ÿå°±æ˜¯ä¸Šæ–‡æåˆ°çš„agent on attachã€‚ä¸¤ç§åŠ è½½å½¢å¼æ‰€åŠ è½½çš„Instrument Agentéƒ½å…³æ³¨åŒä¸€ä¸ªJVMTIäº‹ä»¶ â€“ ClassFileLoadHookäº‹ä»¶ï¼Œè€Œè¿™ä¸ªäº‹ä»¶æ˜¯åœ¨è¯»å–å­—èŠ‚ç æ–‡ä»¶ä¹‹åå›è°ƒæ—¶ç”¨ã€‚æ¢è¨€ä¹‹ï¼Œpremainå’Œagentmainæ–¹å¼çš„å›è°ƒæ—¶æœºéƒ½æ˜¯ç±»æ–‡ä»¶å­—èŠ‚ç è¯»å–ä¹‹åï¼ˆæˆ–è€…è¯´æ˜¯ç±»åŠ è½½ä¹‹åï¼‰ã€‚ å®é™…ä¸Šï¼Œpremainå’Œagentmainä¸¤ç§æ–¹å¼æœ€ç»ˆçš„ç›®çš„éƒ½æ˜¯ä¸ºäº†å›è°ƒInstrumentationå®ä¾‹å¹¶ä¸”æ¿€æ´»sun.instrument.InstrumentationImpl#transform()ä»è€Œå›è°ƒæ³¨å†Œåˆ°Instrumentationä¸­çš„ClassFileTransformerå®ç°å­—èŠ‚ç ä¿®æ”¹ï¼Œæœ¬è´¨åŠŸèƒ½ä¸Šæ²¡æœ‰å¾ˆå¤§åŒºåˆ«ã€‚ä¸¤è€…çš„éæœ¬è´¨åŠŸèƒ½çš„åŒºåˆ«å¦‚ä¸‹ï¼š premainéœ€è¦é€šè¿‡å‘½ä»¤è¡Œä½¿ç”¨å¤–éƒ¨ä»£ç†jaråŒ…ï¼›è€Œagentmainåˆ™å¯ä»¥é€šè¿‡attachæœºåˆ¶ç›´æ¥é™„ç€åˆ°ç›®æ ‡VMä¸­åŠ è½½ä»£ç†ï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨agentmainæ–¹å¼ä¸‹ï¼Œæ“ä½œattachçš„ç¨‹åºå’Œè¢«ä»£ç†çš„ç¨‹åºå¯ä»¥æ˜¯å®Œå…¨ä¸åŒçš„ä¸¤ä¸ªç¨‹åºã€‚ premainæ–¹å¼å›è°ƒåˆ°ClassFileTransformerä¸­çš„ç±»æ˜¯è™šæ‹ŸæœºåŠ è½½çš„æ‰€æœ‰ç±»ï¼Œè¿™ä¸ªæ˜¯ç”±äºä»£ç†åŠ è½½çš„é¡ºåºæ¯”è¾ƒé å‰å†³å®šçš„ï¼Œåœ¨å¼€å‘è€…é€»è¾‘çœ‹æ¥å°±æ˜¯ï¼šæ‰€æœ‰ç±»é¦–æ¬¡åŠ è½½å¹¶ä¸”è¿›å…¥ç¨‹åºmain()æ–¹æ³•ä¹‹å‰ï¼Œpremainæ–¹æ³•ä¼šè¢«æ¿€æ´»ï¼Œç„¶åæ‰€æœ‰è¢«åŠ è½½çš„ç±»éƒ½ä¼šæ‰§è¡ŒClassFileTransformeråˆ—è¡¨ä¸­çš„å›è°ƒã€‚ agentmainæ–¹å¼ç”±äºæ˜¯é‡‡ç”¨attachæœºåˆ¶ï¼Œè¢«ä»£ç†çš„ç›®æ ‡ç¨‹åºVMæœ‰å¯èƒ½å¾ˆæ—©ä¹‹å‰å·²ç»å¯åŠ¨ï¼Œå½“ç„¶å…¶æ‰€æœ‰ç±»å·²ç»è¢«åŠ è½½å®Œæˆï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦å€ŸåŠ©Instrumentation#retransformClasses(Class&lt;?&gt;... classes)è®©å¯¹åº”çš„ç±»å¯ä»¥é‡æ–°è½¬æ¢ï¼Œä»è€Œæ¿€æ´»é‡æ–°è½¬æ¢çš„ç±»æ‰§è¡ŒClassFileTransformeråˆ—è¡¨ä¸­çš„å›è°ƒã€‚ premainæ–¹å¼æ˜¯JDK1.5å¼•å…¥çš„ï¼Œè€Œagentmainæ–¹å¼æ˜¯JDK1.6å¼•å…¥çš„ï¼Œä¹Ÿå°±æ˜¯JDK1.6ä¹‹åå¯ä»¥è‡ªè¡Œé€‰æ‹©ä½¿ç”¨premainæˆ–è€…agentmainã€‚ premainä½¿ç”¨æ–¹å¼ premainæ–¹å¼ä¾èµ–ç‹¬ç«‹çš„javaagentï¼Œä¹Ÿå°±æ˜¯å•ç‹¬å»ºç«‹ä¸€ä¸ªé¡¹ç›®ç¼–å†™å¥½ä»£ç ä¹‹åæ‰“æˆjaråŒ…ä¾›å¦ä¸€ä¸ªä½¿ç”¨ç¨‹åºé€šè¿‡ä»£ç†å½¢å¼å¼•å…¥ã€‚ç®€å•çš„æ­¥éª¤å¦‚ä¸‹ï¼š ç¼–å†™premainå‡½æ•°ï¼Œä¹Ÿå°±æ˜¯ç¼–å†™ä¸€ä¸ªæ™®é€šçš„Javaç±»ï¼ŒåŒ…å«ä¸‹é¢ä¸¤ä¸ªæ–¹æ³•çš„å…¶ä¸­ä¹‹ä¸€ã€‚ 12public static void premain(String agentArgs, Instrumentation inst); [1]public static void premain(String agentArgs); [2] [1]çš„å›è°ƒä¼˜å…ˆçº§ä¼šæ¯”[2]é«˜ï¼Œä¹Ÿå°±æ˜¯[1]å’Œ[2]åŒæ—¶å­˜åœ¨çš„æƒ…å†µä¸‹ï¼Œåªæœ‰[1]ä¼šè¢«å›è°ƒã€‚è€ŒagentArgsæ˜¯premainå‡½æ•°å¾—åˆ°çš„ç¨‹åºå‚æ•°ï¼Œé€šè¿‡â€“ javaagentå‘½ä»¤è¡Œå‚æ•°ä¼ å…¥ã€‚ ä»£ç†æœåŠ¡æ‰“åŒ…ä¸ºJarã€‚ Agentä¸€èˆ¬æ˜¯ä¸€ä¸ªæ™®é€šçš„JavaæœåŠ¡ï¼Œåªæ˜¯éœ€è¦ç¼–å†™premainå‡½æ•°ï¼Œå¹¶ä¸”è¯¥JaråŒ…çš„manifest(ä¹Ÿå°±æ˜¯MANIFEST.MFæ–‡ä»¶)å±æ€§ä¸­éœ€è¦åŠ å…¥Premain-Classæ¥æŒ‡å®šæ­¥éª¤1ä¸­ç¼–å†™å¥½premainå‡½æ•°çš„é‚£ä¸ªJavaç±»ã€‚ é€šè¿‡æŒ‡å®šAgentè¿è¡Œã€‚ 1java -javaagent:ä»£ç†JaråŒ…çš„è·¯å¾„ [=ä¼ å…¥premainçš„å‚æ•°] yourTarget.jar ç®€å•ä¾‹å­å¦‚ä¸‹ï¼š æ–°å»ºä¸€ä¸ªpremain-agentçš„é¡¹ç›®ï¼Œæ–°å»ºä¸€ä¸ªç±»club.throwable.permain.PermainAgentå¦‚ä¸‹ï¼š 1234567891011121314151617181920212223public class PermainAgent &#123; private static Instrumentation INST; public static void premain(String agentArgs, Instrumentation inst) &#123; INST = inst; process(); &#125; private static void process() &#123; INST.addTransformer(new ClassFileTransformer() &#123; @Override public byte[] transform(ClassLoader loader, String className, Class&lt;?&gt; clazz, ProtectionDomain protectionDomain, byte[] byteCode) throws IllegalClassFormatException &#123; System.out.println(String.format(\"Process by ClassFileTransformer,target class = %s\", className)); return byteCode; &#125; &#125;); &#125;&#125; å¼•å…¥Mavenæ’ä»¶maven-jar-pluginï¼š 12345678910111213141516&lt;plugins&gt; &lt;plugin&gt; &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt; &lt;artifactId&gt;maven-jar-plugin&lt;/artifactId&gt; &lt;version&gt;3.1.2&lt;/version&gt; &lt;configuration&gt; &lt;archive&gt; &lt;manifestEntries&gt; &lt;Premain-Class&gt;club.throwable.permain.PermainAgent&lt;/Premain-Class&gt; &lt;Can-Redefine-Classes&gt;true&lt;/Can-Redefine-Classes&gt; &lt;Can-Retransform-Classes&gt;true&lt;/Can-Retransform-Classes&gt; &lt;/manifestEntries&gt; &lt;/archive&gt; &lt;/configuration&gt; &lt;/plugin&gt;&lt;/plugins&gt; é€šè¿‡mvn packageå‘½ä»¤æ‰“åŒ…å³å¯å¾—åˆ°premain-agent.jarï¼ˆç¬”è€…å‘ç°è¯¥æ’ä»¶æœªæ”¯æŒJDK11ï¼Œæ‰€ä»¥é™çº§åˆ°JDK8ï¼‰ã€‚æ¥ç€å¯ä»¥ä½¿ç”¨è¯¥ä»£ç†Jarï¼š 123456789101112131415161718192021222324252627// è¿™ä¸ªæ˜¯æ ·å“ç±»public class HelloSample &#123; public void sayHello(String name) &#123; System.out.println(String.format(\"%s say hello!\", name)); &#125;&#125;// mainå‡½æ•°ï¼Œvmå‚æ•°ï¼š-javaagent:I:\\J-Projects\\instrument-sample\\premain-agent\\target\\premain-agent.jarpublic class PermainMain &#123; public static void main(String[] args) throws Exception&#123; &#125;&#125;// è¾“å‡ºç»“æœProcess by ClassFileTransformer,target class = sun/nio/cs/ThreadLocalCodersProcess by ClassFileTransformer,target class = sun/nio/cs/ThreadLocalCoders$1Process by ClassFileTransformer,target class = sun/nio/cs/ThreadLocalCoders$CacheProcess by ClassFileTransformer,target class = sun/nio/cs/ThreadLocalCoders$2Process by ClassFileTransformer,target class = com/intellij/rt/execution/application/AppMainV2$AgentProcess by ClassFileTransformer,target class = com/intellij/rt/execution/application/AppMainV2Process by ClassFileTransformer,target class = com/intellij/rt/execution/application/AppMainV2$1Process by ClassFileTransformer,target class = java/lang/reflect/InvocationTargetExceptionProcess by ClassFileTransformer,target class = java/net/InetAddress$1Process by ClassFileTransformer,target class = java/lang/ClassValue// ... çœç•¥å¤§é‡å…¶ä»–è¾“å‡º å®é™…ä¸Šï¼Œå¦‚æœæˆ‘ä»¬è¦å®šåˆ¶åŠŸèƒ½éœ€è¦æ’é™¤æ‰ä¸€äº›java.langåŒ…å’ŒsunåŒ…çš„ç±»ï¼Œå½“ç„¶è¿™é‡Œä»…ä»…ä½œä¸ºæ¼”ç¤ºæ‰€ä»¥æ— ä¼¤å¤§é›…ã€‚ agentmainä½¿ç”¨æ–¹å¼ agentmainçš„ä½¿ç”¨æ–¹å¼å’Œpermainååˆ†ç›¸ä¼¼ï¼ŒåŒ…æ‹¬ç¼–å†™MANIFEST.MFå’Œç”Ÿæˆä»£ç†JaråŒ…ã€‚ä½†æ˜¯ï¼Œå®ƒå¹¶ä¸éœ€è¦é€šè¿‡-javaagentå‘½ä»¤è¡Œå½¢å¼å¼•å…¥ä»£ç†Jarï¼Œè€Œæ˜¯åœ¨è¿è¡Œæ—¶é€šè¿‡attachå·¥å…·æ¿€æ´»æŒ‡å®šä»£ç†å³å¯ã€‚ç®€å•çš„æ­¥éª¤å¦‚ä¸‹ï¼š ç¼–å†™premainå‡½æ•°ï¼Œä¹Ÿå°±æ˜¯ç¼–å†™ä¸€ä¸ªæ™®é€šçš„Javaç±»ï¼ŒåŒ…å«ä¸‹é¢ä¸¤ä¸ªæ–¹æ³•çš„å…¶ä¸­ä¹‹ä¸€ã€‚ 12public static void agentmain(String agentArgs, Instrumentation inst); [1]public static void agentmain(String agentArgs); [2] [1]çš„å›è°ƒä¼˜å…ˆçº§ä¼šæ¯”[2]é«˜ï¼Œä¹Ÿå°±æ˜¯[1]å’Œ[2]åŒæ—¶å­˜åœ¨çš„æƒ…å†µä¸‹ï¼Œåªæœ‰[1]ä¼šè¢«å›è°ƒã€‚è€ŒagentArgsæ˜¯agentmainå‡½æ•°å¾—åˆ°çš„ç¨‹åºå‚æ•°ï¼Œé€šè¿‡com.sun.tools.attach.VirtualMachine#loadAgent(var1,var2)ä¸­çš„var2ä¼ å…¥ï¼Œvar1å°±æ˜¯ä»£ç†Jarçš„ç»å¯¹è·¯å¾„ã€‚ ä»£ç†æœåŠ¡æ‰“åŒ…ä¸ºJarã€‚ Agentä¸€èˆ¬æ˜¯ä¸€ä¸ªæ™®é€šçš„JavaæœåŠ¡ï¼Œåªæ˜¯éœ€è¦ç¼–å†™agentmainå‡½æ•°ï¼Œå¹¶ä¸”è¯¥JaråŒ…çš„manifest(ä¹Ÿå°±æ˜¯MANIFEST.MFæ–‡ä»¶)å±æ€§ä¸­éœ€è¦åŠ å…¥Agent-Classæ¥æŒ‡å®šæ­¥éª¤1ä¸­ç¼–å†™å¥½agentmainå‡½æ•°çš„é‚£ä¸ªJavaç±»ã€‚ é€šè¿‡attachå·¥å…·ç›´æ¥åŠ è½½Agentï¼Œæ‰§è¡Œattachçš„ç¨‹åºå’Œéœ€è¦è¢«ä»£ç†çš„ç¨‹åºå¯ä»¥æ˜¯ä¸¤ä¸ªå®Œå…¨ä¸åŒçš„ç¨‹åºã€‚ 123456// åˆ—å‡ºæ‰€æœ‰VMå®ä¾‹List&lt;VirtualMachineDescriptor&gt; list = VirtualMachine.list();// attachç›®æ ‡VMVirtualMachine.attach(descriptor.id());// ç›®æ ‡VMåŠ è½½AgentVirtualMachine#loadAgent(\"ä»£ç†Jarè·¯å¾„\",\"å‘½ä»¤å‚æ•°\"); ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼šç¼–å†™agentmainå‡½æ•°çš„ç±»å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728public class AgentmainAgent &#123; private static Instrumentation INST; public static void agentmain(String agentArgs, Instrumentation inst) &#123; INST = inst; process(); &#125; private static void process() &#123; INST.addTransformer(new ClassFileTransformer() &#123; @Override public byte[] transform(ClassLoader loader, String className, Class&lt;?&gt; clazz, ProtectionDomain protectionDomain, byte[] byteCode) throws IllegalClassFormatException &#123; System.out.println(String.format(\"Agentmain process by ClassFileTransformer,target class = %s\", className)); return byteCode; &#125; &#125;, true); try &#123; INST.retransformClasses(Class.forName(\"club.throwable.instrument.AgentTargetSample\")); &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; &#125;&#125; æ›´æ”¹Mavenæ’ä»¶maven-jar-pluginçš„é…ç½®ï¼Œç„¶åé€šè¿‡mvn pacakgeæ‰“åŒ…ï¼š 1234567891011121314151617&lt;plugins&gt; &lt;plugin&gt; &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt; &lt;artifactId&gt;maven-jar-plugin&lt;/artifactId&gt; &lt;version&gt;3.1.2&lt;/version&gt; &lt;configuration&gt; &lt;archive&gt; &lt;manifestEntries&gt; &lt;!-- ä¸»è¦æ”¹è¿™ä¸ªé…ç½®é¡¹ --&gt; &lt;Agent-Class&gt;club.throwable.agentmain.AgentmainAgent&lt;/Premain-Class&gt; &lt;Can-Redefine-Classes&gt;true&lt;/Can-Redefine-Classes&gt; &lt;Can-Retransform-Classes&gt;true&lt;/Can-Retransform-Classes&gt; &lt;/manifestEntries&gt; &lt;/archive&gt; &lt;/configuration&gt; &lt;/plugin&gt;&lt;/plugins&gt; è´Ÿè´£attachå·¥ä½œçš„ç¨‹åºAgentmainAttachMainï¼š 12345678910111213public class AgentmainAttachMain &#123; public static void main(String[] args) throws Exception &#123; List&lt;VirtualMachineDescriptor&gt; list = VirtualMachine.list(); for (VirtualMachineDescriptor descriptor : list) &#123; if (descriptor.displayName().endsWith(\"AgentTargetSample\")) &#123; VirtualMachine virtualMachine = VirtualMachine.attach(descriptor.id()); virtualMachine.loadAgent(\"I:\\\\J-Projects\\\\instrument-sample\\\\premain-agent\\\\target\\\\premain-agent.jar\", \"arg1\"); virtualMachine.detach(); &#125; &#125; &#125;&#125; è¢«ä»£ç†çš„ç›®æ ‡ç¨‹åºAgentTargetSampleï¼š 1234567891011121314public class AgentTargetSample &#123; public void sayHello(String name) &#123; System.out.println(String.format(\"%s say hello!\", name)); &#125; public static void main(String[] args) throws Exception &#123; AgentTargetSample sample = new AgentTargetSample(); for (; ; ) &#123; Thread.sleep(1000); sample.sayHello(Thread.currentThread().getName()); &#125; &#125;&#125; æ¥ç€å…ˆå¯åŠ¨AgentTargetSampleï¼Œç„¶åå†å¯åŠ¨AgentmainAttachMain: 1234567891011main say hello!main say hello!main say hello!main say hello!main say hello!main say hello!main say hello!Agentmain process by ClassFileTransformer,target class = club/throwable/instrument/AgentTargetSamplemain say hello!main say hello!main say hello! PSï¼šå¦‚æœæ²¡æœ‰æ‰¾åˆ°VirtualMachineDescriptoræˆ–è€…VirtualMachineï¼Œåªéœ€è¦æŠŠ${JAVA_HONE}/lib/tools.jaræ‹·è´åˆ°${JAVA_HONE}/jre/libç›®å½•ä¸‹å³å¯ã€‚ Instrumentationçš„å±€é™æ€§ å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬ä½¿ç”¨Instrumentationéƒ½æ˜¯ä½¿ç”¨å…¶å­—èŠ‚ç æ’æ¡©çš„åŠŸèƒ½ï¼Œæˆ–è€…ç¬¼ç»Ÿè¯´å°±æ˜¯ç±»é‡å®šä¹‰(Class Redefine)çš„åŠŸèƒ½ï¼Œä½†æ˜¯æœ‰ä»¥ä¸‹çš„å±€é™æ€§ï¼š premainå’Œagentmainä¸¤ç§æ–¹å¼ä¿®æ”¹å­—èŠ‚ç çš„æ—¶æœºéƒ½æ˜¯ç±»æ–‡ä»¶åŠ è½½ä¹‹åï¼Œä¹Ÿå°±æ˜¯è¯´å¿…é¡»è¦å¸¦æœ‰Classç±»å‹çš„å‚æ•°ï¼Œä¸èƒ½é€šè¿‡å­—èŠ‚ç æ–‡ä»¶å’Œè‡ªå®šä¹‰çš„ç±»åé‡æ–°å®šä¹‰ä¸€ä¸ªæœ¬æ¥ä¸å­˜åœ¨çš„ç±»ã€‚ ç±»çš„å­—èŠ‚ç ä¿®æ”¹ç§°ä¸ºç±»è½¬æ¢(Class Transform)ï¼Œç±»è½¬æ¢å…¶å®æœ€ç»ˆéƒ½å›å½’åˆ°ç±»é‡å®šä¹‰Instrumentation#redefineClasses()æ–¹æ³•ï¼Œæ­¤æ–¹æ³•æœ‰ä»¥ä¸‹é™åˆ¶ï¼š æ–°ç±»å’Œè€ç±»çš„çˆ¶ç±»å¿…é¡»ç›¸åŒã€‚ æ–°ç±»å’Œè€ç±»å®ç°çš„æ¥å£æ•°ä¹Ÿè¦ç›¸åŒï¼Œå¹¶ä¸”æ˜¯ç›¸åŒçš„æ¥å£ã€‚ æ–°ç±»å’Œè€ç±»è®¿é—®ç¬¦å¿…é¡»ä¸€è‡´ã€‚ æ–°ç±»å’Œè€ç±»å­—æ®µæ•°å’Œå­—æ®µåè¦ä¸€è‡´ã€‚ æ–°ç±»å’Œè€ç±»æ–°å¢æˆ–åˆ é™¤çš„æ–¹æ³•å¿…é¡»æ˜¯private static/finalä¿®é¥°çš„ã€‚ å¯ä»¥ä¿®æ”¹æ–¹æ³•ä½“ã€‚ é™¤äº†ä¸Šé¢çš„æ–¹å¼ï¼Œå¦‚æœæƒ³è¦é‡æ–°å®šä¹‰ä¸€ä¸ªç±»ï¼Œå¯ä»¥è€ƒè™‘åŸºäºç±»åŠ è½½å™¨éš”ç¦»çš„æ–¹å¼ï¼šåˆ›å»ºä¸€ä¸ªæ–°çš„è‡ªå®šä¹‰ç±»åŠ è½½å™¨å»é€šè¿‡æ–°çš„å­—èŠ‚ç å»å®šä¹‰ä¸€ä¸ªå…¨æ–°çš„ç±»ï¼Œä¸è¿‡ä¹Ÿå­˜åœ¨åªèƒ½é€šè¿‡åå°„è°ƒç”¨è¯¥å…¨æ–°ç±»çš„å±€é™æ€§ã€‚ å°ç»“ æœ¬æ–‡ä»…ä»…ç®€å•åˆ†æinstrumentçš„åŸç†å’ŒåŸºæœ¬ä½¿ç”¨ï¼Œå¯ä»¥ä½“ä¼šåˆ°instrumentè®©Javaå…·æœ‰äº†æ›´å¼ºçš„åŠ¨æ€æ§åˆ¶ã€è§£é‡Šèƒ½åŠ›ï¼Œä»è€Œè®©Javaè¯­è¨€å˜å¾—æ›´åŠ çµæ´»å¤šå˜ã€‚åœ¨JDK1.6ä¹‹åï¼Œä½¿ç”¨Instrumentationï¼Œå¼€å‘è€…å¯ä»¥æ„å»ºä¸€ä¸ªç‹¬ç«‹äºåº”ç”¨ç¨‹åºçš„ä»£ç†ç¨‹åºï¼Œç”¨æ¥ç›‘æµ‹å’ŒååŠ©è¿è¡Œåœ¨JVMä¸Šçš„ç¨‹åºï¼Œå¯ä»¥è¿œç¨‹é‡æ–°è½¬æ¢æŒ‡å®šJVMå®ä¾‹é‡Œé¢çš„å·²ç»åŠ è½½çš„ç±»ï¼Œè¿™ä¸€ç‚¹å®ç°ä»å¼€å‘è€…è§’åº¦æ¥çœ‹å°±åƒæ˜¯ä»JVMçº§åˆ«æ”¯æŒäº†AOPç¼–ç¨‹ã€‚ä¸‹ä¸€ç¯‡æ–‡ç« å°†ä¼šç»“åˆå®é™…çš„åœºæ™¯å’Œå­—èŠ‚ç æ”¹é€ è¿›è¡Œæ›´æ·±å…¥çš„æ¢ç©¶ã€‚ å‚è€ƒèµ„æ–™ï¼š JVMæºç åˆ†æä¹‹javaagentåŸç†å®Œå…¨è§£è¯» - Byä½ å‡ç¬¨ JDK11ç›¸å…³æºç  åŠ¨æ‰‹å†™ä¸€ä¸ªjavaagent ï¼ˆæœ¬æ–‡å®Œ c-3-d e-a-20190629 6æœˆä»½è¿‡å®Œäº†ï¼Œè¿™ä¸ªæœˆæ²¡æœ‰ä»€ä¹ˆäº§å‡ºï¼Œo(â•¯â–¡â•°)oï¼‰","categories":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/categories/Java/"},{"name":"Instrument","slug":"Java/Instrument","permalink":"http://throwable.club/blog/categories/Java/Instrument/"}],"tags":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/tags/Java/"},{"name":"Instrument","slug":"Instrument","permalink":"http://throwable.club/blog/tags/Instrument/"}]},{"title":"Javaçº¿ç¨‹ç”Ÿå‘½å‘¨æœŸä¸çŠ¶æ€åˆ‡æ¢","slug":"java-concurrency-thread-state","date":"2019-06-23T15:20:16.000Z","updated":"2019-10-04T02:33:57.859Z","comments":true,"path":"2019/06/23/java-concurrency-thread-state/","link":"","permalink":"http://throwable.club/2019/06/23/java-concurrency-thread-state/","excerpt":"Javaçº¿ç¨‹ç”Ÿå‘½å‘¨æœŸä¸çŠ¶æ€åˆ‡æ¢ å‰æ æœ€è¿‘æœ‰ç‚¹æ‡’æ•£ï¼Œæ²¡ä»€ä¹ˆæ¯”è¾ƒæœ‰æ·±åº¦çš„äº§å‡ºã€‚åˆšå¥½æƒ³é‡æ–°ç ”è¯»ä¸€ä¸‹JUCçº¿ç¨‹æ± çš„æºç å®ç°ï¼Œåœ¨æ­¤ä¹‹å‰å…ˆæ·±å…¥äº†è§£ä¸€ä¸‹Javaä¸­çš„çº¿ç¨‹å®ç°ï¼ŒåŒ…æ‹¬çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸã€çŠ¶æ€åˆ‡æ¢ä»¥åŠçº¿ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ç­‰ç­‰ã€‚ç¼–å†™æœ¬æ–‡çš„æ—¶å€™ï¼Œä½¿ç”¨çš„JDKç‰ˆæœ¬æ˜¯11ã€‚","text":"Javaçº¿ç¨‹ç”Ÿå‘½å‘¨æœŸä¸çŠ¶æ€åˆ‡æ¢ å‰æ æœ€è¿‘æœ‰ç‚¹æ‡’æ•£ï¼Œæ²¡ä»€ä¹ˆæ¯”è¾ƒæœ‰æ·±åº¦çš„äº§å‡ºã€‚åˆšå¥½æƒ³é‡æ–°ç ”è¯»ä¸€ä¸‹JUCçº¿ç¨‹æ± çš„æºç å®ç°ï¼Œåœ¨æ­¤ä¹‹å‰å…ˆæ·±å…¥äº†è§£ä¸€ä¸‹Javaä¸­çš„çº¿ç¨‹å®ç°ï¼ŒåŒ…æ‹¬çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸã€çŠ¶æ€åˆ‡æ¢ä»¥åŠçº¿ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ç­‰ç­‰ã€‚ç¼–å†™æœ¬æ–‡çš„æ—¶å€™ï¼Œä½¿ç”¨çš„JDKç‰ˆæœ¬æ˜¯11ã€‚ Javaçº¿ç¨‹çš„å®ç° åœ¨JDK1.2ä¹‹åï¼ŒJavaçº¿ç¨‹æ¨¡å‹å·²ç»ç¡®å®šäº†åŸºäºæ“ä½œç³»ç»ŸåŸç”Ÿçº¿ç¨‹æ¨¡å‹å®ç°ã€‚å› æ­¤ï¼Œç›®å‰æˆ–è€…ä»Šåçš„JDKç‰ˆæœ¬ä¸­ï¼Œæ“ä½œç³»ç»Ÿæ”¯æŒæ€ä¹ˆæ ·çš„çº¿ç¨‹æ¨¡å‹ï¼Œåœ¨å¾ˆå¤§ç¨‹åº¦ä¸Šå†³å®šäº†Javaè™šæ‹Ÿæœºçš„çº¿ç¨‹å¦‚ä½•æ˜ å°„ï¼Œè¿™ä¸€ç‚¹åœ¨ä¸åŒçš„å¹³å°ä¸Šæ²¡æœ‰åŠæ³•è¾¾æˆä¸€è‡´ï¼Œè™šæ‹Ÿæœºè§„èŒƒä¸­ä¹Ÿæœªé™å®šJavaçº¿ç¨‹éœ€è¦ä½¿ç”¨å“ªç§çº¿ç¨‹æ¨¡å‹æ¥å®ç°ã€‚çº¿ç¨‹æ¨¡å‹åªå¯¹çº¿ç¨‹çš„å¹¶å‘è§„æ¨¡å’Œæ“ä½œæˆæœ¬äº§ç”Ÿå½±å“ï¼Œå¯¹äºJavaç¨‹åºæ¥è¯´ï¼Œè¿™äº›å·®å¼‚æ˜¯é€æ˜çš„ã€‚ å¯¹åº”Oracle Sun JDKæˆ–è€…è¯´Oracle Sun JVMè€Œè¨€ï¼Œå®ƒçš„Windowsç‰ˆæœ¬å’ŒLinuxç‰ˆæœ¬éƒ½æ˜¯ä½¿ç”¨ä¸€å¯¹ä¸€çš„çº¿ç¨‹æ¨¡å‹å®ç°çš„ï¼ˆå¦‚ä¸‹å›¾æ‰€ç¤ºï¼‰ã€‚ ä¹Ÿå°±æ˜¯ä¸€æ¡Javaçº¿ç¨‹å°±æ˜ å°„åˆ°ä¸€æ¡è½»é‡çº§è¿›ç¨‹(Light Weight Process)ä¸­ï¼Œè€Œä¸€æ¡è½»é‡çº§çº¿ç¨‹åˆæ˜ å°„åˆ°ä¸€æ¡å†…æ ¸çº¿ç¨‹(Kernel-Level Thread)ã€‚æˆ‘ä»¬å¹³æ—¶æ‰€è¯´çš„çº¿ç¨‹ï¼Œå¾€å¾€å°±æ˜¯æŒ‡è½»é‡çº§è¿›ç¨‹ï¼ˆæˆ–è€…è¯´æˆ‘ä»¬å¹³æ—¶æ–°å»ºçš„java.lang.Threadå°±æ˜¯è½»é‡çº§è¿›ç¨‹å®ä¾‹ï¼‰ã€‚å‰é¢æ¨ç®—è¿™ä¸ªçº¿ç¨‹æ˜ å°„å…³ç³»ï¼Œå¯ä»¥çŸ¥é“ï¼Œæˆ‘ä»¬åœ¨åº”ç”¨ç¨‹åºä¸­åˆ›å»ºæˆ–è€…æ“ä½œçš„java.lang.Threadå®ä¾‹æœ€ç»ˆä¼šæ˜ å°„åˆ°ç³»ç»Ÿçš„å†…æ ¸çº¿ç¨‹ï¼Œå¦‚æœæˆ‘ä»¬æ¶æ„æˆ–è€…å®éªŒæ€§æ— é™åˆ›å»ºjava.lang.Threadå®ä¾‹ï¼Œæœ€ç»ˆä¼šå½±å“ç³»ç»Ÿçš„æ­£å¸¸è¿è¡Œç”šè‡³å¯¼è‡´ç³»ç»Ÿå´©æºƒï¼ˆå¯ä»¥åœ¨Windowså¼€å‘ç¯å¢ƒä¸­åšå®éªŒï¼Œç¡®ä¿å†…å­˜è¶³å¤Ÿçš„æƒ…å†µä¸‹ä½¿ç”¨æ­»å¾ªç¯åˆ›å»ºå’Œè¿è¡Œjava.lang.Threadå®ä¾‹ï¼‰ã€‚ çº¿ç¨‹è°ƒåº¦æ–¹å¼åŒ…æ‹¬ä¸¤ç§ï¼ŒååŒå¼çº¿ç¨‹è°ƒåº¦å’ŒæŠ¢å å¼çº¿ç¨‹è°ƒåº¦ã€‚ çº¿ç¨‹è°ƒåº¦æ–¹å¼ æè¿° åŠ£åŠ¿ ä¼˜åŠ¿ ååŒå¼çº¿ç¨‹è°ƒåº¦ çº¿ç¨‹çš„æ‰§è¡Œæ—¶é—´ç”±çº¿ç¨‹æœ¬èº«æ§åˆ¶ï¼Œæ‰§è¡Œå®Œæ¯•åä¸»åŠ¨é€šçŸ¥æ“ä½œç³»ç»Ÿåˆ‡æ¢åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ä¸Š æŸä¸ªçº¿ç¨‹å¦‚æœä¸è®©å‡ºCPUæ‰§è¡Œæ—¶é—´å¯èƒ½ä¼šå¯¼è‡´æ•´ä¸ªç³»ç»Ÿå´©æºƒ å®ç°ç®€å•ï¼Œæ²¡æœ‰çº¿ç¨‹åŒæ­¥çš„é—®é¢˜ æŠ¢å å¼çº¿ç¨‹è°ƒåº¦ æ¯ä¸ªçº¿ç¨‹ç”±æ“ä½œç³»ç»Ÿæ¥åˆ†é…æ‰§è¡Œæ—¶é—´ï¼Œçº¿ç¨‹çš„åˆ‡æ¢ä¸ç”±çº¿ç¨‹è‡ªèº«å†³å®š å®ç°ç›¸å¯¹å¤æ‚ï¼Œæ“ä½œç³»ç»Ÿéœ€è¦æ§åˆ¶çº¿ç¨‹åŒæ­¥å’Œåˆ‡æ¢ ä¸ä¼šå‡ºç°ä¸€ä¸ªçº¿ç¨‹é˜»å¡å¯¼è‡´ç³»ç»Ÿå´©æºƒçš„é—®é¢˜ Javaçº¿ç¨‹æœ€ç»ˆä¼šæ˜ å°„ä¸ºç³»ç»Ÿå†…æ ¸åŸç”Ÿçº¿ç¨‹ï¼Œæ‰€ä»¥Javaçº¿ç¨‹è°ƒåº¦æœ€ç»ˆå–å†³äºç³»æ“ä½œç³»ç»Ÿï¼Œè€Œç›®å‰ä¸»æµçš„æ“ä½œç³»ç»Ÿå†…æ ¸çº¿ç¨‹è°ƒåº¦åŸºæœ¬éƒ½æ˜¯ä½¿ç”¨æŠ¢å å¼çº¿ç¨‹è°ƒåº¦ã€‚ä¹Ÿå°±æ˜¯å¯ä»¥æ­»è®°ç¡¬èƒŒä¸€ä¸‹ï¼šJavaçº¿ç¨‹æ˜¯ä½¿ç”¨æŠ¢å å¼çº¿ç¨‹è°ƒåº¦æ–¹å¼è¿›è¡Œçº¿ç¨‹è°ƒåº¦çš„ã€‚ å¾ˆå¤šæ“ä½œç³»ç»Ÿéƒ½æä¾›çº¿ç¨‹ä¼˜å…ˆçº§çš„æ¦‚å¿µï¼Œä½†æ˜¯ç”±äºå¹³å°ç‰¹æ€§çš„é—®é¢˜ï¼ŒJavaä¸­çš„çº¿ç¨‹ä¼˜å…ˆçº§å’Œä¸åŒå¹³å°ä¸­ç³»ç»Ÿçº¿ç¨‹ä¼˜å…ˆçº§å¹¶ä¸åŒ¹é…ï¼Œæ‰€ä»¥Javaçº¿ç¨‹ä¼˜å…ˆçº§å¯ä»¥ä»…ä»…ç†è§£ä¸ºâ€œå»ºè®®ä¼˜å…ˆçº§â€ï¼Œé€šä¿—æ¥è¯´å°±æ˜¯java.lang.Thread#setPriority(int newPriority)å¹¶ä¸ä¸€å®šç”Ÿæ•ˆï¼Œæœ‰å¯èƒ½Javaçº¿ç¨‹çš„ä¼˜å…ˆçº§ä¼šè¢«ç³»ç»Ÿè‡ªè¡Œæ”¹å˜ã€‚ Javaçº¿ç¨‹çš„çŠ¶æ€åˆ‡æ¢ Javaçº¿ç¨‹çš„çŠ¶æ€å¯ä»¥ä»java.lang.Threadçš„å†…éƒ¨æšä¸¾ç±»java.lang.Thread$Stateå¾—çŸ¥ï¼š 1234567891011121314public enum State &#123; NEW, RUNNABLE, BLOCKED, WAITING, TIMED_WAITING, TERMINATED;&#125; è¿™äº›çŠ¶æ€çš„æè¿°æ€»ç»“æˆå›¾å¦‚ä¸‹ï¼š çº¿ç¨‹çŠ¶æ€ä¹‹é—´å…³ç³»åˆ‡æ¢å›¾å¦‚ä¸‹ï¼š ä¸‹é¢é€šè¿‡APIæ³¨é‡Šå’Œä¸€äº›ç®€å•çš„ä»£ç ä¾‹å­åˆ†æä¸€ä¸‹Javaçº¿ç¨‹çš„çŠ¶æ€å«ä¹‰å’ŒçŠ¶æ€åˆ‡æ¢ã€‚ NEWçŠ¶æ€ APIæ³¨é‡Šï¼š 12345/** * Thread state for a thread which has not yet started. * */NEW, çº¿ç¨‹å®ä¾‹å°šæœªå¯åŠ¨æ—¶å€™çš„çº¿ç¨‹çŠ¶æ€ã€‚ ä¸€ä¸ªåˆšåˆ›å»ºè€Œå°šæœªå¯åŠ¨ï¼ˆå°šæœªè°ƒç”¨Thread#start()æ–¹æ³•ï¼‰çš„Javaçº¿ç¨‹å®ä¾‹çš„å°±æ˜¯å‡ºäºNEWçŠ¶æ€ã€‚ 12345678910public class ThreadState &#123; public static void main(String[] args) throws Exception &#123; Thread thread = new Thread(); System.out.println(thread.getState()); &#125;&#125;// è¾“å‡ºç»“æœNEW RUNNABLEçŠ¶æ€ APIæ³¨é‡Šï¼š 1234567/** * Thread state for a runnable thread. A thread in the runnable * state is executing in the Java virtual machine but it may * be waiting for other resources from the operating system * such as processor. */RUNNABLE, å¯è¿è¡ŒçŠ¶æ€ä¸‹çº¿ç¨‹çš„çº¿ç¨‹çŠ¶æ€ã€‚å¯è¿è¡ŒçŠ¶æ€ä¸‹çš„çº¿ç¨‹åœ¨Javaè™šæ‹Ÿæœºä¸­æ‰§è¡Œï¼Œä½†å®ƒå¯èƒ½æ‰§è¡Œç­‰å¾…æ“ä½œç³»ç»Ÿçš„å…¶ä»–èµ„æºï¼Œä¾‹å¦‚å¤„ç†å™¨ã€‚ å½“Javaçº¿ç¨‹å®ä¾‹è°ƒç”¨äº†Thread#start()ä¹‹åï¼Œå°±ä¼šè¿›å…¥RUNNABLEçŠ¶æ€ã€‚RUNNABLEçŠ¶æ€å¯ä»¥è®¤ä¸ºåŒ…å«ä¸¤ä¸ªå­çŠ¶æ€ï¼šREADYå’ŒRUNNINGã€‚ READYï¼šè¯¥çŠ¶æ€çš„çº¿ç¨‹å¯ä»¥è¢«çº¿ç¨‹è°ƒåº¦å™¨è¿›è¡Œè°ƒåº¦ä½¿ä¹‹æ›´å˜ä¸ºRUNNINGçŠ¶æ€ã€‚ RUNNINGï¼šè¯¥çŠ¶æ€è¡¨ç¤ºçº¿ç¨‹æ­£åœ¨è¿è¡Œï¼Œçº¿ç¨‹å¯¹è±¡çš„run()æ–¹æ³•ä¸­çš„ä»£ç æ‰€å¯¹åº”çš„çš„æŒ‡ä»¤æ­£åœ¨è¢«CPUæ‰§è¡Œã€‚ å½“Javaçº¿ç¨‹å®ä¾‹Thread#yield()æ–¹æ³•è¢«è°ƒç”¨æ—¶æˆ–è€…ç”±äºçº¿ç¨‹è°ƒåº¦å™¨çš„è°ƒåº¦ï¼Œçº¿ç¨‹å®ä¾‹çš„çŠ¶æ€æœ‰å¯èƒ½ç”±RUNNINGè½¬å˜ä¸ºREADYï¼Œä½†æ˜¯ä»çº¿ç¨‹çŠ¶æ€Thread#getState()è·å–åˆ°çš„çŠ¶æ€ä¾ç„¶æ˜¯RUNNABLEã€‚ä¾‹å¦‚ï¼š 123456789101112131415public class ThreadState1 &#123; public static void main(String[] args) throws Exception &#123; Thread thread = new Thread(()-&gt; &#123; while (true)&#123; Thread.yield(); &#125; &#125;); thread.start(); Thread.sleep(2000); System.out.println(thread.getState()); &#125;&#125;// è¾“å‡ºç»“æœRUNNABLE WAITINGçŠ¶æ€ APIæ³¨é‡Šï¼š 1234567891011121314151617181920/** * Thread state for a waiting thread. * A thread is in the waiting state due to calling one of the * following methods: * &lt;ul&gt; * &lt;li&gt;&#123;@link Object#wait() Object.wait&#125; with no timeout&lt;/li&gt; * &lt;li&gt;&#123;@link #join() Thread.join&#125; with no timeout&lt;/li&gt; * &lt;li&gt;&#123;@link LockSupport#park() LockSupport.park&#125;&lt;/li&gt; * &lt;/ul&gt; * * &lt;p&gt;A thread in the waiting state is waiting for another thread to * perform a particular action. * * For example, a thread that has called &#123;@code Object.wait()&#125; * on an object is waiting for another thread to call * &#123;@code Object.notify()&#125; or &#123;@code Object.notifyAll()&#125; on * that object. A thread that has called &#123;@code Thread.join()&#125; * is waiting for a specified thread to terminate. */ WAITING, ç­‰å¾…ä¸­çº¿ç¨‹çš„çŠ¶æ€ã€‚ä¸€ä¸ªçº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€æ˜¯ç”±äºè°ƒç”¨äº†ä¸‹é¢æ–¹æ³•ä¹‹ä¸€ï¼š ä¸å¸¦è¶…æ—¶çš„Object#wait() ä¸å¸¦è¶…æ—¶çš„Thread#join() LockSupport.park() ä¸€ä¸ªå¤„äºç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹æ€»æ˜¯åœ¨ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹è¿›è¡Œä¸€äº›ç‰¹æ®Šçš„å¤„ç†ã€‚ ä¾‹å¦‚ï¼šä¸€ä¸ªçº¿ç¨‹è°ƒç”¨äº†Object#wait()ï¼Œé‚£ä¹ˆå®ƒåœ¨ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨å¯¹è±¡ä¸Šçš„Object#notify()æˆ–è€…Object#notifyAll()ï¼›ä¸€ä¸ªçº¿ç¨‹è°ƒç”¨äº†Thread#join()ï¼Œé‚£ä¹ˆå®ƒåœ¨ç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹ç»ˆç»“ã€‚ WAITINGæ˜¯æ— é™æœŸçš„ç­‰å¾…çŠ¶æ€ï¼Œè¿™ç§çŠ¶æ€ä¸‹çš„çº¿ç¨‹ä¸ä¼šè¢«åˆ†é…CPUæ‰§è¡Œæ—¶é—´ã€‚å½“ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œäº†æŸäº›æ–¹æ³•ä¹‹åå°±ä¼šè¿›å…¥æ— é™æœŸç­‰å¾…çŠ¶æ€ï¼Œç›´åˆ°è¢«æ˜¾å¼å”¤é†’ï¼Œè¢«å”¤é†’åï¼Œçº¿ç¨‹çŠ¶æ€ç”±WAITINGæ›´å˜ä¸ºRUNNABLEç„¶åç»§ç»­æ‰§è¡Œã€‚ RUNNABLEè½¬æ¢ä¸ºWAITINGçš„æ–¹æ³•ï¼ˆæ— é™æœŸç­‰å¾…ï¼‰ WAITINGè½¬æ¢ä¸ºRUNNABLEçš„æ–¹æ³•ï¼ˆå”¤é†’ï¼‰ Object#wait() Object#notify()æˆ–è€…Object#notifyAll() Thread#join() - LockSupport.park() LockSupport.unpark(thread) å…¶ä¸­Thread#join()æ–¹æ³•ç›¸å¯¹æ¯”è¾ƒç‰¹æ®Šï¼Œå®ƒä¼šé˜»å¡çº¿ç¨‹å®ä¾‹ç›´åˆ°çº¿ç¨‹å®ä¾‹æ‰§è¡Œå®Œæ¯•ï¼Œå¯ä»¥è§‚å¯Ÿå®ƒçš„æºç å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627public final void join() throws InterruptedException &#123; join(0);&#125;public final synchronized void join(long millis)throws InterruptedException &#123; long base = System.currentTimeMillis(); long now = 0; if (millis &lt; 0) &#123; throw new IllegalArgumentException(\"timeout value is negative\"); &#125; if (millis == 0) &#123; while (isAlive()) &#123; wait(0); &#125; &#125; else &#123; while (isAlive()) &#123; long delay = millis - now; if (delay &lt;= 0) &#123; break; &#125; wait(delay); now = System.currentTimeMillis() - base; &#125; &#125;&#125; å¯è§Thread#join()æ˜¯åœ¨çº¿ç¨‹å®ä¾‹å­˜æ´»çš„æ—¶å€™æ€»æ˜¯è°ƒç”¨Object#wait()æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯å¿…é¡»åœ¨çº¿ç¨‹æ‰§è¡Œå®Œæ¯•isAlive()ä¸ºfalseï¼ˆæ„å‘³ç€çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸå·²ç»ç»ˆç»“ï¼‰çš„æ—¶å€™æ‰ä¼šè§£é™¤é˜»å¡ã€‚ åŸºäºWAITINGçŠ¶æ€ä¸¾ä¸ªä¾‹å­ï¼š 1234567891011121314151617181920public class ThreadState3 &#123; public static void main(String[] args) throws Exception &#123; Thread thread = new Thread(()-&gt; &#123; LockSupport.park(); while (true)&#123; Thread.yield(); &#125; &#125;); thread.start(); Thread.sleep(50); System.out.println(thread.getState()); LockSupport.unpark(thread); Thread.sleep(50); System.out.println(thread.getState()); &#125;&#125;// è¾“å‡ºç»“æœWAITINGRUNNABLE TIMED WAITINGçŠ¶æ€ APIæ³¨é‡Šï¼š 12345678910111213/*** Thread state for a waiting thread with a specified waiting time.* A thread is in the timed waiting state due to calling one of* the following methods with a specified positive waiting time:* &lt;ul&gt;* &lt;li&gt;&#123;@link #sleep Thread.sleep&#125;&lt;/li&gt;* &lt;li&gt;&#123;@link Object#wait(long) Object.wait&#125; with timeout&lt;/li&gt;* &lt;li&gt;&#123;@link #join(long) Thread.join&#125; with timeout&lt;/li&gt;* &lt;li&gt;&#123;@link LockSupport#parkNanos LockSupport.parkNanos&#125;&lt;/li&gt;* &lt;li&gt;&#123;@link LockSupport#parkUntil LockSupport.parkUntil&#125;&lt;/li&gt;* &lt;/ul&gt;*/TIMED_WAITING, å®šä¹‰äº†å…·ä½“ç­‰å¾…æ—¶é—´çš„ç­‰å¾…ä¸­çº¿ç¨‹çš„çŠ¶æ€ã€‚ä¸€ä¸ªçº¿ç¨‹è¿›å…¥è¯¥çŠ¶æ€æ˜¯ç”±äºæŒ‡å®šäº†å…·ä½“çš„è¶…æ—¶æœŸé™è°ƒç”¨äº†ä¸‹é¢æ–¹æ³•ä¹‹ä¸€ï¼š Thread.sleep() å¸¦è¶…æ—¶çš„Object#wait() å¸¦è¶…æ—¶çš„Thread#join() LockSupport.parkNanos() LockSupport.parkUntil() TIMED WAITINGå°±æ˜¯æœ‰é™æœŸç­‰å¾…çŠ¶æ€ï¼Œå®ƒå’ŒWAITINGæœ‰ç‚¹ç›¸ä¼¼ï¼Œè¿™ç§çŠ¶æ€ä¸‹çš„çº¿ç¨‹ä¸ä¼šè¢«åˆ†é…CPUæ‰§è¡Œæ—¶é—´ï¼Œä¸è¿‡è¿™ç§çŠ¶æ€ä¸‹çš„çº¿ç¨‹ä¸éœ€è¦è¢«æ˜¾å¼å”¤é†’ï¼Œåªéœ€è¦ç­‰å¾…è¶…æ—¶é™æœŸåˆ°è¾¾å°±ä¼šè¢«VMå”¤é†’ï¼Œæœ‰ç‚¹ç±»ä¼¼äºç°å®ç”Ÿæ´»ä¸­çš„é—¹é’Ÿã€‚ RUNNABLEè½¬æ¢ä¸ºTIMED WAITINGçš„æ–¹æ³•ï¼ˆæœ‰é™æœŸç­‰å¾…ï¼‰ TIMED WAITINGè½¬æ¢ä¸ºRUNNABLEçš„æ–¹æ³•ï¼ˆè¶…æ—¶è§£é™¤ç­‰å¾…ï¼‰ Object#wait(timeout) - Thread#sleep(timeout) - Thread#join(timeout) - LockSupport.parkNanos(timeout) - LockSupport.parkUntil(timeout) - ä¸¾ä¸ªä¾‹å­ï¼š 1234567891011121314151617181920public class ThreadState4 &#123; public static void main(String[] args) throws Exception &#123; Thread thread = new Thread(()-&gt; &#123; try &#123; Thread.sleep(1000); &#125; catch (InterruptedException e) &#123; //ignore &#125; &#125;); thread.start(); Thread.sleep(50); System.out.println(thread.getState()); Thread.sleep(1000); System.out.println(thread.getState()); &#125;&#125;// è¾“å‡ºç»“æœTIMED_WAITINGTERMINATED BLOCKEDçŠ¶æ€ APIæ³¨é‡Šï¼š 12345678/*** Thread state for a thread blocked waiting for a monitor lock.* A thread in the blocked state is waiting for a monitor lock* to enter a synchronized block/method or* reenter a synchronized block/method after calling* &#123;@link Object#wait() Object.wait&#125;.*/BLOCKED, æ­¤çŠ¶æ€è¡¨ç¤ºä¸€ä¸ªçº¿ç¨‹æ­£åœ¨é˜»å¡ç­‰å¾…è·å–ä¸€ä¸ªç›‘è§†å™¨é”ã€‚å¦‚æœçº¿ç¨‹å¤„äºé˜»å¡çŠ¶æ€ï¼Œè¯´æ˜çº¿ç¨‹ç­‰å¾…è¿›å…¥åŒæ­¥ä»£ç å—æˆ–è€…åŒæ­¥æ–¹æ³•çš„ç›‘è§†å™¨é”æˆ–è€…åœ¨è°ƒç”¨äº†Object#wait()ä¹‹åé‡å…¥åŒæ­¥ä»£ç å—æˆ–è€…åŒæ­¥æ–¹æ³•ã€‚ BLOCKEDçŠ¶æ€ä¹Ÿå°±æ˜¯é˜»å¡çŠ¶æ€ï¼Œè¯¥çŠ¶æ€ä¸‹çš„çº¿ç¨‹ä¸ä¼šè¢«åˆ†é…CPUæ‰§è¡Œæ—¶é—´ã€‚çº¿ç¨‹çš„çŠ¶æ€ä¸ºBLOCKEDçš„æ—¶å€™æœ‰ä¸¤ç§å¯èƒ½çš„æƒ…å†µï¼š A thread in the blocked state is waiting for a monitor lock to enter a synchronized block/method çº¿ç¨‹æ­£åœ¨ç­‰å¾…ä¸€ä¸ªç›‘è§†å™¨é”ï¼Œåªæœ‰è·å–ç›‘è§†å™¨é”ä¹‹åæ‰èƒ½è¿›å…¥synchronizedä»£ç å—æˆ–è€…synchronizedæ–¹æ³•ï¼Œåœ¨æ­¤ç­‰å¾…è·å–é”çš„è¿‡ç¨‹çº¿ç¨‹éƒ½å¤„äºé˜»å¡çŠ¶æ€ã€‚ reenter a synchronized block/method after calling Object#wait() çº¿ç¨‹Xæ­¥å…¥synchronizedä»£ç å—æˆ–è€…synchronizedæ–¹æ³•åï¼ˆæ­¤æ—¶å·²ç»é‡Šæ”¾ç›‘è§†å™¨é”ï¼‰è°ƒç”¨Object#wait()æ–¹æ³•ä¹‹åè¿›è¡Œé˜»å¡ï¼Œå½“æ¥æ”¶å…¶ä»–çº¿ç¨‹Tè°ƒç”¨è¯¥é”å¯¹è±¡Object#notify()/notifyAll()ï¼Œä½†æ˜¯çº¿ç¨‹Tå°šæœªé€€å‡ºå®ƒæ‰€åœ¨çš„synchronizedä»£ç å—æˆ–è€…synchronizedæ–¹æ³•ï¼Œé‚£ä¹ˆçº¿ç¨‹Xä¾ç„¶å¤„äºé˜»å¡çŠ¶æ€ï¼ˆæ³¨æ„APIæ³¨é‡Šä¸­çš„reenterï¼Œç†è§£å®ƒåœºæ™¯2å°±è±ç„¶å¼€æœ—ï¼‰ã€‚ æ›´åŠ è¯¦ç»†çš„æè¿°å¯ä»¥å‚è€ƒç¬”è€…ä¹‹å‰å†™è¿‡çš„ä¸€ç¯‡æ–‡ç« ï¼šæ·±å…¥ç†è§£Objectæä¾›çš„é˜»å¡å’Œå”¤é†’APIã€‚ é’ˆå¯¹ä¸Šé¢çš„åœºæ™¯1ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼š 12345678910111213141516171819202122232425262728public class ThreadState6 &#123; private static final Object MONITOR = new Object(); public static void main(String[] args) throws Exception &#123; Thread thread1 = new Thread(()-&gt; &#123; synchronized (MONITOR)&#123; try &#123; Thread.sleep(Integer.MAX_VALUE); &#125; catch (InterruptedException e) &#123; //ignore &#125; &#125; &#125;); Thread thread2 = new Thread(()-&gt; &#123; synchronized (MONITOR)&#123; System.out.println(\"thread2 got monitor lock...\"); &#125; &#125;); thread1.start(); Thread.sleep(50); thread2.start(); Thread.sleep(50); System.out.println(thread2.getState()); &#125;&#125;// è¾“å‡ºç»“æœBLOCKED é’ˆå¯¹ä¸Šé¢çš„åœºæ™¯2ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647public class ThreadState7 &#123; private static final Object MONITOR = new Object(); private static final DateTimeFormatter F = DateTimeFormatter.ofPattern(\"yyyy-MM-dd HH:mm:ss\"); public static void main(String[] args) throws Exception &#123; System.out.println(String.format(\"[%s]-begin...\", F.format(LocalDateTime.now()))); Thread thread1 = new Thread(() -&gt; &#123; synchronized (MONITOR) &#123; System.out.println(String.format(\"[%s]-thread1 got monitor lock...\", F.format(LocalDateTime.now()))); try &#123; Thread.sleep(1000); MONITOR.wait(); &#125; catch (InterruptedException e) &#123; //ignore &#125; System.out.println(String.format(\"[%s]-thread1 exit waiting...\", F.format(LocalDateTime.now()))); &#125; &#125;); Thread thread2 = new Thread(() -&gt; &#123; synchronized (MONITOR) &#123; System.out.println(String.format(\"[%s]-thread2 got monitor lock...\", F.format(LocalDateTime.now()))); try &#123; MONITOR.notify(); Thread.sleep(2000); &#125; catch (InterruptedException e) &#123; //ignore &#125; System.out.println(String.format(\"[%s]-thread2 releases monitor lock...\", F.format(LocalDateTime.now()))); &#125; &#125;); thread1.start(); thread2.start(); // è¿™é‡Œæ•…æ„è®©ä¸»çº¿ç¨‹sleep 1500æ¯«ç§’ä»è€Œè®©thread2è°ƒç”¨äº†Object#notify()å¹¶ä¸”å°šæœªé€€å‡ºåŒæ­¥ä»£ç å—ï¼Œç¡®ä¿thread1è°ƒç”¨äº†Object#wait() Thread.sleep(1500); System.out.println(thread1.getState()); System.out.println(String.format(\"[%s]-end...\", F.format(LocalDateTime.now()))); &#125;&#125;// æŸä¸ªæ—¶åˆ»çš„è¾“å‡ºå¦‚ä¸‹ï¼š[2019-06-20 00:30:22]-begin...[2019-06-20 00:30:22]-thread1 got monitor lock...[2019-06-20 00:30:23]-thread2 got monitor lock...BLOCKED[2019-06-20 00:30:23]-end...[2019-06-20 00:30:25]-thread2 releases monitor lock...[2019-06-20 00:30:25]-thread1 exit waiting... åœºæ™¯2ä¸­ï¼š çº¿ç¨‹2è°ƒç”¨Object#notify()åç¡çœ 2000æ¯«ç§’å†é€€å‡ºåŒæ­¥ä»£ç å—ï¼Œé‡Šæ”¾ç›‘è§†å™¨é”ã€‚ çº¿ç¨‹1åªç¡çœ äº†1000æ¯«ç§’å°±è°ƒç”¨äº†Object#wait()ï¼Œæ­¤æ—¶å®ƒå·²ç»é‡Šæ”¾äº†ç›‘è§†å™¨é”ï¼Œæ‰€ä»¥çº¿ç¨‹2æˆåŠŸè¿›å…¥åŒæ­¥å—ï¼Œçº¿ç¨‹1å¤„äºAPIæ³¨é‡Šä¸­æ‰€è¿°çš„reenter a synchronized block/methodçš„çŠ¶æ€ã€‚ ä¸»çº¿ç¨‹ç¡çœ 1500æ¯«ç§’åˆšå¥½å¯ä»¥å‘½ä¸­çº¿ç¨‹1å¤„äºreenterçŠ¶æ€å¹¶ä¸”æ‰“å°å…¶çº¿ç¨‹çŠ¶æ€ï¼Œåˆšå¥½å°±æ˜¯BLOCKEDçŠ¶æ€ã€‚ è¿™ä¸‰ç‚¹çœ‹èµ·æ¥æœ‰ç‚¹ç»•ï¼Œå¤šçœ‹å‡ æ¬¡å¤šæ€è€ƒä¸€ä¸‹åº”è¯¥å°±èƒ½ç†è§£ã€‚ TERMINATEDçŠ¶æ€ APIæ³¨é‡Šï¼š 12345/** * Thread state for a terminated thread. * The thread has completed execution. */ TERMINATED; ç»ˆç»“çš„çº¿ç¨‹å¯¹åº”çš„çº¿ç¨‹çŠ¶æ€ï¼Œæ­¤æ—¶çº¿ç¨‹å·²ç»æ‰§è¡Œå®Œæ¯•ã€‚ TERMINATEDçŠ¶æ€è¡¨ç¤ºçº¿ç¨‹å·²ç»ç»ˆç»“ã€‚ä¸€ä¸ªçº¿ç¨‹å®ä¾‹åªèƒ½è¢«å¯åŠ¨ä¸€æ¬¡ï¼Œå‡†ç¡®æ¥è¯´ï¼Œåªä¼šè°ƒç”¨ä¸€æ¬¡Thread#run()æ–¹æ³•ï¼ŒThread#run()æ–¹æ³•æ‰§è¡Œç»“æŸä¹‹åï¼Œçº¿ç¨‹çŠ¶æ€å°±ä¼šæ›´å˜ä¸ºTERMINATEDï¼Œæ„å‘³ç€çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸå·²ç»ç»“æŸã€‚ ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼š 12345678910111213public class ThreadState8 &#123; public static void main(String[] args) throws Exception &#123; Thread thread = new Thread(() -&gt; &#123; &#125;); thread.start(); Thread.sleep(50); System.out.println(thread.getState()); &#125;&#125;// è¾“å‡ºç»“æœTERMINATED ä¸Šä¸‹æ–‡åˆ‡æ¢ å¤šçº¿ç¨‹ç¯å¢ƒä¸­ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹çš„çŠ¶æ€ç”±RUNNABLEè½¬æ¢ä¸ºéRUNNABLEï¼ˆBLOCKEDã€WAITINGæˆ–è€…TIMED_WAITINGï¼‰æ—¶ï¼Œç›¸åº”çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼ˆä¹Ÿå°±æ˜¯å¸¸è¯´çš„Contextï¼ŒåŒ…æ‹¬CPUçš„å¯„å­˜å™¨å’Œç¨‹åºè®¡æ•°å™¨åœ¨æŸä¸€æ—¶é—´ç‚¹çš„å†…å®¹ç­‰ç­‰ï¼‰éœ€è¦è¢«ä¿å­˜ï¼Œä»¥ä¾¿çº¿ç¨‹ç¨åæ¢å¤ä¸ºRUNNABLEçŠ¶æ€æ—¶èƒ½å¤Ÿåœ¨ä¹‹å‰çš„æ‰§è¡Œè¿›åº¦çš„åŸºç¡€ä¸Šç»§ç»­æ‰§è¡Œã€‚è€Œä¸€ä¸ªçº¿ç¨‹çš„çŠ¶æ€ç”±éRUNNABLEçŠ¶æ€è¿›å…¥RUNNABLEçŠ¶æ€æ—¶å¯èƒ½æ¶‰åŠæ¢å¤ä¹‹å‰ä¿å­˜çš„çº¿ç¨‹ä¸Šä¸‹æ–‡ä¿¡æ¯å¹¶ä¸”åœ¨æ­¤åŸºç¡€ä¸Šç»§ç»­æ‰§è¡Œã€‚è¿™é‡Œçš„å¯¹çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ä¿¡æ¯è¿›è¡Œä¿å­˜å’Œæ¢å¤çš„è¿‡ç¨‹å°±ç§°ä¸ºä¸Šä¸‹æ–‡åˆ‡æ¢ï¼ˆContext Switchï¼‰ã€‚ çº¿ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ä¼šå¸¦æ¥é¢å¤–çš„æ€§èƒ½å¼€é”€ï¼Œè¿™åŒ…æ‹¬ä¿å­˜å’Œæ¢å¤çº¿ç¨‹ä¸Šä¸‹æ–‡ä¿¡æ¯çš„å¼€é”€ã€å¯¹çº¿ç¨‹è¿›è¡Œè°ƒåº¦çš„CPUæ—¶é—´å¼€é”€ä»¥åŠCPUç¼“å­˜å†…å®¹å¤±æ•ˆçš„å¼€é”€ï¼ˆçº¿ç¨‹æ‰€æ‰§è¡Œçš„ä»£ç ä»CPUç¼“å­˜ä¸­è®¿é—®å…¶æ‰€éœ€è¦çš„å˜é‡å€¼è¦æ¯”ä»ä¸»å†…å­˜(RAM)ä¸­è®¿é—®å“åº”çš„å˜é‡å€¼è¦å¿«å¾—å¤šï¼Œä½†æ˜¯çº¿ç¨‹ä¸Šä¸‹æ–‡åˆ‡æ¢ä¼šå¯¼è‡´ç›¸å…³çº¿ç¨‹æ‰€è®¿é—®çš„CPUç¼“å­˜å†…å®¹å¤±æ•ˆï¼Œä¸€èˆ¬æ˜¯CPUçš„L1 Cacheå’ŒL2 Cacheï¼Œä½¿å¾—ç›¸å…³çº¿ç¨‹ç¨åè¢«é‡æ–°è°ƒåº¦åˆ°è¿è¡Œæ—¶å…¶ä¸å¾—ä¸å†æ¬¡è®¿é—®ä¸»å†…å­˜ä¸­çš„å˜é‡ä»¥é‡æ–°åˆ›å»ºCPUç¼“å­˜å†…å®¹ï¼‰ã€‚ åœ¨Linuxç³»ç»Ÿä¸­ï¼Œå¯ä»¥é€šè¿‡vmstatå‘½ä»¤æ¥æŸ¥çœ‹å…¨å±€çš„ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ¬¡æ•°ï¼Œä¾‹å¦‚ï¼š 1$ vmstat 1 å¯¹äºJavaç¨‹åºçš„è¿è¡Œï¼Œåœ¨Linuxç³»ç»Ÿä¸­ä¹Ÿå¯ä»¥é€šè¿‡perfå‘½ä»¤è¿›è¡Œç›‘è§†ï¼Œä¾‹å¦‚ï¼š 1$ perf stat -e cpu-clock,task-clock,cs,cache-reference,cache-misses java YourJavaClass å‚è€ƒèµ„æ–™ä¸­æåˆ°Windowsç³»ç»Ÿä¸‹å¯ä»¥é€šè¿‡è‡ªå¸¦çš„å·¥å…·perfmonï¼ˆå…¶å®ä¹Ÿå°±æ˜¯ä»»åŠ¡ç®¡ç†å™¨ï¼‰æ¥ç›‘è§†çº¿ç¨‹çš„ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œå®é™…ä¸Šç¬”è€…å¹¶æ²¡æœ‰ä»ä»»åŠ¡ç®¡ç†å™¨å‘ç°æœ‰ä»»ä½•åŠæ³•æŸ¥çœ‹ä¸Šä¸‹æ–‡åˆ‡æ¢ï¼Œé€šè¿‡æœç´¢ä¹‹åå‘ç°äº†ä¸€ä¸ªå·¥å…·ï¼šProcess Explorerã€‚è¿è¡ŒProcess ExploreråŒæ—¶è¿è¡Œä¸€ä¸ªJavaç¨‹åºå¹¶ä¸”æŸ¥çœ‹å…¶çŠ¶æ€ï¼š å› ä¸ºæ‰“äº†æ–­ç‚¹ï¼Œå¯ä»¥çœ‹åˆ°è¿è¡Œä¸­çš„ç¨‹åºçš„ä¸Šä¸‹æ–‡åˆ‡æ¢ä¸€å…±7000å¤šæ¬¡ï¼Œå½“å‰ä¸€ç§’çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å¢é‡ä¸º26ï¼ˆå› ä¸ºç¬”è€…è®¾ç½®äº†Process Exploreræ¯ç§’åˆ·æ–°ä¸€æ¬¡æ•°æ®ï¼‰ã€‚ ç›‘æ§çº¿ç¨‹çŠ¶æ€ å¦‚æœé¡¹ç›®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è¿è¡Œï¼Œä¸å¯èƒ½é¢‘ç¹è°ƒç”¨Thread#getState()æ–¹æ³•å»ç›‘æµ‹çº¿ç¨‹çš„çŠ¶æ€å˜åŒ–ã€‚JDKæœ¬èº«æä¾›äº†ä¸€äº›ç›‘æ§çº¿ç¨‹çŠ¶æ€çš„å·¥å…·ï¼Œè¿˜æœ‰ä¸€äº›å¼€æºçš„è½»é‡çº§å·¥å…·å¦‚é˜¿é‡Œçš„Arthasï¼Œè¿™é‡Œç®€å•ä»‹ç»ä¸€ä¸‹ã€‚ ä½¿ç”¨jvisualvm jvisualvmæ˜¯JDKè‡ªå¸¦çš„å †ã€çº¿ç¨‹ç­‰å¾…JVMæŒ‡æ ‡ç›‘æ§å·¥å…·ï¼Œé€‚åˆä½¿ç”¨äºå¼€å‘å’Œæµ‹è¯•ç¯å¢ƒã€‚å®ƒä½äºJAVA_HOME/binç›®å½•ä¹‹ä¸‹ã€‚ å…¶ä¸­çº¿ç¨‹Dumpçš„æŒ‰é’®ç±»ä¼¼äºä¸‹é¢è¦æåˆ°çš„jstackå‘½ä»¤ï¼Œç”¨äºå¯¼å‡ºæ‰€æœ‰çº¿ç¨‹çš„æ ˆä¿¡æ¯ã€‚ ä½¿ç”¨jstack jstackæ˜¯JDKè‡ªå¸¦çš„å‘½ä»¤è¡Œå·¥å…·ï¼ŒåŠŸèƒ½æ˜¯ç”¨äºè·å–æŒ‡å®šPIDçš„Javaè¿›ç¨‹çš„çº¿ç¨‹æ ˆä¿¡æ¯ã€‚ä¾‹å¦‚æœ¬åœ°è¿è¡Œçš„ä¸€ä¸ªIDEAå®ä¾‹çš„PIDæ˜¯11376ï¼Œé‚£ä¹ˆåªéœ€è¦è¾“å…¥ï¼š 1jstack 11376 å¦å¤–ï¼Œå¦‚æœæƒ³è¦å®šä½å…·ä½“Javaè¿›ç¨‹çš„PIDï¼Œå¯ä»¥ä½¿ç”¨jpså‘½ä»¤ã€‚ ä½¿ç”¨JMC JMCä¹Ÿå°±æ˜¯Java Mission Controlï¼Œå®ƒä¹Ÿæ˜¯JDKè‡ªå¸¦çš„å·¥å…·ï¼Œæä¾›çš„åŠŸèƒ½è¦æ¯”jvisualvmå¼ºå¤§ï¼ŒåŒ…æ‹¬MBeançš„å¤„ç†ã€çº¿ç¨‹æ ˆä»¥åŠçº¿ç¨‹çŠ¶æ€æŸ¥çœ‹ã€é£è¡Œè®°å½•å™¨ç­‰ç­‰ã€‚ å°ç»“ ç†è§£Javaçº¿ç¨‹çŠ¶æ€çš„åˆ‡æ¢å’Œä¸€äº›ç›‘æ§æ‰‹æ®µï¼Œæ›´æœ‰åˆ©äºæ—¥å¸¸å¼€å‘å¤šçº¿ç¨‹ç¨‹åºï¼Œå¯¹äºç”Ÿäº§ç¯å¢ƒå‡ºç°é—®é¢˜ï¼Œé€šè¿‡ç›‘æ§çº¿ç¨‹çš„æ ˆä¿¡æ¯èƒ½å¤Ÿå¿«é€Ÿå®šä½åˆ°é—®é¢˜çš„æ ¹æœ¬åŸå› ï¼ˆé€šå¸¸æ¥è¯´ï¼Œç›®å‰æ¯”è¾ƒä¸»æµçš„MVCåº”ç”¨éƒ½æ˜¯é€šè¿‡ä¸€ä¸ªçº¿ç¨‹å¤„ç†ä¸€ä¸ªå•ç‹¬çš„è¯·æ±‚ï¼Œå½“è¯·æ±‚å‡ºç°é˜»å¡çš„æ—¶å€™ï¼Œå¯¼å‡ºå¯¹åº”å¤„ç†è¯·æ±‚çš„çº¿ç¨‹åŸºæœ¬å¯ä»¥å®šä½åˆ°é˜»å¡çš„ç²¾å‡†ä½ç½®ï¼Œå¦‚æœä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—ä¾‹å¦‚RabbitMQï¼Œæ¶ˆè´¹è€…çº¿ç¨‹å‡ºç°é˜»å¡ä¹Ÿå¯ä»¥åˆ©ç”¨ç›¸ä¼¼çš„æ€è·¯è§£å†³ï¼‰ã€‚ å‚è€ƒèµ„æ–™ï¼š Jdk11ç›¸å…³æºç  ã€ŠJavaå¤šçº¿ç¨‹ç¼–ç¨‹å®æˆ˜æŒ‡å—ã€‹ ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœº-2ndã€‹ (æœ¬æ–‡å®Œ c-7-d e-a-20190623 æœ€è¿‘ä¸šåŠ¡è¿­ä»£æœ‰ç‚¹å¿™)","categories":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/categories/Java/"},{"name":"Concurrency","slug":"Java/Concurrency","permalink":"http://throwable.club/blog/categories/Java/Concurrency/"}],"tags":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/tags/Java/"},{"name":"Thread","slug":"Thread","permalink":"http://throwable.club/blog/tags/Thread/"}]},{"title":"æ·±å…¥ç†è§£Javaä¸­çš„Garbage Collection","slug":"java-jvm-garbage-collection-summary","date":"2019-06-09T03:45:51.000Z","updated":"2019-06-09T03:56:26.814Z","comments":true,"path":"2019/06/09/java-jvm-garbage-collection-summary/","link":"","permalink":"http://throwable.club/2019/06/09/java-jvm-garbage-collection-summary/","excerpt":"å‰æ æœ€è¿‘ç”±äºç³»ç»Ÿä¸šåŠ¡é‡æ¯”è¾ƒå¤§ï¼Œä»ç”Ÿäº§çš„GCæ—¥å¿—(ç»“åˆPinpoint)æ¥çœ‹ï¼Œéœ€è¦å¯¹éƒ¨åˆ†ç³»ç»Ÿè¿›è¡ŒGCè°ƒä¼˜ã€‚ä½†æ˜¯é‰´äºä»¥å¾€ä¸æ˜¯ä¸“é—¨åšè¿™ä¸€å—ï¼Œä½†æ˜¯ä¸€ç›´éƒ½æœ‰é›¶æ•£çš„ç§¯ç´¯ï¼Œè¿™é‡Œåšä¸€ä¸ªç›¸å¯¹å…¨é¢çš„æ€»ç»“ã€‚æœ¬æ–‡åªé’ˆå¯¹HotSpot VMä¹Ÿå°±æ˜¯Oracle Hotspot VMæˆ–è€…OpenJDK Hotspot VMï¼Œç‰ˆæœ¬ä¸ºJava8ï¼Œå…¶ä»–VMä¸ä¸€å®šé€‚ç”¨ã€‚ ä»€ä¹ˆæ˜¯GC(Garbage Collection) Garbage Collectionå¯ä»¥ç¿»è¯‘ä¸ºâ€œåƒåœ¾æ”¶é›†â€ â€“ ä¸€èˆ¬ä¸»è§‚ä¸Šä¼šè®¤ä¸ºåšæ³•æ˜¯ï¼šæ‰¾åˆ°åƒåœ¾ï¼Œç„¶åæŠŠåƒåœ¾æ‰”æ‰ã€‚åœ¨VMä¸­ï¼ŒGCçš„å®ç°è¿‡ç¨‹æ°æ°ç›¸åï¼ŒGCçš„ç›®çš„æ˜¯ä¸ºäº†è¿½è¸ªæ‰€æœ‰æ­£åœ¨ä½¿ç”¨çš„å¯¹è±¡ï¼Œå¹¶ä¸”å°†å‰©ä½™çš„å¯¹è±¡æ ‡è®°ä¸ºåƒåœ¾ï¼Œéšåæ ‡è®°ä¸ºåƒåœ¾çš„å¯¹è±¡ä¼šè¢«æ¸…é™¤ï¼Œå›æ”¶è¿™äº›åƒåœ¾å¯¹è±¡å æ®çš„å†…å­˜ï¼Œä»è€Œå®ç°å†…å­˜çš„è‡ªåŠ¨ç®¡ç†ã€‚","text":"å‰æ æœ€è¿‘ç”±äºç³»ç»Ÿä¸šåŠ¡é‡æ¯”è¾ƒå¤§ï¼Œä»ç”Ÿäº§çš„GCæ—¥å¿—(ç»“åˆPinpoint)æ¥çœ‹ï¼Œéœ€è¦å¯¹éƒ¨åˆ†ç³»ç»Ÿè¿›è¡ŒGCè°ƒä¼˜ã€‚ä½†æ˜¯é‰´äºä»¥å¾€ä¸æ˜¯ä¸“é—¨åšè¿™ä¸€å—ï¼Œä½†æ˜¯ä¸€ç›´éƒ½æœ‰é›¶æ•£çš„ç§¯ç´¯ï¼Œè¿™é‡Œåšä¸€ä¸ªç›¸å¯¹å…¨é¢çš„æ€»ç»“ã€‚æœ¬æ–‡åªé’ˆå¯¹HotSpot VMä¹Ÿå°±æ˜¯Oracle Hotspot VMæˆ–è€…OpenJDK Hotspot VMï¼Œç‰ˆæœ¬ä¸ºJava8ï¼Œå…¶ä»–VMä¸ä¸€å®šé€‚ç”¨ã€‚ ä»€ä¹ˆæ˜¯GC(Garbage Collection) Garbage Collectionå¯ä»¥ç¿»è¯‘ä¸ºâ€œåƒåœ¾æ”¶é›†â€ â€“ ä¸€èˆ¬ä¸»è§‚ä¸Šä¼šè®¤ä¸ºåšæ³•æ˜¯ï¼šæ‰¾åˆ°åƒåœ¾ï¼Œç„¶åæŠŠåƒåœ¾æ‰”æ‰ã€‚åœ¨VMä¸­ï¼ŒGCçš„å®ç°è¿‡ç¨‹æ°æ°ç›¸åï¼ŒGCçš„ç›®çš„æ˜¯ä¸ºäº†è¿½è¸ªæ‰€æœ‰æ­£åœ¨ä½¿ç”¨çš„å¯¹è±¡ï¼Œå¹¶ä¸”å°†å‰©ä½™çš„å¯¹è±¡æ ‡è®°ä¸ºåƒåœ¾ï¼Œéšåæ ‡è®°ä¸ºåƒåœ¾çš„å¯¹è±¡ä¼šè¢«æ¸…é™¤ï¼Œå›æ”¶è¿™äº›åƒåœ¾å¯¹è±¡å æ®çš„å†…å­˜ï¼Œä»è€Œå®ç°å†…å­˜çš„è‡ªåŠ¨ç®¡ç†ã€‚ åˆ†ä»£å‡è¯´(Generational Hypothesis) åç§° å…·ä½“å†…å®¹ å¼±åˆ†ä»£å‡è¯´ï¼ˆWeak Generational Hypothesisï¼‰ å¤§å¤šæ•°å¯¹è±¡åœ¨å¹´è½»æ—¶æ­»äº¡ å¼ºåˆ†ä»£å‡è¯´ï¼ˆStrong Generational Hypothesisï¼‰ è¶Šè€çš„å¯¹è±¡è¶Šä¸å®¹æ˜“æ­»äº¡ å¼±åˆ†ä»£å‡è¯´å·²ç»åœ¨å„ç§ä¸åŒç±»å‹çš„ç¼–ç¨‹èŒƒå¼æˆ–è€…ç¼–ç¨‹è¯­è¨€ä¸­å¾—åˆ°è¯å®ï¼Œè€Œå¼ºåˆ†ä»£å‡è¯´ç›®å‰æä¾›çš„è¯æ®å¹¶ä¸å……è¶³ï¼Œè§‚ç‚¹è¿˜å­˜åœ¨äº‰è®ºã€‚ åˆ†ä»£åƒåœ¾å›æ”¶å™¨çš„ä¸»è¦è®¾è®¡ç›®çš„æ˜¯å‡å°‘å›æ”¶è¿‡ç¨‹çš„åœé¡¿æ—¶é—´ï¼ŒåŒæ—¶æå‡ç©ºé—´ååé‡ã€‚å¦‚æœé‡‡ç”¨å¤åˆ¶ç®—æ³•å¯¹å¹´è½»ä»£å¯¹è±¡è¿›è¡Œå›æ”¶ï¼Œé‚£ä¹ˆæœŸæœ›çš„åœé¡¿æ—¶é—´å¾ˆå¤§ç¨‹åº¦å–å†³äºæ¬¡çº§å›æ”¶(Minor Collection)ä¹‹åå­˜æ´»çš„å¯¹è±¡æ€»é‡ï¼Œè€Œè¿™ä¸€æ•°å€¼åˆå–å†³äºå¹´è½»ä»£çš„æ•´ä½“ç©ºé—´ã€‚ å¦‚æœå¹´è½»ä»£çš„æ•´ä½“ç©ºé—´å¤ªå°ï¼Œè™½ç„¶ä¸€æ¬¡å›æ”¶çš„è¿‡ç¨‹æ¯”è¾ƒå¿«ï¼Œä½†æ˜¯ç”±äºä¸¤æ¬¡å›æ”¶ä¹‹é—´çš„é—´éš”å¤ªçŸ­ï¼Œå¹´è½»ä»£å¯¹è±¡æœ‰å¯èƒ½æ²¡æœ‰è¶³å¤Ÿçš„æ—¶é—´â€œåˆ°è¾¾æ­»äº¡â€ï¼Œå› è€Œå¯¼è‡´å›æ”¶çš„å†…å­˜ä¸å¤šï¼Œæœ‰å¯èƒ½å¼•å‘ä¸‹é¢çš„æƒ…å†µï¼š å¹´è½»ä»£çš„å¯¹è±¡å›æ”¶è¿‡äºé¢‘ç¹å¹¶ä¸”å­˜æ´»ä¸‹æ¥éœ€è¦å¤åˆ¶çš„å¯¹è±¡æ•°é‡å˜å¤šï¼Œå¢å¤§åƒåœ¾å›æ”¶å™¨åœé¡¿çº¿ç¨‹å’Œæ‰«æå…¶æ ˆä¸Šæ•°æ®çš„å¼€é”€ã€‚ å°†è¾ƒå¤§æ¯”ä¾‹çš„å¹´è½»ä»£å¯¹è±¡æå‡åˆ°è€å¹´ä»£ä¼šå¯¼è‡´è€å¹´ä»£è¢«å¿«é€Ÿå¡«å……ï¼Œä¼šå½±å“æ•´ä¸ªå †çš„åƒåœ¾å›æ”¶é€Ÿç‡ã€‚ è®¸å¤šè¯æ®è¡¨æ˜ï¼Œå¯¹æ–°ç”Ÿä»£å¯¹è±¡çš„ä¿®æ”¹ä¼šæ¯”è€å¹´ä»£å¯¹è±¡çš„ä¿®æ”¹æ›´åŠ é¢‘ç¹ï¼Œå¦‚æœè¿‡æ—©å°†å¹´è½»ä»£å¯¹è±¡æ™‹å‡åˆ°è€å¹´ä»£ï¼Œé‚£ä¹ˆå¤§é‡çš„æ›´æ–°æ“ä½œ(mutation)ä¼šç»™èµ‹å€¼å™¨çš„å†™å±éšœå¸¦æ¥æ¯”è¾ƒå¤§çš„å‹åŠ›ã€‚ å¯¹è±¡çš„æ™‹å‡ä¼šä½¿å¾—ç¨‹åºçš„å·¥ä½œé›†åˆå˜å¾—ç¨€ç–ã€‚ åˆ†ä»£åƒåœ¾å›æ”¶å™¨çš„è®¾è®¡å¸ˆå¯¹ä¸Šé¢å‡ ä¸ªæ–¹é¢è¿›è¡Œå¹³è¡¡çš„ä¸€é—¨è‰ºæœ¯ï¼š è¦å°½é‡åŠ å¿«æ¬¡çº§å›æ”¶çš„é€Ÿåº¦ã€‚ è¦å°½é‡å‡å°‘æ¬¡çº§å›æ”¶çš„æˆæœ¬ã€‚ è¦å‡å°‘å›æ”¶æˆæœ¬æ›´é«˜çš„ä¸»å›æ”¶(Major Collection)ã€‚ è¦é€‚å½“å‡å°‘èµ‹å€¼å™¨çš„å†…å­˜ç®¡ç†å¼€é”€ã€‚ åŸºäºå¼±åˆ†ä»£å‡è¯´ï¼ŒJVMä¸­æŠŠå †å†…å­˜åˆ†ä¸ºå¹´è½»ä»£(Young Generation)å’Œè€å¹´ä»£(Old Generation)ï¼Œè€Œè€å¹´ä»£æœ‰äº›æ—¶å€™ä¹Ÿç§°ä¸ºTenuredã€‚ JVMå¯¹ä¸åŒåˆ†ä»£æä¾›äº†ä¸åŒçš„åƒåœ¾å›æ”¶ç®—æ³•ã€‚å®é™…ä¸Šï¼Œä¸åŒåˆ†ä»£ä¹‹é—´çš„å¯¹è±¡æœ‰å¯èƒ½ç›¸äº’å¼•ç”¨ï¼Œè¿™äº›è¢«å¼•ç”¨çš„å¯¹è±¡åœ¨åˆ†ä»£åƒåœ¾å›æ”¶çš„æ—¶å€™ä¹Ÿä¼šè¢«è§†ä¸ºGC Roots(è§ä¸‹ä¸€èŠ‚åˆ†æ)ã€‚å¼±åˆ†ä»£å‡è¯´æœ‰å¯èƒ½åœ¨ç‰¹å®šåœºæ™¯ä¸­å¯¹æŸäº›åº”ç”¨æ˜¯ä¸é€‚ç”¨çš„ï¼›è€ŒGCç®—æ³•é’ˆå¯¹å¹´è½»ä»£æˆ–è€…è€å¹´ä»£çš„å¯¹è±¡è¿›è¡Œäº†ä¼˜åŒ–ï¼Œå¯¹äºå…·å¤‡â€œä¸­ç­‰â€é¢„æœŸå¯¿å‘½çš„å¯¹è±¡ï¼ŒJVMçš„åƒåœ¾å›æ”¶è¡¨ç°æ˜¯ç›¸å¯¹åŠ£åŠ¿çš„ã€‚ å¯¹è±¡åˆ¤æ´»ç®—æ³• JVMä¸­æ˜¯é€šè¿‡å¯è¾¾æ€§ç®—æ³•(Reachability Analysis)æ¥åˆ¤å®šå¯¹è±¡æ˜¯å¦å­˜æ´»çš„ã€‚è¿™ä¸ªç®—æ³•çš„åŸºæœ¬æ€è·¯å°±æ˜¯ï¼šé€šè¿‡ä¸€äº›åˆ—çš„ç§°ä¸ºGC Roots(GCæ ¹é›†åˆ)çš„æ´»è·ƒå¼•ç”¨ä¸ºèµ·å§‹ç‚¹ï¼Œä»è¿™äº›é›†åˆèŠ‚ç‚¹å¼€å§‹å‘ä¸‹æœç´¢ï¼Œæœç´¢æ‰€èµ°è¿‡çš„è·¯å¾„ç§°ä¸ºå¼•ç”¨é“¾(Reference Chain)ï¼Œå½“ä¸€ä¸ªå¯¹è±¡åˆ°GC Rootsæ²¡æœ‰ä»»ä½•å¼•ç”¨é“¾ç›¸è¿æ—¶ï¼Œè¯´æ˜è¯¥å¯¹è±¡æ˜¯ä¸å¯è¾¾çš„ã€‚ GC Rootså…·ä½“æ˜¯æŒ‡ä»€ä¹ˆï¼Ÿè¿™ä¸€ç‚¹å¯ä»¥ä»HotSpot VMçš„Parallel Scavengeæºç å®ç°æ€»ç»“å‡ºæ¥ï¼Œå‚è€ƒjdk9åˆ†æ”¯çš„psTasks.hppå’ŒpsTasks.cppï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192// psTasks.hppclass ScavengeRootsTask : public GCTask &#123; public: enum RootType &#123; universe = 1, jni_handles = 2, threads = 3, object_synchronizer = 4, flat_profiler = 5, system_dictionary = 6, class_loader_data = 7, management = 8, jvmti = 9, code_cache = 10 &#125;; private: RootType _root_type; public: ScavengeRootsTask(RootType value) : _root_type(value) &#123;&#125; char* name() &#123; return (char *)\"scavenge-roots-task\"; &#125; virtual void do_it(GCTaskManager* manager, uint which);&#125;;// psTasks.cppvoid ScavengeRootsTask::do_it(GCTaskManager* manager, uint which) &#123; assert(ParallelScavengeHeap::heap()-&gt;is_gc_active(), \"called outside gc\"); PSPromotionManager* pm = PSPromotionManager::gc_thread_promotion_manager(which); PSScavengeRootsClosure roots_closure(pm); PSPromoteRootsClosure roots_to_old_closure(pm); switch (_root_type) &#123; case universe: Universe::oops_do(&amp;roots_closure); break; case jni_handles: JNIHandles::oops_do(&amp;roots_closure); break; case threads: &#123; ResourceMark rm; Threads::oops_do(&amp;roots_closure, NULL); &#125; break; case object_synchronizer: ObjectSynchronizer::oops_do(&amp;roots_closure); break; case flat_profiler: FlatProfiler::oops_do(&amp;roots_closure); break; case system_dictionary: SystemDictionary::oops_do(&amp;roots_closure); break; case class_loader_data: &#123; PSScavengeKlassClosure klass_closure(pm); ClassLoaderDataGraph::oops_do(&amp;roots_closure, &amp;klass_closure, false); &#125; break; case management: Management::oops_do(&amp;roots_closure); break; case jvmti: JvmtiExport::oops_do(&amp;roots_closure); break; case code_cache: &#123; MarkingCodeBlobClosure each_scavengable_code_blob(&amp;roots_to_old_closure, CodeBlobToOopClosure::FixRelocations); CodeCache::scavenge_root_nmethods_do(&amp;each_scavengable_code_blob); AOTLoader::oops_do(&amp;roots_closure); &#125; break; default: fatal(\"Unknown root type\"); &#125; // Do the real work pm-&gt;drain_stacks(false);&#125; ç”±äºHotSpot VMçš„æºç é‡Œé¢æ³¨é‡Šæ¯”è¾ƒå°‘ï¼Œæ‰€ä»¥åªèƒ½å‚è€ƒä¸€äº›èµ„æ–™å’Œæºç æ–¹æ³•çš„å…·ä½“å®ç°çŒœæµ‹GC Rootsçš„å…·ä½“ç»„æˆï¼š Universe::oops_doï¼šVMçš„ä¸€äº›é™æ€æ•°æ®ç»“æ„é‡ŒæŒ‡å‘GCå †é‡Œçš„å¯¹è±¡çš„æ´»è·ƒå¼•ç”¨ç­‰ç­‰ã€‚ JNIHandles::oops_doï¼šæ‰€æœ‰çš„JNI handleï¼ŒåŒ…æ‹¬æ‰€æœ‰çš„global handleå’Œlocal handleã€‚ Threads::oops_doï¼šæ‰€æœ‰çº¿ç¨‹çš„è™šæ‹Ÿæœºæ ˆï¼Œå…·ä½“åº”è¯¥æ˜¯æ‰€æœ‰Javaçº¿ç¨‹å½“å‰æ´»è·ƒçš„æ ˆå¸§é‡ŒæŒ‡å‘GCå †é‡Œçš„å¯¹è±¡çš„å¼•ç”¨ï¼Œæˆ–è€…æ¢å¥è¯è¯´ï¼Œå½“å‰æ‰€æœ‰æ­£åœ¨è¢«è°ƒç”¨çš„æ–¹æ³•çš„å¼•ç”¨ç±»å‹çš„å‚æ•°/å±€éƒ¨å˜é‡/ä¸´æ—¶å€¼ã€‚ ObjectSynchronizer::oops_doï¼šæ‰€æœ‰è¢«å¯¹è±¡åŒæ­¥å™¨å…³è”çš„å¯¹è±¡ï¼Œçœ‹æºç åº”è¯¥æ˜¯ObjectMonitorä¸­å¤„äºBlockçŠ¶æ€çš„å¯¹è±¡ï¼Œä»Javaä»£ç å±‚é¢åº”è¯¥æ˜¯é€šè¿‡synchronizedå…³é”®å­—åŠ é”æˆ–è€…ç­‰å¾…åŠ é”çš„å¯¹è±¡ã€‚ FlatProfiler::oops_doï¼šæ‰€æœ‰çº¿ç¨‹çš„ä¸­çš„ThreadProfilerã€‚ SystemDictionary::oops_doï¼šSystem Dictionaryï¼Œä¹Ÿå°±æ˜¯ç³»ç»Ÿå­—å…¸ï¼Œæ˜¯è®°å½•äº†æŒ‡å‘Klassï¼ŒKEYæ˜¯ä¸€ä¸ªEntryï¼Œç”±KalssNameå’ŒClassloaderç»„æˆï¼Œå®é™…ä¸Šï¼ŒYGCä¸ä¼šå¤„ç†System Dictionaryï¼Œä½†æ˜¯ä¼šæ‰«æSystem Dictionaryï¼ŒæŸäº›GCå¯èƒ½è§¦å‘ç±»å¸è½½åŠŸèƒ½ï¼Œå¯ä»¥è¿™æ ·ç†è§£ï¼šSystem DictionaryåŒ…å«äº†æ‰€æœ‰çš„ç±»åŠ è½½å™¨ã€‚ ClassLoaderDataGraph::oops_doï¼šæ‰€æœ‰å·²åŠ è½½çš„ç±»æˆ–è€…å·²åŠ è½½çš„ç³»ç»Ÿç±»ã€‚ Management::oops_doï¼šMBeanæ‰€æŒæœ‰çš„å¯¹è±¡ã€‚ JvmtiExport::oops_doï¼šJVMTIå¯¼å‡ºçš„å¯¹è±¡ï¼Œæ–­ç‚¹æˆ–è€…å¯¹è±¡åˆ†é…äº‹ä»¶æ”¶é›†å™¨ç›¸å…³çš„å¯¹è±¡ã€‚ CodeCache::scavenge_root_nmethods_doï¼šä»£ç ç¼“å­˜(Code Cache)ã€‚ AOTLoader::oops_doï¼šAOTåŠ è½½å™¨ç›¸å…³ï¼ŒåŒ…æ‹¬äº†AOTç›¸å…³ä»£ç ç¼“å­˜ã€‚ è¿˜æœ‰å…¶ä»–æœ‰å¯èƒ½çš„å¼•ç”¨ï¼š StringTable::oops_doï¼šæ‰€æœ‰é©»ç•™çš„å­—ç¬¦ä¸²(StringTableä¸­çš„)ã€‚ JVMä¸­çš„å†…å­˜æ±  JVMæŠŠå†…å­˜æ± åˆ’åˆ†ä¸ºå¤šä¸ªåŒºåŸŸï¼Œä¸‹é¢åˆ†åˆ«ä»‹ç»æ¯ä¸ªåŒºåŸŸçš„ç»„æˆå’ŒåŸºæœ¬åŠŸèƒ½ï¼Œæ–¹ä¾¿ä¸‹é¢ä»‹ç»GCç®—æ³•çš„æ—¶å€™å»ç†è§£åƒåœ¾æ”¶é›†å¦‚ä½•åœ¨ä¸åŒçš„å†…å­˜æ± ç©ºé—´ä¸­å‘æŒ¥å…¶èŒè´£ã€‚ å¹´è½»ä»£(Young Generation)ï¼šåŒ…æ‹¬Edenå’ŒSurvivor Spacesï¼Œè€ŒSurvivor Spacesåˆç­‰åˆ†ä¸ºSurvivor 0å’ŒSurvivor 1ï¼Œæœ‰æ—¶å€™ä¹Ÿç§°ä¸ºfromå’Œtoä¸¤ä¸ªåŒºã€‚ è€å¹´ä»£(Old Generation)ï¼šä¸€èˆ¬ç§°ä¸ºTenuredã€‚ å…ƒç©ºé—´ï¼šç§°ä¸ºMetaspaceï¼Œåœ¨Java8ä¸­VMå·²ç»ç§»é™¤äº†æ°¸ä¹…ä»£Permanent Generationã€‚ Eden ä¼Šç”¸å›­æ˜¯åœ°ä¸Šçš„ä¹å›­ï¼Œæ ¹æ®ã€Šåœ£ç»Â·æ—§çº¦Â·åˆ›ä¸–çºªã€‹è®°è½½ï¼Œç¥Â·è€¶å’Œåç…§è‡ªå·±çš„å½¢åƒé€ äº†äººç±»çš„ç¥–å…ˆç”·äººäºšå½“ï¼Œå†ç”¨äºšå½“çš„ä¸€ä¸ªè‚‹éª¨åˆ›é€ äº†å¥³äººå¤å¨ƒï¼Œå¹¶å®‰ç½®ç¬¬ä¸€å¯¹ç”·å¥³ä½åœ¨ä¼Šç”¸å›­ä¸­ã€‚ Edenï¼Œä¹Ÿå°±æ˜¯ä¼Šç”¸å›­ï¼Œæ˜¯ä¸€å—æ™®é€šçš„åœ¨åˆ›å»ºå¯¹è±¡çš„æ—¶å€™è¿›è¡Œå¯¹è±¡åˆ†é…çš„å†…å­˜åŒºåŸŸã€‚è€ŒEdenè¿›ä¸€æ­¥åˆ’åˆ†ä¸ºé©»ç•™åœ¨Edenç©ºé—´ä¸­çš„ä¸€ä¸ªæˆ–è€…å¤šä¸ªThread Local Allocation Buffer(çº¿ç¨‹æœ¬åœ°åˆ†é…ç¼“å†²åŒºï¼Œç®€ç§°TLAB)ï¼ŒTLABæ˜¯çº¿ç¨‹ç‹¬å çš„ã€‚JVMå…è®¸çº¿ç¨‹åœ¨åˆ›å»ºå¤§å¤šæ•°å¯¹è±¡çš„æ—¶å€™ç›´æ¥åœ¨ç›¸åº”çš„TLABä¸­è¿›è¡Œåˆ†é…ï¼Œè¿™æ ·å¯ä»¥é¿å…å¤šçº¿ç¨‹ä¹‹é—´è¿›è¡ŒåŒæ­¥å¸¦æ¥çš„æ€§èƒ½å¼€é”€ã€‚ å½“æ— æ³•åœ¨TLABä¸­è¿›è¡Œå¯¹è±¡åˆ†é…çš„æ—¶å€™(ä¸€èˆ¬æ˜¯ç¼“å†²åŒºæ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—´)ï¼Œé‚£ä¹ˆå¯¹è±¡åˆ†é…æ“ä½œå°†ä¼šåœ¨Edenä¸­å…±äº«çš„ç©ºé—´(Common Area)ä¸­è¿›è¡Œã€‚å¦‚æœæ•´ä¸ªEdenéƒ½æ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—´ï¼Œåˆ™ä¼šè§¦å‘YGC(Young Generation Garbage Collection)ï¼Œä»¥é‡Šæ”¾æ›´å¤šçš„Edenä¸­çš„ç©ºé—´ã€‚è§¦å‘YGCåä¾ç„¶æ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜ï¼Œé‚£ä¹ˆå¯¹è±¡å°±ä¼šåœ¨è€å¹´ä»£ä¸­åˆ†é…ï¼ˆä¸€èˆ¬è¿™ç§æƒ…å†µç§°ä¸ºåˆ†é…æ‹…ä¿(Handle Promotion)ï¼Œæ˜¯æœ‰å‰ç½®æ¡ä»¶çš„ï¼‰ã€‚ å½“åƒåœ¾å›æ”¶å™¨æ”¶é›†Edençš„æ—¶å€™ï¼Œä¼šéå†æ‰€æœ‰ç›¸å¯¹äºGC Rootså¯è¾¾çš„å¯¹è±¡ï¼Œå¹¶ä¸”æ ‡è®°å®ƒä»¬æ˜¯æ´»å¯¹è±¡ï¼Œè¿™ä¸€é˜¶æ®µç§°ä¸ºæ ‡è®°é˜¶æ®µã€‚ è¿™é‡Œè¿˜æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯ï¼šå †ä¸­çš„å¯¹è±¡æœ‰å¯èƒ½è·¨ä»£é“¾æ¥ï¼Œä¹Ÿå°±æ˜¯æœ‰å¯èƒ½å¹´è½»ä»£ä¸­çš„å¯¹è±¡è¢«è€å¹´ä»£ä¸­çš„å¯¹è±¡æŒæœ‰(æ³¨ï¼šè€å¹´ä»£ä¸­çš„å¯¹è±¡è¢«å¹´è½»ä»£ä¸­çš„å¯¹è±¡æŒæœ‰è¿™ç§æƒ…å†µåœ¨YGCä¸­ä¸éœ€è¦è€ƒè™‘)ï¼Œè¿™ä¸ªæ—¶å€™å¦‚æœä¸éå†è€å¹´ä»£çš„å¯¹è±¡ï¼Œé‚£ä¹ˆå°±æ— æ³•é€šè¿‡å¯è¾¾æ€§ç®—æ³•åˆ†æè¿™ç§è¢«è¢«è€å¹´ä»£ä¸­çš„å¯¹è±¡æŒæœ‰çš„å¹´è½»ä»£å¯¹è±¡æ˜¯å¦å¯è¾¾ã€‚JVMä¸­é‡‡ç”¨äº†Card Markingï¼ˆå¡ç‰‡æ ‡è®°ï¼‰çš„æ–¹å¼è§£å†³äº†è¿™ä¸ªé—®é¢˜ï¼Œè¿™é‡Œä¸å¯¹å¡ç‰‡æ ‡è®°çš„ç»†èŠ‚å®ç°è¿›è¡Œå±•å¼€ã€‚ æ ‡è®°é˜¶æ®µå®Œæˆåï¼ŒEdenä¸­æ‰€æœ‰å­˜æ´»çš„å¯¹è±¡ä¼šè¢«å¤åˆ¶åˆ°å¹¸å­˜è€…ç©ºé—´(Survivor Spaces) çš„å…¶ä¸­ä¸€å—ç©ºé—´ã€‚å¤åˆ¶é˜¶æ®µå®Œæˆåï¼Œæ•´ä¸ªEdenè¢«è®¤ä¸ºæ˜¯ç©ºçš„ï¼Œå¯ä»¥é‡æ–°ç”¨äºåˆ†é…æ›´å¤šå…¶ä»–çš„å¯¹è±¡ã€‚è¿™é‡Œé‡‡ç”¨çš„GCç®—æ³•ç§°ä¸ºæ ‡è®°-å¤åˆ¶(Mark and Copy) ç®—æ³•ï¼šæ ‡è®°å­˜æ´»çš„å¯¹è±¡ï¼Œç„¶åå¤åˆ¶å®ƒä»¬åˆ°å¹¸å­˜è€…ç©ºé—´(Survivor Spaces) çš„å…¶ä¸­ä¸€å—ç©ºé—´ï¼Œæ³¨æ„è¿™é‡Œæ˜¯å¤åˆ¶ï¼Œä¸æ˜¯ç§»åŠ¨ã€‚ å…³äºEdenå°±ä»‹ç»è¿™ä¹ˆå¤šï¼Œå…¶ä¸­TLABå’ŒCard Markingæ˜¯JVMä¸­çš„ç›¸å¯¹åº•å±‚å®ç°ï¼Œå¤§æ¦‚çŸ¥é“å³å¯ã€‚ Survivor Spaces Survivor Spacesä¹Ÿå°±æ˜¯å¹¸å­˜è€…ç©ºé—´ï¼Œå¹¸å­˜è€…ç©ºé—´æœ€å¸¸ç”¨çš„åç§°æ˜¯fromå’Œtoã€‚æœ€é‡è¦çš„ä¸€ç‚¹æ˜¯ï¼šå¹¸å­˜è€…ç©ºé—´ä¸­çš„ä¸¤ä¸ªåŒºåŸŸæ€»æœ‰ä¸€ä¸ªåŒºåŸŸæ˜¯ç©ºçš„ã€‚ ä¸‹ä¸€æ¬¡YGCè§¦å‘ä¹‹åï¼Œç©ºé—²çš„é‚£ä¸€å—å¹¸å­˜è€…ç©ºé—´æ‰ä¼šå…¥é©»å¯¹è±¡ã€‚å¹´è½»ä»£çš„æ‰€æœ‰å­˜æ´»çš„å¯¹è±¡(åŒ…æ‹¬Edenå’Œéç©ºçš„fromå¹¸å­˜è€…åŒºåŸŸä¸­çš„å­˜æ´»å¯¹è±¡)ï¼Œéƒ½ä¼šè¢«å¤åˆ¶åˆ°toå¹¸å­˜è€…åŒºåŸŸï¼Œè¿™ä¸ªè¿‡ç¨‹å®Œæˆä¹‹åï¼Œtoå¹¸å­˜è€…åŒºåŸŸä¼šå­˜æ”¾ç€æ´»è·ƒçš„å¯¹è±¡ï¼Œè€Œfromå¹¸å­˜è€…åŒºåŸŸä¼šè¢«æ¸…ç©ºã€‚æ¥ä¸‹æ¥ï¼Œfromå¹¸å­˜è€…åŒºåŸŸå’Œtoå¹¸å­˜è€…åŒºåŸŸçš„è§’è‰²ä¼šäº¤æ¢ï¼Œä¹Ÿå°±æ˜¯ä¸‹ä¸€è½®YGCè§¦å‘ä¹‹åå­˜æ´»çš„å¯¹è±¡ä¼šå¤åˆ¶åˆ°fromå¹¸å­˜è€…åŒºåŸŸï¼Œè€Œtoå¹¸å­˜è€…åŒºåŸŸä¼šè¢«æ¸…ç©ºï¼Œå¦‚æ­¤å¾ªç¯å¾€å¤ã€‚ ä¸Šé¢æåˆ°çš„å­˜æ´»å¯¹è±¡çš„å¤åˆ¶è¿‡ç¨‹åœ¨ä¸¤ä¸ªå¹¸å­˜è€…ç©ºé—´ä¹‹é—´å¤šæ¬¡å¾€å¤ä¹‹åï¼ŒæŸäº›å­˜æ´»çš„å¯¹è±¡â€œå¹´é¾„è¶³å¤Ÿå¤§â€(ç»è¿‡å¤šæ¬¡å¤åˆ¶è¿˜å­˜æ´»ä¸‹æ¥)ï¼Œåˆ™è¿™äº›â€œå¹´çºªå¤§çš„â€å¯¹è±¡å°±ä¼šæ™‹å‡åˆ°è€å¹´ä»£ä¸­ï¼Œè¿™äº›å¯¹è±¡ä¼šä»å¹¸å­˜è€…ç©ºé—´ç§»åŠ¨åˆ°è€å¹´ä»£ç©ºé—´ä¸­ï¼Œç„¶åå®ƒä»¬å°±é©»ç•™åœ¨è€å¹´ä»£ä¸­ï¼Œç›´åˆ°è‡ªèº«å˜ä¸ºä¸å¯è¾¾ã€‚ å¦‚æœå¯¹è±¡åœ¨Edenä¸­å‡ºç”Ÿå¹¶ä¸”ç»è¿‡äº†ç¬¬ä¸€æ¬¡YGCä¹‹åä¾ç„¶å­˜æ´»ï¼Œå¹¶ä¸”èƒ½å¤Ÿè¢«Survivor Spaceså®¹çº³çš„è¯ï¼Œå¯¹è±¡å°†ä¼šè¢«å¤åˆ¶åˆ°Survivor Spaceså¹¶ä¸”å¯¹è±¡å¹´é¾„è¢«è®¾å®šä¸º1ã€‚å¯¹è±¡åœ¨Survivor Spacesä¸­æ¯ç»å†ä¸€æ¬¡YGCä¹‹åè¿˜èƒ½å­˜æ´»ä¸‹æ¥ï¼Œåˆ™å¯¹è±¡å¹´é¾„å°±ä¼šå¢åŠ 1ï¼Œå½“å®ƒçš„å¹´é¾„å¢åŠ åˆ°æ™‹å‡è€å¹´ä»£çš„å¹´é¾„é˜ˆå€¼ï¼Œé‚£ä¹ˆå®ƒå°±ä¼šæ™‹å‡åˆ°è€å¹´ä»£ä¹Ÿå°±æ˜¯è¢«ç§»åŠ¨åˆ°è€å¹´ä»£ä¸­ã€‚æ™‹å‡è€å¹´ä»£çš„å¹´é¾„é˜ˆå€¼çš„JVMå‚æ•°æ˜¯-XX:MaxTenuringThreshold=nï¼š VMå‚æ•° åŠŸèƒ½ å¯é€‰å€¼ é»˜è®¤å€¼ -XX:MaxTenuringThreshold=n Survivor Spaceså­˜æ´»å¯¹è±¡æ™‹å‡è€å¹´ä»£çš„å¹´é¾„é˜ˆå€¼ 1&lt;= n &lt;= 15 15 å€¼å¾—æ³¨æ„çš„æ˜¯ï¼šJVMä¸­è®¾ç½®-XX:MaxTenuringThresholdçš„é»˜è®¤å€¼ä¸ºæœ€å¤§å¯é€‰å€¼ï¼Œä¹Ÿå°±æ˜¯15ã€‚ JVMè¿˜å…·å¤‡åŠ¨æ€å¯¹è±¡å¹´é¾„åˆ¤æ–­çš„åŠŸèƒ½ï¼ŒJVMå¹¶ä¸æ˜¯æ°¸è¿œåœ°è¦æ±‚å­˜æ´»å¯¹è±¡çš„å¹´é¾„å¿…é¡»è¾¾åˆ°MaxTenuringThresholdæ‰èƒ½æ™‹å‡åˆ°è€å¹´ä»£ï¼Œå¦‚æœåœ¨Survivor Spacesä¸­ç›¸åŒå¹´é¾„çš„æ‰€æœ‰å¯¹è±¡çš„å¤§å°æ€»å’Œå¤§äºSurvivor Spacesçš„ä¸€åŠï¼Œé‚£ä¹ˆå¹´é¾„å¤§äºæˆ–è€…ç­‰äºè¯¥å¹´é¾„çš„å¯¹è±¡å¯ä»¥ç›´æ¥æ™‹å‡åˆ°è€å¹´ä»£ï¼Œä¸éœ€è¦ç­‰å¾…å¯¹è±¡å¹´é¾„åˆ°è¾¾MaxTenuringThresholdï¼Œä¾‹å¦‚ï¼š ç±»å‹ å æ¯” å¹´é¾„ åŠ¨ä½œ(MaxTenuringThreshold=15) ObjectType-1 60% 5 ä¸‹ä¸€æ¬¡YGCå¦‚æœå­˜æ´»ç›´æ¥æ™‹å‡åˆ°è€å¹´ä»£ ObjectType-2 1% 6 ä¸‹ä¸€æ¬¡YGCå¦‚æœå­˜æ´»ç›´æ¥æ™‹å‡åˆ°è€å¹´ä»£ ObjectType-3 10% 4 ä¸‹ä¸€æ¬¡YGCå¦‚æœå­˜æ´»å¯¹è±¡å¹´é¾„å¢åŠ 1 å¯ä»¥ç®€å•æ€»ç»“ä¸€ä¸‹å¯¹è±¡è¿›å…¥è€å¹´ä»£çš„å‡ ç§æƒ…å†µï¼š å¤šæ¬¡YGCå¯¹è±¡å­˜æ´»ä¸‹æ¥å¹¶ä¸”å¹´é¾„åˆ°è¾¾è®¾å®šçš„-XX:MaxTenuringThreshold=nå¯¼è‡´å¯¹è±¡æ™‹å‡ã€‚ å› ä¸ºåŠ¨æ€å¯¹è±¡å¹´é¾„åˆ¤æ–­å¯¼è‡´å¯¹è±¡æ™‹å‡ã€‚ å¤§å¯¹è±¡ç›´æ¥è¿›å…¥è€å¹´ä»£ï¼Œè¿™é‡Œå¤§å¯¹è±¡é€šå¸¸æŒ‡éœ€è¦å¤§é‡è¿ç»­å†…å­˜çš„Javaå¯¹è±¡ï¼Œæœ€å¸¸è§çš„å°±æ˜¯å¤§å‹çš„æ•°ç»„å¯¹è±¡æˆ–è€…é•¿åº¦å¾ˆå¤§çš„å­—ç¬¦ä¸²ï¼Œå› ä¸ºå¹´è½»ä»£å®Œå…¨æœ‰å¯èƒ½è£…ä¸ä¸‹è¿™ç±»å¤§å¯¹è±¡ã€‚ å¹´è½»ä»£ç©ºé—´ä¸è¶³çš„æ—¶å€™ï¼Œè€å¹´ä»£ä¼šè¿›è¡Œç©ºé—´åˆ†é…æ‹…ä¿ï¼Œè¿™ç§æƒ…å†µä¸‹å¯¹è±¡ä¹Ÿæ˜¯ç›´æ¥åœ¨è€å¹´ä»£åˆ†é…ã€‚ Tenured è€å¹´ä»£(Old Generation)æ›´å¤šæ—¶å€™è¢«ç§°ä¸ºTenuredï¼Œå®ƒçš„å†…å­˜ç©ºé—´çš„å®ç°ä¸€èˆ¬ä¼šæ›´åŠ å¤æ‚ã€‚è€å¹´ä»£ç©ºé—´ä¸€èˆ¬è¦æ¯”å¹´è½»å¤§å¤§å¾—å¤šï¼Œå®ƒé‡Œé¢æ‰¿è½½çš„å¯¹è±¡ä¸€èˆ¬ä¸ä¼šæ˜¯â€œå†…å­˜åƒåœ¾â€ï¼Œä¾§é¢ä¹Ÿè¯´æ˜è€å¹´ä»£ä¸­çš„å¯¹è±¡çš„å›æ”¶ç‡ä¸€èˆ¬æ¯”è¾ƒä½ã€‚ è€å¹´ä»£å‘ç”ŸGCçš„é¢‘ç‡ä¸€èˆ¬æƒ…å†µä¸‹ä¼šæ¯”å¹´è½»ä»£ä½ï¼Œå¹¶ä¸”è€å¹´ä»£ä¸­çš„å¤§å¤šæ•°å¯¹è±¡éƒ½è¢«æœŸæœ›ä¸ºå­˜æ´»çš„å¯¹è±¡(ä¹Ÿå°±æ˜¯å¯¹è±¡ç»å†GCä¹‹åå­˜æ´»ç‡æ¯”è¾ƒé«˜)ï¼Œå› æ­¤æ ‡è®°å’Œå¤åˆ¶ç®—æ³•å¹¶ä¸é€‚ç”¨äºè€å¹´ä»£ã€‚è€å¹´ä»£çš„GCç®—æ³•ä¸€èˆ¬æ˜¯ç§»åŠ¨å¯¹è±¡ä»¥æœ€å°åŒ–å†…å­˜ç¢ç‰‡ã€‚è€å¹´ä»£çš„GCç®—æ³•ä¸€èˆ¬è§„åˆ™å¦‚ä¸‹ï¼š é€šè¿‡GC Rootséå†å’Œæ ‡è®°æ‰€æœ‰å¯è¾¾çš„å¯¹è±¡ã€‚ åˆ é™¤æ‰€æœ‰ç›¸å¯¹äºGC Rootsä¸å¯è¾¾çš„å¯¹è±¡ã€‚ é€šè¿‡æŠŠå­˜æ´»çš„å¯¹è±¡è¿ç»­åœ°å¤åˆ¶åˆ°è€å¹´ä»£å†…å­˜ç©ºé—´çš„å¼€å¤´(ä¹Ÿå°±æ˜¯èµ·å§‹åœ°å€çš„ä¸€ç«¯)ä»¥å‹ç¼©è€å¹´ä»£å†…å­˜ç©ºé—´çš„å†…å®¹ï¼Œè¿™ä¸ªè¿‡ç¨‹ä¸»è¦åŒ…æ‹¬æ˜¾å¼çš„å†…å­˜å‹ç¼©ä»è€Œé¿å…è¿‡å¤šçš„å†…å­˜ç¢ç‰‡ã€‚ Metaspace åœ¨Java8ä¹‹å‰JVMå†…å­˜æ± ä¸­è¿˜å®šä¹‰äº†ä¸€å—ç©ºé—´å«æ°¸ä¹…ä»£(Permanent Generation)ï¼Œè¿™å—å†…å­˜ç©ºé—´ä¸»è¦ç”¨äºå­˜æ”¾å…ƒæ•°æ®ä¾‹å¦‚Classä¿¡æ¯ç­‰ç­‰ï¼Œå®ƒè¿˜å­˜æ”¾å…¶ä»–æ•°æ®å†…å®¹ï¼Œä¾‹å¦‚é©»ç•™çš„å­—ç¬¦ä¸²(å­—ç¬¦ä¸²å¸¸é‡æ± )ã€‚å®é™…ä¸Šæ°¸ä¹…ä»£æ›¾ç»ç»™Javaå¼€å‘è€…å¸¦æ¥äº†å¾ˆå¤šéº»çƒ¦ï¼Œå› ä¸ºå¤§å¤šæ•°æƒ…å†µä¸‹å¾ˆéš¾é¢„æµ‹æ°¸ä¹…ä»£éœ€è¦è®¾å®šå¤šå¤§çš„ç©ºé—´ï¼Œå› ä¸ºå¼€å‘è€…ä¹Ÿå¾ˆéš¾é¢„æµ‹å…ƒæ•°æ®æˆ–è€…å­—ç¬¦ä¸²å¸¸é‡æ± çš„å…·ä½“å¤§å°ï¼Œä¸€æ—¦åˆ†é…çš„å…ƒæ•°æ®ç­‰å†…å®¹å‡ºç°äº†å¤±è´¥å°±ä¼šé‡åˆ°java.lang.OutOfMemoryError: Permgen spaceå¼‚å¸¸ã€‚æ’é™¤å†…å­˜æº¢å‡ºå¯¼è‡´çš„java.lang.OutOfMemoryErrorå¼‚å¸¸ï¼Œå¦‚æœæ˜¯æ­£å¸¸æƒ…å†µä¸‹å¯¼è‡´çš„å¼‚å¸¸ï¼Œå”¯ä¸€çš„è§£å†³æ‰‹æ®µå°±æ˜¯é€šè¿‡VMå‚æ•°-XX:MaxPermSize=XXXXmå¢å¤§æ°¸ä¹…ä»£çš„å†…å­˜ï¼Œä¸è¿‡è¿™æ ·ä¹Ÿæ˜¯æ²»æ ‡ä¸æ²»æœ¬ã€‚ å› ä¸ºå…ƒæ•°æ®ç­‰å†…å®¹æ˜¯éš¾ä»¥é¢„æµ‹çš„ï¼ŒJava8ä¸­å·²ç»ç§»é™¤äº†æ°¸ä¹…ä»£ï¼Œæ–°å¢äº†ä¸€å—å†…å­˜åŒºåŸŸMetaspace(å…ƒç©ºé—´)ï¼Œå¾ˆå¤šå…¶ä»–æ‚é¡¹(ä¾‹å¦‚å­—ç¬¦ä¸²å¸¸é‡æ± )éƒ½ç§»åŠ¨äº†Javaå †ä¸­ã€‚Classå®šä¹‰ä¿¡æ¯ç­‰å…ƒæ•°æ®ç›®å‰æ˜¯ç›´æ¥åŠ è½½åˆ°å…ƒç©ºé—´ä¸­ã€‚å…ƒç©ºé—´æ˜¯ä¸€ç‰‡åˆ†é…åœ¨æœºå™¨æœ¬åœ°å†…å­˜(native memory)çš„å†…å­˜åŒºï¼Œå®ƒå’Œæ‰¿è½½Javaå¯¹è±¡çš„å †å†…å­˜æ˜¯éš”ç¦»çš„ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼Œå…ƒç©ºé—´çš„å¤§å°ä»…ä»…å—é™äºæœºå™¨æœ¬åœ°å†…å­˜å¯ä»¥åˆ†é…ç»™Javaç¨‹åºçš„æé™å€¼ï¼Œè¿™æ ·åŸºæœ¬å¯ä»¥é¿å…å› ä¸ºæ·»åŠ æ–°çš„ç±»å¯¼è‡´java.lang.OutOfMemoryError: Permgen spaceå¼‚å¸¸å‘ç”Ÿçš„åœºæ™¯ã€‚ VMå‚æ•° åŠŸèƒ½ å¯é€‰å€¼ é»˜è®¤å€¼ XX:MetaspaceSize=Xm Metaspaceæ‰©å®¹æ—¶è§¦å‘FullGCçš„åˆå§‹åŒ–é˜ˆå€¼ - - XX:MaxMetaspaceSize=Ym Metaspaceçš„å†…å­˜ä¸Šé™ - æ¥è¿‘äºæ— ç©·å¤§ å¸¸ç”¨å†…å­˜æ± ç›¸å…³çš„VMå‚æ•° -Xmx å’Œ -Xms VMå‚æ•° åŠŸèƒ½ å¯é€‰å€¼ é»˜è®¤å€¼ -Xmx è®¾ç½®æœ€å¤§å †å†…å­˜å¤§å° æœ‰ä¸‹é™æ§åˆ¶ï¼Œè§†VMç‰ˆæœ¬ - -Xms è®¾ç½®æœ€å°å †å†…å­˜å¤§å° æœ‰ä¸‹é™æ§åˆ¶ï¼Œè§†VMç‰ˆæœ¬ - -Xmnã€-XX:NewRatio å’Œ -XX:SurvivorRatio VMå‚æ•° åŠŸèƒ½ å¯é€‰å€¼ é»˜è®¤å€¼ -Xmn è®¾ç½®å¹´è½»ä»£å†…å­˜å¤§å° - - -XX:NewRatio= è®¾ç½®è€å¹´ä»£å’Œå¹´è½»ä»£çš„å†…å­˜å¤§å°æ¯”å€¼ï¼Œè®¾ç½®ä¸º4è¡¨ç¤ºå¹´è½»ä»£å å †å†…å­˜çš„1/5 - 4 -XX:SurvivorRatio= è®¾ç½®Edenå’Œå¹¸å­˜è€…åŒºåŸŸçš„å†…å­˜å¤§å°æ¯”å€¼ï¼Œè®¾ç½®ä¸º8è¡¨ç¤ºfrom:to:Eden=1:1:8 - 8 GCç±»å‹ å‚è€ƒRå¤§(RednaxelaFX)çš„çŸ¥ä¹å›ç­”ï¼Œå…¶å®åœ¨HotSpot VMçš„GCåˆ†ç±»åªæœ‰ä¸¤å¤§ç§ï¼š Partial GCï¼šä¹Ÿå°±æ˜¯éƒ¨åˆ†GCï¼Œä¸æ”¶é›†æ•´ä¸ªGCå †ã€‚ Young GCï¼šåªæ”¶é›†young gençš„GCã€‚ Old GCï¼šåªæ”¶é›†old gençš„GCï¼Œç›®å‰åªæœ‰CMSçš„concurrent collectionæ˜¯è¿™ä¸ªæ¨¡å¼ã€‚ Mixed GCï¼šæ”¶é›†æ•´ä¸ªyoung genä»¥åŠéƒ¨åˆ†old gençš„GCï¼Œç›®å‰åªæœ‰G1æœ‰è¿™ä¸ªæ¨¡å¼ã€‚ Full GCï¼šæ”¶é›†æ•´ä¸ªå †ï¼ŒåŒ…æ‹¬young genã€old genã€perm genï¼ˆå¦‚æœå­˜åœ¨çš„è¯ï¼‰ç­‰æ‰€æœ‰éƒ¨åˆ†çš„æ¨¡å¼ã€‚ å› ä¸ºHotSpot VMå‘å±•å¤šå¹´ï¼Œå¤–ç•Œå¯¹GCçš„åè¯è§£è¯»å·²ç»æ··ä¹±ï¼Œæ‰€ä»¥æ‰å‡ºç°äº†Minor GCã€Major GCå’ŒFull GCã€‚ Minor GC Minor GCï¼Œä¹Ÿå°±æ˜¯Minor Garbage Collectionï¼Œç›´è¯‘ä¸ºæ¬¡çº§åƒåœ¾å›æ”¶ï¼Œå®ƒçš„å®šä¹‰ç›¸å¯¹æ¸…æ™°ï¼šå‘ç”Ÿåœ¨å¹´è½»ä»£çš„åƒåœ¾å›æ”¶å°±å«åšMinor GCã€‚Minor Garbage Collectionå¤„ç†è¿‡ç¨‹ä¸­ä¼šå‘ç”Ÿï¼š å½“JVMæ— æ³•ä¸ºæ–°çš„å¯¹è±¡åˆ†é…å†…å­˜ç©ºé—´çš„æ—¶å€™ï¼Œå§‹ç»ˆä¼šè§¦å‘Minor GCï¼Œå¸¸è§çš„æƒ…å†µå¦‚Edençš„å†…å­˜å·²ç»æ»¡äº†ï¼Œå¹¶ä¸”å¯¹è±¡åˆ†é…çš„å‘ç”Ÿç‡è¶Šé«˜ï¼ŒMinor GCå‘ç”Ÿçš„é¢‘ç‡è¶Šé«˜ã€‚ Minor GCæœŸé—´ï¼Œè€å¹´ä»£ä¸­çš„å¯¹è±¡ä¼šè¢«å¿½ç•¥ã€‚è€å¹´ä»£ä¸­çš„å¯¹è±¡å¼•ç”¨çš„å¹´è½»ä»£çš„å¯¹è±¡ä¼šè¢«è®¤ä¸ºæ˜¯GC Rootsçš„ä¸€éƒ¨åˆ†ï¼Œåœ¨æ ‡è®°é˜¶æ®µä¼šç®€å•å¿½ç•¥å¹´è½»ä»£å¯¹è±¡ä¸­å¼•ç”¨çš„è€å¹´ä»£å¯¹è±¡ã€‚ Minor GCä¼šå¯¼è‡´Stop The Worldï¼Œè¡¨ç°ä¸ºæš‚åœåº”ç”¨çº¿ç¨‹ã€‚å¤§å¤šæ•°æƒ…å†µä¸‹ï¼ŒEdenä¸­çš„å¤§å¤šæ•°å¯¹è±¡éƒ½å¯ä»¥è§†ä¸ºåƒåœ¾å¹¶ä¸”è¿™äº›åƒåœ¾ä¸ä¼šè¢«å¤åˆ¶åˆ°å¹¸å­˜è€…ç©ºé—´ï¼Œè¿™ä¸ªæ—¶å€™Minor GCçš„åœé¡¿æ—¶é—´ä¼šååˆ†çŸ­æš‚ï¼Œç”šè‡³å¯ä»¥å¿½ç•¥ä¸è®¡ã€‚ç›¸åï¼Œå¦‚æœEdenä¸­æœ‰å¤§é‡å­˜æ´»å¯¹è±¡éœ€è¦å¤åˆ¶åˆ°å¹¸å­˜è€…ç©ºé—´ï¼Œé‚£ä¹ˆMinor GCçš„åœé¡¿æ—¶é—´ä¼šæ˜¾è‘—å¢åŠ ã€‚ Major GCå’ŒFull GC Major GC(Major Garbage Collectionï¼Œå¯ä»¥ç›´è¯‘ä¸ºä¸»åƒåœ¾æ”¶é›†)å’ŒFull GCç›®å‰æ˜¯ä¸¤ä¸ªæ²¡æœ‰æ­£å¼å®šä¹‰çš„æœ¯è¯­ï¼Œå…·ä½“æ¥è¯´å°±æ˜¯ï¼šJVMè§„èŒƒä¸­æˆ–è€…åƒåœ¾æ”¶é›†ç ”ç©¶è®ºæ–‡ä¸­éƒ½æ²¡æœ‰æ˜ç¡®å®šä¹‰Major GCæˆ–è€…Full GCã€‚ä¸è¿‡æŒ‰ç…§æ°‘é—´æˆ–è€…çº¦å®šä¿—æˆï¼Œä¸¤è€…åŒºåˆ«å¦‚ä¸‹ï¼š Major GCï¼šå¯¹è€å¹´ä»£è¿›è¡Œåƒåœ¾æ”¶é›†ã€‚ Full GCï¼šå¯¹æ•´ä¸ªå †è¿›è¡Œåƒåœ¾æ”¶é›† â€“ åŒ…æ‹¬å¹´è½»ä»£å’Œè€å¹´ä»£ã€‚ å®é™…ä¸Šï¼ŒGCè¿‡ç¨‹æ˜¯ååˆ†å¤æ‚çš„ï¼Œè€Œä¸”å¾ˆå¤šMajor GCéƒ½æ˜¯ç”±Minor GCè§¦å‘çš„ï¼Œæ‰€ä»¥è¦ä¸¥æ ¼åˆ†å‰²Major GCæˆ–è€…Minor GCå‡ ä¹æ˜¯ä¸å¯èƒ½çš„ã€‚å¦ä¸€æ–¹é¢ï¼Œç°åœ¨åƒåœ¾æ”¶é›†ç®—æ³•åƒG1æ”¶é›†ç®—æ³•æä¾›éƒ¨åˆ†åƒåœ¾å›æ”¶åŠŸèƒ½ï¼Œä¾§é¢è¯´æ˜å¹¶ä¸èƒ½å•çº¯æŒ‰ç…§æ”¶é›†ä»€ä¹ˆåŒºåŸŸæ¥åˆ’åˆ†GCçš„ç±»å‹ã€‚ ä¸Šé¢çš„ä¸€äº›ç†è®ºæˆ–è€…èµ„æ–™æŒ‡æ˜ï¼šä¸å…¶è®¨è®ºæˆ–è€…æ‹…å¿ƒGCåˆ°åº•æ˜¯Major GCæˆ–è€…æ˜¯Minor GCï¼Œä¸å¦‚èŠ±æ›´å¤šç²¾åŠ›å»å…³æ³¨GCè¿‡ç¨‹æ˜¯å¦ä¼šå¯¼è‡´åº”ç”¨çš„çº¿ç¨‹åœé¡¿æˆ–è€…GCè¿‡ç¨‹æ˜¯å¦èƒ½å¤Ÿå’Œåº”ç”¨çº¿ç¨‹å¹¶å‘æ‰§è¡Œã€‚ å¸¸ç”¨çš„GCç®—æ³• ä¸‹é¢åˆ†æä¸€ä¸‹ç›®å‰Hotspot VMä¸­æ¯”è¾ƒå¸¸è§çš„GCç®—æ³•ï¼Œå› ä¸ºG1ç®—æ³•ç›¸å¯¹å¤æ‚ï¼Œè¿™é‡Œæš‚æ—¶æ²¡æœ‰èƒ½åŠ›åˆ†æã€‚ GCç®—æ³•çš„ç›®çš„ GCç®—æ³•çš„ç›®çš„ä¸»è¦æœ‰ä¸¤ä¸ªï¼š æ‰¾å‡ºæ‰€æœ‰å­˜æ´»çš„å¯¹è±¡ï¼Œå¯¹å®ƒä»¬è¿›è¡Œæ ‡è®°ã€‚ ç§»é™¤æ‰€æœ‰æ— ç”¨çš„å¯¹è±¡ã€‚ å¯»æ‰¾å­˜æ´»çš„å¯¹è±¡ä¸»è¦æ˜¯åŸºäºGC Rootsçš„å¯è¾¾æ€§ç®—æ³•ï¼Œå…³äºæ ‡è®°é˜¶æ®µæœ‰å‡ ç‚¹æ³¨æ„äº‹é¡¹ï¼š æ ‡è®°é˜¶æ®µæ‰€æœ‰åº”ç”¨çº¿ç¨‹å°†ä¼šåœé¡¿(ä¹Ÿå°±æ˜¯Stop The World)ï¼Œåº”ç”¨çº¿ç¨‹æš‚æ—¶åœé¡¿ä¿å­˜å…¶ä¿¡æ¯åœ¨è¿˜åŸç‚¹ä¸­(Safepoint)ã€‚ æ ‡è®°é˜¶æ®µçš„æŒç»­æ—¶é—´å¹¶ä¸å–å†³äºå †ä¸­çš„å¯¹è±¡æ€»æ•°æˆ–è€…æ˜¯å †çš„å¤§å°ï¼Œè€Œæ˜¯å–å†³äºå­˜æ´»å¯¹è±¡çš„æ€»æ•°ï¼Œå› æ­¤å¢åŠ å †çš„å¤§å°å¹¶ä¸ä¼šæ˜¾è‘—å½±å“æ ‡è®°é˜¶æ®µçš„æŒç»­æ—¶é—´ã€‚ æ ‡è®°é˜¶æ®µå®Œæˆåçš„ä¸‹ä¸€ä¸ªé˜¶æ®µå°±æ˜¯ç§»é™¤æ‰€æœ‰æ— ç”¨çš„å¯¹è±¡ï¼ŒæŒ‰ç…§å¤„ç†æ–¹å¼åˆ†ä¸ºä¸‰ç§å¸¸è§çš„ç®—æ³•ï¼š Sweep â€“ æ¸…ç†ï¼Œä¹Ÿå°±æ˜¯Mark and Sweepï¼Œæ ‡è®°-æ¸…ç†ã€‚ Compact â€“ å‹ç¼©ï¼Œä¹Ÿå°±æ˜¯Mark-Sweep-Compactï¼Œæ ‡è®°-æ¸…ç†-å‹ç¼©ã€‚ Copy â€“ å¤åˆ¶ï¼Œä¹Ÿå°±æ˜¯Mark and Copyï¼Œæ ‡è®°-å¤åˆ¶ã€‚ Mark-Sweepç®—æ³• Mark-Sweepç®—æ³•ï¼Œä¹Ÿå°±æ˜¯æ ‡è®°-æ¸…ç†ç®—æ³•ï¼Œæ˜¯ä¸€ç§é—´æ¥å›æ”¶ç®—æ³•(Indirect Collection)ï¼Œå®ƒå¹¶éç›´æ¥æ£€æµ‹åƒåœ¾å¯¹è±¡æœ¬èº«ï¼Œè€Œæ˜¯å…ˆç¡®å®šæ‰€æœ‰å­˜æ´»çš„å¯¹è±¡ï¼Œç„¶ååè¿‡æ¥åˆ¤æ–­å…¶ä»–å¯¹è±¡æ˜¯åƒåœ¾å¯¹è±¡ã€‚ä¸»è¦åŒ…æ‹¬æ ‡è®°å’Œæ¸…ç†ä¸¤ä¸ªé˜¶æ®µï¼Œå®ƒæ˜¯æœ€ç®€å•å’Œæœ€åŸºç¡€çš„æ”¶é›†ç®—æ³•ï¼Œä¸»è¦åŒ…æ‹¬ä¸¤ä¸ªé˜¶æ®µï¼š ç¬¬ä¸€é˜¶æ®µä¸ºè¿½è¸ª(trace)é˜¶æ®µï¼šæ”¶é›†å™¨ä»GC Rootså¼€å§‹éå†æ‰€æœ‰å¯è¾¾å¯¹è±¡ï¼Œå¹¶ä¸”å¯¹è¿™äº›å­˜æ´»çš„å¯¹è±¡è¿›è¡Œæ ‡è®°(mark)ã€‚ ç¬¬äºŒé˜¶æ®µä¸ºæ¸…ç†(sweep)é˜¶æ®µï¼šæ”¶é›†å™¨æŠŠæ‰€æœ‰æœªæ ‡è®°çš„å¯¹è±¡è¿›è¡Œæ¸…ç†å’Œå›æ”¶ã€‚ Mark-Sweep-Compactç®—æ³• å†…å­˜ç¢ç‰‡åŒ–æ˜¯éç§»åŠ¨å¼æ”¶é›†ç®—æ³•æ— æ³•è§£å†³çš„ä¸€ä¸ªé—®é¢˜ä¹‹ä¸€ï¼šå°½ç®¡å †ä¸­æœ‰å¯ç”¨ç©ºé—´ï¼Œä½†æ˜¯å†…å­˜ç®¡ç†å™¨å´æ— æ³•æ‰¾åˆ°ä¸€å—è¿ç»­å†…å­˜å—æ¥æ»¡è¶³è¾ƒå¤§å¯¹è±¡çš„åˆ†é…éœ€æ±‚ï¼Œæˆ–è€…èŠ±è´¹è¾ƒé•¿æ—¶é—´æ‰èƒ½æ‰¾åˆ°åˆé€‚çš„ç©ºé—²å†…å­˜ç©ºé—´ã€‚ Mark-Sweep-Compactç®—æ³•ï¼Œä¹Ÿå°±æ˜¯æ ‡è®°-æ¸…ç†-å‹ç¼©ç®—æ³•ï¼Œä¹Ÿæ˜¯ä¸€ç§é—´æ¥å›æ”¶ç®—æ³•(Indirect Collection)ï¼Œå®ƒä¸»è¦åŒ…æ‹¬ä¸‰ä¸ªé˜¶æ®µï¼š æ ‡è®°é˜¶æ®µï¼šæ”¶é›†å™¨ä»GC Rootså¼€å§‹éå†æ‰€æœ‰å¯è¾¾å¯¹è±¡ï¼Œå¹¶ä¸”å¯¹è¿™äº›å­˜æ´»çš„å¯¹è±¡è¿›è¡Œæ ‡è®°ã€‚ æ¸…ç†é˜¶æ®µï¼šæ”¶é›†å™¨æŠŠæ‰€æœ‰æœªæ ‡è®°çš„å¯¹è±¡è¿›è¡Œæ¸…ç†å’Œå›æ”¶ã€‚ å‹ç¼©é˜¶æ®µï¼šæ”¶é›†å™¨æŠŠæ‰€æœ‰å­˜æ´»çš„å¯¹è±¡ç§»åŠ¨åˆ°å †å†…å­˜çš„èµ·å§‹ç«¯ï¼Œç„¶åæ¸…ç†æ‰ç«¯è¾¹ç•Œä¹‹å¤–çš„å†…å­˜ç©ºé—´ã€‚ å¯¹å †å†…å­˜è¿›è¡Œå‹ç¼©æ•´ç†å¯ä»¥æœ‰æ•ˆåœ°é™ä½å†…å­˜å¤–éƒ¨ç¢ç‰‡åŒ–(External Fragmentation)é—®é¢˜ï¼Œè¿™ä¸ªæ˜¯æ ‡è®°-æ¸…ç†-å‹ç¼©ç®—æ³•çš„ä¸€ä¸ªä¼˜åŠ¿ã€‚ Mark-Copyç®—æ³• Mark-Copyç®—æ³•ï¼Œä¹Ÿå°±æ˜¯æ ‡è®°-å¤åˆ¶ç®—æ³•ï¼Œå’Œæ ‡è®°-æ¸…ç†-å‹ç¼©ç®—æ³•ååˆ†ç›¸ä¼¼ï¼Œé‡è¦çš„åŒºåˆ«åœ¨äºï¼šæ ‡è®°-å¤åˆ¶ç®—æ³•åœ¨æ ‡è®°å’Œæ¸…ç†å®Œæˆä¹‹åï¼Œæ‰€æœ‰å­˜æ´»çš„å¯¹è±¡ä¼šè¢«å¤åˆ¶åˆ°ä¸€ä¸ªä¸åŒçš„å†…å­˜åŒºåŸŸ â€“ å¹¸å­˜è€…ç©ºé—´ã€‚ä¸»è¦åŒ…æ‹¬ä¸‰ä¸ªé˜¶æ®µï¼š æ ‡è®°é˜¶æ®µï¼šæ”¶é›†å™¨ä»GC Rootså¼€å§‹éå†æ‰€æœ‰å¯è¾¾å¯¹è±¡ï¼Œå¹¶ä¸”å¯¹è¿™äº›å­˜æ´»çš„å¯¹è±¡è¿›è¡Œæ ‡è®°ã€‚ æ¸…ç†é˜¶æ®µï¼šæ”¶é›†å™¨æŠŠæ‰€æœ‰æœªæ ‡è®°çš„å¯¹è±¡è¿›è¡Œæ¸…ç†å’Œå›æ”¶ â€” å®é™…ä¸Šè¿™ä¸€æ­¥å¯èƒ½æ˜¯ä¸å­˜åœ¨çš„ï¼Œå› ä¸ºå­˜æ´»å¯¹è±¡æŒ‡é’ˆè¢«å¤åˆ¶ä¹‹åï¼ŒåŸæ¥æŒ‡é’ˆæ‰€åœ¨çš„ä½ç½®å·²ç»å¯ä»¥é‡æ–°åˆ†é…æ–°çš„å¯¹è±¡ï¼Œå¯ä»¥ä¸è¿›è¡Œæ¸…ç†ã€‚ å¤åˆ¶é˜¶æ®µï¼šæŠŠæ‰€æœ‰å­˜æ´»çš„å¯¹è±¡å¤åˆ¶åˆ°Survivor Spacesä¸­çš„æŸä¸€å—ç©ºé—´ä¸­ã€‚ æ ‡è®°-å¤åˆ¶ç®—æ³•å¯ä»¥é¿å…å†…å­˜ç¢ç‰‡åŒ–çš„é—®é¢˜ï¼Œä½†æ˜¯å®ƒçš„ä»£ä»·æ¯”è¾ƒå¤§ï¼Œå› ä¸ºç”¨çš„æ˜¯åŠåŒºå¤åˆ¶å›æ”¶ï¼ŒåŒºåŸŸå¯ç”¨å†…å­˜ä¸ºåŸæ¥çš„ä¸€åŠã€‚ å°ç»“ JVMå’ŒGCæ˜¯Javaå¼€å‘è€…å¿…é¡»æŒæ¡çš„å†…å®¹ï¼ŒåŒ…å«çš„çŸ¥è¯†å…¶å®è¿˜æ˜¯æŒºå¤šçš„ï¼Œæœ¬æ–‡ä¹Ÿåªæ˜¯ç®€å•ä»‹ç»äº†ä¸€äº›åŸºæœ¬æ¦‚å¿µï¼š åˆ†ä»£å‡è¯´ã€‚ Minor GCã€Major GCå’ŒFull GCã€‚ å†…å­˜æ± ç»„æˆã€‚ å¸¸ç”¨çš„GCç®—æ³•ã€‚ åé¢ä¼šåˆ†æä¸€ä¸‹GCæ”¶é›†å™¨æ­é…å’ŒGCæ—¥å¿—æŸ¥çœ‹ã€JVMæä¾›çš„å·¥å…·ç­‰ç­‰ã€‚ å‚è€ƒèµ„æ–™ï¼š ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœº-2ndã€‹ ã€ŠThe Garbage Collection Handbookã€‹ çŸ¥ä¹-RednaxelaFXéƒ¨åˆ†å›ç­” Java Garbage Collection handbook OpenJDK HotSpot VMéƒ¨åˆ†æºç ","categories":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/categories/Java/"},{"name":"JVM","slug":"Java/JVM","permalink":"http://throwable.club/blog/categories/Java/JVM/"}],"tags":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/tags/Java/"},{"name":"JVM","slug":"JVM","permalink":"http://throwable.club/blog/tags/JVM/"}]},{"title":"Hystrixå®Œæ•´é…ç½®åˆ—è¡¨","slug":"framework-hystrix-full-configuration","date":"2019-05-29T03:27:56.000Z","updated":"2019-06-01T17:24:02.008Z","comments":true,"path":"2019/05/29/framework-hystrix-full-configuration/","link":"","permalink":"http://throwable.club/2019/05/29/framework-hystrix-full-configuration/","excerpt":"å‰æ Hystrixåœ¨2018å¹´11æœˆ20æ—¥ä¹‹åå·²ç»åœæ­¢ç»´æŠ¤ï¼Œæœ€åä¸€ä¸ªæäº¤è®°å½•æ˜¯ï¼šLatest commit 3cb2158 on 20 Nov 2018ï¼Œæœ€åä¸€ä¸ªæ­£å¼ç‰ˆæœ¬ä¸º1.5.18ã€‚é‰´äºç›®å‰æ‰€åœ¨å…¬å¸çš„æŠ€æœ¯æ ˆæ˜¯Spring Cloudï¼Œç†”æ–­å’Œé™çº§ç»„ä»¶ä¸»è¦ç”¨çš„è¿˜æ˜¯Hystrixï¼Œè¿™é‡Œå°±Hystrixçš„å®Œæ•´åˆ—è¡¨åšä¸€ä¸ªåˆ†æè®°å½•ï¼Œæ–¹ä¾¿ä»¥åå¯ä»¥éšæ—¶æŸ¥è¯¢ã€‚æœ¬æ–‡ä¸»è¦å‚è€ƒï¼šHystrix Configurationã€‚å…¶ä¸­ï¼Œå‘½ä»¤é…ç½®æ˜¯é’ˆå¯¹HystrixCommandï¼Œä¸»è¦åŒ…æ‹¬å‘½ä»¤æ‰§è¡Œ(execution)é…ç½®ã€å‘½ä»¤é™çº§(fallback)é…ç½®ã€ç†”æ–­å™¨(circuit breaker)é…ç½®ã€åº¦é‡ç»Ÿè®¡(metrics)é…ç½®å’Œè¯·æ±‚ä¸Šä¸‹æ–‡é…ç½®ã€‚","text":"å‰æ Hystrixåœ¨2018å¹´11æœˆ20æ—¥ä¹‹åå·²ç»åœæ­¢ç»´æŠ¤ï¼Œæœ€åä¸€ä¸ªæäº¤è®°å½•æ˜¯ï¼šLatest commit 3cb2158 on 20 Nov 2018ï¼Œæœ€åä¸€ä¸ªæ­£å¼ç‰ˆæœ¬ä¸º1.5.18ã€‚é‰´äºç›®å‰æ‰€åœ¨å…¬å¸çš„æŠ€æœ¯æ ˆæ˜¯Spring Cloudï¼Œç†”æ–­å’Œé™çº§ç»„ä»¶ä¸»è¦ç”¨çš„è¿˜æ˜¯Hystrixï¼Œè¿™é‡Œå°±Hystrixçš„å®Œæ•´åˆ—è¡¨åšä¸€ä¸ªåˆ†æè®°å½•ï¼Œæ–¹ä¾¿ä»¥åå¯ä»¥éšæ—¶æŸ¥è¯¢ã€‚æœ¬æ–‡ä¸»è¦å‚è€ƒï¼šHystrix Configurationã€‚å…¶ä¸­ï¼Œå‘½ä»¤é…ç½®æ˜¯é’ˆå¯¹HystrixCommandï¼Œä¸»è¦åŒ…æ‹¬å‘½ä»¤æ‰§è¡Œ(execution)é…ç½®ã€å‘½ä»¤é™çº§(fallback)é…ç½®ã€ç†”æ–­å™¨(circuit breaker)é…ç½®ã€åº¦é‡ç»Ÿè®¡(metrics)é…ç½®å’Œè¯·æ±‚ä¸Šä¸‹æ–‡é…ç½®ã€‚ HystrixCommandKeyã€HystrixCommandGroupKeyå’ŒHystrixThreadPoolKey HystrixCommandKeyã€HystrixCommandGroupKeyå’ŒHystrixThreadPoolKeyä¸‰ä¸ªKEYæ˜¯HystrixCommandçš„é‡è¦æ ‡è¯†ã€‚ä¸‹é¢åˆ†åˆ«åˆ†æä¸€ä¸‹å®ƒä»¬çš„å«ä¹‰ã€‚ HystrixCommandKey HystrixCommandKeyæ˜¯Hystrixå‘½ä»¤çš„å”¯ä¸€æ ‡è¯†ï¼Œå‡†ç¡®æ¥è¯´æ˜¯HystrixCommandå®ä¾‹æˆ–è€…HystrixObservableCommandå®ä¾‹çš„å”¯ä¸€æ ‡è¯†ã€‚å®ƒæ˜¯å¿…é¡»çš„ï¼Œå¦‚æœä¸è‡ªå®šä¹‰é…ç½®ï¼Œå®ƒä¼šé€šè¿‡ä¸‹é¢æ–¹å¼ç¡®å®šé»˜è®¤å€¼ï¼š 1[HystrixCommandæˆ–è€…HystrixObservableCommandçš„å…·ä½“å­ç±»].getClass().getSimpleName(); ç¼–ç¨‹å¼é…ç½®å¦‚ä¸‹ï¼š 1234567HystrixCommandKey.Factory.asKey(\"Your Key\");public Command() &#123; super(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(\"Group Key\")) .andCommandKey(HystrixCommandKey.Factory.asKey(\"Command Key\")));&#125; æ³¨æ„ä¸€ç‚¹ï¼šå¤§éƒ¨åˆ†Hystrixçš„é…ç½®éƒ½æ˜¯å’ŒHystrixCommandKeyç»‘å®šï¼Œæ‰€ä»¥HystrixCommandKeyæ˜¯æ¯”è¾ƒé‡è¦çš„ã€‚ HystrixCommandGroupKey HystrixCommandGroupKeyæ˜¯ç”¨äºå¯¹Hystrixå‘½ä»¤è¿›è¡Œåˆ†ç»„ï¼Œåˆ†ç»„ä¹‹åä¾¿äºç»Ÿè®¡å±•ç¤ºäºä»ªè¡¨ç›˜ã€ä¸Šä¼ æŠ¥å‘Šå’Œé¢„è­¦ç­‰ç­‰ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒHystrixCommandGroupKeyæ˜¯Hystrixå†…éƒ¨è¿›è¡Œåº¦é‡ç»Ÿè®¡æ—¶å€™çš„åˆ†ç»„æ ‡è¯†ï¼Œæ•°æ®ä¸ŠæŠ¥å’Œç»Ÿè®¡çš„æœ€å°ç»´åº¦å°±æ˜¯åˆ†ç»„çš„KEYã€‚HystrixCommandGroupKeyæ˜¯å¿…é¡»é…ç½®çš„ï¼Œé…ç½®æ–¹å¼å¦‚ä¸‹ï¼š 12345HystrixCommandGroupKey.Factory.asKey(\"Group Key\")public Command() &#123; super(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(\"Group Key\")));&#125; HystrixThreadPoolKey HystrixThreadPoolKeyä¸»è¦æ ‡è¯†ç”¨äºç›‘æ§ã€åº¦é‡å’Œç¼“å­˜ç­‰ç­‰ä½œç”¨çš„HystrixThreadPoolå®ä¾‹ã€‚ä¸€ä¸ªHystrixCommandä¼šå’Œä¸€ä¸ªç‹¬ç«‹çš„HystrixThreadPoolå®ä¾‹å…³è”ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€ç±»HystrixCommandæ€»æ˜¯åœ¨åŒä¸€ä¸ªHystrixThreadPoolå®ä¾‹ä¸­æ‰§è¡Œã€‚å¦‚æœä¸æ˜¾å¼é…ç½®HystrixThreadPoolKeyï¼Œé‚£ä¹ˆä¼šä½¿ç”¨HystrixCommandGroupKeyçš„å€¼å»é…ç½®HystrixThreadPoolKeyã€‚HystrixThreadPoolKeyçš„é…ç½®æ–¹å¼å¦‚ä¸‹ï¼š 1234567HystrixThreadPoolKey.Factory.asKey(\"ThreadPoolKey\")public Command() &#123; super(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(\"xxx\")) .andCommandKey(HystrixCommandKey.Factory.asKey(\"YYY\")) .andThreadPoolKey(HystrixThreadPoolKey.Factory.asKey(\"ThreadPoolKey\")));&#125; å‘½ä»¤æ‰§è¡Œ(execution)é…ç½® éš”ç¦»ç­–ç•¥ execution.isolation.strategy éš”ç¦»ç­–ç•¥å†³å®šHystrixå‘½ä»¤æ‰§è¡Œçš„æ—¶å€™é‡‡ç”¨ä»€ä¹ˆç±»å‹çš„ç­–ç•¥è¿›è¡Œä¾èµ–éš”ç¦»ã€‚ é¡¹ å€¼ é»˜è®¤å€¼ THREAD (è§ExecutionIsolationStrategy.THREAD) å¯é€‰å€¼ THREAD,SEMAPHORE é»˜è®¤å…¨å±€é…ç½® hystrix.command.default.execution.isolation.strategy å®ä¾‹é…ç½® hystrix.command.[HystrixCommandKey].execution.isolation.strategy æ‰§è¡Œéš”ç¦»ç­–ç•¥åˆ°åº•é€‰æ‹©çº¿ç¨‹æ± (THREAD)è¿˜æ˜¯ä¿¡å·é‡(SEMAPHORE)ï¼Ÿæ–‡æ¡£ä¸­ç»™å‡ºçš„å»ºè®®æ˜¯ï¼š ä½¿ç”¨HystrixCommandçš„æ—¶å€™å»ºè®®ç”¨THREADç­–ç•¥ï¼Œä½¿ç”¨HystrixObservableCommandçš„æ—¶å€™å»ºè®®ä½¿ç”¨SEMAPHOREç­–ç•¥ã€‚ ä½¿ç”¨THREADç­–ç•¥è®©HystrixCommandåœ¨çº¿ç¨‹ä¸­æ‰§è¡Œå¯ä»¥æä¾›é¢å¤–çš„ä¿æŠ¤å±‚ï¼Œä»¥é˜²æ­¢å› ä¸ºç½‘ç»œè¶…æ—¶å¯¼è‡´çš„å»¶æ—¶å¤±è´¥ã€‚ ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåªæœ‰è¿™ç§ç‰¹æ®Šä¾‹å­ä¸‹HystrixCommandä¼šæ­é…SEMAPHOREç­–ç•¥ä½¿ç”¨ï¼šè°ƒç”¨çš„é¢‘æ¬¡å¤ªé«˜(ä¾‹å¦‚æ¯ä¸ªå®ä¾‹æ¯ç§’æ•°ç™¾æ¬¡è°ƒç”¨)ï¼Œè¿™ç§æƒ…å†µå¦‚æœé€‰ç”¨THREADç­–ç•¥æœ‰å¯èƒ½å¯¼è‡´è¶…è¿‡çº¿ç¨‹éš”ç¦»çš„ä¸Šé™(æœ‰å¯èƒ½éœ€è¦å¤ªå¤šçš„çº¿ç¨‹æˆ–è€…å‘½ä»¤å¤ªå¤šçº¿ç¨‹ä¸è¶³å¤Ÿç”¨äºéš”ç¦»è¯·æ±‚)ï¼Œè¿™ç§æƒ…å†µä¸€èˆ¬æ˜¯éç½‘ç»œè¯·æ±‚è°ƒç”¨ã€‚ ç¬”è€…æƒ³è¯´çš„æ˜¯ï¼šå»ºè®®é€‰ç”¨é»˜è®¤å€¼ï¼Œå› ä¸ºç›®å‰å¾ˆå°‘é‡åˆ°ä½¿ç”¨ä¿¡å·é‡éš”ç¦»çš„åœºæ™¯ã€‚ ç¼–ç¨‹å¼é…ç½®ï¼š 12345678910111213public class CustomCommand extends HystrixCommand&lt;String&gt; &#123; public CustomCommand() &#123; super(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(\"CustomCommand\")) .andCommandPropertiesDefaults(HystrixCommandProperties.Setter() .withExecutionIsolationStrategy(HystrixCommandProperties.ExecutionIsolationStrategy.THREAD))); &#125; @Override protected String run() throws Exception &#123; return null; &#125;&#125; é…ç½®æ–‡ä»¶ä¸­(Properties)é…ç½®ï¼š 1234567# ä¸‹é¢é…ç½®äºŒé€‰ä¸€# é»˜è®¤å…¨å±€é…ç½®hystrix.command.default.execution.isolation.strategy=THREAD# å®ä¾‹é…ç½®hystrix.command.CustomCommand.execution.isolation.strategy=THREAD æ˜¯å¦å…è®¸è¶…æ—¶ execution.timeout.enabled å†³å®šHystrixCommand#run()æ‰§è¡Œæ—¶æ˜¯å¦å…è®¸è¶…æ—¶ï¼Œåªæœ‰è®¾ç½®ä¸ºtrueçš„æ—¶å€™ï¼Œä¸‹é¢æåˆ°çš„â€œè¶…æ—¶æ—¶é—´ä¸Šé™â€æ‰ä¼šæœ‰æ•ˆã€‚ é¡¹ å€¼ é»˜è®¤å€¼ true å¯é€‰å€¼ true,false é»˜è®¤å…¨å±€é…ç½® hystrix.command.default.execution.timeout.enabled å®ä¾‹é…ç½® hystrix.command.[HystrixCommandKey].execution.timeout.enabled å»ºè®®(ç¬”è€…å¤‡æ³¨) ä¿æŒé€‰ç”¨é»˜è®¤å€¼ ç¼–ç¨‹å¼é…ç½®ï¼š 12345678910111213public class CustomCommand extends HystrixCommand&lt;String&gt; &#123; public CustomCommand() &#123; super(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(\"CustomCommand\")) .andCommandPropertiesDefaults(HystrixCommandProperties.Setter() .withExecutionTimeoutEnabled(true))); &#125; @Override protected String run() throws Exception &#123; return null; &#125;&#125; é…ç½®æ–‡ä»¶ä¸­(Properties)é…ç½®ï¼š 1234567# ä¸‹é¢é…ç½®äºŒé€‰ä¸€# é»˜è®¤å…¨å±€é…ç½®hystrix.command.default.execution.timeout.enabled=true# å®ä¾‹é…ç½®hystrix.command.CustomCommand.execution.timeout.enabled=true è¶…æ—¶æ—¶é—´ä¸Šé™ execution.isolation.thread.timeoutInMilliseconds HystrixCommandæ‰§è¡Œæ—¶å€™è¶…æ—¶çš„æœ€å¤§ä¸Šé™ï¼Œå•ä½æ˜¯æ¯«ç§’ï¼Œå¦‚æœå‘½ä»¤æ‰§è¡Œè€—æ—¶è¶…è¿‡æ­¤æ—¶é—´å€¼é‚£ä¹ˆä¼šè¿›å…¥é™çº§é€»è¾‘ã€‚è¿™ä¸ªé…ç½®ç”Ÿæ•ˆçš„å‰ææ˜¯hystrix.command.default.execution.timeout.enabledæˆ–è€…hystrix.command.[HystrixCommandKey].execution.timeout.enabledä¸ºtrueã€‚ é¡¹ å€¼ é»˜è®¤å€¼ 1000 å¯é€‰å€¼ - é»˜è®¤å…¨å±€é…ç½® hystrix.command.default.execution.isolation.thread.timeoutInMilliseconds å®ä¾‹é…ç½® hystrix.command.[HystrixCommandKey].execution.isolation.thread.timeoutInMilliseconds å»ºè®®(ç¬”è€…å¤‡æ³¨) ä¿æŒé€‰ç”¨é»˜è®¤å€¼ ç¼–ç¨‹å¼é…ç½®ï¼š 12345678910111213public class CustomCommand extends HystrixCommand&lt;String&gt; &#123; public CustomCommand() &#123; super(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(\"CustomCommand\")) .andCommandPropertiesDefaults(HystrixCommandProperties.Setter() .withExecutionTimeoutInMilliseconds(1000))); &#125; @Override protected String run() throws Exception &#123; return null; &#125;&#125; é…ç½®æ–‡ä»¶ä¸­(Properties)é…ç½®ï¼š 1234567# ä¸‹é¢é…ç½®äºŒé€‰ä¸€# é»˜è®¤å…¨å±€é…ç½®hystrix.command.default.execution.isolation.thread.timeoutInMilliseconds=1000# å®ä¾‹é…ç½®hystrix.command.CustomCommand.execution.isolation.thread.timeoutInMilliseconds=1000 è¶…æ—¶æ˜¯å¦ä¸­æ–­ æ­¤é…ç½®é¡¹å†³å®šHystrixCommand#run()æ‰§è¡Œçš„æ—¶å€™è°ƒç”¨è¶…æ—¶çš„æƒ…å†µä¸‹æ˜¯å¦ä¸­æ–­ã€‚ é¡¹ å€¼ é»˜è®¤å€¼ true å¯é€‰å€¼ trueã€false é»˜è®¤å…¨å±€é…ç½® hystrix.command.default.execution.isolation.thread.interruptOnTimeout å®ä¾‹é…ç½® hystrix.command.[HystrixCommandKey].execution.isolation.thread.interruptOnTimeout å»ºè®®(ç¬”è€…å¤‡æ³¨) ä¿æŒé€‰ç”¨é»˜è®¤å€¼ ç¼–ç¨‹å¼é…ç½®ï¼š 12345678910111213public class CustomCommand extends HystrixCommand&lt;String&gt; &#123; public CustomCommand() &#123; super(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(\"CustomCommand\")) .andCommandPropertiesDefaults(HystrixCommandProperties.Setter() .withExecutionIsolationThreadInterruptOnTimeout(true))); &#125; @Override protected String run() throws Exception &#123; return null; &#125;&#125; é…ç½®æ–‡ä»¶ä¸­(Properties)é…ç½®ï¼š 1234567# ä¸‹é¢é…ç½®äºŒé€‰ä¸€# é»˜è®¤å…¨å±€é…ç½®hystrix.command.default.execution.isolation.thread.interruptOnTimeout=true# å®ä¾‹é…ç½®hystrix.command.CustomCommand.execution.isolation.thread.interruptOnTimeout=true å–æ¶ˆæ˜¯å¦ä¸­æ–­ execution.isolation.thread.interruptOnCancel æ­¤é…ç½®é¡¹å†³å®šHystrixCommand#run()æ‰§è¡Œçš„æ—¶å€™å–æ¶ˆè°ƒç”¨çš„æƒ…å†µä¸‹æ˜¯å¦ä¸­æ–­ã€‚ é¡¹ å€¼ é»˜è®¤å€¼ false å¯é€‰å€¼ trueã€false é»˜è®¤å…¨å±€é…ç½® hystrix.command.default.execution.isolation.thread.interruptOnCancel å®ä¾‹é…ç½® hystrix.command.[HystrixCommandKey].execution.isolation.thread.interruptOnCancel å»ºè®®(ç¬”è€…å¤‡æ³¨) ä¿æŒé€‰ç”¨é»˜è®¤å€¼ ç¼–ç¨‹å¼é…ç½®ï¼š 12345678910111213public class CustomCommand extends HystrixCommand&lt;String&gt; &#123; public CustomCommand() &#123; super(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(\"CustomCommand\")) .andCommandPropertiesDefaults(HystrixCommandProperties.Setter() .withExecutionIsolationThreadInterruptOnFutureCancel(false))); &#125; @Override protected String run() throws Exception &#123; return null; &#125;&#125; é…ç½®æ–‡ä»¶ä¸­(Properties)é…ç½®ï¼š 1234567# ä¸‹é¢é…ç½®äºŒé€‰ä¸€# é»˜è®¤å…¨å±€é…ç½®hystrix.command.default.execution.isolation.thread.interruptOnCancel=false# å®ä¾‹é…ç½®hystrix.command.CustomCommand.execution.isolation.thread.interruptOnCancel=false æœ€å¤§å¹¶å‘è¯·æ±‚ä¸Šé™(SEMAPHORE) execution.isolation.semaphore.maxConcurrentRequests æ­¤é…ç½®é¡¹å†³å®šä½¿ç”¨HystrixCommand#run()æ–¹æ³•å’ŒExecutionIsolationStrategy.SEMAPHOREéš”ç¦»ç­–ç•¥ä¸‹å¹¶å‘è¯·æ±‚æ•°é‡çš„æœ€é«˜ä¸Šé™ã€‚ é¡¹ å€¼ é»˜è®¤å€¼ 10 å¯é€‰å€¼ - é»˜è®¤å…¨å±€é…ç½® hystrix.command.default.execution.isolation.semaphore.maxConcurrentRequests å®ä¾‹é…ç½® hystrix.command.[HystrixCommandKey].execution.isolation.semaphore.maxConcurrentRequests å»ºè®®(ç¬”è€…å¤‡æ³¨) å¿…é¡»æ ¹æ®å®é™…æƒ…å†µè®¾å®šæ­¤å€¼ ç¼–ç¨‹å¼é…ç½®ï¼š 1234567891011121314public class CustomCommand extends HystrixCommand&lt;String&gt; &#123; public CustomCommand() &#123; super(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(\"CustomCommand\")) .andCommandPropertiesDefaults(HystrixCommandProperties.Setter() .withExecutionIsolationStrategy(HystrixCommandProperties.ExecutionIsolationStrategy.SEMAPHORE) .withExecutionIsolationSemaphoreMaxConcurrentRequests(100))); &#125; @Override protected String run() throws Exception &#123; return null; &#125;&#125; é…ç½®æ–‡ä»¶ä¸­(Properties)é…ç½®ï¼š 1234567# ä¸‹é¢é…ç½®äºŒé€‰ä¸€# é»˜è®¤å…¨å±€é…ç½®hystrix.command.default.execution.isolation.semaphore.maxConcurrentRequests=100# å®ä¾‹é…ç½®hystrix.command.CustomCommand.execution.isolation.semaphore.maxConcurrentRequests=100 å‘½ä»¤é™çº§(fallback)é…ç½® å‘½ä»¤é™çº§é…ç½®æ§åˆ¶HystrixCommand#getFallback()çš„æ‰§è¡Œé€»è¾‘ï¼Œæ‰€æœ‰å‘½ä»¤é™çº§é…ç½®å¯¹ç­–ç•¥ExecutionIsolationStrategy.THREADæˆ–è€…ExecutionIsolationStrategy.SEMAPHOREéƒ½ç”Ÿæ•ˆã€‚ æœ€å¤§å¹¶å‘é™çº§è¯·æ±‚å¤„ç†ä¸Šé™ fallback.isolation.semaphore.maxConcurrentRequests è¿™ä¸ªå±æ€§ç”¨äºæ§åˆ¶ä¸€ä¸ªHystrixCommand#getFallback()å®ä¾‹æ–¹æ³•åœ¨æ‰§è¡Œçº¿ç¨‹ä¸­è°ƒç”¨çš„æœ€å¤§ä¸Šé™ï¼Œå¦‚æœè¶…è¿‡æ­¤ä¸Šé™ï¼Œé™çº§é€»è¾‘ä¸ä¼šæ‰§è¡Œå¹¶ä¸”ä¼šæŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ã€‚ é¡¹ å€¼ é»˜è®¤å€¼ 10 å¯é€‰å€¼ - é»˜è®¤å…¨å±€é…ç½® hystrix.command.default.fallback.isolation.semaphore.maxConcurrentRequests å®ä¾‹é…ç½® hystrix.command.[HystrixCommandKey].fallback.isolation.semaphore.maxConcurrentRequests å»ºè®®(ç¬”è€…å¤‡æ³¨) å¿…é¡»æ ¹æ®å®é™…æƒ…å†µè®¾å®šæ­¤å€¼ ç¼–ç¨‹å¼é…ç½®ï¼š 12345678910111213public class CustomCommand extends HystrixCommand&lt;String&gt; &#123; public CustomCommand() &#123; super(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(\"CustomCommand\")) .andCommandPropertiesDefaults(HystrixCommandProperties.Setter() .withFallbackIsolationSemaphoreMaxConcurrentRequests(20))); &#125; @Override protected String run() throws Exception &#123; return null; &#125;&#125; é…ç½®æ–‡ä»¶ä¸­(Properties)é…ç½®ï¼š 1234567# ä¸‹é¢é…ç½®äºŒé€‰ä¸€# é»˜è®¤å…¨å±€é…ç½®hystrix.command.default.fallback.isolation.semaphore.maxConcurrentRequests=20# å®ä¾‹é…ç½®hystrix.command.CustomCommand.fallback.isolation.semaphore.maxConcurrentRequests=20 æ˜¯å¦å¼€å¯é™çº§ fallback.enabled æ­¤å±æ€§æ§åˆ¶å½“HystrixCommandæ‰§è¡Œå¤±è´¥ä¹‹åæ˜¯å¦è°ƒç”¨HystrixCommand#getFallback()ã€‚ é¡¹ å€¼ é»˜è®¤å€¼ true å¯é€‰å€¼ falseã€true é»˜è®¤å…¨å±€é…ç½® hystrix.command.default.fallback.enabled å®ä¾‹é…ç½® hystrix.command.[HystrixCommandKey].fallback.enabled å»ºè®®(ç¬”è€…å¤‡æ³¨) å»ºè®®ä¿æŒé»˜è®¤å€¼ ç¼–ç¨‹å¼é…ç½®ï¼š 12345678910111213public class CustomCommand extends HystrixCommand&lt;String&gt; &#123; public CustomCommand() &#123; super(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(\"CustomCommand\")) .andCommandPropertiesDefaults(HystrixCommandProperties.Setter() .withFallbackEnabled(true))); &#125; @Override protected String run() throws Exception &#123; return null; &#125;&#125; é…ç½®æ–‡ä»¶ä¸­(Properties)é…ç½®ï¼š 1234567# ä¸‹é¢é…ç½®äºŒé€‰ä¸€# é»˜è®¤å…¨å±€é…ç½®hystrix.command.default.fallback.enabled=true# å®ä¾‹é…ç½®hystrix.command.CustomCommand.fallback.enabled=true æ–­è·¯å™¨(circuit breaker)é…ç½® æ–­è·¯å™¨é…ç½®ç”¨äºæ§åˆ¶HystrixCircuitBreakerå®ä¾‹çš„è¡Œä¸ºã€‚ æ˜¯å¦å¯ç”¨æ–­è·¯å™¨ circuitBreaker.enabled æ­¤å±æ€§ç¡®å®šæ–­è·¯å™¨æ˜¯å¦ç”¨äºè·Ÿè¸ªå¥åº·çŠ¶å†µï¼Œä»¥åŠå½“æ–­è·¯å™¨æ‰“å¼€çš„æ—¶å€™æ˜¯å¦ç”¨äºçŸ­è·¯è¯·æ±‚(ä½¿è¯·æ±‚å¿«é€Ÿå¤±è´¥è¿›å…¥é™çº§é€»è¾‘)ã€‚ é¡¹ å€¼ é»˜è®¤å€¼ true å¯é€‰å€¼ falseã€true é»˜è®¤å…¨å±€é…ç½® hystrix.command.default.circuitBreaker.enabled å®ä¾‹é…ç½® hystrix.command.[HystrixCommandKey].circuitBreaker.enabled å»ºè®®(ç¬”è€…å¤‡æ³¨) å»ºè®®ä¿æŒé»˜è®¤å€¼ ç¼–ç¨‹å¼é…ç½®ï¼š 12345678910111213public class CustomCommand extends HystrixCommand&lt;String&gt; &#123; public CustomCommand() &#123; super(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(\"CustomCommand\")) .andCommandPropertiesDefaults(HystrixCommandProperties.Setter() .withCircuitBreakerEnabled(true))); &#125; @Override protected String run() throws Exception &#123; return null; &#125;&#125; é…ç½®æ–‡ä»¶ä¸­(Properties)é…ç½®ï¼š 1234567# ä¸‹é¢é…ç½®äºŒé€‰ä¸€# é»˜è®¤å…¨å±€é…ç½®hystrix.command.default.circuitBreaker.enabled=true# å®ä¾‹é…ç½®hystrix.command.CustomCommand.circuitBreaker.enabled=true æ–­è·¯å™¨è¯·æ±‚é‡é˜ˆå€¼ circuitBreaker.requestVolumeThreshold æ­¤å±æ€§è®¾ç½®å°†ä½¿æ–­è·¯å™¨æ‰“å¼€çš„æ»‘åŠ¨çª—å£ä¸­çš„æœ€å°è¯·æ±‚æ•°é‡ã€‚ ä¾‹å¦‚ï¼Œå¦‚æœå€¼æ˜¯20ï¼Œé‚£ä¹ˆå¦‚æœåœ¨æ»‘åŠ¨çª—å£ä¸­åªæ¥æ”¶åˆ°19ä¸ªè¯·æ±‚(æ¯”å¦‚ä¸€ä¸ª10ç§’çš„çª—å£)ï¼Œå³ä½¿æ‰€æœ‰19ä¸ªè¯·æ±‚éƒ½å¤±è´¥äº†ï¼Œæ–­è·¯å™¨ä¹Ÿä¸ä¼šæ‰“å¼€ã€‚ é¡¹ å€¼ é»˜è®¤å€¼ 20 å¯é€‰å€¼ - é»˜è®¤å…¨å±€é…ç½® hystrix.command.default.circuitBreaker.requestVolumeThreshold å®ä¾‹é…ç½® hystrix.command.[HystrixCommandKey].circuitBreaker.requestVolumeThreshold å»ºè®®(ç¬”è€…å¤‡æ³¨) å»ºè®®ä¿æŒé»˜è®¤å€¼ï¼Œå¦‚æœéƒ¨åˆ†æ¥å£ä¸èƒ½å®¹å¿é»˜è®¤é˜ˆå€¼å¯ä»¥å•ç‹¬é…ç½® ç¼–ç¨‹å¼é…ç½®ï¼š 12345678910111213public class CustomCommand extends HystrixCommand&lt;String&gt; &#123; public CustomCommand() &#123; super(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(\"CustomCommand\")) .andCommandPropertiesDefaults(HystrixCommandProperties.Setter() .withCircuitBreakerRequestVolumeThreshold(10))); &#125; @Override protected String run() throws Exception &#123; return null; &#125;&#125; é…ç½®æ–‡ä»¶ä¸­(Properties)é…ç½®ï¼š 1234567# ä¸‹é¢é…ç½®äºŒé€‰ä¸€# é»˜è®¤å…¨å±€é…ç½®hystrix.command.default.circuitBreaker.requestVolumeThreshold=10# å®ä¾‹é…ç½®hystrix.command.CustomCommand.circuitBreaker.requestVolumeThreshold=10 æ–­è·¯å™¨ç­‰å¾…çª—å£æ—¶é—´ circuitBreaker.sleepWindowInMilliseconds æ­¤å±æ€§è®¾ç½®æ–­è·¯å™¨æ‰“å¼€åæ‹’ç»è¯·æ±‚çš„æ—¶é—´é‡ï¼Œæ¯éš”ä¸€æ®µæ—¶é—´(sleepWindowInMillisecondsï¼Œå•ä½æ˜¯æ¯«ç§’)å…è®¸å†æ¬¡å°è¯•(ä¹Ÿå°±æ˜¯æ”¾è¡Œä¸€ä¸ªè¯·æ±‚)ç¡®å®šæ˜¯å¦åº”è¯¥å…³é—­æ–­è·¯å™¨ã€‚ é¡¹ å€¼ é»˜è®¤å€¼ 5000 å¯é€‰å€¼ - é»˜è®¤å…¨å±€é…ç½® hystrix.command.default.circuitBreaker.sleepWindowInMilliseconds å®ä¾‹é…ç½® hystrix.command.[HystrixCommandKey].circuitBreaker.sleepWindowInMilliseconds å»ºè®®(ç¬”è€…å¤‡æ³¨) å»ºè®®ä¿æŒé»˜è®¤å€¼ ç¼–ç¨‹å¼é…ç½®ï¼š 12345678910111213public class CustomCommand extends HystrixCommand&lt;String&gt; &#123; public CustomCommand() &#123; super(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(\"CustomCommand\")) .andCommandPropertiesDefaults(HystrixCommandProperties.Setter() .withCircuitBreakerSleepWindowInMilliseconds(5000))); &#125; @Override protected String run() throws Exception &#123; return null; &#125;&#125; é…ç½®æ–‡ä»¶ä¸­(Properties)é…ç½®ï¼š 1234567# ä¸‹é¢é…ç½®äºŒé€‰ä¸€# é»˜è®¤å…¨å±€é…ç½®hystrix.command.default.circuitBreaker.sleepWindowInMilliseconds=5000# å®ä¾‹é…ç½®hystrix.command.CustomCommand.circuitBreaker.sleepWindowInMilliseconds=5000 æ–­è·¯å™¨é”™è¯¯ç™¾åˆ†æ¯”é˜ˆå€¼ circuitBreaker.errorThresholdPercentage æ­¤å±æ€§è®¾ç½®ä¸€ä¸ªé”™è¯¯ç™¾åˆ†æ¯”ï¼Œå½“è¯·æ±‚é”™è¯¯ç‡è¶…è¿‡è®¾å®šå€¼ï¼Œæ–­è·¯å™¨å°±ä¼šæ‰“å¼€ã€‚ é¡¹ å€¼ é»˜è®¤å€¼ 50 å¯é€‰å€¼ - é»˜è®¤å…¨å±€é…ç½® hystrix.command.default.circuitBreaker.errorThresholdPercentage å®ä¾‹é…ç½® hystrix.command.[HystrixCommandKey].circuitBreaker.errorThresholdPercentage å»ºè®®(ç¬”è€…å¤‡æ³¨) å»ºè®®ä¿æŒé»˜è®¤å€¼ ç¼–ç¨‹å¼é…ç½®ï¼š 12345678910111213public class CustomCommand extends HystrixCommand&lt;String&gt; &#123; public CustomCommand() &#123; super(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(\"CustomCommand\")) .andCommandPropertiesDefaults(HystrixCommandProperties.Setter() .withCircuitBreakerErrorThresholdPercentage(50))); &#125; @Override protected String run() throws Exception &#123; return null; &#125;&#125; é…ç½®æ–‡ä»¶ä¸­(Properties)é…ç½®ï¼š 1234567# ä¸‹é¢é…ç½®äºŒé€‰ä¸€# é»˜è®¤å…¨å±€é…ç½®hystrix.command.default.circuitBreaker.errorThresholdPercentage=50# å®ä¾‹é…ç½®hystrix.command.CustomCommand.circuitBreaker.errorThresholdPercentage=50 æ³¨æ„ï¼š é…ç½®é¡¹circuitBreaker.requestVolumeThresholdé’ˆå¯¹é”™è¯¯è¯·æ±‚æ•°é‡ã€‚ é…ç½®é¡¹circuitBreaker.errorThresholdPercentageé’ˆå¯¹é”™è¯¯è¯·æ±‚ç™¾åˆ†æ¯”ã€‚ æ˜¯å¦å¼ºåˆ¶æ‰“å¼€æ–­è·¯å™¨ circuitBreaker.forceOpen æ­¤å±æ€§æ§åˆ¶æ–­è·¯å™¨æ˜¯å¦å¼ºåˆ¶æ‰“å¼€ï¼Œå¼ºåˆ¶æ‰“å¼€æ–­è·¯å™¨ä¼šä½¿æ‰€æœ‰è¯·æ±‚ç›´æ¥è¿›å…¥é™çº§é€»è¾‘ï¼Œä¹Ÿå°±æ˜¯åŒ…è£¹åœ¨HystrixCommand#run()çš„é€»è¾‘ä¸ä¼šæ‰§è¡Œã€‚circuitBreaker.forceOpenå±æ€§å’ŒcircuitBreaker.forceClosedå±æ€§äº’æ–¥ã€‚ é¡¹ å€¼ é»˜è®¤å€¼ false å¯é€‰å€¼ falseã€true é»˜è®¤å…¨å±€é…ç½® hystrix.command.default.circuitBreaker.forceOpen å®ä¾‹é…ç½® hystrix.command.[HystrixCommandKey].circuitBreaker.forceOpen å»ºè®®(ç¬”è€…å¤‡æ³¨) å»ºè®®ä¿æŒé»˜è®¤å€¼ ç¼–ç¨‹å¼é…ç½®ï¼š 12345678910111213public class CustomCommand extends HystrixCommand&lt;String&gt; &#123; public CustomCommand() &#123; super(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(\"CustomCommand\")) .andCommandPropertiesDefaults(HystrixCommandProperties.Setter() .withCircuitBreakerForceOpen(true))); &#125; @Override protected String run() throws Exception &#123; return null; &#125;&#125; é…ç½®æ–‡ä»¶ä¸­(Properties)é…ç½®ï¼š 1234567# ä¸‹é¢é…ç½®äºŒé€‰ä¸€# é»˜è®¤å…¨å±€é…ç½®hystrix.command.default.circuitBreaker.forceOpen=true# å®ä¾‹é…ç½®hystrix.command.CustomCommand.circuitBreaker.forceOpen=true æ˜¯å¦å¼ºåˆ¶å…³é—­æ–­è·¯å™¨ circuitBreaker.forceClosed æ­¤å±æ€§æ§åˆ¶æ–­è·¯å™¨æ˜¯å¦å¼ºåˆ¶å…³é—­ï¼Œå¼ºåˆ¶å…³é—­æ–­è·¯å™¨ä¼šå¯¼è‡´æ‰€æœ‰å’Œæ–­è·¯å™¨ç›¸å…³çš„é…ç½®å’ŒåŠŸèƒ½éƒ½å¤±æ•ˆï¼ŒHystrixCommand#run()æŠ›å‡ºå¼‚å¸¸ä¼šæ­£å¸¸è¿›å…¥é™çº§é€»è¾‘ã€‚circuitBreaker.forceClosedå±æ€§å’ŒcircuitBreaker.forceOpenå±æ€§äº’æ–¥ã€‚ é¡¹ å€¼ é»˜è®¤å€¼ false å¯é€‰å€¼ falseã€true é»˜è®¤å…¨å±€é…ç½® hystrix.command.default.circuitBreaker.forceClosed å®ä¾‹é…ç½® hystrix.command.[HystrixCommandKey].circuitBreaker.forceClosed å»ºè®®(ç¬”è€…å¤‡æ³¨) å»ºè®®ä¿æŒé»˜è®¤å€¼ ç¼–ç¨‹å¼é…ç½®ï¼š 12345678910111213public class CustomCommand extends HystrixCommand&lt;String&gt; &#123; public CustomCommand() &#123; super(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(\"CustomCommand\")) .andCommandPropertiesDefaults(HystrixCommandProperties.Setter() .withCircuitBreakerForceClosed(true))); &#125; @Override protected String run() throws Exception &#123; return null; &#125;&#125; é…ç½®æ–‡ä»¶ä¸­(Properties)é…ç½®ï¼š 1234567# ä¸‹é¢é…ç½®äºŒé€‰ä¸€# é»˜è®¤å…¨å±€é…ç½®hystrix.command.default.circuitBreaker.forceClosed=true# å®ä¾‹é…ç½®hystrix.command.CustomCommand.circuitBreaker.forceClosed=true åº¦é‡ç»Ÿè®¡(metrics)é…ç½® åº¦é‡ç»Ÿè®¡é…ç½®ä¼šå¯¹HystrixCommandæˆ–è€…HystrixObservableCommandæ‰§è¡Œæ—¶å€™çš„ç»Ÿè®¡æ•°æ®æ”¶é›†åŠ¨ä½œç”Ÿæ•ˆã€‚ æ»‘åŠ¨çª—å£æŒç»­æ—¶é—´ metrics.rollingStats.timeInMilliseconds é¡¹ å€¼ é»˜è®¤å€¼ 10000 å¯é€‰å€¼ - é»˜è®¤å…¨å±€é…ç½® hystrix.command.default.metrics.rollingStats.timeInMilliseconds å®ä¾‹é…ç½® hystrix.command.[HystrixCommandKey].metrics.rollingStats.timeInMilliseconds å»ºè®®(ç¬”è€…å¤‡æ³¨) å»ºè®®ä¿æŒé»˜è®¤å€¼ ç¼–ç¨‹å¼é…ç½®ï¼š 12345678910111213public class CustomCommand extends HystrixCommand&lt;String&gt; &#123; public CustomCommand() &#123; super(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(\"CustomCommand\")) .andCommandPropertiesDefaults(HystrixCommandProperties.Setter() .withMetricsRollingStatisticalWindowInMilliseconds(10000))); &#125; @Override protected String run() throws Exception &#123; return null; &#125;&#125; é…ç½®æ–‡ä»¶ä¸­(Properties)é…ç½®ï¼š 1234567# ä¸‹é¢é…ç½®äºŒé€‰ä¸€# é»˜è®¤å…¨å±€é…ç½®hystrix.command.default.metrics.rollingStats.timeInMilliseconds=10000# å®ä¾‹é…ç½®hystrix.command.CustomCommand.metrics.rollingStats.timeInMilliseconds=10000 æ»‘åŠ¨çª—å£Bucketæ€»æ•° metrics.rollingStats.numBuckets é¡¹ å€¼ é»˜è®¤å€¼ 10 å¯é€‰å€¼ éœ€è¦æ»¡è¶³metrics.rollingStats.timeInMilliseconds % metrics.rollingStats.numBuckets == 0ï¼Œè¦å°½é‡å°ï¼Œå¦åˆ™æœ‰å¯èƒ½å½±å“æ€§èƒ½ é»˜è®¤å…¨å±€é…ç½® hystrix.command.default.metrics.rollingStats.numBuckets å®ä¾‹é…ç½® hystrix.command.[HystrixCommandKey].metrics.rollingStats.numBuckets å»ºè®®(ç¬”è€…å¤‡æ³¨) å»ºè®®ä¿æŒé»˜è®¤å€¼ ç¼–ç¨‹å¼é…ç½®ï¼š 12345678910111213public class CustomCommand extends HystrixCommand&lt;String&gt; &#123; public CustomCommand() &#123; super(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(\"CustomCommand\")) .andCommandPropertiesDefaults(HystrixCommandProperties.Setter() .withMetricsRollingStatisticalWindowBuckets(100))); &#125; @Override protected String run() throws Exception &#123; return null; &#125;&#125; é…ç½®æ–‡ä»¶ä¸­(Properties)é…ç½®ï¼š 1234567# ä¸‹é¢é…ç½®äºŒé€‰ä¸€# é»˜è®¤å…¨å±€é…ç½®hystrix.command.default.metrics.rollingStats.numBuckets=10# å®ä¾‹é…ç½®hystrix.command.CustomCommand.metrics.rollingStats.numBuckets=10 æ˜¯å¦å¯ç”¨ç™¾åˆ†æ•°è®¡ç®— metrics.rollingPercentile.enabled é¡¹ å€¼ é»˜è®¤å€¼ true å¯é€‰å€¼ trueã€false é»˜è®¤å…¨å±€é…ç½® hystrix.command.default.metrics.rollingPercentile.enabled å®ä¾‹é…ç½® hystrix.command.[HystrixCommandKey].metrics.rollingPercentile.enabled å»ºè®®(ç¬”è€…å¤‡æ³¨) å»ºè®®ä¿æŒé»˜è®¤å€¼ ç¼–ç¨‹å¼é…ç½®ï¼š 12345678910111213public class CustomCommand extends HystrixCommand&lt;String&gt; &#123; public CustomCommand() &#123; super(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(\"CustomCommand\")) .andCommandPropertiesDefaults(HystrixCommandProperties.Setter() .withMetricsRollingPercentileEnabled(true))); &#125; @Override protected String run() throws Exception &#123; return null; &#125;&#125; é…ç½®æ–‡ä»¶ä¸­(Properties)é…ç½®ï¼š 1234567# ä¸‹é¢é…ç½®äºŒé€‰ä¸€# é»˜è®¤å…¨å±€é…ç½®hystrix.command.default.metrics.rollingPercentile.enabled=true# å®ä¾‹é…ç½®hystrix.command.CustomCommand.metrics.rollingPercentile.enabled=true ç™¾åˆ†æ•°è®¡ç®—ä½¿ç”¨çš„æ»‘åŠ¨çª—å£æŒç»­æ—¶é—´ metrics.rollingPercentile.timeInMilliseconds é¡¹ å€¼ é»˜è®¤å€¼ 60000 å¯é€‰å€¼ - é»˜è®¤å…¨å±€é…ç½® hystrix.command.default.metrics.rollingPercentile.timeInMilliseconds å®ä¾‹é…ç½® hystrix.command.[HystrixCommandKey].metrics.rollingPercentile.timeInMilliseconds å»ºè®®(ç¬”è€…å¤‡æ³¨) å»ºè®®ä¿æŒé»˜è®¤å€¼ ç¼–ç¨‹å¼é…ç½®ï¼š 12345678910111213public class CustomCommand extends HystrixCommand&lt;String&gt; &#123; public CustomCommand() &#123; super(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(\"CustomCommand\")) .andCommandPropertiesDefaults(HystrixCommandProperties.Setter() .withMetricsRollingPercentileWindowInMilliseconds(60000))); &#125; @Override protected String run() throws Exception &#123; return null; &#125;&#125; é…ç½®æ–‡ä»¶ä¸­(Properties)é…ç½®ï¼š 1234567# ä¸‹é¢é…ç½®äºŒé€‰ä¸€# é»˜è®¤å…¨å±€é…ç½®hystrix.command.default.metrics.rollingPercentile.timeInMilliseconds=60000# å®ä¾‹é…ç½®hystrix.command.CustomCommand.metrics.rollingPercentile.timeInMilliseconds=60000 ç™¾åˆ†æ•°è®¡ç®—ä½¿ç”¨çš„Bucketæ€»æ•° metrics.rollingPercentile.numBuckets é¡¹ å€¼ é»˜è®¤å€¼ 6 å¯é€‰å€¼ æ»¡è¶³metrics.rollingPercentile.timeInMilliseconds % metrics.rollingPercentile.numBuckets == 0ï¼Œè¦å°½é‡å°ï¼Œå¦åˆ™æœ‰å¯èƒ½å½±å“æ€§èƒ½ é»˜è®¤å…¨å±€é…ç½® hystrix.command.default.metrics.rollingPercentile.numBuckets å®ä¾‹é…ç½® hystrix.command.[HystrixCommandKey].metrics.rollingPercentile.numBuckets å»ºè®®(ç¬”è€…å¤‡æ³¨) å»ºè®®ä¿æŒé»˜è®¤å€¼ ç¼–ç¨‹å¼é…ç½®ï¼š 12345678910111213public class CustomCommand extends HystrixCommand&lt;String&gt; &#123; public CustomCommand() &#123; super(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(\"CustomCommand\")) .andCommandPropertiesDefaults(HystrixCommandProperties.Setter() .withMetricsRollingPercentileWindowBuckets(6))); &#125; @Override protected String run() throws Exception &#123; return null; &#125;&#125; é…ç½®æ–‡ä»¶ä¸­(Properties)é…ç½®ï¼š 1234567# ä¸‹é¢é…ç½®äºŒé€‰ä¸€# é»˜è®¤å…¨å±€é…ç½®hystrix.command.default.metrics.rollingPercentile.numBuckets=6# å®ä¾‹é…ç½®hystrix.command.CustomCommand.metrics.rollingPercentile.numBuckets=6 ç™¾åˆ†æ•°è®¡ç®—ä½¿ç”¨çš„Bucketå®¹é‡ metrics.rollingPercentile.bucketSize é¡¹ å€¼ é»˜è®¤å€¼ 100 å¯é€‰å€¼ - é»˜è®¤å…¨å±€é…ç½® hystrix.command.default.metrics.rollingPercentile.bucketSize å®ä¾‹é…ç½® hystrix.command.[HystrixCommandKey].metrics.rollingPercentile.bucketSize å»ºè®®(ç¬”è€…å¤‡æ³¨) å»ºè®®ä¿æŒé»˜è®¤å€¼ ç¼–ç¨‹å¼é…ç½®ï¼š 12345678910111213public class CustomCommand extends HystrixCommand&lt;String&gt; &#123; public CustomCommand() &#123; super(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(\"CustomCommand\")) .andCommandPropertiesDefaults(HystrixCommandProperties.Setter() .withMetricsRollingPercentileBucketSize(100))); &#125; @Override protected String run() throws Exception &#123; return null; &#125;&#125; é…ç½®æ–‡ä»¶ä¸­(Properties)é…ç½®ï¼š 1234567# ä¸‹é¢é…ç½®äºŒé€‰ä¸€# é»˜è®¤å…¨å±€é…ç½®hystrix.command.default.metrics.rollingPercentile.bucketSize=100# å®ä¾‹é…ç½®hystrix.command.CustomCommand.metrics.rollingPercentile.bucketSize=100 å¥åº·çŠ¶æ€å¿«ç…§æ”¶é›†çš„å‘¨æœŸ metrics.healthSnapshot.intervalInMilliseconds é¡¹ å€¼ é»˜è®¤å€¼ 500 å¯é€‰å€¼ - é»˜è®¤å…¨å±€é…ç½® hystrix.command.default.metrics.healthSnapshot.intervalInMilliseconds å®ä¾‹é…ç½® hystrix.command.[HystrixCommandKey].metrics.healthSnapshot.intervalInMilliseconds å»ºè®®(ç¬”è€…å¤‡æ³¨) å»ºè®®ä¿æŒé»˜è®¤å€¼ ç¼–ç¨‹å¼é…ç½®ï¼š 12345678910111213public class CustomCommand extends HystrixCommand&lt;String&gt; &#123; public CustomCommand() &#123; super(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(\"CustomCommand\")) .andCommandPropertiesDefaults(HystrixCommandProperties.Setter() .withMetricsHealthSnapshotIntervalInMilliseconds(500))); &#125; @Override protected String run() throws Exception &#123; return null; &#125;&#125; é…ç½®æ–‡ä»¶ä¸­(Properties)é…ç½®ï¼š 1234567# ä¸‹é¢é…ç½®äºŒé€‰ä¸€# é»˜è®¤å…¨å±€é…ç½®hystrix.command.default.metrics.healthSnapshot.intervalInMilliseconds=500# å®ä¾‹é…ç½®hystrix.command.CustomCommand.metrics.healthSnapshot.intervalInMilliseconds=500 è¯·æ±‚ä¸Šä¸‹æ–‡é…ç½® è¯·æ±‚ä¸Šä¸‹æ–‡å±æ€§ä¸»è¦æ¶‰åŠåˆ°HystrixRequestContextå’ŒHystrixCommandçš„ä½¿ç”¨ã€‚ æ˜¯å¦å¯ç”¨è¯·æ±‚ç¼“å­˜ requestCache.enabled é¡¹ å€¼ é»˜è®¤å€¼ true å¯é€‰å€¼ trueã€false é»˜è®¤å…¨å±€é…ç½® hystrix.command.default.requestCache.enabled å®ä¾‹é…ç½® hystrix.command.[HystrixCommandKey].requestCache.enabled å»ºè®®(ç¬”è€…å¤‡æ³¨) å»ºè®®ä¿æŒé»˜è®¤å€¼ ç¼–ç¨‹å¼é…ç½®ï¼š 12345678910111213public class CustomCommand extends HystrixCommand&lt;String&gt; &#123; public CustomCommand() &#123; super(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(\"CustomCommand\")) .andCommandPropertiesDefaults(HystrixCommandProperties.Setter() .withRequestCacheEnabled(true))); &#125; @Override protected String run() throws Exception &#123; return null; &#125;&#125; é…ç½®æ–‡ä»¶ä¸­(Properties)é…ç½®ï¼š 1234567# ä¸‹é¢é…ç½®äºŒé€‰ä¸€# é»˜è®¤å…¨å±€é…ç½®hystrix.command.default.requestCache.enabled=true# å®ä¾‹é…ç½®hystrix.command.CustomCommand.requestCache.enabled=true æ˜¯å¦å¯ç”¨è¯·æ±‚æ—¥å¿— requestLog.enabled é¡¹ å€¼ é»˜è®¤å€¼ true å¯é€‰å€¼ trueã€false é»˜è®¤å…¨å±€é…ç½® hystrix.command.default.requestLog.enabled å®ä¾‹é…ç½® hystrix.command.[HystrixCommandKey].requestLog.enabled å»ºè®®(ç¬”è€…å¤‡æ³¨) å»ºè®®ä¿æŒé»˜è®¤å€¼ ç¼–ç¨‹å¼é…ç½®ï¼š 12345678910111213public class CustomCommand extends HystrixCommand&lt;String&gt; &#123; public CustomCommand() &#123; super(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(\"CustomCommand\")) .andCommandPropertiesDefaults(HystrixCommandProperties.Setter() .withRequestLogEnabled(true))); &#125; @Override protected String run() throws Exception &#123; return null; &#125;&#125; é…ç½®æ–‡ä»¶ä¸­(Properties)é…ç½®ï¼š 1234567# ä¸‹é¢é…ç½®äºŒé€‰ä¸€# é»˜è®¤å…¨å±€é…ç½®hystrix.command.default.requestLog.enabled=true# å®ä¾‹é…ç½®hystrix.command.CustomCommand.requestLog.enabled=true è¯·æ±‚åˆæˆå™¨é…ç½® è¯·æ±‚åˆæˆå™¨é…ç½®ä¸»è¦æ§åˆ¶HystrixCollapserçš„è¡Œä¸ºã€‚ è¯·æ±‚åˆæˆçš„æœ€å¤§æ‰¹æ¬¡é‡ maxRequestsInBatch é¡¹ å€¼ é»˜è®¤å€¼ Integer.MAX_VALUE å¯é€‰å€¼ - é»˜è®¤å…¨å±€é…ç½® hystrix.collapser.default.maxRequestsInBatch å®ä¾‹é…ç½® hystrix.collapser.[HystrixCollapserKey].maxRequestsInBatch å»ºè®®(ç¬”è€…å¤‡æ³¨) å»ºè®®ä¿æŒé»˜è®¤å€¼ ç¼–ç¨‹å¼é…ç½®ï¼š 1234567891011121314151617181920212223public class CustomHystrixCollapser extends HystrixCollapser&lt;List&lt;String&gt;, String, String&gt; &#123; public CustomHystrixCollapser(Setter setter) &#123; super(Setter.withCollapserKey(HystrixCollapserKey.Factory.asKey(\"CustomHystrixCollapser\")) .andCollapserPropertiesDefaults(HystrixCollapserProperties.Setter() .withMaxRequestsInBatch(10))); &#125; @Override public String getRequestArgument() &#123; return null; &#125; @Override protected HystrixCommand&lt;List&lt;String&gt;&gt; createCommand(Collection&lt;CollapsedRequest&lt;String, String&gt;&gt; collapsedRequests) &#123; return null; &#125; @Override protected void mapResponseToRequests(List&lt;String&gt; batchResponse, Collection&lt;CollapsedRequest&lt;String, String&gt;&gt; collapsedRequests) &#123; &#125;&#125; é…ç½®æ–‡ä»¶ä¸­(Properties)é…ç½®ï¼š 1234567# ä¸‹é¢é…ç½®äºŒé€‰ä¸€# é»˜è®¤å…¨å±€é…ç½®hystrix.collapser.default.maxRequestsInBatch=10# å®ä¾‹é…ç½®hystrix.collapser.CustomHystrixCollapser.maxRequestsInBatch=10 å»¶è¿Ÿæ‰§è¡Œæ—¶é—´ timerDelayInMilliseconds é¡¹ å€¼ é»˜è®¤å€¼ 10 å¯é€‰å€¼ - é»˜è®¤å…¨å±€é…ç½® hystrix.collapser.default.timerDelayInMilliseconds å®ä¾‹é…ç½® hystrix.collapser.[HystrixCollapserKey].timerDelayInMilliseconds å»ºè®®(ç¬”è€…å¤‡æ³¨) å»ºè®®ä¿æŒé»˜è®¤å€¼ ç¼–ç¨‹å¼é…ç½®ï¼š 1234567891011121314151617181920212223public class CustomHystrixCollapser extends HystrixCollapser&lt;List&lt;String&gt;, String, String&gt; &#123; public CustomHystrixCollapser(Setter setter) &#123; super(Setter.withCollapserKey(HystrixCollapserKey.Factory.asKey(\"CustomHystrixCollapser\")) .andCollapserPropertiesDefaults(HystrixCollapserProperties.Setter() .withTimerDelayInMilliseconds(10))); &#125; @Override public String getRequestArgument() &#123; return null; &#125; @Override protected HystrixCommand&lt;List&lt;String&gt;&gt; createCommand(Collection&lt;CollapsedRequest&lt;String, String&gt;&gt; collapsedRequests) &#123; return null; &#125; @Override protected void mapResponseToRequests(List&lt;String&gt; batchResponse, Collection&lt;CollapsedRequest&lt;String, String&gt;&gt; collapsedRequests) &#123; &#125;&#125; é…ç½®æ–‡ä»¶ä¸­(Properties)é…ç½®ï¼š 1234567# ä¸‹é¢é…ç½®äºŒé€‰ä¸€# é»˜è®¤å…¨å±€é…ç½®hystrix.collapser.default.timerDelayInMilliseconds=10# å®ä¾‹é…ç½®hystrix.collapser.CustomHystrixCollapser.timerDelayInMilliseconds=10 æ˜¯å¦å¯ç”¨è¯·æ±‚åˆæˆç¼“å­˜ requestCache.enabled é¡¹ å€¼ é»˜è®¤å€¼ true å¯é€‰å€¼ trueã€false é»˜è®¤å…¨å±€é…ç½® hystrix.collapser.default.requestCache.enabled å®ä¾‹é…ç½® hystrix.collapser.[HystrixCollapserKey].requestCache.enabled å»ºè®®(ç¬”è€…å¤‡æ³¨) å»ºè®®ä¿æŒé»˜è®¤å€¼ ç¼–ç¨‹å¼é…ç½®ï¼š 1234567891011121314151617181920212223public class CustomHystrixCollapser extends HystrixCollapser&lt;List&lt;String&gt;, String, String&gt; &#123; public CustomHystrixCollapser(Setter setter) &#123; super(Setter.withCollapserKey(HystrixCollapserKey.Factory.asKey(\"CustomHystrixCollapser\")) .andCollapserPropertiesDefaults(HystrixCollapserProperties.Setter() .withTimerDelayInMilliseconds(10))); &#125; @Override public String getRequestArgument() &#123; return null; &#125; @Override protected HystrixCommand&lt;List&lt;String&gt;&gt; createCommand(Collection&lt;CollapsedRequest&lt;String, String&gt;&gt; collapsedRequests) &#123; return null; &#125; @Override protected void mapResponseToRequests(List&lt;String&gt; batchResponse, Collection&lt;CollapsedRequest&lt;String, String&gt;&gt; collapsedRequests) &#123; &#125;&#125; é…ç½®æ–‡ä»¶ä¸­(Properties)é…ç½®ï¼š 1234567# ä¸‹é¢é…ç½®äºŒé€‰ä¸€# é»˜è®¤å…¨å±€é…ç½®hystrix.collapser.default.requestCache.enabled=true# å®ä¾‹é…ç½®hystrix.collapser.CustomHystrixCollapser.requestCache.enabled=true çº¿ç¨‹æ± é…ç½® Hystrixä½¿ç”¨çš„æ˜¯JUCçº¿ç¨‹æ± ThreadPoolExecutorï¼Œçº¿ç¨‹æ± ç›¸å…³é…ç½®ç›´æ¥å½±å“ThreadPoolExecutorå®ä¾‹ã€‚Hystrixçš„å‘½ä»¤æ‰§è¡Œé€‰ç”¨äº†çº¿ç¨‹æ± ç­–ç•¥ï¼Œé‚£ä¹ˆå°±æ˜¯é€šè¿‡çº¿ç¨‹æ± éš”ç¦»æ‰§è¡Œçš„ï¼Œæœ€å¥½ä¸ºæ¯ä¸€ä¸ªåˆ†ç»„è®¾ç«‹ç‹¬ç«‹çš„çº¿ç¨‹æ± ã€‚ç¬”è€…åœ¨ç”Ÿäº§å®è·µçš„æ—¶å€™ï¼Œä¸€èˆ¬æŠŠHystrixCommandGroupKeyå’ŒHystrixThreadPoolKeyè®¾ç½®ä¸ºä¸€è‡´ã€‚ æ ¸å¿ƒçº¿ç¨‹æ•° coreSize é¡¹ å€¼ é»˜è®¤å€¼ 10 å¯é€‰å€¼ - é»˜è®¤å…¨å±€é…ç½® hystrix.threadpool.default.coreSize å®ä¾‹é…ç½® hystrix.threadpool.[HystrixThreadPoolKey].coreSize å»ºè®®(ç¬”è€…å¤‡æ³¨) æ ¹æ®çœŸå®æƒ…å†µè‡ªè¡Œé…ç½®å’Œè°ƒæ•´ ç¼–ç¨‹å¼é…ç½®ï¼š 12345678910111213public class CustomCommand extends HystrixCommand&lt;String&gt; &#123; public CustomCommand() &#123; super(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(\"CustomCommand\")) .andThreadPoolPropertiesDefaults(HystrixThreadPoolProperties.Setter() .withCoreSize(10))); &#125; @Override protected String run() throws Exception &#123; return null; &#125;&#125; é…ç½®æ–‡ä»¶ä¸­(Properties)é…ç½®ï¼š 1234567# ä¸‹é¢é…ç½®äºŒé€‰ä¸€# é»˜è®¤å…¨å±€é…ç½®hystrix.threadpool.default.coreSize=10# å®ä¾‹é…ç½®hystrix.threadpool.CustomCommand.coreSize=10 æœ€å¤§çº¿ç¨‹æ•° maximumSize æ­¤å±æ€§åªæœ‰åœ¨allowMaximumSizeToDivergeFromCoreSizeä¸ºtrueçš„æ—¶å€™æ‰ç”Ÿæ•ˆã€‚ é¡¹ å€¼ é»˜è®¤å€¼ 10 å¯é€‰å€¼ - é»˜è®¤å…¨å±€é…ç½® hystrix.threadpool.default.maximumSize å®ä¾‹é…ç½® hystrix.threadpool.[HystrixThreadPoolKey].maximumSize å»ºè®®(ç¬”è€…å¤‡æ³¨) æ ¹æ®çœŸå®æƒ…å†µè‡ªè¡Œé…ç½®å’Œè°ƒæ•´ ç¼–ç¨‹å¼é…ç½®ï¼š 12345678910111213public class CustomCommand extends HystrixCommand&lt;String&gt; &#123; public CustomCommand() &#123; super(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(\"CustomCommand\")) .andThreadPoolPropertiesDefaults(HystrixThreadPoolProperties.Setter() .withMaximumSize(10))); &#125; @Override protected String run() throws Exception &#123; return null; &#125;&#125; é…ç½®æ–‡ä»¶ä¸­(Properties)é…ç½®ï¼š 1234567# ä¸‹é¢é…ç½®äºŒé€‰ä¸€# é»˜è®¤å…¨å±€é…ç½®hystrix.threadpool.default.maximumSize=10# å®ä¾‹é…ç½®hystrix.threadpool.CustomCommand.maximumSize=10 æœ€å¤§ä»»åŠ¡é˜Ÿåˆ—å®¹é‡ maxQueueSize æ­¤å±æ€§é…ç½®ä¸º-1æ—¶ä½¿ç”¨çš„æ˜¯SynchronousQueueï¼Œé…ç½®ä¸ºå¤§äº1çš„æ•´æ•°æ—¶ä½¿ç”¨çš„æ˜¯LinkedBlockingQueueã€‚ é¡¹ å€¼ é»˜è®¤å€¼ -1 å¯é€‰å€¼ -1æˆ–è€…å¤§äº0çš„æ•´æ•° é»˜è®¤å…¨å±€é…ç½® hystrix.threadpool.default.maxQueueSize å®ä¾‹é…ç½® hystrix.threadpool.[HystrixThreadPoolKey].maxQueueSize å»ºè®®(ç¬”è€…å¤‡æ³¨) æ ¹æ®çœŸå®æƒ…å†µè‡ªè¡Œé…ç½®å’Œè°ƒæ•´ ç¼–ç¨‹å¼é…ç½®ï¼š 12345678910111213public class CustomCommand extends HystrixCommand&lt;String&gt; &#123; public CustomCommand() &#123; super(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(\"CustomCommand\")) .andThreadPoolPropertiesDefaults(HystrixThreadPoolProperties.Setter() .withMaxQueueSize(-1))); &#125; @Override protected String run() throws Exception &#123; return null; &#125;&#125; é…ç½®æ–‡ä»¶ä¸­(Properties)é…ç½®ï¼š 1234567# ä¸‹é¢é…ç½®äºŒé€‰ä¸€# é»˜è®¤å…¨å±€é…ç½®hystrix.threadpool.default.maxQueueSize=-1# å®ä¾‹é…ç½®hystrix.threadpool.CustomCommand.maxQueueSize=-1 ä»»åŠ¡æ‹’ç»çš„ä»»åŠ¡é˜Ÿåˆ—é˜ˆå€¼ queueSizeRejectionThreshold å½“maxQueueSizeé…ç½®ä¸º-1çš„æ—¶å€™ï¼Œæ­¤é…ç½®é¡¹ä¸ç”Ÿæ•ˆã€‚ é¡¹ å€¼ é»˜è®¤å€¼ 5 å¯é€‰å€¼ å¤§äº0çš„æ•´æ•° é»˜è®¤å…¨å±€é…ç½® hystrix.threadpool.default.queueSizeRejectionThreshold å®ä¾‹é…ç½® hystrix.threadpool.[HystrixThreadPoolKey].queueSizeRejectionThreshold å»ºè®®(ç¬”è€…å¤‡æ³¨) æ ¹æ®çœŸå®æƒ…å†µè‡ªè¡Œé…ç½®å’Œè°ƒæ•´ ç¼–ç¨‹å¼é…ç½®ï¼š 12345678910111213public class CustomCommand extends HystrixCommand&lt;String&gt; &#123; public CustomCommand() &#123; super(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(\"CustomCommand\")) .andThreadPoolPropertiesDefaults(HystrixThreadPoolProperties.Setter() .withQueueSizeRejectionThreshold(5))); &#125; @Override protected String run() throws Exception &#123; return null; &#125;&#125; é…ç½®æ–‡ä»¶ä¸­(Properties)é…ç½®ï¼š 1234567# ä¸‹é¢é…ç½®äºŒé€‰ä¸€# é»˜è®¤å…¨å±€é…ç½®hystrix.threadpool.default.queueSizeRejectionThreshold=5# å®ä¾‹é…ç½®hystrix.threadpool.CustomCommand.queueSizeRejectionThreshold=5 éæ ¸å¿ƒçº¿ç¨‹å­˜æ´»æ—¶é—´ keepAliveTimeMinutes å½“allowMaximumSizeToDivergeFromCoreSizeä¸ºtrueå¹¶ä¸”maximumSizeå¤§äºcoreSizeæ—¶æ­¤é…ç½®æ‰ç”Ÿæ•ˆã€‚ é¡¹ å€¼ é»˜è®¤å€¼ 1 å¯é€‰å€¼ å¤§äº0çš„æ•´æ•° é»˜è®¤å…¨å±€é…ç½® hystrix.threadpool.default.keepAliveTimeMinutes å®ä¾‹é…ç½® hystrix.threadpool.[HystrixThreadPoolKey].keepAliveTimeMinutes å»ºè®®(ç¬”è€…å¤‡æ³¨) æ ¹æ®çœŸå®æƒ…å†µè‡ªè¡Œé…ç½®å’Œè°ƒæ•´ ç¼–ç¨‹å¼é…ç½®ï¼š 12345678910111213public class CustomCommand extends HystrixCommand&lt;String&gt; &#123; public CustomCommand() &#123; super(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(\"CustomCommand\")) .andThreadPoolPropertiesDefaults(HystrixThreadPoolProperties.Setter() .withKeepAliveTimeMinutes(1))); &#125; @Override protected String run() throws Exception &#123; return null; &#125;&#125; é…ç½®æ–‡ä»¶ä¸­(Properties)é…ç½®ï¼š 1234567# ä¸‹é¢é…ç½®äºŒé€‰ä¸€# é»˜è®¤å…¨å±€é…ç½®hystrix.threadpool.default.keepAliveTimeMinutes=1# å®ä¾‹é…ç½®hystrix.threadpool.CustomCommand.keepAliveTimeMinutes=1 æ˜¯å¦å…è®¸æœ€å¤§çº¿ç¨‹æ•°ç”Ÿæ•ˆ allowMaximumSizeToDivergeFromCoreSize é¡¹ å€¼ é»˜è®¤å€¼ false å¯é€‰å€¼ trueã€false é»˜è®¤å…¨å±€é…ç½® hystrix.threadpool.default.allowMaximumSizeToDivergeFromCoreSize å®ä¾‹é…ç½® hystrix.threadpool.[HystrixThreadPoolKey].allowMaximumSizeToDivergeFromCoreSize å»ºè®®(ç¬”è€…å¤‡æ³¨) æ ¹æ®çœŸå®æƒ…å†µè‡ªè¡Œé…ç½®å’Œè°ƒæ•´ ç¼–ç¨‹å¼é…ç½®ï¼š 12345678910111213public class CustomCommand extends HystrixCommand&lt;String&gt; &#123; public CustomCommand() &#123; super(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(\"CustomCommand\")) .andThreadPoolPropertiesDefaults(HystrixThreadPoolProperties.Setter() .withAllowMaximumSizeToDivergeFromCoreSize(true))); &#125; @Override protected String run() throws Exception &#123; return null; &#125;&#125; é…ç½®æ–‡ä»¶ä¸­(Properties)é…ç½®ï¼š 1234567# ä¸‹é¢é…ç½®äºŒé€‰ä¸€# é»˜è®¤å…¨å±€é…ç½®hystrix.threadpool.default.allowMaximumSizeToDivergeFromCoreSize=true# å®ä¾‹é…ç½®hystrix.threadpool.CustomCommand.allowMaximumSizeToDivergeFromCoreSize=true çº¿ç¨‹æ± æ»‘åŠ¨çª—å£æŒç»­æ—¶é—´ metrics.rollingStats.timeInMilliseconds é¡¹ å€¼ é»˜è®¤å€¼ 10000 å¯é€‰å€¼ - é»˜è®¤å…¨å±€é…ç½® hystrix.threadpool.default.metrics.rollingStats.timeInMilliseconds å®ä¾‹é…ç½® hystrix.threadpool.[HystrixThreadPoolKey].metrics.rollingStats.timeInMilliseconds å»ºè®®(ç¬”è€…å¤‡æ³¨) å»ºè®®ä½¿ç”¨é»˜è®¤å€¼ ç¼–ç¨‹å¼é…ç½®ï¼š 12345678910111213public class CustomCommand extends HystrixCommand&lt;String&gt; &#123; public CustomCommand() &#123; super(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(\"CustomCommand\")) .andThreadPoolPropertiesDefaults(HystrixThreadPoolProperties.Setter() .withMetricsRollingStatisticalWindowInMilliseconds(10000))); &#125; @Override protected String run() throws Exception &#123; return null; &#125;&#125; é…ç½®æ–‡ä»¶ä¸­(Properties)é…ç½®ï¼š 1234567# ä¸‹é¢é…ç½®äºŒé€‰ä¸€# é»˜è®¤å…¨å±€é…ç½®hystrix.threadpool.default.metrics.rollingStats.timeInMilliseconds=10000# å®ä¾‹é…ç½®hystrix.threadpool.CustomCommand.metrics.rollingStats.timeInMilliseconds=10000 çº¿ç¨‹æ± æ»‘åŠ¨çª—å£Bucketæ€»æ•° metrics.rollingStats.numBuckets é¡¹ å€¼ é»˜è®¤å€¼ 10 å¯é€‰å€¼ æ»¡è¶³metrics.rollingStats.timeInMilliseconds % metrics.rollingStats.numBuckets == 0ï¼Œå€¼è¦å°½é‡å°‘ï¼Œå¦åˆ™ä¼šå½±å“æ€§èƒ½ é»˜è®¤å…¨å±€é…ç½® hystrix.threadpool.default.metrics.rollingStats.numBuckets å®ä¾‹é…ç½® hystrix.threadpool.[HystrixThreadPoolKey].metrics.rollingStats.numBuckets å»ºè®®(ç¬”è€…å¤‡æ³¨) å»ºè®®ä½¿ç”¨é»˜è®¤å€¼ ç¼–ç¨‹å¼é…ç½®ï¼š 12345678910111213public class CustomCommand extends HystrixCommand&lt;String&gt; &#123; public CustomCommand() &#123; super(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(\"CustomCommand\")) .andThreadPoolPropertiesDefaults(HystrixThreadPoolProperties.Setter() .withMetricsRollingStatisticalWindowBuckets(10))); &#125; @Override protected String run() throws Exception &#123; return null; &#125;&#125; é…ç½®æ–‡ä»¶ä¸­(Properties)é…ç½®ï¼š 1234567# ä¸‹é¢é…ç½®äºŒé€‰ä¸€# é»˜è®¤å…¨å±€é…ç½®hystrix.threadpool.default.metrics.rollingStats.numBuckets=10# å®ä¾‹é…ç½®hystrix.threadpool.CustomCommand.metrics.rollingStats.numBuckets=10 (æœ¬æ–‡å®Œ e-a-201890602 1:00 AM c-3-d)","categories":[{"name":"Framework","slug":"Framework","permalink":"http://throwable.club/blog/categories/Framework/"},{"name":"Hystrix","slug":"Framework/Hystrix","permalink":"http://throwable.club/blog/categories/Framework/Hystrix/"}],"tags":[{"name":"Framework","slug":"Framework","permalink":"http://throwable.club/blog/tags/Framework/"},{"name":"Hystrix","slug":"Hystrix","permalink":"http://throwable.club/blog/tags/Hystrix/"}]},{"title":"å†…éƒ¨åˆ†äº«-Spring Cloud Gatewayåˆä½“éªŒ","slug":"in-action-share-spring-cloud-gateway-guide","date":"2019-05-27T13:46:31.000Z","updated":"2019-05-27T14:01:29.988Z","comments":true,"path":"2019/05/27/in-action-share-spring-cloud-gateway-guide/","link":"","permalink":"http://throwable.club/2019/05/27/in-action-share-spring-cloud-gateway-guide/","excerpt":"","text":"ç›®å½• === ç®€ä»‹ === === === å·¥ä½œåŸç† === === === === === === === === === === ===","categories":[],"tags":[{"name":"In Action","slug":"In-Action","permalink":"http://throwable.club/blog/tags/In-Action/"},{"name":"Spring Cloud Gateway","slug":"Spring-Cloud-Gateway","permalink":"http://throwable.club/blog/tags/Spring-Cloud-Gateway/"}]},{"title":"å†…éƒ¨åˆ†äº«-èŠèŠå¸¸ç”¨çš„çº¿ç¨‹æ¨¡å‹","slug":"in-action-share-talk-about-java-thread-model","date":"2019-05-26T12:02:01.000Z","updated":"2019-05-27T14:26:22.630Z","comments":true,"path":"2019/05/26/in-action-share-talk-about-java-thread-model/","link":"","permalink":"http://throwable.club/2019/05/26/in-action-share-talk-about-java-thread-model/","excerpt":"","text":"åŸºæœ¬æ¦‚å¿µ === === å•çº¿ç¨‹æ¨¡å‹ === === å¤šçº¿ç¨‹æ¨¡å‹ === === === Reactorçº¿ç¨‹æ¨¡å‹ === ===","categories":[],"tags":[{"name":"In Action","slug":"In-Action","permalink":"http://throwable.club/blog/tags/In-Action/"},{"name":"Concurrency","slug":"Concurrency","permalink":"http://throwable.club/blog/tags/Concurrency/"}]},{"title":"Spring Cloud Gateway-ä½¿ç”¨è‡ªå®šä¹‰è¿‡æ»¤å™¨é€šè¿‡Hystrixå®ç°é™çº§å¤„ç†","slug":"spring-cloud-gateway-hystrix","date":"2019-05-25T12:33:44.000Z","updated":"2019-06-02T01:53:47.141Z","comments":true,"path":"2019/05/25/spring-cloud-gateway-hystrix/","link":"","permalink":"http://throwable.club/2019/05/25/spring-cloud-gateway-hystrix/","excerpt":"å‰æ åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œä¸‹æ¸¸ä¾èµ–å‡ºç°é—®é¢˜å¦‚æœä¸Šæ¸¸è°ƒç”¨æ–¹ä¸åšè¯·æ±‚é™çº§å¤„ç†ï¼Œä¸‹æ¸¸çš„å¼‚å¸¸ä¾èµ–æ²¡æœ‰è¢«éš”ç¦»ï¼Œå¾ˆæœ‰å¯èƒ½å‡ºç°å› ä¸ºä¸€ä¸¤ä¸ªæœåŠ¡æˆ–è€…å°åˆ°ä¸€ä¸¤ä¸ªæ¥å£å¼‚å¸¸å¯¼è‡´ä¸Šæ¸¸æ‰€æœ‰æœåŠ¡ä¸å¯ç”¨ï¼Œç”šè‡³å½±å“æ•´ä¸ªä¸šåŠ¡çº¿ã€‚è¯·æ±‚é™çº§å¤„ç†ç›®å‰æ¯”è¾ƒä¸»æµçš„ä¾ç„¶æ˜¯Netfilxå‡ºå“çš„Hystrixã€‚Hystrixçš„å·¥ä½œåŸç†æ˜¯ï¼š æŠŠè¯·æ±‚åŸºäºçº¿ç¨‹æ± æˆ–è€…ä¿¡å·é‡éš”ç¦»ï¼Œä¸€æ—¦ä¸‹æ¸¸æœåŠ¡åœ¨æŒ‡å®šé…ç½®çš„è¶…æ—¶æ—¶é—´å†…æ— æ³•å“åº”ä¼šè¿›å…¥é¢„è®¾æˆ–è€…é»˜è®¤çš„é™çº§å®ç°ã€‚ æ¯ä¸ªè¯·æ±‚çš„çŠ¶æ€éƒ½ä¼šè®°å½•ä¸‹æ¥ï¼Œåœ¨ä¸€ä¸ªæ»‘åŠ¨çª—å£å†…å¤„ç†å¤±è´¥çš„æ¯”ç‡è¶…è¿‡è®¾å®šçš„é˜ˆå€¼å°±ä¼šè§¦å‘ç†”æ–­å™¨(Circle Breaker)å¼€å¯ï¼Œç†”æ–­å™¨å¼€å¯ä¹‹åæ‰€æœ‰è¯·æ±‚éƒ½ä¼šç›´æ¥è¿›å…¥é¢„è®¾æˆ–è€…é»˜è®¤çš„é™çº§é€»è¾‘ã€‚ ç†”æ–­å™¨æ‰“å¼€åï¼Œä¸”è·ç¦»ç†”æ–­å™¨æ‰“å¼€çš„æ—¶é—´æˆ–ä¸Šä¸€æ¬¡è¯•æ¢è¯·æ±‚æ”¾è¡Œçš„æ—¶é—´è¶…è¿‡è®¾å®šå€¼ï¼Œç†”æ–­å™¨å™¨è¿›å…¥åŠå¼€çŠ¶æ€ï¼Œå…è®¸æ”¾è¡Œä¸€ä¸ªè¯•æ¢è¯·æ±‚ã€‚ è¯·æ±‚æˆåŠŸç‡æé«˜åï¼ŒåŸºäºç»Ÿè®¡æ•°æ®ç¡®å®šå¯¹ç†”æ–­å™¨è¿›è¡Œå…³é—­ï¼Œæ‰€æœ‰è¯·æ±‚æ­£å¸¸æ”¾è¡Œã€‚ è¿™é‡Œä¸å¯¹Hystrixçš„ç»†èŠ‚åšæ›´æ·±å…¥åˆ†æï¼Œè€Œæ˜¯æ¥ç€è°ˆè°ˆSpring Cloud Gatewayä¸­å¦‚ä½•ä½¿ç”¨Hystrixï¼Œä¸»è¦åŒ…æ‹¬å†…ç½®çš„Hystrixè¿‡æ»¤å™¨å’Œå®šåˆ¶è¿‡æ»¤å™¨ç»“åˆHystrixå®ç°æˆ‘ä»¬æƒ³è¦çš„åŠŸèƒ½ã€‚é™¤äº†è¦å¼•å…¥spring-cloud-starter-gatewayä¾èµ–ä¹‹å¤–ï¼Œè¿˜éœ€è¦å¼•å…¥spring-cloud-starter-netflix-hystrixã€‚ 12345678910&lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-gateway&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-netflix-hystrix&lt;/artifactId&gt; &lt;/dependency&gt;&lt;/dependencies&gt;","text":"å‰æ åœ¨å¾®æœåŠ¡æ¶æ„ä¸­ï¼Œä¸‹æ¸¸ä¾èµ–å‡ºç°é—®é¢˜å¦‚æœä¸Šæ¸¸è°ƒç”¨æ–¹ä¸åšè¯·æ±‚é™çº§å¤„ç†ï¼Œä¸‹æ¸¸çš„å¼‚å¸¸ä¾èµ–æ²¡æœ‰è¢«éš”ç¦»ï¼Œå¾ˆæœ‰å¯èƒ½å‡ºç°å› ä¸ºä¸€ä¸¤ä¸ªæœåŠ¡æˆ–è€…å°åˆ°ä¸€ä¸¤ä¸ªæ¥å£å¼‚å¸¸å¯¼è‡´ä¸Šæ¸¸æ‰€æœ‰æœåŠ¡ä¸å¯ç”¨ï¼Œç”šè‡³å½±å“æ•´ä¸ªä¸šåŠ¡çº¿ã€‚è¯·æ±‚é™çº§å¤„ç†ç›®å‰æ¯”è¾ƒä¸»æµçš„ä¾ç„¶æ˜¯Netfilxå‡ºå“çš„Hystrixã€‚Hystrixçš„å·¥ä½œåŸç†æ˜¯ï¼š æŠŠè¯·æ±‚åŸºäºçº¿ç¨‹æ± æˆ–è€…ä¿¡å·é‡éš”ç¦»ï¼Œä¸€æ—¦ä¸‹æ¸¸æœåŠ¡åœ¨æŒ‡å®šé…ç½®çš„è¶…æ—¶æ—¶é—´å†…æ— æ³•å“åº”ä¼šè¿›å…¥é¢„è®¾æˆ–è€…é»˜è®¤çš„é™çº§å®ç°ã€‚ æ¯ä¸ªè¯·æ±‚çš„çŠ¶æ€éƒ½ä¼šè®°å½•ä¸‹æ¥ï¼Œåœ¨ä¸€ä¸ªæ»‘åŠ¨çª—å£å†…å¤„ç†å¤±è´¥çš„æ¯”ç‡è¶…è¿‡è®¾å®šçš„é˜ˆå€¼å°±ä¼šè§¦å‘ç†”æ–­å™¨(Circle Breaker)å¼€å¯ï¼Œç†”æ–­å™¨å¼€å¯ä¹‹åæ‰€æœ‰è¯·æ±‚éƒ½ä¼šç›´æ¥è¿›å…¥é¢„è®¾æˆ–è€…é»˜è®¤çš„é™çº§é€»è¾‘ã€‚ ç†”æ–­å™¨æ‰“å¼€åï¼Œä¸”è·ç¦»ç†”æ–­å™¨æ‰“å¼€çš„æ—¶é—´æˆ–ä¸Šä¸€æ¬¡è¯•æ¢è¯·æ±‚æ”¾è¡Œçš„æ—¶é—´è¶…è¿‡è®¾å®šå€¼ï¼Œç†”æ–­å™¨å™¨è¿›å…¥åŠå¼€çŠ¶æ€ï¼Œå…è®¸æ”¾è¡Œä¸€ä¸ªè¯•æ¢è¯·æ±‚ã€‚ è¯·æ±‚æˆåŠŸç‡æé«˜åï¼ŒåŸºäºç»Ÿè®¡æ•°æ®ç¡®å®šå¯¹ç†”æ–­å™¨è¿›è¡Œå…³é—­ï¼Œæ‰€æœ‰è¯·æ±‚æ­£å¸¸æ”¾è¡Œã€‚ è¿™é‡Œä¸å¯¹Hystrixçš„ç»†èŠ‚åšæ›´æ·±å…¥åˆ†æï¼Œè€Œæ˜¯æ¥ç€è°ˆè°ˆSpring Cloud Gatewayä¸­å¦‚ä½•ä½¿ç”¨Hystrixï¼Œä¸»è¦åŒ…æ‹¬å†…ç½®çš„Hystrixè¿‡æ»¤å™¨å’Œå®šåˆ¶è¿‡æ»¤å™¨ç»“åˆHystrixå®ç°æˆ‘ä»¬æƒ³è¦çš„åŠŸèƒ½ã€‚é™¤äº†è¦å¼•å…¥spring-cloud-starter-gatewayä¾èµ–ä¹‹å¤–ï¼Œè¿˜éœ€è¦å¼•å…¥spring-cloud-starter-netflix-hystrixã€‚ 12345678910&lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-gateway&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-netflix-hystrix&lt;/artifactId&gt; &lt;/dependency&gt;&lt;/dependencies&gt; ä½¿ç”¨å†…ç½®çš„Hystrixè¿‡æ»¤å™¨ å†…ç½®çš„Hystrixè¿‡æ»¤å™¨æ˜¯HystrixGatewayFilterFactoryï¼Œå®ƒæ”¯æŒçš„é…ç½®æ˜¯ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041public static class Config &#123; // å¦‚æœä¸‹é¢çš„Setteré…ç½®ä¸ºnullçš„æ—¶å€™ï¼Œnameä¼šä½œä¸ºHystrixçš„HystrixCommandKey private String name; // Hystrixçš„Setterå±æ€§ï¼Œä¸»è¦ç”¨æ¥é…ç½®å‘½ä»¤çš„KEYå’Œå…¶ä»–å±æ€§ private Setter setter; // é™çº§çš„ç›®æ ‡URIï¼Œå¿…é¡»ä»¥forwardå¼€å¤´ï¼ŒURIä¼šåŒ¹é…åˆ°ç½‘å…³åº”ç”¨çš„æ§åˆ¶å™¨æ–¹æ³• private URI fallbackUri; public String getName() &#123; return name; &#125; public Config setName(String name) &#123; this.name = name; return this; &#125; public Config setFallbackUri(String fallbackUri) &#123; if (fallbackUri != null) &#123; setFallbackUri(URI.create(fallbackUri)); &#125; return this; &#125; public URI getFallbackUri() &#123; return fallbackUri; &#125; // æ³¨æ„è¿™ä¸ªæ–¹æ³•ï¼Œé…ç½®çš„fallbackUriè¦ä»¥forwardå¼€å§‹ä½œä¸ºschemaï¼Œå¦åˆ™ä¼šæŠ›å¼‚å¸¸ public void setFallbackUri(URI fallbackUri) &#123; if (fallbackUri != null &amp;&amp; !\"forward\".equals(fallbackUri.getScheme())) &#123; throw new IllegalArgumentException(\"Hystrix Filter currently only supports 'forward' URIs, found \" + fallbackUri); &#125; this.fallbackUri = fallbackUri; &#125; public Config setSetter(Setter setter) &#123; this.setter = setter; return this; &#125;&#125; å¦å¤–ï¼Œï¼ˆ1ï¼‰å…¨å±€çš„Hystrixé…ç½®ä¹Ÿä¼šå¯¹HystrixGatewayFilterFactoryç”Ÿæ•ˆï¼›ï¼ˆ2ï¼‰HystrixGatewayFilterFactoryå¯ä»¥ä½œä¸ºé»˜è®¤è¿‡æ»¤å™¨(default-filters)å¯¹æ‰€æœ‰çš„è·¯ç”±é…ç½®ä½œä¸ºå…œåº•è¿‡æ»¤å™¨å¹¶å‘æŒ¥ä½œç”¨ã€‚ å¯¹äºç¬¬ï¼ˆ1ï¼‰ç‚¹ï¼Œæˆ‘ä»¬å¦‚æœåœ¨application.yamlä¸­é…ç½®å¦‚ä¸‹ï¼š 12345678910111213141516// æ‰§è¡Œè¶…æ—¶æ—¶é—´ä¸º1ç§’ï¼Œä¼šå¯¹ä¸‹é¢è·¯ç”±order_routeç»‘å®šçš„HystrixGatewayFilterFactoryç”Ÿæ•ˆhystrix.command.fallbackcmd.execution.isolation.thread.timeoutInMilliseconds: 1000spring: cloud: gateway: routes: - id: order_route uri: http://localhost:9091 predicates: - Path=/order/** filters: - name: Hystrix args: name: HystrixCommand fallbackUri: forward:/fallback é…ç½®çš„hystrix.command.fallbackcmd.execution.isolation.thread.timeoutInMillisecondsä¼šå¯¹ç»‘å®šåœ¨è·¯ç”±order_routeä¸­çš„HystrixGatewayFilterFactoryç”Ÿæ•ˆã€‚ å¯¹äºç¬¬ï¼ˆ2ï¼‰ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥æŠŠHystrixGatewayFilterFactoryé…ç½®ä¸ºé»˜è®¤è¿‡æ»¤å™¨ï¼Œè¿™æ ·å­æ‰€æœ‰çš„è·¯ç”±éƒ½ä¼šå…³è”æ­¤è¿‡æ»¤å™¨ï¼Œä½†æ˜¯éå¿…è¦æ—¶å»ºè®®ä¸è¦è¿™æ ·åšï¼š 12345678910111213spring: cloud: gateway: routes: - id: order_route uri: http://localhost:9091 predicates: - Path=/order/** default-filters: - name: Hystrix args: name: HystrixCommand fallbackUri: forward:/fallback ç¬”è€…åœ¨æµ‹è¯•çš„æ—¶å€™ï¼Œå‘ç°ä¸Šé¢æåˆ°çš„Setteræ— æ³•é…ç½®ï¼Œä¼°è®¡æ˜¯ç”±äºHystrixçš„Setterå¯¹è±¡æ˜¯ç»è¿‡å¤šé‡åŒ…è£…ï¼Œæš‚æ—¶æ²¡æœ‰åŠæ³•è®¾ç½®è¯¥å±æ€§ã€‚æ¥ç€æˆ‘ä»¬è¦åœ¨ç½‘å…³æœåŠ¡åŠ ä¸€ä¸ªæ§åˆ¶å™¨æ–¹æ³•ç”¨äºå¤„ç†é‡å®šå‘çš„/fallbackè¯·æ±‚ï¼š 123456789101112131415161718@RestControllerpublic class FallbackController &#123; @RequestMapping(value = \"/fallback\") @ResponseStatus public Mono&lt;Map&lt;String, Object&gt;&gt; fallback(ServerWebExchange exchange, Throwable throwable) &#123; Map&lt;String, Object&gt; result = new HashMap&lt;&gt;(8); ServerHttpRequest request = exchange.getRequest(); result.put(\"path\", request.getPath().pathWithinApplication().value()); result.put(\"method\", request.getMethodValue()); if (null != throwable.getCause()) &#123; result.put(\"message\", throwable.getCause().getMessage()); &#125; else &#123; result.put(\"message\", throwable.getMessage()); &#125; return Mono.just(result); &#125;&#125; æ§åˆ¶å™¨æ–¹æ³•å…¥å‚ä¼šè¢«Spring Cloud Gatewayçš„å†…éƒ¨ç»„ä»¶å¤„ç†ï¼Œå¯ä»¥å›è°ƒä¸€äº›æœ‰ç”¨çš„ç±»å‹ä¾‹å¦‚ServerWebExchangeå®ä¾‹ã€å…·ä½“çš„å¼‚å¸¸å®ä¾‹ç­‰ç­‰ã€‚ ä½¿ç”¨Hystrixå®šåˆ¶è¿‡æ»¤å™¨ HystrixGatewayFilterFactoryåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹åº”è¯¥å¯ä»¥æ»¡è¶³ä¸šåŠ¡éœ€è¦ï¼Œä½†æ˜¯è¿™é‡Œä¹Ÿåšä¸€æ¬¡å®šåˆ¶ä¸€ä¸ªæ•´åˆHystrixçš„è¿‡æ»¤å™¨ï¼Œå®ç°çš„åŠŸèƒ½å¦‚ä¸‹ï¼š åŸºäºæ¯ä¸ªè¯·æ±‚URLåˆ›å»ºä¸€ä¸ªæ–°çš„Hystrixå‘½ä»¤å®ä¾‹è¿›è¡Œè°ƒç”¨ã€‚ æ¯ä¸ªURLå¯ä»¥æŒ‡å®šç‰¹æœ‰çš„çº¿ç¨‹æ± é…ç½®ï¼Œå¦‚æœä¸æŒ‡å®šåˆ™ä½¿ç”¨é»˜è®¤çš„ã€‚ æ¯ä¸ªURLå¯ä»¥é…ç½®å•ç‹¬çš„Hystrixè¶…æ—¶æ—¶é—´ã€‚ ä¹Ÿå°±æ˜¯é€šè¿‡Hystrixä½¿ç”¨çº¿ç¨‹æ± å¯¹æ¯ç§ä¸åŒçš„å¤–éƒ¨è¯·æ±‚URLè¿›è¡Œéš”ç¦»ã€‚å½“ç„¶ï¼Œè¿™æ ·çš„è¿‡æ»¤å™¨ä»…ä»…åœ¨å¤–éƒ¨è¯·æ±‚çš„ä¸åŒURLçš„æ•°é‡æœ‰é™çš„æƒ…å†µä¸‹æ‰æ¯”è¾ƒåˆç†ï¼Œå¦åˆ™æœ‰å¯èƒ½åˆ›å»ºè¿‡å¤šçš„çº¿ç¨‹æ± é€ æˆç³»ç»Ÿæ€§èƒ½çš„ä¸‹é™ï¼Œé€‚å¾—å…¶åã€‚æ”¹é€ å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174@Componentpublic class CustomHystrixFilter extends AbstractGatewayFilterFactory&lt;CustomHystrixFilter.Config&gt; &#123; private static final String FORWARD_KEY = \"forward\"; private static final String NAME = \"CustomHystrix\"; private static final int TIMEOUT_MS = 1000; private final ObjectProvider&lt;DispatcherHandler&gt; dispatcherHandlerProvider; private volatile DispatcherHandler dispatcherHandler; private boolean processConfig = false; public CustomHystrixFilter(ObjectProvider&lt;DispatcherHandler&gt; dispatcherHandlerProvider) &#123; super(Config.class); this.dispatcherHandlerProvider = dispatcherHandlerProvider; &#125; private DispatcherHandler getDispatcherHandler() &#123; if (dispatcherHandler == null) &#123; dispatcherHandler = dispatcherHandlerProvider.getIfAvailable(); &#125; return dispatcherHandler; &#125; @Override public List&lt;String&gt; shortcutFieldOrder() &#123; return Collections.singletonList(NAME_KEY); &#125; @Override public GatewayFilter apply(Config config) &#123; processConfig(config); return (exchange, chain) -&gt; &#123; ServerHttpRequest request = exchange.getRequest(); String path = request.getPath().pathWithinApplication().value(); int timeout = config.getTimeout().getOrDefault(path, TIMEOUT_MS); CustomHystrixCommand command = new CustomHystrixCommand(config.getFallbackUri(), exchange, chain, timeout, path); return Mono.create(s -&gt; &#123; Subscription sub = command.toObservable().subscribe(s::success, s::error, s::success); s.onCancel(sub::unsubscribe); &#125;).onErrorResume((Function&lt;Throwable, Mono&lt;Void&gt;&gt;) throwable -&gt; &#123; if (throwable instanceof HystrixRuntimeException) &#123; HystrixRuntimeException e = (HystrixRuntimeException) throwable; HystrixRuntimeException.FailureType failureType = e.getFailureType(); switch (failureType) &#123; case TIMEOUT: return Mono.error(new TimeoutException()); case COMMAND_EXCEPTION: &#123; Throwable cause = e.getCause(); if (cause instanceof ResponseStatusException || AnnotatedElementUtils .findMergedAnnotation(cause.getClass(), ResponseStatus.class) != null) &#123; return Mono.error(cause); &#125; &#125; default: break; &#125; &#125; return Mono.error(throwable); &#125;).then(); &#125;; &#125; /** * YAMLè§£æçš„æ—¶å€™MAPçš„KEYä¸æ”¯æŒ'/'ï¼Œè¿™é‡Œåªèƒ½ç”¨'-'æ›¿ä»£ * * @param config config */ private void processConfig(Config config) &#123; if (!processConfig) &#123; processConfig = true; if (null != config.getTimeout()) &#123; Map&lt;String, Integer&gt; timeout = new HashMap&lt;&gt;(8); config.getTimeout().forEach((k, v) -&gt; &#123; String key = k.replace(\"-\", \"/\"); if (!key.startsWith(\"/\")) &#123; key = \"/\" + key; &#125; timeout.put(key, v); &#125;); config.setTimeout(timeout); &#125; &#125; &#125; @Override public String name() &#123; return NAME; &#125; private class CustomHystrixCommand extends HystrixObservableCommand&lt;Void&gt; &#123; private final URI fallbackUri; private final ServerWebExchange exchange; private final GatewayFilterChain chain; public CustomHystrixCommand(URI fallbackUri, ServerWebExchange exchange, GatewayFilterChain chain, int timeout, String key) &#123; super(Setter.withGroupKey(HystrixCommandGroupKey.Factory.asKey(key)) .andCommandKey(HystrixCommandKey.Factory.asKey(key)) .andCommandPropertiesDefaults(HystrixCommandProperties.Setter().withExecutionTimeoutInMilliseconds(timeout))); this.fallbackUri = fallbackUri; this.exchange = exchange; this.chain = chain; &#125; @Override protected Observable&lt;Void&gt; construct() &#123; return RxReactiveStreams.toObservable(this.chain.filter(exchange)); &#125; @Override protected Observable&lt;Void&gt; resumeWithFallback() &#123; if (null == fallbackUri) &#123; return super.resumeWithFallback(); &#125; URI uri = exchange.getRequest().getURI(); boolean encoded = containsEncodedParts(uri); URI requestUrl = UriComponentsBuilder.fromUri(uri) .host(null) .port(null) .uri(this.fallbackUri) .build(encoded) .toUri(); exchange.getAttributes().put(GATEWAY_REQUEST_URL_ATTR, requestUrl); ServerHttpRequest request = this.exchange.getRequest().mutate().uri(requestUrl).build(); ServerWebExchange mutated = exchange.mutate().request(request).build(); return RxReactiveStreams.toObservable(getDispatcherHandler().handle(mutated)); &#125; &#125; public static class Config &#123; private String id; private URI fallbackUri; /** * url -&gt; timeout ms */ private Map&lt;String, Integer&gt; timeout; public String getId() &#123; return id; &#125; public Config setId(String id) &#123; this.id = id; return this; &#125; public URI getFallbackUri() &#123; return fallbackUri; &#125; public Config setFallbackUri(URI fallbackUri) &#123; if (fallbackUri != null &amp;&amp; !FORWARD_KEY.equals(fallbackUri.getScheme())) &#123; throw new IllegalArgumentException(\"Hystrix Filter currently only supports 'forward' URIs, found \" + fallbackUri); &#125; this.fallbackUri = fallbackUri; return this; &#125; public Map&lt;String, Integer&gt; getTimeout() &#123; return timeout; &#125; public Config setTimeout(Map&lt;String, Integer&gt; timeout) &#123; this.timeout = timeout; return this; &#125; &#125;&#125; å…¶å®å¤§éƒ¨åˆ†ä»£ç å’Œå†…ç½®çš„Hystrixè¿‡æ»¤å™¨å·®ä¸å¤šï¼Œåªæ˜¯æ”¹äº†å‘½ä»¤æ”¹é€ å‡½æ•°éƒ¨åˆ†å’Œé…ç½®åŠ è½½å¤„ç†çš„éƒ¨åˆ†ã€‚é…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼š 1234567891011121314151617181920spring: cloud: gateway: routes: - id: hystrix_route uri: http://localhost:9091 predicates: - Host=localhost:9090 filters: - name: CustomHystrix args: id: CustomHystrix fallbackUri: forward:/fallback timeout: # è¿™é‡Œæš‚æ—¶ç”¨-åˆ†éš”URLï¼Œå› ä¸º/ä¸æ”¯æŒ order-remote: 2000 application: name: route-serverserver: port: 9090 ç½‘å…³æ·»åŠ ä¸€ä¸ª/fallbackå¤„ç†æ§åˆ¶å™¨å¦‚ä¸‹ï¼š 123456789101112131415161718@RestControllerpublic class FallbackController &#123; @RequestMapping(value = \"/fallback\") @ResponseStatus public Mono&lt;Map&lt;String, Object&gt;&gt; fallback(ServerWebExchange exchange, Throwable throwable) &#123; Map&lt;String, Object&gt; result = new HashMap&lt;&gt;(8); ServerHttpRequest request = exchange.getRequest(); result.put(\"path\", request.getPath().pathWithinApplication().value()); result.put(\"method\", request.getMethodValue()); if (null != throwable.getCause()) &#123; result.put(\"message\", throwable.getCause().getMessage()); &#125; else &#123; result.put(\"message\", throwable.getMessage()); &#125; return Mono.just(result); &#125;&#125; æ•…æ„åœ¨ä¸‹æ¸¸æœåŠ¡æ‰“æ–­ç‚¹ï¼š 12345678curl http://localhost:9090/order/remoteå“åº”ç»“æœï¼š&#123; \"path\": \"/fallback\", \"method\": \"GET\", \"message\": null # &lt;== è¿™é‡Œç”±äºæ˜¯è¶…æ—¶å¼‚å¸¸ï¼Œmessageå°±æ˜¯null&#125; åˆšå¥½ç¬¦åˆé¢„æœŸç»“æœã€‚ å°ç»“ è¿™ç¯‡æ–‡ç« ä»…ä»…æ˜¯å¯¹Hystrixå’Œè¿‡æ»¤å™¨åº”ç”¨æä¾›ä¸€ä¸ªå¯ç”¨çš„ä¾‹å­å’Œè§£å†³é—®é¢˜çš„æ€è·¯ï¼Œå…·ä½“å¦‚ä½•ä½¿ç”¨è¿˜æ˜¯éœ€è¦é’ˆå¯¹çœŸå®çš„åœºæ™¯ã€‚ (æœ¬æ–‡å®Œ c-2-d e-a-20190522)","categories":[{"name":"Spring Cloud","slug":"Spring-Cloud","permalink":"http://throwable.club/blog/categories/Spring-Cloud/"},{"name":"Spring Cloud Gateway","slug":"Spring-Cloud/Spring-Cloud-Gateway","permalink":"http://throwable.club/blog/categories/Spring-Cloud/Spring-Cloud-Gateway/"}],"tags":[{"name":"Spring Cloud Gateway","slug":"Spring-Cloud-Gateway","permalink":"http://throwable.club/blog/tags/Spring-Cloud-Gateway/"},{"name":"Spring Cloud","slug":"Spring-Cloud","permalink":"http://throwable.club/blog/tags/Spring-Cloud/"}]},{"title":"ç»å…¸é¢è¯•é¢˜-ä¸¤ä¸ªçº¿ç¨‹äº¤æ›¿æ‰“å°å¥‡æ•°å’Œå¶æ•°","slug":"interview-problem-double-thread-print-odd-even-alternately","date":"2019-05-20T14:43:49.000Z","updated":"2019-06-09T03:48:05.767Z","comments":true,"path":"2019/05/20/interview-problem-double-thread-print-odd-even-alternately/","link":"","permalink":"http://throwable.club/2019/05/20/interview-problem-double-thread-print-odd-even-alternately/","excerpt":"å‰æ ä»Šå¤©ä¸‹ç­æ—¶å€™å’ŒåŒäº‹èŠå¤©å¶ç„¶å¬åˆ°é¢è¯•é¢˜â€œä¸¤ä¸ªçº¿ç¨‹äº¤æ›¿æ‰“å°å¥‡æ•°å’Œå¶æ•°â€çš„å®ç°ï¼Œè¿™é‡Œåšä¸€ä¸ªå¤ç›˜ã€‚","text":"å‰æ ä»Šå¤©ä¸‹ç­æ—¶å€™å’ŒåŒäº‹èŠå¤©å¶ç„¶å¬åˆ°é¢è¯•é¢˜â€œä¸¤ä¸ªçº¿ç¨‹äº¤æ›¿æ‰“å°å¥‡æ•°å’Œå¶æ•°â€çš„å®ç°ï¼Œè¿™é‡Œåšä¸€ä¸ªå¤ç›˜ã€‚ å¤ç›˜ åœºæ™¯ä¸€ï¼šçº¿ç¨‹Aæ‰“å°å¥‡æ•°ï¼Œçº¿ç¨‹Bæ‰“å°å¶æ•°ï¼Œçº¿ç¨‹Aå’Œçº¿ç¨‹Bäº¤æ›¿æ‰“å°ï¼Œä½¿ç”¨å¯¹è±¡ç›‘è§†å™¨å®ç°ã€‚ åœºæ™¯äºŒï¼šçº¿ç¨‹Aæ‰“å°å¥‡æ•°ï¼Œçº¿ç¨‹Bæ‰“å°å¶æ•°ï¼Œçº¿ç¨‹Aå’Œçº¿ç¨‹Bäº¤æ›¿æ‰“å°ï¼Œä½¿ç”¨JDKæä¾›çš„å¹¶å‘ç±»åº“å®ç°ã€‚ è¿™ä¸¤ä¸ªåœºæ™¯ä¸­ï¼Œåœºæ™¯ä¸€æ˜¯ä¸€ç§æ¯”è¾ƒå¤è€çš„åŒæ­¥æ–¹å¼ï¼Œæœ¬è´¨ç”±JVMå®ç°ï¼›åœºæ™¯äºŒæ˜¯JDK1.5å¼•å…¥JUCåŒ…ä¹‹åç®€åŒ–äº†å¹¶å‘ç¼–ç¨‹çš„å‰æä¸‹çš„æ›´ç®€ä¾¿çš„å®ç°ã€‚ä¸‹é¢é’ˆå¯¹ä¸¤ä¸ªåœºæ™¯åšå¯¹åº”çš„å®ç°ã€‚ åœºæ™¯ä¸€ åœºæ™¯ä¸€ä¸­ï¼Œçº¿ç¨‹Aå’Œçº¿ç¨‹Bäº¤æ›¿æ‰“å°å¥‡æ•°å’Œå¶æ•°ï¼Œä½¿ç”¨å¯¹è±¡ç›‘è§†å™¨å®ç°ï¼Œé€šä¿—æ¥è¯´ï¼šçº¿ç¨‹Aæˆ–çº¿ç¨‹Båªè¦æœ‰ä¸€è€…ç«äº‰é”æˆåŠŸï¼Œå°±æ‰“å°++iï¼Œé€šçŸ¥å…¶ä»–çº¿ç¨‹ä»ç­‰å¾…é›†åˆä¸­é‡Šæ”¾ï¼Œç„¶åè‡ªèº«çº¿ç¨‹åŠ å…¥ç­‰å¾…é›†åˆå¹¶ä¸”é‡Šæ”¾é”å³å¯ã€‚ 12345678910111213141516171819202122232425262728293031323334public class OddEvenPrinter &#123; private final Object monitor = new Object(); private final int limit; private volatile int count; public OddEvenPrinter(int limit, int initCount) &#123; this.limit = limit; this.count = initCount; &#125; public void print() &#123; synchronized (monitor) &#123; while (count &lt; limit) &#123; try &#123; System.out.println(String.format(\"çº¿ç¨‹[%s]æ‰“å°æ•°å­—:%d\", Thread.currentThread().getName(), ++count)); monitor.notifyAll(); monitor.wait(); &#125; catch (InterruptedException e) &#123; //ignore &#125; &#125; &#125; &#125; public static void main(String[] args) throws Exception &#123; OddEvenPrinter printer = new OddEvenPrinter(10, 0); Thread thread1 = new Thread(printer::print, \"thread-1\"); Thread thread2 = new Thread(printer::print, \"thread-2\"); thread1.start(); thread2.start(); Thread.sleep(Integer.MAX_VALUE); &#125;&#125; æ‰§è¡Œåçš„è¾“å‡ºç»“æœï¼š 12345678910çº¿ç¨‹[thread-1]æ‰“å°æ•°å­—:1çº¿ç¨‹[thread-2]æ‰“å°æ•°å­—:2çº¿ç¨‹[thread-1]æ‰“å°æ•°å­—:3çº¿ç¨‹[thread-2]æ‰“å°æ•°å­—:4çº¿ç¨‹[thread-1]æ‰“å°æ•°å­—:5çº¿ç¨‹[thread-2]æ‰“å°æ•°å­—:6çº¿ç¨‹[thread-1]æ‰“å°æ•°å­—:7çº¿ç¨‹[thread-2]æ‰“å°æ•°å­—:8çº¿ç¨‹[thread-1]æ‰“å°æ•°å­—:9çº¿ç¨‹[thread-2]æ‰“å°æ•°å­—:10 åœºæ™¯äºŒ åœºæ™¯äºŒä¸­ï¼Œå¦‚æœéœ€è¦ä½¿ç”¨JUCä¸­æä¾›çš„å¹¶å‘ç±»åº“ï¼Œå¯ä»¥è€ƒè™‘å’Œå¯¹è±¡ç›‘è§†å™¨åŠŸèƒ½æ¥è¿‘çš„å¯é‡å…¥é”ReentrantLockã€‚å…·ä½“ä»£ç å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839public class OddEvenPrinterEx &#123; private final ReentrantLock lock = new ReentrantLock(); private final Condition condition = lock.newCondition(); private final int limit; private volatile int count; public OddEvenPrinterEx(int limit, int initCount) &#123; this.limit = limit; this.count = initCount; &#125; public void print() &#123; lock.lock(); try &#123; while (count &lt; limit)&#123; System.out.println(String.format(\"çº¿ç¨‹[%s]æ‰“å°æ•°å­—:%d\", Thread.currentThread().getName(), ++count)); condition.signalAll(); try &#123; condition.await(); &#125; catch (InterruptedException e) &#123; //ignore &#125; &#125; &#125; finally &#123; lock.unlock(); &#125; &#125; public static void main(String[] args) throws Exception &#123; OddEvenPrinterEx printer = new OddEvenPrinterEx(10, 0); Thread thread1 = new Thread(printer::print, \"thread-1\"); Thread thread2 = new Thread(printer::print, \"thread-2\"); thread1.start(); thread2.start(); Thread.sleep(Integer.MAX_VALUE); &#125;&#125; æ‰§è¡Œåçš„è¾“å‡ºç»“æœï¼š 12345678910çº¿ç¨‹[thread-2]æ‰“å°æ•°å­—:1çº¿ç¨‹[thread-1]æ‰“å°æ•°å­—:2çº¿ç¨‹[thread-2]æ‰“å°æ•°å­—:3çº¿ç¨‹[thread-1]æ‰“å°æ•°å­—:4çº¿ç¨‹[thread-2]æ‰“å°æ•°å­—:5çº¿ç¨‹[thread-1]æ‰“å°æ•°å­—:6çº¿ç¨‹[thread-2]æ‰“å°æ•°å­—:7çº¿ç¨‹[thread-1]æ‰“å°æ•°å­—:8çº¿ç¨‹[thread-2]æ‰“å°æ•°å­—:9çº¿ç¨‹[thread-1]æ‰“å°æ•°å­—:10 çœ¼å°–çš„å¯èƒ½çœ‹åˆ°è¿™é‡Œæ˜¯å…ˆç”±thread-2æ‰“å°å¥‡æ•°ï¼Œç„¶åthread-1æ‰“å°å¶æ•°ï¼Œè¿™ä¸ªå’ŒåŒæ­¥å™¨æ¡†æ¶çš„ç­‰å¾…é˜Ÿåˆ—ä»¥åŠåŒæ­¥é˜Ÿåˆ—çš„ç«äº‰æœ‰å…³ã€‚ å°ç»“ è¿™ä¸ªé—®é¢˜æœ‰å¾ˆå¤šç§è§£å†³æ€è·¯ï¼Œä½†æ˜¯ç›®å‰ç¬”è€…æ²¡æƒ³åˆ°æ— é”å®ç°æ–¹æ¡ˆã€‚å¾ˆå¤šç°æˆçš„(å‚è€ƒå¤šä¸ªåšå®¢)æ–¹æ¡ˆé‡Œé¢éƒ½æ˜¯ä½¿ç”¨å„ç§å¤šé‡åŒæ­¥æˆ–è€…åŠ é”ï¼Œå…¶å®æ„ä¹‰æ˜¯ä¸å¤§ï¼Œå®é™…ä¸Šè¦ç†è§£å¯¹è±¡ç›‘è§†å™¨å’ŒåŒæ­¥å™¨æ¡†æ¶AQSçš„ä¸€äº›åŸç†ï¼Œé‚£ä¹ˆå®ç°èµ·æ¥è‡ªç„¶æ¯”è¾ƒç®€å•ã€‚å‚çœ‹ç¬”è€…ä¹‹å‰å†™çš„ä¸¤ç¯‡æ–‡ç« ï¼š æ·±å…¥ç†è§£Objectæä¾›çš„é˜»å¡å’Œå”¤é†’API JUCåŒæ­¥å™¨æ¡†æ¶AbstractQueuedSynchronizeræºç å›¾æ–‡åˆ†æ (æœ¬æ–‡å®Œ c-1-d e-a-20190520)","categories":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/categories/Java/"},{"name":"Concurrency","slug":"Java/Concurrency","permalink":"http://throwable.club/blog/categories/Java/Concurrency/"}],"tags":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/tags/Java/"},{"name":"Concurrency","slug":"Concurrency","permalink":"http://throwable.club/blog/tags/Concurrency/"}]},{"title":"Spring Cloud Gateway-ServerWebExchangeæ ¸å¿ƒæ–¹æ³•ä¸è¯·æ±‚æˆ–è€…å“åº”å†…å®¹çš„ä¿®æ”¹","slug":"spring-cloud-gateway-modify-request-response","date":"2019-05-18T07:47:45.000Z","updated":"2019-06-02T02:08:24.089Z","comments":true,"path":"2019/05/18/spring-cloud-gateway-modify-request-response/","link":"","permalink":"http://throwable.club/2019/05/18/spring-cloud-gateway-modify-request-response/","excerpt":"å‰æ æœ¬æ–‡ç¼–å†™çš„æ—¶å€™ä½¿ç”¨çš„Spring Cloud Gatewayç‰ˆæœ¬ä¸ºå½“æ—¶æœ€æ–°çš„ç‰ˆæœ¬Greenwich.SR1ã€‚ æˆ‘ä»¬åœ¨ä½¿ç”¨Spring Cloud Gatewayçš„æ—¶å€™ï¼Œæ³¨æ„åˆ°è¿‡æ»¤å™¨ï¼ˆåŒ…æ‹¬GatewayFilterã€GlobalFilterå’Œè¿‡æ»¤å™¨é“¾GatewayFilterChainï¼‰ï¼Œéƒ½ä¾èµ–åˆ°ServerWebExchangeï¼š 1234567891011121314public interface GlobalFilter &#123; Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain);&#125;public interface GatewayFilter extends ShortcutConfigurable &#123; Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain);&#125;public interface GatewayFilterChain &#123; Mono&lt;Void&gt; filter(ServerWebExchange exchange);&#125; è¿™é‡Œçš„è®¾è®¡å’ŒServletä¸­çš„Filteræ˜¯ç›¸ä¼¼çš„ï¼Œå½“å‰è¿‡æ»¤å™¨å¯ä»¥å†³å®šæ˜¯å¦æ‰§è¡Œä¸‹ä¸€ä¸ªè¿‡æ»¤å™¨çš„é€»è¾‘ï¼Œç”±GatewayFilterChain#filter()æ˜¯å¦è¢«è°ƒç”¨æ¥å†³å®šã€‚è€ŒServerWebExchangeå°±ç›¸å½“äºå½“å‰è¯·æ±‚å’Œå“åº”çš„ä¸Šä¸‹æ–‡ã€‚ServerWebExchangeå®ä¾‹ä¸å•å­˜å‚¨äº†Requestå’ŒResponseå¯¹è±¡ï¼Œè¿˜æä¾›äº†ä¸€äº›æ‰©å±•æ–¹æ³•ï¼Œå¦‚æœæƒ³å®ç°æ”¹é€ è¯·æ±‚å‚æ•°æˆ–è€…å“åº”å‚æ•°ï¼Œå°±å¿…é¡»æ·±å…¥äº†è§£ServerWebExchangeã€‚","text":"å‰æ æœ¬æ–‡ç¼–å†™çš„æ—¶å€™ä½¿ç”¨çš„Spring Cloud Gatewayç‰ˆæœ¬ä¸ºå½“æ—¶æœ€æ–°çš„ç‰ˆæœ¬Greenwich.SR1ã€‚ æˆ‘ä»¬åœ¨ä½¿ç”¨Spring Cloud Gatewayçš„æ—¶å€™ï¼Œæ³¨æ„åˆ°è¿‡æ»¤å™¨ï¼ˆåŒ…æ‹¬GatewayFilterã€GlobalFilterå’Œè¿‡æ»¤å™¨é“¾GatewayFilterChainï¼‰ï¼Œéƒ½ä¾èµ–åˆ°ServerWebExchangeï¼š 1234567891011121314public interface GlobalFilter &#123; Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain);&#125;public interface GatewayFilter extends ShortcutConfigurable &#123; Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain);&#125;public interface GatewayFilterChain &#123; Mono&lt;Void&gt; filter(ServerWebExchange exchange);&#125; è¿™é‡Œçš„è®¾è®¡å’ŒServletä¸­çš„Filteræ˜¯ç›¸ä¼¼çš„ï¼Œå½“å‰è¿‡æ»¤å™¨å¯ä»¥å†³å®šæ˜¯å¦æ‰§è¡Œä¸‹ä¸€ä¸ªè¿‡æ»¤å™¨çš„é€»è¾‘ï¼Œç”±GatewayFilterChain#filter()æ˜¯å¦è¢«è°ƒç”¨æ¥å†³å®šã€‚è€ŒServerWebExchangeå°±ç›¸å½“äºå½“å‰è¯·æ±‚å’Œå“åº”çš„ä¸Šä¸‹æ–‡ã€‚ServerWebExchangeå®ä¾‹ä¸å•å­˜å‚¨äº†Requestå’ŒResponseå¯¹è±¡ï¼Œè¿˜æä¾›äº†ä¸€äº›æ‰©å±•æ–¹æ³•ï¼Œå¦‚æœæƒ³å®ç°æ”¹é€ è¯·æ±‚å‚æ•°æˆ–è€…å“åº”å‚æ•°ï¼Œå°±å¿…é¡»æ·±å…¥äº†è§£ServerWebExchangeã€‚ ç†è§£ServerWebExchange å…ˆçœ‹ServerWebExchangeçš„æ³¨é‡Šï¼š Contract for an HTTP request-response interaction. Provides access to the HTTP request and response and also exposes additional server-side processing related properties and features such as request attributes. ç¿»è¯‘ä¸€ä¸‹å¤§æ¦‚æ˜¯ï¼š ServerWebExchangeæ˜¯ä¸€ä¸ªHTTPè¯·æ±‚-å“åº”äº¤äº’çš„å¥‘çº¦ã€‚æä¾›å¯¹HTTPè¯·æ±‚å’Œå“åº”çš„è®¿é—®ï¼Œå¹¶å…¬å¼€é¢å¤–çš„æœåŠ¡å™¨ç«¯å¤„ç†ç›¸å…³å±æ€§å’Œç‰¹æ€§ï¼Œå¦‚è¯·æ±‚å±æ€§ã€‚ å…¶å®ï¼ŒServerWebExchangeå‘½åä¸ºæœåŠ¡ç½‘ç»œäº¤æ¢å™¨ï¼Œå­˜æ”¾ç€é‡è¦çš„è¯·æ±‚-å“åº”å±æ€§ã€è¯·æ±‚å®ä¾‹å’Œå“åº”å®ä¾‹ç­‰ç­‰ï¼Œæœ‰ç‚¹åƒContextçš„è§’è‰²ã€‚ ServerWebExchangeæ¥å£ ServerWebExchangeæ¥å£çš„æ‰€æœ‰æ–¹æ³•ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586public interface ServerWebExchange &#123; // æ—¥å¿—å‰ç¼€å±æ€§çš„KEYï¼Œå€¼ä¸ºorg.springframework.web.server.ServerWebExchange.LOG_ID // å¯ä»¥ç†è§£ä¸º attributes.set(\"org.springframework.web.server.ServerWebExchange.LOG_ID\",\"æ—¥å¿—å‰ç¼€çš„å…·ä½“å€¼\"); // ä½œç”¨æ˜¯æ‰“å°æ—¥å¿—çš„æ—¶å€™ä¼šæ‹¼æ¥è¿™ä¸ªKEYå¯¹é¥®çš„å‰ç¼€å€¼ï¼Œé»˜è®¤å€¼ä¸º\"\" String LOG_ID_ATTRIBUTE = ServerWebExchange.class.getName() + \".LOG_ID\"; String getLogPrefix(); // è·å–ServerHttpRequestå¯¹è±¡ ServerHttpRequest getRequest(); // è·å–ServerHttpResponseå¯¹è±¡ ServerHttpResponse getResponse(); // è¿”å›å½“å‰exchangeçš„è¯·æ±‚å±æ€§ï¼Œè¿”å›ç»“æœæ˜¯ä¸€ä¸ªå¯å˜çš„Map Map&lt;String, Object&gt; getAttributes(); // æ ¹æ®KEYè·å–è¯·æ±‚å±æ€§ @Nullable default &lt;T&gt; T getAttribute(String name) &#123; return (T) getAttributes().get(name); &#125; // æ ¹æ®KEYè·å–è¯·æ±‚å±æ€§ï¼Œåšäº†éç©ºåˆ¤æ–­ @SuppressWarnings(\"unchecked\") default &lt;T&gt; T getRequiredAttribute(String name) &#123; T value = getAttribute(name); Assert.notNull(value, () -&gt; \"Required attribute '\" + name + \"' is missing\"); return value; &#125; // æ ¹æ®KEYè·å–è¯·æ±‚å±æ€§ï¼Œéœ€è¦æä¾›é»˜è®¤å€¼ @SuppressWarnings(\"unchecked\") default &lt;T&gt; T getAttributeOrDefault(String name, T defaultValue) &#123; return (T) getAttributes().getOrDefault(name, defaultValue); &#125; // è¿”å›å½“å‰è¯·æ±‚çš„ç½‘ç»œä¼šè¯ Mono&lt;WebSession&gt; getSession(); // è¿”å›å½“å‰è¯·æ±‚çš„è®¤è¯ç”¨æˆ·ï¼Œå¦‚æœå­˜åœ¨çš„è¯ &lt;T extends Principal&gt; Mono&lt;T&gt; getPrincipal(); // è¿”å›è¯·æ±‚çš„è¡¨å•æ•°æ®æˆ–è€…ä¸€ä¸ªç©ºçš„Mapï¼Œåªæœ‰Content-Typeä¸ºapplication/x-www-form-urlencodedçš„æ—¶å€™è¿™ä¸ªæ–¹æ³•æ‰ä¼šè¿”å›ä¸€ä¸ªéç©ºçš„Map -- è¿™ä¸ªä¸€èˆ¬æ˜¯è¡¨å•æ•°æ®æäº¤ç”¨åˆ° Mono&lt;MultiValueMap&lt;String, String&gt;&gt; getFormData(); // è¿”å›multipartè¯·æ±‚çš„partæ•°æ®æˆ–è€…ä¸€ä¸ªç©ºçš„Mapï¼Œåªæœ‰Content-Typeä¸ºmultipart/form-dataçš„æ—¶å€™è¿™ä¸ªæ–¹æ³•æ‰ä¼šè¿”å›ä¸€ä¸ªéç©ºçš„Map -- è¿™ä¸ªä¸€èˆ¬æ˜¯æ–‡ä»¶ä¸Šä¼ ç”¨åˆ° Mono&lt;MultiValueMap&lt;String, Part&gt;&gt; getMultipartData(); // è¿”å›Springçš„ä¸Šä¸‹æ–‡ @Nullable ApplicationContext getApplicationContext(); // è¿™å‡ ä¸ªæ–¹æ³•å’ŒlastModifiedå±æ€§ç›¸å…³ boolean isNotModified(); boolean checkNotModified(Instant lastModified); boolean checkNotModified(String etag); boolean checkNotModified(@Nullable String etag, Instant lastModified); // URLè½¬æ¢ String transformUrl(String url); // URLè½¬æ¢æ˜ å°„ void addUrlTransformer(Function&lt;String, String&gt; transformer); // æ³¨æ„è¿™ä¸ªæ–¹æ³•ï¼Œæ–¹æ³•åæ˜¯ï¼šæ”¹å˜ï¼Œè¿™ä¸ªæ˜¯ä¿®æ”¹ServerWebExchangeå±æ€§çš„æ–¹æ³•ï¼Œè¿”å›çš„æ˜¯ä¸€ä¸ªBuilderå®ä¾‹ï¼ŒBuilderæ˜¯ServerWebExchangeçš„å†…éƒ¨ç±» default Builder mutate() &#123; return new DefaultServerWebExchangeBuilder(this); &#125; interface Builder &#123; // è¦†ç›–ServerHttpRequest Builder request(Consumer&lt;ServerHttpRequest.Builder&gt; requestBuilderConsumer); Builder request(ServerHttpRequest request); // è¦†ç›–ServerHttpResponse Builder response(ServerHttpResponse response); // è¦†ç›–å½“å‰è¯·æ±‚çš„è®¤è¯ç”¨æˆ· Builder principal(Mono&lt;Principal&gt; principalMono); // æ„å»ºæ–°çš„ServerWebExchangeå®ä¾‹ ServerWebExchange build(); &#125;&#125; æ³¨æ„åˆ°ServerWebExchange#mutate()æ–¹æ³•ï¼ŒServerWebExchangeå®ä¾‹å¯ä»¥ç†è§£ä¸ºä¸å¯å˜å®ä¾‹ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦ä¿®æ”¹å®ƒï¼Œéœ€è¦é€šè¿‡mutate()æ–¹æ³•ç”Ÿæˆä¸€ä¸ªæ–°çš„å®ä¾‹ï¼Œä¾‹å¦‚è¿™æ ·ï¼š 123456789101112131415public class CustomGlobalFilter implements GlobalFilter &#123; @Override public Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) &#123; ServerHttpRequest request = exchange.getRequest(); // è¿™é‡Œå¯ä»¥ä¿®æ”¹ServerHttpRequestå®ä¾‹ ServerHttpRequest newRequest = ... ServerHttpResponse response = exchange.getResponse(); // è¿™é‡Œå¯ä»¥ä¿®æ”¹ServerHttpResponseå®ä¾‹ ServerHttpResponse newResponse = ... // æ„å»ºæ–°çš„ServerWebExchangeå®ä¾‹ ServerWebExchange newExchange = exchange.mutate().request(newRequest).response(newResponse).build(); return chain.filter(newExchange); &#125;&#125; ServerHttpRequestæ¥å£ ServerHttpRequestå®ä¾‹æ˜¯ç”¨äºæ‰¿è½½è¯·æ±‚ç›¸å…³çš„å±æ€§å’Œè¯·æ±‚ä½“ï¼ŒSpring Cloud Gatewayä¸­åº•å±‚ä½¿ç”¨Nettyå¤„ç†ç½‘ç»œè¯·æ±‚ï¼Œé€šè¿‡è¿½æº¯æºç ï¼Œå¯ä»¥ä»ReactorHttpHandlerAdapterä¸­å¾—çŸ¥ServerWebExchangeå®ä¾‹ä¸­æŒæœ‰çš„ServerHttpRequestå®ä¾‹çš„å…·ä½“å®ç°æ˜¯ReactorServerHttpRequestã€‚ä¹‹æ‰€ä»¥åˆ—å‡ºè¿™äº›å®ä¾‹ä¹‹é—´çš„å…³ç³»ï¼Œæ˜¯å› ä¸ºè¿™æ ·æ¯”è¾ƒå®¹æ˜“ç†æ¸…ä¸€äº›éšå«çš„é—®é¢˜ï¼Œä¾‹å¦‚ï¼š ReactorServerHttpRequestçš„çˆ¶ç±»AbstractServerHttpRequestä¸­åˆå§‹åŒ–å†…éƒ¨å±æ€§headersçš„æ—¶å€™æŠŠè¯·æ±‚çš„HTTPå¤´éƒ¨å°è£…ä¸ºåªè¯»çš„å®ä¾‹ï¼š 12345678910111213141516public AbstractServerHttpRequest(URI uri, @Nullable String contextPath, HttpHeaders headers) &#123; this.uri = uri; this.path = RequestPath.parse(uri, contextPath); this.headers = HttpHeaders.readOnlyHttpHeaders(headers);&#125;// HttpHeadersç±»ä¸­çš„readOnlyHttpHeadersæ–¹æ³•ï¼Œå…¶ä¸­ReadOnlyHttpHeaderså±è”½äº†æ‰€æœ‰ä¿®æ”¹è¯·æ±‚å¤´çš„æ–¹æ³•ï¼Œç›´æ¥æŠ›å‡ºUnsupportedOperationExceptionpublic static HttpHeaders readOnlyHttpHeaders(HttpHeaders headers) &#123; Assert.notNull(headers, \"HttpHeaders must not be null\"); if (headers instanceof ReadOnlyHttpHeaders) &#123; return headers; &#125; else &#123; return new ReadOnlyHttpHeaders(headers); &#125;&#125; æ‰€ä»¥ä¸èƒ½ç›´æ¥ä»ServerHttpRequestå®ä¾‹ä¸­ç›´æ¥è·å–è¯·æ±‚å¤´HttpHeaderså®ä¾‹å¹¶ä¸”è¿›è¡Œä¿®æ”¹ã€‚ ServerHttpRequestæ¥å£å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879public interface HttpMessage &#123; // è·å–è¯·æ±‚å¤´ï¼Œç›®å‰çš„å®ç°ä¸­è¿”å›çš„æ˜¯ReadOnlyHttpHeaderså®ä¾‹ï¼Œåªè¯» HttpHeaders getHeaders();&#125; public interface ReactiveHttpInputMessage extends HttpMessage &#123; // è¿”å›è¯·æ±‚ä½“çš„Fluxå°è£… Flux&lt;DataBuffer&gt; getBody();&#125;public interface HttpRequest extends HttpMessage &#123; // è¿”å›HTTPè¯·æ±‚æ–¹æ³•ï¼Œè§£æä¸ºHttpMethodå®ä¾‹ @Nullable default HttpMethod getMethod() &#123; return HttpMethod.resolve(getMethodValue()); &#125; // è¿”å›HTTPè¯·æ±‚æ–¹æ³•ï¼Œå­—ç¬¦ä¸² String getMethodValue(); // è¯·æ±‚çš„URI URI getURI();&#125; public interface ServerHttpRequest extends HttpRequest, ReactiveHttpInputMessage &#123; // è¿æ¥çš„å”¯ä¸€æ ‡è¯†æˆ–è€…ç”¨äºæ—¥å¿—å¤„ç†æ ‡è¯† String getId(); // è·å–è¯·æ±‚è·¯å¾„ï¼Œå°è£…ä¸ºRequestPathå¯¹è±¡ RequestPath getPath(); // è¿”å›æŸ¥è¯¢å‚æ•°ï¼Œæ˜¯åªè¯»çš„MultiValueMapå®ä¾‹ MultiValueMap&lt;String, String&gt; getQueryParams(); // è¿”å›Cookieé›†åˆï¼Œæ˜¯åªè¯»çš„MultiValueMapå®ä¾‹ MultiValueMap&lt;String, HttpCookie&gt; getCookies(); // è¿œç¨‹æœåŠ¡å™¨åœ°å€ä¿¡æ¯ @Nullable default InetSocketAddress getRemoteAddress() &#123; return null; &#125; // SSLä¼šè¯å®ç°çš„ç›¸å…³ä¿¡æ¯ @Nullable default SslInfo getSslInfo() &#123; return null; &#125; // ä¿®æ”¹è¯·æ±‚çš„æ–¹æ³•ï¼Œè¿”å›ä¸€ä¸ªå»ºé€ å™¨å®ä¾‹Builderï¼ŒBuilderæ˜¯å†…éƒ¨ç±» default ServerHttpRequest.Builder mutate() &#123; return new DefaultServerHttpRequestBuilder(this); &#125; interface Builder &#123; // è¦†ç›–è¯·æ±‚æ–¹æ³• Builder method(HttpMethod httpMethod); // è¦†ç›–è¯·æ±‚çš„URIã€è¯·æ±‚è·¯å¾„æˆ–è€…ä¸Šä¸‹æ–‡ï¼Œè¿™ä¸‰è€…ç›¸äº’æœ‰åˆ¶çº¦å…³ç³»ï¼Œå…·ä½“å¯ä»¥å‚è€ƒAPIæ³¨é‡Š Builder uri(URI uri); Builder path(String path); Builder contextPath(String contextPath); // è¦†ç›–è¯·æ±‚å¤´ Builder header(String key, String value); Builder headers(Consumer&lt;HttpHeaders&gt; headersConsumer); // è¦†ç›–SslInfo Builder sslInfo(SslInfo sslInfo); // æ„å»ºä¸€ä¸ªæ–°çš„ServerHttpRequestå®ä¾‹ ServerHttpRequest build(); &#125; &#125; å¦‚æœè¦ä¿®æ”¹ServerHttpRequestå®ä¾‹ï¼Œé‚£ä¹ˆéœ€è¦è¿™æ ·åšï¼š 12ServerHttpRequest request = exchange.getRequest();ServerHttpRequest newRequest = request.mutate().headers(\"key\",\"value\").path(\"/myPath\").build(); è¿™é‡Œæœ€å€¼å¾—æ³¨æ„çš„æ˜¯ï¼šServerHttpRequestæˆ–è€…è¯´HttpMessageæ¥å£æä¾›çš„è·å–è¯·æ±‚å¤´æ–¹æ³•HttpHeaders getHeaders();è¿”å›ç»“æœæ˜¯ä¸€ä¸ªåªè¯»çš„å®ä¾‹ï¼Œå…·ä½“æ˜¯ReadOnlyHttpHeadersç±»å‹ï¼Œè¿™é‡Œæå¤šä¸€æ¬¡ï¼Œç¬”è€…å†™è¿™ç¯‡åšæ–‡æ—¶å€™ä½¿ç”¨çš„Spring Cloud Gatewayç‰ˆæœ¬ä¸ºGreenwich.SR1ã€‚ ServerHttpResponseæ¥å£ ServerHttpResponseå®ä¾‹æ˜¯ç”¨äºæ‰¿è½½å“åº”ç›¸å…³çš„å±æ€§å’Œå“åº”ä½“ï¼ŒSpring Cloud Gatewayä¸­åº•å±‚ä½¿ç”¨Nettyå¤„ç†ç½‘ç»œè¯·æ±‚ï¼Œé€šè¿‡è¿½æº¯æºç ï¼Œå¯ä»¥ä»ReactorHttpHandlerAdapterä¸­å¾—çŸ¥ServerWebExchangeå®ä¾‹ä¸­æŒæœ‰çš„ServerHttpResponseå®ä¾‹çš„å…·ä½“å®ç°æ˜¯ReactorServerHttpResponseã€‚ä¹‹æ‰€ä»¥åˆ—å‡ºè¿™äº›å®ä¾‹ä¹‹é—´çš„å…³ç³»ï¼Œæ˜¯å› ä¸ºè¿™æ ·æ¯”è¾ƒå®¹æ˜“ç†æ¸…ä¸€äº›éšå«çš„é—®é¢˜ï¼Œä¾‹å¦‚ï¼š 1234567891011121314// ReactorServerHttpResponseçš„çˆ¶ç±»public AbstractServerHttpResponse(DataBufferFactory dataBufferFactory, HttpHeaders headers) &#123; Assert.notNull(dataBufferFactory, \"DataBufferFactory must not be null\"); Assert.notNull(headers, \"HttpHeaders must not be null\"); this.dataBufferFactory = dataBufferFactory; this.headers = headers; this.cookies = new LinkedMultiValueMap&lt;&gt;();&#125;public ReactorServerHttpResponse(HttpServerResponse response, DataBufferFactory bufferFactory) &#123; super(bufferFactory, new HttpHeaders(new NettyHeadersAdapter(response.responseHeaders()))); Assert.notNull(response, \"HttpServerResponse must not be null\"); this.response = response;&#125; å¯çŸ¥ReactorServerHttpResponseæ„é€ å‡½æ•°åˆå§‹åŒ–å®ä¾‹çš„æ—¶å€™ï¼Œå­˜æ”¾å“åº”Headerçš„æ˜¯HttpHeaderså®ä¾‹ï¼Œä¹Ÿå°±æ˜¯å“åº”Headeræ˜¯å¯ä»¥ç›´æ¥ä¿®æ”¹çš„ã€‚ ServerHttpResponseæ¥å£å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142public interface HttpMessage &#123; // è·å–å“åº”Headerï¼Œç›®å‰çš„å®ç°ä¸­è¿”å›çš„æ˜¯HttpHeaderså®ä¾‹ï¼Œå¯ä»¥ç›´æ¥ä¿®æ”¹ HttpHeaders getHeaders();&#125; public interface ReactiveHttpOutputMessage extends HttpMessage &#123; // è·å–DataBufferFactoryå®ä¾‹ï¼Œç”¨äºåŒ…è£…æˆ–è€…ç”Ÿæˆæ•°æ®ç¼“å†²åŒºDataBufferå®ä¾‹(åˆ›å»ºå“åº”ä½“) DataBufferFactory bufferFactory(); // æ³¨å†Œä¸€ä¸ªåŠ¨ä½œï¼Œåœ¨HttpOutputMessageæäº¤ä¹‹å‰æ­¤åŠ¨ä½œä¼šè¿›è¡Œå›è°ƒ void beforeCommit(Supplier&lt;? extends Mono&lt;Void&gt;&gt; action); // åˆ¤æ–­HttpOutputMessageæ˜¯å¦å·²ç»æäº¤ boolean isCommitted(); // å†™å…¥æ¶ˆæ¯ä½“åˆ°HTTPåè®®å±‚ Mono&lt;Void&gt; writeWith(Publisher&lt;? extends DataBuffer&gt; body); // å†™å…¥æ¶ˆæ¯ä½“åˆ°HTTPåè®®å±‚å¹¶ä¸”åˆ·æ–°ç¼“å†²åŒº Mono&lt;Void&gt; writeAndFlushWith(Publisher&lt;? extends Publisher&lt;? extends DataBuffer&gt;&gt; body); // æŒ‡æ˜æ¶ˆæ¯å¤„ç†å·²ç»ç»“æŸï¼Œä¸€èˆ¬åœ¨æ¶ˆæ¯å¤„ç†ç»“æŸè‡ªåŠ¨è°ƒç”¨æ­¤æ–¹æ³•ï¼Œå¤šæ¬¡è°ƒç”¨ä¸ä¼šäº§ç”Ÿå‰¯ä½œç”¨ Mono&lt;Void&gt; setComplete();&#125;public interface ServerHttpResponse extends ReactiveHttpOutputMessage &#123; // è®¾ç½®å“åº”çŠ¶æ€ç  boolean setStatusCode(@Nullable HttpStatus status); // è·å–å“åº”çŠ¶æ€ç  @Nullable HttpStatus getStatusCode(); // è·å–å“åº”Cookieï¼Œå°è£…ä¸ºMultiValueMapå®ä¾‹ï¼Œå¯ä»¥ä¿®æ”¹ MultiValueMap&lt;String, ResponseCookie&gt; getCookies(); // æ·»åŠ å“åº”Cookie void addCookie(ResponseCookie cookie); &#125; è¿™é‡Œå¯ä»¥çœ‹åˆ°é™¤äº†å“åº”ä½“æ¯”è¾ƒéš¾ä¿®æ”¹ä¹‹å¤–ï¼Œå…¶ä»–çš„å±æ€§éƒ½æ˜¯å¯å˜çš„ã€‚ ServerWebExchangeUtilså’Œä¸Šä¸‹æ–‡å±æ€§ ServerWebExchangeUtilsé‡Œé¢å­˜æ”¾äº†å¾ˆå¤šé™æ€å…¬æœ‰çš„å­—ç¬¦ä¸²KEYå€¼(è¿™äº›å­—ç¬¦ä¸²KEYçš„å®é™…å€¼æ˜¯org.springframework.cloud.gateway.support.ServerWebExchangeUtils. + ä¸‹é¢ä»»æ„çš„é™æ€å…¬æœ‰KEY)ï¼Œè¿™äº›å­—ç¬¦ä¸²KEYå€¼ä¸€èˆ¬æ˜¯ç”¨äºServerWebExchangeçš„å±æ€§(Attributeï¼Œè§ä¸Šæ–‡çš„ServerWebExchange#getAttributes()æ–¹æ³•)çš„KEYï¼Œè¿™äº›å±æ€§å€¼éƒ½æ˜¯æœ‰ç‰¹æ®Šçš„å«ä¹‰ï¼Œåœ¨ä½¿ç”¨è¿‡æ»¤å™¨çš„æ—¶å€™å¦‚æœæ—¶æœºé€‚å½“å¯ä»¥ç›´æ¥å–å‡ºæ¥ä½¿ç”¨ï¼Œä¸‹é¢é€ä¸ªåˆ†æã€‚ PRESERVE_HOST_HEADER_ATTRIBUTEï¼šæ˜¯å¦ä¿å­˜Hostå±æ€§ï¼Œå€¼æ˜¯å¸ƒå°”å€¼ç±»å‹ï¼Œå†™å…¥ä½ç½®æ˜¯PreserveHostHeaderGatewayFilterFactoryï¼Œä½¿ç”¨çš„ä½ç½®æ˜¯NettyRoutingFilterï¼Œä½œç”¨æ˜¯å¦‚æœè®¾ç½®ä¸ºtrueï¼ŒHTTPè¯·æ±‚å¤´ä¸­çš„Hostå±æ€§ä¼šå†™åˆ°åº•å±‚Reactor-Nettyçš„è¯·æ±‚Headerå±æ€§ä¸­ã€‚ CLIENT_RESPONSE_ATTRï¼šä¿å­˜åº•å±‚Reactor-Nettyçš„å“åº”å¯¹è±¡ï¼Œç±»å‹æ˜¯reactor.netty.http.client.HttpClientResponseã€‚ CLIENT_RESPONSE_CONN_ATTRï¼šä¿å­˜åº•å±‚Reactor-Nettyçš„è¿æ¥å¯¹è±¡ï¼Œç±»å‹æ˜¯reactor.netty.Connectionã€‚ URI_TEMPLATE_VARIABLES_ATTRIBUTEï¼šPathRoutePredicateFactoryè§£æè·¯å¾„å‚æ•°å®Œæˆä¹‹åï¼ŒæŠŠè§£æå®Œæˆåçš„å ä½ç¬¦KEY-è·¯å¾„Pathæ˜ å°„å­˜æ”¾åœ¨ServerWebExchangeçš„å±æ€§ä¸­ï¼ŒKEYå°±æ˜¯URI_TEMPLATE_VARIABLES_ATTRIBUTEã€‚ CLIENT_RESPONSE_HEADER_NAMESï¼šä¿å­˜åº•å±‚Reactor-Nettyçš„å“åº”Headerçš„åç§°é›†åˆã€‚ GATEWAY_ROUTE_ATTRï¼šç”¨äºå­˜æ”¾RoutePredicateHandlerMappingä¸­åŒ¹é…å‡ºæ¥çš„å…·ä½“çš„è·¯ç”±(org.springframework.cloud.gateway.route.Route)å®ä¾‹ï¼Œé€šè¿‡è¿™ä¸ªè·¯ç”±å®ä¾‹å¯ä»¥å¾—çŸ¥å½“å‰è¯·æ±‚ä¼šè·¯ç”±åˆ°ä¸‹æ¸¸å“ªä¸ªæœåŠ¡ã€‚ GATEWAY_REQUEST_URL_ATTRï¼šjava.net.URIç±»å‹çš„å®ä¾‹ï¼Œè¿™ä¸ªå®ä¾‹ä»£è¡¨ç›´æ¥è¯·æ±‚æˆ–è€…è´Ÿè½½å‡è¡¡å¤„ç†ä¹‹åéœ€è¦è¯·æ±‚åˆ°ä¸‹æ¸¸æœåŠ¡çš„çœŸå®URIã€‚ GATEWAY_ORIGINAL_REQUEST_URL_ATTRï¼šjava.net.URIç±»å‹çš„å®ä¾‹ï¼Œéœ€è¦é‡å†™è¯·æ±‚URIçš„æ—¶å€™ï¼Œä¿å­˜åŸå§‹çš„è¯·æ±‚URIã€‚ GATEWAY_HANDLER_MAPPER_ATTRï¼šä¿å­˜å½“å‰ä½¿ç”¨çš„HandlerMappingå…·ä½“å®ä¾‹çš„ç±»å‹ç®€ç§°(ä¸€èˆ¬æ˜¯å­—ç¬¦ä¸²&quot;RoutePredicateHandlerMapping&quot;)ã€‚ GATEWAY_SCHEME_PREFIX_ATTRï¼šç¡®å®šç›®æ ‡è·¯ç”±URIä¸­å¦‚æœå­˜åœ¨schemeSpecificPartå±æ€§ï¼Œåˆ™ä¿å­˜è¯¥URIçš„schemeåœ¨æ­¤å±æ€§ä¸­ï¼Œè·¯ç”±URIä¼šè¢«é‡æ–°æ„é€ ï¼Œè§RouteToRequestUrlFilterã€‚ GATEWAY_PREDICATE_ROUTE_ATTRï¼šç”¨äºå­˜æ”¾RoutePredicateHandlerMappingä¸­åŒ¹é…å‡ºæ¥çš„å…·ä½“çš„è·¯ç”±(org.springframework.cloud.gateway.route.Route)å®ä¾‹çš„IDã€‚ WEIGHT_ATTRï¼šå®éªŒæ€§åŠŸèƒ½(æ­¤ç‰ˆæœ¬è¿˜ä¸å»ºè®®åœ¨æ­£å¼ç‰ˆæœ¬ä½¿ç”¨)å­˜æ”¾åˆ†ç»„æƒé‡ç›¸å…³å±æ€§ï¼Œè§WeightCalculatorWebFilterã€‚ ORIGINAL_RESPONSE_CONTENT_TYPE_ATTRï¼šå­˜æ”¾å“åº”Headerä¸­çš„ContentTypeçš„å€¼ã€‚ HYSTRIX_EXECUTION_EXCEPTION_ATTRï¼šThrowableçš„å®ä¾‹ï¼Œå­˜æ”¾çš„æ˜¯Hystrixæ‰§è¡Œå¼‚å¸¸æ—¶å€™çš„å¼‚å¸¸å®ä¾‹ï¼Œè§HystrixGatewayFilterFactoryã€‚ GATEWAY_ALREADY_ROUTED_ATTRï¼šå¸ƒå°”å€¼ï¼Œç”¨äºåˆ¤æ–­æ˜¯å¦å·²ç»è¿›è¡Œäº†è·¯ç”±ï¼Œè§NettyRoutingFilterã€‚ GATEWAY_ALREADY_PREFIXED_ATTRï¼šå¸ƒå°”å€¼ï¼Œç”¨äºåˆ¤æ–­è¯·æ±‚è·¯å¾„æ˜¯å¦è¢«æ·»åŠ äº†å‰ç½®éƒ¨åˆ†ï¼Œè§PrefixPathGatewayFilterFactoryã€‚ ServerWebExchangeUtilsæä¾›çš„ä¸Šä¸‹æ–‡å±æ€§ç”¨äºSpring Cloud Gatewayçš„ServerWebExchangeç»„ä»¶å¤„ç†è¯·æ±‚å’Œå“åº”çš„æ—¶å€™ï¼Œå†…éƒ¨ä¸€äº›é‡è¦å®ä¾‹æˆ–è€…æ ‡è¯†å±æ€§çš„å®‰å…¨ä¼ è¾“å’Œä½¿ç”¨ï¼Œä½¿ç”¨å®ƒä»¬å¯èƒ½å­˜åœ¨ä¸€å®šçš„é£é™©ï¼Œå› ä¸ºæ²¡æœ‰äººå¯ä»¥ç¡®å®šåœ¨ç‰ˆæœ¬å‡çº§ä¹‹åï¼ŒåŸæœ‰çš„å±æ€§KEYæˆ–è€…VALUEæ˜¯å¦ä¼šå‘ç”Ÿæ”¹å˜ï¼Œå¦‚æœè¯„ä¼°è¿‡é£é™©æˆ–è€…è§„é¿äº†é£é™©ä¹‹åï¼Œå¯ä»¥å®‰å¿ƒä½¿ç”¨ã€‚ä¾‹å¦‚æˆ‘ä»¬åœ¨åšè¯·æ±‚å’Œå“åº”æ—¥å¿—(ç±»ä¼¼Nginxçš„Access Log)çš„æ—¶å€™ï¼Œå¯ä»¥ä¾èµ–åˆ°GATEWAY_ROUTE_ATTRï¼Œå› ä¸ºæˆ‘ä»¬è¦æ‰“å°è·¯ç”±çš„ç›®æ ‡ä¿¡æ¯ã€‚ä¸¾ä¸ªç®€å•ä¾‹å­ï¼š 1234567891011121314151617181920@Slf4j@Componentpublic class AccessLogFilter implements GlobalFilter &#123; @Override public Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) &#123; ServerHttpRequest request = exchange.getRequest(); String path = request.getPath().pathWithinApplication().value(); HttpMethod method = request.getMethod(); // è·å–è·¯ç”±çš„ç›®æ ‡URI URI targetUri = exchange.getAttribute(ServerWebExchangeUtils.GATEWAY_REQUEST_URL_ATTR); InetSocketAddress remoteAddress = request.getRemoteAddress(); return chain.filter(exchange.mutate().build()).then(Mono.fromRunnable(() -&gt; &#123; ServerHttpResponse response = exchange.getResponse(); HttpStatus statusCode = response.getStatusCode(); log.info(\"è¯·æ±‚è·¯å¾„:&#123;&#125;,å®¢æˆ·ç«¯è¿œç¨‹IPåœ°å€:&#123;&#125;,è¯·æ±‚æ–¹æ³•:&#123;&#125;,ç›®æ ‡URI:&#123;&#125;,å“åº”ç :&#123;&#125;\", path, remoteAddress, method, targetUri, statusCode); &#125;)); &#125;&#125; ä¿®æ”¹è¯·æ±‚ä½“ ä¿®æ”¹è¯·æ±‚ä½“æ˜¯ä¸€ä¸ªæ¯”è¾ƒå¸¸è§çš„éœ€æ±‚ã€‚ä¾‹å¦‚æˆ‘ä»¬ä½¿ç”¨Spring Cloud Gatewayå®ç°ç½‘å…³çš„æ—¶å€™ï¼Œè¦å®ç°ä¸€ä¸ªåŠŸèƒ½ï¼šæŠŠå­˜æ”¾åœ¨è¯·æ±‚å¤´ä¸­çš„JWTè§£æåï¼Œæå–é‡Œé¢çš„ç”¨æˆ·IDï¼Œç„¶åå†™å…¥åˆ°è¯·æ±‚ä½“ä¸­ã€‚æˆ‘ä»¬ç®€åŒ–è¿™ä¸ªåœºæ™¯ï¼Œå‡è®¾æˆ‘ä»¬æŠŠuserIdæ˜æ–‡å­˜æ”¾åœ¨è¯·æ±‚å¤´ä¸­çš„accessTokenä¸­ï¼Œè¯·æ±‚ä½“æ˜¯ä¸€ä¸ªJSONç»“æ„ï¼š 123456&#123; \"serialNumber\": \"è¯·æ±‚æµæ°´å·\", \"payload\" : &#123; // ... è¿™é‡Œæ˜¯æœ‰æ•ˆè½½è·ï¼Œå­˜æ”¾å…·ä½“çš„æ•°æ® &#125;&#125; æˆ‘ä»¬éœ€è¦æå–accessTokenï¼Œä¹Ÿå°±æ˜¯userIdæ’å…¥åˆ°è¯·æ±‚ä½“JSONä¸­å¦‚ä¸‹ï¼š 1234567&#123; \"userId\": \"ç”¨æˆ·ID\", \"serialNumber\": \"è¯·æ±‚æµæ°´å·\", \"payload\" : &#123; // ... è¿™é‡Œæ˜¯æœ‰æ•ˆè½½è·ï¼Œå­˜æ”¾å…·ä½“çš„æ•°æ® &#125;&#125; è¿™é‡Œä¸ºäº†ç®€åŒ–è®¾è®¡ï¼Œç”¨å…¨å±€è¿‡æ»¤å™¨GlobalFilterå®ç°ï¼Œå®é™…éœ€è¦ç»“åˆå…·ä½“åœºæ™¯è€ƒè™‘ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354@Slf4j@Componentpublic class ModifyRequestBodyGlobalFilter implements GlobalFilter &#123; private final DataBufferFactory dataBufferFactory = new NettyDataBufferFactory(ByteBufAllocator.DEFAULT); @Autowired private ObjectMapper objectMapper; @Override public Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) &#123; ServerHttpRequest request = exchange.getRequest(); String accessToken = request.getHeaders().getFirst(\"accessToken\"); if (!StringUtils.hasLength(accessToken)) &#123; throw new IllegalArgumentException(\"accessToken\"); &#125; // æ–°å»ºä¸€ä¸ªServerHttpRequestè£…é¥°å™¨,è¦†ç›–éœ€è¦è£…é¥°çš„æ–¹æ³• ServerHttpRequestDecorator decorator = new ServerHttpRequestDecorator(request) &#123; @Override public Flux&lt;DataBuffer&gt; getBody() &#123; Flux&lt;DataBuffer&gt; body = super.getBody(); InputStreamHolder holder = new InputStreamHolder(); body.subscribe(buffer -&gt; holder.inputStream = buffer.asInputStream()); if (null != holder.inputStream) &#123; try &#123; // è§£æJSONçš„èŠ‚ç‚¹ JsonNode jsonNode = objectMapper.readTree(holder.inputStream); Assert.isTrue(jsonNode instanceof ObjectNode, \"JSONæ ¼å¼å¼‚å¸¸\"); ObjectNode objectNode = (ObjectNode) jsonNode; // JSONèŠ‚ç‚¹æœ€å¤–å±‚å†™å…¥æ–°çš„å±æ€§ objectNode.put(\"userId\", accessToken); DataBuffer dataBuffer = dataBufferFactory.allocateBuffer(); String json = objectNode.toString(); log.info(\"æœ€ç»ˆçš„JSONæ•°æ®ä¸º:&#123;&#125;\", json); dataBuffer.write(json.getBytes(StandardCharsets.UTF_8)); return Flux.just(dataBuffer); &#125; catch (Exception e) &#123; throw new IllegalStateException(e); &#125; &#125; else &#123; return super.getBody(); &#125; &#125; &#125;; // ä½¿ç”¨ä¿®æ”¹åçš„ServerHttpRequestDecoratoré‡æ–°ç”Ÿæˆä¸€ä¸ªæ–°çš„ServerWebExchange return chain.filter(exchange.mutate().request(decorator).build()); &#125; private class InputStreamHolder &#123; InputStream inputStream; &#125;&#125; æµ‹è¯•ä¸€ä¸‹ï¼š 12345678910111213141516171819202122// HTTPPOST /order/json HTTP/1.1Host: localhost:9090Content-Type: application/jsonaccessToken: 10086Accept: */*Cache-Control: no-cacheHost: localhost:9090accept-encoding: gzip, deflatecontent-length: 94Connection: keep-alivecache-control: no-cache&#123; \"serialNumber\": \"è¯·æ±‚æµæ°´å·\", \"payload\": &#123; \"name\": \"doge\" &#125;&#125;// æ—¥å¿—è¾“å‡ºæœ€ç»ˆçš„JSONæ•°æ®ä¸º:&#123;\"serialNumber\":\"è¯·æ±‚æµæ°´å·\",\"payload\":&#123;\"name\":\"doge\"&#125;,\"userId\":\"10086\"&#125; æœ€é‡è¦çš„æ˜¯ç”¨åˆ°äº†ServerHttpRequestè£…é¥°å™¨ServerHttpRequestDecoratorï¼Œä¸»è¦è¦†ç›–å¯¹åº”è·å–è¯·æ±‚ä½“æ•°æ®ç¼“å†²åŒºçš„æ–¹æ³•å³å¯ï¼Œè‡³äºæ€ä¹ˆå¤„ç†å…¶ä»–é€»è¾‘éœ€è¦è‡ªè¡Œè€ƒè™‘ï¼Œè¿™é‡Œåªæ˜¯åšä¸€ä¸ªç®€å•çš„ç¤ºèŒƒã€‚ä¸€èˆ¬çš„ä»£ç é€»è¾‘å¦‚ä¸‹ï¼š 12345678910111213ServerHttpRequest request = exchange.getRequest();ServerHttpRequestDecorator requestDecorator = new ServerHttpRequestDecorator(request) &#123; @Override public Flux&lt;DataBuffer&gt; getBody() &#123; // æ‹¿åˆ°æ‰¿è½½åŸå§‹è¯·æ±‚ä½“çš„Flux Flux&lt;DataBuffer&gt; body = super.getBody(); // è¿™é‡Œé€šè¿‡è‡ªå®šä¹‰æ–¹å¼ç”Ÿæˆæ–°çš„æ‰¿è½½è¯·æ±‚ä½“çš„Flux Flux&lt;DataBuffer&gt; newBody = ... return newBody; &#125; &#125;return chain.filter(exchange.mutate().request(requestDecorator).build()); ä¿®æ”¹å“åº”ä½“ ä¿®æ”¹å“åº”ä½“çš„éœ€æ±‚ä¹Ÿæ˜¯æ¯”è¾ƒå¸¸è§çš„ï¼Œå…·ä½“çš„åšæ³•å’Œä¿®æ”¹è¯·æ±‚ä½“å·®ä¸å¤šã€‚ä¾‹å¦‚æˆ‘ä»¬æƒ³è¦å®ç°ä¸‹é¢çš„åŠŸèƒ½ï¼šç¬¬ä¸‰æ–¹æœåŠ¡è¯·æ±‚ç»è¿‡ç½‘å…³ï¼ŒåŸå§‹æŠ¥æ–‡æ˜¯å¯†æ–‡ï¼Œæˆ‘ä»¬éœ€è¦åœ¨ç½‘å…³å®ç°å¯†æ–‡è§£å¯†ï¼Œç„¶åæŠŠè§£å¯†åçš„æ˜æ–‡è·¯ç”±åˆ°ä¸‹æ¸¸æœåŠ¡ï¼Œä¸‹æ¸¸æœåŠ¡å¤„ç†æˆåŠŸå“åº”æ˜æ–‡ï¼Œéœ€è¦åœ¨ç½‘å…³æŠŠæ˜æ–‡åŠ å¯†æˆå¯†æ–‡å†è¿”å›åˆ°ç¬¬ä¸‰æ–¹æœåŠ¡ã€‚ç°åœ¨ç®€åŒ–æ•´ä¸ªæµç¨‹ï¼Œç”¨AESåŠ å¯†ç®—æ³•ï¼Œç»Ÿä¸€å¯†ç ä¸ºå­—ç¬¦ä¸²&quot;throwable&quot;ï¼Œå‡è®¾è¯·æ±‚æŠ¥æ–‡å’Œå“åº”æŠ¥æ–‡æ˜æ–‡å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425// è¯·æ±‚å¯†æ–‡&#123; \"serialNumber\": \"è¯·æ±‚æµæ°´å·\", \"payload\" : \"åŠ å¯†åçš„è¯·æ±‚æ¶ˆæ¯è½½è·\"&#125;// è¯·æ±‚æ˜æ–‡ï¼ˆä»…ä»…ä½œä¸ºæç¤ºï¼‰&#123; \"serialNumber\": \"è¯·æ±‚æµæ°´å·\", \"payload\" : \"&#123;\\\"name:\\\":\\\"doge\\\"&#125;\"&#125;// å“åº”å¯†æ–‡&#123; \"code\": 200, \"message\":\"ok\", \"payload\" : \"åŠ å¯†åçš„å“åº”æ¶ˆæ¯è½½è·\"&#125;// å“åº”æ˜æ–‡ï¼ˆä»…ä»…ä½œä¸ºæç¤ºï¼‰&#123; \"code\": 200, \"message\":\"ok\", \"payload\" : \"&#123;\\\"name:\\\":\\\"doge\\\",\\\"age\\\":26&#125;\"&#125; ä¸ºäº†æ–¹ä¾¿ä¸€äº›åŠ è§£å¯†æˆ–è€…ç¼–ç è§£ç çš„å®ç°ï¼Œéœ€è¦å¼•å…¥Apacheçš„commons-codecç±»åº“ï¼š 12345&lt;dependency&gt; &lt;groupId&gt;commons-codec&lt;/groupId&gt; &lt;artifactId&gt;commons-codec&lt;/artifactId&gt; &lt;version&gt;1.12&lt;/version&gt;&lt;/dependency&gt; è¿™é‡Œå®šä¹‰ä¸€ä¸ªå…¨å±€è¿‡æ»¤å™¨ä¸“é—¨å¤„ç†åŠ è§£å¯†ï¼Œå®é™…ä¸Šæœ€å¥½ç»“åˆçœŸå®çš„åœºæ™¯å†³å®šæ˜¯å¦é€‚åˆå…¨å±€è¿‡æ»¤å™¨ï¼Œè¿™é‡Œåªæ˜¯ä¸€ä¸ªç¤ºä¾‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169// AESåŠ è§£å¯†å·¥å…·ç±»public enum AesUtils &#123; // å•ä¾‹ X; private static final String PASSWORD = \"throwable\"; private static final String KEY_ALGORITHM = \"AES\"; private static final String SECURE_RANDOM_ALGORITHM = \"SHA1PRNG\"; private static final String DEFAULT_CIPHER_ALGORITHM = \"AES/ECB/PKCS5Padding\"; public String encrypt(String content) &#123; try &#123; Cipher cipher = Cipher.getInstance(DEFAULT_CIPHER_ALGORITHM); cipher.init(Cipher.ENCRYPT_MODE, provideSecretKey()); return Hex.encodeHexString(cipher.doFinal(content.getBytes(StandardCharsets.UTF_8))); &#125; catch (Exception e) &#123; throw new IllegalArgumentException(e); &#125; &#125; public byte[] decrypt(String content) &#123; try &#123; Cipher cipher = Cipher.getInstance(DEFAULT_CIPHER_ALGORITHM); cipher.init(Cipher.DECRYPT_MODE, provideSecretKey()); return cipher.doFinal(Hex.decodeHex(content)); &#125; catch (Exception e) &#123; throw new IllegalArgumentException(e); &#125; &#125; private SecretKey provideSecretKey() &#123; try &#123; KeyGenerator keyGen = KeyGenerator.getInstance(KEY_ALGORITHM); SecureRandom secureRandom = SecureRandom.getInstance(SECURE_RANDOM_ALGORITHM); secureRandom.setSeed(PASSWORD.getBytes(StandardCharsets.UTF_8)); keyGen.init(128, secureRandom); return new SecretKeySpec(keyGen.generateKey().getEncoded(), KEY_ALGORITHM); &#125; catch (Exception e) &#123; throw new IllegalArgumentException(e); &#125; &#125;&#125;// EncryptionGlobalFilter@Slf4j@Componentpublic class EncryptionGlobalFilter implements GlobalFilter, Ordered &#123; @Autowired private ObjectMapper objectMapper; @Override public int getOrder() &#123; return -2; &#125; @Override public Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) &#123; ServerHttpRequest request = exchange.getRequest(); ServerHttpResponse response = exchange.getResponse(); DataBufferFactory bufferFactory = exchange.getResponse().bufferFactory(); ServerHttpRequestDecorator requestDecorator = processRequest(request, bufferFactory); ServerHttpResponseDecorator responseDecorator = processResponse(response, bufferFactory); return chain.filter(exchange.mutate().request(requestDecorator).response(responseDecorator).build()); &#125; private ServerHttpRequestDecorator processRequest(ServerHttpRequest request, DataBufferFactory bufferFactory) &#123; Flux&lt;DataBuffer&gt; body = request.getBody(); DataBufferHolder holder = new DataBufferHolder(); body.subscribe(dataBuffer -&gt; &#123; int len = dataBuffer.readableByteCount(); holder.length = len; byte[] bytes = new byte[len]; dataBuffer.read(bytes); DataBufferUtils.release(dataBuffer); String text = new String(bytes, StandardCharsets.UTF_8); JsonNode jsonNode = readNode(text); JsonNode payload = jsonNode.get(\"payload\"); String payloadText = payload.asText(); byte[] content = AesUtils.X.decrypt(payloadText); String requestBody = new String(content, StandardCharsets.UTF_8); log.info(\"ä¿®æ”¹è¯·æ±‚ä½“payload,ä¿®æ”¹å‰:&#123;&#125;,ä¿®æ”¹å:&#123;&#125;\", payloadText, requestBody); rewritePayloadNode(requestBody, jsonNode); DataBuffer data = bufferFactory.allocateBuffer(); data.write(jsonNode.toString().getBytes(StandardCharsets.UTF_8)); holder.dataBuffer = data; &#125;); HttpHeaders headers = new HttpHeaders(); headers.putAll(request.getHeaders()); headers.remove(HttpHeaders.CONTENT_LENGTH); return new ServerHttpRequestDecorator(request) &#123; @Override public HttpHeaders getHeaders() &#123; int contentLength = holder.length; if (contentLength &gt; 0) &#123; headers.setContentLength(contentLength); &#125; else &#123; headers.set(HttpHeaders.TRANSFER_ENCODING, \"chunked\"); &#125; return headers; &#125; @Override public Flux&lt;DataBuffer&gt; getBody() &#123; return Flux.just(holder.dataBuffer); &#125; &#125;; &#125; private ServerHttpResponseDecorator processResponse(ServerHttpResponse response, DataBufferFactory bufferFactory) &#123; return new ServerHttpResponseDecorator(response) &#123; @SuppressWarnings(\"unchecked\") @Override public Mono&lt;Void&gt; writeWith(Publisher&lt;? extends DataBuffer&gt; body) &#123; if (body instanceof Flux) &#123; Flux&lt;? extends DataBuffer&gt; flux = (Flux&lt;? extends DataBuffer&gt;) body; return super.writeWith(flux.map(buffer -&gt; &#123; CharBuffer charBuffer = StandardCharsets.UTF_8.decode(buffer.asByteBuffer()); DataBufferUtils.release(buffer); JsonNode jsonNode = readNode(charBuffer.toString()); JsonNode payload = jsonNode.get(\"payload\"); String text = payload.toString(); String content = AesUtils.X.encrypt(text); log.info(\"ä¿®æ”¹å“åº”ä½“payload,ä¿®æ”¹å‰:&#123;&#125;,ä¿®æ”¹å:&#123;&#125;\", text, content); setPayloadTextNode(content, jsonNode); return bufferFactory.wrap(jsonNode.toString().getBytes(StandardCharsets.UTF_8)); &#125;)); &#125; return super.writeWith(body); &#125; &#125;; &#125; private void rewritePayloadNode(String text, JsonNode root) &#123; try &#123; JsonNode node = objectMapper.readTree(text); ObjectNode objectNode = (ObjectNode) root; objectNode.set(\"payload\", node); &#125; catch (Exception e) &#123; throw new IllegalStateException(e); &#125; &#125; private void setPayloadTextNode(String text, JsonNode root) &#123; try &#123; ObjectNode objectNode = (ObjectNode) root; objectNode.set(\"payload\", new TextNode(text)); &#125; catch (Exception e) &#123; throw new IllegalStateException(e); &#125; &#125; private JsonNode readNode(String in) &#123; try &#123; return objectMapper.readTree(in); &#125; catch (Exception e) &#123; throw new IllegalStateException(e); &#125; &#125; private class DataBufferHolder &#123; DataBuffer dataBuffer; int length; &#125;&#125; å…ˆå‡†å¤‡ä¸€ä»½å¯†æ–‡ï¼š 12345678Map&lt;String, Object&gt; json = new HashMap&lt;&gt;(8);json.put(\"serialNumber\", \"è¯·æ±‚æµæ°´å·\");String content = \"&#123;\\\"name\\\": \\\"doge\\\"&#125;\";json.put(\"payload\", AesUtils.X.encrypt(content));System.out.println(new ObjectMapper().writeValueAsString(json));// è¾“å‡º&#123;\"serialNumber\":\"è¯·æ±‚æµæ°´å·\",\"payload\":\"144e3dc734743f5709f1adf857bca473da683246fd612f86ac70edeb5f2d2729\"&#125; æ¨¡æ‹Ÿè¯·æ±‚ï¼š 12345678910111213141516171819202122232425POST /order/json HTTP/1.1Host: localhost:9090accessToken: 10086Content-Type: application/jsonUser-Agent: PostmanRuntime/7.13.0Accept: */*Cache-Control: no-cachePostman-Token: bda07fc3-ea1a-478c-b4d7-754fe6f37200,634734d9-feed-4fc9-ba20-7618bd986e1cHost: localhost:9090cookie: customCookieName=customCookieValueaccept-encoding: gzip, deflatecontent-length: 104Connection: keep-alivecache-control: no-cache&#123; \"serialNumber\": \"è¯·æ±‚æµæ°´å·\", \"payload\": \"FE49xzR0P1cJ8a34V7ykc9poMkb9YS+GrHDt618tJyk=\"&#125;// å“åº”ç»“æœ&#123; \"serialNumber\": \"è¯·æ±‚æµæ°´å·\", \"payload\": \"oo/K1igg2t/S8EExkBVGWOfI1gAh5pBpZ0wyjNPW6e8=\" # &lt;--- è§£å¯†åï¼š&#123;\"name\":\"doge\",\"age\":26&#125;&#125; é‡åˆ°çš„é—®é¢˜ï¼š å¿…é¡»å®ç°Orderedæ¥å£ï¼Œè¿”å›ä¸€ä¸ªå°äº-1çš„orderå€¼ï¼Œè¿™æ˜¯å› ä¸ºNettyWriteResponseFilterçš„orderå€¼ä¸º-1ï¼Œæˆ‘ä»¬éœ€è¦è¦†ç›–è¿”å›å“åº”ä½“çš„é€»è¾‘ï¼Œè‡ªå®šä¹‰çš„GlobalFilterå¿…é¡»æ¯”NettyWriteResponseFilterä¼˜å…ˆæ‰§è¡Œã€‚ ç½‘å…³æ¯æ¬¡é‡å¯ä¹‹åï¼Œç¬¬ä¸€ä¸ªè¯·æ±‚æ€»æ˜¯æ— æ³•ä»åŸå§‹çš„ServerHttpRequestè¯»å–åˆ°æœ‰æ•ˆçš„Bodyï¼Œå‡†ç¡®æ¥è¯´å‡ºç°çš„ç°è±¡æ˜¯NettyRoutingFilterè°ƒç”¨ServerHttpRequest#getBody()çš„æ—¶å€™è·å–åˆ°ä¸€ä¸ªç©ºçš„å¯¹è±¡ï¼Œå¯¼è‡´ç©ºæŒ‡é’ˆï¼›å¥‡æ€ªçš„æ˜¯ä»ç¬¬äºŒä¸ªè¯·æ±‚å¼€å§‹å°±èƒ½æ­£å¸¸è°ƒç”¨ã€‚ç¬”è€…æŠŠSpring Cloud Gatewayçš„ç‰ˆæœ¬é™ä½åˆ°Finchley.SR3ï¼ŒSpring Bootçš„ç‰ˆæœ¬é™ä½åˆ°2.0.8.RELEASEï¼Œé—®é¢˜ä¸å†å‡ºç°ï¼Œåˆæ­¥ç¡®å®šæ˜¯Spring Cloud Gatewayç‰ˆæœ¬å‡çº§å¯¼è‡´çš„å…¼å®¹æ€§é—®é¢˜æˆ–è€…æ˜¯BUGã€‚ æœ€é‡è¦çš„æ˜¯ç”¨åˆ°äº†ServerHttpResponseè£…é¥°å™¨ServerHttpResponseDecoratorï¼Œä¸»è¦è¦†ç›–å†™å…¥å“åº”ä½“æ•°æ®ç¼“å†²åŒºçš„éƒ¨åˆ†ï¼Œè‡³äºæ€ä¹ˆå¤„ç†å…¶ä»–é€»è¾‘éœ€è¦è‡ªè¡Œè€ƒè™‘ï¼Œè¿™é‡Œåªæ˜¯åšä¸€ä¸ªç®€å•çš„ç¤ºèŒƒã€‚ä¸€èˆ¬çš„ä»£ç é€»è¾‘å¦‚ä¸‹ï¼š 1234567891011121314151617ServerHttpResponse response = exchange.getResponse();ServerHttpResponseDecorator responseDecorator = new ServerHttpResponseDecorator(response) &#123; @Override public Mono&lt;Void&gt; writeWith(Publisher&lt;? extends DataBuffer&gt; body) &#123; if (body instanceof Flux) &#123; Flux&lt;? extends DataBuffer&gt; flux = (Flux&lt;? extends DataBuffer&gt;) body; return super.writeWith(flux.map(buffer -&gt; &#123; // bufferå°±æ˜¯åŸå§‹çš„å“åº”æ•°æ®çš„ç¼“å†²åŒº // ä¸‹é¢å¤„ç†å®Œæ¯•ä¹‹åè¿”å›æ–°çš„å“åº”æ•°æ®çš„ç¼“å†²åŒºå³å¯ return bufferFactory.wrap(...); &#125;)); &#125; return super.writeWith(body); &#125; &#125;;return chain.filter(exchange.mutate().response(responseDecorator).build()); è¯·æ±‚ä½“æˆ–è€…å“åº”ä½“æŠ¥æ–‡è¿‡å¤§çš„é—®é¢˜ æœ‰çƒ­å¿ƒçš„åŒå­¦å‘Šè¯‰ç¬”è€…ï¼Œå¦‚æœè¯·æ±‚æŠ¥æ–‡è¿‡å¤§æˆ–è€…å“åº”æŠ¥æ–‡è¿‡å¤§çš„æ—¶å€™ï¼Œå‰é¢ä¸¤èŠ‚çš„ä¿®æ”¹è¯·æ±‚å’Œå“åº”æŠ¥æ–‡çš„æ–¹æ³•ä¼šå‡ºç°é—®é¢˜ï¼Œè¿™é‡Œå°è¯•é‡ç°ä¸€ä¸‹é‡åˆ°çš„å…·ä½“é—®é¢˜ã€‚å…ˆæŠŠè¯·æ±‚æŠ¥æ–‡å°è¯•åŠ é•¿ï¼š 123456789101112131415Map&lt;String, Object&gt; json = new HashMap&lt;&gt;(8);json.put(\"serialNumber\", \"è¯·æ±‚æµæ°´å·\");StringBuilder builder = new StringBuilder();for (int i = 0; i &lt; 1000; i++) &#123; builder.append(\"doge\");&#125;String content = String.format(\"&#123;\\\"name\\\": \\\"%s\\\"&#125;\", builder.toString());json.put(\"payload\", AesUtils.X.encrypt(content));System.out.println(new ObjectMapper().writeValueAsString(json));// è¯·æ±‚çš„JSONæŠ¥æ–‡å¦‚ä¸‹ï¼š&#123; \"serialNumber\": \"è¯·æ±‚æµæ°´å·\", \"payload\": \"0Dcf2plFpESprKjkdqNHM8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/zyJ4ipyLGvo5LX87d9oDAs=\"&#125; ç”¨ä¸Šé¢çš„è¯·æ±‚æŠ¥æ–‡å‘èµ·è¯·æ±‚ï¼Œç¡®å®å­˜åœ¨é—®é¢˜ï¼š ä¸»è¦é—®é¢˜æ˜¯ï¼š è¯·æ±‚ä½“åŒ…æ•°æ®è£…æˆçš„Flux&lt;DataBuffer&gt;å®ä¾‹è¢«è®¢é˜…ä¹‹åï¼Œè¯»å–åˆ°çš„å­—èŠ‚æ•°ç»„çš„é•¿åº¦è¢«æˆªæ–­äº†ï¼Œæä¾›çš„åŸå§‹è¯·æ±‚æŠ¥æ–‡é‡Œé¢å­—ç¬¦ä¸²é•¿åº¦è¦å¤§äº1000ï¼Œè½¬æ¢æˆbyteæ•°ç»„ç»å¯¹è¦å¤§äº1000ï¼Œä½†æ˜¯ä¸Šé¢çš„ç¤ºä¾‹ä¸­åªè¯»å–åˆ°é•¿åº¦ä¸º673çš„byteæ•°ç»„ã€‚ è¯»å–åˆ°çš„å­—èŠ‚æ•°ç»„è¢«æˆªæ–­åï¼Œåˆ™ä½¿ç”¨Jacksonè¿›è¡Œååºåˆ—åŒ–çš„æ—¶å€™æç¤ºæ²¡æœ‰è¯»å–åˆ°å­—ç¬¦ä¸²çš„EOFæ ‡è¯†ï¼Œå¯¼è‡´ååºåˆ—åŒ–å¤±è´¥ã€‚ æ—¢ç„¶é‡åˆ°äº†é—®é¢˜ï¼Œå°±æƒ³åŠæ³•è§£å†³ã€‚é¦–å…ˆç¬¬ä¸€æ­¥å®šä½ä¸€ä¸‹æ˜¯ä»€ä¹ˆåŸå› ï¼Œç›´è§‰å‘Šè¯‰ç¬”è€…ï¼šè¦å¼€å¯ä¸€ä¸‹DEBUGæ—¥å¿—è¿›è¡Œè§‚å¯Ÿï¼Œå¦‚æœè¿˜æ²¡æœ‰å¤´ç»ªå¯èƒ½è¦è·Ÿè¸ªä¸€ä¸‹æºç ã€‚ å¼€å¯DEBUGæ—¥å¿—çº§åˆ«ä¹‹ååšä¸€æ¬¡è¯·æ±‚ï¼Œå‘ç°äº†ä¸€äº›å¯ç–‘çš„æ—¥å¿—ä¿¡æ¯ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273742019-05-19 11:16:15.660 [reactor-http-nio-2] DEBUG reactor.ipc.netty.http.server.HttpServer - [id: 0xa9b527e5, L:/0:0:0:0:0:0:0:1:9090 - R:/0:0:0:0:0:0:0:1:58012] READ COMPLETE2019-05-19 11:16:15.660 [reactor-http-nio-2] DEBUG reactor.ipc.netty.http.server.HttpServer - [id: 0xa9b527e5, L:/0:0:0:0:0:0:0:1:9090 ! R:/0:0:0:0:0:0:0:1:58012] INACTIVE2019-05-19 11:16:15.660 [reactor-http-nio-3] DEBUG reactor.ipc.netty.http.server.HttpServer - [id: 0x5554e091, L:/0:0:0:0:0:0:0:1:9090 - R:/0:0:0:0:0:0:0:1:58013] READ: 1024B +-------------------------------------------------+ | 0 1 2 3 4 5 6 7 8 9 a b c d e f |+--------+-------------------------------------------------+----------------+|00000000| 50 4f 53 54 20 2f 6f 72 64 65 72 2f 6a 73 6f 6e |POST /order/json||00000010| 20 48 54 54 50 2f 31 2e 31 0d 0a 61 63 63 65 73 | HTTP/1.1..acces||00000020| 73 54 6f 6b 65 6e 3a 20 31 30 30 38 36 0d 0a 43 |sToken: 10086..C||00000030| 6f 6e 74 65 6e 74 2d 54 79 70 65 3a 20 61 70 70 |ontent-Type: app||00000040| 6c 69 63 61 74 69 6f 6e 2f 6a 73 6f 6e 0d 0a 55 |lication/json..U||00000050| 73 65 72 2d 41 67 65 6e 74 3a 20 50 6f 73 74 6d |ser-Agent: Postm||00000060| 61 6e 52 75 6e 74 69 6d 65 2f 37 2e 31 33 2e 30 |anRuntime/7.13.0||00000070| 0d 0a 41 63 63 65 70 74 3a 20 2a 2f 2a 0d 0a 43 |..Accept: */*..C||00000080| 61 63 68 65 2d 43 6f 6e 74 72 6f 6c 3a 20 6e 6f |ache-Control: no||00000090| 2d 63 61 63 68 65 0d 0a 50 6f 73 74 6d 61 6e 2d |-cache..Postman-||000000a0| 54 6f 6b 65 6e 3a 20 31 31 32 30 38 64 35 39 2d |Token: 11208d59-||000000b0| 65 61 34 61 2d 34 62 39 63 2d 61 30 33 39 2d 30 |ea4a-4b9c-a039-0||000000c0| 30 65 36 64 38 61 30 65 33 65 66 0d 0a 48 6f 73 |0e6d8a0e3ef..Hos||000000d0| 74 3a 20 6c 6f 63 61 6c 68 6f 73 74 3a 39 30 39 |t: localhost:909||000000e0| 30 0d 0a 63 6f 6f 6b 69 65 3a 20 63 75 73 74 6f |0..cookie: custo||000000f0| 6d 43 6f 6f 6b 69 65 4e 61 6d 65 3d 63 75 73 74 |mCookieName=cust||00000100| 6f 6d 43 6f 6f 6b 69 65 56 61 6c 75 65 0d 0a 61 |omCookieValue..a||00000110| 63 63 65 70 74 2d 65 6e 63 6f 64 69 6e 67 3a 20 |ccept-encoding: ||00000120| 67 7a 69 70 2c 20 64 65 66 6c 61 74 65 0d 0a 63 |gzip, deflate..c||00000130| 6f 6e 74 65 6e 74 2d 6c 65 6e 67 74 68 3a 20 35 |ontent-length: 5||00000140| 34 31 36 0d 0a 43 6f 6e 6e 65 63 74 69 6f 6e 3a |416..Connection:||00000150| 20 6b 65 65 70 2d 61 6c 69 76 65 0d 0a 0d 0a 7b | keep-alive....&#123;||00000160| 0a 20 20 20 20 22 73 65 72 69 61 6c 4e 75 6d 62 |. \"serialNumb||00000170| 65 72 22 3a 20 22 e8 af b7 e6 b1 82 e6 b5 81 e6 |er\": \"..........||00000180| b0 b4 e5 8f b7 22 2c 0a 20 20 20 20 22 70 61 79 |.....\",. \"pay||00000190| 6c 6f 61 64 22 3a 20 22 30 44 63 66 32 70 6c 46 |load\": \"0Dcf2plF||000001a0| 70 45 53 70 72 4b 6a 6b 64 71 4e 48 4d 38 6a 6a |pESprKjkdqNHM8jj||000001b0| 49 41 72 6b 64 37 58 57 35 4c 6c 32 2f 71 61 42 |IArkd7XW5Ll2/qaB||000001c0| 71 76 2f 49 34 79 41 4b 35 48 65 31 31 75 53 35 |qv/I4yAK5He11uS5||000001d0| 64 76 36 6d 67 61 72 2f 79 4f 4d 67 43 75 52 33 |dv6mgar/yOMgCuR3||000001e0| 74 64 62 6b 75 58 62 2b 70 6f 47 71 2f 38 6a 6a |tdbkuXb+poGq/8jj||000001f0| 49 41 72 6b 64 37 58 57 35 4c 6c 32 2f 71 61 42 |IArkd7XW5Ll2/qaB||00000200| 71 76 2f 49 34 79 41 4b 35 48 65 31 31 75 53 35 |qv/I4yAK5He11uS5||00000210| 64 76 36 6d 67 61 72 2f 79 4f 4d 67 43 75 52 33 |dv6mgar/yOMgCuR3||00000220| 74 64 62 6b 75 58 62 2b 70 6f 47 71 2f 38 6a 6a |tdbkuXb+poGq/8jj||00000230| 49 41 72 6b 64 37 58 57 35 4c 6c 32 2f 71 61 42 |IArkd7XW5Ll2/qaB||00000240| 71 76 2f 49 34 79 41 4b 35 48 65 31 31 75 53 35 |qv/I4yAK5He11uS5||00000250| 64 76 36 6d 67 61 72 2f 79 4f 4d 67 43 75 52 33 |dv6mgar/yOMgCuR3||00000260| 74 64 62 6b 75 58 62 2b 70 6f 47 71 2f 38 6a 6a |tdbkuXb+poGq/8jj||00000270| 49 41 72 6b 64 37 58 57 35 4c 6c 32 2f 71 61 42 |IArkd7XW5Ll2/qaB||00000280| 71 76 2f 49 34 79 41 4b 35 48 65 31 31 75 53 35 |qv/I4yAK5He11uS5||00000290| 64 76 36 6d 67 61 72 2f 79 4f 4d 67 43 75 52 33 |dv6mgar/yOMgCuR3||000002a0| 74 64 62 6b 75 58 62 2b 70 6f 47 71 2f 38 6a 6a |tdbkuXb+poGq/8jj||000002b0| 49 41 72 6b 64 37 58 57 35 4c 6c 32 2f 71 61 42 |IArkd7XW5Ll2/qaB||000002c0| 71 76 2f 49 34 79 41 4b 35 48 65 31 31 75 53 35 |qv/I4yAK5He11uS5||000002d0| 64 76 36 6d 67 61 72 2f 79 4f 4d 67 43 75 52 33 |dv6mgar/yOMgCuR3||000002e0| 74 64 62 6b 75 58 62 2b 70 6f 47 71 2f 38 6a 6a |tdbkuXb+poGq/8jj||000002f0| 49 41 72 6b 64 37 58 57 35 4c 6c 32 2f 71 61 42 |IArkd7XW5Ll2/qaB||00000300| 71 76 2f 49 34 79 41 4b 35 48 65 31 31 75 53 35 |qv/I4yAK5He11uS5||00000310| 64 76 36 6d 67 61 72 2f 79 4f 4d 67 43 75 52 33 |dv6mgar/yOMgCuR3||00000320| 74 64 62 6b 75 58 62 2b 70 6f 47 71 2f 38 6a 6a |tdbkuXb+poGq/8jj||00000330| 49 41 72 6b 64 37 58 57 35 4c 6c 32 2f 71 61 42 |IArkd7XW5Ll2/qaB||00000340| 71 76 2f 49 34 79 41 4b 35 48 65 31 31 75 53 35 |qv/I4yAK5He11uS5||00000350| 64 76 36 6d 67 61 72 2f 79 4f 4d 67 43 75 52 33 |dv6mgar/yOMgCuR3||00000360| 74 64 62 6b 75 58 62 2b 70 6f 47 71 2f 38 6a 6a |tdbkuXb+poGq/8jj||00000370| 49 41 72 6b 64 37 58 57 35 4c 6c 32 2f 71 61 42 |IArkd7XW5Ll2/qaB||00000380| 71 76 2f 49 34 79 41 4b 35 48 65 31 31 75 53 35 |qv/I4yAK5He11uS5||00000390| 64 76 36 6d 67 61 72 2f 79 4f 4d 67 43 75 52 33 |dv6mgar/yOMgCuR3||000003a0| 74 64 62 6b 75 58 62 2b 70 6f 47 71 2f 38 6a 6a |tdbkuXb+poGq/8jj||000003b0| 49 41 72 6b 64 37 58 57 35 4c 6c 32 2f 71 61 42 |IArkd7XW5Ll2/qaB||000003c0| 71 76 2f 49 34 79 41 4b 35 48 65 31 31 75 53 35 |qv/I4yAK5He11uS5||000003d0| 64 76 36 6d 67 61 72 2f 79 4f 4d 67 43 75 52 33 |dv6mgar/yOMgCuR3||000003e0| 74 64 62 6b 75 58 62 2b 70 6f 47 71 2f 38 6a 6a |tdbkuXb+poGq/8jj||000003f0| 49 41 72 6b 64 37 58 57 35 4c 6c 32 2f 71 61 42 |IArkd7XW5Ll2/qaB|+--------+-------------------------------------------------+----------------+2019-05-19 11:16:15.662 [reactor-http-nio-2] DEBUG reactor.ipc.netty.http.server.HttpServer - [id: 0xa9b527e5, L:/0:0:0:0:0:0:0:1:9090 ! R:/0:0:0:0:0:0:0:1:58012] UNREGISTERED2019-05-19 11:16:15.665 [reactor-http-nio-3] DEBUG reactor.ipc.netty.http.server.HttpServerOperations - [id: 0x5554e091, L:/0:0:0:0:0:0:0:1:9090 - R:/0:0:0:0:0:0:0:1:58013] Increasing pending responses, now 12019-05-19 11:16:15.671 [reactor-http-nio-3] DEBUG reactor.ipc.netty.http.server.HttpServer - [id: 0x5554e091, L:/0:0:0:0:0:0:0:1:9090 - R:/0:0:0:0:0:0:0:1:58013] READ COMPLETE æ³¨æ„ä¸€ä¸‹å…³é”®å­—READ: 1024Bï¼Œè¿™é‡Œåº”è¯¥æ˜¯åº•å±‚çš„Reactor-Nettyè¯»å–çš„æœ€å¤§æ•°æ®æŠ¥çš„é•¿åº¦é™åˆ¶ï¼Œæ‰“å°å‡ºæ¥çš„æ•°æ®æŠ¥åˆšå¥½ä¹Ÿæ˜¯1024Bçš„å¤§å°ï¼Œè¿™ä¸ªåº”è¯¥å°±æ˜¯å¯¼è‡´è¯·æ±‚ä½“è¢«æˆªæ–­çš„æ ¹æœ¬åŸå› ï¼›è¿™ä¸ªé—®é¢˜ä¸å•å•ä¼šå‡ºç°åœ¨è¯·æ±‚ä½“çš„è·å–ï¼Œä¹Ÿä¼šå‡ºç°åœ¨å“åº”ä½“çš„å†™å…¥ã€‚æ—¢ç„¶è¿™ä¸ªæ˜¯å…±æ€§çš„é—®é¢˜ï¼Œé‚£ä¹ˆé¡¹ç›®Githubä¸Šè‚¯å®šæœ‰å¯¹åº”çš„Issueï¼Œæ‰¾åˆ°ä¸€ä¸ªäº’åŠ¨æ¯”è¾ƒé•¿çš„gateway request size limit 1024B because netty default limit 1024,how to solve it? #581ï¼Œä»å›ç­”æ¥çœ‹ï¼Œå®˜æ–¹å»ºè®®ä½¿ç”¨ModifyRequestBodyGatewayFilterFactoryå’ŒModifyResponseBodyGatewayFilterFactoryå®Œæˆå¯¹åº”çš„åŠŸèƒ½ã€‚è¿™é‡Œå¯ä»¥å°è¯•å€Ÿé‰´ä¸€ä¸‹ModifyRequestBodyGatewayFilterFactoryçš„å®ç°æ–¹å¼ä¿®æ”¹ä¹‹å‰çš„ä»£ç ï¼Œå› ä¸ºä»£ç çš„é€»è¾‘æ¯”è¾ƒé•¿å’Œå¤æ‚ï¼Œè§£å¯†è¯·æ±‚ä½“çš„è¿‡æ»¤å™¨æ‹†åˆ†åˆ°æ–°çš„ç±»RequestEncryptionGlobalFilterï¼ŒåŠ å¯†å“åº”ä½“çš„è¿‡æ»¤å™¨æ‹†åˆ†åˆ°ResponseDecryptionGlobalFilterï¼š RequestEncryptionGlobalFilterçš„ä»£ç å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106@Slf4j@Componentpublic class RequestEncryptionGlobalFilter implements GlobalFilter, Ordered &#123; @Autowired private ObjectMapper objectMapper; private final List&lt;HttpMessageReader&lt;?&gt;&gt; messageReaders = HandlerStrategies.withDefaults().messageReaders(); @Override public int getOrder() &#123; return -2; &#125; @Override public Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) &#123; return processRequest(exchange, chain); &#125; private Mono&lt;Void&gt; processRequest(ServerWebExchange exchange, GatewayFilterChain chain) &#123; ServerRequest serverRequest = new DefaultServerRequest(exchange, messageReaders); DataBufferFactory bufferFactory = exchange.getResponse().bufferFactory(); Mono&lt;String&gt; rawBody = serverRequest.bodyToMono(String.class).map(s -&gt; s); BodyInserter&lt;Mono&lt;String&gt;, ReactiveHttpOutputMessage&gt; bodyInserter = BodyInserters.fromPublisher(rawBody, String.class); HttpHeaders tempHeaders = new HttpHeaders(); tempHeaders.putAll(exchange.getRequest().getHeaders()); tempHeaders.remove(HttpHeaders.CONTENT_LENGTH); CachedBodyOutputMessage outputMessage = new CachedBodyOutputMessage(exchange, tempHeaders); return bodyInserter.insert(outputMessage, new BodyInserterContext()).then(Mono.defer(() -&gt; &#123; Flux&lt;DataBuffer&gt; body = outputMessage.getBody(); DataBufferHolder holder = new DataBufferHolder(); body.subscribe(dataBuffer -&gt; &#123; int len = dataBuffer.readableByteCount(); holder.length = len; byte[] bytes = new byte[len]; dataBuffer.read(bytes); DataBufferUtils.release(dataBuffer); String text = new String(bytes, StandardCharsets.UTF_8); JsonNode jsonNode = readNode(text); JsonNode payload = jsonNode.get(\"payload\"); String payloadText = payload.asText(); byte[] content = AesUtils.X.decrypt(payloadText); String requestBody = new String(content, StandardCharsets.UTF_8); log.info(\"ä¿®æ”¹è¯·æ±‚ä½“payload,ä¿®æ”¹å‰:&#123;&#125;,ä¿®æ”¹å:&#123;&#125;\", payloadText, requestBody); rewritePayloadNode(requestBody, jsonNode); DataBuffer data = bufferFactory.allocateBuffer(); data.write(jsonNode.toString().getBytes(StandardCharsets.UTF_8)); holder.dataBuffer = data; &#125;); ServerHttpRequestDecorator requestDecorator = new ServerHttpRequestDecorator(exchange.getRequest()) &#123; @Override public HttpHeaders getHeaders() &#123; long contentLength = tempHeaders.getContentLength(); HttpHeaders httpHeaders = new HttpHeaders(); httpHeaders.putAll(super.getHeaders()); if (contentLength &gt; 0) &#123; httpHeaders.setContentLength(contentLength); &#125; else &#123; httpHeaders.set(HttpHeaders.TRANSFER_ENCODING, \"chunked\"); &#125; return httpHeaders; &#125; @Override public Flux&lt;DataBuffer&gt; getBody() &#123; return Flux.just(holder.dataBuffer); &#125; &#125;; return chain.filter(exchange.mutate().request(requestDecorator).build()); &#125;)); &#125; private void rewritePayloadNode(String text, JsonNode root) &#123; try &#123; JsonNode node = objectMapper.readTree(text); ObjectNode objectNode = (ObjectNode) root; objectNode.set(\"payload\", node); &#125; catch (Exception e) &#123; throw new IllegalStateException(e); &#125; &#125; private void setPayloadTextNode(String text, JsonNode root) &#123; try &#123; ObjectNode objectNode = (ObjectNode) root; objectNode.set(\"payload\", new TextNode(text)); &#125; catch (Exception e) &#123; throw new IllegalStateException(e); &#125; &#125; private JsonNode readNode(String in) &#123; try &#123; return objectMapper.readTree(in); &#125; catch (Exception e) &#123; throw new IllegalStateException(e); &#125; &#125; private class DataBufferHolder &#123; DataBuffer dataBuffer; int length; &#125;&#125; ResponseDecryptionGlobalFilterçš„ä»£ç å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113@Slf4j@Componentpublic class ResponseDecryptionGlobalFilter implements GlobalFilter, Ordered &#123; @Autowired private ObjectMapper objectMapper; @Override public int getOrder() &#123; return NettyWriteResponseFilter.WRITE_RESPONSE_FILTER_ORDER - 1; &#125; @Override public Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) &#123; return processResponse(exchange, chain); &#125; private Mono&lt;Void&gt; processResponse(ServerWebExchange exchange, GatewayFilterChain chain) &#123; ServerHttpResponseDecorator responseDecorator = new ServerHttpResponseDecorator(exchange.getResponse()) &#123; @Override public Mono&lt;Void&gt; writeWith(Publisher&lt;? extends DataBuffer&gt; body) &#123; String originalResponseContentType = exchange.getAttribute(ORIGINAL_RESPONSE_CONTENT_TYPE_ATTR); HttpHeaders httpHeaders = new HttpHeaders(); httpHeaders.add(HttpHeaders.CONTENT_TYPE, originalResponseContentType); ResponseAdapter responseAdapter = new ResponseAdapter(body, httpHeaders); DefaultClientResponse clientResponse = new DefaultClientResponse(responseAdapter, ExchangeStrategies.withDefaults()); Mono&lt;String&gt; rawBody = clientResponse.bodyToMono(String.class).map(s -&gt; s); BodyInserter&lt;Mono&lt;String&gt;, ReactiveHttpOutputMessage&gt; bodyInserter = BodyInserters.fromPublisher(rawBody, String.class); CachedBodyOutputMessage outputMessage = new CachedBodyOutputMessage(exchange, exchange.getResponse().getHeaders()); return bodyInserter.insert(outputMessage, new BodyInserterContext()) .then(Mono.defer(() -&gt; &#123; Flux&lt;DataBuffer&gt; messageBody = outputMessage.getBody(); Flux&lt;DataBuffer&gt; flux = messageBody.map(buffer -&gt; &#123; CharBuffer charBuffer = StandardCharsets.UTF_8.decode(buffer.asByteBuffer()); DataBufferUtils.release(buffer); JsonNode jsonNode = readNode(charBuffer.toString()); JsonNode payload = jsonNode.get(\"payload\"); String text = payload.toString(); String content = AesUtils.X.encrypt(text); log.info(\"ä¿®æ”¹å“åº”ä½“payload,ä¿®æ”¹å‰:&#123;&#125;,ä¿®æ”¹å:&#123;&#125;\", text, content); setPayloadTextNode(content, jsonNode); return getDelegate().bufferFactory().wrap(jsonNode.toString().getBytes(StandardCharsets.UTF_8)); &#125;); HttpHeaders headers = getDelegate().getHeaders(); if (!headers.containsKey(HttpHeaders.TRANSFER_ENCODING)) &#123; flux = flux.doOnNext(data -&gt; headers.setContentLength(data.readableByteCount())); &#125; return getDelegate().writeWith(flux); &#125;)); &#125; &#125;; return chain.filter(exchange.mutate().response(responseDecorator).build()); &#125; private void setPayloadTextNode(String text, JsonNode root) &#123; try &#123; ObjectNode objectNode = (ObjectNode) root; objectNode.set(\"payload\", new TextNode(text)); &#125; catch (Exception e) &#123; throw new IllegalStateException(e); &#125; &#125; private JsonNode readNode(String in) &#123; try &#123; return objectMapper.readTree(in); &#125; catch (Exception e) &#123; throw new IllegalStateException(e); &#125; &#125; private class ResponseAdapter implements ClientHttpResponse &#123; private final Flux&lt;DataBuffer&gt; flux; private final HttpHeaders headers; @SuppressWarnings(\"unchecked\") private ResponseAdapter(Publisher&lt;? extends DataBuffer&gt; body, HttpHeaders headers) &#123; this.headers = headers; if (body instanceof Flux) &#123; flux = (Flux) body; &#125; else &#123; flux = ((Mono) body).flux(); &#125; &#125; @Override public Flux&lt;DataBuffer&gt; getBody() &#123; return flux; &#125; @Override public HttpHeaders getHeaders() &#123; return headers; &#125; @Override public HttpStatus getStatusCode() &#123; return null; &#125; @Override public int getRawStatusCode() &#123; return 0; &#125; @Override public MultiValueMap&lt;String, ResponseCookie&gt; getCookies() &#123; return null; &#125; &#125;&#125; æ¨¡æ‹Ÿè¯·æ±‚ï¼š 12345678910111213141516171819202122POST /order/json HTTP/1.1Host: localhost:9090accessToken: 10086Content-Type: application/jsonUser-Agent: PostmanRuntime/7.13.0Accept: */*Cache-Control: no-cachePostman-Token: 3a830202-f3d1-450e-839f-ae8f3b88bced,b229feb1-7c8b-4d25-a039-09345f3fe8f0Host: localhost:9090cookie: customCookieName=customCookieValueaccept-encoding: gzip, deflatecontent-length: 5416Connection: keep-alivecache-control: no-cache&#123; \"serialNumber\": \"è¯·æ±‚æµæ°´å·\", \"payload\": \"0Dcf2plFpESprKjkdqNHM8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/8jjIArkd7XW5Ll2/qaBqv/I4yAK5He11uS5dv6mgar/yOMgCuR3tdbkuXb+poGq/zyJ4ipyLGvo5LX87d9oDAs=\"&#125;// å“åº”&#123;\"serialNumber\":\"è¯·æ±‚æµæ°´å·\",\"userId\":null,\"payload\":\"7S2VqLu4J6LdW0As50JgZ0eFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+DkeFFoe2FbWytaYdpr2HPg5HhRaHthW1srWmHaa9hz4OR4UWh7YVtbK1ph2mvYc+Dm8rTVHylECORYnLNgnfWx0ENJ9a6E+abYhyFJ9zSIda\"&#125; å½»åº•è§£å†³äº†ä¹‹å‰çš„è¯·æ±‚æˆ–è€…å“åº”æŠ¥æ–‡æˆªæ–­çš„é—®é¢˜ï¼Œç¬”è€…å‘ç°äº†å¾ˆå¤šåšæ–‡éƒ½åœ¨(ç…§æ¬)æ›´æ”¹è¯»å–DataBufferå®ä¾‹æ—¶å€™çš„ä»£ç é€»è¾‘ï¼Œå…¶å®é‚£æ®µé€»è¾‘æ˜¯ä¸ç›¸å…³çš„ï¼Œå¯ä»¥å°è¯•ç”¨BufferedReaderåŸºäºè¡Œè¯»å–ç„¶åç”¨StringBuilderæ‰¿è½½ï¼Œæˆ–è€…åƒæœ¬æ–‡é‚£æ ·ç›´æ¥è¯»å–ä¸ºbyteæ•°ç»„ç­‰ç­‰ï¼Œå› ä¸ºæ ¹æœ¬çš„åŸå› æ˜¯åº•å±‚çš„Reactor-Nettyçš„æ•°æ®å—è¯»å–å¤§å°é™åˆ¶å¯¼è‡´è·å–åˆ°çš„DataBufferå®ä¾‹é‡Œé¢çš„æ•°æ®æ˜¯ä¸å®Œæ•´çš„ï¼Œè§£å†³æ–¹æ¡ˆå°±æ˜¯å‚ç…§Spring Cloud Gatewayæœ¬èº«æä¾›çš„åŸºç¡€ç±»åº“è¿›è¡Œæ”¹é€ (æš‚æ—¶æ²¡å‘ç°æœ‰å…¥å£å¯ä»¥è°ƒæ•´Reactor-Nettyçš„é…ç½®)ï¼Œéš¾åº¦ä¹Ÿä¸å¤§ã€‚ å°ç»“ åˆšå¥½é‡åˆ°ä¸€ä¸ªéœ€æ±‚éœ€è¦åšç½‘å…³çš„åŠ è§£å¯†åŒ…æ‹¬è¯·æ±‚ä½“å’Œå“åº”ä½“çš„ä¿®æ”¹ï¼Œè¿™é‡Œé¡ºä¾¿æŠŠSpring Cloud Gatewayä¸€äº›æ¶‰åŠåˆ°è¿™æ–¹é¢çš„ä¸€äº›å†…å®¹æ¢³ç†äº†ä¸€éï¼Œé¡ºä¾¿æŠŠå‘è¸©äº†å¹¶ä¸”å¡«å®Œã€‚ä¸‹ä¸€æ­¥å°è¯•æŒ‰ç…§ç›®å‰å®˜æ–¹æä¾›çš„å¯ç”¨ç»„ä»¶ä¿®æ”¹ä¸€ä¸‹å®ç°è‡ªå®šä¹‰çš„é€»è¾‘ï¼ŒåŒ…æ‹¬Hystrixã€åŸºäºEurekaå’ŒRibbonçš„è´Ÿè½½å‡è¡¡ã€é™æµç­‰ç­‰ã€‚ (æœ¬æ–‡å®Œ c-6-d e-a-20190518 r-a-20190519)","categories":[{"name":"Spring Cloud","slug":"Spring-Cloud","permalink":"http://throwable.club/blog/categories/Spring-Cloud/"},{"name":"Spring Cloud Gateway","slug":"Spring-Cloud/Spring-Cloud-Gateway","permalink":"http://throwable.club/blog/categories/Spring-Cloud/Spring-Cloud-Gateway/"}],"tags":[{"name":"Spring Cloud Gateway","slug":"Spring-Cloud-Gateway","permalink":"http://throwable.club/blog/tags/Spring-Cloud-Gateway/"},{"name":"Spring Cloud","slug":"Spring-Cloud","permalink":"http://throwable.club/blog/tags/Spring-Cloud/"}]},{"title":"ä¸€æ¬¡MySQLæ­»é”é—®é¢˜çš„æ’æŸ¥ä¸åˆ†æ(ä¸€)","slug":"mysql-deadlock-troubleshoot-1st","date":"2019-05-11T14:02:25.000Z","updated":"2019-06-02T02:13:30.413Z","comments":true,"path":"2019/05/11/mysql-deadlock-troubleshoot-1st/","link":"","permalink":"http://throwable.club/2019/05/11/mysql-deadlock-troubleshoot-1st/","excerpt":"å‰æ ç¬”è€…è´Ÿè´£çš„ä¸€ä¸ªç³»ç»Ÿæœ€è¿‘æœ‰æ–°åŠŸèƒ½ä¸Šçº¿åçªç„¶åœ¨é¢„è­¦æ¨¡å—ä¸å®šæ—¶æŠ¥å‡ºMySQLæ­»é”å¯¼è‡´äº‹åŠ¡å›æ»šã€‚å¹¸äºï¼Œä¸Šæ¸¸ç³»ç»Ÿé‡‡ç”¨äº†å¼‚æ­¥æ¨é€å’ŒåŒæ­¥æŸ¥è¯¢ç»“åˆçš„æ–¹å¼ï¼Œæ„ŸçŸ¥åˆ°æ¨é€å¤±è´¥åŠæ—¶è¿›è¡Œäº†è¡¥å¿ã€‚äºæ˜¯ï¼Œç¬”è€…äº‰å–äº†ä¸€ç‚¹æ—¶é—´è¯¦ç»†åˆ†æäº†å¯¼è‡´æ­»é”çš„å¤šä¸ªäº‹åŠ¡çš„æ‰§è¡Œæ—¶åºï¼Œåˆ†æå¹¶ä¸”å¾—å‡ºè§£å†³æ–¹æ¡ˆã€‚","text":"å‰æ ç¬”è€…è´Ÿè´£çš„ä¸€ä¸ªç³»ç»Ÿæœ€è¿‘æœ‰æ–°åŠŸèƒ½ä¸Šçº¿åçªç„¶åœ¨é¢„è­¦æ¨¡å—ä¸å®šæ—¶æŠ¥å‡ºMySQLæ­»é”å¯¼è‡´äº‹åŠ¡å›æ»šã€‚å¹¸äºï¼Œä¸Šæ¸¸ç³»ç»Ÿé‡‡ç”¨äº†å¼‚æ­¥æ¨é€å’ŒåŒæ­¥æŸ¥è¯¢ç»“åˆçš„æ–¹å¼ï¼Œæ„ŸçŸ¥åˆ°æ¨é€å¤±è´¥åŠæ—¶è¿›è¡Œäº†è¡¥å¿ã€‚äºæ˜¯ï¼Œç¬”è€…äº‰å–äº†ä¸€ç‚¹æ—¶é—´è¯¦ç»†åˆ†æäº†å¯¼è‡´æ­»é”çš„å¤šä¸ªäº‹åŠ¡çš„æ‰§è¡Œæ—¶åºï¼Œåˆ†æå¹¶ä¸”å¾—å‡ºè§£å†³æ–¹æ¡ˆã€‚ æ­»é”åœºæ™¯å¤ç° é¦–å…ˆï¼ŒMySQLçš„æœåŠ¡ç«¯ç‰ˆæœ¬æ˜¯5.7(å°ç‰ˆæœ¬å¯ä»¥åŸºæœ¬å¿½ç•¥)ï¼Œä½¿ç”¨äº†InnoDBã€‚æœ‰ä¸€å¼ ç”¨æˆ·æ•°æ®è¡¨çš„schemaè®¾è®¡å¦‚ä¸‹ï¼ˆæ— å…³å­—æ®µå·²ç»å±è”½æ‰ï¼‰ï¼š 12345678CREATE TABLE `t_user_data`( id BIGINT UNSIGNED PRIMARY KEY AUTO_INCREMENT, user_id BIGINT UNSIGNED NOT NULL COMMENT 'ç”¨æˆ·ID', data_id VARCHAR(50) NOT NULL COMMENT 'æ•°æ®ID', INDEX idx_user_id (user_id), INDEX idx_data_id (data_id)) COMMENT 'ç”¨æˆ·æ•°æ®è¡¨'; ä¸šåŠ¡ä»£ç ä¸­å‘ç”Ÿæ­»é”çš„ä¼ªä»£ç å¦‚ä¸‹ï¼š 12345678process_method(dataId,userDataDtoList)&#123; start transaction: userDataDao.deleteByDataId(dataId); for dto in userDataDtoList: UserData userData = convert(dto); userDataDao.insert(dto); commit;&#125; è¿™é‡Œçš„é€»è¾‘æ˜¯ï¼Œå¦‚æœå·²ç»å­˜åœ¨å¯¹åº”dataIdçš„æ•°æ®è¦å…ˆè¿›è¡Œåˆ é™¤ï¼Œç„¶åå†™å…¥æ–°çš„ç”¨æˆ·æ•°æ®ã€‚ å°è¯•ç”¨ä¸¤ä¸ªSessionæäº¤ä¸¤ä¸ªäº‹åŠ¡é‡ç°æ­»é”é—®é¢˜ï¼š æ—¶é—´åºåˆ— Tx-Session-1 Tx-Session-2 T1 START TRANSACTION; T2 START TRANSACTION; T3 DELETE FROM t_user_data WHERE data_id = â€˜xxxxxâ€™; T4 DELETE FROM t_user_data WHERE data_id = â€˜yyyyyâ€™; T5 INSERT INTO t_user_data(USER_ID, DATA_ID) VALUES (1, â€˜xxxxxâ€™); T6 INSERT INTO t_user_data(USER_ID, DATA_ID) VALUES (2, â€˜yyyyyâ€™); T7 Deadlock found when trying to get lock; try restarting transaction(Rollback) T8 COMMIT; è¿™é‡Œä¼šå‡ºç°ä¸¤ä¸ªç°è±¡ï¼š Tx-Session-2ä¼šè¯T4æ‰§è¡Œå®Œæ¯•ä¹‹åï¼ŒTx-Session-1ä¼šè¯T5æ‰§è¡Œçš„æ—¶å€™ï¼ŒTx-Session-1ä¼šè¯å®¢æˆ·ç«¯ä¼šå¤„äºé˜»å¡çŠ¶æ€ã€‚ Tx-Session-2ä¼šè¯T6æ‰§è¡Œå®Œæ¯•ä¹‹åï¼ŒMySQLæç¤ºæ­»é”äº‹åŠ¡è¢«å›æ»šï¼Œæ­¤æ—¶ï¼ŒTx-Session-1ä¼šè¯å®¢æˆ·ç«¯ä¼šè§£é™¤é˜»å¡ã€‚ å¯¼è‡´æ­»é”çš„åŸå›  åé¢ä¼šå†™ä¸€ç¯‡ä¸“é—¨çš„æ–‡ç« å­¦ä¹ å’Œç†è§£MySQLçš„InnoDBæ•°æ®å¼•æ“çš„é”ç›¸å…³çŸ¥è¯†ï¼Œè¿™é‡Œç›´æ¥æ’æŸ¥InnoDBçš„æ­»é”æ—¥å¿—ã€‚ 1mysql&gt; show engine innodb status; è¾“å‡ºçš„æ­»é”æ—¥å¿—å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132------------------------LATEST DETECTED DEADLOCK------------------------2019-05-11 19:16:04 0x5804*** (1) TRANSACTION:TRANSACTION 3882, ACTIVE 13 sec insertingmysql tables in use 1, locked 1LOCK WAIT 3 lock struct(s), heap size 1136, 2 row lock(s), undo log entries 1MySQL thread id 32, OS thread handle 9876, query id 358 localhost ::1 doge updateINSERT INTO t_user_data(USER_ID, DATA_ID) VALUES (1, 'xxxxx')*** (1) WAITING FOR THIS LOCK TO BE GRANTED:RECORD LOCKS space id 33 page no 6 n bits 72 index idx_data_id of table `test`.`t_user_data` trx id 3882 lock_mode X insert intention waitingRecord lock, heap no 1 PHYSICAL RECORD: n_fields 1; compact format; info bits 0 0: len 8; hex 73757072656d756d; asc supremum;;*** (2) TRANSACTION:TRANSACTION 3883, ACTIVE 9 sec inserting, thread declared inside InnoDB 5000mysql tables in use 1, locked 13 lock struct(s), heap size 1136, 2 row lock(s), undo log entries 1MySQL thread id 11, OS thread handle 22532, query id 359 localhost ::1 doge updateINSERT INTO t_user_data(USER_ID, DATA_ID) VALUES (2, 'yyyyy')*** (2) HOLDS THE LOCK(S):RECORD LOCKS space id 33 page no 6 n bits 72 index idx_data_id of table `test`.`t_user_data` trx id 3883 lock_mode XRecord lock, heap no 1 PHYSICAL RECORD: n_fields 1; compact format; info bits 0 0: len 8; hex 73757072656d756d; asc supremum;;*** (2) WAITING FOR THIS LOCK TO BE GRANTED:RECORD LOCKS space id 33 page no 6 n bits 72 index idx_data_id of table `test`.`t_user_data` trx id 3883 lock_mode X insert intention waitingRecord lock, heap no 1 PHYSICAL RECORD: n_fields 1; compact format; info bits 0 0: len 8; hex 73757072656d756d; asc supremum;;*** WE ROLL BACK TRANSACTION (2) è¿™é‡Œè¦å‚è€ƒMySQLå…³äºInnoDBé”çš„å…³äºnext-keyé”æè¿°é‚£ä¸€èŠ‚ï¼Œæ³¨æ„æ­»é”æ—¥å¿—å…³é”®å­—supremumçš„æ„ä¹‰ï¼š next-keyé”å°†gapé”å®šåœ¨ç´¢å¼•ä¸­æœ€å¤§å€¼ä¹‹ä¸Šï¼Œè€Œsupremumä¼ªè®°å½•çš„å€¼é«˜äºç´¢å¼•ä¸­å®é™…çš„ä»»ä½•å€¼ã€‚supremumä¸æ˜¯çœŸæ­£çš„ç´¢å¼•è®°å½•ï¼Œå› æ­¤ï¼Œå®é™…ä¸Šï¼Œæ­¤next-keyé”ä»…é”å®šæœ€å¤§ç´¢å¼•å€¼ä¹‹åçš„é—´éš™ã€‚ ä¸¤ä¸ªäº‹åŠ¡çš„é”å±æ€§å¯ä»¥é€šè¿‡select * from information_schema.innodb_locks;è¿›è¡ŒæŸ¥è¯¢ï¼Œæ•°æ®å¦‚ä¸‹è¡¨ï¼š lock_id lock_tx_id lock_mode lock_type lock_table lock_index lock_space lock_page lock_rec lock_data 3882:33:6:1 3882 X RECORD test.t_user_data idx_data_id 33 6 1 supremum pseudo-record 3883:33:6:1 3883 X RECORD test.t_user_data idx_data_id 33 6 1 supremum pseudo-record 1DELETE FROM t_user_data WHERE data_id = 'ä¸å­˜åœ¨çš„ç´¢å¼•å€¼'; ä¸Šé¢çš„SQLæ‰§è¡Œæ—¶å€™ï¼Œå¦‚æœæ¡ä»¶åˆšå¥½æ˜¯ç´¢å¼•åˆ—ï¼Œå¹¶ä¸”æŸ¥è¯¢çš„å€¼æ˜¯å½“å‰è¡¨(ç´¢å¼•)ä¸­ä¸å­˜åœ¨çš„æ•°æ®ï¼Œæ ¹æ®next-keyé”çš„æè¿°å’Œæ­»é”æ—¥å¿—ä¸­çš„asc supremumå…³é”®å­—ï¼Œæ‰§è¡Œè¯¥DELETEè¯­å¥çš„æ—¶å€™ï¼Œä¼šé”å®šç›®æ ‡å€¼å’Œé«˜äºç›®æ ‡å€¼çš„ä»»ä½•å€¼ï¼Œå¦‚æœæ¡ä»¶æ˜¯&quot;xxxxx&quot;ï¼Œé‚£ä¹ˆç›¸å½“äºé”å®šåŒºé—´ä¸º(â€œxxxxxâ€,æœ€å¤§ä¸Šç•Œ]ã€‚ next-keyé”æ˜¯ç´¢å¼•è®°å½•ä¸Šçš„è®°å½•é”(Record Lock)å’Œç´¢å¼•è®°å½•ä¹‹å‰çš„é—´éš™ä¸Šçš„é—´éš™é”(Gap Lock)å®šçš„ç»„åˆã€‚é—´éš™é”æœ‰ä¸¤ä¸ªç‰¹ç‚¹ï¼š ä¸¤ä¸ªäº‹åŠ¡å³ä½¿é”å®šçš„åŒºé—´ä¸€è‡´ï¼ˆæˆ–è€…æœ‰éƒ¨åˆ†é‡åˆï¼‰ï¼Œä¸ä¼šå½±å“å®ƒä»¬ä¹‹é—´è·å–åˆ°é”ï¼ˆå¯ä»¥å‚è€ƒè¡Œé”çš„å…¼å®¹æ€§çŸ©é˜µï¼‰ã€‚ é—´éš™é”Gä¼šé˜»æ­¢éæŒæœ‰Gçš„å…¶ä»–äº‹åŠ¡å‘é”å®šçš„åŒºé—´ä¸­æ’å…¥æ•°æ®ï¼Œä»¥é¿å…äº§ç”Ÿå†²çªæ•°æ®ã€‚ åˆ†æåˆ°è¿™é‡Œï¼Œå°±å¾ˆå¥½è§£é‡Šä¸Šé¢å‡ºç°æ­»é”çš„æ‰§è¡Œæ—¶åºï¼š ä¸¤ä¸ªäº‹åŠ¡çš„DELETEè¯­å¥éƒ½å¯ä»¥æ­£ç¡®æ‰§è¡Œï¼Œè¿™ä¸ªæ—¶å€™ï¼Œä¸¤è€…çš„é—´éš™é”é”å®šçš„åŒºåŸŸåˆ†åˆ«æ˜¯(â€˜xxxxxâ€™,æœ€å¤§ä¸Šç•Œ]å’Œ(â€˜yyyyyâ€™,æœ€å¤§ä¸Šç•Œ]ã€‚ äº‹åŠ¡1æ‰§è¡ŒINSERTè¯­å¥çš„æ—¶å€™é˜»å¡ï¼Œæ˜¯å› ä¸ºäº‹åŠ¡2çš„é—´éš™é”ä¸å…è®¸äº‹åŠ¡1æ’å…¥ç´¢å¼•å€¼â€™xxxxxâ€™ã€‚ äº‹åŠ¡2æ‰§è¡ŒINSERTè¯­å¥çš„æ—¶å€™é˜»å¡ï¼Œæ˜¯å› ä¸ºäº‹åŠ¡1çš„é—´éš™é”ä¸å…è®¸äº‹åŠ¡1æ’å…¥ç´¢å¼•å€¼â€™yyyyyâ€™ï¼Œæ‰§è¡Œåˆ°è¿™ä¸€æ­¥ï¼ŒMySQLçš„æ­»é”æ£€æŸ¥æ¨¡å—åº”è¯¥èµ·æ•ˆäº†ï¼Œå› ä¸ºä¸¤ä¸ªäº‹åŠ¡ä¾èµ–çš„é”èµ„æºå·²ç»æˆç¯(æˆ–è€…æˆæœ‰å‘å›¾)ã€‚ äº‹åŠ¡2çš„ä¼˜å…ˆçº§æ¯”è¾ƒä½ï¼Œäºæ˜¯æŠ›å‡ºæ­»é”å¼‚å¸¸å¹¶ä¸”è¢«å›æ»šäº†ã€‚ ä¹‹å‰æ›¾ç»å’ŒDBAåŒäº‹èŠè¿‡ï¼Œå‘ç”Ÿæ­»é”çš„äº‹åŠ¡æ˜¯æ€ä¹ˆè¡¡é‡ä¼˜å…ˆçº§æˆ–è€…æ€ä¹ˆç¡®å®šå“ªä¸ªäº‹åŠ¡éœ€è¦å›æ»š(é‡Šæ”¾é”èµ„æºè®©å¦ä¸€ä¸ªäº‹åŠ¡å¯ä»¥æ­£å¸¸æäº¤)ï¼Œä½†æ˜¯åæ¥æ²¡æœ‰æ”¶åˆ°å¾ˆå¥½çš„ç­”å¤ï¼Œè¿™ä¸€ç‚¹æœ‰æ—¶é—´å†ç ”ç©¶ä¸€ä¸‹ã€‚ è§£å†³æ–¹æ¡ˆ å‚è€ƒMySQLçš„æ–‡æ¡£ï¼Œè§£å†³æ–¹æ¡ˆæœ‰ä¸¤ä¸ªï¼š æ–¹æ¡ˆä¸€ï¼šé™ä½æ•°æ®åº“çš„äº‹åŠ¡éš”ç¦»çº§åˆ«ï¼Œéœ€è¦é™ä½åˆ°READ COMMITEDï¼Œè¿™æ ·å­å¯ä»¥å…³é—­é—´éš™é”çš„æ‰«æã€‚ï¼ˆ&lt;== å¹¶ä¸æ¨èè¿™ç§åšæ³•ï¼Œä¿®æ”¹äº‹åŠ¡éš”ç¦»çº§åˆ«æœ‰å¯èƒ½å‡ºç°æ–°çš„é—®é¢˜ï¼‰ æ–¹æ¡ˆäºŒï¼šé’ˆå¯¹å¯¹åº”çš„åŸå› ä¿®æ”¹ä¸šåŠ¡ä»£ç ã€‚ è¿™é‡Œæ–¹æ¡ˆäºŒåªéœ€è¦æŠŠä¼ªä»£ç é€»è¾‘ä¿®æ”¹å¦‚ä¸‹ï¼š 1234567891011process_method(dataId,userDataDtoList)&#123; List&lt;UserData&gt; userDataList = userDataDao.selectByDataId(dataId); start transaction: if userDataList is not empty: List&lt;Long&gt; ids = collectIdList(userDataList); userDataDao.deleteByIds(ids); for dto in userDataDtoList: UserData userData = convert(dto); userDataDao.insert(dto); commit;&#125; å°±æ˜¯å…ˆæ ¹æ®dataIdè¿›è¡ŒæŸ¥è¯¢ï¼Œå¦‚æœå­˜åœ¨æ•°æ®ï¼Œèšåˆä¸»é”®åˆ—è¡¨ï¼Œé€šè¿‡ä¸»é”®åˆ—è¡¨è¿›è¡Œåˆ é™¤ï¼Œç„¶åå†è¿›è¡Œæ•°æ®æ’å…¥ã€‚ å°ç»“ è¿™å¹¶éæ˜¯ç¬¬ä¸€æ¬¡åœ¨ç”Ÿäº§ç¯å¢ƒä¸­å‡ºç°MySQLæ­»é”ï¼Œåªæ˜¯è¿™æ¬¡çš„æ¡ˆä¾‹ç›¸å¯¹ç®€å•ã€‚InnoDBæä¾›çš„æ­»é”æ—¥å¿—å…¶å®å¹¶æ²¡æœ‰æä¾›å®Œæ•´çš„äº‹åŠ¡æäº¤çš„SQLï¼Œæ‰€ä»¥å¯¹äºå¤æ‚çš„åœºæ™¯éœ€è¦ç»†è‡´ç»“åˆä»£ç å’Œæ­»é”æ—¥å¿—è¿›è¡Œæ’æŸ¥ï¼Œå¾ˆå¤šæ—¶å€™å¯¹åº”çš„ä»£ç é€»è¾‘æ˜¯å¤šå¤„çš„ã€‚è¿™é‡Œåˆ—ä¸¾ä¸€ä¸‹ç¬”è€…å¤„ç†æ­»é”é—®é¢˜çš„ä¸€äº›æ­¥éª¤ï¼š åŠæ—¶æ­¢æŸï¼Œå¦‚æœå¯ä»¥å›æ»šå¯¼è‡´æ­»é”çš„ä»£ç ï¼Œé‚£ä¹ˆæœ€å¥½æœæ•¢åœ°å›æ»šï¼›å¦‚æœé‡è¯•å¯ä»¥è§£å†³é—®é¢˜å¹¶ä¸”å‡ºç°æ­»é”é—®é¢˜çš„è§„æ¨¡ä¸å¤§ï¼Œå¯ä»¥å°è¯•çŸ­æ—¶é—´å†…è¿›è¡Œé—®é¢˜æ’æŸ¥ã€‚ é€šè¿‡ä¸šåŠ¡ç³»ç»Ÿæ—¥å¿—è¿…é€Ÿå®šä½åˆ°å‘ç”Ÿæ­»é”çš„ä»£ç å—ï¼ŒJVMåº”ç”¨ä¸€èˆ¬åº•å±‚æ˜¯ä¾èµ–JDBCï¼Œå‡ºç°æ­»é”çš„æ—¶å€™ä¼šæŠ›å‡ºä¸€ä¸ªSQLExceptionçš„å­ç±»ï¼Œå¼‚å¸¸æ ˆçš„ä¿¡æ¯ä¸­å¸¦æœ‰&quot;Deadlock&quot;å­—æ ·ã€‚ åˆ†æInnoDBçš„æ­»é”æ—¥å¿—ï¼Œä¸€èˆ¬ä¼šåˆ—å‡ºç«äº‰é”çš„å¤šä¸ªäº‹åŠ¡çš„ç›¸å¯¹è¯¦ç»†çš„ä¿¡æ¯ï¼Œè¿™äº›ä¿¡æ¯æ˜¯æ’æŸ¥æ­»é”é—®é¢˜çš„ç¬¬ä¸€æ‰‹èµ„æ–™ã€‚ ä¿®å¤é—®é¢˜ä¸Šçº¿åæ³¨æ„åšå¥½ç›‘æ§å’Œé¢„è­¦ï¼Œç¡®å®šé—®é¢˜å½»åº•è§£å†³ã€‚ å‚è€ƒèµ„æ–™ï¼š MySQL5.7å®˜æ–¹æ–‡æ¡£ (æœ¬æ–‡å®Œ c-1-d e-a-20190511)","categories":[{"name":"MySQL","slug":"MySQL","permalink":"http://throwable.club/blog/categories/MySQL/"}],"tags":[{"name":"MySQL","slug":"MySQL","permalink":"http://throwable.club/blog/tags/MySQL/"}]},{"title":"Spring Cloud Gateway-è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†","slug":"spring-cloud-gateway-custom-exception-handler","date":"2019-05-11T06:26:48.000Z","updated":"2019-06-02T02:19:32.216Z","comments":true,"path":"2019/05/11/spring-cloud-gateway-custom-exception-handler/","link":"","permalink":"http://throwable.club/2019/05/11/spring-cloud-gateway-custom-exception-handler/","excerpt":"å‰æ æˆ‘ä»¬å¹³æ—¶åœ¨ç”¨SpringMVCçš„æ—¶å€™ï¼Œåªè¦æ˜¯ç»è¿‡DispatcherServletå¤„ç†çš„è¯·æ±‚ï¼Œå¯ä»¥é€šè¿‡@ControllerAdviceå’Œ@ExceptionHandlerè‡ªå®šä¹‰ä¸åŒç±»å‹å¼‚å¸¸çš„å¤„ç†é€»è¾‘ï¼Œå…·ä½“å¯ä»¥å‚è€ƒResponseEntityExceptionHandlerå’ŒDefaultHandlerExceptionResolverï¼Œåº•å±‚åŸç†å¾ˆç®€å•ï¼Œå°±æ˜¯å‘ç”Ÿå¼‚å¸¸çš„æ—¶å€™æœç´¢å®¹å™¨ä¸­å·²ç»å­˜åœ¨çš„å¼‚å¸¸å¤„ç†å™¨å¹¶ä¸”åŒ¹é…å¯¹åº”çš„å¼‚å¸¸ç±»å‹ï¼ŒåŒ¹é…æˆåŠŸä¹‹åä½¿ç”¨è¯¥æŒ‡å®šçš„å¼‚å¸¸å¤„ç†å™¨è¿”å›ç»“æœè¿›è¡ŒResponseçš„æ¸²æŸ“ï¼Œå¦‚æœæ‰¾ä¸åˆ°é»˜è®¤çš„å¼‚å¸¸å¤„ç†å™¨åˆ™ç”¨é»˜è®¤çš„è¿›è¡Œå…œåº•(ä¸ªäººè®¤ä¸ºï¼ŒSpringåœ¨å¾ˆå¤šåŠŸèƒ½è®¾è®¡çš„æ—¶å€™éƒ½æœ‰è¿™ç§â€œæœ‰åˆ™ä½¿ç”¨è‡ªå®šä¹‰ï¼Œæ— åˆ™ä½¿ç”¨é»˜è®¤æä¾›â€è¿™ç§æ€æƒ³ååˆ†ä¼˜é›…)ã€‚ SpringMVCä¸­æä¾›çš„è‡ªå®šä¹‰å¼‚å¸¸ä½“ç³»åœ¨Spring-WebFluxä¸­å¹¶ä¸é€‚ç”¨ï¼Œå…¶å®åŸå› å¾ˆç®€å•ï¼Œä¸¤è€…åº•å±‚çš„è¿è¡Œå®¹å™¨å¹¶ä¸ç›¸åŒã€‚WebExceptionHandleræ˜¯Spring-WebFluxçš„å¼‚å¸¸å¤„ç†å™¨é¡¶å±‚æ¥å£ï¼Œå› æ­¤è¿½æº¯åˆ°å­ç±»å¯ä»¥è¿½è¸ªåˆ°DefaultErrorWebExceptionHandleræ˜¯Spring Cloud Gatewayçš„å…¨å±€å¼‚å¸¸å¤„ç†å™¨ï¼Œé…ç½®ç±»æ˜¯ErrorWebFluxAutoConfigurationã€‚","text":"å‰æ æˆ‘ä»¬å¹³æ—¶åœ¨ç”¨SpringMVCçš„æ—¶å€™ï¼Œåªè¦æ˜¯ç»è¿‡DispatcherServletå¤„ç†çš„è¯·æ±‚ï¼Œå¯ä»¥é€šè¿‡@ControllerAdviceå’Œ@ExceptionHandlerè‡ªå®šä¹‰ä¸åŒç±»å‹å¼‚å¸¸çš„å¤„ç†é€»è¾‘ï¼Œå…·ä½“å¯ä»¥å‚è€ƒResponseEntityExceptionHandlerå’ŒDefaultHandlerExceptionResolverï¼Œåº•å±‚åŸç†å¾ˆç®€å•ï¼Œå°±æ˜¯å‘ç”Ÿå¼‚å¸¸çš„æ—¶å€™æœç´¢å®¹å™¨ä¸­å·²ç»å­˜åœ¨çš„å¼‚å¸¸å¤„ç†å™¨å¹¶ä¸”åŒ¹é…å¯¹åº”çš„å¼‚å¸¸ç±»å‹ï¼ŒåŒ¹é…æˆåŠŸä¹‹åä½¿ç”¨è¯¥æŒ‡å®šçš„å¼‚å¸¸å¤„ç†å™¨è¿”å›ç»“æœè¿›è¡ŒResponseçš„æ¸²æŸ“ï¼Œå¦‚æœæ‰¾ä¸åˆ°é»˜è®¤çš„å¼‚å¸¸å¤„ç†å™¨åˆ™ç”¨é»˜è®¤çš„è¿›è¡Œå…œåº•(ä¸ªäººè®¤ä¸ºï¼ŒSpringåœ¨å¾ˆå¤šåŠŸèƒ½è®¾è®¡çš„æ—¶å€™éƒ½æœ‰è¿™ç§â€œæœ‰åˆ™ä½¿ç”¨è‡ªå®šä¹‰ï¼Œæ— åˆ™ä½¿ç”¨é»˜è®¤æä¾›â€è¿™ç§æ€æƒ³ååˆ†ä¼˜é›…)ã€‚ SpringMVCä¸­æä¾›çš„è‡ªå®šä¹‰å¼‚å¸¸ä½“ç³»åœ¨Spring-WebFluxä¸­å¹¶ä¸é€‚ç”¨ï¼Œå…¶å®åŸå› å¾ˆç®€å•ï¼Œä¸¤è€…åº•å±‚çš„è¿è¡Œå®¹å™¨å¹¶ä¸ç›¸åŒã€‚WebExceptionHandleræ˜¯Spring-WebFluxçš„å¼‚å¸¸å¤„ç†å™¨é¡¶å±‚æ¥å£ï¼Œå› æ­¤è¿½æº¯åˆ°å­ç±»å¯ä»¥è¿½è¸ªåˆ°DefaultErrorWebExceptionHandleræ˜¯Spring Cloud Gatewayçš„å…¨å±€å¼‚å¸¸å¤„ç†å™¨ï¼Œé…ç½®ç±»æ˜¯ErrorWebFluxAutoConfigurationã€‚ ä¸ºä»€ä¹ˆè¦è‡ªå®šä¹‰å¼‚å¸¸å¤„ç† å…ˆç”»ä¸€ä¸ªå‡æƒ³ä½†æ˜¯è´´è¿‘å®é™…æ¶æ„å›¾ï¼Œå®šä½ä¸€ä¸‹ç½‘å…³çš„ä½œç”¨ï¼š ç½‘å…³åœ¨æ•´ä¸ªæ¶æ„ä¸­çš„ä½œç”¨æ˜¯ï¼š è·¯ç”±æœåŠ¡ç«¯åº”ç”¨çš„è¯·æ±‚åˆ°åç«¯åº”ç”¨ã€‚ (èšåˆ)åç«¯åº”ç”¨çš„å“åº”è½¬å‘åˆ°æœåŠ¡ç«¯åº”ç”¨ã€‚ å‡è®¾ç½‘å…³æœåŠ¡æ€»æ˜¯æ­£å¸¸çš„å‰æä¸‹ï¼š å¯¹äºç¬¬1ç‚¹æ¥è¯´ï¼Œå‡è®¾åç«¯åº”ç”¨ä¸èƒ½å¹³æ»‘æ— æŸä¸Šçº¿ï¼Œä¼šæœ‰ä¸€å®šçš„å‡ ç‡å‡ºç°ç½‘å…³è·¯ç”±è¯·æ±‚åˆ°ä¸€äº›åç«¯çš„â€œåƒµå°¸èŠ‚ç‚¹(è¯·æ±‚è·¯ç”±è¿‡å»çš„æ—¶å€™ï¼Œåº”ç”¨æ›´å¥½åœ¨é‡å¯æˆ–è€…åˆšå¥½åœæ­¢)â€ï¼Œè¿™ä¸ªæ—¶å€™ä¼šè·¯ç”±ä¼šå¤±è´¥æŠ›å‡ºå¼‚å¸¸ï¼Œä¸€èˆ¬æƒ…å†µæ˜¯Connection Refuseã€‚ å¯¹äºç¬¬2ç‚¹æ¥è¯´ï¼Œå‡è®¾åç«¯åº”ç”¨æ²¡æœ‰æ­£ç¡®å¤„ç†å¼‚å¸¸ï¼Œé‚£ä¹ˆåº”è¯¥ä¼šæŠŠå¼‚å¸¸ä¿¡æ¯ç»è¿‡ç½‘å…³è½¬å‘å›åˆ°æœåŠ¡ç«¯åº”ç”¨ï¼Œè¿™ç§æƒ…å†µç†è®ºä¸Šä¸ä¼šå‡ºç°å¼‚å¸¸ã€‚ å…¶å®è¿˜æœ‰ç¬¬3ç‚¹éšè—çš„é—®é¢˜ï¼Œç½‘å…³å¦‚æœä¸å•å•æ‰¿æ‹…è·¯ç”±çš„åŠŸèƒ½ï¼Œè¿˜åŒ…å«äº†é‰´æƒã€é™æµç­‰åŠŸèƒ½ï¼Œå¦‚æœè¿™äº›åŠŸèƒ½å¼€å‘çš„æ—¶å€™å¯¹å¼‚å¸¸æ•è·æ²¡æœ‰åšå®Œå–„çš„å¤„ç†ç”šè‡³æ˜¯é€»è¾‘æœ¬èº«å­˜åœ¨BUGï¼Œæœ‰å¯èƒ½å¯¼è‡´å¼‚å¸¸æ²¡æœ‰è¢«æ­£å¸¸æ•è·å¤„ç†ï¼Œèµ°äº†é»˜è®¤çš„å¼‚å¸¸å¤„ç†å™¨DefaultErrorWebExceptionHandlerï¼Œé»˜è®¤çš„å¼‚å¸¸å¤„ç†å™¨çš„å¤„ç†é€»è¾‘å¯èƒ½å¹¶ä¸ç¬¦åˆæˆ‘ä»¬é¢„æœŸçš„ç»“æœã€‚ å¦‚ä½•è‡ªå®šä¹‰å¼‚å¸¸å¤„ç† æˆ‘ä»¬å¯ä»¥å…ˆçœ‹é»˜è®¤çš„å¼‚å¸¸å¤„ç†å™¨çš„é…ç½®ç±»ErrorWebFluxAutoConfigurationï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253@Configuration@ConditionalOnWebApplication(type = ConditionalOnWebApplication.Type.REACTIVE)@ConditionalOnClass(WebFluxConfigurer.class)@AutoConfigureBefore(WebFluxAutoConfiguration.class)@EnableConfigurationProperties(&#123; ServerProperties.class, ResourceProperties.class &#125;)public class ErrorWebFluxAutoConfiguration &#123; private final ServerProperties serverProperties; private final ApplicationContext applicationContext; private final ResourceProperties resourceProperties; private final List&lt;ViewResolver&gt; viewResolvers; private final ServerCodecConfigurer serverCodecConfigurer; public ErrorWebFluxAutoConfiguration(ServerProperties serverProperties, ResourceProperties resourceProperties, ObjectProvider&lt;ViewResolver&gt; viewResolversProvider, ServerCodecConfigurer serverCodecConfigurer, ApplicationContext applicationContext) &#123; this.serverProperties = serverProperties; this.applicationContext = applicationContext; this.resourceProperties = resourceProperties; this.viewResolvers = viewResolversProvider.orderedStream() .collect(Collectors.toList()); this.serverCodecConfigurer = serverCodecConfigurer; &#125; @Bean @ConditionalOnMissingBean(value = ErrorWebExceptionHandler.class, search = SearchStrategy.CURRENT) @Order(-1) public ErrorWebExceptionHandler errorWebExceptionHandler( ErrorAttributes errorAttributes) &#123; DefaultErrorWebExceptionHandler exceptionHandler = new DefaultErrorWebExceptionHandler( errorAttributes, this.resourceProperties, this.serverProperties.getError(), this.applicationContext); exceptionHandler.setViewResolvers(this.viewResolvers); exceptionHandler.setMessageWriters(this.serverCodecConfigurer.getWriters()); exceptionHandler.setMessageReaders(this.serverCodecConfigurer.getReaders()); return exceptionHandler; &#125; @Bean @ConditionalOnMissingBean(value = ErrorAttributes.class, search = SearchStrategy.CURRENT) public DefaultErrorAttributes errorAttributes() &#123; return new DefaultErrorAttributes( this.serverProperties.getError().isIncludeException()); &#125;&#125; æ³¨æ„åˆ°ä¸¤ä¸ªBeanå®ä¾‹ErrorWebExceptionHandlerå’ŒDefaultErrorAttributeséƒ½ä½¿ç”¨äº†@ConditionalOnMissingBeanæ³¨è§£ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡è‡ªå®šä¹‰å®ç°å»è¦†ç›–å®ƒä»¬ã€‚å…ˆè‡ªå®šä¹‰ä¸€ä¸ªCustomErrorWebFluxAutoConfigurationï¼ˆé™¤äº†ErrorWebExceptionHandlerçš„è‡ªå®šä¹‰å®ç°ï¼Œå…¶ä»–ç›´æ¥æ‹·è´ErrorWebFluxAutoConfigurationï¼‰ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445@Configuration@ConditionalOnWebApplication(type = ConditionalOnWebApplication.Type.REACTIVE)@ConditionalOnClass(WebFluxConfigurer.class)@AutoConfigureBefore(WebFluxAutoConfiguration.class)@EnableConfigurationProperties(&#123;ServerProperties.class, ResourceProperties.class&#125;)public class CustomErrorWebFluxAutoConfiguration &#123; private final ServerProperties serverProperties; private final ApplicationContext applicationContext; private final ResourceProperties resourceProperties; private final List&lt;ViewResolver&gt; viewResolvers; private final ServerCodecConfigurer serverCodecConfigurer; public CustomErrorWebFluxAutoConfiguration(ServerProperties serverProperties, ResourceProperties resourceProperties, ObjectProvider&lt;ViewResolver&gt; viewResolversProvider, ServerCodecConfigurer serverCodecConfigurer, ApplicationContext applicationContext) &#123; this.serverProperties = serverProperties; this.applicationContext = applicationContext; this.resourceProperties = resourceProperties; this.viewResolvers = viewResolversProvider.orderedStream() .collect(Collectors.toList()); this.serverCodecConfigurer = serverCodecConfigurer; &#125; @Bean @ConditionalOnMissingBean(value = ErrorWebExceptionHandler.class, search = SearchStrategy.CURRENT) @Order(-1) public ErrorWebExceptionHandler errorWebExceptionHandler(ErrorAttributes errorAttributes) &#123; // TODO è¿™é‡Œå®Œæˆè‡ªå®šä¹‰ErrorWebExceptionHandlerå®ç°é€»è¾‘ return null; &#125; @Bean @ConditionalOnMissingBean(value = ErrorAttributes.class, search = SearchStrategy.CURRENT) public DefaultErrorAttributes errorAttributes() &#123; return new DefaultErrorAttributes(this.serverProperties.getError().isIncludeException()); &#125;&#125; ErrorWebExceptionHandlerçš„å®ç°ï¼Œå¯ä»¥ç›´æ¥å‚è€ƒDefaultErrorWebExceptionHandlerï¼Œç”šè‡³ç›´æ¥ç»§æ‰¿DefaultErrorWebExceptionHandlerï¼Œè¦†ç›–å¯¹åº”çš„æ–¹æ³•å³å¯ã€‚è¿™é‡Œç›´æ¥æŠŠå¼‚å¸¸ä¿¡æ¯å°è£…æˆä¸‹é¢æ ¼å¼çš„Responseè¿”å›ï¼Œæœ€åéœ€è¦æ¸²æŸ“æˆJSONæ ¼å¼ï¼š 123456&#123; \"code\": 200, \"message\": \"æè¿°ä¿¡æ¯\", \"path\" : \"è¯·æ±‚è·¯å¾„\", \"method\": \"è¯·æ±‚æ–¹æ³•\"&#125; æˆ‘ä»¬éœ€è¦åˆ†æä¸€ä¸‹DefaultErrorWebExceptionHandlerä¸­çš„ä¸€äº›æºç ï¼š 12345678910111213141516171819202122232425// å°è£…å¼‚å¸¸å±æ€§protected Map&lt;String, Object&gt; getErrorAttributes(ServerRequest request, boolean includeStackTrace) &#123; return this.errorAttributes.getErrorAttributes(request, includeStackTrace);&#125;// æ¸²æŸ“å¼‚å¸¸Responseprotected Mono&lt;ServerResponse&gt; renderErrorResponse(ServerRequest request) &#123; boolean includeStackTrace = isIncludeStackTrace(request, MediaType.ALL); Map&lt;String, Object&gt; error = getErrorAttributes(request, includeStackTrace); return ServerResponse.status(getHttpStatus(error)) .contentType(MediaType.APPLICATION_JSON_UTF8) .body(BodyInserters.fromObject(error));&#125;// è¿”å›è·¯ç”±æ–¹æ³•åŸºäºServerResponseçš„å¯¹è±¡@Overrideprotected RouterFunction&lt;ServerResponse&gt; getRoutingFunction(ErrorAttributes errorAttributes) &#123; return route(acceptsTextHtml(), this::renderErrorView).andRoute(all(), this::renderErrorResponse);&#125;// HTTPå“åº”çŠ¶æ€ç çš„å°è£…ï¼ŒåŸæ¥æ˜¯åŸºäºå¼‚å¸¸å±æ€§çš„statuså±æ€§è¿›è¡Œè§£æçš„protected HttpStatus getHttpStatus(Map&lt;String, Object&gt; errorAttributes) &#123; int statusCode = (int) errorAttributes.get(\"status\"); return HttpStatus.valueOf(statusCode);&#125; ç¡®å®šä¸‰ç‚¹ï¼š æœ€åå°è£…åˆ°å“åº”ä½“çš„å¯¹è±¡æ¥æºäºDefaultErrorWebExceptionHandler#getErrorAttributes()ï¼Œå¹¶ä¸”ç»“æœæ˜¯ä¸€ä¸ªMap&lt;String, Object&gt;å®ä¾‹è½¬æ¢æˆçš„å­—èŠ‚åºåˆ—ã€‚ åŸæ¥çš„RouterFunctionå®ç°åªæ”¯æŒHTMLæ ¼å¼è¿”å›ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹ä¸ºJSONæ ¼å¼è¿”å›(æˆ–è€…è¯´æ”¯æŒæ‰€æœ‰æ ¼å¼è¿”å›)ã€‚ DefaultErrorWebExceptionHandler#getHttpStatus()æ˜¯å“åº”çŠ¶æ€ç çš„å°è£…ï¼ŒåŸæ¥çš„é€»è¾‘æ˜¯åŸºäºå¼‚å¸¸å±æ€§getErrorAttributes()çš„statuså±æ€§è¿›è¡Œè§£æçš„ã€‚ è‡ªå®šä¹‰çš„JsonErrorWebExceptionHandlerå¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132public class JsonErrorWebExceptionHandler extends DefaultErrorWebExceptionHandler &#123; public JsonErrorWebExceptionHandler(ErrorAttributes errorAttributes, ResourceProperties resourceProperties, ErrorProperties errorProperties, ApplicationContext applicationContext) &#123; super(errorAttributes, resourceProperties, errorProperties, applicationContext); &#125; @Override protected Map&lt;String, Object&gt; getErrorAttributes(ServerRequest request, boolean includeStackTrace) &#123; // è¿™é‡Œå…¶å®å¯ä»¥æ ¹æ®å¼‚å¸¸ç±»å‹è¿›è¡Œå®šåˆ¶åŒ–é€»è¾‘ Throwable error = super.getError(request); Map&lt;String, Object&gt; errorAttributes = new HashMap&lt;&gt;(8); errorAttributes.put(\"message\", error.getMessage()); errorAttributes.put(\"code\", HttpStatus.INTERNAL_SERVER_ERROR.value()); errorAttributes.put(\"method\", request.methodName()); errorAttributes.put(\"path\", request.path()); return errorAttributes; &#125; @Override protected RouterFunction&lt;ServerResponse&gt; getRoutingFunction(ErrorAttributes errorAttributes) &#123; return RouterFunctions.route(RequestPredicates.all(), this::renderErrorResponse); &#125; @Override protected HttpStatus getHttpStatus(Map&lt;String, Object&gt; errorAttributes) &#123; // è¿™é‡Œå…¶å®å¯ä»¥æ ¹æ®errorAttributesé‡Œé¢çš„å±æ€§å®šåˆ¶HTTPå“åº”ç  return HttpStatus.INTERNAL_SERVER_ERROR; &#125;&#125; é…ç½®ç±»CustomErrorWebFluxAutoConfigurationæ·»åŠ JsonErrorWebExceptionHandlerï¼š 1234567891011121314@Bean@ConditionalOnMissingBean(value = ErrorWebExceptionHandler.class, search = SearchStrategy.CURRENT)@Order(-1)public ErrorWebExceptionHandler errorWebExceptionHandler(ErrorAttributes errorAttributes) &#123; JsonErrorWebExceptionHandler exceptionHandler = new JsonErrorWebExceptionHandler( errorAttributes, resourceProperties, this.serverProperties.getError(), applicationContext); exceptionHandler.setViewResolvers(this.viewResolvers); exceptionHandler.setMessageWriters(this.serverCodecConfigurer.getWriters()); exceptionHandler.setMessageReaders(this.serverCodecConfigurer.getReaders()); return exceptionHandler;&#125; å¾ˆç®€å•ï¼Œè¿™é‡ŒæŠŠå¼‚å¸¸çš„HTTPå“åº”çŠ¶æ€ç ç»Ÿä¸€ä¸ºHttpStatus.INTERNAL_SERVER_ERROR(500)ï¼Œæ”¹é€ çš„ä¸œè¥¿å¹¶ä¸å¤šï¼Œåªè¦äº†è§£åŸæ¥å¼‚å¸¸å¤„ç†çš„ä¸Šä¸‹æ–‡é€»è¾‘å³å¯ã€‚ æµ‹è¯• æµ‹è¯•åœºæ™¯ä¸€ï¼šåªå¯åŠ¨ç½‘å…³ï¼Œä¸‹æ¸¸æœåŠ¡ä¸å¯åŠ¨çš„æƒ…å†µä¸‹ç›´æ¥è°ƒç”¨ä¸‹æ¸¸æœåŠ¡ï¼š 1234curl http://localhost:9090/order/host// å“åº”ç»“æœ&#123;\"path\":\"/order/host\",\"code\":500,\"message\":\"Connection refused: no further information: localhost/127.0.0.1:9091\",\"method\":\"GET\"&#125; æµ‹è¯•åœºæ™¯äºŒï¼šä¸‹æ¸¸æœåŠ¡æ­£å¸¸å¯åŠ¨å’Œè°ƒç”¨ï¼Œç½‘å…³è‡ªèº«æŠ›å‡ºå¼‚å¸¸ã€‚ åœ¨ç½‘å…³åº”ç”¨è‡ªå®šä¹‰ä¸€ä¸ªå…¨å±€è¿‡æ»¤å™¨å¹¶ä¸”æ•…æ„æŠ›å‡ºå¼‚å¸¸ï¼š 123456789@Componentpublic class ErrorGlobalFilter implements GlobalFilter &#123; @Override public Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) &#123; int i = 1/0; return chain.filter(exchange); &#125;&#125; 1234curl http://localhost:9090/order/host// å“åº”ç»“æœ&#123;\"path\":\"/order/host\",\"code\":500,\"message\":\"/ by zero\",\"method\":\"GET\"&#125; å“åº”ç»“æœå’Œå®šåˆ¶çš„é€»è¾‘ä¸€è‡´ï¼Œå¹¶ä¸”åå°çš„æ—¥å¿—ä¹Ÿæ‰“å°äº†å¯¹åº”çš„å¼‚å¸¸å †æ ˆã€‚ å°ç»“ ç¬”è€…ä¸€ç›´è®¤ä¸ºï¼Œåšå¼‚å¸¸åˆ†ç±»å’ŒæŒ‰ç…§åˆ†ç±»å¤„ç†æ˜¯å·¥ç¨‹é‡Œé¢ååˆ†é‡è¦çš„ä¸€ç¯ã€‚ç¬”è€…åœ¨æ‰€åœ¨å…¬å¸è´Ÿè´£çš„ç³»ç»Ÿä¸­ï¼ŒåšæŒå®ç°å¼‚å¸¸åˆ†ç±»æ•è·ï¼Œä¸»è¦æ˜¯éœ€è¦åŒºåˆ†å¯ä»¥é‡è¯•è¡¥å¿ä»¥åŠæ— æ³•é‡è¯•éœ€è¦åŠæ—¶é¢„è­¦çš„å¼‚å¸¸ï¼Œè¿™æ ·å­æ‰èƒ½é’ˆå¯¹å¯æ¢å¤å¼‚å¸¸å®šåˆ¶è‡ªæ„ˆé€»è¾‘ï¼Œå¯¹ä¸èƒ½æ¢å¤çš„å¼‚å¸¸åŠæ—¶é¢„è­¦å’Œäººä¸ºä»‹å…¥ã€‚æ‰€ä»¥ï¼ŒSpring Cloud Gatewayè¿™ä¸ªæŠ€æœ¯æ ˆä¹Ÿå¿…é¡»è°ƒç ”å…¶è‡ªå®šä¹‰å¼‚å¸¸çš„å¤„ç†é€»è¾‘ã€‚ (æœ¬æ–‡å®Œ c-1-d e-a-20190511)","categories":[{"name":"Spring Cloud","slug":"Spring-Cloud","permalink":"http://throwable.club/blog/categories/Spring-Cloud/"},{"name":"Spring Cloud Gateway","slug":"Spring-Cloud/Spring-Cloud-Gateway","permalink":"http://throwable.club/blog/categories/Spring-Cloud/Spring-Cloud-Gateway/"}],"tags":[{"name":"Spring Cloud Gateway","slug":"Spring-Cloud-Gateway","permalink":"http://throwable.club/blog/tags/Spring-Cloud-Gateway/"},{"name":"Spring Cloud","slug":"Spring-Cloud","permalink":"http://throwable.club/blog/tags/Spring-Cloud/"}]},{"title":"å•é“¾è¡¨ä¸­é—´èŠ‚ç‚¹æœç´¢å’Œå¿«æ…¢æŒ‡é’ˆ","slug":"java-algorithm-linked-list-fast-slow-pointer","date":"2019-05-09T16:41:47.000Z","updated":"2019-06-02T02:24:58.254Z","comments":true,"path":"2019/05/10/java-algorithm-linked-list-fast-slow-pointer/","link":"","permalink":"http://throwable.club/2019/05/10/java-algorithm-linked-list-fast-slow-pointer/","excerpt":"å‰æ ä»Šå¤©ä¸­åˆåƒé¥­çš„æ—¶å€™åˆ·äº†ä¸‹æŠ€æœ¯ç±»å‹çš„å…¬ä¼—å·ï¼Œçœ‹åˆ°æœ‰å‰è¾ˆè¿‡äº†Antçš„é«˜Pé¢è¯•ï¼Œå…¶ä¸­æœ‰ä¸€é“é¢˜è€ƒæŸ¥äº†å•é“¾è¡¨æœç´¢ä½äºä¸­é—´çš„èŠ‚ç‚¹çš„ç®—æ³•ã€‚è§‰å¾—è§£å†³æ–¹æ¡ˆå¾ˆæœ‰è¶£ï¼Œäºæ˜¯è¿™é‡Œå°è¯•é‡ç°ä¸€ä¸‹ã€‚","text":"å‰æ ä»Šå¤©ä¸­åˆåƒé¥­çš„æ—¶å€™åˆ·äº†ä¸‹æŠ€æœ¯ç±»å‹çš„å…¬ä¼—å·ï¼Œçœ‹åˆ°æœ‰å‰è¾ˆè¿‡äº†Antçš„é«˜Pé¢è¯•ï¼Œå…¶ä¸­æœ‰ä¸€é“é¢˜è€ƒæŸ¥äº†å•é“¾è¡¨æœç´¢ä½äºä¸­é—´çš„èŠ‚ç‚¹çš„ç®—æ³•ã€‚è§‰å¾—è§£å†³æ–¹æ¡ˆå¾ˆæœ‰è¶£ï¼Œäºæ˜¯è¿™é‡Œå°è¯•é‡ç°ä¸€ä¸‹ã€‚ åœºæ™¯ é¢è¯•å®˜ï¼šå¦‚ä½•è®¿é—®é“¾è¡¨ä¸­é—´èŠ‚ç‚¹ï¼Ÿ å¤§ä½¬Xï¼šç®€å•åœ°å®ç°ï¼Œéå†ä¸€éæ•´ä¸ªçš„é“¾è¡¨ï¼Œç„¶åè®¡ç®—å‡ºé“¾è¡¨çš„é•¿åº¦ï¼Œè¿›è€Œéå†ç¬¬äºŒéæ‰¾å‡ºä¸­é—´ä½ç½®çš„æ•°æ®ã€‚ é¢è¯•å®˜ï¼šè¦æ±‚åªèƒ½éå†ä¸€æ¬¡é“¾è¡¨ï¼Œé‚£åˆå½“å¦‚ä½•è§£å†³ï¼Ÿ å¤§ä½¬Xï¼šå¯ä»¥é‡‡å–å»ºç«‹ä¸¤ä¸ªæŒ‡é’ˆï¼Œä¸€ä¸ªæŒ‡é’ˆä¸€æ¬¡éå†ä¸¤ä¸ªèŠ‚ç‚¹ï¼Œå¦ä¸€ä¸ªèŠ‚ç‚¹ä¸€æ¬¡éå†ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå½“å¿«æŒ‡é’ˆéå†åˆ°ç©ºèŠ‚ç‚¹æ—¶ï¼Œæ…¢æŒ‡é’ˆæŒ‡å‘çš„ä½ç½®ä¸ºé“¾è¡¨çš„ä¸­é—´ä½ç½®ï¼Œè¿™ç§è§£å†³é—®é¢˜çš„æ–¹æ³•ç§°ä¸ºå¿«æ…¢æŒ‡é’ˆæ–¹æ³•ã€‚ å¤ç›˜ æˆ‘ä»¬å…ˆè®¾å®šå•é“¾è¡¨çš„é•¿åº¦å¤§äºç­‰äº3ï¼Œè¿™æ ·å­æ¯”è¾ƒå®¹æ˜“åˆ†æç®—æ³•ã€‚å…ˆç®€å•å‡è®¾ä¸€ä¸ªé•¿åº¦ä¸º3çš„å•é“¾è¡¨å¦‚ä¸‹ï¼š å¦‚æœæˆ‘ä»¬è¦è®¿é—®ä¸­é—´èŠ‚ç‚¹ï¼Œæœ€ç»ˆæœç´¢åˆ°çš„åº”è¯¥æ˜¯n2èŠ‚ç‚¹ï¼Œå†…å®¹å°±æ˜¯n2ã€‚ å¦‚æœå•é“¾è¡¨çš„é•¿åº¦ä¸ºå¶æ•°ï¼Œè¿™é‡Œå‡è®¾ä¸º4ï¼Œé‚£ä¹ˆå¦‚ä¸‹ï¼š å¦‚æœæˆ‘ä»¬è¦è®¿é—®ä¸­é—´èŠ‚ç‚¹ï¼Œæœ€ç»ˆæœç´¢åˆ°çš„åº”è¯¥æ˜¯n2å’Œn3èŠ‚ç‚¹ï¼Œå†…å®¹å°±æ˜¯n2å’Œn3ã€‚ å…ˆå®šä¹‰å¥½èŠ‚ç‚¹ç±»Nodeå¦‚ä¸‹ï¼š 12345678910111213@Dataprivate static class Node&lt;T&gt;&#123; /** * å½“å‰èŠ‚ç‚¹çš„å€¼ */ private T value; /** * ä¸‹ä¸€ä¸ªèŠ‚ç‚¹çš„å¼•ç”¨ */ private Node&lt;T&gt; next;&#125; æˆ‘ä»¬å¯ä»¥å¾ˆè½»æ˜“åœ°æ„å»ºä¸€ä¸ªå•é“¾è¡¨å¦‚ä¸‹ï¼š 123456789101112private static Node&lt;String&gt; buildLinkedList(int len) &#123; Node&lt;String&gt; head = new Node&lt;&gt;(); head.setValue(\"n1\"); Node&lt;String&gt; tail = head; for (int i = 1; i &lt; len; i++) &#123; Node&lt;String&gt; node = new Node&lt;&gt;(); node.setValue(\"n\" + (i + 1)); tail.setNext(node); tail = node; &#125; return head;&#125; æ¥ç€æˆ‘ä»¬å¯ä»¥ç¼–å†™æœç´¢ä¸­é—´èŠ‚ç‚¹çš„æ–¹æ³•ï¼Œå…ˆç¼–å†™é€šè¿‡éå†é“¾è¡¨è¿›è¡Œé•¿åº¦è®¡ç®—ï¼Œå†éå†é“¾è¡¨å¾—åˆ°ä¸­é—´èŠ‚ç‚¹çš„æ–¹æ¡ˆä¸€ï¼š 1234567891011121314151617181920212223242526272829303132333435private static List&lt;String&gt; searchByTraversal(Node&lt;String&gt; head) &#123; List&lt;String&gt; result = new ArrayList&lt;&gt;(2); Node&lt;String&gt; search = head; int len = 1; // ç¬¬ä¸€æ¬¡éå†é“¾è¡¨,è®¡ç®—é“¾è¡¨é•¿åº¦ while (search.getNext() != null) &#123; search = search.getNext(); len++; &#125; int index = 0; int mid; search = head; // é“¾è¡¨é•¿åº¦ä¸ºå¶æ•° if ((len &amp; 1) == 0) &#123; mid = len / 2 - 1; while (search.getNext() != null) &#123; if (mid == index) &#123; result.add(search.getValue()); result.add(search.getNext().getValue()); &#125; search = search.getNext(); index++; &#125; &#125; else &#123; mid = (len - 1) / 2; while (search.getNext() != null) &#123; if (mid == index) &#123; result.add(search.getValue()); &#125; search = search.getNext(); index++; &#125; &#125; return result;&#125; å†™ä¸ªmainæ–¹æ³•è¯•éªŒä¸€ä¸‹ï¼š 12345678910public static void main(String[] args) throws Exception &#123; Node&lt;String&gt; head = buildLinkedList(11); System.out.println(searchByTraversal(head)); head = buildLinkedList(12); System.out.println(searchByTraversal(head));&#125;// è¾“å‡ºç»“æœ[n6][n6, n7] å‡è®¾é“¾è¡¨çš„é•¿åº¦ä¸ºnï¼Œé‚£ä¹ˆè¿›è¡Œä¸¤æ¬¡éå†ä¸€å…±éœ€è¦éå†çš„å…ƒç´ ä¸ªç´ å¦‚ä¸‹ï¼š ç¬¬ä¸€æ¬¡éå†æ•´ä¸ªé“¾è¡¨ï¼Œè®¡ç®—é•¿åº¦ï¼Œå¿…é¡»éå†nä¸ªå…ƒç´ ã€‚ ç¬¬äºŒæ¬¡éœ€è¦éå†n/2ä¸ªå…ƒç´ (åœ¨næ¯”è¾ƒå¤§çš„æ—¶å€™ï¼Œå…¶å®åŠ å‡çš„å½±å“ä¸å¤§)ã€‚ è¿™ç§æ–¹æ¡ˆå®ç°ï¼Œæœ€ç»ˆçš„æ—¶é—´å¤æ‚åº¦ä¸€å®šä¼šå¤§äºO(n)ã€‚æ‰€ä»¥éœ€è¦è€ƒè™‘ä¼˜åŒ–æ–¹æ¡ˆï¼Œåªéœ€è¦éå†ä¸€æ¬¡é“¾è¡¨å°±èƒ½å®šä½åˆ°ä¸­é—´çš„èŠ‚ç‚¹å€¼ï¼Œè¿™ä¸ªå°±æ˜¯æ–¹æ¡ˆäºŒï¼šä½¿ç”¨å¿«æ…¢æŒ‡é’ˆã€‚ å¿«æ…¢æŒ‡é’ˆï¼Œç®€å•æ¥è¯´å°±æ˜¯å®šä¹‰ä¸¤ä¸ªæŒ‡é’ˆï¼Œåœ¨éå†é“¾è¡¨çš„æ—¶å€™ï¼Œå¿«æŒ‡é’ˆ(fast pointer)æ€»æ˜¯éå†ä¸¤ä¸ªå…ƒç´ ï¼Œè€Œæ…¢æŒ‡é’ˆ(slow pointer)æ€»æ˜¯éå†ä¸€ä¸ªå…ƒç´ ã€‚å½“å¿«æŒ‡é’ˆéå†æ•´ä¸ªé“¾è¡¨å®Œæˆçš„æ—¶å€™ï¼Œæ…¢æŒ‡é’ˆåˆšå¥½æŒ‡å‘é“¾è¡¨çš„ä¸­é—´èŠ‚ç‚¹ã€‚ç®—æ³•å®ç°å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526private static List&lt;String&gt; searchByFastSlowPointer(Node&lt;String&gt; head) &#123; List&lt;String&gt; result = new ArrayList&lt;&gt;(2); // fast pointer Node&lt;String&gt; fp = head; // slow pointer Node&lt;String&gt; sp = head; int len = 1; while (null != fp.getNext()) &#123; if (fp.getNext().getNext() != null) &#123; fp = fp.getNext().getNext(); sp = sp.getNext(); len += 2; &#125; else &#123; fp = fp.getNext(); len += 1; &#125; &#125; // é“¾è¡¨é•¿åº¦ä¸ºå¶æ•° if ((len &amp; 1) == 0) &#123; result.add(sp.getValue()); result.add(sp.getNext().getValue()); &#125; else &#123; result.add(sp.getValue()); &#125; return result;&#125; å†™ä¸ªmainæ–¹æ³•è¯•éªŒä¸€ä¸‹ï¼š 12345678910public static void main(String[] args) throws Exception &#123; Node&lt;String&gt; head = buildLinkedList(11); System.out.println(searchByFastSlowPointer(head)); head = buildLinkedList(12); System.out.println(searchByFastSlowPointer(head));&#125;// è¾“å‡ºç»“æœ[n6][n6, n7] ç”±äºä½¿ç”¨äº†å¿«æ…¢æŒ‡é’ˆçš„æ–¹æ¡ˆï¼Œåªåšäº†ä¸€æ¬¡é“¾è¡¨çš„éå†ï¼Œå¹¶ä¸”ç”±äºå¿«æŒ‡é’ˆæ˜¯æ¯æ¬¡ä¸¤ä¸ªå…ƒç´ è¿›è¡Œéå†ï¼Œæœ€ç»ˆçš„æ—¶é—´å¤æ‚åº¦è¦å°äºO(n)ã€‚ å¿«æ…¢æŒ‡é’ˆçš„åº”ç”¨åœºæ™¯ å¿«æ…¢æŒ‡é’ˆä¸»è¦æœ‰å¦‚ä¸‹çš„åº”ç”¨åœºæ™¯ï¼š æ‰¾åˆ°é“¾è¡¨çš„ä¸­ç‚¹ã€‚ åˆ¤æ–­é“¾è¡¨ä¸­æ˜¯å¦å­˜åœ¨ç¯ã€‚ åˆ é™¤é“¾è¡¨ä¸­å€’æ•°ç¬¬xä¸ªèŠ‚ç‚¹ã€‚ ç¬¬ä¸€ç§æƒ…å†µå·²ç»ä½œä¸ºå¤ç›˜æ¡ˆä¾‹åˆ†æè¿‡ï¼Œä¸‹é¢åˆ†æä¸€ä¸‹ç¬¬äºŒå’Œç¬¬ä¸‰ç§åœºæ™¯ã€‚ åˆ¤æ–­é“¾è¡¨ä¸­æ˜¯å¦å­˜åœ¨ç¯ å‡è®¾é“¾è¡¨æœ‰6ä¸ªèŠ‚ç‚¹(headèŠ‚ç‚¹ä¸ºn1ï¼ŒtailèŠ‚ç‚¹ä¸ºn6)ï¼Œå·²ç»å½¢æˆç¯(n6çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ä¸ºn1)ï¼š ä½¿ç”¨å¿«æ…¢æŒ‡é’ˆï¼Œå¿«æŒ‡é’ˆæ¯æ¬¡éå†ä¼šæ¯”æ…¢æŒ‡é’ˆå¤šä¸€ä¸ªå…ƒç´ ï¼Œè¿™æ ·å­çš„è¯ï¼Œå¦‚æœé“¾è¡¨å·²ç»æˆç¯ï¼Œæ— è®ºå¿«æŒ‡é’ˆå’Œæ…¢æŒ‡é’ˆä¹‹é—´ç›¸éš”å¤šå°‘ä¸ªèŠ‚ç‚¹ï¼Œå¿«æŒ‡é’ˆæ€»æ˜¯èƒ½å¤Ÿè¿½ä¸Šæ…¢æŒ‡é’ˆ(å¿«æŒ‡é’ˆå’Œæ…¢æŒ‡é’ˆæŒ‡å‘åŒä¸€ä¸ªèŠ‚ç‚¹)ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥åˆ¤æ–­é“¾è¡¨å·²ç»æˆç¯ï¼›å¦åˆ™å¿«æŒ‡é’ˆè¿›è¡Œä¸€è½®éå†ä¹‹åå°±ä¼šè·³å‡ºå¾ªç¯ï¼Œæ°¸è¿œä¸å¯èƒ½å’Œæ…¢æŒ‡é’ˆâ€œé‡åˆâ€ã€‚ç®€é™‹çš„å®ç°å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930// åˆ¤æ–­é“¾è¡¨æ˜¯å¦å­˜åœ¨ç¯private static boolean cyclic(Node&lt;String&gt; head) &#123; // fast pointer Node&lt;String&gt; fp = head; // slow pointer Node&lt;String&gt; sp = head; while (fp.getNext() != null) &#123; fp = fp.getNext().getNext(); sp = sp.getNext(); if (sp.equals(fp)) &#123; return true; &#125; &#125; return false;&#125;// ç”Ÿæˆç¯å½¢é“¾è¡¨private static Node&lt;String&gt; buildCyclicLinkedList(int len) &#123; Node&lt;String&gt; head = new Node&lt;&gt;(); head.setValue(\"n1\"); Node&lt;String&gt; tail = head; for (int i = 1; i &lt; len; i++) &#123; Node&lt;String&gt; node = new Node&lt;&gt;(); node.setValue(\"n\" + (i + 1)); tail.setNext(node); tail = node; &#125; tail.setNext(head); return head;&#125; æµ‹è¯•ä¸€ä¸‹ï¼š 12345678910public static void main(String[] args) throws Exception &#123; Node&lt;String&gt; head = buildCyclicLinkedList(11); System.out.println(cyclic(head)); head = buildLinkedList(11); System.out.println(cyclic(head));&#125;// è¾“å‡ºç»“æœtruefalse åˆ é™¤é“¾è¡¨ä¸­å€’æ•°ç¬¬Nä¸ªèŠ‚ç‚¹ è¿™ä¸ªæ˜¯LeetCodeä¸Šçš„ä¸€é“ç®—æ³•é¢˜ï¼Œé‡Œé¢ç”¨åˆ°çš„æ˜¯è™šæ‹Ÿå¤´ç»“ç‚¹åŠ ä¸Šå¿«æ…¢æŒ‡é’ˆçš„æ–¹æ³•ï¼Œåªè¿›è¡Œä¸€æ¬¡éå†å°±èƒ½è§£å†³ã€‚è¿™é‡Œå¼•ç”¨è·èµæœ€å¤šçš„å›ç­”é‡Œé¢çš„è§£å†³æ€è·¯ï¼š ä¸Šè¿°ç®—æ³•å¯ä»¥ä¼˜åŒ–ä¸ºåªä½¿ç”¨ä¸€æ¬¡éå†ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ä¸¤ä¸ªæŒ‡é’ˆè€Œä¸æ˜¯ä¸€ä¸ªæŒ‡é’ˆã€‚ç¬¬ä¸€ä¸ªæŒ‡é’ˆä»åˆ—è¡¨çš„å¼€å¤´å‘å‰ç§»åŠ¨n+1æ­¥ï¼Œè€Œç¬¬äºŒä¸ªæŒ‡é’ˆå°†ä»åˆ—è¡¨çš„å¼€å¤´å‡ºå‘ã€‚ç°åœ¨ï¼Œè¿™ä¸¤ä¸ªæŒ‡é’ˆè¢«nä¸ªç»“ç‚¹åˆ†å¼€ã€‚æˆ‘ä»¬é€šè¿‡åŒæ—¶ç§»åŠ¨ä¸¤ä¸ªæŒ‡é’ˆå‘å‰æ¥ä¿æŒè¿™ä¸ªæ’å®šçš„é—´éš”ï¼Œç›´åˆ°ç¬¬ä¸€ä¸ªæŒ‡é’ˆåˆ°è¾¾æœ€åä¸€ä¸ªç»“ç‚¹ã€‚æ­¤æ—¶ç¬¬äºŒä¸ªæŒ‡é’ˆå°†æŒ‡å‘ä»æœ€åä¸€ä¸ªç»“ç‚¹æ•°èµ·çš„ç¬¬nä¸ªç»“ç‚¹ã€‚æˆ‘ä»¬é‡æ–°é“¾æ¥ç¬¬äºŒä¸ªæŒ‡é’ˆæ‰€å¼•ç”¨çš„ç»“ç‚¹çš„nextæŒ‡é’ˆæŒ‡å‘è¯¥ç»“ç‚¹çš„ä¸‹ä¸‹ä¸ªç»“ç‚¹ã€‚ ç®—æ³•æ¨æ¼”å›¾ï¼š ç®—æ³•ä»£ç å¦‚ä¸‹ï¼š 1234567891011121314151617public ListNode removeNthFromEnd(ListNode head, int n) &#123; ListNode dummy = new ListNode(0); dummy.next = head; ListNode first = dummy; ListNode second = dummy; // Advances first pointer so that the gap between first and second is n nodes apart for (int i = 1; i &lt;= n + 1; i++) &#123; first = first.next; &#125; // Move first to the end, maintaining the gap while (first != null) &#123; first = first.next; second = second.next; &#125; second.next = second.next.next; return dummy.next;&#125; æ—¶é—´å¤æ‚åº¦ä¸ºO(L)ï¼ŒLä¸ºé“¾è¡¨é•¿åº¦ã€‚ å°ç»“ é‰´äºç®—æ³•æ¯”è¾ƒå¼±ï¼Œçœ‹åˆ°è¿™äº›ç›¸å¯¹æœ‰å®ç”¨ä»·å€¼çš„é¢˜ç›®å’Œè§£å†³æ–¹æ¡ˆï¼Œè¿˜æ˜¯å€¼å¾—æ¨æ¼”å’Œå­¦ä¹ ä¸€ç•ªã€‚ å‚è€ƒèµ„æ–™ï¼š Leetcodeï¼Œç®—æ³•é¢˜ç›®ï¼šRemove Nth Node From End of List (æœ¬æ–‡å®Œ c-2-d e-a-20190510)","categories":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/categories/Java/"},{"name":"Algorithm","slug":"Java/Algorithm","permalink":"http://throwable.club/blog/categories/Java/Algorithm/"}],"tags":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/tags/Java/"},{"name":"Algorithm","slug":"Algorithm","permalink":"http://throwable.club/blog/tags/Algorithm/"}]},{"title":"è®¾è®¡æ¨¡å¼æ¦‚å¿µå’Œä¸ƒå¤§åŸåˆ™","slug":"design-pattern-basic-law","date":"2019-05-05T14:53:45.000Z","updated":"2019-06-02T02:30:36.959Z","comments":true,"path":"2019/05/05/design-pattern-basic-law/","link":"","permalink":"http://throwable.club/2019/05/05/design-pattern-basic-law/","excerpt":"ä»€ä¹ˆæ˜¯è®¾è®¡æ¨¡å¼ åœ¨GoF(Gang of Four)çš„ä¹¦ç±ã€ŠDesign Patterns - Elements of Reusable Object-Oriented Software(è®¾è®¡æ¨¡å¼-å¯å¤ç”¨é¢å‘å¯¹è±¡è½¯ä»¶çš„åŸºç¡€)ã€‹ä¸­æ˜¯è¿™æ ·å®šä¹‰è®¾è®¡æ¨¡å¼çš„ï¼šChristopher Alexanderè¯´è¿‡ï¼šâ€œæ¯ä¸€ä¸ªæ¨¡å¼æè¿°äº†ä¸€ä¸ªåœ¨æˆ‘ä»¬å‘¨å›´ä¸æ–­é‡å¤å‘ç”Ÿçš„é—®é¢˜ä»¥åŠè¯¥é—®é¢˜çš„è§£å†³æ–¹æ¡ˆçš„æ ¸å¿ƒã€‚è¿™æ ·ï¼Œä½ å°±èƒ½ä¸€æ¬¡åˆä¸€æ¬¡åœ°ä½¿ç”¨è¯¥æ–¹æ¡ˆè€Œä¸å¿…åšé‡å¤åŠ³åŠ¨â€ [AIS+77ï¼Œç¬¬10é¡µ]ã€‚å°½ç®¡Alexanderæ‰€æŒ‡çš„æ˜¯åŸå¸‚å’Œå»ºç­‘æ¨¡å¼ï¼Œä½†ä»–çš„æ€æƒ³ä¹ŸåŒæ ·é€‚ç”¨äºé¢å‘å¯¹è±¡è®¾è®¡æ¨¡å¼ï¼Œåªæ˜¯åœ¨é¢å‘å¯¹è±¡çš„è§£å†³æ–¹æ¡ˆé‡Œï¼Œ æˆ‘ä»¬ç”¨å¯¹è±¡å’Œæ¥å£ä»£æ›¿äº†å¢™å£å’Œé—¨çª—ã€‚ä¸¤ç±»æ¨¡å¼çš„æ ¸å¿ƒéƒ½åœ¨äºæä¾›äº†ç›¸å…³é—®é¢˜çš„è§£å†³æ–¹æ¡ˆã€‚ä¸€èˆ¬è€Œè¨€ï¼Œè®¾è®¡æ¨¡å¼æœ‰å››ä¸ªåŸºæœ¬è¦ç´ ï¼š æ¨¡å¼åç§°(pattern name)ï¼šä¸€ä¸ªåŠ©è®°åï¼Œå®ƒç”¨ä¸€ä¸¤ä¸ªè¯æ¥æè¿°æ¨¡å¼çš„é—®é¢˜ã€è§£å†³æ–¹æ¡ˆå’Œæ•ˆæœã€‚ é—®é¢˜(problem)ï¼šæè¿°äº†åº”è¯¥åœ¨ä½•æ—¶ä½¿ç”¨æ¨¡å¼ã€‚ è§£å†³æ–¹æ¡ˆ(solution)ï¼šæè¿°äº†è®¾è®¡çš„ç»„æˆæˆåˆ†ï¼Œå®ƒä»¬ä¹‹é—´çš„ç›¸å…³å…³ç³»ä»¥åŠå„è‡ªçš„èŒè´£å’Œåä½œæ–¹æ¡ˆã€‚ æ•ˆæœ(consequences)ï¼šæè¿°äº†æ¨¡å¼åº”ç”¨çš„æ•ˆæœä»¥åŠä½¿ç”¨æ¨¡å¼åº”è¯¥æƒè¡¡çš„é—®é¢˜ã€‚ è®¾è®¡æ¨¡å¼çš„åˆ›å§‹äººå¾ˆæ˜ç¡®åœ°æŒ‡å‡ºäº†è®¾è®¡æ¨¡å¼çš„åŸºæœ¬è¦ç´ ï¼Œä½†æ˜¯ç”±äºç°å®ä¸­æµ®èºã€åå‘è¿‡åº¦è®¾è®¡ç­‰å› ç´ çš„å¹²æ‰°ï¼Œå¼€å‘è€…å¾ˆå¤šæ—¶å€™ä¼šé‡ç‚¹å…³æ³¨ç¬¬1å’Œç¬¬3ç‚¹è¦ç´ (è¿‡åº¦å…³æ³¨è®¾è®¡æ¨¡å¼å’Œè®¾è®¡æ¨¡å¼çš„å®ç°)ï¼Œå¿½ç•¥ç¬¬2å’Œç¬¬4ç‚¹è¦ç´ (å¿½è§†ä½¿ç”¨è®¾è®¡æ¨¡å¼çš„åœºæ™¯å’Œç›®æ ‡)ï¼Œå¯¼è‡´è®¾è®¡å‡ºæ¥çš„ç¼–ç é€»è¾‘å¯èƒ½è¿‡äºå¤æ‚æˆ–è€…è¾¾ä¸åˆ°é¢„æœŸçš„æ•ˆæœã€‚ æ€»çš„æ¥è¯´ï¼Œè®¾è®¡æ¨¡å¼(Design Pattern)æ˜¯ä¸€å¥—è¢«åå¤ä½¿ç”¨ã€å¤šæ•°äººçŸ¥æ™“çš„ã€ç»è¿‡åˆ†ç±»ç¼–ç›®çš„ã€ä»£ç è®¾è®¡ç»éªŒçš„æ€»ç»“ã€‚ä¹Ÿå°±æ˜¯æœ¬æ¥å¹¶ä¸å­˜åœ¨æ‰€è°“è®¾è®¡æ¨¡å¼ï¼Œç”¨çš„äººå¤šäº†ï¼Œä¹Ÿä¾¿æˆäº†è®¾è®¡æ¨¡å¼ã€‚","text":"ä»€ä¹ˆæ˜¯è®¾è®¡æ¨¡å¼ åœ¨GoF(Gang of Four)çš„ä¹¦ç±ã€ŠDesign Patterns - Elements of Reusable Object-Oriented Software(è®¾è®¡æ¨¡å¼-å¯å¤ç”¨é¢å‘å¯¹è±¡è½¯ä»¶çš„åŸºç¡€)ã€‹ä¸­æ˜¯è¿™æ ·å®šä¹‰è®¾è®¡æ¨¡å¼çš„ï¼šChristopher Alexanderè¯´è¿‡ï¼šâ€œæ¯ä¸€ä¸ªæ¨¡å¼æè¿°äº†ä¸€ä¸ªåœ¨æˆ‘ä»¬å‘¨å›´ä¸æ–­é‡å¤å‘ç”Ÿçš„é—®é¢˜ä»¥åŠè¯¥é—®é¢˜çš„è§£å†³æ–¹æ¡ˆçš„æ ¸å¿ƒã€‚è¿™æ ·ï¼Œä½ å°±èƒ½ä¸€æ¬¡åˆä¸€æ¬¡åœ°ä½¿ç”¨è¯¥æ–¹æ¡ˆè€Œä¸å¿…åšé‡å¤åŠ³åŠ¨â€ [AIS+77ï¼Œç¬¬10é¡µ]ã€‚å°½ç®¡Alexanderæ‰€æŒ‡çš„æ˜¯åŸå¸‚å’Œå»ºç­‘æ¨¡å¼ï¼Œä½†ä»–çš„æ€æƒ³ä¹ŸåŒæ ·é€‚ç”¨äºé¢å‘å¯¹è±¡è®¾è®¡æ¨¡å¼ï¼Œåªæ˜¯åœ¨é¢å‘å¯¹è±¡çš„è§£å†³æ–¹æ¡ˆé‡Œï¼Œ æˆ‘ä»¬ç”¨å¯¹è±¡å’Œæ¥å£ä»£æ›¿äº†å¢™å£å’Œé—¨çª—ã€‚ä¸¤ç±»æ¨¡å¼çš„æ ¸å¿ƒéƒ½åœ¨äºæä¾›äº†ç›¸å…³é—®é¢˜çš„è§£å†³æ–¹æ¡ˆã€‚ä¸€èˆ¬è€Œè¨€ï¼Œè®¾è®¡æ¨¡å¼æœ‰å››ä¸ªåŸºæœ¬è¦ç´ ï¼š æ¨¡å¼åç§°(pattern name)ï¼šä¸€ä¸ªåŠ©è®°åï¼Œå®ƒç”¨ä¸€ä¸¤ä¸ªè¯æ¥æè¿°æ¨¡å¼çš„é—®é¢˜ã€è§£å†³æ–¹æ¡ˆå’Œæ•ˆæœã€‚ é—®é¢˜(problem)ï¼šæè¿°äº†åº”è¯¥åœ¨ä½•æ—¶ä½¿ç”¨æ¨¡å¼ã€‚ è§£å†³æ–¹æ¡ˆ(solution)ï¼šæè¿°äº†è®¾è®¡çš„ç»„æˆæˆåˆ†ï¼Œå®ƒä»¬ä¹‹é—´çš„ç›¸å…³å…³ç³»ä»¥åŠå„è‡ªçš„èŒè´£å’Œåä½œæ–¹æ¡ˆã€‚ æ•ˆæœ(consequences)ï¼šæè¿°äº†æ¨¡å¼åº”ç”¨çš„æ•ˆæœä»¥åŠä½¿ç”¨æ¨¡å¼åº”è¯¥æƒè¡¡çš„é—®é¢˜ã€‚ è®¾è®¡æ¨¡å¼çš„åˆ›å§‹äººå¾ˆæ˜ç¡®åœ°æŒ‡å‡ºäº†è®¾è®¡æ¨¡å¼çš„åŸºæœ¬è¦ç´ ï¼Œä½†æ˜¯ç”±äºç°å®ä¸­æµ®èºã€åå‘è¿‡åº¦è®¾è®¡ç­‰å› ç´ çš„å¹²æ‰°ï¼Œå¼€å‘è€…å¾ˆå¤šæ—¶å€™ä¼šé‡ç‚¹å…³æ³¨ç¬¬1å’Œç¬¬3ç‚¹è¦ç´ (è¿‡åº¦å…³æ³¨è®¾è®¡æ¨¡å¼å’Œè®¾è®¡æ¨¡å¼çš„å®ç°)ï¼Œå¿½ç•¥ç¬¬2å’Œç¬¬4ç‚¹è¦ç´ (å¿½è§†ä½¿ç”¨è®¾è®¡æ¨¡å¼çš„åœºæ™¯å’Œç›®æ ‡)ï¼Œå¯¼è‡´è®¾è®¡å‡ºæ¥çš„ç¼–ç é€»è¾‘å¯èƒ½è¿‡äºå¤æ‚æˆ–è€…è¾¾ä¸åˆ°é¢„æœŸçš„æ•ˆæœã€‚ æ€»çš„æ¥è¯´ï¼Œè®¾è®¡æ¨¡å¼(Design Pattern)æ˜¯ä¸€å¥—è¢«åå¤ä½¿ç”¨ã€å¤šæ•°äººçŸ¥æ™“çš„ã€ç»è¿‡åˆ†ç±»ç¼–ç›®çš„ã€ä»£ç è®¾è®¡ç»éªŒçš„æ€»ç»“ã€‚ä¹Ÿå°±æ˜¯æœ¬æ¥å¹¶ä¸å­˜åœ¨æ‰€è°“è®¾è®¡æ¨¡å¼ï¼Œç”¨çš„äººå¤šäº†ï¼Œä¹Ÿä¾¿æˆäº†è®¾è®¡æ¨¡å¼ã€‚ è®¾è®¡æ¨¡å¼çš„ä¸ƒå¤§åŸåˆ™ é¢å‘å¯¹è±¡çš„è®¾è®¡æ¨¡å¼æœ‰ä¸ƒå¤§åŸºæœ¬åŸåˆ™ï¼š å¼€é—­åŸåˆ™ï¼ˆOpen Closed Principleï¼ŒOCPï¼‰ å•ä¸€èŒè´£åŸåˆ™ï¼ˆSingle Responsibility Principle, SRPï¼‰ é‡Œæ°ä»£æ¢åŸåˆ™ï¼ˆLiskov Substitution Principleï¼ŒLSPï¼‰ ä¾èµ–å€’è½¬åŸåˆ™ï¼ˆDependency Inversion Principleï¼ŒDIPï¼‰ æ¥å£éš”ç¦»åŸåˆ™ï¼ˆInterface Segregation Principleï¼ŒISPï¼‰ åˆæˆ/èšåˆå¤ç”¨åŸåˆ™ï¼ˆComposite/Aggregate Reuse Principleï¼ŒCARPï¼‰ æœ€å°‘çŸ¥è¯†åŸåˆ™ï¼ˆLeast Knowledge Principleï¼ŒLKPï¼‰æˆ–è€…è¿ªç±³ç‰¹æ³•åˆ™ï¼ˆLaw of Demeterï¼ŒLODï¼‰ æ ‡è®° è®¾è®¡æ¨¡å¼åŸåˆ™åç§° ç®€å•å®šä¹‰ OCP å¼€é—­åŸåˆ™ å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­ SRP å•ä¸€èŒè´£åŸåˆ™ ä¸€ä¸ªç±»åªè´Ÿè´£ä¸€ä¸ªåŠŸèƒ½é¢†åŸŸä¸­çš„ç›¸åº”èŒè´£ LSP é‡Œæ°ä»£æ¢åŸåˆ™ æ‰€æœ‰å¼•ç”¨åŸºç±»çš„åœ°æ–¹å¿…é¡»èƒ½é€æ˜åœ°ä½¿ç”¨å…¶å­ç±»çš„å¯¹è±¡ DIP ä¾èµ–å€’è½¬åŸåˆ™ ä¾èµ–äºæŠ½è±¡ï¼Œä¸èƒ½ä¾èµ–äºå…·ä½“å®ç° ISP æ¥å£éš”ç¦»åŸåˆ™ ç±»ä¹‹é—´çš„ä¾èµ–å…³ç³»åº”è¯¥å»ºç«‹åœ¨æœ€å°çš„æ¥å£ä¸Š CARP åˆæˆ/èšåˆå¤ç”¨åŸåˆ™ å°½é‡ä½¿ç”¨åˆæˆ/èšåˆï¼Œè€Œä¸æ˜¯é€šè¿‡ç»§æ‰¿è¾¾åˆ°å¤ç”¨çš„ç›®çš„ LOD è¿ªç±³ç‰¹æ³•åˆ™ ä¸€ä¸ªè½¯ä»¶å®ä½“åº”å½“å°½å¯èƒ½å°‘çš„ä¸å…¶ä»–å®ä½“å‘ç”Ÿç›¸äº’ä½œç”¨ å…¶ä¸­ï¼Œå•ä¸€èŒè´£åŸåˆ™ã€å¼€é—­åŸåˆ™ã€è¿ªç±³ç‰¹æ³•åˆ™ã€é‡Œæ°ä»£æ¢åŸåˆ™å’Œæ¥å£éš”ç¦»åŸåˆ™å°±æ˜¯æˆ‘ä»¬å¹³å¸¸ç†ŸçŸ¥çš„SOLIDã€‚ è¿™ä¸ªè¡¨æ ¼çœ‹èµ·æ¥æœ‰ç‚¹æŠ½è±¡ï¼Œä¸‹é¢é€æ¡åˆ†æã€‚ å¼€é—­åŸåˆ™ å¼€é—­åŸåˆ™ï¼ˆOpen Closed Principleï¼ŒOCPï¼‰çš„å®šä¹‰æ˜¯ï¼šä¸€ä¸ªè½¯ä»¶å®ä½“å¦‚ç±»ã€æ¨¡å—å’Œå‡½æ•°åº”è¯¥å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­ã€‚æ¨¡å—åº”å°½é‡åœ¨ä¸ä¿®æ”¹åŸï¼ˆæ˜¯&quot;åŸ&quot;ï¼ŒæŒ‡åŸæ¥çš„ä»£ç ï¼‰ä»£ç çš„æƒ…å†µä¸‹è¿›è¡Œæ‰©å±•ã€‚ å¼€é—­åŸåˆ™çš„æ„ä¹‰ åœ¨è½¯ä»¶çš„ç”Ÿå‘½å‘¨æœŸå†…ï¼Œå› ä¸ºå˜åŒ–ã€å‡çº§å’Œç»´æŠ¤ç­‰åŸå› éœ€è¦å¯¹è½¯ä»¶åŸæœ‰ä»£ç è¿›è¡Œä¿®æ”¹æ—¶ï¼Œå¯èƒ½ä¼šç»™æ—§ä»£ç ä¸­å¼•å…¥é”™è¯¯ï¼Œä¹Ÿå¯èƒ½ä¼šä½¿æˆ‘ä»¬ä¸å¾—ä¸å¯¹æ•´ä¸ªåŠŸèƒ½è¿›è¡Œé‡æ„ï¼Œå¹¶ä¸”éœ€è¦åŸæœ‰ä»£ç ç»è¿‡é‡æ–°æµ‹è¯•ã€‚å½“è½¯ä»¶éœ€è¦å˜åŒ–æ—¶ï¼Œå°½é‡é€šè¿‡æ‰©å±•è½¯ä»¶å®ä½“çš„è¡Œä¸ºæ¥å®ç°å˜åŒ–ï¼Œè€Œä¸æ˜¯é€šè¿‡ä¿®æ”¹å·²æœ‰çš„ä»£ç æ¥å®ç°å˜åŒ–ã€‚ å¦‚ä½•å®ç°å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­ è¦å®ç°å¯¹æ‰©å±•å¼€æ”¾ï¼Œå¯¹ä¿®æ”¹å…³é—­ï¼Œå³éµå¾ªå¼€é—­åŸåˆ™ï¼Œéœ€è¦å¯¹ç³»ç»Ÿè¿›è¡ŒæŠ½è±¡åŒ–è®¾è®¡ï¼ŒæŠ½è±¡å¯ä»¥åŸºäºæŠ½è±¡ç±»æˆ–è€…æ¥å£ã€‚ä¸€èˆ¬æ¥è¯´éœ€è¦åšåˆ°å‡ ç‚¹ï¼š é€šè¿‡æ¥å£æˆ–è€…æŠ½è±¡ç±»çº¦æŸæ‰©å±•ï¼Œå¯¹æ‰©å±•è¿›è¡Œè¾¹ç•Œé™å®šï¼Œä¸å…è®¸å‡ºç°åœ¨æ¥å£æˆ–æŠ½è±¡ç±»ä¸­ä¸å­˜åœ¨çš„publicæ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯æ‰©å±•å¿…é¡»æ·»åŠ å…·ä½“å®ç°è€Œä¸æ˜¯æ”¹å˜å…·ä½“çš„æ–¹æ³•ã€‚ å‚æ•°ç±»å‹ã€å¼•ç”¨å¯¹è±¡å°½é‡ä½¿ç”¨æ¥å£æˆ–è€…æŠ½è±¡ç±»ï¼Œè€Œä¸æ˜¯å®ç°ç±»ï¼Œè¿™æ ·å°±èƒ½å°½é‡ä¿è¯æŠ½è±¡å±‚æ˜¯ç¨³å®šçš„ã€‚ ä¸€èˆ¬æŠ½è±¡æ¨¡å—è®¾è®¡å®Œæˆ(ä¾‹å¦‚æ¥å£çš„æ–¹æ³•å·²ç»æ•²å®š)ï¼Œä¸å…è®¸ä¿®æ”¹æ¥å£æˆ–è€…æŠ½è±¡æ–¹æ³•çš„å®šä¹‰ã€‚ ä¸‹é¢é€šè¿‡ä¸€ä¸ªä¾‹å­éµå¾ªå¼€é—­åŸåˆ™è¿›è¡Œè®¾è®¡ï¼Œåœºæ™¯æ˜¯è¿™æ ·ï¼šæŸç³»ç»Ÿçš„åå°éœ€è¦ç›‘æµ‹ä¸šåŠ¡æ•°æ®å±•ç¤ºå›¾è¡¨ï¼Œå¦‚æŸ±çŠ¶å›¾ã€æŠ˜çº¿å›¾ç­‰ï¼Œåœ¨æœªæ¥éœ€è¦æ”¯æŒå›¾è¡¨çš„ç€è‰²æ“ä½œã€‚åœ¨å¼€å§‹è®¾è®¡çš„æ—¶å€™ï¼Œä»£ç å¯èƒ½æ˜¯è¿™æ ·çš„ï¼š 123456789101112131415161718192021222324public class BarChart &#123; public void draw()&#123; System.out.println(\"Draw bar chart...\"); &#125;&#125;public class LineChart &#123; public void draw()&#123; System.out.println(\"Draw line chart...\"); &#125;&#125;public class App &#123; public void drawChart(String type)&#123; if (type.equalsIgnoreCase(\"line\"))&#123; new LineChart().draw(); &#125;else if (type.equalsIgnoreCase(\"bar\"))&#123; new BarChart().draw(); &#125; &#125;&#125; è¿™æ ·åšåœ¨åˆæœŸæ˜¯èƒ½æ»¡è¶³ä¸šåŠ¡éœ€è¦çš„ï¼Œå¼€å‘æ•ˆç‡ä¹Ÿååˆ†é«˜ï¼Œä½†æ˜¯å½“åé¢éœ€è¦æ–°å¢ä¸€ä¸ªé¥¼çŠ¶å›¾çš„æ—¶å€™ï¼Œæ—¢è¦æ·»åŠ ä¸€ä¸ªé¥¼çŠ¶å›¾çš„ç±»ï¼ŒåŸæ¥çš„å®¢æˆ·ç«¯Appç±»çš„drawChart()æ–¹æ³•ä¹Ÿè¦æ–°å¢ä¸€ä¸ªelse ifåˆ†æ”¯ï¼Œè¿™æ ·åšå°±æ˜¯ä¿®æ”¹äº†åŸæœ‰å®¢æˆ·ç«¯ç±»åº“çš„æ–¹æ³•ï¼Œæ˜¯ååˆ†ä¸åˆç†çš„ã€‚å¦‚æœè¿™ä¸ªæ—¶å€™ï¼Œåœ¨å›¾ä¸­åŠ å…¥ä¸€ä¸ªé¢œè‰²å±æ€§ï¼Œå¤æ‚æ€§ä¹Ÿå¤§å¤§æé«˜ã€‚åŸºäºæ­¤ï¼Œéœ€è¦å¼•å…¥ä¸€ä¸ªæŠ½è±¡Chartç±»AbstractChartï¼ŒAppç±»åœ¨ç”»å›¾çš„æ—¶å€™æ€»æ˜¯æŠŠç›¸å…³çš„æ“ä½œå§”æ‰˜åˆ°å…·ä½“çš„AbstractChartçš„æ´¾ç”Ÿç±»å®ä¾‹ï¼Œè¿™æ ·çš„è¯Appç±»çš„ä»£ç å°±ä¸ç”¨ä¿®æ”¹ï¼š 123456789101112131415161718192021222324252627public abstract class AbstractChart &#123; public abstract void draw();&#125;public class BarChart extends AbstractChart&#123; @Override public void draw() &#123; System.out.println(\"Draw bar chart...\"); &#125;&#125;public class LineChart extends AbstractChart &#123; @Override public void draw() &#123; System.out.println(\"Draw line chart...\"); &#125;&#125;public class App &#123; public void drawChart(AbstractChart chart)&#123; chart.draw(); &#125;&#125; å¦‚æœæ–°åŠ ä¸€ç§å›¾ï¼Œåªéœ€è¦æ–°å¢ä¸€ä¸ªAbstractChartçš„å­ç±»å³å¯ã€‚å®¢æˆ·ç«¯ç±»Appä¸éœ€è¦æ”¹å˜åŸæ¥çš„é€»è¾‘ã€‚ä¿®æ”¹åçš„è®¾è®¡ç¬¦åˆå¼€é—­åŸåˆ™ï¼Œå› ä¸ºæ•´ä¸ªç³»ç»Ÿåœ¨æ‰©å±•æ—¶åŸæœ‰çš„ä»£ç æ²¡æœ‰åšä»»ä½•ä¿®æ”¹ã€‚ å•ä¸€èŒè´£åŸåˆ™ å•ä¸€èŒè´£åŸåˆ™ï¼ˆSingle Responsibility Principle, SRPï¼‰çš„å®šä¹‰æ˜¯ï¼šæŒ‡ä¸€ä¸ªç±»æˆ–è€…æ¨¡å—åº”è¯¥æœ‰ä¸”åªæœ‰ä¸€ä¸ªæ”¹å˜çš„åŸå› ã€‚å¦‚æœä¸€ä¸ªç±»æ‰¿æ‹…çš„èŒè´£è¿‡å¤šï¼Œå°±ç­‰äºæŠŠè¿™äº›èŒè´£è€¦åˆåœ¨ä¸€èµ·äº†ã€‚ä¸€ä¸ªèŒè´£çš„å˜åŒ–å¯èƒ½ä¼šå‰Šå¼±æˆ–è€…æŠ‘åˆ¶è¿™ä¸ªç±»å®Œæˆå…¶ä»–èŒè´£çš„èƒ½åŠ›ã€‚è¿™ç§è€¦åˆä¼šå¯¼è‡´è„†å¼±çš„è®¾è®¡ï¼Œå½“å‘ç”Ÿå˜åŒ–æ—¶ï¼Œè®¾è®¡ä¼šé­å—åˆ°æ„æƒ³ä¸åˆ°çš„ç ´åã€‚è€Œå¦‚æœæƒ³è¦é¿å…è¿™ç§ç°è±¡çš„å‘ç”Ÿï¼Œå°±è¦å°½å¯èƒ½çš„éµå®ˆå•ä¸€èŒè´£åŸåˆ™ã€‚æ­¤åŸåˆ™çš„æ ¸å¿ƒå°±æ˜¯è§£è€¦å’Œå¢å¼ºå†…èšæ€§ã€‚ å•ä¸€èŒè´£åŸåˆ™çš„æ„ä¹‰ å•ä¸€èŒè´£åŸåˆ™å‘Šè¯‰æˆ‘ä»¬ï¼šä¸€ä¸ªç±»ä¸èƒ½åšå¤ªå¤šçš„ä¸œè¥¿ã€‚åœ¨è½¯ä»¶ç³»ç»Ÿä¸­ï¼Œä¸€ä¸ªç±»(ä¸€ä¸ªæ¨¡å—ã€æˆ–è€…ä¸€ä¸ªæ–¹æ³•)æ‰¿æ‹…çš„èŒè´£è¶Šå¤šï¼Œé‚£ä¹ˆå…¶è¢«å¤ç”¨çš„å¯èƒ½æ€§å°±ä¼šè¶Šä½ã€‚ä¸€ä¸ªå¾ˆå…¸å‹çš„ä¾‹å­å°±æ˜¯ä¸‡èƒ½ç±»ã€‚å…¶å®å¯ä»¥è¯´ä¸€å¥å¤§å®è¯ï¼šä»»ä½•ä¸€ä¸ªå¸¸è§„çš„MVCé¡¹ç›®ï¼Œåœ¨æç«¯çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥ç”¨ä¸€ä¸ªç±»(ç”šè‡³ä¸€ä¸ªæ–¹æ³•)å®Œæˆæ‰€æœ‰çš„åŠŸèƒ½ã€‚ä½†æ˜¯è¿™æ ·åšå°±ä¼šä¸¥é‡è€¦åˆï¼Œç”šè‡³ç‰µä¸€å‘åŠ¨å…¨èº«ã€‚ä¸€ä¸ªç±»æ‰¿(ä¸€ä¸ªæ¨¡å—ã€æˆ–è€…ä¸€ä¸ªæ–¹æ³•)æ‹…çš„èŒè´£è¿‡å¤šï¼Œå°±ç›¸å½“äºå°†è¿™äº›èŒè´£è€¦åˆåœ¨ä¸€èµ·ï¼Œå½“å…¶ä¸­ä¸€ä¸ªèŒè´£å˜åŒ–æ—¶ï¼Œå¯èƒ½ä¼šå½±å“å…¶ä»–èŒè´£çš„è¿ä½œï¼Œå› æ­¤è¦å°†è¿™äº›èŒè´£è¿›è¡Œåˆ†ç¦»ï¼Œå°†ä¸åŒçš„èŒè´£å°è£…åœ¨ä¸åŒçš„ç±»ä¸­ï¼Œå³å°†ä¸åŒçš„å˜åŒ–åŸå› å°è£…åœ¨ä¸åŒçš„ç±»ä¸­ï¼Œå¦‚æœå¤šä¸ªèŒè´£æ€»æ˜¯åŒæ—¶å‘ç”Ÿæ”¹å˜åˆ™å¯å°†å®ƒä»¬å°è£…åœ¨åŒä¸€ç±»ä¸­ã€‚ ä¸è¿‡è¯´å®è¯ï¼Œå…¶å®æœ‰çš„æ—¶å€™å¾ˆéš¾å»è¡¡é‡ä¸€ä¸ªç±»çš„èŒè´£ï¼Œä¸»è¦æ˜¯å¾ˆéš¾ç¡®å®šèŒè´£çš„ç²’åº¦ã€‚è¿™ä¸€ç‚¹ä¸ä»…ä»…ä½“ç°åœ¨ä¸€ä¸ªç±»æˆ–è€…ä¸€ä¸ªæ¨¡å—ä¸­ï¼Œä¹Ÿä½“ç°åœ¨é‡‡ç”¨å¾®æœåŠ¡çš„åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ã€‚è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬åœ¨å®æ–½å¾®æœåŠ¡æ‹†åˆ†çš„æ—¶å€™ç»å¸¸ä¼šæ’•é€¼ï¼š&quot;è¿™ä¸ªåŠŸèƒ½ä¸åº”è¯¥å‘åœ¨AæœåŠ¡ä¸­ï¼Œå®ƒä¸åšè¿™ä¸ªé¢†åŸŸçš„ä¸œè¥¿ï¼Œåº”è¯¥æ”¾åœ¨BæœåŠ¡ä¸­&quot;è¯¸å¦‚æ­¤ç±»çš„äº‰è®ºã€‚å­˜åœ¨äº‰è®ºæ˜¯åˆç†çš„ï¼Œä¸è¿‡æœ€å¥½ä¸è¦ä¸äº†äº†ä¹‹ï¼Œè€Œåº”è¯¥æŒ‰ç…§é¢†åŸŸå®šä¹‰å¥½æ¯ä¸ªæœåŠ¡çš„èŒè´£(èŒè´£çš„ç²’åº¦æœ€å¥½æ‰¾ä¸šåŠ¡å’Œæ¶æ„ä¸“å®¶å’¨è¯¢)ï¼Œå¾—å‡ºç›¸å¯¹åˆç†çš„èŒè´£åˆ†é…ã€‚ ä¸‹é¢é€šè¿‡ä¸€ä¸ªå¾ˆç®€å•çš„å®ä¾‹è¯´æ˜ä¸€ä¸‹å•ä¸€èŒè´£åŸåˆ™ï¼š åœ¨ä¸€ä¸ªé¡¹ç›®ç³»ç»Ÿä»£ç ç¼–å†™çš„æ—¶å€™ï¼Œç”±äºå†å²åŸå› å’Œäººä¸ºçš„ä¸è§„èŒƒï¼Œå¯¼è‡´é¡¹ç›®æ²¡æœ‰åˆ†å±‚ï¼Œä¸€ä¸ªServiceç±»çš„ä¼ªä»£ç æ˜¯è¿™æ ·çš„ï¼š 123456789101112public class Service &#123; public UserDTO findUser(String name)&#123; Connection connection = getConnection(); PreparedStatement preparedStatement = connection.prepareStatement(\"SELECT * FROM t_user WHERE name = ?\"); preparedStatement.setObject(1, name); User user = //å¤„ç†ç»“æœ UserDTO dto = new UserDTO(); //entityå€¼æ‹·è´åˆ°dto return dto; &#125;&#125; è¿™é‡Œå‡ºç°ä¸€ä¸ªé—®é¢˜ï¼ŒServiceåšäº†å¤ªå¤šä¸œè¥¿ï¼ŒåŒ…æ‹¬æ•°æ®åº“è¿æ¥çš„ç®¡ç†ï¼ŒSqlçš„æ‰§è¡Œè¿™äº›ä¸šåŠ¡å±‚ä¸åº”è¯¥æ¥è§¦åˆ°çš„é€»è¾‘ï¼Œæ›´å¯æ€•çš„æ˜¯ï¼Œä¾‹å¦‚åˆ°æ—¶å€™å¦‚æœæ•°æ®åº“æ¢æˆäº†Oracleï¼Œè¿™ä¸ªæ–¹æ³•å°†ä¼šå¤§æ”¹ã€‚å› æ­¤ï¼Œæ‹†åˆ†å‡ºæ–°çš„DataBaseUtilsç±»ç”¨äºä¸“é—¨ç®¡ç†æ•°æ®åº“èµ„æºï¼ŒDaoç±»ç”¨äºä¸“é—¨æ‰§è¡ŒæŸ¥è¯¢å’ŒæŸ¥è¯¢ç»“æœå°è£…ï¼Œæ”¹é€ åServiceç±»çš„ä¼ªä»£ç å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223public class Service &#123; private Dao dao; public UserDTO findUser(String name)&#123; User user = dao.findUserByName(name); UserDTO dto = new UserDTO(); //entityå€¼æ‹·è´åˆ°dto return dto; &#125;&#125;public class Dao&#123; public User findUserByName(String name)&#123; Connection connection = DataBaseUtils.getConnnection(); PreparedStatement preparedStatement = connection.prepareStatement(\"SELECT * FROM t_user WHERE name = ?\"); preparedStatement.setObject(1, name); User user = //å¤„ç†ç»“æœ return user; &#125;&#125; ç°åœ¨ï¼Œå¦‚æœæœ‰æŸ¥è¯¢å°è£…çš„å˜åŠ¨åªéœ€è¦ä¿®æ”¹Daoç±»ï¼Œæ•°æ®åº“ç›¸å…³å˜åŠ¨åªéœ€è¦ä¿®æ”¹DataBaseUtilsç±»ï¼Œæ¯ä¸ªç±»çš„èŒè´£åˆ†æ˜ã€‚è¿™ä¸ªæ—¶å€™ï¼Œå¦‚æœæˆ‘ä»¬è¦æŠŠåº•å±‚çš„å­˜å‚¨ç»“æ„ç¼“æˆRedisæˆ–è€…MongoDBæ€ä¹ˆåŠï¼Œè¿™æ ·æ˜¾ç„¶è¦é‡å»ºæ•´ä¸ªDaoç±»ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œéœ€è¦è¿›è¡Œæ¥å£éš”ç¦»ï¼Œä¸‹é¢åˆ†ææ¥å£éš”ç¦»åŸåˆ™çš„æ—¶å€™å†è¯¦ç»†åˆ†æã€‚ é‡Œæ°ä»£æ¢åŸåˆ™ é‡Œæ°ä»£æ¢åŸåˆ™ï¼ˆLiskov Substitution Principleï¼ŒLSPï¼‰çš„å®šä¹‰æ˜¯ï¼šæ‰€æœ‰å¼•ç”¨åŸºç±»çš„åœ°æ–¹å¿…é¡»èƒ½é€æ˜åœ°ä½¿ç”¨å…¶å­ç±»çš„å¯¹è±¡ï¼Œä¹Ÿå¯ä»¥ç®€å•ç†è§£ä¸ºä»»ä½•åŸºç±»å¯ä»¥å‡ºç°çš„åœ°æ–¹ï¼Œå­ç±»ä¸€å®šå¯ä»¥å‡ºç°ã€‚ é‡Œæ°ä»£æ¢åŸåˆ™çš„æ„ä¹‰ åªæœ‰å½“è¡ç”Ÿç±»å¯ä»¥æ›¿æ¢æ‰åŸºç±»ï¼Œè½¯ä»¶å•ä½çš„åŠŸèƒ½ä¸å—åˆ°å½±å“æ—¶ï¼ŒåŸºç±»æ‰èƒ½çœŸæ­£è¢«å¤ç”¨ï¼Œè€Œè¡ç”Ÿç±»ä¹Ÿèƒ½å¤Ÿåœ¨åŸºç±»çš„åŸºç¡€ä¸Šå¢åŠ æ–°çš„è¡Œä¸ºã€‚é‡Œæ°ä»£æ¢åŸåˆ™æ˜¯å¯¹&quot;å¼€-é—­&quot;åŸåˆ™çš„è¡¥å……ã€‚å®ç°&quot;å¼€-é—­&quot;åŸåˆ™çš„å…³é”®æ­¥éª¤å°±æ˜¯æŠ½è±¡åŒ–ã€‚è€ŒåŸºç±»ä¸å­ç±»çš„ç»§æ‰¿å…³ç³»å°±æ˜¯æŠ½è±¡åŒ–çš„å…·ä½“å®ç°ï¼Œæ‰€ä»¥é‡Œæ°ä»£æ¢åŸåˆ™æ˜¯å¯¹å®ç°æŠ½è±¡åŒ–çš„å…·ä½“æ­¥éª¤çš„è§„èŒƒã€‚å½“ç„¶ï¼Œå¦‚æœåè¿‡æ¥ï¼Œè½¯ä»¶å•ä½ä½¿ç”¨çš„æ˜¯ä¸€ä¸ªå­ç±»å¯¹è±¡çš„è¯ï¼Œé‚£ä¹ˆå®ƒä¸ä¸€å®šèƒ½å¤Ÿä½¿ç”¨åŸºç±»å¯¹è±¡ã€‚ä¸¾ä¸ªå¾ˆç®€å•çš„ä¾‹å­è¯´æ˜è¿™ä¸ªé—®é¢˜ï¼šå¦‚æœä¸€ä¸ªæ–¹æ³•æ¥æ”¶Mapç±»å‹å‚æ•°ï¼Œé‚£ä¹ˆå®ƒä¸€å®šå¯ä»¥æ¥æ”¶Mapçš„å­ç±»å‚æ•°ä¾‹å¦‚HashMapã€LinkedHashMapã€ConcurrentHashMapç±»å‹çš„å‚æ•°ï¼›ä½†æ˜¯åè¿‡æ¥ï¼Œå¦‚æœå¦ä¸€ä¸ªæ–¹æ³•åªæ¥æ”¶HashMapç±»å‹çš„å‚æ•°ï¼Œé‚£ä¹ˆå®ƒä¸€å®šä¸èƒ½æ¥æ”¶æ‰€æœ‰Mapç±»å‹çš„å‚æ•°ï¼Œå¦åˆ™å®ƒå¯ä»¥æ¥æ”¶LinkedHashMapã€ConcurrentHashMapç±»å‹çš„å‚æ•°ã€‚ å­ç±»ä¸ºä»€ä¹ˆå¯ä»¥æ›¿æ¢åŸºç±»çš„ä½ç½® å…¶å®åŸå› å¾ˆç®€å•ï¼Œåªè¦å­˜åœ¨ç»§æ‰¿å…³ç³»ï¼ŒåŸºç±»çš„æ‰€æœ‰éç§æœ‰å±æ€§æˆ–è€…æ–¹æ³•ï¼Œå­ç±»éƒ½å¯ä»¥é€šè¿‡ç»§æ‰¿è·å¾—(ç™½ç®±å¤ç”¨)ï¼Œåè¿‡æ¥ä¸æˆç«‹ï¼Œå› ä¸ºå­ç±»å¾ˆæœ‰å¯èƒ½æ‰©å……è‡ªèº«çš„éç§æœ‰å±æ€§æˆ–è€…æ–¹æ³•ï¼Œè¿™ä¸ªæ—¶å€™ä¸èƒ½ç”¨åŸºç±»è·å–å­ç±»æ–°å¢çš„è¿™äº›å±æ€§æˆ–è€…æ–¹æ³•ã€‚ é‡Œæ°ä»£æ¢åŸåˆ™æ˜¯å®ç°å¼€é—­åŸåˆ™çš„åŸºç¡€ï¼Œå®ƒå‘Šè¯‰æˆ‘ä»¬åœ¨è®¾è®¡ç¨‹åºçš„æ—¶å€™è¿›å¯èƒ½ä½¿ç”¨åŸºç±»è¿›è¡Œå¯¹è±¡çš„å®šä¹‰å’Œå¼•ç”¨ï¼Œåœ¨è¿è¡Œæ—¶å†å†³å®šåŸºç±»çš„å…·ä½“å­ç±»å‹ã€‚ ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œå‡è®¾ä¸€ç§ä¼šå‘¼å¸çš„åŠ¨ç‰©ä½œä¸ºçˆ¶ç±»ï¼Œå­ç±»çŒªå’Œé¸Ÿä¹Ÿæœ‰è‡ªèº«çš„å‘¼å¸æ–¹å¼ï¼š 123456789101112131415161718192021222324252627282930public abstract class Animal &#123; protected abstract void breathe();&#125;public class Bird extends Animal &#123; @Override public void breathe() &#123; System.out.println(\"Bird breathes...\"); &#125;&#125;public class Pig extends Animal &#123; @Override public void breathe() &#123; System.out.println(\"Pig breathes...\"); &#125;&#125;public class App &#123; public static void main(String[] args) throws Exception &#123; Animal bird = new Bird(); bird.breathe(); Animal pig = new Pig(); pig.breathe(); &#125;&#125; ä¾èµ–å€’è½¬åŸåˆ™ ä¾èµ–å€’è½¬åŸåˆ™ï¼ˆDependency Inversion Principleï¼ŒDIPï¼‰çš„å®šä¹‰ï¼šç¨‹åºè¦ä¾èµ–äºæŠ½è±¡æ¥å£ï¼Œä¸è¦ä¾èµ–äºå…·ä½“å®ç°ã€‚ç®€å•çš„è¯´å°±æ˜¯è¦æ±‚å¯¹æŠ½è±¡è¿›è¡Œç¼–ç¨‹ï¼Œä¸è¦å¯¹å®ç°è¿›è¡Œç¼–ç¨‹ï¼Œè¿™æ ·å°±é™ä½äº†å®¢æˆ·ä¸å®ç°æ¨¡å—é—´çš„è€¦åˆã€‚ ä¾èµ–å€’è½¬åŸåˆ™çš„æ„ä¹‰ ä¾èµ–å€’è½¬åŸåˆ™è¦æ±‚æˆ‘ä»¬åœ¨ç¨‹åºä»£ç ä¸­ä¼ é€’å‚æ•°æ—¶æˆ–åœ¨å…³è”å…³ç³»ä¸­ï¼Œå°½é‡å¼•ç”¨å±‚æ¬¡é«˜çš„æŠ½è±¡å±‚ç±»ï¼Œå³ä½¿ç”¨æ¥å£å’ŒæŠ½è±¡ç±»è¿›è¡Œå˜é‡ç±»å‹å£°æ˜ã€å‚æ•°ç±»å‹å£°æ˜ã€æ–¹æ³•è¿”å›ç±»å‹å£°æ˜ï¼Œä»¥åŠæ•°æ®ç±»å‹çš„è½¬æ¢ç­‰ï¼Œè€Œä¸è¦ç”¨å…·ä½“ç±»æ¥åšè¿™äº›äº‹æƒ…ã€‚ä¸ºäº†ç¡®ä¿è¯¥åŸåˆ™çš„åº”ç”¨ï¼Œä¸€ä¸ªå…·ä½“ç±»åº”å½“åªå®ç°æ¥å£æˆ–æŠ½è±¡ç±»ä¸­å£°æ˜è¿‡çš„æ–¹æ³•ï¼Œè€Œä¸è¦ç»™å‡ºå¤šä½™çš„æ–¹æ³•ï¼Œå¦åˆ™å°†æ— æ³•è°ƒç”¨åˆ°åœ¨å­ç±»ä¸­å¢åŠ çš„æ–°æ–¹æ³•ã€‚åœ¨å¼•å…¥æŠ½è±¡å±‚åï¼Œç³»ç»Ÿå°†å…·æœ‰å¾ˆå¥½çš„çµæ´»æ€§ï¼Œåœ¨ç¨‹åºä¸­å°½é‡ä½¿ç”¨æŠ½è±¡å±‚è¿›è¡Œç¼–ç¨‹ï¼Œè€Œå°†å…·ä½“ç±»å†™åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œè¿™æ ·ä¸€æ¥ï¼Œå¦‚æœç³»ç»Ÿè¡Œä¸ºå‘ç”Ÿå˜åŒ–ï¼Œåªéœ€è¦å¯¹æŠ½è±¡å±‚è¿›è¡Œæ‰©å±•ï¼Œå¹¶ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œè€Œæ— é¡»ä¿®æ”¹åŸæœ‰ç³»ç»Ÿçš„æºä»£ç ï¼Œåœ¨ä¸ä¿®æ”¹çš„æƒ…å†µä¸‹æ¥æ‰©å±•ç³»ç»Ÿçš„åŠŸèƒ½ï¼Œæ»¡è¶³å¼€é—­åŸåˆ™çš„è¦æ±‚ã€‚ ä¾èµ–å€’è½¬åŸåˆ™çš„æ³¨æ„äº‹é¡¹ é«˜å±‚æ¨¡å—ä¸åº”è¯¥ä¾èµ–ä½å±‚æ¨¡å—ï¼Œé«˜å±‚æ¨¡å—å’Œä½å±‚æ¨¡å—éƒ½åº”è¯¥ä¾èµ–äºæŠ½è±¡ã€‚ æŠ½è±¡ä¸åº”è¯¥ä¾èµ–äºå…·ä½“ï¼Œå…·ä½“åº”è¯¥ä¾èµ–äºæŠ½è±¡ã€‚ åœ¨å®ç°ä¾èµ–å€’è½¬åŸåˆ™æ—¶ï¼Œæˆ‘ä»¬éœ€è¦é’ˆå¯¹æŠ½è±¡å±‚ç¼–ç¨‹ï¼Œè€Œå°†å…·ä½“ç±»çš„å¯¹è±¡é€šè¿‡ä¾èµ–æ³¨å…¥(DependencyInjection, DI)çš„æ–¹å¼æ³¨å…¥åˆ°å…¶ä»–å¯¹è±¡ä¸­ï¼Œä¾èµ–æ³¨å…¥æ˜¯æŒ‡å½“ä¸€ä¸ªå¯¹è±¡è¦ä¸å…¶ä»–å¯¹è±¡å‘ç”Ÿä¾èµ–å…³ç³»æ—¶ï¼Œé€šè¿‡æŠ½è±¡æ¥æ³¨å…¥æ‰€ä¾èµ–çš„å¯¹è±¡ã€‚å¸¸ç”¨çš„æ³¨å…¥æ–¹å¼æœ‰ä¸‰ç§ï¼Œåˆ†åˆ«æ˜¯ï¼šæ„é€ æ³¨å…¥ï¼Œè®¾å€¼æ³¨å…¥ï¼ˆSetteræ³¨å…¥ï¼‰å’Œæ¥å£æ³¨å…¥ã€‚Springçš„IOCæ˜¯æ­¤å®ç°çš„å…¸èŒƒã€‚ ä»Javaè§’åº¦çœ‹å¾…ä¾èµ–å€’è½¬åŸåˆ™çš„æœ¬è´¨å°±æ˜¯ï¼šé¢å‘æ¥å£(æŠ½è±¡)ç¼–ç¨‹ã€‚ æ¯ä¸ªå…·ä½“çš„ç±»éƒ½åº”è¯¥æœ‰å…¶æ¥å£æˆ–è€…åŸºç±»ï¼Œæˆ–è€…ä¸¤è€…éƒ½å…·å¤‡ã€‚ ç±»ä¸­çš„å¼•ç”¨å¯¹è±¡åº”è¯¥æ˜¯æ¥å£æˆ–è€…åŸºç±»ã€‚ ä»»ä½•å…·ä½“ç±»éƒ½ä¸åº”è¯¥æ´¾ç”Ÿå‡ºå­ç±»ã€‚ å°½é‡ä¸è¦è¦†å†™åŸºç±»ä¸­çš„æ–¹æ³•ã€‚ ç»“åˆé‡Œæ°ä»£æ¢åŸåˆ™ä½¿ç”¨ã€‚ éµå¾ªä¾èµ–å€’è½¬åŸåˆ™çš„ä¸€ä¸ªä¾‹å­ï¼Œåœºæ™¯æ˜¯å¸æœºå¼€è½¦ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455public interface Driver &#123; void drive(); void setCar(Car car);&#125;public interface Car &#123; void run();&#125;public class DefaultDriver implements Driver &#123; private Car car; @Override public void drive() &#123; car.run(); &#125; @Override public void setCar(Car car) &#123; this.car = car; &#125;&#125;public class Bmw implements Car &#123; @Override public void run() &#123; System.out.println(\"Bmw runs...\"); &#125;&#125;public class Benz implements Car &#123; @Override public void run() &#123; System.out.println(\"Benz runs...\"); &#125;&#125;public class App &#123; public static void main(String[] args) throws Exception &#123; Driver driver = new DefaultDriver(); Car car = new Benz(); driver.setCar(car); driver.drive(); car = new Bmw(); driver.setCar(car); driver.drive(); &#125;&#125; è¿™æ ·å®ç°äº†ä¸€ä¸ªå¸æœºå¯ä»¥å¼€å„ç§ç±»å‹çš„è½¦ï¼Œå¦‚æœè¿˜æœ‰å…¶ä»–ç±»å‹çš„è½¦ï¼Œåªéœ€è¦æ–°åŠ ä¸€ä¸ªCarçš„å®ç°å³å¯ã€‚ æ¥å£éš”ç¦»åŸåˆ™ æ¥å£éš”ç¦»åŸåˆ™ï¼ˆInterface Segregation Principleï¼ŒISPï¼‰çš„å®šä¹‰æ˜¯å®¢æˆ·ç«¯ä¸åº”è¯¥ä¾èµ–å®ƒä¸éœ€è¦çš„æ¥å£ï¼Œç±»é—´çš„ä¾èµ–å…³ç³»åº”è¯¥å»ºç«‹åœ¨æœ€å°çš„æ¥å£ä¸Šã€‚ç®€å•æ¥è¯´å°±æ˜¯å»ºç«‹å•ä¸€çš„æ¥å£ï¼Œä¸è¦å»ºç«‹è‡ƒè‚¿åºå¤§çš„æ¥å£ã€‚ä¹Ÿå°±æ˜¯æ¥å£å°½é‡ç»†åŒ–ï¼ŒåŒæ—¶æ¥å£ä¸­çš„æ–¹æ³•å°½é‡å°‘ã€‚ å¦‚ä½•çœ‹å¾…æ¥å£éš”ç¦»åŸåˆ™å’Œå•ä¸€èŒè´£åŸåˆ™ å•ä¸€èŒè´£åŸåˆ™æ³¨é‡çš„æ˜¯ç±»å’Œæ¥å£çš„èŒè´£å•ä¸€ï¼Œè¿™é‡ŒèŒè´£æ˜¯ä»ä¸šåŠ¡é€»è¾‘ä¸Šåˆ’åˆ†çš„ï¼Œä½†æ˜¯åœ¨æ¥å£éš”ç¦»åŸåˆ™è¦æ±‚å½“ä¸€ä¸ªæ¥å£å¤ªå¤§æ—¶ï¼Œæˆ‘ä»¬éœ€è¦å°†å®ƒåˆ†å‰²æˆä¸€äº›æ›´ç»†å°çš„æ¥å£ï¼Œä½¿ç”¨è¯¥æ¥å£çš„å®¢æˆ·ç«¯ä»…éœ€çŸ¥é“ä¸ä¹‹ç›¸å…³çš„æ–¹æ³•å³å¯ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬åœ¨è®¾è®¡æ¥å£çš„æ—¶å€™æœ‰å¯èƒ½æ»¡è¶³å•ä¸€èŒè´£åŸåˆ™ä½†æ˜¯ä¸æ»¡è¶³æ¥å£éš”ç¦»åŸåˆ™ã€‚ æ¥å£éš”ç¦»åŸåˆ™çš„è§„èŒƒ ä½¿ç”¨æ¥å£éš”ç¦»åŸåˆ™å‰é¦–å…ˆéœ€è¦æ»¡è¶³å•ä¸€èŒè´£åŸåˆ™ã€‚ æ¥å£éœ€è¦é«˜å†…èšï¼Œä¹Ÿå°±æ˜¯æé«˜æ¥å£ã€ç±»ã€æ¨¡å—çš„å¤„ç†èƒ½åŠ›ï¼Œå°‘å¯¹å¤–å‘å¸ƒpublicçš„æ–¹æ³•ã€‚ å®šåˆ¶æœåŠ¡ï¼Œåªæä¾›è®¿é—®è€…éœ€è¦çš„æ–¹æ³•ã€‚ æ¥å£è®¾è®¡æ˜¯æœ‰é™åº¦çš„ï¼Œæ¥å£çš„è®¾è®¡ç²’åº¦è¶Šå°ï¼Œç³»ç»Ÿè¶Šçµæ´»ï¼Œä½†æ˜¯å€¼å¾—æ³¨æ„ä¸èƒ½è¿‡å°ï¼Œå¦åˆ™å˜æˆ&quot;å­—èŠ‚ç ç¼–ç¨‹&quot;ã€‚ å¦‚æœæœ‰ç”¨è¿‡spring-data-redisçš„äººå°±çŸ¥é“ï¼ŒRedisTemplateä¸­æŒæœ‰ä¸€äº›åˆ—çš„åŸºç±»ï¼Œåˆ†åˆ«æ˜¯ValueOperations(å¤„ç†K-V)ã€ListOperations(å¤„ç†Hash)ã€SetOperations(å¤„ç†é›†åˆ)ç­‰ç­‰ã€‚ 123456public interface ValueOperations&lt;K, V&gt; &#123; void set(K key, V value); void set(K key, V value, long timeout, TimeUnit unit); //....&#125; åˆæˆ/èšåˆå¤ç”¨åŸåˆ™ åˆæˆ/èšåˆå¤ç”¨åŸåˆ™ï¼ˆComposite/Aggregate Reuse Principleï¼ŒCARPï¼‰ä¸€èˆ¬ä¹Ÿå«åˆæˆå¤ç”¨åŸåˆ™(Composite Reuse Principle, CRP)ï¼Œå®šä¹‰æ˜¯ï¼šå°½é‡ä½¿ç”¨åˆæˆ/èšåˆï¼Œè€Œä¸æ˜¯é€šè¿‡ç»§æ‰¿è¾¾åˆ°å¤ç”¨çš„ç›®çš„ã€‚ åˆæˆ/èšåˆå¤ç”¨åŸåˆ™å°±æ˜¯åœ¨ä¸€ä¸ªæ–°çš„å¯¹è±¡é‡Œé¢ä½¿ç”¨ä¸€äº›å·²æœ‰çš„å¯¹è±¡ï¼Œä½¿ä¹‹æˆä¸ºæ–°å¯¹è±¡çš„ä¸€éƒ¨åˆ†ï¼›æ–°çš„å¯¹è±¡é€šè¿‡å‘å†…éƒ¨æŒæœ‰çš„è¿™äº›å¯¹è±¡çš„å§”æ´¾è¾¾åˆ°å¤ç”¨å·²æœ‰åŠŸèƒ½çš„ç›®çš„ï¼Œè€Œä¸æ˜¯é€šè¿‡ç»§æ‰¿æ¥è·å¾—å·²æœ‰çš„åŠŸèƒ½ã€‚ èšåˆ(Aggregate)çš„æ¦‚å¿µ èšåˆè¡¨ç¤ºä¸€ç§å¼±çš„&quot;æ‹¥æœ‰&quot;å…³ç³»ï¼Œä¸€èˆ¬è¡¨ç°ä¸ºæ¾æ•£çš„æ•´ä½“å’Œéƒ¨åˆ†çš„å…³ç³»ï¼Œå…¶å®ï¼Œæ‰€è°“æ•´ä½“å’Œéƒ¨åˆ†ä¹Ÿå¯ä»¥æ˜¯å®Œå…¨ä¸ç›¸å…³çš„ã€‚ä¾‹å¦‚Aå¯¹è±¡æŒæœ‰Bå¯¹è±¡ï¼ŒBå¯¹è±¡å¹¶ä¸æ˜¯Aå¯¹è±¡çš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯Bå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸæ˜¯Bå¯¹è±¡è‡ªèº«ç®¡ç†ï¼Œå’ŒAå¯¹è±¡ä¸ç›¸å…³ã€‚ åˆæˆ(Composite)çš„æ¦‚å¿µ åˆæˆè¡¨ç¤ºä¸€ç§å¼ºçš„&quot;æ‹¥æœ‰&quot;å…³ç³»ï¼Œä¸€èˆ¬è¡¨ç°ä¸ºä¸¥æ ¼çš„æ•´ä½“å’Œéƒ¨åˆ†çš„å…³ç³»ï¼Œéƒ¨åˆ†å’Œæ•´ä½“çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ä¸€æ ·çš„ã€‚ èšåˆå’Œåˆæˆçš„å…³ç³» è¿™é‡Œç”¨å±±ç¾Šä¸¾ä¾‹è¯´æ˜èšåˆå’Œåˆæˆçš„å…³ç³»ï¼š ä¸ºä»€ä¹ˆè¦ç”¨åˆæˆ/èšåˆæ¥æ›¿ä»£ç»§æ‰¿è¾¾åˆ°å¤ç”¨çš„ç›®çš„ ç»§æ‰¿å¤ç”¨ç ´ååŒ…è£…ï¼Œå› ä¸ºç»§æ‰¿å°†åŸºç±»çš„å®ç°ç»†èŠ‚æš´éœ²ç»™æ´¾ç”Ÿç±»ï¼ŒåŸºç±»çš„å†…éƒ¨ç»†èŠ‚é€šå¸¸å¯¹å­ç±»æ¥è¯´æ˜¯å¯è§çš„ï¼Œè¿™ç§å¤ç”¨ä¹Ÿç§°ä¸º&quot;ç™½ç®±å¤ç”¨&quot;ã€‚è¿™é‡Œæœ‰ä¸€ä¸ªæ˜æ˜¾çš„é—®é¢˜æ˜¯ï¼šæ´¾ç”Ÿç±»ç»§æ‰¿è‡ªåŸºç±»ï¼Œå¦‚æœåŸºç±»çš„å®ç°å‘ç”Ÿæ”¹å˜ï¼Œå°†ä¼šå½±å“åˆ°æ‰€æœ‰æ´¾ç”Ÿç±»çš„å®ç°ï¼›å¦‚æœä»åŸºç±»ç»§æ‰¿è€Œæ¥çš„å®ç°æ˜¯é™æ€çš„ï¼Œä¸å¯èƒ½åœ¨è¿è¡Œæ—¶å‘ç”Ÿæ”¹å˜ï¼Œä¸å¤Ÿçµæ´»ã€‚ ç”±äºåˆæˆæˆ–èšåˆå…³ç³»å¯ä»¥å°†å·²æœ‰çš„å¯¹è±¡ï¼Œä¸€èˆ¬å«æˆå‘˜å¯¹è±¡ï¼Œçº³å…¥åˆ°æ–°å¯¹è±¡ä¸­ï¼Œä½¿ä¹‹æˆä¸ºæ–°å¯¹è±¡çš„ä¸€éƒ¨åˆ†ï¼Œå› æ­¤æ–°å¯¹è±¡å¯ä»¥è°ƒç”¨å·²æœ‰å¯¹è±¡çš„åŠŸèƒ½ï¼Œè¿™æ ·åšå¯ä»¥ä½¿å¾—æˆå‘˜å¯¹è±¡çš„å†…éƒ¨å®ç°ç»†èŠ‚å¯¹äºæ–°å¯¹è±¡ä¸å¯è§ï¼Œæ‰€ä»¥è¿™ç§å¤ç”¨åˆç§°ä¸º&quot;é»‘ç®±&quot;å¤ç”¨ï¼Œç›¸å¯¹ç»§æ‰¿å…³ç³»è€Œè¨€ï¼Œå…¶è€¦åˆåº¦ç›¸å¯¹è¾ƒä½ï¼Œæˆå‘˜å¯¹è±¡çš„å˜åŒ–å¯¹æ–°å¯¹è±¡çš„å½±å“ä¸å¤§ï¼Œå¯ä»¥åœ¨æ–°å¯¹è±¡ä¸­æ ¹æ®å®é™…éœ€è¦æœ‰é€‰æ‹©æ€§åœ°è°ƒç”¨æˆå‘˜å¯¹è±¡çš„æ“ä½œï¼›åˆæˆ/èšåˆå¤ç”¨å¯ä»¥åœ¨è¿è¡Œæ—¶åŠ¨æ€è¿›è¡Œï¼Œæ–°å¯¹è±¡å¯ä»¥åŠ¨æ€åœ°å¼•ç”¨ä¸æˆå‘˜å¯¹è±¡ç±»å‹ç›¸åŒçš„å…¶ä»–å¯¹è±¡ã€‚ å¦‚æœæœ‰é˜…è¯»è¿‡ã€ŠEffective Java 2ndã€‹çš„åŒå­¦å°±çŸ¥é“ï¼Œæ­¤ä¹¦ä¹Ÿå»ºè®®æ…ç”¨ç»§æ‰¿ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåªæœ‰æ˜ç¡®çŸ¥é“æ´¾ç”Ÿç±»å’ŒåŸºç±»æ»¡IS Açš„æ—¶å€™æ‰é€‰ç”¨ç»§æ‰¿ï¼Œå½“æ»¡è¶³HAS Aæˆ–è€…ä¸èƒ½åˆ¤æ–­çš„æƒ…å†µä¸‹åº”è¯¥é€‰ç”¨åˆæˆ/èšåˆã€‚ ä¸‹é¢ä¸¾ä¸ªå¾ˆæç«¯çš„ä¾‹å­è¯´æ˜ä¸€ä¸‹å¦‚æœåœ¨éIS Açš„æƒ…å†µä¸‹ä½¿ç”¨ç»§æ‰¿ä¼šå‡ºç°ä»€ä¹ˆé—®é¢˜ï¼š å…ˆå®šä¹‰ä¸€ä¸ªæŠ½è±¡æ‰‹ï¼Œæ‰‹æœ‰ä¸€ä¸ªæ‘‡æ‘†çš„æ–¹æ³•ï¼Œç„¶åå®šä¹‰å·¦å³æ‰‹ç»§æ‰¿æŠ½è±¡æ‰‹ï¼Œå®ç°æ‘‡æ‘†æ–¹æ³•ï¼š 1234567891011121314151617181920public abstract class AbstractHand &#123; protected abstract void swing();&#125;public class LeftHand extends AbstractHand &#123; @Override public void swing() &#123; System.out.println(\"Left hand swings...\"); &#125;&#125;public class RightHand extends AbstractHand &#123; @Override public void swing() &#123; System.out.println(\"Right hand swings...\"); &#125;&#125; ç°åœ¨çœ‹èµ·æ¥æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œå®ç°ä¹Ÿååˆ†æ­£ç¡®ï¼Œç°åœ¨å‡ºç°äº†äºº(Person)è¿™ä¸ªç±»ï¼Œå…·å¤‡æ‘‡å·¦å³æ‰‹çš„åŠŸèƒ½ï¼Œå¦‚æœä¸è€ƒè™‘IS Açš„å…³ç³»ï¼Œå¾ˆæœ‰å¯èƒ½æœ‰äººä¼šè¿™æ ·åšï¼š 1234567891011121314151617181920public abstract class AbstractSwingHand extends AbstractHand&#123; @Override protected void swing() &#123; System.out.println(\" hand swings...\"); &#125;&#125;public class Person extends AbstractSwingHand &#123; public void swingLeftHand()&#123; System.out.print(\"Left \"); super.swing(); &#125; public void swingRightHand()&#123; System.out.print(\"Right \"); super.swing(); &#125;&#125; ä¸Šé¢Personçš„å®ç°è®©äººè§‰å¾—ç™¾æ€ä¸å¾—å…¶è§£ï¼Œä½†æ˜¯å¾€å¾€è¿™ä¼šå‡ºç°åœ¨çœŸå®çš„ç¯å¢ƒä¸­ï¼Œå› ä¸ºHandä¸æ˜¯Personï¼Œæ‰€ä»¥Personç»§æ‰¿Handä¸€å®šä¼šå‡ºç°æ›²çº¿å®ç°ç­‰å¥‡è‘©é€»è¾‘ã€‚Handå’ŒPersonæ˜¯ä¸¥æ ¼çš„éƒ¨åˆ†å’Œæ•´ä½“çš„å…³ç³»ï¼Œæˆ–è€…è¯´Personå’ŒHandæ˜¯HAS Açš„å…³ç³»ï¼Œå¦‚æœä½¿ç”¨åˆæˆï¼Œé€»è¾‘å°†ä¼šååˆ†æ¸…æ™°ï¼š 123456789101112131415161718public class Person &#123; private AbstractHand leftHand; private AbstractHand rightHand; public Person() &#123; leftHand = new LeftHand(); rightHand = new RightHand(); &#125; public void swingLeftHand()&#123; leftHand.swing(); &#125; public void swingRightHand()&#123; rightHand.swing(); &#125;&#125; è¿™é‡Œä½¿ç”¨äº†åˆæˆï¼Œè¯´æ˜äº†Personå’ŒAbstractHandå®ä¾‹çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ä¸€è‡´çš„ã€‚ è¿ªç±³ç‰¹æ³•åˆ™ è¿ªç±³ç‰¹æ³•åˆ™ï¼ˆLaw of Demeterï¼ŒLODï¼‰ï¼Œæœ‰æ—¶å€™ä¹Ÿå«åšæœ€å°‘çŸ¥è¯†åŸåˆ™ï¼ˆLeast Knowledge Principleï¼ŒLKPï¼‰ï¼Œå®ƒçš„å®šä¹‰æ˜¯ï¼šä¸€ä¸ªè½¯ä»¶å®ä½“åº”å½“å°½å¯èƒ½å°‘åœ°ä¸å…¶ä»–å®ä½“å‘ç”Ÿç›¸äº’ä½œç”¨ã€‚æ¯ä¸€ä¸ªè½¯ä»¶å•ä½å¯¹å…¶ä»–çš„å•ä½éƒ½åªæœ‰æœ€å°‘çš„çŸ¥è¯†ï¼Œè€Œä¸”å±€é™äºé‚£äº›ä¸æœ¬å•ä½å¯†åˆ‡ç›¸å…³çš„è½¯ä»¶å•ä½ã€‚è¿ªç±³ç‰¹æ³•åˆ™çš„åˆè¡·åœ¨äºé™ä½ç±»ä¹‹é—´çš„è€¦åˆã€‚ç”±äºæ¯ä¸ªç±»å°½é‡å‡å°‘å¯¹å…¶ä»–ç±»çš„ä¾èµ–ï¼Œå› æ­¤ï¼Œå¾ˆå®¹æ˜“ä½¿å¾—ç³»ç»Ÿçš„åŠŸèƒ½æ¨¡å—åŠŸèƒ½ç‹¬ç«‹ï¼Œç›¸äº’ä¹‹é—´ä¸å­˜åœ¨ï¼ˆæˆ–å¾ˆå°‘æœ‰ï¼‰ä¾èµ–å…³ç³»ã€‚è¿ªç±³ç‰¹æ³•åˆ™ä¸å¸Œæœ›ç±»ä¹‹é—´å»ºç«‹ç›´æ¥çš„è”ç³»ã€‚å¦‚æœçœŸçš„æœ‰éœ€è¦å»ºç«‹è”ç³»ï¼Œä¹Ÿå¸Œæœ›èƒ½é€šè¿‡å®ƒçš„å‹å…ƒç±»ï¼ˆä¸­é—´ç±»æˆ–è€…è·³è½¬ç±»ï¼‰æ¥è½¬è¾¾ã€‚ è¿ªç±³ç‰¹æ³•åˆ™çš„è§„åˆ™ Only talk to your immediate friends(åªä¸ç›´æ¥çš„æœ‹å‹é€šè®¯)ï¼Œä¸€ä¸ªå¯¹è±¡çš„&quot;æœ‹å‹&quot;åŒ…æ‹¬ä»–æœ¬èº«(this)ã€å®ƒæŒæœ‰çš„æˆå‘˜å¯¹è±¡ã€å…¥å‚å¯¹è±¡ã€å®ƒæ‰€åˆ›å»ºçš„å¯¹è±¡ã€‚ å°½é‡å°‘å‘å¸ƒpublicçš„å˜é‡å’Œæ–¹æ³•ï¼Œä¸€æ—¦å…¬å¼€çš„å±æ€§å’Œæ–¹æ³•è¶Šå¤šï¼Œä¿®æ”¹çš„æ—¶å€™å½±å“çš„èŒƒå›´è¶Šå¤§ã€‚ â€œæ˜¯è‡ªå·±çš„å°±æ˜¯è‡ªå·±çš„â€ï¼Œå¦‚æœä¸€ä¸ªæ–¹æ³•æ”¾åœ¨æœ¬ç±»ä¸­ï¼Œæ—¢ä¸äº§ç”Ÿæ–°çš„ç±»é—´ä¾èµ–ï¼Œä¹Ÿä¸é€ æˆè´Ÿé¢çš„å½±å“ï¼Œé‚£ä¹ˆæ¬¡æ–¹æ³•å°±åº”è¯¥æ”¾åœ¨æœ¬ç±»ä¸­ã€‚ è¿ªç±³ç‰¹æ³•åˆ™çš„æ„ä¹‰ è¿ªç±³ç‰¹æ³•åˆ™çš„æ ¸å¿ƒè§‚å¿µå°±æ˜¯ç±»é—´è§£è€¦ï¼Œä¹Ÿå°±é™ä½ç±»ä¹‹é—´çš„è€¦åˆï¼Œåªæœ‰ç±»å¤„äºå¼±è€¦åˆçŠ¶æ€ï¼Œç±»çš„å¤ç”¨ç‡æ‰ä¼šæé«˜ã€‚æ‰€è°“é™ä½ç±»é—´è€¦åˆï¼Œå®é™…ä¸Šå°±æ˜¯å°½é‡å‡å°‘å¯¹è±¡ä¹‹é—´çš„äº¤äº’ï¼Œå¦‚æœä¸¤ä¸ªå¯¹è±¡ä¹‹é—´ä¸å¿…å½¼æ­¤ç›´æ¥é€šä¿¡ï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªå¯¹è±¡å°±ä¸åº”å½“å‘ç”Ÿä»»ä½•ç›´æ¥çš„ç›¸äº’ä½œç”¨ï¼Œå¦‚æœå…¶ä¸­çš„ä¸€ä¸ªå¯¹è±¡éœ€è¦è°ƒç”¨å¦ä¸€ä¸ªå¯¹è±¡çš„æŸä¸€ä¸ªæ–¹æ³•çš„è¯ï¼Œå¯ä»¥é€šè¿‡ç¬¬ä¸‰è€…è½¬å‘è¿™ä¸ªè°ƒç”¨ã€‚ç®€è¨€ä¹‹ï¼Œå°±æ˜¯é€šè¿‡å¼•å…¥ä¸€ä¸ªåˆç†çš„ç¬¬ä¸‰è€…æ¥é™ä½ç°æœ‰å¯¹è±¡ä¹‹é—´çš„è€¦åˆåº¦ã€‚ä½†æ˜¯è¿™æ ·ä¼šå¼•å‘ä¸€ä¸ªé—®é¢˜ï¼Œæœ‰å¯èƒ½äº§ç”Ÿå¤§é‡çš„ä¸­é—´ç±»æˆ–è€…è·³è½¬ç±»ï¼Œå¯¼è‡´ç³»ç»Ÿçš„å¤æ‚æ€§æé«˜ï¼Œå¯ç»´æŠ¤æ€§é™ä½ã€‚å¦‚æœä¸€å‘³è¿½æ±‚æåº¦è§£è€¦ï¼Œé‚£ä¹ˆæœ€ç»ˆæœ‰å¯èƒ½å˜æˆé¢å‘å­—èŠ‚ç ç¼–ç¨‹ç”šè‡³æ˜¯é¢å‘äºŒè¿›åˆ¶çš„0å’Œ1ç¼–ç¨‹ã€‚ ä¸¾ä¸ªå¾ˆç®€å•çš„ä¾‹å­ï¼Œä½“è‚²è€å¸ˆè¦çŸ¥é“ç­é‡Œé¢å¥³ç”Ÿçš„äººæ•°ï¼Œä»–å§”æ‰˜ä½“è‚²è¯¾ä»£è¡¨ç‚¹æ¸…å¥³ç”Ÿçš„äººæ•°ï¼š 1234567891011121314151617181920212223242526272829303132public class Girl &#123; &#125;public class GroupLeader &#123; private final List&lt;Girl&gt; girls; public GroupLeader(List&lt;Girl&gt; girls) &#123; this.girls = girls; &#125; public void countGirls() &#123; System.out.println(\"The sum of girls is \" + girls.size()); &#125;&#125;public class Teacher &#123; public void command(GroupLeader leader)&#123; leader.countGirls(); &#125;&#125;public class App &#123; public static void main(String[] args) throws Exception &#123; Teacher teacher = new Teacher(); GroupLeader groupLeader = new GroupLeader(Arrays.asList(new Girl(), new Girl())); teacher.command(groupLeader); &#125;&#125; è¿™ä¸ªä¾‹å­ä¸­ï¼Œä½“è‚²è¯¾ä»£è¡¨å°±æ˜¯ä¸­é—´ç±»ï¼Œä½“è‚²è¯¾ä»£è¡¨å¯¹äºä½“è‚²è€å¸ˆæ¥è¯´å°±æ˜¯&quot;ç›´æ¥çš„æœ‹å‹&quot;ï¼Œå¦‚æœå»æ‰ä½“è‚²è¯¾ä»£è¡¨è¿™ä¸ªä¸­é—´ç±»ï¼Œä½“è‚²è€å¸ˆå¿…é¡»äº²è‡ªæ¸…ç‚¹å¥³ç”Ÿçš„äººæ•°(å®é™…ä¸Šå°±æ•°äººæ•°è¿™ä¸ªåŠŸèƒ½ï¼Œä½“è‚²è€å¸ˆæ˜¯ä¸å¿…è¦è·å–æ‰€æœ‰å¥³ç”Ÿçš„å¯¹è±¡åˆ—è¡¨)ï¼Œè¿™æ ·åšä¼šè¿åè¿ªç±³ç‰¹æ³•åˆ™ã€‚ å°ç»“ è¯´å®è¯ï¼Œè®¾è®¡æ¨¡å¼çš„ä¸ƒå¤§åŸåˆ™ç†è§£æ˜¯æ¯”è¾ƒå›°éš¾çš„ï¼Œæˆ‘ä»¬åœ¨è®¾è®¡æ¨¡å¼çš„å­¦ä¹ å’Œåº”ç”¨ä¸­ç»å¸¸ä¼šå¬åˆ°æˆ–è€…çœ‹åˆ°&quot;XXXæ¨¡å¼ç¬¦åˆXXXåŸåˆ™&quot;ã€&quot;YYYæ¨¡å¼ä¸ç¬¦åˆYYYåŸåˆ™&quot;è¿™æ ·çš„è¯­å¥ã€‚å› æ­¤ï¼Œä¸ºäº†åˆ†æè®¾è®¡æ¨¡å¼çš„åˆç†æ€§å’Œå®Œå–„æˆ‘ä»¬æ—¥å¸¸çš„ç¼–ç ï¼ŒæŒæ¡å’Œç†è§£è¿™ä¸ƒå¤§åŸåˆ™æ˜¯ååˆ†å¿…è¦çš„ã€‚ å‚è€ƒ ã€ŠJavaè®¾è®¡æ¨¡å¼ã€‹ ã€Šè®¾è®¡æ¨¡å¼ä¹‹ç¦…-2ndã€‹ ã€Šè®¾è®¡æ¨¡å¼-å¯å¤ç”¨é¢å‘å¯¹è±¡è½¯ä»¶çš„åŸºç¡€ã€‹ (æœ¬æ–‡å®Œ c-2-d r-a-20190505)","categories":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/categories/Java/"},{"name":"Design Pattern","slug":"Java/Design-Pattern","permalink":"http://throwable.club/blog/categories/Java/Design-Pattern/"}],"tags":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/tags/Java/"},{"name":"Design Pattern","slug":"Design-Pattern","permalink":"http://throwable.club/blog/tags/Design-Pattern/"}]},{"title":"Spring Cloud Gateway-è‡ªå®šä¹‰GatewayFilter","slug":"spring-cloud-gateway-custom-gateway-filter","date":"2019-05-05T11:13:49.000Z","updated":"2019-06-11T15:21:52.913Z","comments":true,"path":"2019/05/05/spring-cloud-gateway-custom-gateway-filter/","link":"","permalink":"http://throwable.club/2019/05/05/spring-cloud-gateway-custom-gateway-filter/","excerpt":"å‰æ GatewayFilterçš„ä½œç”¨åŸŸæ˜¯æŒ‡å®šçš„è·¯ç”±é…ç½®ï¼Œè·¯ç”±é…ç½®é€‰é¡¹é‡Œé¢éœ€è¦é€šè¿‡filtersæŒ‡å®šæƒ³è¦ä½¿ç”¨çš„GatewayFilteråˆ—è¡¨ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡è‡ªå®šä¹‰GatewayFilterï¼Œåšé¢å¤–çš„æ‰©å±•ï¼Œå®ç°ä¸€äº›å†…å»ºGatewayFilterä¸å­˜åœ¨çš„åŠŸèƒ½ï¼Œå¹¶ä¸”åº”ç”¨åˆ°æˆ‘ä»¬çš„è·¯ç”±é…ç½®ä¸­ã€‚","text":"å‰æ GatewayFilterçš„ä½œç”¨åŸŸæ˜¯æŒ‡å®šçš„è·¯ç”±é…ç½®ï¼Œè·¯ç”±é…ç½®é€‰é¡¹é‡Œé¢éœ€è¦é€šè¿‡filtersæŒ‡å®šæƒ³è¦ä½¿ç”¨çš„GatewayFilteråˆ—è¡¨ã€‚æˆ‘ä»¬å¯ä»¥é€šè¿‡è‡ªå®šä¹‰GatewayFilterï¼Œåšé¢å¤–çš„æ‰©å±•ï¼Œå®ç°ä¸€äº›å†…å»ºGatewayFilterä¸å­˜åœ¨çš„åŠŸèƒ½ï¼Œå¹¶ä¸”åº”ç”¨åˆ°æˆ‘ä»¬çš„è·¯ç”±é…ç½®ä¸­ã€‚ å¦‚ä½•è‡ªå®šä¹‰GatewayFilter éœ€è¦å®šåˆ¶GatewayFilterï¼Œåˆ™éœ€è¦å®ç°org.springframework.cloud.gateway.filter.factory.GatewayFilterFactoryæ¥å£ï¼ŒGatewayFilterFactoryçš„å®šä¹‰å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455@FunctionalInterfacepublic interface GatewayFilterFactory&lt;C&gt; extends ShortcutConfigurable, Configurable&lt;C&gt; &#123; String NAME_KEY = \"name\"; String VALUE_KEY = \"value\"; default GatewayFilter apply(Consumer&lt;C&gt; consumer) &#123; C config = newConfig(); consumer.accept(config); return apply(config); &#125; default Class&lt;C&gt; getConfigClass() &#123; throw new UnsupportedOperationException(\"getConfigClass() not implemented\"); &#125; @Override default C newConfig() &#123; throw new UnsupportedOperationException(\"newConfig() not implemented\"); &#125; GatewayFilter apply(C config); default String name() &#123; return NameUtils.normalizeFilterFactoryName(getClass()); &#125; @Deprecated default ServerHttpRequest.Builder mutate(ServerHttpRequest request) &#123; return request.mutate(); &#125;&#125; public interface ShortcutConfigurable &#123; default ShortcutType shortcutType() &#123; return ShortcutType.DEFAULT; &#125; default List&lt;String&gt; shortcutFieldOrder() &#123; return Collections.emptyList(); &#125; default String shortcutFieldPrefix() &#123; return \"\"; &#125; &#125;public interface Configurable&lt;C&gt; &#123; Class&lt;C&gt; getConfigClass(); C newConfig();&#125; çœ‹èµ·æ¥æŒºå¤æ‚çš„ï¼Œä½†æ˜¯å®é™…ä¸Šå¾ˆå¤šéƒ½æ˜¯æ¥å£çš„é»˜è®¤æ–¹æ³•ï¼Œå®é™…ä¸Šè¦å®ç°çš„æ–¹æ³•å¾ˆå°‘ã€‚ å¦ä¸€ç§æ–¹å¼æ˜¯ç»§æ‰¿org.springframework.cloud.gateway.filter.factory.AbstractGatewayFilterFactoryï¼Œçœ‹æŠ½è±¡ç±»AbstractGatewayFilterFactoryçš„å®šä¹‰ï¼š 12345678910111213141516171819202122232425public abstract class AbstractGatewayFilterFactory&lt;C&gt; extends AbstractConfigurable&lt;C&gt; implements GatewayFilterFactory&lt;C&gt; &#123; @SuppressWarnings(\"unchecked\") public AbstractGatewayFilterFactory() &#123; super((Class&lt;C&gt;) Object.class); &#125; public AbstractGatewayFilterFactory(Class&lt;C&gt; configClass) &#123; super(configClass); &#125; public static class NameConfig &#123; private String name; public String getName() &#123; return name; &#125; public void setName(String name) &#123; this.name = name; &#125; &#125;&#125; æ³›å‹å‚æ•°Cæ˜¯é…ç½®ç±»ï¼Œä»ç°æœ‰çš„AbstractGatewayFilterFactoryæˆ–è€…GatewayFilterFactoryçš„å­ç±»å®ç°æ¥çœ‹ï¼Œé…ç½®ç±»ä¸€èˆ¬å®šä¹‰ä¸ºå…¬æœ‰é™æ€å†…éƒ¨ç±»ã€‚ å®ç°GatewayFilterFactoryæ¥å£æˆ–è€…ç»§æ‰¿AbstractGatewayFilterFactoryã€‚ å¯¹åº”çš„å­ç±»æ³¨å†Œåˆ°Springçš„å®¹å™¨ã€‚ è·¯ç”±é…ç½®ä¸­çš„filterså±æ€§æ·»åŠ å¯¹åº”GatewayFilteré…ç½®ï¼Œæ³¨æ„ä¸€ä¸‹ï¼Œè¿‡æ»¤å™¨åç§°ç”±GatewayFilterFactory#name()å†³å®šã€‚ å®è·µ ä¸‹é¢å®ç°GatewayFilterFactoryæ¥å£å’Œç»§æ‰¿AbstractGatewayFilterFactoryæŠ½è±¡ç±»ä¸¤ç§æ–¹å¼éƒ½åšäº†å°è¯•ã€‚ å®ç°GatewayFilterFactoryæ¥å£ å®ç°GatewayFilterFactoryæ¥å£çš„æ—¶å€™ï¼Œå‚è€ƒäº†SetRequestHeaderGatewayFilterFactoryï¼Œä¸ºæ¯ä¸ªè¯·æ±‚æ·»åŠ è‡ªå®šä¹‰çš„è¯·æ±‚å¤´ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253@Componentpublic class CustomAddRequestHeaderGatewayFilterFactory implements GatewayFilterFactory&lt;CustomAddRequestHeaderGatewayFilterFactory.CustomAddRequestHeaderConfig&gt; &#123; private final Class&lt;CustomAddRequestHeaderConfig&gt; configClass = CustomAddRequestHeaderConfig.class; @Override public List&lt;String&gt; shortcutFieldOrder() &#123; return new ArrayList&lt;&gt;(Arrays.asList(\"headerName\", \"headerValue\")); &#125; @Override public GatewayFilter apply(CustomAddRequestHeaderConfig config) &#123; return ((exchange, chain) -&gt; &#123; ServerHttpRequest request = exchange.getRequest().mutate().headers(httpHeaders -&gt; &#123; httpHeaders.set(config.getHeaderName(), config.getHeaderValue()); &#125;).build(); return chain.filter(exchange.mutate().request(request).build()); &#125;); &#125; @Override public Class&lt;CustomAddRequestHeaderConfig&gt; getConfigClass() &#123; return configClass; &#125; @Override public CustomAddRequestHeaderConfig newConfig() &#123; return BeanUtils.instantiateClass(this.configClass); &#125; public static class CustomAddRequestHeaderConfig &#123; private String headerName; private String headerValue; public String getHeaderName() &#123; return headerName; &#125; public void setHeaderName(String headerName) &#123; this.headerName = headerName; &#125; public String getHeaderValue() &#123; return headerValue; &#125; public void setHeaderValue(String headerValue) &#123; this.headerValue = headerValue; &#125; &#125;&#125; å¯ä»¥çœ‹åˆ°ï¼Œå…¶å®æœ€æ ¸å¿ƒçš„åŠŸèƒ½æ“ä½œæ˜¯éœ€è¦å®ç°GatewayFilter apply(C config)æ–¹æ³•ï¼Œç¼–å†™è‡ªå®šä¹‰çš„åŠŸèƒ½ã€‚æ³¨æ„è¿™æ®µLambdaè¡¨è¾¾å¼çš„é€»è¾‘ï¼š 123456return ((exchange, chain) -&gt; &#123; ServerHttpRequest request = exchange.getRequest().mutate().headers(httpHeaders -&gt; &#123; httpHeaders.set(config.getHeaderName(), config.getHeaderValue()); &#125;).build(); return chain.filter(exchange.mutate().request(request).build());&#125;); å…¶å®ï¼Œå®ƒå¯ä»¥ç®€å•ç†è§£ä¸ºGatewayFilteræ¥å£çš„åŒ¿åå®ç°ã€‚ application.yamlé…ç½®å¦‚ä¸‹ï¼š 12345678910spring: cloud: gateway: routes: - id: custom_add_request_header_route uri: http://localhost:9091 predicates: - Host=localhost:9090 filters: - CustomAddRequestHeader=customHeaderName,customHeaderValue ä¸ºäº†é…åˆæµ‹è¯•ï¼Œä¸‹æ¸¸æœåŠ¡æ·»åŠ ä¸€ä¸ªç«¯ç‚¹ï¼š 1234@GetMapping(value = \"/customAddRequestHeader\")public ResponseEntity&lt;String&gt; customAddRequestHeader(@RequestHeader(name = \"customHeaderName\") String value) &#123; return ResponseEntity.ok(value);&#125; 1234curl localhost:9090/order/customAddRequestHeader// å“åº”customHeaderValue ç»§æ‰¿AbstractGatewayFilterFactoryæŠ½è±¡ç±» ç»§æ‰¿AbstractGatewayFilterFactoryçš„æ–¹å¼å…¶å®å·®ä¸å¤šï¼Œæˆ‘ä»¬å°è¯•åšä¸€ä¸ªç›¸å¯¹å¤æ‚çš„æ”¹é€ ï¼šå¯¹æ¯ä¸€ä¸ªè¯·æ±‚æˆåŠŸ(çŠ¶æ€ç ä¸º200)çš„å“åº”ï¼Œæ·»åŠ ä¸€ä¸ªè‡ªå®šä¹‰çš„cookieå’Œä¸€ä¸ªå“åº”å¤´ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960@Componentpublic class CustomResponseGatewayFilterFactory extends AbstractGatewayFilterFactory&lt;CustomResponseGatewayFilterFactory.Config&gt; &#123; public CustomResponseGatewayFilterFactory() &#123; super(Config.class); &#125; @Override public GatewayFilter apply(Config config) &#123; return ((exchange, chain) -&gt; &#123; ServerHttpResponse response = exchange.getResponse(); if (HttpStatus.OK.equals(response.getStatusCode())) &#123; for (Map.Entry&lt;String, String&gt; entry : toMap(config.getCookie()).entrySet()) &#123; response.addCookie(ResponseCookie.from(entry.getKey(), entry.getValue()).build()); &#125; for (Map.Entry&lt;String, String&gt; entry : toMap(config.getHeader()).entrySet()) &#123; response.getHeaders().add(entry.getKey(), entry.getValue()); &#125; return chain.filter(exchange.mutate().response(response).build()); &#125; else &#123; return chain.filter(exchange); &#125; &#125;); &#125; @Override public List&lt;String&gt; shortcutFieldOrder() &#123; return Collections.singletonList(NAME_KEY); &#125; private static Map&lt;String, String&gt; toMap(String value) &#123; String[] split = value.split(\"=\"); Map&lt;String, String&gt; map = new HashMap&lt;&gt;(8); map.put(split[0], split[1]); return map; &#125; public static class Config &#123; private String cookie; private String header; public String getCookie() &#123; return cookie; &#125; public void setCookie(String cookie) &#123; this.cookie = cookie; &#125; public String getHeader() &#123; return header; &#125; public void setHeader(String header) &#123; this.header = header; &#125; &#125;&#125; application.yamlé…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼š 12345678910111213spring: cloud: gateway: routes: - id: custom_response_route uri: http://localhost:9091 predicates: - Host=localhost:9090 filters: - name: CustomResponse args: cookie: customCookieName=customCookieValue header: customHeaderName=customHeaderValue è¿™é‡Œæ³¨æ„ï¼Œfiltersé›†åˆä¸‹çš„nameå±æ€§æ˜¯å¿…é¡»çš„ï¼ŒæŒ‡å‘AbstractGatewayFilterFactoryå®ç°ç±»çš„name()æ–¹æ³•ï¼Œargså±æ€§æ˜¯ç”¨äºæŒ‡å®šè£…é…åˆ°Configç±»çš„å±æ€§ã€‚ 12345678curl localhost:9090/order/remote// å“åº”å¤´å¦‚ä¸‹customHeaderName: customHeaderValueContent-Type: text/plain;charset=UTF-8Content-Length: 6Date: Sun, 05 May 2019 11:06:35 GMTset-cookie: customCookieName=customCookieValue å°ç»“ è‡ªå®šä¹‰GatewayFilterå…è®¸æˆ‘ä»¬å¾ˆçµæ´»åœ°æ‰©å±•è¿‡æ»¤å™¨ï¼Œå¹¶ä¸”å¯¹äºè¯·æ±‚æˆ–è€…å“åº”æ·»åŠ è‡ªå®šä¹‰çš„ä¸€äº›å±æ€§æˆ–è€…åˆ¤æ–­é€»è¾‘ã€‚GatewayFilterä¸æ˜¯å…¨å±€ç”Ÿæ•ˆçš„ç‰¹æ€§ï¼Œä½¿å¾—æˆ‘ä»¬åœ¨ç¼–å†™è·¯ç”±é…ç½®çš„æ—¶å€™å¯ä»¥çµæ´»ç»„åˆå¤šä¸ªå·²ç»ç¼–å†™å¥½çš„GatewayFilterå®ä¾‹çš„åŠŸèƒ½ã€‚ (c-1-d e-a-20190505)","categories":[{"name":"Spring Cloud","slug":"Spring-Cloud","permalink":"http://throwable.club/blog/categories/Spring-Cloud/"},{"name":"Spring Cloud Gateway","slug":"Spring-Cloud/Spring-Cloud-Gateway","permalink":"http://throwable.club/blog/categories/Spring-Cloud/Spring-Cloud-Gateway/"}],"tags":[{"name":"Spring Cloud Gateway","slug":"Spring-Cloud-Gateway","permalink":"http://throwable.club/blog/tags/Spring-Cloud-Gateway/"},{"name":"Spring Cloud","slug":"Spring-Cloud","permalink":"http://throwable.club/blog/tags/Spring-Cloud/"}]},{"title":"Spring Cloud Gateway-è‡ªå®šä¹‰GlobalFilter","slug":"spring-cloud-gateway-custom-global-filter","date":"2019-05-05T06:43:14.000Z","updated":"2019-06-11T15:21:34.191Z","comments":true,"path":"2019/05/05/spring-cloud-gateway-custom-global-filter/","link":"","permalink":"http://throwable.club/2019/05/05/spring-cloud-gateway-custom-global-filter/","excerpt":"å‰æ GlobalFilterçš„ä½œç”¨åŸŸæ˜¯æ‰€æœ‰çš„è·¯ç”±é…ç½®ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è‡ªå®šä¹‰GlobalFilterï¼Œåšé¢å¤–çš„æ‰©å±•ï¼Œç”¨æ¥å®ç°ä¸€äº›å…¨å±€çš„åŠŸèƒ½ã€‚","text":"å‰æ GlobalFilterçš„ä½œç”¨åŸŸæ˜¯æ‰€æœ‰çš„è·¯ç”±é…ç½®ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è‡ªå®šä¹‰GlobalFilterï¼Œåšé¢å¤–çš„æ‰©å±•ï¼Œç”¨æ¥å®ç°ä¸€äº›å…¨å±€çš„åŠŸèƒ½ã€‚ å¦‚ä½•è‡ªå®šä¹‰GlobalFilter org.springframework.cloud.gateway.filter.GlobalFilterçš„æ¥å£å®šä¹‰å¦‚ä¸‹ï¼š 1234public interface GlobalFilter &#123; Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain);&#125; æˆ‘ä»¬åªéœ€è¦å®ç°org.springframework.cloud.gateway.filter.GlobalFilteræ¥å£ï¼Œå¹¶ä¸”æŠŠå®ç°ç±»æ³¨å†Œåˆ°Springçš„å®¹å™¨ä¸­å³å¯ï¼Œå®˜æ–¹ä¾‹å­å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132@Bean@Order(-1)public GlobalFilter a() &#123; return (exchange, chain) -&gt; &#123; log.info(\"first pre filter\"); return chain.filter(exchange).then(Mono.fromRunnable(() -&gt; &#123; log.info(\"third post filter\"); &#125;)); &#125;;&#125;@Bean@Order(0)public GlobalFilter b() &#123; return (exchange, chain) -&gt; &#123; log.info(\"second pre filter\"); return chain.filter(exchange).then(Mono.fromRunnable(() -&gt; &#123; log.info(\"second post filter\"); &#125;)); &#125;;&#125;@Bean@Order(1)public GlobalFilter c() &#123; return (exchange, chain) -&gt; &#123; log.info(\"third pre filter\"); return chain.filter(exchange).then(Mono.fromRunnable(() -&gt; &#123; log.info(\"first post filter\"); &#125;)); &#125;;&#125; å®è·µ æˆ‘ä»¬é€šè¿‡è‡ªå®šä¹‰å®ç°ä¸€ä¸ªGlobalFilterï¼Œå®ç°ç±»ä¼¼Nginxçš„Access Logçš„åŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯å¯¹æ¯ä¸€ä¸ªè¯·æ±‚éƒ½è®°å½•è¯·æ±‚çš„ä¸€äº›æ ¸å¿ƒå‚æ•°å’Œå“åº”çš„ä¸€äº›æ ¸å¿ƒå‚æ•°ã€‚æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä»¬å®ç°çš„è¿™ä¸ªGlobalFilteræ˜¯preç±»å‹åŒæ—¶æ˜¯postç±»å‹ã€‚ 12345678910111213141516@Slf4j@Componentpublic class AccessLogGlobalFilter implements GlobalFilter &#123; @Override public Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) &#123; ServerHttpRequest request = exchange.getRequest(); String path = request.getPath().pathWithinApplication().value(); InetSocketAddress remoteAddress = request.getRemoteAddress(); return chain.filter(exchange).then(Mono.fromRunnable(() -&gt; &#123; ServerHttpResponse response = exchange.getResponse(); HttpStatus statusCode = response.getStatusCode(); log.info(\"è¯·æ±‚è·¯å¾„:&#123;&#125;,è¿œç¨‹IPåœ°å€:&#123;&#125;,å“åº”ç :&#123;&#125;\", path, remoteAddress, statusCode); &#125;)); &#125;&#125; ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åªæ‰“å°äº†ï¼š è¯·æ±‚çš„è·¯å¾„ã€‚ è¯·æ±‚çš„è¿œç¨‹IPåœ°å€ã€‚ å“åº”ç ã€‚ 1curl http://localhost:9090/order/remote æ—¥å¿—è¾“å‡ºå¦‚ä¸‹ï¼š 12019-05-04 19:13:19.101 INFO 25388 --- [ctor-http-nio-7] c.t.route.support.AccessLogGlobalFilter : è¯·æ±‚è·¯å¾„:/order/remote,è¿œç¨‹IPåœ°å€:/0:0:0:0:0:0:0:1:63861,å“åº”ç :200 OK è¿™æ ·æ˜¾ç„¶ä¸å¤Ÿè¯¦ç»†ï¼Œæˆ‘ä»¬æ¥ç€å°è¯•æ·»åŠ ä¸‹é¢çš„å‚æ•°ï¼š å¦‚æœæ˜¯GETè¯·æ±‚ï¼Œåˆ™æå–å®ƒçš„Queryå‚æ•°ï¼Œå¦‚æœæ˜¯POSTè¯·æ±‚ï¼Œåˆ™å°è¯•è¯»å–RequestBodyçš„å‚æ•°ï¼Œæ‰“å°è¯·æ±‚çš„å‚æ•°ã€‚ è¯·æ±‚æ–¹æ³•ã€‚ ç›®æ ‡URIã€‚ ä¿®æ”¹ä»£ç å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849@Slf4j@Componentpublic class AccessLogGlobalFilter implements GlobalFilter &#123; private final ObjectMapper mapper = new ObjectMapper(); private final DataBufferFactory dataBufferFactory = new NettyDataBufferFactory(ByteBufAllocator.DEFAULT); @Override public Mono&lt;Void&gt; filter(ServerWebExchange exchange, GatewayFilterChain chain) &#123; ServerHttpRequest request = exchange.getRequest(); String path = request.getPath().pathWithinApplication().value(); HttpMethod method = request.getMethod(); StringBuilder builder = new StringBuilder(); URI targetUri = exchange.getAttribute(ServerWebExchangeUtils.GATEWAY_REQUEST_URL_ATTR); if (HttpMethod.GET.equals(method)) &#123; MultiValueMap&lt;String, String&gt; queryParams = request.getQueryParams(); try &#123; builder.append(mapper.writeValueAsString(queryParams)); &#125; catch (JsonProcessingException e) &#123; log.error(e.getMessage(), e); &#125; &#125; else if (HttpMethod.POST.equals(method)) &#123; Flux&lt;DataBuffer&gt; body = request.getBody(); ServerHttpRequest serverHttpRequest = request.mutate().uri(request.getURI()).build(); body.subscribe(dataBuffer -&gt; &#123; InputStream inputStream = dataBuffer.asInputStream(); try &#123; builder.append(StreamUtils.copyToString(inputStream, StandardCharsets.UTF_8)); &#125; catch (IOException e) &#123; log.error(e.getMessage(), e); &#125; &#125;); // é‡å†™è¯·æ±‚ä½“,å› ä¸ºè¯·æ±‚ä½“æ•°æ®åªèƒ½è¢«æ¶ˆè´¹ä¸€æ¬¡ request = new ServerHttpRequestDecorator(serverHttpRequest) &#123; @Override public Flux&lt;DataBuffer&gt; getBody() &#123; return Flux.just(dataBufferFactory.wrap(builder.toString().getBytes(StandardCharsets.UTF_8))); &#125; &#125;; &#125; InetSocketAddress remoteAddress = request.getRemoteAddress(); return chain.filter(exchange.mutate().request(request).build()).then(Mono.fromRunnable(() -&gt; &#123; ServerHttpResponse response = exchange.getResponse(); HttpStatus statusCode = response.getStatusCode(); log.info(\"è¯·æ±‚è·¯å¾„:&#123;&#125;,è¿œç¨‹IPåœ°å€:&#123;&#125;,è¯·æ±‚æ–¹æ³•:&#123;&#125;,è¯·æ±‚å‚æ•°:&#123;&#125;,ç›®æ ‡URI:&#123;&#125;,å“åº”ç :&#123;&#125;\", path, remoteAddress, method, builder.toString(), targetUri, statusCode); &#125;)); &#125;&#125; 1curl -X POST -d \"name=doge\" localhost:9090/order/remote ç”±äºä¸‹æ¸¸æœåŠ¡åªæ¥å—GETæ–¹æ³•è¯·æ±‚ï¼Œç½‘å…³æ‰“å°æ—¥å¿—å¦‚ä¸‹ï¼š 1è¯·æ±‚è·¯å¾„:/order/remote,è¿œç¨‹IPåœ°å€:/0:0:0:0:0:0:0:1:65158,è¯·æ±‚æ–¹æ³•:POST,è¯·æ±‚å‚æ•°:name=doge,ç›®æ ‡URI:http://localhost:9091/order/remote,å“åº”ç :405 METHOD_NOT_ALLOWED å°ç»“ å…¶å®ï¼ŒGlobalFilteræ—¢ç„¶ä¼šå¯¹æ‰€æœ‰çš„è·¯ç”±é…ç½®éƒ½ç”Ÿæ•ˆï¼Œæˆ‘ä»¬æ‰©å±•å®ƒå®ç°çš„åŠŸèƒ½æ˜¯ä¸€èˆ¬å…¨å±€çš„åŠŸèƒ½ã€‚ä¸Šé¢çš„ä¾‹å­ä¸­æ¶‰åŠåˆ°é‡æ–°è£…é¥°è¯·æ±‚å¯¹è±¡ï¼Œè§£æè¯·æ±‚å‚æ•°çš„æ“ä½œä¼šæœ‰ä¸€å®šçš„æ€§èƒ½æŸè€—ï¼Œå…·ä½“è¦çœ‹å®é™…çš„åº”ç”¨åœºæ™¯ã€‚ (c-1-d e-a-20190505)","categories":[{"name":"Spring Cloud","slug":"Spring-Cloud","permalink":"http://throwable.club/blog/categories/Spring-Cloud/"},{"name":"Spring Cloud Gateway","slug":"Spring-Cloud/Spring-Cloud-Gateway","permalink":"http://throwable.club/blog/categories/Spring-Cloud/Spring-Cloud-Gateway/"}],"tags":[{"name":"Spring Cloud Gateway","slug":"Spring-Cloud-Gateway","permalink":"http://throwable.club/blog/tags/Spring-Cloud-Gateway/"},{"name":"Spring Cloud","slug":"Spring-Cloud","permalink":"http://throwable.club/blog/tags/Spring-Cloud/"}]},{"title":"Spring Cloud Gatewayå…¥å‘è®°","slug":"spring-cloud-gateway-guide","date":"2019-05-03T10:41:44.000Z","updated":"2019-06-11T15:21:05.025Z","comments":true,"path":"2019/05/03/spring-cloud-gateway-guide/","link":"","permalink":"http://throwable.club/2019/05/03/spring-cloud-gateway-guide/","excerpt":"å‰æ æœ€è¿‘åœ¨åšè€ç³»ç»Ÿçš„é‡æ„ï¼Œé‡æ„å®Œæˆåæ–°ç³»ç»Ÿä¸­éœ€è¦å¼•å…¥ä¸€ä¸ªç½‘å…³æœåŠ¡ï¼Œä½œä¸ºæ–°ç³»ç»Ÿå’Œè€ç³»ç»Ÿæ¥å£çš„é€‚é…å’Œä»£ç†ã€‚ä¹‹å‰ï¼Œå¾ˆå¤šç½‘å…³åº”ç”¨ä½¿ç”¨çš„æ˜¯Spring-Cloud-NetfilxåŸºäºZuul1.xç‰ˆæœ¬å®ç°çš„é‚£å¥—æ–¹æ¡ˆï¼Œä½†æ˜¯é‰´äºZuul1.xå·²ç»åœæ­¢è¿­ä»£ï¼Œå®ƒä½¿ç”¨çš„æ˜¯æ¯”è¾ƒä¼ ç»Ÿçš„é˜»å¡(B)IO + å¤šçº¿ç¨‹çš„å®ç°æ–¹æ¡ˆï¼Œå…¶å®æ€§èƒ½ä¸å¤ªå¥½ã€‚åæ¥Springå›¢é˜Ÿå¹²è„†è‡ªå·±é‡æ–°ç ”å‘äº†ä¸€å¥—ç½‘å…³ç»„ä»¶ï¼Œè¿™ä¸ªå°±æ˜¯æœ¬æ¬¡è¦è°ƒç ”çš„Spring-Cloud-Gatewayã€‚ ç®€ä»‹ Spring Cloud Gatewayä¾èµ–äºSpring Boot 2.0, Spring WebFlux,å’ŒProject Reactorã€‚è®¸å¤šç†Ÿæ‚‰çš„åŒæ­¥ç±»åº“(ä¾‹å¦‚Spring-Dataå’ŒSpring-Security)å’ŒåŒæ­¥ç¼–ç¨‹æ¨¡å¼åœ¨Spring Cloud Gatewayä¸­å¹¶ä¸é€‚ç”¨ï¼Œæ‰€ä»¥æœ€å¥½å…ˆé˜…è¯»ä¸€ä¸‹ä¸Šé¢æåˆ°çš„ä¸‰ä¸ªæ¡†æ¶çš„æ–‡æ¡£ã€‚ Spring Cloud Gatewayä¾èµ–äºSpring Bootå’ŒSpring WebFluxæä¾›çš„åŸºäºNettyçš„è¿è¡Œæ—¶ç¯å¢ƒï¼Œå®ƒå¹¶éæ„å»ºä¸ºä¸€ä¸ªWARåŒ…æˆ–è€…è¿è¡Œåœ¨ä¼ ç»Ÿçš„Servletå®¹å™¨ä¸­ã€‚","text":"å‰æ æœ€è¿‘åœ¨åšè€ç³»ç»Ÿçš„é‡æ„ï¼Œé‡æ„å®Œæˆåæ–°ç³»ç»Ÿä¸­éœ€è¦å¼•å…¥ä¸€ä¸ªç½‘å…³æœåŠ¡ï¼Œä½œä¸ºæ–°ç³»ç»Ÿå’Œè€ç³»ç»Ÿæ¥å£çš„é€‚é…å’Œä»£ç†ã€‚ä¹‹å‰ï¼Œå¾ˆå¤šç½‘å…³åº”ç”¨ä½¿ç”¨çš„æ˜¯Spring-Cloud-NetfilxåŸºäºZuul1.xç‰ˆæœ¬å®ç°çš„é‚£å¥—æ–¹æ¡ˆï¼Œä½†æ˜¯é‰´äºZuul1.xå·²ç»åœæ­¢è¿­ä»£ï¼Œå®ƒä½¿ç”¨çš„æ˜¯æ¯”è¾ƒä¼ ç»Ÿçš„é˜»å¡(B)IO + å¤šçº¿ç¨‹çš„å®ç°æ–¹æ¡ˆï¼Œå…¶å®æ€§èƒ½ä¸å¤ªå¥½ã€‚åæ¥Springå›¢é˜Ÿå¹²è„†è‡ªå·±é‡æ–°ç ”å‘äº†ä¸€å¥—ç½‘å…³ç»„ä»¶ï¼Œè¿™ä¸ªå°±æ˜¯æœ¬æ¬¡è¦è°ƒç ”çš„Spring-Cloud-Gatewayã€‚ ç®€ä»‹ Spring Cloud Gatewayä¾èµ–äºSpring Boot 2.0, Spring WebFlux,å’ŒProject Reactorã€‚è®¸å¤šç†Ÿæ‚‰çš„åŒæ­¥ç±»åº“(ä¾‹å¦‚Spring-Dataå’ŒSpring-Security)å’ŒåŒæ­¥ç¼–ç¨‹æ¨¡å¼åœ¨Spring Cloud Gatewayä¸­å¹¶ä¸é€‚ç”¨ï¼Œæ‰€ä»¥æœ€å¥½å…ˆé˜…è¯»ä¸€ä¸‹ä¸Šé¢æåˆ°çš„ä¸‰ä¸ªæ¡†æ¶çš„æ–‡æ¡£ã€‚ Spring Cloud Gatewayä¾èµ–äºSpring Bootå’ŒSpring WebFluxæä¾›çš„åŸºäºNettyçš„è¿è¡Œæ—¶ç¯å¢ƒï¼Œå®ƒå¹¶éæ„å»ºä¸ºä¸€ä¸ªWARåŒ…æˆ–è€…è¿è¡Œåœ¨ä¼ ç»Ÿçš„Servletå®¹å™¨ä¸­ã€‚ ä¸“æœ‰åè¯ è·¯ç”±(Route)ï¼šè·¯ç”±æ˜¯ç½‘å…³çš„åŸºæœ¬ç»„ä»¶ã€‚å®ƒç”±IDï¼Œç›®æ ‡URIï¼Œè°“è¯(Predicate)é›†åˆå’Œè¿‡æ»¤å™¨é›†åˆå®šä¹‰ã€‚å¦‚æœè°“è¯èšåˆåˆ¤æ–­ä¸ºçœŸï¼Œåˆ™åŒ¹é…è·¯ç”±ã€‚ è°“è¯(Predicate)ï¼šä½¿ç”¨çš„æ˜¯Java8ä¸­åŸºäºå‡½æ•°å¼ç¼–ç¨‹å¼•å…¥çš„java.util.Predicateã€‚ä½¿ç”¨è°“è¯(èšåˆ)åˆ¤æ–­çš„æ—¶å€™ï¼Œè¾“å…¥çš„å‚æ•°æ˜¯ServerWebExchangeç±»å‹ï¼Œå®ƒå…è®¸å¼€å‘è€…åŒ¹é…æ¥è‡ªHTTPè¯·æ±‚çš„ä»»æ„å‚æ•°ï¼Œä¾‹å¦‚HTTPè¯·æ±‚å¤´ã€HTTPè¯·æ±‚å‚æ•°ç­‰ç­‰ã€‚ è¿‡æ»¤å™¨(Filter)ï¼šä½¿ç”¨çš„æ˜¯æŒ‡å®šçš„GatewayFilterå·¥å‚æ‰€åˆ›å»ºå‡ºæ¥çš„GatewayFilterå®ä¾‹ï¼Œå¯ä»¥åœ¨å‘é€è¯·æ±‚åˆ°ä¸‹æ¸¸ä¹‹å‰æˆ–è€…ä¹‹åä¿®æ”¹è¯·æ±‚(å‚æ•°)æˆ–è€…å“åº”(å‚æ•°)ã€‚ å…¶å®Filterè¿˜åŒ…æ‹¬äº†GlobalFilterï¼Œä¸è¿‡åœ¨å®˜æ–¹æ–‡æ¡£ä¸­æ²¡æœ‰æåˆ°ã€‚ å·¥ä½œåŸç† å®¢æˆ·ç«¯å‘Spring Cloud Gatewayå‘å‡ºè¯·æ±‚ï¼Œå¦‚æœGateway Handler Mappingæ¨¡å—å¤„ç†å½“å‰è¯·æ±‚å¦‚æœåŒ¹é…åˆ°ä¸€ä¸ªç›®æ ‡è·¯ç”±é…ç½®ï¼Œè¯¥è¯·æ±‚å°±ä¼šè½¬å‘åˆ°Gateway Web Handleræ¨¡å—ã€‚Gateway Web Handleræ¨¡å—åœ¨å‘é€è¯·æ±‚çš„æ—¶å€™ï¼Œä¼šæŠŠè¯¥è¯·æ±‚é€šè¿‡ä¸€ä¸ªåŒ¹é…äºè¯¥è¯·æ±‚çš„è¿‡æ»¤å™¨é“¾ã€‚ä¸Šå›¾ä¸­è¿‡æ»¤å™¨è¢«è™šçº¿åˆ†éš”çš„åŸå› æ˜¯ï¼šè¿‡æ»¤å™¨çš„å¤„ç†é€»è¾‘å¯ä»¥åœ¨ä»£ç†è¯·æ±‚å‘é€ä¹‹å‰æˆ–è€…ä¹‹åæ‰§è¡Œã€‚æ‰€æœ‰preç±»å‹çš„è¿‡æ»¤å™¨æ‰§è¡Œä¹‹åï¼Œä»£ç†è¯·æ±‚æ‰ä¼šåˆ›å»º(å’Œå‘é€)ï¼Œå½“ä»£ç†è¯·æ±‚åˆ›å»º(å’Œå‘é€)å®Œæˆä¹‹åï¼Œæ‰€æœ‰çš„postç±»å‹çš„è¿‡æ»¤å™¨æ‰ä¼šæ‰§è¡Œã€‚ è§ä¸Šå›¾ï¼Œå¤–éƒ¨è¯·æ±‚è¿›æ¥åå¦‚æœè½å…¥è¿‡æ»¤å™¨é“¾ï¼Œé‚£ä¹ˆè™šçº¿å·¦è¾¹çš„å°±æ˜¯preç±»å‹çš„è¿‡æ»¤å™¨ï¼Œè¯·æ±‚å…ˆç»è¿‡preç±»å‹çš„è¿‡æ»¤å™¨ï¼Œå†å‘é€åˆ°ç›®æ ‡è¢«ä»£ç†çš„æœåŠ¡ã€‚ç›®æ ‡è¢«ä»£ç†çš„æœåŠ¡å“åº”è¯·æ±‚ï¼Œå“åº”ä¼šå†æ¬¡ç»è¿‡æ»¤å™¨é“¾ï¼Œä¹Ÿå°±æ˜¯èµ°è™šçº¿å³ä¾§çš„è¿‡æ»¤å™¨é“¾ï¼Œè¿™äº›è¿‡æ»¤å™¨å°±æ˜¯postç±»å‹çš„è¿‡æ»¤å™¨ã€‚ æ³¨æ„ï¼Œå¦‚æœåœ¨è·¯ç”±é…ç½®ä¸­æ²¡æœ‰æ˜ç¡®æŒ‡å®šå¯¹åº”çš„è·¯ç”±ç«¯å£ï¼Œé‚£ä¹ˆä¼šä½¿ç”¨å¦‚ä¸‹çš„é»˜è®¤ç«¯å£ï¼š HTTPåè®®ï¼Œä½¿ç”¨80ç«¯å£ã€‚ HTTPSåè®®ï¼Œä½¿ç”¨443ç«¯å£ã€‚ å¼•å…¥ä¾èµ– å»ºè®®ç›´æ¥é€šè¿‡Trainç‰ˆæœ¬(å…¶å®ç¬”è€…è€ƒç©¶è¿‡ï¼ŒTrainç‰ˆæœ¬çš„ä»£å·å…¶å®æ˜¯ä¼¦æ•¦åœ°é“ç«™çš„å‘½åï¼Œåƒå½“å‰çš„Spring Cloudæœ€æ–°ç‰ˆæœ¬æ˜¯Greenwich.SR1ï¼ŒGreenwichå¯ä»¥åœ¨ä¼¦æ•¦åœ°é“ç«™çš„åœ°å›¾æŸ¥åˆ°è¿™ä¸ªç«™ç‚¹ï¼Œå¯¹åº”çš„SpringBootç‰ˆæœ¬æ˜¯2.1.x)å¼•å…¥Spring-Cloud-Gatewayï¼Œå› ä¸ºè¿™æ ·å¯ä»¥è·Ÿä¸Šæœ€æ–°ç¨³å®šç‰ˆæœ¬çš„Spring-Cloudç‰ˆæœ¬ï¼Œå¦å¤–ç”±äºSpring-Cloud-GatewayåŸºäºNettyçš„è¿è¡Œæ—¶ç¯å¢ƒå¯åŠ¨ï¼Œä¸éœ€è¦å¼•å…¥å¸¦Servletå®¹å™¨çš„spring-boot-starter-webã€‚ çˆ¶POMå¼•å…¥ä¸‹é¢çš„é…ç½®ï¼š 123456789101112131415161718&lt;dependencyManagement&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-dependencies&lt;/artifactId&gt; &lt;version&gt;Greenwich.SR1&lt;/version&gt; &lt;type&gt;pom&lt;/type&gt; &lt;scope&gt;import&lt;/scope&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-dependencies&lt;/artifactId&gt; &lt;version&gt;2.1.4.RELEASE&lt;/version&gt; &lt;type&gt;pom&lt;/type&gt; &lt;scope&gt;import&lt;/scope&gt; &lt;/dependency&gt; &lt;/dependencies&gt;&lt;/dependencyManagement&gt; å­æ¨¡å—æˆ–è€…éœ€è¦å¼•å…¥Spring-Cloud-Gatewayçš„æ¨¡å—POMå¼•å…¥ä¸‹é¢çš„é…ç½®ï¼š 123456&lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-gateway&lt;/artifactId&gt; &lt;/dependency&gt;&lt;/dependencies&gt; åˆ›å»ºä¸€ä¸ªå¯åŠ¨ç±»å³å¯ï¼š 1234567@SpringBootApplicationpublic class RouteServerApplication &#123; public static void main(String[] args) &#123; SpringApplication.run(RouteServerApplication.class, args); &#125;&#125; ç½‘å…³é…ç½® ç½‘å…³é…ç½®æœ€ç»ˆéœ€è¦è½¬åŒ–ä¸ºä¸€ä¸ªRouteDefinitionçš„é›†åˆï¼Œé…ç½®çš„å®šä¹‰æ¥å£å¦‚ä¸‹ï¼š 123public interface RouteDefinitionLocator &#123; Flux&lt;RouteDefinition&gt; getRouteDefinitions();&#125; é€šè¿‡YAMLæ–‡ä»¶é…ç½®æˆ–è€…æµå¼ç¼–ç¨‹å¼é…ç½®ï¼ˆå…¶å®æ–‡æ¡£ä¸­è¿˜æœ‰é…åˆEurekaçš„DiscoveryClientè¿›è¡Œé…ç½®ï¼Œè¿™é‡Œæš‚æ—¶ä¸ç ”ç©¶ï¼‰ï¼Œæœ€ç»ˆéƒ½æ˜¯ä¸ºäº†åˆ›å»ºä¸€ä¸ªRouteDefinitionçš„é›†åˆã€‚ Yamlé…ç½® é…ç½®å®ç°æ˜¯PropertiesRouteDefinitionLocatorï¼Œå…³è”ç€é…ç½®ç±»GatewayPropertiesï¼š 12345678spring: cloud: gateway: routes: - id: datetime_after_route # &lt;------ è¿™é‡Œæ˜¯è·¯ç”±é…ç½®çš„ID uri: http://www.throwable.club # &lt;------ è¿™é‡Œæ˜¯è·¯ç”±æœ€ç»ˆç›®æ ‡Serverçš„URI(Host) predicates: # &lt;------ è°“è¯é›†åˆé…ç½®ï¼Œå¤šä¸ªæ˜¯ç”¨andé€»è¾‘è¿æ¥ - Path=/blog # &lt;------- Key(name)=Expressionï¼Œé”®æ˜¯è°“è¯è§„åˆ™å·¥å‚çš„IDï¼Œå€¼ä¸€èˆ¬æ˜¯åŒ¹é…è§„åˆ™çš„æ­£åˆ™è¡¨ç¤º ç¼–ç¨‹å¼æµå¼é…ç½® ç¼–ç¨‹å¼å’Œæµå¼ç¼–ç¨‹é…ç½®éœ€è¦ä¾èµ–RouteLocatorBuilderï¼Œç›®æ ‡æ˜¯æ„é€ ä¸€ä¸ªRouteLocatorå®ä¾‹ï¼š 12345678@Beanpublic RouteLocator customRouteLocator(RouteLocatorBuilder builder) &#123; return builder.routes() .route(r -&gt; r.path(\"/blog\") .uri(\"http://www.throwable.club\") ) .build();&#125; è·¯ç”±è°“è¯å·¥å‚ Spring Cloud Gatewayå°†è·¯ç”±(Route)ä½œä¸ºSpring-WebFluxçš„HandlerMappingç»„ä»¶åŸºç¡€è®¾æ–½çš„ä¸€éƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯HandlerMappingè¿›è¡ŒåŒ¹é…çš„æ—¶å€™ï¼Œä¼šæŠŠé…ç½®å¥½çš„è·¯ç”±è§„åˆ™ä¹Ÿçº³å…¥åŒ¹é…æœºåˆ¶ä¹‹ä¸­ã€‚Spring Cloud Gatewayè‡ªèº«åŒ…å«äº†å¾ˆå¤šå†…å»ºçš„è·¯ç”±è°“è¯å·¥å‚ã€‚è¿™äº›è°“è¯åˆ†åˆ«åŒ¹é…ä¸€ä¸ªHTTPè¯·æ±‚çš„ä¸åŒå±æ€§ã€‚å¤šä¸ªè·¯ç”±è°“è¯å·¥å‚å¯ä»¥ç”¨andçš„é€»è¾‘ç»„åˆåœ¨ä¸€èµ·ã€‚ ç›®å‰Spring Cloud Gatewayæä¾›çš„å†…ç½®çš„è·¯ç”±è°“è¯å·¥å‚å¦‚ä¸‹ï¼š æŒ‡å®šæ—¥æœŸæ—¶é—´è§„åˆ™è·¯ç”±è°“è¯ æŒ‰ç…§é…ç½®çš„æ—¥æœŸæ—¶é—´æŒ‡å®šçš„è·¯ç”±è°“è¯æœ‰ä¸‰ç§å¯é€‰è§„åˆ™ï¼š åŒ¹é…è¯·æ±‚åœ¨æŒ‡å®šæ—¥æœŸæ—¶é—´ä¹‹å‰ã€‚ åŒ¹é…è¯·æ±‚åœ¨æŒ‡å®šæ—¥æœŸæ—¶é—´ä¹‹åã€‚ åŒ¹é…è¯·æ±‚åœ¨æŒ‡å®šæ—¥æœŸæ—¶é—´ä¹‹é—´ã€‚ å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œé…ç½®çš„æ—¥æœŸæ—¶é—´å¿…é¡»æ»¡è¶³ZonedDateTimeçš„æ ¼å¼ï¼š 12//å¹´æœˆæ—¥å’Œæ—¶åˆ†ç§’ç”¨'T'åˆ†éš”,æ¥ç€-07:00æ˜¯å’ŒUTCç›¸å·®çš„æ—¶é—´ï¼Œæœ€åçš„[America/Denver]æ˜¯æ‰€åœ¨çš„æ—¶é—´åœ°åŒº2017-01-20T17:42:47.789-07:00[America/Denver] ä¾‹å¦‚ç½‘å…³çš„åº”ç”¨æ˜¯2019-05-01T00:00:00+08:00[Asia/Shanghai]ä¸Šçº¿çš„ï¼Œä¸Šçº¿ä¹‹åçš„è¯·æ±‚éƒ½è·¯ç”±å¥¥www.throwable.clubï¼Œé‚£ä¹ˆé…ç½®å¦‚ä¸‹ï¼š 12345678910server port: 9090spring: cloud: gateway: routes: - id: datetime_after_route uri: http://www.throwable.club predicates: - After=2019-05-01T00:00:00+08:00[Asia/Shanghai] æ­¤æ—¶ï¼Œåªè¦è¯·æ±‚ç½‘å…³http://localhost:9090ï¼Œè¯·æ±‚å°±ä¼šè½¬å‘åˆ°http://www.throwable.clubã€‚ å¦‚æœæƒ³è¦åªå…è®¸2019-05-01T00:00:00+08:00[Asia/Shanghai]ä¹‹å‰çš„è¯·æ±‚ï¼Œé‚£ä¹ˆåªéœ€è¦æ”¹ä¸ºï¼š 12345678910server port: 9091spring: cloud: gateway: routes: - id: datetime_before_route uri: http://www.throwable.club predicates: - Before=2019-05-01T00:00:00+08:00[Asia/Shanghai] å¦‚æœåªå…è®¸ä¸¤ä¸ªæ—¥æœŸæ—¶é—´æ®µä¹‹é—´çš„æ—¶é—´è¿›è¡Œè¯·æ±‚ï¼Œé‚£ä¹ˆåªéœ€è¦æ”¹ä¸ºï¼š 12345678910server port: 9090spring: cloud: gateway: routes: - id: datetime_between_route uri: http://www.throwable.club predicates: - Between=2019-05-01T00:00:00+08:00[Asia/Shanghai],2019-05-02T00:00:00+08:00[Asia/Shanghai] é‚£ä¹ˆåªæœ‰2019å¹´5æœˆ1æ—¥0æ—¶åˆ°5æœˆ2æ—¥0æ—¶çš„è¯·æ±‚æ‰èƒ½æ­£å¸¸è·¯ç”±ã€‚ Cookieè·¯ç”±è°“è¯ CookieRoutePredicateFactoryéœ€è¦æä¾›ä¸¤ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯Cookieçš„nameå’Œä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼(value)ã€‚åªæœ‰åœ¨è¯·æ±‚ä¸­çš„Cookieå¯¹åº”çš„nameå’Œvalueå’ŒCookieè·¯ç”±è°“è¯ä¸­é…ç½®çš„å€¼åŒ¹é…çš„æ—¶å€™ï¼Œæ‰èƒ½åŒ¹é…å‘½ä¸­è¿›è¡Œè·¯ç”±ã€‚ 12345678910server port: 9090spring: cloud: gateway: routes: - id: cookie_route uri: http://www.throwable.club predicates: - Cookie=doge,throwable è¯·æ±‚éœ€è¦æºå¸¦ä¸€ä¸ªCookieï¼Œnameä¸ºdogeï¼Œvalueéœ€è¦åŒ¹é…æ­£åˆ™è¡¨è¾¾å¼&quot;throwable&quot;æ‰èƒ½è·¯ç”±åˆ°http://www.throwable.clubã€‚ è¿™é‡Œå°è¯•æœ¬åœ°æ­å»ºä¸€ä¸ªè®¢å•OrderæœåŠ¡ï¼ŒåŸºäºSpringBoot2.1.4æ­å»ºï¼Œå¯åŠ¨åœ¨9091ç«¯å£ï¼š 123456789101112131415// å…¥å£ç±»@RestController@RequestMapping(path = \"/order\")@SpringBootApplicationpublic class OrderServiceApplication &#123; public static void main(String[] args) &#123; SpringApplication.run(OrderServiceApplication.class, args); &#125; @GetMapping(value = \"/cookie\") public ResponseEntity&lt;String&gt; cookie(@CookieValue(name = \"doge\") String doge) &#123; return ResponseEntity.ok(doge); &#125;&#125; è®¢å•æœåŠ¡application.yamlé…ç½®ï¼š 1234567891011121314151617181920spring: application: name: order-serviceserver: port: 9091``` ç½‘å…³è·¯ç”±é…ç½®ï¼š```yamlspring: application: name: route-server cloud: gateway: routes: - id: cookie_route uri: http://localhost:9091 predicates: - Cookie=doge,throwable 1234curl http://localhost:9090/order/cookie --cookie \"doge=throwable\"//å“åº”ç»“æœthrowable Headerè·¯ç”±è°“è¯ HeaderRoutePredicateFactoryéœ€è¦æä¾›ä¸¤ä¸ªå‚æ•°ï¼Œåˆ†åˆ«æ˜¯Headerçš„nameå’Œä¸€ä¸ªæ­£åˆ™è¡¨è¾¾å¼(value)ã€‚åªæœ‰åœ¨è¯·æ±‚ä¸­çš„Headerå¯¹åº”çš„nameå’Œvalueå’ŒHeaderè·¯ç”±è°“è¯ä¸­é…ç½®çš„å€¼åŒ¹é…çš„æ—¶å€™ï¼Œæ‰èƒ½åŒ¹é…å‘½ä¸­è¿›è¡Œè·¯ç”±ã€‚ è®¢å•æœåŠ¡ä¸­æ–°å¢ä¸€ä¸ª/headerç«¯ç‚¹ï¼š 1234567891011121314@RestController@RequestMapping(path = \"/order\")@SpringBootApplicationpublic class OrderServiceApplication &#123; public static void main(String[] args) &#123; SpringApplication.run(OrderServiceApplication.class, args); &#125; @GetMapping(value = \"/header\") public ResponseEntity&lt;String&gt; header(@RequestHeader(name = \"accessToken\") String accessToken) &#123; return ResponseEntity.ok(accessToken); &#125;&#125; ç½‘å…³çš„è·¯ç”±é…ç½®å¦‚ä¸‹ï¼š 12345678spring: cloud: gateway: routes: - id: header_route uri: http://localhost:9091 predicates: - Header=accessToken,Doge 1234curl -H \"accessToken:Doge\" http://localhost:9090/order/header//å“åº”ç»“æœDoge Hostè·¯ç”±è°“è¯ HostRoutePredicateFactoryåªéœ€è¦æŒ‡å®šä¸€ä¸ªä¸»æœºååˆ—è¡¨ï¼Œåˆ—è¡¨ä¸­çš„æ¯ä¸ªå…ƒç´ æ”¯æŒAntå‘½åæ ·å¼ï¼Œä½¿ç”¨.ä½œä¸ºåˆ†éš”ç¬¦ï¼Œå¤šä¸ªå…ƒç´ ä¹‹é—´ä½¿ç”¨,åŒºåˆ†ã€‚Hostè·¯ç”±è°“è¯å®é™…ä¸Šé’ˆå¯¹çš„æ˜¯HTTPè¯·æ±‚å¤´ä¸­çš„Hostå±æ€§ã€‚ è®¢å•æœåŠ¡ä¸­æ–°å¢ä¸€ä¸ª/headerç«¯ç‚¹ï¼š 1234567891011121314@RestController@RequestMapping(path = \"/order\")@SpringBootApplicationpublic class OrderServiceApplication &#123; public static void main(String[] args) &#123; SpringApplication.run(OrderServiceApplication.class, args); &#125; @GetMapping(value = \"/host\") public ResponseEntity&lt;String&gt; host(@RequestHeader(name = \"Host\") String host) &#123; return ResponseEntity.ok(host); &#125;&#125; ç½‘å…³çš„è·¯ç”±é…ç½®å¦‚ä¸‹ï¼š 12345678spring: cloud: gateway: routes: - id: host_route uri: http://localhost:9091 predicates: - Host=localhost:9090 1234curl http://localhost:9090/order/host//å“åº”ç»“æœlocalhost:9091 # &lt;--------- è¿™é‡Œè¦æ³¨æ„ä¸€ä¸‹ï¼Œè·¯ç”±åˆ°è®¢å•æœåŠ¡çš„æ—¶å€™ï¼ŒHostä¼šè¢«ä¿®æ”¹ä¸ºlocalhost:9091 å…¶å®å¯ä»¥å®šåˆ¶æ›´å¤šæ ·åŒ–çš„HoståŒ¹é…æ¨¡å¼ï¼Œç”šè‡³å¯ä»¥æ”¯æŒURIæ¨¡æ¿å˜é‡ã€‚ 123- Host=www.throwable.**,**.throwable.**- Host=&#123;sub&#125;.throwable.club è¯·æ±‚æ–¹æ³•è·¯ç”±è°“è¯ MethodRoutePredicateFactoryåªéœ€è¦ä¸€ä¸ªå‚æ•°ï¼šè¦åŒ¹é…çš„HTTPè¯·æ±‚æ–¹æ³•ã€‚ ç½‘å…³çš„è·¯ç”±é…ç½®å¦‚ä¸‹ï¼š 12345678spring: cloud: gateway: routes: - id: method_route uri: http://localhost:9091 predicates: - Method=GET è¿™æ ·é…ç½®ï¼Œæ‰€æœ‰çš„è¿›å…¥åˆ°ç½‘å…³çš„GETæ–¹æ³•çš„è¯·æ±‚éƒ½ä¼šè·¯ç”±åˆ°http://localhost:9091ã€‚ è®¢å•æœåŠ¡ä¸­æ–°å¢ä¸€ä¸ª/getç«¯ç‚¹ï¼š 1234@GetMapping(value = \"/get\")public ResponseEntity&lt;String&gt; get() &#123; return ResponseEntity.ok(\"get\");&#125; 1234curl http://localhost:9090/order/get//å“åº”ç»“æœget è¯·æ±‚è·¯å¾„è·¯ç”±è°“è¯ PathRoutePredicateFactoryéœ€è¦PathMatcheræ¨¡å¼è·¯å¾„åˆ—è¡¨å’Œä¸€ä¸ªå¯é€‰çš„æ ‡å¿—ä½å‚æ•°matchOptionalTrailingSeparatorã€‚è¿™ä¸ªæ˜¯æœ€å¸¸ç”¨çš„ä¸€ä¸ªè·¯ç”±è°“è¯ã€‚ 12345678spring: cloud: gateway: routes: - id: path_route uri: http://localhost:9091 predicates: - Path=/order/path 1234@GetMapping(value = \"/path\")public ResponseEntity&lt;String&gt; path() &#123; return ResponseEntity.ok(\"path\");&#125; 1234curl http://localhost:9090/order/path//å“åº”ç»“æœpath æ­¤å¤–ï¼Œå¯ä»¥é€šè¿‡{segment}å ä½ç¬¦é…ç½®è·¯å¾„å¦‚/foo/1æˆ–/foo/baræˆ–/bar/bazï¼Œå¦‚æœé€šè¿‡è¿™ç§å½¢å¼é…ç½®ï¼Œåœ¨åŒ¹é…å‘½ä¸­è¿›è¡Œè·¯ç”±çš„æ—¶å€™ï¼Œä¼šæå–è·¯å¾„ä¸­å¯¹åº”çš„å†…å®¹å¹¶ä¸”å°†é”®å€¼å¯¹æ”¾åœ¨ServerWebExchange.getAttributes()é›†åˆä¸­ï¼ŒKEYä¸ºServerWebExchangeUtils.URI_TEMPLATE_VARIABLES_ATTRIBUTEï¼Œè¿™äº›æå–å‡ºæ¥çš„å±æ€§å¯ä»¥ä¾›GatewayFilter Factoriesä½¿ç”¨ã€‚ è¯·æ±‚æŸ¥è¯¢å‚æ•°è·¯ç”±è°“è¯ QueryRoutePredicateFactoryéœ€è¦ä¸€ä¸ªå¿…é¡»çš„è¯·æ±‚æŸ¥è¯¢å‚æ•°(paramçš„name)ä»¥åŠä¸€ä¸ªå¯é€‰çš„æ­£åˆ™è¡¨è¾¾å¼(regexp)ã€‚ 12345678spring: cloud: gateway: routes: - id: query_route uri: http://localhost:9091 predicates: - Query=doge,throwabl. è¿™é‡Œé…ç½®çš„paramå°±æ˜¯dogeï¼Œæ­£åˆ™è¡¨è¾¾å¼æ˜¯throwabl.ã€‚ 1234@GetMapping(value = \"/query\")public ResponseEntity&lt;String&gt; query(@RequestParam(\"name\") String doge) &#123; return ResponseEntity.ok(doge);&#125; 1234curl http://localhost:9090/order/query?doge=throwable//å“åº”ç»“æœthrowable è¿œç¨‹IPåœ°å€è·¯ç”±è°“è¯ RemoteAddrRoutePredicateFactoryåŒ¹é…è§„åˆ™é‡‡ç”¨CIDRç¬¦å·ï¼ˆIPv4æˆ–IPv6ï¼‰å­—ç¬¦ä¸²çš„åˆ—è¡¨ï¼ˆæœ€å°å€¼ä¸º1ï¼‰ï¼Œä¾‹å¦‚192.168.0.1/16ï¼ˆå…¶ä¸­192.168.0.1æ˜¯è¿œç¨‹IPåœ°å€å¹¶ä¸”16æ˜¯å­ç½‘æ©ç ï¼‰ã€‚ 12345678spring: cloud: gateway: routes: - id: remoteaddr_route uri: http://localhost:9091 predicates: - RemoteAddr=127.0.0.1 1234@GetMapping(value = \"/remote\")public ResponseEntity&lt;String&gt; remote() &#123; return ResponseEntity.ok(\"remote\");&#125; 1234curl http://localhost:9090/order/remote//å“åº”ç»“æœremote å…³äºè¿œç¨‹IPè·¯ç”±è¿™ä¸€ä¸ªè·¯ç”±è°“è¯å…¶å®è¿˜æœ‰å¾ˆå¤šæ‰©å±•æ‰‹æ®µï¼Œè¿™é‡Œæš‚æ—¶ä¸å±•å¼€ã€‚ å¤šä¸ªè·¯ç”±è°“è¯ç»„åˆ å› ä¸ºè·¯ç”±é…ç½®ä¸­çš„predicateså±æ€§å…¶å®æ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œå¯ä»¥ç›´æ¥æ·»åŠ å¤šä¸ªè·¯ç”±è§„åˆ™ï¼š 12345678910spring: cloud: gateway: routes: - id: remoteaddr_route uri: http://localhost:9091 predicates: - RemoteAddr=xxxx - Path=/yyyy - Query=zzzz,aaaa è¿™äº›è§„åˆ™æ˜¯ç”¨andé€»è¾‘ç»„åˆçš„ï¼Œä¾‹å¦‚ä¸Šé¢çš„ä¾‹å­ç›¸å½“äºï¼š 12345request = ...if(request.getRemoteAddr == 'xxxx' &amp;&amp; request.getPath match '/yyyy' &amp;&amp; request.getQuery('zzzz') match 'aaaa') &#123; return true;&#125;return false; GatewayFilterå·¥å‚ è·¯ç”±è¿‡æ»¤å™¨GatewayFilterå…è®¸ä¿®æ”¹è¿›æ¥çš„HTTPè¯·æ±‚å†…å®¹æˆ–è€…è¿”å›çš„HTTPå“åº”å†…å®¹ã€‚è·¯ç”±è¿‡æ»¤å™¨çš„ä½œç”¨åŸŸæ˜¯ä¸€ä¸ªå…·ä½“çš„è·¯ç”±é…ç½®ã€‚Spring Cloud Gatewayæä¾›äº†ä¸°å¯Œçš„å†…å»ºçš„GatewayFilterå·¥å‚ï¼Œå¯ä»¥æŒ‰éœ€é€‰ç”¨ã€‚ å› ä¸ºGatewayFilterå·¥å‚ç±»å®åœ¨å¤ªå¤šï¼Œç¬”è€…è¿™é‡Œä¸¾ä¸ªç®€å•çš„ä¾‹å­ã€‚ å¦‚æœæˆ‘ä»¬æƒ³å¯¹æŸäº›è¯·æ±‚é™„åŠ ç‰¹æ®Šçš„HTTPè¯·æ±‚å¤´ï¼Œå¯ä»¥é€‰ç”¨AddRequestHeaderX-Request-Foo:Barï¼Œapplication.ymlå¦‚ä¸‹ï¼š 12345678spring: cloud: gateway: routes: - id: add_request_header_route uri: https://example.org filters: - AddRequestHeader=X-Request-Foo,Bar é‚£ä¹ˆæ‰€æœ‰çš„ä»ç½‘å…³å…¥å£çš„HTTPè¯·æ±‚éƒ½ä¼šæ·»åŠ ä¸€ä¸ªç‰¹æ®Šçš„HTTPè¯·æ±‚å¤´ï¼šX-Request-Foo:Barã€‚ ç›®å‰GatewayFilterå·¥å‚çš„å†…å»ºå®ç°å¦‚ä¸‹ï¼š ID ç±»å ç±»å‹ åŠŸèƒ½ StripPrefix StripPrefixGatewayFilterFactory pre ç§»é™¤è¯·æ±‚URLè·¯å¾„çš„ç¬¬ä¸€éƒ¨åˆ†ï¼Œä¾‹å¦‚åŸå§‹è¯·æ±‚è·¯å¾„æ˜¯/order/queryï¼Œå¤„ç†åæ˜¯/query SetStatus SetStatusGatewayFilterFactory post è®¾ç½®è¯·æ±‚å“åº”çš„çŠ¶æ€ç ï¼Œä¼šä»org.springframework.http.HttpStatusä¸­è§£æ SetResponseHeader SetResponseHeaderGatewayFilterFactory post è®¾ç½®(æ·»åŠ )è¯·æ±‚å“åº”çš„å“åº”å¤´ SetRequestHeader SetRequestHeaderGatewayFilterFactory pre è®¾ç½®(æ·»åŠ )è¯·æ±‚å¤´ SetPath SetPathGatewayFilterFactory pre è®¾ç½®(è¦†ç›–)è¯·æ±‚è·¯å¾„ SecureHeader SecureHeadersGatewayFilterFactory pre è®¾ç½®å®‰å…¨ç›¸å…³çš„è¯·æ±‚å¤´ï¼Œè§SecureHeadersProperties SaveSession SaveSessionGatewayFilterFactory pre ä¿å­˜WebSession RewriteResponseHeader RewriteResponseHeaderGatewayFilterFactory post é‡æ–°å“åº”å¤´ RewritePath RewritePathGatewayFilterFactory pre é‡å†™è¯·æ±‚è·¯å¾„ Retry RetryGatewayFilterFactory pre åŸºäºæ¡ä»¶å¯¹è¯·æ±‚è¿›è¡Œé‡è¯• RequestSize RequestSizeGatewayFilterFactory pre é™åˆ¶è¯·æ±‚çš„å¤§å°ï¼Œå•ä½æ˜¯byteï¼Œè¶…è¿‡è®¾å®šå€¼è¿”å›413 Payload Too Large RequestRateLimiter RequestRateLimiterGatewayFilterFactory pre é™æµ RequestHeaderToRequestUri RequestHeaderToRequestUriGatewayFilterFactory pre é€šè¿‡è¯·æ±‚å¤´çš„å€¼æ”¹å˜è¯·æ±‚URL RemoveResponseHeader RemoveResponseHeaderGatewayFilterFactory post ç§»é™¤é…ç½®çš„å“åº”å¤´ RemoveRequestHeader RemoveRequestHeaderGatewayFilterFactory pre ç§»é™¤é…ç½®çš„è¯·æ±‚å¤´ RedirectTo RedirectToGatewayFilterFactory pre é‡å®šå‘ï¼Œéœ€è¦æŒ‡å®šHTTPçŠ¶æ€ç å’Œé‡å®šå‘URL PreserveHostHeader PreserveHostHeaderGatewayFilterFactory pre è®¾ç½®è¯·æ±‚æºå¸¦çš„å±æ€§preserveHostHeaderä¸ºtrue PrefixPath PrefixPathGatewayFilterFactory pre è¯·æ±‚è·¯å¾„æ·»åŠ å‰ç½®è·¯å¾„ Hystrix HystrixGatewayFilterFactory pre æ•´åˆHystrix FallbackHeaders FallbackHeadersGatewayFilterFactory pre Hystrixæ‰§è¡Œå¦‚æœå‘½ä¸­é™çº§é€»è¾‘å…è®¸é€šè¿‡è¯·æ±‚å¤´æºå¸¦å¼‚å¸¸æ˜ç»†ä¿¡æ¯ AddResponseHeader AddResponseHeaderGatewayFilterFactory post æ·»åŠ å“åº”å¤´ AddRequestParameter AddRequestParameterGatewayFilterFactory pre æ·»åŠ è¯·æ±‚å‚æ•°ï¼Œä»…ä»…é™äºURLçš„Queryå‚æ•° AddRequestHeader AddRequestHeaderGatewayFilterFactory pre æ·»åŠ è¯·æ±‚å¤´ GatewayFilterå·¥å‚ä½¿ç”¨çš„æ—¶å€™éœ€è¦çŸ¥é“å…¶IDä»¥åŠé…ç½®æ–¹å¼ï¼Œé…ç½®æ–¹å¼å¯ä»¥çœ‹å¯¹åº”å·¥å‚ç±»çš„å…¬æœ‰é™æ€å†…éƒ¨ç±»XXXXConfigã€‚ GlobalFilterå·¥å‚ GlobalFilterçš„åŠŸèƒ½å…¶å®å’ŒGatewayFilteræ˜¯ç›¸åŒçš„ï¼Œåªæ˜¯GlobalFilterçš„ä½œç”¨åŸŸæ˜¯æ‰€æœ‰çš„è·¯ç”±é…ç½®ï¼Œè€Œä¸æ˜¯ç»‘å®šåœ¨æŒ‡å®šçš„è·¯ç”±é…ç½®ä¸Šã€‚å¤šä¸ªGlobalFilterå¯ä»¥é€šè¿‡@Orderæˆ–è€…getOrder()æ–¹æ³•æŒ‡å®šæ¯ä¸ªGlobalFilterçš„æ‰§è¡Œé¡ºåºï¼Œorderå€¼è¶Šå°ï¼ŒGlobalFilteræ‰§è¡Œçš„ä¼˜å…ˆçº§è¶Šé«˜ã€‚ æ³¨æ„ï¼Œç”±äºè¿‡æ»¤å™¨æœ‰preå’Œpostä¸¤ç§ç±»å‹ï¼Œpreç±»å‹è¿‡æ»¤å™¨å¦‚æœorderå€¼è¶Šå°ï¼Œé‚£ä¹ˆå®ƒå°±åº”è¯¥åœ¨preè¿‡æ»¤å™¨é“¾çš„é¡¶å±‚ï¼Œpostç±»å‹è¿‡æ»¤å™¨å¦‚æœorderå€¼è¶Šå°ï¼Œé‚£ä¹ˆå®ƒå°±åº”è¯¥åœ¨preè¿‡æ»¤å™¨é“¾çš„åº•å±‚ã€‚ç¤ºæ„å›¾å¦‚ä¸‹ï¼š ä¾‹å¦‚è¦å®ç°è´Ÿè½½å‡è¡¡çš„åŠŸèƒ½ï¼Œapplication.ymlé…ç½®å¦‚ä¸‹ï¼š 12345678spring: cloud: gateway: routes: - id: myRoute uri: lb://myservice # &lt;-------- lbç‰¹æ®Šæ ‡è®°ä¼šä½¿ç”¨LoadBalancerClientæœç´¢ç›®æ ‡æœåŠ¡è¿›è¡Œè´Ÿè½½å‡è¡¡ predicates: - Path=/service/** ç›®å‰Spring Cloud Gatewayæä¾›çš„å†…å»ºçš„GlobalFilterå¦‚ä¸‹ï¼š ç±»å åŠŸèƒ½ ForwardRoutingFilter é‡å®šå‘ LoadBalancerClientFilter è´Ÿè½½å‡è¡¡ NettyRoutingFilter Nettyçš„HTTPå®¢æˆ·ç«¯çš„è·¯ç”± NettyWriteResponseFilter Nettyå“åº”è¿›è¡Œå†™æ“ä½œ RouteToRequestUrlFilter åŸºäºè·¯ç”±é…ç½®æ›´æ–°URL WebsocketRoutingFilter Websocketè¯·æ±‚è½¬å‘åˆ°ä¸‹æ¸¸ å†…å»ºçš„GlobalFilterå¤§å¤šæ•°å’ŒServerWebExchangeUtilsçš„å±æ€§ç›¸å…³ï¼Œè¿™é‡Œå°±ä¸æ·±å…¥å±•å¼€ã€‚ è·¨åŸŸé…ç½® ç½‘å…³å¯ä»¥é€šè¿‡é…ç½®æ¥æ§åˆ¶å…¨å±€çš„CORSè¡Œä¸ºã€‚å…¨å±€çš„CORSé…ç½®å¯¹åº”çš„ç±»æ˜¯CorsConfigurationï¼Œè¿™ä¸ªé…ç½®æ˜¯ä¸€ä¸ªURLæ¨¡å¼çš„æ˜ å°„ã€‚ä¾‹å¦‚application.yamlæ–‡ä»¶å¦‚ä¸‹ï¼š 123456789spring: cloud: gateway: globalcors: corsConfigurations: '[/**]': allowedOrigins: \"https://docs.spring.io\" allowedMethods: - GET åœ¨ä¸Šé¢çš„ç¤ºä¾‹ä¸­ï¼Œå¯¹äºæ‰€æœ‰è¯·æ±‚çš„è·¯å¾„ï¼Œå°†å…è®¸æ¥è‡ªdocs.spring.ioå¹¶ä¸”æ˜¯GETæ–¹æ³•çš„CORSè¯·æ±‚ã€‚ Actuatorç«¯ç‚¹ç›¸å…³ å¼•å…¥spring-boot-starter-actuatorï¼Œéœ€è¦åšä»¥ä¸‹é…ç½®å¼€å¯gatewayç›‘æ§ç«¯ç‚¹ï¼š 12management.endpoint.gateway.enabled=true management.endpoints.web.exposure.include=gateway ç›®å‰æ”¯æŒçš„ç«¯ç‚¹åˆ—è¡¨ï¼š ID è¯·æ±‚è·¯å¾„ HTTPæ–¹æ³• æè¿° globalfilters /actuator/gateway/globalfilters GET å±•ç¤ºè·¯ç”±é…ç½®ä¸­çš„GlobalFilteråˆ—è¡¨ routefilters /actuator/gateway/routefilters GET å±•ç¤ºç»‘å®šåˆ°å¯¹åº”è·¯ç”±é…ç½®çš„GatewayFilteråˆ—è¡¨ refresh /actuator/gateway/refresh POST æ¸…ç©ºè·¯ç”±é…ç½®ç¼“å­˜ routes /actuator/gateway/routes GET å±•ç¤ºå·²ç»å®šä¹‰çš„è·¯ç”±é…ç½®åˆ—è¡¨ routes/{id} /actuator/gateway/routes/{id} GET å±•ç¤ºå¯¹åº”IDå·²ç»å®šä¹‰çš„è·¯ç”±é…ç½® routes/{id} /actuator/gateway/routes/{id} POST æ·»åŠ ä¸€ä¸ªæ–°çš„è·¯ç”±é…ç½® routes/{id} /actuator/gateway/routes/{id} DELETE åˆ é™¤æŒ‡å®šIDçš„è·¯ç”±é…ç½® å…¶ä¸­/actuator/gateway/routes/{id}æ·»åŠ ä¸€ä¸ªæ–°çš„è·¯ç”±é…ç½®è¯·æ±‚å‚æ•°çš„æ ¼å¼å¦‚ä¸‹ï¼š 12345678910&#123; \"id\": \"first_route\", \"predicates\": [&#123; \"name\": \"Path\", \"args\": &#123;\"doge\":\"/throwable\"&#125; &#125;], \"filters\": [], \"uri\": \"https://www.throwable.club\", \"order\": 0&#125; å°ç»“ ç¬”è€…è™½ç„¶æ˜¯ä¸€ä¸ªåº•å±‚çš„ç ç•œï¼Œä½†æ˜¯å¾ˆä¹…ä¹‹å‰å°±å‘èº«è¾¹çš„æœ‹å‹è¯´ï¼š ååº”å¼ç¼–ç¨‹ç»“åˆåŒæ­¥éé˜»å¡IOæˆ–è€…å¼‚æ­¥éé˜»å¡IOæ˜¯ç›®å‰ç½‘ç»œç¼–ç¨‹æ¡†æ¶çš„ä¸»æµæ–¹å‘ï¼Œæœ€å¥½è¦è·Ÿä¸Šä¸»æµçš„æ­¥ä¼æŒæ¡è¿™äº›æ¡†æ¶çš„ä½¿ç”¨ï¼Œæœ‰èƒ½åŠ›æœ€å¥½æˆä¸ºå®ƒä»¬çš„è´¡çŒ®è€…ã€‚ ç›®å‰å¸¸è§çš„ååº”å¼ç¼–ç¨‹æ¡†æ¶æœ‰ï¼š Reactorå’ŒRxJava2ï¼Œå…¶ä¸­Reactoråœ¨åç«¯çš„JVMåº”ç”¨æ¯”è¾ƒå¸¸è§ï¼ŒRxJava2åœ¨å®‰å“ç¼–å†™çš„APPå®¢æˆ·ç«¯æ¯”è¾ƒå¸¸è§ã€‚ Reactor-Nettyï¼Œè¿™ä¸ªæ˜¯åŸºäºReactorå’ŒNettyå°è£…çš„ã€‚ Spring-WebFluxå’ŒSpring-Cloud-Gatewayï¼Œå…¶ä¸­Spring-Cloud-Gatewayä¾èµ–Spring-WebFluxï¼Œè€ŒSpring-WebFluxåº•å±‚ä¾èµ–äºReactor-Nettyã€‚ æ ¹æ®è¿™ä¸ªé“¾å¼å…³ç³»ï¼Œæœ€å¥½ç³»ç»Ÿå­¦ä¹ ä¸€ä¸‹Reactorå’ŒNettyã€‚ å‚è€ƒèµ„æ–™ï¼š Spring-Cloud-Gatewayå®˜æ–¹æ–‡æ¡£ Reactorå®˜æ–¹æ–‡æ¡£ é™„å½• é€‰ç”¨Spring-Cloud-Gatewayä¸ä»…ä»…æ˜¯ä¸ºäº†ä½¿ç”¨æ–°çš„æŠ€æœ¯ï¼Œæ›´é‡è¦çš„æ˜¯å®ƒçš„æ€§èƒ½æœ‰äº†ä¸ä¿—çš„æå‡ï¼ŒåŸºå‡†æµ‹è¯•é¡¹ç›®spring-cloud-gateway-benchçš„ç»“æœå¦‚ä¸‹ï¼š ä»£ç†ç»„ä»¶(Proxy) å¹³å‡äº¤äº’å»¶è¿Ÿ(Avg Latency) å¹³å‡æ¯ç§’å¤„ç†çš„è¯·æ±‚æ•°(Avg Requests/Sec) Spring Cloud Gateway 6.61ms 32213.38 Linkered 7.62ms 28050.76 Zuul(1.x) 12.56ms 20800.13 None(ç›´æ¥è°ƒç”¨) 2.09ms 116841.15 (æœ¬æ–‡å®Œ c-3-d e-a-20190504)","categories":[{"name":"Spring Cloud","slug":"Spring-Cloud","permalink":"http://throwable.club/blog/categories/Spring-Cloud/"},{"name":"Spring Cloud Gateway","slug":"Spring-Cloud/Spring-Cloud-Gateway","permalink":"http://throwable.club/blog/categories/Spring-Cloud/Spring-Cloud-Gateway/"}],"tags":[{"name":"Spring Cloud Gateway","slug":"Spring-Cloud-Gateway","permalink":"http://throwable.club/blog/tags/Spring-Cloud-Gateway/"},{"name":"Spring Cloud","slug":"Spring-Cloud","permalink":"http://throwable.club/blog/tags/Spring-Cloud/"}]},{"title":"æ·±å…¥ç†è§£Objectæä¾›çš„é˜»å¡å’Œå”¤é†’API","slug":"java-object-wait-notify","date":"2019-04-30T03:45:00.000Z","updated":"2019-05-01T09:27:19.720Z","comments":true,"path":"2019/04/30/java-object-wait-notify/","link":"","permalink":"http://throwable.club/2019/04/30/java-object-wait-notify/","excerpt":"","text":"æ·±å…¥ç†è§£Objectæä¾›çš„é˜»å¡å’Œå”¤é†’API å‰æ å‰æ®µæ—¶é—´èŠ±äº†å¤§é‡æ—¶é—´å»ç ”è¯»JUCä¸­åŒæ­¥å™¨AbstractQueuedSynchronizerçš„æºç å®ç°ï¼Œå†ç»“åˆå¾ˆä¹…ä¹‹å‰çœ‹è¿‡çš„ä¸€ç¯‡å…³äºObjectæä¾›çš„ç­‰å¾…å’Œå”¤é†’æœºåˆ¶çš„JVMå®ç°ï¼Œå‘ç°ä¸¤è€…æœ‰ä¸å°‘çš„å…³è”ï¼Œäºæ˜¯å†³å®šé‡æ–°ç ”è¯»ä¸€ä¸‹Objectä¸­æä¾›çš„é˜»å¡å’Œå”¤é†’æ–¹æ³•ã€‚æœ¬æ–‡é˜…è¯»JDKç±»åº“æºç ä½¿ç”¨çš„JDKç‰ˆæœ¬æ˜¯JDK11ï¼Œå› ä¸ºæœ¬æ–‡å†…å®¹å¯èƒ½ä¸é€‚åˆäºå…¶ä»–ç‰ˆæœ¬ã€‚ Objectæä¾›çš„é˜»å¡å’Œå”¤é†’API java.lang.Objectä½œä¸ºæ‰€æœ‰éåŸºæœ¬ç±»å‹çš„åŸºç±»ï¼Œä¹Ÿå°±æ˜¯è¯´æ‰€æœ‰java.lang.Objectçš„å­ç±»éƒ½å…·å¤‡é˜»å¡å’Œå”¤é†’çš„åŠŸèƒ½ã€‚ä¸‹é¢è¯¦ç»†åˆ†æObjectæä¾›çš„é˜»å¡å’Œå”¤é†’APIã€‚ é˜»å¡ç­‰å¾…-wait ç­‰å¾…-wait()æ–¹æ³•æä¾›äº†é˜»å¡çš„åŠŸèƒ½ï¼Œåˆ†è¶…æ—¶å’Œæ°¸ä¹…é˜»å¡çš„ç‰ˆæœ¬ï¼Œå®é™…ä¸Šï¼Œåº•å±‚åªæä¾›äº†ä¸€ä¸ªJNIæ–¹æ³•ï¼š 123456789101112131415161718192021// è¿™ä¸ªæ˜¯åº•å±‚æä¾›çš„JNIæ–¹æ³•ï¼Œå¸¦è¶…æ—¶çš„é˜»å¡ç­‰å¾…ï¼Œå“åº”ä¸­æ–­ï¼Œå…¶ä»–ä¸¤ä¸ªåªæ˜¯å˜ä½“public final native void wait(long timeoutMillis) throws InterruptedException;// å˜ä½“æ–¹æ³•1ï¼Œæ°¸ä¹…é˜»å¡ï¼Œå“åº”ä¸­æ–­public final void wait() throws InterruptedException &#123; wait(0L);&#125;// å˜ä½“æ–¹æ³•2ï¼Œå¸¦è¶…æ—¶çš„é˜»å¡ï¼Œè¶…æ—¶æ—¶é—´åˆ†ä¸¤æ®µï¼šæ¯«ç§’å’Œçº³ç§’ï¼Œå®é™…ä¸Šçº³ç§’å¤§äº0ç›´æ¥æ¯«ç§’åŠ 1(è¿™ä¹ˆæš´åŠ›...)ï¼Œå“åº”ä¸­æ–­public final void wait(long timeoutMillis, int nanos) throws InterruptedException &#123; if (timeoutMillis &lt; 0) &#123; throw new IllegalArgumentException(\"timeoutMillis value is negative\"); &#125; if (nanos &lt; 0 || nanos &gt; 999999) &#123; throw new IllegalArgumentException(\"nanosecond timeout value out of range\"); &#125; if (nanos &gt; 0) &#123; timeoutMillis++; &#125; wait(timeoutMillis);&#125; ä¹Ÿå°±æ˜¯åªæœ‰ä¸€ä¸ªwait(long timeoutMillis)æ–¹æ³•æ˜¯JNIæ¥å£ï¼Œå…¶ä»–ä¸¤ä¸ªæ–¹æ³•ç›¸å½“äºï¼š wait()ç­‰ä»·äºwait(0L)ã€‚ wait(long timeoutMillis, int nanos)åœ¨å‚æ•°åˆæ³•çš„æƒ…å†µä¸‹ç­‰ä»·äºwait(timeoutMillis + 1L)ã€‚ ç”±äºwait(long timeoutMillis, int nanos)æ˜¯å‚æ•°æœ€å®Œæ•´çš„æ–¹æ³•ï¼Œå®ƒçš„APIæ³¨é‡Šç‰¹åˆ«é•¿ï¼Œè¿™é‡Œç›´æ¥ç¿»è¯‘å’Œæ‘˜å–å®ƒæ³¨é‡Šä¸­çš„æ ¸å¿ƒè¦ç´ ï¼š å½“å‰çº¿ç¨‹é˜»å¡ç­‰å¾…ç›´åˆ°è¢«å”¤é†’ï¼Œå”¤é†’çš„æƒ…å†µä¸€èˆ¬æœ‰ä¸‰ç§ï¼šnotify(All)è¢«è°ƒç”¨ã€çº¿ç¨‹è¢«ä¸­æ–­æˆ–è€…åœ¨æŒ‡å®šäº†è¶…æ—¶é˜»å¡çš„æƒ…å†µä¸‹è¶…è¿‡äº†æŒ‡å®šçš„é˜»å¡æ—¶é—´ã€‚ å½“å‰çº¿ç¨‹å¿…é¡»è·å–æ­¤å¯¹è±¡çš„ç›‘è§†å™¨é”(monitor lock)ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨é˜»å¡ç­‰å¾…æ–¹æ³•ä¹‹å‰ä¸€ä¸ªçº¿ç¨‹å¿…é¡»æˆä¸ºæ­¤å¯¹è±¡çš„ç›‘è§†å™¨é”çš„æ‹¥æœ‰è€…ã€‚ è°ƒç”¨äº†wait()æ–¹æ³•ä¹‹åï¼Œå½“å‰çº¿ç¨‹ä¼šæŠŠè‡ªèº«æ”¾åˆ°å½“å‰å¯¹è±¡çš„ç­‰å¾…é›†åˆ(wait-set)ï¼Œç„¶åé‡Šæ”¾æ‰€æœ‰åœ¨æ­¤å¯¹è±¡ä¸Šçš„åŒæ­¥å£°æ˜(then to relinquish any nd all synchronization claims on this object)ï¼Œè°¨è®°åªæœ‰å½“å‰å¯¹è±¡ä¸Šçš„åŒæ­¥å£°æ˜ä¼šè¢«é‡Šæ”¾ï¼Œå½“å‰çº¿ç¨‹åœ¨å…¶ä»–å¯¹è±¡ä¸Šçš„åŒæ­¥é”åªæœ‰åœ¨è°ƒç”¨å…¶wait()æ–¹æ³•ä¹‹åæ‰ä¼šé‡Šæ”¾ã€‚ Warningï¼šçº¿ç¨‹è¢«å”¤é†’ä¹‹å(notify()æˆ–è€…ä¸­æ–­)å°±ä¼šä»ç­‰å¾…é›†åˆ(wait-set)ä¸­ç§»é™¤å¹¶ä¸”é‡æ–°å…è®¸è¢«çº¿ç¨‹è°ƒåº¦å™¨è°ƒåº¦ã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œè¿™ä¸ªè¢«å”¤é†’çš„çº¿ç¨‹ä¼šä¸å…¶ä»–çº¿ç¨‹ç«äº‰å¯¹è±¡ä¸Šçš„åŒæ­¥æƒ(é”)ï¼Œä¸€æ—¦çº¿ç¨‹é‡æ–°æ§åˆ¶äº†å¯¹è±¡(regained control of the object)ï¼Œå®ƒå¯¹å¯¹è±¡çš„æ‰€æœ‰åŒæ­¥å£°æ˜éƒ½æ¢å¤åˆ°ä»¥å‰çš„çŠ¶æ€ï¼Œå³æ¢å¤åˆ°è°ƒç”¨wait()æ–¹æ³•æ—¶(ç¬”è€…è®¤ä¸ºï¼Œå…¶å®å‡†ç¡®æ¥è¯´ï¼Œæ˜¯è°ƒç”¨wait()æ–¹æ³•å‰)çš„çŠ¶æ€ã€‚ å¦‚æœä»»æ„çº¿ç¨‹åœ¨å®ƒè°ƒç”¨äº†wait()ä¹‹å‰ï¼Œæˆ–è€…è°ƒç”¨è¿‡wait()æ–¹æ³•ä¹‹åå¤„äºé˜»å¡ç­‰å¾…çŠ¶æ€ï¼Œä¸€æ—¦çº¿ç¨‹è°ƒç”¨äº†Thread#interrupt()ï¼Œçº¿ç¨‹å°±ä¼šä¸­æ–­å¹¶ä¸”æŠ›å‡ºInterruptedExceptionå¼‚å¸¸ï¼Œçº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€ä¼šè¢«æ¸…é™¤ã€‚InterruptedExceptionå¼‚å¸¸ä¼šå»¶è¿Ÿåˆ°åœ¨ç¬¬4ç‚¹æåˆ°&quot;å®ƒå¯¹å¯¹è±¡çš„æ‰€æœ‰åŒæ­¥å£°æ˜éƒ½æ¢å¤åˆ°ä»¥å‰çš„çŠ¶æ€&quot;çš„æ—¶å€™æŠ›å‡ºã€‚ å€¼å¾—æ³¨æ„çš„è¿˜æœ‰ï¼š ä¸€ä¸ªçº¿ç¨‹å¿…é¡»æˆä¸ºæ­¤å¯¹è±¡çš„ç›‘è§†å™¨é”çš„æ‹¥æœ‰è€…æ‰èƒ½æ­£å¸¸è°ƒç”¨wait()ç³»åˆ—æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯wait()ç³»åˆ—æ–¹æ³•å¿…é¡»åœ¨åŒæ­¥ä»£ç å—(synchronizedä»£ç å—)ä¸­è°ƒç”¨ï¼Œå¦åˆ™ä¼šæŠ›å‡ºIllegalMonitorStateExceptionå¼‚å¸¸ï¼Œè¿™ä¸€ç‚¹æ˜¯åˆå­¦è€…æˆ–è€…ä¸äº†è§£wait()çš„æœºåˆ¶çš„å¼€å‘è€…ç»å¸¸ä¼šçŠ¯çš„é—®é¢˜ã€‚ ä¸Šé¢çš„äº”ç‚¹æè¿°å¯ä»¥å†™ä¸ªç®€å•çš„åŒæ­¥ä»£ç å—ä¼ªä»£ç æ—¶åºæ€»ç»“ä¸€ä¸‹ï¼š 123456789101112final Object lock = new Object();synchronized(lock)&#123; 1ã€çº¿ç¨‹è¿›å…¥åŒæ­¥ä»£ç å—ï¼Œæ„å‘³ç€è·å–å¯¹è±¡ç›‘è§†å™¨é”æˆåŠŸ while(!condition)&#123; lock.wait(); 2.çº¿ç¨‹è°ƒç”¨wait()è¿›è¡Œé˜»å¡ç­‰å¾… break; &#125; 3.çº¿ç¨‹ä»wait()çš„é˜»å¡ç­‰å¾…ä¸­è¢«å”¤é†’ï¼Œæ¢å¤åˆ°ç¬¬1æ­¥ä¹‹åçš„åŒæ­¥çŠ¶æ€ 4.ç»§ç»­æ‰§è¡Œåé¢çš„ä»£ç ï¼Œç›´åˆ°ç¦»å¼€åŒæ­¥ä»£ç å—&#125; å”¤é†’-notify notify()æ–¹æ³•çš„æ–¹æ³•ç­¾åå¦‚ä¸‹ï¼š 12@HotSpotIntrinsicCandidatepublic final native void notify(); ä¸‹é¢æŒ‰ç…§æƒ¯ä¾‹ç¿»è¯‘ä¸€ä¸‹å…¶APIæ³¨é‡Šï¼š å”¤é†’ä¸€ä¸ªé˜»å¡ç­‰å¾…åœ¨æ­¤å¯¹è±¡ç›‘è§†å™¨ä¸Šçš„çº¿ç¨‹ï¼Œ(å¦‚æœå­˜åœ¨å¤šä¸ªé˜»å¡çº¿ç¨‹)è‡³äºé€‰æ‹©å“ªä¸€ä¸ªçº¿ç¨‹è¿›è¡Œå”¤é†’æ˜¯ä»»æ„çš„ï¼Œå–å†³äºå…·ä½“çš„ç°å®ï¼Œä¸€ä¸ªçº¿ç¨‹é€šè¿‡è°ƒç”¨wait()æ–¹æ³•æ‰èƒ½é˜»å¡åœ¨å¯¹è±¡ç›‘è§†å™¨ä¸Šã€‚ è¢«å”¤é†’çš„çº¿ç¨‹å¹¶ä¸ä¼šé©¬ä¸Šç»§ç»­æ‰§è¡Œï¼Œç›´åˆ°å½“å‰çº¿ç¨‹(ä¹Ÿå°±æ˜¯å½“å‰è°ƒç”¨äº†notify()æ–¹æ³•çš„çº¿ç¨‹)é‡Šæ”¾å¯¹è±¡ä¸Šçš„é”ã€‚è¢«å”¤é†’çš„çº¿ç¨‹ä¼šä¸å…¶ä»–çº¿ç¨‹ç«äº‰åœ¨å¯¹è±¡ä¸Šè¿›è¡ŒåŒæ­¥(æ¢è¨€ä¹‹åªæœ‰è·å¾—å¯¹è±¡çš„åŒæ­¥æ§åˆ¶æƒæ‰èƒ½ç»§ç»­æ‰§è¡Œ)ï¼Œåœ¨æˆä¸ºä¸‹ä¸€ä¸ªé”å®šæ­¤å¯¹è±¡çš„çº¿ç¨‹æ—¶ï¼Œè¢«å”¤é†’çš„çº¿ç¨‹æ²¡æœ‰å¯é çš„ç‰¹æƒæˆ–åŠ£åŠ¿ã€‚ æ­¤æ–¹æ³•åªæœ‰åœ¨ä¸€ä¸ªçº¿ç¨‹è·å–äº†æ­¤å¯¹è±¡ç›‘è§†å™¨çš„æ‰€æœ‰æƒ(the owner)çš„æ—¶å€™æ‰èƒ½è°ƒç”¨ï¼Œå…·ä½“å°±æ˜¯ï¼šåŒæ­¥æ–¹æ³•ä¸­ã€åŒæ­¥ä»£ç å—ä¸­æˆ–è€…é™æ€åŒæ­¥æ–¹æ³•ä¸­ã€‚å¦åˆ™ï¼Œä¼šæŠ›å‡ºIllegalMonitorStateExceptionå¼‚å¸¸ã€‚ å”¤é†’æ‰€æœ‰-notifyAll notifyAll()æ–¹æ³•çš„æ–¹æ³•ç­¾åå¦‚ä¸‹ï¼š 12@HotSpotIntrinsicCandidatepublic final native void notifyAll(); å”¤é†’æ‰€æœ‰é˜»å¡ç­‰å¾…åœ¨æ­¤å¯¹è±¡ç›‘è§†å™¨ä¸Šçš„çº¿ç¨‹ï¼Œä¸€ä¸ªçº¿ç¨‹é€šè¿‡è°ƒç”¨wait()æ–¹æ³•æ‰èƒ½é˜»å¡åœ¨å¯¹è±¡ç›‘è§†å™¨ä¸Šã€‚ å…¶ä»–æ³¨é‡Šçš„æè¿°å’Œnotify()æ–¹æ³•ç±»ä¼¼ã€‚ å°ç»“ æˆ‘ä»¬ç»å¸¸çœ‹åˆ°çš„èµ„æ–™ä¸­æåˆ°synchronizedå…³é”®å­—çš„ç”¨æ³•ï¼š æ™®é€šåŒæ­¥æ–¹æ³•ï¼ŒåŒæ­¥æˆ–è€…è¯´é”å®šçš„æ˜¯å½“å‰å®ä¾‹å¯¹è±¡ã€‚ é™æ€åŒæ­¥æ–¹æ³•ï¼ŒåŒæ­¥æˆ–è€…è¯´é”å®šçš„æ˜¯å½“å‰å®ä¾‹å¯¹è±¡çš„Classå¯¹è±¡ã€‚ åŒæ­¥ä»£ç å—ï¼ŒåŒæ­¥æˆ–è€…è¯´é”å®šçš„æ˜¯æ‹¬å·é‡Œé¢çš„å®ä¾‹å¯¹è±¡ã€‚ å¯¹äºåŒæ­¥ä»£ç å—è€Œè¨€ï¼Œsynchronizedå…³é”®å­—æŠ½è±¡åˆ°å­—èŠ‚ç å±‚é¢å°±æ˜¯åŒæ­¥ä»£ç å—ä¸­çš„å­—èŠ‚ç æ‰§è¡Œåœ¨monitorenterå’ŒmonitorexitæŒ‡ä»¤ä¹‹é—´ï¼š 12345678910synchronized(xxxx)&#123; ...coding block&#125;â†“â†“â†“â†“â†“â†“â†“â†“â†“â†“monitorenter;...coding block - bytecodemonitorexit; JVMéœ€è¦ä¿è¯æ¯ä¸€ä¸ªmonitorenteréƒ½æœ‰ä¸€ä¸ªmonitorexitä¸ä¹‹ç›¸å¯¹åº”ã€‚ä»»ä½•å¯¹è±¡éƒ½æœ‰ä¸€ä¸ªmonitor(å®é™…ä¸Šæ˜¯ObjectMonitor)ä¸ä¹‹ç›¸å…³è”ï¼Œå½“ä¸”ä¸€ä¸ªmonitorè¢«æŒæœ‰ä¹‹åï¼Œå®ƒå°†å¤„äºé”å®šçŠ¶æ€ã€‚çº¿ç¨‹æ‰§è¡Œåˆ°monitorenteræŒ‡ä»¤æ—¶ï¼Œå°†ä¼šå°è¯•è·å–å¯¹è±¡æ‰€å¯¹åº”çš„monitoræ‰€æœ‰æƒï¼Œå³å°è¯•è·å–å¯¹è±¡çš„é”ã€‚ å¯¹äºåŒæ­¥(é™æ€)æ–¹æ³•è€Œè¨€ï¼Œsynchronizedæ–¹æ³•åˆ™ä¼šè¢«ç¿»è¯‘æˆæ™®é€šçš„æ–¹æ³•è°ƒç”¨å’Œè¿”å›æŒ‡ä»¤ï¼Œå¦‚ï¼šinvokevirtualç­‰ç­‰ï¼Œåœ¨JVMå­—èŠ‚ç å±‚é¢å¹¶æ²¡æœ‰ä»»ä½•ç‰¹åˆ«çš„æŒ‡ä»¤æ¥å®ç°è¢«synchronizedä¿®é¥°çš„æ–¹æ³•ï¼Œè€Œæ˜¯åœ¨Classæ–‡ä»¶çš„æ–¹æ³•è¡¨ä¸­å°†è¯¥æ–¹æ³•çš„access_flagså­—æ®µä¸­çš„synchronizedæ ‡å¿—ä½ç½®1ï¼Œè¡¨ç¤ºè¯¥æ–¹æ³•æ˜¯åŒæ­¥æ–¹æ³•å¹¶ä½¿ç”¨è°ƒç”¨è¯¥æ–¹æ³•çš„å¯¹è±¡æˆ–è¯¥æ–¹æ³•æ‰€å±çš„Classåœ¨JVMçš„å†…éƒ¨å¯¹è±¡è¡¨ç¤ºKlassåšä¸ºé”å¯¹è±¡ã€‚ å…¶å®ä»å¼€å‘è€…è§’åº¦ç®€å•ç†è§£ï¼Œè¿™ä¸¤ç§æ–¹å¼åªæ˜¯åœ¨è·å–é”çš„æ—¶æœºæœ‰æ‰€ä¸åŒã€‚ ä¸‹é¢é‡å¤é˜è¿°å‡ ä¸ªç¬¬ä¸€çœ¼çœ‹èµ·æ¥ä¸åˆç†å´æ˜¯äº‹å®çš„é—®é¢˜(å…¶å®å‰æ–‡å·²ç»æåŠè¿‡)ï¼š åœ¨çº¿ç¨‹è¿›å…¥synchronizedæ–¹æ³•æˆ–è€…ä»£ç å—ï¼Œç›¸å½“äºè·å–ç›‘è§†å™¨é”æˆåŠŸï¼Œå¦‚æœæ­¤æ—¶æˆåŠŸè°ƒç”¨wait()ç³»åˆ—æ–¹æ³•ï¼Œé‚£ä¹ˆå®ƒä¼šç«‹å³é‡Šæ”¾ç›‘è§†å™¨é”ï¼Œå¹¶ä¸”æ·»åŠ åˆ°ç­‰å¾…é›†åˆ(Wait Set)ä¸­è¿›è¡Œé˜»å¡ç­‰å¾…ã€‚ ç”±äºå·²ç»æœ‰çº¿ç¨‹é‡Šæ”¾äº†ç›‘è§†å™¨é”ï¼Œé‚£ä¹ˆåœ¨å¦ä¸€ä¸ªçº¿ç¨‹è¿›å…¥synchronizedæ–¹æ³•æˆ–è€…ä»£ç å—ä¹‹åï¼Œå®ƒå¯ä»¥è°ƒç”¨notify(All)æ–¹æ³•å”¤é†’ç­‰å¾…é›†åˆä¸­æ­£åœ¨é˜»å¡çš„çº¿ç¨‹ï¼Œä½†æ˜¯è¿™ä¸ªå”¤é†’æ“ä½œå¹¶ä¸æ˜¯è°ƒç”¨notify(All)æ–¹æ³•åç«‹å³ç”Ÿæ•ˆï¼Œè€Œæ˜¯åœ¨è¯¥çº¿ç¨‹é€€å‡ºsynchronizedæ–¹æ³•æˆ–è€…ä»£ç å—ä¹‹åæ‰ç”Ÿæ•ˆã€‚ ä»wait()æ–¹æ³•é˜»å¡è¿‡ç¨‹ä¸­è¢«å”¤é†’çš„çº¿ç¨‹ä¼šç«äº‰ç›‘è§†å™¨ç›®æ ‡å¯¹è±¡çš„æ§åˆ¶æƒï¼Œä¸€æ—¦é‡æ–°æ§åˆ¶äº†å¯¹è±¡ï¼Œé‚£ä¹ˆçº¿ç¨‹çš„åŒæ­¥çŠ¶æ€å°±ä¼šæ¢å¤åˆ°æ­¥å…¥synchronizedæ–¹æ³•æˆ–è€…ä»£ç å—æ—¶å€™çš„çŠ¶æ€(ä¹Ÿå°±æ˜¯æˆåŠŸè·å–åˆ°å¯¹è±¡ç›‘è§†å™¨é”æ—¶å€™çš„çŠ¶æ€)ï¼Œè¿™ä¸ªæ—¶å€™çº¿ç¨‹æ‰èƒ½å¤Ÿç»§ç»­æ‰§è¡Œã€‚ ä¸ºäº†éªŒè¯è¿™ä¸‰ç‚¹ï¼Œå¯ä»¥å†™ä¸ªç®€å•çš„Demoï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172public class Lock &#123; @Getter private final Object lock = new Object();&#125;public class WaitMain &#123; private static final DateTimeFormatter F = DateTimeFormatter.ofPattern(\"yyyy-MM-dd HH:mm:ss.SSS\"); public static void main(String[] args) throws Exception &#123; final Lock lock = new Lock(); new Thread(new WaitRunnable(lock), \"WaitThread-1\").start(); new Thread(new WaitRunnable(lock), \"WaitThread-2\").start(); Thread.sleep(50); new Thread(new NotifyRunnable(lock), \"NotifyThread\").start(); Thread.sleep(Integer.MAX_VALUE); &#125; @RequiredArgsConstructor private static class WaitRunnable implements Runnable &#123; private final Lock lock; @Override public void run() &#123; synchronized (lock) &#123; System.out.println(String.format(\"[%s]-çº¿ç¨‹[%s]è·å–é”æˆåŠŸ,å‡†å¤‡æ‰§è¡Œwaitæ–¹æ³•\", F.format(LocalDateTime.now()), Thread.currentThread().getName())); while (true) &#123; try &#123; lock.wait(); &#125; catch (InterruptedException e) &#123; //ignore &#125; System.out.println(String.format(\"[%s]-çº¿ç¨‹[%s]ä»waitä¸­å”¤é†’,å‡†å¤‡exit\", F.format(LocalDateTime.now()), Thread.currentThread().getName())); try &#123; Thread.sleep(500); &#125; catch (InterruptedException e) &#123; //ignore &#125; break; &#125; &#125; &#125; &#125; @RequiredArgsConstructor private static class NotifyRunnable implements Runnable &#123; private final Lock lock; @Override public void run() &#123; synchronized (lock) &#123; System.out.println(String.format(\"[%s]-çº¿ç¨‹[%s]è·å–é”æˆåŠŸ,å‡†å¤‡æ‰§è¡ŒnotifyAllæ–¹æ³•\", F.format(LocalDateTime.now()), Thread.currentThread().getName())); lock.notifyAll(); System.out.println(String.format(\"[%s]-çº¿ç¨‹[%s]å…ˆä¼‘çœ 3000ms\", F.format(LocalDateTime.now()), Thread.currentThread().getName())); try &#123; Thread.sleep(3000); &#125; catch (InterruptedException e) &#123; //ignore &#125; System.out.println(String.format(\"[%s]-çº¿ç¨‹[%s]å‡†å¤‡exit\", F.format(LocalDateTime.now()), Thread.currentThread().getName())); &#125; &#125; &#125;&#125; æŸä¸ªæ—¶åˆ»çš„æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š 1234567[2019-04-27 23:28:17.617]-çº¿ç¨‹[WaitThread-1]è·å–é”æˆåŠŸ,å‡†å¤‡æ‰§è¡Œwaitæ–¹æ³•[2019-04-27 23:28:17.631]-çº¿ç¨‹[WaitThread-2]è·å–é”æˆåŠŸ,å‡†å¤‡æ‰§è¡Œwaitæ–¹æ³•[2019-04-27 23:28:17.657]-çº¿ç¨‹[NotifyThread]è·å–é”æˆåŠŸ,å‡†å¤‡æ‰§è¡ŒnotifyAllæ–¹æ³• &lt;-------- è¿™ä¸€æ­¥æ‰§è¡Œå®Œè¯´æ˜WaitThreadå·²ç»é‡Šæ”¾äº†é”[2019-04-27 23:28:17.657]-çº¿ç¨‹[NotifyThread]å…ˆä¼‘çœ 3000ms[2019-04-27 23:28:20.658]-çº¿ç¨‹[NotifyThread]å‡†å¤‡exit &lt;------- è¿™ä¸€æ­¥åNotifyThreadç¦»å¼€åŒæ­¥ä»£ç å—[2019-04-27 23:28:20.658]-çº¿ç¨‹[WaitThread-1]ä»waitä¸­å”¤é†’,å‡†å¤‡exit &lt;------- è¿™ä¸€æ­¥WaitThread-1è§£é™¤é˜»å¡[2019-04-27 23:28:21.160]-çº¿ç¨‹[WaitThread-2]ä»waitä¸­å”¤é†’,å‡†å¤‡exit &lt;------- è¿™ä¸€æ­¥WaitThread-2è§£é™¤é˜»å¡ï¼Œæ³¨æ„å‘ç”Ÿæ—¶é—´åœ¨WaitThread-1è§£é™¤é˜»å¡500msä¹‹åï¼Œç¬¦åˆæˆ‘ä»¬å‰é¢æåˆ°çš„ç¬¬3ç‚¹ å¦‚æœç»“åˆwait()å’Œnotify()å¯ä»¥ç®€å•æ€»ç»“å‡ºä¸€ä¸ªåŒæ­¥ä»£ç å—çš„ä¼ªä»£ç å¦‚ä¸‹ï¼š 12345678910111213141516171819final Object lock = new Object();// ç­‰å¾…synchronized(lock)&#123; 1ã€çº¿ç¨‹è¿›å…¥åŒæ­¥ä»£ç å—ï¼Œæ„å‘³ç€è·å–å¯¹è±¡ç›‘è§†å™¨é”æˆåŠŸ while(!condition)&#123; lock.wait(); 2.çº¿ç¨‹è°ƒç”¨wait()è¿›è¡Œé˜»å¡ç­‰å¾… break; &#125; 3.çº¿ç¨‹ä»wait()çš„é˜»å¡ç­‰å¾…ä¸­è¢«å”¤é†’ï¼Œå°è¯•æ¢å¤ç¬¬1æ­¥ä¹‹åçš„åŒæ­¥çŠ¶æ€ï¼Œå¹¶ä¸ä¼šé©¬ä¸Šç”Ÿæ•ˆï¼Œç›´åˆ°notifyè¢«è°ƒç”¨å¹¶ä¸”è°ƒç”¨notifyæ–¹æ³•çš„çº¿ç¨‹å·²ç»é‡Šæ”¾é”ï¼ŒåŒæ—¶å½“å‰çº¿ç¨‹éœ€è¦ç«äº‰æˆåŠŸ 4.ç»§ç»­æ‰§è¡Œåé¢çš„ä»£ç ï¼Œç›´åˆ°ç¦»å¼€åŒæ­¥ä»£ç å—&#125;// å”¤é†’synchronized(lock)&#123; 1ã€çº¿ç¨‹è¿›å…¥åŒæ­¥ä»£ç å—ï¼Œæ„å‘³ç€è·å–å¯¹è±¡ç›‘è§†å™¨é”æˆåŠŸ lock.notify(); 2.å”¤é†’å…¶ä¸­ä¸€ä¸ªåœ¨å¯¹è±¡ç›‘è§†å™¨ä¸Šç­‰å¾…çš„çº¿ç¨‹ 3.å‡†å¤‡æ¨å‡ºåŒæ­¥ä»£ç å—é‡Šæ”¾é”ï¼Œåªæœ‰é‡Šæ”¾é”ä¹‹åç¬¬2æ­¥æ‰ä¼šç”Ÿæ•ˆ&#125; å›¾è§£Objectæä¾›çš„é˜»å¡å’Œå”¤é†’æœºåˆ¶ ç»“åˆå‰é¢åˆ†æè¿‡çš„çŸ¥è¯†ç‚¹ä»¥åŠå‚è€ƒèµ„æ–™ä¸­çš„æ–‡ç« ï¼Œé‡æ–°ç”»ä¸€ä¸ªå›¾ç†è§£ä¸€ä¸‹å¯¹è±¡ç›‘è§†å™¨ä»¥åŠç›¸åº”é˜»å¡å’Œå”¤é†’APIçš„å·¥ä½œç¤ºæ„è¿‡ç¨‹ï¼š Entry Set(å®é™…ä¸Šæ˜¯ObjectMonitorä¸­çš„_EntryListå±æ€§)ï¼šå­˜æ”¾ç­‰å¾…é”å¹¶ä¸”å¤„äºé˜»å¡çŠ¶æ€çš„çº¿ç¨‹ã€‚ Wait Set(å®é™…ä¸Šæ˜¯ObjectMonitorä¸­çš„_WaitSetå±æ€§)ï¼šå­˜æ”¾å¤„äºç­‰å¾…é˜»å¡çŠ¶æ€çš„çº¿ç¨‹ã€‚ The Owner(å®é™…ä¸Šæ˜¯ObjectMonitorä¸­çš„_ownerå±æ€§)ï¼šæŒ‡å‘è·å¾—å¯¹è±¡ç›‘è§†å™¨çš„çº¿ç¨‹ï¼Œåœ¨åŒä¸€ä¸ªæ—¶åˆ»åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è¢«The OwneræŒæœ‰ï¼Œé€šä¿—æ¥çœ‹ï¼Œå®ƒå°±æ˜¯ç›‘è§†å™¨çš„æ§åˆ¶æƒã€‚ ä½¿ç”¨ä¾‹å­ é€šè¿‡Objectæä¾›çš„é˜»å¡å’Œå”¤é†’æœºåˆ¶ä¸¾å‡ ä¸ªç®€å•çš„ä½¿ç”¨ä¾‹å­ã€‚ ç»´ä¿®å•æ‰€çš„ä¾‹å­ å‡è®¾æœ‰ä»¥ä¸‹åœºæ™¯ï¼šå•æ‰€åªæœ‰ä¸€ä¸ªå¡ä½ï¼Œå•æ‰€ç»´ä¿®å·¥ä¿®å•æ‰€çš„æ—¶å€™ï¼Œä»»ä½•äººä¸èƒ½ä¸Šå•æ‰€ã€‚å½“å•æ‰€ç»´ä¿®å·¥ä¿®å®Œå•æ‰€çš„æ—¶å€™ï¼Œä¸Šå•æ‰€çš„äººéœ€è¦&quot;å¾—åˆ°å•æ‰€çš„æ§åˆ¶æƒ&quot;æ‰èƒ½ä¸Šå•æ‰€ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677787980818283848586878889909192// å•æ‰€ç±»public class Toilet &#123; // å•æ‰€çš„é” private final Object lock = new Object(); private boolean available; public Object getLock() &#123; return lock; &#125; public void setAvailable(boolean available) &#123; this.available = available; &#125; public boolean getAvailable() &#123; return available; &#125;&#125;// å•æ‰€ç»´ä¿®å·¥@RequiredArgsConstructorpublic class ToiletRepairer implements Runnable &#123; private static final DateTimeFormatter F = DateTimeFormatter.ofPattern(\"yyyy-MM-dd HH:mm:ss.SSS\"); private final Toilet toilet; @Override public void run() &#123; synchronized (toilet.getLock()) &#123; System.out.println(String.format(\"[%s]-å•æ‰€ç»´ä¿®å‘˜å¾—åˆ°äº†å•æ‰€çš„é”,ç»´ä¿®å•æ‰€è¦ç”¨5000ms...\", LocalDateTime.now().format(F))); try &#123; Thread.sleep(5000); &#125; catch (Exception e) &#123; // ignore &#125; toilet.setAvailable(true); toilet.getLock().notifyAll(); System.out.println(String.format(\"[%s]-å•æ‰€ç»´ä¿®å‘˜ç»´ä¿®å®Œæ¯•...\", LocalDateTime.now().format(F))); &#125; &#125;&#125;//ä¸Šå•æ‰€çš„ä»»åŠ¡@RequiredArgsConstructorpublic class ToiletTask implements Runnable &#123; private static final DateTimeFormatter F = DateTimeFormatter.ofPattern(\"yyyy-MM-dd HH:mm:ss.SSS\"); private final Toilet toilet; private final String name; private final Random random; @Override public void run() &#123; synchronized (toilet.getLock()) &#123; System.out.println(String.format(\"[%s]-%så¾—åˆ°äº†å•æ‰€çš„é”...\", LocalDateTime.now().format(F), name)); while (!toilet.getAvailable()) &#123; try &#123; toilet.getLock().wait(); &#125; catch (InterruptedException e) &#123; //ignore &#125; int time = random.nextInt(3) + 1; try &#123; // æ¨¡æ‹Ÿä¸Šå•æ‰€ç”¨æ—¶ TimeUnit.SECONDS.sleep(time); &#125; catch (InterruptedException e) &#123; //ignore &#125; System.out.println(String.format(\"[%s]-%sä¸Šå•æ‰€ç”¨äº†%sç§’...\", LocalDateTime.now().format(F), name, time)); &#125; &#125; &#125;&#125;// åœºæ™¯å…¥å£public class Main &#123; public static void main(String[] args) throws Exception &#123; Toilet toilet = new Toilet(); Random random = new Random(); Thread toiletRepairer = new Thread(new ToiletRepairer(toilet), \"ToiletRepairer\"); Thread thread1 = new Thread(new ToiletTask(toilet, \"å¼ ä¸‰\", random), \"thread-1\"); Thread thread2 = new Thread(new ToiletTask(toilet, \"æå››\", random), \"thread-2\"); Thread thread3 = new Thread(new ToiletTask(toilet, \"ç‹äº”\", random), \"thread-3\"); thread1.start(); thread2.start(); thread3.start(); Thread.sleep(50); toiletRepairer.start(); Thread.sleep(Integer.MAX_VALUE); &#125;&#125; æŸæ¬¡æ‰§è¡Œçš„ç»“æœå¦‚ä¸‹ï¼š 12345678[2019-04-29 01:07:25.914]-å¼ ä¸‰å¾—åˆ°äº†å•æ‰€çš„é”...[2019-04-29 01:07:25.931]-æå››å¾—åˆ°äº†å•æ‰€çš„é”...[2019-04-29 01:07:25.931]-ç‹äº”å¾—åˆ°äº†å•æ‰€çš„é”...[2019-04-29 01:07:25.951]-å•æ‰€ç»´ä¿®å‘˜å¾—åˆ°äº†å•æ‰€çš„é”,ç»´ä¿®å•æ‰€è¦ç”¨5000ms...[2019-04-29 01:07:30.951]-å•æ‰€ç»´ä¿®å‘˜ç»´ä¿®å®Œæ¯•...[2019-04-29 01:07:32.952]-å¼ ä¸‰ä¸Šå•æ‰€ç”¨äº†2ç§’...[2019-04-29 01:07:35.952]-ç‹äº”ä¸Šå•æ‰€ç”¨äº†3ç§’...[2019-04-29 01:07:37.953]-æå››ä¸Šå•æ‰€ç”¨äº†2ç§’... é˜»å¡é˜Ÿåˆ—å®ç° å®ç°ä¸€ä¸ªç®€å•å›ºå®šå®¹é‡çš„é˜»å¡é˜Ÿåˆ—ï¼Œæ¥å£å¦‚ä¸‹ï¼š 123456public interface BlockingQueue&lt;T&gt; &#123; void put(T value) throws InterruptedException; T take() throws InterruptedException;&#125; å…¶ä¸­put(T value)ä¼šé˜»å¡ç›´åˆ°é˜Ÿåˆ—ä¸­æœ‰å¯ç”¨çš„å®¹é‡ï¼Œè€Œtake()æ–¹æ³•ä¼šé˜»å¡ç›´åˆ°æœ‰å…ƒç´ æŠ•æ”¾åˆ°é˜Ÿåˆ—ä¸­ã€‚å®ç°å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152public class DefaultBlockingQueue&lt;T&gt; implements BlockingQueue&lt;T&gt; &#123; private Object[] elements; private final Object notEmpty = new Object(); private final Object notFull = new Object(); private int count; private int takeIndex; private int putIndex; public DefaultBlockingQueue(int capacity) &#123; this.elements = new Object[capacity]; &#125; @Override public void put(T value) throws InterruptedException &#123; synchronized (notFull) &#123; while (count == elements.length) &#123; notFull.wait(); &#125; &#125; final Object[] items = this.elements; items[putIndex] = value; if (++putIndex == items.length) &#123; putIndex = 0; &#125; count++; synchronized (notEmpty) &#123; notEmpty.notify(); &#125; &#125; @SuppressWarnings(\"unchecked\") @Override public T take() throws InterruptedException &#123; synchronized (notEmpty) &#123; while (count == 0) &#123; notEmpty.wait(); &#125; &#125; final Object[] items = this.elements; T value = (T) items[takeIndex]; items[takeIndex] = null; if (++takeIndex == items.length) &#123; takeIndex = 0; &#125; count--; synchronized (notFull) &#123; notFull.notify(); &#125; return value; &#125;&#125; åœºæ™¯å…¥å£ç±»ï¼š 12345678910111213141516171819202122232425262728public class Main &#123; public static void main(String[] args) throws Exception &#123; BlockingQueue&lt;String&gt; queue = new DefaultBlockingQueue&lt;&gt;(5); Runnable r = () -&gt; &#123; while (true) &#123; try &#123; String take = queue.take(); System.out.println(String.format(\"çº¿ç¨‹%sæ¶ˆè´¹æ¶ˆæ¯-%s\", Thread.currentThread().getName(), take)); &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; &#125; &#125;; new Thread(r, \"thread-1\").start(); new Thread(r, \"thread-2\").start(); IntStream.range(0, 10).forEach(i -&gt; &#123; try &#123; queue.put(String.valueOf(i)); &#125; catch (InterruptedException e) &#123; //ignore &#125; &#125;); Thread.sleep(Integer.MAX_VALUE); &#125;&#125; æŸæ¬¡æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š 12345678910çº¿ç¨‹thread-1æ¶ˆè´¹æ¶ˆæ¯-0çº¿ç¨‹thread-2æ¶ˆè´¹æ¶ˆæ¯-1çº¿ç¨‹thread-1æ¶ˆè´¹æ¶ˆæ¯-2çº¿ç¨‹thread-2æ¶ˆè´¹æ¶ˆæ¯-3çº¿ç¨‹thread-1æ¶ˆè´¹æ¶ˆæ¯-4çº¿ç¨‹thread-2æ¶ˆè´¹æ¶ˆæ¯-5çº¿ç¨‹thread-1æ¶ˆè´¹æ¶ˆæ¯-6çº¿ç¨‹thread-2æ¶ˆè´¹æ¶ˆæ¯-7çº¿ç¨‹thread-1æ¶ˆè´¹æ¶ˆæ¯-8çº¿ç¨‹thread-2æ¶ˆè´¹æ¶ˆæ¯-9 ä¸Šé¢è¿™ä¸ªä¾‹å­å°±æ˜¯ç®€å•çš„å•ç”Ÿäº§è€…-å¤šæ¶ˆè´¹è€…çš„æ¨¡å‹ã€‚ çº¿ç¨‹æ± å®ç° è¿™é‡Œå®ç°ä¸€ä¸ªæåº¦ç®€é™‹çš„å›ºå®šå®¹é‡çš„çº¿ç¨‹æ± ï¼ŒåŠŸèƒ½æ˜¯ï¼šåˆå§‹åŒ–å›ºå®šæ•°é‡çš„æ´»è·ƒçº¿ç¨‹ï¼Œé˜»å¡ç›´åˆ°æœ‰å¯ç”¨çš„çº¿ç¨‹ç”¨äºæäº¤ä»»åŠ¡ã€‚å®ƒåªæœ‰ä¸€ä¸ªæ¥å£æ–¹æ³•ï¼Œæ¥å£å®šä¹‰å¦‚ä¸‹ï¼š 1234public interface ThreadPool &#123; void execute(Runnable runnable);&#125; å…·ä½“å®ç°å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103public class DefaultThreadPool implements ThreadPool &#123; private final int capacity; private List&lt;Worker&gt; initWorkers; private Deque&lt;Worker&gt; availableWorkers; private Deque&lt;Worker&gt; busyWorkers; private final Object nextLock = new Object(); public DefaultThreadPool(int capacity) &#123; this.capacity = capacity; init(capacity); &#125; private void init(int capacity) &#123; initWorkers = new ArrayList&lt;&gt;(capacity); availableWorkers = new LinkedList&lt;&gt;(); busyWorkers = new LinkedList&lt;&gt;(); for (int i = 0; i &lt; capacity; i++) &#123; Worker worker = new Worker(); worker.setName(\"Worker-\" + (i + 1)); worker.setDaemon(true); initWorkers.add(worker); &#125; for (Worker w : initWorkers) &#123; w.start(); availableWorkers.add(w); &#125; &#125; @Override public void execute(Runnable runnable) &#123; if (null == runnable) &#123; return; &#125; synchronized (nextLock) &#123; while (availableWorkers.size() &lt; 1) &#123; try &#123; nextLock.wait(500); &#125; catch (InterruptedException e) &#123; //ignore &#125; &#125; Worker worker = availableWorkers.removeFirst(); busyWorkers.add(worker); worker.run(runnable); nextLock.notifyAll(); &#125; &#125; private void makeAvailable(Worker worker) &#123; synchronized (nextLock) &#123; availableWorkers.add(worker); busyWorkers.remove(worker); nextLock.notifyAll(); &#125; &#125; private class Worker extends Thread &#123; private final Object lock = new Object(); private Runnable runnable; private AtomicBoolean run = new AtomicBoolean(true); private void run(Runnable runnable) &#123; synchronized (lock) &#123; if (null != this.runnable) &#123; throw new IllegalStateException(\"Already running a Runnable!\"); &#125; this.runnable = runnable; lock.notifyAll(); &#125; &#125; @Override public void run() &#123; boolean ran = false; while (run.get()) &#123; try &#123; synchronized (lock) &#123; while (runnable == null &amp;&amp; run.get()) &#123; lock.wait(500); &#125; if (runnable != null) &#123; ran = true; runnable.run(); &#125; &#125; &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; finally &#123; synchronized (lock) &#123; runnable = null; &#125; if (ran) &#123; ran = false; makeAvailable(this); &#125; &#125; &#125; &#125; &#125;&#125; åœºæ™¯ç±»å…¥å£ï¼š 123456789101112131415161718192021222324252627282930313233343536public class Main &#123; private static final DateTimeFormatter F = DateTimeFormatter.ofPattern(\"yyyy-MM-dd HH:mm:ss.SSS\"); public static void main(String[] args) throws Exception&#123; ThreadPool threadPool = new DefaultThreadPool(2); threadPool.execute(() -&gt; &#123; try &#123; System.out.println(String.format(\"[%s]-ä»»åŠ¡ä¸€å¼€å§‹æ‰§è¡ŒæŒç»­3ç§’...\", LocalDateTime.now().format(F))); Thread.sleep(3000); System.out.println(String.format(\"[%s]-ä»»åŠ¡ä¸€æ‰§è¡Œç»“æŸ...\", LocalDateTime.now().format(F))); &#125;catch (Exception e)&#123; //ignore &#125; &#125;); threadPool.execute(() -&gt; &#123; try &#123; System.out.println(String.format(\"[%s]-ä»»åŠ¡äºŒå¼€å§‹æ‰§è¡ŒæŒç»­4ç§’...\", LocalDateTime.now().format(F))); Thread.sleep(4000); System.out.println(String.format(\"[%s]-ä»»åŠ¡äºŒæ‰§è¡Œç»“æŸ...\", LocalDateTime.now().format(F))); &#125;catch (Exception e)&#123; //ignore &#125; &#125;); threadPool.execute(() -&gt; &#123; try &#123; System.out.println(String.format(\"[%s]-ä»»åŠ¡ä¸‰å¼€å§‹æ‰§è¡ŒæŒç»­5ç§’...\", LocalDateTime.now().format(F))); Thread.sleep(5000); System.out.println(String.format(\"[%s]-ä»»åŠ¡ä¸‰æ‰§è¡Œç»“æŸ...\", LocalDateTime.now().format(F))); &#125;catch (Exception e)&#123; //ignore &#125; &#125;); Thread.sleep(Integer.MAX_VALUE); &#125;&#125; æŸæ¬¡æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š 123456[2019-04-29 02:07:25.465]-ä»»åŠ¡äºŒå¼€å§‹æ‰§è¡ŒæŒç»­4ç§’...[2019-04-29 02:07:25.465]-ä»»åŠ¡ä¸€å¼€å§‹æ‰§è¡ŒæŒç»­3ç§’...[2019-04-29 02:07:28.486]-ä»»åŠ¡ä¸€æ‰§è¡Œç»“æŸ...[2019-04-29 02:07:28.486]-ä»»åŠ¡ä¸‰å¼€å§‹æ‰§è¡ŒæŒç»­5ç§’...[2019-04-29 02:07:29.486]-ä»»åŠ¡äºŒæ‰§è¡Œç»“æŸ...[2019-04-29 02:07:33.487]-ä»»åŠ¡ä¸‰æ‰§è¡Œç»“æŸ... å°ç»“ é‰´äºç¬”è€…Cè¯­è¨€å­¦å¾—ä¸å¥½ï¼Œè¿™é‡Œå°±æ— æ³•æ·±å…¥åˆ†æJVMæºç çš„å®ç°ï¼Œåªèƒ½ç»“åˆä¸€äº›ç°æœ‰çš„èµ„æ–™å’Œè‡ªå·±çš„ç†è§£é‡æ–°æ¢³ç†ä¸€ä¸‹Objectæä¾›çš„é˜»å¡å’Œå”¤é†’æœºåˆ¶è¿™äº›çŸ¥è¯†ç‚¹ã€‚ç»“åˆä¹‹å‰çœ‹è¿‡JUCåŒæ­¥å™¨çš„æºç ï¼Œä¸€æ—¶é†’æ‚Ÿè¿‡æ¥ï¼ŒJUCåŒæ­¥å™¨åªæ˜¯åœ¨æ•°æ®ç»“æ„å’Œç®—æ³•å±‚é¢ä½¿ç”¨Javaè¯­è¨€å¯¹åŸæ¥JVMä¸­Cè¯­è¨€çš„é˜»å¡å’Œå”¤é†’æœºåˆ¶å³Objectæä¾›çš„é‚£å‡ ä¸ªJNIæ–¹æ³•è¿›è¡Œäº†ä¸€æ¬¡å®ç°è€Œå·²ã€‚ æœ€åï¼ŒObjectæä¾›çš„é˜»å¡ç­‰å¾…å”¤é†’æœºåˆ¶æ˜¯JVMå®ç°çš„(å¦‚æœç‰¹åˆ«ç†Ÿæ‚‰Cè¯­è¨€å¯ä»¥é€šè¿‡JVMæºç ç ”ç©¶å…¶å®ç°ï¼Œå¯¹äºå¤§éƒ¨åˆ†å¼€å‘è€…æ¥è¯´æ˜¯é»‘ç®±)ï¼Œé™¤éæ˜¯ç‰¹åˆ«ç†Ÿç»ƒæˆ–è€…æ˜¯JDKç‰ˆæœ¬å¤ªä½å°šæœªå¼•å…¥JUCåŒ…ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ä¸åº”è¯¥ä¼˜å…ˆé€‰æ‹©Objectï¼Œè€Œåº”è¯¥è€ƒè™‘ä¸“é—¨ä¸ºå¹¶å‘è®¾è®¡çš„JUCåŒ…ä¸­çš„ç±»åº“ã€‚ å‚è€ƒèµ„æ–™ï¼š JVMæºç åˆ†æä¹‹Object.wait/notifyå®ç°-Byå å°ç‹¼ æ­»ç£•Javaå¹¶å‘-æ·±å…¥åˆ†æsynchronizedçš„å®ç°åŸç† JDK11ç›¸å…³æºç  (æœ¬æ–‡å®Œ c-7-d e-a-20190430)","categories":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/categories/Java/"},{"name":"Concurrency","slug":"Java/Concurrency","permalink":"http://throwable.club/blog/categories/Java/Concurrency/"}],"tags":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/tags/Java/"},{"name":"Object","slug":"Object","permalink":"http://throwable.club/blog/tags/Object/"}]},{"title":"é€šè¿‡micrometerå®æ—¶ç›‘æ§çº¿ç¨‹æ± çš„å„é¡¹æŒ‡æ ‡","slug":"jvm-micrometer-thread-pool-monitor","date":"2019-04-14T15:45:17.000Z","updated":"2019-04-30T03:56:50.926Z","comments":true,"path":"2019/04/14/jvm-micrometer-thread-pool-monitor/","link":"","permalink":"http://throwable.club/2019/04/14/jvm-micrometer-thread-pool-monitor/","excerpt":"","text":"é€šè¿‡micrometerå®æ—¶ç›‘æ§çº¿ç¨‹æ± çš„å„é¡¹æŒ‡æ ‡ å‰æ æœ€è¿‘çš„ä¸€ä¸ªé¡¹ç›®ä¸­æ¶‰åŠåˆ°æ–‡ä»¶ä¸Šä¼ å’Œä¸‹è½½ï¼Œä½¿ç”¨åˆ°JUCçš„çº¿ç¨‹æ± ThreadPoolExecutorï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­å‡ºç°äº†æŸäº›æ—¶åˆ»çº¿ç¨‹æ± æ»¡è´Ÿè½½è¿ä½œï¼Œç”±äºä½¿ç”¨äº†CallerRunsPolicyæ‹’ç»ç­–ç•¥ï¼Œå¯¼è‡´æ»¡è´Ÿè½½æƒ…å†µä¸‹ï¼Œåº”ç”¨æ¥å£è°ƒç”¨æ— æ³•å“åº”ï¼Œå¤„äºå‡æ­»çŠ¶æ€ã€‚è€ƒè™‘åˆ°ä¹‹å‰ç”¨micrometer + prometheus + grafanaæ­å»ºè¿‡ç›‘æ§ä½“ç³»ï¼Œäºæ˜¯è€ƒè™‘ä½¿ç”¨micrometeråšä¸€æ¬¡ä¸»åŠ¨çš„çº¿ç¨‹æ± åº¦é‡æ•°æ®é‡‡é›†ï¼Œæœ€ç»ˆå¯ä»¥ç›¸å¯¹å®æ—¶åœ°å±•ç¤ºåœ¨grafanaçš„é¢æ¿ä¸­ã€‚ å®è·µè¿‡ç¨‹ ä¸‹é¢é€šè¿‡çœŸæ­£çš„å®æˆ˜è¿‡ç¨‹åšä¸€ä¸ªä»¿çœŸçš„ä¾‹å­ç”¨äºå¤ç›˜ã€‚ ä»£ç æ”¹é€  é¦–å…ˆæˆ‘ä»¬è¦æ•´ç†ä¸€ä¸‹ThreadPoolExecutorä¸­æä¾›çš„åº¦é‡æ•°æ®é¡¹å’Œmicrometerå¯¹åº”çš„Tagçš„æ˜ å°„å…³ç³»ï¼š çº¿ç¨‹æ± åç§°ï¼ŒTagï¼šthread.pool.nameï¼Œè¿™ä¸ªå¾ˆé‡è¦ï¼Œç”¨äºåŒºåˆ†å„ä¸ªçº¿ç¨‹æ± çš„æ•°æ®ï¼Œå¦‚æœä½¿ç”¨IOCå®¹å™¨ç®¡ç†ï¼Œå¯ä»¥ä½¿ç”¨BeanNameä»£æ›¿ã€‚ int getCorePoolSize()ï¼šæ ¸å¿ƒçº¿ç¨‹æ•°ï¼ŒTagï¼šthread.pool.core.sizeã€‚ int getLargestPoolSize()ï¼šå†å²å³°å€¼çº¿ç¨‹æ•°ï¼ŒTagï¼šthread.pool.largest.sizeã€‚ int getMaximumPoolSize()ï¼šæœ€å¤§çº¿ç¨‹æ•°(çº¿ç¨‹æ± çº¿ç¨‹å®¹é‡)ï¼ŒTagï¼šthread.pool.max.sizeã€‚ int getActiveCount()ï¼šå½“å‰æ´»è·ƒçº¿ç¨‹æ•°ï¼ŒTagï¼šthread.pool.active.sizeã€‚ int getPoolSize()ï¼šå½“å‰çº¿ç¨‹æ± ä¸­è¿è¡Œçš„çº¿ç¨‹æ€»æ•°(åŒ…æ‹¬æ ¸å¿ƒçº¿ç¨‹å’Œéæ ¸å¿ƒçº¿ç¨‹)ï¼ŒTagï¼šthread.pool.thread.countã€‚ å½“å‰ä»»åŠ¡é˜Ÿåˆ—ä¸­ç§¯å‹ä»»åŠ¡çš„æ€»æ•°ï¼ŒTagï¼šthread.pool.queue.sizeï¼Œè¿™ä¸ªéœ€è¦åŠ¨æ€è®¡ç®—å¾—å‡ºã€‚ æ¥ç€ç¼–å†™å…·ä½“çš„ä»£ç ï¼Œå®ç°çš„åŠŸèƒ½å¦‚ä¸‹ï¼š 1ã€å»ºç«‹ä¸€ä¸ªThreadPoolExecutorå®ä¾‹ï¼Œæ ¸å¿ƒçº¿ç¨‹å’Œæœ€å¤§çº¿ç¨‹æ•°ä¸º10ï¼Œä»»åŠ¡é˜Ÿåˆ—é•¿åº¦ä¸º10ï¼Œæ‹’ç»ç­–ç•¥ä¸ºAbortPolicyã€‚ 2ã€æä¾›ä¸¤ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«ä½¿ç”¨çº¿ç¨‹æ± å®ä¾‹æ¨¡æ‹ŸçŸ­æ—¶é—´è€—æ—¶çš„ä»»åŠ¡å’Œé•¿æ—¶é—´è€—æ—¶çš„ä»»åŠ¡ã€‚ 3ã€æä¾›ä¸€ä¸ªæ–¹æ³•ç”¨äºæ¸…ç©ºçº¿ç¨‹æ± å®ä¾‹ä¸­çš„ä»»åŠ¡é˜Ÿåˆ—ã€‚ 4ã€æä¾›ä¸€ä¸ªå•çº¿ç¨‹çš„è°ƒåº¦çº¿ç¨‹æ± ç”¨äºå®šæ—¶æ”¶é›†ThreadPoolExecutorå®ä¾‹ä¸­ä¸Šé¢åˆ—å‡ºçš„åº¦é‡é¡¹ï¼Œä¿å­˜åˆ°micrometerå†…å­˜æ€çš„æ”¶é›†å™¨ä¸­ã€‚ ç”±äºè¿™äº›ç»Ÿè®¡çš„å€¼éƒ½ä¼šè·Ÿéšæ—¶é—´å‘ç”Ÿæ³¢åŠ¨æ€§å˜æ›´ï¼Œå¯ä»¥è€ƒè™‘é€‰ç”¨Gaugeç±»å‹çš„Meterè¿›è¡Œè®°å½•ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123// ThreadPoolMonitorimport io.micrometer.core.instrument.Metrics;import io.micrometer.core.instrument.Tag;import org.springframework.beans.factory.InitializingBean;import org.springframework.stereotype.Service;import java.util.Collections;import java.util.concurrent.*;import java.util.concurrent.atomic.AtomicInteger;/** * @author throwable * @version v1.0 * @description * @since 2019/4/7 21:02 */@Servicepublic class ThreadPoolMonitor implements InitializingBean &#123; private static final String EXECUTOR_NAME = \"ThreadPoolMonitorSample\"; private static final Iterable&lt;Tag&gt; TAG = Collections.singletonList(Tag.of(\"thread.pool.name\", EXECUTOR_NAME)); private final ScheduledExecutorService scheduledExecutor = Executors.newSingleThreadScheduledExecutor(); private final ThreadPoolExecutor executor = new ThreadPoolExecutor(10, 10, 0, TimeUnit.SECONDS, new ArrayBlockingQueue&lt;&gt;(10), new ThreadFactory() &#123; private final AtomicInteger counter = new AtomicInteger(); @Override public Thread newThread(Runnable r) &#123; Thread thread = new Thread(r); thread.setDaemon(true); thread.setName(\"thread-pool-\" + counter.getAndIncrement()); return thread; &#125; &#125;, new ThreadPoolExecutor.AbortPolicy()); private Runnable monitor = () -&gt; &#123; //è¿™é‡Œéœ€è¦æ•è·å¼‚å¸¸,å°½ç®¡å®é™…ä¸Šä¸ä¼šäº§ç”Ÿå¼‚å¸¸,ä½†æ˜¯å¿…é¡»é¢„é˜²å¼‚å¸¸å¯¼è‡´è°ƒåº¦çº¿ç¨‹æ± çº¿ç¨‹å¤±æ•ˆçš„é—®é¢˜ try &#123; Metrics.gauge(\"thread.pool.core.size\", TAG, executor, ThreadPoolExecutor::getCorePoolSize); Metrics.gauge(\"thread.pool.largest.size\", TAG, executor, ThreadPoolExecutor::getLargestPoolSize); Metrics.gauge(\"thread.pool.max.size\", TAG, executor, ThreadPoolExecutor::getMaximumPoolSize); Metrics.gauge(\"thread.pool.active.size\", TAG, executor, ThreadPoolExecutor::getActiveCount); Metrics.gauge(\"thread.pool.thread.count\", TAG, executor, ThreadPoolExecutor::getPoolSize); // æ³¨æ„å¦‚æœé˜»å¡é˜Ÿåˆ—ä½¿ç”¨æ— ç•Œé˜Ÿåˆ—è¿™é‡Œä¸èƒ½ç›´æ¥å–size Metrics.gauge(\"thread.pool.queue.size\", TAG, executor, e -&gt; e.getQueue().size()); &#125; catch (Exception e) &#123; //ignore &#125; &#125;; @Override public void afterPropertiesSet() throws Exception &#123; // æ¯5ç§’æ‰§è¡Œä¸€æ¬¡ scheduledExecutor.scheduleWithFixedDelay(monitor, 0, 5, TimeUnit.SECONDS); &#125; public void shortTimeWork() &#123; executor.execute(() -&gt; &#123; try &#123; // 5ç§’ Thread.sleep(5000); &#125; catch (InterruptedException e) &#123; //ignore &#125; &#125;); &#125; public void longTimeWork() &#123; executor.execute(() -&gt; &#123; try &#123; // 500ç§’ Thread.sleep(5000 * 100); &#125; catch (InterruptedException e) &#123; //ignore &#125; &#125;); &#125; public void clearTaskQueue() &#123; executor.getQueue().clear(); &#125;&#125;//ThreadPoolMonitorControllerimport club.throwable.smp.service.ThreadPoolMonitor;import lombok.RequiredArgsConstructor;import org.springframework.http.ResponseEntity;import org.springframework.web.bind.annotation.GetMapping;import org.springframework.web.bind.annotation.RestController;/** * @author throwable * @version v1.0 * @description * @since 2019/4/7 21:20 */@RequiredArgsConstructor@RestControllerpublic class ThreadPoolMonitorController &#123; private final ThreadPoolMonitor threadPoolMonitor; @GetMapping(value = \"/shortTimeWork\") public ResponseEntity&lt;String&gt; shortTimeWork() &#123; threadPoolMonitor.shortTimeWork(); return ResponseEntity.ok(\"success\"); &#125; @GetMapping(value = \"/longTimeWork\") public ResponseEntity&lt;String&gt; longTimeWork() &#123; threadPoolMonitor.longTimeWork(); return ResponseEntity.ok(\"success\"); &#125; @GetMapping(value = \"/clearTaskQueue\") public ResponseEntity&lt;String&gt; clearTaskQueue() &#123; threadPoolMonitor.clearTaskQueue(); return ResponseEntity.ok(\"success\"); &#125;&#125; é…ç½®å¦‚ä¸‹ï¼š 12345678910server: port: 9091management: server: port: 9091 endpoints: web: exposure: include: '*' base-path: /management prometheusçš„è°ƒåº¦Jobä¹Ÿå¯ä»¥é€‚å½“è°ƒé«˜é¢‘ç‡ï¼Œè¿™é‡Œé»˜è®¤æ˜¯15ç§’æ‹‰å–ä¸€æ¬¡/prometheusç«¯ç‚¹ï¼Œä¹Ÿå°±æ˜¯ä¼šæ¯æ¬¡æäº¤3ä¸ªæ”¶é›†å‘¨æœŸçš„æ•°æ®ã€‚é¡¹ç›®å¯åŠ¨ä¹‹åï¼Œå¯ä»¥å°è¯•è°ƒç”¨/management/prometheusæŸ¥çœ‹ç«¯ç‚¹æäº¤çš„æ•°æ®ï¼š å› ä¸ºThreadPoolMonitorSampleæ˜¯æˆ‘ä»¬è‡ªå®šä¹‰å‘½åçš„Tagï¼Œçœ‹åˆ°ç›¸å…³å­—æ ·è¯´æ˜æ•°æ®æ”¶é›†æ˜¯æ­£å¸¸çš„ã€‚å¦‚æœprometheusçš„Jobæ²¡æœ‰é…ç½®é”™è¯¯ï¼Œåœ¨æœ¬åœ°çš„spring-booté¡¹ç›®èµ·æ¥åï¼Œå¯ä»¥æŸ¥ä¸‹prometheusçš„åå°ï¼š OKï¼Œå®Œç¾ï¼Œå¯ä»¥è¿›è¡Œä¸‹ä¸€æ­¥ã€‚ grafanaé¢æ¿é…ç½® ç¡®ä¿JVMåº”ç”¨å’Œprometheusçš„è°ƒåº¦Jobæ˜¯æ­£å¸¸çš„æƒ…å†µä¸‹ï¼Œæ¥ä¸‹æ¥é‡è¦çš„ä¸€æ­¥å°±æ˜¯é…ç½®grafanaé¢æ¿ã€‚å¦‚æœæš‚æ—¶ä¸æƒ³è®¤çœŸå­¦ä¹ ä¸€ä¸‹prometheusçš„PSQLçš„è¯ï¼Œå¯ä»¥ä»prometheusåå°çš„/graphé¢æ¿ç›´æ¥æœç´¢å¯¹åº”çš„æ ·æœ¬è¡¨è¾¾å¼æ‹·è´è¿›å»grafanaé…ç½®ä¸­å°±è¡Œï¼Œå½“ç„¶æœ€å¥½è¿˜æ˜¯å»çœ‹ä¸‹prometheusçš„æ–‡æ¡£ç³»ç»Ÿå­¦ä¹ ä¸€ä¸‹æ€ä¹ˆç¼–å†™PSQLã€‚ åŸºæœ¬é…ç½®ï¼š å¯è§†åŒ–é…ç½®ï¼ŒæŠŠå³è¾¹çš„æ ‡ç­¾å‹¾é€‰ï¼Œå®½åº¦å°½é‡è°ƒå¤§ç‚¹ï¼š æŸ¥è¯¢é…ç½®ï¼Œè¿™ä¸ªæ˜¯æœ€é‡è¦çš„ï¼Œæœ€ç»ˆå›¾è¡¨å°±æ˜¯é æŸ¥è¯¢é…ç½®å±•ç¤ºçš„ï¼š æŸ¥è¯¢é…ç½®å…·ä½“å¦‚ä¸‹ï¼š Aï¼šthread_pool_active_sizeï¼ŒLegendï¼š-çº¿ç¨‹æ± æ´»è·ƒçº¿ç¨‹æ•°ã€‚ Bï¼šthread_pool_largest_sizeï¼ŒLegendï¼š-çº¿ç¨‹æ± å†å²å³°å€¼çº¿ç¨‹æ•°ã€‚ Cï¼šthread_pool_max_sizeï¼ŒLegendï¼š-çº¿ç¨‹æ± å®¹é‡ã€‚ Dï¼šthread_pool_core_sizeï¼ŒLegendï¼š-çº¿ç¨‹æ± æ ¸å¿ƒçº¿ç¨‹æ•°ã€‚ Eï¼šthread_pool_thread_countï¼ŒLegendï¼š-çº¿ç¨‹æ± è¿è¡Œä¸­çš„çº¿ç¨‹æ•°ã€‚ Fï¼šthread_pool_queue_sizeï¼ŒLegendï¼š-çº¿ç¨‹æ± ç§¯å‹ä»»åŠ¡æ•°ã€‚ æœ€ç»ˆæ•ˆæœ å¤šè°ƒç”¨å‡ æ¬¡ä¾‹å­ä¸­æä¾›çš„å‡ ä¸ªæ¥å£ï¼Œå°±èƒ½å¾—åˆ°ä¸€ä¸ªç›‘æ§çº¿ç¨‹æ± å‘ˆç°çš„å›¾è¡¨ï¼š å°ç»“ é’ˆå¯¹çº¿ç¨‹æ± ThreadPoolExecutorçš„å„é¡¹æ•°æ®è¿›è¡Œç›‘æ§ï¼Œæœ‰åˆ©äºåŠæ—¶å‘ç°ä½¿ç”¨çº¿ç¨‹æ± çš„æ¥å£çš„å¼‚å¸¸ï¼Œå¦‚æœæƒ³è¦å¿«é€Ÿæ¢å¤ï¼Œæœ€æœ‰æ•ˆçš„é€”å¾„æ˜¯ï¼šæ¸…ç©ºçº¿ç¨‹æ± ä¸­ä»»åŠ¡é˜Ÿåˆ—ä¸­ç§¯å‹çš„ä»»åŠ¡ã€‚å…·ä½“çš„åšæ³•æ˜¯ï¼šå¯ä»¥æŠŠThreadPoolExecutorå§”æ‰˜åˆ°IOCå®¹å™¨ç®¡ç†ï¼Œå¹¶ä¸”æŠŠThreadPoolExecutorçš„ä»»åŠ¡é˜Ÿåˆ—æ¸…ç©ºçš„æ–¹æ³•æš´éœ²æˆä¸€ä¸ªRESTç«¯ç‚¹å³å¯ã€‚åƒHTTPå®¢æˆ·ç«¯çš„è¿æ¥æ± å¦‚Apache-Http-Clientæˆ–è€…OkHttpç­‰çš„ç›‘æ§ï¼Œå¯ä»¥ç”¨ç±»ä¼¼çš„æ–¹å¼å®ç°ï¼Œæ•°æ®æ”¶é›†çš„æ—¶å€™å¯èƒ½ç”±äºåŠ é”ç­‰åŸå› ä¼šæœ‰å°‘é‡çš„æ€§èƒ½æŸè€—ï¼Œä¸è¿‡è¿™äº›éƒ½æ˜¯å¯ä»¥å¿½ç•¥çš„ï¼Œå¦‚æœçœŸçš„æ€•æœ‰æ€§èƒ½å½±å“ï¼Œå¯ä»¥å°è¯•ç”¨åå°„APIç›´æ¥è·å–ThreadPoolExecutorå®ä¾‹å†…éƒ¨çš„å±æ€§å€¼ï¼Œè¿™æ ·å°±å¯ä»¥é¿å…åŠ é”çš„æ€§èƒ½æŸè€—ã€‚ (æœ¬æ–‡å®Œ c-2-d 20190414)","categories":[{"name":"Framework","slug":"Framework","permalink":"http://throwable.club/blog/categories/Framework/"},{"name":"Micrometer","slug":"Framework/Micrometer","permalink":"http://throwable.club/blog/categories/Framework/Micrometer/"}],"tags":[{"name":"Framework","slug":"Framework","permalink":"http://throwable.club/blog/tags/Framework/"},{"name":"Micrometer","slug":"Micrometer","permalink":"http://throwable.club/blog/tags/Micrometer/"}]},{"title":"JUCåŒæ­¥å™¨æ¡†æ¶AbstractQueuedSynchronizeræºç å›¾æ–‡åˆ†æ","slug":"java-juc-aqs-source-code","date":"2019-04-07T04:06:01.000Z","updated":"2019-06-09T03:54:33.024Z","comments":true,"path":"2019/04/07/java-juc-aqs-source-code/","link":"","permalink":"http://throwable.club/2019/04/07/java-juc-aqs-source-code/","excerpt":"å‰æ Doug Leaå¤§ç¥åœ¨ç¼–å†™JUC(java.util.concurrent)åŒ…çš„æ—¶å€™å¼•å…¥äº†java.util.concurrent.locks.AbstractQueuedSynchronizerï¼ŒAbstract Queued Synchronizerï¼Œä¹Ÿå°±æ˜¯&quot;åŸºäºé˜Ÿåˆ—å®ç°çš„æŠ½è±¡åŒæ­¥å™¨&quot;ï¼Œä¸€èˆ¬æˆ‘ä»¬ç§°ä¹‹ä¸ºAQSã€‚å…¶å®Doug Leaå¤§ç¥ç¼–å†™AQSæ˜¯æœ‰ä¸¥è°¨çš„ç†è®ºåŸºç¡€çš„ï¼Œä»–çš„ä¸ªäººåšå®¢ä¸Šæœ‰ä¸€ç¯‡è®ºæ–‡ã€ŠThe java.util.concurrent Synchronizer Frameworkã€‹ï¼Œæ–‡ç« åœ¨http://ifeve.comä¸Šå¯ä»¥æ‰¾åˆ°ç›¸å…³çš„è¯‘æ–‡(ã€ŠJUCåŒæ­¥å™¨æ¡†æ¶ã€‹)ï¼Œå¦‚æœæƒ³è¦æ·±å…¥ç ”ç©¶AQSå¿…é¡»è¦ç†è§£ä¸€ä¸‹è¯¥è®ºæ–‡çš„å†…å®¹ï¼Œç„¶åè¯¦ç»†åˆ†æä¸€ä¸‹AQSçš„æºç å®ç°ã€‚æœ¬æ–‡åœ¨é˜…è¯»AQSæºç çš„æ—¶å€™é€‰ç”¨çš„JDKç‰ˆæœ¬æ˜¯JDK11ã€‚ AQSçš„ä¸»è¦åŠŸèƒ½ AQSæ˜¯JUCåŒ…ä¸­ç”¨äºæ„å»ºé”æˆ–è€…å…¶ä»–åŒæ­¥ç»„ä»¶(ä¿¡å·é‡ã€äº‹ä»¶ç­‰)çš„åŸºç¡€æ¡†æ¶ç±»ã€‚AQSä»å®ƒçš„å®ç°ä¸Šçœ‹ä¸»è¦æä¾›äº†ä¸‹é¢çš„åŠŸèƒ½ï¼š åŒæ­¥çŠ¶æ€çš„åŸå­æ€§ç®¡ç†ã€‚ çº¿ç¨‹çš„é˜»å¡å’Œè§£é™¤é˜»å¡ã€‚ æä¾›é˜»å¡çº¿ç¨‹çš„å­˜å‚¨é˜Ÿåˆ—ã€‚ åŸºäºè¿™ä¸‰å¤§åŠŸèƒ½ï¼Œè¡ç”Ÿå‡ºä¸‹é¢çš„é™„åŠ åŠŸèƒ½ï¼š é€šè¿‡ä¸­æ–­å®ç°çš„ä»»åŠ¡å–æ¶ˆï¼ŒåŸºäºçº¿ç¨‹ä¸­æ–­å®ç°ã€‚ å¯é€‰çš„è¶…æ—¶è®¾ç½®ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨è€…å¯ä»¥é€‰æ‹©æ”¾å¼ƒç­‰å¾…ã€‚ å®šä¹‰äº†Conditionæ¥å£ï¼Œç”¨äºæ”¯æŒç®¡ç¨‹å½¢å¼çš„await/signal/signalAllæ“ä½œï¼Œä»£æ›¿äº†Objectç±»åŸºäºJNIæä¾›çš„wait/notify/notifyAllã€‚ AQSè¿˜æ ¹æ®åŒæ­¥çŠ¶æ€çš„ä¸åŒç®¡ç†æ–¹å¼åŒºåˆ†ä¸ºä¸¤ç§ä¸åŒçš„å®ç°ï¼šç‹¬å çŠ¶æ€çš„åŒæ­¥å™¨å’Œå…±äº«çŠ¶æ€çš„åŒæ­¥å™¨ã€‚","text":"å‰æ Doug Leaå¤§ç¥åœ¨ç¼–å†™JUC(java.util.concurrent)åŒ…çš„æ—¶å€™å¼•å…¥äº†java.util.concurrent.locks.AbstractQueuedSynchronizerï¼ŒAbstract Queued Synchronizerï¼Œä¹Ÿå°±æ˜¯&quot;åŸºäºé˜Ÿåˆ—å®ç°çš„æŠ½è±¡åŒæ­¥å™¨&quot;ï¼Œä¸€èˆ¬æˆ‘ä»¬ç§°ä¹‹ä¸ºAQSã€‚å…¶å®Doug Leaå¤§ç¥ç¼–å†™AQSæ˜¯æœ‰ä¸¥è°¨çš„ç†è®ºåŸºç¡€çš„ï¼Œä»–çš„ä¸ªäººåšå®¢ä¸Šæœ‰ä¸€ç¯‡è®ºæ–‡ã€ŠThe java.util.concurrent Synchronizer Frameworkã€‹ï¼Œæ–‡ç« åœ¨http://ifeve.comä¸Šå¯ä»¥æ‰¾åˆ°ç›¸å…³çš„è¯‘æ–‡(ã€ŠJUCåŒæ­¥å™¨æ¡†æ¶ã€‹)ï¼Œå¦‚æœæƒ³è¦æ·±å…¥ç ”ç©¶AQSå¿…é¡»è¦ç†è§£ä¸€ä¸‹è¯¥è®ºæ–‡çš„å†…å®¹ï¼Œç„¶åè¯¦ç»†åˆ†æä¸€ä¸‹AQSçš„æºç å®ç°ã€‚æœ¬æ–‡åœ¨é˜…è¯»AQSæºç çš„æ—¶å€™é€‰ç”¨çš„JDKç‰ˆæœ¬æ˜¯JDK11ã€‚ AQSçš„ä¸»è¦åŠŸèƒ½ AQSæ˜¯JUCåŒ…ä¸­ç”¨äºæ„å»ºé”æˆ–è€…å…¶ä»–åŒæ­¥ç»„ä»¶(ä¿¡å·é‡ã€äº‹ä»¶ç­‰)çš„åŸºç¡€æ¡†æ¶ç±»ã€‚AQSä»å®ƒçš„å®ç°ä¸Šçœ‹ä¸»è¦æä¾›äº†ä¸‹é¢çš„åŠŸèƒ½ï¼š åŒæ­¥çŠ¶æ€çš„åŸå­æ€§ç®¡ç†ã€‚ çº¿ç¨‹çš„é˜»å¡å’Œè§£é™¤é˜»å¡ã€‚ æä¾›é˜»å¡çº¿ç¨‹çš„å­˜å‚¨é˜Ÿåˆ—ã€‚ åŸºäºè¿™ä¸‰å¤§åŠŸèƒ½ï¼Œè¡ç”Ÿå‡ºä¸‹é¢çš„é™„åŠ åŠŸèƒ½ï¼š é€šè¿‡ä¸­æ–­å®ç°çš„ä»»åŠ¡å–æ¶ˆï¼ŒåŸºäºçº¿ç¨‹ä¸­æ–­å®ç°ã€‚ å¯é€‰çš„è¶…æ—¶è®¾ç½®ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨è€…å¯ä»¥é€‰æ‹©æ”¾å¼ƒç­‰å¾…ã€‚ å®šä¹‰äº†Conditionæ¥å£ï¼Œç”¨äºæ”¯æŒç®¡ç¨‹å½¢å¼çš„await/signal/signalAllæ“ä½œï¼Œä»£æ›¿äº†Objectç±»åŸºäºJNIæä¾›çš„wait/notify/notifyAllã€‚ AQSè¿˜æ ¹æ®åŒæ­¥çŠ¶æ€çš„ä¸åŒç®¡ç†æ–¹å¼åŒºåˆ†ä¸ºä¸¤ç§ä¸åŒçš„å®ç°ï¼šç‹¬å çŠ¶æ€çš„åŒæ­¥å™¨å’Œå…±äº«çŠ¶æ€çš„åŒæ­¥å™¨ã€‚ JUCåŒæ­¥å™¨æ¡†æ¶åŸç† ã€ŠThe java.util.concurrent Synchronizer Frameworkã€‹ä¸€æ–‡ä¸­å…¶å®æœ‰æåŠåˆ°åŒæ­¥å™¨æ¡†æ¶çš„ä¼ªä»£ç ï¼š 123456789101112// acquireæ“ä½œå¦‚ä¸‹ï¼šwhile (synchronization state does not allow acquire) &#123; enqueue current thread if not already queued; possibly block current thread;&#125;dequeue current thread if it was queued;//releaseæ“ä½œå¦‚ä¸‹ï¼šupdate synchronization state;if (state may permit a blocked thread to acquire)&#123; unblock one or more queued threads;&#125; ç¿»è¯‘ä¸€ä¸‹ï¼š 1234567891011121314// acquireæ“ä½œå¦‚ä¸‹ï¼šwhile(åŒæ­¥çŠ¶æ€ç”³è¯·è·å–å¤±è´¥)&#123; if(å½“å‰çº¿ç¨‹æœªè¿›å…¥ç­‰å¾…é˜Ÿåˆ—)&#123; å½“å‰çº¿ç¨‹æ”¾å…¥ç­‰å¾…é˜Ÿåˆ—; &#125; å°è¯•é˜»å¡å½“å‰çº¿ç¨‹;&#125;å½“å‰çº¿ç¨‹ç§»å‡ºç­‰å¾…é˜Ÿåˆ—//releaseæ“ä½œå¦‚ä¸‹ï¼šæ›´æ–°åŒæ­¥çŠ¶æ€if(åŒæ­¥çŠ¶æ€è¶³å¤Ÿå…è®¸ä¸€ä¸ªé˜»å¡çš„çº¿ç¨‹ç”³è¯·è·å–)&#123; è§£é™¤ä¸€ä¸ªæˆ–è€…å¤šä¸ªç­‰å¾…é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹çš„é˜»å¡çŠ¶æ€;&#125; ä¸ºäº†å®ç°ä¸Šè¿°æ“ä½œï¼Œéœ€è¦ä¸‹é¢ä¸‰ä¸ªåŸºæœ¬ç»„ä»¶çš„ç›¸äº’åä½œï¼š åŒæ­¥çŠ¶æ€çš„åŸå­æ€§ç®¡ç†ã€‚ ç­‰å¾…é˜Ÿåˆ—çš„ç®¡ç†ã€‚ çº¿ç¨‹çš„é˜»å¡ä¸è§£é™¤é˜»å¡ã€‚ å…¶å®åŸºæœ¬åŸç†å¾ˆç®€å•ï¼Œä½†æ˜¯ä¸ºäº†åº”å¯¹å¤æ‚çš„å¹¶å‘åœºæ™¯å’Œå¹¶å‘åœºæ™¯ä¸‹ç¨‹åºæ‰§è¡Œçš„æ­£ç¡®æ€§ï¼ŒåŒæ­¥å™¨æ¡†æ¶åœ¨ä¸Šé¢çš„acquireæ“ä½œå’Œreleaseæ“ä½œä¸­ä½¿ç”¨äº†æ­»å¾ªç¯å’ŒCASç­‰æ“ä½œï¼Œå¾ˆå¤šæ—¶å€™ä¼šè®©äººæ„Ÿè§‰é€»è¾‘è¿‡äºå¤æ‚ã€‚ åŒæ­¥çŠ¶æ€ç®¡ç† AQSå†…éƒ¨å†…éƒ¨å®šä¹‰äº†ä¸€ä¸ª32ä½æ•´å‹çš„stateå˜é‡ç”¨äºä¿å­˜åŒæ­¥çŠ¶æ€ï¼š 12345678910111213141516171819/** * The synchronization state. */private volatile int state;// è·å–stateprotected final int getState() &#123; return state;&#125;// ç›´æ¥è¦†ç›–è®¾ç½®stateprotected final void setState(int newState) &#123; state = newState;&#125;// CASè®¾ç½®stateprotected final boolean compareAndSetState(int expect, int update) &#123; return STATE.compareAndSet(this, expect, update);&#125; åŒæ­¥çŠ¶æ€stateåœ¨ä¸åŒçš„å®ç°ä¸­å¯ä»¥æœ‰ä¸åŒçš„ä½œç”¨æˆ–è€…è¡¨ç¤ºæ„ä¹‰ï¼Œå®ƒå¯ä»¥ä»£è¡¨èµ„æºæ•°ã€é”çŠ¶æ€ç­‰ç­‰ï¼Œé‡åˆ°å…·ä½“çš„åœºæ™¯æˆ‘ä»¬å†åˆ†æå®ƒè¡¨ç¤ºçš„æ„ä¹‰ã€‚ CLHé˜Ÿåˆ—å˜ä½“ CLHé”å³Craig, Landin, and Hagersten (CLH) locksï¼Œå› ä¸ºå®ƒåº•å±‚æ˜¯åŸºäºé˜Ÿåˆ—å®ç°ï¼Œä¸€èˆ¬ä¹Ÿç§°ä¸ºCLHé˜Ÿåˆ—é”ã€‚CLHé”ä¹Ÿæ˜¯ä¸€ç§åŸºäºé“¾è¡¨çš„å¯æ‰©å±•ã€é«˜æ€§èƒ½ã€å…¬å¹³çš„è‡ªæ—‹é”ï¼Œç”³è¯·çº¿ç¨‹ä»…ä»…åœ¨æœ¬åœ°å˜é‡ä¸Šè‡ªæ—‹ï¼Œå®ƒä¸æ–­è½®è¯¢å‰é©±çš„çŠ¶æ€ï¼Œå‡è®¾å‘ç°å‰é©±é‡Šæ”¾äº†é”å°±ç»“æŸè‡ªæ—‹ã€‚ä»å®ç°ä¸Šçœ‹ï¼ŒCLHé”æ˜¯ä¸€ç§è‡ªæ—‹é”ï¼Œèƒ½ç¡®ä¿æ— é¥¥é¥¿æ€§ï¼Œæä¾›å…ˆæ¥å…ˆæœåŠ¡çš„å…¬å¹³æ€§ã€‚å…ˆçœ‹ç®€å•çš„CLHé”çš„ä¸€ä¸ªç®€å•å®ç°ï¼š 123456789101112131415161718192021222324252627282930313233343536public class CLHLock implements Lock &#123; AtomicReference&lt;QueueNode&gt; tail = new AtomicReference&lt;&gt;(new QueueNode()); ThreadLocal&lt;QueueNode&gt; pred; ThreadLocal&lt;QueueNode&gt; current; public CLHLock() &#123; current = ThreadLocal.withInitial(QueueNode::new); pred = ThreadLocal.withInitial(() -&gt; null); &#125; @Override public void lock() &#123; QueueNode node = current.get(); node.locked = true; QueueNode pred = tail.getAndSet(node); this.pred.set(pred); while (pred.locked) &#123; &#125; &#125; @Override public void unlock() &#123; QueueNode node = current.get(); node.locked = false; current.set(this.pred.get()); &#125; static class QueueNode &#123; boolean locked; &#125; // å¿½ç•¥å…¶ä»–æ¥å£æ–¹æ³•çš„å®ç°&#125; ä¸Šé¢æ˜¯ä¸€ä¸ªç®€å•çš„CLHé˜Ÿåˆ—é”çš„å®ç°ï¼Œå†…éƒ¨ç±»QueueNodeåªä½¿ç”¨äº†ä¸€ä¸ªç®€å•çš„å¸ƒå°”å€¼lockedå±æ€§è®°å½•äº†æ¯ä¸ªçº¿ç¨‹çš„çŠ¶æ€ï¼Œå¦‚æœè¯¥å±æ€§ä¸ºtrueï¼Œåˆ™ç›¸åº”çš„çº¿ç¨‹è¦ä¹ˆå·²ç»è·å–åˆ°é”ï¼Œè¦ä¹ˆæ­£åœ¨ç­‰å¾…é”ï¼Œå¦‚æœè¯¥å±æ€§ä¸ºfalseï¼Œåˆ™ç›¸åº”çš„çº¿ç¨‹å·²ç»é‡Šæ”¾äº†é”ã€‚æ–°æ¥çš„æƒ³è¦è·å–é”çš„çº¿ç¨‹å¿…é¡»å¯¹tailå±æ€§è°ƒç”¨getAndSet()æ–¹æ³•ï¼Œä½¿å¾—è‡ªèº«æˆä¸ºé˜Ÿåˆ—çš„å°¾éƒ¨ï¼ŒåŒæ—¶å¾—åˆ°ä¸€ä¸ªæŒ‡å‘å‰é©±èŠ‚ç‚¹çš„å¼•ç”¨predï¼Œæœ€åçº¿ç¨‹æ‰€åœ¨èŠ‚ç‚¹åœ¨å…¶å‰é©±èŠ‚ç‚¹çš„lockedå±æ€§ä¸Šè‡ªæ—‹ï¼Œå€¼å¾—å‰é©±èŠ‚ç‚¹é‡Šæ”¾é”ã€‚ä¸Šé¢çš„å®ç°æ˜¯æ— æ³•è¿è¡Œçš„ï¼Œå› ä¸ºä¸€æ—¦è‡ªæ—‹å°±ä¼šè¿›å…¥æ­»å¾ªç¯å¯¼è‡´CPUé£™å‡ï¼Œå¯ä»¥å°è¯•ä½¿ç”¨ä¸‹é¢å°†è¦æåˆ°çš„LockSupportè¿›è¡Œæ”¹é€ ã€‚ CLHé˜Ÿåˆ—é”æœ¬è´¨æ˜¯ä½¿ç”¨é˜Ÿåˆ—(å®é™…ä¸Šæ˜¯å•å‘é“¾è¡¨)å­˜æ”¾ç­‰å¾…è·å–é”çš„çº¿ç¨‹ï¼Œç­‰å¾…çš„çº¿ç¨‹æ€»æ˜¯åœ¨å…¶æ‰€åœ¨èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹çš„çŠ¶æ€ä¸Šè‡ªæ—‹ï¼Œç›´åˆ°å‰é©±èŠ‚ç‚¹é‡Šæ”¾èµ„æºã€‚ä»å®é™…æ¥çœ‹ï¼Œè¿‡åº¦è‡ªæ—‹å¸¦æ¥çš„CPUæ€§èƒ½æŸè€—æ¯”è¾ƒå¤§ï¼Œå¹¶ä¸æ˜¯ç†æƒ³çš„çº¿ç¨‹ç­‰å¾…é˜Ÿåˆ—å®ç°ã€‚ åŸºäºåŸå§‹çš„CLHé˜Ÿåˆ—é”ä¸­æä¾›çš„ç­‰å¾…é˜Ÿåˆ—çš„åŸºæœ¬åŸç†ï¼ŒAQSå®ç°ä¸€ç§äº†CLHé”é˜Ÿåˆ—çš„å˜ä½“(variant)ã€‚AQSç±»çš„protectedä¿®é¥°çš„æ„é€ å‡½æ•°é‡Œé¢æœ‰ä¸€å¤§æ®µæ³¨é‡Šç”¨äºè¯´æ˜AQSå®ç°çš„ç­‰å¾…é˜Ÿåˆ—çš„ç»†èŠ‚äº‹é¡¹ï¼Œè¿™é‡Œåˆ—ä¸¾å‡ ç‚¹é‡è¦çš„ï¼š AQSå®ç°çš„ç­‰å¾…é˜Ÿåˆ—æ²¡æœ‰ç›´æ¥ä½¿ç”¨CLHé”é˜Ÿåˆ—ï¼Œä½†æ˜¯å‚è€ƒäº†å…¶è®¾è®¡æ€è·¯ï¼Œç­‰å¾…èŠ‚ç‚¹ä¼šä¿å­˜å‰é©±èŠ‚ç‚¹ä¸­çº¿ç¨‹çš„ä¿¡æ¯ï¼Œå†…éƒ¨ä¹Ÿä¼šç»´æŠ¤ä¸€ä¸ªæ§åˆ¶çº¿ç¨‹é˜»å¡çš„çŠ¶æ€å€¼ã€‚ æ¯ä¸ªèŠ‚ç‚¹éƒ½è®¾è®¡ä¸ºä¸€ä¸ªæŒæœ‰å•ç‹¬çš„ç­‰å¾…çº¿ç¨‹å¹¶ä¸”&quot;å¸¦æœ‰å…·ä½“çš„é€šçŸ¥æ–¹å¼&quot;çš„ç›‘è§†å™¨ï¼Œè¿™é‡Œæ‰€è°“é€šçŸ¥æ–¹å¼å°±æ˜¯è‡ªå®šä¹‰å”¤é†’é˜»å¡çº¿ç¨‹çš„æ–¹å¼è€Œå·²ã€‚ ä¸€ä¸ªçº¿ç¨‹æ˜¯ç­‰å¾…é˜Ÿåˆ—ä¸­çš„ç¬¬ä¸€ä¸ªç­‰å¾…èŠ‚ç‚¹çš„æŒæœ‰çº¿ç¨‹ä¼šå°è¯•è·å–é”ï¼Œä½†æ˜¯å¹¶ä¸æ„å‘³ç€å®ƒä¸€å®šèƒ½å¤Ÿè·å–é”æˆåŠŸ(è¿™é‡Œçš„æ„æ€æ˜¯å­˜åœ¨å…¬å¹³å’Œéå…¬å¹³çš„å®ç°)ï¼Œè·å–å¤±è´¥å°±è¦é‡æ–°ç­‰å¾…ã€‚ ç­‰å¾…é˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹é€šè¿‡prevå±æ€§è¿æ¥å‰é©±èŠ‚ç‚¹ï¼Œé€šè¿‡nextå±æ€§è¿æ¥åç»§èŠ‚ç‚¹ï¼Œç®€å•æ¥è¯´ï¼Œå°±æ˜¯åŒå‘é“¾è¡¨çš„è®¾è®¡ã€‚ CLHé˜Ÿåˆ—æœ¬åº”è¯¥éœ€è¦ä¸€ä¸ªè™šæ‹Ÿçš„å¤´èŠ‚ç‚¹ï¼Œä½†æ˜¯åœ¨AQSä¸­æ²¡æœ‰ç›´æ¥æä¾›è™šæ‹Ÿçš„å¤´èŠ‚ç‚¹ï¼Œè€Œæ˜¯å»¶è¿Ÿåˆ°ç¬¬ä¸€æ¬¡ç«äº‰å‡ºç°çš„æ—¶å€™æ‡’åˆ›å»ºè™šæ‹Ÿçš„å¤´èŠ‚ç‚¹(å…¶å®ä¹Ÿä¼šåˆ›å»ºå°¾èŠ‚ç‚¹ï¼Œåˆå§‹åŒ–æ—¶å¤´å°¾èŠ‚ç‚¹æ˜¯åŒä¸€ä¸ªèŠ‚ç‚¹)ã€‚ Condition(æ¡ä»¶)ç­‰å¾…é˜Ÿåˆ—ä¸­çš„é˜»å¡çº¿ç¨‹ä½¿ç”¨çš„æ˜¯ç›¸åŒçš„Nodeç»“æ„ï¼Œä½†æ˜¯æä¾›äº†å¦ä¸€ä¸ªé“¾è¡¨ç”¨æ¥å­˜æ”¾ï¼ŒConditionç­‰å¾…é˜Ÿåˆ—çš„å®ç°æ¯”éConditionç­‰å¾…é˜Ÿåˆ—å¤æ‚ã€‚ çº¿ç¨‹é˜»å¡ä¸å”¤é†’ çº¿ç¨‹çš„é˜»å¡å’Œå”¤é†’åœ¨JDK1.5ä¹‹å‰ï¼Œä¸€èˆ¬åªèƒ½ä¾èµ–äºObjectç±»æä¾›çš„wait()ã€notify()å’ŒnotifyAll()æ–¹æ³•ï¼Œå®ƒä»¬éƒ½æ˜¯JNIæ–¹æ³•ï¼Œç”±JVMæä¾›å®ç°ï¼Œå¹¶ä¸”å®ƒä»¬å¿…é¡»è¿è¡Œåœ¨è·å–ç›‘è§†å™¨é”çš„ä»£ç å—å†…(synchronizedä»£ç å—ä¸­)ï¼Œè¿™ä¸ªå±€é™æ€§å…ˆä¸è°ˆæ€§èƒ½ä¸Šçš„é—®é¢˜ï¼Œä»£ç çš„ç®€æ´æ€§å’Œçµæ´»æ€§æ˜¯æ¯”è¾ƒä½çš„ã€‚JDK1.5å¼•å…¥äº†LockSupportç±»ï¼Œåº•å±‚æ˜¯åŸºäºUnsafeç±»çš„park()å’Œunpark()æ–¹æ³•ï¼Œæä¾›äº†çº¿ç¨‹é˜»å¡å’Œå”¤é†’çš„åŠŸèƒ½ï¼Œå®ƒçš„æœºåˆ¶æœ‰ç‚¹åƒåªæœ‰ä¸€ä¸ªå…è®¸ä½¿ç”¨èµ„æºçš„ä¿¡å·é‡java.util.concurrent.Semaphoreï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªçº¿ç¨‹åªèƒ½é€šè¿‡park()æ–¹æ³•é˜»å¡ä¸€æ¬¡ï¼Œåªèƒ½è°ƒç”¨unpark()æ–¹æ³•è§£é™¤è°ƒç”¨é˜»å¡ä¸€æ¬¡ï¼Œçº¿ç¨‹å°±ä¼šå”¤é†’(å¤šæ¬¡è°ƒç”¨unpark()æ–¹æ³•ä¹Ÿåªä¼šå”¤é†’ä¸€æ¬¡)ï¼Œå¯ä»¥æƒ³è±¡æ˜¯å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ª0-1çš„è®¡æ•°å™¨ã€‚ LockSupportç±»å¦‚æœä½¿ç”¨å¾—å¥½ï¼Œå¯ä»¥æä¾›æ›´çµæ´»çš„ç¼–ç æ–¹å¼ï¼Œè¿™é‡Œä¸¾ä¸ªç®€å•çš„ä½¿ç”¨ä¾‹å­ï¼š 123456789101112131415161718192021222324252627282930313233343536public class LockSupportMain implements Runnable &#123; private static final DateTimeFormatter FORMATTER = DateTimeFormatter.ofPattern(\"yyyy-MM-dd HH:mm:ss.SSS\"); private Thread thread; private void setThread(Thread thread) &#123; this.thread = thread; &#125; public static void main(String[] args) throws Exception &#123; LockSupportMain main = new LockSupportMain(); Thread thread = new Thread(main, \"LockSupportMain\"); main.setThread(thread); thread.start(); Thread.sleep(2000); main.unpark(); Thread.sleep(2000); &#125; @Override public void run() &#123; System.out.println(String.format(\"%s-æ­¥å…¥runæ–¹æ³•,çº¿ç¨‹åç§°:%s\", FORMATTER.format(LocalDateTime.now()), Thread.currentThread().getName())); LockSupport.park(); System.out.println(String.format(\"%s-è§£é™¤é˜»å¡,çº¿ç¨‹ç»§ç»­æ‰§è¡Œ,çº¿ç¨‹åç§°:%s\", FORMATTER.format(LocalDateTime.now()), Thread.currentThread().getName())); &#125; private void unpark() &#123; LockSupport.unpark(thread); &#125;&#125;// æŸä¸ªæ—¶åˆ»çš„æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š2019-02-25 00:39:57.780-æ­¥å…¥runæ–¹æ³•,çº¿ç¨‹åç§°:LockSupportMain2019-02-25 00:39:59.767-è§£é™¤é˜»å¡,çº¿ç¨‹ç»§ç»­æ‰§è¡Œ,çº¿ç¨‹åç§°:LockSupportMain LockSupportç±»park()æ–¹æ³•ä¹Ÿæœ‰å¸¦è¶…æ—¶çš„å˜ä½“ç‰ˆæœ¬æ–¹æ³•ï¼Œæœ‰äº›é€‚åˆä½¿ç”¨é˜»å¡è¶…æ—¶çš„åœºæ™¯ä¸å¦¨å¯ä»¥ä½¿ç”¨ã€‚ ç‹¬å çº¿ç¨‹çš„ä¿å­˜ AbstractOwnableSynchronizeræ˜¯AQSçš„çˆ¶ç±»ï¼Œä¸€ä¸ªåŒæ­¥å™¨æ¡†æ¶æœ‰å¯èƒ½åœ¨ä¸€ä¸ªæ—¶åˆ»è¢«æŸä¸€ä¸ªçº¿ç¨‹ç‹¬å ï¼ŒAbstractOwnableSynchronizerå°±æ˜¯ä¸ºæ‰€æœ‰çš„åŒæ­¥å™¨å®ç°å’Œé”ç›¸å…³å®ç°æä¾›äº†åŸºç¡€çš„ä¿å­˜ã€è·å–å’Œè®¾ç½®ç‹¬å çº¿ç¨‹çš„åŠŸèƒ½ï¼Œè¿™ä¸ªç±»çš„æºç å¾ˆç®€å•ï¼š 1234567891011121314151617public abstract class AbstractOwnableSynchronizer implements java.io.Serializable &#123; private static final long serialVersionUID = 3737899427754241961L; protected AbstractOwnableSynchronizer() &#123; &#125; private transient Thread exclusiveOwnerThread; protected final void setExclusiveOwnerThread(Thread thread) &#123; exclusiveOwnerThread = thread; &#125; protected final Thread getExclusiveOwnerThread() &#123; return exclusiveOwnerThread; &#125;&#125; å®ƒå°±æä¾›äº†ä¸€ä¸ªä¿å­˜ç‹¬å çº¿ç¨‹çš„å˜é‡å¯¹åº”çš„Setterå’ŒGetteræ–¹æ³•ï¼Œæ–¹æ³•éƒ½æ˜¯finalä¿®é¥°çš„ï¼Œå­ç±»åªèƒ½ä½¿ç”¨ä¸èƒ½è¦†ç›–ã€‚ CLHé˜Ÿåˆ—å˜ä½“çš„å®ç° è¿™é‡Œå…ˆé‡ç‚¹åˆ†æä¸€ä¸‹AQSä¸­ç­‰å¾…é˜Ÿåˆ—çš„èŠ‚ç‚¹AQS$Nodeçš„æºç ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081static final class Node &#123; // æ ‡è®°ä¸€ä¸ªèŠ‚ç‚¹å¤„äºå…±äº«æ¨¡å¼ä¸‹çš„ç­‰å¾… static final Node SHARED = new Node(); // æ ‡è®°ä¸€ä¸ªèŠ‚ç‚¹å¤„äºç‹¬å æ¨¡å¼ä¸‹çš„ç­‰å¾… static final Node EXCLUSIVE = null; // å–æ¶ˆçŠ¶æ€ static final int CANCELLED = 1; // å”¤é†’çŠ¶æ€ static final int SIGNAL = -1; // æ¡ä»¶ç­‰å¾…çŠ¶æ€ static final int CONDITION = -2; // ä¼ æ’­çŠ¶æ€ static final int PROPAGATE = -3; // ç­‰å¾…çŠ¶æ€ï¼Œåˆå§‹å€¼ä¸º0ï¼Œå…¶ä»–å¯é€‰å€¼æ˜¯ä¸Šé¢çš„4ä¸ªå€¼ volatile int waitStatus; // å½“å‰èŠ‚ç‚¹å‰é©±èŠ‚ç‚¹çš„å¼•ç”¨ volatile Node prev; // å½“å‰èŠ‚ç‚¹åç»§èŠ‚ç‚¹çš„å¼•ç”¨ volatile Node next; // å½“å‰èŠ‚ç‚¹æŒæœ‰çš„çº¿ç¨‹ï¼Œå¯èƒ½æ˜¯é˜»å¡ä¸­ç­‰å¾…å”¤é†’çš„çº¿ç¨‹ volatile Thread thread; // ä¸‹ä¸€ä¸ªç­‰å¾…èŠ‚ç‚¹ Node nextWaiter; // å½“å‰æ“ä½œçš„èŠ‚ç‚¹æ˜¯å¦å¤„äºå…±äº«æ¨¡å¼ final boolean isShared() &#123; return nextWaiter == SHARED; &#125; // è·å–å½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹ï¼Œç¡®ä¿å‰é©±èŠ‚ç‚¹å¿…é¡»å­˜åœ¨ï¼Œå¦åˆ™æŠ›å‡ºNPE final Node predecessor() &#123; Node p = prev; if (p == null) throw new NullPointerException(); else return p; &#125; // ç©ºèŠ‚ç‚¹ï¼Œä¸»è¦æ˜¯é¦–æ¬¡åˆ›å»ºé˜Ÿåˆ—çš„æ—¶å€™åˆ›å»ºçš„å¤´å’Œå°¾èŠ‚ç‚¹ä½¿ç”¨ Node() &#123;&#125; // è®¾ç½®ä¸‹ä¸€ä¸ªç­‰å¾…èŠ‚ç‚¹ï¼Œè®¾ç½®æŒæœ‰çº¿ç¨‹ä¸ºå½“å‰çº¿ç¨‹ Node(Node nextWaiter) &#123; this.nextWaiter = nextWaiter; THREAD.set(this, Thread.currentThread()); &#125; // è®¾ç½®waitStatusï¼Œè®¾ç½®æŒæœ‰çº¿ç¨‹ä¸ºå½“å‰çº¿ç¨‹ Node(int waitStatus) &#123; WAITSTATUS.set(this, waitStatus); THREAD.set(this, Thread.currentThread()); &#125; // CASæ›´æ–°waitStatus final boolean compareAndSetWaitStatus(int expect, int update) &#123; return WAITSTATUS.compareAndSet(this, expect, update); &#125; // CASè®¾ç½®åç»§èŠ‚ç‚¹ final boolean compareAndSetNext(Node expect, Node update) &#123; return NEXT.compareAndSet(this, expect, update); &#125; // è®¾ç½®å‰é©±èŠ‚ç‚¹ final void setPrevRelaxed(Node p) &#123; PREV.set(this, p); &#125; // ä¸‹é¢æ˜¯å˜é‡å¥æŸ„çš„å®ç°ï¼Œåœ¨VarHandleå‡ºç°ä¹‹å‰ä½¿ç”¨çš„æ˜¯Unsafeï¼Œå…¶å®åº•å±‚è¿˜æ˜¯ç…§æ ·ä½¿ç”¨Unsafe private static final VarHandle NEXT; private static final VarHandle PREV; private static final VarHandle THREAD; private static final VarHandle WAITSTATUS; static &#123; try &#123; MethodHandles.Lookup l = MethodHandles.lookup(); NEXT = l.findVarHandle(Node.class, \"next\", Node.class); PREV = l.findVarHandle(Node.class, \"prev\", Node.class); THREAD = l.findVarHandle(Node.class, \"thread\", Thread.class); WAITSTATUS = l.findVarHandle(Node.class, \"waitStatus\", int.class); &#125; catch (ReflectiveOperationException e) &#123; throw new ExceptionInInitializerError(e); &#125; &#125; &#125; å…¶ä¸­ï¼Œå˜é‡å¥æŸ„(VarHandle)æ˜¯JDK9å¼•ç”¨çš„æ–°ç‰¹æ€§ï¼Œå…¶å®åº•å±‚ä¾èµ–çš„è¿˜æ˜¯Unsafeçš„æ–¹æ³•ï¼Œæ€»ä½“å’ŒJDK8çš„å®ç°æ˜¯åŸºæœ¬ä¸€è‡´ã€‚è¿™é‡Œéœ€è¦å…³æ³¨ä¸€ä¸‹Nodeé‡Œé¢çš„å‡ ä¸ªå±æ€§ï¼š waitStatusï¼šå½“å‰Nodeå®ä¾‹çš„ç­‰å¾…çŠ¶æ€ï¼Œå¯é€‰å€¼æœ‰5ä¸ªã€‚ åˆå§‹å€¼æ•´æ•°0ï¼šå½“å‰èŠ‚ç‚¹å¦‚æœä¸æŒ‡å®šåˆå§‹åŒ–çŠ¶æ€å€¼ï¼Œé»˜è®¤å€¼å°±æ˜¯0ï¼Œä¾§é¢è¯´æ˜èŠ‚ç‚¹æ­£åœ¨ç­‰å¾…é˜Ÿåˆ—ä¸­å¤„äºç­‰å¾…çŠ¶æ€ã€‚ Node#CANCELLEDæ•´æ•°å€¼1ï¼šè¡¨ç¤ºå½“å‰èŠ‚ç‚¹å®ä¾‹å› ä¸ºè¶…æ—¶æˆ–è€…çº¿ç¨‹ä¸­æ–­è€Œè¢«å–æ¶ˆï¼Œç­‰å¾…ä¸­çš„èŠ‚ç‚¹æ°¸è¿œä¸ä¼šå¤„äºæ­¤çŠ¶æ€ï¼Œè¢«å–æ¶ˆçš„èŠ‚ç‚¹ä¸­çš„çº¿ç¨‹å®ä¾‹ä¸ä¼šé˜»å¡ã€‚ Node#SIGNALæ•´æ•°å€¼-1ï¼šè¡¨ç¤ºå½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹æ˜¯(æˆ–å³å°†æ˜¯)é˜»å¡çš„(é€šè¿‡park)ï¼Œå½“å®ƒé‡Šæ”¾æˆ–å–æ¶ˆæ—¶ï¼Œå½“å‰èŠ‚ç‚¹å¿…é¡»unparkå®ƒçš„åç»§èŠ‚ç‚¹ã€‚ Node#CONDITIONæ•´æ•°å€¼-2ï¼šè¡¨ç¤ºå½“å‰èŠ‚ç‚¹æ˜¯æ¡ä»¶é˜Ÿåˆ—ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå½“å®ƒè½¬æ¢ä¸ºåŒæ­¥é˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹çš„æ—¶å€™ï¼ŒçŠ¶æ€ä¼šè¢«é‡æ–°è®¾ç½®ä¸º0ã€‚ Node#PROPAGATEæ•´æ•°å€¼-3ï¼šæ­¤çŠ¶æ€å€¼é€šå¸¸åªè®¾ç½®åˆ°è°ƒç”¨äº†doReleaseShared()æ–¹æ³•çš„å¤´èŠ‚ç‚¹ï¼Œç¡®ä¿releaseShared()æ–¹æ³•çš„è°ƒç”¨å¯ä»¥ä¼ æ’­åˆ°å…¶ä»–çš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œç®€å•ç†è§£å°±æ˜¯å…±äº«æ¨¡å¼ä¸‹èŠ‚ç‚¹é‡Šæ”¾çš„ä¼ é€’æ ‡è®°ã€‚ prevã€nextï¼šå½“å‰Nodeå®ä¾‹çš„å‰é©±èŠ‚ç‚¹å¼•ç”¨å’Œåç»§èŠ‚ç‚¹å¼•ç”¨ã€‚ threadï¼šå½“å‰Nodeå®ä¾‹æŒæœ‰çš„çº¿ç¨‹å®ä¾‹å¼•ç”¨ã€‚ nextWaiterï¼šè¿™ä¸ªå€¼æ˜¯ä¸€ä¸ªæ¯”è¾ƒå®¹æ˜“ä»¤äººç”Ÿç–‘çš„å€¼ï¼Œè™½ç„¶è¡¨é¢ä¸Šå®ƒç§°ä¸º&quot;ä¸‹ä¸€ä¸ªç­‰å¾…çš„èŠ‚ç‚¹&quot;ï¼Œä½†æ˜¯å®é™…ä¸Šå®ƒæœ‰ä¸‰ç§å–å€¼çš„æƒ…å†µã€‚ å€¼ä¸ºé™æ€å®ä¾‹Node.EXCLUSIVE(ä¹Ÿå°±æ˜¯null)ï¼Œä»£è¡¨å½“å‰çš„Nodeå®ä¾‹æ˜¯ç‹¬å æ¨¡å¼ã€‚ å€¼ä¸ºé™æ€å®ä¾‹Node.SHAREDï¼Œä»£è¡¨å½“å‰çš„Nodeå®ä¾‹æ˜¯å…±äº«æ¨¡å¼ã€‚ å€¼ä¸ºéNode.EXCLUSIVEå’ŒNode.SHAREDçš„å…¶ä»–èŠ‚ç‚¹å®ä¾‹ï¼Œä»£è¡¨Conditionç­‰å¾…é˜Ÿåˆ—ä¸­å½“å‰èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªç­‰å¾…èŠ‚ç‚¹ã€‚ Nodeç±»çš„ç­‰å¾…çŠ¶æ€waitStatusç†è§£èµ·æ¥æ˜¯ååˆ†è´¹åŠ²çš„ï¼Œä¸‹é¢åˆ†æå…¶ä»–æºç çš„æ—¶å€™ä¼šæ ‡è¯†æ­¤çŠ¶æ€å˜åŒ–çš„æ—¶æœºã€‚ å…¶å®ä¸Šé¢çš„Nodeç±»å¯ä»¥ç›´æ¥æ‹·è´å‡ºæ¥å½“æˆä¸€ä¸ªæ–°å»ºçš„ç±»ï¼Œç„¶åå°è¯•æ„å»ºä¸€ä¸ªåŒå‘é“¾è¡¨è‡ªè¡Œè°ƒè¯•ï¼Œè¿™æ ·å­å°±èƒ½æ·±åˆ»å®ƒçš„æ•°æ®ç»“æ„ã€‚ä¾‹å¦‚ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091public class AqsNode &#123; static final AqsNode SHARED = new AqsNode(); static final AqsNode EXCLUSIVE = null; static final int CANCELLED = 1; static final int SIGNAL = -1; static final int CONDITION = -2; static final int PROPAGATE = -3; volatile int waitStatus; volatile AqsNode prev; volatile AqsNode next; volatile Thread thread; AqsNode nextWaiter; final boolean isShared() &#123; return nextWaiter == SHARED; &#125; final AqsNode predecessor() &#123; AqsNode p = prev; if (p == null) throw new NullPointerException(); else return p; &#125; AqsNode() &#123; &#125; AqsNode(AqsNode nextWaiter) &#123; this.nextWaiter = nextWaiter; THREAD.set(this, Thread.currentThread()); &#125; AqsNode(int waitStatus) &#123; WAITSTATUS.set(this, waitStatus); THREAD.set(this, Thread.currentThread()); &#125; final boolean compareAndSetWaitStatus(int expect, int update) &#123; return WAITSTATUS.compareAndSet(this, expect, update); &#125; final boolean compareAndSetNext(AqsNode expect, AqsNode update) &#123; return NEXT.compareAndSet(this, expect, update); &#125; final void setPrevRelaxed(AqsNode p) &#123; PREV.set(this, p); &#125; private static final VarHandle NEXT; private static final VarHandle PREV; private static final VarHandle THREAD; private static final VarHandle WAITSTATUS; static &#123; try &#123; MethodHandles.Lookup l = MethodHandles.lookup(); NEXT = l.findVarHandle(AqsNode.class, \"next\", AqsNode.class); PREV = l.findVarHandle(AqsNode.class, \"prev\", AqsNode.class); THREAD = l.findVarHandle(AqsNode.class, \"thread\", Thread.class); WAITSTATUS = l.findVarHandle(AqsNode.class, \"waitStatus\", int.class); &#125; catch (ReflectiveOperationException e) &#123; throw new ExceptionInInitializerError(e); &#125; &#125; public static void main(String[] args) throws Exception &#123; AqsNode head = new AqsNode(); AqsNode next = new AqsNode(AqsNode.EXCLUSIVE); head.next = next; next.prev = head; AqsNode tail = new AqsNode(AqsNode.EXCLUSIVE); next.next = tail; tail.prev = next; List&lt;Thread&gt; threads = new ArrayList&lt;&gt;(); for (AqsNode node = head; node != null; node = node.next) &#123; threads.add(node.thread); &#125; System.out.println(threads); &#125;&#125;// æŸæ¬¡æ‰§è¡Œçš„è¾“å‡ºï¼š[null, Thread[main,5,main], Thread[main,5,main]] å®é™…ä¸Šï¼ŒAQSä¸­ä¸€å…±å­˜åœ¨ä¸¤ç§ç­‰å¾…é˜Ÿåˆ—ï¼Œå…¶ä¸­ä¸€ç§æ˜¯æ™®é€šçš„åŒæ­¥ç­‰å¾…é˜Ÿåˆ—ï¼Œè¿™é‡Œå‘½åä¸ºSync-Queueï¼Œå¦ä¸€ç§æ˜¯åŸºäºSync-Queueå®ç°çš„æ¡ä»¶ç­‰å¾…é˜Ÿåˆ—ï¼Œè¿™é‡Œå‘½åä¸ºCondition-Queueã€‚ Sync-Queue å‰é¢å·²ç»ä»‹ç»å®ŒAQSçš„åŒæ­¥ç­‰å¾…é˜Ÿåˆ—èŠ‚ç‚¹ç±»ï¼Œä¸‹é¢é‡ç‚¹åˆ†æä¸€ä¸‹åŒæ­¥ç­‰å¾…é˜Ÿåˆ—çš„ç›¸å…³æºç ï¼Œä¸‹æ–‡çš„Syncé˜Ÿåˆ—ã€åŒæ­¥é˜Ÿåˆ—å’ŒåŒæ­¥ç­‰å¾…é˜Ÿåˆ—æ˜¯åŒä¸€ä¸ªä¸œè¥¿ã€‚é¦–å…ˆï¼Œæˆ‘ä»¬é€šè¿‡åˆ†æNodeèŠ‚ç‚¹å¾—çŸ¥Syncé˜Ÿåˆ—ä¸€å®šæ˜¯åŒå‘é“¾è¡¨ï¼ŒAQSä¸­æœ‰ä¸¤ä¸ªç¬æ—¶æˆå‘˜å˜é‡ç”¨æ¥å­˜æ”¾å¤´èŠ‚ç‚¹å’Œå°¾èŠ‚ç‚¹ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243// å¤´èŠ‚ç‚¹å¼•ç”¨private transient volatile Node head;// å°¾èŠ‚ç‚¹å¼•ç”¨private transient volatile Node tail;// å˜é‡å¥æŸ„ç›¸å…³ï¼Œç”¨äºCASæ“ä½œå¤´å°¾èŠ‚ç‚¹private static final VarHandle STATE;private static final VarHandle HEAD;private static final VarHandle TAIL;static &#123; try &#123; MethodHandles.Lookup l = MethodHandles.lookup(); STATE = l.findVarHandle(AbstractQueuedSynchronizer.class, \"state\", int.class); HEAD = l.findVarHandle(AbstractQueuedSynchronizer.class, \"head\", Node.class); TAIL = l.findVarHandle(AbstractQueuedSynchronizer.class, \"tail\", Node.class); &#125; catch (ReflectiveOperationException e) &#123; throw new ExceptionInInitializerError(e); &#125; // ç¡®ä¿LockSupportç±»å·²ç»åˆå§‹åŒ– - è¿™é‡Œåº”è¯¥æ˜¯ä¸ºäº†ä¿®å¤ä¹‹å‰ä¸€ä¸ªå› ä¸ºLockSupportæœªåˆå§‹åŒ–å¯¼è‡´çš„BUG Class&lt;?&gt; ensureLoaded = LockSupport.class;&#125;// åˆå§‹åŒ–åŒæ­¥é˜Ÿåˆ—ï¼Œæ³¨æ„åˆå§‹åŒ–åŒæ­¥é˜Ÿåˆ—çš„æ—¶å€™ï¼Œå¤´å°¾èŠ‚ç‚¹éƒ½æ˜¯æŒ‡å‘åŒä¸€ä¸ªæ–°çš„Nodeå®ä¾‹private final void initializeSyncQueue() &#123; Node h; if (HEAD.compareAndSet(this, null, (h = new Node()))) tail = h;&#125;// CASè®¾ç½®åŒæ­¥é˜Ÿåˆ—çš„å°¾èŠ‚ç‚¹private final boolean compareAndSetTail(Node expect, Node update) &#123; return TAIL.compareAndSet(this, expect, update);&#125;// è®¾ç½®å¤´èŠ‚ç‚¹ï¼Œé‡ç‚¹æ³¨æ„è¿™é‡Œï¼šä¼ å…¥çš„èŠ‚ç‚¹è®¾ç½®æˆå¤´èŠ‚ç‚¹ä¹‹åï¼Œå‰é©±èŠ‚ç‚¹å’ŒæŒæœ‰çš„çº¿ç¨‹ä¼šç½®ä¸ºnullï¼Œè¿™æ˜¯å› ä¸ºï¼š// 1.å¤´èŠ‚ç‚¹ä¸€å®šæ²¡æœ‰å‰é©±èŠ‚ç‚¹ã€‚// 2.å½“èŠ‚ç‚¹è¢«è®¾ç½®ä¸ºå¤´èŠ‚ç‚¹ï¼Œå®ƒæ‰€åœ¨çš„çº¿ç¨‹ä¸€å®šæ˜¯å·²ç»è§£é™¤äº†é˜»å¡ã€‚private void setHead(Node node) &#123; head = node; node.thread = null; node.prev = null;&#125; å½“å‰çº¿ç¨‹åŠ å…¥åŒæ­¥ç­‰å¾…é˜Ÿåˆ—å’ŒåŒæ­¥ç­‰å¾…é˜Ÿåˆ—çš„åˆå§‹åŒ–æ˜¯åŒä¸€ä¸ªæ–¹æ³•ï¼Œå‰æ–‡æåˆ°è¿‡ï¼šåŒæ­¥ç­‰å¾…é˜Ÿåˆ—çš„åˆå§‹åŒ–ä¼šå»¶è¿Ÿåˆ°ç¬¬ä¸€æ¬¡å¯èƒ½å‡ºç°ç«äº‰çš„æƒ…å†µï¼Œè¿™æ˜¯ä¸ºäº†é¿å…æ— è°“çš„èµ„æºæµªè´¹ï¼Œå…·ä½“æ–¹æ³•æ˜¯addWaiter(Node mode)ï¼š 12345678910111213141516171819// æ·»åŠ ç­‰å¾…èŠ‚ç‚¹åˆ°åŒæ­¥ç­‰å¾…é˜Ÿåˆ—ï¼Œå®é™…ä¸Šåˆå§‹åŒ–é˜Ÿåˆ—ä¹Ÿæ˜¯è¿™ä¸ªæ–¹æ³•å®Œæˆçš„private Node addWaiter(Node mode) &#123; // åŸºäºå½“å‰çº¿ç¨‹åˆ›å»ºä¸€ä¸ªæ–°èŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹çš„æ¨¡å¼ç”±è°ƒç”¨è€…å†³å®š Node node = new Node(mode); for (;;) &#123; Node oldTail = tail; // å°¾èŠ‚ç‚¹ä¸ä¸ºç©ºè¯´æ˜é˜Ÿåˆ—å·²ç»åˆå§‹åŒ–è¿‡ï¼Œåˆ™æŠŠæ–°èŠ‚ç‚¹åŠ å…¥åˆ°é“¾è¡¨ä¸­ï¼Œä½œä¸ºæ–°çš„å°¾èŠ‚ç‚¹ï¼Œå»ºç«‹å’Œå‰é©±èŠ‚ç‚¹çš„å…³è”å…³ç³» if (oldTail != null) &#123; node.setPrevRelaxed(oldTail); if (compareAndSetTail(oldTail, node)) &#123; oldTail.next = node; return node; &#125; &#125; else &#123; // å°¾èŠ‚ç‚¹ä¸ºç©ºè¯´æ˜é˜Ÿåˆ—å°šæœªåˆå§‹åŒ–è¿‡ï¼Œè¿›è¡Œä¸€æ¬¡åˆå§‹åŒ–æ“ä½œ initializeSyncQueue(); &#125; &#125;&#125; åœ¨é¦–æ¬¡è°ƒç”¨addWaiter()æ–¹æ³•ï¼Œæ­»å¾ªç¯è‡³å°‘æ‰§è¡Œä¸¤è½®å†è·³å‡ºï¼Œå› ä¸ºåŒæ­¥é˜Ÿåˆ—å¿…é¡»åˆå§‹åŒ–å®Œæˆå(ç¬¬ä¸€è½®å¾ªç¯)ï¼Œç„¶åå†æŠŠå½“å‰çº¿ç¨‹æ‰€åœ¨çš„æ–°èŠ‚ç‚¹å®ä¾‹æ·»åŠ åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­å†è¿”å›(ç¬¬äºŒè½®å¾ªç¯)å½“å‰çš„èŠ‚ç‚¹ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯æ–°åŠ å…¥åŒæ­¥ç­‰å¾…é˜Ÿåˆ—çš„èŠ‚ç‚¹ä¸€å®šæ˜¯æ·»åŠ åˆ°é˜Ÿåˆ—çš„å°¾éƒ¨å¹¶ä¸”ä¼šæ›´æ–°AQSä¸­çš„tailå±æ€§ä¸ºæœ€æ–°å…¥é˜Ÿçš„èŠ‚ç‚¹å®ä¾‹ã€‚ å‡è®¾æˆ‘ä»¬ä½¿ç”¨Node.EXCLUSIVEæ¨¡å¼å…¥é˜Ÿåˆ—ï¼Œæ‰‹ä¸Šæœ‰ä¸‰ä¸ªçº¿ç¨‹åˆ†åˆ«æ˜¯thread-1ã€thread-2å’Œthread-3ï¼Œçº¿ç¨‹å…¥é˜Ÿçš„æ—¶å€™éƒ½å¤„äºé˜»å¡çŠ¶æ€ï¼Œæ¨¡æ‹Ÿä¸€ä¸‹ä¾æ¬¡è°ƒç”¨ä¸Šé¢çš„å…¥é˜Ÿæ–¹æ³•çš„åŒæ­¥é˜Ÿåˆ—çš„æ•´ä¸ªé“¾è¡¨çš„çŠ¶æ€ã€‚ å…ˆæ˜¯çº¿ç¨‹thread-1åŠ å…¥ç­‰å¾…é˜Ÿåˆ—ï¼š æ¥ç€æ˜¯çº¿ç¨‹thread-2åŠ å…¥ç­‰å¾…é˜Ÿåˆ—ï¼š æœ€åæ˜¯çº¿ç¨‹thread-3åŠ å…¥ç­‰å¾…é˜Ÿåˆ—ï¼š å¦‚æœä»”ç»†ç ”ç©¶ä¼šå‘ç°ï¼Œå¦‚æœæ‰€æœ‰çš„å…¥é˜Ÿçº¿ç¨‹éƒ½å¤„äºé˜»å¡çŠ¶æ€çš„è¯ï¼Œæ–°å…¥é˜Ÿçš„çº¿ç¨‹æ€»æ˜¯æ·»åŠ åˆ°é˜Ÿåˆ—çš„tailèŠ‚ç‚¹ï¼Œé˜»å¡çš„çº¿ç¨‹æ€»æ˜¯&quot;äº‰æŠ¢&quot;ç€æˆä¸ºheadèŠ‚ç‚¹ï¼Œè¿™ä¸€ç‚¹å’ŒCLHé˜Ÿåˆ—é”çš„é˜»å¡çº¿ç¨‹æ€»æ˜¯åŸºäºå‰é©±èŠ‚ç‚¹è‡ªæ—‹ä»¥è·å–é”çš„æ€è·¯æ˜¯ä¸€è‡´çš„ã€‚ä¸‹é¢å°†ä¼šåˆ†æçš„ç‹¬å æ¨¡å¼ä¸å…±äº«æ¨¡å¼ï¼Œçº¿ç¨‹åŠ å…¥ç­‰å¾…é˜Ÿåˆ—éƒ½æ˜¯é€šè¿‡addWaiter()æ–¹æ³•ã€‚ Condition-Queue å‰é¢å·²ç»ç›¸å¯¹è¯¦ç»†åœ°ä»‹ç»è¿‡åŒæ­¥ç­‰å¾…é˜Ÿåˆ—ï¼Œåœ¨AQSä¸­è¿˜å­˜åœ¨å¦å¤–ä¸€ç§ç›¸å¯¹ç‰¹æ®Šå’Œå¤æ‚çš„ç­‰å¾…é˜Ÿåˆ—-æ¡ä»¶ç­‰å¾…é˜Ÿåˆ—ã€‚ä»‹ç»æ¡ä»¶ç­‰å¾…é˜Ÿåˆ—ä¹‹å‰ï¼Œè¦å…ˆä»‹ç»java.util.concurrent.locks.Conditionæ¥å£ã€‚ 1234567891011121314151617public interface Condition &#123; // å½“å‰çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ç›´åˆ°è¢«å”¤é†’æˆ–è€…ä¸­æ–­ void await() throws InterruptedException; // å½“å‰çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ï¼Œä¸å“åº”ä¸­æ–­ï¼Œé˜»å¡ç›´åˆ°è¢«å”¤é†’ void awaitUninterruptibly(); // å½“å‰çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ç›´åˆ°è¢«å”¤é†’æˆ–è€…ä¸­æ–­ï¼Œé˜»å¡å¸¦æ—¶é—´é™åˆ¶ long awaitNanos(long nanosTimeout) throws InterruptedException; // å½“å‰çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ç›´åˆ°è¢«å”¤é†’æˆ–è€…ä¸­æ–­ï¼Œé˜»å¡å¸¦æ—¶é—´é™åˆ¶ boolean await(long time, TimeUnit unit) throws InterruptedException; // å½“å‰çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ç›´åˆ°è¢«å”¤é†’æˆ–è€…ä¸­æ–­ï¼Œé˜»å¡å¸¦æ—¶é—´é™åˆ¶ boolean awaitUntil(Date deadline) throws InterruptedException; // å”¤é†’å•ä¸ªé˜»å¡çº¿ç¨‹ void signal(); // å”¤é†’æ‰€æœ‰é˜»å¡çº¿ç¨‹ void signalAll();&#125; Conditionå¯ä»¥ç†è§£ä¸ºObjectä¸­çš„wait()ã€notify()å’ŒnotifyAll()çš„æ›¿ä»£å“ï¼Œå› ä¸ºObjectä¸­çš„ç›¸åº”æ–¹æ³•æ˜¯JNI(Native)æ–¹æ³•ï¼Œç”±JVMå®ç°ï¼Œå¯¹ä½¿ç”¨è€…è€Œè¨€å¹¶ä¸æ˜¯ååˆ†å‹å¥½(å¯èƒ½éœ€è¦æ„ŸçŸ¥JVMçš„æºç å®ç°)ï¼Œè€ŒConditionæ˜¯åŸºäºæ•°æ®ç»“æ„å’Œç›¸åº”ç®—æ³•å®ç°å¯¹åº”çš„åŠŸèƒ½ï¼Œæˆ‘ä»¬å¯ä»¥ä»æºç ä¸Šåˆ†æå…¶å®ç°ã€‚ Conditionçš„å®ç°ç±»æ˜¯AQSçš„å…¬æœ‰å†…éƒ¨ç±»ConditionObjectã€‚ConditionObjectæä¾›çš„å…¥é˜Ÿåˆ—æ–¹æ³•å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162public class ConditionObject implements Condition, java.io.Serializable &#123; private static final long serialVersionUID = 1173984872572414699L; /** First node of condition queue. */ - æ¡ä»¶é˜Ÿåˆ—çš„ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ private transient Node firstWaiter; /** Last node of condition queue. */ - æ¡ä»¶é˜Ÿåˆ—çš„æœ€åä¸€ä¸ªèŠ‚ç‚¹ private transient Node lastWaiter; // å…¬æœ‰æ„é€ å‡½æ•° public ConditionObject() &#123; &#125; // æ·»åŠ æ¡ä»¶ç­‰å¾…èŠ‚ç‚¹ private Node addConditionWaiter() &#123; // è¿™é‡Œåšä¸€æ¬¡åˆ¤æ–­ï¼Œå½“å‰çº¿ç¨‹å¿…é¡»æ­¥å…¥æ­¤åŒæ­¥å™¨å®ä¾‹ if (!isHeldExclusively()) throw new IllegalMonitorStateException(); // ä¸´æ—¶èŠ‚ç‚¹tèµ‹å€¼ä¸ºlastWaiterå¼•ç”¨ Node t = lastWaiter; // If lastWaiter is cancelled, clean out. // æœ€åä¸€ä¸ªèŠ‚ç‚¹ä¸ä¸ºæ¡ä»¶ç­‰å¾…çŠ¶æ€ï¼Œåˆ™æ˜¯å–æ¶ˆçŠ¶æ€ if (t != null &amp;&amp; t.waitStatus != Node.CONDITION) &#123; // è§£é™¤æ‰€æœ‰å–æ¶ˆç­‰å¾…çš„èŠ‚ç‚¹çš„è¿æ¥ unlinkCancelledWaiters(); t = lastWaiter; &#125; // åŸºäºå½“å‰çº¿ç¨‹æ–°å»ºç«‹ä¸€ä¸ªæ¡ä»¶ç­‰å¾…ç±»å‹çš„èŠ‚ç‚¹ Node node = new Node(Node.CONDITION); // é¦–æ¬¡åˆ›å»ºConditionçš„æ—¶å€™ï¼Œæœ€åä¸€ä¸ªèŠ‚ç‚¹ä¸´æ—¶å¼•ç”¨tä¸ºnullï¼Œåˆ™æŠŠç¬¬ä¸€ä¸ªèŠ‚ç‚¹ç½®ä¸ºæ–°å»ºçš„èŠ‚ç‚¹ if (t == null) firstWaiter = node; else // å·²ç»å­˜åœ¨ç¬¬ä¸€ä¸ªèŠ‚ç‚¹ï¼Œåˆ™é€šè¿‡nextWaiterè¿æ¥æ–°çš„èŠ‚ç‚¹ t.nextWaiter = node; // æœ€åä¸€ä¸ªèŠ‚ç‚¹çš„å¼•ç”¨æ›´æ–°ä¸ºæ–°èŠ‚ç‚¹çš„å¼•ç”¨ lastWaiter = node; return node; &#125; // ä»æ¡ä»¶ç­‰å¾…é˜Ÿåˆ—è§£é™¤æ‰€æœ‰å–æ¶ˆç­‰å¾…çš„èŠ‚ç‚¹çš„è¿æ¥ï¼Œå…¶å®å°±æ˜¯æ‰€æœ‰å–æ¶ˆèŠ‚ç‚¹ç§»é™¤çš„æ“ä½œï¼Œæ¶‰åŠåˆ°åŒå‘é“¾è¡¨çš„æ–­é“¾æ“ä½œã€ç¬¬ä¸€ä¸ªå’Œæœ€åä¸€ä¸ªèŠ‚ç‚¹çš„å¼•ç”¨æ›´æ–° private void unlinkCancelledWaiters() &#123; Node t = firstWaiter; Node trail = null; while (t != null) &#123; Node next = t.nextWaiter; // æ³¨æ„è¿™é‡Œç­‰å¾…çŠ¶æ€çš„åˆ¤æ–­ if (t.waitStatus != Node.CONDITION) &#123; t.nextWaiter = null; if (trail == null) firstWaiter = next; else trail.nextWaiter = next; if (next == null) lastWaiter = trail; &#125; else trail = t; t = next; &#125; &#125; // å½“å‰åŒæ­¥å™¨å®ä¾‹æŒæœ‰çš„çº¿ç¨‹æ˜¯å¦å½“å‰çº¿ç¨‹(currentThread()) protected boolean isHeldExclusively() &#123; throw new UnsupportedOperationException(); &#125; // æš‚æ—¶ä¸åˆ†æå…¶ä»–æ–¹æ³• &#125; å®é™…ä¸Šï¼ŒConditionçš„æ‰€æœ‰await()æ–¹æ³•å˜ä½“éƒ½è°ƒç”¨addConditionWaiter()æ·»åŠ é˜»å¡çº¿ç¨‹åˆ°æ¡ä»¶é˜Ÿåˆ—ä¸­ã€‚æˆ‘ä»¬æŒ‰ç…§åˆ†æåŒæ­¥ç­‰å¾…é˜Ÿåˆ—çš„æƒ…å†µï¼Œåˆ†æä¸€ä¸‹æ¡ä»¶ç­‰å¾…é˜Ÿåˆ—ã€‚æ­£å¸¸æƒ…å†µä¸‹ï¼Œå‡è®¾æœ‰2ä¸ªçº¿ç¨‹thread-1å’Œthread-2è¿›å…¥æ¡ä»¶ç­‰å¾…é˜Ÿåˆ—ï¼Œéƒ½å¤„äºé˜»å¡çŠ¶æ€ã€‚ å…ˆæ˜¯thread-1è¿›å…¥æ¡ä»¶é˜Ÿåˆ—ï¼š ç„¶åæ˜¯thread-2è¿›å…¥æ¡ä»¶é˜Ÿåˆ—ï¼š æ¡ä»¶ç­‰å¾…é˜Ÿåˆ—çœ‹èµ·æ¥ä¹Ÿå¹¶ä¸å¤æ‚ï¼Œä½†æ˜¯å®ƒå¹¶ä¸æ˜¯å•ç‹¬å­˜åœ¨å’Œä½¿ç”¨çš„ï¼Œä¸€èˆ¬ä¾èµ–äºåŒæ­¥ç­‰å¾…é˜Ÿåˆ—ï¼Œä¸‹é¢çš„ä¸€èŠ‚åˆ†æConditionçš„å®ç°çš„æ—¶å€™å†è¯¦ç»†åˆ†æã€‚ ç‹¬å æ¨¡å¼ä¸å…±äº«æ¨¡å¼ å‰æ–‡æåŠåˆ°ï¼ŒåŒæ­¥å™¨æ¶‰åŠåˆ°ç‹¬å æ¨¡å‹å’Œå…±äº«æ¨¡å¼ã€‚ä¸‹é¢å°±é’ˆå¯¹è¿™ä¸¤ç§æ¨¡å¼è¯¦ç»†åˆ†æä¸€ä¸‹AQSçš„å…·ä½“å®ç°æºç ã€‚ ç‹¬å æ¨¡å¼ AQSåŒæ­¥å™¨å¦‚æœä½¿ç”¨ç‹¬å (EXCLUSIVE)æ¨¡å¼ï¼Œé‚£ä¹ˆæ„å‘³ç€åŒä¸€ä¸ªæ—¶åˆ»ï¼Œåªæœ‰èŠ‚ç‚¹æ‰€åœ¨ä¸€ä¸ªçº¿ç¨‹è·å–(acuqire)åŸå­çŠ¶æ€statusæˆåŠŸï¼Œæ­¤æ—¶è¯¥çº¿ç¨‹å¯ä»¥ä»é˜»å¡çŠ¶æ€è§£é™¤ç»§ç»­è¿è¡Œï¼Œè€ŒåŒæ­¥ç­‰å¾…é˜Ÿåˆ—ä¸­çš„å…¶ä»–èŠ‚ç‚¹æŒæœ‰çš„çº¿ç¨‹ä¾ç„¶å¤„äºé˜»å¡çŠ¶æ€ã€‚ç‹¬å æ¨¡å¼åŒæ­¥å™¨çš„åŠŸèƒ½ä¸»è¦ç”±ä¸‹é¢çš„å››ä¸ªæ–¹æ³•æä¾›ï¼š acquire(int arg)ï¼›ç”³è¯·è·å–argä¸ªåŸå­çŠ¶æ€status(ç”³è¯·æˆåŠŸå¯ä»¥ç®€å•ç†è§£ä¸ºstatus = status - arg)ã€‚ acquireInterruptibly(int arg)ï¼šç”³è¯·è·å–argä¸ªåŸå­çŠ¶æ€statusï¼Œå“åº”çº¿ç¨‹ä¸­æ–­ã€‚ tryAcquireNanos(int arg, long nanosTimeout)ï¼šç”³è¯·è·å–argä¸ªåŸå­çŠ¶æ€statusï¼Œå¸¦è¶…æ—¶çš„ç‰ˆæœ¬ã€‚ release(int arg)ï¼šé‡Šæ”¾argä¸ªåŸå­çŠ¶æ€status(é‡Šæ”¾æˆåŠŸå¯ä»¥ç®€å•ç†è§£ä¸ºstatus = status + arg)ã€‚ ç‹¬å æ¨¡å¼ä¸‹ï¼ŒAQSåŒæ­¥å™¨å®ä¾‹åˆå§‹åŒ–æ—¶å€™ä¼ å…¥çš„statuså€¼ï¼Œå¯ä»¥ç®€å•ç†è§£ä¸º&quot;å…è®¸ç”³è¯·çš„èµ„æºæ•°é‡çš„ä¸Šé™å€¼&quot;ï¼Œä¸‹é¢çš„acquireç±»å‹çš„æ–¹æ³•æš‚æ—¶ç§°ä¸º&quot;è·å–èµ„æº&quot;ï¼Œè€Œreleaseæ–¹æ³•æš‚æ—¶ç§°ä¸º&quot;é‡Šæ”¾èµ„æº&quot;ã€‚æ¥ç€æˆ‘ä»¬åˆ†æå‰é¢æåˆ°çš„å››ä¸ªæ–¹æ³•çš„æºç ï¼Œå…ˆçœ‹acquire(int arg)ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273public final void acquire(int arg) &#123; // è·å–èµ„æºæˆåŠŸæˆ–è€…æ–°å¢ä¸€ä¸ªç‹¬å ç±»å‹èŠ‚ç‚¹åˆ°åŒæ­¥ç­‰å¾…é˜Ÿåˆ—æˆåŠŸåˆ™ç›´æ¥è¿”å›ï¼Œå¦åˆ™ä¸­æ–­å½“å‰çº¿ç¨‹ if (!tryAcquire(arg) &amp;&amp; acquireQueued(addWaiter(Node.EXCLUSIVE), arg)) selfInterrupt();&#125;// æ­¤æ–¹æ³•å¿…é¡»åˆå­ç±»è¦†ç›–ï¼Œç”¨äºå†³å®šæ˜¯å¦è·å–èµ„æºæˆåŠŸprotected boolean tryAcquire(int arg) &#123; throw new UnsupportedOperationException();&#125;// ä¸­æ–­å½“å‰çº¿ç¨‹static void selfInterrupt() &#123; Thread.currentThread().interrupt();&#125;// ä¸å¯ä¸­æ–­çš„ç‹¬å æ¨¡å¼ä¸‹ï¼ŒåŒæ­¥ç­‰å¾…é˜Ÿåˆ—ä¸­çš„çº¿ç¨‹è·å–èµ„æºçš„æ–¹æ³•final boolean acquireQueued(final Node node, int arg) &#123; boolean interrupted = false; try &#123; for (;;) &#123; // è·å–æ–°å…¥é˜ŸèŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹ final Node p = node.predecessor(); // å‰é©±èŠ‚ç‚¹ä¸ºå¤´èŠ‚ç‚¹å¹¶ä¸”å°è¯•è·å–èµ„æºæˆåŠŸï¼Œä¹Ÿå°±æ˜¯æ¯ä¸€è½®å¾ªç¯éƒ½ä¼šè°ƒç”¨tryAcquireå°è¯•è·å–èµ„æºï¼Œé™¤éé˜»å¡æˆ–è€…è·³å‡ºå¾ªç¯ if (p == head &amp;&amp; tryAcquire(arg)) &#123; // è®¾ç½®æ–°å…¥é˜ŸèŠ‚ç‚¹ä¸ºå¤´èŠ‚ç‚¹ï¼ŒåŸæ¥çš„èŠ‚ç‚¹ä¼šä»é˜Ÿåˆ—ä¸­æ–­å¼€ setHead(node); p.next = null; // help GC return interrupted; // &lt;== æ³¨æ„ï¼Œè¿™ä¸ªä½ç½®æ˜¯è·³å‡ºæ­»å¾ªç¯çš„å”¯ä¸€ä½ç½® &#125; // åˆ¤æ–­æ˜¯å¦éœ€è¦é˜»å¡å½“å‰è·å–èµ„æºå¤±è´¥çš„èŠ‚ç‚¹ä¸­æŒæœ‰çš„çº¿ç¨‹ if (shouldParkAfterFailedAcquire(p, node)) // é˜»å¡å½“å‰çº¿ç¨‹ï¼Œå¦‚æœè¢«å”¤é†’åˆ™è¿”å›å¹¶æ¸…ç©ºçº¿ç¨‹çš„ä¸­æ–­æ ‡è®° interrupted |= parkAndCheckInterrupt(); &#125; &#125; catch (Throwable t) &#123; cancelAcquire(node); if (interrupted) selfInterrupt(); throw t; &#125;&#125;/** * æ£€æŸ¥å¹¶ä¸”æ›´æ–°è·å–èµ„æºå¤±è´¥çš„èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œè¿”å›å€¼å†³å®šçº¿ç¨‹æ˜¯å¦éœ€è¦è¢«é˜»å¡ã€‚ * è¿™ä¸ªæ–¹æ³•æ˜¯æ‰€æœ‰å¾ªç¯è·å–èµ„æºæ–¹æ³•ä¸­ä¿¡å·æ§åˆ¶çš„ä¸»è¦æ–¹æ³• */private static boolean shouldParkAfterFailedAcquire(Node pred, Node node) &#123; // è¿™é‡Œè®°ä½wsæ˜¯å½“å‰å¤„ç†èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹çš„ç­‰å¾…çŠ¶æ€ int ws = pred.waitStatus; if (ws == Node.SIGNAL) // å‰é©±èŠ‚ç‚¹çŠ¶æ€è®¾ç½®æˆNode.SIGNALæˆåŠŸï¼Œç­‰å¾…è¢«releaseè°ƒç”¨é‡Šæ”¾ï¼Œåç»§èŠ‚ç‚¹å¯ä»¥å®‰å…¨åœ°è¿›å…¥é˜»å¡çŠ¶æ€ return true; if (ws &gt; 0) &#123; // wså¤§äº0åªæœ‰ä¸€ç§æƒ…å†µNode.CANCELLEDï¼Œè¯´æ˜å‰é©±èŠ‚ç‚¹å·²ç»å–æ¶ˆè·å–èµ„æºï¼Œ // è¿™ä¸ªæ—¶å€™ä¼šæŠŠæ‰€æœ‰è¿™ç±»å‹å–æ¶ˆçš„å‰é©±èŠ‚ç‚¹ç§»é™¤ï¼Œæ‰¾åˆ°ä¸€ä¸ªéå–æ¶ˆçš„èŠ‚ç‚¹é‡æ–°é€šè¿‡nextå¼•ç”¨è¿æ¥å½“å‰èŠ‚ç‚¹ do &#123; node.prev = pred = pred.prev; &#125; while (pred.waitStatus &gt; 0); pred.next = node; &#125; else &#123; // å…¶ä»–ç­‰å¾…çŠ¶æ€ç›´æ¥ä¿®æ”¹å‰é©±èŠ‚ç‚¹ç­‰å¾…çŠ¶æ€ä¸ºNode.SIGNAL pred.compareAndSetWaitStatus(ws, Node.SIGNAL); &#125; return false;&#125;// é˜»å¡å½“å‰çº¿ç¨‹ï¼Œè·å–å¹¶ä¸”é‡ç½®çº¿ç¨‹çš„ä¸­æ–­æ ‡è®°ä½private final boolean parkAndCheckInterrupt() &#123; // è¿™ä¸ªå°±æ˜¯é˜»å¡çº¿ç¨‹çš„å®ç°ï¼Œä¾èµ–Unsafeçš„API LockSupport.park(this); return Thread.interrupted();&#125; ä¸Šé¢çš„ä»£ç è™½ç„¶çœ‹èµ·æ¥èƒ½åŸºæœ¬ç†è§£ï¼Œä½†æ˜¯æœ€å¥½ç”¨å›¾æ¨æ•²ä¸€ä¸‹&quot;ç©ºé—´ä¸Šçš„å˜åŒ–&quot;ï¼š æ¥ç€åˆ†æä¸€ä¸‹release(int arg)çš„å®ç°ï¼š 12345678910111213141516171819202122232425262728293031323334353637// é‡Šæ”¾èµ„æºpublic final boolean release(int arg) &#123; // å°è¯•é‡Šæ”¾èµ„æº if (tryRelease(arg)) &#123; Node h = head; if (h != null &amp;&amp; h.waitStatus != 0) unparkSuccessor(h); return true; &#125; return false;&#125;// å°è¯•é‡Šæ”¾èµ„æºï¼Œç‹¬å æ¨¡å¼ä¸‹ï¼Œå°è¯•é€šè¿‡é‡æ–°è®¾ç½®statusçš„å€¼ä»è€Œå®ç°é‡Šæ”¾èµ„æºçš„åŠŸèƒ½// è¿™ä¸ªæ–¹æ³•å¿…é¡»ç”±å­ç±»å®ç°protected boolean tryRelease(int arg) &#123; throw new UnsupportedOperationException();&#125;// è§£é™¤ä¼ å…¥èŠ‚ç‚¹(ä¸€èˆ¬æ˜¯å¤´èŠ‚ç‚¹)çš„ç¬¬ä¸€ä¸ªåç»§èŠ‚ç‚¹çš„é˜»å¡çŠ¶æ€ï¼Œå½“å‰å¤„ç†èŠ‚ç‚¹çš„ç­‰å¾…çŠ¶æ€ä¼šè¢«CASæ›´æ–°ä¸º0private void unparkSuccessor(Node node) &#123; int ws = node.waitStatus; // å½“å‰å¤„ç†çš„èŠ‚ç‚¹(ä¸€èˆ¬æ˜¯å¤´èŠ‚ç‚¹)çŠ¶æ€å°äº0åˆ™ç›´æ¥CASæ›´æ–°ä¸º0 if (ws &lt; 0) node.compareAndSetWaitStatus(ws, 0); Node s = node.next; if (s == null || s.waitStatus &gt; 0) &#123; s = null; // å¦‚æœèŠ‚ç‚¹çš„ç¬¬ä¸€ä¸ªåç»§èŠ‚ç‚¹ä¸ºnullæˆ–è€…ç­‰å¾…çŠ¶æ€å¤§äº0(å–æ¶ˆ)ï¼Œåˆ™ä»ç­‰å¾…é˜Ÿåˆ—çš„å°¾èŠ‚ç‚¹å‘å‰éå†ï¼Œ // æ‰¾åˆ°æœ€åä¸€ä¸ªä¸ä¸ºnullï¼Œå¹¶ä¸”ç­‰å¾…çŠ¶æ€å°äºç­‰äº0çš„èŠ‚ç‚¹ for (Node p = tail; p != node &amp;&amp; p != null; p = p.prev) if (p.waitStatus &lt;= 0) s = p; &#125; // è§£é™¤ä¸Šé¢çš„æœç´¢åˆ°çš„èŠ‚ç‚¹çš„é˜»å¡çŠ¶æ€ if (s != null) LockSupport.unpark(s.thread);&#125; æ¥ç€ç”¨ä¸Šé¢çš„å›¾ï¼š ä¸Šé¢å›¾ä¸­thread-2æ™‹å‡ä¸ºå¤´èŠ‚ç‚¹çš„ç¬¬ä¸€ä¸ªåç»§èŠ‚ç‚¹ï¼Œç­‰å¾…ä¸‹ä¸€ä¸ªrelease()é‡Šæ”¾èµ„æºå”¤é†’ä¹‹å°±èƒ½æ™‹å‡ä¸ºå¤´èŠ‚ç‚¹ï¼Œä¸€æ—¦æ™‹å‡ä¸ºå¤´èŠ‚ç‚¹ä¹Ÿå°±æ˜¯æ„å‘³ç€å¯ä»¥è§£é™¤é˜»å¡ç»§ç»­è¿è¡Œã€‚æ¥ç€æˆ‘ä»¬å¯ä»¥çœ‹acquire()çš„å“åº”ä¸­æ–­ç‰ˆæœ¬å’Œå¸¦è¶…æ—¶çš„ç‰ˆæœ¬ã€‚å…ˆçœ‹acquireInterruptibly(int arg)ï¼š 1234567891011121314151617181920212223242526272829303132public final void acquireInterruptibly(int arg) throws InterruptedException &#123; // è·å–å¹¶ä¸”æ¸…ç©ºçº¿ç¨‹ä¸­æ–­æ ‡è®°ä½ï¼Œå¦‚æœæ˜¯ä¸­æ–­çŠ¶æ€åˆ™ç›´æ¥æŠ›InterruptedExceptionå¼‚å¸¸ if (Thread.interrupted()) throw new InterruptedException(); // å¦‚æœè·å–èµ„æºå¤±è´¥ if (!tryAcquire(arg)) doAcquireInterruptibly(arg);&#125;// ç‹¬å æ¨¡å¼ä¸‹å“åº”ä¸­æ–­çš„è·å–èµ„æºæ–¹æ³•private void doAcquireInterruptibly(int arg) throws InterruptedException &#123; // åŸºäºå½“å‰çº¿ç¨‹æ–°å¢ä¸€ä¸ªç‹¬å çš„NodeèŠ‚ç‚¹è¿›å…¥åŒæ­¥ç­‰å¾…é˜Ÿåˆ—ä¸­ final Node node = addWaiter(Node.EXCLUSIVE); try &#123; for (;;) &#123; final Node p = node.predecessor(); if (p == head &amp;&amp; tryAcquire(arg)) &#123; setHead(node); p.next = null; // help GC return; &#125; // è·å–èµ„æºå¤±è´¥è¿›å…¥é˜»å¡çŠ¶æ€ if (shouldParkAfterFailedAcquire(p, node) &amp;&amp; parkAndCheckInterrupt()) // è§£é™¤é˜»å¡åç›´æ¥æŠ›å‡ºInterruptedExceptionå¼‚å¸¸ throw new InterruptedException(); &#125; &#125; catch (Throwable t) &#123; cancelAcquire(node); throw t; &#125;&#125; doAcquireInterruptibly(int arg)æ–¹æ³•å’Œacquire(int arg)ç±»ä¼¼ï¼Œæœ€å¤§çš„ä¸åŒç‚¹åœ¨äºé˜»å¡çº¿ç¨‹è§£é™¤é˜»å¡åå¹¶ä¸æ˜¯æ­£å¸¸ç»§ç»­è¿è¡Œï¼Œè€Œæ˜¯ç›´æ¥æŠ›å‡ºInterruptedExceptionå¼‚å¸¸ã€‚æœ€åçœ‹tryAcquireNanos(int arg, long nanosTimeout)çš„å®ç°ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041// ç‹¬å æ¨¡å¼ä¸‹å°è¯•åœ¨æŒ‡å®šè¶…æ—¶æ—¶é—´å†…è·å–èµ„æºï¼Œå“åº”çº¿ç¨‹ä¸­æ–­public final boolean tryAcquireNanos(int arg, long nanosTimeout) throws InterruptedException &#123; if (Thread.interrupted()) throw new InterruptedException(); return tryAcquire(arg) || doAcquireNanos(arg, nanosTimeout);&#125;// ç‹¬å æ¨¡å¼ä¸‹å¸¦è¶…æ—¶æ—¶é—´é™åˆ¶çš„è·å–èµ„æºæ–¹æ³•private boolean doAcquireNanos(int arg, long nanosTimeout) throws InterruptedException &#123; // è¶…æ—¶æœŸé™å°äº0çº³ç§’ï¼Œå¿«é€Ÿå¤±è´¥ if (nanosTimeout &lt;= 0L) return false; // è¶…æ—¶çš„æœ€ç»ˆæœŸé™æ˜¯å½“å‰ç³»ç»Ÿæ—¶é’Ÿçº³ç§’+å¤–éƒ¨æŒ‡å®šçš„nanosTimeoutå¢é‡ final long deadline = System.nanoTime() + nanosTimeout; final Node node = addWaiter(Node.EXCLUSIVE); try &#123; for (;;) &#123; final Node p = node.predecessor(); if (p == head &amp;&amp; tryAcquire(arg)) &#123; setHead(node); p.next = null; // help GC return true; &#125; // è®¡ç®—å‡ºå‰©ä½™çš„è¶…æ—¶æ—¶é—´ nanosTimeout = deadline - System.nanoTime(); // å‰©ä½™è¶…æ—¶æ—¶é—´å°äº0è¯´æ˜å·²ç»è¶…æ—¶åˆ™å–æ¶ˆè·å– if (nanosTimeout &lt;= 0L) &#123; cancelAcquire(node); return false; &#125; // è¿™é‡Œä¼šåˆ¤æ–­å‰©ä½™è¶…æ—¶æ—¶é—´å¤§äº1000çº³ç§’çš„æ—¶å€™æ‰ä¼šè¿›è¡Œå¸¦è¶…æ—¶æœŸé™çš„çº¿ç¨‹é˜»å¡ï¼Œå¦åˆ™ä¼šè¿›å…¥ä¸‹ä¸€è½®è·å–å°è¯• if (shouldParkAfterFailedAcquire(p, node) &amp;&amp; nanosTimeout &gt; SPIN_FOR_TIMEOUT_THRESHOLD) LockSupport.parkNanos(this, nanosTimeout); if (Thread.interrupted()) throw new InterruptedException(); &#125; &#125; catch (Throwable t) &#123; cancelAcquire(node); throw t; &#125;&#125; tryAcquireNanos(int arg, long nanosTimeout)å…¶å®å’ŒdoAcquireInterruptibly(int arg)ç±»ä¼¼ï¼Œå®ƒä»¬éƒ½å“åº”çº¿ç¨‹ä¸­æ–­ï¼Œä¸è¿‡tryAcquireNanos()åœ¨è·å–èµ„æºçš„æ¯ä¸€è½®å¾ªç¯å°è¯•éƒ½ä¼šè®¡ç®—å‰©ä½™å¯ç”¨çš„è¶…æ—¶æ—¶é—´ï¼Œåªæœ‰åŒæ—¶æ»¡è¶³è·å–å¤±è´¥éœ€è¦é˜»å¡å¹¶ä¸”å‰©ä½™è¶…æ—¶æ—¶é—´å¤§äºSPIN_FOR_TIMEOUT_THRESHOLD(1000çº³ç§’)çš„æƒ…å†µä¸‹æ‰ä¼šè¿›è¡Œé˜»å¡ã€‚ ç‹¬å æ¨¡å¼çš„åŒæ­¥å™¨çš„ä¸€ä¸ªæ˜¾è‘—ç‰¹ç‚¹å°±æ˜¯ï¼šå¤´èŠ‚ç‚¹çš„ç¬¬ä¸€ä¸ªæœ‰æ•ˆ(éå–æ¶ˆ)çš„åç»§èŠ‚ç‚¹ï¼Œæ€»æ˜¯å°è¯•è·å–èµ„æºï¼Œä¸€æ—¦è·å–èµ„æºæˆåŠŸå°±ä¼šè§£é™¤é˜»å¡å¹¶ä¸”æ™‹å‡ä¸ºå¤´èŠ‚ç‚¹ï¼ŒåŸæ¥æ‰€åœ¨èŠ‚ç‚¹ä¼šç§»é™¤å‡ºåŒæ­¥ç­‰å¾…é˜Ÿåˆ—ï¼ŒåŸæ¥çš„é˜Ÿåˆ—é•¿åº¦å°±ä¼šå‡å°‘1ï¼Œç„¶åå¤´ç»“ç‚¹çš„ç¬¬ä¸€ä¸ªæœ‰æ•ˆçš„åç»§èŠ‚ç‚¹ç»§ç»­å¼€å§‹ç«äº‰èµ„æºã€‚ ä½¿ç”¨ç‹¬å æ¨¡å¼åŒæ­¥å™¨çš„ä¸»è¦ç±»åº“æœ‰ï¼š å¯é‡å…¥é”ReentrantLockã€‚ è¯»å†™é”ReentrantReadWriteLockä¸­çš„å†™é”WriteLockã€‚ å…±äº«æ¨¡å¼ å…±äº«(SHARED)æ¨¡å¼ä¸­çš„&quot;å…±äº«&quot;çš„å«ä¹‰æ˜¯ï¼šåŒä¸€ä¸ªæ—¶åˆ»ï¼Œå¦‚æœæœ‰ä¸€ä¸ªèŠ‚ç‚¹æ‰€åœ¨çº¿ç¨‹è·å–(acuqire)åŸå­çŠ¶æ€statusæˆåŠŸï¼Œé‚£ä¹ˆå®ƒä¼šè§£é™¤é˜»å¡è¢«å”¤é†’ï¼Œå¹¶ä¸”ä¼šæŠŠå”¤é†’çŠ¶æ€ä¼ æ’­åˆ°æ‰€æœ‰çš„åç»§èŠ‚ç‚¹(æ¢è¨€ä¹‹å°±æ˜¯å”¤é†’æ•´ä¸ªåŒæ­¥ç­‰å¾…é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹)ã€‚å…±äº«æ¨¡å¼åŒæ­¥å™¨çš„åŠŸèƒ½ä¸»è¦ç”±ä¸‹é¢çš„å››ä¸ªæ–¹æ³•æä¾›ï¼š acquireShared(int arg)ï¼›ç”³è¯·è·å–argä¸ªåŸå­çŠ¶æ€status(ç”³è¯·æˆåŠŸå¯ä»¥ç®€å•ç†è§£ä¸ºstatus = status - arg)ã€‚ acquireSharedInterruptibly(int arg)ï¼šç”³è¯·è·å–argä¸ªåŸå­çŠ¶æ€statusï¼Œå“åº”çº¿ç¨‹ä¸­æ–­ã€‚ tryAcquireSharedNanos(int arg, long nanosTimeout)ï¼šç”³è¯·è·å–argä¸ªåŸå­çŠ¶æ€statusï¼Œå¸¦è¶…æ—¶çš„ç‰ˆæœ¬ã€‚ releaseShared(int arg)ï¼šé‡Šæ”¾argä¸ªåŸå­çŠ¶æ€status(é‡Šæ”¾æˆåŠŸå¯ä»¥ç®€å•ç†è§£ä¸ºstatus = status + arg)ã€‚ å…ˆçœ‹acquireShared(int arg)çš„æºç ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384// å…±äº«æ¨¡å¼ä¸‹è·å–èµ„æºpublic final void acquireShared(int arg) &#123; // æ³¨æ„tryAcquireSharedæ–¹æ³•å€¼ä¸ºæ•´å‹ï¼Œåªæœ‰å°äº0çš„æ—¶å€™æ‰ä¼šåŠ å…¥åŒæ­¥ç­‰å¾…é˜Ÿåˆ— if (tryAcquireShared(arg) &lt; 0) doAcquireShared(arg);&#125;// å…±äº«æ¨¡å¼ä¸‹å°è¯•è·å–èµ„æºï¼Œæ­¤æ–¹æ³•éœ€è¦ç”±å­ç±»è¦†ç›–protected int tryAcquireShared(int arg) &#123; throw new UnsupportedOperationException();&#125;// å…±äº«æ¨¡å¼ä¸‹è·å–èµ„æºå’Œå¤„ç†åŒæ­¥ç­‰å¾…é˜Ÿåˆ—çš„æ–¹æ³•private void doAcquireShared(int arg) &#123; // åŸºäºå½“å‰çº¿ç¨‹æ–°å»ºä¸€ä¸ªæ ‡è®°ä¸ºå…±äº«çš„æ–°èŠ‚ç‚¹ final Node node = addWaiter(Node.SHARED); boolean interrupted = false; try &#123; for (;;) &#123; final Node p = node.predecessor(); // å¦‚æœå½“å‰èŠ‚ç‚¹çš„å‰é©±èŠ‚ç‚¹æ˜¯å¤´èŠ‚ç‚¹ if (p == head) &#123; // æ¯ä¸€è½®å¾ªç¯éƒ½ä¼šè°ƒç”¨tryAcquireSharedå°è¯•è·å–èµ„æºï¼Œé™¤éé˜»å¡æˆ–è€…è·³å‡ºå¾ªç¯ int r = tryAcquireShared(arg); if (r &gt;= 0) &#123; // &lt;= tryAcquireSharedæ–¹æ³•&gt;=0è¯´æ˜ç›´èµ„æºè·å–æˆåŠŸ // è®¾ç½®å¤´ç»“ç‚¹ï¼Œå¹¶ä¸”ä¼ æ’­è·å–èµ„æºæˆåŠŸçš„çŠ¶æ€ï¼Œè¿™ä¸ªæ–¹æ³•çš„ä½œç”¨æ˜¯ç¡®ä¿å”¤é†’çŠ¶æ€ä¼ æ’­åˆ°æ‰€æœ‰çš„åç»§èŠ‚ç‚¹ // ç„¶åä»»æ„ä¸€ä¸ªèŠ‚ç‚¹æ™‹å‡ä¸ºå¤´èŠ‚ç‚¹éƒ½ä¼šå”¤é†’å…¶ç¬¬ä¸€ä¸ªæœ‰æ•ˆçš„åç»§èŠ‚ç‚¹ï¼Œèµ·åˆ°ä¸€ä¸ªé“¾å¼é‡Šæ”¾å’Œè§£é™¤é˜»å¡çš„åŠ¨ä½œ setHeadAndPropagate(node, r); p.next = null; // help GC return; &#125; &#125; // åˆ¤æ–­è·å–èµ„æºå¤±è´¥æ˜¯å¦éœ€è¦é˜»å¡ï¼Œè¿™é‡Œä¼šæŠŠå‰é©±èŠ‚ç‚¹çš„ç­‰å¾…çŠ¶æ€CASæ›´æ–°ä¸ºNode.SIGNAL if (shouldParkAfterFailedAcquire(p, node)) interrupted |= parkAndCheckInterrupt(); &#125; &#125; catch (Throwable t) &#123; cancelAcquire(node); throw t; &#125; finally &#123; if (interrupted) selfInterrupt(); &#125;&#125;// è®¾ç½®åŒæ­¥ç­‰å¾…é˜Ÿåˆ—çš„å¤´èŠ‚ç‚¹ï¼Œåˆ¤æ–­å½“å‰å¤„ç†çš„èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹æ˜¯å¦å…±äº«æ¨¡å¼çš„èŠ‚ç‚¹ï¼Œå¦‚æœå…±äº«æ¨¡å¼çš„èŠ‚ç‚¹ï¼Œ// propagateå¤§äº0æˆ–è€…èŠ‚ç‚¹çš„waitStatusä¸ºPROPAGATEåˆ™è¿›è¡Œå…±äº«æ¨¡å¼ä¸‹çš„é‡Šæ”¾èµ„æºprivate void setHeadAndPropagate(Node node, int propagate) &#123; // hä¸ºå¤´èŠ‚ç‚¹çš„ä¸­é—´å˜é‡ Node h = head; // è®¾ç½®å½“å‰å¤„ç†èŠ‚ç‚¹ä¸ºå¤´èŠ‚ç‚¹ setHead(node); // è¿™ä¸ªåˆ¤æ–­æ¡ä»¶æ¯”è¾ƒå¤æ‚ï¼šå…¥å‚propagateå¤§äº0 || å¤´èŠ‚ç‚¹ä¸ºnull || å¤´èŠ‚ç‚¹çš„çŠ¶æ€ä¸ºéå–æ¶ˆ || å†æ¬¡è·å–å¤´èŠ‚ç‚¹ä¸ºnull || å†æ¬¡è·å–å¤´èŠ‚ç‚¹ä¸ä¸ºå–æ¶ˆ if (propagate &gt; 0 || h == null || h.waitStatus &lt; 0 || (h = head) == null || h.waitStatus &lt; 0) &#123; Node s = node.next; // å½“å‰èŠ‚ç‚¹(å…¶å®å·²ç»æˆä¸ºå¤´èŠ‚ç‚¹)çš„ç¬¬ä¸€ä¸ªåç»§èŠ‚ç‚¹ä¸ºnullæˆ–è€…æ˜¯å…±äº«æ¨¡å¼çš„èŠ‚ç‚¹ if (s == null || s.isShared()) doReleaseShared(); &#125;&#125;// Release action for shared modeï¼šå…±äº«æ¨¡å¼ä¸‹çš„é‡Šæ”¾èµ„æºåŠ¨ä½œprivate void doReleaseShared() &#123; for (;;) &#123; Node h = head; // å¤´èŠ‚ç‚¹ä¸ä¸ºnullå¹¶ä¸”ä¸ä¸ºå°¾èŠ‚ç‚¹ if (h != null &amp;&amp; h != tail) &#123; int ws = h.waitStatus; // å¦‚æœå¤´èŠ‚ç‚¹ç­‰å¾…çŠ¶æ€ä¸ºSIGNAL(-1)åˆ™CASæ›´æ–°å®ƒä¸º0ï¼Œæ›´æ–°æˆåŠŸåå”¤é†’å’Œè§£é™¤å…¶åç»§èŠ‚ç‚¹çš„é˜»å¡ if (ws == Node.SIGNAL) &#123; if (!h.compareAndSetWaitStatus(Node.SIGNAL, 0)) continue; // å”¤é†’å¤´èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ unparkSuccessor(h); &#125; // å¦‚æœå¤´èŠ‚ç‚¹çš„ç­‰å¾…çŠ¶æ€ä¸º0ï¼Œåˆ™CASæ›´æ–°å®ƒä¸ºPROPAGATE(-3) else if (ws == 0 &amp;&amp; !h.compareAndSetWaitStatus(0, Node.PROPAGATE)) continue; &#125; // å¤´èŠ‚ç‚¹æ²¡æœ‰å˜æ›´ï¼Œåˆ™è·³å‡ºå¾ªç¯ if (h == head) break; &#125;&#125; å…¶å®ä»£ç çš„å®ç°å’Œç‹¬å æ¨¡å¼æœ‰å¾ˆå¤šç±»ä¼¼çš„åœ°æ–¹ï¼Œä¸€ä¸ªå¾ˆå¤§çš„ä¸åŒç‚¹æ˜¯ï¼šå…±äº«æ¨¡å¼åŒæ­¥å™¨å½“èŠ‚ç‚¹è·å–èµ„æºæˆåŠŸæ™‹å‡ä¸ºå¤´èŠ‚ç‚¹ä¹‹åï¼Œå®ƒä¼šæŠŠè‡ªèº«çš„ç­‰å¾…çŠ¶æ€é€šè¿‡CASæ›´æ–°ä¸ºNode.PROPAGATEï¼Œä¸‹ä¸€ä¸ªåŠ å…¥ç­‰å¾…é˜Ÿåˆ—çš„æ–°èŠ‚ç‚¹ä¼šæŠŠå¤´èŠ‚ç‚¹çš„ç­‰å¾…çŠ¶æ€å€¼æ›´æ–°å›Node.SIGNALï¼Œæ ‡è®°åç»§èŠ‚ç‚¹å¤„äºå¯ä»¥è¢«å”¤é†’çš„çŠ¶æ€ï¼Œå¦‚æœé‡ä¸Šèµ„æºé‡Šæ”¾ï¼Œé‚£ä¹ˆè¿™ä¸ªé˜»å¡çš„èŠ‚ç‚¹å°±èƒ½è¢«å”¤é†’è§£é™¤é˜»å¡ã€‚æˆ‘ä»¬è¿˜æ˜¯ç”»å›¾ç†è§£ä¸€ä¸‹ï¼Œå…ˆå‡è®¾tryAcquireShared(int arg)æ€»æ˜¯è¿”å›å°äº0çš„å€¼ï¼Œå…¥é˜Ÿä¸¤ä¸ªé˜»å¡çš„çº¿ç¨‹thread-1å’Œthread-2ï¼Œç„¶åè¿›è¡Œèµ„æºé‡Šæ”¾ç¡®ä¿tryAcquireShared(int arg)æ€»æ˜¯è¿”å›å¤§äº0çš„å€¼ï¼š çœ‹èµ·æ¥å’Œç‹¬å æ¨¡å¼ä¸‹çš„åŒæ­¥ç­‰å¾…é˜Ÿåˆ—å·®ä¸å¤šï¼Œå®é™…ä¸ŠçœŸæ­£ä¸åŒçš„åœ°æ–¹åœ¨äºæœ‰èŠ‚ç‚¹è§£é™¤é˜»å¡å’Œæ™‹å‡ä¸ºå¤´èŠ‚ç‚¹çš„è¿‡ç¨‹ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥å…ˆçœ‹releaseShared(int arg)çš„æºç ï¼š 1234567891011121314// å…±äº«æ¨¡å¼ä¸‹é‡Šæ”¾èµ„æºpublic final boolean releaseShared(int arg) &#123; // å°è¯•é‡Šæ”¾èµ„æºæˆåŠŸåˆ™è°ƒç”¨å‰é¢åˆ†æè¿‡çš„doReleaseSharedä»¥ä¼ æ’­å”¤é†’çŠ¶æ€å’Œunparkå¤´èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ if (tryReleaseShared(arg)) &#123; doReleaseShared(); return true; &#125; return false;&#125;// å…±äº«æ¨¡å¼ä¸‹å°è¯•é‡Šæ”¾èµ„æºï¼Œå¿…é¡»ç”±å­ç±»è¦†ç›–protected boolean tryReleaseShared(int arg) &#123; throw new UnsupportedOperationException();&#125; releaseShared(int arg)å°±æ˜¯åœ¨tryReleaseShared(int arg)è°ƒç”¨è¿”å›trueçš„æƒ…å†µä¸‹ä¸»åŠ¨è°ƒç”¨ä¸€æ¬¡doReleaseShared()ä»è€ŒåŸºäºå¤´èŠ‚ç‚¹ä¼ æ’­å”¤é†’çŠ¶æ€å’Œunparkå¤´èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ã€‚æ¥ç€ä¹‹å‰çš„å›¾ï¼š æ¥ç€çœ‹acquireSharedInterruptibly(int arg)çš„æºç å®ç°ï¼š 123456789101112131415161718192021222324252627282930// å…±äº«æ¨¡å¼ä¸‹è·å–èµ„æºçš„æ–¹æ³•ï¼Œå“åº”çº¿ç¨‹ä¸­æ–­public final void acquireSharedInterruptibly(int arg) throws InterruptedException &#123; if (Thread.interrupted()) throw new InterruptedException(); if (tryAcquireShared(arg) &lt; 0) doAcquireSharedInterruptibly(arg);&#125;private void doAcquireSharedInterruptibly(int arg) throws InterruptedException &#123; final Node node = addWaiter(Node.SHARED); try &#123; for (;;) &#123; final Node p = node.predecessor(); if (p == head) &#123; int r = tryAcquireShared(arg); if (r &gt;= 0) &#123; setHeadAndPropagate(node, r); p.next = null; // help GC return; &#125; &#125; // å’Œéå“åº”çº¿ç¨‹ä¸­æ–­çš„acquireSharedæ–¹æ³•ç±»ä¼¼ï¼Œä¸è¿‡è¿™é‡Œè§£é™¤é˜»å¡ä¹‹åç›´æ¥æŠ›å‡ºå¼‚å¸¸InterruptedException if (shouldParkAfterFailedAcquire(p, node) &amp;&amp; parkAndCheckInterrupt()) throw new InterruptedException(); &#125; &#125; catch (Throwable t) &#123; cancelAcquire(node); throw t; &#125;&#125; æœ€åçœ‹tryAcquireSharedNanos(int arg, long nanosTimeout)çš„æºç å®ç°ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344// å…±äº«æ¨¡å¼ä¸‹è·å–èµ„æºçš„æ–¹æ³•ï¼Œå¸¦è¶…æ—¶æ—¶é—´ç‰ˆæœ¬public final boolean tryAcquireSharedNanos(int arg, long nanosTimeout) throws InterruptedException &#123; if (Thread.interrupted()) throw new InterruptedException(); // æ³¨æ„è¿™é‡Œåªè¦tryAcquireShared &gt;= 0æˆ–è€…doAcquireSharedNanosè¿”å›trueéƒ½è®¤ä¸ºè·å–èµ„æºæˆåŠŸ return tryAcquireShared(arg) &gt;= 0 || doAcquireSharedNanos(arg, nanosTimeout);&#125;private boolean doAcquireSharedNanos(int arg, long nanosTimeout) throws InterruptedException &#123; if (nanosTimeout &lt;= 0L) return false; // è®¡ç®—è¶…æ—¶çš„æœ€ç»ˆæœŸé™ final long deadline = System.nanoTime() + nanosTimeout; final Node node = addWaiter(Node.SHARED); try &#123; for (;;) &#123; final Node p = node.predecessor(); if (p == head) &#123; int r = tryAcquireShared(arg); if (r &gt;= 0) &#123; setHeadAndPropagate(node, r); p.next = null; // help GC return true; &#125; &#125; //é‡æ–°è®¡ç®—å‰©ä½™çš„è¶…æ—¶æ—¶é—´ nanosTimeout = deadline - System.nanoTime(); // è¶…æ—¶çš„æƒ…å†µä¸‹ç›´æ¥å–æ¶ˆè·å– if (nanosTimeout &lt;= 0L) &#123; cancelAcquire(node); return false; &#125; // æ»¡è¶³é˜»å¡çŠ¶æ€å¹¶ä¸”å‰©ä½™çš„è¶…æ—¶æ—¶é—´å¤§äºé˜€å€¼1000çº³ç§’åˆ™é€šè¿‡LockSupport.parkNanos()é˜»å¡çº¿ç¨‹ if (shouldParkAfterFailedAcquire(p, node) &amp;&amp; nanosTimeout &gt; SPIN_FOR_TIMEOUT_THRESHOLD) LockSupport.parkNanos(this, nanosTimeout); // è§£é™¤é˜»å¡ååˆ¤æ–­çº¿ç¨‹çš„ä¸­æ–­æ ‡è®°å¹¶ä¸”æ¸…ç©ºæ ‡è®°ä½ï¼Œå¦‚æœæ˜¯å¤„äºä¸­æ–­çŠ¶æ€åˆ™æŠ›å‡ºInterruptedException if (Thread.interrupted()) throw new InterruptedException(); &#125; &#125; catch (Throwable t) &#123; cancelAcquire(node); throw t; &#125;&#125; å…±äº«æ¨¡å¼çš„åŒæ­¥å™¨çš„ä¸€ä¸ªæ˜¾è‘—ç‰¹ç‚¹å°±æ˜¯ï¼šå¤´èŠ‚ç‚¹çš„ç¬¬ä¸€ä¸ªæœ‰æ•ˆ(éå–æ¶ˆ)çš„åç»§èŠ‚ç‚¹ï¼Œæ€»æ˜¯å°è¯•è·å–èµ„æºï¼Œä¸€æ—¦è·å–èµ„æºæˆåŠŸå°±ä¼šè§£é™¤é˜»å¡å¹¶ä¸”æ™‹å‡ä¸ºå¤´èŠ‚ç‚¹ï¼ŒåŸæ¥æ‰€åœ¨èŠ‚ç‚¹ä¼šç§»é™¤å‡ºåŒæ­¥ç­‰å¾…é˜Ÿåˆ—ï¼ŒåŸæ¥çš„é˜Ÿåˆ—é•¿åº¦å°±ä¼šå‡å°‘1ï¼Œé‡æ–°è®¾ç½®å¤´èŠ‚ç‚¹çš„è¿‡ç¨‹ä¼šä¼ æ’­å”¤é†’çš„çŠ¶æ€ï¼Œç®€å•æ¥è¯´å°±æ˜¯å”¤é†’ä¸€ä¸ªæœ‰æ•ˆçš„åç»§èŠ‚ç‚¹ï¼Œåªè¦ä¸€ä¸ªèŠ‚ç‚¹å¯ä»¥æ™‹å‡ä¸ºå¤´èŠ‚ç‚¹ï¼Œå®ƒçš„åç»§èŠ‚ç‚¹å°±èƒ½è¢«å”¤é†’ã€‚èŠ‚ç‚¹çš„å”¤é†’é¡ºåºéµå¾ªç±»ä¼¼äºFIFOçš„åŸåˆ™ï¼Œé€šä¿—è¯´å°±æ˜¯å…ˆé˜»å¡æˆ–è€…é˜»å¡æ—¶é—´æœ€é•¿åˆ™å…ˆè¢«å”¤é†’ã€‚ ä½¿ç”¨å…±äº«æ¨¡å¼åŒæ­¥å™¨çš„ä¸»è¦ç±»åº“æœ‰ï¼š ä¿¡å·é‡Semaphoreã€‚ å€’æ•°æ …æ CountDownLatchã€‚ Conditionçš„å®ç° Conditionå®ä¾‹çš„å»ºç«‹æ˜¯åœ¨Lockæ¥å£çš„newCondition()æ–¹æ³•ï¼Œå®ƒæ˜¯é”æ¡ä»¶ç­‰å¾…çš„å®ç°ï¼ŒåŸºäºä½œç”¨æˆ–è€…è¯­ä¹‰å¯ä»¥è§Conditionæ¥å£çš„ç›¸å…³APIæ³¨é‡Šï¼š Conditionæ˜¯å¯¹è±¡ç›‘è§†å™¨é”æ–¹æ³•Object#wait()ã€Object#notify()å’ŒObject#notifyAll()çš„æ›¿ä»£å®ç°ï¼Œå¯¹è±¡ç›‘è§†å™¨é”å®ç°é”çš„æ—¶å€™ä½œç”¨çš„æ•ˆæœæ˜¯æ¯ä¸ªé”å¯¹è±¡å¿…é¡»ä½¿ç”¨å¤šä¸ªwait-set(JVMå†…ç½®çš„ç­‰å¾…é˜Ÿåˆ—)ï¼Œé€šè¿‡Objectæä¾›çš„æ–¹æ³•å’Œç›‘è§†å™¨é”ç»“åˆä½¿ç”¨å°±èƒ½è¾¾åˆ°Lockçš„å®ç°æ•ˆæœã€‚å¦‚æœæ›¿æ¢synchronizedæ–¹æ³•å’Œè¯­å¥å¹¶ä¸”ç»“åˆä½¿ç”¨Lockå’ŒConditionï¼Œå°±èƒ½æ›¿æ¢å¹¶ä¸”è¾¾åˆ°å¯¹è±¡ç›‘è§†å™¨é”çš„æ•ˆæœã€‚ Conditionå¿…é¡»å›ºæœ‰åœ°ç»‘å®šåœ¨ä¸€ä¸ªLockçš„å®ç°ç±»ä¸Šï¼Œä¹Ÿå°±æ˜¯è¦é€šè¿‡Lockçš„å®ä¾‹å»ºç«‹Conditionå®ä¾‹ï¼Œè€Œä¸”Conditionçš„æ–¹æ³•è°ƒç”¨ä½¿ç”¨å¿…é¡»åœ¨Lockçš„&quot;é”å®šä»£ç å—&quot;ä¸­ï¼Œè¿™ä¸€ç‚¹å’Œsynchronizedå…³é”®å­—ä»¥åŠObjectçš„ç›¸å…³JNIæ–¹æ³•ä½¿ç”¨çš„æƒ…å†µååˆ†ç›¸ä¼¼ã€‚ å‰æ–‡ä»‹ç»è¿‡Conditionæ¥å£æä¾›çš„æ–¹æ³•ä»¥åŠConditioné˜Ÿåˆ—ï¼Œä¹Ÿå°±æ˜¯æ¡ä»¶ç­‰å¾…é˜Ÿåˆ—ï¼Œé€šè¿‡PPTç”»å›¾ç®€å•ä»‹ç»äº†å®ƒçš„é˜Ÿåˆ—èŠ‚ç‚¹ç»„æˆã€‚å®é™…ä¸Šï¼Œæ¡ä»¶ç­‰å¾…é˜Ÿåˆ—éœ€è¦ç»“åˆåŒæ­¥ç­‰å¾…é˜Ÿåˆ—ä½¿ç”¨ï¼Œè¿™ä¹Ÿåˆšå¥½å¯¹åº”äºå‰é¢æåˆ°çš„Conditionçš„æ–¹æ³•è°ƒç”¨ä½¿ç”¨å¿…é¡»åœ¨Lockçš„é”å®šä»£ç å—ä¸­ã€‚å¬èµ·æ¥å¾ˆæ‡µé€¼ï¼Œæˆ‘ä»¬æ…¢æ…¢åˆ†æä¸€ä¸‹ConditionObjectçš„æ–¹æ³•æºç å°±èƒ½çŸ¥é“å…·ä½“çš„åŸå› ã€‚ å…ˆçœ‹ConditionObject#await()æ–¹æ³•ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107// é€€å‡ºç­‰å¾…åä¸»åŠ¨è¿›è¡Œä¸­æ–­å½“å‰çº¿ç¨‹private static final int REINTERRUPT = 1;// é€€å‡ºç­‰å¾…åæŠ›å‡ºInterruptedExceptionå¼‚å¸¸private static final int THROW_IE = -1;/** * å¯ä¸­æ–­çš„æ¡ä»¶ç­‰å¾…å®ç° * 1ã€å½“å‰çº¿ç¨‹å¤„äºä¸­æ–­çŠ¶æ€åˆ™æŠ›å‡ºInterruptedException * 2ã€ä¿å­˜getStateè¿”å›çš„é”çŠ¶æ€ï¼Œå¹¶ä¸”ä½¿ç”¨æ­¤é”çŠ¶æ€è°ƒç”¨releaseé‡Šæ”¾æ‰€æœ‰çš„é˜»å¡çº¿ç¨‹ * 3ã€çº¿ç¨‹åŠ å…¥ç­‰å¾…é˜Ÿåˆ—è¿›è¡Œé˜»å¡ï¼Œç›´åˆ°signallæˆ–è€…ä¸­æ–­ * 4ã€é€šè¿‡ä¿å­˜getStateè¿”å›çš„é”çŠ¶æ€è°ƒç”¨acquireæ–¹æ³• * 5ã€ç¬¬4æ­¥ä¸­é˜»å¡è¿‡ç¨‹ä¸­ä¸­æ–­åˆ™æŠ›å‡ºInterruptedException */public final void await() throws InterruptedException &#123; // å¦‚æœçº¿ç¨‹æ˜¯ä¸­æ–­çŠ¶æ€åˆ™æ¸…ç©ºä¸­æ–­æ ‡è®°ä½å¹¶ä¸”æŠ›å‡ºInterruptedException if (Thread.interrupted()) throw new InterruptedException(); // å½“å‰çº¿ç¨‹æ‰€åœ¨çš„æ–°èŠ‚ç‚¹åŠ å…¥æ¡ä»¶ç­‰å¾…é˜Ÿåˆ— Node node = addConditionWaiter(); // é‡Šæ”¾å½“å‰AQSä¸­çš„æ‰€æœ‰èµ„æºè¿”å›èµ„æºçš„statusä¿å­˜å€¼ï¼Œä¹Ÿå°±æ˜¯åŸºäºstatusçš„å€¼è°ƒç”¨release(status) - å…¶å®è¿™ä¸€æ­¥æ˜¯è§£é”æ“ä½œ int savedState = fullyRelease(node); // åˆå§‹åŒ–ä¸­æ–­æ¨¡å¼ int interruptMode = 0; // å¦‚æœèŠ‚ç‚¹æ–°å»ºçš„èŠ‚ç‚¹ä¸ä½äºåŒæ­¥é˜Ÿåˆ—ä¸­(ç†è®ºä¸Šåº”è¯¥æ˜¯ä¸€å®šä¸å­˜åœ¨)ï¼Œåˆ™å¯¹èŠ‚ç‚¹æ‰€åœ¨çº¿ç¨‹è¿›è¡Œé˜»å¡ï¼Œç¬¬äºŒè½®å¾ªç¯ç†è®ºä¸ŠèŠ‚ç‚¹ä¸€å®šåœ¨åŒæ­¥ç­‰å¾…é˜Ÿåˆ—ä¸­ while (!isOnSyncQueue(node)) &#123; LockSupport.park(this); // å¤„ç†èŠ‚ç‚¹æ‰€åœ¨çº¿ç¨‹ä¸­æ–­çš„è½¬æ¢æ“ä½œ if ((interruptMode = checkInterruptWhileWaiting(node)) != 0) break; &#125; // èŠ‚ç‚¹æ‰€åœ¨çº¿ç¨‹è¢«å”¤é†’åï¼Œå¦‚æœèŠ‚ç‚¹æ‰€åœ¨çº¿ç¨‹æ²¡æœ‰å¤„äºä¸­æ–­çŠ¶æ€ï¼Œåˆ™ä»¥ç‹¬å æ¨¡å¼è¿›è¡Œå¤´èŠ‚ç‚¹ç«äº‰ // æ³¨æ„è¿™é‡Œä½¿ç”¨çš„statusæ˜¯å‰é¢é‡Šæ”¾èµ„æºæ—¶å€™è¿”å›çš„ä¿å­˜ä¸‹æ¥çš„status if (acquireQueued(node, savedState) &amp;&amp; interruptMode != THROW_IE) interruptMode = REINTERRUPT; // ä¸‹ä¸€ä¸ªç­‰å¾…èŠ‚ç‚¹ä¸ç©ºï¼Œåˆ™ä»ç­‰å¾…é˜Ÿåˆ—ä¸­ç§»é™¤æ‰€æœ‰å–æ¶ˆçš„ç­‰å¾…èŠ‚ç‚¹ if (node.nextWaiter != null) // clean up if cancelled unlinkCancelledWaiters(); // interruptModeä¸ä¸º0åˆ™æŒ‰ç…§ä¸­æ–­æ¨¡å¼è¿›è¡Œä¸åŒçš„å¤„ç† if (interruptMode != 0) reportInterruptAfterWait(interruptMode);&#125;// é‡Šæ”¾å½“å‰AQSä¸­çš„æ‰€æœ‰èµ„æºï¼Œå…¶å®ä¹Ÿå°±æ˜¯åŸºäºstatusçš„å€¼è°ƒç”¨release(status)// è¿™ä¸€æ­¥å¯¹äºé”å®ç°æ¥è¯´ï¼Œå°±æ˜¯ä¸€ä¸ªè§£é”æ“ä½œfinal int fullyRelease(Node node) &#123; try &#123; int savedState = getState(); if (release(savedState)) return savedState; throw new IllegalMonitorStateException(); &#125; catch (Throwable t) &#123; // é‡Šæ”¾å¤±è´¥åˆ™æ ‡è®°ç­‰å¾…çŠ¶æ€ä¸ºå–æ¶ˆ node.waitStatus = Node.CANCELLED; throw t; &#125;&#125;// ä¼ å…¥çš„èŠ‚ç‚¹æ˜¯å¦åœ¨åŒæ­¥é˜Ÿåˆ—ä¸­final boolean isOnSyncQueue(Node node) &#123; // èŠ‚ç‚¹ç­‰å¾…æ‚¨çŠ¶æ€ä¸ºCONDITIONæˆ–è€…å‰é©±èŠ‚ç‚¹ä¸ºnullåˆ™è¿”å›false if (node.waitStatus == Node.CONDITION || node.prev == null) return false; // å› ä¸ºç­‰å¾…é˜Ÿåˆ—æ˜¯é€šè¿‡nextWaiterè¿æ¥ï¼Œnextå¼•ç”¨å­˜åœ¨è¯´æ˜èŠ‚ç‚¹ä½äºåŒæ­¥é˜Ÿåˆ— if (node.next != null) return true; // ä»åŒæ­¥é˜Ÿåˆ—çš„å°¾éƒ¨å‘å‰éå†æ˜¯å¦å­˜åœ¨ä¼ å…¥çš„èŠ‚ç‚¹å®ä¾‹ return findNodeFromTail(node);&#125;// ä»åŒæ­¥é˜Ÿåˆ—çš„å°¾éƒ¨å‘å‰éå†æ˜¯å¦å­˜åœ¨ä¼ å…¥çš„èŠ‚ç‚¹å®ä¾‹private boolean findNodeFromTail(Node node) &#123; for (Node p = tail;;) &#123; if (p == node) return true; if (p == null) return false; p = p.prev; &#125;&#125;// è¿™æ˜¯ä¸€ä¸ªå¾ˆå¤æ‚çš„åˆ¤æ–­ï¼Œç”¨äº†ä¸¤ä¸ªä¸‰ç›®è¡¨è¾¾å¼ï¼Œä½œç”¨æ˜¯å¦‚æœæ–°å»ºçš„ç­‰å¾…èŠ‚ç‚¹æ‰€åœ¨çº¿ç¨‹ä¸­æ–­ï¼Œ// åˆ™æŠŠèŠ‚ç‚¹çš„çŠ¶æ€ç”±CONDITIONæ›´æ–°ä¸º0ï¼Œå¹¶ä¸”åŠ å…¥åˆ°åŒæ­¥ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œè¿”å›THROW_IEä¸­æ–­çŠ¶æ€ï¼Œå¦‚æœåŠ å…¥åŒæ­¥é˜Ÿåˆ—å¤±è´¥ï¼Œè¿”å›REINTERRUPT// å¦‚æœæ–°å»ºçš„ç­‰å¾…èŠ‚ç‚¹æ‰€åœ¨çº¿ç¨‹æ²¡æœ‰ä¸­æ–­ï¼Œè¿”å›0ï¼Œä¹Ÿå°±æ˜¯åˆå§‹çŠ¶æ€çš„interruptModeprivate int checkInterruptWhileWaiting(Node node) &#123; return Thread.interrupted() ? (transferAfterCancelledWait(node) ? THROW_IE : REINTERRUPT) : 0;&#125;// èŠ‚ç‚¹çº¿ç¨‹ä¸­æ–­å–æ¶ˆç­‰å¾…åçš„è½¬æ¢æ“ä½œfinal boolean transferAfterCancelledWait(Node node) &#123; // CASæ›´æ–°èŠ‚ç‚¹çš„çŠ¶æ€ç”±CONDITIONæ›´æ”¹ä¸º0 if (node.compareAndSetWaitStatus(Node.CONDITION, 0)) &#123; // èŠ‚ç‚¹åŠ å…¥åŒæ­¥ç­‰å¾…é˜Ÿåˆ— enq(node); return true; &#125; // è¿™é‡Œå°è¯•è‡ªæ—‹ï¼Œç›´åˆ°èŠ‚ç‚¹åŠ å…¥åŒæ­¥ç­‰å¾…é˜Ÿåˆ—æˆåŠŸ while (!isOnSyncQueue(node)) Thread.yield(); return false;&#125;// ç­‰å¾…å®Œæ¯•åæŠ¥å‘Šä¸­æ–­å¤„ç†ï¼Œå‰è¾¹çš„é€»è¾‘å¾—åˆ°çš„interruptModeå¦‚æœä¸ºTHROW_IEåˆ™æŠ›å‡ºInterruptedExceptionï¼Œå¦‚æœä¸ºREINTERRUPTåˆ™ä¸­æ–­å½“å‰çº¿ç¨‹private void reportInterruptAfterWait(int interruptMode) throws InterruptedException &#123; if (interruptMode == THROW_IE) throw new InterruptedException(); else if (interruptMode == REINTERRUPT) selfInterrupt();&#125; å…¶å®ä¸Šé¢çš„await()é€»è¾‘å¹¶ä¸å¤æ‚ï¼Œå‰ææ˜¯ç†è§£äº†å¯¹è±¡ç›‘è§†å™¨é”é‚£å¥—ç­‰å¾…å’Œå”¤é†’çš„æœºåˆ¶(ç”±JVMå®ç°ï¼ŒCè¯­è¨€å­¦å¾—å¥½çš„å¯ä»¥å»çœ‹ä¸‹æºç )ï¼Œè¿™é‡Œåªæ˜¯é€šè¿‡ç®—æ³•å’Œæ•°æ®ç»“æ„é‡æ–°è¿›è¡Œäº†ä¸€æ¬¡å®ç°ã€‚await()ä¸»è¦ä½¿ç”¨äº†ä¸¤ä¸ªé˜Ÿåˆ—ï¼šåŒæ­¥ç­‰å¾…é˜Ÿåˆ—å’Œæ¡ä»¶ç­‰å¾…é˜Ÿåˆ—ã€‚æˆ‘ä»¬å…ˆå‡è®¾æœ‰ä¸¤ä¸ªçº¿ç¨‹thread-1å’Œthread-2è°ƒç”¨äº†ä¸‹é¢çš„ä»£ç ä¸­çš„process()æ–¹æ³•ï¼š 123456789101112ReentrantLock lock = new ReentrantLock();Condition condition = lock.newCondition();public void process()&#123; try&#123; lock.lock(); condition.await(); // çœç•¥å…¶ä»–é€»è¾‘... &#125;finally&#123; lock.unlock(); &#125;&#125; ReentrantLockä½¿ç”¨çš„æ˜¯AQSç‹¬å æ¨¡å¼çš„å®ç°ï¼Œå› æ­¤åœ¨è°ƒç”¨lock()æ–¹æ³•çš„æ—¶å€™ï¼ŒåŒæ­¥ç­‰å¾…é˜Ÿåˆ—çš„ä¸€ä¸ªç¬æ—¶å¿«ç…§(å‡è®¾çº¿ç¨‹thread-1å…ˆåŠ å…¥åŒæ­¥ç­‰å¾…é˜Ÿåˆ—)å¯èƒ½å¦‚ä¸‹ï¼š æ¥ç€ï¼Œçº¿ç¨‹thread-1æ‰€åœ¨èŠ‚ç‚¹æ˜¯å¤´èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ï¼Œè·å–é”æˆåŠŸï¼Œå®ƒè§£é™¤é˜»å¡åå¯ä»¥è°ƒç”¨await()æ–¹æ³•ï¼Œè¿™ä¸ªæ—¶å€™ä¼šé‡Šæ”¾åŒæ­¥ç­‰å¾…é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰ç­‰å¾…èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯çº¿ç¨‹thread-2æ‰€åœ¨çš„èŠ‚ç‚¹ä¹Ÿè¢«é‡Šæ”¾ï¼Œå› æ­¤çº¿ç¨‹thread-2ä¹Ÿä¼šè°ƒç”¨await()æ–¹æ³•ï¼š åªè¦æœ‰çº¿ç¨‹èƒ½å¤Ÿåˆ°è¾¾await()æ–¹æ³•ï¼Œé‚£ä¹ˆåŸæ¥çš„åŒæ­¥å™¨ä¸­çš„åŒæ­¥ç­‰å¾…é˜Ÿåˆ—å°±ä¼šé‡Šæ”¾æ‰€æœ‰é˜»å¡èŠ‚ç‚¹ï¼Œè¡¨ç°ä¸ºé‡Šæ”¾é”ï¼Œç„¶åè¿™äº›é‡Šæ”¾æ‰çš„èŠ‚ç‚¹ä¼šåŠ å…¥åˆ°ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…é˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹ä¹Ÿæ˜¯é˜»å¡çš„ï¼Œè¿™ä¸ªæ—¶å€™åªæœ‰é€šè¿‡signal()æˆ–è€…signalAll()è¿›è¡Œé˜Ÿåˆ—å…ƒç´ è½¬ç§»æ‰æœ‰æœºä¼šå”¤é†’é˜»å¡çš„çº¿ç¨‹ã€‚å› æ­¤æ¥ç€çœ‹signal()å’ŒsignalAll()çš„æºç å®ç°ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859// ä»ç­‰å¾…é˜Ÿåˆ—ä¸­ç§»åŠ¨ä¸€ä¸ªç­‰å¾…æ—¶é—´æœ€é•¿çš„çº¿ç¨‹(å¦‚æœè¿‡å­˜åœ¨çš„è¯)åˆ°é”åŒæ­¥ç­‰å¾…é˜Ÿåˆ—ä¸­public final void signal() &#123; // åˆ¤æ–­å½“å‰çº¿ç¨‹æ˜¯å¦å’Œç‹¬å çº¿ç¨‹ä¸€è‡´ï¼Œå…¶å®å°±æ˜¯æ­¤æ“ä½œéœ€è¦åœ¨é”ä»£ç å—ä¸­æ‰§è¡Œ if (!isHeldExclusively()) throw new IllegalMonitorStateException(); Node first = firstWaiter; if (first != null) doSignal(first);&#125;// åŸºäºç¬¬ä¸€ä¸ªç­‰å¾…èŠ‚ç‚¹è¿›è¡ŒSignalæ“ä½œprivate void doSignal(Node first) &#123; do &#123; // é¦–èŠ‚ç‚¹çš„ä¸‹ä¸€ä¸ªç­‰å¾…èŠ‚ç‚¹ä¸ºç©ºï¼Œè¯´æ˜åªå‰©ä¸‹ä¸€ä¸ªç­‰å¾…èŠ‚ç‚¹ if ( (firstWaiter = first.nextWaiter) == null) lastWaiter = null; // å½“å‰å¤„ç†èŠ‚ç‚¹ä»é“¾è¡¨ä»ç§»é™¤ first.nextWaiter = null; &#125; while (!transferForSignal(first) &amp;&amp; (first = firstWaiter) != null);&#125;// å”¤é†’çš„è½¬æ¢æ“ä½œfinal boolean transferForSignal(Node node) &#123; // CASæ›´æ–°èŠ‚ç‚¹çŠ¶æ€ç”±CONDITIONåˆ°0ï¼Œæ›´æ–°å¤±è´¥åˆ™è¿”å›falseä¸å”¤é†’ if (!node.compareAndSetWaitStatus(Node.CONDITION, 0)) return false; // èŠ‚ç‚¹ä½œä¸ºæ–°èŠ‚ç‚¹é‡æ–°åŠ å…¥åˆ°åŒæ­¥ç­‰å¾…é˜Ÿåˆ— Node p = enq(node); int ws = p.waitStatus; // å–æ¶ˆæˆ–è€…æ›´æ–°èŠ‚ç‚¹ç­‰å¾…çŠ¶æ€ä¸ºSIGNALçš„èŠ‚ç‚¹éœ€è¦è§£é™¤é˜»å¡è¿›è¡Œé‡æ–°åŒæ­¥ï¼Œè¿™é‡Œçš„æ“ä½œåªé’ˆå¯¹å–æ¶ˆå’ŒçŠ¶æ€å¼‚å¸¸çš„èŠ‚ç‚¹ if (ws &gt; 0 || !p.compareAndSetWaitStatus(ws, Node.SIGNAL)) LockSupport.unpark(node.thread); return true;&#125;// ä»ç­‰å¾…é˜Ÿåˆ—ä¸­ç§»åŠ¨æ‰€æœ‰ç­‰å¾…æ—¶é—´æœ€é•¿çš„çº¿ç¨‹(å¦‚æœè¿‡å­˜åœ¨çš„è¯)åˆ°é”åŒæ­¥ç­‰å¾…é˜Ÿåˆ—ä¸­public final void signalAll() &#123; if (!isHeldExclusively()) throw new IllegalMonitorStateException(); Node first = firstWaiter; if (first != null) doSignalAll(first);&#125;// åŸºäºç¬¬ä¸€ä¸ªç­‰å¾…èŠ‚ç‚¹è¿›è¡ŒSignalAllæ“ä½œprivate void doSignalAll(Node first) &#123; // ç½®ç©ºlastWaiterå’ŒfirstWaiter lastWaiter = firstWaiter = null; do &#123; // è·å–ä¸‹ä¸€ä¸ªç­‰å¾…èŠ‚ç‚¹ Node next = first.nextWaiter; // å½“å‰å¤„ç†èŠ‚ç‚¹ä»é“¾è¡¨ä»ç§»é™¤ first.nextWaiter = null; // å¤„ç†å½“å‰èŠ‚ç‚¹ transferForSignal(first); // æ›´æ–°ä¸­é—´å¼•ç”¨ first = next; &#125; while (first != null);&#125; å…¶å®signal()æˆ–è€…signalAll()ä¼šå¯¹å–æ¶ˆçš„èŠ‚ç‚¹æˆ–è€…çŸ­æš‚ä¸­é—´çŠ¶æ€çš„èŠ‚ç‚¹è¿›è¡Œè§£é™¤é˜»å¡ï¼Œä½†æ˜¯æ­£å¸¸æƒ…å†µä¸‹ï¼Œå®ƒä»¬çš„æ“ä½œç»“æœæ˜¯æŠŠé˜»å¡ç­‰å¾…æ—¶é—´æœ€é•¿çš„ä¸€ä¸ªæˆ–è€…æ‰€æœ‰èŠ‚ç‚¹é‡æ–°åŠ å…¥åˆ°AQSçš„åŒæ­¥ç­‰å¾…é˜Ÿåˆ—ä¸­ã€‚ä¾‹å¦‚ï¼Œä¸Šé¢çš„ä¾‹å­è°ƒç”¨signal()æ–¹æ³•åå¦‚ä¸‹ï¼š è¿™æ ·å­ï¼Œç›¸å½“äºçº¿ç¨‹thread-1é‡æ–°åŠ å…¥åˆ°AQSåŒæ­¥ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œå¹¶ä¸”å¼€å§‹ç«äº‰å¤´èŠ‚ç‚¹ï¼Œä¸€æ—¦ç«äº‰æˆåŠŸï¼Œå°±èƒ½å¤Ÿè§£é™¤é˜»å¡ã€‚è¿™ä¸ªæ—¶å€™ä»é€»è¾‘ä¸Šçœ‹ï¼Œsignal()æ–¹æ³•æœ€ç»ˆè§£é™¤äº†å¯¹çº¿ç¨‹thread-1çš„é˜»å¡ã€‚await()çš„å…¶ä»–å˜ä½“æ–¹æ³•çš„åŸç†æ˜¯ç±»ä¼¼çš„ï¼Œè¿™é‡Œå› ä¸ºç¯‡å¹…åŸå› ä¸å†å±•å¼€ã€‚è¿™é‡Œå°ç»“ä¸€ä¸‹Conditionçš„æ˜¾è‘—ç‰¹ç‚¹ï¼š 1ã€åŒæ—¶ä¾èµ–ä¸¤ä¸ªåŒæ­¥ç­‰å¾…é˜Ÿåˆ—ï¼Œä¸€ä¸ªæ˜¯AQSæä¾›ï¼Œå¦ä¸€ä¸ªæ˜¯ConditionObjectæä¾›çš„ã€‚ 2ã€await()æ–¹æ³•ä¼šé‡Šæ”¾AQSåŒæ­¥ç­‰å¾…é˜Ÿåˆ—ä¸­çš„é˜»å¡èŠ‚ç‚¹ï¼Œè¿™äº›èŠ‚ç‚¹ä¼šåŠ å…¥åˆ°æ¡ä»¶é˜Ÿåˆ—ä¸­è¿›è¡Œé˜»å¡ã€‚ 3ã€signal()æˆ–è€…signalAll()ä¼šæŠŠæ¡ä»¶é˜Ÿåˆ—ä¸­çš„èŠ‚ç‚¹é‡æ–°åŠ å…¥AQSåŒæ­¥ç­‰å¾…é˜Ÿåˆ—ä¸­ï¼Œå¹¶ä¸è§£é™¤æ­£å¸¸èŠ‚ç‚¹çš„é˜»å¡çŠ¶æ€ã€‚ 4ã€æ¥ç¬¬3æ­¥ï¼Œè¿™äº›è¿›å…¥åˆ°AQSåŒæ­¥ç­‰å¾…é˜Ÿåˆ—çš„èŠ‚ç‚¹ä¼šé‡æ–°ç«äº‰æˆä¸ºå¤´èŠ‚ç‚¹ï¼Œå…¶å®ä¹Ÿå°±æ˜¯å‰é¢åˆ†æè¿‡çš„ç‹¬å æ¨¡å¼ä¸‹çš„AQSçš„è¿ä½œåŸç†ã€‚ å–æ¶ˆè·å–èµ„æº(cancelAcquire) æ–°èŠ‚ç‚¹åŠ å…¥ç­‰å¾…é˜Ÿåˆ—å¤±è´¥å¯¼è‡´ä»»ä½•ç±»å‹çš„å¼‚å¸¸æˆ–è€…å¸¦è¶…æ—¶ç‰ˆæœ¬çš„APIè°ƒç”¨çš„æ—¶å€™å‰©ä½™è¶…æ—¶æ—¶é—´å°äºç­‰äºé›¶çš„æ—¶å€™ï¼Œå°±ä¼šè°ƒç”¨cancelAcquire()æ–¹æ³•ï¼Œç”¨äºå–æ¶ˆè¯¥èŠ‚ç‚¹å¯¹åº”èŠ‚ç‚¹è·å–èµ„æºçš„æ“ä½œã€‚ 1234567891011121314151617181920212223242526272829303132333435// å–æ¶ˆèŠ‚ç‚¹è·å–èµ„æºçš„æ“ä½œprivate void cancelAcquire(Node node) &#123; // èŠ‚ç‚¹ä¸ºnullç›´æ¥è¿”å› if (node == null) return; // ç½®ç©ºèŠ‚ç‚¹æŒæœ‰çš„çº¿ç¨‹ï¼Œå› ä¸ºæ­¤æ—¶èŠ‚ç‚¹çº¿ç¨‹å·²ç»å‘ç”Ÿä¸­æ–­ node.thread = null; Node pred = node.prev; // è¿™ä¸ªå¾ªç¯æ˜¯ä¸ºäº†è·å–å½“å‰èŠ‚ç‚¹çš„ä¸Šä¸€ä¸ªä¸ä¸ºå–æ¶ˆçŠ¶æ€çš„èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯ä¸­é—´å¦‚æœå‘ç”Ÿäº†å–æ¶ˆçš„èŠ‚ç‚¹éƒ½ç›´æ¥æ–­å¼€ while (pred.waitStatus &gt; 0) node.prev = pred = pred.prev; // ä¿å­˜å½“å‰èŠ‚ç‚¹çš„ä¸Šä¸€ä¸ªä¸ä¸ºå–æ¶ˆçŠ¶æ€çš„èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ Node predNext = pred.next; // å½“å‰èŠ‚ç‚¹ç­‰å¾…çŠ¶æ€æ›´æ–°ä¸ºCANCELLED node.waitStatus = Node.CANCELLED; // å¦‚æœå½“å‰èŠ‚ç‚¹ä¸ºå°¾èŠ‚ç‚¹ï¼Œåˆ™ç›´æ¥æ›´æ–°å°¾èŠ‚ç‚¹ä¸ºå½“å‰èŠ‚ç‚¹çš„ä¸Šä¸€ä¸ªä¸ä¸ºå–æ¶ˆçŠ¶æ€çš„èŠ‚ç‚¹ if (node == tail &amp;&amp; compareAndSetTail(node, pred)) &#123; // ç„¶åæ›´æ–°è¯¥èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ä¸ºnullï¼Œå› ä¸ºå®ƒå·²ç»æˆä¸ºæ–°çš„å°¾èŠ‚ç‚¹ pred.compareAndSetNext(predNext, null); &#125; else &#123; int ws; // å½“å‰èŠ‚ç‚¹çš„ä¸Šä¸€ä¸ªä¸ä¸ºå–æ¶ˆçŠ¶æ€çš„èŠ‚ç‚¹å·²ç»ä¸æ˜¯å¤´èŠ‚ç‚¹çš„æƒ…å†µï¼Œéœ€è¦æŠŠå½“å‰å–æ¶ˆçš„èŠ‚ç‚¹ä»AQSåŒæ­¥ç­‰å¾…é˜Ÿåˆ—ä¸­æ–­å¼€ if (pred != head &amp;&amp; ((ws = pred.waitStatus) == Node.SIGNAL || (ws &lt;= 0 &amp;&amp; pred.compareAndSetWaitStatus(ws, Node.SIGNAL))) &amp;&amp; pred.thread != null) &#123; Node next = node.next; if (next != null &amp;&amp; next.waitStatus &lt;= 0) pred.compareAndSetNext(predNext, next); &#125; else &#123; // å½“å‰èŠ‚ç‚¹çš„ä¸Šä¸€ä¸ªä¸ä¸ºå–æ¶ˆçŠ¶æ€çš„èŠ‚ç‚¹å·²ç»æ˜¯å¤´èŠ‚ç‚¹ï¼Œç›¸å½“äºå¤´èŠ‚ç‚¹ä¹‹åçš„èŠ‚ç‚¹éƒ½æ˜¯å–æ¶ˆï¼Œéœ€è¦å”¤é†’å½“å‰èŠ‚ç‚¹çš„åç»§èŠ‚ç‚¹ unparkSuccessor(node); &#125; // èŠ‚ç‚¹åç»§èŠ‚ç‚¹è®¾ç½®ä¸ºè‡ªèº«ï¼Œé‚£ä¹ˆå°±ä¸ä¼šå½±å“åç»§èŠ‚ç‚¹ node.next = node; &#125;&#125; cancelAcquire()æ–¹æ³•æœ‰å¤šå¤„è°ƒç”¨ï¼Œä¸»è¦åŒ…æ‹¬ä¸‹é¢çš„æƒ…å†µï¼š 1ã€èŠ‚ç‚¹çº¿ç¨‹åœ¨é˜»å¡è¿‡ç¨‹ä¸­ä¸»åŠ¨ä¸­æ–­çš„æƒ…å†µä¸‹ä¼šè°ƒç”¨ã€‚ 2ã€acquireçš„å¤„ç†è¿‡ç¨‹å‘ç”Ÿä»»ä½•å¼‚å¸¸çš„æƒ…å†µä¸‹éƒ½ä¼šè°ƒç”¨ï¼ŒåŒ…æ‹¬tryAcquire()ã€tryAcquireShared()ç­‰ã€‚ 3ã€æ–°èŠ‚ç‚¹åŠ å…¥ç­‰å¾…é˜Ÿåˆ—å¤±è´¥å¯¼è‡´ä»»ä½•ç±»å‹çš„å¼‚å¸¸æˆ–è€…å¸¦è¶…æ—¶ç‰ˆæœ¬çš„APIè°ƒç”¨çš„æ—¶å€™å‰©ä½™è¶…æ—¶æ—¶é—´å°äºç­‰äºé›¶çš„æ—¶å€™ã€‚ cancelAcquire()ä¸»è¦ä½œç”¨æ˜¯æŠŠå–æ¶ˆçš„èŠ‚ç‚¹ç§»å‡ºåŒæ­¥ç­‰å¾…é˜Ÿåˆ—ï¼Œå¿…é¡»æ—¶å€™éœ€è¦è¿›è¡Œåç»§èŠ‚ç‚¹çš„å”¤é†’ã€‚ å®æˆ˜ç¯‡ AQSæ˜¯ä¸€ä¸ªæŠ½è±¡çš„åŒæ­¥å™¨åŸºç¡€æ¡†æ¶ï¼Œå…¶å®æˆ‘ä»¬ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨å®ƒå®ç°ä¸€äº›é«˜çº§çš„å¹¶å‘æ¡†æ¶ã€‚ä¸‹é¢åŸºäºAQSå®ç°ä¸€äº›éå†…å»ºçš„åŠŸèƒ½ï¼Œè¿™ä¸¤ä¸ªä¾‹å­æ¥è‡ªäºAQSçš„æ³¨é‡Šä¸­ã€‚ metux å¤§å­¦Cè¯­è¨€è¯¾ç¨‹ä¸­ç»å¸¸æåŠåˆ°çš„åªæœ‰ä¸€ä¸ªèµ„æºçš„metux(äº’æ–¥åŒº)ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼ŒåŒä¸€ä¸ªæ—¶åˆ»ï¼Œåªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹è·å–åˆ°èµ„æºï¼Œå…¶ä»–è·å–èµ„æºçš„çº¿ç¨‹éœ€è¦é˜»å¡ç­‰å¾…åˆ°å‰ä¸€ä¸ªçº¿ç¨‹é‡Šæ”¾èµ„æºã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106public class Metux implements Lock, Serializable &#123; private static class Sync extends AbstractQueuedSynchronizer &#123; @Override protected boolean tryAcquire(int arg) &#123; assert 1 == arg; if (compareAndSetState(0, 1)) &#123; setExclusiveOwnerThread(Thread.currentThread()); return true; &#125; return false; &#125; @Override protected boolean tryRelease(int arg) &#123; assert 1 == arg; if (!isHeldExclusively()) &#123; throw new IllegalMonitorStateException(); &#125; setExclusiveOwnerThread(null); setState(0); return true; &#125; public Condition newCondition() &#123; return new ConditionObject(); &#125; public boolean isLocked() &#123; return getState() != 0; &#125; @Override public boolean isHeldExclusively() &#123; return getExclusiveOwnerThread() == Thread.currentThread(); &#125; private void readObject(ObjectInputStream s) throws IOException, ClassNotFoundException &#123; s.defaultReadObject(); setState(0); &#125; &#125; private final Sync sync = new Sync(); @Override public void lock() &#123; sync.acquire(1); &#125; @Override public void lockInterruptibly() throws InterruptedException &#123; sync.acquireInterruptibly(1); &#125; @Override public boolean tryLock() &#123; return sync.tryAcquire(1); &#125; @Override public boolean tryLock(long time, TimeUnit unit) throws InterruptedException &#123; return sync.tryAcquireNanos(1, unit.toNanos(time)); &#125; public boolean isLocked() &#123; return sync.isLocked(); &#125; public boolean isHeldByCurrentThread() &#123; return sync.isHeldExclusively(); &#125; @Override public void unlock() &#123; sync.release(1); &#125; @Override public Condition newCondition() &#123; return sync.newCondition(); &#125; public static void main(String[] args) throws Exception &#123; final Metux metux = new Metux(); new Thread(() -&gt; &#123; metux.lock(); System.out.println(String.format(\"%s-thread-1è·å–é”æˆåŠŸä¼‘çœ 3ç§’...\", LocalDateTime.now())); try &#123; Thread.sleep(3000); &#125; catch (InterruptedException e) &#123; //ignore &#125; metux.unlock(); System.out.println(String.format(\"%s-thread-1è·è§£é”æˆåŠŸ...\", LocalDateTime.now())); return; &#125;, \"thread-1\").start(); new Thread(() -&gt; &#123; metux.lock(); System.out.println(String.format(\"%s-thread-2è·å–é”æˆåŠŸ...\",LocalDateTime.now())); return; &#125;, \"thread-2\").start(); Thread.sleep(Integer.MAX_VALUE); &#125;&#125; æŸä¸ªæ—¶é—´çš„æŸæ¬¡è¿è¡Œç»“æœå¦‚ä¸‹ï¼š 1232019-04-07T11:49:27.858791200-thread-1è·å–é”æˆåŠŸä¼‘çœ 3ç§’...2019-04-07T11:49:30.876567-thread-2è·å–é”æˆåŠŸ...2019-04-07T11:49:30.876567-thread-1è·è§£é”æˆåŠŸ... äºŒå…ƒæ …æ  äºŒå…ƒæ …æ æ˜¯CountDownLatchçš„ç®€åŒ–ç‰ˆï¼Œåªå…è®¸ä¸€ä¸ªçº¿ç¨‹é˜»å¡ï¼Œç”±å¦ä¸€ä¸ªçº¿ç¨‹è´Ÿè´£å”¤é†’ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849public class BooleanLatch &#123; private static class Sync extends AbstractQueuedSynchronizer &#123; boolean isSignalled() &#123; return getState() != 0; &#125; @Override protected int tryAcquireShared(int ignore) &#123; return isSignalled() ? 1 : -1; &#125; @Override protected boolean tryReleaseShared(int ignore) &#123; setState(1); return true; &#125; &#125; private final Sync sync = new Sync(); public boolean isSignalled() &#123; return sync.isSignalled(); &#125; public void signal() &#123; sync.releaseShared(1); &#125; public void await() throws InterruptedException &#123; sync.acquireSharedInterruptibly(1); &#125; public static void main(String[] args) throws Exception &#123; BooleanLatch latch = new BooleanLatch(); new Thread(()-&gt; &#123; try &#123; Thread.sleep(3000); &#125; catch (InterruptedException e) &#123; //ignore &#125; latch.signal(); &#125;).start(); System.out.println(String.format(\"[%s]-ä¸»çº¿ç¨‹è¿›å…¥é˜»å¡...\", LocalDateTime.now())); latch.await(); System.out.println(String.format(\"[%s]-ä¸»çº¿ç¨‹è¿›è¢«å”¤é†’...\", LocalDateTime.now())); &#125;&#125; æŸä¸ªæ—¶é—´çš„æŸæ¬¡è¿è¡Œç»“æœå¦‚ä¸‹ï¼š 12[2019-04-07T11:55:12.647816200]-ä¸»çº¿ç¨‹è¿›å…¥é˜»å¡...[2019-04-07T11:55:15.632088]-ä¸»çº¿ç¨‹è¿›è¢«å”¤é†’... å°ç»“ åœ¨JUCçš„é‡è¦å¹¶å‘ç±»åº“æˆ–è€…å®¹å™¨ä¸­ï¼ŒAQSèµ·åˆ°äº†åŸºç¡€æ¡†æ¶çš„ä½œç”¨ï¼Œç†è§£åŒæ­¥å™¨çš„å®ç°åŸç†ï¼Œæœ‰åŠ©äºç†è§£å’Œåˆ†æå…¶ä»–å¹¶å‘ç›¸å…³ç±»åº“çš„å®ç°ã€‚è¿™ç¯‡æ–‡ç« å‰åè€—è´¹äº†æ¥è¿‘1ä¸ªæœˆæ—¶é—´ç¼–å†™ï¼ŒDEBUGè¿‡ç¨‹æœ€å¥½ä½¿ç”¨å¤šçº¿ç¨‹æ–­ç‚¹ï¼Œå¦åˆ™å¾ˆéš¾æ¨¡æ‹ŸçœŸå®çš„æƒ…å†µã€‚AQSé‡Œé¢çš„é€»è¾‘æ˜¯ç›¸å¯¹å¤æ‚çš„ï¼Œå¾ˆæ•¬ä½©å¹¶å‘å¤§å¸ˆDouglas S. Leaå¦‚æ­¤ç²¾å·§çš„ç±»åº“è®¾è®¡ã€‚ å‚è€ƒèµ„æ–™ï¼š ã€ŠThe Art of Multiprocessor Programmingã€‹ ã€ŠThe java.util.concurrent Synchronizer Frameworkã€‹ JDK11ç›¸å…³æºç  (æœ¬æ–‡å®Œ c-a-30-d e-a-20190407 r-a-20190609-ä¿®å¤ç¤ºæ„å›¾éƒ¨åˆ†é”™è¯¯é—®é¢˜)","categories":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/categories/Java/"},{"name":"Concurrency","slug":"Java/Concurrency","permalink":"http://throwable.club/blog/categories/Java/Concurrency/"}],"tags":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/tags/Java/"},{"name":"AQS","slug":"AQS","permalink":"http://throwable.club/blog/tags/AQS/"}]},{"title":"ç‰¹åˆ«æ•™ç¨‹-CronTriggeræ•™ç¨‹","slug":"quartz-doc-translation-cron-trigger","date":"2019-03-29T17:42:57.000Z","updated":"2019-07-15T15:57:10.103Z","comments":true,"path":"2019/03/30/quartz-doc-translation-cron-trigger/","link":"","permalink":"http://throwable.club/2019/03/30/quartz-doc-translation-cron-trigger/","excerpt":"","text":"ç‰¹åˆ«æ•™ç¨‹-CronTriggeræ•™ç¨‹ ä»‹ç» cronè¡¨è¾¾å¼æ˜¯ä¸€ä¸ªå·²ç»å­˜åœ¨äº†å¾ˆé•¿æ—¶é—´çš„UNIXå·¥å…·ï¼Œå› æ­¤å®ƒçš„è°ƒåº¦åŠŸèƒ½éå¸¸å¼ºå¤§ä¸”å·²ç»ç»è¿‡éªŒè¯ã€‚CronTriggerç±»çš„åŠŸèƒ½æ˜¯åŸºäºcronçš„è°ƒåº¦åŠŸèƒ½å®ç°çš„ã€‚ CronTriggerä½¿ç”¨&quot;cronè¡¨è¾¾å¼&quot;ï¼Œå¯ä»¥åˆ›å»ºè¯¸å¦‚â€œæ¯å‘¨ä¸€è‡³å‘¨äº”ä¸Šåˆ8:00â€æˆ–â€œæ¯æœˆæœ€åä¸€ä¸ªæ˜ŸæœŸäº”ä¸Šåˆ1:30â€çš„è§¦å‘è°ƒåº¦æ—¶é—´è¡¨(è°ƒåº¦è®¡åˆ’)ã€‚ cronè¡¨è¾¾å¼å¾ˆå¼ºå¤§ï¼Œä½†æ˜¯å®ƒä½¿ç”¨èµ·æ¥ä¹Ÿæœ‰å¯èƒ½ç›¸å½“æ··ä¹±(è¿™é‡Œå¤§æ¦‚çš„æ„æ€æ˜¯è¯´cronçš„ç”¨æ³•ç›¸å¯¹å¤æ‚ï¼Œå®¹æ˜“å‡ºé”™)ã€‚æœ¬æ•™ç¨‹æ—¨åœ¨è§£å†³åˆ›å»ºcronè¡¨è¾¾å¼çš„ä¸€äº›è°œé¢˜ï¼Œä¸ºç”¨æˆ·æä¾›ä¸€ä¸ªèµ„æºï¼Œè®©ä»–ä»¬å¯ä»¥åœ¨è®ºå›æˆ–é‚®ä»¶åˆ—è¡¨ä¸­æé—®ä¹‹å‰è®¿é—®è¿™ä¸ªæ•™ç¨‹(å‡å°‘åœ¨è®ºå›æˆ–è€…é‚®ä»¶ä¸­çš„æé—®)ã€‚ æ ¼å¼ cronè¡¨è¾¾å¼æ˜¯ç”±ç©ºæ ¼åˆ†éš”çš„6æˆ–7ä¸ªå­—æ®µç»„æˆçš„å­—ç¬¦ä¸²ã€‚å­—æ®µå¯ä»¥åŒ…å«ä»»ä½•å…è®¸çš„å€¼ï¼Œä»¥åŠè¯¥å­—æ®µå…è®¸çš„ç‰¹æ®Šå­—ç¬¦çš„å„ç§ç»„åˆã€‚è¿™äº›å­—æ®µå¦‚ä¸‹æ‰€ç¤ºï¼š å­—æ®µåç§° æ˜¯å¦å¿…é¡» å…è®¸çš„å€¼ å…è®¸çš„ç‰¹æ®Šå­—ç¬¦ ç§’ç§(Seconds) æ˜¯ 0-59 , - * / åˆ†é’Ÿ(Minutes) æ˜¯ 0-59 , - * / å°æ—¶(Hours) æ˜¯ 0-23 , - * / æ—¥(Day of month) æ˜¯ 1-31 , - * ? / L W æœˆ(Month) æ˜¯ 1-12 or JAN-DEC , - * / æ˜ŸæœŸ(Day of week) æ˜¯ 1-7 or SUN-SAT , - * ? / L # å¹´(Year) å¦ empty(ä¹Ÿå°±æ˜¯ä¸å¡«ä»»ä½•å€¼), 1970-2099 , - * / è¯‘è€…æ³¨ï¼šè¿™é‡Œå¯ä»¥çœ‹å‡ºä¸€ä¸ªcronè¡¨è¾¾å¼ä¸­å¹´(Year)å­—æ®µæ˜¯éå¿…é¡»çš„ï¼Œå¦‚æœä¸å¡«å†™æ­¤å­—æ®µå¯ä»¥è®¤ä¸ºå®ƒå…¶å®å°±æ˜¯*å€¼ã€‚ æ‰€ä»¥cronè¡¨è¾¾å¼å¯ä»¥åƒè¿™æ ·ç®€å•ï¼š* * * * ? *ï¼Œæˆ–æ›´å¤æ‚ï¼Œå¦‚è¿™ä¸ªä¾‹å­æ‰€ç¤ºï¼š0/5 14,18,39,52 * ? JAN,MAR,SEP MON-FRI 2002-2010ã€‚ ç‰¹æ®Šå­—ç¬¦ *ï¼šä»£è¡¨æ‰€æœ‰å€¼ - ç”¨äºé€‰æ‹©ä¸€ä¸ªå­—æ®µä¸­çš„æ‰€æœ‰å€¼ã€‚ä¾‹å¦‚ï¼Œåˆ†é’Ÿå­—æ®µ(Minutes)ä¸­çš„&quot;*&quot;è¡¨ç¤º â€œæ¯åˆ†é’Ÿâ€ã€‚ ?ï¼šä»£è¡¨æ²¡æœ‰å…·ä½“çš„å€¼ - å½“ä½ éœ€è¦å®šä¹‰ä¸¤ä¸ªå­—æ®µä¸­çš„å…¶ä¸­ä¸€ä¸ªï¼Œå¦ä¸€ä¸ªä¸éœ€è¦å®šä¹‰idæ—¶å€™å°±ååˆ†æœ‰ç”¨(å…¶å®ä¸»è¦å°±æ˜¯ç”¨åœ¨Day of monthå’ŒDay of weekçš„äº’æ–¥å…³ç³»ä¸­)ã€‚ä¾‹å¦‚ï¼Œä¾‹å¦‚æˆ‘æƒ³æˆ‘çš„è§¦å‘å™¨æ¯æœˆçš„æŸä¸€æ—¥(ä¾‹å¦‚ç¬¬åæ—¥)è§¦å‘ï¼Œä½†æ˜¯æˆ‘ä¸éœ€è¦å…³æ³¨å½“å¤©æ˜¯æ˜ŸæœŸå‡ ï¼Œå› æ­¤æˆ‘åªéœ€è¦æŠŠâ€™10â€™è®¾ç½®åœ¨Day of monthå­—æ®µï¼ŒæŠŠâ€™?'è®¾ç½®åœ¨Day of weekå­—æ®µå³å¯ã€‚å¯ä»¥å‚é˜…ä¸‹é¢çš„ä¾‹å­æ¥è¿›ä¸€æ­¥äº†è§£ã€‚ -ï¼šç”¨äºæŒ‡å®šèŒƒå›´å€¼ã€‚ä¾‹å¦‚Hourså­—æ®µä¸­çš„&quot;10-12&quot;è¡¨ç¤º&quot;10,11å’Œ12&quot;å°æ—¶(å°±æ˜¯ä¸€ä¸ªèŒƒå›´å€¼)ã€‚ ,ï¼šç”¨äºæŒ‡å®šé™„åŠ å€¼ã€‚ä¾‹å¦‚Day of weekå­—æ®µä¸­çš„&quot;MON,WED,FRI&quot;è¡¨ç¤º â€œæ˜ŸæœŸä¸€ï¼Œæ˜ŸæœŸä¸‰å’Œæ˜ŸæœŸäº”â€ã€‚ /ï¼šç”¨äºæŒ‡å®šå¢é‡(æ ¼å¼æ˜¯ï¼šâ€œåˆå§‹å€¼/å¢é‡â€)ã€‚ä¾‹å¦‚åœ¨Secondså­—æ®µä¸­&quot;0/15&quot;è¡¨ç¤ºç§’æ•°èŒƒå›´å–å€¼&quot;0,15,30å’Œ45&quot;ï¼ŒSecondså­—æ®µä¸­&quot;5/15&quot;è¡¨ç¤ºç§’æ•°èŒƒå›´å–å€¼&quot;5,20,35å’Œ50&quot;ã€‚ä¸Šä¸€ä¸ªä¾‹å­è¯´æ˜äº†ï¼Œä½ å¯ä»¥åœ¨&quot;/&quot;å‰å–éé›¶å€¼(å…¶å®ä¹Ÿå°±æ˜¯åˆå§‹å€¼ä¸ä¸º0)ï¼Œä¾‹å¦‚Day of monthå­—æ®µä¸­&quot;1/3&quot;è¡¨ç¤ºä»æœˆä»½çš„ç¬¬ä¸€å¤©èµ·æ¯ä¸‰å¤©(è§¦å‘ä¸€æ¬¡)ã€‚ Lï¼šè‹±æ–‡å•è¯&quot;last&quot;çš„ç¼©å†™ï¼Œå«ä¹‰å’Œlastä¸€è‡´ã€‚ Wï¼šè‹±æ–‡å•è¯&quot;weekday&quot;çš„ç¼©å†™ï¼Œå³å·¥ä½œæ—¥(æ˜ŸæœŸä¸€åˆ°æ˜ŸæœŸäº”)ã€‚ æ³¨æ„ï¼š 123'L'å’Œ'W'å­—ç¬¦å¯ä»¥Day of monthå­—æ®µåˆå¹¶ä½¿ç”¨ï¼Œä¹Ÿå°±æ˜¯åœ¨Day of monthå­—æ®µä¸­ä½¿ç”¨'LW'ï¼Œè½¬æ¢ä¸ºâ€œæœˆä»½çš„æœ€åä¸€ä¸ªå·¥ä½œæ—¥â€ã€‚ä¾‹å¦‚ï¼š\"0 0 12 1LW * ?\"è¡¨ç¤ºæ¯ä¸ªæœˆçš„æœ€åä¸€ä¸ªå·¥ä½œæ—¥ä¸­åˆ12ç‚¹è§¦å‘ã€‚ #ï¼šç”¨äºæŒ‡å®šæœˆä»½çš„&quot;ç¬¬nä¸ª&quot;æ˜ŸæœŸXXX*(æ ¼å¼ï¼šn#pï¼Œè¡¨ç¤ºæœˆä»½çš„ç¬¬pä¸ªæ˜ŸæœŸnï¼Œnç”±1å¼€å§‹ï¼Œ1è¡¨ç¤ºæ˜ŸæœŸæ—¥)ã€‚ä¾‹å¦‚ï¼ŒDay of weekå­—æ®µçš„ä¸­&quot;6#3&quot;è¡¨ç¤ºè¯¥æœˆçš„ç¬¬ä¸‰ä¸ªæ˜ŸæœŸäº”(6è¡¨ç¤ºæ˜ŸæœŸäº”ï¼Œ#3è¡¨ç¤ºç¬¬ä¸‰ä¸ªæ˜ŸæœŸ)ã€‚ä¾‹å¦‚ï¼šâ€œ2#1&quot;è¡¨ç¤ºæœˆä»½çš„ç¬¬ä¸€ä¸ªæ˜ŸæœŸä¸€ï¼Œâ€œ4#5&quot;è¡¨ç¤ºæœˆä»½çš„ç¬¬äº”ä¸ªæ˜ŸæœŸä¸‰ã€‚æ³¨æ„æœ€åè¿™ä¸ªä¾‹å­ï¼Œå¦‚æœä½ æŒ‡å®šäº†â€#5â€ï¼Œå¹¶ä¸”æœˆä»½çš„æ˜ŸæœŸæ•°ä¸è¶…è¿‡5ä¸ªï¼Œé‚£ä¹ˆè¯¥æœˆä»½ä¸ä¼šè§¦å‘ä»»ä½•è°ƒåº¦ã€‚ æ³¨æ„ï¼š 1æœˆä»½å’Œæ˜ŸæœŸç¼©å†™å¯¹åº”çš„åˆæ³•å­—ç¬¦ä¸åŒºåˆ†å¤§å°å†™ã€‚ä¾‹å¦‚ï¼šMONä¸monç›¸åŒã€‚ ä¾‹å­ è¿™é‡Œæœ‰ä¸€äº›å®Œæ•´çš„ä¾‹å­ï¼š è¡¨è¾¾å¼ å«ä¹‰ 0 0 12 * * ? æ¯å¤©ä¸­åˆ12ç‚¹ï¼ˆä¸­åˆï¼‰è§¦å‘ 0 15 10 ? * * æ¯å¤©ä¸Šåˆ10ç‚¹15åˆ†è§¦å‘ 0 15 10 * * ? æ¯å¤©ä¸Šåˆ10ç‚¹15åˆ†è§¦å‘ 0 15 10 * * ? * æ¯å¤©ä¸Šåˆ10ç‚¹15åˆ†è§¦å‘ 0 15 10 * * ? 2005 2005å¹´æ¯å¤©ä¸Šåˆ10ç‚¹15åˆ†è§¦å‘ 0 * 14 * * ? æ¯å¤©ä¸‹åˆ2ç‚¹å¼€å§‹ï¼Œæ¯å¤©ä¸‹åˆ2ç‚¹59åˆ†ç»“æŸ 0 0/5 14 * * ? æ¯å¤©ä¸‹åˆ2ç‚¹å¼€å§‹ï¼Œæ¯å¤©ä¸‹åˆ2ç‚¹55åˆ†ç»“æŸï¼Œæ¯5åˆ†é’Ÿè§¦å‘ä¸€æ¬¡ 0 0/5 14,18 * * ? ä»ä¸‹åˆ2ç‚¹å¼€å§‹ï¼Œæ¯å¤©5åˆ†é’Ÿè§¦å‘ï¼Œç»“æŸäºä¸‹åˆ2ç‚¹55åˆ†ï¼Œæ¯å¤©5ç‚¹é’Ÿè§¦å‘ï¼Œæ¯å¤©æ™šä¸Š6ç‚¹å¼€å§‹ï¼Œç»“æŸäºä¸‹åˆ6ç‚¹55åˆ† 0 0-5 14 * * ? æ¯å¤©ä¸‹åˆ2ç‚¹å¼€å§‹ï¼Œç»“æŸäºä¸‹åˆ2ç‚¹05åˆ†ï¼Œæ¯åˆ†é’Ÿè§¦å‘ 0 10,44 14 ? 3 WED åœ¨3æœˆä»½çš„æ¯ä¸ªæ˜ŸæœŸä¸‰ä¸‹åˆ2ç‚¹10åˆ†å’Œä¸‹åˆ2ç‚¹44åˆ†è§¦å‘ 0 15 10 ? * MON-FRI æ¯å‘¨ä¸€ï¼Œå‘¨äºŒï¼Œå‘¨ä¸‰ï¼Œå‘¨å››å’Œå‘¨äº”ä¸Šåˆ10ç‚¹15åˆ†è§¦å‘ 0 15 10 15 * ? åœ¨æ¯ä¸ªæœˆçš„ç¬¬15å¤©ä¸Šåˆ10ç‚¹15åˆ†è§¦å‘ 0 15 10 L * ? åœ¨æ¯ä¸ªæœˆçš„æœ€åä¸€å¤©ä¸Šåˆ10ç‚¹15åˆ†è§¦å‘ 0 15 10 L-2 * ? åœ¨æ¯ä¸ªæœˆçš„å€’æ•°ç¬¬äºŒå¤©çš„ä¸Šåˆ10ç‚¹15åˆ†è§¦å‘ 0 15 10 ? * 6L æ¯ä¸ªæœˆçš„æœ€åä¸€ä¸ªæ˜ŸæœŸäº”ä¸Šåˆ10ç‚¹15åˆ†è§¦å‘ 0 15 10 ? * 6L 2002-2005 2002å¹´ï¼Œ2003å¹´ï¼Œ2004å¹´å’Œ2005å¹´æ¯ä¸ªæœˆçš„æœ€åä¸€ä¸ªæ˜ŸæœŸäº”ä¸Šåˆ10ç‚¹15åˆ†è§¦å‘ 0 15 10 ? * 6#3 æ¯ä¸ªæœˆçš„ç¬¬ä¸‰ä¸ªæ˜ŸæœŸäº”ä¸Šåˆ10ç‚¹15åˆ†è§¦å‘ 0 0 12 1/5 * ? ä»æ¯æœˆçš„ç¬¬ä¸€å¤©å¼€å§‹ï¼Œæ¯ä¸ªæœˆæ¯éš”5å¤©ä¸‹åˆ12ç‚¹ï¼ˆä¸­åˆï¼‰è§¦å‘ 0 11 11 11 11 ? æ¯11æœˆ11æ—¥ä¸Šåˆ11ç‚¹11åˆ†è§¦å‘ æ³¨æ„ï¼š 1è¯·æ³¨æ„'?'å’Œ'*'åœ¨æ—¥(Day of month)å’Œæ˜ŸæœŸ(Day of week)ä¸­çš„ä½œç”¨ã€‚ æ³¨æ„äº‹é¡¹ ç›®å‰ä¸å®Œå…¨æ”¯æŒåŒæ—¶å®šä¹‰Day of weekå’ŒDay of monthä¸¤ä¸ªå­—æ®µ(ä½ å¿…é¡»åœ¨è¿™ä¸¤ä¸ªå­—æ®µå…¶ä¸­ä¹‹ä¸€ä½¿ç”¨â€™?â€™ã€‚å…¶å®è¿™æ ·åšçš„ç›®çš„æ˜¯è¿™ä¸¤ä¸ªå­—æ®µæ˜¯äº’æ–¥çš„)ã€‚ ä½ éœ€è¦æ³¨æ„å¦‚æœè§¦å‘æ—¶é—´è®¾ç½®åœ¨å‡Œæ™¨çš„å‡ ä¸ªå°æ—¶ï¼Œä½ çš„è¯­è¨€ç¯å¢ƒ(locale)æœ‰å¯èƒ½ä¼šå› ä¸ºâ€œå¤ä»¤æ—¶â€ï¼ˆå¯¹äºç¾å›½åœ°åŒºï¼Œè¿™é€šå¸¸æ˜¯å‡Œæ™¨2ç‚¹ä¹‹å‰å’Œä¹‹åçš„ä¸€ä¸ªå°æ—¶ï¼‰è€Œå‘ç”Ÿå˜åŒ– - æ­¤æ—¶ï¼Œæ—¶é—´è¿ç§»æœ‰å¯èƒ½ä¼šå‘ç”Ÿè·³è·ƒæˆ–è€…é‡å¤(è¿™é‡Œæ˜¯æŒ‡åŒä¸€ä¸ªæ—¶åˆ»é‡å¤ä¸¤æ¬¡ï¼Œå› ä¸ºæ—¶é—´å‘ç”Ÿäº†å›æ‹¨)ï¼Œè¿™å–å†³äºæ—¶é—´æ˜¯å‘åç§»åŠ¨è¿˜æ˜¯å‘å‰ç§»åŠ¨ã€‚ä½ å¯ä»¥ä»ç»´åŸºç™¾ç§‘ä¸ŠæŸ¥æ‰¾èµ„æ–™ç¡®å®šä½ æ‰€åœ¨åœ°åŒºçš„å…·ä½“æƒ…å†µï¼Œé“¾æ¥æ˜¯ï¼šhttps://secure.wikimedia.org/wikipedia/en/wiki/Daylight_saving_time_around_the_world åŸæ–‡é“¾æ¥ï¼šcrontrigger","categories":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/categories/Middleware/"},{"name":"Quartz","slug":"Middleware/Quartz","permalink":"http://throwable.club/blog/categories/Middleware/Quartz/"}],"tags":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/tags/Middleware/"},{"name":"Quartz","slug":"Quartz","permalink":"http://throwable.club/blog/tags/Quartz/"}]},{"title":"ç¬¬åäºŒç« ï¼šå…¶ä»–ç‰¹æ€§","slug":"quartz-doc-translation-lesson-12","date":"2019-03-29T17:42:40.000Z","updated":"2019-03-30T03:19:02.872Z","comments":true,"path":"2019/03/30/quartz-doc-translation-lesson-12/","link":"","permalink":"http://throwable.club/2019/03/30/quartz-doc-translation-lesson-12/","excerpt":"","text":"ç¬¬åäºŒç« ï¼šå…¶ä»–ç‰¹æ€§ æ’ä»¶ Quartzæä¾›äº†ä¸€ä¸ªç”¨äºæ’å…¥é™„åŠ åŠŸèƒ½çš„æ¥å£org.quartz.spi.SchedulerPluginã€‚ ä½ å¯ä»¥ä»org.quartz.pluginsåŒ…ä¸­æ‰¾åˆ°æä¾›å„ç§å®ç”¨åŠŸèƒ½çš„Quartzæ’ä»¶ã€‚å®ƒä»¬æä¾›è¯¸å¦‚åœ¨è°ƒåº¦å™¨å¯åŠ¨æ—¶è‡ªåŠ¨è°ƒåº¦Jobçš„åŠŸèƒ½ï¼Œè®°å½•Jobå’ŒTriggerç›¸å…³äº‹ä»¶çš„å†å²ï¼Œå¹¶ç¡®ä¿å½“JVMé€€å‡ºæ—¶è°ƒåº¦å™¨èƒ½å¤Ÿå½»åº•å…³é—­ã€‚ Jobå·¥å‚ å½“Triggerè§¦å‘æ—¶ï¼Œé€šè¿‡Schedulerä¸Šé…ç½®çš„JobFactoryå®ä¾‹åŒ–ä¸ä¹‹å…³è”çš„Jobã€‚é»˜è®¤çš„JobFactoryåªæ˜¯åœ¨Jobç±»ä¸Š(åå°„)è°ƒç”¨newInstance()ã€‚ä½ å¯èƒ½éœ€è¦åˆ›å»ºè‡ªå·±çš„JobFactoryå®ç°ï¼Œä»¥å®Œæˆè¯¸å¦‚è®©åº”ç”¨ç¨‹åºçš„IoCæˆ–DIå®¹å™¨ç”Ÿæˆ/åˆå§‹åŒ–Jobå®ä¾‹ç­‰ç­‰çš„æ“ä½œã€‚ è¯·å‚é˜…org.quartz.spi.JobFactoryæ¥å£ä»¥åŠScheduler#setJobFactory(fact)ç­‰ç›¸å…³æ–¹æ³•ã€‚ Factory-Shipped Jobs(è¿™ä¸ªä¸çŸ¥é“æ€ä¹ˆç¿»è¯‘) Quartzè¿˜æä¾›äº†è®¸å¤šå®ç”¨Jobç±»å‹ï¼Œä½ å¯ä»¥åœ¨åº”ç”¨ç¨‹åºä¸­ç”¨äºæ‰§è¡Œè¯¸å¦‚å‘é€ç”µå­é‚®ä»¶å’Œè°ƒç”¨EJBç­‰Jobå®ç°ã€‚è¿™äº›å¼€ç®±å³ç”¨çš„Jobç±»å‹å¯ä»¥åœ¨org.quartz.jobsåŒ…ä¸­æ‰¾åˆ°(è¦å¼•å…¥ä¾èµ–quartz-jobs)ã€‚ åŸæ–‡é“¾æ¥ï¼štutorial-lesson-12","categories":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/categories/Middleware/"},{"name":"Quartz","slug":"Middleware/Quartz","permalink":"http://throwable.club/blog/categories/Middleware/Quartz/"}],"tags":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/tags/Middleware/"},{"name":"Quartz","slug":"Quartz","permalink":"http://throwable.club/blog/tags/Quartz/"}]},{"title":"ç¬¬åä¸€ç« ï¼šé«˜çº§(ä¼ä¸šçº§)ç‰¹æ€§","slug":"quartz-doc-translation-lesson-11","date":"2019-03-29T17:42:36.000Z","updated":"2019-03-30T03:18:18.053Z","comments":true,"path":"2019/03/30/quartz-doc-translation-lesson-11/","link":"","permalink":"http://throwable.club/2019/03/30/quartz-doc-translation-lesson-11/","excerpt":"","text":"ç¬¬åä¸€ç« ï¼šé«˜çº§(ä¼ä¸šçº§)ç‰¹æ€§ é›†ç¾¤ Quartzé›†ç¾¤ç›®å‰ä¸JDBC-Jobstoreï¼ˆJobStoreTXæˆ–JobStoreCMTï¼‰å’Œ(&lt;â€“è¯‘è€…æ³¨ï¼šå…¶å®æˆ‘è§‰å¾—è¿™é‡Œåº”è¯¥æ˜¯&quot;æˆ–&quot;)TerracottaJobStoreä¸€èµ·ä½¿ç”¨ã€‚åŠŸèƒ½åŒ…æ‹¬è´Ÿè½½å‡è¡¡å’ŒJobæ•…éšœè½¬ç§»ï¼ˆå¦‚æœJobDetailçš„â€œè¯·æ±‚æ¢å¤(request recovery)â€æ ‡å¿—è®¾ç½®ä¸ºtrueï¼‰ã€‚ ä½¿ç”¨JobStoreTXæˆ–JobStoreCMTé€šè¿‡å°†org.quartz.jobStore.isClusteredå±æ€§è®¾ç½®ä¸ºtrueæ¥å¯ç”¨é›†ç¾¤æ¨¡å¼ã€‚**é›†ç¾¤ä¸­çš„æ¯ä¸ªå®ä¾‹éƒ½åº”è¯¥ä½¿ç”¨ç›¸åŒçš„quartz.propertiesæ–‡ä»¶ã€‚**è¿™äº›ç›¸åŒçš„é…ç½®æ–‡ä»¶ä¸­ï¼Œä¹Ÿå…è®¸ä¸‹é¢å‡ é¡¹å±æ€§é…ç½®æ˜¯å¯ä»¥ä¸ç›¸åŒçš„ï¼šä¸åŒçš„çº¿ç¨‹æ± å¤§å°ï¼Œä»¥åŠorg.quartz.scheduler.instanceIdè®¾ç½®ä¸åŒçš„å±æ€§å€¼ã€‚é›†ç¾¤ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹å¿…é¡»å…·æœ‰å”¯ä¸€çš„instanceIdï¼Œé€šè¿‡å°†AUTOä½œä¸ºæ­¤å±æ€§çš„å€¼ï¼Œå¯ä»¥è½»æ¾å®Œæˆæ­¤å®šä¹‰ï¼ˆè¿™æ ·å°±ä¸éœ€è¦ä½¿ç”¨ä¸åŒçš„é…ç½®æ–‡ä»¶ï¼‰ã€‚ä¸‹é¢æ˜¯æ³¨æ„äº‹é¡¹ï¼š 1ä¸è¦åœ¨å„è‡ªç‹¬ç«‹çš„æœºå™¨ä¸Šå„è‡ªå¼€å¯é›†ç¾¤æ¨¡å¼ï¼Œé™¤éå®ƒä»¬çš„æ—¶é’Ÿä½¿ç”¨æŸç§å½¢å¼çš„æ—¶é—´åŒæ­¥æœåŠ¡ï¼ˆå®ˆæŠ¤è¿›ç¨‹ï¼‰è¿›è¡ŒåŒæ­¥ï¼Œè€Œè¿™äº›æ—¶é—´åŒæ­¥æœåŠ¡ï¼ˆå®ˆæŠ¤è¿›ç¨‹ï¼‰è¿è¡Œå¾—éå¸¸æœ‰è§„å¾‹ï¼ˆå„ä¸ªæœºå™¨çš„æ—¶é’Ÿå·®è·å¿…é¡»åœ¨ä¸€ç§’å†…ï¼‰ã€‚ å¦‚æœä½ ä¸ç†Ÿæ‚‰å¦‚ä½•æ‰§è¡Œæ­¤æ“ä½œï¼Œ è¯·å‚é˜…`http://www.boulder.nist.gov/timefreq/service/its.htm`ã€‚ 1éé›†ç¾¤æ¨¡å¼ä¸‹ï¼Œä¸¤ä¸ªä¸åŒçš„å®ä¾‹åƒä¸‡ä¸è¦ä½¿ç”¨åŒä¸€å¥—Quartzçš„è¡¨ã€‚å¦åˆ™ï¼Œä½ ä¸€å®šä¼šé‡åˆ°ä¸æ­£å¸¸çš„(è°ƒåº¦)è¡Œä¸ºï¼Œæœ‰å¯èƒ½ä¼šé­é‡ä¸¥é‡çš„æ•°æ®æŸåã€‚ é›†ç¾¤ä¸­è§¦å‘æœºåˆ¶æ˜¯ï¼šJobæ¯æ¬¡åªèƒ½è¢«ä¸€ä¸ªèŠ‚ç‚¹è§¦å‘(ä¹Ÿå°±æ˜¯è™½ç„¶é›†ç¾¤ä¸­æ¯å°æœºå™¨éƒ½è·‘ç€Quartzçš„è°ƒåº¦å™¨ï¼Œä½†æ˜¯Jobéœ€è¦è¢«è§¦å‘çš„æ—¶åˆ»åªæœ‰ä¸€å°æœºå™¨ä¼šè¿›è¡Œè§¦å‘)ã€‚æˆ‘çš„æ„æ€æ˜¯ï¼Œå¦‚æœJobæœ‰ä¸€ä¸ªé‡å¤çš„Triggerï¼Œå‘Šè¯‰å®ƒæ¯10ç§’é’Ÿè§¦å‘ä¸€æ¬¡ï¼Œé‚£ä¹ˆåœ¨12:00:00ï¼Œæ­£å¥½ä¸€ä¸ªèŠ‚ç‚¹å°†æ‰§è¡Œè¿™ä¸ªJobï¼Œåœ¨12:00:10ï¼Œä¹Ÿæ˜¯ç”±ä¸€ä¸ªèŠ‚ç‚¹å°†æ‰§è¡Œæ­¤Jobç­‰ã€‚å¹¶ä¸ä¸€å®šæ˜¯æ¯æ¬¡ç”±ç›¸åŒçš„èŠ‚ç‚¹æ‰§è¡ŒJob - ç”±å“ªä¸ªèŠ‚ç‚¹æ‰§è¡Œå®ƒæ˜¯éšæœºçš„ã€‚è´Ÿè½½å‡è¡¡æœºåˆ¶å¯¹äºç¹å¿™çš„è°ƒåº¦ç¨‹åºï¼ˆå¤§é‡çš„Triggerï¼‰æ¥è¯´æ˜¯è¿‘ä¹éšæœºçš„ã€‚ä½†æ˜¯å¯¹äºéç¹å¿™(åªæœ‰ä¸€ä¸¤ä¸ªTrigger)çš„è°ƒåº¦å™¨é›†ç¾¤æ¥è¯´ï¼Œæœ‰å¯èƒ½åå‘äºç”±åŒä¸€ä¸ªèŠ‚ç‚¹æ‰§è¡Œã€‚(è¯‘è€…æ³¨ï¼šå…¶å®ä»æºç ä¸Šçœ‹ï¼Œä¸»è¦æ˜¯çœ‹å“ªä¸ªèŠ‚ç‚¹å…ˆè·å–åˆ°ç‹¬å é”ã€‚) ä½¿ç”¨TerracottaJobStoreå»ºç«‹Quartzé›†ç¾¤åªéœ€è¦å°†æŠŠSchedulerçš„JobStoreé…ç½®ä¸ºTerracottaJobStoreï¼ˆç¬¬ä¹ç« ï¼šJobStoresä¸­ä»‹ç»è¿‡ï¼‰å³å¯ï¼Œç„¶åä½ çš„è°ƒåº¦å™¨å°±ä¼šè¢«è®¾ç½®ä¸ºé›†ç¾¤æ¨¡å¼ã€‚ æ‚¨å¯èƒ½è¿˜éœ€è¦è€ƒè™‘å¦‚ä½•è®¾ç½®TerracottaæœåŠ¡å™¨ï¼Œç‰¹åˆ«æ˜¯å¼€å¯æŒä¹…åŒ–ç‰¹æ€§ç­‰åŠŸèƒ½çš„é…ç½®é€‰é¡¹ï¼Œä»¥åŠæ­å»ºä¸€äº›åˆ—é«˜å¯ç”¨çš„TerracottaæœåŠ¡å™¨ã€‚ TerracottaJobStoreçš„ä¼ä¸šç‰ˆæä¾›äº†é«˜çº§çš„&quot;Quartz Where&quot;åŠŸèƒ½ï¼Œå…è®¸å°†ä½œä¸šçš„æ™ºèƒ½å®šä½åˆ°é€‚å½“çš„Quartzé›†ç¾¤èŠ‚ç‚¹ã€‚ æœ‰å…³JobStoreå’ŒTerracottaçš„æ›´å¤šä¿¡æ¯ï¼Œè¯·è®¿é—®http://www.terracotta.org/quartzã€‚ JTAäº‹åŠ¡ æ­£å¦‚ç¬¬ä¹ç« ï¼šJobStoresæ‰€è¿°ï¼ŒJobStoreCMTå…è®¸åœ¨è¾ƒå¤§çš„JTAäº‹åŠ¡ä¸­æ‰§è¡ŒQuartzè°ƒåº¦æ“ä½œã€‚ é€šè¿‡å°†org.quartz.scheduler.wrapJobExecutionInUserTransactionå±æ€§è®¾ç½®ä¸ºtrueï¼ŒJobä¹Ÿå¯ä»¥åœ¨JTAäº‹åŠ¡ï¼ˆUserTransactionï¼‰å†…æ‰§è¡Œã€‚ä½¿ç”¨æ­¤é€‰é¡¹é›†ï¼Œä¸€ä¸ªJTAäº‹åŠ¡å°†åœ¨Jobçš„executeæ–¹æ³•è¢«è°ƒç”¨ä¹‹å‰è°ƒç”¨å…¶begin()æ–¹æ³•ï¼Œå¹¶ä¸”åœ¨Jobæ‰§è¡Œå®Œæˆè°ƒç”¨ä¹‹åè°ƒç”¨å…¶commit()ã€‚è¿™é€‚ç”¨äºæ‰€æœ‰çš„Jobã€‚ å¦‚æœä½ å¸Œæœ›æŒ‡å®šæ¯ä¸ªJobsæ˜¯å¦åŒ…è£¹åœ¨JTAäº‹åŠ¡å†…æ‰§è¡Œï¼Œé‚£ä¹ˆä½ åº”è¯¥åœ¨Jobç±»ä¸Šä½¿ç”¨@ExecuteInJTATransactionæ³¨è§£ã€‚ é™¤äº†Quartzè‡ªåŠ¨å°†Jobæ‰§è¡ŒåŒ…è£…åˆ°JTAäº‹åŠ¡ä¸­ï¼Œä½¿ç”¨JobStoreCMTä¹‹ååœ¨Scheduleræ¥å£æ–¹æ³•ä¹Ÿå¯ä»¥ä½¿ç”¨äº‹åŠ¡å¤„ç†ã€‚ä½ å¯ä»¥æ˜ç¡®ä¸€ç‚¹ï¼šåœ¨ä½¿ç”¨Scheduleræ¥å£æ–¹æ³•ä¹‹å‰å·²ç»å¼€å¯äº†ä¸€ä¸ªäº‹åŠ¡ã€‚ä½ å¯ä»¥ç›´æ¥é€šè¿‡ä½¿ç”¨UserTransactionæˆ–å°†ä½¿ç”¨è°ƒåº¦ç¨‹åºçš„ä»£ç æ”¾åœ¨ä½¿ç”¨å®¹å™¨ç®¡ç†äº‹åŠ¡çš„SessionBeanä¸­æ¥æ‰§è¡Œæ­¤æ“ä½œã€‚ åŸæ–‡é“¾æ¥ï¼štutorial-lesson-11","categories":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/categories/Middleware/"},{"name":"Quartz","slug":"Middleware/Quartz","permalink":"http://throwable.club/blog/categories/Middleware/Quartz/"}],"tags":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/tags/Middleware/"},{"name":"Quartz","slug":"Quartz","permalink":"http://throwable.club/blog/tags/Quartz/"}]},{"title":"ç¬¬åç« ï¼šé…ç½®ã€èµ„æºçš„ä½¿ç”¨ä»¥åŠSchedulerFactory","slug":"quartz-doc-translation-lesson-10","date":"2019-03-29T17:42:32.000Z","updated":"2019-03-30T03:17:00.978Z","comments":true,"path":"2019/03/30/quartz-doc-translation-lesson-10/","link":"","permalink":"http://throwable.club/2019/03/30/quartz-doc-translation-lesson-10/","excerpt":"","text":"ç¬¬åç« ï¼šé…ç½®ã€èµ„æºçš„ä½¿ç”¨ä»¥åŠSchedulerFactory Quartzçš„æ¶æ„è®¾è®¡æ˜¯æ¨¡å—åŒ–çš„ï¼Œå› æ­¤è¦è¿è¡Œå®ƒéœ€è¦æŠŠå‡ ä¸ªç»„ä»¶ç»„åˆåœ¨ä¸€èµ·ä½¿ç”¨ã€‚å¹¸è¿çš„æ˜¯ï¼Œæœ‰ä¸€äº›å·¥å…·å°±æ˜¯ä¸ºäº†å®Œæˆè¿™ä¸ªç›®æ ‡ã€‚ Quartzåœ¨èƒ½å¤Ÿæ­£å¸¸è¿ä½œä¹‹å‰ï¼Œä¸‹é¢çš„å‡ ä¸ªæ ¸å¿ƒç»„ä»¶å¿…é¡»é…ç½®å¥½ï¼š ThreadPool JobStore DataSources(å¦‚æœéœ€è¦çš„è¯) Scheduler(è°ƒåº¦å™¨æœ¬èº«ï¼Œè¿™ä¸ªæ˜¯æ ¸å¿ƒ) çº¿ç¨‹æ± æä¾›äº†ä¸€ç»„Quartzåœ¨æ‰§è¡ŒJobæ—¶ä½¿ç”¨çš„çº¿ç¨‹ã€‚çº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹è¶Šå¤šï¼Œå¹¶å‘è¿è¡Œçš„Jobæ•°è¶Šå¤šã€‚ä½†æ˜¯ï¼Œå¤ªå¤šçš„çº¿ç¨‹å¯èƒ½ä¼šç ´åä½ çš„ç³»ç»Ÿã€‚å¤§å¤šæ•°Quartzçš„ç”¨æˆ·å‘ç°ï¼Œ5ä¸ªå·¦å³çš„çº¿ç¨‹æ˜¯å……è¶³çš„ - å› ä¸ºåœ¨ä»»ä½•ç»™å®šæ—¶é—´ï¼Œä»–ä»¬çš„Jobæ•°é‡å°‘äº100ä¸ªï¼Œé€šå¸¸ä¸ä¼šåŒæ—¶è¿è¡Œè¿™äº›Jobï¼Œè€Œä¸”è¿™äº›Jobæ˜¯çŸ­æš‚çš„ï¼ˆå¿«é€Ÿå®Œæˆï¼‰ã€‚å…¶ä»–ç”¨æˆ·è®¤ä¸ºä»–ä»¬éœ€è¦10ä¸ªï¼Œ15ä¸ªï¼Œ50ä¸ªç”šè‡³100ä¸ªçº¿ç¨‹ï¼Œå› ä¸ºä»–ä»¬å…·æœ‰æ•°ä¸‡ä¸ªå…·æœ‰å„ç§è°ƒåº¦è®¡åˆ’çš„Triggerï¼Œæœ€ç»ˆåœ¨ä»»ä½•ç»™å®šæ—¶åˆ»å¹³å‡æ‰§è¡Œ10åˆ°100ä¸ªJobã€‚ä¸ºè°ƒåº¦å™¨çš„çº¿ç¨‹æ± æ‰¾åˆ°æ­£ç¡®çš„çº¿ç¨‹æ± å¤§å°å®Œå…¨å–å†³äºä½ éœ€è¦ä½¿ç”¨è°ƒåº¦å™¨æ¥å®Œæˆä»€ä¹ˆå·¥ä½œ(è¿™é‡Œæ„æ€åº”è¯¥æ˜¯éœ€è¦æŒ‰ç…§å·¥ä½œé‡å»å®šä¹‰çº¿ç¨‹æ± å¤§å°)ã€‚æ²¡æœ‰çœŸæ­£çš„è§„åˆ™ï¼Œé™¤äº†ä¿æŒçº¿ç¨‹æ•°é‡å°½å¯èƒ½å°ï¼ˆä¸ºäº†ä½ æ˜‚è´µçš„æœåŠ¡å™¨èµ„æºï¼‰ - ä½†éœ€è¦ç¡®ä¿çº¿ç¨‹æ•°é‡å·²è¶³å¤Ÿè®©ä½ çš„JobæŒ‰æ—¶å¯åŠ¨ã€‚è¯·æ³¨æ„ï¼Œå¦‚æœTriggerçš„è§¦å‘æ—¶é—´åˆ°è¾¾ï¼Œå¹¶ä¸”çº¿ç¨‹æ± ä¸­æ²¡æœ‰å¯ç”¨çš„çº¿ç¨‹ï¼ŒQuartzå°†é˜»å¡ï¼ˆæš‚åœï¼‰ç›´åˆ°çº¿ç¨‹å¯ç”¨ï¼Œç„¶åJobå°†æ‰§è¡Œ - ä¹Ÿå°±æ˜¯åœ¨å®ƒæœ¬è¯¥æ‰§è¡Œçš„æ—¶é—´ç‚¹å»¶åä¸€ä¸ªæ—¶é—´æ®µæ‰§è¡Œã€‚è¿™ç”šè‡³å¯èƒ½å¯¼è‡´çº¿ç¨‹çš„é”™è¿‡è§¦å‘ - å¦‚æœåœ¨è°ƒåº¦å™¨ä¸­é…ç½®çš„â€œé”™è¿‡è§¦å‘é˜ˆå€¼â€çš„æŒç»­æ—¶é—´å†…æ²¡æœ‰å¯ç”¨çš„çº¿ç¨‹ã€‚ ThreadPoolæ¥å£åœ¨org.quartz.spiåŒ…ä¸­å®šä¹‰ï¼Œä½ å¯ä»¥æŒ‰ç…§ä½ å–œæ¬¢çš„æ–¹å¼åˆ›å»ºThreadPoolå®ç°ã€‚Quartzå¸¦æœ‰ä¸€ä¸ªåä¸ºorg.quartz.simpl.SimpleThreadPoolï¼ˆè™½ç„¶ç®€å•ï¼Œä½†éå¸¸ä»¤äººæ»¡æ„ï¼‰çš„çº¿ç¨‹æ± ã€‚è¿™ä¸ªThreadPoolåªæ˜¯åœ¨å®ƒçš„çº¿ç¨‹æ± ä¸­ç»´æŠ¤ä¸€ä¸ªå›ºå®šçš„çº¿ç¨‹é›† - æ°¸è¿œä¸ä¼šå¢é•¿ï¼Œæ°¸è¿œä¸ä¼šç¼©å°ã€‚ä½†æ˜¯å®ƒæ˜¯éå¸¸å¼ºå¤§çš„ï¼Œæµ‹è¯•ç»“æœä»¤äººæ»¡æ„ - å‡ ä¹æ‰€æœ‰ä½¿ç”¨Quartzçš„äººéƒ½ä½¿ç”¨è¿™ä¸ªçº¿ç¨‹æ± ã€‚ JobStoreså’ŒDataSourceåœ¨æœ¬æ•™ç¨‹çš„ç¬¬ä¹ç« ï¼šJobStoresè®¨è®ºè¿‡ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œæ‰€æœ‰JobStoreéƒ½å®ç°äº†org.quartz.spi.JobStoreæ¥å£ - ä»»ä½•ä¸€ä¸ªJobStoreå®ç°éƒ½ä¸ç¬¦åˆä½ çš„éœ€æ±‚ï¼Œé‚£ä¹ˆä½ å¯ä»¥è‡ªå·±åˆ›å»ºå¹¶ä¸”è‡ªè¡Œå®ç°org.quartz.spi.JobStoreæ¥å£ã€‚ æœ€åï¼Œä½ éœ€è¦åˆ›å»ºä½ çš„Schedulerå®ä¾‹ã€‚Scheduleræœ¬èº«éœ€è¦è¢«èµ‹äºˆä¸€ä¸ªåå­—ï¼Œå‘Šè¯‰å…¶RMIè®¾ç½®ï¼Œå¹¶ä¸”è®¾ç½®JobStoreå’ŒThreadPoolçš„å®ä¾‹ã€‚RMIè®¾ç½®åŒ…æ‹¬è°ƒåº¦ç¨‹åºæ˜¯å¦åº”å°†è‡ªèº«åˆ›å»ºä¸ºRMIçš„æœåŠ¡å™¨å¯¹è±¡ï¼ˆä½¿å…¶å¯ç”¨äºè¿œç¨‹è¿æ¥ï¼‰ï¼Œè¦ä½¿ç”¨çš„ä¸»æœºå’Œç«¯å£ç­‰ã€‚StdSchedulerFactoryï¼ˆä¸‹é¢å°†è®¨è®ºï¼‰è¿˜å¯ä»¥åˆ›å»ºSchedulerå®ä¾‹ï¼Œè¿™äº›Schedulerå®ä¾‹å¯ä»¥æ˜¯åˆ›å»ºåœ¨è¿œç¨‹ç¨‹åºä¸­çš„Schedulerçš„ä»£ç†(RMIå­˜æ ¹)ã€‚ StdSchedulerFactory StdSchedulerFactoryæ˜¯org.quartz.SchedulerFactoryæ¥å£çš„ä¸€ä¸ªå®ç°ã€‚å®ƒä½¿ç”¨ä¸€ç»„å±æ€§ï¼ˆjava.util.Propertiesï¼‰æ¥åˆ›å»ºå’Œåˆå§‹åŒ–Quartzçš„Schedulerå®ä¾‹ã€‚å±æ€§é€šå¸¸å­˜å‚¨åœ¨æ–‡ä»¶ä¸­å¹¶ä»æ–‡ä»¶ä¸­åŠ è½½ï¼Œä½†ä¹Ÿå¯ä»¥ç”±ç¨‹åºåˆ›å»ºå¹¶ç›´æ¥ä¼ é€’åˆ°å·¥å‚ç±»å®ä¾‹ã€‚ç®€å•åœ°è°ƒç”¨å·¥å‚ä¸­çš„getScheduler()å°†ç”ŸæˆSchedulerå®ä¾‹ï¼Œå¹¶åˆå§‹åŒ–å®ƒï¼ˆå’Œå®ƒçš„ThreadPoolï¼ŒJobStoreå’ŒDataSourceï¼‰å¹¶è¿”å›ä¸€ä¸ªå…¬å…±æ¥å£org.quartz.Schedulerçš„å¥æŸ„ã€‚ åœ¨Quartzå‘è¡Œç‰ˆçš„&quot;docs/config&quot;ç›®å½•ä¸­æœ‰ä¸€äº›ç¤ºä¾‹é…ç½®ï¼ˆåŒ…æ‹¬å±æ€§çš„æè¿°ï¼‰ã€‚ä½ å¯ä»¥åœ¨Quartzæ–‡æ¡£çš„â€œå‚è€ƒâ€éƒ¨åˆ†çš„â€œé…ç½®â€æ‰‹å†Œä¸­æ‰¾åˆ°å®Œæ•´çš„æ–‡æ¡£ã€‚ DirectSchedulerFactory DirectSchedulerFactoryæ˜¯å¦ä¸€ä¸ªSchedulerFactoryå®ç°ã€‚å¯¹äºå¸Œæœ›ç¼–ç¨‹å¼åˆ›å»ºå…¶Schedulerå®ä¾‹çš„ç”¨æˆ·æ˜¯æœ‰ç”¨çš„ã€‚é€šå¸¸ä¸é¼“åŠ±ä½¿ç”¨å®ƒï¼ŒåŸå› å¦‚ä¸‹ï¼š ï¼ˆ1ï¼‰DirectSchedulerFactoryè¦æ±‚ç”¨æˆ·æ›´å¥½åœ°äº†è§£ä»–ä»¬æ­£åœ¨åšä»€ä¹ˆã€‚ ï¼ˆ2ï¼‰å®ƒä¸å…è®¸å£°æ˜æ€§é…ç½®(ä¸èƒ½ä½¿ç”¨é…ç½®æ–‡ä»¶) - æ¢å¥è¯è¯´ï¼Œä½ éœ€è¦ç¡¬ç¼–ç Schedulerå®ä¾‹çš„æ‰€æœ‰å±æ€§é¡¹ã€‚ æ—¥å¿— Quartzä½¿ç”¨SLF4Jæ¡†æ¶æ¥æ»¡è¶³æ‰€æœ‰çš„æ—¥å¿—è®°å½•éœ€æ±‚ã€‚ä¸ºäº†â€œè°ƒæ•´â€æ—¥å¿—è®°å½•è®¾ç½®ï¼ˆä¾‹å¦‚è¾“å‡ºé‡ä»¥åŠè¾“å‡ºä½ç½®ï¼‰ï¼Œä½ éœ€è¦äº†è§£SLF4Jæ¡†æ¶ï¼Œè¿™è¶…å‡ºäº†æœ¬æ–‡æ¡£çš„èŒƒå›´ã€‚ å¦‚æœéœ€è¦æ•è·Triggerå¯åŠ¨å’ŒJobæ‰§è¡Œçš„é¢å¤–ä¿¡æ¯ï¼Œå¯ä»¥å¯ç”¨org.quartz.plugins.history.LoggingJobHistoryPluginæˆ–org.quartz.plugins.history.LoggingTriggerHistoryPluginã€‚ åŸæ–‡é“¾æ¥ï¼štutorial-lesson-10","categories":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/categories/Middleware/"},{"name":"Quartz","slug":"Middleware/Quartz","permalink":"http://throwable.club/blog/categories/Middleware/Quartz/"}],"tags":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/tags/Middleware/"},{"name":"Quartz","slug":"Quartz","permalink":"http://throwable.club/blog/tags/Quartz/"}]},{"title":"ç¬¬ä¹ç« ï¼šJobStores","slug":"quartz-doc-translation-lesson-9","date":"2019-03-29T17:42:29.000Z","updated":"2019-03-30T03:14:52.702Z","comments":true,"path":"2019/03/30/quartz-doc-translation-lesson-9/","link":"","permalink":"http://throwable.club/2019/03/30/quartz-doc-translation-lesson-9/","excerpt":"","text":"ç¬¬ä¹ç« ï¼šJobStores JobStoreè´Ÿè´£è®°å½•ä½ æä¾›åˆ°è°ƒåº¦å™¨çš„æ‰€æœ‰â€œå·¥ä½œæ•°æ®â€ï¼šæ‰€æœ‰çš„Jobã€æ‰€æœ‰çš„Triggerã€æ‰€æœ‰çš„Calendar(org.quartz.Calendar)ç­‰ç­‰ã€‚ä¸ºä½ çš„Quartzè°ƒåº¦å™¨é€‰æ‹©ä¸€ä¸ªåˆé€‚çš„JobStoreæ˜¯ä¸€ä¸ªé‡è¦çš„æ­¥éª¤ã€‚å¹¸è¿çš„æ˜¯ï¼Œä¸€æ—¦ä½ æ˜ç™½ä¸åŒçš„JobStoreä¹‹é—´çš„å·®å¼‚ï¼Œé‚£ä¹ˆä½œå‡ºåˆé€‚çš„é€‰æ‹©æ˜¯ååˆ†ç®€å•çš„ã€‚ ä½ å£°æ˜ä½ æä¾›ç»™ç”¨äºç”Ÿæˆè°ƒåº¦å™¨å®ä¾‹å¯¹åº”çš„SchedulerFactoryå®ä¾‹æ—¶å€™ç”¨åˆ°çš„å±æ€§æ–‡ä»¶ï¼ˆæˆ–å¯¹è±¡ï¼‰ä¸­ï¼Œåº”è¯¥æŒ‡å®šä½ çš„è°ƒåº¦å™¨åº”ä½¿ç”¨å“ªä¸ªç±»å‹çš„JobStoreï¼ˆä»¥åŠå®ƒçš„ç›¸å…³é…ç½®ï¼‰ã€‚æ³¨æ„ä¸€ç‚¹ï¼š 1åˆ‡å‹¿åœ¨ä»£ç ä¸­ç›´æ¥ä½¿ç”¨JobStoreå®ä¾‹ã€‚ç”±äºæŸäº›åŸå› ï¼Œè®¸å¤šä½¿ç”¨è€…è¯•å›¾è¿™æ ·åšã€‚JobStoreåº”è¯¥åªç”¨äºQuartzçš„åå°ã€‚ä½ å¿…é¡»å‘Šè¯‰Quartzï¼ˆé€šè¿‡é…ç½®ï¼‰ä½¿ç”¨å“ªä¸ªç±»å‹çš„JobStoreï¼Œä½ åœ¨ä»£ç ä¸­åº”è¯¥åªèƒ½ä½¿ç”¨Scheduleræ¥å£ã€‚ RAMJobStore RAMJobStoreæ˜¯ä½¿ç”¨æœ€ç®€å•çš„JobStoreï¼Œå®ƒä¹Ÿæ˜¯æ€§èƒ½æœ€é«˜çš„ï¼ˆåœ¨CPUæ—¶é—´æ–¹é¢ï¼‰ã€‚RAMJobStoreçš„åŠŸèƒ½æ˜¾ç„¶å’Œå®ƒçš„åå­—ç›¸å…³ï¼šå®ƒå°†å…¶æ‰€æœ‰æ•°æ®ä¿å­˜åœ¨RAM(å†…å­˜)ä¸­ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆå®ƒæ˜¯é—ªç”µèˆ¬çš„å¿«ï¼Œä¹Ÿæ˜¯ä¸ºä»€ä¹ˆå®ƒçš„çš„é…ç½®è¿™ä¹ˆç®€å•ã€‚ç¼ºç‚¹æ˜¯å½“ä½ çš„åº”ç”¨ç¨‹åºç»“æŸï¼ˆæˆ–å´©æºƒï¼‰æ—¶ï¼Œæ‰€æœ‰è°ƒåº¦ä¿¡æ¯éƒ½å°†ä¸¢å¤± - è¿™æ„å‘³ç€RAMJobStoreæ— æ³•å±¥è¡Œä½œä¸šå’ŒTriggerä¸Šçš„â€œéæ˜“å¤±æ€§â€è®¾ç½®ã€‚å¯¹äºæŸäº›åº”ç”¨ç¨‹åºï¼Œè¿™æ˜¯å¯ä»¥æ¥å—çš„ - ç”šè‡³æ˜¯æ‰€éœ€çš„è¡Œä¸ºï¼Œä½†å¯¹äºå…¶ä»–åº”ç”¨ç¨‹åºï¼Œè¿™å¯èƒ½æ˜¯ç¾éš¾æ€§çš„ã€‚ è¦ä½¿ç”¨RAMJobStoreï¼ˆå¹¶å‡è®¾æ‚¨ä½¿ç”¨çš„æ˜¯StdSchedulerFactoryï¼‰ï¼Œåªéœ€å°†Quartzçš„JobStoreç±»å±æ€§é…ç½®æŒ‡å®šä¸ºorg.quartz.simpl.RAMJobStoreï¼š 1org.quartz.jobStore.class = org.quartz.simpl.RAMJobStore é™¤æ­¤ä¹‹å¤–æ²¡æœ‰å…¶ä»–éœ€è¦æ‹…å¿ƒçš„é…ç½®é¡¹ã€‚ JDBCJobStore JDBCJobStoreçš„å‘½åä¹Ÿç›¸å½“æ°å½“ - å®ƒé€šè¿‡JDBCå°†å…¶æ‰€æœ‰æ•°æ®ä¿å­˜åœ¨æ•°æ®åº“ä¸­ã€‚å› æ­¤ï¼Œå®ƒé…ç½®æ¯”RAMJobStoreè¦å¤æ‚ä¸€ç‚¹ï¼Œè€Œä¸”ä¹Ÿä¸æ˜¯é‚£ä¹ˆå¿«ã€‚ä½†æ˜¯ï¼Œå®ƒæ€§èƒ½ä¸‹é™å¹¶ä¸æ˜¯å¾ˆç³Ÿç³•ï¼Œç‰¹åˆ«æ˜¯å¦‚æœä½ ä½¿ç”¨çš„æ•°æ®åº“è¡¨åœ¨ç›¸åº”çš„ä¸»é”®æˆ–è€…å¤–é”®åŠ ä¸Šç´¢å¼•ã€‚åœ¨ç›¸å¯¹ä¸»æµçš„å¹¶ä¸”æœ‰ä¸€ä¸ªåƒæ ·çš„å±€åŸŸç½‘ï¼ˆåœ¨è°ƒåº¦å™¨å’Œæ•°æ®åº“ä¹‹é—´ï¼‰çš„æœºå™¨ä¸Šï¼Œæ£€ç´¢å’Œæ›´æ–°ä¸€ä¸ªè§¦å‘ä¸­çš„Triggerçš„æ—¶é—´é€šå¸¸å°†å°äº10æ¯«ç§’ã€‚ JDBCJobStoreå‡ ä¹å¯ä»¥åœ¨ä»»ä½•ç±»å‹çš„ä»»ä½•æ•°æ®åº“ä¸­ä½¿ç”¨ï¼Œå·²è¢«å¹¿æ³›åº”ç”¨äºOracleï¼ŒPostgreSQLï¼ŒMySQLï¼ŒMS SQLServerï¼ŒHSQLDBå’ŒDB2ã€‚è¦ä½¿ç”¨JDBCJobStoreï¼Œå¿…é¡»é¦–å…ˆåˆ›å»ºä¸€ç»„æ•°æ®åº“è¡¨ä»¥ä¾›Quartzä½¿ç”¨ã€‚ä½ å¯ä»¥åœ¨Quartzå‘è¡Œç‰ˆçš„&quot;docs/dbTables&quot;ç›®å½•ä¸­æ‰¾åˆ°è¡¨åˆ›å»ºSQLè„šæœ¬ã€‚å¦‚æœä½ çš„æ•°æ®åº“ç±»å‹å°šæœªæœ‰è„šæœ¬ï¼Œè¯·æŸ¥çœ‹å…¶ä¸­ä¸€ä¸ªè„šæœ¬ï¼Œç„¶åä»¥æ•°æ®åº“æ‰€éœ€çš„ä»»ä½•æ–¹å¼è¿›è¡Œä¿®æ”¹ã€‚éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œåœ¨è¿™äº›è„šæœ¬ä¸­ï¼Œæ‰€æœ‰çš„è¡¨éƒ½ä»¥å‰ç¼€&quot;QRTZ_â€œå¼€å§‹ï¼ˆå¦‚è¡¨&quot;QRTZ_TRIGGERS&quot;å’Œ&quot;QRTZ_JOB_DETAILâ€ï¼‰ã€‚ä½ å¯ä»¥é€šçŸ¥JDBCJobStoreè¡¨çš„å‰ç¼€æ˜¯ä»€ä¹ˆï¼ˆåœ¨ä½ çš„Quartzå±æ€§é…ç½®ä¸­ï¼‰ï¼Œä¹Ÿå°±æ˜¯ä½ ä¹Ÿå¯ä»¥ä¿®æ”¹è¿™ä¸ªè¡¨å‰ç¼€çš„å€¼ã€‚å¯¹äºå¤šä¸ªè°ƒåº¦ç¨‹åºå®ä¾‹ï¼Œä½¿ç”¨ä¸åŒçš„å‰ç¼€å¯èƒ½æœ‰åŠ©äºåŒä¸€ä¸ªæ•°æ®åº“ä¸­çš„å¤šä¸ªè°ƒåº¦å™¨å®ä¾‹åˆ›å»ºå¤šç»„è¡¨ã€‚ åˆ›å»ºè¡¨åï¼Œåœ¨é…ç½®å’Œå¯åŠ¨JDBCJobStoreä¹‹å‰ï¼Œä½ è¿˜æœ‰ä¸€ä¸ªé‡è¦çš„å†³å®šã€‚ä½ éœ€è¦ç¡®å®šåº”ç”¨ç¨‹åºéœ€è¦å“ªç§ç±»å‹çš„äº‹åŠ¡ã€‚å¦‚æœä½ ä¸éœ€è¦å°†è°ƒåº¦å‘½ä»¤ï¼ˆä¾‹å¦‚æ·»åŠ å’Œåˆ é™¤Triggerï¼‰ç»‘å®šåˆ°å…¶ä»–ä»£ç é€»è¾‘çš„äº‹åŠ¡ä¸­ï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡ä½¿ç”¨JobStoreTXå¯¹JobStoreè¿›è¡Œäº‹åŠ¡ç®¡ç†ï¼ˆè¿™æ˜¯æœ€å¸¸è§çš„é€‰æ‹©ï¼‰ã€‚ å¦‚æœä½ éœ€è¦Quartzä¸å…¶ä»–äº‹åŠ¡ï¼ˆå³J2EEåº”ç”¨ç¨‹åºæœåŠ¡å™¨ï¼‰ä¸€èµ·å·¥ä½œï¼Œé‚£ä¹ˆä½ åº”è¯¥ä½¿ç”¨JobStoreCMT - åœ¨è¿™ç§æƒ…å†µä¸‹ï¼ŒQuartzå°†è®©åº”ç”¨ç¨‹åºæœåŠ¡å™¨å®¹å™¨ç®¡ç†äº‹åŠ¡ã€‚ æœ€åä¸€ä¸ªéš¾é¢˜æ˜¯è®¾ç½®ä¸€ä¸ªDataSourceï¼Œä½¿å¾—JDBCJobStoreå¯ä»¥ä»ä¸­è·å–æ•°æ®åº“çš„è¿æ¥ã€‚å®šä¹‰Quartzçš„DataSourceæœ‰ä¸‹é¢çš„å‡ ç§æ–¹å¼ã€‚ä¸€ç§æ–¹æ³•æ˜¯è®©Quartzåˆ›å»ºå’Œç®¡ç†DataSourceæœ¬èº« - é€šè¿‡æä¾›æ•°æ®åº“çš„æ‰€æœ‰è¿æ¥ä¿¡æ¯ã€‚å¦ä¸€ç§æ–¹æ³•æ˜¯é€šè¿‡æä¾›JDBCJobStoreçš„DataSourceçš„JNDIåç§°ï¼Œè®©Quartzä½¿ç”¨ç”±Quartzæ­£åœ¨è¿è¡Œçš„åº”ç”¨ç¨‹åºæœåŠ¡å™¨æ¥ç®¡ç†DataSourceã€‚æœ‰å…³å±æ€§çš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜…å‘è¡Œç‰ˆæœ¬ä¸­&quot;docs/config&quot;æ–‡ä»¶å¤¹ä¸­çš„ç¤ºä¾‹é…ç½®æ–‡ä»¶ã€‚ è¦ä½¿ç”¨JDBCJobStoreï¼ˆå‡è®¾ä½ ä½¿ç”¨çš„æ˜¯StdSchedulerFactoryï¼‰ï¼Œé¦–å…ˆéœ€è¦å°†Quartzé…ç½®æ–‡ä»¶ä¸­çš„çš„JobStoreç±»å±æ€§è®¾ç½®ä¸ºorg.quartz.impl.jdbcjobstore.JobStoreTXæˆ–org.quartz.impl.jdbcjobstore.JobStoreCMT - å…·ä½“å¯ä»¥å‚è€ƒä¸Šä¸€æ®µæ–‡å­—çš„æè¿°ï¼Œä¸è¿‡å†³å®šæƒè¿˜æ˜¯åœ¨ä½ æ‰‹ä¸­ã€‚ é…ç½®Quartzä»¥ä½¿ç”¨JobStoreTxï¼š 1org.quartz.jobStore.class = org.quartz.impl.jdbcjobstore.JobStoreTX æ¥ä¸‹æ¥ï¼Œä½ éœ€è¦ä¸ºJobStoreé€‰æ‹©ä¸€ä¸ªDriverDelegateã€‚DriverDelegateè´Ÿè´£æ‰§è¡Œç‰¹å®šæ•°æ®åº“å¯èƒ½éœ€è¦çš„ä»»ä½•JDBCç›¸å…³çš„å·¥ä½œã€‚StdJDBCDelegateæ˜¯ä¸€ä¸ªä½¿ç”¨â€œvanilla(åŸæ„è¯†é¦™è‰å‘³çš„ï¼Œè¿™é‡Œå¤§æ¦‚çš„æ„æ€æ˜¯åŸç”Ÿçš„)â€JDBCä»£ç ï¼ˆå’ŒSQLè¯­å¥ï¼‰æ¥å·¥ä½œçš„ã€‚å¦‚æœQuartzæ²¡æœ‰ä¸ºä½ çš„æ•°æ®åº“ç±»å‹æä¾›ç‰¹å®šçš„DriverDelegateï¼Œè¯·å°è¯•ä½¿ç”¨æ­¤DriverDelegate - æˆ‘ä»¬ä»…ä»…ä¸ºé‚£äº›ä½¿ç”¨StdJDBCDelegate(å‡ ä¹æ˜¯æœ€å¸¸ä½¿ç”¨)å‡ºç°äº†é—®é¢˜çš„æ•°æ®åº“ç±»å‹æä¾›äº†ç‰¹æ®Šçš„è®¢é€ çš„DriverDelegateã€‚å…¶ä»–DriverDelegateå¯ä»¥åœ¨&quot;org.quartz.impl.jdbcjobstore&quot;åŒ…æˆ–å…¶å­åŒ…ä¸­æ‰¾åˆ°ã€‚å…¶ä»–DriverDelegateåŒ…æ‹¬DB2v6Delegateï¼ˆç”¨äºDB2ç‰ˆæœ¬6åŠæ›´æ—©ç‰ˆæœ¬ï¼‰ï¼ŒHSQLDBDelegateï¼ˆç”¨äºHSQLDBï¼‰ï¼ŒMSSQLDelegateï¼ˆç”¨äºMicrosoft SQLServerï¼‰ï¼ŒPostgreSQLDelegateï¼ˆç”¨äºPostgreSQLï¼‰ï¼‰ï¼ŒWeblogicDelegateï¼ˆç”¨äºä½¿ç”¨Weblogicåˆ›å»ºçš„JDBCé©±åŠ¨ç¨‹åºï¼‰ã€‚ ä¸€æ—¦ä½ é€‰æ‹©äº†DriverDelegateåï¼Œå°†å…¶ç±»åè®¾ç½®ä¸ºJDBCJobStoreçš„å¯¹åº”å±æ€§ä»¥ä¾¿JDBCJobStoreèƒ½å¤Ÿä½¿ç”¨å®ƒã€‚ ä¸ºJDBCJobStoreé…ç½®DriverDelegateï¼š 1org.quartz.jobStore.driverDelegateClass = org.quartz.impl.jdbcjobstore.StdJDBCDelegate æ¥ä¸‹æ¥ï¼Œä½ éœ€è¦é€šçŸ¥JobStoreä½ æ­£åœ¨ä½¿ç”¨çš„è¡¨å‰ç¼€ï¼ˆå¦‚ä¸Šæ‰€è¿°ï¼‰ã€‚ é…ç½®JDBCJobStoreå¯¹åº”çš„è¡¨å‰ç¼€ï¼š 1org.quartz.jobStore.tablePrefix = QRTZ_ æœ€åï¼Œä½ éœ€è¦è®¾ç½®JobStoreåº”è¯¥ä½¿ç”¨å“ªä¸ªDataSourceã€‚DataSourceçš„å‘½åä¹Ÿå¿…é¡»åœ¨Quartzé…ç½®æ–‡ä»¶ä¸­çš„å±æ€§ä¸­å®šä¹‰ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æŒ‡å®šQuartzåº”è¯¥ä½¿ç”¨DataSourceåç§°&quot;myDS&quot;ï¼ˆåœ¨é…ç½®å±æ€§ä¸­çš„å…¶ä»–ä½ç½®ä¹Ÿæ˜¯ç”¨è¿™ä¸ªåç§°å»å®šä¹‰ï¼‰ã€‚ é…ç½®JDBCJobStoreå¯¹åº”çš„DataSourceï¼š 1org.quartz.jobStore.dataSource = myDS æ³¨æ„äº‹é¡¹ä¸€ï¼š 1å¦‚æœä½ çš„è°ƒåº¦å™¨ä¸€ç›´å¤„äºå¿™ç¢Œçš„çŠ¶æ€(æ»¡è´Ÿè½½)ï¼ˆæ­£åœ¨æ‰§è¡Œçš„Jobæ•°é‡å‡ ä¹ä¸çº¿ç¨‹æ± å¤§å°ç›¸åŒï¼‰ï¼Œé‚£ä¹ˆä½ åº”è¯¥å°†DataSourceä¸­çš„è¿æ¥æ•°è®¾ç½®ä¸ºçº¿ç¨‹æ± å®¹é‡+2ã€‚ æ³¨æ„äº‹é¡¹äºŒï¼š 1å¯ä»¥å°†\"org.quartz.jobStore.useProperties\"é…ç½®å‚æ•°è®¾ç½®ä¸º\"true\"ï¼ˆé»˜è®¤ä¸ºfalseï¼‰ï¼Œä»¥æŒ‡ç¤ºJDBCJobStoreå°†JobDataMapä¸­çš„æ‰€æœ‰å€¼éƒ½ä½œä¸ºå­—ç¬¦ä¸²ï¼Œä»è€ŒJobDataMapä¸­çš„å±æ€§å¯ä»¥ä½œä¸ºé”®å€¼å¯¹å­˜å‚¨ï¼Œè€Œä¸æ˜¯ä½¿ç”¨BLOBç±»å‹ï¼Œå› ä¸ºBLOBç±»å‹æ˜¯ä¸ºäº†ä»¥å…¶åºåˆ—åŒ–å½¢å¼å­˜å‚¨æ›´å¤šå¤æ‚çš„å¯¹è±¡ã€‚ä»é•¿è¿œæ¥çœ‹ï¼Œè¿™æ˜¯æ›´å®‰å…¨çš„ï¼Œå› ä¸ºä½ é¿å…äº†å°†éStringç±»åºåˆ—åŒ–ä¸ºBLOBç±»å‹çš„ç‰ˆæœ¬é—®é¢˜ã€‚ TerracottaJobStore TerracottaJobStoreæä¾›äº†ä¸€ç§ä¼¸ç¼©æ€§å’Œé²æ£’æ€§çš„æ‰‹æ®µï¼Œå®ƒå¹¶ä¸ä½¿ç”¨æ•°æ®åº“ã€‚è¿™æ„å‘³ç€ä½ çš„æ•°æ®åº“å¯ä»¥å…å—Quartzçš„è´Ÿè½½ï¼Œå¯ä»¥å°†æ•°æ®åº“æ‰€æœ‰èµ„æºåˆ†é…ç»™åº”ç”¨ç¨‹åºçš„å…¶ä½™éƒ¨åˆ†ã€‚ TerracottaJobStoreå¯ä»¥è¿è¡Œåœ¨ç¾¤é›†æˆ–éç¾¤é›†ç¯å¢ƒåœ¨é›†ç¾¤æˆ–è€…éé›†ç¾¤ç¯å¢ƒä¸‹ï¼ŒTerracottaJobStoreéƒ½å¯ä»¥ä¸ºåº”ç”¨ç¨‹åºçš„ä½œä¸šæ•°æ®æä¾›å­˜å‚¨ä»‹è´¨ï¼Œå³ä¾¿æ˜¯åº”ç”¨ç¨‹åºé‡å¯çš„é—´éš™ï¼Œå› ä¸ºæ•°æ®æ˜¯å­˜å‚¨åœ¨TerracottaæœåŠ¡å™¨ä¸­ã€‚å®ƒçš„æ€§èƒ½æ¯”åŸºäºä½¿ç”¨æ•°æ®åº“çš„JDBCJobStoreè¦å¥½å¾—å¤šï¼ˆçº¦ä¸€ä¸ªæ•°é‡çº§ï¼‰ï¼Œä½†æ¯”RAMJobStoreè¦æ…¢ã€‚ è¦ä½¿ç”¨TerracottaJobStoreï¼ˆå‡è®¾ä½ ä½¿ç”¨çš„æ˜¯StdSchedulerFactoryï¼‰ï¼Œåªéœ€å°†é…ç½®æ–‡ä»¶ä¸­çš„ç±»åç§°org.quartz.jobStore.class = org.terracotta.quartz.TerracottaJobStoreæŒ‡å®šä¸ºQuartzçš„JobStoreç±»å±æ€§ï¼Œå¹¶æ·»åŠ ä¸€ä¸ªé¢å¤–çš„é…ç½®é¡¹æ¥æŒ‡å®šTerracottaæœåŠ¡å™¨çš„ä½ç½®å³å¯ï¼š ä½¿ç”¨TerracottaJobStoreé…ç½®Quartzï¼š 12org.quartz.jobStore.class = org.terracotta.quartz.TerracottaJobStoreorg.quartz.jobStore.tcConfigUrl = localhost:9510 æ›´å¤šå…³äºJobStoreå’ŒTerracottaçš„å†…å®¹å¯ä»¥å‚é˜…http://www.terracotta.org/quartzã€‚ åŸæ–‡é“¾æ¥ï¼štutorial-lesson-09","categories":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/categories/Middleware/"},{"name":"Quartz","slug":"Middleware/Quartz","permalink":"http://throwable.club/blog/categories/Middleware/Quartz/"}],"tags":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/tags/Middleware/"},{"name":"Quartz","slug":"Quartz","permalink":"http://throwable.club/blog/tags/Quartz/"}]},{"title":"ç¬¬å…«ç« ï¼šSchedulerç›‘å¬å™¨","slug":"quartz-doc-translation-lesson-8","date":"2019-03-29T17:42:23.000Z","updated":"2019-03-30T03:12:30.851Z","comments":true,"path":"2019/03/30/quartz-doc-translation-lesson-8/","link":"","permalink":"http://throwable.club/2019/03/30/quartz-doc-translation-lesson-8/","excerpt":"","text":"ç¬¬å…«ç« ï¼šSchedulerç›‘å¬å™¨ SchedulerListenerå’ŒTriggerListeneræˆ–JobListenerååˆ†ç›¸ä¼¼ï¼Œå®ƒæ¥æ”¶è°ƒåº¦å™¨çš„ç›¸å…³äº‹ä»¶ï¼Œè°ƒåº¦å™¨çš„ç›¸å…³äº‹ä»¶ä¸ä¸€å®šå’Œç‰¹å®šçš„Triggeræˆ–è€…Jobç›¸å…³ã€‚ ä¸Schedulerç›¸å…³çš„äº‹ä»¶åŒ…æ‹¬ï¼šæ·»åŠ Job/Triggerã€åˆ é™¤Job/Triggerã€è°ƒåº¦å™¨ä¸­çš„ä¸¥é‡é”™è¯¯ä»¥åŠå…³é—­è°ƒåº¦å™¨çš„é€šçŸ¥ç­‰ç­‰ã€‚ org.quartz.SchedulerListeneræ¥å£ï¼š 1234567891011121314151617181920212223242526public interface SchedulerListener &#123; public void jobScheduled(Trigger trigger); public void jobUnscheduled(String triggerName, String triggerGroup); public void triggerFinalized(Trigger trigger); public void triggersPaused(String triggerName, String triggerGroup); public void triggersResumed(String triggerName, String triggerGroup); public void jobsPaused(String jobName, String jobGroup); public void jobsResumed(String jobName, String jobGroup); public void schedulerError(String msg, SchedulerException cause); public void schedulerStarted(); public void schedulerInStandbyMode(); public void schedulerShutdown(); public void schedulingDataCleared();&#125; SchedulerListenerä¹Ÿæ˜¯é€šè¿‡ListenerManageræ³¨å†Œåˆ°è°ƒåº¦å™¨ã€‚SchedulerListenerå®ä¾‹å‡ ä¹å¯ä»¥æ˜¯ä»»ä½•å®ç°äº†org.quartz.SchedulerListeneræ¥å£çš„å¯¹è±¡(&lt;â€“è¯‘è€…åæ§½ï¼šè¿™å¥è¯æ€ä¹ˆçœ‹éƒ½è§‰å¾—æœ‰ç‚¹å¤šä½™)ã€‚ æ·»åŠ SchedulerListenerï¼š 1scheduler.getListenerManager().addSchedulerListener(mySchedListener); åˆ é™¤SchedulerListenerï¼š 1scheduler.getListenerManager().removeSchedulerListener(mySchedListener); åŸæ–‡é“¾æ¥ï¼štutorial-lesson-08","categories":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/categories/Middleware/"},{"name":"Quartz","slug":"Middleware/Quartz","permalink":"http://throwable.club/blog/categories/Middleware/Quartz/"}],"tags":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/tags/Middleware/"},{"name":"Quartz","slug":"Quartz","permalink":"http://throwable.club/blog/tags/Quartz/"}]},{"title":"ç¬¬ä¸ƒç« ï¼šTriggerç›‘å¬å™¨å’ŒJobç›‘å¬å™¨","slug":"quartz-doc-translation-lesson-7","date":"2019-03-29T17:42:16.000Z","updated":"2019-03-30T03:11:08.047Z","comments":true,"path":"2019/03/30/quartz-doc-translation-lesson-7/","link":"","permalink":"http://throwable.club/2019/03/30/quartz-doc-translation-lesson-7/","excerpt":"","text":"ç¬¬ä¸ƒç« ï¼šTriggerç›‘å¬å™¨å’ŒJobç›‘å¬å™¨ ç›‘å¬å™¨ï¼ˆlistenerï¼‰æ˜¯ä½ åˆ›å»ºçš„å¯¹è±¡ï¼Œä¸»è¦ä½œç”¨æ˜¯æ¥æ”¶å’Œå¤„ç†è°ƒåº¦å™¨å›è°ƒçš„äº‹ä»¶(event)ã€‚TriggerListeneræ¥æ”¶åˆ°ä¸è§¦å‘å™¨ï¼ˆTriggerï¼‰ç›¸å…³çš„äº‹ä»¶ï¼ŒJobListeneræ¥æ”¶ä¸è°ƒåº¦ä»»åŠ¡(Job)ç›¸å…³çš„äº‹ä»¶ã€‚ ä¸è§¦å‘å™¨ç›¸å…³çš„äº‹ä»¶åŒ…æ‹¬ï¼šè§¦å‘å™¨æ­£è¦è§¦å‘ï¼Œè§¦å‘å™¨é”™å¤±è§¦å‘ï¼Œè§¦å‘å™¨è§¦å‘å®Œæˆï¼ˆè°ƒåº¦ä»»åŠ¡å·²è¢«è§¦å‘å¼€å§‹æ‰§è¡Œï¼Œè§¦å‘å™¨å®Œæˆå½“æ¬¡è§¦å‘ï¼‰ã€‚ org.quartz.TriggerListeneræ¥å£ï¼š 12345678910111213public interface TriggerListener &#123; public String getName(); public void triggerFired(Trigger trigger, JobExecutionContext context); public boolean vetoJobExecution(Trigger trigger, JobExecutionContext context); public void triggerMisfired(Trigger trigger); public void triggerComplete(Trigger trigger, JobExecutionContext context, int triggerInstructionCode);&#125; ä¸è°ƒåº¦ä»»åŠ¡ç›¸å…³çš„äº‹ä»¶åŒ…æ‹¬ï¼šJobå³å°†æ‰§è¡Œæ—¶çš„é€šçŸ¥ä»¥åŠJobæ‰§è¡Œå®Œæˆæ—¶çš„é€šçŸ¥ã€‚ org.quartz.JobListeneræ¥å£ï¼š 123456789101112public interface JobListener &#123; public String getName(); public void jobToBeExecuted(JobExecutionContext context); public void jobExecutionVetoed(JobExecutionContext context); public void jobWasExecuted(JobExecutionContext context, JobExecutionException jobException);&#125; ä½¿ç”¨è‡ªå®šä¹‰çš„ç›‘å¬å™¨ è¦åˆ›å»ºä¸€ä¸ªListenerï¼Œåªéœ€åˆ›å»ºä¸€ä¸ªå®ç°org.quartz.TriggerListeneræˆ–org.quartz.JobListeneræ¥å£å®ç°çš„å®ä¾‹ã€‚ç„¶åï¼ŒListeneréœ€è¦åœ¨è¿è¡Œæ—¶æ³¨å†Œåˆ°è°ƒåº¦å™¨ä¸­ã€‚Listenerå¿…é¡»æŒ‡å®šä¸€ä¸ªåç§°ï¼ˆé€šè¿‡å®ç°JobListeneræ¥å£çš„getName()æ–¹æ³•æ¥ä¼ å…¥ç›‘å¬å™¨çš„åå­—ï¼‰ã€‚ ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œè‡ªå®šä¹‰ç›‘å¬å™¨ä¹Ÿå¯ä»¥ç»§æ‰¿è‡ªJobListenerSupportç±»æˆ–TriggerListenerSupportç±»ï¼Œå¹¶ä¸”åªéœ€è¦†ç›–ä½ æ„Ÿå…´è¶£çš„æ–¹æ³•ã€‚ Listeneré€šè¿‡è°ƒåº¦å™¨çš„ListenerManagerè¿›è¡Œæ³¨å†Œï¼Œå¯ä»¥é€šè¿‡ä¸€ä¸ªåŒ¹é…å™¨(Matcher)å®ä¾‹å»åŒ¹é…ç›‘å¬ä½ æ„Ÿå…´è¶£çš„Jobæˆ–è€…Triggerã€‚æ³¨æ„ä¸‹é¢çš„äº‹é¡¹ï¼š 1Listeneråœ¨è¿è¡Œæ—¶æ‰æ³¨å†Œåˆ°è°ƒåº¦å™¨ä¸­ï¼Œå¹¶ä¸”ä¸ä¸Jobæˆ–è€…è§¦å‘å™¨ä¸€èµ·å­˜å‚¨åœ¨JobStoreä¸­ã€‚è¿™æ˜¯å› ä¸ºé€šå¸¸ç›‘å¬å™¨æ˜¯ç›´æ¥é›†æˆåˆ°åº”ç”¨ç¨‹åºä¹‹ä¸­(è¿™é‡Œçš„æ„æ€å¤§æ¦‚æ˜¯ç›‘å¬å™¨ä¸­ä¼šæœ‰åº”ç”¨ç¨‹åºé‡Œé¢ç›¸å…³çš„é€»è¾‘)ã€‚å› æ­¤æ¯å½“åº”ç”¨ç¨‹åºå¯åŠ¨çš„æ—¶å€™ï¼Œæ‰€æœ‰çš„ç›‘å¬å™¨éœ€è¦é‡æ–°æ³¨å†Œåˆ°è°ƒåº¦å™¨ä¸­ã€‚ æ·»åŠ åŒ¹é…çš„ç‰¹å®šJobçš„JobListenerï¼š 1scheduler.getListenerManager().addJobListener(myJobListener, KeyMatcher.jobKeyEquals(new JobKey(\"myJobName\", \"myJobGroup\"))); ä½ å¯èƒ½éœ€è¦ä¸ºåŒ¹é…å™¨å’Œå…³é”®ç±»ä½¿ç”¨é™æ€å¯¼å…¥ï¼Œè¿™å°†ä½¿ä½ å®šä¹‰åŒ¹é…å™¨çš„é€»è¾‘æ›´ç®€æ´ï¼š 1234567import static org.quartz.JobKey.*;import static org.quartz.impl.matchers.KeyMatcher.*;import static org.quartz.impl.matchers.GroupMatcher.*;import static org.quartz.impl.matchers.AndMatcher.*;import static org.quartz.impl.matchers.OrMatcher.*;import static org.quartz.impl.matchers.EverythingMatcher.*;...etc. ä½¿ç”¨é™æ€å¯¼å…¥åä¸Šé¢çš„ä¾‹å­å˜æˆè¿™æ ·ï¼š 1scheduler.getListenerManager().addJobListener(myJobListener, jobGroupEquals(\"myJobGroup\")); æ·»åŠ å¯¹ä¸¤ä¸ªç‰¹å®šGroupçš„æ‰€æœ‰Jobæ„Ÿå…´è¶£çš„JobListenerï¼š 1scheduler.getListenerManager().addJobListener(myJobListener, or(jobGroupEquals(\"myJobGroup\"), jobGroupEquals(\"yourGroup\"))); æ·»åŠ å¯¹æ‰€æœ‰Jobæ„Ÿå…´è¶£çš„JobListenerï¼š 1scheduler.getListenerManager().addJobListener(myJobListener, allJobs()); æ³¨å†ŒTriggerListenerçš„å·¥ä½œåŸç†å’ŒJobListeneråŸºæœ¬ç›¸åŒã€‚ å¤§å¤šæ•°Quartzçš„ä½¿ç”¨è€…å¹¶ä¸ä½¿ç”¨Listenerã€‚ä½†æ˜¯å½“åº”ç”¨ç¨‹åºæœ‰è·å–ä»»åŠ¡è°ƒåº¦ç›¸å…³çš„äº‹ä»¶é€šçŸ¥çš„éœ€æ±‚æ—¶ï¼Œå¦‚æœä½¿ç”¨äº†Listenerå¯ä»¥é¿å…åœ¨Jobçš„é€»è¾‘é‡Œé¢åŠ å…¥é¢å¤–çš„é€šçŸ¥é€»è¾‘ï¼Œè¿™ä¸€ç‚¹å¯¹äºä½¿ç”¨è€…è€Œè¨€æ˜¯å¾ˆæ–¹ä¾¿çš„ã€‚ åŸæ–‡é“¾æ¥ï¼štutorial-lesson-07","categories":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/categories/Middleware/"},{"name":"Quartz","slug":"Middleware/Quartz","permalink":"http://throwable.club/blog/categories/Middleware/Quartz/"}],"tags":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/tags/Middleware/"},{"name":"Quartz","slug":"Quartz","permalink":"http://throwable.club/blog/tags/Quartz/"}]},{"title":"ç¬¬å…­ç« ï¼šCronTrigger","slug":"quartz-doc-translation-lesson-6","date":"2019-03-29T17:42:12.000Z","updated":"2019-03-30T03:07:32.697Z","comments":true,"path":"2019/03/30/quartz-doc-translation-lesson-6/","link":"","permalink":"http://throwable.club/2019/03/30/quartz-doc-translation-lesson-6/","excerpt":"","text":"ç¬¬å…­ç« ï¼šCronTrigger CronTriggeré€šå¸¸æ¯”SimpleTriggeræ›´æœ‰ç”¨ï¼Œå¦‚æœä½ éœ€è¦ä¸€ä¸ªåŸºäºç±»ä¼¼æ—¥å†çš„æ¦‚å¿µé‡å¤å‡ºç°çš„å·¥ä½œè°ƒåº¦è®¡åˆ’ï¼Œè€Œä¸æ˜¯SimpleTriggerçš„ç²¾ç¡®æŒ‡å®šæ—¶é—´é—´éš”ã€‚ä½¿ç”¨CronTriggerï¼Œä½ å¯ä»¥æŒ‡å®šä»»åŠ¡è§¦å‘çš„æ—¶é—´è¡¨ï¼Œä¾‹å¦‚â€œæ¯å‘¨äº”ä¸­åˆâ€æˆ–â€œæ¯ä¸ªå·¥ä½œæ—¥å’Œä¸Šåˆ9:30â€ï¼Œç”šè‡³â€œæ¯å‘¨ä¸€è‡³å‘¨äº”ä¸Šåˆ9:00è‡³10ç‚¹ä¹‹é—´æ¯5åˆ†é’Ÿâ€å’Œ1æœˆä»½çš„æ˜ŸæœŸäº”â€ã€‚å³ä½¿å¦‚æ­¤ï¼Œå’ŒSimpleTriggerä¸€æ ·ï¼ŒCronTriggeræœ‰ä¸€ä¸ªstartTimeï¼Œå®ƒæŒ‡å®šä½•æ—¶ç”Ÿæ•ˆï¼Œä»¥åŠä¸€ä¸ªï¼ˆå¯é€‰çš„ï¼‰endTimeï¼Œç”¨äºæŒ‡å®šä½•æ—¶åœæ­¢ä»»åŠ¡è°ƒåº¦ã€‚ Cronè¡¨è¾¾å¼ Cron-Expressionsç”¨äºé…ç½®CronTriggerçš„å®ä¾‹ã€‚Cronè¡¨è¾¾å¼æ˜¯ç”±ä¸ƒä¸ªå­è¡¨è¾¾å¼ç»„æˆçš„å­—ç¬¦ä¸²ï¼Œç”¨äºæè¿°è°ƒåº¦è®¡åˆ’çš„å„ä¸ªç»†èŠ‚ã€‚è¿™äº›å­è¡¨è¾¾å¼ç”¨ç©ºæ ¼åˆ†éš”ï¼Œå„ä¸ªéƒ¨åˆ†è¡¨ç¤ºå¦‚ä¸‹ï¼š 1.Seconds 2.Minutes 3.Hours 4.Day-of-Month 5.Month 6.Day-of-Week 7.Year (optional field -&gt; å¯é€‰çš„) ä¸€ä¸ªå®Œæ•´çš„Cron-Expressionsçš„ä¾‹å­æ˜¯å­—ç¬¦ä¸²&quot;0 0 12 ? * WED&quot; - è¿™æ„å‘³ç€â€œæ¯ä¸ªæ˜ŸæœŸä¸‰ä¸‹åˆ12:00â€ã€‚å•ä¸ªå­è¡¨è¾¾å¼å¯ä»¥åŒ…å«èŒƒå›´å€¼ã€&quot;/â€œæˆ–åˆ—è¡¨ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥ç”¨&quot;MON-FRIâ€ã€â€œMON,WED,FRI&quot;æˆ–ç”šè‡³&quot;MON-WED,SAT&quot;ä»£æ›¿å‰ä¸€ä¸ªï¼ˆä¾‹å¦‚&quot;WEDâ€ï¼‰ç¤ºä¾‹ä¸­çš„æ˜ŸæœŸå‡ å­—æ®µã€‚ é€šé…ç¬¦ï¼ˆ'*'ï¼Œåœ¨å®˜æ–¹æ–‡æ¡£ä¸­æ˜¯''ï¼Œä¼°è®¡æ˜¯å®˜æ–¹æ–‡æ¡£æœ‰è¯¯ï¼Œcronä¸æ”¯æŒç©ºå­—ç¬¦ä¸²ï¼‰å¯ç”¨äºè¯´æ˜è¯¥å­—æ®µå¯ä»¥å–ä»»ä½•å€¼ã€‚å› æ­¤ï¼Œå‰ä¸€ä¸ªä¾‹å­çš„Monthå­—æ®µä¸­çš„â€™â€˜å­—ç¬¦ä»…ä»…æ˜¯â€œæ¯ä¸ªæœˆâ€ã€‚å› æ­¤ï¼ŒDay-of-Monthå­—æ®µä¸­çš„â€™'æ˜¾ç„¶æ„å‘³ç€â€œæ¯å‘¨çš„æ¯ä¸€å¤©â€ã€‚ æ‰€æœ‰å­—æ®µéƒ½æœ‰ä¸€ç»„å¯ä»¥æŒ‡å®šçš„æœ‰æ•ˆå€¼ã€‚è¿™äº›å€¼åº”è¯¥æ˜¯ç›¸å½“æ˜æ˜¾çš„ - ä¾‹å¦‚Secondså’ŒMinutesåªå…è®¸æ•°å­—0åˆ°59ï¼ŒHoursåªå…è®¸æ•°å­—0åˆ°23ã€‚Day-of-Monthå¯ä»¥æ˜¯1-31çš„ä»»ä½•å€¼ï¼Œä½†æ˜¯ä½ éœ€è¦æ³¨æ„åœ¨ç»™å®šçš„æœˆä»½ä¸­æœ‰å¤šå°‘å¤©ï¼Monthå¯ä»¥æŒ‡å®šä¸º0åˆ°11ä¹‹é—´çš„å€¼ï¼Œæˆ–è€…ä½¿ç”¨å­—ç¬¦ä¸²JANï¼ŒFEBï¼ŒMARï¼ŒAPRï¼ŒMAYï¼ŒJUNï¼ŒJULï¼ŒAUGï¼ŒSEPï¼ŒOCTï¼ŒNOVå’ŒDECã€‚Day-of-Weekå¯ä»¥æŒ‡å®šä¸º1åˆ°7ï¼ˆ1 = æ˜ŸæœŸæ—¥ï¼‰ä¹‹é—´çš„å€¼ï¼Œæˆ–è€…ä½¿ç”¨å­—ç¬¦ä¸²SUNï¼ŒMONï¼ŒTUEï¼ŒWEDï¼ŒTHUï¼ŒFRIå’ŒSATã€‚ '/'å­—ç¬¦å¯ç”¨äºæŒ‡å®šå€¼çš„å¢é‡ã€‚ä¾‹å¦‚ï¼Œå¦‚æœåœ¨Minuteså­—æ®µä¸­è¾“å…¥&quot;0/15&quot;ï¼Œåˆ™è¡¨ç¤ºâ€œä»ç¬¬0åˆ†é’Ÿå¼€å§‹å¼€å§‹ï¼Œæ¯éš”15åˆ†é’Ÿâ€ã€‚å¦‚æœä½ åœ¨Minuteså­—æ®µä¸­ä½¿ç”¨&quot;3/20&quot;ï¼Œåˆ™æ„å‘³ç€â€œä»ç¬¬3åˆ†é’Ÿå¼€å§‹ï¼Œæ¯éš”20åˆ†é’Ÿâ€ - æ¢å¥è¯è¯´ï¼Œå®ƒä¸Minuteså­—æ®µä¸­å®šä¹‰çš„&quot;3,243,43&quot;æ„ä¹‰ç›¸åŒã€‚è¯·æ³¨æ„&quot;/35&quot;çš„ç»†å¾®ä¹‹å¤„å¹¶ä¸ä»£è¡¨â€œæ¯35åˆ†é’Ÿâ€ - è¿™æ„å‘³ç€â€œä»ç¬¬0åˆ†é’Ÿå¼€å§‹ï¼Œæ¯éš”35åˆ†é’Ÿâ€ - æˆ–è€…æ¢å¥è¯è¯´ï¼Œä¸æŒ‡å®š&quot;0,35&quot;ç›¸åŒã€‚ â€˜?â€˜å­—ç¬¦åªå…è®¸ä½¿ç”¨åœ¨Day-of-Monthå’ŒDay-of-Weekå­—æ®µä¸­ã€‚ç”¨äºè¡¨ç¤ºâ€œæ²¡æœ‰ç‰¹å®šçš„å€¼â€ã€‚å½“æ‚¨éœ€è¦åœ¨Day-of-Monthå’ŒDay-of-Weekä¸¤ä¸ªå­—æ®µä¹‹ä¸€å®šä¹‰å…¶ä¸­ä¸€ä¸ªå­—æ®µçš„ç¡®åˆ‡å€¼ï¼Œé‚£ä¹ˆå¦ä¸€ä¸ªå­—æ®µå¯ä»¥ç”¨â€™?â€™ï¼Œè¿™ç‚¹ååˆ†æœ‰ç”¨ã€‚è¯·å‚é˜…ä¸‹é¢çš„ç¤ºä¾‹ï¼ˆå’ŒCronTrigger JavaDocï¼‰ä»¥è¿›è¡Œè¯´æ˜ã€‚ â€˜Lâ€™å­—ç¬¦åªå…è®¸ç”¨äºDay-of-Monthå’ŒDay-of-Weekå­—æ®µä¸­ã€‚è¿™ä¸ªå­—ç¬¦å…¶å®å°±æ˜¯â€™lastâ€™çš„ç¼©å†™ï¼Œä½†æ˜¯åœ¨Day-of-Monthå’ŒDay-of-Weekå„è‡ªçš„å­—æ®µä¸­æœ‰ä¸åŒçš„å«ä¹‰ã€‚ä¾‹å¦‚ï¼ŒDay-of-Monthå­—æ®µä¸­çš„&quot;L&quot;è¡¨ç¤ºâ€œæœˆçš„æœ€åä¸€å¤©â€ - ä¾‹å¦‚1æœˆ31æ—¥ï¼Œéé—°å¹´2æœˆ28æ—¥ã€‚å¦‚æœåœ¨Day-of-Weekå­—æ®µä¸­ä½¿ç”¨å®ƒï¼Œå®ƒåªæ˜¯æ„å‘³ç€&quot;7&quot;æˆ–&quot;SAT&quot;ã€‚ä½†æ˜¯åœ¨ä½¿ç”¨äº†Day-of-Monthå‰æä¸‹ï¼Œåœ¨Day-of-Weekä¸­ä½¿ç”¨â€™Lâ€™ï¼Œå°±æ„å‘³ç€â€œxxxæœˆçš„æœ€åä¸€ä¸ªæ˜ŸæœŸxxxâ€ï¼Œä¾‹å¦‚&quot;6L&quot;æˆ–&quot;FRIL&quot;éƒ½æ„å‘³ç€â€œæœˆçš„æœ€åä¸€ä¸ªæ˜ŸæœŸäº”â€ã€‚ä½ è¿˜å¯ä»¥æŒ‡å®šæœˆä»½æœ€åä¸€å¤©çš„åç§»é‡ï¼Œä¾‹å¦‚&quot;L-3&quot;ï¼Œè¿™æ„å‘³ç€ä¸€ä¸ªæœˆä»½çš„å€’æ•°ç¬¬ä¸‰å¤©ã€‚å½“ä½¿ç”¨â€™Lâ€™é€‰é¡¹æ—¶ï¼Œåˆ‡è®°ä¸è¦æŒ‡å®šåˆ—è¡¨æˆ–èŒƒå›´å€¼ï¼Œå› ä¸ºä½ ä¼šå¾—åˆ°æ··ä¹±æˆ–è€…æ„å¤–çš„ç»“æœã€‚ 'Wâ€™ç”¨äºæŒ‡å®šç»™å®šæ—¥æœŸæœ€ç›¸è¿‘çš„å·¥ä½œæ—¥ï¼ˆæ˜ŸæœŸä¸€è‡³æ˜ŸæœŸäº”ï¼‰ã€‚ä¾‹å¦‚ï¼Œå¦‚æœå°†&quot;15W&quot;æŒ‡å®šä¸ºDay-of-Monthå­—æ®µçš„å€¼ï¼Œåˆ™æ„æ€æ˜¯ï¼šâ€œè·ç¦»æœ¬æœˆ15æ—¥æœ€è¿‘çš„å·¥ä½œæ—¥â€ã€‚ '#â€˜ç”¨äºæŒ‡å®šæœˆä»½çš„â€œç¬¬nä¸ªâ€æ˜ŸæœŸXXXï¼Œæ ¼å¼æ˜¯â€™n#pâ€™ï¼Œè¡¨ç¤ºæœˆçš„ç¬¬pä¸ªæ˜ŸæœŸnã€‚ä¾‹å¦‚ï¼ŒDay-of-Weekå­—æ®µä¸­çš„&quot;6ï¼ƒ3&quot;æˆ–&quot;FRIï¼ƒ3&quot;çš„å€¼è¡¨ç¤ºâ€œæœˆçš„ç¬¬ä¸‰ä¸ªæ˜ŸæœŸäº”â€ã€‚ ä»¥ä¸‹æ˜¯ä¸€äº›è¡¨è¾¾å¼åŠå…¶å«ä¹‰çš„ç¤ºä¾‹ - ä½ å¯ä»¥åœ¨JavaDocçš„org.quartz.CronExpressionä¸­æ‰¾åˆ°æ›´å¤šçš„èµ„æ–™ã€‚ è¯‘è€…æ³¨ï¼šè¿™é‡Œæœ‰ç–‘æƒ‘çš„å°±æ˜¯â€™*â€˜å’Œâ€™?'çš„åŒºåˆ«ï¼Œæ€»ç»“å¦‚ä¸‹ï¼š é—®å·(?)çš„ä½œç”¨æ˜¯æŒ‡æ˜è¯¥å­—æ®µâ€œæ²¡æœ‰ç‰¹å®šçš„å€¼â€ï¼Œæ˜Ÿå·(*)æŒ‡æ˜è¯¥å­—æ®µâ€œä»£è¡¨æ‰€æœ‰å¯èƒ½å€¼â€ã€‚ æ˜Ÿå·(*)å’Œå…¶å®ƒå€¼ï¼Œæ¯”å¦‚æ•°å­—ï¼Œéƒ½æ˜¯ç»™è¯¥å­—æ®µæŒ‡æ˜ç‰¹å®šçš„å€¼ï¼Œåªä¸è¿‡ç”¨æ˜Ÿå·(*)ä»£è¡¨æ‰€æœ‰å¯èƒ½å€¼ã€‚ Cron-Expressionå¯¹æ—¥æœŸå’Œæ˜ŸæœŸå­—æ®µçš„å¤„ç†è§„åˆ™æ˜¯å®ƒä»¬å¿…é¡»äº’æ–¥ï¼Œå³åªèƒ½ä¸”å¿…é¡»æœ‰ä¸€ä¸ªå­—æ®µæœ‰ç‰¹å®šçš„å€¼ï¼Œå¦ä¸€ä¸ªå­—æ®µå¿…é¡»æ˜¯â€œæ²¡æœ‰ç‰¹å®šçš„å€¼â€ã€‚ é—®å·(?)å°±æ˜¯ç”¨æ¥å¯¹æ—¥æœŸå’Œæ˜ŸæœŸå­—æ®µåšäº’æ–¥çš„ã€‚ Cronè¡¨è¾¾å¼ç¤ºä¾‹ CronTriggerç¤ºä¾‹1 - åˆ›å»ºä¸€ä¸ªè§¦å‘å™¨çš„è¡¨è¾¾å¼ï¼Œæ¯5åˆ†é’Ÿå°±ä¼šè§¦å‘ä¸€æ¬¡ &quot;0 0/5 * * * ?&quot; CronTriggerç¤ºä¾‹2 - åˆ›å»ºä¸€ä¸ªè§¦å‘å™¨çš„è¡¨è¾¾å¼ï¼Œæ¯5åˆ†é’Ÿè§¦å‘ä¸€æ¬¡ï¼Œåˆ†é’Ÿå10ç§’ï¼ˆå³ä¸Šåˆ10æ—¶10åˆ†ï¼Œä¸Šåˆ10:05:10ç­‰ï¼‰ã€‚ &quot;10 0/5 * * * ?&quot; CronTriggerç¤ºä¾‹3 - åˆ›å»ºä¸€ä¸ªè§¦å‘å™¨çš„è¡¨è¾¾å¼ï¼Œåœ¨æ¯ä¸ªæ˜ŸæœŸä¸‰å’Œæ˜ŸæœŸäº”çš„10:30ï¼Œ11:30ï¼Œ12:30å’Œ13:30åˆ›å»ºè§¦å‘å™¨çš„è¡¨è¾¾å¼ã€‚ &quot;0 30 10-13 ? * WED,FRI&quot; CronTriggerç¤ºä¾‹4 - åˆ›å»ºä¸€ä¸ªè§¦å‘å™¨çš„è¡¨è¾¾å¼ï¼Œæ¯ä¸ªæœˆ5æ—¥å’Œ20æ—¥ä¸Šåˆ8ç‚¹è‡³10ç‚¹ä¹‹é—´æ¯åŠå°æ—¶è§¦å‘ä¸€æ¬¡ã€‚è¯·æ³¨æ„ï¼Œè§¦å‘å™¨å°†ä¸ä¼šåœ¨ä¸Šåˆ10ç‚¹å¼€å§‹ï¼Œä»…åœ¨8:00ï¼Œ8:30ï¼Œ9:00å’Œ9:30 &quot;0 0/30 8-9 5,20 * ?&quot; è¯·æ³¨æ„ï¼Œä¸€äº›è°ƒåº¦è¦æ±‚å¤ªå¤æ‚ï¼Œæ— æ³•ç”¨å•ä¸€è§¦å‘è¡¨ç¤º - ä¾‹å¦‚â€œæ¯ä¸Šåˆ9:00è‡³10:00ä¹‹é—´æ¯5åˆ†é’Ÿï¼Œä¸‹åˆ1:00è‡³æ™šä¸Š10ç‚¹ä¹‹é—´æ¯20åˆ†é’Ÿâ€ä¸€æ¬¡ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹çš„è§£å†³æ–¹æ¡ˆæ˜¯ç®€å•åœ°åˆ›å»ºä¸¤ä¸ªè§¦å‘å™¨ï¼Œå¹¶ç”¨å®ƒä»¬æ¥è§¦å‘ç›¸åŒçš„Jobã€‚ æ„å»ºCronTrigger CronTriggerå®ä¾‹ä½¿ç”¨TriggerBuilderï¼ˆç”¨äºè®¾ç½®è§¦å‘å™¨çš„ä¸»è¦å±æ€§ï¼‰å’ŒCronScheduleBuilderï¼ˆå¯¹äºCronTriggerç‰¹å®šçš„å±æ€§ï¼‰æ„å»ºã€‚è¦ä»¥DSLé£æ ¼ä½¿ç”¨è¿™äº›æ„å»ºå™¨ï¼Œè¯·ä½¿ç”¨é™æ€å¯¼å…¥ï¼š 123import static org.quartz.TriggerBuilder.*;import static org.quartz.CronScheduleBuilder.*;import static org.quartz.DateBuilder.*: å»ºç«‹ä¸€ä¸ªè§¦å‘å™¨ï¼Œæ¯å¤©ä¸Šåˆ8ç‚¹è‡³ä¸‹åˆ5ç‚¹ä¹‹é—´æ¯éš”ä¸€åˆ†é’Ÿè§¦å‘ä¸€æ¬¡ï¼š 12345trigger = newTrigger() .withIdentity(\"trigger3\", \"group1\") .withSchedule(cronSchedule(\"0 0/2 8-17 * * ?\")) .forJob(\"myJob\", \"group1\") .build(); å»ºç«‹ä¸€ä¸ªè§¦å‘å™¨ï¼Œå°†åœ¨ä¸Šåˆ10:42æ¯å¤©è§¦å‘ä¸€æ¬¡ï¼š 12345trigger = newTrigger() .withIdentity(\"trigger3\", \"group1\") .withSchedule(dailyAtHourAndMinute(10, 42)) .forJob(myJobKey) .build(); æˆ–è€…ï¼š 12345trigger = newTrigger() .withIdentity(\"trigger3\", \"group1\") .withSchedule(cronSchedule(\"0 42 10 * * ?\")) .forJob(myJobKey) .build(); å»ºç«‹ä¸€ä¸ªè§¦å‘å™¨ï¼Œå°†åœ¨æ˜ŸæœŸä¸‰ä¸Šåˆ10:42åœ¨TimeZoneï¼ˆç³»ç»Ÿé»˜è®¤å€¼ï¼‰ä¹‹å¤–è§¦å‘ï¼š 123456trigger = newTrigger() .withIdentity(\"trigger3\", \"group1\") .withSchedule(weeklyOnDayAndHourAndMinute(DateBuilder.WEDNESDAY, 10, 42)) .forJob(myJobKey) .inTimeZone(TimeZone.getTimeZone(\"America/Los_Angeles\")) .build(); æˆ–è€…ï¼š 123456trigger = newTrigger() .withIdentity(\"trigger3\", \"group1\") .withSchedule(cronSchedule(\"0 42 10 ? * WED\")) .inTimeZone(TimeZone.getTimeZone(\"America/Los_Angeles\")) .forJob(myJobKey) .build(); CronTrigger Misfireè¯´æ˜ ä»¥ä¸‹é”™è¿‡è§¦å‘é…ç½®å¯ä»¥ç”¨äºé€šçŸ¥Quartzå½“CronTriggerå‘ç”Ÿé”™å¤±è§¦å‘æ—¶åº”è¯¥åšä»€ä¹ˆã€‚ï¼ˆMisfireç­–ç•¥çš„ä»‹ç»å¯ä»¥å‚è€ƒç¬¬å››ç« ï¼šå…³äºTriggerçš„æ›´å¤šç»†èŠ‚ï¼‰ã€‚è¿™äº›ç­–ç•¥ä»¥å¸¸é‡çš„å½¢å¼åœ¨CronTriggeræ¥å£ä¸­å®šä¹‰ï¼ˆå¸¸é‡ä¸ŠåŒ…æ‹¬æè¿°å…¶è¡Œä¸ºçš„JavaDocï¼‰ã€‚è¿™äº›å¸¸é‡åŒ…æ‹¬ï¼š 123MISFIRE_INSTRUCTION_IGNORE_MISFIRE_POLICYMISFIRE_INSTRUCTION_DO_NOTHINGMISFIRE_INSTRUCTION_FIRE_NOW æ‰€æœ‰è§¦å‘å™¨éƒ½å¯ä»¥ä½¿ç”¨Trigger.MISFIRE_INSTRUCTION_SMART_POLICYé”™è¿‡è§¦å‘ç­–ç•¥ï¼Œå®ƒå°±æ˜¯æ‰€æœ‰è§¦å‘å™¨é»˜è®¤çš„é”™å¤±è§¦å‘ç­–ç•¥ã€‚â€œSMART POLICYâ€ç­–ç•¥åœ¨ä½¿ç”¨äº†CronTriggerçš„æƒ…å†µä¸‹è§£é‡Šä¸ºMISFIRE_INSTRUCTION_FIRE_NOWã€‚CronTrigger.updateAfterMisfire()æ–¹æ³•çš„JavaDocè§£é‡Šäº†æ­¤è¡Œä¸ºçš„ç¡®åˆ‡ç»†èŠ‚ã€‚ åœ¨æ„å»ºCronTriggersæ—¶ï¼Œä½ å¯ä»¥å°†misfireæŒ‡ä»¤æŒ‡å®šä¸ºcron schedule(cron è°ƒåº¦)çš„ä¸€éƒ¨åˆ†ï¼ˆé€šè¿‡CronSchedulerBuilderï¼‰ï¼š 123456trigger = newTrigger() .withIdentity(\"trigger3\", \"group1\") .withSchedule(cronSchedule(\"0 0/2 8-17 * * ?\") ..withMisfireHandlingInstructionFireAndProceed()) .forJob(\"myJob\", \"group1\") .build(); åŸæ–‡é“¾æ¥ï¼štutorial-lesson-06","categories":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/categories/Middleware/"},{"name":"Quartz","slug":"Middleware/Quartz","permalink":"http://throwable.club/blog/categories/Middleware/Quartz/"}],"tags":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/tags/Middleware/"},{"name":"Quartz","slug":"Quartz","permalink":"http://throwable.club/blog/tags/Quartz/"}]},{"title":"ç¬¬äº”ç« ï¼šSimpleTrigger","slug":"quartz-doc-translation-lesson-5","date":"2019-03-29T17:42:07.000Z","updated":"2019-03-30T03:05:59.962Z","comments":true,"path":"2019/03/30/quartz-doc-translation-lesson-5/","link":"","permalink":"http://throwable.club/2019/03/30/quartz-doc-translation-lesson-5/","excerpt":"","text":"ç¬¬äº”ç« ï¼šSimpleTrigger SimpleTriggerå¯ä»¥æ»¡è¶³çš„è°ƒåº¦éœ€æ±‚æ˜¯ï¼šåœ¨å…·ä½“çš„æ—¶é—´ç‚¹æ‰§è¡Œä¸€æ¬¡ï¼Œæˆ–è€…åœ¨å…·ä½“çš„æ—¶é—´ç‚¹æ‰§è¡Œå¹¶ä¸”ä»¥æŒ‡å®šçš„é—´éš”é‡å¤æ‰§è¡Œè‹¥å¹²æ¬¡ï¼ˆå…¶å®æ°¸è¿œé‡å¤ä¹Ÿå¯ä»¥ï¼‰ã€‚æ¯”å¦‚ï¼Œä½ æœ‰ä¸€ä¸ªTriggerï¼Œä½ å¯ä»¥è®¾ç½®å®ƒåœ¨2015å¹´1æœˆ13æ—¥çš„ä¸Šåˆ11:23:54å‡†æ—¶è§¦å‘ï¼Œæˆ–è€…åœ¨å½“å‰è¿™ä¸ªæ—¶é—´ç‚¹è§¦å‘ï¼Œå¹¶ä¸”æ¯éš”2ç§’è§¦å‘ä¸€æ¬¡ï¼Œä¸€å…±é‡å¤5æ¬¡ã€‚ æ ¹æ®æè¿°ï¼Œä½ å¯èƒ½å·²ç»å‘ç°äº†ï¼ŒSimpleTriggerçš„å±æ€§åŒ…æ‹¬ï¼šå¼€å§‹æ—¶é—´ã€ç»“æŸæ—¶é—´ã€é‡å¤æ¬¡æ•°ä»¥åŠé‡å¤çš„é—´éš”ã€‚è¿™äº›å±æ€§çš„å«ä¹‰ä¸ä½ æ‰€æœŸæœ›çš„æ˜¯ä¸€è‡´çš„ï¼Œåªæ˜¯å…³äºç»“æŸæ—¶é—´æœ‰ä¸€äº›åœ°æ–¹éœ€è¦æ³¨æ„ã€‚ é‡å¤æ¬¡æ•°ï¼Œå¯ä»¥æ˜¯0ã€æ­£æ•´æ•°ï¼Œä»¥åŠå¸¸é‡SimpleTrigger.REPEAT_INDEFINITELY(å®é™…å€¼ä¸º-1ï¼Œå³æ— é™é‡å¤æ‰§è¡Œæ¬¡æ•°)ã€‚é‡å¤çš„é—´éš”ï¼Œå¿…é¡»æ˜¯0ï¼Œæˆ–è€…longå‹çš„æ­£æ•°ï¼Œå•ä½æ˜¯æ¯«ç§’ã€‚æ³¨æ„ï¼Œå¦‚æœé‡å¤é—´éš”ä¸º0ï¼ŒTriggerå°†ä¼šä»¥é‡å¤æ¬¡æ•°å¹¶å‘æ‰§è¡Œ(æˆ–è€…ä»¥Schedulerå¯ä»¥å¤„ç†çš„è¿‘ä¼¼å¹¶å‘æ•°å¹¶å‘æ‰§è¡Œ)ã€‚ å¦‚æœä½ è¿˜ä¸ç†Ÿæ‚‰Quartzçš„DateBuilderç±»ï¼Œäº†è§£åä½ ä¼šå‘ç°ä½¿ç”¨å®ƒå¯ä»¥éå¸¸æ–¹ä¾¿åœ°æ„é€ åŸºäºstartTime(æˆ–endTime)çš„è°ƒåº¦ç­–ç•¥ã€‚ endTimeå±æ€§çš„å€¼ä¼šè¦†ç›–è®¾ç½®é‡å¤æ¬¡æ•°çš„å±æ€§å€¼ï¼›æ¯”å¦‚ï¼Œä½ å¯ä»¥åˆ›å»ºä¸€ä¸ªTriggerï¼Œåœ¨ç»ˆæ­¢æ—¶é—´ä¹‹å‰æ¯éš”10ç§’æ‰§è¡Œä¸€æ¬¡ï¼Œä½ ä¸éœ€è¦å»è®¡ç®—åœ¨å¼€å§‹æ—¶é—´å’Œç»ˆæ­¢æ—¶é—´ä¹‹é—´çš„é‡å¤æ¬¡æ•°ï¼Œåªéœ€è¦è®¾ç½®ç»ˆæ­¢æ—¶é—´å¹¶å°†é‡å¤æ¬¡æ•°è®¾ç½®ä¸ºREPEAT_INDEFINITELY(å½“ç„¶ï¼Œä½ ä¹Ÿå¯ä»¥å°†é‡å¤æ¬¡æ•°è®¾ç½®ä¸ºä¸€ä¸ªå¾ˆå¤§çš„å€¼ï¼Œå¹¶ä¿è¯è¯¥å€¼æ¯”Triggeråœ¨ç»ˆæ­¢æ—¶é—´ä¹‹å‰å®é™…è§¦å‘çš„æ¬¡æ•°è¦å¤§å³å¯)ã€‚ SimpleTriggerå®ä¾‹é€šè¿‡TriggerBuilderè®¾ç½®ä¸»è¦çš„å±æ€§ï¼Œé€šè¿‡SimpleScheduleBuilderè®¾ç½®ä¸SimpleTriggerç›¸å…³çš„å±æ€§ã€‚è¦ä½¿ç”¨è¿™äº›builderçš„é™æ€æ–¹æ³•ï¼Œéœ€è¦é™æ€å¯¼å…¥ï¼š 123import static org.quartz.TriggerBuilder.*;import static org.quartz.SimpleScheduleBuilder.*;import static org.quartz.DateBuilder.*: ä¸‹é¢çš„ä¾‹å­ï¼Œæ˜¯åŸºäºç®€å•è°ƒåº¦(simple schedule)åˆ›å»ºçš„Triggerã€‚å»ºè®®éƒ½çœ‹ä¸€ä¸‹ï¼Œå› ä¸ºæ¯ä¸ªä¾‹å­éƒ½åŒ…å«ä¸€ä¸ªä¸åŒçš„å®ç°ï¼š æŒ‡å®šæ—¶é—´å¼€å§‹è§¦å‘ï¼Œä¸é‡å¤è§¦å‘ï¼š 12345SimpleTrigger trigger = (SimpleTrigger) newTrigger() .withIdentity(\"trigger1\", \"group1\") .startAt(myStartTime) // some Date .forJob(\"job1\", \"group1\") // identify job with name, group strings .build(); æŒ‡å®šæ—¶é—´è§¦å‘ï¼Œæ¯éš”10ç§’è§¦å‘ä¸€æ¬¡ï¼Œé‡å¤10æ¬¡ï¼š 12345678trigger = newTrigger() .withIdentity(\"trigger3\", \"group1\") .startAt(myTimeToStartFiring) // if a start time is not given (if this line were omitted), \"now\" is implied .withSchedule(simpleSchedule() .withIntervalInSeconds(10) .withRepeatCount(10)) // note that 10 repeats will give a total of 11 firings .forJob(myJob) // identify job with handle to its JobDetail itself .build(); 5åˆ†é’Ÿä»¥åå¼€å§‹è§¦å‘ï¼Œä»…è§¦å‘ä¸€æ¬¡ï¼š 12345trigger = (SimpleTrigger) newTrigger() .withIdentity(\"trigger5\", \"group1\") .startAt(futureDate(5, IntervalUnit.MINUTE)) // use DateBuilder to create a date in the future .forJob(myJobKey) // identify job with its JobKey .build(); ç«‹å³è§¦å‘ï¼Œæ¯ä¸ª5åˆ†é’Ÿè§¦å‘ä¸€æ¬¡ï¼Œç›´åˆ°22:00ï¼š 1234567trigger = newTrigger() .withIdentity(\"trigger7\", \"group1\") .withSchedule(simpleSchedule() .withIntervalInMinutes(5) .repeatForever()) .endAt(dateOf(22, 0, 0)) .build(); å»ºç«‹ä¸€ä¸ªè§¦å‘å™¨ï¼Œå°†åœ¨ä¸‹ä¸€ä¸ªå°æ—¶çš„æ•´ç‚¹è§¦å‘ï¼Œç„¶åæ¯2å°æ—¶é‡å¤è§¦å‘ä¸€æ¬¡ï¼š 1234567891011trigger = newTrigger() .withIdentity(\"trigger8\") // because group is not specified, \"trigger8\" will be in the default group .startAt(evenHourDate(null)) // get the next even-hour (minutes and seconds zero (\"00:00\")) .withSchedule(simpleSchedule() .withIntervalInHours(2) .repeatForever()) // note that in this example, 'forJob(..)' is not called which is valid // if the trigger is passed to the scheduler along with the job .build(); scheduler.scheduleJob(trigger, job); è¯·æŸ¥é˜…TriggerBuilderå’ŒSimpleScheduleBuilderæä¾›çš„æ–¹æ³•ï¼Œä»¥ä¾¿äº†è§£å¯¹ä¸Šè¿°ç¤ºä¾‹ä¸­æœªæåˆ°çš„é€‰é¡¹ã€‚ 1TriggerBuilder(ä»¥åŠQuartzçš„å…¶å®ƒbuilder)ä¼šä¸ºé‚£äº›æ²¡æœ‰è¢«æ˜¾å¼è®¾ç½®çš„å±æ€§é€‰æ‹©åˆç†çš„é»˜è®¤å€¼ã€‚æ¯”å¦‚ï¼šå¦‚æœä½ æ²¡æœ‰è°ƒç”¨withIdentity(..)æ–¹æ³•ï¼ŒTriggerBuilderä¼šä¸ºTriggerç”Ÿæˆä¸€ä¸ªéšæœºçš„åç§°ï¼›å¦‚æœæ²¡æœ‰è°ƒç”¨startAt(..)æ–¹æ³•ï¼Œåˆ™é»˜è®¤ä½¿ç”¨å½“å‰æ—¶é—´ï¼Œå³Triggerç«‹å³ç”Ÿæ•ˆã€‚ SimpleTrigger Misfireç­–ç•¥ SimpleTriggeræœ‰å‡ ä¸ªmisfireç›¸å…³çš„ç­–ç•¥ï¼Œå‘Šè¯‰quartzå½“misfireå‘ç”Ÿçš„æ—¶å€™åº”è¯¥å¦‚ä½•å¤„ç†ã€‚(Misfireç­–ç•¥çš„ä»‹ç»å¯ä»¥å‚è€ƒç¬¬å››ç« ï¼šå…³äºTriggerçš„æ›´å¤šç»†èŠ‚)ã€‚è¿™äº›ç­–ç•¥ä»¥å¸¸é‡çš„å½¢å¼åœ¨SimpleTriggerä¸­å®šä¹‰(JavaDocä¸­ä»‹ç»äº†å®ƒä»¬çš„åŠŸèƒ½)ã€‚è¿™äº›ç­–ç•¥åŒ…æ‹¬ï¼š SimpleTriggerçš„Misfireç­–ç•¥å¸¸é‡ï¼š 1234567MISFIRE_INSTRUCTION_SMART_POLICY MISFIRE_INSTRUCTION_IGNORE_MISFIRE_POLICYMISFIRE_INSTRUCTION_FIRE_NOWMISFIRE_INSTRUCTION_RESCHEDULE_NOW_WITH_EXISTING_REPEAT_COUNTMISFIRE_INSTRUCTION_RESCHEDULE_NOW_WITH_REMAINING_REPEAT_COUNTMISFIRE_INSTRUCTION_RESCHEDULE_NEXT_WITH_REMAINING_COUNTMISFIRE_INSTRUCTION_RESCHEDULE_NEXT_WITH_EXISTING_COUNT è¯‘è€…è¡¥å……ï¼šå…¶å®è¿™äº›é”™è¿‡è§¦å‘ç­–ç•¥åŸºæœ¬éƒ½å¯ä»¥ä»åç§°å¾—å‡ºå®ƒä»¬çš„å®é™…æ“ä½œï¼Œæ€»ç»“å¦‚ä¸‹ï¼š MISFIRE_INSTRUCTION_IGNORE_MISFIRE_POLICYï¼šè¿™ä¸ªä¸æ˜¯å¿½ç•¥å·²ç»é”™å¤±çš„è§¦å‘çš„æ„æ€ï¼Œè€Œæ˜¯è¯´å¿½ç•¥MisFireç­–ç•¥ã€‚å®ƒä¼šåœ¨èµ„æºåˆé€‚çš„æ—¶å€™ï¼Œé‡æ–°è§¦å‘æ‰€æœ‰çš„MisFireçš„é”™è¿‡è§¦å‘ï¼Œå¹¶ä¸”ä¸ä¼šå½±å“ç°æœ‰çš„è°ƒåº¦æ—¶é—´ã€‚æ¯”å¦‚ï¼ŒSimpleTriggeræ¯15ç§’æ‰§è¡Œä¸€æ¬¡ï¼Œè€Œä¸­é—´æœ‰5åˆ†é’Ÿæ—¶é—´å®ƒéƒ½MisFireäº†ï¼Œä¸€å…±é”™å¤±äº†20æ¬¡è§¦å‘ï¼Œ5åˆ†é’Ÿåï¼Œå‡è®¾èµ„æºå……è¶³äº†ï¼Œå¹¶ä¸”ä»»åŠ¡å…è®¸å¹¶å‘ï¼Œå®ƒä¼šè¢«ä¸€æ¬¡æ€§å¹¶å‘è§¦å‘20æ¬¡ã€‚ MISFIRE_INSTRUCTION_FIRE_NOWï¼šå¿½ç•¥å·²ç»MisFireçš„è§¦å‘ï¼Œå¹¶ä¸”ç«‹å³è§¦å‘ä¸€æ¬¡ã€‚è¿™é€šå¸¸åªé€‚ç”¨äºåªæ‰§è¡Œä¸€æ¬¡çš„ä»»åŠ¡ã€‚ MISFIRE_INSTRUCTION_RESCHEDULE_NOW_WITH_EXISTING_REPEAT_COUNTï¼šå°†startTimeè®¾ç½®å½“å‰æ—¶é—´ï¼Œç«‹å³é‡æ–°è§¦å‘ï¼ŒåŒ…æ‹¬MisFireçš„è§¦å‘ã€‚ MISFIRE_INSTRUCTION_RESCHEDULE_NOW_WITH_REMAINING_REPEAT_COUNTï¼šå°†startTimeè®¾ç½®å½“å‰æ—¶é—´ï¼Œç«‹å³é‡æ–°è§¦å‘ï¼Œä¸åŒ…æ‹¬MisFireçš„è§¦å‘ã€‚ MISFIRE_INSTRUCTION_RESCHEDULE_NEXT_WITH_EXISTING_COUNTï¼šåœ¨ä¸‹ä¸€æ¬¡è°ƒåº¦æ—¶é—´ç‚¹è§¦å‘ï¼ŒåŒ…æ‹¬MisFireçš„çš„è§¦å‘ã€‚ MISFIRE_INSTRUCTION_RESCHEDULE_NEXT_WITH_REMAINING_COUNTï¼šåœ¨ä¸‹ä¸€æ¬¡è°ƒåº¦æ—¶é—´ç‚¹è§¦å‘ï¼Œä¸åŒ…æ‹¬MisFireçš„çš„è§¦å‘ã€‚ MISFIRE_INSTRUCTION_SMART_POLICYï¼šé»˜è®¤ç­–ç•¥ï¼Œå¤§è‡´æ„æ€æ˜¯â€œæŠŠå¤„ç†é€»è¾‘äº¤ç»™èªæ˜çš„Quartzå»å†³å®šâ€ã€‚ å¦‚æœæ˜¯åªæ‰§è¡Œä¸€æ¬¡çš„è°ƒåº¦ï¼Œä½¿ç”¨MISFIRE_INSTRUCTION_FIRE_NOWã€‚ å¦‚æœæ˜¯æ— é™æ¬¡çš„è°ƒåº¦(repeatCountæ˜¯æ— é™çš„)ï¼Œä½¿ç”¨MISFIRE_INSTRUCTION_RESCHEDULE_NEXT_WITH_REMAINING_COUNTã€‚ å¦åˆ™ï¼Œä½¿ç”¨MISFIRE_INSTRUCTION_RESCHEDULE_NOW_WITH_EXISTING_REPEAT_COUNTã€‚ å…¶å®ï¼Œé”™è¿‡è§¦å‘çš„ç­–ç•¥ç›¸å¯¹å¤æ‚ï¼Œå¯ä»¥å‚è€ƒQuartz Scheduler Misfire Instructions Explainedã€‚ å›é¡¾ä¸€ä¸‹ï¼Œæ‰€æœ‰çš„Triggeréƒ½æœ‰ä¸€ä¸ªTrigger.MISFIRE_INSTRUCTION_SMART_POLICYç­–ç•¥å¯ä»¥ä½¿ç”¨ï¼Œè¯¥ç­–ç•¥ä¹Ÿæ˜¯æ‰€æœ‰Triggerçš„é»˜è®¤ç­–ç•¥ã€‚ å¦‚æœä½¿ç”¨smart policyï¼ŒSimpleTriggerä¼šæ ¹æ®å®ä¾‹çš„é…ç½®åŠçŠ¶æ€ï¼Œåœ¨æ‰€æœ‰MISFIREç­–ç•¥ä¸­åŠ¨æ€é€‰æ‹©ä¸€ç§Misfireç­–ç•¥ã€‚å¯ä»¥ä»SimpleTrigger.updateAfterMisfire()çš„JavaDocä¸­è§£é‡Šäº†è¯¥åŠ¨æ€è¡Œä¸ºçš„å…·ä½“ç»†èŠ‚ã€‚ åœ¨ä½¿ç”¨SimpleTriggeræ„é€ Triggeræ—¶ï¼Œmisfireç­–ç•¥ä½œä¸ºç®€å•è°ƒåº¦(simple schedule)çš„ä¸€éƒ¨åˆ†è¿›è¡Œé…ç½®(é€šè¿‡SimpleSchedulerBuilderè®¾ç½®)ï¼Œä¾‹å­å¦‚ä¸‹ï¼š 1234567trigger = newTrigger() .withIdentity(\"trigger7\", \"group1\") .withSchedule(simpleSchedule() .withIntervalInMinutes(5) .repeatForever() .withMisfireHandlingInstructionNextWithExistingCount()) .build(); åŸæ–‡é“¾æ¥ï¼štutorial-lesson-05","categories":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/categories/Middleware/"},{"name":"Quartz","slug":"Middleware/Quartz","permalink":"http://throwable.club/blog/categories/Middleware/Quartz/"}],"tags":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/tags/Middleware/"},{"name":"Quartz","slug":"Quartz","permalink":"http://throwable.club/blog/tags/Quartz/"}]},{"title":"ç¬¬å››ç« ï¼šå…³äºTriggerçš„æ›´å¤šç»†èŠ‚","slug":"quartz-doc-translation-lesson-4","date":"2019-03-29T17:42:03.000Z","updated":"2019-03-29T17:52:30.915Z","comments":true,"path":"2019/03/30/quartz-doc-translation-lesson-4/","link":"","permalink":"http://throwable.club/2019/03/30/quartz-doc-translation-lesson-4/","excerpt":"","text":"ç¬¬å››ç« ï¼šå…³äºTriggerçš„æ›´å¤šç»†èŠ‚ ä¸Jobä¸€æ ·ï¼ŒTriggerä¹Ÿå¾ˆå®¹æ˜“ä½¿ç”¨ï¼Œä½†æ˜¯è¿˜æœ‰ä¸€äº›æ‰©å±•é€‰é¡¹éœ€è¦ç†è§£ï¼Œä»¥ä¾¿æ›´å¥½åœ°ä½¿ç”¨Qartzã€‚Triggerä¹Ÿæœ‰å¾ˆå¤šç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥æ ¹æ®å®é™…éœ€è¦æ¥é€‰æ‹©ã€‚ æœ€å¸¸ç”¨çš„ä¸¤ç§Triggerä¼šåˆ†åˆ«åœ¨ç¬¬äº”ç« ï¼šSimpleTriggerå’Œç¬¬å…­ç« ï¼šCronTriggerä¸­è®²åˆ°ã€‚ Triggerçš„å…¬å…±å±æ€§ æ‰€æœ‰ç±»å‹çš„Triggeréƒ½æœ‰TriggerKeyè¿™ä¸ªå±æ€§ï¼Œè¡¨ç¤ºTriggerçš„èº«ä»½ï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰ï¼›é™¤æ­¤ä¹‹å¤–ï¼ŒTriggerè¿˜æœ‰å¾ˆå¤šå…¶å®ƒçš„å…¬å…±å±æ€§ã€‚è¿™äº›å±æ€§ï¼Œåœ¨æ„å»ºTriggerçš„æ—¶å€™å¯ä»¥é€šè¿‡TriggerBuilderè®¾ç½®ã€‚Triggerçš„å…¬å…±å±æ€§æœ‰ï¼š jobKeyå±æ€§ï¼šå½“Triggerè§¦å‘æ—¶è¢«æ‰§è¡Œçš„Jobçš„èº«ä»½ï¼ˆå”¯ä¸€æ ‡è¯†ï¼‰ï¼› startTimeå±æ€§ï¼šè®¾ç½®triggerç¬¬ä¸€æ¬¡è§¦å‘çš„æ—¶é—´ç‚¹ï¼Œè¯¥å±æ€§çš„å€¼æ˜¯java.util.Dateç±»å‹ï¼Œè¡¨ç¤ºæŸä¸ªæŒ‡å®šçš„æ—¶é—´ç‚¹ï¼›æœ‰äº›ç±»å‹çš„Triggerï¼Œä¼šåœ¨è®¾ç½®çš„startTimeæ—¶ç«‹å³è§¦å‘ï¼Œæœ‰äº›ç±»å‹çš„Triggerï¼Œè¡¨ç¤ºå…¶è§¦å‘æ˜¯åœ¨startTimeä¹‹åå¼€å§‹ç”Ÿæ•ˆã€‚æ¯”å¦‚ï¼Œç°åœ¨æ˜¯1æœˆä»½ï¼Œä½ è®¾ç½®äº†ä¸€ä¸ªTriggerâ€“â€œåœ¨æ¯ä¸ªæœˆçš„ç¬¬5å¤©æ‰§è¡Œâ€ï¼Œç„¶åä½ å°†startTimeå±æ€§è®¾ç½®ä¸º4æœˆ1å·ï¼Œåˆ™è¯¥Triggerç¬¬ä¸€æ¬¡è§¦å‘ä¼šæ˜¯åœ¨å‡ ä¸ªæœˆä»¥åäº†(å³4æœˆ5å·)ã€‚ endTimeå±æ€§ï¼šè¡¨ç¤ºTriggerå¤±æ•ˆçš„æ—¶é—´ç‚¹ï¼Œè¯¥å±æ€§çš„å€¼æ˜¯java.util.Dateç±»å‹ã€‚æ¯”å¦‚ï¼Œâ€æ¯æœˆç¬¬5å¤©æ‰§è¡Œâ€çš„triggerï¼Œå¦‚æœå…¶endTimeæ˜¯7æœˆ1å·ï¼Œåˆ™å…¶æœ€åä¸€æ¬¡æ‰§è¡Œæ—¶é—´æ˜¯6æœˆ5å·ã€‚ å…¶å®ƒçš„å±æ€§ï¼Œä¼šåœ¨ä¸‹æ–‡ä¸­è§£é‡Šã€‚ Priority(ä¼˜å…ˆçº§) æœ‰æ—¶å€™ï¼Œå½“ä½ æœ‰å¾ˆå¤šTriggerå®ä¾‹ï¼ˆæˆ–è€…ä½ çš„Quartzçº¿ç¨‹æ± ä¸­åªæœ‰æœ‰å°‘é‡å·¥ä½œçº¿ç¨‹ï¼Œä¸è¶³ä»¥è§¦å‘æ‰€æœ‰çš„è§¦å‘å™¨ï¼‰æ—¶ï¼ŒQuartzå¯èƒ½æ²¡æœ‰è¶³å¤Ÿçš„èµ„æºæ¥ç«‹å³è§¦å‘æ‰€æœ‰è®¡åˆ’åŒæ—¶è§¦å‘çš„è§¦å‘å™¨ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œä½ å¯èƒ½æƒ³è¦æ§åˆ¶å“ªäº›Triggerå¯ä»¥ä¼˜å…ˆä½¿ç”¨ï¼ˆåœ¨å½“å‰å¯ç”¨çš„ï¼‰Quartzå·¥ä½œçº¿ç¨‹ã€‚ä¸ºæ­¤ï¼Œä½ å¯ä»¥åœ¨è§¦å‘å™¨ä¸Šè®¾ç½®ä¼˜å…ˆçº§å±æ€§ã€‚å¦‚æœNä¸ªè§¦å‘å™¨åŒæ—¶è§¦å‘ï¼Œä½†å½“å‰åªæœ‰Zä¸ªå·¥ä½œçº¿ç¨‹å¯ç”¨ï¼Œåˆ™é¦–å…ˆæ‰§è¡Œå…·æœ‰æœ€é«˜ä¼˜å…ˆçº§çš„Zä¸ªè§¦å‘å™¨ã€‚å¦‚æœæ‚¨æ²¡æœ‰åœ¨è§¦å‘å™¨ä¸Šè®¾ç½®ä¼˜å…ˆçº§ï¼Œé‚£ä¹ˆå®ƒå°†ä½¿ç”¨é»˜è®¤ä¼˜å…ˆçº§5ã€‚priorityå±æ€§çš„å€¼å¯ä»¥æ˜¯ä»»æ„æ•´æ•°ï¼Œæ­£æ•°æˆ–è€…è´Ÿæ•°éƒ½æ˜¯å…è®¸çš„ã€‚ æ³¨æ„ï¼šåªæœ‰åŒæ—¶è§¦å‘çš„Triggerä¹‹é—´æ‰ä¼šæ¯”è¾ƒä¼˜å…ˆçº§ã€‚10:59è§¦å‘çš„Triggeræ€»æ˜¯åœ¨11:00è§¦å‘çš„Triggerä¹‹å‰æ‰§è¡Œã€‚ æ³¨æ„ï¼šå¦‚æœTriggeræ˜¯å¯æ¢å¤çš„ï¼Œåœ¨æ¢å¤åå†è°ƒåº¦æ—¶ï¼Œä¼˜å…ˆçº§ä¸åŸTriggeræ˜¯ä¸€æ ·çš„ã€‚ Misfire Instructions(é”™è¿‡è§¦å‘ç­–ç•¥) Triggerè¿˜æœ‰ä¸€ä¸ªé‡è¦çš„å±æ€§misfireï¼ˆè¿™é‡Œåº”è¯¥ç§°ä¸ºâ€œé”™è¿‡è§¦å‘ç­–ç•¥â€æ›´åˆç†ï¼Œæœ¬è´¨å°±æ˜¯ä¸€æ¬¡å¤„ç†è§¦å‘å™¨é”™å¤±è§¦å‘çš„ç­–ç•¥ï¼‰ï¼›å¦‚æœSchedulerå…³é—­äº†ï¼Œæˆ–è€…Quartzçº¿ç¨‹æ± ä¸­æ²¡æœ‰å¯ç”¨çš„çº¿ç¨‹æ¥æ‰§è¡ŒjJbï¼Œæ­¤æ—¶æŒä¹…æ€§çš„Triggerå°±ä¼šé”™è¿‡(miss)å…¶è§¦å‘æ—¶é—´ï¼Œå³é”™è¿‡è§¦å‘(misfire)ã€‚ä¸åŒç±»å‹çš„Triggerï¼Œæœ‰ä¸åŒçš„misfireæœºåˆ¶ã€‚å®ƒä»¬é»˜è®¤éƒ½ä½¿ç”¨â€œæ™ºèƒ½æœºåˆ¶(smart policy)â€ï¼Œå³æ ¹æ®Triggerçš„ç±»å‹å’Œé…ç½®åŠ¨æ€è°ƒæ•´è¡Œä¸ºã€‚å½“Schedulerå¯åŠ¨çš„æ—¶å€™ï¼ŒæŸ¥è¯¢æ‰€æœ‰é”™è¿‡è§¦å‘(misfire)çš„æŒä¹…åŒ–çš„Triggerã€‚ç„¶åæ ¹æ®å®ƒä»¬å„è‡ªçš„misfireæœºåˆ¶æ›´æ–°Triggerçš„ä¿¡æ¯ã€‚å½“ä½ åœ¨é¡¹ç›®ä¸­ä½¿ç”¨Quartzæ—¶ï¼Œä½ åº”è¯¥å¯¹å„ç§ç±»å‹çš„Triggerçš„misfireæœºåˆ¶éƒ½æ¯”è¾ƒç†Ÿæ‚‰ï¼Œè¿™äº›misfireæœºåˆ¶åœ¨JavaDocä¸­æœ‰è¯´æ˜ã€‚å…³äºmisfireæœºåˆ¶çš„ç»†èŠ‚ï¼Œä¼šåœ¨è®²åˆ°å…·ä½“çš„Triggeræ—¶å†ä½œä»‹ç»ã€‚ Calendar(æ—¥å†) Quartzçš„org.quartz.Calendarå¯¹è±¡(ä¸æ˜¯java.util.Calendarå¯¹è±¡)å¯ä»¥åœ¨å®šä¹‰å’Œå­˜å‚¨Triggerçš„æ—¶å€™ä¸Triggerè¿›è¡Œå…³è”ã€‚Calendarç”¨äºä»Triggerçš„è°ƒåº¦è®¡åˆ’ä¸­æ’é™¤æ—¶é—´æ®µã€‚æ¯”å¦‚ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªTriggerï¼Œæ¯ä¸ªå·¥ä½œæ—¥çš„ä¸Šåˆ9:30æ‰§è¡Œï¼Œç„¶åå¢åŠ ä¸€ä¸ªCalendarï¼Œæ’é™¤æ‰æ‰€æœ‰çš„ä¸šåŠ¡å‡æœŸ(ä¹Ÿå°±æ˜¯å·¥ä½œæ—¥ä¸­çš„æ³•å®šå‡æœŸ)ã€‚ ä»»ä½•å®ç°äº†Calendaræ¥å£çš„å¯åºåˆ—åŒ–å¯¹è±¡éƒ½å¯ä»¥ä½œä¸ºCalendarå¯¹è±¡ï¼ŒCalendaræ¥å£å¦‚ä¸‹ï¼š 123456789package org.quartz;public interface Calendar &#123; public boolean isTimeIncluded(long timeStamp); public long getNextIncludedTime(long timeStamp);&#125; è¯‘è€…åæ§½ï¼šè¿™é‡Œè´´å‡ºæ¥çš„Calendaræ¥å£çš„æºç ä¼°è®¡æ˜¯è€ç‰ˆæœ¬çš„org.quartz.Calendaræ¥å£ï¼Œå¯¹æ¯”äº†ä¸‹2.2.xç‰ˆæœ¬çš„åŒä¸€ä¸ªæ¥å£å¹¶ä¸æ˜¯é•¿è¿™æ ·çš„ã€‚ æ³¨æ„åˆ°è¿™äº›æ–¹æ³•çš„å‚æ•°ç±»å‹ä¸ºlongã€‚ä½ ä¹Ÿè®¸çŒœåˆ°äº†ï¼Œä»–ä»¬å°±æ˜¯æ¯«ç§’å•ä½çš„æ—¶é—´æˆ³ã€‚å³Calendaræ’é™¤æ—¶é—´æ®µçš„å•ä½å¯ä»¥ç²¾ç¡®åˆ°æ¯«ç§’ã€‚ä½ ä¹Ÿè®¸å¯¹â€œæ’é™¤ä¸€æ•´å¤©â€çš„Calendaræ¯”è¾ƒæ„Ÿå…´è¶£ã€‚Quartzæä¾›çš„org.quartz.impl.HolidayCalendarç±»å¯ä»¥å¾ˆæ–¹ä¾¿åœ°å®ç°ã€‚ Calendarå¿…é¡»å…ˆå®ä¾‹åŒ–ï¼Œç„¶åé€šè¿‡addCalendar()æ–¹æ³•æ³¨å†Œåˆ°Schedulerã€‚å¦‚æœä½¿ç”¨HolidayCalendarï¼Œå®ä¾‹åŒ–åï¼Œéœ€è¦è°ƒç”¨addExcludedDate(Date date)æ–¹æ³•ä»è°ƒåº¦è®¡åˆ’ä¸­æ’é™¤æ—¶é—´æ®µã€‚ä»¥ä¸‹ç¤ºä¾‹æ˜¯å°†åŒä¸€ä¸ªCalendarå®ä¾‹ç”¨äºå¤šä¸ªTriggerï¼š 123456789101112131415161718192021222324HolidayCalendar cal = new HolidayCalendar();cal.addExcludedDate( someDate );cal.addExcludedDate( someOtherDate );sched.addCalendar(\"myHolidays\", cal, false);Trigger t = newTrigger() .withIdentity(\"myTrigger\") .forJob(\"myJob\") .withSchedule(dailyAtHourAndMinute(9, 30)) // execute job daily at 9:30 .modifiedByCalendar(\"myHolidays\") // but not on holidays .build();// .. schedule job with triggerTrigger t2 = newTrigger() .withIdentity(\"myTrigger2\") .forJob(\"myJob2\") .withSchedule(dailyAtHourAndMinute(11, 30)) // execute job daily at 11:30 .modifiedByCalendar(\"myHolidays\") // but not on holidays .build();// .. schedule job with trigger2 æ¥ä¸‹æ¥çš„å‡ ä¸ªç« èŠ‚å°†ä»‹ç»è§¦å‘å™¨çš„æ„å»º/æ„å»ºç»†èŠ‚ã€‚ç°åœ¨ï¼Œåªè¦æ˜ç¡®ä¸Šé¢çš„ä»£ç ä¼šåˆ›å»ºä¸¤ä¸ªè§¦å‘å™¨ï¼Œæ¯ä¸ªè§¦å‘å™¨éƒ½è®¡åˆ’æ¯å¤©è§¦å‘ä¸€æ¬¡ã€‚ä½†æ˜¯ï¼Œåœ¨æ—¥å†ï¼ˆCalendarï¼‰æ’é™¤çš„æœŸé—´å†…å‘ç”Ÿçš„ä»»ä½•è§¦å‘éƒ½å°†è¢«è·³è¿‡ã€‚ è¯·å‚é˜…org.quartz.impl.calendaråŒ…ï¼Œäº†è§£é€‚åˆä½ çš„Calendarå®ç°ã€‚ åŸæ–‡é“¾æ¥ï¼štutorial-lesson-04","categories":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/categories/Middleware/"},{"name":"Quartz","slug":"Middleware/Quartz","permalink":"http://throwable.club/blog/categories/Middleware/Quartz/"}],"tags":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/tags/Middleware/"},{"name":"Quartz","slug":"Quartz","permalink":"http://throwable.club/blog/tags/Quartz/"}]},{"title":"ç¬¬ä¸‰ç« ï¼šJobå’ŒJobDetailçš„æ›´å¤šç»†èŠ‚","slug":"quartz-doc-translation-lesson-3","date":"2019-03-29T17:41:59.000Z","updated":"2019-03-29T17:51:04.624Z","comments":true,"path":"2019/03/30/quartz-doc-translation-lesson-3/","link":"","permalink":"http://throwable.club/2019/03/30/quartz-doc-translation-lesson-3/","excerpt":"","text":"ç¬¬ä¸‰ç« ï¼šJobå’ŒJobDetailçš„æ›´å¤šç»†èŠ‚ æ­£å¦‚ä½ åœ¨ç¬¬äºŒç« ï¼šQuartz APIã€è°ƒåº¦ä»»åŠ¡ä»¥åŠè§¦å‘å™¨çœ‹åˆ°çš„ï¼Œorg.quartz.Jobå¾ˆå®¹æ˜“å®ç°ï¼Œåœ¨æ¥å£ä¸­åªæœ‰ä¸€ä¸ªexecuteæ–¹æ³•ã€‚æœ¬èŠ‚ä¸»è¦å…³æ³¨ï¼šJobçš„ç‰¹ç‚¹ã€Jobæ¥å£çš„executeæ–¹æ³•ä»¥åŠJobDetailã€‚ ä½ å®šä¹‰äº†ä¸€ä¸ªå®ç°Jobæ¥å£çš„ç±»ï¼Œè¿™ä¸ªç±»ä»…ä»…è¡¨æ˜è¯¥Jobéœ€è¦å®Œæˆä»€ä¹ˆç±»å‹çš„ä»»åŠ¡ï¼Œé™¤æ­¤ä¹‹å¤–ï¼ŒQuartzè¿˜éœ€è¦çŸ¥é“è¯¥Jobå®ä¾‹æ‰€åŒ…å«çš„å±æ€§ï¼›è¿™å°†ç”±JobDetailç±»æ¥å®Œæˆã€‚ JobDetailå®ä¾‹æ˜¯é€šè¿‡JobBuilderç±»åˆ›å»ºçš„ï¼Œå¯¼å…¥è¯¥ç±»ä¸‹çš„æ‰€æœ‰é™æ€æ–¹æ³•ï¼Œä¼šè®©ä½ ç¼–ç æ—¶æœ‰DSLçš„æ„Ÿè§‰ï¼š 1import static org.quartz.JobBuilder.*; è®©æˆ‘ä»¬å…ˆçœ‹çœ‹Jobçš„ç‰¹å¾ï¼ˆnatureï¼‰ä»¥åŠJobå®ä¾‹çš„ç”Ÿå‘½æœŸã€‚ä¸å¦¨å…ˆå›å¤´çœ‹çœ‹ç¬¬ä¸€ç« ï¼šä½¿ç”¨Quartzä¸­çš„ä»£ç ç‰‡æ®µï¼š 12345678910111213141516// define the job and tie it to our HelloJob class JobDetail job = newJob(HelloJob.class) .withIdentity(\"myJob\", \"group1\") // name \"myJob\", group \"group1\" .build(); // Trigger the job to run now, and then every 40 seconds Trigger trigger = newTrigger() .withIdentity(\"myTrigger\", \"group1\") .startNow() .withSchedule(simpleSchedule() .withIntervalInSeconds(40) .repeatForever()) .build(); // Tell quartz to schedule the job using our trigger sched.scheduleJob(job, trigger); ç°åœ¨è¿™æ ·å®šä¹‰ä¸‹é¢è¿™æ ·çš„ä¸€ä¸ªè°ƒåº¦ä»»åŠ¡ç±»â€œHelloJobâ€ï¼š 12345678910public class HelloJob implements Job &#123; public HelloJob() &#123; &#125; public void execute(JobExecutionContext context) throws JobExecutionException&#123; System.err.println(\"Hello! HelloJob is executing.\"); &#125; &#125; å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬ä¼ ç»™Schedulerä¸€ä¸ªJobDetailå®ä¾‹ï¼Œå› ä¸ºæˆ‘ä»¬åœ¨åˆ›å»ºJobDetailæ—¶ï¼Œå°†è¦æ‰§è¡Œçš„Jobçš„ç±»å(ç±»å‹)ä¼ ç»™äº†JobDetailï¼Œæ‰€ä»¥Schedulerå°±çŸ¥é“äº†è¦æ‰§è¡Œä½•ç§ç±»å‹çš„Jobï¼›æ¯æ¬¡å½“Scheduleræ‰§è¡ŒJobæ—¶ï¼Œåœ¨è°ƒç”¨å…¶execute(â€¦)æ–¹æ³•ä¹‹å‰ä¼šåˆ›å»ºè¯¥ç±»çš„ä¸€ä¸ªæ–°çš„å®ä¾‹ï¼›æ‰§è¡Œå®Œæ¯•ï¼Œå¯¹è¯¥å®ä¾‹çš„å¼•ç”¨å°±è¢«ä¸¢å¼ƒäº†ï¼Œå®ä¾‹ä¼šè¢«åƒåœ¾å›æ”¶ï¼›è¿™ç§æ‰§è¡Œç­–ç•¥å¸¦æ¥çš„ä¸€ä¸ªåæœæ˜¯ï¼ŒJobå¿…é¡»æœ‰ä¸€ä¸ªæ— å‚çš„æ„é€ å‡½æ•°ï¼ˆå½“ä½¿ç”¨é»˜è®¤çš„JobFactoryæ—¶ï¼‰ï¼›å¦ä¸€ä¸ªåæœæ˜¯ï¼Œåœ¨Jobç±»ä¸­ï¼Œä¸åº”è¯¥å®šä¹‰æœ‰çŠ¶æ€çš„æ•°æ®å±æ€§ï¼Œå› ä¸ºåœ¨Jobçš„å¤šæ¬¡æ‰§è¡Œä¸­ï¼Œè¿™äº›å±æ€§çš„å€¼ä¸ä¼šä¿ç•™ã€‚ è¯‘è€…æ³¨ï¼šè¿™é‡Œåˆä¸€æ¬¡å¼ºè°ƒäº†Jobæ˜¯æ— çŠ¶æ€çš„ã€‚å¦å¤–ï¼Œå¯ä»¥å®ç°è‡ªå®šä¹‰çš„JobFactoryæ¥æ”¹å˜è·å–Jobå®ä¾‹çš„æ–¹å¼ï¼Œä¾‹å¦‚ä»Springçš„IOCå®¹å™¨ä¸­è·å–ï¼Œè¿™æ ·å°±ä¸ç”¨æ¯æ¬¡æ–°å»ºä¸€ä¸ªJobå®ä¾‹å†æ‰§è¡Œã€‚ é‚£ä¹ˆå¦‚ä½•ç»™Jobå®ä¾‹å¢åŠ å±æ€§æˆ–é…ç½®å‘¢ï¼Ÿå¦‚ä½•åœ¨Jobçš„å¤šæ¬¡æ‰§è¡Œä¸­ï¼Œè·Ÿè¸ªJobçš„çŠ¶æ€å‘¢ï¼Ÿç­”æ¡ˆå°±æ˜¯:JobDataMapï¼ŒJobDetailå¯¹è±¡çš„ä¸€éƒ¨åˆ†ã€‚ JobDataMap JobDataMapä¸­å¯ä»¥åŒ…å«ä¸é™é‡çš„ï¼ˆåºåˆ—åŒ–çš„ï¼‰æ•°æ®å¯¹è±¡ï¼Œåœ¨Jobå®ä¾‹æ‰§è¡Œçš„æ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨å…¶ä¸­çš„æ•°æ®ï¼›JobDataMapæ˜¯java.util.Mapæ¥å£çš„ä¸€ä¸ªå®ç°ï¼Œé¢å¤–å¢åŠ äº†ä¸€äº›ä¾¿äºå­˜å–åŸºæœ¬ç±»å‹çš„æ•°æ®çš„æ–¹æ³•ã€‚ å°†JobåŠ å…¥åˆ°Schedulerä¹‹å‰ï¼Œåœ¨æ„å»ºJobDetailæ—¶ï¼Œå¯ä»¥å°†æ•°æ®æ”¾å…¥JobDataMapï¼Œå¦‚ä¸‹ç¤ºä¾‹ï¼š 123456// define the job and tie it to our DumbJob class JobDetail job = newJob(DumbJob.class) .withIdentity(\"myJob\", \"group1\") // name \"myJob\", group \"group1\" .usingJobData(\"jobSays\", \"Hello World!\") .usingJobData(\"myFloatValue\", 3.141f) .build(); åœ¨Jobçš„æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå¯ä»¥ä»JobDataMapä¸­å–å‡ºæ•°æ®ï¼Œå¦‚ä¸‹ç¤ºä¾‹ï¼š 123456789101112131415161718public class DumbJob implements Job &#123; public DumbJob() &#123; &#125; public void execute(JobExecutionContext context) throws JobExecutionException &#123; JobKey key = context.getJobDetail().getKey(); JobDataMap dataMap = context.getJobDetail().getJobDataMap(); String jobSays = dataMap.getString(\"jobSays\"); float myFloatValue = dataMap.getFloat(\"myFloatValue\"); System.err.println(\"Instance \" + key + \" of DumbJob says: \" + jobSays + \", and val is: \" + myFloatValue); &#125; &#125; **å¦‚æœæ‚¨ä½¿ç”¨å…·å¤‡æŒä¹…åŒ–ç‰¹æ€§çš„JobStoreï¼ˆåœ¨æœ¬æ•™ç¨‹çš„JobStoreéƒ¨åˆ†ä¸­è¿›è¡Œäº†è®¨è®ºï¼‰ï¼Œæ‚¨åº”è¯¥è°¨æ…å†³å®šæ”¾ç½®åœ¨JobDataMapä¸­çš„å†…å®¹ï¼Œå› ä¸ºå…¶ä¸­çš„å¯¹è±¡å°†è¢«åºåˆ—åŒ–ï¼Œå› æ­¤å®ƒä»¬å®¹æ˜“å‡ºç°ç±»ç‰ˆæœ¬é—®é¢˜ã€‚**æ˜¾ç„¶ï¼Œæ ‡å‡†çš„Javaç±»å‹åº”è¯¥æ˜¯éå¸¸å®‰å…¨çš„ï¼Œä½†é™¤æ­¤ä¹‹å¤–ï¼Œä»»ä½•æ—¶å€™æœ‰äººæ”¹å˜ä½ å·²ç»åºåˆ—åŒ–äº†å®ä¾‹çš„ç±»çš„å®šä¹‰æ—¶ï¼Œéƒ½å¿…é¡»æ³¨æ„ä¸è¦æ‰“ç ´å…¼å®¹æ€§ã€‚å¦å¤–ï¼Œä½ å¯ä»¥å¼ºåˆ¶è¦æ±‚JDBC-JobStoreå’ŒJobDataMapåªå…è®¸åœ¨JobDataMapä¸­å­˜å‚¨åŸºæœ¬ç±»å‹å’Œå­—ç¬¦ä¸²ç±»å‹ï¼Œè¿™æ ·å¯ä»¥é¿å…åç»­çš„åºåˆ—åŒ–é—®é¢˜ã€‚ å¦‚æœä½ åœ¨Jobçš„å®ç°ç±»ä¸­ï¼Œä¸ºJobDataMapä¸­å­˜å‚¨çš„æ•°æ®çš„keyå¢åŠ setæ–¹æ³•ï¼ˆå¦‚åœ¨ä¸Šé¢ç¤ºä¾‹ä¸­ï¼Œå¢åŠ setJobSays(String val)æ–¹æ³•ï¼‰ï¼Œé‚£ä¹ˆQuartzçš„é»˜è®¤JobFactoryå®ç°åœ¨Jobè¢«å®ä¾‹åŒ–çš„æ—¶å€™ä¼šè‡ªåŠ¨è°ƒç”¨è¿™äº›setæ–¹æ³•ï¼Œè¿™æ ·ä½ å°±ä¸éœ€è¦åœ¨execute()æ–¹æ³•ä¸­æ˜¾å¼åœ°ä»JobDataMapä¸­å–æ•°æ®äº†ã€‚ å¦‚æœä½ æœ‰ä¸€ä¸ªå­˜å‚¨åœ¨è°ƒåº¦å™¨ä¸­çš„è°ƒåº¦ä»»åŠ¡ï¼Œä¾›å¤šä¸ªè§¦å‘å™¨å®šæœŸ/é‡å¤ä½¿ç”¨ï¼Œä½†æ¯æ¬¡ç‹¬ç«‹è§¦å‘ï¼Œåˆ™å¸Œæœ›ä¸ºä½œä¸šæä¾›ä¸åŒçš„æ•°æ®è¾“å…¥ï¼Œå¯ä»¥ä¸ºè§¦å‘å™¨å®šä¹‰ä¸ä¹‹å…³è”çš„JobDataMapã€‚ åœ¨Jobæ‰§è¡Œæ—¶ï¼ŒJobExecutionContextä¸­çš„JobDataMapä¸ºæˆ‘ä»¬æä¾›äº†å¾ˆå¤šçš„ä¾¿åˆ©ã€‚å®ƒæ˜¯JobDetailä¸­çš„JobDataMapå’ŒTriggerä¸­çš„JobDataMapçš„æ•°æ®å¹¶é›†ï¼Œä½†æ˜¯å¦‚æœå­˜åœ¨ç›¸åŒçš„æ•°æ®ï¼Œåˆ™åæ·»åŠ è€…ä¼šè¦†ç›–ä¹‹å‰æ·»åŠ çš„Keyç›¸åŒçš„å€¼ï¼ˆæ¯•ç«Ÿå°±æ˜¯ä¸€ä¸ªjava.util.Mapçš„å®ä¾‹ï¼‰ã€‚ ä»¥ä¸‹æ˜¯åœ¨ä½œä¸šæ‰§è¡ŒæœŸé—´ä»JobExecutionContextçš„åˆå¹¶JobDataMapè·å–æ•°æ®çš„ç®€å•ç¤ºä¾‹ï¼š 1234567891011121314151617181920public class DumbJob implements Job &#123; public DumbJob() &#123; &#125; public void execute(JobExecutionContext context) throws JobExecutionException &#123; JobKey key = context.getJobDetail().getKey(); JobDataMap dataMap = context.getMergedJobDataMap(); // Note the difference from the previous example String jobSays = dataMap.getString(\"jobSays\"); float myFloatValue = dataMap.getFloat(\"myFloatValue\"); ArrayList state = (ArrayList)dataMap.get(\"myStateData\"); state.add(new Date()); System.err.println(\"Instance \" + key + \" of DumbJob says: \" + jobSays + \", and val is: \" + myFloatValue); &#125; &#125; å¦‚æœä½ å¸Œæœ›ä½¿ç”¨JobFactoryå®ç°æ•°æ®çš„è‡ªåŠ¨â€œæ³¨å…¥â€åŠŸèƒ½ï¼Œåˆ™ç¤ºä¾‹ä»£ç ä¸ºï¼š 1234567891011121314151617181920212223242526272829303132333435public class DumbJob implements Job &#123; String jobSays; float myFloatValue; ArrayList state; public DumbJob() &#123; &#125; public void execute(JobExecutionContext context) throws JobExecutionException &#123; JobKey key = context.getJobDetail().getKey(); JobDataMap dataMap = context.getMergedJobDataMap(); // Note the difference from the previous example state.add(new Date()); System.err.println(\"Instance \" + key + \" of DumbJob says: \" + jobSays + \", and val is: \" + myFloatValue); &#125; public void setJobSays(String jobSays) &#123; this.jobSays = jobSays; &#125; public void setMyFloatValue(float myFloatValue) &#123; myFloatValue = myFloatValue; &#125; public void setState(ArrayList state) &#123; state = state; &#125;&#125; ä½ ä¼šæ³¨æ„åˆ°è¯¥ç±»çš„æ•´ä½“ä»£ç æ›´é•¿ï¼Œä½†execute()æ–¹æ³•ä¸­çš„ä»£ç æ›´ç®€æ´æ¸…æ™°ã€‚è€Œä¸”ï¼Œè™½ç„¶ä»£ç æ›´å¤šäº†ï¼Œä½†å¦‚æœä½ çš„IDEå¯ä»¥è‡ªåŠ¨ç”ŸæˆSetteræ–¹æ³•ï¼Œä½ å°±ä¸éœ€è¦å†™ä»£ç è°ƒç”¨ç›¸åº”çš„æ–¹æ³•ä»JobDataMapä¸­è·å–æ•°æ®äº†ï¼Œæ‰€ä»¥ä½ å®é™…éœ€è¦ç¼–å†™çš„ä»£ç æ›´å°‘äº†ã€‚å½“å‰ï¼Œå¦‚ä½•é€‰æ‹©ï¼Œç”±ä½ å†³å®šã€‚ Jobå®ä¾‹ å¾ˆå¤šä½¿ç”¨è€…å¯¹äºJobå®ä¾‹åˆ°åº•ç”±ä»€ä¹ˆæ„æˆæ„Ÿåˆ°å¾ˆè¿·æƒ‘ã€‚æˆ‘ä»¬å°†å°è¯•åœ¨è¿™é‡Œè§£é‡Šä¸€ä¸‹ï¼Œå¹¶ä¸”åœ¨ä¸‹é¢çš„éƒ¨åˆ†ä¸­è§£é‡Šå…³äºè°ƒåº¦ä»»åŠ¡çŠ¶æ€å’Œå¹¶å‘æ€§ç›¸å…³å†…å®¹ã€‚ æ‚¨å¯ä»¥åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„Jobç±»ï¼Œå¹¶é€šè¿‡åˆ›å»ºJobDetailsçš„å¤šä¸ªå®ä¾‹ï¼ˆæ¯ä¸ªå®ä¾‹å…·æœ‰è‡ªå·±çš„å±æ€§é›†å’ŒJobDataMapï¼‰ï¼Œæœ€åï¼Œå°†æ‰€æœ‰çš„Jobå®ä¾‹éƒ½æ·»åŠ åŠ åˆ°Schedulerä¸­ã€‚ ä¾‹å¦‚ï¼Œä½ å¯ä»¥åˆ›å»ºä¸€ä¸ªå®ç°Jobæ¥å£çš„ç±»ï¼Œåä¸ºâ€œSalesReportJobâ€ã€‚è¯¥Jobéœ€è¦ä¸€ä¸ªå‚æ•°ï¼ˆé€šè¿‡JobDataMapä¼ å…¥ï¼‰æŒ‡å®šé”€å”®æŠ¥å‘Šåº”è¯¥åŸºäºçš„é”€å”®äººå‘˜çš„åç§°ã€‚ç„¶åï¼Œä½ å¯ä»¥åˆ›å»ºå¤šä¸ªJobå®ä¾‹ï¼ˆJobDetailsï¼‰ï¼Œæ¯”å¦‚â€œSalesReportForJoeâ€ã€â€œSalesReportForMikeâ€ï¼Œå°†â€œjoeâ€å’Œâ€œmikeâ€ä½œä¸ºJobDataMapçš„æ•°æ®ä¼ ç»™å¯¹åº”çš„Jobå®ä¾‹ã€‚ å½“è§¦å‘å™¨è§¦å‘æ—¶ï¼Œå®ƒæ‰€å…³è”çš„JobDetailï¼ˆå®ä¾‹å®šä¹‰ï¼‰å°†è¢«åŠ è½½ï¼Œå¹¶ä¸”å®ƒå¼•ç”¨çš„ä½œä¸šç±»å°†é€šè¿‡Schedulerä¸Šé…ç½®çš„JobFactoryå®ä¾‹åŒ–ã€‚é»˜è®¤çš„JobFactoryåªæ˜¯åœ¨ä½œä¸šç±»ä¸Šè°ƒç”¨newInstance()ï¼Œç„¶åå°è¯•è°ƒç”¨è¯¥ç±»çš„åŒ¹é…JobDataMapä¸­çš„é”®çš„åç§°çš„setteræ–¹æ³•ã€‚ä½ å¯èƒ½å¸Œæœ›åˆ›å»ºè‡ªå·±çš„JobFactoryå®ç°æ¥å®Œæˆè¯¸å¦‚è®©åº”ç”¨ç¨‹åºçš„IoCæˆ–DIå®¹å™¨ç”Ÿæˆ/åˆå§‹åŒ–Jobå®ä¾‹ç­‰äº‹æƒ…ã€‚ åœ¨Quartzçš„æè¿°è¯­è¨€ä¸­ï¼Œæˆ‘ä»¬å°†æ¯ä¸ªå­˜å‚¨çš„JobDetailç§°ä¸ºâ€œJobå®šä¹‰â€æˆ–â€œJobDetailå®ä¾‹â€ï¼Œå¹¶å°†æ¯ä¸ªæ­£åœ¨æ‰§è¡Œçš„ä½œä¸šç§°ä¸ºâ€œJobå®ä¾‹â€æˆ–â€œJobå®šä¹‰çš„å®ä¾‹â€ã€‚é€šå¸¸ï¼Œå¦‚æœæˆ‘ä»¬åªä½¿ç”¨â€œJobâ€è¿™ä¸ªè¯ï¼Œæˆ‘ä»¬å°±æ˜¯æŒ‡ä¸€ä¸ªå‘½åå®šä¹‰ï¼Œæˆ–è€…JobDetailã€‚å½“æˆ‘ä»¬æŒ‡çš„æ˜¯å®ç°å·¥ä½œç•Œé¢çš„ç±»æ—¶ï¼Œæˆ‘ä»¬é€šå¸¸ä½¿ç”¨æœ¯è¯­â€œJobç±»â€ã€‚ Jobçš„çŠ¶æ€å’Œå¹¶å‘æ€§ å…³äºJobçŠ¶æ€æ•°æ®ï¼ˆä¹Ÿå°±æ˜¯JobDataMapï¼‰å’Œå¹¶å‘æ€§è¿˜æœ‰ä¸€äº›å†…å®¹éœ€è¦è¡¥å……ã€‚æœ‰å‡ ä¸ªæ³¨é‡Šå¯ä»¥æ·»åŠ åˆ°ä½ çš„Jobç±»ä¸­ï¼Œè¿™äº›æ³¨è§£ä¼šå½±å“Jobçš„çŠ¶æ€å’Œå¹¶å‘æ€§ã€‚ @DisallowConcurrentExecutionæ˜¯ä¸€ä¸ªæ³¨è§£ï¼Œå¯ä»¥æ·»åŠ åˆ°Jobç±»ä¸­ï¼Œå‘Šè¯‰Quartzä¸è¦åŒæ—¶æ‰§è¡Œç»™å®šJobå®šä¹‰ï¼ˆæŒ‡ç»™å®šJobç±»ï¼‰çš„å¤šä¸ªå®ä¾‹ã€‚ æ³¨æ„è¿™é‡Œçš„æªè¯ã€‚æ‹¿å‰ä¸€å°èŠ‚çš„ä¾‹å­æ¥è¯´ï¼Œå¦‚æœâ€œSalesReportJobâ€ç±»ä¸Šæœ‰è¯¥æ³¨è§£ï¼Œåˆ™åŒä¸€æ—¶åˆ»ä»…å…è®¸æ‰§è¡Œä¸€ä¸ªâ€œSalesReportForJoeâ€å®ä¾‹ï¼Œä½†å¯ä»¥å¹¶å‘åœ°æ‰§è¡Œâ€œSalesReportForMikeâ€ç±»çš„ä¸€ä¸ªå®ä¾‹ã€‚æ‰€ä»¥è¯¥é™åˆ¶æ˜¯é’ˆå¯¹JobDetailçš„ï¼Œè€Œä¸æ˜¯Jobç±»ã€‚ä½†æ˜¯æˆ‘ä»¬è®¤ä¸ºï¼ˆåœ¨è®¾è®¡Quartzçš„æ—¶å€™ï¼‰åº”è¯¥å°†è¯¥æ³¨è§£æ”¾åœ¨Jobç±»ä¸Šï¼Œå› ä¸ºJobç±»çš„æ”¹å˜ç»å¸¸ä¼šå¯¼è‡´å…¶è¡Œä¸ºå‘ç”Ÿå˜åŒ–ã€‚ @PersistJobDataAfterExecutionæ˜¯ä¸€ä¸ªæ³¨è§£ï¼Œå¯ä»¥æ·»åŠ åˆ°Jobç±»ä¸­ï¼Œå‘Šè¯‰Quartzåœ¨execute()æ–¹æ³•æˆåŠŸå®Œæˆåï¼ˆä¸æŠ›å‡ºå¼‚å¸¸ï¼‰æ›´æ–°JobDetailçš„JobDataMapçš„å­˜å‚¨å‰¯æœ¬æ•°æ®ï¼Œä½¿å¾—è¯¥Jobï¼ˆå³JobDetailï¼‰åœ¨ä¸‹ä¸€æ¬¡æ‰§è¡Œçš„æ—¶å€™ï¼ŒJobDataMapä¸­æ˜¯æ›´æ–°åçš„æ•°æ®ï¼Œè€Œä¸æ˜¯æ›´æ–°å‰çš„æ—§æ•°æ®ã€‚åƒ @DisallowConcurrentExecutionæ³¨è§£ä¸€æ ·ï¼Œå°½ç®¡æ³¨è§£æ˜¯åŠ åœ¨Jobç±»ä¸Šçš„ï¼Œä½†å…¶é™åˆ¶ä½œç”¨æ˜¯é’ˆå¯¹Jobå®ä¾‹çš„ï¼Œè€Œä¸æ˜¯Jobç±»çš„ã€‚ç”±Jobç±»æ¥æ‰¿è½½è¯¥æ³¨è§£ï¼Œæ˜¯å› ä¸ºæ­¤æ³¨è§£çš„åŠŸèƒ½ä¼šå½±å“ç±»çš„ç¼–ç æ–¹å¼ï¼ˆä¾‹å¦‚ï¼Œâ€˜æœ‰çŠ¶æ€â€™éœ€è¦è¢«æ‰§è¡Œæ–¹æ³•å†…çš„ä»£ç æ˜ç¡®â€™ç†è§£â€™â€“&gt; è¿™é‡ŒåŸæ–‡æ˜¯e.g. the â€˜statefulnessâ€™ will need to be explicitly â€˜understoodâ€™ by the code within the execute methodï¼‰ã€‚ å¦‚æœä½ ä½¿ç”¨äº†@PersistJobDataAfterExecutionæ³¨è§£ï¼Œæˆ‘ä»¬å¼ºçƒˆå»ºè®®ä½ åŒæ—¶ä½¿ç”¨@DisallowConcurrentExecutionæ³¨è§£ï¼Œå› ä¸ºå½“åŒä¸€ä¸ªJobï¼ˆJobDetailï¼‰çš„ä¸¤ä¸ªå®ä¾‹è¢«å¹¶å‘æ‰§è¡Œæ—¶ï¼Œç”±äºç«äº‰ï¼ŒJobDataMapä¸­å­˜å‚¨çš„æ•°æ®å¾ˆå¯èƒ½æ˜¯ä¸ç¡®å®šçš„ã€‚ Jobçš„å…¶ä»–å±æ€§ é€šè¿‡JobDetailå¯¹è±¡ï¼Œå¯ä»¥ç»™Jobå®ä¾‹é…ç½®çš„å…¶å®ƒå±æ€§æœ‰ï¼š Durabilityï¼šæŒä¹…åŒ–ç‰¹æ€§ï¼Œå¸ƒå°”å€¼ã€‚å¦‚æœä¸€ä¸ªJobæ˜¯éæŒä¹…çš„ï¼Œå½“æ²¡æœ‰æ´»è·ƒçš„Triggerä¸ä¹‹å…³è”çš„æ—¶å€™ï¼Œä¼šè¢«è‡ªåŠ¨åœ°ä»Schedulerä¸­åˆ é™¤ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒéæŒä¹…çš„Jobçš„ç”Ÿå‘½æœŸæ˜¯ç”±Triggerçš„å­˜åœ¨ä¸å¦å†³å®šçš„ã€‚ RequestsRecovery - è¯·æ±‚æ¢å¤ç‰¹æ€§ï¼Œå¸ƒå°”å€¼ã€‚å¦‚æœä¸€ä¸ªJobæ˜¯å¯æ¢å¤çš„ï¼Œå¹¶ä¸”åœ¨å…¶æ‰§è¡Œçš„æ—¶å€™ï¼ŒSchedulerå‘å¼ºåˆ¶å…³é—­ï¼ˆhard shutdown)ï¼ˆæ¯”å¦‚è¿è¡Œçš„è¿›ç¨‹å´©æºƒäº†æˆ–è€…æœåŠ¡å™¨å®•æœºäº†ï¼‰ï¼Œåˆ™å½“Scheduleré‡æ–°å¯åŠ¨çš„æ—¶å€™ï¼Œè¯¥Jobä¼šè¢«é‡æ–°æ‰§è¡Œã€‚æ­¤æ—¶ï¼Œè¯¥Jobçš„JobExecutionContext.isRecovering()è¿”å›trueã€‚ è¿™ä¸¤ä¸ªå±æ€§åœ¨JobBuilderä¸­éƒ½æœ‰ç›¸åº”çš„è®¾ç½®æ–¹æ³•ã€‚ JobExecutionException æœ€åï¼Œæˆ‘ä»¬éœ€è¦é€šçŸ¥ä½ å…³äºè¯¥Job.execute(..)æ–¹æ³•çš„ä¸€äº›ç»†èŠ‚ã€‚å”¯ä¸€å¯ä»¥ä»executeæ–¹æ³•æŠ›å‡ºçš„å¼‚å¸¸ï¼ˆåŒ…æ‹¬RuntimeExceptionsï¼‰æ˜¯JobExecutionExceptionã€‚å› æ­¤ï¼Œé€šå¸¸åº”è¯¥ç”¨â€œtry-catchâ€å—æ¥åŒ…è£…executeæ–¹æ³•çš„å…¨éƒ¨å†…å®¹ã€‚ä½ è¿˜åº”è¯¥èŠ±ä¸€äº›æ—¶é—´æŸ¥çœ‹JobExecutionExceptionçš„æ–‡æ¡£ï¼Œå› ä¸ºä½ çš„Jobå¯ä»¥ä½¿ç”¨è¯¥å¼‚å¸¸å‘Šè¯‰Schedulerï¼Œä½ å¸Œæœ›å¦‚ä½•æ¥å¤„ç†å‘ç”Ÿçš„å¼‚å¸¸ã€‚ åŸæ–‡é“¾æ¥ï¼štutorial-lesson-03","categories":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/categories/Middleware/"},{"name":"Quartz","slug":"Middleware/Quartz","permalink":"http://throwable.club/blog/categories/Middleware/Quartz/"}],"tags":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/tags/Middleware/"},{"name":"Quartz","slug":"Quartz","permalink":"http://throwable.club/blog/tags/Quartz/"}]},{"title":"ç¬¬ä¸€ç« ï¼šä½¿ç”¨Quartz","slug":"quartz-doc-translation-lesson-1","date":"2019-03-29T17:39:58.000Z","updated":"2019-03-29T17:49:36.863Z","comments":true,"path":"2019/03/30/quartz-doc-translation-lesson-1/","link":"","permalink":"http://throwable.club/2019/03/30/quartz-doc-translation-lesson-1/","excerpt":"","text":"ç¬¬ä¸€ç« ï¼šä½¿ç”¨Quartz å†…å®¹ åœ¨ä½¿ç”¨æ­¤è°ƒåº¦å™¨(Scheduler)ä¹‹å‰ï¼Œå®ƒéœ€è¦è¢«å®ä¾‹åŒ–(è°çŒœåˆ°è¿™ä¸€ç‚¹äº†? &lt;-- è¿™é‡Œä¼°è®¡æ˜¯å®˜æ–¹çš„è°ƒçš®)ã€‚ä¸ºäº†å®ä¾‹åŒ–è°ƒåº¦å™¨ï¼Œä½ éœ€è¦ç”¨åˆ°SchedulerFactoryã€‚ä¸€äº›Quartzçš„ä½¿ç”¨è€…å¯èƒ½ä¼šåœ¨JNDIå­˜å‚¨ä¸­ä¿ç•™SchedulerFactoryçš„å®ä¾‹ï¼Œå…¶ä»–ä½¿ç”¨è€…å¯èƒ½ä¼šè§‰å¾—ç›´æ¥åˆå§‹åŒ–ä¼šæ›´åŠ ç®€å•ï¼ˆä¾‹å¦‚ä¸‹é¢çš„ç¤ºä¾‹ï¼‰ã€‚ ä¸€æ—¦è°ƒåº¦å™¨å®Œæˆäº†å®ä¾‹åŒ–ï¼Œå°±å¯ä»¥å¯åŠ¨(start)ã€æš‚åœ(stand-by)ã€åœæ­¢(shutdown)ã€‚æ³¨æ„ï¼šä¸€æ—¦è°ƒåº¦å™¨è¢«åœæ­¢ï¼Œå®ƒå°±ä¸èƒ½å¤Ÿé‡æ–°å¯åŠ¨ï¼Œé™¤éé‡æ–°å®ä¾‹åŒ–å¦ä¸€ä¸ªè°ƒåº¦å™¨å®ä¾‹ã€‚æ‰€æœ‰çš„è§¦å‘å™¨(Trigger)ä¸ä¼šè§¦å‘ä»»åŠ¡(ä¹Ÿå°±æ˜¯ä»»åŠ¡ä¸ä¼šæ‰§è¡Œ)ï¼Œé™¤éè°ƒåº¦å™¨å·²ç»å¯åŠ¨ã€‚ä½†æ˜¯å¦‚æœè°ƒåº¦å™¨(è™½ç„¶å·²ç»å¯åŠ¨)å¤„äºæš‚åœçŠ¶æ€ï¼Œæ‰€æœ‰çš„è§¦å‘å™¨ä¹Ÿä¸ä¼šè§¦å‘ä»»åŠ¡ã€‚ ä¸‹é¢æ˜¯ä¸€ä¸ªä»£ç ç‰‡æ®µï¼Œå®ä¾‹åŒ–å¹¶å¯åŠ¨ä¸€ä¸ªè°ƒåº¦å™¨ï¼Œè°ƒåº¦æ‰§è¡Œä¸€ä¸ªä»»åŠ¡ï¼š 12345678910111213141516171819202122SchedulerFactory schedFact = new org.quartz.impl.StdSchedulerFactory(); Scheduler sched = schedFact.getScheduler(); sched.start(); // define the job and tie it to our HelloJob class JobDetail job = newJob(HelloJob.class) .withIdentity(\"myJob\", \"group1\") .build(); // Trigger the job to run now, and then every 40 seconds Trigger trigger = newTrigger() .withIdentity(\"myTrigger\", \"group1\") .startNow() .withSchedule(simpleSchedule() .withIntervalInSeconds(40) .repeatForever()) .build(); // Tell quartz to schedule the job using our trigger sched.scheduleJob(job, trigger); æ­£å¦‚ä½ æ‰€è§ï¼Œä½¿ç”¨Quartzæ˜¯ååˆ†ç®€å•çš„ã€‚åœ¨ä¸‹ä¸€èŠ‚ç¬¬äºŒç« ï¼šQuartz APIã€è°ƒåº¦ä»»åŠ¡ä»¥åŠè§¦å‘å™¨ä¸­æˆ‘ä»¬å°†ä¼šæ¦‚è¿°ä¸€ä¸‹è°ƒåº¦ä»»åŠ¡ã€è§¦å‘å™¨ä»¥åŠQuartzçš„APIï¼Œä»¥ä¾¿ä½ å¯ä»¥æ›´å…¨é¢åœ°äº†è§£è¿™ä¸ªä¾‹å­ã€‚ åŸæ–‡é“¾æ¥ï¼štutorial-lesson-01","categories":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/categories/Middleware/"},{"name":"Quartz","slug":"Middleware/Quartz","permalink":"http://throwable.club/blog/categories/Middleware/Quartz/"}],"tags":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/tags/Middleware/"},{"name":"Quartz","slug":"Quartz","permalink":"http://throwable.club/blog/tags/Quartz/"}]},{"title":"ç¬¬äºŒç« ï¼šQuartz APIã€è°ƒåº¦ä»»åŠ¡ä»¥åŠè§¦å‘å™¨","slug":"quartz-doc-translation-lesson-2","date":"2019-03-29T17:39:58.000Z","updated":"2019-03-29T17:49:20.500Z","comments":true,"path":"2019/03/30/quartz-doc-translation-lesson-2/","link":"","permalink":"http://throwable.club/2019/03/30/quartz-doc-translation-lesson-2/","excerpt":"","text":"ç¬¬äºŒç« ï¼šQuartz APIã€è°ƒåº¦ä»»åŠ¡ä»¥åŠè§¦å‘å™¨ Quartz API ä¸‹é¢æ˜¯Quartz APIä¸­çš„å…³é”®æ¥å£ï¼š Schedulerï¼šä¸è°ƒåº¦å™¨äº¤äº’çš„ä¸»è¦API(å®é™…ä¸Šè¿™ä¸ªå°±æ˜¯è°ƒåº¦å™¨)ã€‚ Jobï¼šorg.quartz.Jobï¼Œå¸Œæœ›ç”±è°ƒåº¦å™¨æ‰§è¡Œçš„ç»„ä»¶ï¼Œæ˜¯ä¸€ä¸ªæ¥å£ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬ä½¿ç”¨çš„æ—¶å€™è¢«è°ƒåº¦çš„ä»»åŠ¡éœ€è¦å®ç°æ­¤æ¥å£ã€‚ JobDetailï¼šorg.quartz.JobDetailï¼Œè°ƒåº¦ä»»åŠ¡è¯¦æƒ…ï¼Œç”¨äºå®šä¹‰è°ƒåº¦ä»»åŠ¡ã€‚ Triggerï¼šorg.quartz.Triggerï¼Œä¹Ÿå°±æ˜¯è§¦å‘å™¨ï¼Œå®ƒæ˜¯ä¸€ä¸ªå®šä¹‰äº†ç»™å®šè°ƒåº¦ä»»åŠ¡å°†è¢«æ‰§è¡Œçš„æ—¶é—´è¡¨çš„ç»„ä»¶ã€‚ JobBuilderï¼šorg.quartz.JobBuilderï¼Œç”¨äºå®šä¹‰æˆ–è€…æ„å»ºJobDetailå®ä¾‹ã€‚ TriggerBuilderï¼šorg.quartz.TriggerBuilderï¼Œç”¨äºå®šä¹‰æˆ–è€…æ„å»ºTriggerå®ä¾‹ã€‚ å…¶å®Jobå°±æ˜¯ä½¿ç”¨è€…éœ€è¦å®ç°çš„è°ƒåº¦ä»»åŠ¡æ¥å£ï¼Œå®ƒä»¥JobDetailçš„å½¢å¼å­˜æ”¾åœ¨Quartzç®¡ç†çš„å†…å­˜æˆ–è€…è¡¨é‡Œé¢ã€‚ Schedulerçš„ç”Ÿå‘½æœŸï¼Œä»SchedulerFactoryåˆ›å»ºå®ƒçš„å®ä¾‹æ—¶å¼€å§‹ï¼Œåˆ°Schedulerçš„å®ä¾‹è°ƒç”¨shutdown()æ–¹æ³•æ—¶ç»“æŸã€‚Schedulerè¢«åˆ›å»ºåï¼Œå¯ä»¥æ·»åŠ ã€åˆ é™¤å’ŒæŸ¥è¯¢JobDetailå’ŒTriggerï¼Œä»¥åŠæ‰§è¡Œå…¶å®ƒä»¬ä¸è°ƒåº¦ç›¸å…³çš„æ“ä½œï¼ˆå¦‚æš‚åœTriggerï¼‰ã€‚ä½†æ˜¯ï¼ŒScheduleråªæœ‰åœ¨è°ƒç”¨start()æ–¹æ³•åï¼Œæ‰ä¼šçœŸæ­£åœ°è§¦å‘Triggerï¼ˆTriggerè¿ä½œä¹‹åæ‰èƒ½fireå…·ä½“çš„Jobï¼‰ï¼Œè§ç¬¬ä¸€ç« ï¼šä½¿ç”¨Quartzã€‚ Quartzæä¾›çš„â€œBuilderâ€ç±»ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ä¸€ç§é¢†åŸŸç‰¹å®šè¯­è¨€ï¼ˆDSLï¼ŒDomain Specific Language)ã€‚å…¶å®è¿™äº›Builderå°±æ˜¯æµå¼çš„APIã€‚ä¸Šä¸€ç« ä½ å·²ç»çœ‹è¿‡ç›¸åº”çš„ä¾‹å­ï¼Œè¿™é‡Œå†è´´å‡ºæ¥ä¸€æ¬¡ï¼š 12345678910111213141516// define the job and tie it to our HelloJob class JobDetail job = newJob(HelloJob.class) .withIdentity(\"myJob\", \"group1\") // name \"myJob\", group \"group1\" .build(); // Trigger the job to run now, and then every 40 seconds Trigger trigger = newTrigger() .withIdentity(\"myTrigger\", \"group1\") .startNow() .withSchedule(simpleSchedule() .withIntervalInSeconds(40) .repeatForever()) .build(); // Tell quartz to schedule the job using our trigger sched.scheduleJob(job, trigger); å®šä¹‰JobDetailçš„ä»£ç ä½¿ç”¨çš„æ˜¯ä»JobBuilderé™æ€å¯¼å…¥çš„æ–¹æ³•ã€‚åŒæ ·ï¼Œå®šä¹‰Triggerçš„ä»£ç ä½¿ç”¨çš„æ˜¯ä»TriggerBuilderé™æ€å¯¼å…¥çš„æ–¹æ³• ã€‚ å¦å¤–ï¼Œä¹Ÿå¯¼å…¥äº†SimpleSchedulerBuilderç±»çš„é™æ€æ–¹æ³•ã€‚DSLçš„é™æ€å¯¼å…¥å¯ä»¥é€šè¿‡ä»¥ä¸‹å¯¼å…¥è¯­å¥æ¥å®ç°ï¼š 123456import static org.quartz.JobBuilder.*;import static org.quartz.SimpleScheduleBuilder.*;import static org.quartz.CronScheduleBuilder.*;import static org.quartz.CalendarIntervalScheduleBuilder.*;import static org.quartz.TriggerBuilder.*;import static org.quartz.DateBuilder.*; SchedulerBuilderæ¥å£çš„å„ç§å®ç°ç±»ï¼Œå¯ä»¥å®šä¹‰ä¸åŒç±»å‹çš„è°ƒåº¦è®¡åˆ’ï¼ˆscheduleï¼‰ï¼›DateBuilderç±»åŒ…å«å¾ˆå¤šæ–¹æ³•ï¼Œå¯ä»¥å¾ˆæ–¹ä¾¿åœ°æ„é€ è¡¨ç¤ºä¸åŒæ—¶é—´ç‚¹çš„java.util.Dateå®ä¾‹ï¼ˆå¦‚å®šä¹‰ä¸‹ä¸€ä¸ªå°æ—¶ä¸ºå¶æ•°çš„æ—¶é—´ç‚¹ï¼Œå¦‚æœå½“å‰æ—¶é—´ä¸º9:43:27ï¼Œåˆ™å®šä¹‰çš„æ—¶é—´ä¸º10:00:00ï¼‰ã€‚ å…¶å®å°±æ˜¯SchedulerBuilderæ˜¯ç­–ç•¥æ¥å£ï¼Œå®ƒçš„å­ç±»æä¾›äº†å¤šç§ä¸åŒç±»å‹çš„è°ƒåº¦è®¡åˆ’çš„å®ç°ï¼ŒDateBuilderå†…éƒ¨çš„å¤šæ•°æ–¹æ³•ä¾èµ–äºCalendarï¼Œå®ƒä¸»è¦åŠŸèƒ½æ˜¯ç”¨æ¥å¿«é€Ÿå®šä¹‰ä¸€ä¸ªå…·ä½“çš„æ—¶åˆ»ï¼Œå› ä¸ºæœ‰æ—¶å€™Cronè¡¨è¾¾å¼å¯èƒ½ä¸æ»¡è¶³ç‰¹å®šçš„åœºæ™¯ï¼Œè¿™ä¸ªæ—¶å€™DateBuilderå¯ä»¥æ´¾ä¸Šç”¨åœºã€‚ Jobs and Triggers ä¸€ä¸ªè°ƒåº¦ä»»åŠ¡å°±æ˜¯ä¸€ä¸ªå®ç°äº†org.quartz.Jobæ¥å£(åªæœ‰ä¸€ä¸ªç®€å•çš„æ¥å£æ–¹æ³•execute)çš„ç±»ï¼š The Job Interfaceï¼š 1234567package org.quartz; public interface Job &#123; public void execute(JobExecutionContext context) throws JobExecutionException; &#125; å½“Jobçš„ä¸€ä¸ªTriggerè¢«è§¦å‘ï¼ˆç¨åä¼šè®²åˆ°ï¼‰æ—¶ï¼Œexecute()æ–¹æ³•ç”±Schedulerçš„ä¸€ä¸ªå·¥ä½œçº¿ç¨‹è°ƒç”¨ã€‚ä¼ é€’ç»™execute()æ–¹æ³•çš„JobExecutionContextå¯¹è±¡ä¸­ä¿å­˜ç€è¯¥Jobè¿è¡Œæ—¶çš„ä¸€äº›ä¿¡æ¯ ï¼Œæ‰§è¡ŒJobçš„Schedulerçš„å¼•ç”¨ï¼Œè§¦å‘Jobçš„Triggerçš„å¼•ç”¨ï¼ŒJobDetailå¯¹è±¡å¼•ç”¨ï¼Œä»¥åŠä¸€äº›å…¶å®ƒä¿¡æ¯ï¼ˆå¦‚æœä½¿ç”¨äº†Springçš„è¯ï¼Œå¯ä»¥ä¼ å…¥Springçš„ä¸Šä¸‹æ–‡å¯¹è±¡ApplicationContextï¼‰ã€‚ JobDetailå¯¹è±¡æ˜¯åœ¨å°†JobåŠ å…¥Scheduleræ—¶ï¼Œç”±å®¢æˆ·ç«¯ç¨‹åºï¼ˆä½ çš„ç¨‹åºï¼‰åˆ›å»ºçš„ã€‚å®ƒåŒ…å«Jobçš„å„ç§å±æ€§è®¾ç½®ï¼Œä»¥åŠç”¨äºå­˜å‚¨Jobå®ä¾‹çŠ¶æ€ä¿¡æ¯çš„JobDataMapã€‚æœ¬èŠ‚æ˜¯å¯¹Jobå®ä¾‹çš„ç®€å•ä»‹ç»ï¼Œæ›´å¤šçš„ç»†èŠ‚å°†åœ¨ä¸‹ä¸€èŠ‚è®²åˆ°ã€‚ Triggerç”¨äºè§¦å‘Jobçš„æ‰§è¡Œã€‚å½“ä½ å‡†å¤‡è°ƒåº¦ä¸€ä¸ªJobæ—¶ï¼Œä½ åˆ›å»ºä¸€ä¸ªTriggerçš„å®ä¾‹ï¼Œç„¶åè®¾ç½®è°ƒåº¦ç›¸å…³çš„å±æ€§ã€‚Triggerä¹Ÿæœ‰ä¸€ä¸ªç›¸å…³è”çš„JobDataMapï¼Œç”¨äºç»™Jobä¼ é€’ä¸€äº›è§¦å‘ç›¸å…³çš„å‚æ•°ã€‚Quartzè‡ªå¸¦äº†å„ç§ä¸åŒç±»å‹çš„Triggerï¼Œæœ€å¸¸ç”¨çš„ä¸»è¦æ˜¯SimpleTrigger(é—´éš”ä¸€å®šæ—¶é—´(é‡å¤)æ‰§è¡Œ)å’ŒCronTrigger(åŸºäºCronè¡¨è¾¾å¼æ„å»ºè°ƒåº¦è®¡åˆ’)ã€‚ SimpleTriggerä¸»è¦ç”¨äºä¸€æ¬¡æ€§æ‰§è¡Œçš„Jobï¼ˆåªåœ¨æŸä¸ªç‰¹å®šçš„æ—¶é—´ç‚¹æ‰§è¡Œä¸€æ¬¡ï¼‰ï¼Œæˆ–è€…Jobåœ¨ç‰¹å®šçš„æ—¶é—´ç‚¹æ‰§è¡Œï¼Œé‡å¤æ‰§è¡ŒNæ¬¡ï¼Œæ¯æ¬¡æ‰§è¡Œé—´éš”Tä¸ªæ—¶é—´å•ä½ã€‚CronTriggeråœ¨åŸºäºæ—¥å†çš„è°ƒåº¦ä¸Šéå¸¸æœ‰ç”¨ï¼Œå¦‚â€œæ¯ä¸ªæ˜ŸæœŸäº”çš„æ­£åˆâ€ï¼Œæˆ–è€…â€œæ¯æœˆçš„ç¬¬åå¤©çš„ä¸Šåˆ10:15â€ç­‰ã€‚ ä¸ºä»€ä¹ˆæ—¢æœ‰Jobï¼Œåˆæœ‰Triggerå‘¢ï¼Ÿå¾ˆå¤šä»»åŠ¡è°ƒåº¦å™¨å¹¶ä¸åŒºåˆ†Jobå’ŒTriggerã€‚æœ‰äº›è°ƒåº¦å™¨åªæ˜¯ç®€å•åœ°é€šè¿‡ä¸€ä¸ªæ‰§è¡Œæ—¶é—´å’Œä¸€äº›Jobæ ‡è¯†ç¬¦æ¥å®šä¹‰ä¸€ä¸ªJobï¼›å…¶å®ƒçš„ä¸€äº›è°ƒåº¦å™¨å°†Quartzä¸­æè¿°çš„Jobå’ŒTriggerå¯¹è±¡åˆäºŒä¸ºä¸€ã€‚åœ¨å¼€å‘Quartzçš„æ—¶å€™ï¼Œæˆ‘ä»¬è®¤ä¸ºå°†è§¦å‘å™¨å’Œè¦è°ƒåº¦çš„ä»»åŠ¡åˆ†ç¦»æ˜¯åˆç†çš„ã€‚åœ¨æˆ‘ä»¬çœ‹æ¥ï¼Œè¿™å¯ä»¥å¸¦æ¥å¾ˆå¤šå¥½å¤„ã€‚ ä¾‹å¦‚ï¼ŒJobè¢«åˆ›å»ºåï¼Œå¯ä»¥ä¿å­˜åœ¨Schedulerä¸­ï¼Œä¸Triggeræ˜¯ç‹¬ç«‹çš„ï¼ŒåŒä¸€ä¸ªJobå¯ä»¥æœ‰å¤šä¸ªTriggerï¼›è¿™ç§æ¾è€¦åˆçš„å¦ä¸€ä¸ªå¥½å¤„æ˜¯ï¼Œå½“ä¸Schedulerä¸­çš„Jobå…³è”çš„Triggeréƒ½è¿‡æœŸæ—¶ï¼Œå¯ä»¥é…ç½®Jobç¨åè¢«é‡æ–°è°ƒåº¦ï¼Œè€Œä¸ç”¨é‡æ–°å®šä¹‰Jobï¼›è¿˜æœ‰ï¼Œå¯ä»¥ä¿®æ”¹æˆ–è€…æ›¿æ¢Triggerï¼Œè€Œä¸ç”¨é‡æ–°å®šä¹‰ä¸ä¹‹å…³è”çš„Jobã€‚ è¯‘è€…æ³¨ï¼šä¸Šé¢è¿™æ®µå†…å®¹ååˆ†é‡è¦ï¼Œåœ¨Quartzä¸­ï¼Œè°ƒåº¦ä»»åŠ¡å’Œè§¦å‘å™¨æ˜¯ç‹¬ç«‹åˆ†ç¦»çš„ï¼Œå¹¶ä¸”å¯ä»¥æ€»ç»“å‡ºä¸€ç‚¹ï¼šQuartzä¸­Jobæ˜¯æ— çŠ¶æ€çš„ï¼Œæœ‰çŠ¶æ€çš„æ˜¯Triggerã€‚å› æ­¤æˆ‘ä»¬åœ¨åšä¸€ä¸ªè°ƒåº¦ä»»åŠ¡æŸ¥è¯¢åˆ—è¡¨å±•ç¤ºçš„æ—¶å€™åº”è¯¥å±•ç¤ºçš„æ˜¯è§¦å‘å™¨çš„çŠ¶æ€ï¼Œè€Œä¸åº”è¯¥æ˜¯è°ƒåº¦ä»»åŠ¡çš„çŠ¶æ€ï¼›è‡³äºè°ƒåº¦ä»»åŠ¡æ˜¯å¦æ‰§è¡ŒæˆåŠŸï¼Œåªèƒ½é€šè¿‡æ·»åŠ ç›‘å¬å™¨æˆ–è€…æŸ¥çœ‹æ—¥å¿—å»åˆ¤æ–­æˆ–è€…è¯´è°ƒåº¦ä»»åŠ¡çš„è¿è¡ŒçŠ¶æ€åº”è¯¥äº¤ç”±å¼€å‘è€…å»ç›‘æ§å’Œç®¡ç†ã€‚ Identities Identitieså…¶å®å°±æ˜¯è°ƒåº¦ä»»åŠ¡å’Œè§¦å‘å™¨çš„èº«ä»½æ ‡è¯†ã€‚å½“Jobå’ŒTriggeræ³¨å†Œåˆ°Quartzçš„è°ƒåº¦å™¨ä¸­çš„æ—¶å€™éœ€è¦å®šä¹‰ç›¸åº”çš„è¯†åˆ«æ ‡è®°(å…¶å®å°±æ˜¯JobKeyå’ŒTriggerKey)ã€‚è°ƒåº¦ä»»åŠ¡å’Œè§¦å‘å™¨ï¼ˆJobKeyå’ŒTriggerKeyï¼‰çš„è¯†åˆ«æ ‡è®°ä¸­å…è®¸ä½¿ç”¨â€œåˆ†ç»„(group)â€ï¼Œè¿™å¯¹äºç»„ç»‡ä½ çš„å·¥ä½œå’Œè§¦å‘è¯¸å¦‚â€œæŠ¥å‘Šå·¥ä½œâ€å’Œâ€œç»´æŠ¤å·¥ä½œâ€ç­‰ç±»åˆ«æ˜¯æœ‰ç”¨çš„ã€‚ä½œä¸šæˆ–è§¦å‘å™¨çš„é”®çš„åç§°éƒ¨åˆ†å¿…é¡»åœ¨ç»„å†…æ˜¯æƒŸä¸€çš„â€”æ¢å¥è¯è¯´ï¼Œä½œä¸šæˆ–è§¦å‘å™¨çš„å®Œæ•´é”®ï¼ˆæˆ–æ ‡è¯†ç¬¦ï¼‰æ˜¯åç§°ï¼ˆnameï¼‰å’Œç»„åˆ«ï¼ˆgroupï¼‰çš„å¤åˆã€‚è¿™é‡Œå¯ä»¥å…ˆè¿™æ ·ç†è§£ï¼ŒJobKey(nameå’Œgroup)æ˜¯JobDetailçš„è”åˆä¸»é”®ï¼ŒTriggerKey(nameå’Œgroup)æ˜¯Triggerçš„è”åˆä¸»é”®ã€‚ ä½ ç°åœ¨å¯¹è°ƒåº¦ä»»åŠ¡å’Œè§¦å‘å™¨æœ‰äº†å¤§è‡´çš„äº†è§£ï¼Œä½ å¯ä»¥åœ¨ç¬¬ä¸‰ç« ï¼šJobå’ŒJobDetailçš„æ›´å¤šç»†èŠ‚å’Œç¬¬å››ç« ï¼šå…³äºTriggerçš„æ›´å¤šç»†èŠ‚äº†è§£åˆ°æ›´å¤šå…³äºå®ƒä»¬çš„ä½¿ç”¨æ–¹å¼ã€‚ åŸæ–‡é“¾æ¥ï¼štutorial-lesson-02","categories":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/categories/Middleware/"},{"name":"Quartz","slug":"Middleware/Quartz","permalink":"http://throwable.club/blog/categories/Middleware/Quartz/"}],"tags":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/tags/Middleware/"},{"name":"Quartz","slug":"Quartz","permalink":"http://throwable.club/blog/tags/Quartz/"}]},{"title":"Quartzå®˜æ–¹æ–‡æ¡£ç¿»è¯‘","slug":"quartz-doc-translation-entry","date":"2019-03-29T17:38:00.000Z","updated":"2019-03-30T03:29:44.793Z","comments":true,"path":"2019/03/30/quartz-doc-translation-entry/","link":"","permalink":"http://throwable.club/2019/03/30/quartz-doc-translation-entry/","excerpt":"","text":"Quartzå®˜æ–¹æ–‡æ¡£ç¿»è¯‘ 2018å¹´5æœˆçš„æ—¶å€™ï¼Œå› ä¸ºè¦ç†è§£Quartzçš„ç›¸å…³ä¸œè¥¿ï¼Œå½“æ—¶ç¿»é˜…è¿‡å®ƒçš„æ–‡æ¡£é¡ºä¾¿æŠŠå®ƒç¿»è¯‘äº†å‡ºæ¥ï¼Œå·²ç»å¿˜è®°äº†è¿™ä¸ªäº‹ï¼Œå¥½åœ¨å­˜æ¡£è¿˜åœ¨ç¡¬ç›˜ä¸Šã€‚å…¶ä¸­æœ‰éƒ¨åˆ†ç« èŠ‚ä¸ºäº†èŠ‚çœæ—¶é—´ä½¿ç”¨äº†æœºç¿»ç„¶åäººå·¥æ¶¦è‰²ï¼Œç›®å‰é˜…è¯»èµ·æ¥åº”è¯¥æ²¡æœ‰éšœç¢ã€‚ è¿™æ®µæ—¶é—´å¤ªå¿™(996ï¼Œå¿«ICUäº†)ï¼Œå…ˆå¯¹åŸºç¡€æ•™ç¨‹éƒ¨åˆ†é‡æ–°æ’ç‰ˆå’ŒäºŒæ¬¡æ¶¦è‰²ï¼Œå‰©ä¸‹çš„å…¶ä»–æ–‡æ¡£æœ‰ç©ºå†è¡¥ä¸€ä¸‹ã€‚ æœ¯è¯­ï¼š Schedulerï¼šè°ƒåº¦å™¨ã€‚ SchedulerFactoryï¼šè°ƒåº¦å™¨å·¥å‚ã€‚ Triggerï¼šè§¦å‘å™¨ã€‚ Jobï¼š(è°ƒåº¦)ä»»åŠ¡æˆ–è€…ä½œä¸šï¼Œåœ¨Quartzä¸­ä½“ç°ä¸ºJobDetailã€‚ åœ¨åé¢çš„ç¿»è¯‘ä¸­ï¼Œå› ä¸ºä¸ªäººä¹ æƒ¯ï¼Œå¯èƒ½ä¼šä¸­è‹±äº’ç”¨ï¼Œæ˜ å°„å…³ç³»ä¸ºï¼š Scheduler === è°ƒåº¦å™¨ SchedulerFactory === è°ƒåº¦å™¨å·¥å‚ Trigger === è§¦å‘å™¨ Jobã€JobDetail === (è°ƒåº¦)ä»»åŠ¡ fire === è§¦å‘ åŸºç¡€ç¯‡ ç¬¬ä¸€ç« ï¼šä½¿ç”¨Quartz ç¬¬äºŒç« ï¼šQuartz APIã€è°ƒåº¦ä»»åŠ¡ä»¥åŠè§¦å‘å™¨ ç¬¬ä¸‰ç« ï¼šJobå’ŒJobDetailçš„æ›´å¤šç»†èŠ‚ ç¬¬å››ç« ï¼šå…³äºTriggerçš„æ›´å¤šç»†èŠ‚ ç¬¬äº”ç« ï¼šSimpleTrigger ç¬¬å…­ç« ï¼šCronTrigger ç¬¬ä¸ƒç« ï¼šTriggerç›‘å¬å™¨å’ŒJobç›‘å¬å™¨ ç¬¬å…«ç« ï¼šSchedulerç›‘å¬å™¨ ç¬¬ä¹ç« ï¼šJobStores ç¬¬åç« ï¼šé…ç½®ã€èµ„æºçš„ä½¿ç”¨ä»¥åŠSchedulerFactory ç¬¬åä¸€ç« ï¼šé«˜çº§(ä¼ä¸šçº§)ç‰¹æ€§ ç¬¬åäºŒç« ï¼šå…¶ä»–ç‰¹æ€§ ç‰¹åˆ«æ•™ç¨‹ ç‰¹åˆ«æ•™ç¨‹-CronTriggeræ•™ç¨‹ å…¶ä»– to be continueâ€¦ (e-a-20170526 c-14-d r-a-20180330)","categories":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/categories/Middleware/"},{"name":"Quartz","slug":"Middleware/Quartz","permalink":"http://throwable.club/blog/categories/Middleware/Quartz/"}],"tags":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/tags/Middleware/"},{"name":"Quartz","slug":"Quartz","permalink":"http://throwable.club/blog/tags/Quartz/"}]},{"title":"è°ˆè°ˆå¯¹åˆ†å¸ƒå¼äº‹åŠ¡çš„ä¸€ç‚¹ç†è§£å’Œè§£å†³æ–¹æ¡ˆ","slug":"j-action-about-distributed-transaction","date":"2019-03-23T03:09:08.000Z","updated":"2019-03-24T03:47:01.156Z","comments":true,"path":"2019/03/23/j-action-about-distributed-transaction/","link":"","permalink":"http://throwable.club/2019/03/23/j-action-about-distributed-transaction/","excerpt":"","text":"è°ˆè°ˆå¯¹åˆ†å¸ƒå¼äº‹åŠ¡çš„ä¸€ç‚¹ç†è§£å’Œè§£å†³æ–¹æ¡ˆ å‰æ æœ€è¿‘ï¼Œå·¥ä½œä¸­è¦ä¸ºç°åœ¨çš„è€ç³»ç»Ÿåšæ‹†åˆ†å’Œå‡çº§ï¼Œåˆšå¥½é‡åˆ°äº†åˆ†å¸ƒå¼äº‹åŠ¡ã€å¹‚ç­‰æ§åˆ¶ã€å¼‚æ­¥æ¶ˆæ¯ä¹±åºå’Œè¡¥å¿æ–¹æ¡ˆç­‰é—®é¢˜ï¼Œåˆšå¥½åŸºäºå®è·µç»“åˆä¸ªäººçš„çœ‹æ³•è®°å½•ä¸€ä¸‹ä¸€äº›æ–¹æ¡ˆå’Œæ€è·¯ã€‚ åˆ†å¸ƒå¼äº‹åŠ¡ é¦–å…ˆï¼Œåšç³»ç»Ÿæ‹†åˆ†çš„æ—¶å€™å‡ ä¹éƒ½ä¼šé‡åˆ°åˆ†å¸ƒå¼äº‹åŠ¡çš„é—®é¢˜ï¼Œä¸€ä¸ªä»¿çœŸçš„æ¡ˆä¾‹å¦‚ä¸‹ï¼š é¡¹ç›®åˆæœŸï¼Œç”±äºç”¨æˆ·ä½“é‡ä¸å¤§ï¼Œè®¢å•æ¨¡å—å’Œé’±åŒ…æ¨¡å—å…±åº“å…±åº”ç”¨(å¤§waråŒ…æ—¶ä»£)ï¼Œæ¨¡å—è°ƒç”¨å¯ä»¥ç®€åŒ–ä¸ºæœ¬åœ°äº‹åŠ¡æ“ä½œï¼Œè¿™æ ·åšåªè¦ä¸æ˜¯ç¨‹åºæœ¬èº«çš„BUGï¼ŒåŸºæœ¬å¯ä»¥é¿å…æ•°æ®ä¸ä¸€è‡´ã€‚åé¢å› ä¸ºç”¨æˆ·ä½“é‡è¶Šå‘å¢å¤§ï¼ŒåŸºäºå®¹é”™ã€æ€§èƒ½ã€åŠŸèƒ½å…±äº«ç­‰è€ƒè™‘ï¼ŒæŠŠåŸæ¥çš„åº”ç”¨æ‹†åˆ†ä¸ºè®¢å•å¾®æœåŠ¡å’Œé’±åŒ…å¾®æœåŠ¡ï¼Œä¸¤ä¸ªæœåŠ¡ä¹‹é—´é€šè¿‡éæœ¬åœ°äº‹åŠ¡æ“(è¿™é‡Œå¯ä»¥æ˜¯HTTPæˆ–è€…æ¶ˆæ¯é˜Ÿåˆ—ç­‰)è¿›è¡Œæ•°æ®åŒæ­¥ï¼Œè¿™ä¸ªæ—¶å€™å°±å¾ˆæœ‰å¯èƒ½ç”±äºå¼‚å¸¸åœºæ™¯å‡ºç°æ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µã€‚ äº‹åŠ¡ä¸­ç›´æ¥RPCè°ƒç”¨è¾¾åˆ°å¼ºä¸€è‡´æ€§ ä»¥ä¸Šé¢çš„è®¢å•å¾®æœåŠ¡è¯·æ±‚é’±åŒ…å¾®æœåŠ¡è¿›è¡Œæ‰£æ¬¾å¹¶æ›´æ–°è®¢å•çŠ¶æ€ä¸ºæ‰£æ¬¾è¿™ä¸ªè°ƒç”¨è¿‡ç¨‹ä¸ºä¾‹ï¼Œå‡è®¾é‡‡ç”¨HTTPåŒæ­¥è°ƒç”¨ï¼Œé¡¹ç›®å¦‚æœç”±ç»éªŒä¸è¶³çš„å¼€å‘è€…å¼€å‘è¿™ä¸ªé€»è¾‘ï¼Œå¯èƒ½ä¼šå‡ºç°ä¸‹é¢çš„ä¼ªä»£ç ï¼š 123456789[è®¢å•å¾®æœåŠ¡è¯·æ±‚é’±åŒ…å¾®æœåŠ¡è¿›è¡Œæ‰£æ¬¾å¹¶æ›´æ–°è®¢å•çŠ¶æ€]å¤„ç†è®¢å•å¾®æœåŠ¡è¯·æ±‚é’±åŒ…å¾®æœåŠ¡è¿›è¡Œæ‰£æ¬¾å¹¶æ›´æ–°è®¢å•çŠ¶æ€æ–¹æ³•()&#123; [å¼€å¯äº‹åŠ¡] 1ã€æŸ¥è¯¢è®¢å• 2ã€HTTPè°ƒç”¨é’±åŒ…å¾®æœåŠ¡æ‰£æ¬¾ 3ã€æ›´æ–°è®¢å•çŠ¶æ€ä¸ºæ‰£æ¬¾æˆåŠŸ [æäº¤äº‹åŠ¡]&#125; è¿™æ˜¯ä¸€ä¸ªä»è‚‰çœ¼ä¸Šçœ‹èµ·æ¥æ²¡æœ‰ä»€ä¹ˆé—®é¢˜çš„è§£å†³æ–¹æ³•ï¼ŒHTTPè°ƒç”¨ç›´æ¥åµŒå…¥åˆ°äº‹åŠ¡ä»£ç å—å†…éƒ¨ï¼ŒçŒœæƒ³æœ€åˆå¼€å‘è€…çš„æƒ³æ³•æ˜¯ï¼šHTTPè°ƒç”¨å¤±è´¥æŠ›å‡ºå¼‚å¸¸ä¼šå¯¼è‡´äº‹åŠ¡å›æ»šï¼Œç”¨æˆ·é‡è¯•å³å¯ï¼›HTTPè°ƒç”¨æˆåŠŸï¼Œäº‹åŠ¡æ­£å¸¸æäº¤ï¼Œä¸šåŠ¡æ­£å¸¸å®Œæˆã€‚è¿™ç§åšæ³•çœ‹ä¼¼å¯å–ï¼Œä½†æ˜¯å¸¦æ¥äº†æå¤§çš„éšæ‚£ï¼Œæ ¹æœ¬åŸå› æ˜¯ï¼šäº‹åŠ¡ä¸­åµŒå…¥äº†RPCè°ƒç”¨ã€‚å‡è®¾ä¸¤ç§æ¯”è¾ƒå¸¸è§çš„æƒ…å†µï¼š 1ã€ä¸Šé¢æ–¹æ³•ä¸­ç¬¬2æ­¥ç”±äºé’±åŒ…å¾®æœåŠ¡æœ¬èº«å„ç§åŸå› å¯¼è‡´æ‰£æ¬¾æ¥å£å“åº”ææ…¢ï¼Œä¼šå¯¼è‡´ä¸Šé¢çš„å¤„ç†æ–¹æ³•äº‹åŠ¡(å‡†ç¡®æ¥è¯´æ˜¯æ•°æ®åº“è¿æ¥)é•¿æ—¶é—´æŒ‚èµ·ï¼ŒæŒæœ‰çš„æ•°æ®åº“è¿æ¥æ— æ³•é‡Šæ”¾ï¼Œä¼šå¯¼è‡´æ•°æ®åº“è¿æ¥æ± çš„è¿æ¥è€—å°½ï¼Œå¾ˆå®¹æ˜“å¯¼è‡´è®¢å•å¾®æœåŠ¡çš„å…¶ä»–ä¾èµ–æ•°æ®åº“çš„æ¥å£æ— æ³•å“åº”ã€‚ 2ã€é’±åŒ…å¾®æœåŠ¡æ˜¯å•èŠ‚ç‚¹éƒ¨ç½²(å¹¶ä¸æ˜¯æ‰€æœ‰çš„å…¬å¸å¾®æœåŠ¡éƒ½åšå¾—å¾ˆå®Œå–„)ï¼Œå‡çº§æœŸé—´åº”ç”¨åœæœºï¼Œä¸Šé¢æ–¹æ³•ä¸­ç¬¬2æ­¥æ¥å£è°ƒç”¨ç›´æ¥å¤±è´¥ï¼Œè¿™æ ·ä¼šå¯¼è‡´çŸ­æ—¶é—´å†…æ‰€æœ‰çš„äº‹åŠ¡éƒ½å›æ»šï¼Œç›¸å½“äºè®¢å•å¾®æœåŠ¡çš„æ‰£æ¬¾å…¥å£æ˜¯ä¸å¯ç”¨çš„ã€‚ 3ã€ç½‘ç»œæ˜¯ä¸å¯é çš„ï¼ŒHTTPè°ƒç”¨æˆ–è€…æ¥å—å“åº”çš„æ—¶å€™å¦‚æœå‡ºç°ç½‘ç»œé—ªæ–­æœ‰å¯èƒ½å‡ºç°äº†æœåŠ¡é—´çŠ¶æ€ä¸èƒ½äº’ç›¸æ˜ç¡®çš„æƒ…å†µï¼Œä¾‹å¦‚è®¢å•å¾®æœåŠ¡è°ƒç”¨é’±åŒ…å¾®æœåŠ¡æˆåŠŸï¼Œæ¥å—å“åº”çš„æ—¶å€™å‡ºç°ç½‘ç»œé—®é¢˜ï¼Œä¼šå‡ºç°æ‰£æ¬¾æˆåŠŸä½†æ˜¯è®¢å•çŠ¶æ€æ²¡æœ‰æ›´æ–°çš„å¯èƒ½(è®¢å•å¾®æœåŠ¡äº‹åŠ¡å›æ»š)ã€‚ å°½ç®¡ç°åœ¨æœ‰Hystrixç­‰æ¡†æ¶å¯ä»¥åŸºäºçº¿ç¨‹æ± éš”ç¦»è°ƒç”¨æˆ–è€…åŸºäºç†”æ–­å™¨å¿«é€Ÿå¤±è´¥ï¼Œä½†æ˜¯è¿™æ˜¯æ”¶æ•ˆç”šå¾®çš„ã€‚å› æ­¤ï¼Œä¸ªäººè®¤ä¸ºäº‹åŠ¡ä¸­ç›´æ¥RPCè°ƒç”¨è¾¾åˆ°å¼ºä¸€è‡´æ€§æ˜¯å®Œå…¨ä¸å¯å–çš„ï¼Œå¦‚æœä½¿ç”¨äº†è¿™ç§æ–¹å¼å®ç°&quot;åˆ†å¸ƒå¼äº‹åŠ¡&quot;å»ºè®®æ•´æ”¹ï¼Œå¦åˆ™åªèƒ½æ¯å¤©ç¥ˆæ±‚ä¸‹æ¸¸æœåŠ¡æˆ–è€…ç½‘ç»œä¸å‡ºç°ä»»ä½•é—®é¢˜ã€‚ äº‹åŠ¡ä¸­è¿›è¡Œå¼‚æ­¥æ¶ˆæ¯æ¨é€ ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡ŒæœåŠ¡ä¹‹é—´çš„è°ƒç”¨ä¹Ÿæ˜¯å¸¸è§çš„æ–¹å¼ä¹‹ä¸€ï¼Œä½†æ˜¯ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—äº¤äº’æœ¬è´¨æ˜¯å¼‚æ­¥çš„ï¼Œæ— æ³•æ„ŸçŸ¥ä¸‹æ¸¸æ¶ˆæ¯æ¶ˆè´¹æ–¹æ˜¯å¦æ­£å¸¸å¤„ç†æ¶ˆæ¯ã€‚ç”¨å‰ä¸€èŠ‚çš„ä¾‹å­ï¼Œå‡è®¾é‡‡ç”¨æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥è°ƒç”¨ï¼Œé¡¹ç›®å¦‚æœç”±ç»éªŒä¸è¶³çš„å¼€å‘è€…å¼€å‘è¿™ä¸ªé€»è¾‘ï¼Œå¯èƒ½ä¼šå‡ºç°ä¸‹é¢çš„ä¼ªä»£ç ï¼š 123456789[è®¢å•å¾®æœåŠ¡è¯·æ±‚é’±åŒ…å¾®æœåŠ¡è¿›è¡Œæ‰£æ¬¾å¹¶æ›´æ–°è®¢å•çŠ¶æ€]å¤„ç†è®¢å•å¾®æœåŠ¡è¯·æ±‚é’±åŒ…å¾®æœåŠ¡è¿›è¡Œæ‰£æ¬¾å¹¶æ›´æ–°è®¢å•çŠ¶æ€æ–¹æ³•()&#123; [å¼€å¯äº‹åŠ¡] 1ã€æŸ¥è¯¢è®¢å• 2ã€æ¨é€é’±åŒ…å¾®æœåŠ¡æ‰£æ¬¾æ¶ˆæ¯(æ¨é€æ¶ˆæ¯) 3ã€æ›´æ–°è®¢å•çŠ¶æ€ä¸ºæ‰£æ¬¾æˆåŠŸ [æäº¤äº‹åŠ¡]&#125; ä¸Šé¢çš„å¤„ç†æ–¹æ³•å¦‚æœæŠ½è±¡ä¸€ç‚¹è¡¨ç¤ºå¦‚ä¸‹ï¼š 12345678910111213141516æ–¹æ³•()&#123; DataSource dataSource = xx; Connection con = dataSource.getConnection(); con.setAutoCommit(false); try&#123; 1ã€SQLæ“ä½œ; 2ã€æ¨é€æ¶ˆæ¯; 3ã€SQLæ“ä½œ; con.commit(); &#125;catch(Exception e)&#123; con.rollback(); &#125;finally&#123; é‡Šæ”¾å…¶ä»–èµ„æº; release(con); &#125;&#125; è¿™æ ·åšï¼Œåœ¨æ­£å¸¸æƒ…å†µä¸‹ï¼Œä¹Ÿå°±æ˜¯èƒ½å¤Ÿæ­£å¸¸è°ƒç”¨æ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶æ¨é€æ¶ˆæ¯æˆåŠŸçš„æƒ…å†µä¸‹ï¼Œäº‹åŠ¡æ˜¯èƒ½å¤Ÿæ­£ç¡®æäº¤çš„ã€‚ä½†æ˜¯å­˜åœ¨ä¸¤ä¸ªæ˜æ˜¾çš„é—®é¢˜ï¼š 1ã€æ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶å‡ºç°äº†å¼‚å¸¸ï¼Œæ— æ³•æ­£å¸¸è°ƒç”¨ï¼Œå¸¸è§çš„æƒ…å†µæ˜¯ç½‘ç»œåŸå› æˆ–è€…æ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶ä¸å¯ç”¨ï¼Œä¼šå¯¼è‡´å¼‚å¸¸ä»è€Œä½¿å¾—äº‹åŠ¡å›æ»šã€‚è¿™ç§æƒ…å†µçœ‹èµ·æ¥ä¼¼ä¹åˆæƒ…åˆç†ï¼Œä½†æ˜¯ä»”ç»†æƒ³ï¼šä¸ºä»€ä¹ˆæ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶è°ƒç”¨å¼‚å¸¸ä¼šå¯¼è‡´ä¸šåŠ¡äº‹åŠ¡å›æ»šï¼Œå¦‚æœä¸­é—´ä»¶ä¸æ¢å¤ï¼Œè¿™ä¸ªæ¥å£è°ƒç”¨å²‚ä¸æ˜¯ç›¸å½“äºä¸å¯ç”¨ï¼Ÿ 2ã€å¦‚æœæ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶æ­£å¸¸ï¼Œæ¶ˆæ¯æ­£å¸¸æ¨é€ï¼Œä½†æ˜¯ç¬¬3æ­¥ç”±äºSQLå­˜åœ¨è¯­æ³•é”™è¯¯å¯¼è‡´äº‹åŠ¡å›æ»šï¼Œè¿™æ ·å°±ä¼šå‡ºç°äº†ä¸‹æ¸¸å¾®æœåŠ¡è¢«è°ƒç”¨æˆåŠŸï¼Œæœ¬åœ°äº‹åŠ¡å´å›æ»šçš„é—®é¢˜ï¼Œå¯¼è‡´äº†ä¸Šä¸‹æ¸¸ç³»ç»Ÿæ•°æ®ä¸ä¸€è‡´ã€‚ æ€»çš„æ¥è¯´ï¼šäº‹åŠ¡ä¸­è¿›è¡Œå¼‚æ­¥æ¶ˆæ¯æ¨é€æ˜¯ä¸€ç§å¹¶ä¸å¯é çš„å®ç°ã€‚ ç›®å‰ä¸šç•Œæä¾›çš„è§£å†³æ–¹æ¡ˆ ä¸šç•Œç›®å‰ä¸»æµçš„åˆ†å¸ƒå¼äº‹åŠ¡è§£å†³æ–¹æ¡ˆä¸»è¦æœ‰ï¼šå¤šé˜¶æ®µæäº¤æ–¹æ¡ˆ(2PCã€3PC)ã€è¡¥å¿äº‹åŠ¡(TCC)å’Œæ¶ˆæ¯äº‹åŠ¡(ä¸»è¦æ˜¯RocketMQï¼ŒåŸºæœ¬æ€æƒ³ä¹Ÿæ˜¯å¤šé˜¶æ®µæäº¤æ–¹æ¡ˆï¼Œå…¶ä»–æ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶å¹¶æ²¡æœ‰å®ç°åˆ†å¸ƒå¼äº‹åŠ¡)ã€‚è¿™äº›æ–¹æ¡ˆçš„åŸç†åœ¨æ­¤å¤„ä¸å±•å¼€ï¼Œç›®å‰ç½‘ç»œä¸­ç›¸åº”èµ„æ–™æ¯”è¾ƒå¤šï¼Œå°ç»“ä¸€ä¸‹å®ƒä»¬çš„ç‰¹ç‚¹ï¼š å¤šé˜¶æ®µæäº¤æ–¹æ¡ˆï¼šå¸¸è§çš„æœ‰äºŒé˜¶æ®µå’Œä¸‰é˜¶æ®µæäº¤äº‹åŠ¡ï¼Œéœ€è¦é¢å¤–çš„èµ„æºç®¡ç†å™¨æ¥åè°ƒäº‹åŠ¡ï¼Œæ•°æ®ä¸€è‡´æ€§å¼ºï¼Œä½†æ˜¯å®ç°æ–¹æ¡ˆæ¯”è¾ƒå¤æ‚ï¼Œå¯¹æ€§èƒ½çš„ç‰ºç‰²æ¯”è¾ƒå¤§(ä¸»è¦æ˜¯éœ€è¦å¯¹èµ„æºé”å®šï¼Œç­‰å¾…æ‰€æœ‰äº‹åŠ¡æäº¤æ‰èƒ½è§£é”)ï¼Œä¸é€‚ç”¨äºé«˜å¹¶å‘çš„åœºæ™¯ï¼Œç›®å‰æ¯”è¾ƒçŸ¥åçš„æœ‰é˜¿é‡Œå¼€æºçš„fescarã€‚ è¡¥å¿äº‹åŠ¡ï¼šä¸€èˆ¬ä¹Ÿå«TCCï¼Œå› ä¸ºæ¯ä¸ªäº‹åŠ¡æ“ä½œéƒ½éœ€è¦æä¾›ä¸‰ä¸ªæ“ä½œå°è¯•(Try)ã€ç¡®è®¤(Confirm)å’Œè¡¥å¿/æ’¤é”€(Cancel)ï¼Œæ•°æ®ä¸€è‡´æ€§çš„å¼ºåº¦æ¯”å¤šé˜¶æ®µæäº¤æ–¹æ¡ˆä½ï¼Œä½†æ˜¯å®ç°çš„å¤æ‚åº¦ä¼šæœ‰æ‰€é™ä½ï¼Œæ¯”è¾ƒæ˜æ˜¾çš„ç¼ºé™·æ˜¯æ¯ä¸ªä¸šåŠ¡äº‹åŠ¡éœ€è¦å®ç°ä¸‰ç»„æ“ä½œï¼Œæœ‰å¯èƒ½å‡ºç°è¿‡å¤šçš„è¡¥å¿æ–¹æ¡ˆçš„ä»£ç ï¼›å¦å¤–æœ‰å¾ˆå¤šåœºæ™¯TCCæ˜¯ä¸åˆé€‚çš„ã€‚ æ¶ˆæ¯äº‹åŠ¡ï¼šè¿™é‡Œåªè°ˆRocketMQçš„å®ç°ï¼Œä¸€ä¸ªäº‹åŠ¡çš„æ‰§è¡Œæµç¨‹åŒ…æ‹¬ï¼šå‘é€é¢„æ¶ˆæ¯ã€æ‰§è¡Œæœ¬åœ°äº‹åŠ¡ã€ç¡®è®¤æ¶ˆæ¯å‘é€æˆåŠŸã€‚å®ƒçš„æ¶ˆæ¯ä¸­é—´ä»¶å­˜å‚¨äº†ä¸‹æ¸¸æ— æ³•æ¶ˆè´¹æˆåŠŸçš„æ¶ˆæ¯ï¼Œå¹¶ä¸”ä¸æ–­é‡è¯•æ¨é€ä¸‹æ¸¸æ¶ˆè´¹æ¶ˆæ¯ï¼Œè€Œç”Ÿäº§è€…(ä¸Šæ¸¸)éœ€è¦æä¾›ä¸€ä¸ªcheckæ¥å£ï¼Œç”¨äºæ£€æŸ¥æˆåŠŸå‘é€é¢„æ¶ˆæ¯ä½†æ˜¯æœªç¡®è®¤æœ€ç»ˆæ¶ˆæ¯å‘é€çŠ¶æ€çš„äº‹åŠ¡çš„çŠ¶æ€ã€‚ é¡¹ç›®å®è·µä¸­æœ€ç»ˆä½¿ç”¨çš„æ–¹æ¡ˆ ä¸ªäººæ‰€åœ¨çš„å…¬å¸çš„æŠ€æœ¯æ ˆä¸­æ²¡æœ‰ä½¿ç”¨RocketMQï¼Œä¸»è¦ä½¿ç”¨RabbitMQï¼Œæ‰€ä»¥éœ€è¦é’ˆå¯¹RabbitMQåšæ¶ˆæ¯äº‹åŠ¡çš„é€‚é…ã€‚ç›®å‰ä¸šåŠ¡ç³»ç»Ÿä¸­æ¶ˆæ¯å¼‚æ­¥äº¤äº’å­˜åœ¨ä¸‰ç§åœºæ™¯ï¼š 1ã€æ¶ˆæ¯æ¨é€å®æ—¶æ€§é«˜ï¼Œå¯ä»¥æ¥å—ä¸¢å¤±ã€‚ 2ã€æ¶ˆæ¯æ¨é€å®æ—¶æ€§ä½ï¼Œä¸èƒ½ä¸¢å¤±ã€‚ 3ã€æ¶ˆæ¯æ¨é€å®æ—¶æ€§é«˜ï¼Œä¸èƒ½ä¸¢å¤±ã€‚ æœ€ç»ˆæ•²å®šä½¿ç”¨äº†æœ¬åœ°æ¶ˆæ¯è¡¨çš„è§£å†³æ–¹æ¡ˆï¼Œè¿™ä¸ªæ–¹æ¡ˆååˆ†ç®€å•ï¼š ä¸»è¦æ€è·¯æ˜¯ï¼š 1ã€éœ€è¦å‘é€åˆ°æ¶ˆè´¹æ–¹çš„æ¶ˆæ¯çš„ä¿å­˜å’Œä¸šåŠ¡å¤„ç†ç»‘å®šåœ¨åŒä¸€ä¸ªæœ¬åœ°äº‹åŠ¡ä¸­ï¼Œéœ€è¦é¢å¤–å»ºç«‹ä¸€å¼ æœ¬åœ°æ¶ˆæ¯è¡¨ã€‚ 2ã€æœ¬åœ°äº‹åŠ¡æäº¤ä¹‹åï¼Œå¯ä»¥åœ¨äº‹åŠ¡å¤–å¯¹æœ¬åœ°æ¶ˆæ¯è¡¨è¿›è¡ŒæŸ¥è¯¢å¹¶ä¸”è¿›è¡Œæ¶ˆæ¯æ¨é€ï¼Œæˆ–è€…é‡‡ç”¨å®šæ—¶è°ƒåº¦è½®è¯¢æœ¬åœ°æ¶ˆæ¯è¡¨è¿›è¡Œæ¶ˆæ¯æ¨é€ã€‚ 3ã€ä¸‹æ¸¸æœåŠ¡æ¶ˆè´¹æ¶ˆæ¯æˆåŠŸå¯ä»¥å›è°ƒä¸€ä¸ªç¡®è®¤åˆ°ä¸Šæ¸¸æœåŠ¡ï¼Œè¿™æ ·å°±å¯ä»¥ä»ä¸Šæ¸¸æœåŠ¡çš„æœ¬åœ°æ¶ˆæ¯è¡¨åˆ é™¤å¯¹åº”çš„æ¶ˆæ¯è®°å½•ã€‚ ä¼ªä»£ç å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132333435[æ¶ˆæ¯æ¨é€å®æ—¶æ€§é«˜ï¼Œå¯ä»¥æ¥å—ä¸¢å¤±-è¿™ç§æƒ…å†µä¸‹å¯ä»¥ä¸éœ€è¦å†™å…¥æœ¬åœ°æ¶ˆæ¯è¡¨ - start]å¤„ç†æ–¹æ³•()&#123; [æœ¬åœ°äº‹åŠ¡å¼€å§‹] 1ã€å¤„ç†ä¸šåŠ¡æ“ä½œ [æœ¬åœ°äº‹åŠ¡æäº¤] 2ã€ç»„è£…æ¨é€æ¶ˆæ¯å¹¶ä¸”è¿›è¡Œæ¨é€&#125;[æ¶ˆæ¯æ¨é€å®æ—¶æ€§é«˜ï¼Œå¯ä»¥æ¥å—ä¸¢å¤±-è¿™ç§æƒ…å†µä¸‹å¯ä»¥ä¸éœ€è¦å†™å…¥æœ¬åœ°æ¶ˆæ¯è¡¨ - end][æ¶ˆæ¯æ¨é€å®æ—¶æ€§ä½ï¼Œä¸èƒ½ä¸¢å¤± - start]å¤„ç†æ–¹æ³•()&#123; [æœ¬åœ°äº‹åŠ¡å¼€å§‹] 1ã€å¤„ç†ä¸šåŠ¡æ“ä½œ 2ã€ç»„è£…æ¨é€æ¶ˆæ¯å¹¶ä¸”å†™å…¥åˆ°æœ¬åœ°æ¶ˆæ¯è¡¨ [æœ¬åœ°äº‹åŠ¡æäº¤]&#125;æ¶ˆæ¯æ¨é€è°ƒåº¦æ¨¡å—()&#123; 3ã€æŸ¥è¯¢æœ¬åœ°æ¶ˆæ¯è¡¨å¾…æ¨é€æ•°æ®è¿›è¡Œæ¨é€&#125;[æ¶ˆæ¯æ¨é€å®æ—¶æ€§ä½ï¼Œä¸èƒ½ä¸¢å¤± - end][æ¶ˆæ¯æ¨é€å®æ—¶æ€§é«˜ï¼Œä¸èƒ½ä¸¢å¤± - start]å¤„ç†æ–¹æ³•()&#123; [æœ¬åœ°äº‹åŠ¡å¼€å§‹] 1ã€å¤„ç†ä¸šåŠ¡æ“ä½œ 2ã€ç»„è£…æ¨é€æ¶ˆæ¯å¹¶ä¸”å†™å…¥åˆ°æœ¬åœ°æ¶ˆæ¯è¡¨ [æœ¬åœ°äº‹åŠ¡æäº¤] 3ã€æ¶ˆæ¯æ¨é€&#125;æ¶ˆæ¯æ¨é€è°ƒåº¦æ¨¡å—()&#123; 4ã€æŸ¥è¯¢æœ¬åœ°æ¶ˆæ¯è¡¨å¾…æ¨é€æ•°æ®è¿›è¡Œæ¨é€&#125;[æ¶ˆæ¯æ¨é€å®æ—¶æ€§é«˜ï¼Œä¸èƒ½ä¸¢å¤± - end] å¯¹äº&quot;æ¶ˆæ¯æ¨é€å®æ—¶æ€§é«˜ï¼Œå¯ä»¥æ¥å—ä¸¢å¤±&quot;è¿™ç§æƒ…å†µï¼Œå®é™…ä¸Šä¸ç”¨ä¾èµ–æœ¬åœ°æ¶ˆæ¯è¡¨ï¼Œåªè¦åœ¨ä¸šåŠ¡æ“ä½œäº‹åŠ¡æäº¤ä¹‹åç»„è£…å’Œæ¨é€æ¶ˆæ¯å³å¯ï¼Œè¿™ç§æƒ…å†µä¼šå­˜åœ¨å› ä¸ºæ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶ä¸å¯ç”¨æˆ–è€…æœ¬åœ°åº”ç”¨å®•æœºå¯¼è‡´æ¶ˆæ¯ä¸¢å¤±çš„é—®é¢˜(æœ¬è´¨æ˜¯å› ä¸ºæ•°æ®æ˜¯å†…å­˜æ€ï¼ŒéæŒä¹…åŒ–)ï¼Œå¯é æ€§ä¸é«˜ï¼Œä½†æ˜¯ç»å¤§å¤šæ•°æƒ…å†µä¸‹æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚å¦‚æœä½¿ç”¨spring-txçš„å£°æ˜å¼äº‹åŠ¡@Transactionalæˆ–è€…ç¼–ç¨‹å¼äº‹åŠ¡TransactionTemplateï¼Œå¯ä»¥ä½¿ç”¨äº‹åŠ¡åŒæ­¥å™¨å®ç°åµŒå…¥äºä¸šåŠ¡æ“ä½œäº‹åŠ¡ä»£ç å—ä¸­çš„RPCæ“ä½œå»¶ååˆ°äº‹åŠ¡æäº¤åæ‰§è¡Œï¼Œè¿™æ ·å­RPCè°ƒç”¨çš„ä»£ç ç‰©ç†ä½ç½®å°±å¯ä»¥æ”¾ç½®åœ¨äº‹åŠ¡ä»£ç å—å†…ï¼Œä¾‹å¦‚ï¼š 12345678910@Transactional(rollbackFor = RuntimeException.class)public void process()&#123; 1.å¤„ç†ä¸šåŠ¡é€»è¾‘ TransactionSynchronizationManager.getSynchronizations().add(new TransactionSynchronizationAdapter() &#123; @Override public void afterCommit() &#123; 2.è¿›è¡Œæ¶ˆæ¯æ¨é€ &#125; &#125;);&#125; å¯¹äºä½¿ç”¨åˆ°æœ¬åœ°æ¶ˆæ¯è¡¨çš„åœºæ™¯ï¼Œéœ€è¦è­¦æƒ•ä¸‹é¢å‡ ä¸ªé—®é¢˜ï¼š 1ã€æ³¨æ„æœ¬åœ°æ¶ˆæ¯è¡¨å°½é‡ä¸è¦é•¿æ—¶é—´ç§¯å‹æ•°æ®ï¼Œæ¨é€æˆåŠŸçš„æ•°æ®éœ€è¦åŠæ—¶åˆ é™¤ã€‚ 2ã€æœ¬åœ°æ¶ˆæ¯è¡¨çš„æ•°æ®åœ¨æŸ¥è¯¢å¹¶ä¸”æ¨é€çš„æ—¶å€™ï¼Œéœ€è¦è®¾è®¡æœ€å¤§é‡è¯•æ¬¡æ•°ä¸Šé™ï¼Œè¾¾åˆ°ä¸Šé™ä»ç„¶æ¨é€å¤±è´¥çš„è®°å½•éœ€è¦è¿›è¡Œé¢„è­¦å’Œäººä¸ºå¹²é¢„ã€‚ 3ã€å¦‚æœå…¥åº“çš„æ¶ˆæ¯ä½“æ¯”è¾ƒå¤§ï¼ŒæŸ¥è¯¢å¯èƒ½æ¶ˆè€—çš„IOæ¯”è¾ƒå¤§ï¼Œéœ€è¦è€ƒè™‘æ‹†åˆ†å•ç‹¬çš„ä¸€å¼ æ¶ˆæ¯å†…å®¹è¡¨ç”¨äºå­˜æ”¾æ¶ˆæ¯ä½“å†…å®¹ï¼Œè€Œç»å¸¸æ›´å˜çš„åˆ—åº”è¯¥å•ç‹¬æ‹†åˆ†åˆ°å¦å¤–ä¸€å¼ è¡¨ã€‚ ä¾‹å¦‚æœ¬åœ°æ¶ˆæ¯è¡¨çš„è®¾è®¡å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526CREATE TABLE `t_local_message`( id BIGINT PRIMARY KEY COMMENT 'ä¸»é”®', module INT NOT NULL COMMENT 'æ¶ˆæ¯æ¨¡å—', tag VARCHAR(20) NOT NULL COMMENT 'æ¶ˆæ¯æ ‡ç­¾', business_key VARCHAR(60) NOT NULL COMMENT 'ä¸šåŠ¡é”®', queue VARCHAR(60) NOT NULL COMMENT 'é˜Ÿåˆ—', exchange VARCHAR(60) NOT NULL COMMENT 'äº¤æ¢å™¨', exchange_type VARCHAR(10) NOT NULL COMMENT 'äº¤æ¢å™¨ç±»å‹', routing_key VARCHAR(60) NOT NULL COMMENT 'è·¯ç”±é”®', retry_times TINYINT NOT NULL DEFAULT 0 COMMENT 'é‡è¯•æ¬¡æ•°', create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¥æœŸæ—¶é—´', edit_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'ä¿®æ”¹æ—¥æœŸæ—¶é—´', seq_no VARCHAR(60) NOT NULL COMMENT 'æµæ°´å·', message_status TINYINT NOT NULL DEFAULT 0 COMMENT 'æ¶ˆæ¯çŠ¶æ€', INDEX idx_business_key(business_key), INDEX idx_create_time(create_time), UNIQUE uniq_seq_no(seq_no))COMMENT 'æœ¬åœ°æ¶ˆæ¯è¡¨';CREATE TABLE `t_local_message_content`( id BIGINT PRIMARY KEY COMMENT 'ä¸»é”®', message_id BIGINT NOT NULL COMMENT 'æœ¬åœ°æ¶ˆæ¯è¡¨ä¸»é”®', message_content TEXT COMMENT 'æ¶ˆæ¯å†…å®¹', UNIQUE uniq_message_id(message_id))COMMENT 'æœ¬åœ°æ¶ˆæ¯å†…å®¹è¡¨'; åˆ†å¸ƒå¼äº‹åŠ¡å°ç»“ ä¸ªäººè®¤ä¸ºï¼Œè§£å†³åˆ†å¸ƒå¼äº‹åŠ¡çš„æœ€ä½³å®è·µå°±æ˜¯ï¼š è§„é¿ä½¿ç”¨å¼ºä¸€è‡´æ€§çš„åˆ†å¸ƒå¼äº‹åŠ¡å®ç°ï¼ŒåŸºæœ¬è§‚å¿µå°±æ˜¯æ”¾å¼ƒACIDæŠ•å¥”BASEã€‚ æ¨èä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œç³»ç»Ÿé—´çš„è§£è€¦ï¼Œæ¶ˆæ¯æ¨é€æ–¹ä¸ºäº†ç¡®ä¿æ¶ˆæ¯æ¨é€æˆåŠŸå¯ä»¥ç‹¬ç«‹é™„åŠ æ¶ˆæ¯è¡¨æŠŠéœ€è¦æ¨é€çš„æ¶ˆæ¯å’Œä¸šåŠ¡æ“ä½œç»‘å®šåœ¨åŒä¸€ä¸ªäº‹åŠ¡å†…ï¼Œä½¿ç”¨å¼‚æ­¥æˆ–è€…è°ƒåº¦çš„æ–¹å¼è¿›è¡Œæ¨é€ã€‚ æ¶ˆæ¯æ¨é€æ–¹(ä¸Šæ¸¸)éœ€è¦ç¡®ä¿æ¶ˆæ¯æ­£ç¡®æŠ•é€’åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶ï¼Œæ¶ˆæ¯æ¶ˆè´¹æˆ–è€…è¡¥å¿æ–¹æ¡ˆç”±æ¶ˆæ¯æ¶ˆè´¹æ–¹(ä¸‹æ¸¸)è‡ªè¡Œè§£å†³ï¼Œå…³äºè¿™ä¸€ç‚¹åæ–‡ä¸€ä¸ªç« èŠ‚ä¸“é—¨è§£é‡Šã€‚ å…¶å®ï¼Œå¯¹äºä¸€è‡´æ€§å’Œå®æ—¶æ€§è¦æ±‚ç›¸å¯¹è¾ƒé«˜çš„åˆ†å¸ƒå¼äº‹åŠ¡çš„å®ç°ï¼Œä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—è§£è€¦ä¹Ÿæœ‰å¯¹åº”çš„è§£å†³æ–¹æ¡ˆã€‚ å¹‚ç­‰æ§åˆ¶ å¹‚ç­‰(idempotence)è¿™ä¸ªæœ¯è¯­åŸæ–‡æ¥è‡ªäºHTTP/1.1åè®®ä¸­çš„å®šä¹‰ï¼š Methods can also have the property of â€œidempotenceâ€ in that (aside from error or expiration issues) the side-effects of N &gt; 0 identical requests is the same as for a single request. ç®€å•æ¥è¯´å°±æ˜¯ï¼šé™¤äº†é”™è¯¯æˆ–è€…è¿‡æœŸçš„è¯·æ±‚(æ¢è¨€ä¹‹å°±æ˜¯æˆåŠŸçš„è¯·æ±‚)ï¼Œæ— è®ºå¤šæ¬¡è°ƒç”¨è¿˜æ˜¯å•æ¬¡è°ƒç”¨æœ€ç»ˆå¾—åˆ°çš„æ•ˆæœæ˜¯ä¸€è‡´çš„ã€‚é€šä¿—æ¥è¯´ï¼Œæœ‰ä¸€æ¬¡è°ƒç”¨æˆåŠŸï¼Œé‡‡ç”¨ç›¸åŒçš„è¯·æ±‚å‚æ•°æ— è®ºè°ƒç”¨å¤šå°‘æ¬¡(é‡å¤æäº¤)éƒ½åº”è¯¥è¿”å›æˆåŠŸã€‚ ä¸‹æ¸¸æœåŠ¡å¯¹å¤–æä¾›æœåŠ¡æ¥å£ï¼Œå¿…é¡»æ‰¿è¯ºå®ç°æ¥å£çš„å¹‚ç­‰æ€§ï¼Œè¿™ä¸€ç‚¹åœ¨åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æå…¶é‡è¦ã€‚ å¯¹äºHTTPè°ƒç”¨ï¼Œæ‰¿è¯ºå¹‚ç­‰æ€§å¯ä»¥é¿å…è¡¨å•æˆ–è€…è¯·æ±‚æ“ä½œé‡å¤æäº¤é€ æˆä¸šåŠ¡æ•°æ®é‡å¤ã€‚ å¯¹äºå¼‚æ­¥æ¶ˆæ¯è°ƒç”¨ï¼Œæ‰¿è¯ºå¹‚ç­‰æ€§é€šè¿‡å¯¹æ¶ˆæ¯å»é‡å¤„ç†ä¹Ÿæ˜¯ç”¨äºé¿å…é‡å¤æ¶ˆè´¹é€ æˆä¸šåŠ¡æ•°æ®é‡å¤ã€‚ ç›®å‰å®è·µä¸­å¯¹äºå¹‚ç­‰çš„å¤„ç†ä½¿ç”¨äº†ä¸‹é¢ä¸‰ä¸ªæ–¹é¢çš„æ§åˆ¶ï¼š 1ã€å®ç°å¹‚ç­‰çš„æ¥å£è°ƒç”¨æ—¶å…¥å£ä½¿ç”¨åˆ†å¸ƒå¼é”ï¼Œä½¿ç”¨äº†ä¸»æµçš„Redissonï¼Œæ§åˆ¶é”çš„ç²’åº¦å’Œé”çš„ç­‰å¾…ã€æŒæœ‰æ—¶é—´åœ¨åˆç†èŒƒå›´(ç¬”è€…æ‰€åœ¨è¡Œä¸šè¦æ±‚æ•°æ®å¿…é¡»å‡†ç¡®æ— è¯¯ï¼Œæ‰€ä»¥å‡ ä¹ç”¨æ‚²è§‚é”è®¾è®¡æ‰€æœ‰æ ¸å¿ƒæ¥å£ï¼Œå®æ„¿æ…¢ä¹Ÿä¸èƒ½é”™ï¼Œå®é™…ä¸Šå¦‚æœå†²çªæ¯”è¾ƒä½çš„æ—¶å€™ä¸ºäº†æ€§èƒ½ä¼˜åŒ–å¯ä»¥è€ƒè™‘ä½¿ç”¨ä¹è§‚é”)ã€‚ 2ã€ä¸šåŠ¡é€»è¾‘ä¸Šçš„é˜²é‡ï¼Œä¾‹å¦‚åˆ›å»ºè®¢å•çš„æ¥å£å…ˆåšä¸€æ­¥é€šè¿‡è®¢å•å·æŸ¥è¯¢åº“è¡¨ä¸­æ˜¯å¦å·²ç»å­˜åœ¨å¯¹åº”çš„è®¢å•ï¼Œå¦‚æœå­˜åœ¨åˆ™ä¸åšå¤„ç†ç›´æ¥è¿”å›æˆåŠŸã€‚ 3ã€æ•°æ®åº“è¡¨è®¾è®¡å¯¹é€»è¾‘ä¸Šå”¯ä¸€çš„ä¸šåŠ¡é”®åšå”¯ä¸€ç´¢å¼•ï¼Œè¿™ä¸ªæ˜¯é€šè¿‡æ•°æ®åº“å±‚é¢åšæœ€åçš„ä¿éšœã€‚ ä¸¾ä¸€ä¸ªåŸºäºæ¶ˆæ¯æ¶ˆè´¹å¹‚ç­‰æ§åˆ¶çš„ä¼ªä»£ç ä¾‹å­ï¼š 1234567[å¤„ç†æ¶ˆæ¯æ¶ˆè´¹]listen(request)&#123; 1ã€é€šè¿‡ä¸šåŠ¡é”®æ„å»ºåˆ†å¸ƒå¼é”çš„KEY 2ã€é€šè¿‡Redissonæ„å»ºåˆ†å¸ƒå¼é”å¹¶ä¸”åŠ é” 3ã€åŠ é”ä»£ç ä¸­æ‰§è¡Œä¸šåŠ¡é€»è¾‘(åŒ…æ‹¬å»é‡åˆ¤æ–­ã€äº‹åŠ¡æ“ä½œå’Œéäº‹åŠ¡æ“ä½œç­‰) 4ã€finallyä»£ç å—ä¸­é‡Šæ”¾åˆ†å¸ƒå¼é”&#125; è¡¥å¿æ–¹æ¡ˆ è¡¥å¿æ–¹æ¡ˆä¸»è¦æ˜¯HTTPåŒæ­¥è°ƒç”¨çš„è¡¥å¿å’Œå¼‚æ­¥æ¶ˆæ¯æ¶ˆè´¹å¤±è´¥çš„è¡¥å¿ã€‚ HTTPåŒæ­¥è°ƒç”¨è¡¥å¿ ä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒHTTPåŒæ­¥è°ƒç”¨ä¼šå¾—åˆ°ä¸‹æ¸¸ç³»ç»Ÿçš„åŒæ­¥ç»“æœï¼Œå¯¹ç»“æœçš„å¤„ç†å­˜åœ¨ä¸‹é¢å‡ ç§å¸¸è§çš„æƒ…å†µï¼š 1ã€åŒæ­¥ç»“æœè¿”å›æ­£å¸¸ï¼Œå¾—åˆ°äº†å’Œä¸‹æ¸¸çº¦å®šçš„æœ€ç»ˆçŠ¶æ€ï¼Œäº¤äº’ç»“æŸï¼Œä¸€èˆ¬è®¤ä¸ºæˆåŠŸå°±æ˜¯æœ€ç»ˆçŠ¶æ€ï¼Œä¸éœ€è¦è¡¥å¿ã€‚ 2ã€åŒæ­¥ç»“æœè¿”å›æ­£å¸¸ï¼Œå¾—åˆ°äº†å’Œä¸‹æ¸¸çº¦å®šçš„éæœ€ç»ˆçŠ¶æ€ï¼Œéœ€è¦å®šæ—¶è¡¥å¿åˆ°æœ€ç»ˆçŠ¶æ€æˆ–åˆ°è¾¾é‡è¯•ä¸Šé™è‡ªè¡Œæ ‡è®°ä¸ºæœ€ç»ˆçŠ¶æ€ã€‚ 3ã€åŒæ­¥ç»“æœè¿”å›å¼‚å¸¸ï¼Œæœ€å¸¸è§çš„æ˜¯ä¸‹æ¸¸æœåŠ¡ä¸å¯ç”¨è¿”å›HTTPçŠ¶æ€ç ä¸º5XXã€‚ é¦–å…ˆè¦æœ‰ä¸€ä¸ªç®€å•çš„è®¤çŸ¥ï¼šçŸ­æ—¶é—´å†…çš„HTTPé‡è¯•é€šå¸¸æƒ…å†µä¸‹éƒ½æ˜¯æ— æ•ˆçš„ã€‚å¦‚æœæ˜¯ç¬æ—¶çš„ç½‘ç»œæŠ–åŠ¨ï¼ŒçŸ­æ—¶é—´å†…HTTPåŒæ­¥é‡è¯•æ˜¯å¯è¡Œçš„ï¼Œå¤§éƒ¨åˆ†æƒ…å†µä¸‹æ˜¯ä¸‹æ¸¸æœåŠ¡æ— æ³•å“åº”ã€ä¸‹æ¸¸æœåŠ¡é‡å¯ä¸­æˆ–è€…å¤æ‚çš„ç½‘ç»œæƒ…å†µå¯¼è‡´çŸ­æ—¶é—´å†…æ— æ³•æ¢å¤ï¼Œè¿™ä¸ªæ—¶å€™åšHTTPåŒæ­¥é‡è¯•è°ƒç”¨å¾€å¾€æ˜¯æ— æ•ˆçš„ã€‚ å¦‚æœé¢å¯¹çš„åœºæ™¯æ˜¯å†…éƒ¨ä½å¹¶å‘é‡çš„ç³»ç»Ÿä¹‹é—´çš„è¿›è¡ŒHTTPäº¤äº’ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨åŸºäºæŒ‡æ•°é€€é¿çš„ç®—æ³•è¿›è¡Œé‡è¯•ï¼Œä¸¾ä¸ªä¾‹å­ï¼š 123451ã€ç¬¬ä¸€æ¬¡è°ƒç”¨å¤±è´¥ï¼Œé©¬ä¸Šè¿›è¡Œç¬¬äºŒæ¬¡é‡è¯•2ã€ç¬¬äºŒæ¬¡é‡è¯•å¤±è´¥ï¼Œçº¿ç¨‹ä¼‘çœ 2ç§’3ã€ç¬¬ä¸‰æ¬¡é‡è¯•å¤±è´¥ï¼Œçº¿ç¨‹ä¼‘çœ 4ç§’(2^2)4ã€ç¬¬å››æ¬¡é‡è¯•å¤±è´¥ï¼Œçº¿ç¨‹ä¼‘çœ 8ç§’(2^3)5ã€ç¬¬äº”æ¬¡é‡è¯•å¤±è´¥ï¼ŒæŠ›å‡ºå¼‚å¸¸ å¦‚æœä¸Šé¢çš„ä¾‹å­ä¸­ä½¿ç”¨äº†Hystrixæ§åˆ¶è¶…æ—¶ä¸º1ç§’åŒ…è£¹ç€è¦æ‰§è¡Œçš„HTTPå‘½ä»¤è¿›è¡Œè°ƒç”¨ï¼Œä¸Šé¢çš„é‡è¯•è¿‡ç¨‹æœ€å¤§è€—æ—¶å°äº20ç§’ï¼Œåœ¨ä½å¹¶å‘çš„å†…éƒ¨ç³»ç»Ÿä¹‹é—´çš„äº¤äº’æ˜¯å¯ä»¥æ¥å—çš„ã€‚ ä½†æ˜¯ï¼Œå¦‚æœé¢å¯¹çš„æ˜¯å¹¶å‘æ¯”è¾ƒé«˜ã€ç”¨æˆ·ä½“éªŒä¼˜å…ˆçº§æ¯”è¾ƒé«˜çš„åœºæ™¯ï¼Œè¿™æ ·åšæ˜¾ç„¶æ˜¯ä¸åˆç†çš„ã€‚ä¸ºäº†ç¨³å¦¥èµ·è§ï¼Œå¯ä»¥é‡‡å–ç›¸å¯¹ä¼ ç»Ÿè€Œæœ‰æ•ˆçš„æ–¹æ¡ˆï¼šHTTPè°ƒç”¨çš„è°ƒç”¨ä¿¡æ¯å¿«ç…§å†…å®¹ä¿å­˜åˆ°ä¸€å¼ æœ¬åœ°é‡è¯•è¡¨ä¸­ï¼Œè¿™ä¸ªä¿å­˜æ“ä½œç»‘å®šåœ¨ä¸šåŠ¡å¤„ç†çš„äº‹åŠ¡ä¸­ï¼Œé€šè¿‡å®šæ—¶è°ƒåº¦å¯¹æœªè°ƒç”¨æˆåŠŸçš„è®°å½•è¿›è¡Œé‡è¯•ã€‚è¿™ä¸ªæ–¹æ¡ˆå’Œä¸Šæ–‡æåˆ°ä¿è¯æ¶ˆæ¯æ¨é€æˆåŠŸçš„æ–¹æ¡ˆç±»ä¼¼ï¼Œä¸¾ä¸€ä¸ªä»¿çœŸçš„ä¾‹å­ï¼š 123456789101112[ä¸‹å•æ¥å£è¯·æ±‚ä¸‹æ¸¸é’±åŒ…æœåŠ¡æ‰£é’±çš„è¿‡ç¨‹]process()&#123; [äº‹åŠ¡ä»£ç å—-start] 1ã€å¤„ç†ä¸šåŠ¡é€»è¾‘ï¼Œä¿å­˜è®¢å•ä¿¡æ¯ï¼Œè®¢å•çŠ¶æ€ä¸ºæ‰£é’±å¤„ç†ä¸­ 2ã€ç»„è£…å°†è¦å‘ä¸‹æ¸¸é’±åŒ…æœåŠ¡å‘èµ·çš„HTTPè°ƒç”¨ä¿¡æ¯ï¼Œä¿å­˜åœ¨æœ¬åœ°è¡¨ä¸­ [äº‹åŠ¡ä»£ç å—-end] 3ã€äº‹åŠ¡å¤–è¿›è¡ŒHTTPè°ƒç”¨(OkHttpå®¢æˆ·ç«¯æˆ–è€…Apacheçš„Httpå®¢æˆ·ç«¯)ï¼Œè°ƒç”¨æˆåŠŸæ›´æ–°è®¢å•çŠ¶æ€ä¸ºæ‰£é’±æˆåŠŸ&#125;å®šæ—¶è°ƒåº¦()&#123; 4ã€å®šæ—¶æŸ¥è¯¢è®¢å•çŠ¶æ€ä¸ºæ‰£é’±å¤„ç†ä¸­çš„è®¢å•è¿›è¡ŒHTTPè°ƒç”¨ï¼Œè°ƒç”¨æˆåŠŸæ›´æ–°è®¢å•çŠ¶æ€ä¸ºæ‰£é’±æˆåŠŸ&#125; å¼‚æ­¥æ¶ˆæ¯æ¶ˆè´¹å¤±è´¥è¡¥å¿ å¼‚æ­¥æ¶ˆæ¯æ¶ˆè´¹å¤±è´¥çš„åœºæ™¯å‘ç”Ÿåªèƒ½åœ¨æ¶ˆæ¯æ¶ˆè´¹æ–¹ï¼Œä¹Ÿå°±æ˜¯ä¸‹æ¸¸æœåŠ¡ã€‚ä»é™ä½æˆæœ¬çš„ç›®çš„ä¸Šçœ‹ï¼Œæ¶ˆæ¯æ¶ˆè´¹å¤±è´¥çš„è¡¥å¿åº”è¯¥ç”±æ¶ˆæ¯å¤„ç†çš„ä¸€æ–¹(æ¶ˆè´¹è€…)è‡ªè¡Œæ‰¿æ‹…ï¼Œç”»ä¸€ä¸ªç³»ç»Ÿäº¤äº’å›¾ç†è§£ä¸€ä¸‹ï¼š å¦‚æœç”±ä¸Šæ¸¸æœåŠ¡è¿›è¡Œè¡¥å¿ï¼Œå­˜åœ¨ä¸¤ä¸ªæ˜æ˜¾çš„é—®é¢˜ï¼š 1ã€æ¶ˆæ¯è¡¥å¿æ¨¡å—éœ€è¦åœ¨æ‰€æœ‰çš„ä¸Šæ¸¸æœåŠ¡ä¸­ç¼–å†™ï¼Œè¿™æ˜¯ä¸åˆç†çš„ã€‚ 2ã€ä¸€æ—¦ä¸‹æ¸¸æ¶ˆè´¹å‡ºç°ç”Ÿäº§é—®é¢˜éœ€è¦ä¸Šæ¸¸è¡¥å¿ï¼Œéœ€è¦å…ˆå®šä½å‡ºå¯¹åº”çš„æ¶ˆæ¯æ˜¯å“ªä¸ªä¸Šæ¸¸æœåŠ¡æ¨é€ï¼Œç„¶åé€šè¿‡è¯¥ä¸Šæ¸¸æœåŠ¡è¿›è¡Œè¡¥å¿ï¼Œå¤„ç†ç”Ÿäº§é—®é¢˜çš„å¤æ‚åº¦æé«˜ã€‚ åœ¨æœ€è¿‘çš„ä¸€äº›é¡¹ç›®å®è·µä¸­ï¼Œç¡®å®šåœ¨ä½¿ç”¨å¼‚æ­¥æ¶ˆæ¯äº¤äº’çš„æ—¶å€™ï¼Œè¡¥å¿ç»Ÿä¸€ç”±æ¶ˆæ¯æ¶ˆè´¹æ–¹å®ç°ã€‚æœ€ç®€å•çš„æ–¹å¼ä¹Ÿæ˜¯ä½¿ç”¨ç±»ä¼¼æœ¬åœ°æ¶ˆæ¯è¡¨çš„æ–¹å¼ï¼ŒæŠŠæ¶ˆè´¹å¤±è´¥çš„æ¶ˆæ¯å…¥åº“ï¼Œå¹¶ä¸”è¿›è¡Œé‡è¯•ï¼Œåˆ°è¾¾é‡è¯•ä¸Šé™ä¾ç„¶å¤±è´¥åˆ™è¿›è¡Œé¢„è­¦å’Œäººå·¥ä»‹å…¥å³å¯ã€‚ç®€å•çš„æµç¨‹å›¾å¦‚ä¸‹ï¼š å¼‚æ­¥æ¶ˆæ¯ä¹±åºè§£å†³ å¼‚æ­¥æ¶ˆæ¯ä¹±åºæ˜¯ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—è¿›è¡Œå¼‚æ­¥äº¤äº’åœºæ™¯ä¸­éœ€è¦è€ƒè™‘å’Œè§£å†³çš„é—®é¢˜ã€‚ä¸‹é¢ä¸¾ä¸€äº›å¯èƒ½ä¸åˆä¹å®é™…ä½†æ˜¯èƒ½å¤Ÿè¯´æ˜é—®é¢˜çš„ä¾‹å­ã€‚ åœºæ™¯ä¸€ï¼šä¸Šæ¸¸æŸä¸ªæœåŠ¡å‘ç”¨æˆ·æœåŠ¡é€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—å¼‚æ­¥ä¿®æ”¹ç”¨æˆ·çš„æ€§åˆ«ä¿¡æ¯ï¼Œå‡è®¾æ¶ˆæ¯ç®€åŒ–å¦‚ä¸‹ï¼š 123456é˜Ÿåˆ—ï¼šuser-service.modify.sex.qeueæ¶ˆæ¯:&#123; \"userId\": é•¿æ•´å‹, \"sex\": å­—ç¬¦ä¸²,å¯é€‰å€¼æ˜¯MANã€WOMANå’ŒUNKNOW&#125; ç”¨æˆ·æœåŠ¡ä¸€å…±ä½¿ç”¨äº†10ä¸ªæ¶ˆè´¹è€…çº¿ç¨‹ç›‘å¬user-service.modify.sex.qeueé˜Ÿåˆ—ã€‚å‡è®¾ä¸Šæ¸¸æœåŠ¡å…ˆåå‘user-service.modify.sex.qeueé˜Ÿåˆ—æ¨é€ä¸‹é¢ä¸¤æ¡æ¶ˆæ¯ï¼š 1234567891011ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼š&#123; \"userId\": 1, \"sex\": \"MAN\"&#125; ç¬¬äºŒæ¡æ¶ˆæ¯ï¼š&#123; \"userId\": 1, \"sex\": \"WOMAN\"&#125; ä¸Šé¢çš„æ¶ˆæ¯æ¨é€å’Œä¸‹æ¸¸å¤„ç†æœ‰æ¯”è¾ƒé«˜å‡ ç‡å‡ºç°ä¸‹é¢çš„æƒ…å†µï¼š åŸæœ¬ç”¨æˆ·IDä¸º1çš„ç”¨æˆ·å…ˆæŠŠæ€§åˆ«æ”¹ä¸ºMAN(ç¬¬ä¸€æ¬¡è¯·æ±‚)ï¼Œåæ¥æ”¹ä¸ºWOMAN(ç¬¬äºŒæ¬¡è¯·æ±‚)ï¼Œæœ€ç»ˆçœ‹åˆ°æ›´æ–°åçš„æ€§åˆ«æœ‰å¯èƒ½æ˜¯MANï¼Œè¿™æ˜¾ç„¶æ˜¯ä¸åˆç†çš„ã€‚è¿™ä¸ªä¸æ˜¯å¾ˆåˆç†çš„ä¾‹å­æƒ³è¯´æ˜çš„é—®é¢˜æ˜¯ï¼šé€šè¿‡å¼‚æ­¥æ¶ˆæ¯äº¤äº’ï¼Œä¸‹æ¸¸æœåŠ¡å¤„ç†æ¶ˆæ¯çš„æ—¶åºæœ‰å¯èƒ½å’Œä¸Šæ¸¸å‘é€æ¶ˆæ¯çš„æ—¶åºå¹¶ä¸ä¸€è‡´ï¼Œè¿™æ ·æœ‰å¯èƒ½å¯¼è‡´ä¸šåŠ¡çŠ¶æ€é”™ä¹±ã€‚å¯¹äºè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæä¾›å‡ ä¸ªå¯è¡Œçš„æ€è·¯ï¼š æ–¹æ¡ˆä¸€ï¼šå¹¶å‘è¦æ±‚ä¸é«˜çš„æƒ…å†µä¸‹ï¼Œå¯ä»¥å……åˆ†åˆ©ç”¨æ¶ˆæ¯é˜Ÿåˆ—FIFOçš„ç‰¹æ€§(è¿™ä¸€ç‚¹RabbitMQå®ç°äº†ï¼Œå…¶ä»–æ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶ä¸ç¡®å®š)ï¼ŒæŠŠä¸‹æ¸¸æœåŠ¡çš„æ¶ˆè´¹çº¿ç¨‹è®¾ç½®ä¸º1å³å¯ï¼Œé‚£ä¹ˆä¸Šæ¸¸æ¨é€çš„æ¶ˆæ¯å’Œä¸‹æ¸¸æ¶ˆè´¹æ¶ˆæ¯çš„æ—¶åºæ˜¯ä¸€è‡´çš„(è¿™ä¸ªæ–¹æ¡ˆæœ‰ç¼ºé™·ï¼Œå› ä¸ºåˆ†å¸ƒå¼å¤šèŠ‚ç‚¹éƒ¨ç½²ï¼Œä¸‹æ¸¸æœåŠ¡èŠ‚ç‚¹ä¼šè¶…è¿‡ä¸¤ä¸ªï¼Œå› æ­¤æ¶ˆè´¹è€…çº¿ç¨‹ä¸€å®šä¼šå¤§äº1)ã€‚ æ–¹æ¡ˆäºŒï¼šä½¿ç”¨HTTPè°ƒç”¨ï¼Œè¿™ä¸ªè¦å‰ç«¯æˆ–è€…APPå®¢æˆ·ç«¯é…åˆï¼Œè¯·æ±‚è®¾è®¡æˆä¸²è¡Œçš„å³å¯ã€‚ æ–¹æ¡ˆä¸‰ï¼šè¿™æ˜¯ä¸€ä¸ªå®éªŒæ€§æ–¹æ¡ˆï¼Œä¸ªäººåªåœ¨Demoä¸­å°è¯•è¿‡ï¼Œé‡‡ç”¨å–æ¨¡æˆ–è€…Hashå¯¹é˜Ÿåˆ—è¿›è¡Œåˆ†ç‰‡ï¼Œä¸Šé¢çš„ä¾‹å­åŸºäºç”¨æˆ·ID % 10å–æ¨¡å»ºç«‹queue_0åˆ°queue_9ä¸€å…±10ä¸ªé˜Ÿåˆ—ï¼Œä¸‹æ¸¸å¯åŠ¨10ä¸ªæ¶ˆè´¹è€…çº¿ç¨‹ï¼Œqueue_0åˆ°queue_9æ¯ä¸ªé˜Ÿåˆ—åªå¯åŠ¨ä¸€ä¸ªæ¶ˆè´¹çº¿ç¨‹(ä¾‹å¦‚ä¸‹æ¸¸æœåŠ¡æœ‰åŒèŠ‚ç‚¹ï¼ŒèŠ‚ç‚¹1æ¶ˆè´¹queue_0åˆ°queue_4ï¼ŒèŠ‚ç‚¹2æ¶ˆè´¹queue_5åˆ°queue_9)ï¼Œè¿™æ ·å­èƒ½å¤Ÿä¿è¯å•ä¸ªç”¨æˆ·IDçš„æ€§åˆ«æ›´æ–°æ“ä½œæ˜¯ä¸²è¡Œçš„ã€‚ åœºæ™¯äºŒï¼šæ²¡æœ‰æ—¶åºè¦æ±‚çš„å¼‚æ­¥æ¶ˆæ¯å¤„ç†ï¼Œä½†æ˜¯è¦æ±‚æœ€ç»ˆå±•ç¤ºçš„æ—¶å€™æ˜¯æœ‰æ—¶åºçš„ã€‚è¿™æ ·è¯´å¯èƒ½æœ‰ç‚¹æŠ½è±¡ï¼Œä¸¾ä¸ªä¾‹å­ï¼šåœ¨å€Ÿå‘—ä¸Šå€Ÿäº†10000å…ƒï¼Œè¿˜æ¬¾çš„æ—¶å€™ï¼Œç”¨æˆ·æ˜¯åˆ†å¤šæ¬¡è¿˜æ¸…(ä¾‹å¦‚è¿˜æ¬¾æ–¹æ¡ˆä¸€ï¼š2000,3000,5000ï¼›è¿˜æ¬¾æ–¹æ¡ˆäºŒï¼š1000,1000ï¼Œ1000ï¼Œ7000ç­‰ç­‰)ï¼Œæ¯æ¬¡è¿˜çš„é’±éƒ½ä¸ä¸€æ ·ï¼Œæœ€ç»ˆè¦æ±‚è´¦å•å±•ç¤ºçš„æ—¶å€™æ˜¯æŒ‰ç…§ç”¨æˆ·çš„è¿˜æ¬¾æ“ä½œé¡ºåºã€‚ å‡è®¾å€Ÿå‘—çš„ä¸Šæ¸¸æœåŠ¡å’Œå®ƒé€šè¿‡å¼‚æ­¥æ¶ˆæ¯äº¤äº’ã€‚è¯¦ç»†åˆ†æä¸€ä¸‹ï¼šè¿™ä¸ªåœºæ™¯å…¶å®å¯¹äºå€Ÿå‘—(ä¸»è¦æ˜¯è€ƒè™‘æ”¶å›ç”¨æˆ·çš„è¿˜æ¬¾è¿™ä¸ªç›®çš„)æ¥è¯´ï¼Œå¯¹ç”¨æˆ·è¿˜æ¬¾çš„é¡ºåºå¹¶ä¸éœ€è¦æ„ŸçŸ¥ï¼Œåªéœ€è¦è€ƒè™‘ç”¨æˆ·æ˜¯å¦è¿˜æ¸…ï¼Œä½†æ˜¯ä½¿ç”¨å¼‚æ­¥äº¤äº’ï¼Œæœ‰å¯èƒ½å¯¼è‡´ä¸‹æ¸¸æ— æ³•æ­£ç¡®å¾—çŸ¥ç”¨æˆ·è¿˜æ¬¾çš„æ“ä½œé¡ºåºã€‚ è§£å†³æ–¹æ¡ˆå¾ˆç®€å•ï¼šæ¨é€æ¶ˆæ¯çš„æ—¶å€™é™„åŠ ä¸€ä¸ªå¸¦æœ‰å¢é•¿æˆ–è€…å‡å°‘è¶‹åŠ¿çš„æ ‡è®°ä½å³å¯ï¼Œä¾‹å¦‚ä½¿ç”¨å¸¦æœ‰æ—¶é—´æˆ³çš„æ ‡è®°ä½æˆ–è€…ä½¿ç”¨Snowflakeç®—æ³•ç”Ÿæˆè‡ªå¢è¶‹åŠ¿çš„é•¿æ•´å‹æ•°ä½œä¸ºæµæ°´å·ï¼Œä¹‹åæŒ‰ç…§æµæ°´å·æ’åºå³å¯å¾—åˆ°æ¶ˆæ¯æ“ä½œçš„é¡ºåº(è¿™ä¸ªæµæ°´å·ä¸‹æ¸¸éœ€è¦ä¿å­˜)ï¼Œä½†æ˜¯å®é™…æ¶ˆæ¯å¤„ç†çš„æ—¶å€™å¹¶ä¸éœ€è¦æ„ŸçŸ¥æ¶ˆæ¯çš„æ—¶åºã€‚ å¼‚æ­¥æ¶ˆæ¯ç»“åˆçŠ¶æ€é©±åŠ¨ ä¸ªäººè®¤ä¸ºï¼šå¼‚æ­¥æ¶ˆæ¯ç»“åˆçŠ¶æ€é©±åŠ¨æ˜¯å¯ä»¥ç›¸å¯¹å®Œå–„åœ°è§£å†³åˆ†å¸ƒå¼äº‹åŠ¡ï¼Œç»“åˆé¢„å¤„ç†(ä¾‹å¦‚é¢„æ‰£é™¤æˆ–è€…é¢„å¢é•¿)å¯ä»¥æ»¡è¶³æ¯”è¾ƒé«˜ä¸€è‡´æ€§å’Œå®æ—¶æ€§ã€‚å…ˆå¼•å‡ºä¸€ä¸ªç»å¸¸ç”¨æ¥è®¨è®ºåˆ†å¸ƒå¼äº‹åŠ¡å¼ºä¸€è‡´æ€§çš„è½¬è´¦åœºæ™¯ã€‚ è§£å†³è¿™ä¸ªé—®é¢˜å¦‚æœä½¿ç”¨åŒæ­¥è°ƒç”¨(å…¶å®åƒTCCã€2PCæˆ–è€…3PCç­‰æœ¬è´¨éƒ½æ˜¯åŒæ­¥è°ƒç”¨)ï¼Œåœ¨å…è®¸æ€§èƒ½æŸå¤±çš„æƒ…å†µä¸‹æ˜¯èƒ½å¤Ÿè¾¾åˆ°æ¯”è¾ƒé«˜çš„ä¸€è‡´æ€§ã€‚è¿™ä¸€èŠ‚å¹¶ä¸è®¨è®ºåŒæ­¥è°ƒç”¨çš„æƒ…å†µä¸‹æ€ä¹ˆåšï¼Œé‡ç‚¹ç ”ç©¶ä¸€ä¸‹åœ¨ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—çš„æƒ…å†µä¸‹ï¼Œå¦‚ä½•ä»BASEçš„è§’åº¦&quot;è¾¾åˆ°æ¯”è¾ƒé«˜çš„ä¸€è‡´æ€§&quot;ã€‚å…ˆæŠŠè¿™ä¸ªä¾‹å­æŠ½è±¡åŒ–ï¼Œå‡è®¾ä¸¤ä¸ªç³»ç»Ÿçš„è´¦æˆ·è¡¨éƒ½è®¾è®¡æˆè¿™æ ·ï¼š 123456789CREATE TABLE `t_account`( id BIGINT PRIMARY KEY COMMENT 'ä¸»é”®', user_id BIGINT NOT NULL COMMENT 'ç”¨æˆ·ID', balance DECIMAL(10,2) NOT NULL DEFAULT 0 COMMENT 'è´¦æˆ·ä½™é¢', create_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´', edit_time DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'ä¿®æ”¹æ—¶é—´', version BIGINT NOT NULL DEFAULT 0 COMMENT 'ç‰ˆæœ¬' // çœç•¥ç´¢å¼•)COMMENT 'è´¦æˆ·è¡¨'; ä¸¤ä¸ªç³»ç»Ÿéƒ½å¯ä»¥å»ºç«‹ä¸€å¼ è¡¨ç»“æ„ç›¸ä¼¼çš„é‡‘é¢å˜æ›´æµæ°´è¡¨ï¼Œä¸Šæ¸¸ç³»ç»Ÿç”¨äºåšé¢„æ‰£æ“ä½œå’Œæµæ°´è®°å½•ï¼Œä¸‹æ¸¸ç³»ç»Ÿç”¨äºåšæµæ°´è®°å½•ï¼Œæ¥ç€æˆ‘ä»¬å¯ä»¥æ¢³ç†å‡ºæ–°çš„äº¤äº’æ—¶åºé€»è¾‘å¦‚ä¸‹ï¼š 1234567891011121314151617181920[Aç³»ç»Ÿæœ¬åœ°äº‹åŠ¡-start]1ã€Aç³»ç»Ÿt_accountè¡¨Xç”¨æˆ·ä½™é¢å‡å»10002ã€Aç³»ç»Ÿæµæ°´è¡¨å†™å…¥ä¸€æ¡ç”¨æˆ·Xçš„é¢„æ‰£1000çš„è®°å½•ï¼Œæ ‡è®°çŠ¶æ€ä¸ºå¤„ç†ä¸­ï¼Œç”Ÿæˆå…¨å±€å”¯ä¸€çš„æµæ°´å·è®°ä¸ºSEQ_NO[Aç³»ç»Ÿæœ¬åœ°äº‹åŠ¡-end]3ã€Aç³»ç»Ÿé€šè¿‡æ¶ˆæ¯é˜Ÿåˆ—æ¨é€ä¸€æ¡ç”¨æˆ·Xæ‰£å‡1000çš„æ¶ˆæ¯(ä¸€å®šè¦é™„å¸¦æµæ°´å·SEQ_NO)åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶(è¿™é‡Œå¯ä»¥ç”¨ä¸Šæ–‡æåˆ°çš„æŠ€å·§ç¡®ä¿æ¶ˆæ¯æ¨é€æˆåŠŸ)[Bç³»ç»Ÿæœ¬åœ°äº‹åŠ¡-start]4ã€Bç³»ç»Ÿt_accountè¡¨Xç”¨æˆ·ä½™é¢åŠ ä¸Š10005ã€Bç³»ç»Ÿæµæ°´è¡¨å†™å…¥ä¸€æ¡ç”¨æˆ·Xçš„ä½™é¢å˜æ›´(å¢åŠ )1000çš„è®°å½• &lt;= æ³¨æ„è¿™é‡ŒBç³»ç»Ÿçš„æµæ°´åªèƒ½insertä¸èƒ½update[Bç³»ç»Ÿæœ¬åœ°äº‹åŠ¡-end]6ã€Bç³»ç»Ÿæ¨é€å¤„ç†Xç”¨æˆ·ä½™é¢å¤„ç†æˆåŠŸçš„æ¶ˆæ¯åˆ°æ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶ï¼Œä¸€å®šè¦é™„å¸¦æµæ°´å·SEQ_NO(è¿™é‡Œå¯ä»¥ç”¨ä¸Šæ–‡æåˆ°çš„æŠ€å·§ç¡®ä¿æ¶ˆæ¯æ¨é€æˆåŠŸ)[Aç³»ç»Ÿæœ¬åœ°äº‹åŠ¡-start]7ã€Aç³»ç»Ÿæ›´æ–°æµæ°´è¡¨ä¸­Xç”¨æˆ·æµæ°´å·ä¸ºSEQ_NOçš„é¢„æ‰£è®°å½•çš„çŠ¶æ€ä¸ºå¤„ç†æˆåŠŸ(è¿™ä¸€æ­¥ä¸€å®šè¦åšå¥½å¹‚ç­‰æ§åˆ¶ï¼Œå¯ä»¥è€ƒè™‘ç”¨SEQ_NOä½œä¸ºåˆ†å¸ƒå¼é”çš„KEY)[Aç³»ç»Ÿæœ¬åœ°äº‹åŠ¡-end]å…¶ä»–ï¼š[Aç³»ç»Ÿæµæ°´è¡¨å¤„ç†ä¸­çš„è®°å½•éœ€è¦å®šæ—¶è½®è¯¢å’Œé‡è¯•]1ã€å®šæ—¶è°ƒåº¦é‡è¯•Aç³»ç»Ÿæµæ°´è¡¨ä¸­çŠ¶æ€ä¸ºå¤„ç†ä¸­çš„è®°å½•[A-Bç³»ç»Ÿæ—¥åˆ‡å¯¹è´¦æ¨¡å—]1ã€æ—¥åˆ‡ï¼Œç”¨Aç³»ç»Ÿä¸­å¤„ç†æˆåŠŸçš„T-1æ—¥æµæ°´è®°å½•å’ŒBç³»ç»Ÿä¸­çš„æµæ°´è¡¨æ‰€æœ‰T-1æ—¥çš„è®°å½•è¿›è¡Œå¯¹è´¦ ä¸Šé¢çš„æ­¥éª¤çœ‹èµ·æ¥æ¯”è¾ƒå¤šï¼Œè€Œä¸”è¿˜éœ€è¦ç¼–å†™å¯¹è´¦å’Œé‡è¯•æ¨¡å—ã€‚å…¶å®ï¼Œåœ¨ä¸Šä¸‹æ¸¸ç³»ç»Ÿã€æ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶éƒ½æ­£å¸¸è¿ä½œçš„æƒ…å†µä¸‹ï¼Œä¸Šé¢çš„è¿™å¥—äº¤äº’æ–¹æ¡ˆå¯æ‰¿å—çš„å¹¶å‘é‡è¿œæ¯”åŒæ­¥æ–¹æ¡ˆé«˜ï¼Œå‡ºç°äº†æœåŠ¡æˆ–è€…æ¶ˆæ¯é˜Ÿåˆ—ä¸­é—´ä»¶ä¸å¯ç”¨çš„æƒ…å†µä¸‹ï¼Œç”±äºæµæ°´è¡¨æœ‰æœªå¤„ç†çš„æœ¬åœ°è®°å½•ï¼Œåœ¨è¿™äº›é—®é¢˜æ¢å¤ä¹‹åå¯ä»¥é‡è¯•ï¼Œå¯é æ€§ä¹Ÿæ˜¯æ¯”è¾ƒé«˜çš„ã€‚å¦å¤–ï¼Œé‡è¯•å’Œå¯¹è´¦çš„æ¨¡å—ï¼Œå¯¹äºæ‰€æœ‰æ¶‰åŠé‡‘é¢äº¤æ˜“çš„å¤„ç†éƒ½æ˜¯å¿…é¡»çš„ï¼Œè¿™ä¸€ç‚¹å…¶å®é€‰ç”¨åŒæ­¥æˆ–è€…å¼‚æ­¥äº¤äº’æ–¹å¼å¹¶æ²¡æœ‰å…³ç³»(æ—¶åºå›¾åªå±•ç¤ºäº†ä¸€èˆ¬å’Œæ­£å¸¸äº¤äº’æƒ…å†µä¸‹çš„è°ƒç”¨æ—¶åºï¼Œå¼‚å¸¸æƒ…å†µä¾‹å¦‚è¶…é¢è½¬è´¦ã€è°ƒç”¨é“¾ä¸­æŸä¸ªç¯èŠ‚å¤±è´¥ç­‰ç»†èŠ‚ç­‰æš‚ä¸åˆ†æ)ã€‚ å°ç»“ ä½ ä¼šå‘è§‰ï¼Œé€šç¯‡æ–‡ç« æœ‰å¾ˆå¤šæ–¹æ¡ˆéƒ½æ˜¯ä½¿ç”¨äº†å¾…å¤„ç†å†…å®¹å†™å…¥æœ¬åœ°è¡¨ + äº‹åŠ¡å¤–å®æ—¶è§¦å‘ + å®šæ—¶è°ƒåº¦è¡¥å¿è¿™ä¸ªæ¨¡å¼ï¼Œå…¶å®æˆ‘æƒ³è¡¨è¾¾çš„å°±æ˜¯è¿™ä¸ªæ¨¡å¼æ˜¯ç›®å‰åˆ†å¸ƒå¼è§£å†³æ–¹æ¡ˆä¸­ä¸€ä¸ªç›¸å¯¹é€šç”¨çš„æ¨¡å¼ï¼Œå¯ä»¥åŸºæœ¬æ»¡è¶³åˆ†å¸ƒå¼äº‹åŠ¡ã€åŒæ­¥å¼‚æ­¥è¡¥å¿ã€å®æ—¶éå®æ—¶è§¦å‘ç­‰å¤šç§å¤æ‚åœºæ™¯çš„å¤„ç†ã€‚è¿™ä¸ªæ¨¡å¼ä¹Ÿå­˜åœ¨ä¸€äº›æ˜æ˜¾çš„é—®é¢˜(å¦‚æœå®è·µè¿‡çš„è¯ä¸€èˆ¬ä¼šé‡åˆ°)ï¼š 1ã€åº“è¡¨(æœ¬åœ°æ¶ˆæ¯è¡¨)è®¾è®¡ä¸åˆç†æˆ–è€…å¤„ç†ä¸åˆç†å®¹æ˜“æˆä¸ºæ•°æ®åº“çš„ç“¶é¢ˆã€‚ 2ã€è¡¥å¿æˆ–è€…æœ¬åœ°è¡¨å…¥åº“å¤„ç†çš„é€»è¾‘ä»£ç å®¹æ˜“å†—ä½™å’Œè…åŒ–ã€‚ 3ã€æç«¯æƒ…å†µä¸‹ï¼Œå¼‚å¸¸æ¢å¤çš„åœºæ™¯å­˜åœ¨æ‹–å®æœåŠ¡çš„éšæ‚£ã€‚ å…¶å®ï¼Œæ›´å¤šçš„æ—¶å€™éœ€è¦ç»“åˆç°æœ‰çš„ç³»ç»Ÿæˆ–è€…åœºæ™¯è¿›è¡Œåˆ†æã€‚æ¯•ç«Ÿï¼Œæ¶æ„æ˜¯è¿­ä»£å‡ºæ¥ï¼Œè€Œä¸æ˜¯è®¾è®¡å‡ºæ¥çš„ã€‚ (æœ¬æ–‡å®Œ r-a-20190324 c-14-d æœ€è¿‘è¿˜æ˜¯996)","categories":[{"name":"In Action","slug":"In-Action","permalink":"http://throwable.club/blog/categories/In-Action/"},{"name":"Distributed Transaction","slug":"In-Action/Distributed-Transaction","permalink":"http://throwable.club/blog/categories/In-Action/Distributed-Transaction/"}],"tags":[{"name":"In Action","slug":"In-Action","permalink":"http://throwable.club/blog/tags/In-Action/"},{"name":"Distributed Transaction","slug":"Distributed-Transaction","permalink":"http://throwable.club/blog/tags/Distributed-Transaction/"}]},{"title":"zuulæºç åˆ†æ-æ¢ç©¶åŸç”Ÿzuulçš„å·¥ä½œåŸç†","slug":"java-netflix-zuul-implementation","date":"2019-03-14T15:21:08.000Z","updated":"2019-03-14T15:22:08.287Z","comments":true,"path":"2019/03/14/java-netflix-zuul-implementation/","link":"","permalink":"http://throwable.club/2019/03/14/java-netflix-zuul-implementation/","excerpt":"","text":"zuulæºç åˆ†æ-æ¢ç©¶åŸç”Ÿzuulçš„å·¥ä½œåŸç† å‰æ æœ€è¿‘åœ¨é¡¹ç›®ä¸­ä½¿ç”¨äº†SpringCloudï¼ŒåŸºäºZuulæ­å»ºäº†ä¸€ä¸ªæä¾›åŠ è§£å¯†ã€é‰´æƒç­‰åŠŸèƒ½çš„ç½‘å…³æœåŠ¡ã€‚é‰´äºä¹‹å‰æ²¡æ€ä¹ˆä½¿ç”¨è¿‡Zuulï¼Œäºæ˜¯é¡ºä¾¿ä»”ç»†é˜…è¯»äº†å®ƒçš„æºç ã€‚å®é™…ä¸Šï¼ŒZuulåŸæ¥æä¾›çš„åŠŸèƒ½æ˜¯å¾ˆå•ä¸€çš„ï¼šé€šè¿‡ä¸€ä¸ªç»Ÿä¸€çš„Servletå…¥å£(ZuulServletï¼Œæˆ–è€…Filterå…¥å£ï¼Œä½¿ç”¨ZuulServletFilter)æ‹¦æˆªæ‰€æœ‰çš„è¯·æ±‚ï¼Œç„¶åé€šè¿‡å†…å»ºçš„com.netflix.zuul.IZuulFilteré“¾å¯¹è¯·æ±‚åšæ‹¦æˆªå’Œè¿‡æ»¤å¤„ç†ã€‚ZuulFilterå’Œjavax.servlet.Filterçš„åŸç†ç›¸ä¼¼ï¼Œä½†æ˜¯å®ƒä»¬æœ¬è´¨å¹¶ä¸ç›¸åŒã€‚javax.servlet.Filteråœ¨Webåº”ç”¨ä¸­æ˜¯ç‹¬ç«‹çš„ç»„ä»¶ï¼ŒZuulFilteræ˜¯ZuulServletå¤„ç†è¯·æ±‚æ—¶å€™è°ƒç”¨çš„ï¼Œåé¢ä¼šè¯¦ç»†åˆ†æã€‚ æºç ç¯å¢ƒå‡†å¤‡ Zuulçš„é¡¹ç›®åœ°å€æ˜¯https://github.com/Netflix/zuulï¼Œå®ƒæ˜¯è‘—åçš„&quot;å¼€æºæ¡†æ¶æä¾›å•†&quot;Netflixçš„ä½œå“ï¼Œé¡¹ç›®çš„ç›®çš„æ˜¯ï¼šZuulæ˜¯ä¸€ä¸ªç½‘å…³æœåŠ¡ï¼Œæä¾›åŠ¨æ€è·¯ç”±ã€ç›‘è§†ã€å¼¹æ€§ã€å®‰å…¨æ€§ç­‰ã€‚åœ¨SpringCloudä¸­å¼•å…¥äº†zuulï¼Œé…åˆNetflixçš„å¦ä¸€ä¸ªè´Ÿè½½å‡è¡¡æ¡†æ¶Ribbonå’ŒNetflixçš„å¦ä¸€ä¸ªæä¾›æœåŠ¡å‘ç°ä¸æ³¨å†Œæ¡†æ¶Eurekaï¼Œå¯ä»¥å®ç°æœåŠ¡çš„åŠ¨æ€è·¯ç”±ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œzuulåœ¨2.xç”šè‡³3.xçš„åˆ†æ”¯ä¸­å·²ç»å¼•å…¥äº†nettyï¼Œæ¡†æ¶çš„å¤æ‚æ€§å¤§å¤§æé«˜ã€‚ä½†æ˜¯å½“å‰çš„SpringCloudä½“ç³»å¹¶æ²¡æœ‰å‡çº§zuulçš„ç‰ˆæœ¬ï¼Œç›®å‰ä½¿ç”¨çš„æ˜¯zuul1.xçš„æœ€é«˜ç‰ˆæœ¬1.3.1ã€‚ å› æ­¤æˆ‘ä»¬éœ€è¦é˜…è¯»å®ƒçš„æºç çš„æ—¶å€™å¯ä»¥é€‰æ‹©è¿™ä¸ªå‘å¸ƒç‰ˆæœ¬ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œç”±äºè¿™äº›ç‰ˆæœ¬çš„å‘å¸ƒæ—¶é—´å·²ç»æ¯”è¾ƒä¹…ï¼Œæœ‰éƒ¨åˆ†æ’ä»¶æˆ–è€…ä¾èµ–åŒ…å¯èƒ½æ‰¾ä¸åˆ°ï¼Œç¬”è€…åœ¨æ„å»ºzuul1.3.1çš„æºç çš„æ—¶å€™å‘ç°è¿™å‡ ä¸ªé—®é¢˜ï¼š 1ã€nebula.netflixossæ’ä»¶çš„æ—§ç‰ˆæœ¬å·²ç»ä¸å†æ”¯æŒï¼Œæ‰€æœ‰build.gradleæ–‡ä»¶ä¸­çš„nebula.netflixossæ’ä»¶çš„ç‰ˆæœ¬ä¿®æ”¹ä¸º5.2.0ã€‚ 2ã€2017å¹´çš„æ—¶å€™Gradleæ”¯æŒçš„ç‰ˆæœ¬æ˜¯2.xï¼Œç¬”è€…è¿™é‡Œé€‰æ‹©äº†gradle-2.14ï¼Œé€‰æ‹©é«˜ç‰ˆæœ¬çš„Gradleæœ‰å¯èƒ½åœ¨æ„å»ºé¡¹ç›®çš„æ—¶å€™å‡ºç°jettyæ’ä»¶ä¸æ”¯æŒã€‚ 3ã€Jdkæœ€å¥½ä½¿ç”¨1.8ï¼ŒGradleæ„å»ºæ–‡ä»¶ä¸­çš„sourceCompatibilityã€targetCompatibilityã€languageLevelç­‰é…ç½®å…¨æ”¹ä¸º1.8ã€‚ å¦å¤–ï¼Œå¦‚æœä½¿ç”¨IDEAè¿›è¡Œæ„å»ºï¼Œæ³¨æ„é…ç½®é¡¹ç›®çš„Jdkå’ŒJavaç¯å¢ƒï¼Œæ‰€æœ‰é…ç½®æ”¹ä¸ºJdk1.8ï¼ŒGradleæ„å»ºæˆåŠŸåå¦‚ä¸‹ï¼š zuul-1.3.1ä¸­æä¾›äº†ä¸€ä¸ªWebåº”ç”¨çš„Sampleé¡¹ç›®ï¼Œæˆ‘ä»¬ç›´æ¥è¿è¡Œzuul-simple-webappçš„Gradleé…ç½®ä¸­çš„Tomcatæ’ä»¶å³å¯å¯åŠ¨é¡¹ç›®ï¼Œå¼€å§‹Debugä¹‹æ—…ï¼š æºç åˆ†æ ZuulFilterçš„åŠ è½½ ä»Zuulçš„æºç æ¥çœ‹ï¼ŒZuulFilterçš„åŠ è½½æ¨¡å¼å¯èƒ½è·Ÿæˆ‘ä»¬æƒ³è±¡çš„å¤§æœ‰ä¸åŒï¼ŒZuulè®¾è®¡çš„åˆè¡·æ˜¯ZuulFilteræ˜¯å­˜æ”¾åœ¨Groovyæ–‡ä»¶ä¸­ï¼Œå¯ä»¥å®ç°åŸºäºæœ€åä¿®æ”¹æ—¶é—´è¿›è¡Œçƒ­åŠ è½½ã€‚æˆ‘ä»¬å…ˆçœ‹çœ‹Zuulæ ¸å¿ƒç±»ä¹‹ä¸€com.netflix.zuul.filters.FilterRegistry(Filterçš„æ³¨å†Œä¸­å¿ƒï¼Œå®é™…ä¸Šæ˜¯ZuulFilterçš„å…¨å±€ç¼“å­˜)ï¼š 1234567891011121314151617181920212223242526272829303132333435public class FilterRegistry &#123; // é¥¿æ±‰å¼å•ä¾‹ï¼Œç¡®ä¿å…¨å±€åªæœ‰ä¸€ä¸ªZuulFilterçš„ç¼“å­˜ private static final FilterRegistry INSTANCE = new FilterRegistry(); public static final FilterRegistry instance() &#123; return INSTANCE; &#125; //ç¼“å­˜å­—ç¬¦ä¸²åˆ°ZuulFilterå®ä¾‹çš„æ˜ å°„å…³ç³»ï¼Œå¦‚æœæ˜¯ä»æ–‡ä»¶åŠ è½½ï¼Œå­—ç¬¦ä¸²keyçš„æ ¼å¼æ˜¯ï¼šæ–‡ä»¶ç»å¯¹è·¯å¾„ + æ–‡ä»¶åï¼Œå½“ç„¶ä¹Ÿå¯ä»¥è‡ªå®ç° private final ConcurrentHashMap&lt;String, ZuulFilter&gt; filters = new ConcurrentHashMap&lt;String, ZuulFilter&gt;(); private FilterRegistry() &#123; &#125; public ZuulFilter remove(String key) &#123; return this.filters.remove(key); &#125; public ZuulFilter get(String key) &#123; return this.filters.get(key); &#125; public void put(String key, ZuulFilter filter) &#123; this.filters.putIfAbsent(key, filter); &#125; public int size() &#123; return this.filters.size(); &#125; public Collection&lt;ZuulFilter&gt; getAllFilters() &#123; return this.filters.values(); &#125;&#125; å®é™…ä¸ŠZuulä½¿ç”¨äº†ç®€å•ç²—æš´çš„æ–¹å¼(ç›´æ¥ä½¿ç”¨ConcurrentHashMap)ç¼“å­˜äº†ZuulFilterï¼Œè¿™äº›ç¼“å­˜é™¤éä¸»åŠ¨è°ƒç”¨removeæ–¹æ³•ï¼Œå¦åˆ™ä¸ä¼šè‡ªåŠ¨æ¸…ç†ã€‚Zuulæä¾›é»˜è®¤çš„åŠ¨æ€ä»£ç ç¼–è¯‘å™¨ï¼Œæ¥å£æ˜¯DynamicCodeCompilerï¼Œç›®çš„æ˜¯æŠŠä»£ç ç¼–è¯‘ä¸ºJavaçš„ç±»ï¼Œé»˜è®¤å®ç°æ˜¯GroovyCompilerï¼ŒåŠŸèƒ½å°±æ˜¯æŠŠGroovyä»£ç ç¼–è¯‘ä¸ºJavaç±»ã€‚è¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„å·¥å‚ç±»æ¥å£æ˜¯FilterFactoryï¼Œå®ƒå®šä¹‰äº†ZuulFilterç±»ç”ŸæˆZuulFilterå®ä¾‹çš„é€»è¾‘ï¼Œé»˜è®¤å®ç°æ˜¯DefaultFilterFactoryï¼Œå®é™…ä¸Šå°±æ˜¯åˆ©ç”¨Class#newInstance()åå°„ç”ŸæˆZuulFilterå®ä¾‹ã€‚æ¥ç€ï¼Œæˆ‘ä»¬å¯ä»¥è¿›è¡Œåˆ†æFilterLoaderçš„æºç ï¼Œè¿™ä¸ªç±»çš„ä½œç”¨å°±æ˜¯åŠ è½½æ–‡ä»¶ä¸­çš„ZuulFilterå®ä¾‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114public class FilterLoader &#123; //é™æ€finalå®ä¾‹ï¼Œæ³¨æ„åˆ°è®¿é—®æƒé™æ˜¯åŒ…è®¸å¯ï¼Œå®é™…ä¸Šå°±æ˜¯é¥¿æ±‰å¼å•ä¾‹ final static FilterLoader INSTANCE = new FilterLoader(); private static final Logger LOG = LoggerFactory.getLogger(FilterLoader.class); //ç¼“å­˜Filteråç§°(ä¸»è¦æ˜¯ä»æ–‡ä»¶åŠ è½½ï¼Œåç§°ä¸ºç»å¯¹è·¯å¾„ + æ–‡ä»¶åçš„å½¢å¼)-&gt;Filteræœ€åä¿®æ”¹æ—¶é—´æˆ³çš„æ˜ å°„ private final ConcurrentHashMap&lt;String, Long&gt; filterClassLastModified = new ConcurrentHashMap&lt;String, Long&gt;(); //ç¼“å­˜Filteråå­—-&gt;Filterä»£ç çš„æ˜ å°„ï¼Œå®é™…ä¸Šè¿™ä¸ªMapåªä½¿ç”¨åˆ°getæ–¹æ³•è¿›è¡Œå­˜åœ¨æ€§åˆ¤æ–­ï¼Œä¸€ç›´æ˜¯ä¸€ä¸ªç©ºçš„ç»“æ„ private final ConcurrentHashMap&lt;String, String&gt; filterClassCode = new ConcurrentHashMap&lt;String, String&gt;(); //ç¼“å­˜Filteråå­—-&gt;Filteråå­—çš„æ˜ å°„ï¼Œç”¨äºå­˜åœ¨æ€§åˆ¤æ–­ private final ConcurrentHashMap&lt;String, String&gt; filterCheck = new ConcurrentHashMap&lt;String, String&gt;(); //ç¼“å­˜Filterç±»å‹åç§°-&gt;List&lt;ZuulFilter&gt;çš„æ˜ å°„ private final ConcurrentHashMap&lt;String, List&lt;ZuulFilter&gt;&gt; hashFiltersByType = new ConcurrentHashMap&lt;String, List&lt;ZuulFilter&gt;&gt;(); //å‰é¢æåˆ°çš„ZuulFilterå…¨å±€ç¼“å­˜çš„å•ä¾‹ private FilterRegistry filterRegistry = FilterRegistry.instance(); //åŠ¨æ€ä»£ç ç¼–è¯‘å™¨å®ä¾‹ï¼ŒZuulæä¾›çš„é»˜è®¤å®ç°æ˜¯GroovyCompiler static DynamicCodeCompiler COMPILER; //ZuulFilterçš„å·¥å‚ç±» static FilterFactory FILTER_FACTORY = new DefaultFilterFactory(); //ä¸‹é¢ä¸‰ä¸ªæ–¹æ³•è¯´æ˜DynamicCodeCompilerã€FilterRegistryã€FilterFactoryå¯ä»¥è¢«è¦†ç›– public void setCompiler(DynamicCodeCompiler compiler) &#123; COMPILER = compiler; &#125; public void setFilterRegistry(FilterRegistry r) &#123; this.filterRegistry = r; &#125; public void setFilterFactory(FilterFactory factory) &#123; FILTER_FACTORY = factory; &#125; //é¥¿æ±‰å¼å•ä¾‹è·å–è‡ªèº«å®ä¾‹ public static FilterLoader getInstance() &#123; return INSTANCE; &#125; //è¿”å›æ‰€æœ‰ç¼“å­˜çš„ZuulFilterå®ä¾‹çš„æ€»æ•°é‡ public int filterInstanceMapSize() &#123; return filterRegistry.size(); &#125; //é€šè¿‡ZuulFilterçš„ç±»ä»£ç å’ŒFilteråç§°è·å–ZuulFilterå®ä¾‹ public ZuulFilter getFilter(String sCode, String sName) throws Exception &#123; //æ£€æŸ¥filterCheckæ˜¯å¦å­˜åœ¨ç›¸åŒåå­—çš„Filterï¼Œå¦‚æœå­˜åœ¨è¯´æ˜å·²ç»åŠ è½½è¿‡ if (filterCheck.get(sName) == null) &#123; //filterCheckä¸­æ”¾å…¥Filteråç§° filterCheck.putIfAbsent(sName, sName); //filterClassCodeä¸­ä¸å­˜åœ¨åŠ è½½è¿‡çš„Filteråç§°å¯¹åº”çš„ä»£ç  if (!sCode.equals(filterClassCode.get(sName))) &#123; LOG.info(\"reloading code \" + sName); //ä»å…¨å±€ç¼“å­˜ä¸­ç§»é™¤å¯¹åº”çš„Filter filterRegistry.remove(sName); &#125; &#125; ZuulFilter filter = filterRegistry.get(sName); //å¦‚æœå…¨å±€ç¼“å­˜ä¸­ä¸å­˜åœ¨å¯¹åº”çš„Filterï¼Œå°±ä½¿ç”¨DynamicCodeCompileråŠ è½½ä»£ç ï¼Œä½¿ç”¨FilterFactoryå®ä¾‹åŒ–ZuulFilter //æ³¨æ„åŠ è½½çš„ZuulFilterç±»ä¸èƒ½æ˜¯æŠ½è±¡çš„ï¼Œå¿…é¡»æ˜¯ç»§æ‰¿äº†ZuulFilterçš„å­ç±» if (filter == null) &#123; Class clazz = COMPILER.compile(sCode, sName); if (!Modifier.isAbstract(clazz.getModifiers())) &#123; filter = (ZuulFilter) FILTER_FACTORY.newInstance(clazz); &#125; &#125; return filter; &#125; //é€šè¿‡æ–‡ä»¶åŠ åŠ è½½ZuulFilter public boolean putFilter(File file) throws Exception &#123; //Filteråç§°ä¸ºæ–‡ä»¶çš„ç»å¯¹è·¯å¾„+æ–‡ä»¶å(è¿™é‡Œå…¶å®ç»å¯¹è·¯å¾„å·²ç»åŒ…å«æ–‡ä»¶åï¼Œè¿™é‡Œå†åŠ æ–‡ä»¶åçš„ç›®çš„ä¸æ˜ç¡®) String sName = file.getAbsolutePath() + file.getName(); //å¦‚æœæ–‡ä»¶è¢«ä¿®æ”¹è¿‡åˆ™ä»å…¨å±€ç¼“å­˜ä»ç§»é™¤å¯¹åº”çš„Filterä»¥ä¾¿é‡æ–°åŠ è½½ if (filterClassLastModified.get(sName) != null &amp;&amp; (file.lastModified() != filterClassLastModified.get(sName))) &#123; LOG.debug(\"reloading filter \" + sName); filterRegistry.remove(sName); &#125; //ä¸‹é¢çš„é€»è¾‘å’Œä¸Šä¸€ä¸ªæ–¹æ³•ç±»ä¼¼ ZuulFilter filter = filterRegistry.get(sName); if (filter == null) &#123; Class clazz = COMPILER.compile(file); if (!Modifier.isAbstract(clazz.getModifiers())) &#123; filter = (ZuulFilter) FILTER_FACTORY.newInstance(clazz); List&lt;ZuulFilter&gt; list = hashFiltersByType.get(filter.filterType()); //è¿™é‡Œè¯´æ˜äº†ä¸€æ—¦æ–‡ä»¶æœ‰ä¿®æ”¹ï¼ŒhashFiltersByTypeä¸­å¯¹åº”çš„å½“å‰æ–‡ä»¶åŠ è½½å‡ºæ¥çš„Filterç±»å‹çš„ç¼“å­˜è¦ç§»é™¤ï¼ŒåŸå› è§ä¸‹ä¸€ä¸ªæ–¹æ³• if (list != null) &#123; hashFiltersByType.remove(filter.filterType()); //rebuild this list &#125; filterRegistry.put(file.getAbsolutePath() + file.getName(), filter); filterClassLastModified.put(sName, file.lastModified()); return true; &#125; &#125; return false; &#125; //é€šè¿‡Filterç±»å‹è·å–åŒç±»å‹çš„æ‰€æœ‰ZuulFilter public List&lt;ZuulFilter&gt; getFiltersByType(String filterType) &#123; List&lt;ZuulFilter&gt; list = hashFiltersByType.get(filterType); if (list != null) return list; list = new ArrayList&lt;ZuulFilter&gt;(); //å¦‚æœhashFiltersByTypeç¼“å­˜è¢«ç§»é™¤ï¼Œè¿™é‡Œä»å…¨å±€ç¼“å­˜ä¸­åŠ è½½æ‰€æœ‰çš„ZuulFilterï¼ŒæŒ‰ç…§æŒ‡å®šç±»å‹æ„å»ºä¸€ä¸ªæ–°çš„åˆ—è¡¨ Collection&lt;ZuulFilter&gt; filters = filterRegistry.getAllFilters(); for (Iterator&lt;ZuulFilter&gt; iterator = filters.iterator(); iterator.hasNext(); ) &#123; ZuulFilter filter = iterator.next(); if (filter.filterType().equals(filterType)) &#123; list.add(filter); &#125; &#125; //æ³¨æ„è¿™é‡Œä¼šè¿›è¡Œæ’åºï¼Œæ˜¯åŸºäºfilterOrder Collections.sort(list); // sort by priority //è¿™é‡Œæ€»æ˜¯putIfAbsentï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¸Šä¸ªæ–¹æ³•å¯ä»¥æ”¾å¿ƒåœ°åœ¨ä¿®æ”¹çš„æƒ…å†µä¸‹ç§»é™¤æŒ‡å®šFilterç±»å‹ä¸­çš„å…¨éƒ¨ç¼“å­˜å®ä¾‹çš„åŸå›  hashFiltersByType.putIfAbsent(filterType, list); return list; &#125;&#125; ä¸Šé¢çš„å‡ ä¸ªæ–¹æ³•å’Œç¼“å­˜å®¹å™¨éƒ½æ¯”è¾ƒç®€å•ï¼Œè¿™é‡Œå®é™…ä¸Šæœ‰åŠ è½½å’Œå­˜æ”¾åŠ¨ä½œçš„æ–¹æ³•åªæœ‰putFilterï¼Œè¿™ä¸ªæ–¹æ³•æ­£æ˜¯Filteræ–‡ä»¶ç®¡ç†å™¨FilterFileManagerä¾èµ–çš„ï¼Œæ¥ç€çœ‹FilterFileManagerçš„æºç ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100public class FilterFileManager &#123; private static final Logger LOG = LoggerFactory.getLogger(FilterFileManager.class); String[] aDirectories; int pollingIntervalSeconds; Thread poller; boolean bRunning = true; //æ–‡ä»¶åè¿‡æ»¤å™¨ï¼ŒZuulä¸­çš„é»˜è®¤å®ç°æ˜¯GroovyFileFilterï¼Œåªæ¥å—.groovyåç¼€çš„æ–‡ä»¶ static FilenameFilter FILENAME_FILTER; static FilterFileManager INSTANCE; private FilterFileManager() &#123; &#125; public static void setFilenameFilter(FilenameFilter filter) &#123; FILENAME_FILTER = filter; &#125; //initæ–¹æ³•æ˜¯æ ¸å¿ƒé™æ€æ–¹æ³•ï¼Œå®ƒå…·å¤‡äº†é…ç½®ï¼Œé¢„å¤„ç†å’Œæ¿€æ´»åå°è½®è¯¢çº¿ç¨‹çš„åŠŸèƒ½ public static void init(int pollingIntervalSeconds, String... directories) throws Exception, IllegalAccessException, InstantiationException&#123; if (INSTANCE == null) INSTANCE = new FilterFileManager(); INSTANCE.aDirectories = directories; INSTANCE.pollingIntervalSeconds = pollingIntervalSeconds; INSTANCE.manageFiles(); INSTANCE.startPoller(); &#125; public static FilterFileManager getInstance() &#123; return INSTANCE; &#125; public static void shutdown() &#123; INSTANCE.stopPoller(); &#125; void stopPoller() &#123; bRunning = false; &#125; //å¯åŠ¨åå°è½®è¯¢å®ˆæŠ¤çº¿ç¨‹ï¼Œæ¯ä¼‘çœ pollingIntervalSecondsç§’åˆ™è¿›è¡Œä¸€æ¬¡æ–‡ä»¶æ‰«æå°è¯•æ›´æ–°Filter void startPoller() &#123; poller = new Thread(\"GroovyFilterFileManagerPoller\") &#123; public void run() &#123; while (bRunning) &#123; try &#123; sleep(pollingIntervalSeconds * 1000); //é¢„å¤„ç†æ–‡ä»¶ï¼Œå®é™…ä¸Šæ˜¯ZuulFilterçš„é¢„åŠ è½½ manageFiles(); &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; &#125; &#125; &#125;; //è®¾ç½®ä¸ºå®ˆæŠ¤çº¿ç¨‹ poller.setDaemon(true); poller.start(); &#125; //æ ¹æ®æŒ‡å®šç›®å½•è·¯å¾„è·å–ç›®å½•ï¼Œä¸»è¦éœ€è¦è½¬æ¢ä¸ºClassPath public File getDirectory(String sPath) &#123; File directory = new File(sPath); if (!directory.isDirectory()) &#123; URL resource = FilterFileManager.class.getClassLoader().getResource(sPath); try &#123; directory = new File(resource.toURI()); &#125; catch (Exception e) &#123; LOG.error(\"Error accessing directory in classloader. path=\" + sPath, e); &#125; if (!directory.isDirectory()) &#123; throw new RuntimeException(directory.getAbsolutePath() + \" is not a valid directory\"); &#125; &#125; return directory; &#125; //éå†é…ç½®ç›®å½•ï¼Œè·å–æ‰€æœ‰é…ç½®ç›®å½•ä¸‹çš„æ‰€æœ‰æ»¡è¶³FilenameFilterè¿‡æ»¤æ¡ä»¶çš„æ–‡ä»¶ List&lt;File&gt; getFiles() &#123; List&lt;File&gt; list = new ArrayList&lt;File&gt;(); for (String sDirectory : aDirectories) &#123; if (sDirectory != null) &#123; File directory = getDirectory(sDirectory); File[] aFiles = directory.listFiles(FILENAME_FILTER); if (aFiles != null) &#123; list.addAll(Arrays.asList(aFiles)); &#125; &#125; &#125; return list; &#125; //éå†æŒ‡å®šæ–‡ä»¶åˆ—è¡¨ï¼Œè°ƒç”¨FilterLoaderå•ä¾‹ä¸­çš„putFilter void processGroovyFiles(List&lt;File&gt; aFiles) throws Exception, InstantiationException, IllegalAccessException &#123; for (File file : aFiles) &#123; FilterLoader.getInstance().putFilter(file); &#125; &#125; //è·å–æŒ‡å®šç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶ï¼Œè°ƒç”¨processGroovyFilesï¼Œä¸ªäººè®¤ä¸ºè¿™ä¸¤ä¸ªæ–¹æ³•æ²¡å¿…è¦åšå•ç‹¬å°è£… void manageFiles() throws Exception, IllegalAccessException, InstantiationException &#123; List&lt;File&gt; aFiles = getFiles(); processGroovyFiles(aFiles); &#125; åˆ†æå®ŒFilterFileManageræºç ä¹‹åï¼ŒZuulä¸­åŸºäºæ–‡ä»¶åŠ è½½ZuulFilterçš„é€»è¾‘å·²ç»ååˆ†æ¸…æ™°ï¼šåå°å¯åŠ¨ä¸€ä¸ªå®ˆæŠ¤çº¿ç¨‹ï¼Œå®šæ—¶è½®è¯¢æŒ‡å®šæ–‡ä»¶å¤¹é‡Œé¢çš„æ–‡ä»¶ï¼Œå¦‚æœæ–‡ä»¶å­˜åœ¨å˜æ›´ï¼Œåˆ™å°è¯•æ›´æ–°æŒ‡å®šçš„ZuulFilterç¼“å­˜ï¼ŒFilterFileManagerçš„initæ–¹æ³•è°ƒç”¨çš„æ—¶å€™åœ¨å¯åŠ¨åå°çº¿ç¨‹ä¹‹å‰ä¼šè¿›è¡Œä¸€æ¬¡é¢„åŠ è½½ã€‚ RequestContext åœ¨åˆ†æZuulFilterçš„ä½¿ç”¨ä¹‹å‰ï¼Œæœ‰å¿…è¦å…ˆäº†è§£Zuulä¸­çš„è¯·æ±‚ä¸Šä¸‹æ–‡å¯¹è±¡RequestContextã€‚é¦–å…ˆè¦æœ‰ä¸€ä¸ªå…±è¯†ï¼šæ¯ä¸€ä¸ªæ–°çš„è¯·æ±‚éƒ½æ˜¯ç”±ä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹å¤„ç†(è¿™ä¸ªçº¿ç¨‹æ˜¯Tomcaté‡Œé¢èµ·çš„çº¿ç¨‹)ï¼Œæ¢è¨€ä¹‹ï¼Œè¯·æ±‚çš„æ‰€æœ‰å‚æ•°(HttpæŠ¥æ–‡ä¿¡æ¯è§£æå‡ºæ¥çš„å†…å®¹ï¼Œå¦‚è¯·æ±‚å¤´ã€è¯·æ±‚ä½“ç­‰ç­‰)æ€»æ˜¯ç»‘å®šåœ¨å¤„ç†è¯·æ±‚çš„çº¿ç¨‹ä¸­ã€‚RequestContextçš„è®¾è®¡å°±æ˜¯ç®€å•ç›´æ¥æœ‰æ•ˆï¼Œå®ƒç»§æ‰¿äºConcurrentHashMap&lt;String, Object&gt;ï¼Œæ‰€ä»¥å‚æ•°å¯ä»¥ç›´æ¥è®¾ç½®åœ¨RequestContextä¸­ï¼ŒZuulæ²¡æœ‰è®¾è®¡ä¸€ä¸ªç±»ä¼¼äºæšä¸¾çš„ç±»æ§åˆ¶RequestContextçš„å¯é€‰å‚æ•°ï¼Œå› æ­¤é‡Œé¢çš„è®¾ç½®å€¼å’Œæå–å€¼çš„æ–¹æ³•éƒ½æ˜¯ç¡¬ç¼–ç çš„ï¼Œä¾‹å¦‚ï¼š 12345678910111213141516public HttpServletRequest getRequest() &#123; return (HttpServletRequest) get(\"request\");&#125;public void setRequest(HttpServletRequest request) &#123; put(\"request\", request);&#125;public HttpServletResponse getResponse() &#123; return (HttpServletResponse) get(\"response\");&#125;public void setResponse(HttpServletResponse response) &#123; set(\"response\", response);&#125;... çœ‹èµ·æ¥å¾ˆæš´åŠ›å¹¶ä¸”ä¸æ€ä¹ˆä¼˜é›…ï¼Œä½†æ˜¯å®é™…ä¸Šæ˜¯é«˜æ•ˆçš„ã€‚RequestContextä¸€èˆ¬ä½¿ç”¨é™æ€æ–¹æ³•RequestContext#getCurrentContext()è¿›è¡Œåˆå§‹åŒ–ï¼Œæˆ‘ä»¬åˆ†æä¸€ä¸‹å®ƒçš„åˆå§‹åŒ–æµç¨‹ï¼š 1234567891011121314151617181920212223242526272829//ä¿å­˜RequestContextè‡ªèº«ç±»å‹protected static Class&lt;? extends RequestContext&gt; contextClass = RequestContext.class;//é™æ€å¯¹è±¡private static RequestContext testContext = null;//é™æ€finalä¿®é¥°çš„ThreadLocalå®ä¾‹ï¼Œç”¨äºå­˜æ”¾æ‰€æœ‰çš„RequestContextï¼Œæ¯ä¸ªRequestContextéƒ½ä¼šç»‘å®šåœ¨è‡ªèº«è¯·æ±‚çš„å¤„ç†çº¿ç¨‹ä¸­//æ³¨æ„è¿™é‡Œçš„ThreadLocalå®ä¾‹çš„initialValue()æ–¹æ³•ï¼Œå½“ThreadLocalçš„get()æ–¹æ³•è¿”å›nullçš„æ—¶å€™æ€»æ˜¯ä¼šè°ƒç”¨initialValue()æ–¹æ³•protected static final ThreadLocal&lt;? extends RequestContext&gt; threadLocal = new ThreadLocal&lt;RequestContext&gt;() &#123; @Override protected RequestContext initialValue() &#123; try &#123; return contextClass.newInstance(); &#125; catch (Throwable e) &#123; throw new RuntimeException(e); &#125; &#125;&#125;;public RequestContext() &#123; super();&#125;public static RequestContext getCurrentContext() &#123; //è¿™é‡Œæ··æ‚äº†æµ‹è¯•çš„ä»£ç ï¼Œæš‚æ—¶å¿½ç•¥ if (testContext != null) return testContext; //å½“ThreadLocalçš„get()æ–¹æ³•è¿”å›nullçš„æ—¶å€™æ€»æ˜¯ä¼šè°ƒç”¨initialValue()æ–¹æ³•ï¼Œæ‰€ä»¥è¿™é‡Œæ˜¯\"æ— åˆ™æ–°å»ºRequestContext\"çš„é€»è¾‘ RequestContext context = threadLocal.get(); return context;&#125; æ³¨æ„ä¸Šé¢çš„ThreadLocalè¦†ç›–äº†åˆå§‹åŒ–æ–¹æ³•initialValue()ï¼ŒThreadLocalçš„åˆå§‹åŒ–æ–¹æ³•æ€»æ˜¯åœ¨ThreadLocal#get()æ–¹æ³•è¿”å›nullçš„æ—¶å€™è°ƒç”¨ï¼Œå®é™…ä¸Šé™æ€æ–¹æ³•RequestContext#getCurrentContext()çš„ä½œç”¨å°±æ˜¯ï¼šå¦‚æœThreadLocalä¸­å·²ç»ç»‘å®šäº†RequestContexté™æ€å®ä¾‹å°±ç›´æ¥è·å–ç»‘å®šåœ¨çº¿ç¨‹ä¸­çš„RequestContextå®ä¾‹ï¼Œå¦åˆ™æ–°å»ºä¸€ä¸ªRequestContextå®ä¾‹å­˜æ”¾åœ¨ThreadLocal(ç»‘å®šåˆ°å½“å‰çš„è¯·æ±‚çº¿ç¨‹ä¸­)ã€‚äº†è§£è¿™ä¸€ç‚¹åé¢åˆ†æZuulServletFilterå’ŒZuulServletçš„æ—¶å€™å°±å¾ˆç®€å•äº†ã€‚ ZuulFilter æŠ½è±¡ç±»com.netflix.zuul.ZuulFilteræ˜¯Zuulé‡Œé¢çš„æ ¸å¿ƒç»„ä»¶ï¼Œå®ƒæ˜¯ç”¨æˆ·æ‰©å±•Zuulè¡Œä¸ºçš„ç»„ä»¶ï¼Œç”¨æˆ·å¯ä»¥å®ç°ä¸åŒç±»å‹çš„ZuulFilterã€å®šä¹‰å®ƒä»¬çš„æ‰§è¡Œé¡ºåºã€å®ç°å®ƒä»¬çš„æ‰§è¡Œæ–¹æ³•è¾¾åˆ°å®šåˆ¶åŒ–çš„ç›®çš„ï¼ŒSpringCloudçš„netflix-zuulå°±æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„å®ç°åŒ…ã€‚ZuulFilterå®ç°äº†IZuulFilteræ¥å£ï¼Œæˆ‘ä»¬å…ˆçœ‹è¿™ä¸ªæ¥å£çš„å®šä¹‰ï¼š 123456public interface IZuulFilter &#123; boolean shouldFilter(); Object run() throws ZuulException;&#125; å¾ˆç®€å•ï¼ŒshouldFilter()æ–¹æ³•å†³å®šæ˜¯å¦éœ€è¦æ‰§è¡Œ(ä¹Ÿå°±æ˜¯æ‰§è¡Œæ—¶æœºç”±ä½¿ç”¨è€…æ‰©å±•ï¼Œç”šè‡³å¯ä»¥ç¦ç”¨)ï¼Œè€Œrun()æ–¹æ³•å†³å®šæ‰§è¡Œçš„é€»è¾‘ã€‚æ¥ç€çœ‹ZuulFilterçš„æºç ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556public abstract class ZuulFilter implements IZuulFilter, Comparable&lt;ZuulFilter&gt; &#123; //netflixçš„é…ç½®ç»„ä»¶ï¼Œå®é™…ä¸Šå°±æ˜¯åŸºäºé…ç½®æ–‡ä»¶æå–çš„æŒ‡å®škeyçš„å€¼ private final AtomicReference&lt;DynamicBooleanProperty&gt; filterDisabledRef = new AtomicReference&lt;&gt;(); //å®šä¹‰Filterçš„ç±»å‹ abstract public String filterType(); //å®šä¹‰å½“å‰Filterå®ä¾‹æ‰§è¡Œçš„é¡ºåº abstract public int filterOrder(); //æ˜¯å¦é™æ€çš„Filterï¼Œé™æ€çš„Filteræ˜¯æ— çŠ¶æ€çš„ public boolean isStaticFilter() &#123; return true; &#125; //ç¦ç”¨å½“å‰Filterçš„é…ç½®å±æ€§çš„Keyåç§° //Key=zuul.$&#123;å…¨ç±»å&#125;.$&#123;filterType&#125;.disable public String disablePropertyName() &#123; return \"zuul.\" + this.getClass().getSimpleName() + \".\" + filterType() + \".disable\"; &#125; //åˆ¤æ–­å½“å‰çš„Filteræ˜¯å¦ç¦ç”¨ï¼Œé€šè¿‡disablePropertyNameæ–¹æ³•ä»é…ç½®ä¸­è¯»å–ï¼Œé»˜è®¤æ˜¯ä¸ç¦ç”¨ï¼Œä¹Ÿå°±æ˜¯å¯ç”¨ public boolean isFilterDisabled() &#123; filterDisabledRef.compareAndSet(null, DynamicPropertyFactory.getInstance().getBooleanProperty(disablePropertyName(), false)); return filterDisabledRef.get().get(); &#125; //è¿™ä¸ªæ˜¯æ ¸å¿ƒæ–¹æ³•ï¼Œæ‰§è¡ŒFilterï¼Œå¦‚æœFilterä¸æ˜¯ç¦ç”¨ã€å¹¶ä¸”æ»¡è¶³æ‰§è¡Œæ—¶æœºåˆ™è°ƒç”¨runæ–¹æ³•ï¼Œè¿”å›æ‰§è¡Œç»“æœï¼Œè®°å½•æ‰§è¡Œè½¨è¿¹ public ZuulFilterResult runFilter() &#123; ZuulFilterResult zr = new ZuulFilterResult(); if (!isFilterDisabled()) &#123; if (shouldFilter()) &#123; Tracer t = TracerFactory.instance().startMicroTracer(\"ZUUL::\" + this.getClass().getSimpleName()); try &#123; Object res = run(); zr = new ZuulFilterResult(res, ExecutionStatus.SUCCESS); &#125; catch (Throwable e) &#123; t.setName(\"ZUUL::\" + this.getClass().getSimpleName() + \" failed\"); zr = new ZuulFilterResult(ExecutionStatus.FAILED); //æ³¨æ„è¿™é‡Œåªä¿å­˜å¼‚å¸¸çš„å®ä¾‹ï¼Œå³ä½¿æ‰§è¡ŒæŠ›å‡ºå¼‚å¸¸ zr.setException(e); &#125; finally &#123; t.stopAndLog(); &#125; &#125; else &#123; zr = new ZuulFilterResult(ExecutionStatus.SKIPPED); &#125; &#125; return zr; &#125; //å®ç°Comparableï¼ŒåŸºäºfilterOrderå‡åºæ’åºï¼Œä¹Ÿå°±æ˜¯filterOrderè¶Šå¤§ï¼Œæ‰§è¡Œä¼˜å…ˆåº¦è¶Šä½ public int compareTo(ZuulFilter filter) &#123; return Integer.compare(this.filterOrder(), filter.filterOrder()); &#125;&#125; è¿™é‡Œæ³¨æ„å‡ ä¸ªåœ°æ–¹ï¼Œç¬¬ä¸€ä¸ªæ˜¯filterOrder()æ–¹æ³•å’ŒcompareTo(ZuulFilter filter)æ–¹æ³•ï¼Œå­ç±»å®ç°ZuulFilteræ—¶å€™ï¼ŒfilterOrder()æ–¹æ³•è¿”å›å€¼è¶Šå¤§ï¼Œæˆ–è€…è¯´Filterçš„é¡ºåºç³»æ•°è¶Šå¤§ï¼ŒZuulFilteræ‰§è¡Œçš„ä¼˜å…ˆåº¦è¶Šä½ã€‚ç¬¬äºŒä¸ªåœ°æ–¹æ˜¯å¯ä»¥é€šè¿‡zuul.${å…¨ç±»å}.${filterType}.disable=falseé€šè¿‡ç±»åå’ŒFilterç±»å‹ç¦ç”¨å¯¹åº”çš„Filterã€‚ç¬¬ä¸‰ä¸ªå€¼å¾—æ³¨æ„çš„åœ°æ–¹æ˜¯Zuulä¸­å®šä¹‰äº†å››ç§ç±»å‹çš„ZuulFilterï¼Œåé¢åˆ†æZuulRunnerçš„æ—¶å€™å†è¯¦ç»†å±•å¼€ã€‚ZuulFilterå®é™…ä¸Šå°±æ˜¯ä½¿ç”¨è€…æ‰©å±•çš„æ ¸å¿ƒç»„ä»¶ï¼Œé€šè¿‡å®ç°ZuulFilterçš„æ–¹æ³•å¯ä»¥åœ¨ä¸€ä¸ªè¯·æ±‚å¤„ç†é“¾ä¸­çš„ç‰¹å®šä½ç½®æ‰§è¡Œç‰¹å®šçš„å®šåˆ¶åŒ–é€»è¾‘ã€‚ç¬¬å››ä¸ªå€¼å¾—æ³¨æ„çš„åœ°æ–¹æ˜¯runFilter()æ–¹æ³•æ‰§è¡Œä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå¦‚æœå‡ºç°å¼‚å¸¸ï¼ŒThrowableå®ä¾‹ä¼šä¿å­˜åœ¨ZuulFilterResultå¯¹è±¡ä¸­è¿”å›åˆ°å¤–å±‚æ–¹æ³•ï¼Œå¦‚æœæ­£å¸¸æ‰§è¡Œï¼Œåˆ™ç›´æ¥è¿”å›runFilter()æ–¹æ³•çš„ç»“æœã€‚ FilterProcessor å‰é¢èŠ±å¤§é‡åŠŸå¤«åˆ†æå®ŒZuulFilteråŸºäºGroovyæ–‡ä»¶çš„åŠ è½½æœºåˆ¶(åœ¨SpringCloudä½“ç³»ä¸­å¹¶æ²¡æœ‰ä½¿ç”¨æ­¤ç­–ç•¥ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬æŒäº†è§£çš„æ€åº¦å³å¯)ä»¥åŠRequestContextçš„è®¾è®¡ï¼Œæ¥ç€æˆ‘ä»¬åˆ†æFilterProcessorå»äº†è§£å¦‚ä½•ä½¿ç”¨åŠ è½½å¥½çš„ç¼“å­˜ä¸­çš„ZuulFilterã€‚æˆ‘ä»¬å…ˆçœ‹FilterProcessorçš„åŸºæœ¬å±æ€§ï¼š 12345678910111213141516171819202122232425public class FilterProcessor &#123; static FilterProcessor INSTANCE = new FilterProcessor(); protected static final Logger logger = LoggerFactory.getLogger(FilterProcessor.class); private FilterUsageNotifier usageNotifier; public FilterProcessor() &#123; usageNotifier = new BasicFilterUsageNotifier(); &#125; public static FilterProcessor getInstance() &#123; return INSTANCE; &#125; public static void setProcessor(FilterProcessor processor) &#123; INSTANCE = processor; &#125; public void setFilterUsageNotifier(FilterUsageNotifier notifier) &#123; this.usageNotifier = notifier; &#125; ...&#125; åƒä¹‹å‰åˆ†æçš„å‡ ä¸ªç±»ä¸€æ ·ï¼ŒFilterProcessorè®¾è®¡ä¸ºå•ä¾‹ï¼Œæä¾›å¯ä»¥è¦†ç›–å•ä¾‹å®ä¾‹çš„æ–¹æ³•ã€‚éœ€è¦æ³¨æ„çš„ä¸€ç‚¹æ˜¯å±æ€§usageNotifieræ˜¯FilterUsageNotifierç±»å‹ï¼ŒFilterUsageNotifieræ¥å£çš„é»˜è®¤å®ç°æ˜¯BasicFilterUsageNotifier(FilterProcessorçš„ä¸€ä¸ªé™æ€å†…éƒ¨ç±»)ï¼ŒBasicFilterUsageNotifierä¾èµ–äºNetflixçš„ä¸€ä¸ªå·¥å…·åŒ…servo-coreï¼Œæä¾›åŸºäºå†…å­˜æ€çš„è®¡æ•°å™¨ç»Ÿè®¡æ¯ç§ZuulFilterçš„æ¯ä¸€æ¬¡è°ƒç”¨çš„çŠ¶æ€ExecutionStatusã€‚æšä¸¾ExecutionStatusçš„å¯é€‰å€¼å¦‚ä¸‹ï¼š 1ã€SUCCESSï¼Œä»£è¡¨è¯¥Filterå¤„ç†æˆåŠŸï¼Œå€¼ä¸º1ã€‚ 2ã€SKIPPEDï¼Œä»£è¡¨è¯¥Filterè·³è¿‡å¤„ç†ï¼Œå€¼ä¸º-1ã€‚ 3ã€DISABLEDï¼Œä»£è¡¨è¯¥Filterç¦ç”¨ï¼Œå€¼ä¸º-2ã€‚ 4ã€SUCCESSï¼Œä»£è¡¨è¯¥FAILEDå¤„ç†å‡ºç°å¼‚å¸¸ï¼Œå€¼ä¸º-3ã€‚ å½“ç„¶ï¼Œä½¿ç”¨è€…ä¹Ÿå¯ä»¥è¦†ç›–usageNotifierå±æ€§ã€‚æ¥ç€æˆ‘ä»¬çœ‹FilterProcessorä¸­çœŸæ­£è°ƒç”¨ZuulFilterå®ä¾‹çš„æ ¸å¿ƒæ–¹æ³•ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182//æŒ‡å®šFilterç±»å‹æ‰§è¡Œè¯¥ç±»å‹ä¸‹çš„æ‰€æœ‰ZuulFilterpublic Object runFilters(String sType) throws Throwable &#123; //å°è¯•æ‰“å°Debugæ—¥å¿— if (RequestContext.getCurrentContext().debugRouting()) &#123; Debug.addRoutingDebug(\"Invoking &#123;\" + sType + \"&#125; type filters\"); &#125; boolean bResult = false; //è·å–æ‰€æœ‰æŒ‡å®šç±»å‹çš„ZuulFilter List&lt;ZuulFilter&gt; list = FilterLoader.getInstance().getFiltersByType(sType); if (list != null) &#123; for (int i = 0; i &lt; list.size(); i++) &#123; ZuulFilter zuulFilter = list.get(i); Object result = processZuulFilter(zuulFilter); //å¦‚æœå¤„ç†ç»“æœæ˜¯Booleanç±»å‹å°è¯•åšæˆ–æ“ä½œï¼Œå…¶ä»–ç±»å‹ç»“æœå¿½ç•¥ if (result != null &amp;&amp; result instanceof Boolean) &#123; bResult |= ((Boolean) result); &#125; &#125; &#125; return bResult;&#125;//æ‰§è¡ŒZuulFilterï¼Œè¿™ä¸ªå°±æ˜¯ZuulFilteræ‰§è¡Œé€»è¾‘public Object processZuulFilter(ZuulFilter filter) throws ZuulException &#123; RequestContext ctx = RequestContext.getCurrentContext(); boolean bDebug = ctx.debugRouting(); final String metricPrefix = \"zuul.filter-\"; long execTime = 0; String filterName = \"\"; try &#123; long ltime = System.currentTimeMillis(); filterName = filter.getClass().getSimpleName(); RequestContext copy = null; Object o = null; Throwable t = null; if (bDebug) &#123; Debug.addRoutingDebug(\"Filter \" + filter.filterType() + \" \" + filter.filterOrder() + \" \" + filterName); copy = ctx.copy(); &#125; //ç®€å•è°ƒç”¨ZuulFilterçš„runFilteræ–¹æ³• ZuulFilterResult result = filter.runFilter(); ExecutionStatus s = result.getStatus(); execTime = System.currentTimeMillis() - ltime; switch (s) &#123; case FAILED: t = result.getException(); //è®°å½•è°ƒç”¨é“¾ä¸­å½“å‰Filterçš„åç§°ï¼Œæ‰§è¡Œç»“æœçŠ¶æ€å’Œæ‰§è¡Œæ—¶é—´ ctx.addFilterExecutionSummary(filterName, ExecutionStatus.FAILED.name(), execTime); break; case SUCCESS: o = result.getResult(); //è®°å½•è°ƒç”¨é“¾ä¸­å½“å‰Filterçš„åç§°ï¼Œæ‰§è¡Œç»“æœçŠ¶æ€å’Œæ‰§è¡Œæ—¶é—´ ctx.addFilterExecutionSummary(filterName, ExecutionStatus.SUCCESS.name(), execTime); if (bDebug) &#123; Debug.addRoutingDebug(\"Filter &#123;\" + filterName + \" TYPE:\" + filter.filterType() + \" ORDER:\" + filter.filterOrder() + \"&#125; Execution time = \" + execTime + \"ms\"); Debug.compareContextState(filterName, copy); &#125; break; default: break; &#125; if (t != null) throw t; //è¿™é‡Œåšè®¡æ•°å™¨çš„ç»Ÿè®¡ usageNotifier.notify(filter, s); return o; &#125; catch (Throwable e) &#123; if (bDebug) &#123; Debug.addRoutingDebug(\"Running Filter failed \" + filterName + \" type:\" + filter.filterType() + \" order:\" + filter.filterOrder() + \" \" + e.getMessage()); &#125; //è¿™é‡Œåšè®¡æ•°å™¨çš„ç»Ÿè®¡ usageNotifier.notify(filter, ExecutionStatus.FAILED); if (e instanceof ZuulException) &#123; throw (ZuulException) e; &#125; else &#123; ZuulException ex = new ZuulException(e, \"Filter threw Exception\", 500, filter.filterType() + \":\" + filterName); //è®°å½•è°ƒç”¨é“¾ä¸­å½“å‰Filterçš„åç§°ï¼Œæ‰§è¡Œç»“æœçŠ¶æ€å’Œæ‰§è¡Œæ—¶é—´ ctx.addFilterExecutionSummary(filterName, ExecutionStatus.FAILED.name(), execTime); throw ex; &#125; &#125;&#125; ä¸Šé¢ä»‹ç»äº†FilterProcessorä¸­çš„processZuulFilter(ZuulFilter filter)æ–¹æ³•ä¸»è¦æä¾›ZuulFilteræ‰§è¡Œçš„ä¸€äº›åº¦é‡ç›¸å…³è®°å½•(ä¾‹å¦‚Filteræ‰§è¡Œè€—æ—¶æ‘˜è¦ï¼Œä¼šå½¢æˆä¸€ä¸ªé“¾ï¼Œè®°å½•åœ¨ä¸€ä¸ªå­—ç¬¦ä¸²ä¸­)å’ŒZuulFilterçš„æ‰§è¡Œæ–¹æ³•ï¼ŒZuulFilteræ‰§è¡Œç»“æœå¯èƒ½æ˜¯æˆåŠŸæˆ–è€…å¼‚å¸¸ï¼Œå‰é¢æåˆ°è¿‡ï¼Œå¦‚æœæŠ›å‡ºå¼‚å¸¸Throwableå®ä¾‹ä¼šä¿å­˜åœ¨ZuulFilterResultä¸­ï¼Œåœ¨processZuulFilter(ZuulFilter filter)å‘ç°ZuulFilterResultä¸­çš„Throwableå®ä¾‹ä¸ä¸ºnullåˆ™ç›´æ¥æŠ›å‡ºï¼Œå¦åˆ™è¿”å›ZuulFilteræ­£å¸¸æ‰§è¡Œçš„ç»“æœã€‚å¦å¤–ï¼ŒFilterProcessorä¸­é€šè¿‡æŒ‡å®šFilterç±»å‹æ‰§è¡Œæ‰€æœ‰å¯¹åº”ç±»å‹çš„ZuulFilterçš„runFilters(String sType)æ–¹æ³•ï¼Œæˆ‘ä»¬çŸ¥é“äº†runFilters(String sType)æ–¹æ³•å¦‚æœå¤„ç†ç»“æœæ˜¯Booleanç±»å‹å°è¯•åšæˆ–æ“ä½œï¼Œå…¶ä»–ç±»å‹ç»“æœå¿½ç•¥ï¼Œå¯ä»¥ç†è§£ä¸ºæ­¤æ–¹æ³•çš„è¿”å›å€¼æ˜¯æ²¡æœ‰å¾ˆå¤§æ„ä¹‰çš„ã€‚å‚è€ƒSpringCloudé‡Œé¢å¯¹ZuulFilterçš„è¿”å›å€¼å¤„ç†ä¸€èˆ¬æ˜¯ç›´æ¥å¡è¿›å»å½“å‰çº¿ç¨‹ç»‘å®šçš„RequestContextä¸­ï¼Œé€‰æ‹©ç‰¹å®šçš„ZuulFilterå­ç±»å¯¹å‰é¢çš„ZuulFilteräº§ç”Ÿçš„ç»“æœè¿›è¡Œå¤„ç†ã€‚FilterProcessoråŸºäºrunFilters(String sType)æ–¹æ³•æä¾›äº†å…¶ä»–æŒ‡å®šfilterTypeçš„æ–¹æ³•ï¼š 12345678910111213141516171819202122232425262728293031323334353637public void postRoute() throws ZuulException &#123; try &#123; runFilters(\"post\"); &#125; catch (ZuulException e) &#123; throw e; &#125; catch (Throwable e) &#123; throw new ZuulException(e, 500, \"UNCAUGHT_EXCEPTION_IN_POST_FILTER_\" + e.getClass().getName()); &#125;&#125;public void preRoute() throws ZuulException &#123; try &#123; runFilters(\"pre\"); &#125; catch (ZuulException e) &#123; throw e; &#125; catch (Throwable e) &#123; throw new ZuulException(e, 500, \"UNCAUGHT_EXCEPTION_IN_PRE_FILTER_\" + e.getClass().getName()); &#125;&#125;public void error() &#123; try &#123; runFilters(\"error\"); &#125; catch (Throwable e) &#123; logger.error(e.getMessage(), e); &#125;&#125;public void route() throws ZuulException &#123; try &#123; runFilters(\"route\"); &#125; catch (ZuulException e) &#123; throw e; &#125; catch (Throwable e) &#123; throw new ZuulException(e, 500, \"UNCAUGHT_EXCEPTION_IN_ROUTE_FILTER_\" + e.getClass().getName()); &#125;&#125; ä¸Šé¢æä¾›çš„æ–¹æ³•å¾ˆç®€å•ï¼Œæ— æ³•æ˜¯æŒ‡å®šå‚æ•°ä¸ºpostã€preã€errorã€routeå¯¹runFilters(String sType)æ–¹æ³•è¿›è¡Œè°ƒç”¨ï¼Œè‡³äºè¿™äº›FilterTypeçš„æ‰§è¡Œä½ç½®è§ä¸‹ä¸€ä¸ªå°èŠ‚çš„åˆ†æã€‚ ZuulServletFilterå’ŒZuulServlet Zuulæœ¬æ¥å°±æ˜¯è®¾è®¡ä¸ºServletè§„èŒƒç»„ä»¶çš„ä¸€ä¸ªç±»åº“ï¼ŒZuulServletå°±æ˜¯javax.servlet.http.HttpServletçš„å®ç°ç±»ï¼Œè€ŒZuulServletFilteræ˜¯javax.servlet.Filterçš„å®ç°ç±»ã€‚è¿™ä¸¤ä¸ªç±»éƒ½ä¾èµ–åˆ°ZuulRunnerå®ŒæˆZuulFilterçš„è°ƒç”¨ï¼Œå®ƒä»¬çš„å®ç°é€»è¾‘æ˜¯å®Œå…¨ä¸€è‡´çš„ï¼Œæˆ‘ä»¬åªéœ€è¦çœ‹å…¶ä¸­ä¸€ä¸ªç±»çš„å®ç°ï¼Œè¿™é‡ŒæŒ‘é€‰ZuulServletï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071public class ZuulServlet extends HttpServlet &#123; private static final long serialVersionUID = -3374242278843351500L; private ZuulRunner zuulRunner; @Override public void init(ServletConfig config) throws ServletException &#123; super.init(config); String bufferReqsStr = config.getInitParameter(\"buffer-requests\"); boolean bufferReqs = bufferReqsStr != null &amp;&amp; bufferReqsStr.equals(\"true\") ? true : false; zuulRunner = new ZuulRunner(bufferReqs); &#125; @Override public void service(javax.servlet.ServletRequest servletRequest, javax.servlet.ServletResponse servletResponse) throws ServletException, IOException &#123; try &#123; //å®é™…ä¸Šå§”æ‰˜åˆ°ZuulRunnerçš„initæ–¹æ³• init((HttpServletRequest) servletRequest, (HttpServletResponse) servletResponse); //åˆå§‹åŒ–RequestContextå®ä¾‹ RequestContext context = RequestContext.getCurrentContext(); //è®¾ç½®RequestContextä¸­zuulEngineRan=true context.setZuulEngineRan(); try &#123; preRoute(); &#125; catch (ZuulException e) &#123; error(e); postRoute(); return; &#125; try &#123; route(); &#125; catch (ZuulException e) &#123; error(e); postRoute(); return; &#125; try &#123; postRoute(); &#125; catch (ZuulException e) &#123; error(e); return; &#125; &#125; catch (Throwable e) &#123; error(new ZuulException(e, 500, \"UNHANDLED_EXCEPTION_\" + e.getClass().getName())); &#125; finally &#123; RequestContext.getCurrentContext().unset(); &#125; &#125; void postRoute() throws ZuulException &#123; zuulRunner.postRoute(); &#125; void route() throws ZuulException &#123; zuulRunner.route(); &#125; void preRoute() throws ZuulException &#123; zuulRunner.preRoute(); &#125; void init(HttpServletRequest servletRequest, HttpServletResponse servletResponse) &#123; zuulRunner.init(servletRequest, servletResponse); &#125; //è¿™é‡Œä¼šå…ˆè®¾ç½®RequestContextå®ä¾‹ä¸­çš„throwableå±æ€§ä¸ºæ‰§è¡ŒæŠ›å‡ºçš„Throwableå®ä¾‹ void error(ZuulException e) &#123; RequestContext.getCurrentContext().setThrowable(e); zuulRunner.error(); &#125;&#125; ZuulServletFilterå’ŒZuulServletä¸ç›¸åŒçš„åœ°æ–¹ä»…ä»…æ˜¯åˆå§‹åŒ–å’Œå¤„ç†æ–¹æ³•çš„æ–¹æ³•ç­¾å(å‚æ•°åˆ—è¡¨å’Œæ–¹æ³•å)ï¼Œå…¶ä»–é€»è¾‘ç”šè‡³æ˜¯ä»£ç æ˜¯ä¸€æ¨¡ä¸€æ ·ï¼Œä½¿ç”¨è¿‡ç¨‹ä¸­æˆ‘ä»¬éœ€è¦äº†è§£javax.servlet.http.HttpServletå’Œjavax.servlet.Filterçš„ä½œç”¨å»é€‰æ‹©åˆ°åº•ä½¿ç”¨ZuulServletFilterè¿˜æ˜¯ZuulServletã€‚ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹åˆ°ï¼ŒZuulServletåˆå§‹åŒ–çš„æ—¶å€™å¯ä»¥é…ç½®åˆå§‹åŒ–å¸ƒå°”å€¼å‚æ•°buffer-requestsï¼Œè¿™ä¸ªå‚æ•°é»˜è®¤ä¸ºfalseï¼Œå®ƒæ˜¯ZuulRunnerå®ä¾‹åŒ–çš„å¿…é¡»å‚æ•°ã€‚ZuulServletä¸­çš„è°ƒç”¨ZuulFilterçš„æ–¹æ³•éƒ½å§”æ‰˜åˆ°ZuulRunnerå®ä¾‹å»å®Œæˆï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥ä»service(servletRequest, servletResponse)æ–¹æ³•çœ‹å‡ºå››ç§FilterType(preã€routeã€postã€error)çš„ZuulFilterçš„æ‰§è¡Œé¡ºåºï¼Œæ€»ç»“å¦‚ä¸‹ï¼š 1ã€preã€routeã€postéƒ½ä¸æŠ›å‡ºå¼‚å¸¸ï¼Œé¡ºåºæ˜¯ï¼špre-&gt;route-&gt;postï¼Œerrorä¸æ‰§è¡Œã€‚ 2ã€preæŠ›å‡ºå¼‚å¸¸ï¼Œé¡ºåºæ˜¯ï¼špre-&gt;error-&gt;postã€‚ 3ã€routeæŠ›å‡ºå¼‚å¸¸ï¼Œé¡ºåºæ˜¯ï¼špre-&gt;route-&gt;error-&gt;postã€‚ 4ã€postæŠ›å‡ºå¼‚å¸¸ï¼Œé¡ºåºæ˜¯ï¼špre-&gt;route-&gt;post-&gt;errorã€‚ æ³¨æ„ï¼Œä¸€æ—¦å‡ºç°äº†å¼‚å¸¸ï¼Œä¼šæŠŠæŠ›å‡ºçš„Throwableå®ä¾‹è®¾ç½®åˆ°ç»‘å®šåˆ°å½“å‰è¯·æ±‚çº¿ç¨‹çš„RequestContextå®ä¾‹ä¸­çš„throwableå±æ€§ã€‚è¿˜éœ€è¦æ³¨æ„åœ¨service(servletRequest, servletResponse)çš„finallyå—ä¸­è°ƒç”¨äº†RequestContext.getCurrentContext().unset();ï¼Œå®é™…ä¸Šæ˜¯ä»RequestContextçš„ThreadLocalå®ä¾‹ä¸­ç§»é™¤å½“å‰çš„RequestContextå®ä¾‹ï¼Œè¿™æ ·åšå¯ä»¥é¿å…ThreadLocalä½¿ç”¨ä¸å½“å¯¼è‡´å†…å­˜æ³„æ¼ã€‚ æ¥ç€çœ‹ZuulRunnerçš„æºç ï¼š 1234567891011121314151617181920212223242526272829303132333435363738public class ZuulRunner &#123; private boolean bufferRequests; public ZuulRunner() &#123; this.bufferRequests = true; &#125; public ZuulRunner(boolean bufferRequests) &#123; this.bufferRequests = bufferRequests; &#125; public void init(HttpServletRequest servletRequest, HttpServletResponse servletResponse) &#123; RequestContext ctx = RequestContext.getCurrentContext(); if (bufferRequests) &#123; ctx.setRequest(new HttpServletRequestWrapper(servletRequest)); &#125; else &#123; ctx.setRequest(servletRequest); &#125; ctx.setResponse(new HttpServletResponseWrapper(servletResponse)); &#125; public void postRoute() throws ZuulException &#123; FilterProcessor.getInstance().postRoute(); &#125; public void route() throws ZuulException &#123; FilterProcessor.getInstance().route(); &#125; public void preRoute() throws ZuulException &#123; FilterProcessor.getInstance().preRoute(); &#125; public void error() &#123; FilterProcessor.getInstance().error(); &#125;&#125; postRoute()ã€route()ã€preRoute()ã€error()éƒ½æ˜¯ç›´æ¥å§”æ‰˜åˆ°FilterProcessorä¸­å®Œæˆçš„ï¼Œå®é™…ä¸Šå°±æ˜¯æ‰§è¡Œå¯¹åº”ç±»å‹çš„æ‰€æœ‰ZuulFilterå®ä¾‹ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåˆå§‹åŒ–ZuulRunneræ—¶å€™ï¼ŒHttpServletResponseä¼šè¢«åŒ…è£…ä¸ºcom.netflix.zuul.http.HttpServletResponseWrapperå®ä¾‹ï¼Œå®ƒæ˜¯Zuulå®ç°çš„javax.servlet.http.HttpServletResponseWrapperçš„å­ç±»ï¼Œä¸»è¦æ˜¯æ·»åŠ äº†ä¸€ä¸ªå±æ€§statusç”¨æ¥è®°å½•HttpçŠ¶æ€ç ã€‚å¦‚æœåˆå§‹åŒ–å‚æ•°bufferRequestsä¸ºtrueï¼ŒHttpServletRequestä¼šè¢«åŒ…è£…ä¸ºcom.netflix.zuul.http.HttpServletRequestWrapperï¼Œå®ƒæ˜¯Zuulå®ç°çš„javax.servlet.http.HttpServletRequestWrapperçš„å­ç±»ï¼Œè¿™ä¸ªåŒ…è£…ç±»ä¸»è¦æ˜¯æŠŠè¯·æ±‚çš„è¡¨å•å‚æ•°å’Œè¯·æ±‚ä½“éƒ½ç¼“å­˜åœ¨å®ä¾‹å±æ€§ä¸­ï¼Œè¿™æ ·åœ¨ä¸€äº›ç‰¹å®šåœºæ™¯ä¸­å¯ä»¥æé«˜æ€§èƒ½ã€‚å¦‚æœæ²¡æœ‰ç‰¹æ®Šéœ€è¦ï¼Œè¿™ä¸ªå‚æ•°bufferRequestsä¸€èˆ¬è®¾ç½®ä¸ºfalseã€‚ Zuulç®€å•çš„ä½¿ç”¨ä¾‹å­ æˆ‘ä»¬åšä¸€ä¸ªå¾ˆç®€å•çš„ä¾‹å­ï¼Œåœºæ™¯æ˜¯ï¼šå¯¹äºæ¯ä¸ªPOSTè¯·æ±‚ï¼Œä½¿ç”¨preç±»å‹çš„ZuulFilteræ‰“å°å®ƒçš„è¯·æ±‚ä½“ï¼Œç„¶åä½¿ç”¨postç±»å‹çš„ZuulFilterï¼Œå“åº”ç»“æœç¡¬ç¼–ç ä¸ºå­—ç¬¦ä¸²&quot;Hello World!&quot;ã€‚æˆ‘ä»¬å…ˆä¸ºCounterFactoryã€`TracerFactoryæ·»åŠ ä¸¤ä¸ªç©ºçš„å­ç±»ï¼Œå› ä¸ºZuulå¤„ç†é€»è¾‘ä¸­ä¾èµ–åˆ°è¿™ä¸¤ä¸ªç»„ä»¶å®ç°æ•°æ®åº¦é‡ï¼š 123456789101112131415public class DefaultTracerFactory extends TracerFactory &#123; @Override public Tracer startMicroTracer(String name) &#123; return null; &#125;&#125;public class DefaultCounterFactory extends CounterFactory &#123; @Override public void increment(String name) &#123; &#125;&#125; æ¥ç€æˆ‘ä»¬åˆ†åˆ«ç»§æ‰¿ZuulFilterï¼Œå®ç°ä¸€ä¸ªpreç±»å‹çš„ç”¨äºæ‰“å°è¯·æ±‚å‚æ•°çš„Filterï¼Œå‘½åä¸ºPrintParameterZuulFilterï¼Œå®ç°ä¸€ä¸ªpostç±»å‹çš„ç”¨äºè¿”å›å­—ç¬¦ä¸²&quot;Hello World!&quot;çš„Filterï¼Œå‘½åä¸ºSendResponseZuulFilterï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879public class PrintParameterZuulFilter extends ZuulFilter &#123; @Override public String filterType() &#123; return \"pre\"; &#125; @Override public int filterOrder() &#123; return 0; &#125; @Override public boolean shouldFilter() &#123; RequestContext context = RequestContext.getCurrentContext(); HttpServletRequest request = context.getRequest(); return \"POST\".equalsIgnoreCase(request.getMethod()); &#125; @Override public Object run() throws ZuulException &#123; RequestContext context = RequestContext.getCurrentContext(); HttpServletRequest request = context.getRequest(); if (null != request.getContentType()) &#123; if (request.getContentType().contains(\"application/json\")) &#123; try &#123; ServletInputStream inputStream = request.getInputStream(); String result = StreamUtils.copyToString(inputStream, Charset.forName(\"UTF-8\")); System.out.println(String.format(\"è¯·æ±‚URIä¸º:%s,è¯·æ±‚å‚æ•°ä¸º:%s\", request.getRequestURI(), result)); &#125; catch (IOException e) &#123; throw new ZuulException(e, 500, \"ä»è¾“å…¥æµä¸­è¯»å–è¯·æ±‚å‚æ•°å¼‚å¸¸\"); &#125; &#125; else if (request.getContentType().contains(\"application/x-www-form-urlencoded\")) &#123; StringBuilder params = new StringBuilder(); Enumeration&lt;String&gt; parameterNames = request.getParameterNames(); while (parameterNames.hasMoreElements()) &#123; String name = parameterNames.nextElement(); params.append(name).append(\"=\").append(request.getParameter(name)).append(\"&amp;\"); &#125; String result = params.toString(); System.out.println(String.format(\"è¯·æ±‚URIä¸º:%s,è¯·æ±‚å‚æ•°ä¸º:%s\", request.getRequestURI(), result.substring(0, result.lastIndexOf(\"&amp;\")))); &#125; &#125; return null; &#125;&#125;public class SendResponseZuulFilter extends ZuulFilter &#123; @Override public String filterType() &#123; return \"post\"; &#125; @Override public int filterOrder() &#123; return 0; &#125; @Override public boolean shouldFilter() &#123; RequestContext context = RequestContext.getCurrentContext(); HttpServletRequest request = context.getRequest(); return \"POST\".equalsIgnoreCase(request.getMethod()); &#125; @Override public Object run() throws ZuulException &#123; RequestContext context = RequestContext.getCurrentContext(); String output = \"Hello World!\"; try &#123; context.getResponse().getWriter().write(output); &#125; catch (IOException e) &#123; throw new ZuulException(e, 500, e.getMessage()); &#125; return true; &#125;&#125; æ¥ç€ï¼Œæˆ‘ä»¬å¼•å…¥åµŒå…¥å¼Tomcatï¼Œç®€å•åœ°åˆ›å»ºä¸€ä¸ªServletå®¹å™¨ï¼ŒMavenä¾èµ–ä¸ºï¼š 12345678910111213141516171819202122232425&lt;dependency&gt; &lt;groupId&gt;org.apache.tomcat.embed&lt;/groupId&gt; &lt;artifactId&gt;tomcat-embed-core&lt;/artifactId&gt; &lt;version&gt;8.5.34&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.apache.tomcat.embed&lt;/groupId&gt; &lt;artifactId&gt;tomcat-embed-jasper&lt;/artifactId&gt; &lt;version&gt;8.5.34&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.apache.tomcat&lt;/groupId&gt; &lt;artifactId&gt;tomcat-jasper&lt;/artifactId&gt; &lt;version&gt;8.5.34&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.apache.tomcat&lt;/groupId&gt; &lt;artifactId&gt;tomcat-jasper-el&lt;/artifactId&gt; &lt;version&gt;8.5.34&lt;/version&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.apache.tomcat&lt;/groupId&gt; &lt;artifactId&gt;tomcat-jsp-api&lt;/artifactId&gt; &lt;version&gt;8.5.34&lt;/version&gt; &lt;/dependency&gt; æ·»åŠ å¸¦mainæ–¹æ³•çš„ç±»æŠŠä¸Šé¢çš„ç»„ä»¶å’ŒTomcatçš„ç»„ä»¶ç»„è£…èµ·æ¥ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142public class ZuulMain &#123; private static final String WEBAPP_DIRECTORY = \"src/main/webapp/\"; private static final String ROOT_CONTEXT = \"\"; public static void main(String[] args) throws Exception &#123; Tomcat tomcat = new Tomcat(); File tempDir = File.createTempFile(\"tomcat\" + \".\", \".8080\"); tempDir.delete(); tempDir.mkdir(); tempDir.deleteOnExit(); //åˆ›å»ºä¸´æ—¶ç›®å½•,è¿™ä¸€æ­¥å¿…é¡»å…ˆè®¾ç½®,å¦‚æœä¸è®¾ç½®é»˜è®¤åœ¨å½“å‰çš„è·¯å¾„åˆ›å»ºä¸€ä¸ª'tomcat.8080æ–‡ä»¶å¤¹' tomcat.setBaseDir(tempDir.getAbsolutePath()); tomcat.setPort(8080); StandardContext ctx = (StandardContext) tomcat.addWebapp(ROOT_CONTEXT, new File(WEBAPP_DIRECTORY).getAbsolutePath()); WebResourceRoot resources = new StandardRoot(ctx); resources.addPreResources(new DirResourceSet(resources, \"/WEB-INF/classes\", new File(\"target/classes\").getAbsolutePath(), \"/\")); ctx.setResources(resources); ctx.setDefaultWebXml(new File(\"src/main/webapp/WEB-INF/web.xml\").getAbsolutePath()); // FixBug: no global web.xml found for (LifecycleListener ll : ctx.findLifecycleListeners()) &#123; if (ll instanceof ContextConfig) &#123; ((ContextConfig) ll).setDefaultWebXml(ctx.getDefaultWebXml()); &#125; &#125; //è¿™é‡Œæ·»åŠ ä¸¤ä¸ªåº¦é‡çˆ¶ç±»çš„ç©ºå®ç° CounterFactory.initialize(new DefaultCounterFactory()); TracerFactory.initialize(new DefaultTracerFactory()); //è¿™é‡Œæ·»åŠ è‡ªå®ç°çš„ZuulFilter FilterRegistry.instance().put(\"printParameterZuulFilter\", new PrintParameterZuulFilter()); FilterRegistry.instance().put(\"sendResponseZuulFilter\", new SendResponseZuulFilter()); //è¿™é‡Œæ·»åŠ ZuulServlet Context context = tomcat.addContext(\"/zuul\", null); Tomcat.addServlet(context, \"zuul\", new ZuulServlet()); //è®¾ç½®Servletçš„è·¯å¾„ context.addServletMappingDecoded(\"/*\", \"zuul\"); tomcat.start(); tomcat.getServer().await(); &#125;&#125; æ‰§è¡Œmainæ–¹æ³•ï¼ŒTomcatæ­£å¸¸å¯åŠ¨åæ‰“å°å‡ºç†Ÿæ‚‰çš„æ—¥å¿—å¦‚ä¸‹ï¼š æ¥ä¸‹æ¥ï¼Œç”¨POSTMANè¯·æ±‚æ¨¡æ‹Ÿä¸€ä¸‹è¯·æ±‚ï¼š å°ç»“ Zuulè™½ç„¶åœ¨å®ƒçš„Githubä»“åº“ä¸­çš„ç®€ä»‹ä¸­è¯´å®ƒæ˜¯ä¸€ä¸ªæä¾›åŠ¨æ€è·¯ç”±ã€ç›‘è§†ã€å¼¹æ€§ã€å®‰å…¨æ€§ç­‰çš„ç½‘å…³æ¡†æ¶ï¼Œä½†æ˜¯å®é™…ä¸Šå®ƒåŸç”Ÿå¹¶æ²¡æœ‰æä¾›è¿™äº›åŠŸèƒ½ï¼Œè¿™äº›åŠŸèƒ½æ˜¯éœ€è¦ä½¿ç”¨è€…æ‰©å±•ZuulFilterå®ç°çš„ï¼Œä¾‹å¦‚åŸºäºè´Ÿè½½å‡è¡¡çš„åŠ¨æ€è·¯ç”±éœ€è¦é…ç½®Netflixè‡ªå·±å®¶çš„Ribbonå®ç°ã€‚Zuulåœ¨è®¾è®¡ä¸Šçš„æ‰©å±•æ€§ä»€ä¹ˆè‰¯å¥½ï¼ŒZuulFilterå°±åƒæ’ä»¶ä¸€ä¸ªå¯ä»¥é€šè¿‡ç±»å‹ã€æ’åºç³»æ•°æ„å»ºä¸€ä¸ªè°ƒç”¨é“¾ï¼Œé€šè¿‡Filteræˆ–è€…Servletåšå…¥å£ï¼ŒåµŒå…¥åˆ°Servlet(Web)åº”ç”¨ä¸­ã€‚ä¸è¿‡ï¼Œåœ¨Zuulåç»­çš„ç‰ˆæœ¬å¦‚2.xå’Œ3.xä¸­ï¼Œå¼•å…¥äº†Nettyï¼ŒåŸºäºTCPåšåº•å±‚çš„æ‰©å±•ï¼Œä½†æ˜¯ç¼–ç å’Œä½¿ç”¨çš„å¤æ‚åº¦å¤§å¤§æé«˜ã€‚ä¹Ÿè®¸è¿™å°±æ˜¯SpringCloudåœ¨netflix-zuulç»„ä»¶ä¸­é€‰ç”¨äº†zuul1.xçš„æœ€åä¸€ä¸ªå‘å¸ƒç‰ˆæœ¬1.3.1çš„åŸå› å§ã€‚springcloud-netflixä¸­ä½¿ç”¨åˆ°Netflixçš„zuul(åŠ¨æ€è·¯ç”±)ã€robbin(è´Ÿè½½å‡è¡¡)ã€eureka(æœåŠ¡æ³¨å†Œä¸å‘ç°)ã€hystrix(ç†”æ–­)ç­‰æ ¸å¿ƒç»„ä»¶ï¼Œè¿™é‡Œç«‹ä¸ªflagå…ˆé€ä¸ªç»„ä»¶åˆ†æå…¶æºç ï¼Œé€ä¸ªå‡»ç ´åå†å¯¹springcloud-netflixåšä¸€æ¬¡å®Œæ•´çš„æºç åˆ†æã€‚ (æœ¬æ–‡å®Œ c-5-d r-a-20190310 æœ€è¿‘996ï¼Œä¸èƒ½ç»å¸¸æ›´æ–°ï¼Œé¡ºä¾¿ç¥è‡ªå·±ç”Ÿæ—¥å¿«ä¹â€¦)","categories":[{"name":"Framework","slug":"Framework","permalink":"http://throwable.club/blog/categories/Framework/"},{"name":"Zuul","slug":"Framework/Zuul","permalink":"http://throwable.club/blog/categories/Framework/Zuul/"}],"tags":[{"name":"Framework","slug":"Framework","permalink":"http://throwable.club/blog/tags/Framework/"},{"name":"Zuul","slug":"Zuul","permalink":"http://throwable.club/blog/tags/Zuul/"}]},{"title":"ThreadLocalæºç åˆ†æ-é»„é‡‘åˆ†å‰²æ•°çš„ä½¿ç”¨","slug":"java-concurrency-threadlocal-source-code","date":"2019-02-17T11:18:09.000Z","updated":"2019-06-23T15:25:45.729Z","comments":true,"path":"2019/02/17/java-concurrency-threadlocal-source-code/","link":"","permalink":"http://throwable.club/2019/02/17/java-concurrency-threadlocal-source-code/","excerpt":"å‰æ æœ€è¿‘æ¥è§¦åˆ°çš„ä¸€ä¸ªé¡¹ç›®è¦å…¼å®¹æ–°è€ç³»ç»Ÿï¼Œæœ€ç»ˆé‡‡ç”¨äº†ThreadLocal(å®é™…ä¸Šç”¨çš„æ˜¯InheritableThreadLocal)ç”¨äºåœ¨å­çº¿ç¨‹è·å–çˆ¶çº¿ç¨‹ä¸­å…±äº«çš„å˜é‡ã€‚é—®é¢˜æ˜¯è§£å†³äº†ï¼Œä½†æ˜¯åæ¥å‘ç°å¯¹ThreadLocalçš„ç†è§£ä¸å¤Ÿæ·±å…¥ï¼Œäºæ˜¯é¡ºä¾¿æŠŠå®ƒçš„æºç é˜…è¯»ç†è§£äº†ä¸€éã€‚åœ¨è°ˆåˆ°ThreadLocalä¹‹å‰å…ˆä¹°ä¸ªå…³å­ï¼Œå…ˆè°ˆè°ˆé»„é‡‘åˆ†å‰²æ•°ã€‚æœ¬æ–‡åœ¨é˜…è¯»ThreadLocalæºç çš„æ—¶å€™æ˜¯ä½¿ç”¨JDK8(1.8.0_181)ã€‚","text":"å‰æ æœ€è¿‘æ¥è§¦åˆ°çš„ä¸€ä¸ªé¡¹ç›®è¦å…¼å®¹æ–°è€ç³»ç»Ÿï¼Œæœ€ç»ˆé‡‡ç”¨äº†ThreadLocal(å®é™…ä¸Šç”¨çš„æ˜¯InheritableThreadLocal)ç”¨äºåœ¨å­çº¿ç¨‹è·å–çˆ¶çº¿ç¨‹ä¸­å…±äº«çš„å˜é‡ã€‚é—®é¢˜æ˜¯è§£å†³äº†ï¼Œä½†æ˜¯åæ¥å‘ç°å¯¹ThreadLocalçš„ç†è§£ä¸å¤Ÿæ·±å…¥ï¼Œäºæ˜¯é¡ºä¾¿æŠŠå®ƒçš„æºç é˜…è¯»ç†è§£äº†ä¸€éã€‚åœ¨è°ˆåˆ°ThreadLocalä¹‹å‰å…ˆä¹°ä¸ªå…³å­ï¼Œå…ˆè°ˆè°ˆé»„é‡‘åˆ†å‰²æ•°ã€‚æœ¬æ–‡åœ¨é˜…è¯»ThreadLocalæºç çš„æ—¶å€™æ˜¯ä½¿ç”¨JDK8(1.8.0_181)ã€‚ é»„é‡‘åˆ†å‰²æ•°ä¸æ–æ³¢é‚£å¥‘æ•°åˆ— é¦–å…ˆå¤ä¹ ä¸€ä¸‹æ–æ³¢é‚£å¥‘æ•°åˆ—ï¼Œä¸‹é¢çš„æ¨å¯¼è¿‡ç¨‹æ¥è‡ªæŸæœç´¢å¼•æ“çš„wikiï¼š æ–æ³¢é‚£å¥‘æ•°åˆ—ï¼š1, 1, 2, 3, 5, 8, 13, 21, 34, 55, 89, 144, â€¦ é€šé¡¹å…¬å¼ï¼šå‡è®¾F(n)ä¸ºè¯¥æ•°åˆ—çš„ç¬¬né¡¹ï¼ˆn âˆˆ N*ï¼‰ï¼Œé‚£ä¹ˆè¿™å¥è¯å¯ä»¥å†™æˆå¦‚ä¸‹å½¢å¼ï¼šF(n) = F(n-1) + F(n-2)ã€‚ æœ‰è¶£çš„æ˜¯ï¼Œè¿™æ ·ä¸€ä¸ªå®Œå…¨æ˜¯è‡ªç„¶æ•°çš„æ•°åˆ—ï¼Œé€šé¡¹å…¬å¼å´æ˜¯ç”¨æ— ç†æ•°æ¥è¡¨è¾¾çš„ã€‚è€Œä¸”å½“nè¶‹å‘äºæ— ç©·å¤§æ—¶ï¼Œå‰ä¸€é¡¹ä¸åä¸€é¡¹çš„æ¯”å€¼è¶Šæ¥è¶Šé€¼è¿‘0.618ï¼ˆæˆ–è€…è¯´åä¸€é¡¹ä¸å‰ä¸€é¡¹çš„æ¯”å€¼å°æ•°éƒ¨åˆ†è¶Šæ¥è¶Šé€¼è¿‘0.618ï¼‰ï¼Œè€Œè¿™ä¸ªå€¼0.618å°±è¢«ç§°ä¸ºé»„é‡‘åˆ†å‰²æ•°ã€‚è¯æ˜è¿‡ç¨‹å¦‚ä¸‹ï¼š é»„é‡‘åˆ†å‰²æ•°çš„å‡†ç¡®å€¼ä¸º(æ ¹å·5 - 1)/2ï¼Œçº¦ç­‰äº0.618ã€‚ é»„é‡‘åˆ†å‰²æ•°çš„åº”ç”¨ é»„é‡‘åˆ†å‰²æ•°è¢«å¹¿æ³›ä½¿ç”¨åœ¨ç¾æœ¯ã€æ‘„å½±ç­‰è‰ºæœ¯é¢†åŸŸï¼Œå› ä¸ºå®ƒå…·æœ‰ä¸¥æ ¼çš„æ¯”ä¾‹æ€§ã€è‰ºæœ¯æ€§ã€å’Œè°æ€§ï¼Œè•´è—ç€ä¸°å¯Œçš„ç¾å­¦ä»·å€¼ï¼Œèƒ½å¤Ÿæ¿€å‘äººçš„ç¾æ„Ÿã€‚å½“ç„¶ï¼Œè¿™äº›ä¸æ˜¯æœ¬æ–‡ç ”ç©¶çš„æ–¹å‘ï¼Œæˆ‘ä»¬å…ˆå°è¯•æ±‚å‡ºæ— ç¬¦å·æ•´å‹å’Œå¸¦ç¬¦å·æ•´å‹çš„é»„é‡‘åˆ†å‰²æ•°çš„å…·ä½“å€¼ï¼š 12345678public static void main(String[] args) throws Exception &#123; //é»„é‡‘åˆ†å‰²æ•° * 2çš„32æ¬¡æ–¹ = 2654435769 - è¿™ä¸ªæ˜¯æ— ç¬¦å·32ä½æ•´æ•°çš„é»„é‡‘åˆ†å‰²æ•°å¯¹åº”çš„é‚£ä¸ªå€¼ long c = (long) ((1L &lt;&lt; 32) * (Math.sqrt(5) - 1) / 2); System.out.println(c); //å¼ºåˆ¶è½¬æ¢ä¸ºå¸¦ç¬¦å·ä¸ºçš„32ä½æ•´å‹ï¼Œå€¼ä¸º-1640531527 int i = (int) c; System.out.println(i);&#125; é€šè¿‡ä¸€ä¸ªçº¿æ®µå›¾ç†è§£ä¸€ä¸‹ï¼š ä¹Ÿå°±æ˜¯2654435769ä¸º32ä½æ— ç¬¦å·æ•´æ•°çš„é»„é‡‘åˆ†å‰²å€¼ï¼Œè€Œ-1640531527å°±æ˜¯32ä½å¸¦ç¬¦å·æ•´æ•°çš„é»„é‡‘åˆ†å‰²å€¼ã€‚è€ŒThreadLocalä¸­çš„å“ˆå¸Œé­”æ•°æ­£æ˜¯1640531527(åå…­è¿›åˆ¶ä¸º0x61c88647)ã€‚ä¸ºä»€ä¹ˆè¦ä½¿ç”¨0x61c88647ä½œä¸ºå“ˆå¸Œé­”æ•°ï¼Ÿè¿™é‡Œæå‰è¯´ä¸€ä¸‹ThreadLocalåœ¨ThreadLocalMap(ThreadLocalåœ¨ThreadLocalMapä»¥Keyçš„å½¢å¼å­˜åœ¨)ä¸­çš„å“ˆå¸Œæ±‚Keyä¸‹æ ‡çš„è§„åˆ™ï¼š å“ˆå¸Œç®—æ³•ï¼škeyIndex = ((i + 1) * HASH_INCREMENT) &amp; (length - 1) å…¶ä¸­ï¼Œiä¸ºThreadLocalå®ä¾‹çš„ä¸ªæ•°ï¼Œè¿™é‡Œçš„HASH_INCREMENTå°±æ˜¯å“ˆå¸Œé­”æ•°0x61c88647ï¼Œlengthä¸ºThreadLocalMapä¸­å¯å®¹çº³çš„Entry(K-Vç»“æ„)çš„ä¸ªæ•°(æˆ–è€…ç§°ä¸ºå®¹é‡)ã€‚åœ¨ThreadLocalä¸­çš„å†…éƒ¨ç±»ThreadLocalMapçš„åˆå§‹åŒ–å®¹é‡ä¸º16ï¼Œæ‰©å®¹åæ€»æ˜¯2çš„å¹‚æ¬¡æ–¹ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥å†™ä¸ªDemoæ¨¡æ‹Ÿæ•´ä¸ªå“ˆå¸Œçš„è¿‡ç¨‹ï¼š 1234567891011121314151617181920public class Main &#123; private static final int HASH_INCREMENT = 0x61c88647; public static void main(String[] args) throws Exception &#123; hashCode(4); hashCode(16); hashCode(32); &#125; private static void hashCode(int capacity) throws Exception &#123; int keyIndex; for (int i = 0; i &lt; capacity; i++) &#123; keyIndex = ((i + 1) * HASH_INCREMENT) &amp; (capacity - 1); System.out.print(keyIndex); System.out.print(\" \"); &#125; System.out.println(); &#125;&#125; ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åˆ†åˆ«æ¨¡æ‹Ÿäº†ThreadLocalMapå®¹é‡ä¸º4,16,32çš„æƒ…å†µä¸‹ï¼Œä¸è§¦å‘æ‰©å®¹ï¼Œå¹¶ä¸”åˆ†åˆ«&quot;æ”¾å…¥&quot;4,16,32ä¸ªå…ƒç´ åˆ°å®¹å™¨ä¸­ï¼Œè¾“å‡ºç»“æœå¦‚ä¸‹ï¼š 1233 2 1 0 7 14 5 12 3 10 1 8 15 6 13 4 11 2 9 0 7 14 21 28 3 10 17 24 31 6 13 20 27 2 9 16 23 30 5 12 19 26 1 8 15 22 29 4 11 18 25 0 æ¯ç»„çš„å…ƒç´ ç»è¿‡æ•£åˆ—ç®—æ³•åæ°å¥½å¡«å……æ»¡äº†æ•´ä¸ªå®¹å™¨ï¼Œä¹Ÿå°±æ˜¯å®ç°äº†å®Œç¾æ•£åˆ—ã€‚å®é™…ä¸Šï¼Œè¿™ä¸ªå¹¶ä¸æ˜¯å¶ç„¶ï¼Œå…¶å®æ•´ä¸ªå“ˆå¸Œç®—æ³•å¯ä»¥è½¬æ¢ä¸ºå¤šé¡¹å¼è¯æ˜ï¼šè¯æ˜(x - y) * HASH_INCREMENT != 2^n * (n m)ï¼Œåœ¨x != yï¼Œn != mï¼ŒHASH_INCREMENTä¸ºå¥‡æ•°çš„æƒ…å†µä¸‹æ’æˆç«‹ï¼Œå…·ä½“è¯æ˜å¯ä»¥è‡ªè¡Œå®Œæˆã€‚HASH_INCREMENTèµ‹å€¼ä¸º0x61c88647çš„APIæ–‡æ¡£æ³¨é‡Šå¦‚ä¸‹ï¼š è¿ç»­ç”Ÿæˆçš„å“ˆå¸Œç ä¹‹é—´çš„å·®å¼‚(å¢é‡å€¼)ï¼Œå°†éšå¼é¡ºåºçº¿ç¨‹æœ¬åœ°idè½¬æ¢ä¸ºå‡ ä¹æœ€ä½³åˆ†å¸ƒçš„ä¹˜æ³•å“ˆå¸Œå€¼ï¼Œè¿™äº›ä¸åŒçš„å“ˆå¸Œå€¼æœ€ç»ˆç”Ÿæˆä¸€ä¸ª2çš„å¹‚æ¬¡æ–¹çš„å“ˆå¸Œè¡¨ã€‚ ThreadLocalæ˜¯ä»€ä¹ˆ ä¸‹é¢å¼•ç”¨ThreadLocalçš„APIæ³¨é‡Šï¼š This class provides thread-local variables. These variables differ from their normal counterparts in that each thread that accesses one (via its get or set method) has its own, independently initialized copy of the variable. ThreadLocal instances are typically private static fields in classes that wish to associate state with a thread (e.g., a user ID or Transaction ID) ç¨å¾®ç¿»è¯‘ä¸€ä¸‹ï¼šThreadLocalæä¾›çº¿ç¨‹å±€éƒ¨å˜é‡ã€‚è¿™äº›å˜é‡ä¸æ­£å¸¸çš„å˜é‡ä¸åŒï¼Œå› ä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹åœ¨è®¿é—®ThreadLocalå®ä¾‹çš„æ—¶å€™ï¼ˆé€šè¿‡å…¶getæˆ–setæ–¹æ³•ï¼‰éƒ½æœ‰è‡ªå·±çš„ã€ç‹¬ç«‹åˆå§‹åŒ–çš„å˜é‡å‰¯æœ¬ã€‚ThreadLocalå®ä¾‹é€šå¸¸æ˜¯ç±»ä¸­çš„ç§æœ‰é™æ€å­—æ®µï¼Œä½¿ç”¨å®ƒçš„ç›®çš„æ˜¯å¸Œæœ›å°†çŠ¶æ€ï¼ˆä¾‹å¦‚ï¼Œç”¨æˆ·IDæˆ–äº‹åŠ¡IDï¼‰ä¸çº¿ç¨‹å…³è”èµ·æ¥ã€‚ ThreadLocalç”±Javaç•Œçš„ä¸¤ä¸ªå¤§å¸ˆçº§çš„ä½œè€…ç¼–å†™ï¼ŒJosh Blochå’ŒDoug Leaã€‚Josh Blochæ˜¯JDK5è¯­è¨€å¢å¼ºã€Javaé›†åˆ(Collection)æ¡†æ¶çš„åˆ›åŠäººä»¥åŠã€ŠEffective Javaã€‹ç³»åˆ—çš„ä½œè€…ã€‚Doug Leaæ˜¯JUC(java.util.concurrent)åŒ…çš„ä½œè€…ï¼ŒJavaå¹¶å‘ç¼–ç¨‹çš„æ³°æ–—ã€‚æ‰€ä»¥ï¼ŒThreadLocalçš„æºç ååˆ†å€¼å¾—å­¦ä¹ ã€‚ ThreadLocalçš„åŸç† ThreadLocalè™½ç„¶å«çº¿ç¨‹æœ¬åœ°(å±€éƒ¨)å˜é‡ï¼Œä½†æ˜¯å®é™…ä¸Šå®ƒå¹¶ä¸å­˜æ”¾ä»»ä½•çš„ä¿¡æ¯ï¼Œå¯ä»¥è¿™æ ·ç†è§£ï¼šå®ƒæ˜¯çº¿ç¨‹(Thread)æ“ä½œThreadLocalMapä¸­å­˜æ”¾çš„å˜é‡çš„æ¡¥æ¢ã€‚å®ƒä¸»è¦æä¾›äº†åˆå§‹åŒ–ã€set()ã€get()ã€remove()å‡ ä¸ªæ–¹æ³•ã€‚è¿™æ ·è¯´å¯èƒ½æœ‰ç‚¹æŠ½è±¡ï¼Œä¸‹é¢ç”»ä¸ªå›¾è¯´æ˜ä¸€ä¸‹åœ¨çº¿ç¨‹ä¸­ä½¿ç”¨ThreadLocalå®ä¾‹çš„set()å’Œget()æ–¹æ³•çš„ç®€å•æµç¨‹å›¾ã€‚ å‡è®¾æˆ‘ä»¬æœ‰å¦‚ä¸‹çš„ä»£ç ï¼Œä¸»çº¿ç¨‹çš„çº¿ç¨‹åå­—æ˜¯main(ä¹Ÿæœ‰å¯èƒ½ä¸æ˜¯main)ï¼š 123456789public class Main &#123; private static final ThreadLocal&lt;String&gt; LOCAL = new ThreadLocal&lt;&gt;(); public static void main(String[] args) throws Exception&#123; LOCAL.set(\"doge\"); System.out.println(LOCAL.get()); &#125;&#125; çº¿ç¨‹å®ä¾‹å’ŒThreadLocalå®ä¾‹çš„å…³ç³»å¦‚ä¸‹ï¼š ä¸Šé¢åªæè¿°äº†å•çº¿ç¨‹çš„æƒ…å†µå¹¶ä¸”å› ä¸ºæ˜¯ä¸»çº¿ç¨‹å¿½ç•¥äº†Thread t = new Thread()è¿™ä¸€æ­¥ï¼Œå¦‚æœæœ‰å¤šä¸ªçº¿ç¨‹ä¼šç¨å¾®å¤æ‚ä¸€äº›ï¼Œä½†æ˜¯åŸç†æ˜¯ä¸å˜çš„ï¼ŒThreadLocalå®ä¾‹æ€»æ˜¯é€šè¿‡Thread.currentThread()è·å–åˆ°å½“å‰æ“ä½œçº¿ç¨‹å®ä¾‹ï¼Œç„¶åå»æ“ä½œçº¿ç¨‹å®ä¾‹ä¸­çš„ThreadLocalMapç±»å‹çš„æˆå‘˜å˜é‡ï¼Œå› æ­¤å®ƒæ˜¯ä¸€ä¸ªæ¡¥æ¢ï¼Œæœ¬èº«ä¸å…·å¤‡å­˜å‚¨åŠŸèƒ½ã€‚ ThreadLocalæºç åˆ†æ å¯¹äºThreadLocalçš„æºç ï¼Œæˆ‘ä»¬éœ€è¦é‡ç‚¹å…³æ³¨set()ã€get()ã€remove()å‡ ä¸ªæ–¹æ³•ã€‚ ThreadLocalçš„å†…éƒ¨å±æ€§ 12345678910111213//è·å–ä¸‹ä¸€ä¸ªThreadLocalå®ä¾‹çš„å“ˆå¸Œé­”æ•°private final int threadLocalHashCode = nextHashCode();//åŸå­è®¡æ•°å™¨ï¼Œä¸»è¦åˆ°å®ƒè¢«å®šä¹‰ä¸ºé™æ€private static AtomicInteger nextHashCode = new AtomicInteger();//å“ˆå¸Œé­”æ•°(å¢é•¿æ•°)ï¼Œä¹Ÿæ˜¯å¸¦ç¬¦å·çš„32ä½æ•´å‹å€¼é»„é‡‘åˆ†å‰²å€¼çš„å–æ­£private static final int HASH_INCREMENT = 0x61c88647;//ç”Ÿæˆä¸‹ä¸€ä¸ªå“ˆå¸Œé­”æ•°private static int nextHashCode() &#123; return nextHashCode.getAndAdd(HASH_INCREMENT);&#125; è¿™é‡Œéœ€è¦æ³¨æ„ä¸€ç‚¹ï¼ŒthreadLocalHashCodeæ˜¯ä¸€ä¸ªfinalçš„å±æ€§ï¼Œè€ŒåŸå­è®¡æ•°å™¨å˜é‡nextHashCodeå’Œç”Ÿæˆä¸‹ä¸€ä¸ªå“ˆå¸Œé­”æ•°çš„æ–¹æ³•nextHashCode()æ˜¯é™æ€å˜é‡å’Œé™æ€æ–¹æ³•ï¼Œé™æ€å˜é‡åªä¼šåˆå§‹åŒ–ä¸€æ¬¡ã€‚æ¢è€Œè¨€ä¹‹ï¼Œæ¯æ–°å»ºä¸€ä¸ªThreadLocalå®ä¾‹ï¼Œå®ƒå†…éƒ¨çš„threadLocalHashCodeå°±ä¼šå¢åŠ 0x61c88647ã€‚ä¸¾ä¸ªä¾‹å­ï¼š 123456//t1ä¸­çš„threadLocalHashCodeå˜é‡ä¸º0x61c88647ThreadLocal t1 = new ThreadLocal();//t2ä¸­çš„threadLocalHashCodeå˜é‡ä¸º0x61c88647 + 0x61c88647ThreadLocal t2 = new ThreadLocal();//t3ä¸­çš„threadLocalHashCodeå˜é‡ä¸º0x61c88647 + 0x61c88647 + 0x61c88647ThreadLocal t3 = new ThreadLocal(); threadLocalHashCodeæ˜¯ä¸‹é¢çš„ThreadLocalMapç»“æ„ä¸­ä½¿ç”¨çš„å“ˆå¸Œç®—æ³•çš„æ ¸å¿ƒå˜é‡ï¼Œå¯¹äºæ¯ä¸ªThreadLocalå®ä¾‹ï¼Œå®ƒçš„threadLocalHashCodeæ˜¯å”¯ä¸€çš„ã€‚ å†…éƒ¨ç±»ThreadLocalMapçš„åŸºæœ¬ç»“æ„å’Œæºç åˆ†æ ThreadLocalå†…éƒ¨ç±»ThreadLocalMapä½¿ç”¨äº†é»˜è®¤ä¿®é¥°ç¬¦ï¼Œä¹Ÿå°±æ˜¯åŒ…(åŒ…ç§æœ‰)å¯è®¿é—®çš„ã€‚ThreadLocalMapå†…éƒ¨å®šä¹‰äº†ä¸€ä¸ªé™æ€ç±»Entryã€‚æˆ‘ä»¬é‡ç‚¹çœ‹ä¸‹ThreadLocalMapçš„æºç ï¼Œå…ˆçœ‹æˆå‘˜å’Œç»“æ„éƒ¨åˆ†ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647/** * ThreadLocalMapæ˜¯ä¸€ä¸ªå®šåˆ¶çš„æ•£åˆ—æ˜ å°„ï¼Œä»…é€‚ç”¨äºç»´æŠ¤çº¿ç¨‹æœ¬åœ°å˜é‡ã€‚ * å®ƒçš„æ‰€æœ‰æ–¹æ³•éƒ½æ˜¯å®šä¹‰åœ¨ThreadLocalç±»ä¹‹å†…ã€‚ * å®ƒæ˜¯åŒ…ç§æœ‰çš„ï¼Œæ‰€ä»¥åœ¨Threadç±»ä¸­å¯ä»¥å®šä¹‰ThreadLocalMapä½œä¸ºå˜é‡ã€‚ * ä¸ºäº†å¤„ç†éå¸¸å¤§(æŒ‡çš„æ˜¯å€¼)å’Œé•¿æ—¶é—´çš„ç”¨é€”ï¼Œå“ˆå¸Œè¡¨çš„Keyä½¿ç”¨äº†å¼±å¼•ç”¨(WeakReferences)ã€‚ * å¼•ç”¨çš„é˜Ÿåˆ—(å¼±å¼•ç”¨)ä¸å†è¢«ä½¿ç”¨çš„æ—¶å€™ï¼Œå¯¹åº”çš„è¿‡æœŸçš„æ¡ç›®å°±èƒ½é€šè¿‡ä¸»åŠ¨åˆ é™¤ç§»å‡ºå“ˆå¸Œè¡¨ã€‚ */static class ThreadLocalMap &#123; //æ³¨æ„è¿™é‡Œçš„Entryçš„Keyä¸ºWeakReference&lt;ThreadLocal&lt;?&gt;&gt; static class Entry extends WeakReference&lt;ThreadLocal&lt;?&gt;&gt; &#123; //è¿™ä¸ªæ˜¯çœŸæ­£çš„å­˜æ”¾çš„å€¼ Object value; // Entryçš„Keyå°±æ˜¯ThreadLocalå®ä¾‹æœ¬èº«ï¼ŒValueå°±æ˜¯è¾“å…¥çš„å€¼ Entry(ThreadLocal&lt;?&gt; k, Object v) &#123; super(k); value = v; &#125; &#125; //åˆå§‹åŒ–å®¹é‡ï¼Œå¿…é¡»æ˜¯2çš„å¹‚æ¬¡æ–¹ private static final int INITIAL_CAPACITY = 16; //å“ˆå¸Œ(Entry)è¡¨ï¼Œå¿…é¡»æ—¶æ‰©å®¹ï¼Œé•¿åº¦å¿…é¡»ä¸º2çš„å¹‚æ¬¡æ–¹ private Entry[] table; //å“ˆå¸Œè¡¨ä¸­å…ƒç´ (Entry)çš„ä¸ªæ•° private int size = 0; //ä¸‹ä¸€æ¬¡éœ€è¦æ‰©å®¹çš„é˜ˆå€¼ï¼Œé»˜è®¤å€¼ä¸º0 private int threshold; //è®¾ç½®ä¸‹ä¸€æ¬¡éœ€è¦æ‰©å®¹çš„é˜ˆå€¼ï¼Œè®¾ç½®å€¼ä¸ºè¾“å…¥å€¼lençš„ä¸‰åˆ†ä¹‹äºŒ private void setThreshold(int len) &#123; threshold = len * 2 / 3; &#125; // ä»¥lenä¸ºæ¨¡å¢åŠ i private static int nextIndex(int i, int len) &#123; return ((i + 1 &lt; len) ? i + 1 : 0); &#125; // ä»¥lenä¸ºæ¨¡å‡å°‘i private static int prevIndex(int i, int len) &#123; return ((i - 1 &gt;= 0) ? i - 1 : len - 1); &#125;&#125; è¿™é‡Œæ³¨æ„åˆ°ååˆ†é‡è¦çš„ä¸€ç‚¹ï¼šThreadLocalMap$Entryæ˜¯WeakReference(å¼±å¼•ç”¨)ï¼Œå¹¶ä¸”é”®å€¼Keyä¸ºThreadLocal&lt;?&gt;å®ä¾‹æœ¬èº«ï¼Œè¿™é‡Œä½¿ç”¨äº†æ— é™å®šçš„æ³›å‹é€šé…ç¬¦ã€‚ æ¥ç€çœ‹ThreadLocalMapçš„æ„é€ å‡½æ•°ï¼š 1234567891011121314151617181920212223242526272829303132333435// æ„é€ ThreadLocalæ—¶å€™ä½¿ç”¨ï¼Œå¯¹åº”ThreadLocalçš„å®ä¾‹æ–¹æ³•void createMap(Thread t, T firstValue)ThreadLocalMap(ThreadLocal&lt;?&gt; firstKey, Object firstValue) &#123; // å“ˆå¸Œè¡¨é»˜è®¤å®¹é‡ä¸º16 table = new Entry[INITIAL_CAPACITY]; // è®¡ç®—ç¬¬ä¸€ä¸ªå…ƒç´ çš„å“ˆå¸Œç  int i = firstKey.threadLocalHashCode &amp; (INITIAL_CAPACITY - 1); table[i] = new Entry(firstKey, firstValue); size = 1; setThreshold(INITIAL_CAPACITY);&#125;// æ„é€ InheritableThreadLocalæ—¶å€™ä½¿ç”¨ï¼ŒåŸºäºçˆ¶çº¿ç¨‹çš„ThreadLocalMapé‡Œé¢çš„å†…å®¹è¿›è¡Œæå–æ”¾å…¥æ–°çš„ThreadLocalMapçš„å“ˆå¸Œè¡¨ä¸­// å¯¹åº”ThreadLocalçš„é™æ€æ–¹æ³•static ThreadLocalMap createInheritedMap(ThreadLocalMap parentMap)private ThreadLocalMap(ThreadLocalMap parentMap) &#123; Entry[] parentTable = parentMap.table; int len = parentTable.length; setThreshold(len); table = new Entry[len]; // åŸºäºçˆ¶ThreadLocalMapçš„å“ˆå¸Œè¡¨è¿›è¡Œæ‹·è´ for (Entry e : parentTable) &#123; if (e != null) &#123; @SuppressWarnings(\"unchecked\") ThreadLocal&lt;Object&gt; key = (ThreadLocal&lt;Object&gt;) e.get(); if (key != null) &#123; Object value = key.childValue(e.value); Entry c = new Entry(key, value); int h = key.threadLocalHashCode &amp; (len - 1); while (table[h] != null) h = nextIndex(h, len); table[h] = c; size++; &#125; &#125; &#125;&#125; è¿™é‡Œæ³¨æ„ä¸€ä¸‹ï¼ŒThreadLocalçš„set()æ–¹æ³•è°ƒç”¨çš„æ—¶å€™ä¼šæ‡’åˆå§‹åŒ–ä¸€ä¸ªThreadLocalMapå¹¶ä¸”æ”¾å…¥ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚è€ŒThreadLocalMapçš„ç§æœ‰æ„é€ æ˜¯æä¾›ç»™é™æ€æ–¹æ³•ThreadLocal#createInheritedMap()ä½¿ç”¨çš„ã€‚ æ¥ç€çœ‹ThreadLocalMapæä¾›ç»™ThreadLocalä½¿ç”¨çš„ä¸€äº›å®ä¾‹æ–¹æ³•ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227// å¦‚æœKeyåœ¨å“ˆå¸Œè¡¨ä¸­æ‰¾ä¸åˆ°å“ˆå¸Œæ§½çš„æ—¶å€™ä¼šè°ƒç”¨æ­¤æ–¹æ³•private Entry getEntryAfterMiss(ThreadLocal&lt;?&gt; key, int i, Entry e) &#123; Entry[] tab = table; int len = tab.length; // è¿™é‡Œä¼šé€šè¿‡nextIndexå°è¯•éå†æ•´ä¸ªå“ˆå¸Œè¡¨ï¼Œå¦‚æœæ‰¾åˆ°åŒ¹é…çš„Keyåˆ™è¿”å›Entry // å¦‚æœå“ˆå¸Œè¡¨ä¸­å­˜åœ¨Key == nullçš„æƒ…å†µï¼Œè°ƒç”¨expungeStaleEntryè¿›è¡Œæ¸…ç† while (e != null) &#123; ThreadLocal&lt;?&gt; k = e.get(); if (k == key) return e; if (k == null) expungeStaleEntry(i); else i = nextIndex(i, len); e = tab[i]; &#125; return null;&#125;// 1.æ¸…ç©ºstaleSlotå¯¹åº”å“ˆå¸Œæ§½çš„Keyå’ŒValue// 2.å¯¹staleSlotåˆ°ä¸‹ä¸€ä¸ªç©ºçš„å“ˆå¸Œæ§½ä¹‹é—´çš„æ‰€æœ‰å¯èƒ½å†²çªçš„å“ˆå¸Œè¡¨éƒ¨åˆ†æ§½è¿›è¡Œé‡å“ˆå¸Œï¼Œç½®ç©ºKeyä¸ºnullçš„æ§½// 3.æ³¨æ„è¿”å›å€¼æ˜¯staleSlotä¹‹åçš„ä¸‹ä¸€ä¸ªç©ºçš„å“ˆå¸Œæ§½çš„å“ˆå¸Œç private int expungeStaleEntry(int staleSlot) &#123; Entry[] tab = table; int len = tab.length; // expunge entry at staleSlot // æ¸…ç©ºstaleSlotå¯¹åº”å“ˆå¸Œæ§½çš„Keyå’ŒValue tab[staleSlot].value = null; tab[staleSlot] = null; size--; // Rehash until we encounter null // ä¸‹é¢çš„è¿‡ç¨‹æ˜¯å¯¹staleSlotåˆ°ä¸‹ä¸€ä¸ªç©ºçš„å“ˆå¸Œæ§½ä¹‹é—´çš„æ‰€æœ‰å¯èƒ½å†²çªçš„å“ˆå¸Œè¡¨éƒ¨åˆ†æ§½è¿›è¡Œé‡å“ˆå¸Œï¼Œç½®ç©ºKeyä¸ºnullçš„æ§½ Entry e; int i; for (i = nextIndex(staleSlot, len); (e = tab[i]) != null; i = nextIndex(i, len)) &#123; ThreadLocal&lt;?&gt; k = e.get(); if (k == null) &#123; e.value = null; tab[i] = null; size--; &#125; else &#123; int h = k.threadLocalHashCode &amp; (len - 1); if (h != i) &#123; tab[i] = null; // Unlike Knuth 6.4 Algorithm R, we must scan until // null because multiple entries could have been stale. while (tab[h] != null) h = nextIndex(h, len); tab[h] = e; &#125; &#125; &#125; return i;&#125;// è¿™é‡Œä¸ªæ–¹æ³•æ¯”è¾ƒé•¿ï¼Œä½œç”¨æ˜¯æ›¿æ¢å“ˆå¸Œç ä¸ºstaleSlotçš„å“ˆå¸Œæ§½ä¸­Entryçš„å€¼private void replaceStaleEntry(ThreadLocal&lt;?&gt; key, Object value, int staleSlot) &#123; Entry[] tab = table; int len = tab.length; Entry e; // Back up to check for prior stale entry in current run. // We clean out whole runs at a time to avoid continual // incremental rehashing due to garbage collector freeing // up refs in bunches (i.e., whenever the collector runs). int slotToExpunge = staleSlot; // è¿™ä¸ªå¾ªç¯ä¸»è¦æ˜¯ä¸ºäº†æ‰¾åˆ°staleSlotä¹‹å‰çš„æœ€å‰é¢çš„ä¸€ä¸ªKeyä¸ºnullçš„å“ˆå¸Œæ§½çš„å“ˆå¸Œç  for (int i = prevIndex(staleSlot, len); (e = tab[i]) != null; i = prevIndex(i, len)) if (e.get() == null) slotToExpunge = i; // Find either the key or trailing null slot of run, whichever // occurs first // éå†staleSlotä¹‹åçš„å“ˆå¸Œæ§½ï¼Œå¦‚æœKeyåŒ¹é…åˆ™ç”¨è¾“å…¥å€¼æ›¿æ¢ for (int i = nextIndex(staleSlot, len); (e = tab[i]) != null; i = nextIndex(i, len)) &#123; ThreadLocal&lt;?&gt; k = e.get(); // If we find key, then we need to swap it // with the stale entry to maintain hash table order. // The newly stale slot, or any other stale slot // encountered above it, can then be sent to expungeStaleEntry // to remove or rehash all of the other entries in run. if (k == key) &#123; e.value = value; tab[i] = tab[staleSlot]; tab[staleSlot] = e; // Start expunge at preceding stale entry if it exists if (slotToExpunge == staleSlot) slotToExpunge = i; cleanSomeSlots(expungeStaleEntry(slotToExpunge), len); return; &#125; // If we didn't find stale entry on backward scan, the // first stale entry seen while scanning for key is the // first still present in the run. if (k == null &amp;&amp; slotToExpunge == staleSlot) slotToExpunge = i; &#125; // KeyåŒ¹é…ä¸äº†ï¼Œåˆ™æ–°åˆ›å»ºä¸€ä¸ªå“ˆå¸Œæ§½ // If key not found, put new entry in stale slot tab[staleSlot].value = null; tab[staleSlot] = new Entry(key, value); // è¿™é‡Œå¦‚æœå½“å‰çš„staleSlotå’Œæ‰¾åˆ°å‰ç½®çš„slotToExpungeä¸ä¸€è‡´ä¼šè¿›è¡Œä¸€æ¬¡æ¸…ç† // If there are any other stale entries in run, expunge them if (slotToExpunge != staleSlot) cleanSomeSlots(expungeStaleEntry(slotToExpunge), len);&#125;// å¯¹å½“å‰å“ˆå¸Œè¡¨ä¸­æ‰€æœ‰çš„Keyä¸ºnullçš„Entryè°ƒç”¨expungeStaleEntryprivate void expungeStaleEntries() &#123; Entry[] tab = table; int len = tab.length; for (int j = 0; j &lt; len; j++) &#123; Entry e = tab[j]; if (e != null &amp;&amp; e.get() == null) expungeStaleEntry(j); &#125;&#125;// æ¸…ç†ç¬¬iä¸ªå“ˆå¸Œæ§½ä¹‹åçš„nä¸ªå“ˆå¸Œæ§½ï¼Œå¦‚æœéå†çš„æ—¶å€™å‘ç°Entryçš„Keyä¸ºnullï¼Œåˆ™nä¼šé‡ç½®ä¸ºå“ˆå¸Œè¡¨çš„é•¿åº¦ï¼ŒexpungeStaleEntryæœ‰å¯èƒ½ä¼šé‡å“ˆå¸Œä½¿å¾—å“ˆå¸Œè¡¨é•¿åº¦å‘ç”Ÿå˜åŒ–private boolean cleanSomeSlots(int i, int n) &#123; boolean removed = false; Entry[] tab = table; int len = tab.length; do &#123; i = nextIndex(i, len); Entry e = tab[i]; if (e != null &amp;&amp; e.get() == null) &#123; n = len; removed = true; i = expungeStaleEntry(i); &#125; &#125; while ( (n &gt;&gt;&gt;= 1) != 0); return removed;&#125;/** * è¿™ä¸ªæ–¹æ³•ä¸»è¦ç»™`ThreadLocal#get()`è°ƒç”¨ï¼Œé€šè¿‡å½“å‰ThreadLocalå®ä¾‹è·å–å“ˆå¸Œè¡¨ä¸­å¯¹åº”çš„Entry * */private Entry getEntry(ThreadLocal&lt;?&gt; key) &#123; // è®¡ç®—Entryçš„å“ˆå¸Œå€¼ int i = key.threadLocalHashCode &amp; (table.length - 1); Entry e = table[i]; if (e != null &amp;&amp; e.get() == key) return e; else // æ³¨æ„è¿™é‡Œï¼Œå¦‚æœeä¸ºnullæˆ–è€…Keyå¯¹ä¸ä¸Šï¼Œä¼šè°ƒç”¨getEntryAfterMiss return getEntryAfterMiss(key, i, e);&#125;// é‡å“ˆå¸Œï¼Œå¿…è¦æ—¶è¿›è¡Œæ‰©å®¹private void rehash() &#123; // æ¸…ç†æ‰€æœ‰ç©ºçš„å“ˆå¸Œæ§½ï¼Œå¹¶ä¸”è¿›è¡Œé‡å“ˆå¸Œ expungeStaleEntries(); // Use lower threshold for doubling to avoid hysteresis // å“ˆå¸Œè¡¨çš„å“ˆå¸Œå…ƒç´ ä¸ªæ•°å¤§äº3/4é˜ˆå€¼æ—¶å€™è§¦å‘æ‰©å®¹ if (size &gt;= threshold - threshold / 4) resize();&#125;// æ‰©å®¹ï¼Œç®€å•çš„æ‰©å¤§2å€çš„å®¹é‡ private void resize() &#123; Entry[] oldTab = table; int oldLen = oldTab.length; int newLen = oldLen * 2; Entry[] newTab = new Entry[newLen]; int count = 0; for (Entry e : oldTab) &#123; if (e != null) &#123; ThreadLocal&lt;?&gt; k = e.get(); if (k == null) &#123; e.value = null; // Help the GC &#125; else &#123; int h = k.threadLocalHashCode &amp; (newLen - 1); while (newTab[h] != null) h = nextIndex(h, newLen); newTab[h] = e; count++; &#125; &#125; &#125; setThreshold(newLen); size = count; table = newTab;&#125;// åŸºäºThreadLocalä½œä¸ºkeyï¼Œå¯¹å½“å‰çš„å“ˆå¸Œè¡¨è®¾ç½®å€¼ï¼Œæ­¤æ–¹æ³•ç”±`ThreadLocal#set()`è°ƒç”¨private void set(ThreadLocal&lt;?&gt; key, Object value) &#123; // We don't use a fast path as with get() because it is at // least as common to use set() to create new entries as // it is to replace existing ones, in which case, a fast // path would fail more often than not. Entry[] tab = table; int len = tab.length; int i = key.threadLocalHashCode &amp; (len-1); // å˜é‡å“ˆå¸Œè¡¨ for (Entry e = tab[i]; e != null; e = tab[i = nextIndex(i, len)]) &#123; ThreadLocal&lt;?&gt; k = e.get(); // KeyåŒ¹é…ï¼Œç›´æ¥è®¾ç½®å€¼ if (k == key) &#123; e.value = value; return; &#125; // å¦‚æœEntryçš„Keyä¸ºnullï¼Œåˆ™æ›¿æ¢è¯¥Keyä¸ºå½“å‰çš„keyï¼Œå¹¶ä¸”è®¾ç½®å€¼ if (k == null) &#123; replaceStaleEntry(key, value, i); return; &#125; &#125; tab[i] = new Entry(key, value); int sz = ++size; // æ¸…ç†å½“å‰æ–°è®¾ç½®å…ƒç´ çš„å“ˆå¸Œæ§½ä¸‹æ ‡åˆ°szæ®µçš„å“ˆå¸Œæ§½ï¼Œå¦‚æœæ¸…ç†æˆåŠŸå¹¶ä¸”szå¤§äºé˜ˆå€¼åˆ™è§¦å‘æ‰©å®¹ if (!cleanSomeSlots(i, sz) &amp;&amp; sz &gt;= threshold) rehash();&#125; ç®€å•æ¥è¯´ï¼ŒThreadLocalMapæ˜¯ThreadLocalçœŸæ­£çš„æ•°æ®å­˜å‚¨å®¹å™¨ï¼Œå®é™…ä¸ŠThreadLocalæ•°æ®æ“ä½œçš„å¤æ‚éƒ¨åˆ†çš„æ‰€æœ‰é€»è¾‘éƒ½åœ¨ThreadLocalMapä¸­è¿›è¡Œï¼Œè€ŒThreadLocalMapå®ä¾‹æ˜¯Threadçš„æˆå‘˜å˜é‡ï¼Œåœ¨ThreadLocal#set()æ–¹æ³•é¦–æ¬¡è°ƒç”¨çš„æ—¶å€™è®¾ç½®åˆ°å½“å‰æ‰§è¡Œçš„çº¿ç¨‹å®ä¾‹ä¸­ã€‚å¦‚æœåœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­ä½¿ç”¨å¤šä¸ªThreadLocalå®ä¾‹ï¼Œå®é™…ä¸Šï¼Œæ¯ä¸ªThreadLocalå®ä¾‹å¯¹åº”çš„æ˜¯ThreadLocalMapçš„å“ˆå¸Œè¡¨ä¸­çš„ä¸€ä¸ªå“ˆå¸Œæ§½ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œåœ¨ä¸»å‡½æ•°ä¸»çº¿ç¨‹ä¸­ä½¿ç”¨å¤šä¸ªThreadLocalå®ä¾‹ï¼š 12345678910111213141516public class ThreadLocalMain &#123; private static final ThreadLocal&lt;Integer&gt; TL_1 = new ThreadLocal&lt;&gt;(); private static final ThreadLocal&lt;String&gt; TL_2 = new ThreadLocal&lt;&gt;(); private static final ThreadLocal&lt;Long&gt; TL_3 = new ThreadLocal&lt;&gt;(); public static void main(String[] args) throws Exception &#123; TL_1.set(1); TL_2.set(\"1\"); TL_3.set(1L); Field field = Thread.class.getDeclaredField(\"threadLocals\"); field.setAccessible(true); Object o = field.get(Thread.currentThread()); System.out.println(o); &#125;&#125; å®é™…ä¸Šï¼Œä¸»çº¿ç¨‹çš„threadLocalså±æ€§ä¸­çš„å“ˆå¸Œè¡¨ä¸­ä¸€èˆ¬ä¸æ­¢æˆ‘ä»¬ä¸Šé¢å®šä¹‰çš„ä¸‰ä¸ªThreadLocalï¼Œå› ä¸ºåŠ è½½ä¸»çº¿ç¨‹çš„æ—¶å€™è¿˜æœ‰å¯èƒ½åœ¨å…¶ä»–åœ°æ–¹ä½¿ç”¨åˆ°ThreadLocalï¼Œç¬”è€…æŸæ¬¡Debugçš„ç»“æœå¦‚ä¸‹ï¼š ç”¨PPTç”»å›¾ç®€åŒ–ä¸€ä¸‹ï¼š ä¸Šå›¾threadLocalHashCodeå±æ€§ä¸€è¡Œçš„è¡¨æ˜¯ä¸ºäº†æ ‡å‡ºæ¯ä¸ªEntryçš„å“ˆå¸Œæ§½çš„å“ˆå¸Œå€¼ï¼Œå®é™…ä¸Šï¼ŒthreadLocalHashCodeæ˜¯ThreadLocal@XXXXä¸­çš„ä¸€ä¸ªå±æ€§ï¼Œè¿™æ˜¯å¾ˆæ˜¾ç„¶çš„ï¼Œæœ¬æ¥threadLocalHashCodeå°±æ˜¯ThreadLocalçš„ä¸€ä¸ªæˆå‘˜å˜é‡ã€‚ ä¸Šé¢åªæ˜¯ç®€å•ç²—ç•¥å¯¹ThreadLocalMapçš„æºç è¿›è¡Œäº†æµæ°´è´¦çš„åˆ†æï¼Œä¸‹æ–‡ä¼šä½œä¸€äº›è¯¦ç»†çš„å›¾ï¼Œè¯´æ˜ä¸€ä¸‹ThreadLocalå’ŒThreadLocalMapä¸­çš„ä¸€äº›æ ¸å¿ƒæ“ä½œçš„è¿‡ç¨‹ã€‚ ThreadLocalçš„åˆ›å»º ä»ThreadLocalçš„æ„é€ å‡½æ•°æ¥çœ‹ï¼ŒThreadLocalå®ä¾‹çš„æ„é€ å¹¶ä¸ä¼šåšä»»ä½•æ“ä½œï¼Œåªæ˜¯ä¸ºäº†å¾—åˆ°ä¸€ä¸ªThreadLocalçš„æ³›å‹å®ä¾‹ï¼Œåç»­å¯ä»¥æŠŠå®ƒä½œä¸ºThreadLocalMap$Entryçš„é”®ï¼š 1234567891011121314151617// æ³¨æ„threadLocalHashCodeåœ¨æ¯ä¸ªæ–°`ThreadLocal`å®ä¾‹çš„æ„é€ åŒæ—¶å·²ç»ç¡®å®šäº†private final int threadLocalHashCode = nextHashCode();private static AtomicInteger nextHashCode = new AtomicInteger();private static final int HASH_INCREMENT = 0x61c88647;private static int nextHashCode() &#123; return nextHashCode.getAndAdd(HASH_INCREMENT);&#125;// é€šè¿‡Supplierå»è¦†ç›–initialValueæ–¹æ³•public static &lt;S&gt; ThreadLocal&lt;S&gt; withInitial(Supplier&lt;? extends S&gt; supplier) &#123; return new SuppliedThreadLocal&lt;&gt;(supplier);&#125;// é»˜è®¤å…¬æœ‰æ„é€ å‡½æ•°public ThreadLocal() &#123;&#125; æ³¨æ„threadLocalHashCodeåœ¨æ¯ä¸ªæ–°ThreadLocalå®ä¾‹çš„æ„é€ åŒæ—¶å·²ç»ç¡®å®šäº†ï¼Œè¿™ä¸ªå€¼ä¹Ÿæ˜¯Entryå“ˆå¸Œè¡¨çš„å“ˆå¸Œæ§½ç»‘å®šçš„å“ˆå¸Œå€¼ã€‚ TreadLocalçš„setæ–¹æ³• ThreadLocalä¸­set()æ–¹æ³•çš„æºç å¦‚ä¸‹: 12345678910111213141516171819202122public void set(T value) &#123; //è®¾ç½®å€¼å‰æ€»æ˜¯è·å–å½“å‰çº¿ç¨‹å®ä¾‹ Thread t = Thread.currentThread(); //ä»å½“å‰çº¿ç¨‹å®ä¾‹ä¸­è·å–threadLocalså±æ€§ ThreadLocalMap map = getMap(t); if (map != null) //threadLocalså±æ€§ä¸ä¸ºnullåˆ™è¦†ç›–keyä¸ºå½“å‰çš„ThreadLocalå®ä¾‹ï¼Œå€¼ä¸ºvalue map.set(this, value); else //threadLocalså±æ€§ä¸ºnullï¼Œåˆ™åˆ›å»ºThreadLocalMapï¼Œç¬¬ä¸€ä¸ªé¡¹çš„Keyä¸ºå½“å‰çš„ThreadLocalå®ä¾‹ï¼Œå€¼ä¸ºvalue createMap(t, value);&#125;// è¿™é‡Œçœ‹åˆ°è·å–ThreadLocalMapå®ä¾‹æ—¶å€™æ€»æ˜¯ä»çº¿ç¨‹å®ä¾‹çš„æˆå‘˜å˜é‡è·å–ThreadLocalMap getMap(Thread t) &#123; return t.threadLocals;&#125;// åˆ›å»ºThreadLocalMapå®ä¾‹çš„æ—¶å€™ï¼Œä¼šæŠŠæ–°å®ä¾‹èµ‹å€¼åˆ°çº¿ç¨‹å®ä¾‹çš„threadLocalsæˆå‘˜void createMap(Thread t, T firstValue) &#123; t.threadLocals = new ThreadLocalMap(this, firstValue);&#125; ä¸Šé¢çš„è¿‡ç¨‹æºç å¾ˆç®€å•ï¼Œè®¾ç½®å€¼çš„æ—¶å€™æ€»æ˜¯å…ˆè·å–å½“å‰çº¿ç¨‹å®ä¾‹å¹¶ä¸”æ“ä½œå®ƒçš„å˜é‡threadLocalsã€‚æ­¥éª¤æ˜¯ï¼š è·å–å½“å‰è¿è¡Œçº¿ç¨‹çš„å®ä¾‹ã€‚ é€šè¿‡çº¿ç¨‹å®ä¾‹è·å–çº¿ç¨‹å®ä¾‹æˆå‘˜threadLocals(ThreadLocalMap)ï¼Œå¦‚æœä¸ºnullï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„ThreadLocalMapå®ä¾‹èµ‹å€¼åˆ°threadLocalsã€‚ é€šè¿‡threadLocalsè®¾ç½®å€¼valueï¼Œå¦‚æœåŸæ¥çš„å“ˆå¸Œæ§½å·²ç»å­˜åœ¨å€¼ï¼Œåˆ™è¿›è¡Œè¦†ç›–ã€‚ TreadLocalçš„getæ–¹æ³• ThreadLocalä¸­get()æ–¹æ³•çš„æºç å¦‚ä¸‹: 123456789101112131415161718192021222324252627282930313233 public T get() &#123; //è·å–å½“å‰çº¿ç¨‹çš„å®ä¾‹ Thread t = Thread.currentThread(); ThreadLocalMap map = getMap(t); if (map != null) &#123; //æ ¹æ®å½“å‰çš„ThreadLocalå®ä¾‹è·å–ThreadLocalMapä¸­çš„Entryï¼Œä½¿ç”¨çš„æ˜¯ThreadLocalMapçš„getEntryæ–¹æ³• ThreadLocalMap.Entry e = map.getEntry(this); if (e != null) &#123; @SuppressWarnings(\"unchecked\") T result = (T) e.value; return result; &#125; &#125; //çº¿ç¨‹å®ä¾‹ä¸­çš„threadLocalsä¸ºnullï¼Œåˆ™è°ƒç”¨initialValueæ–¹æ³•ï¼Œå¹¶ä¸”åˆ›å»ºThreadLocalMapèµ‹å€¼åˆ°threadLocals return setInitialValue();&#125;private T setInitialValue() &#123; // è°ƒç”¨initialValueæ–¹æ³•è·å–å€¼ T value = initialValue(); Thread t = Thread.currentThread(); ThreadLocalMap map = getMap(t); // ThreadLocalMapå¦‚æœæœªåˆå§‹åŒ–åˆ™è¿›è¡Œä¸€æ¬¡åˆ›å»ºï¼Œå·²åˆå§‹åŒ–åˆ™ç›´æ¥è®¾ç½®å€¼ if (map != null) map.set(this, value); else createMap(t, value); return value;&#125;protected T initialValue() &#123; return null;&#125; initialValue()æ–¹æ³•é»˜è®¤è¿”å›nullï¼Œå¦‚æœThreadLocalå®ä¾‹æ²¡æœ‰ä½¿ç”¨è¿‡set()æ–¹æ³•ç›´æ¥ä½¿ç”¨get()æ–¹æ³•ï¼Œé‚£ä¹ˆThreadLocalMapä¸­çš„æ­¤ThreadLocalä¸ºKeyçš„é¡¹ä¼šæŠŠå€¼è®¾ç½®ä¸ºinitialValue()æ–¹æ³•çš„è¿”å›å€¼ã€‚å¦‚æœæƒ³æ”¹å˜è¿™ä¸ªé€»è¾‘å¯ä»¥å¯¹initialValue()æ–¹æ³•è¿›è¡Œè¦†ç›–ã€‚ TreadLocalçš„removeæ–¹æ³• ThreadLocalä¸­remove()æ–¹æ³•çš„æºç å¦‚ä¸‹: 1234567public void remove() &#123; //è·å–Threadå®ä¾‹ä¸­çš„ThreadLocalMap ThreadLocalMap m = getMap(Thread.currentThread()); if (m != null) //æ ¹æ®å½“å‰ThreadLocalä½œä¸ºKeyå¯¹ThreadLocalMapçš„å…ƒç´ è¿›è¡Œç§»é™¤ m.remove(this);&#125; ThreadLocal.ThreadLocalMapçš„åˆå§‹åŒ– æˆ‘ä»¬å¯ä»¥å…³æ³¨ä¸€ä¸‹java.lang.Threadç±»é‡Œé¢çš„å˜é‡ï¼š 1234567public class Thread implements Runnable &#123; //ä¼ é€’ThreadLocalä¸­çš„ThreadLocalMapå˜é‡ ThreadLocal.ThreadLocalMap threadLocals = null; //ä¼ é€’InheritableThreadLocalä¸­çš„ThreadLocalMapå˜é‡ ThreadLocal.ThreadLocalMap inheritableThreadLocals = null;&#125; ä¹Ÿå°±æ˜¯ï¼ŒThreadLocaléœ€è¦å­˜æ”¾å’Œè·å–çš„æ•°æ®å®é™…ä¸Šç»‘å®šåœ¨Threadå®ä¾‹çš„æˆå‘˜å˜é‡threadLocalsä¸­ï¼Œå¹¶ä¸”æ˜¯ThreadLocal#set()æ–¹æ³•è°ƒç”¨çš„æ—¶å€™æ‰è¿›è¡Œæ‡’åŠ è½½çš„ï¼Œå¯ä»¥ç»“åˆä¸Šä¸€èŠ‚çš„å†…å®¹ç†è§£ä¸€ä¸‹ï¼Œè¿™é‡Œä¸å±•å¼€ã€‚ ä»€ä¹ˆæƒ…å†µä¸‹ThreadLocalçš„ä½¿ç”¨ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ å…¶å®ThreadLocalæœ¬èº«ä¸å­˜æ”¾ä»»ä½•çš„æ•°æ®ï¼Œè€ŒThreadLocalä¸­çš„æ•°æ®å®é™…ä¸Šæ˜¯å­˜æ”¾åœ¨çº¿ç¨‹å®ä¾‹ä¸­ï¼Œä»å®é™…æ¥çœ‹æ˜¯çº¿ç¨‹å†…å­˜æ³„æ¼ï¼Œåº•å±‚æ¥çœ‹æ˜¯Threadå¯¹è±¡ä¸­çš„æˆå‘˜å˜é‡threadLocalsæŒæœ‰å¤§é‡çš„K-Vç»“æ„ï¼Œå¹¶ä¸”çº¿ç¨‹ä¸€ç›´å¤„äºæ´»è·ƒçŠ¶æ€å¯¼è‡´å˜é‡threadLocalsæ— æ³•é‡Šæ”¾è¢«å›æ”¶ã€‚threadLocalsæŒæœ‰å¤§é‡çš„K-Vç»“æ„è¿™ä¸€ç‚¹çš„å‰ææ˜¯è¦å­˜åœ¨å¤§é‡çš„ThreadLocalå®ä¾‹çš„å®šä¹‰ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œä¸€ä¸ªåº”ç”¨ä¸å¯èƒ½å®šä¹‰å¤§é‡çš„ThreadLocalï¼Œæ‰€ä»¥ä¸€èˆ¬çš„æ³„æ¼æºæ˜¯çº¿ç¨‹ä¸€ç›´å¤„äºæ´»è·ƒçŠ¶æ€å¯¼è‡´å˜é‡threadLocalsæ— æ³•é‡Šæ”¾è¢«å›æ”¶ã€‚ä½†æ˜¯æˆ‘ä»¬çŸ¥é“ï¼ŒÂ·ThreadLocalMapÂ·ä¸­çš„Entryç»“æ„çš„Keyç”¨åˆ°äº†å¼±å¼•ç”¨(Â·WeakReference&lt;ThreadLocal&lt;?&gt;&gt;Â·)ï¼Œå½“æ²¡æœ‰å¼ºå¼•ç”¨æ¥å¼•ç”¨ThreadLocalå®ä¾‹çš„æ—¶å€™ï¼ŒJVMçš„GCä¼šå›æ”¶ThreadLocalMapä¸­çš„è¿™äº›Keyï¼Œæ­¤æ—¶ï¼ŒThreadLocalMapä¸­ä¼šå‡ºç°ä¸€äº›Keyä¸ºnullï¼Œä½†æ˜¯Valueä¸ä¸ºnullçš„Entryé¡¹ï¼Œè¿™äº›Entryé¡¹å¦‚æœä¸ä¸»åŠ¨æ¸…ç†ï¼Œå°±ä¼šä¸€ç›´é©»ç•™åœ¨ThreadLocalMapä¸­ã€‚ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆThreadLocalä¸­get()ã€set()ã€remove()è¿™äº›æ–¹æ³•ä¸­éƒ½å­˜åœ¨æ¸…ç†ThreadLocalMapå®ä¾‹keyä¸ºnullçš„ä»£ç å—ã€‚æ€»ç»“ä¸‹æ¥ï¼Œå†…å­˜æ³„æ¼å¯èƒ½å‡ºç°çš„åœ°æ–¹æ˜¯ï¼š 1ã€å¤§é‡åœ°(é™æ€)åˆå§‹åŒ–ThreadLocalå®ä¾‹ï¼Œåˆå§‹åŒ–ä¹‹åä¸å†è°ƒç”¨get()ã€set()ã€remove()æ–¹æ³•ã€‚ 2ã€åˆå§‹åŒ–äº†å¤§é‡çš„ThreadLocalï¼Œè¿™äº›ThreadLocalä¸­å­˜æ”¾äº†å®¹é‡å¤§çš„Valueï¼Œå¹¶ä¸”ä½¿ç”¨äº†è¿™äº›ThreadLocalå®ä¾‹çš„çº¿ç¨‹ä¸€ç›´å¤„äºæ´»è·ƒçš„çŠ¶æ€ã€‚ ThreadLocalä¸­ä¸€ä¸ªè®¾è®¡äº®ç‚¹æ˜¯ThreadLocalMapä¸­çš„Entryç»“æ„çš„Keyç”¨åˆ°äº†å¼±å¼•ç”¨ã€‚è¯•æƒ³å¦‚æœä½¿ç”¨å¼ºå¼•ç”¨ï¼Œç­‰äºThreadLocalMapä¸­çš„æ‰€æœ‰æ•°æ®éƒ½æ˜¯ä¸Threadçš„ç”Ÿå‘½å‘¨æœŸç»‘å®šï¼Œè¿™æ ·å¾ˆå®¹æ˜“å‡ºç°å› ä¸ºå¤§é‡çº¿ç¨‹æŒç»­æ´»è·ƒå¯¼è‡´çš„å†…å­˜æ³„æ¼ã€‚ä½¿ç”¨äº†å¼±å¼•ç”¨çš„è¯ï¼ŒJVMè§¦å‘GCå›æ”¶å¼±å¼•ç”¨åï¼ŒThreadLocalåœ¨ä¸‹ä¸€æ¬¡è°ƒç”¨get()ã€set()ã€remove()æ–¹æ³•å°±å¯ä»¥åˆ é™¤é‚£äº›ThreadLocalMapä¸­Keyä¸ºnullçš„å€¼ï¼Œèµ·åˆ°äº†æƒ°æ€§åˆ é™¤é‡Šæ”¾å†…å­˜çš„ä½œç”¨ã€‚ å…¶å®ThreadLocalåœ¨è®¾ç½®å†…éƒ¨ç±»ThreadLocal.ThreadLocalMapä¸­æ„å»ºçš„Entryå“ˆå¸Œè¡¨å·²ç»è€ƒè™‘åˆ°å†…å­˜æ³„æ¼çš„é—®é¢˜ï¼Œæ‰€ä»¥ThreadLocal.ThreadLocalMap$Entryç±»è®¾è®¡ä¸ºå¼±å¼•ç”¨ï¼Œç±»ç­¾åä¸ºstatic class Entry extends WeakReference&lt;ThreadLocal&lt;?&gt;&gt;ã€‚ä¹‹å‰ä¸€ç¯‡æ–‡ç« ä»‹ç»è¿‡ï¼Œå¦‚æœå¼±å¼•ç”¨å…³è”çš„å¯¹è±¡å¦‚æœç½®ä¸ºnullï¼Œé‚£ä¹ˆè¯¥å¼±å¼•ç”¨ä¼šåœ¨ä¸‹ä¸€æ¬¡GCæ—¶å€™å›æ”¶å¼±å¼•ç”¨å…³è”çš„å¯¹è±¡ã€‚ä¸¾ä¸ªä¾‹å­ï¼š 1234567891011public class ThreadLocalMain &#123; private static ThreadLocal&lt;Integer&gt; TL_1 = new ThreadLocal&lt;&gt;(); public static void main(String[] args) throws Exception &#123; TL_1.set(1); TL_1 = null; System.gc(); Thread.sleep(300); &#125;&#125; è¿™ç§æƒ…å†µä¸‹ï¼ŒTL_1è¿™ä¸ªThreadLocalåœ¨ä¸»åŠ¨GCä¹‹åï¼Œçº¿ç¨‹ç»‘å®šçš„ThreadLocal.ThreadLocalMapå®ä¾‹ä¸­çš„Entryå“ˆå¸Œè¡¨ä¸­åŸæ¥çš„TL_1æ‰€åœ¨çš„å“ˆå¸Œæ§½Entryçš„å¼•ç”¨æŒæœ‰å€¼referent(ç»§æ‰¿è‡ªWeakReference)ä¼šå˜æˆnullï¼Œä½†æ˜¯Entryä¸­çš„valueæ˜¯å¼ºå¼•ç”¨ï¼Œè¿˜å­˜æ”¾ç€TL_1è¿™ä¸ªThreadLocalæœªå›æ”¶ä¹‹å‰çš„å€¼ã€‚è¿™äº›è¢«&quot;å­¤ç«‹&quot;çš„å“ˆå¸Œæ§½Entryå°±æ˜¯å‰é¢è¯´åˆ°çš„è¦æƒ°æ€§åˆ é™¤çš„å“ˆå¸Œæ§½ã€‚ ThreadLocalçš„æœ€ä½³å®è·µ å…¶å®ThreadLocalçš„æœ€ä½³å®è·µå¾ˆç®€å•ï¼š æ¯æ¬¡ä½¿ç”¨å®ŒThreadLocalå®ä¾‹ï¼Œéƒ½è°ƒç”¨å®ƒçš„remove()æ–¹æ³•ï¼Œæ¸…é™¤Entryä¸­çš„æ•°æ®ã€‚ è°ƒç”¨remove()æ–¹æ³•æœ€ä½³æ—¶æœºæ˜¯çº¿ç¨‹è¿è¡Œç»“æŸä¹‹å‰çš„finallyä»£ç å—ä¸­è°ƒç”¨ï¼Œè¿™æ ·èƒ½å®Œå…¨é¿å…æ“ä½œä¸å½“å¯¼è‡´çš„å†…å­˜æ³„æ¼ï¼Œè¿™ç§ä¸»åŠ¨æ¸…ç†çš„æ–¹å¼æ¯”æƒ°æ€§åˆ é™¤æœ‰æ•ˆã€‚ çˆ¶å­çº¿ç¨‹æ•°æ®ä¼ é€’InheritableThreadLocal ç•™å¾…ä¸‹ä¸€ç¯‡æ–‡ç« ç¼–å†™ï¼Œå› ä¸ºInheritableThreadLocalåªèƒ½é€šè¿‡çˆ¶å­çº¿(1-&gt;1)ç¨‹ä¼ é€’å˜é‡ï¼Œçº¿ç¨‹æ± é‡Œé¢çš„çº¿ç¨‹æœ‰å¯èƒ½æ˜¯å¤šä¸ªçˆ¶çº¿ç¨‹å…±äº«çš„(ä¹Ÿå°±æ˜¯1ä¸ªçˆ¶çº¿ç¨‹æäº¤çš„ä»»åŠ¡æœ‰å¯èƒ½ç”±çº¿ç¨‹æ± ä¸­çš„å¤šä¸ªå­çº¿ç¨‹æ‰§è¡Œ)ï¼Œå› æ­¤æœ‰å¯èƒ½å‡ºç°é—®é¢˜ã€‚é˜¿é‡Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ç¼–å†™è¿‡ä¸€ä¸ªæ¡†æ¶-transmittable-thread-localï¼Œè§£å†³äº†çˆ¶çº¿ç¨‹å’Œçº¿ç¨‹æ± ä¸­çº¿ç¨‹çš„å˜é‡ä¼ é€’é—®é¢˜ã€‚ å°ç»“ ThreadLocalçº¿ç¨‹æœ¬åœ°å˜é‡æ˜¯çº¿ç¨‹å®ä¾‹ä¼ é€’å’Œå­˜å‚¨å…±äº«å˜é‡çš„æ¡¥æ¢ï¼ŒçœŸæ­£çš„å…±äº«å˜é‡è¿˜æ˜¯å­˜æ”¾åœ¨çº¿ç¨‹å®ä¾‹æœ¬èº«çš„å±æ€§ä¸­ã€‚ThreadLocalé‡Œé¢çš„åŸºæœ¬é€»è¾‘å¹¶ä¸å¤æ‚ï¼Œä½†æ˜¯ä¸€æ—¦æ¶‰åŠåˆ°æ€§èƒ½å½±å“ã€å†…å­˜å›æ”¶(å¼±å¼•ç”¨)å’Œæƒ°æ€§åˆ é™¤ç­‰ç¯èŠ‚ï¼Œå…¶å®å®ƒè€ƒè™‘åˆ°çš„ä¸œè¥¿è¿˜æ˜¯ç›¸å¯¹å…¨é¢è€Œä¸”æœ‰æ•ˆçš„ã€‚ (æœ¬æ–‡å®Œ e-a-20190217 c-7-d)","categories":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/categories/Java/"},{"name":"Concurrency","slug":"Java/Concurrency","permalink":"http://throwable.club/blog/categories/Java/Concurrency/"}],"tags":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/tags/Java/"},{"name":"ThreadLocal","slug":"ThreadLocal","permalink":"http://throwable.club/blog/tags/ThreadLocal/"}]},{"title":"JDKå®‰å…¨æ¨¡å—JCEæ ¸å¿ƒCipherä½¿ç”¨è¯¦è§£","slug":"java-security-cipher","date":"2019-02-16T15:04:21.000Z","updated":"2019-02-16T15:05:55.251Z","comments":true,"path":"2019/02/16/java-security-cipher/","link":"","permalink":"http://throwable.club/2019/02/16/java-security-cipher/","excerpt":"","text":"JDKå®‰å…¨æ¨¡å—JCEæ ¸å¿ƒCipherä½¿ç”¨è¯¦è§£ å‰æ javax.crypto.Cipherï¼Œç¿»è¯‘ä¸ºå¯†ç ï¼Œå…¶å®å«åšå¯†ç å™¨æ›´åŠ åˆé€‚ã€‚Cipheræ˜¯JCA(Java Cryptographic Extensionï¼ŒJavaåŠ å¯†æ‰©å±•)çš„æ ¸å¿ƒï¼Œæä¾›åŸºäºå¤šç§åŠ è§£å¯†ç®—æ³•çš„åŠ è§£å¯†åŠŸèƒ½ã€‚åœ¨ä¸äº†è§£Cipherä¹‹å‰ï¼Œæˆ‘ä»¬åœ¨å®Œæˆä¸€äº›éœ€è¦åŠ è§£å¯†çš„æ¨¡å—çš„æ—¶å€™æ€»æ˜¯éœ€è¦åˆ°å¤„æ‹·è´ä»£ç ï¼Œç”šè‡³æœ‰äº›é”™è¯¯çš„ç”¨æ³•ä¹Ÿè¢«æ— æ•°æ¬¡æ‹·è´ï¼Œè¸©å‘ä¹‹ååˆè¦æ‹·è´è¡¥å‘çš„ä»£ç ã€‚ä¸ºä»€ä¹ˆä¸å°è¯•ç†è§£Cipherç„¶ååˆç†åœ°ä½¿ç”¨å‘¢ï¼Ÿ Cipheråˆå§‹åŒ–transformation(è½¬æ¢æ¨¡å¼)çš„ä¸€äº›çŸ¥è¯†è¡¥å…… è½¬æ¢æ¨¡å¼transformationä¸€èˆ¬ç”±ä¸‰ä¸ªéƒ¨åˆ†ç»„æˆï¼Œæ ¼å¼æ˜¯ï¼šç®—æ³•/å·¥ä½œæ¨¡å¼/å¡«å……æ¨¡å¼(algorithm/mode/padding)ã€‚ä¾‹å¦‚ï¼šDES/CBC/PKCS5Paddingã€‚ ç®—æ³• ç®—æ³•å°±æ˜¯æŒ‡å…·ä½“åŠ è§£å¯†ç®—æ³•çš„åç§°è‹±æ–‡å­—ç¬¦ä¸²ï¼Œä¾‹å¦‚&quot;SHA-256&quot;ã€&quot;RSA&quot;ç­‰ï¼Œè¿™é‡Œä¸å¯¹å…·ä½“ç®—æ³•çš„å®ç°åŸç†åšå…·ä½“å±•å¼€ã€‚ å·¥ä½œæ¨¡å¼ å·¥ä½œæ¨¡å¼å…¶å®ä¸»è¦æ˜¯é’ˆå¯¹åˆ†ç»„å¯†ç ã€‚åˆ†ç»„å¯†ç æ˜¯å°†æ˜æ–‡æ¶ˆæ¯ç¼–ç è¡¨ç¤ºåçš„æ•°å­—ï¼ˆç®€ç§°æ˜æ–‡æ•°å­—ï¼‰åºåˆ—ï¼Œåˆ’åˆ†æˆé•¿åº¦ä¸ºnçš„ç»„ï¼ˆå¯çœ‹æˆé•¿åº¦ä¸ºnçš„çŸ¢é‡ï¼‰ï¼Œæ¯ç»„åˆ†åˆ«åœ¨å¯†é’¥çš„æ§åˆ¶ä¸‹å˜æ¢æˆç­‰é•¿çš„è¾“å‡ºæ•°å­—ï¼ˆç®€ç§°å¯†æ–‡æ•°å­—ï¼‰åºåˆ—ã€‚å·¥ä½œæ¨¡å¼çš„å‡ºç°ä¸»è¦åŸºäºä¸‹é¢åŸå› ï¼š å½“éœ€è¦åŠ å¯†çš„æ˜æ–‡é•¿åº¦ååˆ†å¤§(ä¾‹å¦‚æ–‡ä»¶å†…å®¹)ï¼Œç”±äºç¡¬ä»¶æˆ–è€…æ€§èƒ½åŸå› éœ€è¦åˆ†ç»„åŠ å¯†ã€‚ å¤šæ¬¡ä½¿ç”¨ç›¸åŒçš„å¯†é’¥å¯¹å¤šä¸ªåˆ†ç»„åŠ å¯†ï¼Œä¼šå¼•å‘è®¸å¤šå®‰å…¨é—®é¢˜ã€‚ ä»æœ¬è´¨ä¸Šè®²ï¼Œå·¥ä½œæ¨¡å¼æ˜¯ä¸€é¡¹å¢å¼ºå¯†ç ç®—æ³•æˆ–è€…ä½¿ç®—æ³•é€‚åº”å…·ä½“åº”ç”¨çš„æŠ€æœ¯ï¼Œä¾‹å¦‚å°†åˆ†ç»„å¯†ç åº”ç”¨äºæ•°æ®å—ç»„æˆçš„åºåˆ—æˆ–è€…æ•°æ®æµã€‚ç›®å‰ä¸»è¦åŒ…æ‹¬ä¸‹é¢äº”ç§ç”±NISTå®šä¹‰çš„å·¥ä½œæ¨¡å¼ï¼š æ¨¡å¼ åç§° æè¿° å…¸å‹åº”ç”¨ ç”µå­å¯†ç æœ¬(ECB) Electronic CodeBook ç”¨ç›¸åŒçš„å¯†é’¥åˆ†åˆ«å¯¹æ˜æ–‡åˆ†ç»„ç‹¬ç«‹åŠ å¯† å•ä¸ªæ•°æ®çš„å®‰å…¨ä¼ è¾“(ä¾‹å¦‚ä¸€ä¸ªåŠ å¯†å¯†é’¥) å¯†ç åˆ†ç»„é“¾æ¥(CBC) Cipher Block Chaining åŠ å¯†ç®—æ³•çš„è¾“å…¥æ˜¯ä¸Šä¸€ä¸ªå¯†æ–‡ç»„åˆä¸‹ä¸€ä¸ªæ˜æ–‡ç»„çš„å¼‚æˆ– é¢å‘åˆ†ç»„çš„é€šç”¨ä¼ è¾“æˆ–è€…è®¤è¯ å¯†æ–‡åé¦ˆ(CFB) Cipher FeedBack ä¸€æ¬¡å¤„ç†sä½ï¼Œä¸Šä¸€å—å¯†æ–‡ä½œä¸ºåŠ å¯†ç®—æ³•çš„è¾“å…¥ï¼Œäº§ç”Ÿçš„ä¼ªéšæœºæ•°è¾“å‡ºä¸æ˜æ–‡å¼‚æˆ–ä½œä¸ºä¸‹ä¸€å•å…ƒçš„å¯†æ–‡ é¢å‘åˆ†ç»„çš„é€šç”¨ä¼ è¾“æˆ–è€…è®¤è¯ è¾“å‡ºåé¦ˆ(OFB) Output FeedBack ä¸CFBç±»ä¼¼ï¼Œåªæ˜¯åŠ å¯†ç®—æ³•çš„è¾“å…¥æ˜¯ä¸Šä¸€æ¬¡åŠ å¯†çš„è¾“å‡ºï¼Œå¹¶ä¸”ä½¿ç”¨æ•´ä¸ªåˆ†ç»„ å™ªå£°ä¿¡é“ä¸Šçš„æ•°æ®æµçš„ä¼ è¾“(å¦‚å«æ˜Ÿé€šä¿¡) è®¡æ•°å™¨(CTR) Counter æ¯ä¸ªæ˜æ–‡åˆ†ç»„éƒ½ä¸ä¸€ä¸ªç»è¿‡åŠ å¯†çš„è®¡æ•°å™¨ç›¸å¼‚æˆ–ã€‚å¯¹æ¯ä¸ªåç»­åˆ†ç»„è®¡æ•°å™¨é€’å¢ é¢å‘åˆ†ç»„çš„é€šç”¨ä¼ è¾“æˆ–è€…ç”¨äºé«˜é€Ÿéœ€æ±‚ ä¸Šé¢äº”ç§å·¥ä½œæ¨¡å¼å¯ä»¥ç”¨äº3DESå’ŒAESåœ¨å†…çš„ä»»ä½•åˆ†ç»„å¯†ç ï¼Œè‡³äºé€‰æ‹©å“ªä¸€ç§å·¥ä½œæ¨¡å¼éœ€è¦ç»“åˆå®é™…æƒ…å†µåˆ†æã€‚ å¡«å……æ¨¡å¼ PaddingæŒ‡çš„æ˜¯ï¼šå—åŠ å¯†ç®—æ³•è¦æ±‚åŸæ–‡æ•°æ®é•¿åº¦ä¸ºå›ºå®šå—å¤§å°çš„æ•´æ•°å€ï¼Œå¦‚æœåŸæ–‡æ•°æ®é•¿åº¦å¤§äºå›ºå®šå—å¤§å°ï¼Œåˆ™éœ€è¦åœ¨å›ºå®šå—å¡«å……æ•°æ®ç›´åˆ°æ•´ä¸ªå—çš„æ•°æ®æ˜¯å®Œæ•´çš„ã€‚ä¾‹å¦‚æˆ‘ä»¬çº¦å®šå—çš„é•¿åº¦ä¸º128ï¼Œä½†æ˜¯éœ€è¦åŠ å¯†çš„åŸæ–‡é•¿åº¦ä¸º129ï¼Œé‚£ä¹ˆéœ€è¦åˆ†æˆä¸¤ä¸ªåŠ å¯†å—ï¼Œç¬¬äºŒä¸ªåŠ å¯†å—éœ€è¦å¡«å……127é•¿åº¦çš„æ•°æ®ï¼Œå¡«å……æ¨¡å¼å†³å®šæ€ä¹ˆå¡«å……æ•°æ®ã€‚ å¯¹æ•°æ®åœ¨åŠ å¯†æ—¶è¿›è¡Œå¡«å……ã€è§£å¯†æ—¶å»é™¤å¡«å……åˆ™æ˜¯é€šä¿¡åŒæ–¹éœ€è¦é‡ç‚¹è€ƒè™‘çš„å› ç´ ã€‚å¯¹åŸæ–‡è¿›è¡Œå¡«å……ï¼Œä¸»è¦åŸºäºä»¥ä¸‹åŸå› ï¼š é¦–å…ˆï¼Œè€ƒè™‘å®‰å…¨æ€§ã€‚ç”±äºå¯¹åŸå§‹æ•°æ®è¿›è¡Œäº†å¡«å……ï¼Œä½¿åŸæ–‡èƒ½å¤Ÿâ€œä¼ªè£…â€åœ¨å¡«å……åçš„æ•°æ®ä¸­ï¼Œä½¿å¾—æ”»å‡»è€…å¾ˆéš¾æ‰¾åˆ°çœŸæ­£çš„åŸæ–‡ä½ç½®ã€‚ å…¶æ¬¡ï¼Œç”±äºå—åŠ å¯†ç®—æ³•è¦æ±‚åŸæ–‡æ•°æ®é•¿åº¦ä¸ºå›ºå®šå—å¤§å°çš„æ•´æ•°å€ï¼Œå¦‚æœåŠ å¯†åŸæ–‡ä¸æ»¡è¶³è¿™ä¸ªæ¡ä»¶ï¼Œåˆ™éœ€è¦åœ¨åŠ å¯†å‰å¡«å……åŸæ–‡æ•°æ®è‡³å›ºå®šå—å¤§å°çš„æ•´æ•°å€ã€‚ å¦å¤–ï¼Œå¡«å……ä¹Ÿä¸ºå‘é€æ–¹ä¸æ¥æ”¶æ–¹æä¾›äº†ä¸€ç§æ ‡å‡†çš„å½¢å¼ä»¥çº¦æŸåŠ å¯†åŸæ–‡çš„å¤§å°ã€‚åªæœ‰åŠ è§£å¯†åŒæ–¹çŸ¥é“å¡«å……æ–¹å¼ï¼Œæ‰å¯çŸ¥é“å¦‚ä½•å‡†ç¡®ç§»å»å¡«å……çš„æ•°æ®å¹¶è¿›è¡Œè§£å¯†ã€‚ å¸¸ç”¨çš„å¡«å……æ–¹å¼è‡³å°‘æœ‰5ç§ï¼Œä¸åŒç¼–ç¨‹è¯­è¨€å®ç°åŠ è§£å¯†æ—¶ç”¨åˆ°çš„å¡«å……å¤šæ•°æ¥è‡ªäºè¿™äº›æ–¹å¼æˆ–å®ƒä»¬çš„å˜ç§æ–¹å¼ã€‚ä»¥ä¸‹äº”ç§å¡«å……æ¨¡å¼æ‘˜æŠ„è‡ªå‚è€ƒèµ„æ–™çš„è®ºæ–‡ï¼š 1.å¡«å……æ•°æ®ä¸ºå¡«å……å­—èŠ‚åºåˆ—çš„é•¿åº¦ï¼š è¿™ç§å¡«å……æ–¹å¼ä¸­ï¼Œå¡«å……å­—ç¬¦ä¸²ç”±ä¸€ä¸ªå­—èŠ‚åºåˆ—ç»„æˆï¼Œæ¯ä¸ªå­—èŠ‚å¡«å……è¯¥å­—èŠ‚åºåˆ—çš„é•¿åº¦ã€‚å‡å®šå—é•¿åº¦ä¸º8ï¼ŒåŸæ–‡æ•°æ®é•¿åº¦ä¸º9ï¼Œåˆ™å¡«å……å­—èŠ‚æ•° ç­‰äº0x07ï¼›å¦‚æœæ˜æ–‡æ•°æ®é•¿åº¦ä¸º8çš„æ•´æ•°å€ï¼Œåˆ™å¡«å……å­—èŠ‚æ•°ä¸º0x08ã€‚å¡«å……å­—ç¬¦ä¸²å¦‚ä¸‹ï¼š åŸæ–‡æ•°æ®1: FF FF FF FF FF FF FF FF FF å¡«å……åæ•°æ®1:FF FF FF FF FF FF FF FF FF 07 07 07 07 07 07 07 ========================================================== åŸæ–‡æ•°æ®2:FF FF FF FF FF FF FF FF å¡«å……åæ•°æ®2:FF FF FF FF FF FF FF FF 08 08 08 08 08 08 08 08 2.å¡«å……æ•°æ®ä¸º0x80ååŠ 0x00ï¼š è¿™ç§å¡«å……æ–¹å¼ä¸­ï¼Œå¡«å……å­—ç¬¦ä¸²çš„ç¬¬ä¸€ä¸ªå­—èŠ‚æ•°æ˜¯0x80ï¼Œåé¢çš„æ¯ä¸ªå­—èŠ‚æ˜¯0x00ã€‚å‡å®šå—é•¿åº¦ä¸º8ï¼ŒåŸæ–‡æ•°æ®é•¿åº¦ä¸º9æˆ–è€…ä¸º8çš„æ•´æ•°å€ï¼Œåˆ™ å¡«å……å­—ç¬¦ä¸²å¦‚ä¸‹ï¼š åŸæ–‡æ•°æ®1: FF FF FF FF FF FF FF FF FF å¡«å……åæ•°æ®1:FF FF FF FF FF FF FF FF FF 80 00 00 00 00 00 00 ========================================================== åŸæ–‡æ•°æ®2:FF FF FF FF FF FF FF FF å¡«å……åæ•°æ®2:FF FF FF FF FF FF FF FF 80 00 00 00 00 00 00 00 3.å¡«å……æ•°æ®çš„æœ€åä¸€ä¸ªå­—èŠ‚ä¸ºå¡«å……å­—èŠ‚åºåˆ—çš„é•¿åº¦ï¼š è¿™ç§å¡«å……æ–¹å¼ä¸­ï¼Œå¡«å……å­—ç¬¦ä¸²çš„æœ€åä¸€ä¸ªå­—èŠ‚ä¸ºè¯¥åºåˆ—çš„é•¿åº¦ï¼Œè€Œå‰é¢çš„å­—èŠ‚å¯ä»¥æ˜¯0x00ï¼Œä¹Ÿå¯ä»¥æ˜¯éšæœºçš„å­—èŠ‚åºåˆ—ã€‚å‡å®šå—é•¿åº¦ä¸º8ï¼ŒåŸæ–‡æ•°æ®é•¿åº¦ä¸º9æˆ–è€…ä¸º8çš„æ•´æ•°å€ï¼Œåˆ™å¡«å……å­—ç¬¦ä¸²å¦‚ä¸‹ï¼š åŸæ–‡æ•°æ®1:FF FF FF FF FF FF FF FF FF å¡«å……åæ•°æ®1:FF FF FF FF FF FF FF FF FF 00 00 00 00 00 00 07æˆ–FF FF FF FF FF FF FF FF FF 0A B0 0C 08 05 09 07 =============================================================================== åŸæ–‡æ•°æ®2:FF FF FF FF FF FF FF FF å¡«å……åæ•°æ®2:FF FF FF FF FF FF FF FF 00 00 00 00 00 00 00 08æˆ–FF FF FF FF FF FF FF FF 80 06 AB EA 03 02 01 08 4.å¡«å……æ•°æ®ä¸ºç©ºæ ¼ï¼š è¿™ç§å¡«å……æ–¹å¼ä¸­ï¼Œå¡«å……å­—ç¬¦ä¸²çš„æ¯ä¸ªå­—èŠ‚ä¸ºç©ºæ ¼å¯¹åº”çš„å­—èŠ‚æ•°0x20ã€‚å‡å®šå—é•¿åº¦ä¸º8ï¼ŒåŸæ–‡æ•°æ®é•¿åº¦ä¸º9æˆ–è€…ä¸º8çš„æ•´æ•°å€ï¼Œåˆ™å¡«å……å­—ç¬¦ä¸²å¦‚ä¸‹ï¼š åŸæ–‡æ•°æ®1: FF FF FF FF FF FF FF FF FF å¡«å……åæ•°æ®1:FF FF FF FF FF FF FF FF FF 20 20 20 20 20 20 20 =============================================================================== åŸæ–‡æ•°æ®2:FF FF FF FF FF FF FF FF å¡«å……åæ•°æ®2:FF FF FF FF FF FF FF FF 20 20 20 20 20 20 20 20 5.å¡«å……æ•°æ®ä¸º0x00ï¼š è¿™ç§å¡«å……æ–¹å¼ä¸­ï¼Œå¡«å……å­—ç¬¦ä¸²çš„æ¯ä¸ªå­—èŠ‚ä¸º0x00ã€‚å‡å®šå—é•¿åº¦ä¸º8ï¼ŒåŸæ–‡æ•°æ®é•¿åº¦ä¸º9æˆ–è€…8çš„æ•´æ•°å€ï¼Œåˆ™å¡«å……å­—ç¬¦ä¸²å¦‚ä¸‹ï¼š åŸæ–‡æ•°æ®1: FF FF FF FF FF FF FF FF FF å¡«å……åæ•°æ®1:FF FF FF FF FF FF FF FF FF 00 00 00 00 00 00 00 =============================================================================== åŸæ–‡æ•°æ®2:FF FF FF FF FF FF FF FF å¡«å……åæ•°æ®2:FF FF FF FF FF FF FF FF 00 00 00 00 00 00 00 00 transformationå°ç»“ SunJCE Provideræ”¯æŒçš„Cipherçš„éƒ¨åˆ†è¯¦ç»†ä¿¡æ¯å¦‚ä¸‹ï¼š algorithm(ç®—æ³•) mode(å·¥ä½œæ¨¡å¼) padding(å¡«å……æ¨¡å¼) AES EBCã€CBCã€PCBCã€CTRã€CTSã€CFBã€CFB8-CFB128ç­‰ NoPaddingã€ISO10126Paddingã€PKCS5Padding AESWrap EBC NoPadding ARCFOUR EBC NoPadding Blowfishã€DESã€DESedeã€RC2 EBCã€CBCã€PCBCã€CTRã€CTSã€CFBã€CFB8-CFB128ç­‰ NoPaddingã€ISO10126Paddingã€PKCS5Padding DESedeWrap CBC NoPadding PBEWithMD5AndDESã€PBEWithMD5AndTripleDESã€PBEWithSHA1AndDESedeã€PBEWithSHA1AndRC2_40 CBC PKCS5Padding RSA ECBã€NONE NoPaddingã€PKCS1Paddingç­‰ JavaåŸç”Ÿæ”¯æŒçš„Padding(Cipher)æ±‡æ€»å¦‚ä¸‹ï¼š å¡«å……æ¨¡å¼ æè¿° NoPadding ä¸é‡‡ç”¨å¡«å……æ¨¡å¼ ISO10126Padding XMLåŠ å¯†è¯­æ³•å’Œå¤„ç†æ–‡æ¡£ä¸­æœ‰è¯¦ç»†æè¿° OAEPPadding, OAEPWith&lt;digest&gt;And&lt;mgf&gt;Padding PKCS1ä¸­å®šä¹‰çš„æœ€ä¼˜éå¯¹ç§°åŠ å¯†å¡«å……æ–¹æ¡ˆï¼Œdigestä»£è¡¨æ¶ˆæ¯æ‘˜è¦ç±»å‹ï¼Œmgfä»£è¡¨æ©ç ç”Ÿæˆå‡½æ•°ï¼Œä¾‹å¦‚ï¼šOAEPWithMD5AndMGF1Paddingæˆ–è€…OAEPWithSHA-512AndMGF1Padding PKCS1Padding PKCS1ï¼ŒRSAç®—æ³•ä½¿ç”¨ PKCS5Padding PKCS5ï¼ŒRSAç®—æ³•ä½¿ç”¨ SSL3Padding è§SSL Protocol Version 3.0çš„å®šä¹‰ å…¶ä»–Paddingéœ€è¦ç¬¬ä¸‰æ–¹Provideræä¾›ã€‚ Cipherçš„å±æ€§å’Œæ–¹æ³• Cipherçš„ä¸ƒä¸ªä¸»è¦å…¬æœ‰å±æ€§ 1ã€ENCRYPT_MODEï¼Œæ•´å‹å€¼1ï¼ŒåŠ å¯†æ¨¡å¼ï¼Œç”¨äºCipherçš„åˆå§‹åŒ–ã€‚ 2ã€DECRYPT_MODEï¼Œæ•´å‹å€¼2ï¼Œè§£å¯†æ¨¡å¼ï¼Œç”¨äºCipherçš„åˆå§‹åŒ–ã€‚ 3ã€WRAP_MODEï¼Œæ•´å‹å€¼3ï¼ŒåŒ…è£…å¯†é’¥æ¨¡å¼ï¼Œç”¨äºCipherçš„åˆå§‹åŒ–ã€‚ 4ã€UNWRAP_MODEï¼Œæ•´å‹å€¼4ï¼Œè§£åŒ…è£…å¯†é’¥æ¨¡å¼ï¼Œç”¨äºCipherçš„åˆå§‹åŒ–ã€‚ 5ã€PUBLIC_KEYï¼Œæ•´å‹å€¼1ï¼Œè§£åŒ…è£…å¯†é’¥æ¨¡å¼ä¸‹æŒ‡å®šå¯†é’¥ç±»å‹ä¸ºå…¬é’¥ã€‚ 6ã€PRIVATE_KEYï¼Œæ•´å‹å€¼2ï¼Œè§£åŒ…è£…å¯†é’¥æ¨¡å¼ä¸‹æŒ‡å®šå¯†é’¥ç±»å‹ä¸ºç§é’¥ã€‚ 7ã€SECRET_KEYï¼Œæ•´å‹å€¼3ï¼Œè§£åŒ…è£…å¯†é’¥æ¨¡å¼ä¸‹æŒ‡å®šå¯†é’¥ç±»å‹ä¸ºå¯†é’¥ï¼Œä¸»è¦ç”¨äºä¸æ˜¯éå¯¹ç§°åŠ å¯†çš„å¯†é’¥(åªæœ‰ä¸€ä¸ªå¯†é’¥ï¼Œä¸åŒ…å«ç§é’¥å’Œå…¬é’¥)ã€‚ getInstanceæ–¹æ³• Cipheræä¾›ä¸‰ä¸ªé™æ€å·¥å‚æ–¹æ³•getInstance()ç”¨äºæ„å»ºå…¶å®ä¾‹ï¼Œä¸‰ä¸ªæ–¹æ³•å¦‚ä¸‹ï¼š 1234567891011121314public static final Cipher getInstance(String transformation) throws NoSuchAlgorithmException, NoSuchPaddingExceptionpublic static final Cipher getInstance(String transformation, String provider) throws NoSuchAlgorithmException, NoSuchProviderException, NoSuchPaddingExceptionpublic static final Cipher getInstance(String transformation, Provider provider) throws NoSuchAlgorithmException, NoSuchPaddingException å…¶ä¸­transformationï¼Œè¿™é‡Œç§°ä¸ºè½¬æ¢(æ¨¡å¼)ï¼Œæ˜¯æ ¸å¿ƒå‚æ•°ï¼Œè§å‰é¢ä¸€ä¸ªå°èŠ‚çš„è§£æã€‚å¦å¤–ï¼Œæœ‰ä¸¤ä¸ªå·¥å‚æ–¹æ³•è¦æ±‚å¿…é¡»ä¼ å…¥java.security.Providerçš„å…¨ç±»åæˆ–è€…å®ä¾‹ï¼Œå› ä¸ºCipherè¦ä»å¯¹åº”çš„æä¾›å•†ä¸­è·å–æŒ‡å®šè½¬æ¢æ¨¡å¼çš„å®ç°ï¼Œç¬¬ä¸€ä¸ªå·¥å‚æ–¹æ³•åªæœ‰å•å‚æ•°transformationï¼Œå®ƒä¼šä»ç°æˆæ‰€æœ‰çš„java.security.Providerä¸­åŒ¹é…å–å‡ºç¬¬ä¸€ä¸ªæ»¡è¶³transformationçš„æœåŠ¡ï¼Œä»ä¸­å®ä¾‹åŒ–CipherSpi(è¦ç†è§£Cipherå§”æ‰˜åˆ°å†…éƒ¨æŒæœ‰çš„CipherSpiå®ä¾‹å®Œæˆå…·ä½“çš„åŠ è§£å¯†åŠŸèƒ½)ã€‚å®é™…ä¸ŠCipherå®ä¾‹çš„åˆå§‹åŒ–å¿…é¡»ä¾èµ–äºè½¬æ¢æ¨¡å¼å’Œæä¾›å•†ã€‚ initæ–¹æ³• init()æ–¹æ³•ä¸€å…±æœ‰å…«ä¸ªå˜ä½“æ–¹æ³•ï¼Œæ­¤æ–¹æ³•ä¸»è¦ç”¨äºåˆå§‹åŒ–Cipherã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051//é¢å¤–å‚æ•°æ˜¯Key(å¯†é’¥)public final void init(int opmode, Key key) throws InvalidKeyException//é¢å¤–å‚æ•°æ˜¯Key(å¯†é’¥)å’ŒSecureRandom(éšæœºæº)public final void init(int opmode, Key key, SecureRandom random) throws InvalidKeyException//é¢å¤–å‚æ•°æ˜¯Key(å¯†é’¥)å’ŒAlgorithmParameterSpec(ç®—æ³•å‚æ•°é€æ˜å®šä¹‰)public final void init(int opmode, Key key, AlgorithmParameterSpec params) throws InvalidKeyException, InvalidAlgorithmParameterException //é¢å¤–å‚æ•°æ˜¯Key(å¯†é’¥)ã€AlgorithmParameterSpec(ç®—æ³•å‚æ•°é€æ˜å®šä¹‰)å’ŒSecureRandom(éšæœºæº)public final void init(int opmode, Key key, AlgorithmParameterSpec params, SecureRandom random) throws InvalidKeyException, InvalidAlgorithmParameterException//é¢å¤–å‚æ•°æ˜¯Key(å¯†é’¥)ã€AlgorithmParameters(ç®—æ³•å‚æ•°)public final void init(int opmode, Key key, AlgorithmParameters params) throws InvalidKeyException, InvalidAlgorithmParameterException//é¢å¤–å‚æ•°æ˜¯Key(å¯†é’¥)ã€AlgorithmParameters(ç®—æ³•å‚æ•°)ã€SecureRandom(éšæœºæº)public final void init(int opmode, Key key, AlgorithmParameters params, SecureRandom random) throws InvalidKeyException, InvalidAlgorithmParameterException//é¢å¤–å‚æ•°æ˜¯Certificate(è¯ä¹¦)public final void init(int opmode, Certificate certificate) throws InvalidKeyException//é¢å¤–å‚æ•°æ˜¯Certificate(è¯ä¹¦)ã€SecureRandom(éšæœºæº)public final void init(int opmode, Certificate certificate, SecureRandom random) throws InvalidKeyException opmode(æ“ä½œæ¨¡å¼)æ˜¯å¿…é¡»å‚æ•°ï¼Œå¯é€‰å€¼æ˜¯ENCRYPT_MODEã€DECRYPT_MODEã€WRAP_MODEå’ŒUNWRAP_MODEã€‚Keyç±»å‹å‚æ•°å¦‚æœä¸æ˜¯éå¯¹ç§°åŠ å¯†ï¼Œå¯¹åº”çš„ç±»å‹æ˜¯SecretKeyï¼Œå¦‚æœæ˜¯éå¯¹ç§°åŠ å¯†ï¼Œå¯ä»¥æ˜¯PublicKeyæˆ–è€…PrivateKeyã€‚SecureRandomæ˜¯éšæœºæºï¼Œå› ä¸ºæœ‰äº›ç®—æ³•éœ€è¦æ¯æ¬¡åŠ å¯†ç»“æœéƒ½ä¸ç›¸åŒï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦ä¾èµ–ç³»ç»Ÿæˆ–è€…ä¼ å…¥çš„éšæœºæºï¼Œä¸€äº›è¦æ±‚æ¯æ¬¡åŠ è§£å¯†ç»“æœç›¸åŒçš„ç®—æ³•å¦‚AESä¸èƒ½ä½¿ç”¨æ­¤å‚æ•°ã€‚Certificateæ˜¯å¸¦æœ‰å¯†é’¥çš„è¯ä¹¦å®ç°ã€‚ç®—æ³•å‚æ•°ä¸»è¦åŒ…æ‹¬IV(initialization vectorï¼Œåˆå§‹åŒ–å‘é‡)ç­‰ç­‰ã€‚ wrapæ–¹æ³•å’Œunwrapæ–¹æ³• wrapæ–¹æ³•ç”¨äºåŒ…è£…ä¸€ä¸ªå¯†é’¥ã€‚ 123public final byte[] wrap(Key key) throws IllegalBlockSizeException, InvalidKeyException wrapæ–¹æ³•ä½¿ç”¨çš„æ—¶å€™éœ€è¦æ³¨æ„Cipherçš„opmodeè¦åˆå§‹åŒ–ä¸ºWRAP_MODEã€‚ unwrapæ–¹æ³•ç”¨äºè§£åŒ…è£…ä¸€ä¸ªå¯†é’¥ã€‚ 12345public final Key unwrap(byte[] wrappedKey, String wrappedKeyAlgorithm, int wrappedKeyType) throws InvalidKeyException, NoSuchAlgorithmException unwrapæ–¹æ³•ä½¿ç”¨çš„æ—¶å€™éœ€è¦æ³¨æ„Cipherçš„opmodeè¦åˆå§‹åŒ–ä¸ºUNWRAP_MODEï¼Œåœ¨è°ƒç”¨unwrapæ–¹æ³•æ—¶å€™ï¼Œéœ€è¦æŒ‡å®šä¹‹å‰åŒ…è£…å¯†é’¥çš„ç®—æ³•å’ŒKeyçš„ç±»å‹ã€‚ å…¶å®wrapå’Œunwrapæ˜¯ä¸€ä¸ªäº’é€†çš„æ“ä½œï¼š wrapæ–¹æ³•çš„ä½œç”¨æ˜¯æŠŠåŸå§‹çš„å¯†é’¥é€šè¿‡æŸç§åŠ å¯†ç®—æ³•åŒ…è£…ä¸ºåŠ å¯†åçš„å¯†é’¥ï¼Œè¿™æ ·å°±å¯ä»¥é¿å…åœ¨ä¼ é€’å¯†é’¥çš„æ—¶å€™æ³„æ¼äº†å¯†é’¥çš„æ˜æ–‡ã€‚ unwrapæ–¹æ³•çš„ä½œç”¨æ˜¯æŠŠåŒ…è£…(åŠ å¯†)åçš„å¯†é’¥è§£åŒ…è£…ä¸ºåŸå§‹çš„å¯†é’¥ï¼Œå¾—åˆ°å¯†é’¥çš„æ˜æ–‡ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041public enum EncryptUtils &#123; /** * å•ä¾‹ */ SINGLETON; private static final String SECRECT = \"passwrod\"; public String wrap(String keyString) throws Exception &#123; KeyGenerator keyGenerator = KeyGenerator.getInstance(\"AES\"); //åˆå§‹åŒ–å¯†é’¥ç”Ÿæˆå™¨ï¼ŒæŒ‡å®šå¯†é’¥é•¿åº¦ä¸º128ï¼ŒæŒ‡å®šéšæœºæºçš„ç§å­ä¸ºæŒ‡å®šçš„å¯†é’¥(è¿™é‡Œæ˜¯\"passward\") keyGenerator.init(128, new SecureRandom(SECRECT.getBytes())); SecretKey secretKey = keyGenerator.generateKey(); SecretKeySpec secretKeySpec = new SecretKeySpec(secretKey.getEncoded(), \"AES\"); Cipher cipher = Cipher.getInstance(\"AES\"); cipher.init(Cipher.WRAP_MODE, secretKeySpec); SecretKeySpec key = new SecretKeySpec(keyString.getBytes(), \"AES\"); byte[] bytes = cipher.wrap(key); return Hex.encodeHexString(bytes); &#125; public String unwrap(String keyString) throws Exception &#123; byte[] rawKey = Hex.decodeHex(keyString); KeyGenerator keyGenerator = KeyGenerator.getInstance(\"AES\"); //åˆå§‹åŒ–å¯†é’¥ç”Ÿæˆå™¨ï¼ŒæŒ‡å®šå¯†é’¥é•¿åº¦ä¸º128ï¼ŒæŒ‡å®šéšæœºæºçš„ç§å­ä¸ºæŒ‡å®šçš„å¯†é’¥(è¿™é‡Œæ˜¯\"passward\") keyGenerator.init(128, new SecureRandom(SECRECT.getBytes())); SecretKey secretKey = keyGenerator.generateKey(); SecretKeySpec secretKeySpec = new SecretKeySpec(secretKey.getEncoded(), \"AES\"); Cipher cipher = Cipher.getInstance(\"AES\"); cipher.init(Cipher.UNWRAP_MODE, secretKeySpec); SecretKey key = (SecretKey) cipher.unwrap(rawKey, \"AES\", Cipher.SECRET_KEY); return new String(key.getEncoded()); &#125; public static void main(String[] args) throws Exception &#123; String wrapKey = EncryptUtils.SINGLETON.wrap(\"doge\"); System.out.println(wrapKey); System.out.println(EncryptUtils.SINGLETON.unwrap(wrapKey)); &#125;&#125; ä¸Šé¢çš„ä¾‹å­æ˜¯é€šè¿‡AESå¯¹å¯†é’¥è¿›è¡ŒåŒ…è£…å’Œè§£åŒ…è£…ï¼Œè°ƒç”¨mainæ–¹æ³•ï¼Œè¾“å‡ºï¼š 1277050742188d4b97a1d401db902b864ddoge updateæ–¹æ³• updateæ–¹æ³•æœ‰å¤šä¸ªå˜ä½“ï¼Œå…¶å®æ„ä¹‰ç›¸å·®æ— å‡ ï¼š 123456789101112131415public final byte[] update(byte[] input)public final byte[] update(byte[] input, int inputOffset, int inputLen)public final int update(byte[] input, int inputOffset, int inputLen, byte[] output) throws ShortBufferExceptionpublic final int update(ByteBuffer input, ByteBuffer output) throws ShortBufferException updateæ–¹æ³•ä¸»è¦ç”¨äºéƒ¨åˆ†åŠ å¯†æˆ–è€…éƒ¨åˆ†è§£å¯†ï¼Œè‡³äºåŠ å¯†æˆ–æ˜¯è§£å¯†å–å†³äºCipheråˆå§‹åŒ–æ—¶å€™çš„opmodeã€‚å³ä½¿å®ƒæœ‰å¤šä¸ªå˜ä½“ï¼Œä½†æ˜¯å¥—è·¯æ˜¯ä¸€æ ·çš„ï¼šä¾èµ–äºä¸€ä¸ªè¾“å…¥çš„ç¼“å†²åŒº(å¸¦æœ‰éœ€è¦è¢«åŠ å¯†æˆ–è€…è¢«è§£å¯†çš„æ•°æ®)ã€è¿”å›å€¼æˆ–è€…å‚æ•°æ˜¯ä¸€ä¸ªè¾“å‡ºçš„ç¼“å†²åŒºï¼Œä¸€äº›é¢å¤–çš„å‚æ•°å¯ä»¥é€šè¿‡åç§»é‡å’Œé•¿åº¦æ§åˆ¶åŠ å¯†æˆ–è€…è§£å¯†æ“ä½œçš„æ•°æ®æ®µã€‚éƒ¨åˆ†åŠ å¯†æˆ–è€…è§£å¯†æ“ä½œå®Œæ¯•åï¼Œå¿…é¡»è¦è°ƒç”¨Cipher#doFinal()æ–¹æ³•æ¥ç»“æŸåŠ å¯†æˆ–è€…è§£å¯†æ“ä½œã€‚ doFinalæ–¹æ³• doFinal()æ–¹æ³•ä¹Ÿå­˜åœ¨å¤šä¸ªå˜ä½“ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374757677/** * ç»“æŸå¤šéƒ¨åˆ†åŠ å¯†æˆ–è€…è§£å¯†æ“ä½œã€‚ * æ­¤æ–¹æ³•éœ€è¦åœ¨updateè°ƒç”¨é“¾æ‰§è¡Œå®Œæ¯•ä¹‹åè°ƒç”¨ï¼Œè¿”å›çš„ç»“æœæ˜¯åŠ å¯†æˆ–è€…è§£å¯†ç»“æœçš„ä¸€éƒ¨åˆ†ã€‚ * æ­¤æ–¹æ³•æ­£å¸¸è°ƒç”¨ç»“æŸä¹‹åCipherä¼šé‡ç½®ä¸ºåˆå§‹åŒ–çŠ¶æ€ã€‚ */public final byte[] doFinal() throws IllegalBlockSizeException, BadPaddingException/** * ç»“æŸå¤šéƒ¨åˆ†åŠ å¯†æˆ–è€…è§£å¯†æ“ä½œã€‚ * æ­¤æ–¹æ³•éœ€è¦åœ¨updateè°ƒç”¨é“¾æ‰§è¡Œå®Œæ¯•ä¹‹åè°ƒç”¨ï¼Œä¼ å…¥çš„outputä½œä¸ºç¼“å†²åŒºæ¥æ”¶åŠ å¯†æˆ–è€…è§£å¯†ç»“æœçš„ä¸€éƒ¨åˆ†ã€‚ * æ­¤æ–¹æ³•æ­£å¸¸è°ƒç”¨ç»“æŸä¹‹åCipherä¼šé‡ç½®ä¸ºåˆå§‹åŒ–çŠ¶æ€ã€‚ */public final int doFinal(byte[] output, int outputOffset) throws IllegalBlockSizeException, ShortBufferException, BadPaddingException /** * ç»“æŸå•éƒ¨åˆ†åŠ å¯†æˆ–è€…è§£å¯†æ“ä½œã€‚ * æ­¤æ–¹æ³•æ¥æ”¶éœ€è¦åŠ å¯†æˆ–è€…è§£å¯†çš„å®Œæ•´æŠ¥æ–‡ï¼Œè¿”å›å¤„ç†ç»“æœ * æ­¤æ–¹æ³•æ­£å¸¸è°ƒç”¨ç»“æŸä¹‹åCipherä¼šé‡ç½®ä¸ºåˆå§‹åŒ–çŠ¶æ€ã€‚ */public final byte[] doFinal(byte[] input) throws IllegalBlockSizeException, BadPaddingException/** * ç»“æŸå•éƒ¨åˆ†æˆ–è€…å¤šéƒ¨åˆ†åŠ å¯†æˆ–è€…è§£å¯†æ“ä½œã€‚ * å‚æ•°inputOffsetä¸ºéœ€è¦åŠ è§£å¯†çš„æŠ¥æ–‡byteæ•°ç»„çš„èµ·å§‹ä½ç½®ï¼ŒinputLenä¸ºéœ€è¦åŠ å¯†æˆ–è€…è§£å¯†çš„å­—èŠ‚é•¿åº¦ * æ­¤æ–¹æ³•æ­£å¸¸è°ƒç”¨ç»“æŸä¹‹åCipherä¼šé‡ç½®ä¸ºåˆå§‹åŒ–çŠ¶æ€ã€‚ */public final byte[] doFinal(byte[] input, int inputOffset, int inputLen) throws IllegalBlockSizeException, BadPaddingException /** * ç»“æŸå•éƒ¨åˆ†æˆ–è€…å¤šéƒ¨åˆ†åŠ å¯†æˆ–è€…è§£å¯†æ“ä½œã€‚ * å‚æ•°inputOffsetä¸ºéœ€è¦åŠ è§£å¯†çš„æŠ¥æ–‡byteæ•°ç»„çš„èµ·å§‹ä½ç½®ï¼ŒinputLenä¸ºéœ€è¦åŠ å¯†æˆ–è€…è§£å¯†çš„å­—èŠ‚é•¿åº¦ï¼Œoutputç”¨äºæ¥æ”¶åŠ è§£å¯†çš„ç»“æœ * æ­¤æ–¹æ³•æ­£å¸¸è°ƒç”¨ç»“æŸä¹‹åCipherä¼šé‡ç½®ä¸ºåˆå§‹åŒ–çŠ¶æ€ã€‚ */public final int doFinal(byte[] input, int inputOffset, int inputLen, byte[] output) throws ShortBufferException, IllegalBlockSizeException, BadPaddingException /** * ç»“æŸå•éƒ¨åˆ†æˆ–è€…å¤šéƒ¨åˆ†åŠ å¯†æˆ–è€…è§£å¯†æ“ä½œã€‚ * å‚æ•°inputOffsetä¸ºéœ€è¦åŠ è§£å¯†çš„æŠ¥æ–‡byteæ•°ç»„çš„èµ·å§‹ä½ç½®ï¼ŒinputLenä¸ºéœ€è¦åŠ å¯†æˆ–è€…è§£å¯†çš„å­—èŠ‚é•¿åº¦ï¼Œ * outputç”¨äºæ¥æ”¶åŠ è§£å¯†çš„ç»“æœï¼ŒoutputOffsetç”¨äºè®¾ç½®outputçš„èµ·å§‹ä½ç½® * æ­¤æ–¹æ³•æ­£å¸¸è°ƒç”¨ç»“æŸä¹‹åCipherä¼šé‡ç½®ä¸ºåˆå§‹åŒ–çŠ¶æ€ã€‚ */public final int doFinal(byte[] input, int inputOffset, int inputLen, byte[] output, int outputOffset) throws ShortBufferException, IllegalBlockSizeException, BadPaddingException /** * ç»“æŸå•éƒ¨åˆ†æˆ–è€…å¤šéƒ¨åˆ†åŠ å¯†æˆ–è€…è§£å¯†æ“ä½œã€‚ * å‚æ•°inputä¸ºè¾“å…¥ç¼“å†²åŒºï¼Œoutputä¸ºè¾“å‡ºç¼“å†²åŒº * æ­¤æ–¹æ³•æ­£å¸¸è°ƒç”¨ç»“æŸä¹‹åCipherä¼šé‡ç½®ä¸ºåˆå§‹åŒ–çŠ¶æ€ã€‚ */public final int doFinal(ByteBuffer input, ByteBuffer output) throws ShortBufferException, IllegalBlockSizeException, BadPaddingException doFinal()ä¸»è¦åŠŸèƒ½æ˜¯ç»“æŸå•éƒ¨åˆ†æˆ–è€…å¤šéƒ¨åˆ†åŠ å¯†æˆ–è€…è§£å¯†æ“ä½œã€‚å•éƒ¨åˆ†åŠ å¯†æˆ–è€…è§£å¯†é€‚ç”¨äºéœ€è¦å¤„ç†çš„æŠ¥æ–‡é•¿åº¦è¾ƒçŸ­æ— éœ€åˆ†å—çš„æƒ…å†µï¼Œè¿™ä¸ªæ—¶å€™ç›´æ¥ä½¿ç”¨byte[] doFinal(byte[] input)æ–¹æ³•å³å¯ã€‚å¤šéƒ¨åˆ†åŠ å¯†æˆ–è€…è§£å¯†é€‚ç”¨äºéœ€è¦å¤„ç†çš„æŠ¥æ–‡é•¿åº¦é•¿åº¦è¾ƒå¤§ï¼Œéœ€è¦è¿›è¡Œåˆ†å—çš„æƒ…å†µï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦è°ƒç”¨å¤šæ¬¡updateæ–¹æ³•å˜ä½“è¿›è¡Œéƒ¨åˆ†å—çš„åŠ è§£å¯†ï¼Œæœ€åè°ƒç”¨doFinalæ–¹æ³•å˜ä½“è¿›è¡Œéƒ¨åˆ†åŠ è§£å¯†æ“ä½œçš„ç»“æŸã€‚ä¸¾ä¸ªä¾‹å­ï¼Œä¾‹å¦‚å¤„ç†å—çš„å¤§å°ä¸º8ï¼Œå®é™…éœ€è¦åŠ å¯†çš„æŠ¥æ–‡é•¿åº¦ä¸º23ï¼Œé‚£ä¹ˆéœ€è¦åˆ†ä¸‰å—è¿›è¡ŒåŠ å¯†ï¼Œå‰é¢2å—é•¿åº¦ä¸º8çš„æŠ¥æ–‡éœ€è¦è°ƒç”¨updateè¿›è¡Œéƒ¨åˆ†åŠ å¯†ï¼Œéƒ¨åˆ†åŠ å¯†çš„ç»“æœå¯ä»¥ä»updateçš„è¿”å›å€¼è·å–åˆ°ï¼Œæœ€åçš„7é•¿åº¦(å…¶å®ä¸€èˆ¬ä¼šå¡«å……åˆ°é•¿åº¦ä¸ºå—é•¿åº¦8)çš„æŠ¥æ–‡åˆ™è°ƒç”¨doFinalè¿›è¡ŒåŠ å¯†ï¼Œç»“æŸæ•´ä¸ªéƒ¨åˆ†åŠ å¯†çš„æ“ä½œã€‚å¦å¤–ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯åªè¦Cipheræ­£å¸¸è°ƒç”¨å®Œä»»ä¸€ä¸ªdoFinalå˜ä½“æ–¹æ³•(è¿‡ç¨‹ä¸­ä¸æŠ›å‡ºå¼‚å¸¸)ï¼Œé‚£ä¹ˆCipherä¼šé‡ç½®ä¸ºåˆå§‹åŒ–çŠ¶æ€ï¼Œå¯ä»¥ç»§ç»­ä½¿ç”¨ï¼Œè¿™ä¸ªå¯å¤ç”¨çš„ç‰¹æ€§å¯ä»¥é™ä½åˆ›å»ºCipherå®ä¾‹çš„æ€§èƒ½æŸè€—ã€‚ updateADDæ–¹æ³• é¦–å…ˆADDçš„æ„æ€æ˜¯Additional Authentication Data(é¢å¤–çš„èº«ä»½è®¤è¯æ•°æ®)ã€‚updateADD()ä¹Ÿæœ‰ä¸‰ä¸ªæ–¹æ³•å˜ä½“ï¼š 1234567public final void updateAAD(byte[] src)public final void updateAAD(byte[] src, int offset, int len)public final void updateAAD(ByteBuffer src) å®ƒçš„æ–¹æ³•å˜ä½“éƒ½åªä¾èµ–ä¸€ä¸ªè¾“å…¥ç¼“å†²åŒºï¼Œå¸¦æœ‰é¢å¤–çš„èº«ä»½è®¤è¯æ•°æ®ï¼Œä¸€èˆ¬ä½¿ç”¨åœ¨GCMæˆ–è€…CCMåŠ è§£å¯†ç®—æ³•ä¸­ã€‚å¦‚æœä½¿ç”¨æ­¤æ–¹æ³•ï¼Œå®ƒçš„è°ƒç”¨å¿…é¡»åœ¨Cipherçš„updateå’ŒdoFinalå˜ä½“æ–¹æ³•ä¹‹å‰è°ƒç”¨ï¼Œå…¶å®ç†è§£èµ·æ¥ä¹Ÿå¾ˆç®€å•ï¼Œèº«ä»½éªŒè¯å¿…é¡»åœ¨å®é™…çš„åŠ è§£å¯†æ“ä½œä¹‹å‰è¿›è¡Œã€‚ç›®å‰ï¼ŒupdateADDçš„èµ„æ–™æ¯”è¾ƒå°‘ï¼Œç¬”è€…åœ¨ç”Ÿäº§ç¯å¢ƒæ‰¾é‚£ä¸ªä¹Ÿå°šæœªå®è·µè¿‡ï¼Œæ‰€ä»¥ä¸åšå±•å¼€åˆ†æã€‚ å…¶ä»–æ–¹æ³• å…¶ä»–æ–¹æ³•ä¸»è¦æ˜¯Getteræ–¹æ³•ï¼Œç”¨äºè·å–Cipherçš„ç›¸å…³ä¿¡æ¯ã€‚ public final Provider getProvider()ï¼šè·å–Cipherçš„æä¾›å•†ã€‚ public final String getAlgorithm()ï¼šè·å–Cipherä½¿ç”¨çš„ç®—æ³•åç§°ã€‚ public final int getBlockSize()ï¼šåˆ†ç»„åŠ å¯†ä¸­ï¼Œæ¯ä¸€ç»„éƒ½æœ‰å›ºå®šçš„é•¿åº¦ï¼Œä¹Ÿç§°ä¸ºå—ï¼Œæ­¤æ–¹æ³•æ˜¯è¿”å›å—çš„å¤§å°ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚ public final int getOutputSize(int inputLen)ï¼šæ ¹æ®ç»™å®šçš„è¾“å…¥é•¿åº¦inputLenï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ï¼Œè¿”å›ä¿å­˜ä¸‹ä¸€ä¸ªupdateæˆ–doFinalæ“ä½œç»“æœæ‰€éœ€çš„è¾“å‡ºç¼“å†²åŒºé•¿åº¦ï¼ˆä»¥å­—èŠ‚ä¸ºå•ä½ï¼‰ã€‚ public final byte[] getIV()ï¼šè¿”å›Cipherä¸­çš„åˆå§‹åŒ–å‘é‡çš„å­—èŠ‚æ•°ç»„ã€‚ public final AlgorithmParameters getParameters()ï¼šè¿”å›Cipherä½¿ç”¨çš„ç®—æ³•å‚æ•°ã€‚ public final ExemptionMechanism getExemptionMechanism()ï¼šè¿”å›Cipherä½¿ç”¨çš„è±å…(exemption)æœºåˆ¶å¯¹è±¡ã€‚ public static final int getMaxAllowedKeyLength(String transformation)ï¼šæ ¹æ®æ‰€å®‰è£…çš„JCEç­–ç•¥æ–‡ä»¶ï¼Œè¿”å›æŒ‡å®šè½¬æ¢çš„æœ€å¤§å¯†é’¥é•¿åº¦ã€‚ public static final AlgorithmParameterSpec getMaxAllowedParameterSpec(String transformation)ï¼šæ ¹æ®JCEç­–ç•¥æ–‡ä»¶ï¼Œè¿”å›CipheræŒ‡å®štransformationä¸‹æœ€å¤§çš„AlgorithmParameterSpecå¯¹è±¡ã€‚ Cipherçš„å·¥ä½œæµç¨‹ ä¸‹é¢ç”»ä¸€ä¸ªå›¾æ¥è¯¦ç»†åˆ†æä¸€ä¸‹Cipherçš„å·¥ä½œæµç¨‹ï¼š å½“ç„¶ä¸Šå›¾åªåˆ†æäº†Cipherçš„ä½¿ç”¨è¿‡ç¨‹ï¼Œå…¶å®è¿˜æœ‰ä¸€ä¸ªé‡è¦çš„æ­¥éª¤å°±æ˜¯å¯†é’¥çš„å¤„ç†ï¼Œä½†æ˜¯å¯†é’¥çš„å¤„ç†å’Œå…·ä½“çš„ç®—æ³•ä½¿ç”¨æ˜¯ç›¸å…³çš„ï¼Œæ‰€ä»¥å›¾ä¸­æ²¡æœ‰ä½“ç°ã€‚å†æ”¾ä¸€å¼ å®˜æ–¹æè¿°CipheråŠ è½½çš„æµç¨‹ï¼š ä¸»è¦è¿‡ç¨‹åŒ…æ‹¬ï¼š 1ã€åˆ›å»ºCipherå®ä¾‹ï¼Œè¿™ä¸ªæ—¶å€™ä¼šä»å¹³å°ä¸­æ‰€æœ‰çš„æä¾›å•†(Provider)ä¸­æ ¹æ®transformationåŒ¹é…ç¬¬ä¸€ä¸ªå¯ä»¥ä½¿ç”¨çš„CipherSpiå®ä¾‹ï¼Œ&quot;ç®—æ³•/å·¥ä½œæ¨¡å¼/å¡«å……æ¨¡å¼&quot;å¿…é¡»å®Œå…¨åŒ¹é…æ‰èƒ½é€‰ä¸­ã€‚ åœ¨${JAVA_HONE}/jre/lib/securityä¸­çš„java.securityæ–‡ä»¶ä¸­å¯ä»¥çœ‹åˆ°é»˜è®¤åŠ è½½çš„æä¾›å•†ã€‚å¦‚æœéœ€è¦æ·»åŠ é¢å¤–æˆ–è€…è‡ªå®ç°çš„Providerï¼Œå¯ä»¥é€šè¿‡java.security.Securityçš„é™æ€æ–¹æ³•addProvideræ·»åŠ ã€‚ 2ã€é€šè¿‡Cipherå®ä¾‹çš„initæ–¹æ³•åˆå§‹åŒ–Cipherï¼Œä¸»è¦å‚æ•°æ˜¯opmodeå’Œå¯†é’¥ã€‚ 3ã€æ ¹æ®åˆå§‹åŒ–çš„æ–¹å¼å’Œæ˜¯å¦éœ€è¦åˆ†ç»„å¤„ç†ï¼Œé€‰æ‹©åˆé€‚çš„æ–¹æ³•è¿›è¡Œè°ƒç”¨ï¼Œä¸€èˆ¬ä»¥doFinal()æ–¹æ³•ä½œç»“å¾—åˆ°è¿”å›ç»“æœã€‚ Cipherçš„ä½¿ç”¨ ä¸ºäº†æ–¹ä¾¿Cipherçš„ä½¿ç”¨ï¼Œæœ€å¥½å…ˆå¼•å…¥apache-codecä¾èµ–ï¼Œè¿™æ ·èƒ½ç®€åŒ–Hexã€Base64ç­‰æ“ä½œã€‚ 12345&lt;dependency&gt; &lt;groupId&gt;commons-codec&lt;/groupId&gt; &lt;artifactId&gt;commons-codec&lt;/artifactId&gt; &lt;version&gt;1.11&lt;/version&gt;&lt;/dependency&gt; å¤§å¤šæ•°æƒ…å†µä¸‹ï¼ŒåŠ å¯†åçš„byteæ•°ç»„çš„ä¸­å…ƒç´ å–å€¼ä¸åœ¨Unicodeç ç‚¹çš„èŒƒå›´å†…ï¼Œè¡¨é¢ä¸Šçœ‹åˆ°çš„å°±æ˜¯ä¹±ç ï¼Œå®é™…ä¸Šå®ƒä»¬æ˜¯æœ‰æ„ä¹‰çš„ï¼Œå› æ­¤éœ€è¦è€ƒè™‘æŠŠè¿™ç§byteæ•°ç»„è½¬æ¢ä¸ºéä¹±ç çš„å­—ç¬¦ä¸²ä»¥ä¾¿ä¼ è¾“ï¼Œå¸¸è§çš„æ–¹å¼æœ‰Hex(äºŒè¿›åˆ¶è½¬æ¢ä¸ºåå…­è¿›åˆ¶)ã€Base64ç­‰ç­‰ã€‚ä¸‹é¢ä¸¾ä¾‹ä¸­æ²¡æœ‰é’ˆå¯¹å¼‚å¸¸ç±»å‹è¿›è¡Œå¤„ç†ç»Ÿä¸€å¤–æŠ›ï¼Œåˆ‡å‹¿æ¨¡ä»¿ï¼Œè¿˜æœ‰ï¼Œæ‰€æœ‰çš„å­—ç¬¦ä¸²è½¬åŒ–ä¸ºå­—èŠ‚æ•°ç»„éƒ½æ²¡æœ‰æŒ‡å®šå­—ç¬¦ç¼–ç ï¼Œå› æ­¤åªèƒ½ä½¿ç”¨éä¸­æ–‡çš„æ˜æ–‡è¿›è¡Œå¤„ç†ã€‚ åŠ å¯†æ¨¡å¼ åŠ å¯†æ¨¡å¼ä¸‹ï¼ŒCipheråªèƒ½ç”¨äºåŠ å¯†ï¼Œä¸»è¦ç”±init()æ–¹æ³•ä¸­çš„opmodeå†³å®šã€‚ä¸¾ä¸ªä¾‹å­ï¼š 123456789101112131415public String encryptByAes(String content, String password) throws Exception &#123; //è¿™é‡ŒæŒ‡å®šäº†ç®—æ³•ä¸ºAES_128ï¼Œå·¥ä½œæ¨¡å¼ä¸ºEBCï¼Œå¡«å……æ¨¡å¼ä¸ºNoPadding Cipher cipher = Cipher.getInstance(\"AES_128/ECB/NoPadding\"); KeyGenerator keyGenerator = KeyGenerator.getInstance(\"AES\"); //å› ä¸ºAESè¦æ±‚å¯†é’¥çš„é•¿åº¦ä¸º128ï¼Œæˆ‘ä»¬éœ€è¦å›ºå®šçš„å¯†ç ï¼Œå› æ­¤éšæœºæºçš„ç§å­éœ€è¦è®¾ç½®ä¸ºæˆ‘ä»¬çš„å¯†ç æ•°ç»„ keyGenerator.init(128, new SecureRandom(password.getBytes())); SecretKey secretKey = keyGenerator.generateKey(); SecretKeySpec secretKeySpec = new SecretKeySpec(secretKey.getEncoded(), \"AES\"); //åŸºäºåŠ å¯†æ¨¡å¼å’Œå¯†é’¥åˆå§‹åŒ–Cipher cipher.init(Cipher.ENCRYPT_MODE, secretKeySpec); //å•éƒ¨åˆ†åŠ å¯†ç»“æŸï¼Œé‡ç½®Cipher byte[] bytes = cipher.doFinal(content.getBytes()); //åŠ å¯†åçš„å¯†æ–‡ç”±äºŒè¿›åˆ¶åºåˆ—è½¬åŒ–ä¸ºåå…­è¿›åˆ¶åºåˆ—ï¼Œä¾èµ–apache-codecåŒ… return Hex.encodeHexString(bytes);&#125; å…¶å®æ•´ä¸ªè¿‡ç¨‹Cipherçš„ä½¿ç”¨éƒ½å¾ˆç®€å•ï¼Œæ¯”è¾ƒå¤æ‚çš„åè€Œæ˜¯å¯†é’¥ç”Ÿæˆçš„è¿‡ç¨‹ã€‚ä¸Šé¢çš„ä¾‹å­éœ€è¦æ³¨æ„ï¼Œå› ä¸ºä½¿ç”¨äº†å¡«å……æ¨¡å¼ä¸ºNoPaddingï¼Œè¾“å…¥çš„éœ€è¦åŠ å¯†çš„æŠ¥æ–‡é•¿åº¦å¿…é¡»æ˜¯16(128bit)çš„å€æ•°ã€‚ è§£å¯†æ¨¡å¼ è§£å¯†æ¨¡å¼çš„ä½¿ç”¨å¤§è‡´å’ŒåŠ å¯†æ¨¡å¼æ˜¯ç›¸åŒçš„ï¼ŒæŠŠå¤„ç†è¿‡ç¨‹é€†è½¬è¿‡æ¥å°±è¡Œï¼š 12345678910111213141516public String decryptByAes(String content, String password) throws Exception &#123; //è¿™é‡Œè¦æŠŠåå…­è¿›åˆ¶çš„åºåˆ—è½¬åŒ–å›äºŒè¿›åˆ¶çš„åºåˆ—ï¼Œä¾èµ–apache-codecåŒ… byte[] bytes = Hex.decodeHex(content); //è¿™é‡ŒæŒ‡å®šäº†ç®—æ³•ä¸ºAES_128ï¼Œå·¥ä½œæ¨¡å¼ä¸ºEBCï¼Œå¡«å……æ¨¡å¼ä¸ºNoPadding Cipher cipher = Cipher.getInstance(\"AES_128/ECB/NoPadding\"); KeyGenerator keyGenerator = KeyGenerator.getInstance(\"AES\"); //å› ä¸ºAESè¦æ±‚å¯†é’¥çš„é•¿åº¦ä¸º128ï¼Œæˆ‘ä»¬éœ€è¦å›ºå®šçš„å¯†ç ï¼Œå› æ­¤éšæœºæºçš„ç§å­éœ€è¦è®¾ç½®ä¸ºæˆ‘ä»¬çš„å¯†ç æ•°ç»„ keyGenerator.init(128, new SecureRandom(password.getBytes())); SecretKey secretKey = keyGenerator.generateKey(); SecretKeySpec secretKeySpec = new SecretKeySpec(secretKey.getEncoded(), \"AES\"); //åŸºäºè§£å¯†æ¨¡å¼å’Œå¯†é’¥åˆå§‹åŒ–Cipher cipher.init(Cipher.DECRYPT_MODE, secretKeySpec); //å•éƒ¨åˆ†åŠ å¯†ç»“æŸï¼Œé‡ç½®Cipher byte[] result = cipher.doFinal(bytes); return new String(result);&#125; ä¸Šé¢çš„ä¾‹å­éœ€è¦æ³¨æ„ï¼Œå› ä¸ºä½¿ç”¨äº†å¡«å……æ¨¡å¼ä¸ºNoPaddingï¼Œè¾“å…¥çš„éœ€è¦åŠ å¯†çš„æŠ¥æ–‡é•¿åº¦å¿…é¡»æ˜¯16(128bit)çš„å€æ•°ã€‚ åŒ…è£…å¯†é’¥æ¨¡å¼å’Œè§£åŒ…è£…å¯†é’¥æ¨¡å¼ å¯†é’¥çš„åŒ…è£…å’Œè§£åŒ…è£…æ¨¡å¼æ˜¯ä¸€å¯¹äº’é€†çš„æ“ä½œï¼Œä¸»è¦ä½œç”¨æ˜¯é€šè¿‡ç®—æ³•å¯¹å¯†é’¥è¿›è¡ŒåŠ è§£å¯†ï¼Œä»è€Œæé«˜å¯†é’¥æ³„æ¼çš„éš¾åº¦ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041public enum EncryptUtils &#123; /** * å•ä¾‹ */ SINGLETON; private static final String SECRECT = \"passwrod\"; public String wrap(String keyString) throws Exception &#123; KeyGenerator keyGenerator = KeyGenerator.getInstance(\"AES\"); //åˆå§‹åŒ–å¯†é’¥ç”Ÿæˆå™¨ï¼ŒæŒ‡å®šå¯†é’¥é•¿åº¦ä¸º128ï¼ŒæŒ‡å®šéšæœºæºçš„ç§å­ä¸ºæŒ‡å®šçš„å¯†é’¥(è¿™é‡Œæ˜¯\"passward\") keyGenerator.init(128, new SecureRandom(SECRECT.getBytes())); SecretKey secretKey = keyGenerator.generateKey(); SecretKeySpec secretKeySpec = new SecretKeySpec(secretKey.getEncoded(), \"AES\"); Cipher cipher = Cipher.getInstance(\"AES\"); cipher.init(Cipher.WRAP_MODE, secretKeySpec); SecretKeySpec key = new SecretKeySpec(keyString.getBytes(), \"AES\"); byte[] bytes = cipher.wrap(key); return Hex.encodeHexString(bytes); &#125; public String unwrap(String keyString) throws Exception &#123; byte[] rawKey = Hex.decodeHex(keyString); KeyGenerator keyGenerator = KeyGenerator.getInstance(\"AES\"); //åˆå§‹åŒ–å¯†é’¥ç”Ÿæˆå™¨ï¼ŒæŒ‡å®šå¯†é’¥é•¿åº¦ä¸º128ï¼ŒæŒ‡å®šéšæœºæºçš„ç§å­ä¸ºæŒ‡å®šçš„å¯†é’¥(è¿™é‡Œæ˜¯\"passward\") keyGenerator.init(128, new SecureRandom(SECRECT.getBytes())); SecretKey secretKey = keyGenerator.generateKey(); SecretKeySpec secretKeySpec = new SecretKeySpec(secretKey.getEncoded(), \"AES\"); Cipher cipher = Cipher.getInstance(\"AES\"); cipher.init(Cipher.UNWRAP_MODE, secretKeySpec); SecretKey key = (SecretKey) cipher.unwrap(rawKey, \"AES\", Cipher.SECRET_KEY); return new String(key.getEncoded()); &#125; public static void main(String[] args) throws Exception &#123; String wrapKey = EncryptUtils.SINGLETON.wrap(\"doge\"); System.out.println(wrapKey); System.out.println(EncryptUtils.SINGLETON.unwrap(wrapKey)); &#125;&#125; åˆ†ç»„(éƒ¨åˆ†)åŠ å¯†å’Œåˆ†ç»„è§£å¯† å½“ä¸€ä¸ªéœ€è¦åŠ å¯†çš„æŠ¥æ–‡ååˆ†é•¿çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥è€ƒè™‘æŠŠæŠ¥æ–‡åˆ‡å‰²æˆå¤šä¸ªå°æ®µï¼Œç„¶åé’ˆå¯¹æ¯ä¸ªå°æ®µè¿›è¡ŒåŠ å¯†ï¼Œè¿™å°±æ˜¯åˆ†ç»„åŠ å¯†ã€‚åˆ†ç»„è§£å¯†çš„è¿‡ç¨‹ç±»åŒï¼Œå¯ä»¥çœ‹ä½œæ˜¯åˆ†ç»„åŠ å¯†çš„é€†å‘è¿‡ç¨‹ã€‚ä¸‹é¢è¿˜æ˜¯ç”¨AESç®—æ³•ä¸ºä¾‹ä¸¾ä¸ªä¾‹å­ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687import org.apache.commons.codec.binary.Hex;import javax.crypto.Cipher;import javax.crypto.KeyGenerator;import javax.crypto.SecretKey;import javax.crypto.spec.SecretKeySpec;import java.security.SecureRandom;/** * @author throwable * @version v1.0 * @description * @since 2018/8/15 1:06 */public enum Part &#123; /** * SINGLETON */ SINGLETON; private static final String PASSWORD = \"throwable\"; private Cipher createCipher() throws Exception &#123; return Cipher.getInstance(\"AES\"); &#125; public String encrypt(String content) throws Exception &#123; Cipher cipher = createCipher(); KeyGenerator keyGenerator = KeyGenerator.getInstance(\"AES\"); //å› ä¸ºAESè¦æ±‚å¯†é’¥çš„é•¿åº¦ä¸º128ï¼Œæˆ‘ä»¬éœ€è¦å›ºå®šçš„å¯†ç ï¼Œå› æ­¤éšæœºæºçš„ç§å­éœ€è¦è®¾ç½®ä¸ºæˆ‘ä»¬çš„å¯†ç æ•°ç»„ keyGenerator.init(128, new SecureRandom(PASSWORD.getBytes())); SecretKey secretKey = keyGenerator.generateKey(); SecretKeySpec secretKeySpec = new SecretKeySpec(secretKey.getEncoded(), \"AES\"); //åŸºäºåŠ å¯†æ¨¡å¼å’Œå¯†é’¥åˆå§‹åŒ–Cipher cipher.init(Cipher.ENCRYPT_MODE, secretKeySpec); byte[] raw = content.getBytes(); StringBuilder builder = new StringBuilder(); //[0,9] byte[] first = cipher.update(raw, 0, 10); builder.append(Hex.encodeHexString(first)); //[10,19] byte[] second = cipher.update(raw, 10, 10); builder.append(Hex.encodeHexString(second)); //[20,25] byte[] third = cipher.update(raw, 20, 6); builder.append(Hex.encodeHexString(third)); //å¤šéƒ¨åˆ†åŠ å¯†ç»“æŸï¼Œå¾—åˆ°æœ€åä¸€æ®µåŠ å¯†çš„ç»“æœï¼Œé‡ç½®Cipher byte[] bytes = cipher.doFinal(); String last = Hex.encodeHexString(bytes); builder.append(last); return builder.toString(); &#125; public String decrypt(String content) throws Exception &#123; byte[] raw = Hex.decodeHex(content); Cipher cipher = createCipher(); KeyGenerator keyGenerator = KeyGenerator.getInstance(\"AES\"); //å› ä¸ºAESè¦æ±‚å¯†é’¥çš„é•¿åº¦ä¸º128ï¼Œæˆ‘ä»¬éœ€è¦å›ºå®šçš„å¯†ç ï¼Œå› æ­¤éšæœºæºçš„ç§å­éœ€è¦è®¾ç½®ä¸ºæˆ‘ä»¬çš„å¯†ç æ•°ç»„ keyGenerator.init(128, new SecureRandom(PASSWORD.getBytes())); SecretKey secretKey = keyGenerator.generateKey(); SecretKeySpec secretKeySpec = new SecretKeySpec(secretKey.getEncoded(), \"AES\"); //åŸºäºè§£å¯†æ¨¡å¼å’Œå¯†é’¥åˆå§‹åŒ–Cipher cipher.init(Cipher.DECRYPT_MODE, secretKeySpec); StringBuilder builder = new StringBuilder(); //[0,14] byte[] first = cipher.update(raw, 0, 15); builder.append(new String(first)); //[15,29] byte[] second = cipher.update(raw, 15, 15); builder.append(new String(second)); //[30,31] byte[] third = cipher.update(raw, 30, 2); builder.append(new String(third)); //å¤šéƒ¨åˆ†è§£å¯†ç»“æŸï¼Œå¾—åˆ°æœ€åä¸€æ®µè§£å¯†çš„ç»“æœï¼Œé‡ç½®Cipher byte[] bytes = cipher.doFinal(); builder.append(new String(bytes)); return builder.toString(); &#125; public static void main(String[] args) throws Exception&#123; String raw = \"abcdefghijklmnopqrstyuwxyz\"; String e = Part.SINGLETON.encrypt(raw); System.out.println(e); System.out.println(Part.SINGLETON.decrypt(e)); &#125;&#125; ä¸Šé¢çš„åˆ†æ®µä¸‹æ ‡å·²ç»åœ¨æ³¨é‡Šä¸­ç»™å‡ºï¼Œåˆ†æ®µçš„è§„åˆ™ç”±å®é™…æƒ…å†µè€ƒè™‘ï¼Œä¸€èˆ¬AESåŠ è§£å¯†æŠ¥æ–‡ä¸å¤§çš„æ—¶å€™å¯ä»¥ç›´æ¥å•éƒ¨åˆ†åŠ è§£å¯†å³å¯ï¼Œè¿™é‡Œä»…ä»…æ˜¯ä¸ºäº†åšå±•ç¤ºã€‚ æŸ¥çœ‹å½“å‰JDKä¸­Cipherçš„æ‰€æœ‰æä¾›å•† æˆ‘ä»¬å¯ä»¥ç›´æ¥æŸ¥çœ‹å½“å‰çš„ä½¿ç”¨çš„JDKä¸­Cipherçš„æ‰€æœ‰æä¾›å•†å’Œæ”¯æŒçš„åŠ è§£å¯†æœåŠ¡ï¼Œç®€å•å†™ä¸ªmainå‡½æ•°å°±è¡Œï¼š 1234567891011121314151617181920import java.security.Provider;import java.security.Security;import java.util.Set;public class Main &#123; public static void main(String[] args) throws Exception &#123; Provider[] providers = Security.getProviders(); if (null != providers) &#123; for (Provider provider : providers) &#123; Set&lt;Provider.Service&gt; services = provider.getServices(); for (Provider.Service service : services) &#123; if (\"Cipher\".equals(service.getType())) &#123; System.out.println(String.format(\"provider:%s,type:%s,algorithm:%s\", service.getProvider(), service.getType(), service.getAlgorithm())); &#125; &#125; &#125; &#125; &#125;&#125; ç¬”è€…ç¼–å†™è¿™ç¯‡æ–‡ç« çš„æ—¶å€™ä½¿ç”¨çš„JDKæ˜¯JDK8çš„æœ€åä¸€ä¸ªæ›´æ–°çš„ç‰ˆæœ¬8u181(1.8.0_181)ï¼Œè¿è¡Œmainå‡½æ•°è¾“å‡ºå¦‚ä¸‹ï¼š 12345678910provider:SunJCE version 1.8,type:Cipher,algorithm:RSAprovider:SunJCE version 1.8,type:Cipher,algorithm:DESprovider:SunJCE version 1.8,type:Cipher,algorithm:DESedeprovider:SunJCE version 1.8,type:Cipher,algorithm:DESedeWrapprovider:SunJCE version 1.8,type:Cipher,algorithm:PBEWithMD5AndDESprovider:SunJCE version 1.8,type:Cipher,algorithm:PBEWithMD5AndTripleDESprovider:SunJCE version 1.8,type:Cipher,algorithm:PBEWithSHA1AndDESedeprovider:SunJCE version 1.8,type:Cipher,algorithm:PBEWithSHA1AndRC2_40provider:SunJCE version 1.8,type:Cipher,algorithm:PBEWithSHA1AndRC2_128.....è¾“å‡ºå†…å®¹å¤ªå¤šå¿½ç•¥å‰©ä½™éƒ¨åˆ† æ‰©å±• å› ä¸ºJavaåŸç”Ÿæ”¯æŒçš„transformationæ˜¯æœ‰é™çš„ï¼Œæœ‰äº›æ—¶å€™æˆ‘ä»¬éœ€è¦ä½¿ç”¨ä¸€äº›ç®—æ³•å…¶ä»–å·¥ä½œæ¨¡å¼æˆ–è€…å¡«å……æ¨¡å¼åŸç”Ÿæ— æ³•æ”¯æŒï¼Œè¿™ä¸ªæ—¶å€™æˆ‘ä»¬éœ€è¦å¼•å…¥ç¬¬ä¸‰æ–¹çš„Providerç”šè‡³è‡ªå·±å®ç°Providerã€‚å¸¸è§çš„ç¬¬ä¸‰æ–¹Provideræ˜¯bouncycastle(BC)ï¼Œç›®å‰BCçš„æœ€æ–°ä¾èµ–ä¸ºï¼š 12345&lt;dependency&gt; &lt;groupId&gt;org.bouncycastle&lt;/groupId&gt; &lt;artifactId&gt;bcprov-jdk15on&lt;/artifactId&gt; &lt;version&gt;1.60&lt;/version&gt;&lt;/dependency&gt; ä¸¾ä¸ªä¾‹å­ï¼ŒJavaåŸç”Ÿæ˜¯ä¸æ”¯æŒAESWRAPç®—æ³•çš„ï¼Œå› æ­¤å¯ä»¥å¼•å…¥BCçš„ä¾èµ–ï¼Œå†ä½¿ç”¨è½¬æ¢æ¨¡å¼AESWRAPã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061import org.apache.commons.codec.binary.Hex;import org.bouncycastle.jce.provider.BouncyCastleProvider;import javax.crypto.Cipher;import javax.crypto.KeyGenerator;import javax.crypto.SecretKey;import javax.crypto.spec.SecretKeySpec;import java.security.MessageDigest;import java.security.SecureRandom;import java.security.Security;public enum EncryptUtils &#123; /** * SINGLETON */ SINGLETON; private static final String SECRET = \"throwable\"; private static final String CHARSET = \"UTF-8\"; //è£…è½½BCæä¾›å•† static &#123; Security.addProvider(new BouncyCastleProvider()); &#125; private Cipher createAesCipher() throws Exception &#123; return Cipher.getInstance(\"AESWRAP\"); &#125; public String encryptByAes(String raw) throws Exception &#123; Cipher aesCipher = createAesCipher(); KeyGenerator keyGenerator = KeyGenerator.getInstance(\"AESWRAP\"); keyGenerator.init(128, new SecureRandom(SECRET.getBytes(CHARSET))); SecretKey secretKey = keyGenerator.generateKey(); SecretKeySpec secretKeySpec = new SecretKeySpec(secretKey.getEncoded(), \"AESWRAP\"); aesCipher.init(Cipher.ENCRYPT_MODE, secretKeySpec); byte[] bytes = aesCipher.doFinal(raw.getBytes(CHARSET)); return Hex.encodeHexString(bytes); &#125; public String decryptByAes(String raw) throws Exception &#123; byte[] bytes = Hex.decodeHex(raw); Cipher aesCipher = createAesCipher(); KeyGenerator keyGenerator = KeyGenerator.getInstance(\"AESWRAP\"); keyGenerator.init(128, new SecureRandom(SECRET.getBytes(CHARSET))); SecretKey secretKey = keyGenerator.generateKey(); SecretKeySpec secretKeySpec = new SecretKeySpec(secretKey.getEncoded(), \"AESWRAP\"); aesCipher.init(Cipher.DECRYPT_MODE, secretKeySpec); return new String(aesCipher.doFinal(bytes), CHARSET); &#125; public static void main(String[] args) throws Exception &#123; String raw = \"throwable-a-doge\"; String en = EncryptUtils.SINGLETON.encryptByAes(raw); System.out.println(en); String de = EncryptUtils.SINGLETON.decryptByAes(en); System.out.println(de); &#125;&#125; ä¸Šé¢çš„ä¾‹å­éœ€è¦æ³¨æ„ï¼Œå› ä¸ºä½¿ç”¨äº†AESWRAPç®—æ³•ï¼Œè¾“å…¥çš„éœ€è¦åŠ å¯†çš„æŠ¥æ–‡é•¿åº¦å¿…é¡»æ˜¯8çš„å€æ•°ã€‚ å°ç»“ ç†Ÿç»ƒæŒæ¡Cipherçš„ç”¨æ³•ã€è½¬æ¢æ¨¡å¼transformationçš„ä¸€äº›çŸ¥è¯†ä¹‹åï¼Œå½±å“æˆ‘ä»¬ç¼–å†™åŠ è§£å¯†æ¨¡å—ä»£ç çš„ä¸»è¦å› ç´ å°±æ˜¯åŠ è§£å¯†ç®—æ³•çš„åŸç†æˆ–è€…ä½¿ç”¨ï¼Œè¿™äº›éœ€è¦æˆ‘ä»¬å»å­¦ä¹ ä¸“é—¨çš„åŠ è§£å¯†ç®—æ³•ç›¸å…³çš„çŸ¥è¯†ã€‚å¦å¤–ï¼Œæœ‰äº›æ—¶å€™æˆ‘ä»¬å‘ç°ä¸åŒå¹³å°æˆ–è€…ä¸åŒè¯­è¨€ä½¿ç”¨åŒä¸€ä¸ªåŠ å¯†ç®—æ³•ä¸èƒ½ç›¸äº’è§£å¯†åŠ å¯†ï¼Œå…¶å®åŸå› å¾ˆç®€å•ï¼Œç»å¤§éƒ¨åˆ†åŸå› æ˜¯å·¥ä½œæ¨¡å¼é€‰å–æˆ–è€…å¡«å……æ¨¡å¼é€‰å–çš„ä¸åŒå¯¼è‡´çš„ï¼Œæ’é™¤æ‰è¿™ä¸¤ç‚¹ï¼Œå‰©ä¸‹çš„å¯èƒ½æ€§å°±æ˜¯ç®—æ³•çš„å®ç°ä¸ç›¸åŒï¼Œä¾æ®è¿™ä¸‰ç‚¹å› ç´ (æˆ–è€…è¯´å°±æ˜¯transformationè¿™å”¯ä¸€çš„å› ç´ )å»åˆ¤æ–­å’Œå¯»æ‰¾è§£å†³æ–¹æ¡ˆå³å¯ã€‚å…³äºåŠ è§£å¯†ç®—æ³•åŸç†ã€å·¥ä½œæ¨¡å¼ç­‰ç›¸å…³çŸ¥è¯†å¯ä»¥å‚è€ƒä¸‹é¢çš„èµ„æ–™ã€‚ å‚è€ƒèµ„æ–™ï¼š ã€Šå¯†ç ç¼–ç å­¦ä¸ç½‘ç»œå®‰å…¨-åŸç†ä¸å®è·µ(ç¬¬å…­ç‰ˆ)ã€‹ ã€Šä¿¡æ¯å®‰å…¨åŸç†ä¸å®è·µ(ç¬¬2ç‰ˆ)ã€‹ ã€Šå…³äºåŠ å¯†æ•°æ®çš„å¡«å……æ–¹å¼çš„ç ”ç©¶ã€‹ JDK8æ–‡æ¡£ å¦å¤–ï¼Œä¸€äº›ç‰¹æ®Šçš„æ–¹æ³•ä¾‹å¦‚Ciper#updateADD()æš‚æ—¶æ²¡é‡åˆ°ä½¿ç”¨åœºæ™¯ï¼Œè¿™é‡Œå°±ä¸å†™æ²¡å®è·µè¿‡çš„Demoã€‚ (æœ¬æ–‡å®Œ e-a-20190216 c-7-d)","categories":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/tags/Java/"},{"name":"Security","slug":"Security","permalink":"http://throwable.club/blog/tags/Security/"}]},{"title":"é¡¹ç›®æ¶æ„çº§åˆ«è§„çº¦æ¡†æ¶Archunitè°ƒç ”","slug":"java-archunit-research","date":"2019-02-16T12:12:58.000Z","updated":"2019-02-16T14:44:09.160Z","comments":true,"path":"2019/02/16/java-archunit-research/","link":"","permalink":"http://throwable.club/2019/02/16/java-archunit-research/","excerpt":"","text":"é¡¹ç›®æ¶æ„çº§åˆ«è§„çº¦æ¡†æ¶Archunitè°ƒç ” èƒŒæ™¯ æœ€è¿‘åœ¨åšä¸€ä¸ªæ–°é¡¹ç›®çš„æ—¶å€™å¼•å…¥äº†ä¸€ä¸ªæ¶æ„æ–¹é¢çš„éœ€æ±‚ï¼Œå°±æ˜¯éœ€è¦æ£€æŸ¥é¡¹ç›®çš„ç¼–ç è§„èŒƒã€æ¨¡å—åˆ†ç±»è§„èŒƒã€ç±»ä¾èµ–è§„èŒƒç­‰ï¼Œåˆšå¥½æ¥è§¦åˆ°ï¼Œæ­£å¥½åšä¸ªè°ƒç ”ã€‚ å¾ˆå¤šæ—¶å€™ï¼Œæˆ‘ä»¬ä¼šåˆ¶å®šé¡¹ç›®çš„è§„èŒƒï¼Œä¾‹å¦‚ï¼š ç¡¬æ€§è§„å®šé¡¹ç›®åŒ…ç»“æ„ä¸­serviceå±‚ä¸èƒ½å¼•ç”¨controllerå±‚çš„ç±»(è¿™ä¸ªä¾‹å­æœ‰ç‚¹æç«¯)ã€‚ ç¡¬æ€§è§„å®šå®šä¹‰åœ¨controlleråŒ…ä¸‹çš„Controllerç±»çš„ç±»åç§°ä»¥&quot;Controller&quot;ç»“å°¾ï¼Œæ–¹æ³•çš„å…¥å‚ç±»å‹å‘½åä»¥&quot;Request&quot;ç»“å°¾ï¼Œè¿”å›å‚æ•°å‘½åä»¥&quot;Response&quot;ç»“å°¾ã€‚ æšä¸¾ç±»å‹å¿…é¡»æ”¾åœ¨common.constantåŒ…ä¸‹ï¼Œä»¥ç±»åç§°Enumç»“å°¾ã€‚ è¿˜æœ‰å¾ˆå¤šå…¶ä»–å¯èƒ½éœ€è¦å®šåˆ¶çš„è§„èŒƒï¼Œæœ€ç»ˆå¯èƒ½ä¼šè¾“å‡ºä¸€ä¸ªæ–‡æ¡£ã€‚ä½†æ˜¯ï¼Œè°èƒ½ä¿è¯æ‰€æœ‰å‚æ•°å¼€å‘çš„äººå‘˜éƒ½ä¼šæŒ‰ç…§æ–‡æ¡£çš„è§„èŒƒè¿›è¡Œå¼€å‘ï¼Ÿä¸ºäº†ä¿è¯è§„èŒƒçš„å®è¡Œï¼ŒArchunitä»¥å•å…ƒæµ‹è¯•çš„å½¢å¼é€šè¿‡æ‰«æç±»è·¯å¾„(ç”šè‡³Jar)åŒ…ä¸‹çš„æ‰€æœ‰ç±»ï¼Œé€šè¿‡å•å…ƒæµ‹è¯•çš„å½¢å¼å¯¹å„ä¸ªè§„èŒƒè¿›è¡Œä»£ç ç¼–å†™ï¼Œå¦‚æœé¡¹ç›®ä»£ç ä¸­æœ‰è¿èƒŒå¯¹åº”çš„å•æµ‹è§„èŒƒï¼Œé‚£ä¹ˆå•å…ƒæµ‹è¯•å°†ä¼šä¸é€šè¿‡ï¼Œè¿™æ ·å°±å¯ä»¥ä»CI/CDå±‚é¢å½»åº•æŠŠæ§é¡¹é¡¹ç›®æ¶æ„å’Œç¼–ç è§„èŒƒã€‚ ç®€ä»‹ Archunitæ˜¯ä¸€ä¸ªå…è´¹ã€ç®€å•ã€å¯æ‰©å±•çš„ç±»åº“ï¼Œç”¨äºæ£€æŸ¥Javaä»£ç çš„ä½“ç³»ç»“æ„ã€‚æä¾›æ£€æŸ¥åŒ…å’Œç±»çš„ä¾èµ–å…³ç³»ã€è°ƒç”¨å±‚æ¬¡å’Œåˆ‡é¢çš„ä¾èµ–å…³ç³»ã€å¾ªç¯ä¾èµ–æ£€æŸ¥ç­‰å…¶ä»–åŠŸèƒ½ã€‚å®ƒé€šè¿‡å¯¼å…¥æ‰€æœ‰ç±»çš„ä»£ç ç»“æ„ï¼ŒåŸºäºJavaå­—èŠ‚ç åˆ†æå®ç°è¿™ä¸€ç‚¹ã€‚çš„ä¸»è¦å…³æ³¨ç‚¹æ˜¯ä½¿ç”¨ä»»ä½•æ™®é€šçš„Javaå•å…ƒæµ‹è¯•æ¡†æ¶è‡ªåŠ¨æµ‹è¯•ä»£ç ä½“ç³»ç»“æ„å’Œç¼–ç è§„åˆ™ã€‚ å¼•å…¥ä¾èµ– ä¸€èˆ¬æ¥è¯´ï¼Œç›®å‰å¸¸ç”¨çš„æµ‹è¯•æ¡†æ¶æ˜¯Junit4ï¼Œéœ€è¦å¼•å…¥Junit4å’Œarchunitï¼š 123456789101112&lt;dependency&gt; &lt;groupId&gt;com.tngtech.archunit&lt;/groupId&gt; &lt;artifactId&gt;archunit&lt;/artifactId&gt; &lt;version&gt;0.9.3&lt;/version&gt; &lt;scope&gt;test&lt;/scope&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;junit&lt;/groupId&gt; &lt;artifactId&gt;junit&lt;/artifactId&gt; &lt;version&gt;4.12&lt;/version&gt; &lt;scope&gt;test&lt;/scope&gt;&lt;/dependency&gt; ç”±äºjunit4ä¸­ä¾èµ–åˆ°slf4jï¼Œå› æ­¤æœ€å¥½åœ¨æµ‹è¯•ä¾èµ–ä¸­å¼•å…¥ä¸€ä¸ªslf4jçš„å®ç°ï¼Œä¾‹å¦‚logbackï¼š 123456&lt;dependency&gt; &lt;groupId&gt;ch.qos.logback&lt;/groupId&gt; &lt;artifactId&gt;logback-classic&lt;/artifactId&gt; &lt;version&gt;1.2.3&lt;/version&gt; &lt;scope&gt;test&lt;/scope&gt;&lt;/dependency&gt; å¦‚ä½•ä½¿ç”¨ ä¸»è¦ä»ä¸‹é¢çš„ä¸¤ä¸ªæ–¹é¢ä»‹ç»ä¸€ä¸‹çš„ä½¿ç”¨ï¼š æŒ‡å®šå‚æ•°è¿›è¡Œç±»æ‰«æã€‚ å†…å»ºè§„åˆ™å®šä¹‰ã€‚ æŒ‡å®šå‚æ•°è¿›è¡Œç±»æ‰«æ éœ€è¦å¯¹ä»£ç æˆ–è€…ä¾èµ–è§„åˆ™è¿›è¡Œåˆ¤æ–­å‰ææ˜¯è¦å¯¼å…¥æ‰€æœ‰éœ€è¦åˆ†æçš„ç±»ï¼Œç±»æ‰«æå¯¼å…¥ä¾èµ–äºClassFileImporterï¼Œåº•å±‚ä¾èµ–äºASMå­—èŠ‚ç æ¡†æ¶é’ˆå¯¹ç±»æ–‡ä»¶çš„å­—èŠ‚ç è¿›è¡Œè§£æï¼Œæ€§èƒ½ä¼šæ¯”åŸºäºåå°„çš„ç±»æ‰«ææ¡†æ¶é«˜å¾ˆå¤šã€‚ClassFileImporterçš„æ„é€ å¯é€‰å‚æ•°ä¸ºImportOption(s)ï¼Œæ‰«æè§„åˆ™å¯ä»¥é€šè¿‡ImportOptionæ¥å£å®ç°ï¼Œé»˜è®¤æä¾›å¯é€‰çš„è§„åˆ™æœ‰ï¼š 12345678// ä¸åŒ…å«æµ‹è¯•ç±»ImportOption.Predefined.DONT_INCLUDE_TESTS// ä¸åŒ…å«JaråŒ…é‡Œé¢çš„ç±»ImportOption.Predefined.DONT_INCLUDE_JARS// ä¸åŒ…å«Jarå’ŒJrtåŒ…é‡Œé¢çš„ç±»ï¼ŒJDK9çš„ç‰¹æ€§ImportOption.Predefined.DONT_INCLUDE_ARCHIVES ä¸¾ä¸ªä¾‹å­ï¼Œæˆ‘ä»¬å®ç°ä¸€ä¸ªè‡ªå®šä¹‰çš„ImportOptionå®ç°ï¼Œç”¨äºæŒ‡å®šéœ€è¦æ’é™¤æ‰«æçš„åŒ…è·¯å¾„ï¼š 123456789101112131415161718192021public class DontIncludePackagesImportOption implements ImportOption &#123; private final Set&lt;Pattern&gt; EXCLUDED_PATTERN; public DontIncludePackagesImportOption(String... packages) &#123; EXCLUDED_PATTERN = new HashSet&lt;&gt;(8); for (String eachPackage : packages) &#123; EXCLUDED_PATTERN.add(Pattern.compile(String.format(\".*/%s/.*\", eachPackage.replace(\"/\", \".\")))); &#125; &#125; @Override public boolean includes(Location location) &#123; for (Pattern pattern : EXCLUDED_PATTERN) &#123; if (location.matches(pattern)) &#123; return false; &#125; &#125; return true; &#125;&#125; ImportOptionæ¥å£åªæœ‰ä¸€ä¸ªæ–¹æ³•ï¼š 1boolean includes(Location location) å…¶ä¸­ï¼ŒLocationåŒ…å«äº†è·¯å¾„ä¿¡æ¯ã€æ˜¯å¦Jaræ–‡ä»¶ç­‰åˆ¤æ–­å±æ€§çš„å…ƒæ•°æ®ï¼Œæ–¹ä¾¿ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼æˆ–è€…ç›´æ¥çš„é€»è¾‘åˆ¤æ–­ã€‚ æ¥ç€æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸Šé¢å®ç°çš„DontIncludePackagesImportOptionå»æ„é€ ClassFileImporterå®ä¾‹ï¼š 123456ImportOptions importOptions = new ImportOptions() // ä¸æ‰«æjaråŒ… .with(ImportOption.Predefined.DONT_INCLUDE_JARS) // æ’é™¤ä¸æ‰«æçš„åŒ… .with(new DontIncludePackagesImportOption(\"com.sample..support\"));ClassFileImporter classFileImporter = new ClassFileImporter(importOptions); å¾—åˆ°ClassFileImporterå®ä¾‹åæˆ‘ä»¬å¯ä»¥é€šè¿‡å¯¹åº”çš„æ–¹æ³•å¯¼å…¥é¡¹ç›®ä¸­çš„ç±»ï¼š 123456789101112131415161718192021222324252627282930313233// æŒ‡å®šç±»å‹å¯¼å…¥å•ä¸ªç±»public JavaClass importClass(Class&lt;?&gt; clazz)// æŒ‡å®šç±»å‹å¯¼å…¥å¤šä¸ªç±»public JavaClasses importClasses(Class&lt;?&gt;... classes)public JavaClasses importClasses(Collection&lt;Class&lt;?&gt;&gt; classes)// é€šè¿‡æŒ‡å®šè·¯å¾„å¯¼å…¥ç±»public JavaClasses importUrl(URL url)public JavaClasses importUrls(Collection&lt;URL&gt; urls)public JavaClasses importLocations(Collection&lt;Location&gt; locations)// é€šè¿‡ç±»è·¯å¾„å¯¼å…¥ç±»public JavaClasses importClasspath()public JavaClasses importClasspath(ImportOptions options)// é€šè¿‡æ–‡ä»¶è·¯å¾„å¯¼å…¥ç±»public JavaClasses importPath(String path)public JavaClasses importPath(Path path)public JavaClasses importPaths(String... paths)public JavaClasses importPaths(Path... paths)public JavaClasses importPaths(Collection&lt;Path&gt; paths)// é€šè¿‡Jaræ–‡ä»¶å¯¹è±¡å¯¼å…¥ç±»public JavaClasses importJar(JarFile jar)public JavaClasses importJars(JarFile... jarFiles)public JavaClasses importJars(Iterable&lt;JarFile&gt; jarFiles)// é€šè¿‡åŒ…è·¯å¾„å¯¼å…¥ç±» - è¿™ä¸ªæ˜¯æ¯”è¾ƒå¸¸ç”¨çš„æ–¹æ³•public JavaClasses importPackages(Collection&lt;String&gt; packages)public JavaClasses importPackages(String... packages)public JavaClasses importPackagesOf(Class&lt;?&gt;... classes)public JavaClasses importPackagesOf(Collection&lt;Class&lt;?&gt;&gt; classes) å¯¼å…¥ç±»çš„æ–¹æ³•æä¾›äº†å¤šç»´åº¦çš„å‚æ•°ï¼Œç”¨èµ·æ¥ä¼šååˆ†ä¾¿æ·ã€‚ä¾‹å¦‚æƒ³å¯¼å…¥com.sampleåŒ…ä¸‹é¢çš„æ‰€æœ‰ç±»ï¼Œåªéœ€è¦è¿™æ ·ï¼š 12345678910111213141516public class ClassFileImporterTest &#123; @Test public void testImportBootstarpClass() throws Exception &#123; ImportOptions importOptions = new ImportOptions() // ä¸æ‰«æjaråŒ… .with(ImportOption.Predefined.DONT_INCLUDE_JARS) // æ’é™¤ä¸æ‰«æçš„åŒ… .with(new DontIncludePackagesImportOption(\"com.sample..support\")); ClassFileImporter classFileImporter = new ClassFileImporter(importOptions); long start = System.currentTimeMillis(); JavaClasses javaClasses = classFileImporter.importPackages(\"com.sample\"); long end = System.currentTimeMillis(); System.out.println(String.format(\"Found %d classes,cost %d ms\", javaClasses.size(), end - start)); &#125;&#125; å¾—åˆ°çš„JavaClassesæ˜¯JavaClassçš„é›†åˆï¼Œå¯ä»¥ç®€å•ç±»æ¯”ä¸ºåå°„ä¸­Classçš„é›†åˆï¼Œåé¢ä½¿ç”¨çš„ä»£ç è§„åˆ™å’Œä¾èµ–è§„åˆ™åˆ¤æ–­éƒ½æ˜¯å¼ºä¾èµ–äºJavaClassesæˆ–è€…JavaClassã€‚ å†…å»ºè§„åˆ™å®šä¹‰ ç±»æ‰«æå’Œç±»å¯¼å…¥å®Œæˆä¹‹åï¼Œæˆ‘ä»¬éœ€è¦å®šæ£€æŸ¥è§„åˆ™ï¼Œç„¶ååº”ç”¨äºæ‰€æœ‰å¯¼å…¥çš„ç±»ï¼Œè¿™æ ·å­å°±èƒ½å®Œæˆå¯¹æ‰€æœ‰çš„ç±»è¿›è¡Œè§„åˆ™çš„è¿‡æ»¤ - æˆ–è€…è¯´æŠŠè§„åˆ™åº”ç”¨äºæ‰€æœ‰ç±»å¹¶ä¸”è¿›è¡Œæ–­è¨€ã€‚ è§„åˆ™å®šä¹‰ä¾èµ–äºArchRuleDefinitionç±»ï¼Œåˆ›å»ºå‡ºæ¥çš„è§„åˆ™æ˜¯ArchRuleå®ä¾‹ï¼Œè§„åˆ™å®ä¾‹çš„åˆ›å»ºè¿‡ç¨‹ä¸€èˆ¬ä½¿ç”¨ArchRuleDefinitionç±»çš„æµå¼æ–¹æ³•ï¼Œè¿™äº›æµå¼æ–¹æ³•å®šä¹‰ä¸Šç¬¦åˆäººç±»æ€è€ƒçš„æ€ç»´é€»è¾‘ï¼Œä¸Šæ‰‹æ¯”è¾ƒç®€å•ï¼Œä¸¾ä¸ªä¾‹å­ï¼š 123456789ArchRule archRule = ArchRuleDefinition.noClasses() // åœ¨serviceåŒ…ä¸‹çš„æ‰€æœ‰ç±» .that().resideInAPackage(\"..service..\") // ä¸èƒ½è°ƒç”¨controlleråŒ…ä¸‹çš„ä»»æ„ç±» .should().accessClassesThat().resideInAPackage(\"..controller..\") // æ–­è¨€æè¿° - ä¸æ»¡è¶³è§„åˆ™çš„æ—¶å€™æ‰“å°å‡ºæ¥çš„åŸå›  .because(\"ä¸èƒ½åœ¨serviceåŒ…ä¸­è°ƒç”¨controllerä¸­çš„ç±»\"); // å¯¹æ‰€æœ‰çš„JavaClassesè¿›è¡Œåˆ¤æ–­archRule.check(classes); ä¸Šé¢å±•ç¤ºäº†è‡ªå®šä¹‰æ–°çš„ArchRuleçš„ä¾‹å­ï¼Œä¸­å·²ç»ä¸ºæˆ‘ä»¬å†…ç½®äº†ä¸€äº›å¸¸ç”¨çš„ArchRuleå®ç°ï¼Œå®ƒä»¬ä½äºGeneralCodingRulesä¸­ï¼š NO_CLASSES_SHOULD_ACCESS_STANDARD_STREAMSï¼šä¸èƒ½è°ƒç”¨System.outã€System.erræˆ–è€…(Exception.)printStackTraceã€‚ NO_CLASSES_SHOULD_THROW_GENERIC_EXCEPTIONSï¼šç±»ä¸èƒ½ç›´æ¥æŠ›å‡ºé€šç”¨å¼‚å¸¸Throwableã€Exceptionæˆ–è€…RuntimeExceptionã€‚ NO_CLASSES_SHOULD_USE_JAVA_UTIL_LOGGINGï¼šä¸èƒ½ä½¿ç”¨java.util.loggingåŒ…è·¯å¾„ä¸‹çš„æ—¥å¿—ç»„ä»¶ã€‚ æ›´å¤šå†…å»ºçš„ArchRuleæˆ–è€…é€šç”¨çš„å†…ç½®è§„åˆ™ä½¿ç”¨ï¼Œå¯ä»¥å‚è€ƒå®˜æ–¹ä¾‹å­ã€‚ åŸºæœ¬ä½¿ç”¨ä¾‹å­ åŸºæœ¬ä½¿ç”¨ä¾‹å­ï¼Œä¸»è¦ä»ä¸€äº›å¸¸è§çš„ç¼–ç è§„èŒƒæˆ–è€…é¡¹ç›®è§„èŒƒç¼–å†™è§„åˆ™å¯¹é¡¹ç›®æ‰€æœ‰ç±»è¿›è¡Œæ£€æŸ¥ã€‚ åŒ…ä¾èµ–å…³ç³»æ£€æŸ¥ 123ArchRule archRule = ArchRuleDefinition.noClasses() .that().resideInAPackage(\"..com.source..\") .should().dependOnClassesThat().resideInAPackage(\"..com.target..\"); 123ArchRule archRule = ArchRuleDefinition.classes() .that().resideInAPackage(\"..com.foo..\") .should().onlyAccessClassesThat().resideInAnyPackage(\"..com.source..\", \"..com.foo..\"); ç±»ä¾èµ–å…³ç³»æ£€æŸ¥ 123ArchRule archRule = ArchRuleDefinition.classes() .that().haveNameMatching(\".*Bar\") .should().onlyBeAccessed().byClassesThat().haveSimpleName(\"Bar\"); ç±»åŒ…å«äºåŒ…çš„å…³ç³»æ£€æŸ¥ 123ArchRule archRule = ArchRuleDefinition.classes() .that().haveSimpleNameStartingWith(\"Foo\") .should().resideInAPackage(\"com.foo\"); ç»§æ‰¿å…³ç³»æ£€æŸ¥ 123ArchRule archRule = ArchRuleDefinition.classes() .that().implement(Collection.class) .should().haveSimpleNameEndingWith(\"Connection\"); 123ArchRule archRule = ArchRuleDefinition.classes() .that().areAssignableTo(EntityManager.class) .should().onlyBeAccessed().byAnyPackage(\"..persistence..\"); æ³¨è§£æ£€æŸ¥ 123ArchRule archRule = ArchRuleDefinition.classes() .that().areAssignableTo(EntityManager.class) .should().onlyBeAccessed().byClassesThat().areAnnotatedWith(Transactional.class) é€»è¾‘å±‚è°ƒç”¨å…³ç³»æ£€æŸ¥ ä¾‹å¦‚é¡¹ç›®ç»“æ„å¦‚ä¸‹ï¼š 12345678- com.myapp.controller SomeControllerOne.class SomeControllerTwo.class- com.myapp.service SomeServiceOne.class SomeServiceTwo.class- com.myapp.persistence SomePersistenceManager ä¾‹å¦‚æˆ‘ä»¬è§„å®šï¼š åŒ…è·¯å¾„com.myapp.controllerä¸­çš„ç±»ä¸èƒ½è¢«å…¶ä»–å±‚çº§åŒ…å¼•ç”¨ã€‚ åŒ…è·¯å¾„com.myapp.serviceä¸­çš„ç±»åªèƒ½è¢«com.myapp.controllerä¸­çš„ç±»å¼•ç”¨ã€‚ åŒ…è·¯å¾„com.myapp.persistenceä¸­çš„ç±»åªèƒ½è¢«com.myapp.serviceä¸­çš„ç±»å¼•ç”¨ã€‚ ç¼–å†™è§„åˆ™å¦‚ä¸‹ï¼š 12345678layeredArchitecture() .layer(\"Controller\").definedBy(\"..controller..\") .layer(\"Service\").definedBy(\"..service..\") .layer(\"Persistence\").definedBy(\"..persistence..\") .whereLayer(\"Controller\").mayNotBeAccessedByAnyLayer() .whereLayer(\"Service\").mayOnlyBeAccessedByLayers(\"Controller\") .whereLayer(\"Persistence\").mayOnlyBeAccessedByLayers(\"Service\") å¾ªç¯ä¾èµ–å…³ç³»æ£€æŸ¥ ä¾‹å¦‚é¡¹ç›®ç»“æ„å¦‚ä¸‹ï¼š 123456789- com.myapp.moduleone ClassOneInModuleOne.class ClassTwoInModuleOne.class- com.myapp.moduletwo ClassOneInModuleTwo.class ClassTwoInModuleTwo.class- com.myapp.modulethree ClassOneInModuleThree.class ClassTwoInModuleThree.class ä¾‹å¦‚æˆ‘ä»¬è§„å®šï¼šcom.myapp.moduleoneã€com.myapp.moduletwoå’Œcom.myapp.modulethreeä¸‰ä¸ªåŒ…è·¯å¾„ä¸­çš„ç±»ä¸èƒ½å½¢æˆä¸€ä¸ªå¾ªç¯ä¾èµ–ç¼“ï¼Œä¾‹å¦‚ï¼š 1ClassOneInModuleOne -&gt; ClassOneInModuleTwo -&gt; ClassOneInModuleThree -&gt; ClassOneInModuleOne ç¼–å†™è§„åˆ™å¦‚ä¸‹ï¼š 1slices().matching(\"com.myapp.(*)..\").should().beFreeOfCycles() æ ¸å¿ƒAPI æŠŠAPIåˆ†ä¸ºä¸‰å±‚ï¼Œæœ€é‡è¦çš„æ˜¯&quot;Core&quot;å±‚ã€&quot;Lang&quot;å±‚å’Œ&quot;Library&quot;å±‚ã€‚ Coreå±‚API ArchUnitçš„Coreå±‚APIå¤§éƒ¨åˆ†ç±»ä¼¼äºJavaåŸç”Ÿåå°„APIï¼Œä¾‹å¦‚JavaMethodå’ŒJavaFieldå¯¹åº”äºåŸç”Ÿåå°„ä¸­çš„Methodå’ŒFieldï¼Œå®ƒä»¬æä¾›äº†è¯¸å¦‚getName()ã€getMethods()ã€getType()å’ŒgetParameters()ç­‰æ–¹æ³•ã€‚ æ­¤å¤–ArchUnitæ‰©å±•ä¸€äº›APIç”¨äºæè¿°ä¾èµ–ä»£ç ä¹‹é—´å…³ç³»ï¼Œä¾‹å¦‚JavaMethodCallï¼Œ JavaConstructorCallæˆ–JavaFieldAccessã€‚è¿˜æä¾›äº†ä¾‹å¦‚Javaç±»ä¸å…¶ä»–Javaç±»ä¹‹é—´çš„å¯¼å…¥è®¿é—®å…³ç³»çš„APIå¦‚JavaClass#getAccessesFromSelf()ã€‚ è€Œéœ€è¦å¯¼å…¥ç±»è·¯å¾„ä¸‹æˆ–è€…JaråŒ…ä¸­å·²ç»ç¼–è¯‘å¥½çš„Javaç±»ï¼ŒArchUnitæä¾›äº†ClassFileImporterå®Œæˆæ­¤åŠŸèƒ½ï¼š 1JavaClasses classes = new ClassFileImporter().importPackages(\"com.mycompany.myapp\"); Langå±‚API Coreå±‚çš„APIååˆ†å¼ºå¤§ï¼Œæä¾›äº†éœ€è¦å…³äºJavaç¨‹åºé™æ€ç»“æ„çš„ä¿¡æ¯ï¼Œä½†æ˜¯ç›´æ¥ä½¿ç”¨Coreå±‚çš„APIå¯¹äºå•å…ƒæµ‹è¯•ä¼šç¼ºä¹è¡¨ç°åŠ›ï¼Œç‰¹åˆ«è¡¨ç°åœ¨æ¶æ„è§„åˆ™æ–¹é¢ã€‚ å‡ºäºè¿™ä¸ªåŸå› ï¼ŒArchUnitæä¾›äº†Langå±‚çš„APIï¼Œå®ƒæä¾›äº†ä¸€ç§å¼ºå¤§çš„è¯­æ³•æ¥ä»¥æŠ½è±¡çš„æ–¹å¼è¡¨è¾¾è§„åˆ™ã€‚Langå±‚çš„APIå¤§å¤šæ•°æ˜¯é‡‡ç”¨æµå¼ç¼–ç¨‹æ–¹å¼å®šä¹‰æ–¹æ³•ï¼Œä¾‹å¦‚æŒ‡å®šåŒ…å®šä¹‰å’Œè°ƒç”¨å…³ç³»çš„è§„åˆ™å¦‚ä¸‹ï¼š 123456ArchRule rule = classes() // å®šä¹‰åœ¨serviceåŒ…ä¸‹çš„æ‰€æ¬²ç±» .that().resideInAPackage(\"..service..\") // åªèƒ½è¢«controlleråŒ…æˆ–è€…serviceåŒ…ä¸­çš„ç±»è®¿é—® .should().onlyBeAccessed().byAnyPackage(\"..controller..\", \"..service..\"); ç¼–å†™å¥½è§„åˆ™åå°±å¯ä»¥åŸºäºå¯¼å…¥æ‰€æœ‰ç¼–è¯‘å¥½çš„ç±»è¿›è¡Œæ‰«æï¼š 123JavaClasses classes = new ClassFileImporter().importPackage(\"com.myapp\");ArchRule rule = // å®šä¹‰çš„è§„åˆ™rule.check(classes); Libraryå±‚API Libraryå±‚APIé€šè¿‡é™æ€å·¥å‚æ–¹æ³•æä¾›äº†æ›´å¤šå¤æ‚è€Œå¼ºå¤§çš„é¢„å®šä¹‰è§„åˆ™ï¼Œå…¥å£ç±»æ˜¯ï¼š 1com.tngtech.archunit.library.Architectures ç›®å‰ï¼Œè¿™åªèƒ½ä¸ºåˆ†å±‚æ¶æ„æä¾›æ–¹ä¾¿çš„æ£€æŸ¥ï¼Œä½†å°†æ¥å¯èƒ½ä¼šæ‰©å±•ä¸ºå…­è¾¹å½¢æ¶æ„\\ç®¡é“å’Œè¿‡æ»¤å™¨ï¼Œä¸šåŠ¡é€»è¾‘å’ŒæŠ€æœ¯åŸºç¡€æ¶æ„çš„åˆ†ç¦»ç­‰æ ·å¼ã€‚ è¿˜æœ‰å…¶ä»–å‡ ä¸ªç›¸å¯¹å¼ºå¤§çš„åŠŸèƒ½ï¼š ä»£ç åˆ‡ç‰‡åŠŸèƒ½ï¼Œå…¥å£æ˜¯com.tngtech.archunit.library.dependencies.SlicesRuleDefinitionã€‚ ä¸€èˆ¬ç¼–ç è§„åˆ™ï¼Œå…¥å£æ˜¯com.tngtech.archunit.library.GeneralCodingRulesã€‚ PlantUMLç»„ä»¶æ”¯æŒï¼ŒåŠŸèƒ½ä½äºåŒ…è·¯å¾„com.tngtech.archunit.library.plantumlä¸‹ã€‚ ç¼–å†™å¤æ‚çš„è§„åˆ™ ä¸€èˆ¬æ¥è¯´ï¼Œå†…å»ºçš„è§„åˆ™ä¸ä¸€å®šèƒ½å¤Ÿæ»¡è¶³ä¸€äº›å¤æ‚çš„è§„èŒƒæ ¡éªŒè§„åˆ™ï¼Œå› æ­¤éœ€è¦ç¼–å†™è‡ªå®šä¹‰çš„è§„åˆ™ã€‚è¿™é‡Œä»…ä»…ä¸¾ä¸€ä¸ªå‰æ–‡æåˆ°çš„ç›¸å¯¹å¤æ‚çš„è§„åˆ™ï¼š å®šä¹‰åœ¨controlleråŒ…ä¸‹çš„Controllerç±»çš„ç±»åç§°ä»¥&quot;Controller&quot;ç»“å°¾ï¼Œæ–¹æ³•çš„å…¥å‚ç±»å‹å‘½åä»¥&quot;Request&quot;ç»“å°¾ï¼Œè¿”å›å‚æ•°å‘½åä»¥&quot;Response&quot;ç»“å°¾ã€‚ å®˜æ–¹æä¾›çš„è‡ªå®šä¹‰è§„åˆ™çš„ä¾‹å­å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324DescribedPredicate&lt;JavaClass&gt; haveAFieldAnnotatedWithPayload = new DescribedPredicate&lt;JavaClass&gt;(\"have a field annotated with @Payload\")&#123; @Override public boolean apply(JavaClass input) &#123; boolean someFieldAnnotatedWithPayload = // iterate fields and check for @Payload return someFieldAnnotatedWithPayload; &#125; &#125;;ArchCondition&lt;JavaClass&gt; onlyBeAccessedBySecuredMethods = new ArchCondition&lt;JavaClass&gt;(\"only be accessed by @Secured methods\") &#123; @Override public void check(JavaClass item, ConditionEvents events) &#123; for (JavaMethodCall call : item.getMethodCallsToSelf()) &#123; if (!call.getOrigin().isAnnotatedWith(Secured.class)) &#123; String message = String.format( \"Method %s is not @Secured\", call.getOrigin().getFullName()); events.add(SimpleConditionEvent.violated(call, message)); &#125; &#125; &#125; &#125;;classes().that(haveAFieldAnnotatedWithPayload).should(onlyBeAccessedBySecuredMethods); æˆ‘ä»¬åªéœ€è¦æ¨¡ä»¿å®ƒçš„å®ç°å³å¯ï¼Œå…·ä½“å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152public class ArchunitTest &#123; @Test public void controller_class_rule() &#123; JavaClasses classes = new ClassFileImporter().importPackages(\"club.throwable\"); DescribedPredicate&lt;JavaClass&gt; predicate = new DescribedPredicate&lt;JavaClass&gt;(\"å®šä¹‰åœ¨club.throwable.controlleråŒ…ä¸‹çš„æ‰€æœ‰ç±»\") &#123; @Override public boolean apply(JavaClass input) &#123; return null != input.getPackageName() &amp;&amp; input.getPackageName().contains(\"club.throwable.controller\"); &#125; &#125;; ArchCondition&lt;JavaClass&gt; condition1 = new ArchCondition&lt;JavaClass&gt;(\"ç±»åç§°ä»¥Controllerç»“å°¾\") &#123; @Override public void check(JavaClass javaClass, ConditionEvents conditionEvents) &#123; String name = javaClass.getName(); if (!name.endsWith(\"Controller\")) &#123; conditionEvents.add(SimpleConditionEvent.violated(javaClass, String.format(\"å½“å‰æ§åˆ¶å™¨ç±»[%s]å‘½åä¸ä»¥\\\"Controller\\\"ç»“å°¾\", name))); &#125; &#125; &#125;; ArchCondition&lt;JavaClass&gt; condition2 = new ArchCondition&lt;JavaClass&gt;(\"æ–¹æ³•çš„å…¥å‚ç±»å‹å‘½åä»¥\\\"Request\\\"ç»“å°¾ï¼Œè¿”å›å‚æ•°å‘½åä»¥\\\"Response\\\"ç»“å°¾\") &#123; @Override public void check(JavaClass javaClass, ConditionEvents conditionEvents) &#123; Set&lt;JavaMethod&gt; javaMethods = javaClass.getMethods(); String className = javaClass.getName(); // å…¶å®è¿™é‡Œè¦åšä¸¥è°¨ä¸€ç‚¹éœ€è¦è€ƒè™‘æ˜¯å¦ä½¿ç”¨äº†æ³›å‹å‚æ•°ï¼Œè¿™é‡Œæš‚æ—¶ç®€åŒ–äº† for (JavaMethod javaMethod : javaMethods) &#123; Method method = javaMethod.reflect(); Class&lt;?&gt;[] parameterTypes = method.getParameterTypes(); for (Class parameterType : parameterTypes) &#123; if (!parameterType.getName().endsWith(\"Request\")) &#123; conditionEvents.add(SimpleConditionEvent.violated(method, String.format(\"å½“å‰æ§åˆ¶å™¨ç±»[%s]çš„[%s]æ–¹æ³•å…¥å‚ä¸ä»¥\\\"Request\\\"ç»“å°¾\", className, method.getName()))); &#125; &#125; Class&lt;?&gt; returnType = method.getReturnType(); if (!returnType.getName().endsWith(\"Response\")) &#123; conditionEvents.add(SimpleConditionEvent.violated(method, String.format(\"å½“å‰æ§åˆ¶å™¨ç±»[%s]çš„[%s]æ–¹æ³•è¿”å›å‚æ•°ä¸ä»¥\\\"Response\\\"ç»“å°¾\", className, method.getName()))); &#125; &#125; &#125; &#125;; ArchRuleDefinition.classes() .that(predicate) .should(condition1) .andShould(condition2) .because(\"å®šä¹‰åœ¨controlleråŒ…ä¸‹çš„Controllerç±»çš„ç±»åç§°ä»¥\\\"Controller\\\"ç»“å°¾ï¼Œæ–¹æ³•çš„å…¥å‚ç±»å‹å‘½åä»¥\\\"Request\\\"ç»“å°¾ï¼Œè¿”å›å‚æ•°å‘½åä»¥\\\"Response\\\"ç»“å°¾\") .check(classes); &#125;&#125; å› ä¸ºå¯¼å…¥äº†æ‰€æœ‰éœ€è¦çš„ç¼–è¯‘å¥½çš„ç±»çš„é™æ€å±æ€§ï¼ŒåŸºæœ¬ä¸Šæ˜¯å¯ä»¥ç¼–å†™æ‰€æœ‰èƒ½å¤Ÿæƒ³å‡ºæ¥çš„è§„çº¦ï¼Œæ›´å¤šçš„å†…å®¹æˆ–è€…å®ç°å¯ä»¥è‡ªè¡Œæ‘¸ç´¢ã€‚ å°ç»“ é€šè¿‡æœ€è¿‘çš„ä¸€ä¸ªé¡¹ç›®å¼•å…¥äº†Archunitï¼Œå¹¶ä¸”è¿›è¡Œäº†ä¸€äº›ç¼–ç è§„èŒƒå’Œæ¶æ„è§„èŒƒçš„è§„çº¦ï¼Œèµ·åˆ°äº†ååˆ†æ˜æ˜¾çš„æ•ˆæœã€‚ä¹‹å‰å£å¤´æˆ–è€…ä¹¦é¢æ–‡æ¡£çš„è§„èŒƒå¯ä»¥é€šè¿‡å•å…ƒæµ‹è¯•ç›´æ¥æ§åˆ¶ï¼Œé¡¹ç›®æ„å»ºçš„æ—¶å€™å¼ºåˆ¶å¿…é¡»æ‰§è¡Œå•å…ƒæµ‹è¯•ï¼Œåªæœ‰æ‰€æœ‰å•æµ‹é€šè¿‡æ‰èƒ½æ„å»ºå’Œæ‰“åŒ…(ç¦æ­¢ä½¿ç”¨-Dmaven.test.skip=trueå‚æ•°)ï¼Œèµ·åˆ°äº†ååˆ†æ˜æ˜¾çš„æˆæ•ˆã€‚ å‚è€ƒèµ„æ–™ï¼š User Guide (e-a-2019216 c-1-d)","categories":[{"name":"Framework","slug":"Framework","permalink":"http://throwable.club/blog/categories/Framework/"},{"name":"Archunit","slug":"Framework/Archunit","permalink":"http://throwable.club/blog/categories/Framework/Archunit/"}],"tags":[{"name":"Framework","slug":"Framework","permalink":"http://throwable.club/blog/tags/Framework/"},{"name":"Archunit","slug":"Archunit","permalink":"http://throwable.club/blog/tags/Archunit/"}]},{"title":"æ·±å…¥ç†è§£JDKä¸­çš„ReferenceåŸç†å’Œæºç å®ç°","slug":"java-reference","date":"2019-02-16T06:36:10.000Z","updated":"2019-02-16T06:51:54.552Z","comments":true,"path":"2019/02/16/java-reference/","link":"","permalink":"http://throwable.club/2019/02/16/java-reference/","excerpt":"","text":"æ·±å…¥ç†è§£JDKä¸­çš„ReferenceåŸç†å’Œæºç å®ç° å‰æ è¿™ç¯‡æ–‡ç« ä¸»è¦åŸºäºJDK11çš„æºç å’Œæœ€è¿‘ç¿»çœ‹çš„ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœº-2ndã€‹ä¸€ä¹¦çš„éƒ¨åˆ†å†…å®¹ï¼Œå¯¹JDK11ä¸­çš„Reference(å¼•ç”¨)åšä¸€äº›æ€»ç»“ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œé€šè¿‡ç¬”è€…å¯¹æ¯”ä¸€ä¸‹JDK11å’ŒJDK8å¯¹äºjava.lang.refåŒ…çš„ç›¸å…³å®ç°ï¼Œå‘ç°ä»£ç å˜åŒ–æ¯”è¾ƒå¤§ï¼Œå› æ­¤æœ¬æ–‡çš„æºç åˆ†æå¯èƒ½å¹¶ä¸é€‚åˆäºJDK11ä¹‹å¤–çš„JDKç‰ˆæœ¬ã€‚ Referenceçš„ç®€ä»‹å’Œåˆ†ç±» åœ¨JDK1.2ä¹‹å‰ï¼ŒJavaä¸­çš„å¼•ç”¨çš„å®šä¹‰æ˜¯ååˆ†ä¼ ç»Ÿçš„ï¼šå¦‚æœreferenceç±»å‹çš„æ•°æ®ä¸­å­˜å‚¨çš„æ•°å€¼ä»£è¡¨çš„æ˜¯å¦ä¸€å—å†…å­˜çš„èµ·å§‹åœ°å€ï¼Œå°±ç§°è¿™å—å†…å­˜ä»£è¡¨ç€ä¸€ä¸ªå¼•ç”¨ã€‚åœ¨è¿™ç§å®šä¹‰ä¹‹ä¸‹ï¼Œä¸€ä¸ªå¯¹è±¡åªæœ‰è¢«å¼•ç”¨å’Œæ²¡æœ‰è¢«å¼•ç”¨ä¸¤ç§çŠ¶æ€ã€‚ å®é™…ä¸Šï¼Œæˆ‘ä»¬æ›´å¸Œæœ›å­˜åœ¨è¿™æ ·çš„ä¸€ç±»å¯¹è±¡ï¼šå½“å†…å­˜ç©ºé—´è¿˜è¶³å¤Ÿçš„æ—¶å€™ï¼Œè¿™äº›å¯¹è±¡èƒ½å¤Ÿä¿ç•™åœ¨å†…å­˜ç©ºé—´ä¸­ï¼›å¦‚æœå½“å†…å­˜ç©ºé—´åœ¨è¿›è¡Œäº†åƒåœ¾æ”¶é›†ä¹‹åè¿˜æ˜¯éå¸¸ç´§å¼ ï¼Œåˆ™å¯ä»¥æŠ›å¼ƒè¿™äº›å¯¹è±¡ã€‚åŸºäºè¿™ç§ç‰¹æ€§ï¼Œå¯ä»¥æ»¡è¶³å¾ˆå¤šç³»ç»Ÿçš„ç¼“å­˜åŠŸèƒ½çš„ä½¿ç”¨åœºæ™¯ã€‚ java.lang.refåŒ…æ˜¯JDK1.2å¼•å…¥çš„ï¼ŒåŒ…ç»“æ„å’Œç±»åˆ†å¸ƒå¦‚ä¸‹ï¼š 12345678910- java.lang.ref - Cleaner.class - Finalizer.class - FinalizerHistogram.class - FinalReference.class - PhantomReference.class - Reference.class - ReferenceQueue.class - SoftReference.classs - WeakReference.class å¼•å…¥æ­¤åŒ…çš„ä½œç”¨æ˜¯å¯¹å¼•ç”¨çš„æ¦‚å¿µè¿›è¡Œäº†æ‰©å……ï¼Œå°†å¼•ç”¨åˆ†ä¸ºå¼ºå¼•ç”¨(Strong Reference)ã€è½¯å¼•ç”¨(Soft Reference)ã€å¼±å¼•ç”¨(Weak Reference)å’Œè™šå¼•ç”¨(Phantom Reference)å››ç§ç±»å‹çš„å¼•ç”¨ï¼Œè¿˜æœ‰ä¸€ç§æ¯”è¾ƒç‰¹æ®Šçš„å¼•ç”¨æ˜¯ææ„å¼•ç”¨(Final Reference)ï¼Œå®ƒæ˜¯ä¸€ç§ç‰¹åŒ–çš„è™šå¼•ç”¨ã€‚å››ç§å¼•ç”¨çš„å¼ºåº¦æŒ‰ç…§ä¸‹é¢çš„æ¬¡åºä¾æ¬¡å‡å¼±ï¼š 1StrongReference &gt; SoftReference &gt; WeakReference &gt; PhantomReference å€¼å¾—æ³¨æ„çš„æ˜¯ï¼š å¼ºå¼•ç”¨æ²¡æœ‰å¯¹åº”çš„ç±»å‹è¡¨ç¤ºï¼Œä¹Ÿå°±æ˜¯è¯´å¼ºå¼•ç”¨æ˜¯æ™®éå­˜åœ¨çš„ï¼Œå¦‚Object object = new Object();ã€‚ è½¯å¼•ç”¨ã€å¼±å¼•ç”¨å’Œè™šå¼•ç”¨éƒ½æ˜¯java.lang.ref.Referenceçš„ç›´æ¥å­ç±»ã€‚ ç›´åˆ°JDK11ä¸ºæ­¢ï¼Œåªå­˜åœ¨å››ç§å¼•ç”¨ï¼Œè¿™äº›å¼•ç”¨æ˜¯ç”±JVMåˆ›å»ºï¼Œå› æ­¤ç›´æ¥ç»§æ‰¿java.lang.ref.Referenceåˆ›å»ºè‡ªå®šä¹‰çš„å¼•ç”¨ç±»å‹æ˜¯æ— æ•ˆçš„ï¼Œä½†æ˜¯å¯ä»¥ç›´æ¥ç»§æ‰¿å·²ç»å­˜åœ¨çš„å¼•ç”¨ç±»å‹ï¼Œå¦‚java.lang.ref.Cleanerå°±æ˜¯ç»§æ‰¿è‡ªjava.lang.ref.PhantomReferenceã€‚ ç‰¹æ®Šçš„java.lang.ref.Referenceçš„å­ç±»java.lang.ref.FinalReferenceå’ŒObject#finalize()æœ‰å…³ï¼Œjava.lang.ref.Finalizeræ˜¯java.lang.ref.FinalReferenceå­ç±»ï¼Œä¸‹æ–‡ä¼šè¯¦ç»†åˆ†æè¿™äº›å†…å®¹ã€‚ Reference Referenceå°±æ˜¯å¼•ç”¨ï¼Œå¯¹JVMçš„åƒåœ¾æ”¶é›†æ´»åŠ¨æ•æ„Ÿ(å½“ç„¶ï¼Œå¼ºå¼•ç”¨å¯èƒ½å¯¹åƒåœ¾æ”¶é›†æ´»åŠ¨æ˜¯ä¸æ•æ„Ÿçš„)ï¼ŒReferenceçš„ç»§æ‰¿å…³ç³»æˆ–è€…å®ç°æ˜¯ç”±JDKå®šåˆ¶ï¼Œå¼•ç”¨å®ä¾‹æ˜¯ç”±JVMåˆ›å»ºï¼Œæ‰€ä»¥è‡ªè¡Œç»§æ‰¿Referenceå®ç°è‡ªå®šä¹‰çš„å¼•ç”¨ç±»å‹æ˜¯æ— æ„ä¹‰çš„ï¼Œä½†æ˜¯å¯ä»¥ç»§æ‰¿å·²ç»å­˜åœ¨çš„å¼•ç”¨ç±»å‹ï¼Œå¦‚SoftReferenceç­‰ã€‚Referenceç±»æ–‡ä»¶çš„æ³¨é‡Šä¹Ÿæ¯”è¾ƒç®€çŸ­ï¼Œä½†æ˜¯æ–¹æ³•å’Œå˜é‡çš„æ³¨é‡Šååˆ†è¯¦ç»†ï¼Œç‰¹åˆ«æ˜¯ç”¨å›¾è¡¨è¡¨æ˜äº†çŠ¶æ€è·ƒè¿çš„è¿‡ç¨‹ï¼Œè¿™é‡Œå…ˆçœ‹ç±»æ–‡ä»¶å¤´æ³¨é‡Šï¼š Abstract base class for reference objects. This class defines the operations common to all reference objects. Because reference objects are implemented in close cooperation with the garbage collector, this class may not be subclassed directly. ç¿»è¯‘ä¸€ä¸‹å¤§æ„æ˜¯ï¼šReferenceæ˜¯æ‰€æœ‰å¼•ç”¨å¯¹è±¡çš„åŸºç±»ã€‚è¿™ä¸ªç±»å®šä¹‰äº†æ‰€æœ‰å¼•ç”¨å¯¹è±¡çš„é€šç”¨æ“ä½œã€‚å› ä¸ºå¼•ç”¨å¯¹è±¡æ˜¯ä¸åƒåœ¾æ”¶é›†å™¨ç´§å¯†åä½œè€Œå®ç°çš„ï¼Œæ‰€ä»¥è¿™ä¸ªç±»å¯èƒ½ä¸èƒ½ç›´æ¥å­ç±»åŒ–ã€‚ Referenceçš„çŠ¶æ€é›†åˆ Referenceæºç ä¸­å¹¶ä¸å­˜åœ¨ä¸€ä¸ªæˆå‘˜å˜é‡ç”¨äºæè¿°Referenceçš„çŠ¶æ€ï¼Œå®ƒæ˜¯é€šè¿‡ç»„åˆåˆ¤æ–­referentã€discoveredã€queueã€nextæˆå‘˜çš„å­˜åœ¨æ€§æˆ–è€…é¡ºåº&quot;æ‹¼å‡‘å‡º&quot;å¯¹åº”çš„çŠ¶æ€ï¼Œæ³¨é‡Šä¸­æè¿°å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031ä¸€ä¸ªå¼•ç”¨å¯¹è±¡å¯ä»¥åŒæ—¶å­˜åœ¨ä¸¤ç§çŠ¶æ€ï¼š- ç¬¬ä¸€ç»„çŠ¶æ€ï¼š\"active\", \"pending\", or \"inactive\"- ç¬¬äºŒç»„çŠ¶æ€ï¼š\"registered\", \"enqueued\", \"dequeued\", or \"unregistered\"Activeï¼šå½“å‰å¼•ç”¨å®ä¾‹å¤„äºActiveçŠ¶æ€ï¼Œä¼šæ”¶åˆ°åƒåœ¾æ”¶é›†å™¨çš„ç‰¹æ®Šå¤„ç†ã€‚åœ¨åƒåœ¾æ”¶é›†å™¨æ£€æµ‹åˆ°referentçš„å¯è¾¾æ€§å·²æ›´æ”¹ä¸ºé€‚å½“çŠ¶æ€ä¹‹åçš„æŸä¸ªæ—¶é—´ï¼Œåƒåœ¾æ”¶é›†å™¨ä¼š\"é€šçŸ¥\"å½“å‰å¼•ç”¨å®ä¾‹æ”¹å˜å…¶çŠ¶æ€ä¸º\"pending\"æˆ–è€…\"inactive\"ã€‚æ­¤æ—¶çš„åˆ¤æ–­æ¡ä»¶æ˜¯ï¼šreferent != null; discovered = nullæˆ–è€…å®ä¾‹ä½äºGCçš„discoveredåˆ—è¡¨ä¸­ã€‚Pendingï¼šå½“å‰çš„å¼•ç”¨å®ä¾‹æ˜¯pending-Referenceåˆ—è¡¨çš„ä¸€ä¸ªå…ƒç´ ï¼Œç­‰å¾…è¢«ReferenceHandlerçº¿ç¨‹å¤„ç†ã€‚pending-Referenceåˆ—è¡¨é€šè¿‡åº”ç”¨å®ä¾‹çš„discoveredå­—æ®µè¿›è¡Œå…³è”ã€‚æ­¤æ—¶çš„åˆ¤æ–­æ¡ä»¶æ˜¯ï¼šreferent = null; discovered = pending-Referenceåˆ—è¡¨ä¸­çš„ä¸‹ä¸€ä¸ªå…ƒç´ Inactiveï¼šå½“å‰çš„å¼•ç”¨å®ä¾‹å¤„äºéActiveå’ŒéPendingçŠ¶æ€ã€‚æ­¤æ—¶çš„åˆ¤æ–­æ¡ä»¶æ˜¯ï¼šreferent = null (åŒæ—¶discovered = null)Registeredï¼šå½“å‰çš„å¼•ç”¨å®ä¾‹åˆ›å»ºçš„æ—¶å€™å…³è”åˆ°ä¸€ä¸ªå¼•ç”¨é˜Ÿåˆ—å®ä¾‹ï¼Œä½†æ˜¯å¼•ç”¨å®ä¾‹æš‚æœªåŠ å…¥åˆ°é˜Ÿåˆ—ä¸­ã€‚æ­¤æ—¶çš„åˆ¤æ–­æ¡ä»¶æ˜¯ï¼šqueue = ä¼ å…¥çš„ReferenceQueueå®ä¾‹Enqueuedï¼šå½“å‰çš„å¼•ç”¨å®ä¾‹å·²ç»æ·»åŠ åˆ°å’Œå®ƒå…³è”çš„å¼•ç”¨é˜Ÿåˆ—ä¸­ä½†æ˜¯å°šæœªç§»é™¤(remove)ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨äº†ReferenceQueue.enqueued()åçš„Referenceå®ä¾‹å°±ä¼šå¤„äºè¿™ä¸ªçŠ¶æ€ã€‚æ­¤æ—¶çš„åˆ¤æ–­æ¡ä»¶æ˜¯ï¼šqueue = ReferenceQueue.ENQUEUE; next = å¼•ç”¨åˆ—è¡¨ä¸­çš„ä¸‹ä¸€ä¸ªå¼•ç”¨å®ä¾‹ï¼Œæˆ–è€…å¦‚æœå½“å‰å¼•ç”¨å®ä¾‹æ˜¯å¼•ç”¨åˆ—è¡¨ä¸­çš„æœ€åä¸€ä¸ªå…ƒç´ ï¼Œåˆ™å®ƒä¼šè¿›å…¥InactiveçŠ¶æ€Dequeuedï¼šå½“å‰çš„å¼•ç”¨å®ä¾‹æ›¾ç»æ·»åŠ åˆ°å’Œå®ƒå…³è”çš„å¼•ç”¨é˜Ÿåˆ—ä¸­å¹¶ä¸”å·²ç»ç§»é™¤(remove)ã€‚æ­¤æ—¶çš„åˆ¤æ–­æ¡ä»¶æ˜¯ï¼šqueue = ReferenceQueue.NULL; next = å½“å‰çš„å¼•ç”¨å®ä¾‹Unregisteredï¼šå½“å‰çš„å¼•ç”¨å®ä¾‹ä¸å­˜åœ¨å…³è”çš„å¼•ç”¨é˜Ÿåˆ—ï¼Œä¹Ÿå°±æ˜¯åˆ›å»ºå¼•ç”¨å®ä¾‹çš„æ—¶å€™ä¼ å…¥çš„queueä¸ºnullã€‚æ­¤æ—¶çš„åˆ¤æ–­æ¡ä»¶æ˜¯ï¼šqueue = ReferenceQueue.NULL çŠ¶æ€è·ƒè¿çš„æ—¶åºå›¾å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051* Initial states:* [active/registered]* [active/unregistered] [1]** Transitions:* clear* [active/registered] -------&gt; [inactive/registered]* | |* | | enqueue [2]* | GC enqueue [2] |* | -----------------|* | |* v |* [pending/registered] --- v* | | ReferenceHandler* | enqueue [2] |---&gt; [inactive/enqueued]* v | |* [pending/enqueued] --- |* | | poll/remove* | poll/remove |* | |* v ReferenceHandler v* [pending/dequeued] ------&gt; [inactive/dequeued]*** clear/enqueue/GC [3]* [active/unregistered] ------* | |* | GC |* | |--&gt; [inactive/unregistered]* v |* [pending/unregistered] ------* ReferenceHandler** Terminal states:* [inactive/dequeued]* [inactive/unregistered]** Unreachable states (because enqueue also clears):* [active/enqeued]* [active/dequeued]** [1] Unregistered is not permitted for FinalReferences.** [2] These transitions are not possible for FinalReferences, making* [pending/enqueued] and [pending/dequeued] unreachable, and* [inactive/registered] terminal.** [3] The garbage collector may directly transition a Reference* from [active/unregistered] to [inactive/unregistered],* bypassing the pending-Reference list. æ³¨é‡Šä¸­è¿˜å¼ºè°ƒäº†å‡ ç‚¹ï¼š åˆå§‹åŒ–çŠ¶æ€ï¼š[active/registered]å’Œ[active/unregistered](è¿™ç§æƒ…å†µåªé™äºFinalReferences)ã€‚ ç»ˆç»“çŠ¶æ€ï¼š[inactive/dequeued]å’Œ[inactive/unregistered]ã€‚ ä¸å¯èƒ½å‡ºç°çš„çŠ¶æ€ï¼š[active/enqeued]å’Œ[active/dequeued]ã€‚ ä¸Šé¢çš„å›¾çœ‹èµ·æ¥å¯èƒ½æ¯”è¾ƒæŠ½è±¡ï¼ŒReferenceHandlerå…¶å®æ˜¯Referenceä¸­é™æ€ä»£ç å—ä¸­åˆå§‹åŒ–çš„çº¿ç¨‹å®ä¾‹ï¼Œä¸»è¦ä½œç”¨æ˜¯ï¼šå¤„ç†pendingçŠ¶æ€çš„å¼•ç”¨å®ä¾‹ï¼Œä½¿å®ƒä»¬å…¥é˜Ÿåˆ—å¹¶èµ°å‘[inactive/dequeued]çŠ¶æ€ã€‚å¦å¤–ï¼Œä¸Šé¢çš„çº¿æ¡†å›¾æ˜¯åˆ†ä¸¤éƒ¨åˆ†ï¼Œå…¶ä¸­ä¸ŠåŠéƒ¨åˆ†æ˜¯ä½¿ç”¨äº†ReferenceQueueï¼ŒååŠéƒ¨åˆ†æ˜¯æ²¡æœ‰ä½¿ç”¨ReferenceQueue(æˆ–è€…è¯´ä½¿ç”¨äº†ReferenceQueue.NULL)ã€‚è¿™é‡Œå°è¯•ç”¨PPTç”»ä¸€ä¸‹ç®€åŒ–çš„çŠ¶æ€è·ƒè¿å›¾ï¼š Referenceæºç åˆ†æ å…ˆçœ‹Referenceçš„æ„é€ å‡½æ•°å’Œæˆå‘˜å˜é‡ï¼š 123456789101112131415public abstract class Reference&lt;T&gt; &#123; private T referent; volatile ReferenceQueue&lt;? super T&gt; queue; volatile Reference next; private transient Reference&lt;T&gt; discovered; Reference(T referent) &#123; this(referent, null); &#125; Reference(T referent, ReferenceQueue&lt;? super T&gt; queue) &#123; this.referent = referent; this.queue = (queue == null) ? ReferenceQueue.NULL : queue; &#125;&#125; æ„é€ æè¿°ï¼š æ„é€ å‡½æ•°ä¾èµ–äºä¸€ä¸ªæ³›å‹çš„referentæˆå‘˜ä»¥åŠä¸€ä¸ªReferenceQueue&lt;? super T&gt;çš„é˜Ÿåˆ—ï¼Œå¦‚æœReferenceQueueå®ä¾‹ä¸ºnullï¼Œåˆ™ä½¿ç”¨ReferenceQueue.NULLã€‚ æˆå‘˜å˜é‡æè¿°ï¼š referentï¼šReferenceä¿å­˜çš„å¼•ç”¨æŒ‡å‘çš„å¯¹è±¡ï¼Œä¸‹é¢ç›´æ¥ç§°ä¸ºreferentã€‚ 12// GCç‰¹æ®Šå¤„ç†çš„å¯¹è±¡private T referent; /* Treated specially by GC */ queueï¼šReferenceå¯¹è±¡å…³è”çš„é˜Ÿåˆ—ï¼Œä¹Ÿå°±æ˜¯å¼•ç”¨é˜Ÿåˆ—ï¼Œå¯¹è±¡å¦‚æœå³å°†è¢«åƒåœ¾æ”¶é›†å™¨å›æ”¶ï¼Œæ­¤é˜Ÿåˆ—ä½œä¸ºé€šçŸ¥çš„å›è°ƒé˜Ÿåˆ—ï¼Œä¹Ÿå°±æ˜¯å½“Referenceå®ä¾‹æŒæœ‰çš„å¯¹è±¡referentè¦è¢«å›æ”¶çš„æ—¶å€™ï¼ŒReferenceå®ä¾‹ä¼šè¢«æ”¾å…¥å¼•ç”¨é˜Ÿåˆ—ï¼Œé‚£ä¹ˆç¨‹åºæ‰§è¡Œçš„æ—¶å€™å¯ä»¥ä»å¼•ç”¨é˜Ÿåˆ—å¾—åˆ°æˆ–è€…ç›‘æ§ç›¸åº”çš„Referenceå®ä¾‹ã€‚ 123456789/* The queue this reference gets enqueued to by GC notification or by * calling enqueue(). * * When registered: the queue with which this reference is registered. * enqueued: ReferenceQueue.ENQUEUE * dequeued: ReferenceQueue.NULL * unregistered: ReferenceQueue.NULL */volatile ReferenceQueue&lt;? super T&gt; queue; nextï¼šä¸‹ä¸€ä¸ªReferenceå®ä¾‹çš„å¼•ç”¨ï¼ŒReferenceå®ä¾‹é€šè¿‡æ­¤æ„é€ å•å‘çš„é“¾è¡¨ã€‚ 123456789/* The link in a ReferenceQueue's list of Reference objects. * * When registered: null * enqueued: next element in queue (or this if last) * dequeued: this (marking FinalReferences as inactive) * unregistered: null */@SuppressWarnings(\"rawtypes\")volatile Reference next; discoveredï¼šæ³¨æ„è¿™ä¸ªå±æ€§ç”±transientä¿®é¥°ï¼ŒåŸºäºçŠ¶æ€è¡¨ç¤ºä¸åŒé“¾è¡¨ä¸­çš„ä¸‹ä¸€ä¸ªå¾…å¤„ç†çš„å¯¹è±¡ï¼Œä¸»è¦æ˜¯pending-referenceåˆ—è¡¨çš„ä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œé€šè¿‡JVMç›´æ¥è°ƒç”¨èµ‹å€¼ã€‚ 12345/* When active: next element in a discovered reference list maintained by GC (or this if last)* pending: next element in the pending list (or null if last)* otherwise: NULL*/transient private Reference&lt;T&gt; discovered; /* used by VM */ å®ä¾‹æ–¹æ³•(å’ŒReferenceHandlerçº¿ç¨‹ä¸ç›¸å…³çš„æ–¹æ³•)ï¼š 1234567891011121314151617181920212223242526272829303132// è·å–æŒæœ‰çš„referentå®ä¾‹@HotSpotIntrinsicCandidatepublic T get() &#123; return this.referent;&#125;// æŠŠæŒæœ‰çš„referentå®ä¾‹ç½®ä¸ºnullpublic void clear() &#123; this.referent = null;&#125;// åˆ¤æ–­æ˜¯å¦å¤„äºenqeuedçŠ¶æ€public boolean isEnqueued() &#123; return (this.queue == ReferenceQueue.ENQUEUED);&#125;// å…¥é˜Ÿå‚æ•°ï¼ŒåŒæ—¶ä¼šæŠŠreferentç½®ä¸ºnullpublic boolean enqueue() &#123; this.referent = null; return this.queue.enqueue(this);&#125;// è¦†ç›–cloneæ–¹æ³•å¹¶ä¸”æŠ›å‡ºå¼‚å¸¸ï¼Œä¹Ÿå°±æ˜¯ç¦æ­¢clone@Overrideprotected Object clone() throws CloneNotSupportedException &#123; throw new CloneNotSupportedException();&#125;// ç¡®ä¿ç»™å®šçš„å¼•ç”¨å®ä¾‹æ˜¯å¼ºå¯è¾¾çš„@ForceInlinepublic static void reachabilityFence(Object ref) &#123;&#125; ReferenceHandlerçº¿ç¨‹ ReferenceHandlerçº¿ç¨‹æ˜¯ç”±Referenceé™æ€ä»£ç å—ä¸­å»ºç«‹å¹¶ä¸”è¿è¡Œçš„çº¿ç¨‹ï¼Œå®ƒçš„è¿è¡Œæ–¹æ³•ä¸­ä¾èµ–äº†æ¯”è¾ƒå¤šçš„æœ¬åœ°(native)æ–¹æ³•ï¼ŒReferenceHandlerçº¿ç¨‹çš„ä¸»è¦åŠŸèƒ½æ˜¯å¤„ç†pendingé“¾è¡¨ä¸­çš„å¼•ç”¨å¯¹è±¡ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293// ReferenceHandlerç›´æ¥ç»§æ‰¿äºThreadè¦†ç›–äº†runæ–¹æ³•private static class ReferenceHandler extends Thread &#123; // é™æ€å·¥å…·æ–¹æ³•ç”¨äºç¡®ä¿å¯¹åº”çš„ç±»å‹å·²ç»åˆå§‹åŒ– private static void ensureClassInitialized(Class&lt;?&gt; clazz) &#123; try &#123; Class.forName(clazz.getName(), true, clazz.getClassLoader()); &#125; catch (ClassNotFoundException e) &#123; throw (Error) new NoClassDefFoundError(e.getMessage()).initCause(e); &#125; &#125; static &#123; // ç¡®ä¿Cleanerè¿™ä¸ªç±»å·²ç»åˆå§‹åŒ– // pre-load and initialize Cleaner class so that we don't // get into trouble later in the run loop if there's // memory shortage while loading/initializing it lazily. ensureClassInitialized(Cleaner.class); &#125; ReferenceHandler(ThreadGroup g, String name) &#123; super(g, null, name, 0, false); &#125; // æ³¨æ„runæ–¹æ³•æ˜¯ä¸€ä¸ªæ­»å¾ªç¯æ‰§è¡ŒprocessPendingReferences public void run() &#123; while (true) &#123; processPendingReferences(); &#125; &#125;&#125;/* åŸå­è·å–(å)å¹¶ä¸”æ¸…ç†VMä¸­çš„pendingå¼•ç”¨é“¾è¡¨ * Atomically get and clear (set to null) the VM's pending-Reference list. */private static native Reference&lt;Object&gt; getAndClearReferencePendingList();/* æ£€éªŒVMä¸­çš„pendingå¼•ç”¨å¯¹è±¡é“¾è¡¨æ˜¯å¦æœ‰å‰©ä½™å…ƒç´  * Test whether the VM's pending-Reference list contains any entries. */private static native boolean hasReferencePendingList();/* ç­‰å¾…ç›´åˆ°pendingå¼•ç”¨å¯¹è±¡é“¾è¡¨ä¸ä¸ºnullï¼Œæ­¤æ–¹æ³•é˜»å¡çš„å…·ä½“å®ç°åˆVMå®ç° * Wait until the VM's pending-Reference list may be non-null. */private static native void waitForReferencePendingList();// é”å¯¹è±¡ï¼Œç”¨äºæ§åˆ¶ç­‰å¾…pendingå¯¹è±¡æ—¶å€™çš„åŠ é”å’Œå¼€å§‹å¤„ç†è¿™äº›å¯¹è±¡æ—¶å€™çš„è§£é”private static final Object processPendingLock = new Object();// æ­£åœ¨å¤„ç†pendingå¯¹è±¡çš„æ—¶å€™ï¼Œè¿™ä¸ªå˜é‡ä¼šæ›´æ–°ä¸ºtrueï¼Œå¤„ç†å®Œæ¯•æˆ–è€…åˆå§‹åŒ–çŠ¶æ€ä¸ºfalseï¼Œç”¨äºé¿å…é‡å¤å¤„ç†æˆ–è€…é‡å¤ç­‰å¾…private static boolean processPendingActive = false;// è¿™ä¸ªæ˜¯æ­»å¾ªç¯ä¸­çš„æ ¸å¿ƒæ–¹æ³•ï¼ŒåŠŸèƒ½æ˜¯å¤„ç†pendingé“¾è¡¨ä¸­çš„å¼•ç”¨å…ƒç´ private static void processPendingReferences() &#123; // Only the singleton reference processing thread calls // waitForReferencePendingList() and getAndClearReferencePendingList(). // These are separate operations to avoid a race with other threads // that are calling waitForReferenceProcessing(). // ï¼ˆ1ï¼‰ç­‰å¾… waitForReferencePendingList(); Reference&lt;Object&gt; pendingList; synchronized (processPendingLock) &#123; // ï¼ˆ2ï¼‰è·å–å¹¶æ¸…ç†ï¼Œæ ‡è®°å¤„ç†ä¸­çŠ¶æ€ pendingList = getAndClearReferencePendingList(); processPendingActive = true; &#125; // ï¼ˆ3ï¼‰é€šè¿‡discovered(ä¸‹ä¸€ä¸ªå…ƒç´ )éå†pendingé“¾è¡¨è¿›è¡Œå¤„ç† while (pendingList != null) &#123; Reference&lt;Object&gt; ref = pendingList; pendingList = ref.discovered; ref.discovered = null; // å¦‚æœæ˜¯Cleanerç±»å‹æ‰§è¡Œæ‰§è¡Œcleanæ–¹æ³•å¹¶ä¸”å¯¹é”å¯¹è±¡processPendingLockè¿›è¡Œå”¤é†’æ‰€æœ‰é˜»å¡çš„çº¿ç¨‹ if (ref instanceof Cleaner) &#123; ((Cleaner)ref).clean(); // Notify any waiters that progress has been made. // This improves latency for nio.Bits waiters, which // are the only important ones. synchronized (processPendingLock) &#123; processPendingLock.notifyAll(); &#125; &#125; else &#123; // éCleanerç±»å‹å¹¶ä¸”å¼•ç”¨é˜Ÿåˆ—ä¸ä¸ºReferenceQueue.NULLåˆ™è¿›è¡Œå…¥é˜Ÿæ“ä½œ ReferenceQueue&lt;? super Object&gt; q = ref.queue; if (q != ReferenceQueue.NULL) q.enqueue(ref); &#125; &#125; // ï¼ˆ4ï¼‰å½“æ¬¡å¾ªç¯ç»“æŸä¹‹å‰å†æ¬¡å”¤é†’é”å¯¹è±¡processPendingLockä¸Šé˜»å¡çš„æ‰€æœ‰çº¿ç¨‹ // Notify any waiters of completion of current round. synchronized (processPendingLock) &#123; processPendingActive = false; processPendingLock.notifyAll(); &#125;&#125; ReferenceHandlerçº¿ç¨‹å¯åŠ¨çš„é™æ€ä»£ç å—å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243static &#123; // ThreadGroupç»§æ‰¿å½“å‰æ‰§è¡Œçº¿ç¨‹(ä¸€èˆ¬æ˜¯ä¸»çº¿ç¨‹)çš„çº¿ç¨‹ç»„ ThreadGroup tg = Thread.currentThread().getThreadGroup(); for (ThreadGroup tgn = tg; tgn != null; tg = tgn, tgn = tg.getParent()); // åˆ›å»ºçº¿ç¨‹å®ä¾‹ï¼Œå‘½åä¸ºReference Handlerï¼Œé…ç½®æœ€é«˜ä¼˜å…ˆçº§å’Œåå°è¿è¡Œ(å®ˆæŠ¤çº¿ç¨‹)ï¼Œç„¶åå¯åŠ¨ Thread handler = new ReferenceHandler(tg, \"Reference Handler\"); /* If there were a special system-only priority greater than * MAX_PRIORITY, it would be used here */ handler.setPriority(Thread.MAX_PRIORITY); handler.setDaemon(true); handler.start(); // æ³¨æ„è¿™é‡Œè¦†ç›–äº†å…¨å±€çš„jdk.internal.misc.JavaLangRefAccesså®ç° // provide access in SharedSecrets SharedSecrets.setJavaLangRefAccess(new JavaLangRefAccess() &#123; @Override public boolean waitForReferenceProcessing() throws InterruptedException&#123; return Reference.waitForReferenceProcessing(); &#125; @Override public void runFinalization() &#123; Finalizer.runFinalization(); &#125; &#125;);&#125;// å¦‚æœæ­£åœ¨å¤„ç†pendingé“¾è¡¨ä¸­çš„å¼•ç”¨å¯¹è±¡æˆ–è€…ç›‘æµ‹åˆ°VMä¸­çš„pendingé“¾è¡¨ä¸­è¿˜æœ‰å‰©ä½™å…ƒç´ åˆ™åŸºäºé”å¯¹è±¡processPendingLockè¿›è¡Œç­‰å¾…private static boolean waitForReferenceProcessing() throws InterruptedException&#123; synchronized (processPendingLock) &#123; if (processPendingActive || hasReferencePendingList()) &#123; // Wait for progress, not necessarily completion. processPendingLock.wait(); return true; &#125; else &#123; return false; &#125; &#125;&#125; ç”±äºReferenceHandlerçº¿ç¨‹æ˜¯Referenceçš„é™æ€ä»£ç åˆ›å»ºçš„ï¼Œæ‰€ä»¥åªè¦Referenceè¿™ä¸ªçˆ¶ç±»è¢«åˆå§‹åŒ–ï¼Œè¯¥çº¿ç¨‹å°±ä¼šåˆ›å»ºå’Œè¿è¡Œï¼Œç”±äºå®ƒæ˜¯å®ˆæŠ¤çº¿ç¨‹ï¼Œé™¤éJVMè¿›ç¨‹ç»ˆç»“ï¼Œå¦åˆ™å®ƒä¼šä¸€ç›´åœ¨åå°è¿è¡Œ(æ³¨æ„å®ƒçš„run()æ–¹æ³•é‡Œé¢ä½¿ç”¨äº†æ­»å¾ªç¯)ã€‚ ReferenceQueue JDKä¸­å¯¹ReferenceQueueçš„æ–‡æ¡£æè¿°æ˜¯æ¯”è¾ƒå°‘çš„ï¼Œç±»æ–‡ä»¶åªæœ‰ä¸€å¥ç®€å•çš„æ³¨é‡Šï¼š Reference queues, to which registered reference objects are appended by the garbage collector after the appropriate reachability changes are detected. ç¿»è¯‘ä¸€ä¸‹å¤§æ„ä¸ºï¼šå¼•ç”¨é˜Ÿåˆ—ï¼Œåƒåœ¾æ”¶é›†å™¨åœ¨æ£€æµ‹åˆ°é€‚å½“çš„å¯è¾¾æ€§æ›´æ”¹åå°†å·²æ³¨å†Œçš„å¼•ç”¨å¯¹è±¡è¿½åŠ åˆ°è¯¥é˜Ÿåˆ—ã€‚ ä»æºç ä¸Šçœ‹ï¼Œå®é™…ä¸ŠReferenceQueueåªæ˜¯åä¹‰ä¸Šçš„å¼•ç”¨é˜Ÿåˆ—ï¼Œå®ƒåªä¿å­˜äº†Referenceé“¾è¡¨çš„å¤´(head)èŠ‚ç‚¹ï¼Œå¹¶ä¸”æä¾›äº†å‡ºé˜Ÿã€å…¥é˜Ÿå’Œç§»é™¤ç­‰æ“ä½œï¼Œè€ŒReferenceå®é™…ä¸Šæœ¬èº«æä¾›å•å‘é“¾è¡¨çš„åŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯Referenceé€šè¿‡æˆå‘˜å±æ€§nextæ„å»ºå•å‘é“¾è¡¨ï¼Œè€Œé“¾è¡¨çš„æ“ä½œæ˜¯å§”æ‰˜ç»™ReferenceQueueå®Œæˆï¼Œè¿™é‡Œçš„é€»è¾‘æœ‰ç‚¹ç»•ã€‚ReferenceQueueçš„æºç æ¯”è¾ƒå°‘ï¼Œè¿™é‡Œå…¨é‡è´´å‡ºæ ‡æ³¨ä¸€ä¸‹æ³¨é‡Šï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146public class ReferenceQueue&lt;T&gt; &#123; public ReferenceQueue() &#123; &#125; // å†…éƒ¨ç±»Nullç±»ç»§æ‰¿è‡ªReferenceQueueï¼Œè¦†ç›–äº†enqueueæ–¹æ³•è¿”å›false private static class Null extends ReferenceQueue&lt;Object&gt; &#123; boolean enqueue(Reference&lt;?&gt; r) &#123; return false; &#125; &#125; // ReferenceQueue.NULLå’ŒReferenceQueue.ENQUEUEDéƒ½æ˜¯å†…éƒ¨ç±»Nullçš„æ–°å®ä¾‹ static final ReferenceQueue&lt;Object&gt; NULL = new Null(); static final ReferenceQueue&lt;Object&gt; ENQUEUED = new Null(); // é™æ€å†…éƒ¨ç±»ï¼Œä½œä¸ºé”å¯¹è±¡ private static class Lock &#123; &#125;; // é”å®ä¾‹ private final Lock lock = new Lock(); // å¼•ç”¨é“¾è¡¨çš„å¤´èŠ‚ç‚¹ private volatile Reference&lt;? extends T&gt; head; // å¼•ç”¨é˜Ÿåˆ—é•¿åº¦ï¼Œå…¥é˜Ÿåˆ™å¢åŠ 1ï¼Œå‡ºé˜Ÿåˆ™å‡å°‘1 private long queueLength = 0; // å…¥é˜Ÿæ“ä½œï¼Œåªä¼šè¢«Referenceå®ä¾‹è°ƒç”¨ boolean enqueue(Reference&lt;? extends T&gt; r) &#123; /* Called only by Reference class */ // åŠ é” synchronized (lock) &#123; // Check that since getting the lock this reference hasn't already been // enqueued (and even then removed) // å¦‚æœå¼•ç”¨å®ä¾‹æŒæœ‰çš„é˜Ÿåˆ—ä¸ºReferenceQueue.NULLæˆ–è€…ReferenceQueue.ENQUEUEDåˆ™å…¥é˜Ÿå¤±è´¥è¿”å›false ReferenceQueue&lt;?&gt; queue = r.queue; if ((queue == NULL) || (queue == ENQUEUED)) &#123; return false; &#125; assert queue == this; // Self-loop end, so if a FinalReference it remains inactive. // å¦‚æœé“¾è¡¨æ²¡æœ‰å…ƒç´ ï¼Œåˆ™æ­¤å¼•ç”¨å®ä¾‹ç›´æ¥ä½œä¸ºå¤´èŠ‚ç‚¹ï¼Œå¦åˆ™æŠŠå‰ä¸€ä¸ªå¼•ç”¨å®ä¾‹ä½œä¸ºä¸‹ä¸€ä¸ªèŠ‚ç‚¹ r.next = (head == null) ? r : head; // å½“å‰å®ä¾‹æ›´æ–°ä¸ºå¤´èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸€ä¸ªæ–°å…¥é˜Ÿçš„å¼•ç”¨å®ä¾‹éƒ½æ˜¯ä½œä¸ºå¤´èŠ‚ç‚¹ï¼Œå·²æœ‰çš„å¼•ç”¨å®ä¾‹ä¼šä½œä¸ºåç»§èŠ‚ç‚¹ head = r; // é˜Ÿåˆ—é•¿åº¦å¢åŠ 1 queueLength++; // Update r.queue *after* adding to list, to avoid race // with concurrent enqueued checks and fast-path poll(). // Volatiles ensure ordering. // å½“å‰å¼•ç”¨å®ä¾‹å·²ç»å…¥é˜Ÿï¼Œé‚£ä¹ˆå®ƒæœ¬èº«æŒæœ‰çš„å¼•ç”¨é˜Ÿåˆ—å®ä¾‹ç½®ä¸ºReferenceQueue.ENQUEUED r.queue = ENQUEUED; // ç‰¹æ®Šå¤„ç†FinalReferenceï¼ŒVMè¿›è¡Œè®¡æ•° if (r instanceof FinalReference) &#123; VM.addFinalRefCount(1); &#125; // å”¤é†’æ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹ lock.notifyAll(); return true; &#125; &#125; // å¼•ç”¨é˜Ÿåˆ—çš„pollæ“ä½œï¼Œæ­¤æ–¹æ³•å¿…é¡»åœ¨åŠ é”æƒ…å†µä¸‹è°ƒç”¨ private Reference&lt;? extends T&gt; reallyPoll() &#123; /* Must hold lock */ Reference&lt;? extends T&gt; r = head; if (r != null) &#123; r.queue = NULL; // Update r.queue *before* removing from list, to avoid // race with concurrent enqueued checks and fast-path // poll(). Volatiles ensure ordering. @SuppressWarnings(\"unchecked\") Reference&lt;? extends T&gt; rn = r.next; // Handle self-looped next as end of list designator. // æ›´æ–°nextèŠ‚ç‚¹ä¸ºå¤´èŠ‚ç‚¹ï¼Œå¦‚æœnextèŠ‚ç‚¹ä¸ºè‡ªèº«ï¼Œè¯´æ˜å·²ç»èµ°è¿‡ä¸€æ¬¡å‡ºé˜Ÿï¼Œåˆ™è¿”å›null head = (rn == r) ? null : rn; // Self-loop next rather than setting to null, so if a // FinalReference it remains inactive. // å½“å‰å¤´èŠ‚ç‚¹å˜æ›´ä¸ºç¯çŠ¶é˜Ÿåˆ—ï¼Œè€ƒè™‘åˆ°FinalReferenceå°šä¸ºinactiveå’Œé¿å…é‡å¤å‡ºé˜Ÿçš„é—®é¢˜ r.next = r; // é˜Ÿåˆ—é•¿åº¦å‡å°‘1 queueLength--; // ç‰¹æ®Šå¤„ç†FinalReferenceï¼ŒVMè¿›è¡Œè®¡æ•° if (r instanceof FinalReference) &#123; VM.addFinalRefCount(-1); &#125; return r; &#125; return null; &#125; // é˜Ÿåˆ—çš„å…¬æœ‰pollæ“ä½œï¼Œä¸»è¦æ˜¯åŠ é”åè°ƒç”¨reallyPoll public Reference&lt;? extends T&gt; poll() &#123; if (head == null) return null; synchronized (lock) &#123; return reallyPoll(); &#125; &#125; // ç§»é™¤å¼•ç”¨é˜Ÿåˆ—ä¸­çš„ä¸‹ä¸€ä¸ªå¼•ç”¨å…ƒç´ ï¼Œå®é™…ä¸Šä¹Ÿæ˜¯ä¾èµ–äºreallyPollçš„Objectæä¾›çš„é˜»å¡æœºåˆ¶ public Reference&lt;? extends T&gt; remove(long timeout) throws IllegalArgumentException, InterruptedException&#123; if (timeout &lt; 0) &#123; throw new IllegalArgumentException(\"Negative timeout value\"); &#125; synchronized (lock) &#123; Reference&lt;? extends T&gt; r = reallyPoll(); if (r != null) return r; long start = (timeout == 0) ? 0 : System.nanoTime(); for (;;) &#123; lock.wait(timeout); r = reallyPoll(); if (r != null) return r; if (timeout != 0) &#123; long end = System.nanoTime(); timeout -= (end - start) / 1000_000; if (timeout &lt;= 0) return null; start = end; &#125; &#125; &#125; &#125; // removeï¼Œè¶…æ—¶æ—¶é—´ä¸º0ï¼Œå®é™…ä¸Šå°±æ˜¯lock.wait(0)å°±æ˜¯æ°¸ä¹…é˜»å¡ç›´è‡³å”¤é†’ public Reference&lt;? extends T&gt; remove() throws InterruptedException &#123; return remove(0); &#125; // foreach void forEach(Consumer&lt;? super Reference&lt;? extends T&gt;&gt; action) &#123; for (Reference&lt;? extends T&gt; r = head; r != null;) &#123; action.accept(r); @SuppressWarnings(\"unchecked\") Reference&lt;? extends T&gt; rn = r.next; if (rn == r) &#123; if (r.queue == ENQUEUED) &#123; // still enqueued -&gt; we reached end of chain r = null; &#125; else &#123; // already dequeued: r.queue == NULL; -&gt; // restart from head when overtaken by queue poller(s) r = head; &#125; &#125; else &#123; // next in chain r = rn; &#125; &#125; &#125; &#125; ReferenceQueueçš„æºç ååˆ†ç®€å•ï¼Œè¿˜æ˜¯é‡æ–°æä¸€ä¸‹ï¼Œå®ƒåªå­˜å‚¨äº†Referenceé“¾è¡¨çš„å¤´èŠ‚ç‚¹ï¼ŒçœŸæ­£çš„Referenceé“¾è¡¨çš„æ‰€æœ‰èŠ‚ç‚¹æ˜¯å­˜å‚¨åœ¨Referenceå®ä¾‹æœ¬èº«ï¼Œé€šè¿‡å±æ€§nextæ‹¼æ¥çš„ï¼ŒReferenceQueueæä¾›äº†å¯¹Referenceé“¾è¡¨çš„å…¥é˜Ÿã€pollã€removeç­‰æ“ä½œã€‚ åˆ¤æ–­å¯¹è±¡çš„å¯è¾¾æ€§å’Œå¯¹è±¡æ˜¯å¦å­˜æ´» åˆ¤æ–­å¯¹è±¡çš„å¯è¾¾æ€§å’Œå¯¹è±¡æ˜¯å¦å­˜æ´»æ˜¯ä¸¤ä¸ªæ¯”è¾ƒå›°éš¾çš„é—®é¢˜ï¼Œç¬”è€…Cè¯­è¨€å­¦å¾—æ¯”è¾ƒçƒ‚ï¼Œå¦åˆ™ä¼šé‡ç‚¹ç¿»çœ‹ä¸€ä¸‹JVMçš„å®ç°ï¼Œç›®å‰åªèƒ½å‚è€ƒä¸€äº›èµ„æ–™æ¥è¯´æ˜è¿™ä¸ªé—®é¢˜ã€‚ å¯è¾¾æ€§ç®—æ³• ä¸»æµå•†ç”¨è¯­è¨€åŒ…æ‹¬Javaéƒ½æ˜¯ä½¿ç”¨å¯è¾¾æ€§åˆ†æ(Reachability Analysis)ç®—æ³•æ¥åˆ¤å®šå¯¹è±¡æ˜¯å¦å­˜æ´»çš„ã€‚è¿™ä¸ªç®—æ³•çš„åŸºæœ¬æ€è·¯æ˜¯é€šè¿‡ä¸€ç³»åˆ—çš„ç§°ä¸º&quot;GC Roots&quot;(GCæ ¹é›†)çš„å¯¹è±¡ä½œä¸ºèµ·å§‹ç‚¹ï¼Œä»è¿™äº›èŠ‚ç‚¹å¼€å§‹å‘ä¸‹æœç´¢ï¼Œæœç´¢æ‰€èµ°è¿‡çš„è·¯å¾„ç§°ä¸ºå¼•ç”¨é“¾(Reference Chain)ï¼Œå½“ä¸€ä¸ªå¯¹è±¡åˆ°GCæ ¹é›†æ²¡æœ‰ä»»ä½•å¼•ç”¨é“¾ç›¸è¿(ä»å›¾è®ºçš„è§’åº¦çœ‹ï¼Œä¹Ÿå°±æ˜¯ä»GCæ ¹é›†åˆ°è¿™ä¸ªå¯¹è±¡æ˜¯ä¸å¯è¾¾çš„)æ—¶ï¼Œåˆ™è¯æ˜æ­¤å¯¹è±¡æ˜¯ä¸å¯ç”¨çš„ã€‚ä¸å¯ç”¨çš„å¯¹è±¡&quot;æœ‰æœºä¼š&quot;è¢«åˆ¤å®šä¸ºå¯ä»¥å›æ”¶çš„å¯¹è±¡ã€‚ åœ¨Javaè¯­è¨€ä¸­ï¼Œå¯ä»¥ä½œä¸ºGCæ ¹é›†çš„å¯¹è±¡åŒ…æ‹¬ä¸‹é¢å‡ ç§ï¼š è™šæ‹Ÿæœºæ ˆ(æ ˆå¸§ä¸­çš„æœ¬åœ°å˜é‡è¡¨)ä¸­å¼•ç”¨çš„å¯¹è±¡ã€‚ æ–¹æ³•åŒºä¸­å¸¸é‡å¼•ç”¨çš„å¯¹è±¡(åœ¨JDK1.8ä¹‹åä¸å­˜åœ¨æ–¹æ³•åŒºï¼Œä¹Ÿå°±æ˜¯æœ‰å¯èƒ½æ˜¯metaspaceä¸­å¸¸é‡å¼•ç”¨çš„å¯¹è±¡)ã€‚ æœ¬åœ°æ–¹æ³•æ ˆä¸­JNI(å³ä¸€èˆ¬å¸¸è¯´çš„Nativeæ–¹æ³•)å¼•ç”¨çš„å¯¹è±¡ã€‚ finalizeå‡½æ•° å³ä½¿åœ¨å¯è¾¾æ€§åˆ†æç®—æ³•ä¸­åˆ¤å®šä¸ºä¸å¯è¾¾çš„å¯¹è±¡ï¼Œä¹Ÿå¹¶éä¸€å®šä¼šåˆ¤å®šä¸ºå¯ä»¥è¢«å›æ”¶çš„&quot;æ­»äº¡&quot;å¯¹è±¡ã€‚ä¸€ä¸ªå¯¹è±¡åˆ¤å®šä¸º&quot;æ­»äº¡&quot;è‡³å°‘éœ€è¦ç»å†ä¸¤æ¬¡æ ‡è®°çš„è¿‡ç¨‹ã€‚ ç¬¬ä¸€æ¬¡æ ‡è®°ï¼šå¦‚æœå¯¹è±¡åœ¨è¿›è¡Œå¯è¾¾æ€§åˆ†æåå‘ç°æ²¡æœ‰ä¸GC Rootsç›¸è¿æ¥çš„å¼•ç”¨é“¾ï¼Œé‚£ä¹ˆå®ƒå°†ä¼šè¢«ç¬¬ä¸€æ¬¡æ ‡è®°å¹¶ä¸”è¿›è¡Œä¸€æ¬¡ç­›é€‰ï¼Œç­›é€‰çš„æ¡ä»¶æ˜¯æ­¤å¯¹è±¡æ˜¯å¦æœ‰å¿…è¦æ‰§è¡Œfinalize()æ–¹æ³•ã€‚JVMä¼šæŠŠä»¥ä¸‹ä¸¤ç§æƒ…å†µè®¤ä¸ºå¯¹è±¡æ²¡æœ‰å¿…è¦æ‰§è¡Œfinalize()æ–¹æ³•ï¼š å¯¹è±¡æ²¡æœ‰è¦†ç›–ç»§æ‰¿è‡ªObjectç±»çš„finalize()æ–¹æ³•ã€‚ å¯¹è±¡çš„finalize()æ–¹æ³•å·²ç»è¢«JVMè°ƒç”¨è¿‡ã€‚ å¦‚æœä¸€ä¸ªå¯¹è±¡è¢«åˆ¤å®šä¸ºæœ‰å¿…è¦æ‰§è¡Œfinalize()æ–¹æ³•ï¼Œé‚£ä¹ˆè¿™ä¸ªå¯¹è±¡å°†ä¼šè¢«æ”¾ç½®åœ¨ä¸€ä¸ªå«F-Queueçš„é˜Ÿåˆ—ä¹‹ä¸­ï¼Œå¹¶ä¸”ç¨åç”±ä¸€ä¸ªä¼˜å…ˆçº§ä½çš„Finalizerçº¿ç¨‹å»å–è¯¥é˜Ÿåˆ—çš„å…ƒç´ ï¼Œ&quot;å°è¯•æ‰§è¡Œ&quot;å…ƒç´ çš„finalize()æ–¹æ³•ã€‚è¿™é‡Œä¹‹æ‰€ä»¥å«å°è¯•æ‰§è¡Œæ˜¯å› ä¸ºJVMä¼šä¿è¯è§¦å‘æ»¡è¶³æ¡ä»¶çš„å¯¹è±¡çš„finalize()æ–¹æ³•ï¼Œä½†æ˜¯å¹¶ä¸æ‰¿è¯ºä¼šç­‰å¾…å®ƒæ‰§è¡Œç»“æŸï¼Œè¿™æ˜¯å› ä¸ºï¼šå¦‚æœä¸€ä¸ªå¯¹è±¡åœ¨æ‰§è¡Œfinalize()æ–¹æ³•è€—æ—¶è¾ƒé•¿ï¼Œç”šè‡³å‘ç”Ÿäº†æ­»å¾ªç¯ï¼Œå°†ä¼šå¯¼è‡´F-Queueçš„é˜Ÿåˆ—ä¸­çš„å…¶ä»–å…ƒç´ æ°¸è¿œå¤„äºç­‰å¾…çŠ¶æ€ï¼Œæç«¯æƒ…å†µä¸‹æœ‰å¯èƒ½å¯¼è‡´æ•´ä¸ªå†…å­˜å›æ”¶ç³»ç»Ÿå´©æºƒã€‚ finalize()æ–¹æ³•æ˜¯å¯¹è±¡é€ƒè„±æ­»äº¡å‘½è¿çš„æœ€åä¸€æ¬¡æœºä¼šï¼Œå› ä¸ºç¨åçš„GCå°†ä¼šå¯¹F-Queueé˜Ÿåˆ—ä¸­çš„å¯¹è±¡è¿›è¡Œç¬¬äºŒæ¬¡å°è§„æ¨¡çš„æ ‡è®°ï¼Œå¦‚æœå¯¹è±¡åœ¨finalize()æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­æˆåŠŸæ‹¯æ•‘è‡ªå·±â€“ä¹Ÿå°±æ˜¯å¯¹è±¡è‡ªèº«é‡æ–°ä¸å¼•ç”¨é“¾çš„ä»»ä½•ä¸€ä¸ªå¯¹è±¡å»ºç«‹å…³è”å³å¯ï¼Œæœ€å¸¸è§çš„å°±æ˜¯æŠŠè‡ªèº«(thiså…³é”®å­—)èµ‹å€¼ç»™æŸä¸ªç±»å˜é‡æˆ–è€…å¯¹è±¡çš„æˆå‘˜å±æ€§ï¼Œé‚£ä¹ˆåœ¨ç¬¬äºŒæ¬¡å°è§„æ¨¡çš„æ ‡è®°æ—¶å€™å°†ä¼šæŠŠ&quot;è‡ªæˆ‘æ‹¯æ•‘&quot;æˆåŠŸçš„å¯¹è±¡ç§»å‡º&quot;å³å°†å›æ”¶&quot;çš„é›†åˆã€‚å¦‚æœå¯¹è±¡åœ¨finalize()æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­æ²¡æœ‰&quot;é€ƒé€¸&quot;ï¼Œé‚£ä¹ˆå®ƒæœ€ç»ˆå°±ä¼šè¢«å›æ”¶ã€‚å‚è€ƒã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœº-2ndã€‹çš„&quot;å¯¹è±¡è‡ªæˆ‘æ‹¯æ•‘çš„ä¾‹å­&quot;ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041public class FinalizeEscapeGc &#123; private static FinalizeEscapeGc SAVE_HOOK = null; public void isAlive() &#123; System.out.println(\"Yes,I am still alive :)\"); &#125; public static void main(String[] args) throws Exception &#123; SAVE_HOOK = new FinalizeEscapeGc(); SAVE_HOOK = null; System.gc(); Thread.sleep(500); if (SAVE_HOOK != null) &#123; SAVE_HOOK.isAlive(); &#125; else &#123; System.out.println(\"No,I am not alive :(\"); &#125; // ä¸‹é¢çš„è¿™æ®µä»£ç å’Œä¸Šé¢çš„ä¸€è‡´ SAVE_HOOK = null; System.gc(); Thread.sleep(500); if (SAVE_HOOK != null) &#123; SAVE_HOOK.isAlive(); &#125; else &#123; System.out.println(\"No,I am not alive :(\"); &#125; &#125; @Override protected void finalize() throws Throwable &#123; super.finalize(); System.out.println(\"FinalizeEscapeGc finalize invoke...\"); FinalizeEscapeGc.SAVE_HOOK = this; &#125;&#125;// è¾“å‡ºç»“æœFinalizeEscapeGc finalize invoke...Yes,I am still alive :)No,I am not alive :( æ³¨æ„ï¼š finalize()æ–¹æ³•çš„é”™è¯¯ä½¿ç”¨æœ‰å¯èƒ½æ˜¯å†…å­˜å›æ”¶ç³»ç»Ÿå´©æºƒçš„æ ¹æºï¼Œä¸€èˆ¬æƒ…å†µä¸‹è°¨æ…æ€è€ƒæ˜¯å¦çœŸçš„éœ€è¦è¦†ç›–æ­¤æ–¹æ³•ã€‚ ä»»æ„ä¸€ä¸ªå¯¹è±¡åªèƒ½é€šè¿‡finalize()æ–¹æ³•è‡ªæˆ‘æ‹¯æ•‘ä¸€æ¬¡ã€‚ Finalizerå®ˆæŠ¤çº¿ç¨‹ å‰é¢æåˆ°çš„Finalizerå®ˆæŠ¤çº¿ç¨‹å’ŒF-Queueé˜Ÿåˆ—å…¶å®åœ¨JDKä¸­æœ‰å…·ä½“çš„å®ç°ç±»java.lang.ref.Finalizerã€‚F-Queueé˜Ÿåˆ—åªæ˜¯ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœº-2ndã€‹ä¸­çš„ä¸€ä¸ªåè¯æè¿°ï¼Œå®é™…ä¸Šç¬”è€…æ²¡æœ‰æ‰¾åˆ°ç›¸å…³çš„èµ„æ–™ï¼Œè¿™é‡Œæˆ‘ä»¬é€šè¿‡åˆ†æJDKå’ŒJVMç›¸å…³çš„æºç å»ç†è§£è¿™ä¸ªF-Queueé˜Ÿåˆ—å§ã€‚å…ˆçœ‹java.lang.ref.Finalizerçš„æºç ï¼Œä»£ç æ¯”è¾ƒå°‘å…¨é‡è´´å‡ºï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172final class Finalizer extends FinalReference&lt;Object&gt; &#123; /* Package-private; must be in same package as the Reference class */ // Finalizerå…³è”çš„ReferenceQueueï¼Œå…¶å®Finalizeræ˜¯ä¸€ä¸ªç‰¹æ®Šçš„Referenceå®ç° private static ReferenceQueue&lt;Object&gt; queue = new ReferenceQueue&lt;&gt;(); /** Head of doubly linked list of Finalizers awaiting finalization. */ // ç­‰å¾…finalizationçš„æ‰€æœ‰Finalizerå®ä¾‹é“¾è¡¨çš„å¤´èŠ‚ç‚¹ï¼Œè¿™é‡Œç§°æ­¤é“¾è¡¨ä¸ºunfinalizedé“¾è¡¨ private static Finalizer unfinalized = null; /** Lock guarding access to unfinalized list. */ // unfinalizedé“¾è¡¨çš„é”ï¼Œé™æ€finalï¼Œå…¨å±€çš„é”å®ä¾‹ private static final Object lock = new Object(); // ä¸­é—´å˜é‡ï¼Œåˆ†åˆ«è®°å½•unfinalizedé“¾è¡¨ä¸­å½“å‰æ‰§è¡Œå…ƒç´ çš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹å’Œå‰ä¸€ä¸ªèŠ‚ç‚¹ private Finalizer next, prev; private Finalizer(Object finalizee) &#123; super(finalizee, queue); // push onto unfinalized // è¿™é‡Œä¸»è¦æ˜¯æ›´æ–°unfinalizedé“¾è¡¨çš„å¤´èŠ‚ç‚¹ï¼Œæ–°å¢çš„å…ƒç´ æ€»æ˜¯ä¼šå˜æˆå¤´èŠ‚ç‚¹ synchronized (lock) &#123; if (unfinalized != null) &#123; this.next = unfinalized; unfinalized.prev = this; &#125; unfinalized = this; &#125; &#125; static ReferenceQueue&lt;Object&gt; getQueue() &#123; return queue; &#125; /* Invoked by VM */ è¿™ä¸ªæ–¹æ³•ç”±JVMæ¿€æ´»ï¼Œä¹Ÿå°±æ˜¯é“¾è¡¨çš„å…ƒç´ å…¥é˜Ÿæ˜¯ç”±JVMæ§åˆ¶çš„ï¼Œè§ä¸‹æ–‡åˆ†æ static void register(Object finalizee) &#123; new Finalizer(finalizee); &#125; private void runFinalizer(JavaLangAccess jla) &#123; synchronized (lock) &#123; // å½“å‰å…ƒç´ å·²ç»å¤„ç†è¿‡ï¼Œç›´æ¥è¿”å› if (this.next == this) // already finalized return; // unlink from unfinalized // ä¸‹é¢çš„é€»è¾‘æ˜¯å½“å‰éœ€è¦æ‰§è¡Œçš„å…ƒç´ ä»é“¾è¡¨ä¸­ç§»é™¤ï¼Œå¹¶ä¸”æ›´æ–°prevå’Œnextçš„å€¼ï¼Œç›¸å½“äºé‡å»ºé“¾è¡¨çš„éƒ¨åˆ†èŠ‚ç‚¹ if (unfinalized == this) unfinalized = this.next; else this.prev.next = this.next; if (this.next != null) this.next.prev = this.prev; this.prev = null; this.next = this; // mark as finalized &#125; try &#123; // è·å–å¯¹è±¡æ‰§è¡Œä¸€æ¬¡finalizeæ–¹æ³• Object finalizee = this.get(); if (finalizee != null &amp;&amp; !(finalizee instanceof java.lang.Enum)) &#123; jla.invokeFinalize(finalizee); // Clear stack slot containing this variable, to decrease // the chances of false retention with a conservative GC // æ¸…ç©ºå˜é‡å¼•ç”¨ä»è€Œå‡å°‘ä¿å®ˆGCå¯¼è‡´å˜é‡ä¿ç•™çš„å¯èƒ½æ€§ finalizee = null; &#125; &#125; catch (Throwable x) &#123; &#125; // æ‰§è¡Œå®Œæ¯•ä¼šåšä¸€æ¬¡æƒ…å†µé˜²æ­¢é‡å¤æ‰§è¡Œ super.clear(); &#125; /* Create a privileged secondary finalizer thread in the system thread * group for the given Runnable, and wait for it to complete. * * This method is used by runFinalization. * * It could have been implemented by offloading the work to the * regular finalizer thread and waiting for that thread to finish. * The advantage of creating a fresh thread, however, is that it insulates * invokers of that method from a stalled or deadlocked finalizer thread. */ // è¿™é‡Œå…¶å®ä¸ç”¨ç•æƒ§æ³¨é‡Šå¤ªå¤šï¼Œå®ƒåªæ˜¯ä¸€ä¸ªå€™é€‰æ–¹æ³•ï¼Œæ–°å»ºä¸€ä¸ªçº¿ç¨‹ç›´æ¥è°ƒç”¨åŒ…è£¹åœ¨Runnableçš„runFinalizationæ–¹æ³•ï¼Œä¸»è¦æ˜¯æä¾›ç»™ä¸»åŠ¨è°ƒç”¨çš„ä¸Šå±‚æ–¹æ³•è°ƒç”¨çš„ private static void forkSecondaryFinalizer(final Runnable proc) &#123; AccessController.doPrivileged( new PrivilegedAction&lt;&gt;() &#123; public Void run() &#123; ThreadGroup tg = Thread.currentThread().getThreadGroup(); for (ThreadGroup tgn = tg; tgn != null; tg = tgn, tgn = tg.getParent()); Thread sft = new Thread(tg, proc, \"Secondary finalizer\", 0, false); sft.start(); try &#123; sft.join(); &#125; catch (InterruptedException x) &#123; Thread.currentThread().interrupt(); &#125; return null; &#125;&#125;); &#125; /* Called by Runtime.runFinalization() */ // è¿™ä¸ªæ–¹æ³•æ˜¯ç»™Runtime.runFinalization()å§”æ‰˜è°ƒç”¨çš„ï¼Œå…¶å®å°±æ˜¯ä¸»åŠ¨å–å‡ºqueueçš„å…ƒç´ å¼ºåˆ¶è°ƒç”¨å…¶finalizeæ–¹æ³• static void runFinalization() &#123; if (VM.initLevel() == 0) &#123; return; &#125; forkSecondaryFinalizer(new Runnable() &#123; private volatile boolean running; public void run() &#123; // in case of recursive call to run() if (running) return; final JavaLangAccess jla = SharedSecrets.getJavaLangAccess(); running = true; for (Finalizer f; (f = (Finalizer)queue.poll()) != null;) f.runFinalizer(jla); &#125; &#125;); &#125; // çœŸæ­£çš„Finalizerçº¿ç¨‹ private static class FinalizerThread extends Thread &#123; private volatile boolean running; FinalizerThread(ThreadGroup g) &#123; super(g, null, \"Finalizer\", 0, false); &#125; public void run() &#123; // in case of recursive call to run() if (running) return; // Finalizer thread starts before System.initializeSystemClass // is called. Wait until JavaLangAccess is available while (VM.initLevel() == 0) &#123; // delay until VM completes initialization try &#123; VM.awaitInitLevel(1); &#125; catch (InterruptedException x) &#123; // ignore and continue &#125; &#125; final JavaLangAccess jla = SharedSecrets.getJavaLangAccess(); running = true; // æ³¨æ„è¿™é‡Œæ˜¯æ­»å¾ªç¯ for (;;) &#123; try &#123; // æ³¨æ„è¿™é‡Œæ˜¯è°ƒç”¨`Reference#remove()`çš„æ°¸ä¹…é˜»å¡ç‰ˆæœ¬ï¼Œåªæœ‰`Reference#enqueue()`è¢«è°ƒç”¨æ‰ä¼šè§£é™¤é˜»å¡ // `Reference#remove()`è§£é™¤é˜»å¡è¯´æ˜å…ƒç´ å·²ç»å®Œæˆå…¥é˜Ÿï¼Œç”±ReferenceHandlerçº¿ç¨‹å®Œæˆ Finalizer f = (Finalizer)queue.remove(); // å®é™…ä¸Šå°±æ˜¯è°ƒç”¨å¯¹è±¡çš„finalizeæ–¹æ³• f.runFinalizer(jla); &#125; catch (InterruptedException x) &#123; // ignore and continue &#125; &#125; &#125; &#125; static &#123; ThreadGroup tg = Thread.currentThread().getThreadGroup(); for (ThreadGroup tgn = tg; tgn != null; tg = tgn, tgn = tg.getParent()); // é™æ€ä»£ç å—ä¸­å£°æ˜çº¿ç¨‹ï¼Œä¼˜å…ˆçº§æ˜¯æœ€é«˜ä¼˜å…ˆçº§-2ï¼Œå®ˆæŠ¤çº¿ç¨‹ï¼Œå®é™…ä¸Šè¿™é‡Œä¼˜å…ˆçº§ä¸ä¸€å®šä¼šç”Ÿæ•ˆ Thread finalizer = new FinalizerThread(tg); finalizer.setPriority(Thread.MAX_PRIORITY - 2); finalizer.setDaemon(true); finalizer.start(); &#125;&#125; ä¸Šé¢çš„æ³¨é‡Šå·²ç»å¾ˆæ˜æ˜¾æ ‡æ³¨å‡ºæ¥ï¼Œè¿™é‡Œå°ç»“ä¸€ä¸‹å†…å®¹ã€‚ Finalizeræ˜¯FinalReferenceçš„å­ç±»ï¼Œè€ŒFinalReferenceæ˜¯Referenceçš„å®ç°ï¼Œæ‰€ä»¥å®ƒçš„å·¥ä½œåŸç†å’Œå…¶ä»–å¼•ç”¨ç±»ä¼¼ï¼Œå¯¹è±¡çš„çŠ¶æ€æ›´å˜å’Œç”±ReferenceHandlerçº¿ç¨‹å¯†åˆ‡ç›¸å…³ã€‚ Finalizerå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªé“¾è¡¨ï¼Œæ¯å½“JVMè°ƒç”¨é™æ€æ³¨å†Œæ–¹æ³•å°±ä¼šæ–°å»ºä¸€ä¸ªFinalizerå®ä¾‹åŠ å…¥åˆ°é“¾è¡¨çš„å¤´èŠ‚ç‚¹ä¸­ï¼Œå¤´èŠ‚ç‚¹å…ƒç´ ä¸ºunfinalizedï¼Œè¿™é‡Œç§°æ­¤é“¾è¡¨ä¸ºunfinalizedé“¾è¡¨ã€‚ Finalizerçº¿ç¨‹ç”±Finalizeré™æ€ä»£ç å—æ„å»ºå¹¶ä¸”è¿è¡Œï¼Œå®ƒæ˜¯å®ˆæŠ¤çº¿ç¨‹ï¼Œä¼˜å…ˆçº§æ˜¯æœ€é«˜ä¼˜å…ˆçº§-2ï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯æå–unfinalizedé“¾è¡¨çš„å…ƒç´ å¹¶ä¸”æ‰§è¡Œå…ƒç´ å¯¹è±¡çš„finalize()æ–¹æ³•ï¼Œè¿‡ç¨‹ä¸­è¿˜ä¼šæ¶‰åŠåˆ°çº¿ç¨‹çš„é˜»å¡ã€å”¤é†’ï¼Œä»¥åŠunfinalizedé“¾è¡¨çš„é‡å»ºç­‰å·¥ä½œã€‚ ç”±äºé™æ€æ–¹æ³•Finalizer#register(Object finalizee)æ˜¯ç”±JVMè°ƒç”¨çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¿…é¡»è¦åˆ†æä¸€äº›JVMçš„æºç ï¼Œå‚è€ƒçš„æ˜¯OpenJDKä¸»åˆ†æ”¯çš„ä»£ç ï¼Œæ–‡ä»¶æ˜¯instanceKlass.cppï¼š 123456789101112131415instanceOop InstanceKlass::register_finalizer(instanceOop i, TRAPS) &#123; if (TraceFinalizerRegistration) &#123; tty-&gt;print(\"Registered \"); i-&gt;print_value_on(tty); tty-&gt;print_cr(\" (\" INTPTR_FORMAT \") as finalizable\", p2i(i)); &#125; instanceHandle h_i(THREAD, i); // Pass the handle as argument, JavaCalls::call expects oop as jobjects JavaValue result(T_VOID); JavaCallArguments args(h_i); // è¿™é‡ŒUniverse::finalizer_register_method()è·å–åˆ°çš„å°±æ˜¯Finalizer#registeræ–¹æ³•å¥æŸ„ methodHandle mh (THREAD, Universe::finalizer_register_method()); JavaCalls::call(&amp;result, mh, &amp;args, CHECK_NULL); return h_i();&#125; æœ€åè°ƒç”¨çš„æ˜¯javaCalls.cppï¼š 12345678void JavaCalls::call(JavaValue* result, const methodHandle&amp; method, JavaCallArguments* args, TRAPS) &#123; // Check if we need to wrap a potential OS exception handler around thread // This is used for e.g. Win32 structured exception handlers assert(THREAD-&gt;is_Java_thread(), \"only JavaThreads can make JavaCalls\"); // Need to wrap each and every time, since there might be native code down the // stack that has installed its own exception handlers os::os_exception_wrapper(call_helper, result, method, args, THREAD);&#125; ç®€å•æ¥çœ‹å°±æ˜¯æŠŠåˆ›å»ºå¯¹è±¡è¿‡ç¨‹ä¸­ï¼Œå¦‚æœæœ‰å¿…è¦æ³¨å†ŒFinalizer(ä¸€èˆ¬æ˜¯è¦†ç›–äº†finalize()æ–¹æ³•)ï¼Œåˆ™åŸºäºå½“å‰çº¿ç¨‹é€šè¿‡Finalizer#register(Object finalizee)æŠŠå½“å‰æ–°å»ºçš„å®ä¾‹æ³¨å†Œåˆ°Finalizerè‡ªèº«ç»´æŠ¤çš„é“¾è¡¨ä¸­(å¦‚æœæ²¡ç†è§£é”™ï¼Œæ‰€è°“çš„F-Queueå°±æ˜¯è¿™ä¸ªé“¾è¡¨äº†)ï¼Œç­‰å¾…åå°Finalizerçº¿ç¨‹è½®è¯¢å¹¶ä¸”æ‰§è¡Œé“¾è¡¨ä¸­å¯¹è±¡çš„finalize()æ–¹æ³•ã€‚ å„ç±»å¼•ç”¨ä»¥åŠå®ƒä»¬çš„ä½¿ç”¨åœºæ™¯ è¿™é‡Œæåˆ°çš„å„ç±»å¼•ç”¨ç›®å‰å°±æ˜¯å››ç§ï¼šå¼ºå¼•ç”¨(StrongReference)ã€è½¯å¼•ç”¨(SoftReference)ã€å¼±å¼•ç”¨(WeakReference)å’Œè™šå¼•ç”¨(PhantomReference)ã€‚å…¶å®è¿˜æœ‰ç‰¹æ®Šçš„å¼•ç”¨ç±»å‹FinalReferenceï¼Œå®ƒæ˜¯åŒ…ç§æœ‰çš„ï¼Œå¹¶ä¸”åªæœ‰ä¸€ä¸ªå­ç±»å‹Finalizerã€‚ StrongReference StrongReferenceä¹Ÿå°±æ˜¯å¼ºå¼•ç”¨ï¼Œå®ƒæ˜¯ä½¿ç”¨æœ€æ™®éçš„ä¸€ç§å¼•ç”¨ï¼Œjava.lang.refåŒ…ä¸‹æ²¡æœ‰å¼ºå¼•ç”¨å¯¹åº”çš„ç±»å‹ã€‚ä¸€ä¸ªæ¯”è¾ƒæ˜ç¡®çš„å¼ºå¼•ç”¨å®šä¹‰å°±æ˜¯ï¼šæ‰€æœ‰å’ŒGC Rootä¹‹é—´å­˜åœ¨å¼•ç”¨é“¾çš„å¯¹è±¡éƒ½å…·å¤‡å¼ºå¼•ç”¨ã€‚ä¸¾ä¸ªç®€å•ä¾‹å­ï¼šå½¢å¦‚Object o = new Object();åœ¨æ–¹æ³•ä½“ä¸­ä½¿ç”¨newå…³é”®å­—å£°æ˜çš„å¯¹è±¡ä¸€èˆ¬å°±æ˜¯å¼ºå¼•ç”¨ã€‚å¦‚æœä¸€ä¸ªå¯¹è±¡å…·å¤‡å¼ºå¼•ç”¨ï¼Œåƒåœ¾å›æ”¶å™¨ç»ä¸ä¼šå›æ”¶å®ƒã€‚å½“å†…å­˜ç©ºé—´ä¸è¶³ï¼ŒJVMå®æ„¿æŠ›å‡ºOutOfMemoryErroré”™è¯¯ï¼Œä½¿ç¨‹åºå¼‚å¸¸ç»ˆæ­¢ï¼Œä¹Ÿä¸ä¼šå‡ºç°å›æ”¶å…·æœ‰å¼ºå¼•ç”¨çš„å¯¹è±¡æ¥è§£å†³å†…å­˜ä¸è¶³çš„æƒ…å†µã€‚å½“ç„¶ï¼Œå¦‚æœæœ‰å…±äº«çš„æˆå‘˜å˜é‡åœ¨æ–¹æ³•é€€å‡ºä¹‹å‰ç½®ä¸ºnullï¼Œç›¸å½“äºæ–­ç»æˆå‘˜å˜é‡å’ŒGC Rootçš„å¼•ç”¨é“¾ï¼Œåœ¨åˆé€‚çš„æ—¶æœºæ˜¯æœ‰åˆ©äºGCåå…·å¤‡å¼ºå¼•ç”¨çš„å¯¹è±¡çš„å›æ”¶ï¼Œä¾‹å¦‚ï¼š 123456private Object shareValue = XXX;public void methodA()&#123; //do something shareValue = null;&#125; åæ¥æœ‰äººè¿‡åº¦ä¿¡å¥‰ç±»ä¼¼ä¸Šé¢çš„è¿™ä¸ªå®è·µï¼Œå‡ºç°äº†ä¸€æ¡æ¯”è¾ƒè¯¡å¼‚çš„ç¼–ç å®è·µï¼šå¼ºå¼•ç”¨ä½¿ç”¨å®Œæ¯•åéƒ½è¦ç½®ä¸ºnullæ–¹ä¾¿å¯¹è±¡å›æ”¶ã€‚ä½†æ˜¯å®é™…ä¸Šï¼Œè¿™ä¸ªå®è·µå¹¶ä¸æ˜¯åœ¨ä»»ä½•åœºæ™¯éƒ½æ˜¯åˆç†çš„ã€‚ SoftReference SoftReferenceä¹Ÿå°±æ˜¯è½¯å¼•ç”¨ï¼Œå®ƒæ˜¯ç”¨æ¥æè¿°ä¸€äº›&quot;è¿˜æœ‰ç”¨ä½†æ˜¯éå¿…é¡»&quot;çš„å¯¹è±¡ã€‚å¯¹äºè½¯å¼•ç”¨å…³è”ç€çš„å¯¹è±¡ï¼Œåœ¨JVMåº”ç”¨å³å°†å‘ç”Ÿå†…å­˜æº¢å‡ºå¼‚å¸¸ä¹‹å‰ï¼Œå°†ä¼šæŠŠè¿™äº›è½¯å¼•ç”¨å…³è”çš„å¯¹è±¡åˆ—è¿›å»å›æ”¶å¯¹è±¡èŒƒå›´ä¹‹ä¸­è¿›è¡Œç¬¬äºŒæ¬¡å›æ”¶ã€‚å¦‚æœè¿™æ¬¡å›æ”¶ä¹‹åè¿˜æ˜¯æ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜ï¼Œæ‰ä¼šæŠ›å‡ºå†…å­˜æº¢å‡ºå¼‚å¸¸ã€‚ç®€å•æ¥è¯´å°±æ˜¯ï¼š å¦‚æœå†…å­˜ç©ºé—´è¶³å¤Ÿï¼Œåƒåœ¾å›æ”¶å™¨å°±ä¸ä¼šå›æ”¶è½¯å¼•ç”¨å…³è”ç€çš„å¯¹è±¡ã€‚ å¦‚æœå†…å­˜ç©ºé—´ä¸è¶³ï¼Œåƒåœ¾å›æ”¶å™¨åœ¨å°†è¦æŠ›å‡ºå†…å­˜æº¢å‡ºå¼‚å¸¸ä¹‹å‰ä¼šå›æ”¶è½¯å¼•ç”¨å…³è”ç€çš„å¯¹è±¡ã€‚ ä¸¾ä¸ªç®€å•çš„ä½¿ç”¨ä¾‹å­ï¼š 12345678910111213141516171819202122232425// VMå‚æ•°ï¼š-Xmx4m -Xms4mpublic class SoftReferenceMain &#123; public static void main(String[] args) throws Exception &#123; ReferenceQueue&lt;SoftReferenceObject&gt; queue = new ReferenceQueue&lt;&gt;(); SoftReferenceObject object = new SoftReferenceObject(); SoftReference&lt;SoftReferenceObject&gt; reference = new SoftReference&lt;&gt;(object, queue); object = null; System.gc(); Thread.sleep(500); System.out.println(reference.get()); &#125; private static class SoftReferenceObject &#123; int[] array = new int[120_000]; @Override public String toString() &#123; return \"SoftReferenceObject\"; &#125; &#125;&#125;// è¿è¡Œåè¾“å‡ºç»“æœnull ä¸Šé¢çš„ä¾‹å­æ•…æ„æŠŠJVMçš„å¯åŠ¨çš„æœ€å¤§Heapå†…å­˜å’Œåˆå§‹Heapå†…å­˜è®¾ç½®ä¸º4MBï¼Œä½¿ç”¨è¿™ä¸ªå¯¹è±¡åˆå§‹åŒ–ä¸€ä¸ªæ¯”è¾ƒå¤§çš„æ•´å‹æ•°ç»„å¹¶ä¸”å…³ç³»åˆ°ä¸€ä¸ªè½¯å¼•ç”¨å¯¹è±¡ä¸­ï¼ŒGCä¹‹åï¼Œå‘ç°è½¯å¼•ç”¨å…³è”çš„å¯¹è±¡è¢«å›æ”¶äº†ã€‚ WeakReference WeakReferenceä¹Ÿå°±æ˜¯å¼±å¼•ç”¨ï¼Œå¼±å¼•ç”¨å’Œè½¯å¼•ç”¨ç±»ä¼¼ï¼Œå®ƒæ˜¯ç”¨æ¥æè¿°&quot;éå¿…é¡»&quot;çš„å¯¹è±¡çš„ï¼Œå®ƒçš„å¼ºåº¦æ¯”è½¯å¼•ç”¨è¦æ›´å¼±ä¸€äº›ã€‚è¢«å¼±å¼•ç”¨å…³è”çš„å¯¹è±¡åªèƒ½ç”Ÿå­˜åˆ°ä¸‹ä¸€æ¬¡åƒåœ¾æ”¶é›†å‘ç”Ÿä¹‹å‰ï¼Œç®€è¨€ä¹‹å°±æ˜¯ï¼šä¸€æ—¦å‘ç”ŸGCå¿…å®šå›æ”¶è¢«å¼±å¼•ç”¨å…³è”çš„å¯¹è±¡ï¼Œä¸ç®¡å½“å‰çš„å†…å­˜æ˜¯å¦è¶³å¤Ÿã€‚ ä¸¾ä¸ªä¾‹å­ï¼š 123456789101112131415161718192021222324public class WeakReferenceMain &#123; public static void main(String[] args) throws Exception &#123; ReferenceQueue&lt;WeakReferenceObject&gt; queue = new ReferenceQueue&lt;&gt;(); WeakReferenceObject object = new WeakReferenceObject(); System.out.println(object); WeakReference&lt;WeakReferenceObject&gt; reference = new WeakReference&lt;&gt;(object, queue); object = null; System.gc(); Thread.sleep(500); System.out.println(reference.get()); &#125; private static class WeakReferenceObject &#123; @Override public String toString() &#123; return \"WeakReferenceObject\"; &#125; &#125;&#125;// è¿è¡Œåè¾“å‡ºç»“æœWeakReferenceObjectnull ä¸Šé¢çš„ä¾‹å­ä¸­æ²¡æœ‰è®¾å®šJVMçš„å †å†…å­˜ï¼Œå› æ­¤ä¸å­˜åœ¨å†…å­˜ä¸è¶³çš„æƒ…å†µï¼Œå¯è§å¼±å¼•ç”¨å…³è”çš„å¯¹è±¡åœ¨GCä¹‹åè¢«å›æ”¶äº†ã€‚å¼±å¼•ç”¨é€‚åˆç”¨æ¥åšå¯¹å†…å­˜æ•æ„Ÿçš„ç¼“å­˜ï¼Œå¾ˆå¸¸ç”¨çš„WeakHashMapå°±æ˜¯åŸºäºå¼±å¼•ç”¨å®ç°çš„ã€‚ PhantomReference PhantomReferenceä¹Ÿå°±æ˜¯è™šå¼•ç”¨ï¼Œä¹Ÿå«å¹½çµå¼•ç”¨æˆ–è€…å¹»å½±å¼•ç”¨ï¼Œå®ƒæ˜¯æ‰€æœ‰å¼•ç”¨ç±»å‹ä¸­æœ€å¼±çš„ä¸€ç§ã€‚ä¸€ä¸ªå¯¹è±¡æ˜¯å¦å…³è”åˆ°è™šå¼•ç”¨ï¼Œå®Œå…¨ä¸ä¼šå½±å“è¯¥å¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸï¼Œä¹Ÿæ— æ³•é€šè¿‡è™šå¼•ç”¨æ¥è·å–ä¸€ä¸ªå¯¹è±¡çš„å®ä¾‹(PhantomReferenceè¦†ç›–äº†Reference#get()å¹¶ä¸”æ€»æ˜¯è¿”å›null)ã€‚ä¸ºå¯¹è±¡è®¾ç½®ä¸€ä¸ªè™šå¼•ç”¨çš„å”¯ä¸€ç›®çš„æ˜¯ï¼šèƒ½åœ¨æ­¤å¯¹è±¡è¢«åƒåœ¾æ”¶é›†å™¨å›æ”¶çš„æ—¶å€™æ”¶åˆ°ä¸€ä¸ªç³»ç»Ÿé€šçŸ¥ã€‚PhantomReferenceæœ‰ä¸¤ä¸ªæ¯”è¾ƒå¸¸ç”¨çš„å­ç±»æ˜¯java.lang.ref.Cleanerå’Œjdk.internal.ref.Cleanerï¼Œå…¶ä¸­å‰è€…æä¾›çš„åŠŸèƒ½æ˜¯å¼€å‘è€…ç”¨äºåœ¨å¼•ç”¨å¯¹è±¡å›æ”¶çš„æ—¶å€™è§¦å‘ä¸€ä¸ªåŠ¨ä½œ(java.lang.ref.Cleaner$Cleanable)ï¼Œåè€…ç”¨äºDirectByteBufferå¯¹è±¡å›æ”¶çš„æ—¶å€™å¯¹äºå †å¤–å†…å­˜çš„å›æ”¶ï¼Œå¯ä»¥ç¿»çœ‹å‰é¢æè¿°java.lang.ref.Reference#processPendingReferences()æºç çš„æ—¶å€™ï¼ŒReferenceHandlerçº¿ç¨‹ä¼šå¯¹pendingé“¾è¡¨ä¸­çš„jdk.internal.ref.Cleanerç±»å‹å¼•ç”¨å¯¹è±¡è°ƒç”¨å…¶clean()æ–¹æ³•ã€‚PhantomReferenceæœ¬èº«ä½¿ç”¨åœºæ™¯æ¯”è¾ƒå°‘ï¼Œè¿™é‡Œä¸¾ä¸€ä¸‹java.lang.ref.Cleaneræ³¨é‡Šä¸­çš„ä¾‹å­ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243public class PhantomReferenceMain &#123; public static void main(String[] args) throws Exception &#123; try (CleaningExample o = new CleaningExample(11))&#123; &#125; CleaningExample o2 = new CleaningExample(22); System.gc(); Thread.sleep(300); &#125;&#125;class CleaningExample implements AutoCloseable &#123; private Cleaner cleaner = Cleaner.create(); private final State state; private final Cleaner.Cleanable cleanable; public CleaningExample(int s) &#123; state = new State(s); cleanable = cleaner.register(this, state); &#125; class State implements Runnable &#123; private final int s; public State(int s) &#123; this.s = s; &#125; @Override public void run() &#123; System.out.println(\"State runnable in action.State value = \" + s); &#125; &#125; @Override public void close() throws Exception &#123; cleanable.clean(); &#125;&#125; å®é™…ä¸Šï¼Œæ²™é¢çš„ä»£ç æ‰§è¡Œå®Œæ¯•åªä¼šè¾“å‡º&quot;State runnable in action.State value = 11&quot;ï¼Œå¹¶æ²¡æœ‰è¾“å‡º&quot;State runnable in action.State value = 22&quot;ï¼Œè¿™æ˜¯å› ä¸ºæ— æ³•é¢„æµ‹å¼ºå¼•ç”¨å¯¹è±¡è¢«å›æ”¶çš„æ—¶æœºã€‚java.lang.ref.Cleanerä¸»è¦æ˜¯ç”¨äºé¢„é˜²å®ç°äº†AutoCloseableæ¥å£çš„å®ä¾‹å¿˜è®°è°ƒç”¨close()æ–¹æ³•åœ¨å¯¹è±¡è¢«åƒåœ¾æ”¶é›†å™¨å›æ”¶çš„æ—¶å€™(å†…å­˜å›æ”¶)åšä¸€ä¸ªå…œåº•çš„æ¸…ç†å·¥ä½œï¼Œåœ¨JDK9ä¹‹åï¼Œjava.lang.ref.Cleanerä¸»è¦æ˜¯ä¸ºäº†æ›¿ä»£å·²ç»æ ‡è¯†ä¸ºè¿‡æœŸçš„Object#finalize()æ–¹æ³•ã€‚ æ‰©å±•é˜…è¯»ï¼šå¯ä»¥æ³¨æ„é˜…è¯»ä¸€ä¸‹ã€ŠEffective Java 3rdã€‹çš„ç¬¬8å°èŠ‚ï¼Œæ‘˜æŠ„éƒ¨åˆ†å†…å®¹å¦‚ä¸‹ï¼šç»ˆç»“æ–¹æ³•ï¼ˆFinalizerï¼‰æ˜¯ä¸å¯é¢„çŸ¥çš„ï¼Œå¾ˆå¤šæ—¶å€™æ˜¯å±é™©çš„ï¼Œè€Œä¸”ä¸€èˆ¬æƒ…å†µä¸‹æ˜¯ä¸å¿…è¦çš„ã€‚â€¦åœ¨Java 9ä¸­ï¼Œç»ˆç»“æ–¹æ³•å·²ç»è¢«é—å¼ƒäº†ï¼Œä½†å®ƒä»¬ä»è¢«Javaç±»åº“ä½¿ç”¨ï¼Œç›¸åº”ç”¨æ¥æ›¿ä»£ç»ˆç»“æ–¹æ³•çš„æ˜¯æ¸…ç†æ–¹æ³•ï¼ˆcleanerï¼‰ã€‚æ¯”èµ·ç»ˆç»“æ–¹æ³•ï¼Œæ¸…ç†æ–¹æ³•ç›¸å¯¹å®‰å…¨ç‚¹ï¼Œä½†ä»æ˜¯ä¸å¯ä»¥é¢„çŸ¥çš„ï¼Œè¿è¡Œæ…¢çš„ï¼Œè€Œä¸”ä¸€èˆ¬æƒ…å†µä¸‹æ˜¯ä¸å¿…è¦çš„ã€‚ JDK9ä¸­æœ‰å¾ˆå¤šåŸæ¥ä½¿ç”¨è¦†ç›–Object#finalize()æ–¹æ³•çš„æ¸…ç†å·¥ä½œå®ç°éƒ½æ›¿æ¢ä¸ºjava.lang.ref.Cleanerï¼Œä½†æ˜¯ä»ç„¶ä¸é¼“åŠ±ä½¿ç”¨è¿™ç§æ–¹å¼ã€‚ Referenceå’ŒReferenceQueueé…åˆä½¿ç”¨ å‰é¢åŸºæœ¬ä»‹ç»å®Œäº†æ‰€æœ‰ç±»å‹å¼•ç”¨ä»¥åŠç›¸å…³çš„æºç ï¼Œä½†æ˜¯å°šæœªæä¾›ä¾‹å­è¯´æ˜Referenceå’ŒReferenceQueueæ˜¯æ€ä¹ˆé…åˆä½¿ç”¨çš„ã€‚ä¸¾ä¸ªä¾‹å­ï¼š 123456789101112131415161718192021222324252627282930public class ReferenceQueueMain &#123; public static void main(String[] args) throws Exception &#123; ReferenceQueue&lt;WeakReferenceObject&gt; queue = new ReferenceQueue&lt;&gt;(); WeakReferenceObject object = new WeakReferenceObject(); WeakReference&lt;WeakReferenceObject&gt; weakReference = new WeakReference&lt;&gt;(object, queue); System.out.println(weakReference); object = null; System.gc(); Thread.sleep(500); while (true) &#123; Reference&lt;? extends WeakReferenceObject&gt; reference = queue.poll(); if (null == reference) &#123; Thread.sleep(100); &#125; else &#123; System.out.println(reference); System.out.println(reference.get()); break; &#125; &#125; &#125; private static class WeakReferenceObject &#123; @Override public String toString() &#123; return \"WeakReferenceObject\"; &#125; &#125;&#125; è¿è¡Œåè¾“å‡ºç»“æœæ˜¯ï¼š 123java.lang.ref.WeakReference@6537cf78java.lang.ref.WeakReference@6537cf78null å¯è§è½®è¯¢ReferenceQueueå®ä¾‹å¾—åˆ°çš„å¼±å¼•ç”¨å®ä¾‹å’Œåˆ›å»ºçš„æ˜¯ä¸€è‡´çš„ï¼Œåªæ˜¯å®ƒæŒæœ‰çš„å…³è”çš„å¯¹è±¡å·²ç»è¢«å›æ”¶ï¼Œå¾—åˆ°nullã€‚ä¸Šé¢çš„ReferenceQueue#poll()æ–¹æ³•ä¹Ÿå¯ä»¥æ›¿æ¢ä¸ºReferenceQueue#remove()ï¼Œè¿™æ ·å­å°±ä¸ç”¨å†™åœ¨æ­»å¾ªç¯ä¸­ï¼Œå› ä¸ºReferenceQueue#remove()ä¼šé˜»å¡åˆ°æœ‰å…ƒç´ å¯ä»¥å‡ºé˜Ÿã€‚é€šè¿‡è½®è¯¢ç»‘å®šåˆ°Referenceå®ä¾‹çš„ReferenceQueueå®ä¾‹ï¼Œå°±å¯ä»¥å¾—çŸ¥Referenceå®ä¾‹å½“å‰çš„çŠ¶æ€å¹¶ä¸”åˆ¤æ–­å®ƒå…³è”çš„æˆ‘ä»¬çœŸæ­£å…³æ³¨çš„å¯¹è±¡æ˜¯å¦è¢«å›æ”¶ã€‚ å°ç»“ Referenceæ˜¯éå¼ºå¼•ç”¨çš„å…¶ä»–ä¸‰ç§å¼•ç”¨çš„å…±åŒçˆ¶ç±»ã€‚ ReferenceQueueåªå­˜å‚¨äº†å¼•ç”¨é“¾è¡¨çš„å¤´èŠ‚ç‚¹ï¼Œæä¾›äº†å¼•ç”¨é“¾è¡¨çš„æ“ä½œï¼Œå®é™…ä¸Šï¼Œå¼•ç”¨é“¾è¡¨æ˜¯Referenceå®ä¾‹å†…éƒ¨å˜é‡å­˜å‚¨çš„ã€‚ ReferenceHandlerå®ˆæŠ¤çº¿ç¨‹çº¿ç¨‹ç”±Referenceçš„é™æ€ä»£ç å—åˆ›å»ºå’Œè¿è¡Œï¼Œä½œç”¨æ˜¯å¤„ç†pendingé“¾è¡¨çš„å¼•ç”¨å…ƒç´ ä½¿ä¹‹çŠ¶æ€å˜æ›´ï¼Œä¼´éšç€ReferenceQueueçš„ç›¸å…³æ“ä½œã€‚ Finalizerå®ˆæŠ¤çº¿ç¨‹æ˜¯ç”±Finalizerç±»çš„é™æ€ä»£ç å—åˆ›å»ºå’Œè¿è¡Œçš„ï¼Œä½œç”¨æ˜¯å¤„ç†Finalizerç±»å†…éƒ¨ç»´æŠ¤çš„F-Queueé“¾è¡¨(é“¾è¡¨å…ƒç´ å…¥é˜Ÿæ“ä½œç”±JVMå®ç°)çš„å…ƒç´ è°ƒç”¨å…³è”å¯¹è±¡çš„finalize()æ–¹æ³•ã€‚ ReferenceHandlerå®ˆæŠ¤çº¿ç¨‹çº¿å’ŒFinalizerå®ˆæŠ¤çº¿ç¨‹å…±åŒåä½œæ‰èƒ½ä½¿å¼•ç”¨ç±»å‹å¯¹è±¡å†…å­˜å›æ”¶ç³»ç»Ÿçš„å·¥ä½œèƒ½å¤Ÿæ­£å¸¸è¿›è¡Œã€‚ å››ç§å¼•ç”¨ç±»å‹çš„æ€»ç»“ï¼š å¼•ç”¨ç±»å‹ è¢«åƒåœ¾æ”¶é›†å™¨å›æ”¶çš„æ—¶æœº ä¸»è¦ç”¨é€” ç”Ÿå­˜å‘¨æœŸ å¼ºå¼•ç”¨ ç›´åˆ°å†…å­˜æº¢å‡ºä¹Ÿä¸ä¼šå›æ”¶ æ™®éå¯¹è±¡çš„çŠ¶æ€ ä»åˆ›å»ºåˆ°JVMå®ä¾‹ç»ˆæ­¢è¿è¡Œ è½¯å¼•ç”¨ åƒåœ¾å›æ”¶å¹¶ä¸”å†…å­˜ä¸è¶³æ—¶ æœ‰ç”¨ä½†éå¿…é¡»çš„å¯¹è±¡ç¼“å­˜ ä»åˆ›å»ºåˆ°åƒåœ¾å›æ”¶å¹¶ä¸”å†…å­˜ä¸è¶³æ—¶ å¼±å¼•ç”¨ åƒåœ¾å›æ”¶æ—¶ éå¿…é¡»çš„å¯¹è±¡ç¼“å­˜ ä¸Šä¸€æ¬¡åƒåœ¾å›æ”¶ç»“æŸåˆ°ä¸‹ä¸€æ¬¡åƒåœ¾å›æ”¶å¼€å§‹ è™šå¼•ç”¨ - å…³è”çš„å¯¹è±¡è¢«åƒåœ¾æ”¶é›†å™¨å›æ”¶æ—¶å€™å¾—åˆ°ä¸€ä¸ªç³»ç»Ÿé€šçŸ¥ - å‚è€ƒèµ„æ–™ï¼š JDK11éƒ¨åˆ†æºç ã€‚ ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœº-2ndã€‹- è¿™æœ¬ä¹¦ç®—æ˜¯å›½å†…ä¹¦ç±å†™å¾—æ¯”è¾ƒè‰¯å¿ƒçš„ä¸€æœ¬äº†ï¼Œä¸è¿‡æœ‰å¾ˆå¤šå°çš„é—®é¢˜æˆ–è€…ç¬”è¯¯ä¹‹å¤„ï¼Œéœ€è¦è‡ªè¡Œå‘ç°å’Œä¿®æ­£ã€‚ (è¿‡å¹´æ¯”è¾ƒæ‡’ï¼Œå¾ˆä¹…æ²¡å‘æ–‡ e-a-20190215 c-14-d)","categories":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/tags/Java/"},{"name":"Reference","slug":"Reference","permalink":"http://throwable.club/blog/tags/Reference/"}]},{"title":"JSR310æ–°æ—¥æœŸAPI(äº”)-åœ¨ä¸»æµæ¡†æ¶ä¸­ä½¿ç”¨æ–°æ—¥æœŸæ—¶é—´ç±»","slug":"java-jsr310-framework-integration","date":"2019-01-07T16:02:48.000Z","updated":"2019-01-07T16:03:12.352Z","comments":true,"path":"2019/01/08/java-jsr310-framework-integration/","link":"","permalink":"http://throwable.club/2019/01/08/java-jsr310-framework-integration/","excerpt":"","text":"JSR310æ–°æ—¥æœŸAPI(äº”)-åœ¨ä¸»æµæ¡†æ¶ä¸­ä½¿ç”¨æ–°æ—¥æœŸæ—¶é—´ç±» å‰æ å‰é¢çš„å‡ ç¯‡æ–‡ç« å·²ç»åŸºæœ¬ä»‹ç»å®Œäº†JSR-310æ—¥æœŸæ—¶é—´ç±»åº“çš„åŸºæœ¬ä½¿ç”¨ï¼Œè¿™ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»åœ¨ä¸»æµçš„æ¡†æ¶ä¸­å¦‚ä½•ä½¿ç”¨è¿™äº›ç±»åº“ã€‚å› ä¸ºæ¶‰åŠåˆ°æ•°æ®åº“æ“ä½œï¼Œå…ˆå‡†å¤‡å¥½ä¸€å¼ è¡¨å’Œå¯¹åº”çš„å®ä½“ã€‚ 12345678CREATE TABLE `t_user`( id BIGINT PRIMARY KEY COMMENT 'ä¸»é”®', username VARCHAR(10) COMMENT 'å§“å', birthday DATE COMMENT 'ç”Ÿæ—¥', create_time DATETIME COMMENT 'åˆ›å»ºæ—¶é—´', KEY idx_name(`username`), KEY idx_create_time(`create_time`))COMMENT 'ç”¨æˆ·è¡¨'; 12345678@Datapublic class User&#123; private Long id; private String name; private LocalDate birthday; private OffsetDateTime createTime;&#125; è¿™é‡Œå¦‚æœä¸è€ƒè™‘æ—¶åŒºçš„å½±å“ï¼ŒcreateTimeä¹Ÿå¯ä»¥ä½¿ç”¨LocalDateTimeç±»å‹ã€‚å¦å¤–ï¼Œä¸ºäº†è¿æ¥æµ‹è¯•æ•°æ®åº“ï¼Œè¿™é‡Œå¼•å…¥â€™å…‰â€™è¿æ¥æ± çš„ä¾èµ–ï¼š 12345&lt;dependency&gt; &lt;groupId&gt;com.zaxxer&lt;/groupId&gt; &lt;artifactId&gt;HikariCP&lt;/artifactId&gt; &lt;version&gt;3.2.0&lt;/version&gt;&lt;/dependency&gt; JDBCä¸­ä½¿ç”¨JSR-310æ—¥æœŸæ—¶é—´ç±»åº“ è¯´å®è¯ï¼Œç”±äºJDBCç±»åº“åœ¨æ–¹æ³•å‚æ•°æˆ–è€…è¿”å›å€¼ç±»å‹å¾ˆä¹…æ²¡æ›´æ–°ï¼Œå¯¹äºå¸¦æ—¥æœŸæ—¶é—´çš„å±æ€§ï¼Œç»Ÿä¸€ä½¿ç”¨java.sql.Timestampç±»å‹ï¼Œå¯¹äºæ—¥æœŸç±»å‹çš„å±æ€§åˆ™ç»Ÿä¸€ä½¿ç”¨java.sql.Dateï¼Œå› æ­¤éœ€è¦è¿›è¡Œç±»å‹è½¬æ¢ã€‚ä»£ç å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839public class JdbcSample &#123; public static void main(String[] args) throws Exception &#123; HikariConfig config = new HikariConfig(); config.setMaximumPoolSize(10); config.setJdbcUrl(\"jdbc:mysql://localhost:3306/test?useSSL=false&amp;characterEncoding=utf8\"); config.setUsername(\"root\"); config.setPassword(\"root\"); config.setDriverClassName(\"com.mysql.jdbc.Driver\"); DataSource dataSource = new HikariDataSource(config); Connection connection = dataSource.getConnection(); connection.setAutoCommit(false); PreparedStatement p = connection.prepareStatement(\"INSERT INTO t_user(id,username,birthday,create_time) VALUES (?,?,?,?)\"); p.setLong(1, 1L); p.setString(2, \"Throwable\"); p.setDate(3, Date.valueOf(LocalDate.of(1993, 3, 10))); p.setTimestamp(4, Timestamp.from(OffsetDateTime.now().toInstant())); //LocalDateTime -&gt; p.setTimestamp(4, Timestamp.from(LocalDateTime.now())); int updateCount = p.executeUpdate(); connection.commit(); System.out.println(String.format(\"æ›´æ–°æ•°æ®%dæ¡\", updateCount)); p = connection.prepareStatement(\"SELECT * FROM t_user WHERE id = ?\"); p.setLong(1, 1L); ResultSet resultSet = p.executeQuery(); User user = null; if (resultSet.next()) &#123; user = new User(); user.setId(resultSet.getLong(\"id\")); user.setName(resultSet.getString(\"username\")); user.setBirthday(resultSet.getDate(\"birthday\").toLocalDate()); user.setCreateTime(OffsetDateTime.ofInstant(resultSet.getTimestamp(\"create_time\").toInstant(), ZoneId.systemDefault())); //LocalDateTime -&gt; user.setCreateTime(resultSet.getTimestamp(\"create_time\").toLocalDateTime()); &#125; System.out.println(user); &#125;&#125;// è¾“å‡ºç»“æœæ›´æ–°æ•°æ®1æ¡User(id=1, name=Throwable, birthday=1993-03-10, createTime=2019-01-06T23:09:01+08:00) é™¤äº†éœ€è¦åšå°‘é‡ç±»å‹è½¬æ¢ï¼Œæ²¡æœ‰å…¶ä»–çš„å…¼å®¹æ€§é—®é¢˜ã€‚ Mybatisä¸­ä½¿ç”¨JSR-310æ—¥æœŸæ—¶é—´ç±»åº“ æ—¢ç„¶JDBCå·²ç»å¯ä»¥ä½¿ç”¨JSR-310çš„æ—¥æœŸæ—¶é—´ç±»åº“ï¼Œé‚£ä¹ˆåŸºäºJDBCå°è£…çš„ORMæ¡†æ¶å¿…å®šä¹Ÿå¯ä»¥æ”¯æŒã€‚é™¤äº†éœ€è¦å¼•å…¥Mybatisæœ¬èº«çš„ä¾èµ–ï¼Œè¿˜éœ€è¦å¼•å…¥mybatis-typehandlers-jsr310ä¾èµ–ï¼š 12345678910&lt;dependency&gt; &lt;groupId&gt;org.mybatis&lt;/groupId&gt; &lt;artifactId&gt;mybatis&lt;/artifactId&gt; &lt;version&gt;3.4.6&lt;/version&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.mybatis&lt;/groupId&gt; &lt;artifactId&gt;mybatis-typehandlers-jsr310&lt;/artifactId&gt; &lt;version&gt;1.0.2&lt;/version&gt;&lt;/dependency&gt; æ–°å»ºä¸€ä¸ªMapperæ¥å£ç±»UserMapperï¼š 12345678public interface UserMapper &#123; @Insert(\"INSERT INTO t_user(id,username,birthday,create_time) VALUES (#&#123;id&#125;,#&#123;name&#125;,#&#123;birthday&#125;,#&#123;createTime&#125;)\") int insert(User user); @Select(\"SELECT id,username as name,birthday,create_time as createTime FROM t_user WHERE id = #&#123;id&#125;\") User selectById(Long id);&#125; æ ¸å¿ƒä»£ç å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233public class MybatisSample &#123; public static void main(String[] args) throws Exception &#123; HikariConfig config = new HikariConfig(); config.setMaximumPoolSize(10); config.setJdbcUrl(\"jdbc:mysql://localhost:3306/test?useSSL=false&amp;characterEncoding=utf8\"); config.setUsername(\"root\"); config.setPassword(\"root\"); config.setDriverClassName(\"com.mysql.jdbc.Driver\"); DataSource dataSource = new HikariDataSource(config); TransactionFactory transactionFactory = new JdbcTransactionFactory(); Environment environment = new Environment(\"development\", transactionFactory, dataSource); Configuration configuration = new Configuration(environment); configuration.addMapper(UserMapper.class); SqlSessionFactory sqlSessionFactory = new SqlSessionFactoryBuilder().build(configuration); SqlSession sqlSession = sqlSessionFactory.openSession(); UserMapper userMapper = sqlSession.getMapper(UserMapper.class); User user = new User(); user.setId(1L); user.setCreateTime(OffsetDateTime.now()); user.setBirthday(LocalDate.of(1993, 3, 10)); user.setName(\"Throwable\"); int updateCount = userMapper.insert(user); System.out.println(String.format(\"æ›´æ–°æ•°æ®%dæ¡\", updateCount)); sqlSession.commit(); User result = userMapper.selectById(1L); System.out.println(result); sqlSession.close(); &#125;&#125;// è¾“å‡ºç»“æœæ›´æ–°æ•°æ®1æ¡User(id=1, name=Throwable, birthday=1993-03-10, createTime=2019-01-06T23:30:09+08:00) è™½ç„¶å¤šå¼•å…¥äº†ä¸€ä¸ªä¾èµ–ï¼Œä½†æ˜¯ä½¿ç”¨èµ·æ¥ååˆ†ç®€å•ï¼Œç”šè‡³å¯ä»¥åšåˆ°å¼€å‘æ€æ— æ„ŸçŸ¥ï¼ŒMybatisè¿™ä¸€ç‚¹åšå¾—æ¯”è¾ƒå®Œå–„ã€‚ Jacksonä¸­ä½¿ç”¨JSR-310æ—¥æœŸæ—¶é—´ç±»åº“ Jacksonä»2.xæŸä¸ªç‰ˆæœ¬ä¸­ï¼Œå®˜æ–¹å°±åŸºäºJDK8çš„æ–°ç‰¹æ€§å¼€å‘äº†ç¬¬ä¸‰æ–¹ç±»åº“jackson-modules-java8ï¼Œè¿™ä¸ªç¬¬ä¸‰æ–¹ç±»åº“åŒ…æ‹¬ä¸‰ä¸ªæ¨¡å—jackson-module-parameter-namesã€jackson-datatype-jdk8å’Œjackson-datatype-jsr310ï¼Œè¿™ä¸‰ä¸ªæ¨¡å—æ˜¯ç‹¬ç«‹æ‰“åŒ…çš„ï¼Œå¯ä»¥æŒ‰éœ€å¼•å…¥ã€‚è¿™é‡Œåšçš„å®ä¾‹éœ€è¦å¼•å…¥ä¸‹é¢çš„ä¾èµ–ï¼š 12345678910&lt;dependency&gt; &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt; &lt;artifactId&gt;jackson-databind&lt;/artifactId&gt; &lt;version&gt;2.9.8&lt;/version&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;com.fasterxml.jackson.datatype&lt;/groupId&gt; &lt;artifactId&gt;jackson-datatype-jsr310&lt;/artifactId&gt; &lt;version&gt;2.9.8&lt;/version&gt;&lt;/dependency&gt; åœ¨å®˜æ–¹æ–‡æ¡£ä¸­å·²ç»å¾ˆè¯¦ç»†ç»™å‡ºå…·ä½“çš„ä½¿ç”¨ä¾‹å­ï¼Œè¿™é‡Œä¹Ÿç®€å•åšä¸€ä¸ªä¾‹å­ï¼š 12345678910111213141516171819202122232425262728public class JacksonMain &#123; private static final DateTimeFormatter DATE_FORMATTER = DateTimeFormatter.ofPattern(\"yyyy-MM-dd\"); private static final DateTimeFormatter DATE_TIME_FORMATTER = DateTimeFormatter.ofPattern(\"yyyy-MM-dd HH:mm:ss\"); public static void main(String[] args) throws Exception &#123; ObjectMapper objectMapper = new ObjectMapper(); JavaTimeModule javaTimeModule = new JavaTimeModule(); javaTimeModule.addSerializer(LocalDate.class, new LocalDateSerializer(DATE_FORMATTER)); javaTimeModule.addDeserializer(LocalDate.class, new LocalDateDeserializer(DATE_FORMATTER)); javaTimeModule.addSerializer(LocalDateTime.class, new LocalDateTimeSerializer(DATE_TIME_FORMATTER)); javaTimeModule.addDeserializer(LocalDateTime.class, new LocalDateTimeDeserializer(DATE_TIME_FORMATTER)); objectMapper.registerModule(javaTimeModule); Sample sample = new Sample(); sample.setLocalDate(LocalDate.now()); sample.setLocalDateTime(LocalDateTime.now()); System.out.println(objectMapper.writeValueAsString(sample)); &#125; @Data public static class Sample &#123; private LocalDate localDate; private LocalDateTime localDateTime; &#125;&#125;// æŸä¸ªæ—¶åˆ»è¾“å‡ºå¦‚ä¸‹&#123;\"localDate\":\"2019-01-07\",\"localDateTime\":\"2019-01-07 23:40:12\"&#125; ObjectMapperå®ä¾‹ä¸­å¯ä»¥æ³¨å†Œè‡ªå®šä¹‰çš„JavaTimeModuleæ¨¡å—ï¼ŒJavaTimeModuleæ¨¡å—ä¸­å·²ç»å­˜åœ¨äº†ä¸å°‘é»˜è®¤çš„æ—¥æœŸæ—¶é—´ç±»çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–å™¨ï¼Œå¿…è¦æ—¶å¯ä»¥åƒä¸Šé¢çš„ä¾‹å­ä¸€æ ·é‡å†™å¯¹åº”çš„æ—¥æœŸæ—¶é—´ç±»å‹çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–å™¨å¹¶ä¸”è¦†ç›–å·²ç»é…ç½®çš„é»˜è®¤å®ç°ï¼Œè¿™æ ·å­å°±èƒ½å®ç°æˆ‘ä»¬æƒ³è¦çš„æ ¼å¼åŒ–è¾“å‡ºã€‚JavaTimeModuleé»˜è®¤çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–å™¨é…ç½®å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546public JavaTimeModule() &#123; super(PackageVersion.VERSION); this.addDeserializer(Instant.class, InstantDeserializer.INSTANT); this.addDeserializer(OffsetDateTime.class, InstantDeserializer.OFFSET_DATE_TIME); this.addDeserializer(ZonedDateTime.class, InstantDeserializer.ZONED_DATE_TIME); this.addDeserializer(Duration.class, DurationDeserializer.INSTANCE); this.addDeserializer(LocalDateTime.class, LocalDateTimeDeserializer.INSTANCE); this.addDeserializer(LocalDate.class, LocalDateDeserializer.INSTANCE); this.addDeserializer(LocalTime.class, LocalTimeDeserializer.INSTANCE); this.addDeserializer(MonthDay.class, MonthDayDeserializer.INSTANCE); this.addDeserializer(OffsetTime.class, OffsetTimeDeserializer.INSTANCE); this.addDeserializer(Period.class, JSR310StringParsableDeserializer.PERIOD); this.addDeserializer(Year.class, YearDeserializer.INSTANCE); this.addDeserializer(YearMonth.class, YearMonthDeserializer.INSTANCE); this.addDeserializer(ZoneId.class, JSR310StringParsableDeserializer.ZONE_ID); this.addDeserializer(ZoneOffset.class, JSR310StringParsableDeserializer.ZONE_OFFSET); this.addSerializer(Duration.class, DurationSerializer.INSTANCE); this.addSerializer(Instant.class, InstantSerializer.INSTANCE); this.addSerializer(LocalDateTime.class, LocalDateTimeSerializer.INSTANCE); this.addSerializer(LocalDate.class, LocalDateSerializer.INSTANCE); this.addSerializer(LocalTime.class, LocalTimeSerializer.INSTANCE); this.addSerializer(MonthDay.class, MonthDaySerializer.INSTANCE); this.addSerializer(OffsetDateTime.class, OffsetDateTimeSerializer.INSTANCE); this.addSerializer(OffsetTime.class, OffsetTimeSerializer.INSTANCE); this.addSerializer(Period.class, new ToStringSerializer(Period.class)); this.addSerializer(Year.class, YearSerializer.INSTANCE); this.addSerializer(YearMonth.class, YearMonthSerializer.INSTANCE); this.addSerializer(ZonedDateTime.class, ZonedDateTimeSerializer.INSTANCE); this.addSerializer(ZoneId.class, new ToStringSerializer(ZoneId.class)); this.addSerializer(ZoneOffset.class, new ToStringSerializer(ZoneOffset.class)); this.addKeySerializer(ZonedDateTime.class, ZonedDateTimeKeySerializer.INSTANCE); this.addKeyDeserializer(Duration.class, DurationKeyDeserializer.INSTANCE); this.addKeyDeserializer(Instant.class, InstantKeyDeserializer.INSTANCE); this.addKeyDeserializer(LocalDateTime.class, LocalDateTimeKeyDeserializer.INSTANCE); this.addKeyDeserializer(LocalDate.class, LocalDateKeyDeserializer.INSTANCE); this.addKeyDeserializer(LocalTime.class, LocalTimeKeyDeserializer.INSTANCE); this.addKeyDeserializer(MonthDay.class, MonthDayKeyDeserializer.INSTANCE); this.addKeyDeserializer(OffsetDateTime.class, OffsetDateTimeKeyDeserializer.INSTANCE); this.addKeyDeserializer(OffsetTime.class, OffsetTimeKeyDeserializer.INSTANCE); this.addKeyDeserializer(Period.class, PeriodKeyDeserializer.INSTANCE); this.addKeyDeserializer(Year.class, YearKeyDeserializer.INSTANCE); this.addKeyDeserializer(YearMonth.class, YearMothKeyDeserializer.INSTANCE); this.addKeyDeserializer(ZonedDateTime.class, ZonedDateTimeKeyDeserializer.INSTANCE); this.addKeyDeserializer(ZoneId.class, ZoneIdKeyDeserializer.INSTANCE); this.addKeyDeserializer(ZoneOffset.class, ZoneOffsetKeyDeserializer.INSTANCE);&#125; å¦‚æœç†Ÿç»ƒæŒæ¡Jacksonçš„è§£æåŸç†å’Œæºç ï¼Œå¯ä»¥å°è¯•ç»§æ‰¿JSR310FormattedSerializerBaseæˆ–è€…JSR310DateTimeDeserializerBaseå®ç°è‡ªå®šä¹‰åºåˆ—åŒ–æˆ–ååºåˆ—åŒ–å™¨ï¼Œä»æ›´åº•å±‚æ§åˆ¶æ—¥æœŸæ—¶é—´ç±»çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚ SpringMVCä¸­ä½¿ç”¨JSR-310æ—¥æœŸæ—¶é—´ç±»åº“ SpringMVCä¸­é»˜è®¤çš„HTTPæ¶ˆæ¯è½¬æ¢å™¨å°±æ˜¯ä½¿ç”¨Jacksonå®ç°çš„ï¼Œå‰é¢å·²ç»æåˆ°äº†Jacksonå¯ä»¥å®Œç¾æ”¯æŒJSR-310ï¼Œé‚£ä¹ˆSpringMVCä¹Ÿå¿…å®šå¯ä»¥æ”¯æŒï¼Œåªéœ€è¦å¯¹ObjectMapperåšä¸€äº›é¢å¤–çš„é…ç½®å³å¯ã€‚è¿™é‡Œç®€å•ä»¥SpringBootåº”ç”¨åšç¤ºä¾‹ï¼Œå¼•å…¥ä¾èµ–ï¼š 123456789101112131415&lt;dependency&gt; &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt; &lt;artifactId&gt;jackson-databind&lt;/artifactId&gt; &lt;version&gt;2.9.8&lt;/version&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;com.fasterxml.jackson.datatype&lt;/groupId&gt; &lt;artifactId&gt;jackson-datatype-jsr310&lt;/artifactId&gt; &lt;version&gt;2.9.8&lt;/version&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt; &lt;version&gt;2.1.0.RELEASE&lt;/version&gt;&lt;/dependency&gt; ç”±äºorg.springframework.boot.autoconfigure.jackson.JacksonAutoConfigurationä¸­ä¼šé€šè¿‡Jackson2ObjectMapperBuilderå»æ„é€ å†…éƒ¨ä½¿ç”¨çš„ObjectMapperï¼Œæˆ‘ä»¬åªéœ€è¦æä¾›ä¸€ä¸ªè‡ªå®šä¹‰çš„Jackson2ObjectMapperBuilderç±»å‹çš„Beanå³å¯ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849// é…ç½®ç±»@Configurationpublic class JacksonBuilderAutoConfiguration &#123; private static final DateTimeFormatter DATE_FORMATTER = DateTimeFormatter.ofPattern(\"yyyy-MM-dd\"); private static final DateTimeFormatter DATE_TIME_FORMATTER = DateTimeFormatter.ofPattern(\"yyyy-MM-dd HH:mm:ss\"); @Bean public Jackson2ObjectMapperBuilder jackson2ObjectMapperBuilder() &#123; Jackson2ObjectMapperBuilder builder = new Jackson2ObjectMapperBuilder(); JavaTimeModule javaTimeModule = new JavaTimeModule(); javaTimeModule.addSerializer(LocalDate.class, new LocalDateSerializer(DATE_FORMATTER)); javaTimeModule.addDeserializer(LocalDate.class, new LocalDateDeserializer(DATE_FORMATTER)); javaTimeModule.addSerializer(LocalDateTime.class, new LocalDateTimeSerializer(DATE_TIME_FORMATTER)); javaTimeModule.addDeserializer(LocalDateTime.class, new LocalDateTimeDeserializer(DATE_TIME_FORMATTER)); builder.modules(javaTimeModule); return builder; &#125;&#125;// å¯åŠ¨ç±»@SpringBootApplicationpublic class Application implements CommandLineRunner &#123; @Autowired private ObjectMapper objectMapper; public static void main(String[] args) &#123; SpringApplication.run(Application.class, args); &#125; @Override public void run(String... args) throws Exception &#123; Sample sample = new Sample(); sample.setLocalDate(LocalDate.now()); sample.setLocalDateTime(LocalDateTime.now()); System.out.println(objectMapper.writeValueAsString(sample)); &#125; @Data public static class Sample &#123; private LocalDate localDate; private LocalDateTime localDateTime; &#125;&#125;// è¿è¡Œå¯åŠ¨ç±»ï¼ŒæŸä¸ªæ—¶åˆ»è¾“å‡ºå¦‚ä¸‹&#123;\"localDate\":\"2019-01-07\",\"localDateTime\":\"2019-01-07 23:58:08\"&#125; è¿™é‡Œåªè¦ä¿è¯SpringMVCå†…éƒ¨ä½¿ç”¨çš„ObjectMapperç±»å‹çš„Beanå¯¹JSR-310æ—¥æœŸæ—¶é—´ç±»å‹çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ç”Ÿæ•ˆå³å¯ï¼Œå› ä¸ºé»˜è®¤é…ç½®çš„MappingJackson2HttpMessageConverterHTTPæ¶ˆæ¯è½¬æ¢å™¨å°±æ˜¯ä½¿ç”¨å†…ç½®çš„ObjectMapperç±»å‹çš„BeanåšJSONçš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ã€‚ å°ç»“ å®æˆ˜å±‚é¢æ¥çœ‹ï¼Œä½¿ç”¨çš„æ¡†æ¶éƒ½æ˜¯åŸºäºJDKç±»åº“çš„å®ç°ï¼Œåªè¦JDKç±»åº“çš„åŠŸèƒ½å¯ä»¥å®ç°ï¼Œé‚£ä¹ˆåœ¨åº”ç”¨çš„æ—¶å€™è¦æœ‰ä¿¡å¿ƒä¸»æµçš„æ¡†æ¶ä¸€å®šä¼šæ”¯æŒå¯¹åº”çš„ç‰¹æ€§ã€‚ å‚è€ƒèµ„æ–™ï¼š Mybatiså®˜æ–¹æ–‡æ¡£ JDK11ç›¸å…³æºç å’Œæ³¨é‡Š (æœ¬æ–‡å®Œ e-a-201818 c-2-d)","categories":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/tags/Java/"},{"name":"JSR-310","slug":"JSR-310","permalink":"http://throwable.club/blog/tags/JSR-310/"}]},{"title":"JSR310æ–°æ—¥æœŸAPI(å››)-æ—¥æœŸæ—¶é—´å¸¸ç”¨è®¡ç®—å·¥å…·","slug":"java-jsr310-date-time-calculate","date":"2019-01-06T08:20:22.000Z","updated":"2019-01-06T08:25:10.417Z","comments":true,"path":"2019/01/06/java-jsr310-date-time-calculate/","link":"","permalink":"http://throwable.club/2019/01/06/java-jsr310-date-time-calculate/","excerpt":"","text":"JSR310æ–°æ—¥æœŸAPI(å››)-æ—¥æœŸæ—¶é—´å¸¸ç”¨è®¡ç®—å·¥å…· å‰æ è¿™ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»JSR-310ä¸­æ—¥æœŸæ—¶é—´ç±»çš„å¸¸ç”¨è®¡ç®—å·¥å…·ï¼ŒåŒ…æ‹¬å¸¸è§„çš„ä¸¤ä¸ªæ—¥æœŸæ—¶é—´å®ä¾‹ä¹‹é—´çš„å‰åæ¯”è¾ƒã€é—´éš”çš„æ—¶é—´é‡ç­‰ç­‰ã€‚ æ—¥æœŸæ—¶é—´çš„åŸºå‡†ç±» æ—¥æœŸæ—¶é—´ç±»åº“ä¸­æä¾›äº†å‡ ä¸ªå¸¸ç”¨çš„è®¡ç®—æˆ–è€…åº¦é‡åŸºå‡†ç±»ï¼Œåˆ†åˆ«æ˜¯ï¼š è¡¨ç¤ºå–å€¼èŒƒå›´çš„ValueRangeï¼šå†…éƒ¨æŒæœ‰å››ä¸ªä¸»è¦çš„æˆå‘˜å˜é‡minSmallestã€minLargestã€maxSmallestå’ŒmaxLargestï¼Œå¯ä»¥è¡¨ç¤ºçš„å€¼èŒƒå›´æ˜¯[minSmallest/maxSmallest,minLargest/maxLargest]ã€‚ è¡¨ç¤ºç§’å’Œçº³ç§’çº§åˆ«çš„æ—¶é—´é‡Durationï¼šTemporalAmountçš„å®ç°ç±»ï¼Œå†…éƒ¨æŒæœ‰ä¸€ä¸ªé•¿æ•´å‹çš„æˆå‘˜secondsä»£è¡¨ç§’å’Œä¸€ä¸ªæ•´å‹çš„æˆå‘˜nanosä»£è¡¨çº³ç§’ï¼Œç”±ç§’å’Œçº³ç§’ç»„æˆæ—¶é—´é‡ã€‚ è¡¨ç¤ºå¹´æœˆæ—¥çº§åˆ«çš„æ—¶é—´é‡Periodï¼šTemporalAmountçš„å®ç°ç±»ï¼Œå†…éƒ¨æŒæœ‰ä¸‰ä¸ªæ•´å‹çš„æˆå‘˜yearsã€monthså’Œdaysåˆ†åˆ«ä»£è¡¨å¹´ã€æœˆã€æ—¥ï¼Œç”±å¹´æœˆæ—¥ç»„æˆæ—¶é—´é‡ã€‚ æ—¥æœŸæ—¶é—´çš„åŸºæœ¬å•ä½TemporalUnitï¼šä¸»è¦å®ç°ç±»æ˜¯æšä¸¾ç±»å‹ChronoUnitï¼Œä¸€ä¸ªChronoUnitæˆå‘˜ä¼šç»´æŠ¤ä¸€ä¸ªå­—ç¬¦ä¸²åå­—å±æ€§nameå’Œä¸€ä¸ªDurationç±»å‹çš„å®ä¾‹ã€‚ æ—¥æœŸæ—¶é—´çš„å±æ€§(field)è¡¨ç¤ºTemporalFieldï¼šä¸»è¦å®ç°æ˜¯æšä¸¾ç±»å‹ChronoFieldï¼Œä¸€ä¸ªChronoFieldæˆå‘˜ä¼šç»´æŠ¤ä¸€ä¸ªå­—ç¬¦ä¸²åå­—å±æ€§nameã€ä¸€ä¸ªTemporalUnitçš„åŸºç¡€å•ä½baseUnitã€ä¸€ä¸ªTemporalUnitçš„è¡¨ç¤ºèŒƒå›´çš„å•ä½rangeUnitå’Œä¸€ä¸ªValueRangeç±»å‹çš„rangeç”¨äºè¡¨ç¤ºå½“å‰å±æ€§çš„èŒƒå›´ã€‚ ä¸¾ä¸€äº›ç®€å•çš„ä½¿ç”¨ä¾‹å­ï¼š 123456789101112public class ValueRangeMain &#123; public static void main(String[] args) throws Exception &#123; ValueRange valueRange = ValueRange.of(1L, 10000L); System.out.println(valueRange); valueRange = ValueRange.of(1L, 5L, 10000L, 50000L); System.out.println(valueRange); &#125;&#125;// è¾“å‡ºç»“æœ1 - 100001/5 - 10000/50000 123456789101112131415public class DurationMain &#123; public static void main(String[] args) throws Exception &#123; Duration duration = Duration.of(1L, ChronoUnit.HOURS); System.out.println(duration); duration = Duration.from(duration); System.out.println(duration); duration = Duration.ofSeconds(1L, 999_999_999); System.out.println(duration.get(ChronoUnit.SECONDS)); &#125;&#125;//è¾“å‡ºç»“æœ - toStringæ–¹æ³•é‡å†™äº†ï¼Œæœ‰ç‰¹å®šçš„æ ¼å¼PT1HPT1H1 123456789101112public class PeriodMain &#123; public static void main(String[] args) throws Exception &#123; Period period = Period.of(10, 10, 10); System.out.println(period); period = Period.from(period); System.out.println(period.getYears()); &#125;&#125;//è¾“å‡ºç»“æœP10Y10M10D10 å¸¸ç”¨è®¡ç®—å·¥å…· åˆ¤æ–­æ˜¯å¦é—°å¹´ åˆ¤æ–­æ˜¯å¦é—°å¹´è¿™ä¸ªåŠŸèƒ½æ˜¯ç”±å¹´è¡¨Chronologyæä¾›çš„ï¼Œå› ä¸ºä¸åŒçš„å¹´è¡¨ä¸­çš„é—°å¹´è§„åˆ™å¯èƒ½ä¸ä¸€è‡´ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éƒ½æ˜¯ä½¿ç”¨ISOè§„èŒƒä¸‹çš„å¹´è¡¨ï¼Œå¯¹åº”çš„æ˜¯IsoChronologyï¼Œå¯ä»¥çœ‹ä¸€ä¸‹IsoChronologyåˆ¤æ–­é—°å¹´æ–¹æ³•çš„å®ç°ï¼š 123public boolean isLeapYear(long prolepticYear) &#123; return ((prolepticYear &amp; 3) == 0) &amp;&amp; ((prolepticYear % 100) != 0 || (prolepticYear % 400) == 0);&#125; è¿™ä¸ªä¹Ÿæ˜¯æœ€å¸¸è§çš„JavaåŸºç¡€é¢è¯•é¢˜ä¹‹ä¸€ï¼Œå¯ä»¥è®°ä¸‹æ¥æ€ä¹ˆå®ç°ã€‚é™æ€æ–¹æ³•java.time.Year#isLeap()ä¹Ÿæ˜¯åŒæ ·çš„å®ç°ã€‚ä¸¾ä¸ªç®€å•çš„ä½¿ç”¨ä¾‹å­ï¼š 123456789101112131415161718public class IsLeapYearMain &#123; public static void main(String[] args) throws Exception &#123; int year = 2016; System.out.println(Year.isLeap(year)); System.out.println(IsoChronology.INSTANCE.isLeapYear(year)); // 2018å¹´ LocalDate localDate = LocalDate.now(); LocalDateTime localDateTime = LocalDateTime.now(); System.out.println(localDate.isLeapYear()); System.out.println(localDateTime.toLocalDate().isLeapYear()); &#125;&#125;// è¾“å‡ºç»“æœtruetruefalsefalse æ¯”è¾ƒæ—¥æœŸæ—¶é—´çš„å…ˆå æ‰€æœ‰çš„æ—¥æœŸæ—¶é—´ã€æ—¥æœŸã€æ—¶é—´ç±»éƒ½å…·å¤‡ä¸‰ä¸ªæ¯”è¾ƒæ–¹æ³•ï¼šisBefore()ã€isAfter()å’ŒisEqual()æˆ–è€…equals()ï¼Œå¯¹äºChronoLocalDateTimeæˆ–è€…ChronoZonedDateTimeï¼Œåº•å±‚æ€»æ˜¯å…ˆè½¬åŒ–ä¸ºæ–°çºªå…ƒå¤©æ•°å†åŸºäºå¤©æ•°è¿›è¡Œæ¯”è¾ƒã€‚ä¸¾ä¸ªç®€å•çš„ä½¿ç”¨ä¾‹å­ï¼š 123456789101112public class DateTimeCompareMain &#123; public static void main(String[] args) throws Exception &#123; System.out.println(LocalDateTime.now().isBefore(LocalDateTime.now().plus(1, ChronoUnit.SECONDS))); System.out.println(LocalDate.now().isBefore(LocalDate.now().plus(1, ChronoUnit.DAYS))); System.out.println(LocalTime.now().equals(LocalTime.now().plus(1, ChronoUnit.SECONDS))); &#125;&#125;// è¾“å‡ºtruetruefalse è®¡ç®—æ—¥æœŸæ—¶é—´çš„é—´éš” è®¡ç®—æ—¥æœŸæ—¶é—´çš„é—´éš”ä¸»è¦é€šè¿‡Durationæˆ–è€…Periodçš„é™æ€æ–¹æ³•ï¼Œä¸»è¦æ˜¯é€šè¿‡ä¸¤ä¸ªç±»çš„between()æ–¹æ³•ï¼š 12345678910111213// Durationä¸­public class Duration&#123; public static Duration between(Temporal startInclusive, Temporal endExclusive)&#125;// Periodä¸­public class Period&#123; public static ChronoPeriod between(ChronoLocalDate startDateInclusive, ChronoLocalDate endDateExclusive) public static Period between(LocalDate startDateInclusive, LocalDate endDateExclusive)&#125; å¯¹äºæ—¥æœŸæ—¶é—´ç±»æ¥è¯´ï¼Œè®¡ç®—æ—¶é—´é—´éš”åº•å±‚æ˜¯åŸºäºTemporalUnit#between()æ–¹æ³•ï¼Œå…¥å£æ–¹æ³•ä¸€èˆ¬æ˜¯long until(Temporal endExclusive, TemporalUnit unit)æ–¹æ³•ã€‚ ä¸¾ä¸ªç®€å•çš„ä½¿ç”¨ä¾‹å­ï¼š 123456789101112131415161718192021222324252627282930public class DurationPeriodMain &#123; public static void main(String[] args) throws Exception &#123; LocalTime start = LocalTime.of(1, 1, 1); LocalTime end = LocalTime.of(2, 2, 2); Duration duration = Duration.between(start, end); long until = start.until(end, ChronoUnit.SECONDS); System.out.println(duration.getSeconds()); System.out.println(until); LocalDateTime startDt = LocalDateTime.of(2017, 9, 6, 1, 2, 3); LocalDateTime endDt = LocalDateTime.of(2018, 1, 6, 12, 12, 12); duration = Duration.between(startDt, endDt); until = startDt.until(endDt, ChronoUnit.SECONDS); System.out.println(duration.getSeconds()); System.out.println(until); LocalDate startD = LocalDate.of(2018, 2, 1); LocalDate endD = LocalDate.of(2019, 1, 6); Period period = Period.between(startD, endD); Period untilPeriod = startD.until(endD); System.out.println(period); System.out.println(untilPeriod); &#125;&#125;// è¾“å‡ºç»“æœ366136611058100910581009P11M5DP11M5D åªè¦é€šè¿‡è®¡ç®—å¾—åˆ°Durationæˆ–è€…Periodå®ä¾‹ï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡get(TemporalUnit unit)æ–¹æ³•è½¬æ¢ä¸ºå¯¹åº”å•ä½çš„æ—¶é—´é‡ï¼Œä½†æ˜¯è¦æ³¨æ„çš„æ˜¯å¯¹äºæ­¤æ–¹æ³•Durationåªæ”¯æŒChronoUnit.SECONDSå’ŒChronoUnit.NANOSï¼Œè€ŒPeriodåªæ”¯æŒChronoUnit.YEARSã€ChronoUnit.MONTHSå’ŒChronoUnit.DAYSã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ›´å¸Œæœ›å¾—çŸ¥ä¸¤ä¸ªæ—¥æœŸæ—¶é—´ä¹‹é—´ç›¸å·®å¤šå°‘å¹´ï¼Œå¤šå°‘ä¸ªæœˆç­‰ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨Durationæˆ–è€…Periodæä¾›çš„å®ä¾‹æ–¹æ³•ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546// Periodä¸­public class Period&#123; // ç›¸å·®çš„æ€»æœˆæ•° public long toTotalMonths()&#125;// Periodä¸­public class Period&#123; // è½¬æ¢ä¸ºå¤©æ•° public long toDays() // è½¬æ¢ä¸ºå°æ—¶æ•° public long toHours() // è½¬æ¢ä¸ºåˆ†é’Ÿæ•° public long toMinutes() // è½¬æ¢ä¸ºç§’é’Ÿæ•° public long toSeconds() // è½¬æ¢ä¸ºæ¯«ç§’æ•° public long toMillis() // è½¬æ¢ä¸ºçº³ç§’æ•° public long toNanos() // è½¬æ¢ä¸ºå‡†ç¡®å¤©æ•° public long toDaysPart() // è½¬æ¢ä¸ºå‡†ç¡®å°æ—¶æ•° public int toHoursPart() // è½¬æ¢ä¸ºå‡†ç¡®åˆ†é’Ÿæ•° public int toMinutesPart() // è½¬æ¢ä¸ºå‡†ç¡®ç§’é’Ÿæ•° public int toSecondsPart() // è½¬æ¢ä¸ºå‡†ç¡®æ¯«ç§’æ•° public int toMillisPart() // è½¬æ¢ä¸ºå‡†ç¡®çº³ç§’æ•° public int toNanosPart()&#125; ä»¥ä¸Šçš„å®ä¾‹æ–¹æ³•éƒ½æ˜¯åŸºäºæ•´æ•°çš„é™¤æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´ä¼šæˆªæ–­å°¾æ•°ã€‚ä¸¾ä¸ªç®€å•ä½¿ç”¨ä¾‹å­ï¼š 123456789LocalDateTime start = LocalDateTime.of(2017, 9, 6, 1, 2, 3);LocalDateTime end = LocalDateTime.of(2018, 1, 6, 12, 12, 12);Duration duration = Duration.between(start, end);Period period = Period.between(start.toLocalDate(), end.toLocalDate());System.out.println(duration.toDays());System.out.println(period.toTotalMonths());// è¾“å‡ºç»“æœ1224 å¦‚æœä¸ä½¿ç”¨Durationæˆ–è€…Periodï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨æ—¥æœŸæ—¶é—´ç±»çš„util()æ–¹æ³•ï¼Œæœ¬è´¨æ˜¯ä¸€è‡´çš„ï¼Œä»¥LocalDateTimeä¸ºä¾‹ï¼š 123456789LocalDateTime start = LocalDateTime.of(2017, 9, 6, 1, 2, 3);LocalDateTime end = LocalDateTime.of(2018, 1, 6, 12, 12, 12);long months = start.until(end, ChronoUnit.MONTHS);long days = start.until(end, ChronoUnit.DAYS);System.out.println(days);System.out.println(months);// è¾“å‡ºç»“æœ1224 (æœ¬æ–‡å®Œ c-1-d e-a-201816)","categories":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/tags/Java/"},{"name":"JSR-310","slug":"JSR-310","permalink":"http://throwable.club/blog/tags/JSR-310/"}]},{"title":"JSR310æ–°æ—¥æœŸAPI(ä¸‰)-æ—¥æœŸæ—¶é—´æ ¼å¼åŒ–ä¸è§£æ","slug":"java-jsr310-date-time-format-parse","date":"2019-01-05T13:43:51.000Z","updated":"2019-01-05T13:45:27.222Z","comments":true,"path":"2019/01/05/java-jsr310-date-time-format-parse/","link":"","permalink":"http://throwable.club/2019/01/05/java-jsr310-date-time-format-parse/","excerpt":"","text":"JSR310æ–°æ—¥æœŸAPI(ä¸‰)-æ—¥æœŸæ—¶é—´æ ¼å¼åŒ–ä¸è§£æ å‰æ å‰ä¸€ç¯‡æ–‡ç« å·²ç»æ¯”è¾ƒè¯¦ç»†åœ°ä»‹ç»äº†JSR-310ä¸­æ–°å¢çš„å¸¸ç”¨çš„æ—¥æœŸæ—¶é—´ç±»ï¼Œåœ¨å®é™…åº”ç”¨ä¸­ï¼Œæˆ‘ä»¬ä¹Ÿååˆ†å…³æ³¨è¿™äº›æ—¥æœŸæ—¶é—´ç±»çš„æ ¼å¼åŒ–æ“ä½œï¼Œæ›´åŠ é€šä¿—æ¥è¯´å°±æ˜¯å­—ç¬¦ä¸²å’Œæ—¥æœŸæ—¶é—´ç±»çš„ç›¸äº’è½¬æ¢é—®é¢˜ã€‚ä¸‹é¢å…ˆå›é¡¾ä¸€ä¸‹Javaæ—§æœ‰çš„æ—¥æœŸæ—¶é—´ç±»å’Œå­—ç¬¦ä¸²ä¹‹é—´çš„è½¬æ¢æ–¹æ¡ˆï¼Œç„¶åé‡ç‚¹åˆ†æJSR-310ä¸­æ–°å¢çš„å¸¸ç”¨çš„æ—¥æœŸæ—¶é—´ç±»å’Œå­—ç¬¦ä¸²ä¹‹é—´çš„è½¬æ¢æ–¹æ¡ˆã€‚ SimpleDateFormat Javaæ—§æœ‰çš„æ—¥æœŸæ—¶é—´ç±»æ ¼å¼åŒ–ä¸ºå­—ç¬¦ä¸²æˆ–è€…å­—ç¬¦ä¸²åŸºäºæ¨¡å¼(pattern)è§£æä¸ºæ—¥æœŸæ—¶é—´ç±»å®Œå…¨ä¾èµ–äºjava.text.DateFormatçš„å®ç°ç±»java.text.SimpleDateFormatã€‚SimpleDateFormatçš„åŸºæœ¬åŠŸèƒ½æ˜¯å®Œå¤‡çš„ï¼Œä½†æ˜¯å­˜åœ¨ä¸¤ä¸ªé—®é¢˜ï¼š è§£æå’Œæ ¼å¼åŒ–çš„æ•ˆç‡æ¯”è¾ƒä½ï¼ŒåŸå› æ˜¯ä¾èµ–äº†æœ¬æ¥å°±æ•ˆç‡ä¸é«˜çš„Calendarï¼Œå†…éƒ¨æœ‰å¤§é‡çš„å­—ç¬¦ä¸²æˆ–è€…å­—ç¬¦(char)çš„åˆ¤æ–­å’Œè½¬æ¢ä»£ç ï¼Œå› æ­¤ä½¿ç”¨äº†å¤§é‡å¾ªç¯ã€switchå—ç­‰ï¼Œè¿™äº›å› ç´ éƒ½å¯¼è‡´äº†SimpleDateFormatçš„æ•ˆç‡æ¯”è¾ƒä½ã€‚ éçº¿ç¨‹å®‰å…¨ï¼Œè¿™ä¸ªæ˜¯å› ä¸ºSimpleDateFormatåœ¨åšè½¬æ¢æ“ä½œçš„æ—¶å€™å…±äº«äº†DateFormatçš„ä¸€ä¸ªå†…éƒ¨Calendarçš„æˆå‘˜calendarã€‚ æ•ˆç‡ä½æ˜¯å¯ä»¥å¿å—çš„ï¼Œä½†æ˜¯éçº¿ç¨‹å®‰å…¨è¿™ä¸€ç‚¹å¯èƒ½ä¼šå¯¼è‡´ä¸¥é‡çš„é—®é¢˜ã€‚å¯¹äºéçº¿ç¨‹å®‰å…¨è¿™ä¸ªé—®é¢˜ä¹Ÿæœ‰è§£å†³æ–¹æ¡ˆï¼š æ–¹æ¡ˆä¸€ï¼šæŠŠSimpleDateFormatå®ä¾‹å°é—­åœ¨æ–¹æ³•ä¸­ï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨çš„æ—¶å€™æ‰åˆ›å»ºï¼Œè¿™æ ·è™½ç„¶å¯¼è‡´äº†èµ„æºæµªè´¹ï¼Œä½†æ˜¯å¯ä»¥é¿å…å¹¶å‘é—®é¢˜ã€‚ æ–¹æ¡ˆäºŒï¼šä½¿ç”¨ThreadLocalè£…è½½SimpleDateFormatå®ä¾‹ï¼Œå¯¹äºåŒä¸€ä¸ªçº¿ç¨‹æ¥è¯´ï¼Œå…±äº«ä¸€ä¸ªSimpleDateFormatå®ä¾‹ã€‚ ä¸¾ä¸ªç®€å•çš„ä½¿ç”¨ä¾‹å­ï¼š 123456789101112131415161718public class SimpleDateFormatMain &#123; public static void main(String[] args) throws Exception &#123; java.util.Date date = new Date(); SimpleDateFormat simpleDateFormat = new SimpleDateFormat(\"yyyy-MM-dd HH:mm:ss\"); String dateString = simpleDateFormat.format(date); System.out.println(dateString); date = simpleDateFormat.parse(dateString); System.out.println(date); simpleDateFormat.applyPattern(\"yyyy-MM-dd\"); dateString = simpleDateFormat.format(date); System.out.println(dateString); &#125;&#125;// æŸä¸ªæ—¶åˆ»çš„è¾“å‡ºå¦‚ä¸‹2019-01-03 23:32:05Thu Jan 03 23:32:05 CST 20192019-01-03 å¯¹äºJavaæ—§æœ‰çš„æ—¥æœŸæ—¶é—´ç±»ï¼ŒSimpleDateFormatæ˜¯åŸºæœ¬èƒ½å¤Ÿæ»¡è¶³çš„ï¼Œå†åŠ ä¸Šæœ‰ç¬¬ä¸‰æ–¹åº“apache-common-lang3ã€joda-timeç­‰çš„è¡¥è¶³ï¼Œæ ¼å¼åŒ–å’Œè§£æçš„æ•ˆç‡ä¹Ÿä¼šæœ‰æ‰€æé«˜ã€‚ JSR-310æ—¥æœŸæ—¶é—´ç±»çš„æ ¼å¼åŒ–å’Œè§£æ JSR-310æ—¥æœŸæ—¶é—´ç±»çš„æ ¼å¼åŒ–ä¾èµ–äºæ—¥æœŸæ—¶é—´æ ¼å¼åŒ–å™¨java.time.format.DateTimeFormatterï¼Œå®ƒæœ‰ä¸€ä¸ªå»ºé€ å™¨ç±»java.time.format.DateTimeFormatterBuilderã€‚ DateTimeFormatterBuilder java.time.format.DateTimeFormatterBuilderç”¨äºæ„å»ºæ—¥æœŸæ—¶é—´ç±»æ ¼å¼åŒ–å™¨ï¼Œå®ƒåœ¨è®¾è®¡çš„æ—¶å€™ä½¿ç”¨äº†é“¾å¼ç»“æ„ï¼Œå†…éƒ¨æŒæœ‰ä¸€ä¸ªDateTimeFormatterBuilderç±»å‹çš„parentæˆå‘˜æŒ‡å‘çˆ¶DateTimeFormatterBuilderå®ä¾‹å’Œä¸€ä¸ªDateTimeFormatterBuilderç±»å‹çš„activeæˆå‘˜æŒ‡å‘å½“å‰çš„DateTimeFormatterBuilderå®ä¾‹ã€‚è¿˜æœ‰ä¸€ç‚¹æ¯”è¾ƒé‡è¦çš„æ˜¯ï¼šDateTimeFormatterBuilderå®ä¾‹å†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªDateTimePrinterParseråˆ—è¡¨printerParsersï¼ŒçœŸæ­£çš„è§£æå·¥ä½œæ˜¯å§”æ‰˜ç»™å¯¹åº”çš„DateTimePrinterParserå®ä¾‹å®Œæˆçš„ï¼Œå¦‚æœæ²¡æœ‰å¯ç”¨æˆ–è€…æ²¡æœ‰æ·»åŠ DateTimePrinterParserï¼Œé‚£ä¹ˆè§£ææˆ–è€…æ ¼å¼åŒ–æ–¹æ³•ç›¸å½“äºç©ºè·‘ã€‚æ¥ç€çœ‹ä¸‹DateTimeFormatterBuilderæä¾›æ„å»ºDateTimeFormatteræ—¶å…è®¸æ·»åŠ ç‰¹æ€§çš„æ–¹æ³•ã€‚ è§£æé£æ ¼é…ç½®ï¼š 12345678// å¤§å°å†™æ•æ„Ÿ - é»˜è®¤public DateTimeFormatterBuilder parseCaseSensitive()// å¤§å°å†™ä¸æ•æ„Ÿpublic DateTimeFormatterBuilder parseCaseInsensitive()// ä¸¥æ ¼ - é»˜è®¤public DateTimeFormatterBuilder parseStrict()// å®½æ¾public DateTimeFormatterBuilder parseLenient() é»˜è®¤å€¼é…ç½®ï¼š 12// åŸºäºTemporalFieldå®ä¾‹é…ç½®è§£ææ—¶å€™å†™å…¥é»˜è®¤å€¼ï¼Œæ”¯æŒçš„TemporalFieldä¸»è¦åœ¨ChronoFieldpublic DateTimeFormatterBuilder parseDefaulting(TemporalField field, long value) è¿½åŠ æ—¥æœŸæ—¶é—´å±æ€§æ ¼å¼åŒ–ç¬¦å·æ§åˆ¶é…ç½®ï¼š 123456789101112131415161718/** * å¯¹äºæ¯ä¸ªæ—¥æœŸæ—¶é—´å­—æ®µæ ¼å¼åŒ–çš„æ§åˆ¶ï¼Œå®é™…ä½œç”¨æ˜¯æ·»åŠ ä¸€ä¸ªDateTimePrinterParserçš„å®ç°NumberPrinterParser * TemporalFieldï¼šæ—¥æœŸæ—¶é—´å­—æ®µç±»å‹å®ä¾‹ï¼Œä¸»è¦å®ç°ç±»ä¸ºåœ¨ChronoFieldçš„æšä¸¾å±æ€§ * minWidthï¼šæ‰“å°æœ€å°é•¿åº¦é™åˆ¶ï¼ŒèŒƒå›´æ˜¯[1,19] * maxWidthï¼šæ‰“å°æœ€å¤§é•¿åº¦é™åˆ¶ï¼ŒèŒƒå›´æ˜¯[1,19] * SignStyleï¼šç¬¦å·é£æ ¼ï¼Œæœ‰NORMALã€ALWAYSã€NEVERã€NOT_NEGATIVEã€EXCEEDS_PADäº”ç§é€‰æ‹© * - NORMALï¼šä¸¥æ ¼æ¨¡å¼ä¸‹åªæ¥æ”¶è´Ÿå€¼ï¼Œå®½æ¾æ¨¡å¼ä¸‹æ¥æ”¶æ‰€æœ‰ç¬¦å· * - ALWAYSï¼š0ä¼šæ›¿æ¢ä¸º'+'ï¼Œä¸¥æ ¼æ¨¡å¼ä¸‹ä¸æ¥æ”¶ç¼ºå¤±çš„ç¬¦å·ï¼Œå®½æ¾æ¨¡å¼ä¸‹ç¼ºå¤±çš„ç¬¦å·ä¼šæ›¿æ¢ä¸ºä¸€ä¸ªæ­£æ•° * - NEVERï¼šåªè¾“å‡ºç»å¯¹çš„å›ºå®šå€¼ï¼Œä¸¥æ ¼æ¨¡å¼ä¸‹ä¸æ¥æ”¶ä»»ä½•ç¬¦å·ï¼Œå®½æ¾æ¨¡å¼ä¸‹åªæ¥æ”¶å›ºå®šé•¿åº¦çš„ç¬¦å· * - NOT_NEGATIVEï¼šä»¥å¼‚å¸¸çš„æ–¹å¼é˜»æ­¢è´Ÿå€¼ï¼Œä¸¥æ ¼æ¨¡å¼ä¸‹ä¸æ¥æ”¶ä»»ä½•ç¬¦å·ï¼Œå®½æ¾æ¨¡å¼ä¸‹åªæ¥æ”¶å›ºå®šé•¿åº¦çš„ç¬¦å· * - EXCEEDS_PADï¼šåªè¾“å‡ºè¶…å‡ºå®½åº¦é™åˆ¶çš„ç¬¦å·ï¼Œè´Ÿæ•°æ›¿æ¢ä¸º'-'ï¼Œä¸¥æ ¼æ¨¡å¼ä¸‹åªè¾“å‡ºè¶…å‡ºå®½åº¦é™åˆ¶çš„ç¬¦å·ï¼Œå®½æ¾æ¨¡å¼ä¸‹ç¼ºå¤±çš„ç¬¦å·ä¼šæ›¿æ¢ä¸ºä¸€ä¸ªæ­£æ•° */public DateTimeFormatterBuilder appendValue(TemporalField field, int minWidth, int maxWidth, SignStyle signStyle)// ä¸‹é¢2ä¸ªæ˜¯é‡è½½æ–¹æ³•// minWidth = 1,maxWidth = 19,signStyle = SignStyle.NORMALpublic DateTimeFormatterBuilder appendValue(TemporalField field)// minWidth = maxWidth = width,signStyle = SignStyle.NOT_NEGATIVEpublic DateTimeFormatterBuilder appendValue(TemporalField field, int width) è¿½åŠ åŸºäºåŸºç¡€å€¼è¿›è¡Œå‡å°‘é…ç½®ï¼š 1234// ä¾‹å¦‚field=YEARï¼Œwidth=2ï¼ŒbaseValue=2018ï¼Œé‚£ä¹ˆå½“å‰æ ¼å¼åŒ–çš„å®ä¾‹çš„æœ‰æ•ˆå€¼ä¸º[2018,2117]ï¼Œ2019-&gt;1ï¼Œ2117-&gt;99// widthèŒƒå›´æ˜¯[1,10]ï¼ŒmaxWidthèŒƒå›´æ˜¯[1,10]public DateTimeFormatterBuilder appendValueReduced(TemporalField field, int width, int maxWidth, int baseValue)public DateTimeFormatterBuilder appendValueReduced(TemporalField field, int width, int maxWidth, ChronoLocalDate baseDate) è¿½åŠ å°æ•°(ç‚¹)é…ç½®ï¼š 12// decimalPoint = trueåˆ™è¾“å‡ºå°æ•°ï¼ŒminWidthèŒƒå›´æ˜¯[0,9]ï¼ŒmaxWidthèŒƒå›´æ˜¯[1,9]public DateTimeFormatterBuilder appendFraction(TemporalField field, int minWidth, int maxWidth, boolean decimalPoint) è¿½åŠ æ–‡æœ¬æ ¼å¼é…ç½®ï¼š 123public DateTimeFormatterBuilder appendText(TemporalField field)public DateTimeFormatterBuilder appendText(TemporalField field, TextStyle textStyle)public DateTimeFormatterBuilder appendText(TemporalField field, Map&lt;Long, String&gt; textLookup) è¿½åŠ ç¬æ—¶æ—¶é—´é…ç½®ï¼š 12public DateTimeFormatterBuilder appendInstant()public DateTimeFormatterBuilder appendInstant(int fractionalDigits) è¿½åŠ æ—¶åŒºç›¸å…³çš„é…ç½®ï¼š 1234567891011121314151617// æ—¶é—´åç§»é‡å¦‚+01:00public DateTimeFormatterBuilder appendOffsetId()// æŒ‡å®šæ ¼å¼çš„æ—¶é—´åç§»é‡public DateTimeFormatterBuilder appendOffset(String pattern, String noOffsetText)// æŒ‡å®šæ–‡æœ¬é£æ ¼çš„æœ¬åœ°æ—¶é—´åç§»é‡public DateTimeFormatterBuilder appendLocalizedOffset(TextStyle style)public DateTimeFormatterBuilder appendZoneId()public DateTimeFormatterBuilder appendZoneRegionId()public DateTimeFormatterBuilder appendZoneOrOffsetId()public DateTimeFormatterBuilder appendZoneText(TextStyle textStyle)public DateTimeFormatterBuilder appendZoneText(TextStyle textStyle, Set&lt;ZoneId&gt; preferredZones)// å¤ªå¹³æ´‹æ—¶é—´æ—¶åŒºåç§»é‡public DateTimeFormatterBuilder appendGenericZoneText(TextStyle textStyle)public DateTimeFormatterBuilder appendGenericZoneText(TextStyle textStyle, Set&lt;ZoneId&gt; preferredZones) // æ—¥å†é…ç½®public DateTimeFormatterBuilder appendChronologyId()public DateTimeFormatterBuilder appendChronologyText(TextStyle textStyle) è¿½åŠ æœ¬åœ°æ—¥æœŸæ—¶é—´é…ç½®ï¼š 1public DateTimeFormatterBuilder appendLocalized(FormatStyle dateStyle, FormatStyle timeStyle) è¿½åŠ å¸¸é‡æ–‡å­—(å­—ç¬¦ä¸²)é…ç½®ï¼š 12public DateTimeFormatterBuilder appendLiteral(char literal)public DateTimeFormatterBuilder appendLiteral(String literal) è¿½åŠ å…¶ä»–æ ¼å¼åŒ–å™¨çš„å±æ€§åˆ°å½“æœŸå»ºé€ å™¨ï¼š 123public DateTimeFormatterBuilder append(DateTimeFormatter formatter)// é…ç½®å€™é€‰æ ¼å¼åŒ–å™¨public DateTimeFormatterBuilder appendOptional(DateTimeFormatter formatter) è¿½åŠ é€šç”¨æ ¼å¼é…ç½®ï¼š 12// patternçš„è§£æåŸºæœ¬åŒ…å«äº†ä¸Šé¢æåˆ°çš„å…¶ä»–ç§ç±»çš„é…ç½®public DateTimeFormatterBuilder appendPattern(String pattern) ä¸Šé¢åªæ˜¯åˆ†æå®Œæ¯•ï¼Œå®é™…ä¸Šç†è§£è¿™äº›é…ç½®æ–¹æ³•çš„æˆæœ¬è¿˜æ˜¯æŒºé«˜çš„ï¼Œå¯ä»¥å‚è€ƒDateTimeFormatterä¸­å·²ç»å­˜åœ¨çš„ä¸€äº›é™æ€å˜é‡ISO_LOCAL_TIMEã€ISO_OFFSET_TIMEã€ISO_LOCAL_DATE_TIMEç­‰å­¦ä¹ æ€ä¹ˆä½¿ç”¨DateTimeFormatterBuilderï¼š 12345678910111213public static final DateTimeFormatter ISO_LOCAL_TIME;static &#123; ISO_LOCAL_TIME = new DateTimeFormatterBuilder() .appendValue(HOUR_OF_DAY, 2) .appendLiteral(':') .appendValue(MINUTE_OF_HOUR, 2) .optionalStart() .appendLiteral(':') .appendValue(SECOND_OF_MINUTE, 2) .optionalStart() .appendFraction(NANO_OF_SECOND, 0, 9, true) .toFormatter(ResolverStyle.STRICT, null);&#125; æ¨¡ä»¿ä¸Šé¢çš„ä»£ç ï¼Œæˆ‘ä»¬åšä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼šæ ¼å¼åŒ–ç”¨LocalDateTimeå­˜å‚¨çš„æ—¥æœŸæ—¶é—´2018-1-5 15:30:30ä¸º&quot;å½“å‰æ—¶é—´æ˜¯ï¼š2018å¹´1æœˆ5æ—¥ 15æ—¶30åˆ†30ç§’ï¼Œç¥ä½ ç”Ÿæ´»æ„‰å¿«ï¼&quot;ã€‚ 12345678910111213141516171819202122232425262728public class DateTimeFormatterBuilderMain &#123; public static void main(String[] args) throws Exception &#123; DateTimeFormatterBuilder builder = new DateTimeFormatterBuilder(); builder.appendLiteral(\"å½“å‰æ—¶é—´æ˜¯ï¼š\"); builder.appendValue(ChronoField.YEAR, 4); builder.appendLiteral(\"å¹´\"); builder.appendValue(ChronoField.MONTH_OF_YEAR, 1, 2, SignStyle.NORMAL); builder.appendLiteral(\"æœˆ\"); builder.appendValue(ChronoField.DAY_OF_MONTH, 1, 2, SignStyle.NORMAL); builder.appendLiteral(\"æ—¥\"); builder.appendLiteral(\" \"); builder.appendValue(ChronoField.HOUR_OF_DAY, 2); builder.appendLiteral(\"æ—¶\"); builder.appendLiteral(\":\"); builder.appendValue(ChronoField.MINUTE_OF_HOUR, 2); builder.appendLiteral(\"åˆ†\"); builder.appendLiteral(\":\"); builder.appendValue(ChronoField.SECOND_OF_MINUTE, 2); builder.appendLiteral(\"ç§’\"); builder.appendLiteral(\"ï¼Œç¥ä½ ç”Ÿæ´»æ„‰å¿«ï¼\"); DateTimeFormatter formatter = builder.toFormatter(); System.out.println(formatter.format(LocalDateTime.now())); &#125;&#125;// æŸä¸ªæ—¶åˆ»æ‰§è¡Œåè¾“å‡ºç»“æœå½“å‰æ—¶é—´æ˜¯ï¼š2019å¹´1æœˆ5æ—¥ 15æ—¶:50åˆ†:50ç§’ï¼Œç¥ä½ ç”Ÿæ´»æ„‰å¿«ï¼ ä»ç†è®ºä¸Šæ¥çœ‹ï¼Œå¦‚æœèƒ½å¤Ÿç†Ÿç»ƒä½¿ç”¨ä¸Šé¢åˆ†æè¿‡çš„è§„åˆ™ï¼Œé‚£ä¹ˆå¯ä»¥æ ¼å¼åŒ–æˆ–è€…åå‘è§£æä»»æ„æ ¼å¼çš„æ—¥æœŸæ—¶é—´æˆ–è€…å­—ç¬¦ä¸²ã€‚ DateTimeFormatter java.time.format.DateTimeFormatteråœ¨è®¾è®¡ä¸Šæ˜¯ä¸€ä¸ªä¸å¯å˜ç±»ï¼Œä¹Ÿå°±æ˜¯å®ƒæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼ŒDateTimeFormatterçš„é™æ€æ–¹æ³•å’Œå®ä¾‹æ–¹æ³•åªè¦è¿”å›DateTimeFormatterç±»å‹ï¼Œé‚£ä¹ˆå¿…å®šæ˜¯ä¸€ä¸ªæ–°çš„å®ä¾‹ã€‚å®ƒä¸»è¦èŒè´£æ˜¯æ ¼å¼åŒ–æ—¥æœŸæ—¶é—´ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ„é€ DateTimeFormatterå®ä¾‹å¯ä»¥ä½¿ç”¨å®ƒæä¾›çš„é™æ€å·¥å‚æ–¹æ³•ï¼Œè¿™äº›é™æ€æ–¹æ³•å¦‚æœä¸èƒ½æ»¡è¶³éœ€æ±‚ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨DateTimeFormatterBuilderå®šåˆ¶åŒ–å»ºé€ DateTimeFormatterå®ä¾‹ã€‚å¸¸ç”¨çš„2ä¸ªé™æ€å·¥å‚æ–¹æ³•æ˜¯ï¼š 12public static DateTimeFormatter ofPattern(String pattern)public static DateTimeFormatter ofPattern(String pattern, Locale locale) å­—ç¬¦ä¸²patternåŸºæœ¬å¯ä»¥å¡«å†™ä»»æ„åˆæ³•çš„æ—¥æœŸæ—¶é—´æ ¼å¼ï¼Œå› ä¸ºåº•å±‚ä½¿ç”¨DateTimeFormatterBuilder#appendPattern()è¿›è¡Œè§£æï¼Œä¾‹å¦‚ï¼š 123DateTimeFormatter.ofPattern(\"yyyy-MM-dd\")DateTimeFormatter.ofPattern(\"yyyy-MM-dd HH:mm:ss\")DateTimeFormatter.ofPattern(\"yyyyå¹´MMæœˆddæ—¥ HHæ—¶mmåˆ†ssç§’\") è‡³äºæ—¥æœŸæ—¶é—´å®ä¾‹çš„æ ¼å¼åŒ–ï¼Œä¸»è¦é€šè¿‡ä¸‹é¢çš„ä¸¤ä¸ªæ–¹æ³•ï¼š 12public String format(TemporalAccessor temporal)public void formatTo(TemporalAccessor temporal, Appendable appendable) ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼š 123456789101112131415public class DateTimeFormatterMain &#123; public static void main(String[] args) throws Exception &#123; DateTimeFormatter formatter = DateTimeFormatter.ofPattern(\"yyyyå¹´MMæœˆddæ—¥ HHæ—¶mmåˆ†ssç§’\"); LocalDateTime localDateTime = LocalDateTime.now(); String value = formatter.format(localDateTime); StringBuilder builder = new StringBuilder(); formatter.formatTo(localDateTime, builder); System.out.println(value); System.out.println(builder.toString()); &#125;&#125;// æŸä¸ªæ—¶åˆ»çš„è¾“å‡º2019å¹´01æœˆ05æ—¥ 16æ—¶28åˆ†01ç§’2019å¹´01æœˆ05æ—¥ 16æ—¶28åˆ†01ç§’ å­—ç¬¦ä¸²åè§£æä¸ºæ—¥æœŸæ—¶é—´ç±»å‹çš„(parse)æ–¹æ³•å¹¶ä¸å­˜åœ¨äºDateTimeFormatterç±»ä¸­ï¼Œparseæ–¹æ³•å­˜åœ¨äºæ—¥æœŸæ—¶é—´ç±»è‡ªèº«ä¹‹ä¸­ï¼Œè¿™æ ·çš„è®¾è®¡æ‰æ˜¯åˆç†çš„ï¼Œæ€æƒ³å’Œé¢†åŸŸé©±åŠ¨çš„æ–¹å‘æ˜¯ä¸€è‡´çš„ï¼Œè¿™é‡Œç”¨LocalDateTimeä¸ºä¾‹ï¼š 1234// ä½¿ç”¨DateTimeFormatter.ISO_LOCAL_DATE_TIMEè¿›è¡Œè§£æpublic static LocalDateTime parse(CharSequence text)// ä½¿ç”¨ä¼ å…¥çš„è‡ªå®šä¹‰DateTimeFormatterè¿›è¡Œè§£æpublic static LocalDateTime parse(CharSequence text, DateTimeFormatter formatter) ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼š 1234567891011public class DateTimeFormatterMain &#123; public static void main(String[] args) throws Exception &#123; DateTimeFormatter formatter = DateTimeFormatter.ofPattern(\"yyyyå¹´MMæœˆddæ—¥ HHæ—¶mmåˆ†ssç§’\"); String dateTime = \"2019å¹´01æœˆ05æ—¥ 16æ—¶28åˆ†01ç§’\"; LocalDateTime parseResult = LocalDateTime.parse(dateTime, formatter); System.out.println(parseResult); &#125;&#125;// æŸä¸ªæ—¶åˆ»çš„è¾“å‡º2019-01-05T16:28:01 ç”±äºDateTimeFormatterå®ä¾‹åˆ›å»ºçš„æ—¶å€™ç›¸å¯¹è€—æ—¶ï¼Œå› æ­¤éœ€è¦è€ƒè™‘é¿å…å¤šæ¬¡åˆ›å»ºDateTimeFormatterå®ä¾‹ï¼Œå¯ä»¥è€ƒè™‘ç¼–å†™ä¸€ä¸ªå·¥å…·ç±»ï¼Œç”¨å“ˆå¸Œè¡¨ç¼“å­˜pattern -&gt; DateTimeFormatterï¼š 12345678910111213141516171819202122232425262728// è¿™é‡Œåªåˆ—ä¸¾LocalDateTimeå’ŒLocalDateçš„ä¾‹å­ï¼Œå…¶ä»–çš„æ—¥æœŸæ—¶é—´ç±»å¯ä»¥ä»¥æ­¤ç±»æ¨public enum DateTimeFormatUtils &#123; // å•ä¾‹ SINGLETON; private static final ConcurrentMap&lt;String, DateTimeFormatter&gt; FORMATTERS = new ConcurrentHashMap&lt;&gt;(); public String formatLocalDateTime(LocalDateTime value, String pattern) &#123; return getOrCreateDateTimeFormatter(pattern).format(value); &#125; public LocalDateTime parseLocalDateTime(String value, String pattern) &#123; return LocalDateTime.parse(value, getOrCreateDateTimeFormatter(pattern)); &#125; public String formatLocalDate(LocalDate value, String pattern) &#123; return getOrCreateDateTimeFormatter(pattern).format(value); &#125; public LocalDate parseLocalDate(String value, String pattern) &#123; return LocalDate.parse(value, getOrCreateDateTimeFormatter(pattern)); &#125; private DateTimeFormatter getOrCreateDateTimeFormatter(String pattern) &#123; return FORMATTERS.computeIfAbsent(pattern, DateTimeFormatter::ofPattern); &#125;&#125; æœ€åè¿˜è¦æ³¨æ„ä¸€ç‚¹ï¼šæ ¼å¼åŒ–æˆ–è€…è§£æçš„æ—¶å€™ä½¿ç”¨çš„æ¨¡å¼patternå¿…é¡»æ˜¯åˆæ³•æ—¥æœŸæ—¶é—´è¡¨ç¤ºæ ¼å¼(ä¾‹å¦‚å¹´ä»½ç”¨yyyyè¡¨ç¤º)ï¼Œå¹¶ä¸”ä¸¥æ ¼åŒºåˆ†æ—¥æœŸæ—¶é—´ã€åªæœ‰æ—¥æœŸå±æ€§å’Œåªæœ‰æ—¶é—´å±æ€§ä¸‰ç§ä¸åŒçš„æƒ…å†µï¼Œå¦‚æœä½¿ç”¨yyyy-MM-dd HH:mm:ssæ¨¡å¼åˆ›å»ºçš„DateTimeFormatterå»æ ¼å¼åŒ–LocalTimeæˆ–è€…LocalDateï¼Œä¼šæŠ›å‡ºå¼‚å¸¸ï¼Œå¼‚å¸¸çš„ç±»å‹æ˜¯DateTimeExceptionæˆ–è€…å…¶å­ç±»ï¼Œå±äºè¿è¡Œæ—¶å¼‚å¸¸ã€‚ å°ç»“ åœ¨JavaEEå¼€å‘ä¸­ï¼Œç‰¹åˆ«åœ¨ç³»ç»Ÿäº¤äº’ä¸­ï¼Œæ—¥æœŸæ—¶é—´å­—æ®µçš„è½¬æ¢æ˜¯æ¯”è¾ƒé‡è¦çš„ã€‚å…¶å®JSR-310ä¸­çš„æ—¥æœŸæ—¶é—´APIçš„æ ¼å¼åŒ–å’Œè§£æå’Œæ—§æœ‰çš„æ—¥æœŸæ—¶é—´APIçš„æ ¼å¼åŒ–å’Œè§£æä»æœ¬è´¨ä¸Šæ˜¯æ²¡æœ‰åŒºåˆ«çš„ï¼Œéƒ½æ˜¯å­—ç¬¦ä¸²è§£æå’Œè½¬æ¢çš„æ¸¸æˆï¼Œä½†æ˜¯ä¸ªäººæ˜¯æ¨èä½¿ç”¨JSR-310ä¸­çš„æ—¥æœŸæ—¶é—´APIçš„æ ¼å¼åŒ–å’Œè§£æï¼ŒåŸå› æ˜¯ï¼š æ€§èƒ½ä¸Šæœ‰å¾ˆå¤§æå‡(ç›´è§‚ä¸Šæ¨æµ‹ï¼Œæ²¡æœ‰åšä¸¥æ ¼æµ‹è¯•)ã€‚ ç±»åº“è®¾è®¡ä¸Šæ›´åŠ åˆç†ã€‚ çº¿ç¨‹å®‰å…¨ã€‚ (æœ¬æ–‡å®Œ e-a-2019-1-5 c-2-d)","categories":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/tags/Java/"},{"name":"JSR-310","slug":"JSR-310","permalink":"http://throwable.club/blog/tags/JSR-310/"}]},{"title":"JSR310æ–°æ—¥æœŸAPI(äºŒ)-æ—¥æœŸæ—¶é—´API","slug":"java-jsr310-time-api","date":"2019-01-01T14:03:36.000Z","updated":"2019-01-01T14:04:22.587Z","comments":true,"path":"2019/01/01/java-jsr310-time-api/","link":"","permalink":"http://throwable.club/2019/01/01/java-jsr310-time-api/","excerpt":"","text":"JSR310æ–°æ—¥æœŸAPI(äºŒ)-æ—¥æœŸæ—¶é—´API å‰æ è¿™ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»ä¸€ä¸‹æ—¥æœŸæ—¶é—´APIä¸­æœ€å¸¸ç”¨çš„ç±»åº“ï¼Œåˆ†åˆ«æ˜¯ï¼š java.time.Clockï¼šæ—¶é’Ÿã€‚ java.time.Instantï¼šç¬æ—¶æ—¶é—´ï¼Œæ—¶é—´æˆ³java.sql.Timestampçš„æ›¿ä»£ç±»ã€‚ java.time.LocalDateï¼šæœ¬åœ°æ—¥æœŸï¼ŒISO-8601æ—¥å†ç³»ç»Ÿä¸‹çš„æ—¥æœŸè¡¨ç¤ºï¼Œä¸åŒ…å«æ—¶åŒºçš„æ¦‚å¿µï¼Œåªèƒ½è¡¨ç¤ºå¹´æœˆæ—¥ã€‚ java.time.LocalDateTimeï¼šæœ¬åœ°æ—¥æœŸæ—¶é—´ï¼ŒISO-8601æ—¥å†ç³»ç»Ÿä¸‹çš„æ—¥æœŸæ—¶é—´è¡¨ç¤ºï¼Œä¸åŒ…å«æ—¶åŒºçš„æ¦‚å¿µï¼Œåªèƒ½è¡¨ç¤ºå¹´æœˆæ—¥æ—¶åˆ†ç§’ã€‚ java.time.LocalTimeï¼šæœ¬åœ°æ—¶é—´ï¼ŒISO-8601æ—¥å†ç³»ç»Ÿä¸‹çš„æ—¶é—´è¡¨ç¤ºï¼Œä¸åŒ…å«æ—¶åŒºçš„æ¦‚å¿µï¼Œåªèƒ½è¡¨ç¤ºæ—¶åˆ†ç§’ã€‚ java.time.OffsetTimeï¼šå¸¦æœ‰æ—¶é—´åç§»é‡çš„æ—¶é—´ï¼ŒISO-8601æ—¥å†ç³»ç»Ÿä¸‹çš„å¸¦æœ‰UTC/GMTæ—¶é—´åç§»é‡çš„æ—¶é—´è¡¨ç¤ºã€‚ java.time.OffsetDateTimeï¼šå¸¦æœ‰æ—¶é—´åç§»é‡çš„æ—¥æœŸæ—¶é—´ï¼ŒISO-8601æ—¥å†ç³»ç»Ÿä¸‹çš„å¸¦æœ‰UTC/GMTæ—¶é—´åç§»é‡(ä¸åŒ…å«åŸºäºZoneRegionçš„æ—¶é—´åç§»é‡)çš„æ—¥æœŸæ—¶é—´è¡¨ç¤ºã€‚ java.time.ZonedDateTimeï¼šå¸¦æœ‰æ—¶é—´åç§»é‡çš„æ—¥æœŸæ—¶é—´ï¼ŒISO-8601æ—¥å†ç³»ç»Ÿä¸‹çš„å¸¦æœ‰UTC/GMTæ—¶é—´åç§»é‡(åŒ…å«åŸºäºZoneRegionçš„æ—¶é—´åç§»é‡)çš„æ—¥æœŸæ—¶é—´è¡¨ç¤ºã€‚ å…¶ä»–çš„ç±»åº“è¿˜æœ‰Yearã€Monthã€DayOfWeekã€MonthDayã€YearMonthç­‰ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼šJSR-310å¢åŠ çš„æ—¥æœŸAPIæ˜¯ä¸¥æ ¼åŒºåˆ†å¹´æœˆæ—¥-æ—¶åˆ†ç§’æ ¼å¼çš„æ—¥æœŸè¡¨ç¤ºç±»ï¼Œä¾‹å¦‚XXXDateTimeä¸€å®šè¡¨ç¤ºä¸ºå¹´æœˆæ—¥æ—¶åˆ†ç§’ï¼ŒXXXTimeåªèƒ½è¡¨ç¤ºæ—¶åˆ†ç§’ï¼ŒXXXDateåªèƒ½è¡¨ç¤ºå¹´æœˆæ—¥ã€‚ å€¼å¾—æ³¨æ„çš„æ˜¯ï¼šè¿™äº›æ–°å¢çš„æ—¥æœŸæ—¶é—´ç±»éƒ½æ˜¯ä¸å¯å˜ç±»ï¼Œæ¯æ¬¡é€šè¿‡å…¶æ–¹æ³•æ›´å˜æˆ–è€…ä¿®æ”¹éƒ½æ˜¯è¿”å›ä¸€ä¸ªå…¨æ–°çš„å¯¹è±¡ï¼Œå› æ­¤å®ƒä»¬éƒ½æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚ Clock java.time.Clockæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå®ƒè¡¨ç¤ºæ—¶é’Ÿï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå®ƒéœ€è¦ç»“åˆæ—¶åŒºä½¿ç”¨ï¼Œæä¾›è·å–å½“å‰æ—¶åˆ»çš„åŠŸèƒ½ã€‚Clockä¸»è¦æä¾›ä¸‹é¢å››ä¸ªæ–¹æ³•ï¼Œå…¶ä»–æ–¹æ³•éƒ½æ˜¯é™æ€å·¥å‚æ–¹æ³•ï¼š 1234567891011// è·å–ç”¨äºåˆ›å»ºæ—¶é’Ÿçš„æ—¶åŒºã€‚public abstract ZoneId getZone()// è·å–æ—¶é’Ÿçš„å½“å‰ç¬æ—¶å¯¹è±¡ã€‚public abstract Instant instant()// è·å–æ—¶é’Ÿçš„å½“å‰æ¯«ç§’æ•°å€¼public long millis()// è¿”å›å½“å‰æ—¶é’Ÿå®ä¾‹çš„ä¸€ä¸ªæ–°çš„æ‹·è´æ—¶é’Ÿå®ä¾‹ï¼Œå¹¶ä¸”ä½¿ç”¨å…¥å‚ä½œä¸ºæ–°æ—¶é’Ÿå®ä¾‹çš„æ—¶åŒºpublic abstract Clock withZone(ZoneId zone) é™æ€å·¥å‚æ–¹æ³•å¦‚ä¸‹ï¼š æ–¹æ³• åŠŸèƒ½ public static Clock systemUTC() è·å–å¯ä»¥è¿”å›å½“å‰æ—¶åˆ»çš„ç³»ç»Ÿæ—¶é’Ÿï¼Œä½¿ç”¨UTC(é›¶)æ—¶åŒºè¿›è¡Œè¿›è¡Œæ—¶é—´è½¬æ¢[SystemClock] public static Clock systemDefaultZone() è·å–å¯ä»¥è¿”å›å½“å‰æ—¶åˆ»çš„ç³»ç»Ÿæ—¶é’Ÿï¼Œä½¿ç”¨é»˜è®¤æ—¶åŒºè¿›è¡Œæ—¶é—´è½¬æ¢[SystemClock] public static Clock system(ZoneId zone) è·å–å¯ä»¥è¿”å›å½“å‰æ—¶åˆ»çš„ç³»ç»Ÿæ—¶é’Ÿï¼Œä½¿ç”¨æŒ‡å®šæ—¶åŒºIDè¿›è¡Œæ—¶é—´è½¬æ¢[SystemClock] public static Clock tickMillis(ZoneId zone) è·å–ä»¥æ•´æ•°æ¯«ç§’è¿”å›å½“å‰æ—¶åˆ»çš„æ—¶é’Ÿï¼Œä½¿ç”¨æŒ‡å®šæ—¶åŒºIDè¿›è¡Œæ—¶é—´è½¬æ¢[TickClock] public static Clock tickSeconds(ZoneId zone) è·å–ä»¥æ•´æ•°ç§’è¿”å›å½“å‰æ—¶åˆ»çš„æ—¶é’Ÿï¼Œä½¿ç”¨æŒ‡å®šæ—¶åŒºIDè¿›è¡Œæ—¶é—´è½¬æ¢[TickClock] public static Clock tickMinutes(ZoneId zone) è·å–ä»¥æ•´æ•°åˆ†é’Ÿè¿”å›å½“å‰æ—¶åˆ»çš„æ—¶é’Ÿï¼Œä½¿ç”¨æŒ‡å®šæ—¶åŒºIDè¿›è¡Œæ—¶é—´è½¬æ¢[TickClock] public static Clock tick(Clock baseClock, Duration tickDuration) è¿”å›ä¸€ä¸ªä»¥åŸºç¡€æ—¶é’Ÿå’Œæ—¶é’Ÿè®°å½•åŸºç¡€å•ä½ä¸ºæ„é€ çš„æ—¶é’Ÿ[TickClock] public static Clock fixed(Instant fixedInstant, ZoneId zone) è·å¾—ä¸€ä¸ªå§‹ç»ˆè¿”å›åŒä¸€æ—¶åˆ»çš„æ—¶é’Ÿï¼Œä½¿ç”¨æŒ‡å®šæ—¶åŒºIDè¿›è¡Œæ—¶é—´è½¬æ¢[FixedClock] offsetâ€‹(Clock baseClock, Duration offsetDuration) è¿”å›ä¸€ä¸ªä»¥åŸºç¡€æ—¶é’Ÿå’Œå›ºå®šæ—¶é—´åç§»é‡ä¸ºæ„é€ çš„æ—¶é’Ÿ[OffsetClock] java.time.Clockä¸»è¦æœ‰å››ä¸ªå®ç°ï¼Œå®ƒä»¬éƒ½æ˜¯java.time.Clockçš„å†…éƒ¨ç±»ï¼Œä¸Šé¢çš„å·¥å‚æ–¹æ³•åˆ›å»ºçš„å®ä¾‹ä¸€å®šæ˜¯è¿™å››ä¸ªå®ç°ä¹‹ä¸€ï¼š SystemClockï¼šæ€»æ˜¯åŸºäºSystem#currentTimeMillis()è¿”å›æœ€æ–°çš„æ—¶é—´SystemClock.UTCæ˜¯å…¸å‹çš„å®ç°ã€‚ FixedClockï¼šæ€»æ˜¯è¿”å›ç›¸åŒçš„ç¬æ—¶æ—¶é—´ï¼Œå¯ä»¥è®¤ä¸ºæ˜¯ä¸€ä¸ªå›ºå®šæ—¶åˆ»çš„æ—¶é’Ÿï¼Œé€šå¸¸ä½¿ç”¨äºæµ‹è¯•ã€‚ OffsetClockï¼šåŸºäºä¸€ä¸ªç¡®å®šçš„Clockå®ç°ï¼Œä¸ºå®ƒæ·»åŠ ä¸€ä¸ªæ—¶é—´åç§»é‡ï¼Œæ—¶é—´åç§»é‡çš„å•ä½æ˜¯Durationã€‚ TickClockï¼šåŸºäºä¸€ä¸ªç¡®å®šçš„Clockå®ç°ï¼Œä¸ºå®ƒæ·»åŠ ä¸€ä¸ªæ—¶é—´åç§»é‡ï¼Œæ—¶é—´åç§»é‡çš„å•ä½æ˜¯çº³ç§’ã€‚ ä¸Šé¢æ¯”è¾ƒéš¾ç†è§£çš„æ˜¯TickClockï¼Œè¿™é‡Œä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼š 12345678910111213public class TickClockMain &#123; public static void main(String[] args) throws Exception&#123; Clock tickMillis = Clock.tickMillis(ZoneId.systemDefault()); Clock tickSeconds = Clock.tickSeconds(ZoneId.systemDefault()); System.out.println(tickMillis.millis()); System.out.println(tickSeconds.millis()); &#125;&#125;//è¾“å‡ºç»“æœ15460109455751546010945000 ç®€å•æ¥è¯´ï¼ŒClock#tickMillis()æ„é€ çš„æ—¶é’Ÿçš„è®¡æ—¶å•ä½æ˜¯æ¯«ç§’ï¼Œè€ŒClock#tickSeconds()æ„é€ çš„æ—¶é’Ÿçš„è®¡æ—¶å•ä½æ˜¯ç§’(æ¯«ç§’éƒ¨åˆ†ä¼šè¢«æˆªæ–­)ï¼Œä»¥æ­¤ç±»æ¨ã€‚ FixedClockæ˜¯ä¸€ä¸ªå›ºå®šæ—¶åˆ»çš„æ—¶é’Ÿï¼Œä¸€èˆ¬ç”¨äºæµ‹è¯•ï¼š 1234567891011121314public class FixedClockMain &#123; public static void main(String[] args) throws Exception &#123; Clock fixed = Clock.fixed(Instant.now(), ZoneId.systemDefault()); System.out.println(fixed.millis()); System.out.println(fixed.millis()); System.out.println(fixed.millis()); &#125;&#125;//è¾“å‡ºç»“æœ154601149259015460114925901546011492590 æœ€å¸¸ç”¨çš„æ˜¯é»˜è®¤ZoneIdä¸‹çš„ç³»ç»Ÿæ—¶é’ŸSystemClockå’ŒUTCç³»ç»Ÿæ—¶é’Ÿï¼š 123456789101112131415public class SystemClockMain &#123; public static void main(String[] args) throws Exception &#123; Clock clock = Clock.systemDefaultZone(); System.out.println(clock.millis()); Clock utc = Clock.systemUTC(); System.out.println(utc.millis()); System.out.println(System.currentTimeMillis()); &#125;&#125;//æŸä¸ªæ—¶åˆ»çš„è¾“å‡ºç»“æœ154601168641315460116864131546011686413 Instant java.time.Instantå­—é¢æ„æ€æ˜¯ç¬æ—¶æ—¶é—´ï¼Œå®ƒæ˜¯java.sql.Timestampçš„å¯¹åº”ç±»ï¼Œä»£è¡¨æ—¶é—´çº¿(time-line)ä¸Šçš„ä¸€ä¸ªç¬æ—¶æ—¶é—´ç‚¹ï¼Œå‡†ç¡®æ¥è¯´ï¼Œå®ƒå†…éƒ¨æŒæœ‰ä¸€ä¸ªlongç±»å‹çš„çºªå…ƒç§’å±æ€§(seconds)å’Œä¸€ä¸ªintç±»å‹çš„çº³ç§’å±æ€§(nanosï¼Œnanosçš„å–å€¼èŒƒå›´æ˜¯[0,999_999_999])ï¼Œçºªå…ƒç§’å¦‚æœä¸ºæ­£æ•°ï¼Œè¡¨ç¤ºè¯¥ç¬æ—¶æ—¶é—´ç‚¹ä½äºæ ¼æ—å¨æ²»æ–°çºªå…ƒ1970-01-01T00:00:00Zä¹‹åï¼Œè€Œçºªå…ƒç§’å¦‚æœä¸ºè´Ÿæ•°ï¼Œåˆ™è¡¨ç¤ºè¯¥ç¬æ—¶æ—¶é—´ç‚¹ä½äºæ ¼æ—å¨æ²»æ–°çºªå…ƒä¹‹å‰ã€‚å› æ­¤Instantèƒ½è¡¨ç¤ºçš„æ—¶é—´ç‚¹å…¶å®æ˜¯æœ‰ä¸Šä¸‹ç•Œçš„ï¼Œé€»è¾‘ä¸Šçš„ç•Œé™å°±æ˜¯1970-01-01T00:00:00Z - 31557014167219200ç§’åˆ°1970-01-01T00:00:00Z + 31556889864403199ç§’ + 999_999_999çº³ç§’æˆ–è€…è¡¨ç¤ºä¸ºInstant#MINåˆ°Instant#MAXï¼Œè¿™ä¸ªèŒƒå›´å¾ˆå¤§ï¼Œå› æ­¤æš‚æ—¶ä¸éœ€è¦è€ƒè™‘è¶…é™çš„é—®é¢˜ã€‚Instantä¸­å·²ç»æä¾›äº†ä¸€ä¸ªå…¬æœ‰é™æ€å®ä¾‹ç”¨äºè¡¨ç¤ºæ ¼æ—å¨æ²»æ–°çºªå…ƒï¼Œå®ƒå°±æ˜¯Instant#EPOCHï¼Œä»£è¡¨1970-01-01T00:00:00Zè¿™ä¸ªç¬æ—¶æ—¶é—´ç‚¹ã€‚å…ˆçœ‹ä¸€ä¸‹Instantçš„å¸¸ç”¨é™æ€å·¥å‚æ–¹æ³•(Instantæ²¡æœ‰å…¬æœ‰æ„é€ å™¨ï¼Œå¿…é¡»é€šè¿‡å·¥å‚æ–¹æ³•æ„é€ å®ä¾‹)ï¼š 1234567891011121314151617181920// å½“å‰æ—¶åˆ»çš„ç¬æ—¶æ—¶é—´ç‚¹public static Instant now()// åŸºäºæ—¶é’Ÿå®ä¾‹è·å–ç¬æ—¶æ—¶é—´ç‚¹public static Instant now(Clock clock)// åŸºäºè·ç¦»æ–°çºªå…ƒçš„ç§’æ•°åˆ›å»ºç¬æ—¶æ—¶é—´ç‚¹public static Instant ofEpochSecond(long epochSecond)// åŸºäºè·ç¦»æ–°çºªå…ƒçš„ç§’æ•°å’Œçº³ç§’åˆ›å»ºç¬æ—¶æ—¶é—´ç‚¹public static Instant ofEpochSecond(long epochSecond, long nanoAdjustment)// åŸºäºæ¯«ç§’æ•°åˆ›å»ºç¬æ—¶æ—¶é—´ç‚¹public static Instant ofEpochMilli(long epochMilli)// åŸºäºå…¶ä»–æ—¥æœŸæ—¶é—´APIåˆ›å»ºç¬æ—¶æ—¶é—´ç‚¹public static Instant from(TemporalAccessor temporal)// åŸºäºç‰¹å®šæ ¼å¼å­—ç¬¦ä¸²åˆ›å»ºç¬æ—¶æ—¶é—´ç‚¹ï¼Œå¦‚2007-12-03T10:15:30.00Zpublic static Instant parse(final CharSequence text) å½“ç„¶è¿˜æœ‰å…¶ä»–å¸¸ç”¨çš„æ–¹æ³•ï¼š 1234567891011121314151617181920212223242526// è·å–å½“å‰Instantå®ä¾‹å¯¹äºä¸åŒè®¡æ—¶å•ä½çš„å€¼ï¼Œè§ChronoFieldpublic long getLong(TemporalField field)// è·å–å½“å‰Instantå®ä¾‹çš„çºªå…ƒç§’å±æ€§public long getEpochSecond()// è·å–å½“å‰Instantå®ä¾‹çš„çº³ç§’å±æ€§public int getNano()// è·å–å½“å‰Instantå®ä¾‹çš„æ¯«ç§’å€¼public long toEpochMilli() // åŸºäºTemporalFieldå®ä¾‹(TemporalField)å’Œæ–°çš„å€¼è°ƒæ•´å¹¶ä¸”åˆ›å»ºä¸€ä¸ªæ–°çš„Instantpublic Instant with(TemporalField field, long newValue)// å½“å‰Instantå®ä¾‹åŸºäºTemporalUnit(ChronoUnit)æˆªæ–­å¹¶ä¸”è¿”å›ä¸€ä¸ªæ–°çš„Instantpublic Instant truncatedTo(TemporalUnit unit)// é¡¾åæ€ä¹‰ï¼ŒåŸºäºä¸€ä¸ªæ—¶é—´åŸºå‡†å•ä½è¿›è¡Œæ—¶é—´é‡å¢åŠ ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„Instantpublic Instant plus(long amountToAdd, TemporalUnit unit)// é¡¾åæ€ä¹‰ï¼ŒåŸºäºä¸€ä¸ªæ—¶é—´åŸºå‡†å•ä½è¿›è¡Œæ—¶é—´é‡å‡å°‘ï¼Œè¿”å›ä¸€ä¸ªæ–°çš„Instantpublic Instant minus(long amountToSubtract, TemporalUnit unit)// è®¡ç®—å½“å‰Instantå®ä¾‹å’Œå…¥å‚endExclusiveåŸºäºæ—¶é—´åŸºå‡†å•ä½unitä¹‹é—´çš„æ—¶é—´é‡public long until(Temporal endExclusive, TemporalUnit unit) ä¸¾ä¸ªä½¿ç”¨ä¾‹å­ï¼š 123456789101112131415161718192021222324public class InstantMain &#123; public static void main(String[] args) throws Exception &#123; Instant instant = Instant.now(); System.out.println(String.format(\"Second:%d,Nano:%d\", instant.getEpochSecond(), instant.getNano())); instant = Instant.now(Clock.systemDefaultZone()); System.out.println(String.format(\"Second:%d,Nano:%d\", instant.getEpochSecond(), instant.getNano())); instant = Instant.ofEpochSecond(new Date().toInstant().getEpochSecond()); System.out.println(String.format(\"Second:%d,Nano:%d\", instant.getEpochSecond(), instant.getNano())); instant = Instant.ofEpochMilli(System.currentTimeMillis()); System.out.println(String.format(\"Second:%d,Nano:%d\", instant.getEpochSecond(), instant.getNano())); instant = Instant.from(Instant.now()); System.out.println(String.format(\"Second:%d,Nano:%d\", instant.getEpochSecond(), instant.getNano())); instant = Instant.parse(\"2018-12-31T10:15:30.00Z\"); System.out.println(String.format(\"Second:%d,Nano:%d\", instant.getEpochSecond(), instant.getNano())); &#125;&#125;// æŸä¸ªæ—¶åˆ»çš„è¾“å‡ºSecond:1546187685,Nano:261861900Second:1546187685,Nano:291941900Second:1546187685,Nano:0Second:1546187685,Nano:292000000Second:1546187685,Nano:292946400Second:1546251330,Nano:0 LocalDate java.time.LocalDateä»£è¡¨ISO-8601æ—¥å†ç³»ç»Ÿä¸­ä¸åŒ…å«æ—¶åŒºçš„æ—¥æœŸ(å½“ç„¶ä¹Ÿä¸åŒ…å«å…·ä½“çš„æ—¶é—´)è¡¨ç¤ºï¼Œä¾‹å¦‚2007-12-03ã€‚LocalDateæ˜¯ä¸€ä¸ªä¸å¯å˜çš„æ—¥æœŸå¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯åªèƒ½è¡¨ç¤ºæ—¥æœŸï¼Œé€šå¸¸çš„è¡¨ç¤ºæ ¼å¼ä¸ºå¹´-æœˆ-æ—¥ï¼ŒåŒæ—¶æä¾›å…¶ä»–æ—¥æœŸå­—æ®µçš„è®¿é—®ï¼Œä¾‹å¦‚ä¸€å¹´ä¸­çš„ç¬¬å‡ æ—¥(day-of-year)ã€æ˜ŸæœŸå‡ (day-of-week)å’Œä¸€å¹´ä¸­çš„ç¬¬å‡ å‘¨(week-of-year)ç­‰ã€‚ä¸åŒçš„LocalDateä¹‹é—´çš„æ¯”è¾ƒåªèƒ½é€šè¿‡LocalDate#equals()æ–¹æ³•ï¼Œå…¶ä»–æ¯”è¾ƒæ“ä½œå¦‚==æˆ–è€…hash()æ–¹æ³•ä¼šäº§ç”Ÿæ— æ³•é¢„çŸ¥çš„ç»“æœã€‚LocalDateæä¾›çš„å¸¸é‡ï¼š 12345678// -999999999-01-01public static final LocalDate MIN = LocalDate.of(Year.MIN_VALUE, 1, 1)// 999999999-12-31public static final LocalDate MAX = LocalDate.of(Year.MAX_VALUE, 12, 31)// 1970-01-01public static final LocalDate EPOCH = LocalDate.of(1970, 1, 1) LocalDateçš„å·¥å‚æ–¹æ³•æ¯”è¾ƒå¤šï¼Œè¿™é‡Œåªåˆ—ä¸¾éƒ¨åˆ†å¸¸ç”¨çš„ï¼š 1234567891011121314151617181920// åŸºäºå½“å‰æ—¥æœŸè·å–LocalDateå®ä¾‹public static LocalDate now()// åŸºäºå½“å‰æ—¥æœŸå’Œæ—¶åŒºè·å–LocalDateå®ä¾‹public static LocalDate now(ZoneId zone)// åŸºäºå½“å‰æ—¥æœŸå’Œæ—¶é’Ÿè·å–LocalDateå®ä¾‹public static LocalDate now(Clock clock)// åŸºäºå¹´æœˆ(æšä¸¾)æ—¥è·å–LocalDateå®ä¾‹public static LocalDate of(int year, Month month, int dayOfMonth)// åŸºäºå¹´æœˆæ—¥è·å–LocalDateå®ä¾‹public static LocalDate of(int year, int month, int dayOfMonth)// åŸºäºå¹´å’Œå…·ä½“è¯¥å¹´ä¸­çš„æŸä¸€æ—¥è·å–LocalDateå®ä¾‹public static LocalDate ofYearDay(int year, int dayOfYear)// åŸºäºæ–°çºªå…ƒ1970-01-01çš„åç§»å¤©æ•°è·å–LocalDateå®ä¾‹public static LocalDate ofEpochDay(long epochDay) LocalDateçš„å®ä¾‹æ–¹æ³•ä¹Ÿæ¯”è¾ƒå¤šï¼Œè¿™é‡Œä¹Ÿåˆ—ä¸¾éƒ¨åˆ†å¸¸ç”¨çš„ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344// è·å–å¹´ä»½å€¼public int getYear()// è·å–æœˆä»½å€¼ï¼ŒèŒƒå›´æ˜¯1-12public int getMonthValue()// è·å–æœˆä»½æšä¸¾public Month getMonth()// è¿”å›å½“å‰LocalDateå®ä¾‹çš„è¯¥å¹´ä¸­å…·ä½“çš„ç¬¬å‡ å¤©public int getDayOfYear()// è¿”å›å½“å‰LocalDateå®ä¾‹çš„å…·ä½“æ˜¯æ˜ŸæœŸå‡ public DayOfWeek getDayOfWeek()// æ˜¯å¦é—°å¹´public boolean isLeapYear()// è¿”å›å½“å‰LocalDateå®ä¾‹æœˆä»½é•¿åº¦public int lengthOfMonth()// è¿”å›å½“å‰LocalDateå®ä¾‹å¹´ä»½é•¿åº¦public int lengthOfYear()// åŸºäºä¸€ä¸ªæ—¥æœŸå±æ€§ä¿®æ”¹å¯¹åº”çš„å€¼è¿”å›ä¸€ä¸ªæ–°çš„LocalDateå®ä¾‹public LocalDate with(TemporalField field, long newValue)// åŸºäºä¸€ä¸ªæ—¥æœŸæ—¶é—´åŸºå‡†å•ä½å¢åŠ å¯¹åº”çš„å€¼è¿”å›ä¸€ä¸ªæ–°çš„LocalDateå®ä¾‹public LocalDate plus(long amountToAdd, TemporalUnit unit)// åŸºäºä¸€ä¸ªæ—¥æœŸæ—¶é—´åŸºå‡†å•ä½å‡å»å¯¹åº”çš„å€¼è¿”å›ä¸€ä¸ªæ–°çš„LocalDateå®ä¾‹public LocalDate minus(long amountToSubtract, TemporalUnit unit)// åŸºäºä¸€ä¸ªæ—¥æœŸæ—¶é—´åŸºå‡†å•ä½è®¡ç®—ä»¥å…¥å‚ä¸ºendExclusiveè®¡ç®—æ—¥æœŸæˆ–è€…æ—¶é—´çš„é—´éš”public long until(Temporal endExclusive, TemporalUnit unit)// è¿”å›åŸºäºæ–°çºªå…ƒå¹´1970-1-1çš„åç§»å¤©æ•°public long toEpochDay()// å¦‚æœå…¥å‚ä¸ºLocalDateç±»å‹åŠŸèƒ½å’Œequalsä¸€è‡´ï¼Œå¦åˆ™é€šè¿‡åŸºäºçºªå…ƒå¹´çš„åç§»å¤©æ•°æ¯”è¾ƒpublic boolean isEqual(ChronoLocalDate other)// åªæœ‰å¹´æœˆæ—¥ä¸‰ä¸ªæˆå‘˜åŒæ—¶ç›¸ç­‰æ­¤æ–¹æ³•æ‰è¿”å›truepublic boolean equals(Object obj) ä¸¾ä¸ªç®€å•çš„ä½¿ç”¨ä¾‹å­ï¼š 12345678910111213141516171819public class LocalDateMain &#123; public static void main(String[] args) throws Exception &#123; LocalDate localDate = LocalDate.now(); System.out.println(localDate); localDate = LocalDate.of(2018, 12, 31); System.out.println(localDate); localDate = localDate.plus(1, ChronoUnit.DAYS); System.out.println(localDate); System.out.println(localDate.equals(LocalDate.of(2019,1,1))); System.out.println(localDate.toEpochDay()); &#125;&#125;// æŸå¤©æ‰§è¡Œçš„è¾“å‡ºç»“æœ2018-12-312018-12-312019-01-01true17897 LocalTime java.time.LocalTimeä»£è¡¨ISO-8601æ—¥å†ç³»ç»Ÿä¸­ä¸åŒ…å«æ—¶åŒºçš„æ—¶é—´(å½“ç„¶ä¹Ÿä¸åŒ…å«å…·ä½“çš„æ—¥æœŸ)è¡¨ç¤ºï¼Œä¾‹å¦‚10:15:30ã€‚LocalTimeæ˜¯ä¸€ä¸ªä¸å¯å˜çš„æ—¶é—´å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯åªèƒ½è¡¨ç¤ºæ—¶é—´ï¼Œé€šå¸¸çš„è¡¨ç¤ºæ ¼å¼ä¸ºæ—¶:åˆ†:ç§’ï¼Œä¹Ÿå¯ä»¥åŒ…å«ä¸€ä¸ªçº³ç§’å±æ€§(nanoå–å€¼èŒƒå›´[0,999999999])ï¼Œé€šä¿—æ¥è¯´ï¼Œå®ƒè¡¨ç¤ºçš„å°±æ˜¯æŒ‚é’Ÿä¸Šæ‰€è§çš„æ—¶é—´çš„æè¿°ã€‚åŒæ ·ï¼Œä¸åŒçš„LocalTimeå®ä¾‹å¿…é¡»é€šè¿‡LocalTime#equals()æ–¹æ³•æ¯”è¾ƒã€‚LocalTimeæä¾›çš„é™æ€å®ä¾‹å¦‚ä¸‹ï¼š 1234567891011// ä¸€å¤©çš„èµ·å§‹æ—¶é—´ - 00:00public static final LocalTime MIN// ä¸€å¤©çš„ç»“æŸæ—¶é—´ - 23:59:59.999999999public static final LocalTime MAX// åˆå¤œ - 00:00 å…¶å®å’ŒMINæ˜¯ä¸€æ ·çš„public static final LocalTime MIDNIGHT// ä¸­åˆ - 12:00public static final LocalTime NOON LocalTimeå¸¸ç”¨çš„å·¥å‚æ–¹æ³•ï¼š 12345678910111213141516171819202122// åŸºäºå½“å‰æ—¶é—´æ„é€ LocalTimeå®ä¾‹public static LocalTime now()// åŸºäºå½“å‰æ—¶é—´å’Œæ—¶åŒºIDæ„é€ LocalTimeå®ä¾‹public static LocalTime now(ZoneId zone)// åŸºäºå½“å‰æ—¶é—´å’Œæ—¶é’Ÿå®ä¾‹æ„é€ LocalTimeå®ä¾‹public static LocalTime now(Clock clock)// åŸºäºå°æ—¶ã€åˆ†é’Ÿ(ã€ç§’å’Œçº³ç§’)æ„é€ LocalTimeå®ä¾‹public static LocalTime of(int hour, int minute)public static LocalTime of(int hour, int minute, int second)public static LocalTime of(int hour, int minute, int second, int nanoOfSecond)// åŸºäºç¬æ—¶æ—¶é—´å®ä¾‹å’Œæ—¶åŒºIDæ„é€ LocalTimeå®ä¾‹public static LocalTime ofInstant(Instant instant, ZoneId zone)// åŸºäºä¸€å¤©å½“ä¸­çš„å…·ä½“ç§’æ•°æ„é€ LocalTimeå®ä¾‹,secondOfDayèŒƒå›´æ˜¯[0,24 * 60 * 60 - 1]public static LocalTime ofSecondOfDay(long secondOfDay)// åŸºäºä¸€å¤©å½“ä¸­çš„å…·ä½“çº³ç§’æ•°æ„é€ LocalTimeå®ä¾‹,nanoOfDay[0,24 * 60 * 60 * 1,000,000,000 - 1]public static LocalTime ofNanoOfDay(long nanoOfDay) LocalTimeå¸¸ç”¨çš„å®ä¾‹æ–¹æ³•æœ‰å¾ˆå¤šï¼Œå¥—è·¯å’Œä¸Šé¢ç« èŠ‚æåˆ°è¿‡çš„æ–¹æ³•ç±»ä¼¼ï¼Œè¿™é‡Œä¸å•°å—¦åˆ†æï¼š 1234567891011// è¿”å›å°æ—¶å€¼ï¼ŒèŒƒå›´[0,23]public int getHour()// è¿”å›åˆ†é’Ÿå€¼ï¼ŒèŒƒå›´[0,59]public int getMinute()// è¿”å›ç§’æ•°å€¼ï¼ŒèŒƒå›´[0,59]public int getSecond()// è¿”å›çº³ç§’æ•°å€¼ï¼ŒèŒƒå›´[0,999_999_999]public int getNano() ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼š 12345678910111213141516public class LocalTimeMain &#123; public static void main(String[] args) throws Exception &#123; LocalTime localTime = LocalTime.now(); System.out.println(localTime); localTime = LocalTime.of(23, 59); System.out.println(localTime); localTime = LocalTime.MAX; System.out.println(String.format(\"Hour:%d,minute:%d,second:%d,nano:%d\", localTime.getHour(), localTime.getMinute(), localTime.getSecond(), localTime.getNano())); &#125;&#125;// æŸä¸ªæ—¶åˆ»ä¸‹çš„è¾“å‡ºç»“æœ00:46:08.84584880023:59Hour:23,minute:59,second:59,nano:999999999 LocalDateTime java.time.LocalDateTimeå®é™…ä¸Šå°±æ˜¯LocalDateå’ŒLocalTimeçš„ç»“åˆç‰ˆæœ¬ï¼Œä»£è¡¨ISO-8601æ—¥å†ç³»ç»Ÿä¸­ä¸åŒ…å«æ—¶åŒº(LocalDateTimeä¸å­˜å‚¨æ—¶åŒºä¿¡æ¯ï¼Œä½†æ˜¯å¯ä»¥ä½¿ç”¨æ—¶åŒºIDæ„é€ LocalDateTimeå®ä¾‹)çš„æ—¥æœŸæ—¶é—´è¡¨ç¤ºï¼Œä¾‹å¦‚2007-12-03T10:15:30ã€‚LocalDateTimeæ˜¯ä¸€ä¸ªä¸å¯å˜çš„æ—¶é—´å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯åªèƒ½è¡¨ç¤ºæ—¥æœŸæ—¶é—´ï¼Œé€šå¸¸çš„è¡¨ç¤ºæ ¼å¼ä¸ºå¹´-æœˆæ—¥ æ—¶:åˆ†:ç§’ï¼Œä¹Ÿå¯ä»¥åŒ…å«ä¸€ä¸ªçº³ç§’å±æ€§(nanoå–å€¼èŒƒå›´[0,999999999])ã€‚ä¸åŒçš„LocalDateTimeå®ä¾‹å¿…é¡»é€šè¿‡LocalDateTime#equals()æ–¹æ³•æ¯”è¾ƒã€‚LocalDateTimeå†…éƒ¨æŒæœ‰ä¸€ä¸ªLocalDateå®ä¾‹å’Œä¸€ä¸ªLocalTimeå®ä¾‹ã€‚å®ƒå®šä¹‰äº†ä¸¤ä¸ªå…¬æœ‰çš„é™æ€å¸¸é‡ï¼š 12345// LocalDateTimeèƒ½å¤Ÿè¡¨ç¤ºçš„æœ€å°æ—¥æœŸæ—¶é—´ï¼Œå³-999999999-01-01T00:00:00public static final LocalDateTime MIN = LocalDateTime.of(LocalDate.MIN, LocalTime.MIN)// LocalDateTimeèƒ½å¤Ÿè¡¨ç¤ºçš„æœ€å¤§æ—¥æœŸæ—¶é—´ï¼Œå³999999999-12-31T23:59:59.999999999public static final LocalDateTime MAX = LocalDateTime.of(LocalDate.MAX, LocalTime.MAX) LocalDateTimeå¸¸ç”¨çš„é™æ€å·¥å‚æ–¹æ³•å¦‚ä¸‹ï¼š 123456789101112131415161718192021// åŸºäºå½“å‰æ—¥æœŸæ—¶é—´ã€æ—¶åŒºIDã€æ—¶é’Ÿåˆ›å»ºLocalDateTimeå®ä¾‹public static LocalDateTime now()public static LocalDateTime now(ZoneId zone)public static LocalDateTime now(Clock clock)// åŸºäºå¹´æœˆ(æšä¸¾)æ—¥æ—¶åˆ†ç§’çº³ç§’åˆ›å»ºLocalDateTimeå®ä¾‹public static LocalDateTime of(int year, Month month, int dayOfMonth, int hour, int minute)public static LocalDateTime of(int year, Month month, int dayOfMonth, int hour, int minute, int second)public static LocalDateTime of(int year, Month month, int dayOfMonth, int hour, int minute, int second, int nanoOfSecond)public static LocalDateTime of(int year, int month, int dayOfMonth, int hour, int minute)public static LocalDateTime of(int year, int month, int dayOfMonth, int hour, int minute, int second)public static LocalDateTime of(int year, int month, int dayOfMonth, int hour, int minute, int second, int nanoOfSecond)// åŸºäºLocalDateå’ŒLocalTimeå®ä¾‹åˆ›å»ºLocalDateTimeå®ä¾‹public static LocalDateTime of(LocalDate date, LocalTime time)// åŸºäºInstantå®ä¾‹å’Œæ—¶åŒºIDå®ä¾‹åˆ›å»ºLocalDateTimeå®ä¾‹public static LocalDateTime ofInstant(Instant instant, ZoneId zone)// åŸºäºæ–°çºªå…ƒåç§»ç§’æ•°ã€çº³ç§’æ•°å’Œæ—¶é—´åç§»é‡åˆ›å»ºLocalDateTimeå®ä¾‹public static LocalDateTime ofEpochSecond(long epochSecond, int nanoOfSecond, ZoneOffset offset) LocalDateTimeçš„å®ä¾‹æ–¹æ³•å’Œå‰é¢ä»‹ç»è¿‡çš„ç±»å·®ä¸å¤šï¼Œè¿™é‡Œä¸åšè¯¦ç»†å±•å¼€ï¼Œä¸¾ä¸ªç®€å•çš„ä½¿ç”¨ä¾‹å­ï¼š 123456789101112131415public class LocalDateTimeMain &#123; public static void main(String[] args) throws Exception &#123; LocalDateTime localDateTime = LocalDateTime.now(ZoneId.systemDefault()); System.out.println(localDateTime); localDateTime = LocalDateTime.ofInstant(Instant.now(), ZoneId.systemDefault()); System.out.println(localDateTime); localDateTime = localDateTime.plus(1, ChronoUnit.YEARS); System.out.println(localDateTime); &#125;&#125;// æŸä¸ªæ—¶åˆ»çš„è¾“å‡ºå¦‚ä¸‹2019-01-01T17:43:48.2605174002019-01-01T17:43:48.2605174002020-01-01T17:43:48.260517400 OffsetTime java.time.OffsetTimeè¡¨ç¤ºISO-8601æ—¥å†ç³»ç»Ÿä¸­å¸¦æœ‰åŸºäºUTC/Greenwichæ—¶é—´åç§»é‡çš„æ—¶é—´ï¼Œä¾‹å¦‚10:15:30+01:00ã€‚OffsetTimeä¹Ÿæ˜¯ä¸€ä¸ªä¸å¯å˜çš„æ—¶é—´å¯¹è±¡ï¼Œé€šå¸¸è¡¨ç¤ºæ ¼å¼ä¸ºæ—¶:åˆ†:ç§’-æ—¶é—´åç§»é‡ï¼Œå½“ç„¶å®ƒä¹Ÿå¯ä»¥åŒ…å«ä¸€ä¸ªçº³ç§’å±æ€§(nanoå–å€¼èŒƒå›´[0,999999999])ã€‚ç›¸æ¯”LocalTimeï¼Œå®ƒå¤šå­˜å‚¨äº†ä¸€ä¸ªæ—¶åŒºæ—¶é—´åç§»é‡(zone offset)å±æ€§ã€‚OffsetTimeçš„å…¬æœ‰é™æ€å®ä¾‹å¦‚ä¸‹ï¼š 12345// ä»£è¡¨00:00:00+18:00public static final OffsetTime MIN = LocalTime.MIN.atOffset(ZoneOffset.MAX)// ä»£è¡¨23:59:59.999999999-18:00public static final OffsetTime MAX = LocalTime.MAX.atOffset(ZoneOffset.MIN) OffsetTimeçš„å¸¸ç”¨å·¥å‚æ–¹æ³•å¦‚ä¸‹ï¼š 12345678910111213// åŸºäºå½“å‰æ—¶é—´ã€æ—¶åŒºIDã€æ—¶é’Ÿåˆ›å»ºOffsetTimeå®ä¾‹public static OffsetTime now()public static OffsetTime now(ZoneId zone)public static OffsetTime now(Clock clock)// åŸºäºLocalTimeå®ä¾‹å’Œæ—¶é—´åç§»é‡åˆ›å»ºOffsetTimeå®ä¾‹public static OffsetTime of(LocalTime time, ZoneOffset offset)// åŸºäºæ—¶åˆ†ç§’çº³ç§’å’Œæ—¶é—´åç§»é‡åˆ›å»ºOffsetTimeå®ä¾‹public static OffsetTime of(int hour, int minute, int second, int nanoOfSecond, ZoneOffset offset)// åŸºäºInstantå®ä¾‹å’Œæ—¶åŒºIDå®ä¾‹åˆ›å»ºOffsetTimeå®ä¾‹public static OffsetTime ofInstant(Instant instant, ZoneId zone) ä¸¾ä¸ªç®€å•çš„ä½¿ç”¨ä¾‹å­ï¼š 123456789101112131415public class OffsetTimeMain &#123; public static void main(String[] args) throws Exception &#123; OffsetTime offsetTime = OffsetTime.now(); System.out.println(offsetTime); offsetTime = OffsetTime.ofInstant(Instant.now(), ZoneId.systemDefault()); System.out.println(offsetTime); offsetTime = OffsetTime.of(LocalTime.now(), ZoneOffset.UTC); System.out.println(offsetTime); &#125;&#125;//æŸä¸ªæ—¶åˆ»ä¸‹çš„è¾“å‡ºç»“æœå¦‚ä¸‹18:08:26.263710800+08:0018:08:26.264713600+08:0018:08:26.264713600Z OffsetDateTime java.time.OffsetDateTimeè¡¨ç¤ºISO-8601æ—¥å†ç³»ç»Ÿä¸­å¸¦æœ‰åŸºäºUTC/Greenwichæ—¶é—´åç§»é‡çš„æ—¥æœŸæ—¶é—´ï¼Œä¾‹å¦‚2007-12-03T10:15:30+01:00ã€‚OffsetDateTimeä¹Ÿæ˜¯ä¸€ä¸ªä¸å¯å˜çš„æ—¥æœŸæ—¶é—´å¯¹è±¡ï¼Œé€šå¸¸è¡¨ç¤ºæ ¼å¼ä¸ºå¹´-æœˆ-æ—¥ æ—¶:åˆ†:ç§’-æ—¶é—´åç§»é‡ï¼Œå½“ç„¶å®ƒä¹Ÿå¯ä»¥åŒ…å«ä¸€ä¸ªçº³ç§’å±æ€§(nanoå–å€¼èŒƒå›´[0,999999999])ã€‚ç›¸æ¯”LocalDateTimeï¼Œå®ƒå¤šå­˜å‚¨äº†ä¸€ä¸ªæ—¶åŒºæ—¶é—´åç§»é‡(zone offset)å±æ€§ã€‚OffsetDateTimeæä¾›çš„å…¬æœ‰é™æ€å®ä¾‹å¸¸é‡å¦‚ä¸‹ï¼š 12345// OffsetDateTimeèƒ½è¡¨ç¤ºçš„æœ€å°çš„æ—¥æœŸæ—¶é—´-999999999-01-01T00:00:00+18:00public static final OffsetDateTime MIN = LocalDateTime.MIN.atOffset(ZoneOffset.MAX)// OffsetDateTimeèƒ½è¡¨ç¤ºçš„æœ€å¤§çš„æ—¥æœŸæ—¶é—´999999999-12-31T23:59:59.999999999-18:00public static final OffsetDateTime MAX = LocalDateTime.MAX.atOffset(ZoneOffset.MIN) OffsetDateTimeçš„å¸¸ç”¨é™æ€å·¥å‚æ–¹æ³•å¦‚ä¸‹ï¼š 123456789101112131415161718// åŸºäºå½“å‰çš„æ—¥æœŸæ—¶é—´ã€æ—¶åŒºIDã€æ—¶é’Ÿåˆ›å»ºOffsetDateTimeå®ä¾‹public static OffsetDateTime now()public static OffsetDateTime now(ZoneId zone)public static OffsetDateTime now(Clock clock)// åŸºäºLocalDateå®ä¾‹ã€LocalTimeå®ä¾‹å’Œæ—¶é—´åç§»é‡åˆ›å»ºOffsetDateTimeå®ä¾‹public static OffsetDateTime of(LocalDate date, LocalTime time, ZoneOffset offset)// åŸºäºLocalDateTimeå®ä¾‹å’Œæ—¶é—´åç§»é‡åˆ›å»ºOffsetDateTimeå®ä¾‹public static OffsetDateTime of(LocalDateTime dateTime, ZoneOffset offset)// åŸºäºå¹´æœˆæ—¥æ—¶åˆ†ç§’çº³ç§’å’Œæ—¶é—´åç§»é‡åˆ›å»ºOffsetDateTimeå®ä¾‹public static OffsetDateTime of( int year, int month, int dayOfMonth, int hour, int minute, int second, int nanoOfSecond, ZoneOffset offset)// åŸºäºInstantå®ä¾‹å’Œæ—¶åŒºIDå®ä¾‹åˆ›å»ºOffsetDateTimeå®ä¾‹public static OffsetDateTime ofInstant(Instant instant, ZoneId zone) ä¸¾ä¸ªç®€å•çš„ä½¿ç”¨ä¾‹å­ï¼š 123456789101112131415public class OffsetDateTimeMain &#123; public static void main(String[] args) throws Exception &#123; OffsetDateTime offsetDateTime = OffsetDateTime.now(); System.out.println(offsetDateTime); offsetDateTime = OffsetDateTime.ofInstant(Instant.now(), ZoneId.systemDefault()); System.out.println(offsetDateTime); offsetDateTime = OffsetDateTime.of(LocalDateTime.now(), ZoneOffset.ofHours(8)); System.out.println(offsetDateTime); &#125;&#125;// æŸä¸ªæ—¶åˆ»çš„è¾“å‡ºå¦‚ä¸‹2019-01-01T20:38:03.388846400+08:002019-01-01T20:38:03.388846400+08:002019-01-01T20:38:03.388846400+08:00 ZonedDateTime java.time.ZonedDateTimeåº”è¯¥æ˜¯JSR-310ä¸­æœ€å¤æ‚ä½†æ˜¯æœ€å…¨é¢çš„æ—¥æœŸæ—¶é—´ç±»(å®ƒçš„APIæ–‡æ¡£ä¸­æ³¨é‡Šä¹Ÿæ˜¯æœ€å¤šçš„ï¼Œä»è¿™ç‚¹ä¹Ÿå¯ä»¥çœ‹å‡ºå®ƒçš„å¤æ‚æ€§)ã€‚ZonedDateTimeå¯ä»¥ç®€å•ç†è§£ä¸ºLocalDateTimeï¼Œæ—¶åŒºIDå’Œä¸€ä¸ªå¯å¤„ç†çš„ZoneOffsetä¸‰è€…çš„å…±åŒå®ç°ï¼Œæˆ–è€…æ›´ç®€å•ç†è§£ä¸ºæ—¥æœŸæ—¶é—´ã€æ—¶é—´åç§»é‡ã€åŒºåŸŸæ—¶åŒºç­‰æ—¶åŒºè§„åˆ™çš„å¤šé‡å®ç°ã€‚ZonedDateTimeä¹Ÿæ˜¯ä¸€ä¸ªä¸å¯å˜çš„æ—¥æœŸæ—¶é—´å¯¹è±¡ï¼Œå¸¸ç”¨çš„æ ¼å¼ä¸ºï¼šå¹´-æœˆ-æ—¥ æ—¶:åˆ†:ç§’-æ—¶åŒºåç§»é‡-åŒºåŸŸï¼Œä¾‹å¦‚2007-12-03T10:15:30+01:00 Europe/Parisã€‚é™¤äº†åŒ…å«æ‰€æœ‰çš„æ—¥æœŸæ—¶é—´å±æ€§ä¹‹å¤–ï¼ŒZonedDateTimeè¿˜åŒ…å«ä¸€ä¸ªçº³ç§’å±æ€§(nanoå–å€¼èŒƒå›´[0,999999999])ã€‚ZonedDateTimeçš„å¸¸ç”¨é™æ€å·¥å‚æ–¹æ³•å¦‚ä¸‹ï¼š 123456789101112131415161718// æ ¹æ®å½“å‰çš„æ—¥æœŸæ—¶é—´ã€æ—¶åŒºIDå’Œæ—¶é’Ÿåˆ›å»ºZonedDateTimeå®ä¾‹public static ZonedDateTime now()public static ZonedDateTime now(ZoneId zone)public static ZonedDateTime now(Clock clock)// åŸºäºLocalDateå®ä¾‹ã€LocalTimeå®ä¾‹å’Œæ—¶åŒºIDåˆ›å»ºZonedDateTimeå®ä¾‹public static ZonedDateTime of(LocalDate date, LocalTime time, ZoneId zone)// åŸºäºLocalDateTimeå®ä¾‹å’Œæ—¶åŒºIDåˆ›å»ºZonedDateTimeå®ä¾‹public static ZonedDateTime of(LocalDateTime localDateTime, ZoneId zone)// åŸºäºå¹´æœˆæ—¥æ—¶åˆ†ç§’çº³ç§’å’Œæ—¶åŒºIDåˆ›å»ºZonedDateTimeå®ä¾‹public static ZonedDateTime of( int year, int month, int dayOfMonth, int hour, int minute, int second, int nanoOfSecond, ZoneId zone)// åŸºäºLocalDateTimeå®ä¾‹ã€æ—¶åŒºIDå’Œå€™é€‰åå¥½çš„æ—¶é—´åç§»é‡åˆ›å»ºZonedDateTimeå®ä¾‹public static ZonedDateTime ofLocal(LocalDateTime localDateTime, ZoneId zone, ZoneOffset preferredOffset) ä¸¾ä¸ªç®€å•çš„ä½¿ç”¨ä¾‹å­ï¼š 123456789101112131415public class ZonedDateTimeMain &#123; public static void main(String[] args) throws Exception &#123; ZonedDateTime zonedDateTime = ZonedDateTime.now(); System.out.println(zonedDateTime); zonedDateTime = ZonedDateTime.of(LocalDateTime.now(), ZoneId.systemDefault()); System.out.println(zonedDateTime); zonedDateTime = ZonedDateTime.ofInstant(Instant.now(), ZoneId.systemDefault()); System.out.println(zonedDateTime); &#125;&#125;// æŸä¸ªæ—¶åˆ»çš„æ‰§è¡Œç»“æœ2019-01-01T21:00:03.193242200+08:00[Asia/Shanghai]2019-01-01T21:00:03.193242200+08:00[Asia/Shanghai]2019-01-01T21:00:03.193242200+08:00[Asia/Shanghai] å…¶ä»– Year java.time.YearåŸºäºISO-8601æ—¥æœŸç³»ç»Ÿä¸‹è¡¨ç¤ºå¹´ä»½ï¼Œæ”¯æŒçš„èŒƒå›´æ˜¯[-999_999_999,999_999_999]ã€‚ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼š 12345678910111213141516public class YearMain &#123; public static void main(String[] args) throws Exception&#123; Year year = Year.now(); System.out.println(year); System.out.println(year.isLeap()); year = Year.of(2016); System.out.println(year); System.out.println(year.isLeap()); &#125;&#125;// è¾“å‡ºç»“æœ2019false2016true Month java.time.Monthæ˜¯ä¸€ä¸ªæšä¸¾ï¼Œä»£è¡¨ISO-8601æ—¥æœŸç³»ç»Ÿä¸­çš„æœˆä»½ã€‚æšä¸¾çš„æˆå‘˜ä¸€å…±æœ‰12ä¸ªï¼Œå°±æ˜¯JANUARYåˆ°DECEMBERä¸€å…±12ä¸ªæœˆä»½çš„è‹±æ–‡å¤§å†™è¡¨ç¤ºã€‚ä¸¾ä¸ªç®€å•çš„ä½¿ç”¨ä¾‹å­ï¼š 123456789101112public class MonthMain &#123; public static void main(String[] args) throws Exception &#123; Month month = Month.of(12); System.out.println(month); month = Month.JANUARY; System.out.println(month); &#125;&#125;// è¾“å‡ºç»“æœDECEMBERJANUARY DayOfWeek java.time.DayOfWeekæ˜¯ä¸€ä¸ªæšä¸¾ï¼Œè¡¨ç¤ºä¸€ä¸ªæ˜ŸæœŸä¸­å…·ä½“æ˜¯æ˜ŸæœŸå‡ ã€‚æšä¸¾æˆå‘˜ä¸€å…±æœ‰7ä¸ªï¼Œå°±æ˜¯ä»MONDAYåˆ°SUNDAYä¸€å…±7ä¸ªæŒ‡ä»£å…·ä½“æ˜ŸæœŸå‡ çš„è‹±æ–‡å¤§å†™è¡¨ç¤ºã€‚ä¸¾ä¸ªç®€å•çš„ä½¿ç”¨ä¾‹å­ï¼š 123456789101112public class DayOfWeekMain &#123; public static void main(String[] args) throws Exception&#123; DayOfWeek dayOfWeek = DayOfWeek.of(1); System.out.println(dayOfWeek); dayOfWeek = DayOfWeek.SUNDAY; System.out.println(dayOfWeek); &#125;&#125;// è¾“å‡ºç»“æœMONDAYSUNDAY MonthDay java.time.MonthDayä»£è¡¨æœˆä»½å’Œå¯¹åº”æœˆä»½ä¸€å…±å­˜åœ¨çš„å¤©æ•°ï¼Œå†…éƒ¨ç»´æŠ¤ç€æ•´å‹çš„å±æ€§monthå’Œæ•´å‹çš„å±æ€§dayã€‚ä¸¾ä¸ªä¾‹å­ï¼š 123456789101112public class MonthDayMain &#123; public static void main(String[] args) throws Exception &#123; MonthDay monthDay = MonthDay.now(); System.out.println(monthDay); monthDay = MonthDay.of(2, 29); System.out.println(monthDay); &#125;&#125;//æŸä¸ªæ—¶åˆ»çš„è¾“å‡ºç»“æœ--01-01--02-29 MonthDayé€šè¿‡é™æ€å·¥å‚æ–¹æ³•æ„å»ºå®ä¾‹çš„æ—¶å€™ä¼šåˆ¤æ–­æœˆä»½æˆ–è€…å¤©æ•°æ˜¯å¦è¶…è¿‡å®é™…çš„é™åˆ¶ï¼Œå¦‚æœè¶…é™ä¼šæŠ›å¼‚å¸¸ã€‚ YearMonth java.time.YearMonthä»£è¡¨å¹´ä»½å’Œæœˆä»½ï¼Œå†…éƒ¨ç»´æŠ¤ç€æ•´å‹çš„å±æ€§monthå’Œæ•´å‹çš„å±æ€§monthã€‚ä¸¾ä¸ªä¾‹å­ï¼š 123456789101112public class YearMonthMain &#123; public static void main(String[] args) throws Exception&#123; YearMonth yearMonth = YearMonth.now(); System.out.println(yearMonth); yearMonth = YearMonth.of(2019, 12); System.out.println(yearMonth); &#125;&#125;// æŸä¸ªæ—¶åˆ»çš„è¾“å‡º2019-012019-12 ç±»å‹è½¬æ¢ è¿™é‡Œä¸»è¦æ€»ç»“ä¸€ä¸‹JSR-310çš„æ—¥æœŸæ—¶é—´ç±»ä¹‹é—´çš„è½¬æ¢ä»¥åŠJSR-310çš„æ—¥æœŸæ—¶é—´ç±»å’Œå·²ç»å­˜åœ¨çš„æ—§Javaæ—¥æœŸæ—¶é—´ç±»ä¹‹é—´çš„è½¬æ¢å…³ç³»ã€‚ Instantå’Œå…¶ä»–æ—¥æœŸæ—¶é—´ç±»äº’è½¬ å¦‚æœæœ‰æ³¨æ„åˆ°ä¸Šé¢ä»‹ç»æ—¥æœŸæ—¶é—´ç±»çš„æ—¶å€™ä¼šå‘ç°æ¯ä¸ªç±»çš„å·¥å‚æ–¹æ³•éƒ½åŒ…å«ofInstant()æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯Instantå®ä¾‹å¯ä»¥è½¬åŒ–ä¸ºå…¶ä»–æ—¥æœŸæ—¶é—´ç±»å®ä¾‹ï¼Œè¿™é‡Œæ€»ç»“ä¸€ä¸‹ï¼š 12345678910111213public class InstantConvertTo &#123; public static void main(String[] args) throws Exception &#123; Instant instant = Instant.now(); ZoneId zoneId = ZoneId.systemDefault(); LocalDateTime localDateTime = LocalDateTime.ofInstant(instant, zoneId); LocalDate localDate = LocalDate.ofInstant(instant, zoneId); LocalTime localTime = LocalTime.ofInstant(instant, zoneId); OffsetTime offsetTime = OffsetTime.ofInstant(instant, zoneId); OffsetDateTime offsetDateTime = OffsetDateTime.ofInstant(instant,zoneId); ZonedDateTime zonedDateTime = ZonedDateTime.ofInstant(instant, zoneId); &#125;&#125; å…¶å®å¾ˆå¥½ç†è§£ï¼Œå³ä½¿åœ¨æ—§çš„Javaæ—¥æœŸæ—¶é—´APIä¸­ï¼Œé•¿æ•´å‹çš„æ—¶é—´æˆ³æ¯«ç§’ä¹Ÿå¯ä»¥é€šè¿‡å„ç§æ—¥æœŸæ—¶é—´ç±»çš„æ„é€ æˆ–è€…é™æ€å·¥å‚æ–¹æ³•åˆ›å»ºå¯¹åº”çš„å®ä¾‹ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œåªæœ‰åŒæ—¶åŒ…å«æ—¥æœŸå’Œæ—¶é—´çš„ç±»æ‰èƒ½è½¬æ¢ä¸ºInstantå®ä¾‹ï¼Œè¿™ä¸€ç‚¹ä¹Ÿå¾ˆå¥½ç†è§£ï¼ŒåªåŒ…å«æ—¶é—´æˆ–è€…åªåŒ…å«æ—¥æœŸçš„ç±»è½¬æ¢æˆç¬æ—¶æ—¶é—´ä¼šä¸¢å¤±éƒ¨åˆ†æ—¶é—´å€¼ã€‚è¿™é‡Œä¸¾ä¸ªç®€å•ä¾‹å­ï¼š 12345678910public class InstantConvertFrom &#123; public static void main(String[] args) throws Exception &#123; // è¿™é‡Œåªä»¥LocalDateTimeä¸ºä¾‹,å…¶ä»–ç±»ä¼¼ LocalDateTime localDateTime = LocalDateTime.now(); Instant instant = localDateTime.toInstant(ZoneOffset.UTC); // æˆ–è€… instant = Instant.ofEpochMilli(localDateTime.toEpochSecond(ZoneOffset.UTC) * 1000); &#125;&#125; JSR-310æ—¥æœŸæ—¶é—´ç±»ä¹‹é—´äº’ç›¸è½¬æ¢ æ—¥æœŸæ—¶é—´ç±»æœ¬èº«å°±åŒ…å«æ—¥æœŸå’Œæ—¶é—´çš„ç»´åº¦ï¼Œä¸€èˆ¬å®ƒä»¬ç›´æ¥ä¿å­˜æ—¶é—´ç±»å®ä¾‹ä½œä¸ºæˆå‘˜å±æ€§ï¼Œæ‰€ä»¥è½¬æ¢ä¹Ÿååˆ†æ–¹ä¾¿ï¼š 12345678public class DateTimeToTime &#123; public static void main(String[] args) throws Exception&#123; LocalDateTime localDateTime = LocalDateTime.now(); LocalDate localDate = localDateTime.toLocalDate(); LocalTime localTime = localDateTime.toLocalTime(); &#125;&#125; æ—¥æœŸç±»ä¸åŒ…å«æ—¶é—´éƒ¨åˆ†ï¼Œæ‰€ä»¥æ—¥æœŸç±»è½¬æ¢ä¸ºæ—¥æœŸæ—¶é—´ç±»çš„æ—¶å€™ï¼Œæ—¶é—´éƒ¨åˆ†ä¼šå–æœ€å°ï¼Œä¾‹å¦‚ï¼š 123456789101112131415public class DateToDateTime &#123; public static void main(String[] args) throws Exception&#123; LocalDate localDate = LocalDate.now(); System.out.println(localDate); LocalDateTime localDateTime = localDate.atStartOfDay(); System.out.println(localDateTime); ZonedDateTime zonedDateTime = localDate.atStartOfDay(ZoneId.systemDefault()); System.out.println(zonedDateTime); &#125;&#125;// æŸä¸ªæ—¶åˆ»çš„è¾“å‡ºå¦‚ä¸‹2019-01-012019-01-01T00:002019-01-01T00:00+08:00[Asia/Shanghai] å¸¦æœ‰æ—¶åŒºID(æ—¶é—´åç§»é‡æˆ–è€…åœ°åŒº)çš„ç±»å‹å¯ä»¥è½»æ˜“è½¬å˜ä¸ºä¸å¸¦æœ‰æ—¶åŒºIDçš„ç±»å‹ï¼Œå¦‚æœè¦åè¿‡æ¥ï¼Œåˆ™éœ€è¦æ·»åŠ å¯¹åº”çš„æ—¶åŒºIDå±æ€§ï¼Œä¾‹å¦‚ï¼š 1234567891011121314151617public class ZoneIdDateTimeMain &#123; public static void main(String[] args) throws Exception &#123; ZonedDateTime zonedDateTime = ZonedDateTime.of(LocalDateTime.now(), ZoneId.systemDefault()); System.out.println(zonedDateTime); LocalDateTime localDateTime = zonedDateTime.toLocalDateTime(); LocalDate localDate = zonedDateTime.toLocalDate(); LocalTime localTime = zonedDateTime.toLocalTime(); zonedDateTime = ZonedDateTime.of(localDateTime, ZoneId.systemDefault()); OffsetDateTime offsetDateTime = OffsetDateTime.of(LocalDateTime.now(), ZoneOffset.UTC); localDateTime = offsetDateTime.toLocalDateTime(); localDate = offsetDateTime.toLocalDate(); localTime = offsetDateTime.toLocalTime(); offsetDateTime = OffsetDateTime.of(localDateTime, ZoneOffset.UTC); &#125;&#125; JSR-310ä¸­çš„ç±»å’Œæ—§çš„æ—¥æœŸæ—¶é—´ç›¸å…³ç±»ä¹‹é—´çš„è½¬æ¢ java.sql.Timestampå’Œjava.time.LocalDateTimeä¹‹é—´çš„è½¬æ¢ï¼š 12345678public class TimestampLocalDateTime &#123; public static void main(String[] args) throws Exception &#123; LocalDateTime localDateTime = LocalDateTime.now(); Timestamp timestamp = Timestamp.valueOf(localDateTime); LocalDateTime ldt = timestamp.toLocalDateTime(); &#125;&#125; java.sql.Dateå’Œjava.time.LocalDateä¹‹é—´çš„è½¬æ¢ï¼š 12345678public class DateLocalDate &#123; public static void main(String[] args) throws Exception &#123; Date date = new Date(2018, 1, 1); LocalDate localDate = date.toLocalDate(); date = new Date(localDate.getYear(), localDate.getMonthValue(), localDate.getDayOfMonth()); &#125;&#125; åªè¦æ˜¯èƒ½ä½¿ç”¨æ¯«ç§’è¡¨ç¤ºçš„æ—§çš„æ—¥æœŸæ—¶é—´ç±»ï¼Œéƒ½å¯ä»¥å’Œjava.time.Instantç›¸äº’è½¬æ¢ï¼Œä¾‹å¦‚ï¼š 1234567891011public class ToInstant &#123; public static void main(String[] args) throws Exception&#123; Timestamp timestamp = new Timestamp(System.currentTimeMillis()); Instant instant = timestamp.toInstant(); java.util.Date date = new Date(System.currentTimeMillis()); instant = date.toInstant(); timestamp = new Timestamp(instant.toEpochMilli()); date = new Date(instant.toEpochMilli()); &#125;&#125; å°ç»“ JSR-310çš„æ–°æ—¶é—´æ—¥æœŸç±»åº“çš„è®¾è®¡ç›¸æ¯”å·²ç»å­˜åœ¨çš„æ—§çš„æ—¥æœŸæ—¶é—´ç±»åº“æ¥è¯´ï¼Œä¸ªäººè®¤ä¸ºæœ‰ä»¥ä¸‹çš„ä¼˜ç‚¹ï¼š çº¿ç¨‹å®‰å…¨ã€‚ ç±»çš„èŒè´£æ›´åŠ åˆ†æ˜ï¼Œæ—¶é—´ã€æ—¥æœŸã€æ—¥æœŸæ—¶é—´éœ€è¦ä½¿ç”¨æ˜ç¡®çš„ç±»å»è¡¨ç¤ºã€‚ APIå°è£…æ›´åŠ åˆç†ï¼Œä½¿å¾—æ˜“ç”¨æ€§æé«˜ã€‚ ä¸è¿‡ä¼šå­˜åœ¨ä¸€äº›é—®é¢˜ï¼Œæœ€æ˜æ˜¾çš„æ˜¯å·²æœ‰çš„æ—§ç±»åº“å­˜åœ¨å…¼å®¹æ€§é—®é¢˜ï¼Œä¾‹å¦‚JDBCæ¨¡å—é‡Œé¢å¤„ç†æ—¥æœŸæ—¶é—´éœ€è¦è¿›è¡Œæ–°çš„æ—¥æœŸæ—¶é—´ç±»å’Œjava.sql.Timestampè¿›è¡Œè½¬æ¢çš„é—®é¢˜ï¼Œä¸è¿‡è½¬æ¢æˆæœ¬å¹¶ä¸é«˜ã€‚ (æœ¬æ–‡å®Œ c-3-d e-a-20181230)","categories":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/tags/Java/"},{"name":"JSR-310","slug":"JSR-310","permalink":"http://throwable.club/blog/tags/JSR-310/"}]},{"title":"JSR310æ–°æ—¥æœŸAPI(ä¸€)-æ—¶åŒºä¸æ—¶é—´åç§»é‡","slug":"java-jsr310-zone-id","date":"2018-12-23T15:05:42.000Z","updated":"2019-01-01T14:04:05.225Z","comments":true,"path":"2018/12/23/java-jsr310-zone-id/","link":"","permalink":"http://throwable.club/2018/12/23/java-jsr310-zone-id/","excerpt":"","text":"JSR310æ–°æ—¥æœŸAPI(ä¸€)-æ—¶åŒºä¸æ—¶é—´åç§»é‡ å‰æ æœ€è¿‘åˆšå¥½æœ‰æ–°é¡¹ç›®ä½¿ç”¨åˆ°JSR-310(JDK8)ä¸­å¼•å…¥çš„æ–°æ—¥æœŸAPIï¼Œæ‰“ç®—åšä¸€ä¸‹æ€»ç»“ã€‚æœ¬æ–‡ç¼–å†™åŸºäºJDK11ï¼Œéƒ¨åˆ†APIå¯èƒ½æ˜¯JDK9ä¹‹åæ–°å¢çš„ã€‚ åœ°ç†çŸ¥è¯†è¡¥å…… ä¸»è¦è¡¥å……ä¸€ä¸‹ä¸€äº›åœ°ç†çŸ¥è¯†ï¼šæ—¶åŒºã€UTCã€GMTã€CSTã€DSTå’ŒISO-8601çš„ç›¸å…³æ¦‚å¿µã€‚ æ—¶åŒº æ—¶åŒº(Time Zone)æ˜¯åœ°çƒä¸Šçš„åŒºåŸŸä½¿ç”¨åŒä¸€ä¸ªæ—¶é—´å®šä¹‰ã€‚1884å¹´åœ¨åç››é¡¿å¬å¼€å›½é™…ç»åº¦ä¼šè®®æ—¶ï¼Œä¸ºäº†å…‹æœæ—¶é—´ä¸Šçš„æ··ä¹±ï¼Œè§„å®šå°†å…¨çƒåˆ’åˆ†ä¸º24ä¸ªæ—¶åŒºã€‚é€ æˆæ—¶é—´ä¸Šçš„æ··ä¹±æ˜¯ç”±äºä¸–ç•Œå„ä¸ªå›½å®¶ä½äºåœ°çƒä¸åŒä½ç½®ä¸Šï¼Œå› æ­¤ä¸åŒå›½å®¶ï¼Œç‰¹åˆ«æ˜¯ä¸œè¥¿è·¨åº¦å¤§çš„å›½å®¶æ—¥å‡ºã€æ—¥è½æ—¶é—´å¿…å®šæœ‰æ‰€åå·®(è¿™ä¸ªåå·®æˆ‘ä»¬é€šå¸¸å«åšæ—¶å·®)ã€‚ å‰è¾¹æåˆ°å…¨çƒå…±åˆ†ä¸º24ä¸ªæ—¶åŒº(ä¸œã€è¥¿å„12ä¸ªæ—¶åŒº)ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸ªæ—¶åŒºçš„ç»åº¦å®½åº¦ä¸º15åº¦ï¼Œå…¶ä¸­æœ¬åˆå­åˆçº¿(0åº¦ç»çº¿)ä¸º0æ—¶åŒºçš„ä¸­å¿ƒçº¿ï¼Œè€Œä¸œã€è¥¿12æ—¶åŒºåˆå¹¶ä¸ºä¸€ä¸ªæ—¶åŒºï¼Œè¿™äº›æ—¶åŒºçš„ç»åº¦åˆ†å¸ƒå¦‚ä¸‹ï¼š æ—¶åŒº æ—¶åŒºç»åº¦èŒƒå›´ æ—¶åŒºä¸­å¿ƒçº¿ UTC(0æ—¶åŒº) 7.5Â°W~7.5Â°E 0Â° UTC+1(ä¸œ1åŒº) 7.5Â°E~22.5Â°E 15Â°E UTC+2(ä¸œ2åŒº) 22.5Â°E~37.5Â°E 30Â°E UTC+3(ä¸œ3åŒº) 37.5Â°E~52.5Â°E 45Â°E UTC+4(ä¸œ4åŒº) 52.5Â°E~67.5Â°E 60Â°E UTC+5(ä¸œ5åŒº) 67.5Â°E~82.5Â°E 75Â°E UTC+6(ä¸œ6åŒº) 82.5Â°E~97.5Â°E 90Â°E UTC+7(ä¸œ7åŒº) 97.5Â°E~112.5Â°E 105Â°E UTC+8(ä¸œ8åŒº) 112.5Â°E~127.5Â°E 120Â°E UTC+9(ä¸œ9åŒº) 127.5Â°E~142.5Â°E 135Â°E UTC+10(ä¸œ10åŒº) 142.5Â°E~157.5Â°E 150Â°E UTC+11(ä¸œ11åŒº) 157.5Â°E~172.5Â°E 165Â°E UTC12(ä¸œã€è¥¿12åŒº) 172.5Â°E~172.5Â°W 180Â° UTC-11(è¥¿11åŒº) 172.5Â°W~157.5Â°W 165Â°W UTC-10(è¥¿10åŒº) 157.5Â°W~142.5Â°W 150Â°W UTC-9(è¥¿9åŒº) 142.5Â°W~127.5Â°W 135Â°W UTC-8(è¥¿8åŒº) 127.5Â°W~112.5Â°W 120Â°W UTC-7(è¥¿7åŒº) 112.5Â°W~97.5Â°W 105Â°W UTC-6(è¥¿6åŒº) 97.5Â°W~82.5Â°W 90Â°W UTC-5(è¥¿5åŒº) 82.5Â°W~67.5Â°W 75Â°W UTC-4(è¥¿4åŒº) 67.5Â°W~52.5Â°W 60Â°W UTC-3(è¥¿3åŒº) 52.5Â°W~37.5Â°W 45Â°W UTC-2(è¥¿2åŒº) 37.5Â°W~22.5Â°W 30Â°W UTC-1(è¥¿1åŒº) 22.5Â°W~7.5Â°W 15Â°W ä½†æ˜¯å®é™…ä¸Šï¼Œé€šå¸¸1ä¸ªå›½å®¶æˆ–1ä¸ªçœä»½åŒæ—¶è·¨ç€å¤šä¸ªæ—¶åŒºï¼Œæ˜¯å› ä¸ºä¸ºäº†ç…§é¡¾åˆ°è¡Œæ”¿ä¸Šçš„æ–¹ä¾¿ï¼Œå¸¸å°†1ä¸ªå›½å®¶æˆ–1ä¸ªçœä»½åˆ’åœ¨åŒä¸€ä¸ªæ—¶åŒºã€‚ä¾‹å¦‚ï¼Œä¸­å›½è·¨5ä¸ªæ—¶åŒºï¼Œä½†ä¸ºäº†ä½¿ç”¨æ–¹ä¾¿ç®€å•å¹¶ä¸”å…¨å›½ç»Ÿä¸€ä½¿ç”¨ä¸€ä¸ªåŒºæ—¶ï¼Œå®é™…ä¸Šåœ¨ä¸­å›½ä½¿ç”¨ä¸œ8åŒºçš„åŒºæ—¶ä¸€èˆ¬ç§°ä¸ºåŒ—äº¬æ—¶é—´ä½œä¸ºæ ‡å‡†æ—¶é—´ã€‚å…¨çƒçš„æ ‡å‡†æ—¶åŒºåˆ’åˆ†å¦‚ä¸‹ï¼š UTCã€GMTã€CSTã€DSTä¸ISO-8601 GMTï¼ŒGreenwich Mean Timeï¼Œæ ¼æ—å°¼æ²»(æˆ–è€…æœ‰æ—¶å€™ç¿»è¯‘ä¸ºæ ¼æ—å¨æ²»)æ ‡å‡†æ—¶é—´ï¼Œæ˜¯æŒ‡ä½äºä¼¦æ•¦éƒŠåŒºçš„çš‡å®¶æ ¼æ—å°¼æ²»å¤©æ–‡å°çš„æ ‡å‡†æ—¶é—´ã€‚æ ¼æ—å°¼æ²»æ‰€åœ¨åœ°çš„æ ‡å‡†æ—¶é—´ä¹Ÿå«ä¸–ç•Œæ—¶UTã€‚ä»¥åœ°çƒè‡ªè½¬ä¸ºåŸºç¡€çš„æ—¶é—´è®¡é‡ç³»ç»Ÿã€‚åœ°çƒè‡ªè½¬çš„è§’åº¦å¯ç”¨åœ°æ–¹å­åˆçº¿ç›¸å¯¹äºåœ°çƒä¸Šçš„åŸºæœ¬å‚è€ƒç‚¹çš„è¿åŠ¨æ¥åº¦é‡ã€‚ä¸ºäº†æµ‹é‡åœ°çƒè‡ªè½¬ï¼Œäººä»¬åœ¨åœ°çƒä¸Šé€‰å–äº†ä¸¤ä¸ªåŸºæœ¬å‚è€ƒç‚¹ï¼šæ˜¥åˆ†ç‚¹(è§åˆ†è‡³ç‚¹)å’Œå¹³å¤ªé˜³ï¼Œç”±æ­¤ç¡®å®šçš„æ—¶é—´åˆ†åˆ«ç§°ä¸ºæ’æ˜Ÿæ—¶å’Œå¹³å¤ªé˜³æ—¶ã€‚å¯¹äºä¸–ç•Œä¸Šå‘ç”Ÿçš„é‡å¤§äº‹ä»¶ï¼Œéƒ½ä»¥æ ¼æ—å°¼æ²»çš„åœ°æ–¹æ—¶é—´è®°å½•ä¸‹æ¥ã€‚ä¸€æ—¦çŸ¥é“äº†æ ¼æ—å°¼æ²»æ—¶é—´ï¼Œäººä»¬å°±å¾ˆå®¹æ˜“æ¨ç®—å‡ºç›¸å¯¹åº”çš„æœ¬åœ°æ—¶é—´ã€‚æŒ‡ä½äºè‹±å›½ä¼¦æ•¦éƒŠåŒºçš„çš‡å®¶æ ¼æ—å°¼æ²»å¤©æ–‡å°çš„æ ‡å‡†æ—¶é—´ï¼Œå› ä¸ºæœ¬åˆå­åˆçº¿è¢«å®šä¹‰åœ¨é€šè¿‡é‚£é‡Œçš„ç»çº¿ã€‚ è‡ª1924å¹´2æœˆ5æ—¥å¼€å§‹ï¼Œæ ¼æ—å°¼æ²»å¤©æ–‡å°æ¯éš”ä¸€å°æ—¶ä¼šå‘å…¨ä¸–ç•Œå‘æ”¾è°ƒæ—¶ä¿¡æ¯ã€‚ æ ¼æ—å¨æ²»å­åˆçº¿ä¸Šçš„åœ°æ–¹æ—¶ï¼Œæˆ–é›¶æ—¶åŒºï¼ˆä¸­æ—¶åŒºï¼‰çš„åŒºæ—¶å«åšæ ¼æ—å¨æ²»æ—¶é—´(åˆè¯‘ä¸º&quot;æ ¼æ—å°¼æ²»æ—¶é—´&quot;)ï¼Œä¹Ÿå«&quot;ä¸–ç•Œæ—¶&quot;ã€‚åŸæ˜¯é‡‡ç”¨æ ¼æ—å¨æ²»çš„å¹³æ­£åˆä½œä¸ºä¸€ä¸ªå¹³å¤ªé˜³æ—¥çš„å¼€å§‹ï¼Œä½†åœ¨ä½¿ç”¨ä¸­æœ‰äº›ä¸ä¾¿ã€‚å› æ­¤ï¼Œå›½é™…å¤©æ–‡å­¦è”åˆä¼šäº1928å¹´å†³å®šï¼Œå°†ç”±æ ¼æ—å¨æ²»å¹³å­å¤œèµ·ç®—çš„å¹³å¤ªé˜³æ—¶ä½œä¸ºä¸–ç•Œæ—¶ï¼Œä¹Ÿå°±æ˜¯é€šå¸¸æ‰€è¯´çš„æ ¼æ—å¨æ²»æ—¶é—´ã€‚æ ¼æ—å¨æ²»æ—¶é—´æ‰€åœ¨æ—¶åŒºä¸º0æ—¶åŒºï¼Œå¯ä»¥æ¨ç®—å‡ºä½¿ç”¨GMT+8è¡¨ç¤ºä¸­å›½çš„æ—¶é—´ï¼Œæ˜¯å› ä¸ºä¸­å›½ä½äºä¸œå…«åŒºï¼Œæ—¶é—´ä¸Šæ¯”æ ¼æ—å¨æ²»æ—¶é—´å¿«8ä¸ªå°æ—¶ã€‚ UTCï¼ŒCoordinated Universal Timeï¼Œä¹Ÿå°±æ˜¯åè°ƒä¸–ç•Œæ—¶ï¼Œç”±äºè‹±æ–‡(CUT)å’Œæ³•æ–‡(TUC)çš„ç¼©å†™ä¸åŒï¼Œä½œä¸ºå¦¥åï¼Œç®€ç§°UTCã€‚åè°ƒä¸–ç•Œæ—¶æ˜¯ä»¥åŸå­æ—¶ç§’é•¿ä¸ºåŸºç¡€ï¼Œåœ¨æ—¶åˆ»ä¸Šå°½é‡æ¥è¿‘äºä¸–ç•Œæ—¶çš„ä¸€ç§æ—¶é—´è®¡é‡ç³»ç»Ÿ(ç”±å®éªŒå®¤ç”¨è¶³å¤Ÿç²¾ç¡®çš„é“¯åŸå­é’Ÿå¯¼å‡ºçš„æ—¶é—´ä½œä¸ºåŸå­æ—¶ï¼ŒåŸå­æ—¶çš„ç²¾ç¡®åº¦æé«˜ï¼Œç²¾åº¦å¯ä»¥è¾¾åˆ°æ¯2000ä¸‡å¹´æ‰è¯¯å·®1ç§’)ã€‚å›½é™…åŸå­æ—¶çš„å‡†ç¡®åº¦ä¸ºæ¯æ—¥æ•°çº³ç§’ï¼Œè€Œä¸–ç•Œæ—¶çš„å‡†ç¡®åº¦ä¸ºæ¯æ—¥æ•°æ¯«ç§’ã€‚è®¸å¤šåº”ç”¨éƒ¨é—¨è¦æ±‚æ—¶é—´ç³»ç»Ÿæ¥è¿‘ä¸–ç•Œæ—¶UTï¼Œå¯¹äºè¿™ç§æƒ…å†µï¼Œä¸€ç§ç§°ä¸ºåè°ƒä¸–ç•Œæ—¶çš„æŠ˜è¡·æ—¶æ ‡äº1972å¹´é¢ä¸–ã€‚ä¸ºç¡®ä¿åè°ƒä¸–ç•Œæ—¶ä¸ä¸–ç•Œæ—¶ç›¸å·®ä¸ä¼šè¶…è¿‡0.9ç§’ï¼Œåœ¨æœ‰éœ€è¦çš„æƒ…å†µä¸‹ä¼šåœ¨åè°ƒä¸–ç•Œæ—¶å†…åŠ ä¸Šæ­£æˆ–è´Ÿé—°ç§’ã€‚å› æ­¤åè°ƒä¸–ç•Œæ—¶ä¸å›½é™…åŸå­æ—¶ä¹‹é—´ä¼šå‡ºç°è‹¥å¹²æ•´æ•°ç§’çš„å·®åˆ«ï¼Œä¸¤è€…ä¹‹å·®é€å¹´ç§¯ç´¯ï¼Œä¾¿é‡‡ç”¨è·³ç§’(é—°ç§’)çš„æ–¹æ³•ä½¿åè°ƒæ—¶ä¸ä¸–ç•Œæ—¶çš„æ—¶åˆ»ç›¸æ¥è¿‘ï¼Œå…¶å·®ä¸è¶…è¿‡1sã€‚é€šå¸¸å°†GMTå’ŒUTCè§†ä½œç­‰åŒï¼Œä½†UTCæ›´åŠ ç§‘å­¦æ›´åŠ ç²¾ç¡®ï¼Œå®ƒæ˜¯ä»¥åŸå­æ—¶ä¸ºåŸºç¡€ï¼Œåœ¨æ—¶åˆ»ä¸Šå°½é‡æ¥è¿‘ä¸–ç•Œæ—¶çš„ä¸€ç§æ—¶é—´è®¡é‡ç³»ç»Ÿã€‚ç±»ä¼¼çš„ï¼Œå¯ä»¥ä½¿ç”¨UTC+8è¡¨ç¤ºä¸­å›½çš„æ—¶é—´ã€‚ CSTï¼ŒChina Standard Timeï¼Œä¹Ÿå°±æ˜¯ä¸­å›½æ ‡å‡†æ—¶é—´ï¼Œå½“æ ¼æ—å¨æ²»æ—¶é—´ä¸ºå‡Œæ™¨0:00æ—¶ï¼Œä¸­å›½æ ‡å‡†æ—¶é—´æ­£å¥½ä¸ºä¸Šåˆ8:00ï¼Œä¹Ÿå°±æ˜¯CSTå®é™…ä¸Šæ˜¯å‚ç…§äºUTCï¼Œé€šç”¨å…¬å¼ä¸ºï¼šCST = UTC/GMT +8ã€‚ DSTï¼ŒDaylight Saving Timeï¼Œé˜³å…‰èŠ‚çº¦æ—¶ï¼Œåœ¨æˆ‘å›½ç§°ä¸ºå¤æ—¶åˆ¶ï¼Œåˆç§°å¤ä»¤æ—¶ï¼Œæ˜¯ä¸€ç§ä¸ºèŠ‚çº¦èƒ½æºè€Œäººä¸ºè°ƒæ•´åœ°æ–¹æ—¶é—´çš„åˆ¶åº¦ã€‚æœ‰äº›å›½å®¶DSTçš„ä½¿ç”¨æ—¶é—´è¾ƒé•¿ï¼Œ(å¦‚ç¾å›½é•¿è¾¾7ä¸ªæœˆ)è·¨è¶Šäº†æ˜¥å¤ç§‹ç­‰ä¸‰ä¸ªå­£èŠ‚ï¼Œå› æ­¤ç®€å•åœ°ç”¨å¤æ—¶åˆ¶çš„æ¦‚å¿µå·²ç»ä¸èƒ½å®Œå…¨è¡¨è¾¾DSTçš„ç¡®åˆ‡å«ä¹‰äº†ï¼Œæ‰€ä»¥æœ‰äººä¹Ÿç§°å…¶ä¸ºèŠ‚èƒ½æ—¶ã€‚æ‰€è°“çš„DSTï¼Œå°±æ˜¯åˆ©ç”¨å¤å­£å¤©äº®å¾—æ—©è¿™ä¸€è‡ªç„¶ç°è±¡ï¼Œäººä¸ºåœ°å°†æ—¶é—´æå‰ä¸€å°æ—¶ã€‚è¿™æ ·å°±å¯ä»¥ä½¿äººä»¬æ—©èµ·æ—©ç¡ï¼Œä»¥å……åˆ†åˆ©ç”¨å…‰ç…§èµ„æºï¼Œå‡å°‘ç…§æ˜æ—¶é—´ï¼Œä»è€ŒèŠ‚çº¦ç…§æ˜ç”¨ç”µã€‚ç›®å‰ä¸­å›½å·²ç»å¼ƒç”¨DSTã€‚ ISO-8601ï¼Œæ˜¯å›½é™…æ ‡å‡†åŒ–ç»„ç»‡çš„æ—¥æœŸå’Œæ—¶é—´çš„è¡¨ç¤ºæ–¹æ³•ï¼Œå…¨ç§°ä¸ºã€Šæ•°æ®å­˜å‚¨å’Œäº¤æ¢å½¢å¼Â·ä¿¡æ¯äº¤æ¢Â·æ—¥æœŸå’Œæ—¶é—´çš„è¡¨ç¤ºæ–¹æ³•ã€‹ã€‚ç›®å‰æ˜¯2004å¹´12æœˆ1æ—¥å‘è¡Œçš„ç¬¬ä¸‰ç‰ˆ&quot;ISO8601:2004&quot;ä»¥æ›¿ä»£1998å¹´çš„ç¬¬ä¸€ç‰ˆ&quot;ISO8601:1988&quot;ä¸2000å¹´çš„ç¬¬äºŒç‰ˆ&quot;ISO8601:2000&quot;ã€‚è¯¥è¡¨ç¤ºæ–¹æ³•è§„å®šï¼šå¹´ç”±4ä½æ•°å­—ç»„æˆYYYYï¼Œæˆ–è€…å¸¦æ­£è´Ÿå·çš„å››æˆ–äº”ä½æ•°å­—è¡¨ç¤ºÂ±YYYYYï¼Œæœˆã€æ—¥ç”¨ä¸¤ä½æ•°å­—è¡¨ç¤ºï¼šMMã€DDã€‚åªä½¿ç”¨æ•°å­—ä¸ºåŸºæœ¬æ ¼å¼ã€‚ä½¿ç”¨çŸ­æ¨ªçº¿&quot;-â€œé—´éš”å¼€å¹´ã€æœˆã€æ—¥ä¸ºæ‰©å±•æ ¼å¼ã€‚æ—¶é—´åªä½¿ç”¨æ•°å­—ä¸ºåŸºæœ¬æ ¼å¼ã€‚ä½¿ç”¨å†’å·â€:&quot;é—´éš”å¼€å°æ—¶ã€åˆ†ã€ç§’çš„ä¸ºæ‰©å±•æ ¼å¼ã€‚å°æ—¶ã€åˆ†å’Œç§’éƒ½ç”¨2ä½æ•°è¡¨ç¤ºã€‚åˆå¹¶è¡¨ç¤ºæ—¶ï¼Œè¦åœ¨æ—¶é—´å‰é¢åŠ ä¸€å¤§å†™å­—æ¯Tï¼Œå¦‚è¦è¡¨ç¤ºåŒ—äº¬æ—¶é—´2004å¹´5æœˆ3æ—¥ä¸‹åˆ5ç‚¹30åˆ†8ç§’ï¼Œå¯ä»¥å†™æˆ2004-05-03T17:30:08+08:00æˆ–20040503T173008+08ã€‚å¦‚æœæ—¶é—´åœ¨é›¶æ—¶åŒºï¼Œå¹¶æ°å¥½ä¸åè°ƒä¸–ç•Œæ—¶ç›¸åŒï¼Œé‚£ä¹ˆ(ä¸åŠ ç©ºæ ¼åœ°)åœ¨æ—¶é—´æœ€ååŠ ä¸€ä¸ªå¤§å†™å­—æ¯Zã€‚Zæ˜¯ç›¸å¯¹åè°ƒä¸–ç•Œæ—¶æ—¶é—´0åç§»çš„ä»£å·ã€‚å¦‚ä¸‹åˆ2ç‚¹30åˆ†5ç§’è¡¨ç¤ºä¸º14:30:05Zæˆ–143005Zï¼›åªè¡¨ç¤ºå°æ—¶å’Œåˆ†ï¼Œä¸º1430Zæˆ–14:30Zï¼›åªè¡¨ç¤ºå°æ—¶ï¼Œåˆ™ä¸º14Zæˆ–14Zã€‚å…¶ä»–æ—¶åŒºç”¨å®é™…æ—¶é—´åŠ æ—¶å·®è¡¨ç¤ºï¼Œå½“æ—¶çš„UTC+8æ—¶é—´è¡¨ç¤ºä¸º22:30:05+08:00æˆ–223005+0800ï¼Œä¹Ÿå¯ä»¥ç®€åŒ–æˆ223005+08ã€‚Javaä¸­å·²å­˜åœ¨çš„ç±»java.util.Dateé»˜è®¤å°±æ˜¯ä½¿ç”¨ISO-8601è¡¨ç¤ºçš„ã€‚ ZoneId JSR-310ä¸­å¼•å…¥äº†æŠ½è±¡ç±»java.time.ZoneIdè¡¨ç¤ºæ—¶åŒºIDï¼Œå®ƒæ˜¯æ—§APIjava.util.TimeZoneçš„æ›¿ä»£ã€‚ZoneRulesProviderç”¨äºåŠ è½½Zone Rule(æ—¶åŒºè§„åˆ™ï¼ŒZoneRules)ï¼Œè‡ªå®šä¹‰å®ç°æ˜¯å¯ä»¥é€šè¿‡ç³»ç»Ÿå˜é‡è®¾ç½®java.time.zone.DefaultZoneRulesProvider=å…¨ç±»åä¸ºZoneRulesProviderè‡ªå®šä¹‰çš„æä¾›ç±»ï¼Œæˆ–è€…é€šè¿‡SPIåŠ è½½ï¼Œé»˜è®¤çš„å®ç°ç±»æ˜¯TzdbZoneRulesProviderï¼ŒTzdbZoneRulesProviderä¼šåŠ è½½${JAVA_HONE}/lib/tzdb.datæ–‡ä»¶(å¯ä»¥æ‰“å¼€è¿™ä¸ªæ–‡ä»¶çœ‹ä¸‹é‡Œé¢æ˜¯æ€ä¹ˆå®šä¹‰å’Œæè¿°æ—¶åŒºçš„ç›¸åº”è§„åˆ™ï¼Œè¿™é‡Œä¸åšè¯¦ç»†åˆ†æï¼Œå®é™…ä¸Šå¦‚æœæ·±å…¥äº†è§£è¿™ä¸ªè§„åˆ™æ–‡ä»¶çš„å®šä¹‰å¯ä»¥è‡ªè¡Œç¼–å†™è§„åˆ™æ–‡ä»¶å’Œå®ç°åŠ è½½ç±»åŠ è½½è‡ªå®šä¹‰çš„è§„åˆ™)ï¼Œè¿™ä¸ªDATæ–‡ä»¶ä¸­å­˜æ”¾ç€æ—¶åŒºçš„è§„åˆ™æ˜ å°„ã€‚ZoneIdå°±æ˜¯æ—¶åŒºIDä¸»è¦ç”¨äºå®šåˆ¶Instantå’ŒLocalDateTimeä¹‹é—´çš„è½¬æ¢è§„åˆ™çš„ã€‚æ—¶åŒºIDä¸€å…±æœ‰ä¸¤ç§ä¸åŒçš„ç±»å‹ï¼š å›ºå®šæ—¶é—´åç§»é‡(Fixed Offset) - å®é™…ä¸Šå¯¹åº”ZoneOffsetã€‚ åœ°ç†åŒºåŸŸ(Geographical Region) - å®é™…ä¸Šå¯¹åº”ZoneRegionã€‚ é™æ€æ–¹æ³•ZoneId#of(String zoneId)ä¼šæ ¹æ®å…¥å‚è‡ªåŠ¨é€‚é…æœ€ç»ˆçš„æ—¶åŒºIDåˆ°åº•è¡¨ç¤ºå›ºå®šæ—¶é—´åç§»é‡è¿˜æ˜¯åœ°ç†åŒºåŸŸï¼Œæ­¤æ–¹æ³•æ”¯æŒå¦‚ä¸‹çš„å‚æ•°ï¼š åœ°ç†åŒºåŸŸå‚æ•°ï¼Œå½¢å¼æ˜¯ï¼šæ´²(å·ã€å›½å®¶)/åŸå¸‚ï¼Œå¦‚ZoneId.of(&quot;Asia/Shanghia&quot;)ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯é»˜è®¤åŠ è½½çš„è§„åˆ™é‡Œé¢æ²¡æœ‰åŒ—äº¬ã€‚ å›ºå®šæ—¶é—´åç§»é‡æ ¼å¼(offset-style)ï¼Œæ”¯æŒçš„æ ¼å¼æ¯”è¾ƒå¤šï¼š UTCæˆ–è€…GMTã€‚ Z(ç›¸å½“äºUTC)ã€‚ +hæˆ–è€…-hã€‚ +hhæˆ–è€…-hhã€‚ +hh:mmæˆ–è€…-hh:mmã€‚ +hh:mm:ssæˆ–è€…-hh:mm:ssã€‚ +hhmmssæˆ–è€…-hhmmssã€‚ åŸºäºå›ºå®šæ—¶é—´åç§»é‡æ ¼å¼ä¸¾å‡ ä¸ªä¾‹å­ï¼š 123456789101112ZoneId z;z = ZoneId.of(\"Z\"); //for UTCz = ZoneId.of(\"+02:00\");z = ZoneId.of(\"-02:00\");ZoneId.of(\"GMT+2\");ZoneId.of(\"UTC\");ZoneId.of(\"UT+01:00\");ZoneId.of(\"Asia/Aden\");ZoneId.of(\"Etc/GMT+9\");ZoneId.of(\"Asia/Aqtau\"); å›ºå®šæ—¶é—´åç§»é‡-ZoneOffset java.time.ZoneOffsetæ˜¯java.time.ZoneIdå®ç°ç±»ï¼Œè¡¨ç¤ºå›ºå®šæ—¶é—´åç§»é‡ï¼Œè¿™ä¸ªåç§»é‡æ˜¯ä»¥æ ¼æ—å°¼æ²»(GMT)/åè°ƒä¸–ç•Œæ—¶(UTC)ä¸ºåŸºå‡†çš„åç§»æ—¶é—´é‡ã€‚ä¸¾ä¸ªä¾‹å­ï¼š 123456789public class ZoneOffsetMain &#123; public static void main(String[] args) throws Exception &#123; ZoneOffset zoneOffset = ZoneOffset.of(\"+02:00\"); System.out.println(zoneOffset); zoneOffset = ZoneOffset.of(\"-02:00\"); System.out.println(zoneOffset); &#125;&#125; å…¶ä¸­ï¼ŒZoneOffset.of(&quot;+02:00&quot;)è¡¨ç¤ºUTCä¸‹2å°æ—¶çš„æ—¶é—´åç§»(ç®€å•ç†è§£ä¸ºä¸œ2åŒº)ï¼ŒZoneOffset.of(&quot;-02:00&quot;)è¡¨ç¤ºUTCä¸‹-2å°æ—¶çš„æ—¶é—´åç§»(ç®€å•ç†è§£ä¸ºè¥¿2åŒº)ã€‚ åœ°ç†åŒºåŸŸ-ZoneRegion java.time.ZoneRegionæ˜¯java.time.ZoneIdå®ç°ç±»(ä¸è¿‡å…¶ä¿®é¥°ç¬¦ä¸ºdefaultï¼Œå› æ­¤æ— æ³•ç›´æ¥è®¿é—®ï¼Œåªèƒ½é€šè¿‡ZoneIdæ“ä½œ)ï¼Œè¡¨ç¤ºåœ°ç†åŒºåŸŸï¼Œæ ¼å¼æ˜¯ï¼šæ´²(å·ã€å›½å®¶)/åŸå¸‚ã€‚æ³¨é‡Šä¸­æåˆ°ï¼šæœ€å¸¸è§çš„åŒºåŸŸåˆ†ç±»æ˜¯æ—¶åŒºæ•°æ®åº“(TZDB)ï¼ŒTZDBä½¿ç”¨Europe/Parisâ€™å’Œâ€™Asia/Tokyoâ€™ç­‰å½¢å¼åŒºåˆ†åœ°åŒºã€‚ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼š 12345678910111213public class ZoneRegionMain &#123; public static void main(String[] args) throws Exception &#123; ZoneId zoneId = ZoneId.systemDefault(); System.out.println(zoneId); Set&lt;String&gt; availableZoneIds = ZoneId.getAvailableZoneIds(); for (String z : availableZoneIds) &#123; if (z.contains(\"Beijing\") || z.contains(\"BeiJing\")) &#123; System.out.println(z); &#125; &#125; &#125;&#125; æ‰§è¡Œåæ§åˆ¶å°è¾“å‡ºï¼š 1Asia/Shanghai å®é™…ä¸Šï¼Œæ‰§è¡Œè¿™ä¸ªæ–¹æ³•çš„æ—¶å€™ï¼Œç¬”è€…åœ¨å¹¿å·ï¼Œå¾—åˆ°çš„ç³»ç»Ÿé»˜è®¤zoneIdæ˜¯Asia/Shanghaiï¼Œå¹¶ä¸”é»˜è®¤åŠ è½½çš„åœ°ç†åŒºåŸŸä¸­æ²¡æœ‰åŒ—äº¬ç›¸å…³çš„zoneIdã€‚ å°ç»“ JSR-310ä¸­å¼•å…¥çš„æ—¶é—´APIç±»ZoneIdè¡¨ç¤ºæ—¶åŒºIDï¼Œå…·ä½“æœ‰ä¸¤ç§ç±»å‹ï¼šå›ºå®šæ—¶é—´åç§»é‡-ZoneOffsetå’Œåœ°ç†åŒºåŸŸ-ZoneRegionï¼Œè¿™ä¸¤ç§ç±»å‹å¯ä»¥å†ç»†åˆ†ä¸ºä¸‰ç§è¡¨ç¤ºæ–¹å¼ï¼š åœ°ç†åŒºåŸŸè¡¨ç¤ºï¼Œå¦‚ï¼šZoneId.of(&quot;Asia/Aden&quot;)ã€‚ GMT/UTCåç§»é‡è¯¦ç»†è¡¨ç¤ºï¼Œå¦‚ï¼šZoneId.of(&quot;UTC&quot;)ã€ZoneId.of(&quot;GMT+2&quot;)ã€‚ GMT/UTCåç§»é‡ç®€å•è¡¨ç¤ºï¼Œå¦‚ï¼šZoneId.of(&quot;Z&quot;)ã€ZoneId.of(&quot;+2:00&quot;)ã€‚ å‚è€ƒèµ„æ–™ï¼š ç»´åŸºç™¾ç§‘-Time zone ç»´åŸºç™¾ç§‘-ISO 8601 Bingäº’åŠ¨ç™¾ç§‘ç›¸å…³èµ„æ–™ Java 8: how to derive a ZoneId from ZoneOffset JDK11ç›¸å…³æºç  (æœ¬æ–‡å®Œ c-1-d e-a-20181223)","categories":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/tags/Java/"},{"name":"JSR-310","slug":"JSR-310","permalink":"http://throwable.club/blog/tags/JSR-310/"}]},{"title":"RabbitMQæ‰©å±•ä¹‹äº¤æ¢å™¨é—´çš„ç»‘å®š","slug":"rabbitmq-extension-exchange-binding","date":"2018-12-18T15:37:34.000Z","updated":"2018-12-18T15:40:44.922Z","comments":true,"path":"2018/12/18/rabbitmq-extension-exchange-binding/","link":"","permalink":"http://throwable.club/2018/12/18/rabbitmq-extension-exchange-binding/","excerpt":"","text":"RabbitMQæ‰©å±•ä¹‹äº¤æ¢å™¨é—´çš„ç»‘å®š æ¦‚è¦ AMQP-0-9-1ä¸­æä¾›äº†queue.bindæ–¹æ³•ç”¨äºç»‘å®šä¸€ä¸ªé˜Ÿåˆ—åˆ°ä¸€ä¸ªäº¤æ¢å™¨ï¼Œç„¶åå‘é€æ¶ˆæ¯çš„æ—¶å€™ï¼Œæ•°æ®æµæ€»æ˜¯å…ˆé€šè¿‡äº¤æ¢å™¨(source)æœ€ç»ˆåˆ°è¾¾ç›®æ ‡é˜Ÿåˆ—ä¸­(destination)ã€‚RabbitMQå®ç°äº†æ‰©å±•ï¼Œä¸ºäº¤æ¢å™¨æä¾›äº†ä¸€ä¸ªexchange.bindæ–¹æ³•ç”¨äºç»‘å®šä¸€ä¸ªäº¤æ¢å™¨åˆ°å¦ä¸€ä¸ªäº¤æ¢å™¨ã€‚äº¤æ¢å™¨ä¹‹é—´çš„ç»‘å®šå’Œé˜Ÿåˆ—ä¸äº¤æ¢å™¨çš„ç»‘å®šåœ¨è¯­ä¹‰ä¸Šæ˜¯ç›¸åŒçš„ï¼šå•å‘çš„ã€ä½¿ç”¨è·¯ç”±é”®å’Œå¤šç§äº¤æ¢å™¨ç±»å‹ã€‚è¿™ä¸€ç‚¹å…è®¸ä½¿ç”¨è€…åˆ›å»ºæ›´ä¸°å¯Œçš„è·¯ç”±æ‹“æ‰‘ã€‚exchange.bindæ–¹æ³•ä¸­çš„sourceå’Œdestinationåæ˜ äº†æ¶ˆæ¯çš„æµå‘ï¼šä»æº(source)äº¤æ¢å™¨åˆ°ç›®æ ‡(destination)äº¤æ¢å™¨ã€‚ åƒqueue.bindæ–¹æ³•ä¸€æ ·ï¼Œå¯ä»¥åœ¨ç›¸åŒçš„ç»‘å®šç«¯ç‚¹ä¸Šåˆ›å»ºå¤šä¸ªä¸åŒçš„äº¤æ¢å™¨ç»‘å®šï¼Œä¾‹å¦‚ï¼š exchange-source -&gt; exchange-destination-1 -&gt; queue-1ã€‚ exchange-source -&gt; exchange-destination-2 -&gt; queue-2ã€‚ exchange-source -&gt; exchange-destination-3 -&gt; queue-3ã€‚ RabbitMQåœ¨æ¶ˆæ¯ä¼ é€’æœŸé—´æ£€æµ‹å¹¶æ¶ˆé™¤å¾ªç¯ï¼Œå¹¶ç¡®ä¿åœ¨ä»»ä½•è·¯ç”±æ‹“æ‰‘ä¸Šä¼ é€’ç»™å®šè·¯ç”±çš„æ¯ä¸ªé˜Ÿåˆ—ï¼Œæ¯ä¸ªé˜Ÿåˆ—å°†åªæ¥æ”¶è¯¥æ¶ˆæ¯çš„ä¸€ä¸ªå‰¯æœ¬ã€‚ ä½¿ç”¨äº†auto-deleteå‚æ•°å£°æ˜çš„äº¤æ¢å™¨åªæœ‰å®ƒå…³è”çš„æ‰€æœ‰ç»‘å®šå…³ç³»éƒ½ç§»é™¤(ä¸ç®¡æ˜¯äº¤æ¢å™¨ä¹‹é—´çš„ç»‘å®šè¿˜æ˜¯äº¤æ¢å™¨å’Œé˜Ÿåˆ—çš„ç»‘å®š)ï¼Œå®ƒè‡ªèº«æ‰ä¼šè¢«åˆ é™¤ã€‚ä¸¾ä¸ªä¾‹å­ï¼š exchange-source -&gt; exchange-destination -&gt; queue-1ã€‚ å¦‚æœexchange-sourceè¢«åˆ é™¤æˆ–è€…è§£é™¤ä¸exchange-destinationçš„ç»‘å®šå…³ç³»åŒæ—¶exchange-destinationå’Œqueue-1è§£é™¤ç»‘å®šï¼Œè€Œexchange-destinationä½¿ç”¨äº†auto-deleteå‚æ•°å£°æ˜ï¼Œé‚£ä¹ˆexchange-destinationå°±ä¼šè¢«åˆ é™¤ã€‚ RabbitMQä¸­è¿˜æä¾›äº†ä¸€ä¸ªexchange.unbindæ–¹æ³•è¿›è¡Œäº¤æ¢å™¨ä¹‹é—´ç»‘å®šå…³ç³»çš„è§£é™¤ã€‚ ç¼–ç å®ç° 12345678910111213141516public class ExchangeBindingMain extends BaseChannelFactory &#123; public static void main(String[] args) throws Exception &#123; provideChannel(channel -&gt; &#123; channel.exchangeDeclare(\"exchange.source\", BuiltinExchangeType.DIRECT, true, false, null); channel.exchangeDeclare(\"exchange.destination\", BuiltinExchangeType.DIRECT, true, true, null); channel.queueDeclare(\"exchange.binding.queue\", true, false, false, null); channel.exchangeBind(\"exchange.destination\", \"exchange.source\", \"exchange.routingKey\"); channel.queueBind(\"exchange.binding.queue\", \"exchange.destination\", \"exchange.routingKey\"); channel.basicPublish(\"exchange.source\", \"exchange.routingKey\", MessageProperties.BASIC, \"message\".getBytes(StandardCharsets.UTF_8)); channel.exchangeUnbind(\"exchange.destination\", \"exchange.source\", \"exchange.routingKey\");// channel.exchangeDelete(\"exchange.source\"); channel.queueUnbind(\"exchange.binding.queue\", \"exchange.destination\", \"exchange.routingKey\"); &#125;); &#125;&#125; åœ¨è§£é™¤exchange.sourceå’Œexchange.destinationã€exchange.binding.queueå’Œexchange.destinationä¹‹é—´çš„ç»‘å®šåï¼Œexchange.destinationä¼šè‡ªåŠ¨åˆ é™¤ã€‚ (æœ¬æ–‡å®Œ e-a-20181218 c-1-d)","categories":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/categories/Middleware/"},{"name":"RabbitMQ","slug":"Middleware/RabbitMQ","permalink":"http://throwable.club/blog/categories/Middleware/RabbitMQ/"}],"tags":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/tags/Middleware/"},{"name":"RabbitMQ","slug":"RabbitMQ","permalink":"http://throwable.club/blog/tags/RabbitMQ/"}]},{"title":"åŸºäºSpringBootçš„Environmentæºç ç†è§£å®ç°åˆ†æ•£é…ç½®","slug":"spring-boot-environment-configuration-spread","date":"2018-12-16T14:41:46.000Z","updated":"2020-01-02T03:22:02.427Z","comments":true,"path":"2018/12/16/spring-boot-environment-configuration-spread/","link":"","permalink":"http://throwable.club/2018/12/16/spring-boot-environment-configuration-spread/","excerpt":"å‰æ org.springframework.core.env.Environmentæ˜¯å½“å‰åº”ç”¨è¿è¡Œç¯å¢ƒçš„å…¬å¼€æ¥å£ï¼Œä¸»è¦åŒ…æ‹¬åº”ç”¨ç¨‹åºè¿è¡Œç¯å¢ƒçš„ä¸¤ä¸ªå…³é”®æ–¹é¢ï¼šé…ç½®æ–‡ä»¶(profiles)å’Œå±æ€§ã€‚Environmentç»§æ‰¿è‡ªæ¥å£PropertyResolverï¼Œè€ŒPropertyResolveræä¾›äº†å±æ€§è®¿é—®çš„ç›¸å…³æ–¹æ³•ã€‚è¿™ç¯‡æ–‡ç« ä»æºç çš„è§’åº¦åˆ†æEnvironmentçš„å­˜å‚¨å®¹å™¨å’ŒåŠ è½½æµç¨‹ï¼Œç„¶ååŸºäºæºç çš„ç†è§£ç»™å‡ºä¸€ä¸ªç”Ÿäº§çº§åˆ«çš„æ‰©å±•ã€‚ æœ¬æ–‡è¾ƒé•¿ï¼Œè¯·ç”¨ä¸€ä¸ªèˆ’æœçš„å§¿åŠ¿é˜…è¯»ã€‚","text":"å‰æ org.springframework.core.env.Environmentæ˜¯å½“å‰åº”ç”¨è¿è¡Œç¯å¢ƒçš„å…¬å¼€æ¥å£ï¼Œä¸»è¦åŒ…æ‹¬åº”ç”¨ç¨‹åºè¿è¡Œç¯å¢ƒçš„ä¸¤ä¸ªå…³é”®æ–¹é¢ï¼šé…ç½®æ–‡ä»¶(profiles)å’Œå±æ€§ã€‚Environmentç»§æ‰¿è‡ªæ¥å£PropertyResolverï¼Œè€ŒPropertyResolveræä¾›äº†å±æ€§è®¿é—®çš„ç›¸å…³æ–¹æ³•ã€‚è¿™ç¯‡æ–‡ç« ä»æºç çš„è§’åº¦åˆ†æEnvironmentçš„å­˜å‚¨å®¹å™¨å’ŒåŠ è½½æµç¨‹ï¼Œç„¶ååŸºäºæºç çš„ç†è§£ç»™å‡ºä¸€ä¸ªç”Ÿäº§çº§åˆ«çš„æ‰©å±•ã€‚ æœ¬æ–‡è¾ƒé•¿ï¼Œè¯·ç”¨ä¸€ä¸ªèˆ’æœçš„å§¿åŠ¿é˜…è¯»ã€‚ Environmentç±»ä½“ç³» PropertyResolverï¼šæä¾›å±æ€§è®¿é—®åŠŸèƒ½ã€‚ ConfigurablePropertyResolverï¼šç»§æ‰¿è‡ªPropertyResolverï¼Œé¢å¤–ä¸»è¦æä¾›å±æ€§ç±»å‹è½¬æ¢(åŸºäºorg.springframework.core.convert.ConversionService)åŠŸèƒ½ã€‚ Environmentï¼šç»§æ‰¿è‡ªPropertyResolverï¼Œé¢å¤–æä¾›è®¿é—®å’Œåˆ¤æ–­profilesçš„åŠŸèƒ½ã€‚ ConfigurableEnvironmentï¼šç»§æ‰¿è‡ªConfigurablePropertyResolverå’ŒEnvironmentï¼Œå¹¶ä¸”æä¾›è®¾ç½®æ¿€æ´»çš„profileå’Œé»˜è®¤çš„profileçš„åŠŸèƒ½ã€‚ ConfigurableWebEnvironmentï¼šç»§æ‰¿è‡ªConfigurableEnvironmentï¼Œå¹¶ä¸”æä¾›é…ç½®Servletä¸Šä¸‹æ–‡å’ŒServletå‚æ•°çš„åŠŸèƒ½ã€‚ AbstractEnvironmentï¼šå®ç°äº†ConfigurableEnvironmentæ¥å£ï¼Œé»˜è®¤å±æ€§å’Œå­˜å‚¨å®¹å™¨çš„å®šä¹‰ï¼Œå¹¶ä¸”å®ç°äº†ConfigurableEnvironmentç§çš„æ–¹æ³•ï¼Œå¹¶ä¸”ä¸ºå­ç±»é¢„ç•™å¯è¦†ç›–äº†æ‰©å±•æ–¹æ³•ã€‚ StandardEnvironmentï¼šç»§æ‰¿è‡ªAbstractEnvironmentï¼ŒéServlet(Web)ç¯å¢ƒä¸‹çš„æ ‡å‡†Environmentå®ç°ã€‚ StandardServletEnvironmentï¼šç»§æ‰¿è‡ªStandardEnvironmentï¼ŒServlet(Web)ç¯å¢ƒä¸‹çš„æ ‡å‡†Environmentå®ç°ã€‚ reactiveç›¸å…³çš„æš‚æ—¶ä¸ç ”ç©¶ã€‚ Environmentæä¾›çš„æ–¹æ³• ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åœ¨SpringMVCé¡¹ç›®ä¸­å¯ç”¨åˆ°çš„æ˜¯StandardServletEnvironmentï¼Œå®ƒçš„çˆ¶æ¥å£é—®ConfigurableWebEnvironmentï¼Œæˆ‘ä»¬å¯ä»¥æŸ¥çœ‹æ­¤æ¥å£æä¾›çš„æ–¹æ³•ï¼š Environmentçš„å­˜å‚¨å®¹å™¨ Environmentçš„é™æ€å±æ€§å’Œå­˜å‚¨å®¹å™¨éƒ½æ˜¯åœ¨AbstractEnvironmentä¸­å®šä¹‰çš„ï¼ŒConfigurableWebEnvironmentæ¥å£æä¾›çš„getPropertySources()æ–¹æ³•å¯ä»¥è·å–åˆ°è¿”å›çš„MutablePropertySourceså®ä¾‹ï¼Œç„¶åæ·»åŠ é¢å¤–çš„PropertySourceã€‚å®é™…ä¸Šï¼ŒEnvironmentçš„å­˜å‚¨å®¹å™¨å°±æ˜¯org.springframework.core.env.PropertySourceçš„å­ç±»é›†åˆï¼ŒAbstractEnvironmentä¸­ä½¿ç”¨çš„å®ä¾‹æ˜¯org.springframework.core.env.MutablePropertySourcesï¼Œä¸‹é¢çœ‹ä¸‹PropertySourceçš„æºç ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647public abstract class PropertySource&lt;T&gt; &#123; protected final Log logger = LogFactory.getLog(getClass()); protected final String name; protected final T source; public PropertySource(String name, T source) &#123; Assert.hasText(name, \"Property source name must contain at least one character\"); Assert.notNull(source, \"Property source must not be null\"); this.name = name; this.source = source; &#125; @SuppressWarnings(\"unchecked\") public PropertySource(String name) &#123; this(name, (T) new Object()); &#125; public String getName() &#123; return this.name; &#125; public T getSource() &#123; return this.source; &#125; public boolean containsProperty(String name) &#123; return (getProperty(name) != null); &#125; @Nullable public abstract Object getProperty(String name); @Override public boolean equals(Object obj) &#123; return (this == obj || (obj instanceof PropertySource &amp;&amp; ObjectUtils.nullSafeEquals(this.name, ((PropertySource&lt;?&gt;) obj).name))); &#125; @Override public int hashCode() &#123; return ObjectUtils.nullSafeHashCode(this.name); &#125; //çœç•¥å…¶ä»–æ–¹æ³•å’Œå†…éƒ¨ç±»çš„æºç  &#125; æºç ç›¸å¯¹ç®€å•ï¼Œé¢„ç•™äº†ä¸€ä¸ªgetPropertyæŠ½è±¡æ–¹æ³•ç»™å­ç±»å®ç°ï¼Œé‡ç‚¹éœ€è¦å…³æ³¨çš„æ˜¯è¦†å†™äº†çš„equalså’ŒhashCodeæ–¹æ³•ï¼Œå®é™…ä¸Šåªå’Œnameå±æ€§ç›¸å…³ï¼Œè¿™ä¸€ç‚¹å¾ˆé‡è¦ï¼Œè¯´æ˜ä¸€ä¸ªPropertySourceå®ä¾‹ç»‘å®šåˆ°ä¸€ä¸ªå”¯ä¸€çš„nameï¼Œè¿™ä¸ªnameæœ‰ç‚¹åƒHashMapé‡Œé¢çš„keyï¼Œéƒ¨åˆ†ç§»é™¤ã€åˆ¤æ–­æ–¹æ³•éƒ½æ˜¯åŸºäºnameå±æ€§ã€‚PropertySourceçš„æœ€å¸¸ç”¨å­ç±»æ˜¯MapPropertySourceã€PropertiesPropertySourceã€ResourcePropertySourceã€StubPropertySourceã€ComparisonPropertySourceï¼š MapPropertySourceï¼šsourceæŒ‡å®šä¸ºMapå®ä¾‹çš„PropertySourceå®ç°ã€‚ PropertiesPropertySourceï¼šsourceæŒ‡å®šä¸ºMapå®ä¾‹çš„PropertySourceå®ç°ï¼Œå†…éƒ¨çš„Mapå®ä¾‹ç”±Propertieså®ä¾‹è½¬æ¢è€Œæ¥ã€‚ ResourcePropertySourceï¼šç»§æ‰¿è‡ªPropertiesPropertySourceï¼ŒsourceæŒ‡å®šä¸ºé€šè¿‡Resourceå®ä¾‹è½¬åŒ–ä¸ºPropertieså†è½¬æ¢ä¸ºMapå®ä¾‹ã€‚ StubPropertySourceï¼šPropertySourceçš„ä¸€ä¸ªå†…éƒ¨ç±»ï¼Œsourceè®¾ç½®ä¸ºnullï¼Œå®é™…ä¸Šå°±æ˜¯ç©ºå®ç°ã€‚ ComparisonPropertySourceï¼šç»§æ‰¿è‡ªComparisonPropertySourceï¼Œæ‰€æœ‰å±æ€§è®¿é—®æ–¹æ³•å¼ºåˆ¶æŠ›å‡ºå¼‚å¸¸ï¼Œä½œç”¨å°±æ˜¯ä¸€ä¸ªä¸å¯è®¿é—®å±æ€§çš„ç©ºå®ç°ã€‚ AbstractEnvironmentä¸­çš„å±æ€§å®šä¹‰ï¼š 123456789101112public static final String IGNORE_GETENV_PROPERTY_NAME = \"spring.getenv.ignore\";public static final String ACTIVE_PROFILES_PROPERTY_NAME = \"spring.profiles.active\";public static final String DEFAULT_PROFILES_PROPERTY_NAME = \"spring.profiles.default\";protected static final String RESERVED_DEFAULT_PROFILE_NAME = \"default\";private final Set&lt;String&gt; activeProfiles = new LinkedHashSet&lt;&gt;();private final Set&lt;String&gt; defaultProfiles = new LinkedHashSet&lt;&gt;(getReservedDefaultProfiles());private final MutablePropertySources propertySources = new MutablePropertySources(this.logger);private final ConfigurablePropertyResolver propertyResolver = new PropertySourcesPropertyResolver(this.propertySources); ä¸Šé¢çš„propertySources(MutablePropertySourcesç±»å‹)å±æ€§å°±æ˜¯ç”¨æ¥å­˜æ”¾PropertySourceåˆ—è¡¨çš„ï¼ŒPropertySourcesPropertyResolveræ˜¯ConfigurablePropertyResolverçš„å®ç°ï¼Œé»˜è®¤çš„profileå°±æ˜¯å­—ç¬¦ä¸²defaultã€‚MutablePropertySourcesçš„å†…éƒ¨å±æ€§å¦‚ä¸‹ï¼š 1private final List&lt;PropertySource&lt;?&gt;&gt; propertySourceList = new CopyOnWriteArrayList&lt;&gt;(); æ²¡é”™ï¼Œè¿™ä¸ªå°±æ˜¯æœ€åº•å±‚çš„å­˜å‚¨å®¹å™¨ï¼Œä¹Ÿå°±æ˜¯ç¯å¢ƒå±æ€§éƒ½æ˜¯å­˜æ”¾åœ¨ä¸€ä¸ªCopyOnWriteArrayList&lt;PropertySource&lt;?&gt;&gt;å®ä¾‹ä¸­ã€‚MutablePropertySourcesæ˜¯PropertySourcesçš„å­ç±»ï¼Œå®ƒæä¾›äº†get(String name)ã€addFirstã€addLastã€addBeforeã€addAfterã€removeã€replaceç­‰ä¾¿æ·æ–¹æ³•ï¼Œæ–¹ä¾¿æ“ä½œpropertySourceListé›†åˆçš„å…ƒç´ ï¼Œè¿™é‡ŒæŒ‘é€‰addBeforeçš„æºç åˆ†æï¼š 12345678910111213141516171819202122232425262728293031323334353637383940public void addBefore(String relativePropertySourceName, PropertySource&lt;?&gt; propertySource) &#123; if (logger.isDebugEnabled()) &#123; logger.debug(\"Adding PropertySource '\" + propertySource.getName() + \"' with search precedence immediately higher than '\" + relativePropertySourceName + \"'\"); &#125; //å‰ä¸€ä¸ªPropertySourceçš„nameæŒ‡å®šä¸ºrelativePropertySourceNameæ—¶å€™å¿…é¡»å’Œæ·»åŠ çš„PropertySourceçš„nameå±æ€§ä¸ç›¸åŒ assertLegalRelativeAddition(relativePropertySourceName, propertySource); //å°è¯•ç§»é™¤åŒåçš„PropertySource removeIfPresent(propertySource); //è·å–å‰ä¸€ä¸ªPropertySourceåœ¨CopyOnWriteArrayListä¸­çš„ç´¢å¼• int index = assertPresentAndGetIndex(relativePropertySourceName); //æ·»åŠ å½“å‰ä¼ å…¥çš„PropertySourceåˆ°æŒ‡å®šå‰ä¸€ä¸ªPropertySourceçš„ç´¢å¼•ï¼Œç›¸å½“äºrelativePropertySourceNameå¯¹åº”çš„PropertySourceåç§»åˆ°åŸæ¥ç´¢å¼•å€¼+1çš„ä½ç½® addAtIndex(index, propertySource);&#125;protected void assertLegalRelativeAddition(String relativePropertySourceName, PropertySource&lt;?&gt; propertySource) &#123; String newPropertySourceName = propertySource.getName(); if (relativePropertySourceName.equals(newPropertySourceName)) &#123; throw new IllegalArgumentException( \"PropertySource named '\" + newPropertySourceName + \"' cannot be added relative to itself\"); &#125;&#125;protected void removeIfPresent(PropertySource&lt;?&gt; propertySource) &#123; this.propertySourceList.remove(propertySource);&#125;private int assertPresentAndGetIndex(String name) &#123; int index = this.propertySourceList.indexOf(PropertySource.named(name)); if (index == -1) &#123; throw new IllegalArgumentException(\"PropertySource named '\" + name + \"' does not exist\"); &#125; return index;&#125;private void addAtIndex(int index, PropertySource&lt;?&gt; propertySource) &#123; //æ³¨æ„ï¼Œè¿™é‡Œä¼šå†æ¬¡å°è¯•ç§»é™¤åŒåçš„PropertySource removeIfPresent(propertySource); this.propertySourceList.add(index, propertySource);&#125; å¤§å¤šæ•°PropertySourceå­ç±»çš„ä¿®é¥°ç¬¦éƒ½æ˜¯publicï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ï¼Œè¿™é‡Œå†™ä¸ªå°demoï¼š 123456789101112MutablePropertySources mutablePropertySources = new MutablePropertySources();Map&lt;String, Object&gt; map = new HashMap&lt;&gt;(8);map.put(\"name\", \"throwable\");map.put(\"age\", 25);MapPropertySource mapPropertySource = new MapPropertySource(\"map\", map);mutablePropertySources.addLast(mapPropertySource);Properties properties = new Properties();PropertiesPropertySource propertiesPropertySource = new PropertiesPropertySource(\"prop\", properties);properties.put(\"name\", \"doge\");properties.put(\"gourp\", \"group-a\");mutablePropertySources.addBefore(\"map\", propertiesPropertySource);System.out.println(mutablePropertySources); EnvironmentåŠ è½½è¿‡ç¨‹æºç åˆ†æ EnvironmentåŠ è½½çš„æºç ä½äºSpringApplication#prepareEnvironmentï¼š 123456789101112131415161718192021private ConfigurableEnvironment prepareEnvironment( SpringApplicationRunListeners listeners, ApplicationArguments applicationArguments) &#123; // Create and configure the environment //åˆ›å»ºConfigurableEnvironmentå®ä¾‹ ConfigurableEnvironment environment = getOrCreateEnvironment(); //å¯åŠ¨å‚æ•°ç»‘å®šåˆ°ConfigurableEnvironmentä¸­ configureEnvironment(environment, applicationArguments.getSourceArgs()); //å‘å¸ƒConfigurableEnvironmentå‡†å¤‡å®Œæ¯•äº‹ä»¶ listeners.environmentPrepared(environment); //ç»‘å®šConfigurableEnvironmentåˆ°å½“å‰çš„SpringApplicationå®ä¾‹ä¸­ bindToSpringApplication(environment); //è¿™ä¸€æ­¥æ˜¯éSpringMVCé¡¹ç›®çš„å¤„ç†ï¼Œæš‚æ—¶å¿½ç•¥ if (this.webApplicationType == WebApplicationType.NONE) &#123; environment = new EnvironmentConverter(getClassLoader()) .convertToStandardEnvironmentIfNecessary(environment); &#125; //ç»‘å®šConfigurationPropertySourcesPropertySourceåˆ°ConfigurableEnvironmentä¸­ï¼Œnameä¸ºconfigurationPropertiesï¼Œå®ä¾‹æ˜¯SpringConfigurationPropertySourcesï¼Œå±æ€§å®é™…æ˜¯ConfigurableEnvironmentä¸­çš„MutablePropertySources ConfigurationPropertySources.attach(environment); return environment;&#125; è¿™é‡Œé‡ç‚¹çœ‹ä¸‹getOrCreateEnvironmentæ–¹æ³•ï¼š 1234567891011121314151617181920212223242526private ConfigurableEnvironment getOrCreateEnvironment() &#123; if (this.environment != null) &#123; return this.environment; &#125; //åœ¨SpringMVCé¡¹ç›®ï¼ŒConfigurableEnvironmentæ¥å£çš„å®ä¾‹å°±æ˜¯æ–°å»ºçš„StandardServletEnvironmentå®ä¾‹ if (this.webApplicationType == WebApplicationType.SERVLET) &#123; return new StandardServletEnvironment(); &#125; return new StandardEnvironment();&#125;//REACTIVE_WEB_ENVIRONMENT_CLASS=org.springframework.web.reactive.DispatcherHandler//MVC_WEB_ENVIRONMENT_CLASS=org.springframework.web.servlet.DispatcherServlet//MVC_WEB_ENVIRONMENT_CLASS=&#123;\"javax.servlet.Servlet\",\"org.springframework.web.context.ConfigurableWebApplicationContext\"&#125;//è¿™é‡Œï¼Œé»˜è®¤å°±æ˜¯WebApplicationType.SERVLETprivate WebApplicationType deduceWebApplicationType() &#123; if (ClassUtils.isPresent(REACTIVE_WEB_ENVIRONMENT_CLASS, null) &amp;&amp; !ClassUtils.isPresent(MVC_WEB_ENVIRONMENT_CLASS, null)) &#123; return WebApplicationType.REACTIVE; &#125; for (String className : WEB_ENVIRONMENT_CLASSES) &#123; if (!ClassUtils.isPresent(className, null)) &#123; return WebApplicationType.NONE; &#125; &#125; return WebApplicationType.SERVLET;&#125; è¿˜æœ‰ä¸€ä¸ªåœ°æ–¹è¦é‡ç‚¹å…³æ³¨ï¼šå‘å¸ƒConfigurableEnvironmentå‡†å¤‡å®Œæ¯•äº‹ä»¶listeners.environmentPrepared(environment)ï¼Œå®é™…ä¸Šè¿™é‡Œç”¨åˆ°äº†åŒæ­¥çš„EventBusï¼Œäº‹ä»¶çš„ç›‘å¬è€…æ˜¯ConfigFileApplicationListenerï¼Œå…·ä½“å¤„ç†é€»è¾‘æ˜¯onApplicationEnvironmentPreparedEventæ–¹æ³•ï¼š 123456789101112131415161718192021private void onApplicationEnvironmentPreparedEvent( ApplicationEnvironmentPreparedEvent event) &#123; List&lt;EnvironmentPostProcessor&gt; postProcessors = loadPostProcessors(); postProcessors.add(this); AnnotationAwareOrderComparator.sort(postProcessors); //éå†æ‰€æœ‰çš„EnvironmentPostProcessorå¯¹Environmentå®ä¾‹è¿›è¡Œå¤„ç† for (EnvironmentPostProcessor postProcessor : postProcessors) &#123; postProcessor.postProcessEnvironment(event.getEnvironment(), event.getSpringApplication()); &#125;&#125;//ä»spring.factoriesæ–‡ä»¶ä¸­åŠ è½½ï¼Œä¸€å…±æœ‰å››ä¸ªå®ä¾‹//ConfigFileApplicationListener//CloudFoundryVcapEnvironmentPostProcessor//SpringApplicationJsonEnvironmentPostProcessor//SystemEnvironmentPropertySourceEnvironmentPostProcessorList&lt;EnvironmentPostProcessor&gt; loadPostProcessors() &#123; return SpringFactoriesLoader.loadFactories(EnvironmentPostProcessor.class, getClass().getClassLoader());&#125; å®é™…ä¸Šï¼Œå¤„ç†å·¥ä½œå¤§éƒ¨åˆ†éƒ½åœ¨ConfigFileApplicationListenerä¸­ï¼Œè§å®ƒçš„postProcessEnvironmentæ–¹æ³•ï¼š 12345678910public void postProcessEnvironment(ConfigurableEnvironment environment, SpringApplication application) &#123; addPropertySources(environment, application.getResourceLoader());&#125;protected void addPropertySources(ConfigurableEnvironment environment, ResourceLoader resourceLoader) &#123; RandomValuePropertySource.addToEnvironment(environment); new Loader(environment, resourceLoader).load();&#125; ä¸»è¦çš„é…ç½®ç¯å¢ƒåŠ è½½é€»è¾‘åœ¨å†…éƒ¨ç±»Loaderï¼ŒLoaderä¼šåŒ¹é…å¤šä¸ªè·¯å¾„ä¸‹çš„æ–‡ä»¶æŠŠå±æ€§åŠ è½½åˆ°ConfigurableEnvironmentä¸­ï¼ŒåŠ è½½å™¨ä¸»è¦æ˜¯PropertySourceLoaderçš„å®ä¾‹ï¼Œä¾‹å¦‚æˆ‘ä»¬ç”¨åˆ°application-${profile}.yamlæ–‡ä»¶åšåº”ç”¨ä¸»é…ç½®æ–‡ä»¶ï¼Œä½¿ç”¨çš„æ˜¯YamlPropertySourceLoaderï¼Œè¿™ä¸ªæ—¶å€™activeProfilesä¹Ÿä¼šè¢«è®¾ç½®åˆ°ConfigurableEnvironmentä¸­ã€‚åŠ è½½å®Œæ¯•ä¹‹åï¼ŒConfigurableEnvironmentä¸­åŸºæœ¬åŒ…å«äº†æ‰€æœ‰éœ€è¦åŠ è½½çš„å±æ€§(activeProfilesæ˜¯è¿™ä¸ªæ—¶å€™è¢«å†™å…¥ConfigurableEnvironment)ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå‡ ä¹æ‰€æœ‰å±æ€§éƒ½æ˜¯key-valueå½¢å¼å­˜å‚¨ï¼Œå¦‚xxx.yyyy.zzzzz=valueã€xxx.yyyy[0].zzzzz=value-1ã€xxx.yyyy[1].zzzzz=value-2ã€‚Loaderä¸­çš„é€»è¾‘ç›¸å¯¹å¤æ‚ï¼Œæœ‰æ¯”è¾ƒå¤šçš„éå†å’Œè¿‡æ»¤æ¡ä»¶ï¼Œè¿™é‡Œä¸åšå±•å¼€ã€‚ Environmentå±æ€§è®¿é—®æºç åˆ†æ ä¸Šæ–‡æåˆ°è¿‡ï¼Œéƒ½æ˜¯å§”æ‰˜åˆ°PropertySourcesPropertyResolverï¼Œå…ˆçœ‹å®ƒçš„æ„é€ å‡½æ•°ï¼š 123456@Nullableprivate final PropertySources propertySources;public PropertySourcesPropertyResolver(@Nullable PropertySources propertySources) &#123; this.propertySources = propertySources;&#125; åªä¾èµ–äºä¸€ä¸ªPropertySourceså®ä¾‹ï¼Œåœ¨SpringBooté¡¹ç›®ä¸­å°±æ˜¯MutablePropertySourcesçš„å®ä¾‹ã€‚é‡ç‚¹åˆ†æä¸€ä¸‹æœ€å¤æ‚çš„ä¸€ä¸ªæ–¹æ³•ï¼š 1234567891011121314151617181920212223242526protected &lt;T&gt; T getProperty(String key, Class&lt;T&gt; targetValueType, boolean resolveNestedPlaceholders) &#123; if (this.propertySources != null) &#123; //éå†æ‰€æœ‰çš„PropertySource for (PropertySource&lt;?&gt; propertySource : this.propertySources) &#123; if (logger.isTraceEnabled()) &#123; logger.trace(\"Searching for key '\" + key + \"' in PropertySource '\" + propertySource.getName() + \"'\"); &#125; Object value = propertySource.getProperty(key); //é€‰ç”¨ç¬¬ä¸€ä¸ªä¸ä¸ºnullçš„åŒ¹é…keyçš„å±æ€§å€¼ if (value != null) &#123; if (resolveNestedPlaceholders &amp;&amp; value instanceof String) &#123; //å¤„ç†å±æ€§å ä½ç¬¦ï¼Œå¦‚$&#123;server.port&#125;ï¼Œåº•å±‚å§”æ‰˜åˆ°PropertyPlaceholderHelperå®Œæˆ value = resolveNestedPlaceholders((String) value); &#125; logKeyFound(key, propertySource, value); //å¦‚æœéœ€è¦çš„è¯ï¼Œè¿›è¡Œä¸€æ¬¡ç±»å‹è½¬æ¢ï¼Œåº•å±‚å§”æ‰˜åˆ°DefaultConversionServiceå®Œæˆ return convertValueIfNecessary(value, targetValueType); &#125; &#125; &#125; if (logger.isDebugEnabled()) &#123; logger.debug(\"Could not find key '\" + key + \"' in any property source\"); &#125; return null;&#125; è¿™é‡Œçš„æºç å‘Šè¯‰æˆ‘ä»¬ï¼Œå¦‚æœå‡ºç°å¤šä¸ªPropertySourceä¸­å­˜åœ¨åŒåçš„keyï¼Œè¿”å›çš„æ˜¯ç¬¬ä¸€ä¸ªPropertySourceå¯¹åº”keyçš„å±æ€§å€¼çš„å¤„ç†ç»“æœï¼Œå› æ­¤æˆ‘ä»¬å¦‚æœéœ€è¦è‡ªå®šä¹‰ä¸€äº›ç¯å¢ƒå±æ€§ï¼Œéœ€è¦ååˆ†æ¸…æ¥šå„ä¸ªPropertySourceçš„é¡ºåºã€‚ æ‰©å±•-å®ç°åˆ†æ•£é…ç½® åœ¨ä¸ä½¿ç”¨SpringCloudé…ç½®ä¸­å¿ƒçš„æƒ…å†µä¸‹ï¼Œä¸€èˆ¬çš„SpringBooté¡¹ç›®çš„é…ç½®æ–‡ä»¶å¦‚ä¸‹ï¼š 123456- src - main - resources - application-prod.yaml - application-dev.yaml - application-test.yaml éšç€é¡¹ç›®å‘å±•ï¼Œé…ç½®é¡¹è¶Šæ¥è¶Šå¤šï¼Œå¯¼è‡´äº†application-${profile}.yamlè¿…é€Ÿè†¨èƒ€ï¼Œå¤§çš„é…ç½®æ–‡ä»¶ç”šè‡³è¶…è¿‡ä¸€åƒè¡Œï¼Œä¸ºäº†ç®€åŒ–å’Œåˆ’åˆ†ä¸åŒåŠŸèƒ½çš„é…ç½®ï¼Œå¯ä»¥è€ƒè™‘æŠŠé…ç½®æ–‡ä»¶æ‹†åˆ†å¦‚ä¸‹ï¼š 12345678910111213141516171819- src - main - resources - profiles - dev - business.yaml - mq.json - datasource.properties - prod - business.yaml - mq.json - datasource.properties - test - business.yaml - mq.json - datasource.properties - application-prod.yaml - application-dev.yaml - application-test.yaml å¤–å±‚çš„application-${profile}.yamlåªç•™ä¸‹é¡¹ç›®çš„æ ¸å¿ƒé…ç½®å¦‚server.portç­‰ï¼Œå…¶ä»–é…ç½®æ‰“æ•£æ”¾åœ¨/profiles/${profile}/å„è‡ªçš„é…ç½®æ–‡ä»¶ä¸­ã€‚å®ç°æ–¹å¼æ˜¯ï¼šä¾æ®å½“å‰é…ç½®çš„spring.profiles.activeå±æ€§ï¼Œè¯»å–ç±»è·¯å¾„ä¸­æŒ‡å®šæ–‡ä»¶å¤¹ä¸‹çš„é…ç½®æ–‡ä»¶ä¸­ï¼ŒåŠ è½½åˆ°Environmentä¸­ï¼Œéœ€è¦æ³¨æ„è¿™ä¸€ä¸ªåŠ è½½æ­¥éª¤å¿…é¡»åœ¨Springåˆ·æ–°ä¸Šä¸‹æ–‡æ–¹æ³•æœ€åä¸€æ­¥finishRefresh()ä¹‹å‰å®Œæˆï¼Œå¦åˆ™æœ‰å¯èƒ½ä¼šå½±å“åˆ°å ä½ç¬¦å±æ€§çš„è‡ªåŠ¨è£…é…(ä¾‹å¦‚ä½¿ç”¨äº†@Value(&quot;${filed}&quot;))ã€‚ å…ˆå®šä¹‰ä¸€ä¸ªå±æ€§æ¢ç´¢è€…æ¥å£ï¼š 12345678910111213141516171819public interface PropertySourceDetector &#123; /** * è·å–æ”¯æŒçš„æ–‡ä»¶åç¼€æ•°ç»„ * * @return String[] */ String[] getFileExtensions(); /** * åŠ è½½ç›®æ ‡æ–‡ä»¶å±æ€§åˆ°ç¯å¢ƒä¸­ * * @param environment environment * @param name name * @param resource resource * @throws IOException IOException */ void load(ConfigurableEnvironment environment, String name, Resource resource) throws IOException;&#125; ç„¶åéœ€è¦ä¸€ä¸ªæŠ½è±¡å±æ€§æ¢ç´¢è€…æŠŠResourceè½¬æ¢ä¸ºå­—ç¬¦ä¸²ï¼Œé¢å¤–æä¾›Mapçš„ç¼©è¿›ã€æ·»åŠ PropertySourceåˆ°Environmentç­‰æ–¹æ³•ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859public abstract class AbstractPropertySourceDetector implements PropertySourceDetector &#123; private static final String SERVLET_ENVIRONMENT_CLASS = \"org.springframework.web.\" + \"context.support.StandardServletEnvironment\"; public boolean support(String fileExtension) &#123; String[] fileExtensions = getFileExtensions(); return null != fileExtensions &amp;&amp; Arrays.stream(fileExtensions).anyMatch(extension -&gt; extension.equals(fileExtension)); &#125; private String findPropertySource(MutablePropertySources sources) &#123; if (ClassUtils.isPresent(SERVLET_ENVIRONMENT_CLASS, null) &amp;&amp; sources .contains(StandardServletEnvironment.JNDI_PROPERTY_SOURCE_NAME)) &#123; return StandardServletEnvironment.JNDI_PROPERTY_SOURCE_NAME; &#125; return StandardEnvironment.SYSTEM_PROPERTIES_PROPERTY_SOURCE_NAME; &#125; protected void addPropertySource(ConfigurableEnvironment environment, PropertySource&lt;?&gt; source) &#123; MutablePropertySources sources = environment.getPropertySources(); String name = findPropertySource(sources); if (sources.contains(name)) &#123; sources.addBefore(name, source); &#125; else &#123; sources.addFirst(source); &#125; &#125; protected Map&lt;String, Object&gt; flatten(Map&lt;String, Object&gt; map) &#123; Map&lt;String, Object&gt; result = new LinkedHashMap&lt;&gt;(); flatten(null, result, map); return result; &#125; private void flatten(String prefix, Map&lt;String, Object&gt; result, Map&lt;String, Object&gt; map) &#123; String namePrefix = (prefix != null ? prefix + \".\" : \"\"); map.forEach((key, value) -&gt; extract(namePrefix + key, result, value)); &#125; @SuppressWarnings(\"unchecked\") private void extract(String name, Map&lt;String, Object&gt; result, Object value) &#123; if (value instanceof Map) &#123; flatten(name, result, (Map&lt;String, Object&gt;) value); &#125; else if (value instanceof Collection) &#123; int index = 0; for (Object object : (Collection&lt;Object&gt;) value) &#123; extract(name + \"[\" + index + \"]\", result, object); index++; &#125; &#125; else &#123; result.put(name, value); &#125; &#125; protected String getContentStringFromResource(Resource resource) throws IOException &#123; return StreamUtils.copyToString(resource.getInputStream(), Charset.forName(\"UTF-8\")); &#125;&#125; ä¸Šé¢çš„æ–¹æ³•å‚è€ƒSpringApplicationJsonEnvironmentPostProcessorï¼Œç„¶åç¼–å†™å„ç§ç±»å‹é…ç½®å±æ€§æ¢ç´¢è€…çš„å®ç°ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859//Json@Slf4jpublic class JsonPropertySourceDetector extends AbstractPropertySourceDetector &#123; private static final JsonParser JSON_PARSER = JsonParserFactory.getJsonParser(); @Override public String[] getFileExtensions() &#123; return new String[]&#123;\"json\"&#125;; &#125; @Override public void load(ConfigurableEnvironment environment, String name, Resource resource) throws IOException &#123; try &#123; Map&lt;String, Object&gt; map = JSON_PARSER.parseMap(getContentStringFromResource(resource)); Map&lt;String, Object&gt; target = flatten(map); addPropertySource(environment, new MapPropertySource(name, target)); &#125; catch (Exception e) &#123; log.warn(\"åŠ è½½Jsonæ–‡ä»¶å±æ€§åˆ°ç¯å¢ƒå˜é‡å¤±è´¥,name = &#123;&#125;,resource = &#123;&#125;\", name, resource); &#125; &#125;&#125;//Propertiespublic class PropertiesPropertySourceDetector extends AbstractPropertySourceDetector &#123; @Override public String[] getFileExtensions() &#123; return new String[]&#123;\"properties\", \"conf\"&#125;; &#125; @SuppressWarnings(\"unchecked\") @Override public void load(ConfigurableEnvironment environment, String name, Resource resource) throws IOException &#123; Map map = PropertiesLoaderUtils.loadProperties(resource); addPropertySource(environment, new MapPropertySource(name, map)); &#125;&#125;//Yaml@Slf4jpublic class YamlPropertySourceDetector extends AbstractPropertySourceDetector &#123; private static final JsonParser YAML_PARSER = new YamlJsonParser(); @Override public String[] getFileExtensions() &#123; return new String[]&#123;\"yaml\", \"yml\"&#125;; &#125; @Override public void load(ConfigurableEnvironment environment, String name, Resource resource) throws IOException &#123; try &#123; Map&lt;String, Object&gt; map = YAML_PARSER.parseMap(getContentStringFromResource(resource)); Map&lt;String, Object&gt; target = flatten(map); addPropertySource(environment, new MapPropertySource(name, target)); &#125; catch (Exception e) &#123; log.warn(\"åŠ è½½Yamlæ–‡ä»¶å±æ€§åˆ°ç¯å¢ƒå˜é‡å¤±è´¥,name = &#123;&#125;,resource = &#123;&#125;\", name, resource); &#125; &#125;&#125; å­ç±»çš„å…¨éƒ¨PropertySourceéƒ½æ˜¯MapPropertySourceï¼Œnameä¸ºæ–‡ä»¶çš„åç§°ï¼Œæ‰€æœ‰PropertySourceéƒ½ç”¨addBefore()æ–¹æ³•æ’å…¥åˆ°systemPropertiesçš„å‰é¢ï¼Œä¸»è¦æ˜¯ä¸ºäº†æé«˜åŒ¹é…å±æ€§çš„ä¼˜å…ˆçº§ã€‚æ¥ç€éœ€è¦å®šä¹‰ä¸€ä¸ªå±æ€§æ¢ç´¢è€…çš„åˆæˆç±»ç”¨æ¥è£…è½½æ‰€æœ‰çš„å­ç±»ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647public class PropertySourceDetectorComposite implements PropertySourceDetector &#123; private static final String DEFAULT_SUFFIX = \"properties\"; private final List&lt;AbstractPropertySourceDetector&gt; propertySourceDetectors = new ArrayList&lt;&gt;(); public void addPropertySourceDetector(AbstractPropertySourceDetector sourceDetector) &#123; propertySourceDetectors.add(sourceDetector); &#125; public void addPropertySourceDetectors(List&lt;AbstractPropertySourceDetector&gt; sourceDetectors) &#123; propertySourceDetectors.addAll(sourceDetectors); &#125; public List&lt;AbstractPropertySourceDetector&gt; getPropertySourceDetectors() &#123; return Collections.unmodifiableList(propertySourceDetectors); &#125; @Override public String[] getFileExtensions() &#123; List&lt;String&gt; fileExtensions = new ArrayList&lt;&gt;(8); for (AbstractPropertySourceDetector propertySourceDetector : propertySourceDetectors) &#123; fileExtensions.addAll(Arrays.asList(propertySourceDetector.getFileExtensions())); &#125; return fileExtensions.toArray(new String[0]); &#125; @Override public void load(ConfigurableEnvironment environment, String name, Resource resource) throws IOException &#123; if (resource.isFile()) &#123; String fileName = resource.getFile().getName(); int index = fileName.lastIndexOf(\".\"); String suffix; if (-1 == index) &#123; //å¦‚æœæ–‡ä»¶æ²¡æœ‰åç¼€,å½“ä½œpropertieså¤„ç† suffix = DEFAULT_SUFFIX; &#125; else &#123; suffix = fileName.substring(index + 1); &#125; for (AbstractPropertySourceDetector propertySourceDetector : propertySourceDetectors) &#123; if (propertySourceDetector.support(suffix)) &#123; propertySourceDetector.load(environment, name, resource); return; &#125; &#125; &#125; &#125;&#125; æœ€åæ·»åŠ ä¸€ä¸ªé…ç½®ç±»ä½œä¸ºå…¥å£ï¼š 1234567891011121314151617181920212223242526272829303132333435363738public class PropertySourceDetectorConfiguration implements ImportBeanDefinitionRegistrar &#123; private static final String PATH_PREFIX = \"profiles\"; @Override public void registerBeanDefinitions(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry) &#123; DefaultListableBeanFactory beanFactory = (DefaultListableBeanFactory) registry; ConfigurableEnvironment environment = beanFactory.getBean(ConfigurableEnvironment.class); List&lt;AbstractPropertySourceDetector&gt; propertySourceDetectors = new ArrayList&lt;&gt;(); configurePropertySourceDetectors(propertySourceDetectors, beanFactory); PropertySourceDetectorComposite propertySourceDetectorComposite = new PropertySourceDetectorComposite(); propertySourceDetectorComposite.addPropertySourceDetectors(propertySourceDetectors); String[] activeProfiles = environment.getActiveProfiles(); ResourcePatternResolver resourcePatternResolver = new PathMatchingResourcePatternResolver(); try &#123; for (String profile : activeProfiles) &#123; String location = PATH_PREFIX + File.separator + profile + File.separator + \"*\"; Resource[] resources = resourcePatternResolver.getResources(location); for (Resource resource : resources) &#123; propertySourceDetectorComposite.load(environment, resource.getFilename(), resource); &#125; &#125; &#125; catch (IOException e) &#123; throw new IllegalStateException(e); &#125; &#125; private void configurePropertySourceDetectors(List&lt;AbstractPropertySourceDetector&gt; propertySourceDetectors, DefaultListableBeanFactory beanFactory) &#123; Map&lt;String, AbstractPropertySourceDetector&gt; beansOfType = beanFactory.getBeansOfType(AbstractPropertySourceDetector.class); for (Map.Entry&lt;String, AbstractPropertySourceDetector&gt; entry : beansOfType.entrySet()) &#123; propertySourceDetectors.add(entry.getValue()); &#125; propertySourceDetectors.add(new JsonPropertySourceDetector()); propertySourceDetectors.add(new YamlPropertySourceDetector()); propertySourceDetectors.add(new PropertiesPropertySourceDetector()); &#125;&#125; å‡†å¤‡å°±ç»ªï¼Œåœ¨ç¤ºä¾‹é¡¹ç›®çš„/resources/profiles/devç›®å½•ä¸‹é¢æ·»åŠ ä¸¤ä¸ªæ–‡ä»¶app.jsonå’Œconfï¼š 123456789//app.jsonæ–‡ä»¶å†…å®¹&#123; \"app\": &#123; \"name\": \"throwable\", \"age\": 25 &#125;&#125;//confæ–‡ä»¶å†…å®¹name=doge é¡¹ç›®çš„application.yamlæ·»åŠ å±æ€§spring.profiles.active: devï¼Œæœ€åæ·»åŠ ä¸€ä¸ªCommandLineRunnerçš„å®ç°ç”¨æ¥è§‚å¯Ÿæ•°æ®ï¼š 12345678910111213141516@Slf4j@Componentpublic class CustomCommandLineRunner implements CommandLineRunner &#123; @Value(\"$&#123;app.name&#125;\") String name; @Value(\"$&#123;app.age&#125;\") Integer age; @Autowired ConfigurableEnvironment configurableEnvironment; @Override public void run(String... args) throws Exception &#123; log.info(\"name = &#123;&#125;,age = &#123;&#125;\", name, age); &#125;&#125; è‡ªåŠ¨è£…é…çš„å±æ€§å€¼å’ŒEnvironmentå®ä¾‹ä¸­çš„å±æ€§å’Œé¢„æœŸä¸€æ ·ï¼Œæ”¹é€ æ˜¯æˆåŠŸçš„ã€‚ å°ç»“ Springä¸­çš„ç¯å¢ƒå±æ€§ç®¡ç†çš„æºç ä¸ªäººè®¤ä¸ºæ˜¯æœ€æ¸…æ™°å’Œç®€å•çš„ï¼šä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®è½¬åŒ–ä¸ºkey-valueç»“æ„ï¼Œkey-valueç»“æ„å­˜æ”¾åœ¨ä¸€ä¸ªPropertySourceå®ä¾‹ä¸­ï¼Œç„¶åå¾—åˆ°çš„å¤šä¸ªPropertySourceå®ä¾‹å­˜æ”¾åœ¨ä¸€ä¸ªCopyOnWriteArrayListä¸­ï¼Œå±æ€§è®¿é—®çš„æ—¶å€™æ€»æ˜¯éå†CopyOnWriteArrayListä¸­çš„PropertySourceè¿›è¡ŒåŒ¹é…ã€‚å¯èƒ½ç›¸å¯¹å¤æ‚çš„å°±æ˜¯å ä½ç¬¦çš„è§£æå’Œå‚æ•°ç±»å‹çš„è½¬æ¢ï¼Œåè€…ç‰µè¿åˆ°Converterä½“ç³»ï¼Œè¿™äº›ä¸åœ¨æœ¬æ–‡çš„è®¨è®ºèŒƒå›´å†…ã€‚æœ€åé™„ä¸Šä¸€å¼ Environmentå­˜å‚¨å®¹å™¨çš„ç¤ºä¾‹å›¾ï¼š å‚è€ƒèµ„æ–™ï¼š spring-boot-starter-web:2.0.3.RELEASEæºç ã€‚ (æœ¬æ–‡å®Œ r-a-20181216)","categories":[{"name":"Spring","slug":"Spring","permalink":"http://throwable.club/blog/categories/Spring/"},{"name":"SpringBoot","slug":"Spring/SpringBoot","permalink":"http://throwable.club/blog/categories/Spring/SpringBoot/"}],"tags":[{"name":"Spring","slug":"Spring","permalink":"http://throwable.club/blog/tags/Spring/"},{"name":"SpringBoot","slug":"SpringBoot","permalink":"http://throwable.club/blog/tags/SpringBoot/"}]},{"title":"CGLIBåŠ¨æ€ä»£ç†åŸç†åˆ†æ","slug":"cglib-dynamic-proxy-analyze","date":"2018-12-16T09:10:39.000Z","updated":"2018-12-16T09:13:03.952Z","comments":true,"path":"2018/12/16/cglib-dynamic-proxy-analyze/","link":"","permalink":"http://throwable.club/2018/12/16/cglib-dynamic-proxy-analyze/","excerpt":"","text":"CGLIBåŠ¨æ€ä»£ç†åŸç†åˆ†æ å‰æ å‰ä¸€ç¯‡æ–‡ç« ä»‹ç»äº†CGLIBä¸­å¸¸ç”¨çš„APIï¼Œå®é™…ä¸Šä½¿ç”¨äº†Enhancerå’ŒMethodInterceptorä¹‹åä¼šç”Ÿæˆä»£ç†å­ç±»ï¼Œè¿™ç¯‡æ–‡ç« å°±æ˜¯åˆ†æä¸€ä¸‹CGLIBåŠ¨æ€ä»£ç†çš„åŸç†ã€‚ CGLIBåŠ¨æ€ä»£ç†åŸç†åˆ†æ æˆ‘ä»¬ç»å¸¸è¯´CGLIBçš„åŠ¨æ€ä»£ç†çš„åº•å±‚é€šè¿‡è¢«ä»£ç†ç±»ç”Ÿæˆä»£ç†å­ç±»å®ç°çš„ï¼Œé‚£ä¹ˆä¸‹é¢æˆ‘ä»¬å°±åˆ†æä¸€ä¸‹ç”Ÿæˆçš„å­ç±»åˆ°åº•æ˜¯ä»€ä¹ˆæ ·çš„ã€‚å¼€å¯CGLIBçš„debugæ¨¡å¼ï¼Œè¾“å‡ºå®ƒç”Ÿæˆçš„ç±»åˆ°æŒ‡å®šçš„ç›®å½•ï¼š 12345678910111213141516171819202122232425262728public class DebuggingCglibDemo &#123; private static final String METHOD_NAME = \"sayHello\"; public static void main(String[] args) throws Exception &#123; String location = DebuggingCglibDemo.class.getResource(\"\").getPath() + \"debugging/\"; System.out.println(\"location -&gt; \" + location); System.setProperty(DebuggingClassWriter.DEBUG_LOCATION_PROPERTY, location); Enhancer enhancer = new Enhancer(); enhancer.setSuperclass(SampleClass.class); enhancer.setCallback(new MethodInterceptor() &#123; @Override public Object intercept(Object obj, Method method, Object[] objects, MethodProxy methodProxy) throws Throwable &#123; Object result; if (METHOD_NAME.equals(method.getName())) &#123; System.out.println(\"Before invoking sayHello...\"); result = methodProxy.invokeSuper(obj, objects); System.out.println(\"After invoking sayHello...\"); &#125; else &#123; result = methodProxy.invokeSuper(obj, objects); &#125; return result; &#125; &#125;); SampleClass sampleClass = (SampleClass) enhancer.create(); System.out.println(sampleClass.sayHello(\"throwable\")); &#125;&#125; è¾“å‡ºç»“æœï¼š 12345location -&gt; /D:/Projects/cglib-seed/target/classes/club/throwable/cglib/debugging/CGLIB debugging enabled, writing to '/D:/Projects/cglib-seed/target/classes/club/throwable/cglib/debugging/'Before invoking sayHello...After invoking sayHello...throwable say hello! è¿™ä¸ªæ—¶å€™ï¼Œçœ‹ä¸‹targetä¸‹é¢ç”Ÿæˆçš„ç±»å¦‚ä¸‹ï¼š ä¸€å…±æœ‰äº”ä¸ªç±»ï¼š ../net.sf.cglibåŒ…ä¸‹ï¼š MethodWrapper$MethodWrapperKey$$KeyFactoryByCGLIB$$d45e49f7.class Enhancer$EnhancerKey$$KeyFactoryByCGLIB$$7fb24d72.class è¿™ä¸¤ä¸ªç±»ä¸»è¦å¾ˆç¼“å­˜çš„Keyç›¸å…³ï¼Œè¿™é‡Œä¸åšè¯¦ç»†å±•å¼€ã€‚ ç”¨æˆ·è‡ªå®šä¹‰åŒ…../club/throwable/cglibåŒ…ä¸‹ï¼š SampleClass$$EnhancerByCGLIB$$53c7afed$$FastClassByCGLIB$$da5c8621.class SampleClass$$EnhancerByCGLIB$$53c7afed.class SampleClass$$FastClassByCGLIB$$cf1a549b.class è¿™ä¸‰ä¸ªå°±æ˜¯å®é™…ä½¿ç”¨åˆ°çš„å­ç±»ï¼Œå…¶ä¸­æœ‰ä¸€ä¸ªæ˜¯è¢«ä»£ç†ç±»çš„ç›´æ¥å­ç±»SampleClass$$EnhancerByCGLIB$$53c7afedï¼Œå…¶ä»–çš„ä¸¤ä¸ªæ˜¯FastClassã€‚ æ¥ç€æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹SampleClass$$EnhancerByCGLIB$$53c7afedè¿™ä¸ªç±»çš„æºç ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243ä¸JavaåŸç”Ÿä»£ç†ç±»ä¼¼ï¼Œä»ç„¶ä»¥é™æ€å˜é‡ä¿å­˜äº†æŒ‡å‘ä»£ç†æ–¹æ³•çš„å¼•ç”¨ private boolean CGLIB$BOUND; public static Object CGLIB$FACTORY_DATA; private static final ThreadLocal CGLIB$THREAD_CALLBACKS; private static final Callback[] CGLIB$STATIC_CALLBACKS; private MethodInterceptor CGLIB$CALLBACK_0; private static Object CGLIB$CALLBACK_FILTER; //æ¯ä¸ªå‡½æ•°æœ‰ä¸¤ä¸ªåå°„æ–¹æ³•ï¼Œä¸€ä¸ªæ˜¯é€šè¿‡åŸç”Ÿåå°„è·å¾—çš„ï¼Œå¦å¤–ä¸€ä¸ªæ˜¯é€šè¿‡Cglibæ„å»ºçš„ã€‚ private static final Method CGLIB$sayHello$0$Method; private static final MethodProxy CGLIB$sayHello$0$Proxy; private static final Object[] CGLIB$emptyArgs; private static final Method CGLIB$equals$1$Method; private static final MethodProxy CGLIB$equals$1$Proxy; private static final Method CGLIB$toString$2$Method; private static final MethodProxy CGLIB$toString$2$Proxy; private static final Method CGLIB$hashCode$3$Method; private static final MethodProxy CGLIB$hashCode$3$Proxy; private static final Method CGLIB$clone$4$Method; private static final MethodProxy CGLIB$clone$4$Proxy; //è¿™é‡Œé€šè¿‡é™æ€ä»£ç å—åˆå§‹åŒ–ä¸Šé¢ç”¨åˆ°çš„é™æ€å˜é‡ï¼Œä¸»è¦ä½¿ç”¨åˆ°åå°„ static void CGLIB$STATICHOOK1() &#123; CGLIB$THREAD_CALLBACKS = new ThreadLocal(); CGLIB$emptyArgs = new Object[0]; Class var0 = Class.forName(\"club.throwable.cglib.SampleClass$$EnhancerByCGLIB$$53c7afed\"); Class var1; Method[] var10000 = ReflectUtils.findMethods(new String[]&#123;\"equals\", \"(Ljava/lang/Object;)Z\", \"toString\", \"()Ljava/lang/String;\", \"hashCode\", \"()I\", \"clone\", \"()Ljava/lang/Object;\"&#125;, (var1 = Class.forName(\"java.lang.Object\")).getDeclaredMethods()); CGLIB$equals$1$Method = var10000[0]; CGLIB$equals$1$Proxy = MethodProxy.create(var1, var0, \"(Ljava/lang/Object;)Z\", \"equals\", \"CGLIB$equals$1\"); CGLIB$toString$2$Method = var10000[1]; CGLIB$toString$2$Proxy = MethodProxy.create(var1, var0, \"()Ljava/lang/String;\", \"toString\", \"CGLIB$toString$2\"); CGLIB$hashCode$3$Method = var10000[2]; CGLIB$hashCode$3$Proxy = MethodProxy.create(var1, var0, \"()I\", \"hashCode\", \"CGLIB$hashCode$3\"); CGLIB$clone$4$Method = var10000[3]; CGLIB$clone$4$Proxy = MethodProxy.create(var1, var0, \"()Ljava/lang/Object;\", \"clone\", \"CGLIB$clone$4\"); CGLIB$sayHello$0$Method = ReflectUtils.findMethods(new String[]&#123;\"sayHello\", \"(Ljava/lang/String;)Ljava/lang/String;\"&#125;, (var1 = Class.forName(\"club.throwable.cglib.SampleClass\")).getDeclaredMethods())[0]; CGLIB$sayHello$0$Proxy = MethodProxy.create(var1, var0, \"(Ljava/lang/String;)Ljava/lang/String;\", \"sayHello\", \"CGLIB$sayHello$0\"); &#125; //è¿™ä¸ªæ–¹æ³•å°±æ˜¯ç›´æ¥è°ƒç”¨åŸæ¥çš„è¢«ä»£ç†ç±»(çˆ¶ç±»)çš„æ–¹æ³• final String CGLIB$sayHello$0(String var1) &#123; return super.sayHello(var1); &#125; //è¿™ä¸ªæ–¹æ³•å°±æ˜¯é€šè¿‡æ–¹æ³•ä»£ç†è¿›è¡Œå›è°ƒï¼Œé‡Œé¢ç”¨åˆ°äº†Callbackå®ä¾‹ public final String sayHello(String var1) &#123; MethodInterceptor var10000 = this.CGLIB$CALLBACK_0; if (this.CGLIB$CALLBACK_0 == null) &#123; CGLIB$BIND_CALLBACKS(this); var10000 = this.CGLIB$CALLBACK_0; &#125; return var10000 != null ? (String)var10000.intercept(this, CGLIB$sayHello$0$Method, new Object[]&#123;var1&#125;, CGLIB$sayHello$0$Proxy) : super.sayHello(var1); &#125; final boolean CGLIB$equals$1(Object var1) &#123; return super.equals(var1); &#125; public final boolean equals(Object var1) &#123; MethodInterceptor var10000 = this.CGLIB$CALLBACK_0; if (this.CGLIB$CALLBACK_0 == null) &#123; CGLIB$BIND_CALLBACKS(this); var10000 = this.CGLIB$CALLBACK_0; &#125; if (var10000 != null) &#123; Object var2 = var10000.intercept(this, CGLIB$equals$1$Method, new Object[]&#123;var1&#125;, CGLIB$equals$1$Proxy); return var2 == null ? false : (Boolean)var2; &#125; else &#123; return super.equals(var1); &#125; &#125; final String CGLIB$toString$2() &#123; return super.toString(); &#125; public final String toString() &#123; MethodInterceptor var10000 = this.CGLIB$CALLBACK_0; if (this.CGLIB$CALLBACK_0 == null) &#123; CGLIB$BIND_CALLBACKS(this); var10000 = this.CGLIB$CALLBACK_0; &#125; return var10000 != null ? (String)var10000.intercept(this, CGLIB$toString$2$Method, CGLIB$emptyArgs, CGLIB$toString$2$Proxy) : super.toString(); &#125; final int CGLIB$hashCode$3() &#123; return super.hashCode(); &#125; public final int hashCode() &#123; MethodInterceptor var10000 = this.CGLIB$CALLBACK_0; if (this.CGLIB$CALLBACK_0 == null) &#123; CGLIB$BIND_CALLBACKS(this); var10000 = this.CGLIB$CALLBACK_0; &#125; if (var10000 != null) &#123; Object var1 = var10000.intercept(this, CGLIB$hashCode$3$Method, CGLIB$emptyArgs, CGLIB$hashCode$3$Proxy); return var1 == null ? 0 : ((Number)var1).intValue(); &#125; else &#123; return super.hashCode(); &#125; &#125; final Object CGLIB$clone$4() throws CloneNotSupportedException &#123; return super.clone(); &#125; protected final Object clone() throws CloneNotSupportedException &#123; MethodInterceptor var10000 = this.CGLIB$CALLBACK_0; if (this.CGLIB$CALLBACK_0 == null) &#123; CGLIB$BIND_CALLBACKS(this); var10000 = this.CGLIB$CALLBACK_0; &#125; return var10000 != null ? var10000.intercept(this, CGLIB$clone$4$Method, CGLIB$emptyArgs, CGLIB$clone$4$Proxy) : super.clone(); &#125; public static MethodProxy CGLIB$findMethodProxy(Signature var0) &#123; String var10000 = var0.toString(); switch(var10000.hashCode()) &#123; case -1816210712: if (var10000.equals(\"sayHello(Ljava/lang/String;)Ljava/lang/String;\")) &#123; return CGLIB$sayHello$0$Proxy; &#125; break; case -508378822: if (var10000.equals(\"clone()Ljava/lang/Object;\")) &#123; return CGLIB$clone$4$Proxy; &#125; break; case 1826985398: if (var10000.equals(\"equals(Ljava/lang/Object;)Z\")) &#123; return CGLIB$equals$1$Proxy; &#125; break; case 1913648695: if (var10000.equals(\"toString()Ljava/lang/String;\")) &#123; return CGLIB$toString$2$Proxy; &#125; break; case 1984935277: if (var10000.equals(\"hashCode()I\")) &#123; return CGLIB$hashCode$3$Proxy; &#125; &#125; return null; &#125; public SampleClass$$EnhancerByCGLIB$$53c7afed() &#123; CGLIB$BIND_CALLBACKS(this); &#125; public static void CGLIB$SET_THREAD_CALLBACKS(Callback[] var0) &#123; CGLIB$THREAD_CALLBACKS.set(var0); &#125; public static void CGLIB$SET_STATIC_CALLBACKS(Callback[] var0) &#123; CGLIB$STATIC_CALLBACKS = var0; &#125; private static final void CGLIB$BIND_CALLBACKS(Object var0) &#123; SampleClass$$EnhancerByCGLIB$$53c7afed var1 = (SampleClass$$EnhancerByCGLIB$$53c7afed)var0; if (!var1.CGLIB$BOUND) &#123; var1.CGLIB$BOUND = true; Object var10000 = CGLIB$THREAD_CALLBACKS.get(); if (var10000 == null) &#123; var10000 = CGLIB$STATIC_CALLBACKS; if (CGLIB$STATIC_CALLBACKS == null) &#123; return; &#125; &#125; var1.CGLIB$CALLBACK_0 = (MethodInterceptor)((Callback[])var10000)[0]; &#125; &#125; public Object newInstance(Callback[] var1) &#123; CGLIB$SET_THREAD_CALLBACKS(var1); SampleClass$$EnhancerByCGLIB$$53c7afed var10000 = new SampleClass$$EnhancerByCGLIB$$53c7afed(); CGLIB$SET_THREAD_CALLBACKS((Callback[])null); return var10000; &#125; public Object newInstance(Callback var1) &#123; CGLIB$SET_THREAD_CALLBACKS(new Callback[]&#123;var1&#125;); SampleClass$$EnhancerByCGLIB$$53c7afed var10000 = new SampleClass$$EnhancerByCGLIB$$53c7afed(); CGLIB$SET_THREAD_CALLBACKS((Callback[])null); return var10000; &#125; public Object newInstance(Class[] var1, Object[] var2, Callback[] var3) &#123; CGLIB$SET_THREAD_CALLBACKS(var3); SampleClass$$EnhancerByCGLIB$$53c7afed var10000 = new SampleClass$$EnhancerByCGLIB$$53c7afed; switch(var1.length) &#123; case 0: var10000.&lt;init&gt;(); CGLIB$SET_THREAD_CALLBACKS((Callback[])null); return var10000; default: throw new IllegalArgumentException(\"Constructor not found\"); &#125; &#125; public Callback getCallback(int var1) &#123; CGLIB$BIND_CALLBACKS(this); MethodInterceptor var10000; switch(var1) &#123; case 0: var10000 = this.CGLIB$CALLBACK_0; break; default: var10000 = null; &#125; return var10000; &#125; public void setCallback(int var1, Callback var2) &#123; switch(var1) &#123; case 0: this.CGLIB$CALLBACK_0 = (MethodInterceptor)var2; default: &#125; &#125; public Callback[] getCallbacks() &#123; CGLIB$BIND_CALLBACKS(this); return new Callback[]&#123;this.CGLIB$CALLBACK_0&#125;; &#125; public void setCallbacks(Callback[] var1) &#123; this.CGLIB$CALLBACK_0 = (MethodInterceptor)var1[0]; &#125; static &#123; CGLIB$STATICHOOK1(); &#125;&#125; è¿™ä¸ªç±»ååˆ†é•¿ï¼Œå› ä¸ºé‡Œé¢æœ‰å¾ˆå¤šçš„å˜é‡ï¼Œå®ƒä»¬éƒ½é€šè¿‡äº†é™æ€ä»£ç å—ä½¿ç”¨åå°„åˆå§‹åŒ–ã€‚ç±»çš„ä»£ç æ¯”JDKåŠ¨æ€ä»£ç†çš„å­ç±»å¤šï¼Œå› æ­¤ç”Ÿæˆæ•ˆç‡ä¼šæ¯”è¾ƒä½ã€‚ç›¸å…³æ¯”è¾ƒé‡è¦çš„æ³¨é‡Šå·²ç»å†™åœ¨ç±»ä¸­ï¼Œæˆ‘ä»¬æœ€ä¸»è¦å…³æ³¨ä¸¤ç‚¹ï¼š ç¬¬ä¸€ç‚¹ï¼š 12private static final Method CGLIB$sayHello$0$Method;private static final MethodProxy CGLIB$sayHello$0$Proxy; è¿™ä¸¤ä¸ªé™æ€å˜é‡éƒ½æ˜¯æŒ‡å‘sayHelloè¿™ä¸ªæ–¹æ³•ï¼ŒCGLIB$sayHello$0$Methodç›´æ¥æŒ‡å‘çˆ¶ç±»æ–¹æ³•ï¼ŒCGLIB$sayHello$0$Proxyæ˜¯CGLIBç”Ÿæˆçš„æ–¹æ³•ä»£ç†ã€‚ ç¬¬äºŒç‚¹ï¼š 1234567891011121314//è¿™ä¸ªæ–¹æ³•å°±æ˜¯ç›´æ¥è°ƒç”¨åŸæ¥çš„è¢«ä»£ç†ç±»(çˆ¶ç±»)çš„æ–¹æ³•final String CGLIB$sayHello$0(String var1) &#123; return super.sayHello(var1);&#125;//è¿™ä¸ªæ–¹æ³•å°±æ˜¯é€šè¿‡æ–¹æ³•ä»£ç†è¿›è¡Œå›è°ƒï¼Œé‡Œé¢ç”¨åˆ°äº†Callbackå®ä¾‹public final String sayHello(String var1) &#123; MethodInterceptor var10000 = this.CGLIB$CALLBACK_0; if (this.CGLIB$CALLBACK_0 == null) &#123; CGLIB$BIND_CALLBACKS(this); var10000 = this.CGLIB$CALLBACK_0; &#125; //å¦‚æœæ‰¾ä¸åˆ°Callbackä¼šç›´æ¥è°ƒç”¨çˆ¶ç±»çš„åŸæ–¹æ³• return var10000 != null ? (String)var10000.intercept(this, CGLIB$sayHello$0$Method, new Object[]&#123;var1&#125;, CGLIB$sayHello$0$Proxy) : super.sayHello(var1);&#125; ä¹Ÿå°±æ˜¯å¦‚æœæƒ³è¦å¯ç”¨CGLIBçš„å›è°ƒï¼Œæˆ‘ä»¬ä¸»è§‚ä¸Šåº”è¯¥æ˜¯è¿™æ ·æ“ä½œçš„ï¼š 12SampleClass$$EnhancerByCGLIB$$53c7afed sample = new SampleClass$$EnhancerByCGLIB$$53c7afed();sample.sayHello(\"doge\"); ä½†æ˜¯ç”±äºè¿™ä¸ªä»£ç†ç±»æ˜¯åŠ¨æ€ç”Ÿæˆçš„ï¼Œåªèƒ½é€šè¿‡åå°„è°ƒç”¨ã€‚ é‚£ä¹ˆï¼Œå‰©ä¸‹çš„ä¸¤ä¸ªFastClassçš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿæˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹MethodProxyçš„invoke()å’ŒinvokeSuper()æ–¹æ³•ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344 //åˆå§‹åŒ–FastClassä¸­çš„indexç´¢å¼• private void init() &#123; if (this.fastClassInfo == null) &#123; Object var1 = this.initLock; synchronized(this.initLock) &#123; if (this.fastClassInfo == null) &#123; MethodProxy.CreateInfo ci = this.createInfo; MethodProxy.FastClassInfo fci = new MethodProxy.FastClassInfo(); fci.f1 = helper(ci, ci.c1); fci.f2 = helper(ci, ci.c2); fci.i1 = fci.f1.getIndex(this.sig1); fci.i2 = fci.f2.getIndex(this.sig2); this.fastClassInfo = fci; this.createInfo = null; &#125; &#125; &#125; &#125;public Object invoke(Object obj, Object[] args) throws Throwable &#123; try &#123; this.init(); MethodProxy.FastClassInfo fci = this.fastClassInfo; return fci.f1.invoke(fci.i1, obj, args); &#125; catch (InvocationTargetException var4) &#123; throw var4.getTargetException(); &#125; catch (IllegalArgumentException var5) &#123; if (this.fastClassInfo.i1 &lt; 0) &#123; throw new IllegalArgumentException(\"Protected method: \" + this.sig1); &#125; else &#123; throw var5; &#125; &#125; &#125; public Object invokeSuper(Object obj, Object[] args) throws Throwable &#123; try &#123; this.init(); MethodProxy.FastClassInfo fci = this.fastClassInfo; return fci.f2.invoke(fci.i2, obj, args); &#125; catch (InvocationTargetException var4) &#123; throw var4.getTargetException(); &#125; &#125; è¿™é‡Œï¼Œä¸¤ä¸ªæ–¹æ³•å„è‡ªä½¿ç”¨äº†ä¸åŒçš„FastClassInfoå®ä¾‹fci.f2å’Œfci.f2ã€‚å…¶ä¸­ï¼ŒSampleClass$$FastClassByCGLIB$$cf1a549b.classæ˜¯å¯¹åº”äºçˆ¶ç±»ï¼Œè€ŒSampleClass$$EnhancerByCGLIB$$53c7afed$$FastClassByCGLIB$$da5c8621æ˜¯å¯¹åº”äºCGLIBç”Ÿæˆçš„è¢«ä»£ç†ç±»çš„å­ç±»ã€‚ä¸‹é¢å±•å¼€SampleClass$$EnhancerByCGLIB$$53c7afed$$FastClassByCGLIB$$da5c8621çš„æºç ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405public class SampleClass$$EnhancerByCGLIB$$53c7afed$$FastClassByCGLIB$$da5c8621 extends FastClass &#123; public SampleClass$$EnhancerByCGLIB$$53c7afed$$FastClassByCGLIB$$da5c8621(Class var1) &#123; super(var1); &#125; public int getIndex(Signature var1) &#123; String var10000 = var1.toString(); switch(var10000.hashCode()) &#123; case -2055565910: if (var10000.equals(\"CGLIB$SET_THREAD_CALLBACKS([Lnet/sf/cglib/proxy/Callback;)V\")) &#123; return 10; &#125; break; case -1882565338: if (var10000.equals(\"CGLIB$equals$1(Ljava/lang/Object;)Z\")) &#123; return 18; &#125; break; case -1816210712: if (var10000.equals(\"sayHello(Ljava/lang/String;)Ljava/lang/String;\")) &#123; return 7; &#125; break; case -1457535688: if (var10000.equals(\"CGLIB$STATICHOOK1()V\")) &#123; return 15; &#125; break; case -1411842725: if (var10000.equals(\"CGLIB$hashCode$3()I\")) &#123; return 19; &#125; break; case -894172689: if (var10000.equals(\"newInstance(Lnet/sf/cglib/proxy/Callback;)Ljava/lang/Object;\")) &#123; return 5; &#125; break; case -623122092: if (var10000.equals(\"CGLIB$findMethodProxy(Lnet/sf/cglib/core/Signature;)Lnet/sf/cglib/proxy/MethodProxy;\")) &#123; return 14; &#125; break; case -508378822: if (var10000.equals(\"clone()Ljava/lang/Object;\")) &#123; return 3; &#125; break; case -419626537: if (var10000.equals(\"setCallbacks([Lnet/sf/cglib/proxy/Callback;)V\")) &#123; return 13; &#125; break; case 560567118: if (var10000.equals(\"setCallback(ILnet/sf/cglib/proxy/Callback;)V\")) &#123; return 8; &#125; break; case 811063227: if (var10000.equals(\"newInstance([Ljava/lang/Class;[Ljava/lang/Object;[Lnet/sf/cglib/proxy/Callback;)Ljava/lang/Object;\")) &#123; return 6; &#125; break; case 973717575: if (var10000.equals(\"getCallbacks()[Lnet/sf/cglib/proxy/Callback;\")) &#123; return 11; &#125; break; case 1221173700: if (var10000.equals(\"newInstance([Lnet/sf/cglib/proxy/Callback;)Ljava/lang/Object;\")) &#123; return 4; &#125; break; case 1230699260: if (var10000.equals(\"getCallback(I)Lnet/sf/cglib/proxy/Callback;\")) &#123; return 12; &#125; break; case 1298742135: if (var10000.equals(\"CGLIB$sayHello$0(Ljava/lang/String;)Ljava/lang/String;\")) &#123; return 16; &#125; break; case 1306468936: if (var10000.equals(\"CGLIB$toString$2()Ljava/lang/String;\")) &#123; return 20; &#125; break; case 1584330438: if (var10000.equals(\"CGLIB$SET_STATIC_CALLBACKS([Lnet/sf/cglib/proxy/Callback;)V\")) &#123; return 9; &#125; break; case 1800494055: if (var10000.equals(\"CGLIB$clone$4()Ljava/lang/Object;\")) &#123; return 17; &#125; break; case 1826985398: if (var10000.equals(\"equals(Ljava/lang/Object;)Z\")) &#123; return 0; &#125; break; case 1913648695: if (var10000.equals(\"toString()Ljava/lang/String;\")) &#123; return 1; &#125; break; case 1984935277: if (var10000.equals(\"hashCode()I\")) &#123; return 2; &#125; &#125; return -1; &#125; public int getIndex(String var1, Class[] var2) &#123; switch(var1.hashCode()) &#123; case -2012993625: if (var1.equals(\"sayHello\")) &#123; switch(var2.length) &#123; case 1: if (var2[0].getName().equals(\"java.lang.String\")) &#123; return 7; &#125; &#125; &#125; break; case -1983192202: if (var1.equals(\"CGLIB$sayHello$0\")) &#123; switch(var2.length) &#123; case 1: if (var2[0].getName().equals(\"java.lang.String\")) &#123; return 16; &#125; &#125; &#125; break; case -1776922004: if (var1.equals(\"toString\")) &#123; switch(var2.length) &#123; case 0: return 1; &#125; &#125; break; case -1295482945: if (var1.equals(\"equals\")) &#123; switch(var2.length) &#123; case 1: if (var2[0].getName().equals(\"java.lang.Object\")) &#123; return 0; &#125; &#125; &#125; break; case -1053468136: if (var1.equals(\"getCallbacks\")) &#123; switch(var2.length) &#123; case 0: return 11; &#125; &#125; break; case -124978609: if (var1.equals(\"CGLIB$equals$1\")) &#123; switch(var2.length) &#123; case 1: if (var2[0].getName().equals(\"java.lang.Object\")) &#123; return 18; &#125; &#125; &#125; break; case -60403779: if (var1.equals(\"CGLIB$SET_STATIC_CALLBACKS\")) &#123; switch(var2.length) &#123; case 1: if (var2[0].getName().equals(\"[Lnet.sf.cglib.proxy.Callback;\")) &#123; return 9; &#125; &#125; &#125; break; case -29025555: if (var1.equals(\"CGLIB$hashCode$3\")) &#123; switch(var2.length) &#123; case 0: return 19; &#125; &#125; break; case 85179481: if (var1.equals(\"CGLIB$SET_THREAD_CALLBACKS\")) &#123; switch(var2.length) &#123; case 1: if (var2[0].getName().equals(\"[Lnet.sf.cglib.proxy.Callback;\")) &#123; return 10; &#125; &#125; &#125; break; case 94756189: if (var1.equals(\"clone\")) &#123; switch(var2.length) &#123; case 0: return 3; &#125; &#125; break; case 147696667: if (var1.equals(\"hashCode\")) &#123; switch(var2.length) &#123; case 0: return 2; &#125; &#125; break; case 161998109: if (var1.equals(\"CGLIB$STATICHOOK1\")) &#123; switch(var2.length) &#123; case 0: return 15; &#125; &#125; break; case 495524492: if (var1.equals(\"setCallbacks\")) &#123; switch(var2.length) &#123; case 1: if (var2[0].getName().equals(\"[Lnet.sf.cglib.proxy.Callback;\")) &#123; return 13; &#125; &#125; &#125; break; case 1154623345: if (var1.equals(\"CGLIB$findMethodProxy\")) &#123; switch(var2.length) &#123; case 1: if (var2[0].getName().equals(\"net.sf.cglib.core.Signature\")) &#123; return 14; &#125; &#125; &#125; break; case 1543336189: if (var1.equals(\"CGLIB$toString$2\")) &#123; switch(var2.length) &#123; case 0: return 20; &#125; &#125; break; case 1811874389: if (var1.equals(\"newInstance\")) &#123; switch(var2.length) &#123; case 1: String var10001 = var2[0].getName(); switch(var10001.hashCode()) &#123; case -845341380: if (var10001.equals(\"net.sf.cglib.proxy.Callback\")) &#123; return 5; &#125; break; case 1730110032: if (var10001.equals(\"[Lnet.sf.cglib.proxy.Callback;\")) &#123; return 4; &#125; &#125; case 2: default: break; case 3: if (var2[0].getName().equals(\"[Ljava.lang.Class;\") &amp;&amp; var2[1].getName().equals(\"[Ljava.lang.Object;\") &amp;&amp; var2[2].getName().equals(\"[Lnet.sf.cglib.proxy.Callback;\")) &#123; return 6; &#125; &#125; &#125; break; case 1817099975: if (var1.equals(\"setCallback\")) &#123; switch(var2.length) &#123; case 2: if (var2[0].getName().equals(\"int\") &amp;&amp; var2[1].getName().equals(\"net.sf.cglib.proxy.Callback\")) &#123; return 8; &#125; &#125; &#125; break; case 1905679803: if (var1.equals(\"getCallback\")) &#123; switch(var2.length) &#123; case 1: if (var2[0].getName().equals(\"int\")) &#123; return 12; &#125; &#125; &#125; break; case 1951977610: if (var1.equals(\"CGLIB$clone$4\")) &#123; switch(var2.length) &#123; case 0: return 17; &#125; &#125; &#125; return -1; &#125; public int getIndex(Class[] var1) &#123; switch(var1.length) &#123; case 0: return 0; default: return -1; &#125; &#125; public Object invoke(int var1, Object var2, Object[] var3) throws InvocationTargetException &#123; 53c7afed var10000 = (53c7afed)var2; int var10001 = var1; try &#123; switch(var10001) &#123; case 0: return new Boolean(var10000.equals(var3[0])); case 1: return var10000.toString(); case 2: return new Integer(var10000.hashCode()); case 3: return var10000.clone(); case 4: return var10000.newInstance((Callback[])var3[0]); case 5: return var10000.newInstance((Callback)var3[0]); case 6: return var10000.newInstance((Class[])var3[0], (Object[])var3[1], (Callback[])var3[2]); case 7: return var10000.sayHello((String)var3[0]); case 8: var10000.setCallback(((Number)var3[0]).intValue(), (Callback)var3[1]); return null; case 9: 53c7afed.CGLIB$SET_STATIC_CALLBACKS((Callback[])var3[0]); return null; case 10: 53c7afed.CGLIB$SET_THREAD_CALLBACKS((Callback[])var3[0]); return null; case 11: return var10000.getCallbacks(); case 12: return var10000.getCallback(((Number)var3[0]).intValue()); case 13: var10000.setCallbacks((Callback[])var3[0]); return null; case 14: return 53c7afed.CGLIB$findMethodProxy((Signature)var3[0]); case 15: 53c7afed.CGLIB$STATICHOOK1(); return null; case 16: return var10000.CGLIB$sayHello$0((String)var3[0]); case 17: return var10000.CGLIB$clone$4(); case 18: return new Boolean(var10000.CGLIB$equals$1(var3[0])); case 19: return new Integer(var10000.CGLIB$hashCode$3()); case 20: return var10000.CGLIB$toString$2(); &#125; &#125; catch (Throwable var4) &#123; throw new InvocationTargetException(var4); &#125; throw new IllegalArgumentException(\"Cannot find matching method/constructor\"); &#125; public Object newInstance(int var1, Object[] var2) throws InvocationTargetException &#123; 53c7afed var10000 = new 53c7afed; 53c7afed var10001 = var10000; int var10002 = var1; try &#123; switch(var10002) &#123; case 0: var10001.&lt;init&gt;(); return var10000; &#125; &#125; catch (Throwable var3) &#123; throw new InvocationTargetException(var3); &#125; throw new IllegalArgumentException(\"Cannot find matching method/constructor\"); &#125; public int getMaxIndex() &#123; return 20; &#125;&#125; è¿™ä¸ªç±»æ›´åŠ é•¿ï¼Œä½†æ˜¯å…¶å®å¤§éƒ¨åˆ†éƒ½æ˜¯switch-caseçš„ä»£ç å—ï¼Œå®ƒçš„åŠŸèƒ½å°±æ˜¯ä¸ºæ–¹æ³•çš„è°ƒç”¨æ·»åŠ åŸºäºæ•´å‹æ•°å­—çš„ç´¢å¼•ï¼Œä¸»è¦ç›®çš„æ˜¯ä¸ºäº†å‡å°‘åå°„è°ƒç”¨çš„æ—¶é—´ï¼Œå°†åå°„è°ƒç”¨è½¬åŒ–ä¸ºç›´æ¥è°ƒç”¨ã€‚ç®€å•æ¥è¯´ï¼ŒinvokeSuperçš„æµç¨‹å°±æ˜¯è¿™æ ·çš„ï¼š é€šè¿‡MethodProxyçš„initæ–¹æ³•ï¼Œç”¨å½“å‰æ–¹æ³•çš„Signature(ç­¾å)æ„å»ºä¸¤ä¸ªFastClasså®ä¾‹(å½“ç„¶ï¼Œè¿™é‡Œä¼šåšç¼“å­˜)å’Œå½“å‰æ–¹æ³•å¯¹åº”çš„indexï¼Œå­˜æ”¾åœ¨FastClassInfoå®ä¾‹ä¸­ã€‚ é€šè¿‡FastClassInfoä¸­çš„FastClasså®ä¾‹å’Œindexï¼Œåœ¨FastClassä¸­æ‰¾åˆ°å¯¹åº”çš„æ–¹æ³•(åœ¨switch-caseå—ä¸­åŸºäºæ•´æ•°ç´¢å¼•indexè¿›è¡ŒæŸ¥æ‰¾)ç›´æ¥è°ƒç”¨ã€‚ ç›´è§‚æ¥çœ‹ï¼ŒCGLIBåœ¨ç±»ç”ŸæˆæœŸé—´çš„æ“ä½œä¼šç›¸å¯¹è€—æ—¶ï¼Œè€Œä¸”ç”Ÿæˆçš„ç±»æ•°ç›®æ¯”è¾ƒå¤šï¼Œä¼šå æ®å¤§é‡æ°¸ä¹…ä»£æˆ–è€…å…ƒç©ºé—´çš„å†…å­˜ã€‚å­ç±»ä¸€æ—¦ç”Ÿæˆï¼Œåé¢çš„æ–¹æ³•è°ƒç”¨å°±ä¼šå˜æˆæœç´¢æ–¹æ³•ç´¢å¼•å’Œç›´æ¥è°ƒç”¨ï¼Œè¿™æ ·çš„æ“ä½œåœ¨ç‰¹å®šçš„æ¡ä»¶ä¸‹æ•ˆç‡ä¼šæ¯”JDKçš„åå°„é«˜ã€‚è¿™é‡Œç‰¹å®šçš„åœºæ™¯æ˜¯æŒ‡CGLIBå­ç±»ä¸­çš„switch-caseå—ä¸å¤§å¹¶ä¸”å½“å‰è°ƒç”¨çš„æ–¹æ³•çš„indexåœ¨switch-caseå—çš„å‰éƒ¨è€Œä¸æ˜¯ä¸­åéƒ¨(ç®€å•æ¥è¯´å°±æ˜¯å­ç±»ä¸­çš„æ–¹æ³•è¦å°½é‡å°‘ä»è€Œæé«˜switch-caseä¸­çš„æœå¯»æ•ˆç‡)ã€‚è¯¦ç»†å¯ä»¥å‚è€ƒè¿™ç¯‡æ€§èƒ½å¯¹æ¯”çš„æ–‡ç« ï¼šcglibå’ŒjdkåŠ¨æ€ä»£ç†è°ƒç”¨æ€§èƒ½æµ‹ å°ç»“ CGLIBæä¾›äº†è®¸å¤šåŸºäºä»£ç ç”Ÿæˆçš„é«˜çº§åŠŸèƒ½çš„APIï¼Œå¯ä»¥åœ¨é€šè¿‡ä¸Šé¢çš„ä¾‹å­ç†Ÿæ‚‰å®ƒçš„ä½¿ç”¨ï¼Œå¹¶ä¸”åœ¨åˆé€‚çš„åœºæ™¯ç”¨äºå®æˆ˜ä¸­ã€‚å¯èƒ½æœ€å¸¸ç”¨åˆ°çš„æ˜¯åŸºäºEnhancerçš„åŠ¨æ€ä»£ç†ï¼Œè¿™é‡Œæ€»ç»“ä¸€ä¸‹CGLIBå’ŒJDKåŠ¨æ€ä»£ç†çš„åŒºåˆ«(è€ç”Ÿå¸¸è°ˆ)ï¼š JDKåŠ¨æ€ä»£ç†åªèƒ½å¤Ÿå¯¹æ¥å£è¿›è¡Œä»£ç†ï¼Œä¸èƒ½å¯¹æ™®é€šçš„ç±»è¿›è¡Œä»£ç†ï¼ˆå› ä¸ºæ‰€æœ‰ç”Ÿæˆçš„ä»£ç†ç±»çš„çˆ¶ç±»ä¸ºProxyï¼ŒJavaç±»ç»§æ‰¿æœºåˆ¶ä¸å…è®¸å¤šé‡ç»§æ‰¿ï¼‰ï¼›CGLIBèƒ½å¤Ÿä»£ç†æ™®é€šç±»ï¼Œä½†æ˜¯è¯¥æ™®é€šç±»å¿…é¡»èƒ½å¤Ÿè¢«ç»§æ‰¿(ä¸èƒ½ç”¨finalä¿®é¥°ç¬¦)ã€‚ JDKåŠ¨æ€ä»£ç†ä½¿ç”¨JavaåŸç”Ÿçš„åå°„APIè¿›è¡Œæ“ä½œï¼Œåœ¨ç”Ÿæˆç±»ä¸Šæ¯”è¾ƒé«˜æ•ˆï¼›CGLIBä½¿ç”¨ASMæ¡†æ¶ç›´æ¥å¯¹å­—èŠ‚ç è¿›è¡Œä¿®æ”¹ï¼Œä½¿ç”¨äº†FastClassçš„ç‰¹æ€§ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹ç±»çš„æ–¹æ³•æ‰§è¡Œä¼šæ¯”è¾ƒé«˜æ•ˆã€‚ (æœ¬æ–‡å®Œ e-a-20181216 c-1-d)","categories":[{"name":"Framework","slug":"Framework","permalink":"http://throwable.club/blog/categories/Framework/"},{"name":"Cglib","slug":"Framework/Cglib","permalink":"http://throwable.club/blog/categories/Framework/Cglib/"}],"tags":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/tags/Java/"},{"name":"Cglib","slug":"Cglib","permalink":"http://throwable.club/blog/tags/Cglib/"}]},{"title":"ç®€è¿°CGLIBå¸¸ç”¨API","slug":"cglib-api","date":"2018-12-16T08:52:35.000Z","updated":"2018-12-16T08:55:12.514Z","comments":true,"path":"2018/12/16/cglib-api/","link":"","permalink":"http://throwable.club/2018/12/16/cglib-api/","excerpt":"","text":"ç®€è¿°CGLIBå¸¸ç”¨API CGLIBç®€ä»‹ CGLIBï¼Œå³Code Generation Libraryï¼Œæ˜¯ä¸€ä¸ªå¼ºå¤§çš„ã€é«˜æ€§èƒ½çš„ä»£ç ç”Ÿæˆåº“ã€‚å…¶è¢«å¹¿æ³›åº”ç”¨äºAOPæ¡†æ¶ï¼ˆä¾‹å¦‚Springï¼‰ä¸­ï¼Œç”¨ä»¥æä¾›æ–¹æ³•æ‹¦æˆªæ“ä½œã€‚Hibernateä½œä¸ºä¸€ä¸ªæ¯”è¾ƒå—æ¬¢è¿çš„ORMæ¡†æ¶ï¼ŒåŒæ ·ä½¿ç”¨CGLIBæ¥ä»£ç†å•ç«¯ï¼ˆå¤šå¯¹ä¸€å’Œä¸€å¯¹ä¸€ï¼‰å…³è”ï¼ˆå»¶è¿Ÿæå–é›†åˆä½¿ç”¨çš„å¦ä¸€ç§æœºåˆ¶ï¼‰ã€‚CGLIBä½œä¸ºä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œå…¶ä»£ç æ‰˜ç®¡åœ¨githubï¼Œåœ°å€ä¸ºï¼šhttps://github.com/cglib/cglibã€‚ CGLIBçš„githubç®€ä»‹ï¼šCGLIB - å­—èŠ‚ç ç”Ÿæˆåº“ï¼Œæ˜¯ç”¨äºç”Ÿæˆå’Œè½¬æ¢Javaå­—èŠ‚ç çš„é«˜çº§APIã€‚å®ƒè¢«AOPã€æµ‹è¯•ã€æ•°æ®è®¿é—®æ¡†æ¶ç”¨äºç”ŸæˆåŠ¨æ€ä»£ç†å¯¹è±¡å’Œæ‹¦æˆªå­—æ®µè®¿é—®ã€‚(åŸæ–‡ï¼šcglib - Byte Code Generation Library is high level API to generate and transform Java byte code. It is used by AOP, testing, data access frameworks to generate dynamic proxy objects and intercept field access.) CGLIBæä¾›ä¸¤ç§ç±»å‹çš„JARåŒ…ï¼š cglib-nodep-x.x.x.jarï¼šä½¿ç”¨nodepåŒ…ä¸éœ€è¦å…³è”ASMçš„jaråŒ…ï¼Œä¹Ÿå°±æ˜¯jaråŒ…å†…éƒ¨åŒ…å«ASMçš„ç±»åº“ã€‚ cglib-x.x.x.jarï¼šä½¿ç”¨æ­¤jaråŒ…éœ€è¦å¦å¤–æä¾›ASMçš„jaråŒ…ï¼Œå¦åˆ™è¿è¡Œæ—¶æŠ¥é”™ï¼Œå»ºè®®é€‰ç”¨ä¸åŒ…å«ASMç±»åº“çš„jaråŒ…ï¼Œå¯ä»¥æ–¹ä¾¿æ§åˆ¶ASMçš„ã€‚ æœ¬æ–‡ä¸­ä½¿ç”¨çš„CGLIBä¾èµ–ä¸ºï¼š 12345678910&lt;dependency&gt; &lt;groupId&gt;cglib&lt;/groupId&gt; &lt;artifactId&gt;cglib-nodep&lt;/artifactId&gt; &lt;version&gt;3.2.10&lt;/version&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.projectlombok&lt;/groupId&gt; &lt;artifactId&gt;lombok&lt;/artifactId&gt; &lt;version&gt;1.16.22&lt;/version&gt;&lt;/dependency&gt; CGLIBåŸºæœ¬åŸç† åŸºæœ¬åŸç†ï¼šåŠ¨æ€ç”Ÿæˆä¸€ä¸ªè¦ä»£ç†ç±»çš„å­ç±»(è¢«ä»£ç†çš„ç±»ä½œä¸ºç»§æ‰¿çš„çˆ¶ç±»)ï¼Œå­ç±»é‡å†™è¦ä»£ç†çš„ç±»çš„æ‰€æœ‰ä¸æ˜¯finalçš„æ–¹æ³•ã€‚åœ¨å­ç±»ä¸­é‡‡ç”¨æ–¹æ³•æ‹¦æˆªçš„æŠ€æœ¯æ‹¦æˆªæ‰€æœ‰çˆ¶ç±»æ–¹æ³•çš„è°ƒç”¨ï¼Œé¡ºåŠ¿ç»‡å…¥æ¨ªåˆ‡é€»è¾‘ã€‚å®ƒæ¯”ä½¿ç”¨Javaåå°„çš„JDKåŠ¨æ€ä»£ç†è¦å¿«ï¼Œå› ä¸ºå®ƒé‡‡ç”¨äº†æ•´å½¢å˜é‡å»ºç«‹äº†æ–¹æ³•ç´¢å¼•ã€‚ åº•å±‚å®ç°ï¼šä½¿ç”¨å­—èŠ‚ç å¤„ç†æ¡†æ¶ASMï¼Œç”¨äºè½¬æ¢å­—èŠ‚ç å¹¶ç”Ÿæˆæ–°çš„ç±»ã€‚ä¸é¼“åŠ±ç›´æ¥ä½¿ç”¨ASMï¼Œå› ä¸ºå®ƒè¦æ±‚å¿…é¡»å¯¹JVMå†…éƒ¨ç»“æ„åŒ…æ‹¬classæ–‡ä»¶çš„æ ¼å¼å’ŒJVMæŒ‡ä»¤é›†éƒ½å¾ˆç†Ÿæ‚‰ï¼Œå¦åˆ™ä¸€æ—¦å‡ºç°é”™è¯¯å°†ä¼šæ˜¯JVMå´©æºƒçº§åˆ«çš„å¼‚å¸¸ã€‚ åŠ£åŠ¿ï¼šå¯¹äºfinalæ–¹æ³•æˆ–è€…finalçš„ç±»ï¼Œæ— æ³•è¿›è¡Œä»£ç†ã€‚ CGLIBçš„åŒ…ç»“æ„ net.sf.cglib.coreï¼šåº•å±‚å­—èŠ‚ç å¤„ç†ç±»ï¼Œå®ƒä»¬å¤§éƒ¨åˆ†ä¸ASMæœ‰å…³ç³»ï¼Œåœ¨ä½¿ç”¨è€…è§’åº¦æ¥çœ‹ä¸éœ€è¦è¿‡å¤šå…³æ³¨æ­¤åŒ…ã€‚ net.sf.cglib.transformï¼šç¼–è¯‘æœŸæˆ–è¿è¡ŒæœŸç±»å’Œç±»æ–‡ä»¶çš„è½¬æ¢ã€‚ net.sf.cglib.proxyï¼šå®ç°åˆ›å»ºä»£ç†å’Œæ–¹æ³•æ‹¦æˆªå™¨çš„ç±»ã€‚ net.sf.cglib.reflectï¼šåå°„ç›¸å…³å·¥å…·ç±»ã€‚ net.sf.cglib.utilï¼šé›†åˆæ’åºç­‰å·¥å…·ç±»ã€‚ net.sf.cglib.beansï¼šJavaBeanç›¸å…³çš„å·¥å…·ç±»ã€‚ CGLIBå¸¸ç”¨APIä»‹ç» ä¸‹é¢ä»‹ç»ä¸€ä¸‹CGLIBä¸­å¸¸ç”¨çš„APIï¼Œå…ˆå»ºç«‹ä¸€ä¸ªæ¨¡ç‰¹æ¥å£ç±»å’Œæ™®é€šæ¨¡ç‰¹ç±»ï¼š 1234567891011public class SampleClass &#123; public String sayHello(String name) &#123; return String.format(\"%s say hello!\", name); &#125;&#125;public interface SampleInterface &#123; String sayHello(String name);&#125; Enhancer Enhancerï¼Œå³(å­—èŠ‚ç )å¢å¼ºå™¨ã€‚å®ƒæ˜¯CGLIBåº“ä¸­æœ€å¸¸ç”¨çš„ä¸€ä¸ªç±»ï¼ŒåŠŸèƒ½JDKåŠ¨æ€ä»£ç†ä¸­å¼•å…¥çš„Proxyç±»å·®ä¸å¤šï¼Œä½†æ˜¯Enhanceræ—¢èƒ½å¤Ÿä»£ç†æ™®é€šçš„Javaç±»ï¼Œä¹Ÿèƒ½å¤Ÿä»£ç†æ¥å£ã€‚Enhanceråˆ›å»ºä¸€ä¸ªè¢«ä»£ç†å¯¹è±¡çš„å­ç±»å¹¶ä¸”æ‹¦æˆªæ‰€æœ‰çš„æ–¹æ³•è°ƒç”¨ï¼ˆåŒ…æ‹¬ä»Objectä¸­ç»§æ‰¿çš„toStringå’ŒhashCodeæ–¹æ³•ï¼‰ã€‚Enhancerä¸èƒ½å¤Ÿæ‹¦æˆªfinalæ–¹æ³•ï¼Œä¾‹å¦‚Object.getClass()æ–¹æ³•ï¼Œè¿™æ˜¯ç”±äºfinalå…³é”®å­—çš„è¯­ä¹‰å†³å®šçš„ã€‚åŸºäºåŒæ ·çš„é“ç†ï¼ŒEnhancerä¹Ÿä¸èƒ½å¯¹fianlç±»è¿›è¡Œä»£ç†æ“ä½œã€‚è¿™ä¹Ÿæ˜¯Hibernateä¸ºä»€ä¹ˆä¸èƒ½æŒä¹…åŒ–finalå…³é”®å­—ä¿®é¥°çš„ç±»çš„åŸå› ã€‚ 123456789101112131415public class EnhancerClassDemo &#123; public static void main(String[] args) throws Exception &#123; Enhancer enhancer = new Enhancer(); enhancer.setSuperclass(SampleClass.class); //ä½¿ç”¨FixedValueï¼Œæ‹¦æˆªè¿”å›å€¼ï¼Œæ¯æ¬¡è¿”å›å›ºå®šå€¼\"Doge say hello!\" enhancer.setCallback((FixedValue) () -&gt; \"Doge say hello!\"); SampleClass sampleClass = (SampleClass) enhancer.create(); System.out.println(sampleClass.sayHello(\"throwable-10086\")); System.out.println(sampleClass.sayHello(\"throwable-doge\")); System.out.println(sampleClass.toString()); System.out.println(sampleClass.getClass()); System.out.println(sampleClass.hashCode()); &#125;&#125; è¾“å‡ºç»“æœï¼š 123456Doge say hello!Doge say hello!Doge say hello!class club.throwable.cglib.SampleClass$$EnhancerByCGLIB$$6f6e7a68Exception in thread \"main\" java.lang.ClassCastException: java.lang.String cannot be cast to java.lang.Number...... ä¸Šè¿°ä»£ç ä¸­ï¼ŒFixedValueç”¨æ¥å¯¹æ‰€æœ‰æ‹¦æˆªçš„æ–¹æ³•è¿”å›ç›¸åŒçš„å€¼ï¼Œä»è¾“å‡ºæˆ‘ä»¬å¯ä»¥çœ‹å‡ºæ¥ï¼ŒEnhancerå¯¹éfinalæ–¹æ³•test()ã€toString()ã€hashCode()è¿›è¡Œäº†æ‹¦æˆªï¼Œæ²¡æœ‰å¯¹getClassè¿›è¡Œæ‹¦æˆªã€‚ç”±äºhashCode()æ–¹æ³•éœ€è¦è¿”å›ä¸€ä¸ªNumberï¼Œä½†æ˜¯æˆ‘ä»¬è¿”å›çš„æ˜¯ä¸€ä¸ªStringï¼Œè¿™è§£é‡Šäº†ä¸Šé¢çš„ç¨‹åºä¸­ä¸ºä»€ä¹ˆä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ Enhancer3setSuperclass()ç”¨æ¥è®¾ç½®çˆ¶ç±»å‹ï¼Œä»toString()æ–¹æ³•å¯ä»¥çœ‹å‡ºï¼Œä½¿ç”¨CGLIBç”Ÿæˆçš„ç±»ä¸ºè¢«ä»£ç†ç±»çš„ä¸€ä¸ªå­ç±»ï¼Œç±»ç®€å†™åç§°ä¸ºSampleClass$$EnhancerByCGLIB$$e3ea9b7ã€‚ Enhancer#create(Class[] argumentTypes, Object[] arguments)æ–¹æ³•æ˜¯ç”¨æ¥åˆ›å»ºå¢å¼ºå¯¹è±¡çš„ï¼Œå…¶æä¾›äº†å¾ˆå¤šä¸åŒå‚æ•°çš„æ–¹æ³•ç”¨æ¥åŒ¹é…è¢«å¢å¼ºç±»çš„ä¸åŒæ„é€ æ–¹æ³•ã€‚æˆ‘ä»¬ä¹Ÿå¯ä»¥å…ˆä½¿ç”¨Enhancer#createClass()æ¥åˆ›å»ºå­—èŠ‚ç (.class)ï¼Œç„¶åç”¨å­—èŠ‚ç åŠ è½½å®Œæˆåçš„ç±»åŠ¨æ€ç”Ÿæˆå¢å¼ºåçš„å¯¹è±¡ã€‚Enhancerä¸­è¿˜æœ‰å…¶ä»–å‡ ä¸ªæ–¹æ³•åä¸ºcreateçš„æ–¹æ³•ï¼Œæä¾›ä¸åŒçš„å‚æ•°é€‰æ‹©ï¼Œå…·ä½“å¯ä»¥è‡ªè¡ŒæŸ¥é˜…ã€‚ ä¸‹é¢å†ä¸¾ä¸ªä¾‹å­è¯´æ˜ä¸€ä¸‹ä½¿ç”¨Enhancerä»£ç†æ¥å£ï¼š 1234567891011121314public class EnhancerInterfaceDemo &#123; public static void main(String[] args) throws Exception &#123; Enhancer enhancer = new Enhancer(); enhancer.setInterfaces(new Class[]&#123;SampleInterface.class&#125;); enhancer.setCallback((FixedValue) () -&gt; \"Doge say hello!\"); SampleInterface sampleInterface = (SampleInterface) enhancer.create(); System.out.println(sampleInterface.sayHello(\"throwable-10086\")); System.out.println(sampleInterface.sayHello(\"throwable-doge\")); System.out.println(sampleInterface.toString()); System.out.println(sampleInterface.getClass()); System.out.println(sampleInterface.hashCode()); &#125;&#125; è¾“å‡ºç»“æœå’Œä¸Šä¸€ä¸ªä¾‹å­ä¸€è‡´ã€‚ Callback Callbackï¼Œå³å›è°ƒã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå®ƒæ˜¯ä¸€ä¸ªæ ‡è¯†æ¥å£(ç©ºæ¥å£ï¼Œæ²¡æœ‰ä»»ä½•æ–¹æ³•)ï¼Œå®ƒçš„å›è°ƒæ—¶æœºæ˜¯ç”Ÿæˆçš„ä»£ç†ç±»çš„æ–¹æ³•è¢«è°ƒç”¨çš„æ—¶å€™ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç”Ÿæˆçš„ä»£ç†ç±»çš„æ–¹æ³•è¢«è°ƒç”¨çš„æ—¶å€™ï¼ŒCallbackçš„å®ç°é€»è¾‘å°±ä¼šè¢«è°ƒç”¨ã€‚Enhanceré€šè¿‡setCallback()å’ŒsetCallbacks()è®¾ç½®Callbackï¼Œè®¾ç½®äº†å¤šä¸ªCallbackå®ä¾‹å°†ä¼šæŒ‰ç…§è®¾ç½®çš„é¡ºåºè¿›è¡Œå›è°ƒã€‚CGLIBä¸­æä¾›çš„Callbackçš„å­ç±»æœ‰ä»¥ä¸‹å‡ ç§ï¼š NoOp FixedValue InvocationHandler MethodInterceptor Dispatcher LazyLoader NoOp NoOpï¼ŒNo Operationï¼Œä¹Ÿå°±æ˜¯ä¸åšä»»ä½•æ“ä½œã€‚è¿™ä¸ªå›è°ƒå®ç°åªæ˜¯ç®€å•åœ°æŠŠæ–¹æ³•è°ƒç”¨å§”æ‰˜ç»™äº†è¢«ä»£ç†ç±»çš„åŸæ–¹æ³•(ä¹Ÿå°±æ˜¯è°ƒç”¨åŸå§‹ç±»çš„åŸå§‹æ–¹æ³•)ï¼Œä¸åšä»»ä½•å…¶å®ƒçš„æ“ä½œï¼Œæ‰€ä»¥ä¸èƒ½ä½¿ç”¨åœ¨æ¥å£ä»£ç†ã€‚ 12345678910public class NoOpDemo &#123; public static void main(String[] args) throws Exception&#123; Enhancer enhancer = new Enhancer(); enhancer.setSuperclass(SampleClass.class); enhancer.setCallback(NoOp.INSTANCE); SampleClass sampleClass = (SampleClass) enhancer.create(); System.out.println(sampleClass.sayHello(\"throwable\")); &#125;&#125; è¾“å‡ºç»“æœï¼š 1throwable say hello! FixedValue FixedValueï¼ŒFixed Valueï¼Œå³å›ºå®šå€¼ã€‚å®ƒæä¾›äº†ä¸€ä¸ªloadObject()æ–¹æ³•ï¼Œä¸è¿‡è¿™ä¸ªæ–¹æ³•è¿”å›çš„ä¸æ˜¯ä»£ç†å¯¹è±¡ï¼Œè€Œæ˜¯åŸæ–¹æ³•è°ƒç”¨æƒ³è¦çš„ç»“æœã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨è¿™ä¸ªCallbacké‡Œé¢ï¼Œçœ‹ä¸åˆ°ä»»ä½•åŸæ–¹æ³•çš„ä¿¡æ¯ï¼Œä¹Ÿå°±æ²¡æœ‰è°ƒç”¨åŸæ–¹æ³•çš„é€»è¾‘ï¼Œä¸ç®¡åŸæ–¹æ³•æ˜¯ä»€ä¹ˆéƒ½åªä¼šè°ƒç”¨loadObject()å¹¶è¿”å›ä¸€ä¸ªå›ºå®šç»“æœã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœloadObject()æ–¹æ³•çš„è¿”å›å€¼å¹¶ä¸èƒ½è½¬æ¢æˆåŸæ–¹æ³•çš„è¿”å›å€¼ç±»å‹ï¼Œé‚£ä¹ˆä¼šæŠ›å‡ºç±»å‹è½¬æ¢å¼‚å¸¸(ClassCastException)ã€‚ æœ€å‰é¢çš„Enhancerä¸¤ä¸ªä¾‹å­å°±æ˜¯ç”¨FixedValueåšåˆ†æçš„ï¼Œè¿™é‡Œä¸å†ä¸¾ä¾‹ã€‚ InvocationHandler InvocationHandlerå…¨ç±»åä¸ºnet.sf.cglib.proxy.InvocationHandlerï¼Œå®ƒçš„åŠŸèƒ½å’ŒJDKåŠ¨æ€ä»£ç†ä¸­çš„java.lang.reflect.InvocationHandlerç±»ä¼¼ï¼Œæä¾›äº†ä¸€ä¸ªObject invoke(Object proxy, Method method, Object[] objects)æ–¹æ³•ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼šæ‰€æœ‰å¯¹invokeæ–¹æ³•çš„å‚æ•°proxyå¯¹è±¡çš„æ–¹æ³•è°ƒç”¨éƒ½ä¼šè¢«å§”æ‰˜ç»™åŒä¸€ä¸ªInvocationHandlerï¼Œæ‰€ä»¥å¯èƒ½ä¼šå¯¼è‡´æ— é™å¾ªç¯(å› ä¸ºinvokeä¸­è°ƒç”¨çš„ä»»ä½•åŸä»£ç†ç±»æ–¹æ³•ï¼Œå‡ä¼šé‡æ–°ä»£ç†åˆ°invokeæ–¹æ³•ä¸­)ã€‚ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼š 123456789101112131415public class InvocationHandlerDeadLoopDemo &#123; public static void main(String[] args) throws Exception&#123; Enhancer enhancer = new Enhancer(); enhancer.setSuperclass(SampleClass.class); enhancer.setCallback(new InvocationHandler() &#123; @Override public Object invoke(Object o, Method method, Object[] objects) throws Throwable &#123; return method.invoke(o, objects); &#125; &#125;); SampleClass sampleClass = (SampleClass) enhancer.create(); System.out.println(sampleClass.sayHello(\"throwable\")); &#125;&#125; ä¸Šé¢çš„mainæ–¹æ³•æ‰§è¡Œåä¼šç›´æ¥çˆ†æ ˆï¼Œå› ä¸ºmethod#invoke()æ–¹æ³•ä¼šé‡æ–°è°ƒç”¨InvocationHandlerçš„invokeæ–¹æ³•ï¼Œå½¢æˆæ­»å¾ªç¯ã€‚æ­£ç¡®çš„ä½¿ç”¨ä¾‹å­å¦‚ä¸‹ï¼š 123456789101112131415161718public class InvocationHandlerDemo &#123; public static void main(String[] args) throws Exception &#123; Enhancer enhancer = new Enhancer(); enhancer.setSuperclass(SampleClass.class); enhancer.setCallback(new InvocationHandler() &#123; @Override public Object invoke(Object o, Method method, Object[] objects) throws Throwable &#123; if (!Objects.equals(method.getDeclaringClass(), Object.class) &amp;&amp; Objects.equals(String.class, method.getReturnType())) &#123; return String.format(\"%s say hello!\", objects); &#125; return \"No one say hello!\"; &#125; &#125;); SampleClass sampleClass = (SampleClass) enhancer.create(); System.out.println(sampleClass.sayHello(\"throwable\")); &#125;&#125; è¾“å‡ºç»“æœï¼š 1throwable say hello! MethodInterceptor MethodInterceptorï¼Œå³æ–¹æ³•æ‹¦æˆªå™¨ï¼Œè¿™æ˜¯ä¸€ä¸ªåŠŸèƒ½å¾ˆå¼ºå¤§çš„æ¥å£ï¼Œå®ƒå¯ä»¥å®ç°ç±»ä¼¼äºAOPç¼–ç¨‹ä¸­çš„ç¯ç»•å¢å¼ºï¼ˆAround Adviceï¼‰ã€‚å®ƒåªæœ‰ä¸€ä¸ªæ–¹æ³•public Object intercept(Object obj,java.lang.reflect.Method method,Object[] args,MethodProxy methodProxy) throws Throwableã€‚è®¾ç½®äº†MethodInterceptoråï¼Œä»£ç†ç±»çš„æ‰€æœ‰æ–¹æ³•è°ƒç”¨éƒ½ä¼šè½¬è€Œæ‰§è¡Œè¿™ä¸ªæ¥å£ä¸­çš„interceptæ–¹æ³•è€Œä¸æ˜¯åŸæ–¹æ³•ã€‚å¦‚æœéœ€è¦åœ¨interceptæ–¹æ³•ä¸­æ‰§è¡ŒåŸæ–¹æ³•å¯ä»¥ä½¿ç”¨å‚æ•°methodåŸºäºä»£ç†å®ä¾‹objè¿›è¡Œåå°„è°ƒç”¨ï¼Œä½†æ˜¯ä½¿ç”¨æ–¹æ³•ä»£ç†methodProxyæ•ˆç‡ä¼šæ›´é«˜ï¼ˆåå°„è°ƒç”¨æ¯”æ­£å¸¸çš„æ–¹æ³•è°ƒç”¨çš„é€Ÿåº¦æ…¢å¾ˆå¤šï¼‰ã€‚MethodInterceptorçš„ç”Ÿæˆæ•ˆç‡ä¸é«˜ï¼Œå®ƒçš„ä¼˜åŠ¿åœ¨äºè°ƒç”¨æ•ˆç‡ï¼Œå®ƒéœ€è¦äº§ç”Ÿä¸åŒç±»å‹çš„å­—èŠ‚ç ï¼Œå¹¶ä¸”éœ€è¦ç”Ÿæˆä¸€äº›è¿è¡Œæ—¶å¯¹è±¡(InvocationHandlerå°±ä¸éœ€è¦)ã€‚æ³¨æ„ï¼Œåœ¨ä½¿ç”¨MethodProxyè°ƒç”¨invokeSuperæ–¹æ³•ç›¸å½“äºé€šè¿‡æ–¹æ³•ä»£ç†ç›´æ¥è°ƒç”¨åŸç±»çš„å¯¹åº”æ–¹æ³•ï¼Œå¦‚æœè°ƒç”¨MethodProxyçš„invokeä¼šè¿›å…¥æ­»å¾ªç¯å¯¼è‡´çˆ†æ ˆï¼ŒåŸå› è·ŸInvocationHandlerå·®ä¸å¤šã€‚ 123456789101112131415161718public class MethodInterceptorDemo &#123; public static void main(String[] args) throws Exception &#123; Enhancer enhancer = new Enhancer(); enhancer.setSuperclass(SampleClass.class); enhancer.setCallback(new MethodInterceptor() &#123; @Override public Object intercept(Object obj, Method method, Object[] objects, MethodProxy methodProxy) throws Throwable &#123; System.out.println(\"Before invoking sayHello...\"); Object result = methodProxy.invokeSuper(obj, objects); System.out.println(\"After invoking sayHello...\"); return result; &#125; &#125;); SampleClass sampleClass = (SampleClass) enhancer.create(); System.out.println(sampleClass.sayHello(\"throwable\")); &#125;&#125; è¾“å‡ºç»“æœï¼š 123Before invoking sayHello...After invoking sayHello...throwable say hello! è¿™ä¸ªä¾‹å­å°±æ˜¯Springçš„AOPä¸­çš„ç¯ç»•å¢å¼º(Around Advice)çš„ç®€åŒ–ç‰ˆï¼Œè¿™é‡Œæ²¡æœ‰æ”¹å˜åŸæ¥çš„æ–¹æ³•çš„è¡Œä¸ºï¼Œåªæ˜¯åœ¨æ–¹æ³•è°ƒç”¨å‰å’Œè°ƒç”¨åç»‡å…¥é¢å¤–çš„é€»è¾‘ã€‚ Dispatcher Dispatcherï¼Œå³åˆ†å‘å™¨ï¼Œæä¾›ä¸€ä¸ªæ–¹æ³•Object loadObject() throws Exception;ï¼ŒåŒæ ·åœ°è¿”å›ä¸€ä¸ªä»£ç†å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡åŒæ ·å¯ä»¥ä»£ç†åŸæ–¹æ³•çš„è°ƒç”¨ã€‚Dispatcherçš„loadObject()æ–¹æ³•åœ¨æ¯æ¬¡å‘ç”Ÿå¯¹åŸæ–¹æ³•çš„è°ƒç”¨æ—¶éƒ½ä¼šè¢«è°ƒç”¨å¹¶è¿”å›ä¸€ä¸ªä»£ç†å¯¹è±¡æ¥è°ƒç”¨åŸæ–¹æ³•ã€‚Dispatcherå¯ä»¥ç±»æ¯”ä¸ºSpringä¸­çš„Prototypeç±»å‹ã€‚ 123456789101112131415161718192021222324252627282930313233public class DispatcherDemo &#123; private static final AtomicInteger COUNTER = new AtomicInteger(0); public static void main(String[] args) throws Exception &#123; Enhancer enhancer = new Enhancer(); SampleInterfaceImpl impl = new SampleInterfaceImpl(); enhancer.setInterfaces(new Class[]&#123;SampleInterface.class&#125;); enhancer.setCallback(new Dispatcher() &#123; @Override public Object loadObject() throws Exception &#123; COUNTER.incrementAndGet(); return impl; &#125; &#125;); SampleInterface sampleInterface = (SampleInterface) enhancer.create(); System.out.println(sampleInterface.sayHello(\"throwable-1\")); System.out.println(sampleInterface.sayHello(\"throwable-2\")); System.out.println(COUNTER.get()); &#125; private static class SampleInterfaceImpl implements SampleInterface&#123; public SampleInterfaceImpl()&#123; System.out.println(\"SampleInterfaceImpl init...\"); &#125; @Override public String sayHello(String name) &#123; return \"Hello i am SampleInterfaceImpl!\"; &#125; &#125;&#125; è¾“å‡ºç»“æœï¼š 1234SampleInterfaceImpl init...Hello i am SampleInterfaceImpl!Hello i am SampleInterfaceImpl!2 è®¡æ•°å™¨è¾“å‡ºä¸º2ï¼Œå°è¯äº†æ¯æ¬¡è°ƒç”¨æ–¹æ³•éƒ½ä¼šå›è°ƒDispatcherä¸­çš„å®ä¾‹è¿›è¡Œè°ƒç”¨ã€‚ LazyLoader LazyLoaderï¼Œå³æ‡’åŠ è½½å™¨ï¼Œå®ƒåªæä¾›äº†ä¸€ä¸ªæ–¹æ³•Object loadObject() throws Exception;ï¼ŒloadObject()æ–¹æ³•ä¼šåœ¨ç¬¬ä¸€æ¬¡è¢«ä»£ç†ç±»çš„æ–¹æ³•è°ƒç”¨æ—¶è§¦å‘ï¼Œå®ƒè¿”å›ä¸€ä¸ªä»£ç†ç±»çš„å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡ä¼šè¢«å­˜å‚¨èµ·æ¥ç„¶åè´Ÿè´£æ‰€æœ‰è¢«ä»£ç†ç±»æ–¹æ³•çš„è°ƒç”¨ï¼Œå°±åƒå®ƒçš„åå­—è¯´çš„é‚£æ ·ï¼Œä¸€ç§lazyåŠ è½½æ¨¡å¼ã€‚å¦‚æœè¢«ä»£ç†ç±»æˆ–è€…ä»£ç†ç±»çš„å¯¹è±¡çš„åˆ›å»ºæ¯”è¾ƒéº»çƒ¦ï¼Œè€Œä¸”ä¸ç¡®å®šå®ƒæ˜¯å¦ä¼šè¢«ä½¿ç”¨ï¼Œé‚£ä¹ˆå¯ä»¥é€‰æ‹©ä½¿ç”¨è¿™ç§lazyæ¨¡å¼æ¥å»¶è¿Ÿç”Ÿæˆä»£ç†ã€‚LazyLoaderå¯ä»¥ç±»æ¯”ä¸ºSpringä¸­çš„Lazyæ¨¡å¼çš„Singletonã€‚ 123456789101112131415161718192021222324252627282930313233public class LazyLoaderDemo &#123; private static final AtomicInteger COUNTER = new AtomicInteger(0); public static void main(String[] args) throws Exception &#123; Enhancer enhancer = new Enhancer(); SampleInterfaceImpl impl = new SampleInterfaceImpl(); enhancer.setInterfaces(new Class[]&#123;SampleInterface.class&#125;); enhancer.setCallback(new LazyLoader() &#123; @Override public Object loadObject() throws Exception &#123; COUNTER.incrementAndGet(); return impl; &#125; &#125;); SampleInterface sampleInterface = (SampleInterface) enhancer.create(); System.out.println(sampleInterface.sayHello(\"throwable-1\")); System.out.println(sampleInterface.sayHello(\"throwable-2\")); System.out.println(COUNTER.get()); &#125; private static class SampleInterfaceImpl implements SampleInterface&#123; public SampleInterfaceImpl()&#123; System.out.println(\"SampleInterfaceImpl init...\"); &#125; @Override public String sayHello(String name) &#123; return \"Hello i am SampleInterfaceImpl!\"; &#125; &#125;&#125; è¾“å‡ºç»“æœï¼š 1234SampleInterfaceImpl init...Hello i am SampleInterfaceImpl!Hello i am SampleInterfaceImpl!1 è®¡æ•°å™¨è¾“å‡ºä¸º1ï¼Œå°è¯äº†LazyLoaderä¸­çš„å®ä¾‹åªå›è°ƒäº†1æ¬¡ï¼Œè¿™å°±æ˜¯æ‡’åŠ è½½ã€‚ BeanCopier JavaBeanå±æ€§æ‹·è´å™¨ï¼Œæä¾›ä»ä¸€ä¸ªJavaBeanå®ä¾‹ä¸­æ‹·è´å±æ€§åˆ°å¦ä¸€ä¸ªJavaBeanå®ä¾‹ä¸­ï¼Œæ³¨æ„ç±»å‹å¿…é¡»å®Œå…¨åŒ¹é…å±æ€§æ‰èƒ½æ‹·è´æˆåŠŸ(åŸå§‹ç±»å‹å’Œå…¶åŒ…è£…ç±»ä¸å±äºç›¸åŒç±»å‹)ã€‚å®ƒè¿˜æä¾›äº†ä¸€ä¸ªnet.sf.cglib.core.Converterè½¬æ¢å™¨å›è°ƒæ¥å£è®©ä½¿ç”¨è€…æ§åˆ¶æ‹·è´çš„è¿‡ç¨‹ã€‚æ³¨æ„ï¼ŒBeanCopierå†…éƒ¨ä½¿ç”¨äº†ç¼“å­˜å’ŒåŸºäºASMåŠ¨æ€ç”ŸæˆBeanCopierçš„å­ç±»å®ç°çš„è½¬æ¢æ–¹æ³•ä¸­ç›´æ¥ä½¿ç”¨å®ä¾‹çš„Getterå’ŒSetteræ–¹æ³•ï¼Œæ‹·è´é€Ÿåº¦æå¿«(BeanCopierå±æ€§æ‹·è´æ¯”ç›´æ¥çš„Setterã€Getterç¨æ…¢ï¼Œç¨æ…¢çš„åŸå› åœ¨äºé¦–æ¬¡éœ€è¦åŠ¨æ€ç”ŸæˆBeanCopierçš„å­ç±»ï¼Œä¸€æ—¦å­ç±»ç”Ÿæˆå®Œæˆä¹‹åå°±å’Œç›´æ¥çš„Setterã€Getteræ•ˆç‡ä¸€è‡´ï¼Œä½†æ˜¯æ•ˆç‡è¿œè¿œé«˜äºå…¶ä»–ä½¿ç”¨åå°„çš„å·¥å…·ç±»åº“)ã€‚ 123456789101112131415161718192021222324252627282930313233343536public class BeanCopierDemo &#123; private static final Map&lt;String, BeanCopier&gt; CACHE = new ConcurrentHashMap&lt;&gt;(); public static void main(String[] args) throws Exception &#123; //è¿™é‡ŒuseConverterè®¾ç½®ä¸ºfalse,è°ƒç”¨copyæ–¹æ³•çš„æ—¶å€™ä¸èƒ½ä¼ å…¥è½¬æ¢å™¨å®ä¾‹ BeanCopier beanCopier; String key = generateCacheKey(Person.class, Person.class); if (CACHE.containsKey(key)) &#123; beanCopier = CACHE.get(key); &#125; else &#123; beanCopier = BeanCopier.create(Person.class, Person.class, false); CACHE.put(key, beanCopier); &#125; Person person = new Person(); person.setId(10086L); person.setName(\"throwable\"); person.setAge(25); Person newPerson = new Person(); beanCopier.copy(person, newPerson, null); //è¿™é‡Œè½¬æ¢å™¨å®ä¾‹è¦ä¼ null System.out.println(newPerson); &#125; private static String generateCacheKey(Class&lt;?&gt; source, Class&lt;?&gt; target) &#123; return String.format(\"%s-%s\", source.getName(), target.getName()); &#125; @ToString @Data private static class Person &#123; private Long id; private String name; private Integer age; &#125;&#125; è¾“å‡ºç»“æœï¼š 1BeanCopierDemo.Person(id=10086, name=throwable, age=25) åœ¨ä½¿ç”¨BeanCopieræ—¶å€™æœ€å¥½ç¼“å­˜BeanCopierå®ä¾‹ï¼Œå› ä¸ºæ„é€ BeanCopierå®ä¾‹æ˜¯ä¸€ä¸ªè€—æ—¶çš„æ“ä½œã€‚ ImmutableBean ImmutableBeanï¼Œå³ä¸å¯å˜çš„Beanã€‚ImmutableBeanå…è®¸åˆ›å»ºä¸€ä¸ªåŸæ¥å¯¹è±¡çš„åŒ…è£…ç±»ï¼Œè¿™ä¸ªåŒ…è£…ç±»æ˜¯ä¸å¯å˜çš„ï¼Œä»»ä½•æ”¹å˜åº•å±‚å¯¹è±¡çš„åŒ…è£…ç±»æ“ä½œéƒ½ä¼šæŠ›å‡ºIllegalStateExceptionã€‚ä½†æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡ç›´æ¥æ“ä½œåº•å±‚å¯¹è±¡æ¥æ”¹å˜åŒ…è£…ç±»å¯¹è±¡ã€‚è¿™æœ‰ç‚¹ç±»ä¼¼äºGuavaä¸­çš„ä¸å¯å˜è§†å›¾æˆ–è€…JDKä¸­çš„ä¸å¯å˜é›†åˆã€‚ 12345678910111213141516171819public class ImmutableBeanDemo &#123; public static void main(String[] args) throws Exception &#123; Person person = new Person(); person.setName(\"throwable\"); Person immutablePerson = (Person) ImmutableBean.create(person); System.out.println(immutablePerson.getName()); person.setName(\"doge\"); System.out.println(immutablePerson.getName()); immutablePerson.setName(\"throwable-doge\"); System.out.println(immutablePerson.getName()); &#125; @Data private static class Person &#123; private String name; &#125;&#125; è¾“å‡ºç»“æœ: 1234throwabledogeException in thread \"main\" java.lang.IllegalStateException: Bean is immutable... BeanGenerator BeanGeneratorï¼Œå³Beanç”Ÿæˆå™¨ï¼Œä½¿ç”¨å®ƒèƒ½å¤Ÿåœ¨è¿è¡Œæ—¶åŠ¨æ€çš„åˆ›å»ºä¸€ä¸ªJavaBeanã€‚å¯ä»¥ç›´æ¥è®¾ç½®çˆ¶ç±»ï¼Œç”Ÿæˆçš„JavaBeanå°±æ˜¯çˆ¶ç±»ç±»å‹çš„å®ä¾‹ã€‚ 123456789101112public class BeanGeneratorDemo &#123; public static void main(String[] args) throws Exception &#123; BeanGenerator beanGenerator = new BeanGenerator(); beanGenerator.addProperty(\"name\", String.class); Object target = beanGenerator.create(); Method setter = target.getClass().getDeclaredMethod(\"setName\", String.class); Method getter = target.getClass().getDeclaredMethod(\"getName\"); setter.invoke(target, \"throwable\"); System.out.println(getter.invoke(target)); &#125;&#125; è¾“å‡ºç»“æœï¼š 1throwable BulkBean ç›¸æ¯”äºBeanCopierï¼ŒBulkBeanåˆ›å»ºæ—¶å€™ä¾èµ–äºç¡®å®šçš„ç›®æ ‡ç±»å‹ï¼ŒSetterå’ŒGetteræ–¹æ³•åç§°åˆ—è¡¨ä»¥åŠå‚æ•°ç±»å‹ï¼Œå®ƒå°†copyçš„åŠ¨ä½œæ‹†åˆ†ä¸ºgetPropertyValues()å’ŒsetPropertyValues()ä¸¤ä¸ªæ–¹æ³•ï¼Œå…è®¸è‡ªå®šä¹‰å¤„ç†å±æ€§ã€‚ 12345678910111213141516171819202122public class BulkBeanDemo &#123; public static void main(String[] args) throws Exception &#123; BulkBean bulkBean = BulkBean.create( Person.class, new String[]&#123;\"getName\"&#125;, new String[]&#123;\"setName\"&#125;, new Class[]&#123;String.class&#125;); Person person = new Person(); person.setName(\"throwable\"); Object[] propertyValues = bulkBean.getPropertyValues(person); System.out.println(Arrays.toString(propertyValues)); bulkBean.setPropertyValues(person, new Object[]&#123;\"doge\"&#125;); System.out.println(person.getName()); &#125; @Data private static class Person &#123; private String name; &#125;&#125; è¾“å‡ºç»“æœï¼š 12[throwable]doge BeanMap BeanMapç±»å®ç°äº†JDKçš„java.util.Mapæ¥å£ï¼Œå°†ä¸€ä¸ªJavaBeanå¯¹è±¡ä¸­çš„æ‰€æœ‰å±æ€§è½¬æ¢ä¸ºä¸€ä¸ªString-To-Obejctçš„Mapå®ä¾‹ã€‚ 12345678910111213141516public class BeanMapDemo &#123; public static void main(String[] args) throws Exception&#123; Person person = new Person(); person.setName(\"throwable\"); BeanMap beanMap = BeanMap.create(person); System.out.println(beanMap); System.out.println(beanMap.get(\"name\")); &#125; @Data private static class Person &#123; private String name; &#125;&#125; è¾“å‡ºç»“æœï¼š 12&#123;name=throwable&#125;throwable KeyFactory KeyFactoryæºç ä¸­çš„æ³¨é‡Šæ˜¯ï¼šGenerates classes to handle multi-valued keys, for use in things such as Maps and Sets. Code for equals and hashCode methods follow the the rules laid out in Effective Java by Joshua Bloch.(ç¿»è¯‘ä¸€ä¸‹ï¼šé€šè¿‡ç”Ÿæˆç±»æ¥å¤„ç†å¤šå€¼é”®ï¼Œä»¥ä¾¿åœ¨è¯¸å¦‚Mapå’Œé›†åˆä¹‹ç±»çš„ä¸œè¥¿ä¸­ä½¿ç”¨ã€‚equalså’ŒhashCodeæ–¹æ³•çš„ä»£ç éµå¾ªJoshua Blochåœ¨ã€ŠEffective Javaã€‹ä¸­åˆ—å‡ºçš„è§„åˆ™)ã€‚ ä»€ä¹ˆå«multi-valued keys? å°±æ˜¯æœ‰å¤šä¸ªé”®çš„ç»„åˆï¼Œä¸€èµ·ä½œä¸ºä¸€ä¸ªKeyã€‚ æ¯”å¦‚[a b c]æ˜¯ä¸€ä¸ªç»„åˆï¼Œä¸€èµ·ä½œä¸ºä¸€ä¸ªkeyï¼Œ[2 3]ä¹Ÿå¯ä»¥æ˜¯ä½œä¸ºä¸€ä¸ªkeyã€‚ KeyFactoryå°±æ˜¯ç”¨æ¥ç”Ÿæˆè¿™æ ·ä¸€ç»„Keyçš„ï¼Œé€šè¿‡ä¸¤ç»„çš„equalsï¼ŒhashCodeç­‰æ–¹æ³•åˆ¤æ–­æ˜¯å¦ä¸ºåŒä¸€ç»„keyçš„åœºæ™¯ã€‚ä¸ºäº†æè¿°Keyçš„ç»„åˆï¼Œéœ€è¦å®šä¹‰ä¸€ä¸ªæ¥å£ï¼Œä»…æä¾›ä¸€ä¸ªæ–¹æ³•ï¼Œå«åšnewInstance()ï¼Œä¸”è¿”å›å€¼ä¸ºObjectï¼Œè¿™ä¸ªæ˜¯ä½¿ç”¨KeyFactoryçš„è¦æ±‚ã€‚ 12345678910111213141516171819public class KeyFactoryDemo &#123; public static void main(String[] args) throws Exception &#123; KeyFactoryInterface keyFactoryInterface1 = (KeyFactoryInterface) KeyFactory.create(KeyFactoryInterface.class); KeyFactoryInterface keyFactoryInterface2 = (KeyFactoryInterface) KeyFactory.create(KeyFactoryInterface.class); System.out.println(keyFactoryInterface1 == keyFactoryInterface2); System.out.println(keyFactoryInterface1.equals(keyFactoryInterface2)); Object key1 = keyFactoryInterface1.newInstance(1, \"doge\"); Object key2 = keyFactoryInterface1.newInstance(1, \"doge\"); System.out.println(key1.equals(key2)); key2 = keyFactoryInterface1.newInstance(1, \"doge10086\"); System.out.println(key1.equals(key2)); &#125; interface KeyFactoryInterface &#123; Object newInstance(Integer a, String b); &#125;&#125; è¾“å‡ºç»“æœï¼š 1234falsetruetruefalse Mixin Mixinèƒ½å¤Ÿè®©æˆ‘ä»¬å°†å¤šä¸ªæ¥å£çš„å¤šä¸ªå®ç°åˆå¹¶åˆ°åŒä¸€ä¸ªæ¥å£çš„å•ä¸ªå®ç°ã€‚ 12345678910111213141516171819202122232425262728293031323334353637383940public class MixinDemo &#123; interface InterfaceFirst &#123; String first(); &#125; interface InterfaceSecond &#123; String second(); &#125; static class ImplFirst implements InterfaceFirst &#123; @Override public String first() &#123; return \"I am first\"; &#125; &#125; static class ImplSecond implements InterfaceSecond &#123; @Override public String second() &#123; return \"I am second\"; &#125; &#125; interface MixinImpl extends InterfaceFirst, InterfaceSecond &#123; &#125; public static void main(String[] args) throws Exception &#123; Mixin mixin = Mixin.create(new Class[]&#123;InterfaceFirst.class, InterfaceSecond.class, MixinImpl.class&#125;, new Object[]&#123;new ImplFirst(), new ImplSecond()&#125;); MixinImpl mixinImpl = (MixinImpl) mixin; System.out.println(mixinImpl.first()); System.out.println(mixinImpl.second()); &#125;&#125; è¾“å‡ºç»“æœï¼š 12I am firstI am second StringSwitcher ç”¨æ¥æ¨¡æ‹Ÿä¸€ä¸ªStringåˆ°intç±»å‹çš„Mapç±»å‹ã€‚å¦‚æœåœ¨Java7ä»¥åçš„ç‰ˆæœ¬ä¸­ï¼Œç±»ä¼¼ä¸€ä¸ªswitchå—çš„é€»è¾‘ã€‚ 12345678public class StringSwitcherDemo &#123; public static void main(String[] args) throws Exception &#123; StringSwitcher stringSwitcher = StringSwitcher.create(new String[]&#123;\"one\", \"two\"&#125;, new int[]&#123;1, 2&#125;, true); System.out.println(stringSwitcher.intValue(\"one\")); System.out.println(stringSwitcher.intValue(\"two\")); &#125;&#125; è¾“å‡ºç»“æœï¼š 1212 InterfaceMaker æ¥å£ç”Ÿæˆå™¨ï¼Œåº•å±‚ä¾èµ–ASMçš„ç›¸å…³APIã€‚ 1234567891011121314public class InterfaceMakerDemo &#123; public static void main(String[] args) throws Exception &#123; Signature signature = new Signature(\"foo\", Type.DOUBLE_TYPE, new Type[]&#123;Type.INT_TYPE&#125;); InterfaceMaker interfaceMaker = new InterfaceMaker(); interfaceMaker.add(signature, new Type[0]); Class&lt;?&gt; clazz = interfaceMaker.create(); Method[] methods = clazz.getMethods(); System.out.println(methods.length); Method foo = methods[0]; System.out.println(foo.getReturnType()); System.out.println(Arrays.toString(foo.getParameterTypes())); &#125;&#125; è¾“å‡ºç»“æœï¼š 1231double[int] ä¸Šè¿°çš„InterfaceMakeråˆ›å»ºçš„æ¥å£ä¸­åªå«æœ‰ä¸€ä¸ªæ–¹æ³•ï¼Œç­¾åä¸ºdouble foo(int)ã€‚InterfaceMakerä¸ä¸Šé¢ä»‹ç»çš„å…¶ä»–ç±»ä¸åŒï¼Œå®ƒä¾èµ–ASMä¸­çš„Typeç±»å‹ã€‚ç”±äºæ¥å£ä»…ä»…åªç”¨åšåœ¨ç¼–è¯‘æ—¶æœŸè¿›è¡Œç±»å‹æ£€æŸ¥ï¼Œå› æ­¤åœ¨ä¸€ä¸ªè¿è¡Œçš„åº”ç”¨ä¸­åŠ¨æ€çš„åˆ›å»ºæ¥å£æ²¡æœ‰ä»€ä¹ˆä½œç”¨ã€‚ä½†æ˜¯InterfaceMakerå¯ä»¥ç”¨æ¥è‡ªåŠ¨ç”Ÿæˆæ¥å£ä»£ç ï¼Œä¸ºä»¥åçš„å¼€å‘åšå‡†å¤‡ã€‚ MethodDelegate æ–¹æ³•ä»£ç†ï¼Œä¸ªäººè®¤ä¸ºä½œç”¨ä¸å¤ªå¤§ï¼Œè¿™é‡Œä»…ä¸¾ä¾‹ã€‚ 1234567891011121314151617181920212223242526272829public class MethodDelegateDemo &#123; interface MethodDelegateInterface &#123; String getValueFromDelegate(); &#125; static class Delegate &#123; private String value; public String getValue() &#123; return value; &#125; public Delegate setValue(String value) &#123; this.value = value; return this; &#125; &#125; public static void main(String[] args) throws Exception &#123; Delegate delegate = new Delegate(); delegate.setValue(\"throwable\"); MethodDelegate methodDelegate = MethodDelegate.create(delegate, \"getValue\", MethodDelegateInterface.class); MethodDelegateInterface delegateInterface = (MethodDelegateInterface) methodDelegate; System.out.println(delegateInterface.getValueFromDelegate()); &#125;&#125; è¾“å‡ºç»“æœï¼š 1throwable MulticastDelegate å¤šé‡ä»£ç†ï¼Œä¸ªäººè®¤ä¸ºä½œç”¨ä¸å¤ªå¤§ï¼Œè¿™é‡Œä»…ä¸¾ä¾‹ã€‚ 123456789101112131415161718192021222324252627282930313233public class MulticastDelegateDemo &#123; public interface DelegateProvider &#123; void setValue(String value); &#125; static class MulticastBean implements DelegateProvider &#123; private String value; @Override public void setValue(String value) &#123; this.value = value; &#125; public String getValue() &#123; return value; &#125; &#125; public static void main(String[] args) throws Exception &#123; MulticastDelegate multicastDelegate = MulticastDelegate.create(DelegateProvider.class); MulticastBean first = new MulticastBean(); MulticastBean second = new MulticastBean(); multicastDelegate = multicastDelegate.add(first); multicastDelegate = multicastDelegate.add(second); DelegateProvider provider = (DelegateProvider) multicastDelegate; provider.setValue(\"throwable\"); System.out.println(first.getValue()); System.out.println(second.getValue()); &#125;&#125; è¾“å‡ºç»“æœï¼š 12throwablethrowable ConstructorDelegate æ„é€ å™¨ä»£ç†ï¼Œä¸ªäººè®¤ä¸ºä½œç”¨ä¸å¤ªå¤§ï¼Œè¿™é‡Œä»…ä¸¾ä¾‹ã€‚ 123456789101112131415161718192021222324252627282930313233public class ConstructorDelegateDemo &#123; public interface ConstructorInterface &#123; Object newInstance(String value); &#125; static class ConstructorImpl &#123; private String value; public ConstructorImpl(String value) &#123; this.value = value; &#125; public String getValue() &#123; return value; &#125; public ConstructorImpl setValue(String value) &#123; this.value = value; return this; &#125; &#125; public static void main(String[] args) throws Exception &#123; ConstructorInterface constructorInterface = (ConstructorInterface) ConstructorDelegate.create(ConstructorImpl.class, ConstructorInterface.class); ConstructorImpl constructorImpl = (ConstructorImpl) constructorInterface.newInstance(\"throwable\"); System.out.println(ConstructorImpl.class.isAssignableFrom(constructorImpl.getClass())); System.out.println(constructorImpl.getValue()); &#125;&#125; è¾“å‡ºç»“æœï¼š 12truethrowable ParallelSorter å¹¶è¡Œæ’åºå™¨ï¼Œèƒ½å¤Ÿå¯¹å¤šä¸ªæ•°ç»„åŒæ—¶è¿›è¡Œæ’åºï¼Œç›®å‰å®ç°çš„ç®—æ³•æœ‰å½’å¹¶æ’åº(mergeSort)å’Œå¿«é€Ÿæ’åº(quickSort)ï¼ŒæŸ¥çœ‹æºç çš„æ—¶å€™å‘ç°Floatå’ŒDoubleç±»çš„æ¯”è¾ƒç›´æ¥ç”¨å¤§äºæˆ–è€…å°äºï¼Œæœ‰å¯èƒ½é€ æˆè¿™ä¸¤ä¸ªç±»å‹çš„æ•°æ®æ’åºä¸å‡†ç¡®(åº”è¯¥ä½¿ç”¨Floatæˆ–Doubleçš„compareæ–¹æ³•è¿›è¡Œæ¯”è¾ƒ)ã€‚ 12345678910111213public class ParallelSorterDemo &#123; public static void main(String[] args) throws Exception &#123; Integer[][] array = new Integer[][]&#123; &#123;4, 3, 9, 0&#125;, &#123;2, 1, 6, 0&#125; &#125;; ParallelSorter.create(array).quickSort(0); for (Integer[] row : array) &#123; System.out.println(Arrays.toString(row)); &#125; &#125;&#125; è¾“å‡ºç»“æœï¼š 12[0, 3, 4, 9][0, 1, 2, 6] FastClass FastClasså°±æ˜¯å¯¹Classå¯¹è±¡è¿›è¡Œç‰¹å®šçš„å¤„ç†ï¼Œè®¤çŸ¥ä¸Šå¯ä»¥ç†è§£ä¸ºç´¢å¼•ç±»ï¼Œæ¯”å¦‚é€šè¿‡æ•°ç»„ä¿å­˜methodå¼•ç”¨ï¼Œå› æ­¤FastClasså¼•å‡ºäº†ä¸€ä¸ªindexä¸‹æ ‡çš„æ–°æ¦‚å¿µï¼Œæ¯”å¦‚getIndex(String name, Class[] parameterTypes)å°±æ˜¯ä»¥å‰çš„è·å–methodçš„æ–¹æ³•ã€‚é€šè¿‡æ•°ç»„å­˜å‚¨methodï¼Œconstructorç­‰classä¿¡æ¯ï¼Œä»è€Œå°†åŸå…ˆçš„åå°„è°ƒç”¨ï¼Œè½¬åŒ–ä¸ºclass.indexçš„ç›´æ¥è°ƒç”¨ä»¥æé«˜æ•ˆç‡ï¼Œä»è€Œä½“ç°æ‰€è°“çš„FastClassã€‚ 12345678910public class FastClassDemo &#123; public static void main(String[] args) throws Exception &#123; FastClass fastClass = FastClass.create(SampleClass.class); FastMethod fastMethod = fastClass.getMethod(\"sayHello\", new Class[]&#123;String.class&#125;); SampleClass sampleClass = new SampleClass(); System.out.println(fastMethod.invoke(sampleClass, new Object[]&#123;\"throwable\"&#125;)); System.out.println(fastMethod.getIndex()); &#125;&#125; è¾“å‡ºç»“æœï¼š 12throwable say hello!0 å®é™…ä¸Šï¼Œåœ¨æ¥å£æˆ–è€…ä»£ç†ç±»çš„æ–¹æ³•æ¯”è¾ƒå°‘çš„æ—¶å€™ï¼Œä½¿ç”¨FastClassè¿›è¡Œæ–¹æ³•è°ƒç”¨æœ‰å¯èƒ½æ¯”åŸç”Ÿåå°„æ–¹æ³•è°ƒç”¨Method#invoke()é«˜ï¼Œä½†æ˜¯å®é™…è¿˜æ˜¯éœ€è¦è¿›è¡Œæµ‹è¯•å’Œåˆ†æï¼Œä¸èƒ½ç›²ç›®ä¸€æ¦‚è€Œè®ºã€‚ å°ç»“ æœ¬æ–‡ç®€å•åˆ†æäº†ä¸€ä¸‹CGLIBä¸­çš„å¸¸ç”¨APIï¼Œå…¶å®åœ¨å®ç°AOPã€åŠ¨æ€ä»£ç†å’Œåå°„è°ƒç”¨çš„æ—¶å€™ï¼Œæœ€å¸¸ç”¨çš„æ˜¯å­—èŠ‚ç å¢å¼ºå™¨Enhancerã€å›è°ƒ(Callback)ä»¥åŠå¿«ç±»(FastClass)ï¼ŒæŒæ¡å®ƒä»¬çš„ä½¿ç”¨æ–¹å¼æœ‰åˆ©äºè¿›è¡ŒAOPç¼–ç¨‹ä»¥åŠåå°„æ€§èƒ½åˆ›æ–°æ€§æå‡ã€‚ (æœ¬æ–‡å®Œ r-a-20181216 c-1-d)","categories":[{"name":"Framework","slug":"Framework","permalink":"http://throwable.club/blog/categories/Framework/"},{"name":"Cglib","slug":"Framework/Cglib","permalink":"http://throwable.club/blog/categories/Framework/Cglib/"}],"tags":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/tags/Java/"},{"name":"Cglib","slug":"Cglib","permalink":"http://throwable.club/blog/tags/Cglib/"}]},{"title":"Zookeeperå®¢æˆ·ç«¯Curatorä½¿ç”¨è¯¦è§£","slug":"zookeeper-curator-usage","date":"2018-12-16T07:31:56.000Z","updated":"2018-12-16T07:39:39.330Z","comments":true,"path":"2018/12/16/zookeeper-curator-usage/","link":"","permalink":"http://throwable.club/2018/12/16/zookeeper-curator-usage/","excerpt":"","text":"Zookeeperå®¢æˆ·ç«¯Curatorä½¿ç”¨è¯¦è§£ å‰æ å› ä¸ºæœ€è¿‘é¡¹ç›®éœ€è¦ä½¿ç”¨Zookeeperè¿™ä¸ªä¸­é—´ä»¶ï¼Œæå‰äº†è§£ä¸€ä¸‹å®ƒçš„å®¢æˆ·ç«¯Curatorçš„ä½¿ç”¨ã€‚ ç®€ä»‹ Curatoræ˜¯Netflixå…¬å¸å¼€æºçš„ä¸€å¥—zookeeperå®¢æˆ·ç«¯æ¡†æ¶ï¼Œè§£å†³äº†å¾ˆå¤šZookeeperå®¢æˆ·ç«¯éå¸¸åº•å±‚çš„ç»†èŠ‚å¼€å‘å·¥ä½œï¼ŒåŒ…æ‹¬è¿æ¥é‡è¿ã€åå¤æ³¨å†ŒWatcherå’ŒNodeExistsExceptionå¼‚å¸¸ç­‰ç­‰ã€‚Patrixck Huntï¼ˆZookeeperï¼‰ä»¥ä¸€å¥â€œGuava is to Java that Curator to Zookeeperâ€ç»™Curatoräºˆé«˜åº¦è¯„ä»·ã€‚ å¼•å­å’Œè¶£é—»ï¼š Zookeeperåå­—çš„ç”±æ¥æ˜¯æ¯”è¾ƒæœ‰è¶£çš„ï¼Œä¸‹é¢çš„ç‰‡æ®µæ‘˜æŠ„è‡ªã€Šä»PAXOSåˆ°ZOOKEEPERåˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†ä¸å®è·µã€‹ä¸€ä¹¦ï¼š Zookeeperæœ€æ—©èµ·æºäºé›…è™çš„ç ”ç©¶é™¢çš„ä¸€ä¸ªç ”ç©¶å°ç»„ã€‚åœ¨å½“æ—¶ï¼Œç ”ç©¶äººå‘˜å‘ç°ï¼Œåœ¨é›…è™å†…éƒ¨å¾ˆå¤šå¤§å‹çš„ç³»ç»Ÿéœ€è¦ä¾èµ–ä¸€ä¸ªç±»ä¼¼çš„ç³»ç»Ÿè¿›è¡Œåˆ†å¸ƒå¼åè°ƒï¼Œä½†æ˜¯è¿™äº›ç³»ç»Ÿå¾€å¾€å­˜åœ¨åˆ†å¸ƒå¼å•ç‚¹é—®é¢˜ã€‚æ‰€ä»¥é›…è™çš„å¼€å‘äººå‘˜å°±è¯•å›¾å¼€å‘ä¸€ä¸ªé€šç”¨çš„æ— å•ç‚¹é—®é¢˜çš„åˆ†å¸ƒå¼åè°ƒæ¡†æ¶ã€‚åœ¨ç«‹é¡¹åˆæœŸï¼Œè€ƒè™‘åˆ°å¾ˆå¤šé¡¹ç›®éƒ½æ˜¯ç”¨åŠ¨ç‰©çš„åå­—æ¥å‘½åçš„(ä¾‹å¦‚è‘—åçš„Pigé¡¹ç›®)ï¼Œé›…è™çš„å·¥ç¨‹å¸ˆå¸Œæœ›ç»™è¿™ä¸ªé¡¹ç›®ä¹Ÿå–ä¸€ä¸ªåŠ¨ç‰©çš„åå­—ã€‚æ—¶ä»»ç ”ç©¶é™¢çš„é¦–å¸­ç§‘å­¦å®¶Raghu Ramakrishnanå¼€ç©ç¬‘è¯´ï¼šå†è¿™æ ·ä¸‹å»ï¼Œæˆ‘ä»¬è¿™å„¿å°±å˜æˆåŠ¨ç‰©å›­äº†ã€‚æ­¤è¯ä¸€å‡ºï¼Œå¤§å®¶çº·çº·è¡¨ç¤ºå°±å«åŠ¨ç‰©å›­ç®¡ç†å‘˜å§â€”â€”å› ä¸ºå„ä¸ªä»¥åŠ¨ç‰©å‘½åçš„åˆ†å¸ƒå¼ç»„ä»¶æ”¾åœ¨ä¸€èµ·ï¼Œé›…è™çš„æ•´ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿçœ‹ä¸Šå»å°±åƒä¸€ä¸ªå¤§å‹çš„åŠ¨ç‰©å›­äº†ï¼Œè€ŒZookeeperæ­£å¥½ç”¨æ¥è¿›è¡Œåˆ†å¸ƒå¼ç¯å¢ƒçš„åè°ƒâ€”â€”äºæ˜¯ï¼ŒZookeeperçš„åå­—ç”±æ­¤è¯ç”Ÿäº†ã€‚ Curatoræ— ç–‘æ˜¯Zookeeperå®¢æˆ·ç«¯ä¸­çš„ç‘å£«å†›åˆ€ï¼Œå®ƒè¯‘ä½œ&quot;é¦†é•¿&quot;æˆ–è€…â€™â€˜ç®¡ç†è€…â€™â€™ï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯å¼€å‘å°ç»„æœ‰æ„è€Œä¸ºä¹‹ï¼Œç¬”è€…çŒœæµ‹æœ‰å¯èƒ½è¿™æ ·å‘½åçš„åŸå› æ˜¯è¯´æ˜Curatorå°±æ˜¯Zookeeperçš„é¦†é•¿(è„‘æ´æœ‰ç‚¹å¤§ï¼šCuratorå°±æ˜¯åŠ¨ç‰©å›­çš„å›­é•¿)ã€‚ CuratoråŒ…å«äº†å‡ ä¸ªåŒ…ï¼š curator-frameworkï¼šå¯¹zookeeperçš„åº•å±‚apiçš„ä¸€äº›å°è£…ã€‚ curator-clientï¼šæä¾›ä¸€äº›å®¢æˆ·ç«¯çš„æ“ä½œï¼Œä¾‹å¦‚é‡è¯•ç­–ç•¥ç­‰ã€‚ curator-recipesï¼šå°è£…äº†ä¸€äº›é«˜çº§ç‰¹æ€§ï¼Œå¦‚ï¼šCacheäº‹ä»¶ç›‘å¬ã€é€‰ä¸¾ã€åˆ†å¸ƒå¼é”ã€åˆ†å¸ƒå¼è®¡æ•°å™¨ã€åˆ†å¸ƒå¼Barrierç­‰ã€‚ Mavenä¾èµ–(ä½¿ç”¨curatorçš„ç‰ˆæœ¬ï¼š2.12.0ï¼Œå¯¹åº”Zookeeperçš„ç‰ˆæœ¬ä¸ºï¼š3.4.xï¼Œå¦‚æœè·¨ç‰ˆæœ¬ä¼šæœ‰å…¼å®¹æ€§é—®é¢˜ï¼Œå¾ˆæœ‰å¯èƒ½å¯¼è‡´èŠ‚ç‚¹æ“ä½œå¤±è´¥)ï¼š 12345678910&lt;dependency&gt; &lt;groupId&gt;org.apache.curator&lt;/groupId&gt; &lt;artifactId&gt;curator-framework&lt;/artifactId&gt; &lt;version&gt;2.12.0&lt;/version&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.apache.curator&lt;/groupId&gt; &lt;artifactId&gt;curator-recipes&lt;/artifactId&gt; &lt;version&gt;2.12.0&lt;/version&gt;&lt;/dependency&gt; Curatorçš„åŸºæœ¬Api åˆ›å»ºä¼šè¯ 1.ä½¿ç”¨é™æ€å·¥ç¨‹æ–¹æ³•åˆ›å»ºå®¢æˆ·ç«¯ ä¸€ä¸ªä¾‹å­å¦‚ä¸‹ï¼š 1234567RetryPolicy retryPolicy = new ExponentialBackoffRetry(1000, 3);CuratorFramework client =CuratorFrameworkFactory.newClient( connectionInfo, 5000, 3000, retryPolicy); newClienté™æ€å·¥å‚æ–¹æ³•åŒ…å«å››ä¸ªä¸»è¦å‚æ•°ï¼š å‚æ•°å è¯´æ˜ connectionString æœåŠ¡å™¨åˆ—è¡¨ï¼Œæ ¼å¼host1:port1,host2:port2,â€¦ retryPolicy é‡è¯•ç­–ç•¥,å†…å»ºæœ‰å››ç§é‡è¯•ç­–ç•¥,ä¹Ÿå¯ä»¥è‡ªè¡Œå®ç°RetryPolicyæ¥å£ sessionTimeoutMs ä¼šè¯è¶…æ—¶æ—¶é—´ï¼Œå•ä½æ¯«ç§’ï¼Œé»˜è®¤60000ms connectionTimeoutMs è¿æ¥åˆ›å»ºè¶…æ—¶æ—¶é—´ï¼Œå•ä½æ¯«ç§’ï¼Œé»˜è®¤60000ms 2.ä½¿ç”¨Fluenté£æ ¼çš„Apiåˆ›å»ºä¼šè¯ æ ¸å¿ƒå‚æ•°å˜ä¸ºæµå¼è®¾ç½®ï¼Œä¸€ä¸ªåˆ—å­å¦‚ä¸‹ï¼š 12345678 RetryPolicy retryPolicy = new ExponentialBackoffRetry(1000, 3);CuratorFramework client =CuratorFrameworkFactory.builder() .connectString(connectionInfo) .sessionTimeoutMs(5000) .connectionTimeoutMs(5000) .retryPolicy(retryPolicy) .build(); 3.åˆ›å»ºåŒ…å«éš”ç¦»å‘½åç©ºé—´çš„ä¼šè¯ ä¸ºäº†å®ç°ä¸åŒçš„Zookeeperä¸šåŠ¡ä¹‹é—´çš„éš”ç¦»ï¼Œéœ€è¦ä¸ºæ¯ä¸ªä¸šåŠ¡åˆ†é…ä¸€ä¸ªç‹¬ç«‹çš„å‘½åç©ºé—´ï¼ˆNameSpaceï¼‰ï¼Œå³æŒ‡å®šä¸€ä¸ªZookeeperçš„æ ¹è·¯å¾„ï¼ˆå®˜æ–¹æœ¯è¯­ï¼šä¸ºZookeeperæ·»åŠ â€œChrootâ€ç‰¹æ€§ï¼‰ã€‚ä¾‹å¦‚ï¼ˆä¸‹é¢çš„ä¾‹å­ï¼‰å½“å®¢æˆ·ç«¯æŒ‡å®šäº†ç‹¬ç«‹å‘½åç©ºé—´ä¸ºâ€œ/baseâ€ï¼Œé‚£ä¹ˆè¯¥å®¢æˆ·ç«¯å¯¹Zookeeperä¸Šçš„æ•°æ®èŠ‚ç‚¹çš„æ“ä½œéƒ½æ˜¯åŸºäºè¯¥ç›®å½•è¿›è¡Œçš„ã€‚é€šè¿‡è®¾ç½®Chrootå¯ä»¥å°†å®¢æˆ·ç«¯åº”ç”¨ä¸ZookeeperæœåŠ¡ç«¯çš„ä¸€è¯¾å­æ ‘ç›¸å¯¹åº”ï¼Œåœ¨å¤šä¸ªåº”ç”¨å…±ç”¨ä¸€ä¸ªZookeeperé›†ç¾¤çš„åœºæ™¯ä¸‹ï¼Œè¿™å¯¹äºå®ç°ä¸åŒåº”ç”¨ä¹‹é—´çš„ç›¸äº’éš”ç¦»ååˆ†æœ‰æ„ä¹‰ã€‚ 123456789RetryPolicy retryPolicy = new ExponentialBackoffRetry(1000, 3); CuratorFramework client = CuratorFrameworkFactory.builder() .connectString(connectionInfo) .sessionTimeoutMs(5000) .connectionTimeoutMs(5000) .retryPolicy(retryPolicy) .namespace(\"base\") .build(); å¯åŠ¨å®¢æˆ·ç«¯ å½“åˆ›å»ºä¼šè¯æˆåŠŸï¼Œå¾—åˆ°clientçš„å®ä¾‹ç„¶åå¯ä»¥ç›´æ¥è°ƒç”¨å…¶start( )æ–¹æ³•ï¼š 1client.start(); æ•°æ®èŠ‚ç‚¹æ“ä½œ åˆ›å»ºæ•°æ®èŠ‚ç‚¹ Zookeeperçš„èŠ‚ç‚¹åˆ›å»ºæ¨¡å¼ï¼š PERSISTENTï¼šæŒä¹…åŒ– PERSISTENT_SEQUENTIALï¼šæŒä¹…åŒ–å¹¶ä¸”å¸¦åºåˆ—å· EPHEMERALï¼šä¸´æ—¶ EPHEMERAL_SEQUENTIALï¼šä¸´æ—¶å¹¶ä¸”å¸¦åºåˆ—å· åˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹ï¼Œåˆå§‹å†…å®¹ä¸ºç©º 1client.create().forPath(&quot;path&quot;); æ³¨æ„ï¼šå¦‚æœæ²¡æœ‰è®¾ç½®èŠ‚ç‚¹å±æ€§ï¼ŒèŠ‚ç‚¹åˆ›å»ºæ¨¡å¼é»˜è®¤ä¸ºæŒä¹…åŒ–èŠ‚ç‚¹ï¼Œå†…å®¹é»˜è®¤ä¸ºç©º åˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹ï¼Œé™„å¸¦åˆå§‹åŒ–å†…å®¹ 1client.create().forPath(&quot;path&quot;,&quot;init&quot;.getBytes()); åˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹ï¼ŒæŒ‡å®šåˆ›å»ºæ¨¡å¼ï¼ˆä¸´æ—¶èŠ‚ç‚¹ï¼‰ï¼Œå†…å®¹ä¸ºç©º 1client.create().withMode(CreateMode.EPHEMERAL).forPath(&quot;path&quot;); åˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹ï¼ŒæŒ‡å®šåˆ›å»ºæ¨¡å¼ï¼ˆä¸´æ—¶èŠ‚ç‚¹ï¼‰ï¼Œé™„å¸¦åˆå§‹åŒ–å†…å®¹ 1client.create().withMode(CreateMode.EPHEMERAL).forPath(&quot;path&quot;,&quot;init&quot;.getBytes()); åˆ›å»ºä¸€ä¸ªèŠ‚ç‚¹ï¼ŒæŒ‡å®šåˆ›å»ºæ¨¡å¼ï¼ˆä¸´æ—¶èŠ‚ç‚¹ï¼‰ï¼Œé™„å¸¦åˆå§‹åŒ–å†…å®¹ï¼Œå¹¶ä¸”è‡ªåŠ¨é€’å½’åˆ›å»ºçˆ¶èŠ‚ç‚¹ 1234client.create() .creatingParentContainersIfNeeded() .withMode(CreateMode.EPHEMERAL) .forPath(\"path\",\"init\".getBytes()); è¿™ä¸ªcreatingParentContainersIfNeeded()æ¥å£éå¸¸æœ‰ç”¨ï¼Œå› ä¸ºä¸€èˆ¬æƒ…å†µå¼€å‘äººå‘˜åœ¨åˆ›å»ºä¸€ä¸ªå­èŠ‚ç‚¹å¿…é¡»åˆ¤æ–­å®ƒçš„çˆ¶èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨ç›´æ¥åˆ›å»ºä¼šæŠ›å‡ºNoNodeExceptionï¼Œä½¿ç”¨creatingParentContainersIfNeeded()ä¹‹åCuratorèƒ½å¤Ÿè‡ªåŠ¨é€’å½’åˆ›å»ºæ‰€æœ‰æ‰€éœ€çš„çˆ¶èŠ‚ç‚¹ã€‚ åˆ é™¤æ•°æ®èŠ‚ç‚¹ åˆ é™¤ä¸€ä¸ªèŠ‚ç‚¹ 1client.delete().forPath(&quot;path&quot;); æ³¨æ„ï¼Œæ­¤æ–¹æ³•åªèƒ½åˆ é™¤å¶å­èŠ‚ç‚¹ï¼Œå¦åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ åˆ é™¤ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¹¶ä¸”é€’å½’åˆ é™¤å…¶æ‰€æœ‰çš„å­èŠ‚ç‚¹ 1client.delete().deletingChildrenIfNeeded().forPath(&quot;path&quot;); åˆ é™¤ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¼ºåˆ¶æŒ‡å®šç‰ˆæœ¬è¿›è¡Œåˆ é™¤ 1client.delete().withVersion(10086).forPath(&quot;path&quot;); åˆ é™¤ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¼ºåˆ¶ä¿è¯åˆ é™¤ 1client.delete().guaranteed().forPath(&quot;path&quot;); guaranteed()æ¥å£æ˜¯ä¸€ä¸ªä¿éšœæªæ–½ï¼Œåªè¦å®¢æˆ·ç«¯ä¼šè¯æœ‰æ•ˆï¼Œé‚£ä¹ˆCuratorä¼šåœ¨åå°æŒç»­è¿›è¡Œåˆ é™¤æ“ä½œï¼Œç›´åˆ°åˆ é™¤èŠ‚ç‚¹æˆåŠŸã€‚ **æ³¨æ„ï¼š**ä¸Šé¢çš„å¤šä¸ªæµå¼æ¥å£æ˜¯å¯ä»¥è‡ªç”±ç»„åˆçš„ï¼Œä¾‹å¦‚ï¼š 1client.delete().guaranteed().deletingChildrenIfNeeded().withVersion(10086).forPath(&quot;path&quot;); è¯»å–æ•°æ®èŠ‚ç‚¹æ•°æ® è¯»å–ä¸€ä¸ªèŠ‚ç‚¹çš„æ•°æ®å†…å®¹ 1client.getData().forPath(&quot;path&quot;); æ³¨æ„ï¼Œæ­¤æ–¹æ³•è¿”çš„è¿”å›å€¼æ˜¯byte[ ]; è¯»å–ä¸€ä¸ªèŠ‚ç‚¹çš„æ•°æ®å†…å®¹ï¼ŒåŒæ—¶è·å–åˆ°è¯¥èŠ‚ç‚¹çš„stat 12Stat stat &#x3D; new Stat();client.getData().storingStatIn(stat).forPath(&quot;path&quot;); æ›´æ–°æ•°æ®èŠ‚ç‚¹æ•°æ® æ›´æ–°ä¸€ä¸ªèŠ‚ç‚¹çš„æ•°æ®å†…å®¹ 1client.setData().forPath(&quot;path&quot;,&quot;data&quot;.getBytes()); æ³¨æ„ï¼šè¯¥æ¥å£ä¼šè¿”å›ä¸€ä¸ªStatå®ä¾‹ æ›´æ–°ä¸€ä¸ªèŠ‚ç‚¹çš„æ•°æ®å†…å®¹ï¼Œå¼ºåˆ¶æŒ‡å®šç‰ˆæœ¬è¿›è¡Œæ›´æ–° 1client.setData().withVersion(10086).forPath(&quot;path&quot;,&quot;data&quot;.getBytes()); æ£€æŸ¥èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨ 1client.checkExists().forPath(&quot;path&quot;); æ³¨æ„ï¼šè¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªStatå®ä¾‹ï¼Œç”¨äºæ£€æŸ¥ZNodeæ˜¯å¦å­˜åœ¨çš„æ“ä½œ. å¯ä»¥è°ƒç”¨é¢å¤–çš„æ–¹æ³•(ç›‘æ§æˆ–è€…åå°å¤„ç†)å¹¶åœ¨æœ€åè°ƒç”¨forPath()æŒ‡å®šè¦æ“ä½œçš„ZNode è·å–æŸä¸ªèŠ‚ç‚¹çš„æ‰€æœ‰å­èŠ‚ç‚¹è·¯å¾„ 1client.getChildren().forPath(&quot;path&quot;); æ³¨æ„ï¼šè¯¥æ–¹æ³•çš„è¿”å›å€¼ä¸ºList,è·å¾—ZNodeçš„å­èŠ‚ç‚¹Pathåˆ—è¡¨ã€‚ å¯ä»¥è°ƒç”¨é¢å¤–çš„æ–¹æ³•(ç›‘æ§ã€åå°å¤„ç†æˆ–è€…è·å–çŠ¶æ€watch, background or get stat) å¹¶åœ¨æœ€åè°ƒç”¨forPath()æŒ‡å®šè¦æ“ä½œçš„çˆ¶ZNode äº‹åŠ¡ CuratorFrameworkçš„å®ä¾‹åŒ…å«inTransaction( )æ¥å£æ–¹æ³•ï¼Œè°ƒç”¨æ­¤æ–¹æ³•å¼€å¯ä¸€ä¸ªZooKeeperäº‹åŠ¡. å¯ä»¥å¤åˆcreate, setData, check, and/or delete ç­‰æ“ä½œç„¶åè°ƒç”¨commit()ä½œä¸ºä¸€ä¸ªåŸå­æ“ä½œæäº¤ã€‚ä¸€ä¸ªä¾‹å­å¦‚ä¸‹ï¼š 1234567client.inTransaction().check().forPath(\"path\") .and() .create().withMode(CreateMode.EPHEMERAL).forPath(\"path\",\"data\".getBytes()) .and() .setData().withVersion(10086).forPath(\"path\",\"data2\".getBytes()) .and() .commit(); å¼‚æ­¥æ¥å£ ä¸Šé¢æåˆ°çš„åˆ›å»ºã€åˆ é™¤ã€æ›´æ–°ã€è¯»å–ç­‰æ–¹æ³•éƒ½æ˜¯åŒæ­¥çš„ï¼ŒCuratoræä¾›å¼‚æ­¥æ¥å£ï¼Œå¼•å…¥äº†BackgroundCallbackæ¥å£ç”¨äºå¤„ç†å¼‚æ­¥æ¥å£è°ƒç”¨ä¹‹åæœåŠ¡ç«¯è¿”å›çš„ç»“æœä¿¡æ¯ã€‚BackgroundCallbackæ¥å£ä¸­ä¸€ä¸ªé‡è¦çš„å›è°ƒå€¼ä¸ºCuratorEventï¼Œé‡Œé¢åŒ…å«äº‹ä»¶ç±»å‹ã€å“åº”å—å’ŒèŠ‚ç‚¹çš„è¯¦ç»†ä¿¡æ¯ã€‚ CuratorEventType äº‹ä»¶ç±»å‹ å¯¹åº”CuratorFrameworkå®ä¾‹çš„æ–¹æ³• CREATE #create() DELETE #delete() EXISTS #checkExists() GET_DATA #getData() SET_DATA #setData() CHILDREN #getChildren() SYNC #sync(String,Object) GET_ACL #getACL() SET_ACL #setACL() WATCHED #Watcher(Watcher) CLOSING #close() å“åº”ç (#getResultCode()) å“åº”ç  æ„ä¹‰ 0 OKï¼Œå³è°ƒç”¨æˆåŠŸ -4 ConnectionLossï¼Œå³å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯æ–­å¼€è¿æ¥ -110 NodeExistsï¼Œå³èŠ‚ç‚¹å·²ç»å­˜åœ¨ -112 SessionExpiredï¼Œå³ä¼šè¯è¿‡æœŸ ä¸€ä¸ªå¼‚æ­¥åˆ›å»ºèŠ‚ç‚¹çš„ä¾‹å­å¦‚ä¸‹ï¼š 1234567Executor executor = Executors.newFixedThreadPool(2);client.create() .creatingParentsIfNeeded() .withMode(CreateMode.EPHEMERAL) .inBackground((curatorFramework, curatorEvent) -&gt; &#123; System.out.println(String.format(\"eventType:%s,resultCode:%s\",curatorEvent.getType(),curatorEvent.getResultCode())); &#125;,executor) .forPath(\"path\"); æ³¨æ„ï¼šå¦‚æœ#inBackground()æ–¹æ³•ä¸æŒ‡å®šexecutorï¼Œé‚£ä¹ˆä¼šé»˜è®¤ä½¿ç”¨Curatorçš„EventThreadå»è¿›è¡Œå¼‚æ­¥å¤„ç†ã€‚ Curatoré£Ÿè°±(é«˜çº§ç‰¹æ€§) æé†’ï¼šé¦–å…ˆä½ å¿…é¡»æ·»åŠ curator-recipesä¾èµ–ï¼Œä¸‹æ–‡ä»…ä»…å¯¹recipesä¸€äº›ç‰¹æ€§çš„ä½¿ç”¨è¿›è¡Œè§£é‡Šå’Œä¸¾ä¾‹ï¼Œä¸æ‰“ç®—è¿›è¡Œæºç çº§åˆ«çš„æ¢è®¨ 12345&lt;dependency&gt; &lt;groupId&gt;org.apache.curator&lt;/groupId&gt; &lt;artifactId&gt;curator-recipes&lt;/artifactId&gt; &lt;version&gt;2.12.0&lt;/version&gt;&lt;/dependency&gt; é‡è¦æé†’ï¼šå¼ºçƒˆæ¨èä½¿ç”¨ConnectionStateListenerç›‘æ§è¿æ¥çš„çŠ¶æ€ï¼Œå½“è¿æ¥çŠ¶æ€ä¸ºLOSTï¼Œcurator-recipesä¸‹çš„æ‰€æœ‰Apiå°†ä¼šå¤±æ•ˆæˆ–è€…è¿‡æœŸï¼Œå°½ç®¡åé¢æ‰€æœ‰çš„ä¾‹å­éƒ½æ²¡æœ‰ä½¿ç”¨åˆ°ConnectionStateListenerã€‚ ç¼“å­˜ ZookeeperåŸç”Ÿæ”¯æŒé€šè¿‡æ³¨å†ŒWatcheræ¥è¿›è¡Œäº‹ä»¶ç›‘å¬ï¼Œä½†æ˜¯å¼€å‘è€…éœ€è¦åå¤æ³¨å†Œ(Watcheråªèƒ½å•æ¬¡æ³¨å†Œå•æ¬¡ä½¿ç”¨)ã€‚Cacheæ˜¯Curatorä¸­å¯¹äº‹ä»¶ç›‘å¬çš„åŒ…è£…ï¼Œå¯ä»¥çœ‹ä½œæ˜¯å¯¹äº‹ä»¶ç›‘å¬çš„æœ¬åœ°ç¼“å­˜è§†å›¾ï¼Œèƒ½å¤Ÿè‡ªåŠ¨ä¸ºå¼€å‘è€…å¤„ç†åå¤æ³¨å†Œç›‘å¬ã€‚Curatoræä¾›äº†ä¸‰ç§Watcher(Cache)æ¥ç›‘å¬ç»“ç‚¹çš„å˜åŒ–ã€‚ Path Cache Path Cacheç”¨æ¥ç›‘æ§ä¸€ä¸ªZNodeçš„å­èŠ‚ç‚¹. å½“ä¸€ä¸ªå­èŠ‚ç‚¹å¢åŠ ï¼Œ æ›´æ–°ï¼Œåˆ é™¤æ—¶ï¼Œ Path Cacheä¼šæ”¹å˜å®ƒçš„çŠ¶æ€ï¼Œ ä¼šåŒ…å«æœ€æ–°çš„å­èŠ‚ç‚¹ï¼Œ å­èŠ‚ç‚¹çš„æ•°æ®å’ŒçŠ¶æ€ï¼Œè€ŒçŠ¶æ€çš„æ›´å˜å°†é€šè¿‡PathChildrenCacheListeneré€šçŸ¥ã€‚ å®é™…ä½¿ç”¨æ—¶ä¼šæ¶‰åŠåˆ°å››ä¸ªç±»ï¼š PathChildrenCache PathChildrenCacheEvent PathChildrenCacheListener ChildData é€šè¿‡ä¸‹é¢çš„æ„é€ å‡½æ•°åˆ›å»ºPath Cache: 1public PathChildrenCache(CuratorFramework client, String path, boolean cacheData) æƒ³ä½¿ç”¨cacheï¼Œå¿…é¡»è°ƒç”¨å®ƒçš„startæ–¹æ³•ï¼Œä½¿ç”¨å®Œåè°ƒç”¨closeæ–¹æ³•ã€‚ å¯ä»¥è®¾ç½®StartModeæ¥å®ç°å¯åŠ¨çš„æ¨¡å¼ï¼Œ StartModeæœ‰ä¸‹é¢å‡ ç§ï¼š NORMALï¼šæ­£å¸¸åˆå§‹åŒ–ã€‚ BUILD_INITIAL_CACHEï¼šåœ¨è°ƒç”¨start()ä¹‹å‰ä¼šè°ƒç”¨rebuild()ã€‚ POST_INITIALIZED_EVENTï¼š å½“Cacheåˆå§‹åŒ–æ•°æ®åå‘é€ä¸€ä¸ªPathChildrenCacheEvent.Type#INITIALIZEDäº‹ä»¶ public void addListener(PathChildrenCacheListener listener)å¯ä»¥å¢åŠ listenerç›‘å¬ç¼“å­˜çš„å˜åŒ–ã€‚ getCurrentData()æ–¹æ³•è¿”å›ä¸€ä¸ªList&lt;ChildData&gt;å¯¹è±¡ï¼Œå¯ä»¥éå†æ‰€æœ‰çš„å­èŠ‚ç‚¹ã€‚ è®¾ç½®/æ›´æ–°ã€ç§»é™¤å…¶å®æ˜¯ä½¿ç”¨client (CuratorFramework)æ¥æ“ä½œ, ä¸é€šè¿‡PathChildrenCacheæ“ä½œï¼š 1234567891011121314151617181920212223242526272829303132333435public class PathCacheDemo &#123; private static final String PATH = \"/example/pathCache\"; public static void main(String[] args) throws Exception &#123; TestingServer server = new TestingServer(); CuratorFramework client = CuratorFrameworkFactory.newClient(server.getConnectString(), new ExponentialBackoffRetry(1000, 3)); client.start(); PathChildrenCache cache = new PathChildrenCache(client, PATH, true); cache.start(); PathChildrenCacheListener cacheListener = (client1, event) -&gt; &#123; System.out.println(\"äº‹ä»¶ç±»å‹ï¼š\" + event.getType()); if (null != event.getData()) &#123; System.out.println(\"èŠ‚ç‚¹æ•°æ®ï¼š\" + event.getData().getPath() + \" = \" + new String(event.getData().getData())); &#125; &#125;; cache.getListenable().addListener(cacheListener); client.create().creatingParentsIfNeeded().forPath(\"/example/pathCache/test01\", \"01\".getBytes()); Thread.sleep(10); client.create().creatingParentsIfNeeded().forPath(\"/example/pathCache/test02\", \"02\".getBytes()); Thread.sleep(10); client.setData().forPath(\"/example/pathCache/test01\", \"01_V2\".getBytes()); Thread.sleep(10); for (ChildData data : cache.getCurrentData()) &#123; System.out.println(\"getCurrentData:\" + data.getPath() + \" = \" + new String(data.getData())); &#125; client.delete().forPath(\"/example/pathCache/test01\"); Thread.sleep(10); client.delete().forPath(\"/example/pathCache/test02\"); Thread.sleep(1000 * 5); cache.close(); client.close(); System.out.println(\"OK!\"); &#125;&#125; **æ³¨æ„ï¼š**å¦‚æœnew PathChildrenCache(client, PATH, true)ä¸­çš„å‚æ•°cacheDataå€¼è®¾ç½®ä¸ºfalseï¼Œåˆ™ç¤ºä¾‹ä¸­çš„event.getData().getData()ã€data.getData()å°†è¿”å›nullï¼Œcacheå°†ä¸ä¼šç¼“å­˜èŠ‚ç‚¹æ•°æ®ã€‚ **æ³¨æ„ï¼š**ç¤ºä¾‹ä¸­çš„Thread.sleep(10)å¯ä»¥æ³¨é‡Šæ‰ï¼Œä½†æ˜¯æ³¨é‡Šåäº‹ä»¶ç›‘å¬çš„è§¦å‘æ¬¡æ•°ä¼šä¸å…¨ï¼Œè¿™å¯èƒ½ä¸PathCacheçš„å®ç°åŸç†æœ‰å…³ï¼Œä¸èƒ½å¤ªè¿‡é¢‘ç¹çš„è§¦å‘äº‹ä»¶ï¼ Node Cache Node Cacheä¸Path Cacheç±»ä¼¼ï¼ŒNode Cacheåªæ˜¯ç›‘å¬æŸä¸€ä¸ªç‰¹å®šçš„èŠ‚ç‚¹ã€‚å®ƒæ¶‰åŠåˆ°ä¸‹é¢çš„ä¸‰ä¸ªç±»ï¼š NodeCache - Node Cacheå®ç°ç±» NodeCacheListener - èŠ‚ç‚¹ç›‘å¬å™¨ ChildData - èŠ‚ç‚¹æ•°æ® **æ³¨æ„ï¼š**ä½¿ç”¨cacheï¼Œä¾ç„¶è¦è°ƒç”¨å®ƒçš„start()æ–¹æ³•ï¼Œä½¿ç”¨å®Œåè°ƒç”¨close()æ–¹æ³•ã€‚ getCurrentData()å°†å¾—åˆ°èŠ‚ç‚¹å½“å‰çš„çŠ¶æ€ï¼Œé€šè¿‡å®ƒçš„çŠ¶æ€å¯ä»¥å¾—åˆ°å½“å‰çš„å€¼ã€‚ 12345678910111213141516171819202122232425262728293031public class NodeCacheDemo &#123; private static final String PATH = \"/example/cache\"; public static void main(String[] args) throws Exception &#123; TestingServer server = new TestingServer(); CuratorFramework client = CuratorFrameworkFactory.newClient(server.getConnectString(), new ExponentialBackoffRetry(1000, 3)); client.start(); client.create().creatingParentsIfNeeded().forPath(PATH); final NodeCache cache = new NodeCache(client, PATH); NodeCacheListener listener = () -&gt; &#123; ChildData data = cache.getCurrentData(); if (null != data) &#123; System.out.println(\"èŠ‚ç‚¹æ•°æ®ï¼š\" + new String(cache.getCurrentData().getData())); &#125; else &#123; System.out.println(\"èŠ‚ç‚¹è¢«åˆ é™¤!\"); &#125; &#125;; cache.getListenable().addListener(listener); cache.start(); client.setData().forPath(PATH, \"01\".getBytes()); Thread.sleep(100); client.setData().forPath(PATH, \"02\".getBytes()); Thread.sleep(100); client.delete().deletingChildrenIfNeeded().forPath(PATH); Thread.sleep(1000 * 2); cache.close(); client.close(); System.out.println(\"OK!\"); &#125;&#125; **æ³¨æ„ï¼š**ç¤ºä¾‹ä¸­çš„Thread.sleep(10)å¯ä»¥æ³¨é‡Šï¼Œä½†æ˜¯æ³¨é‡Šåäº‹ä»¶ç›‘å¬çš„è§¦å‘æ¬¡æ•°ä¼šä¸å…¨ï¼Œè¿™å¯èƒ½ä¸NodeCacheçš„å®ç°åŸç†æœ‰å…³ï¼Œä¸èƒ½å¤ªè¿‡é¢‘ç¹çš„è§¦å‘äº‹ä»¶ï¼ **æ³¨æ„ï¼š**NodeCacheåªèƒ½ç›‘å¬ä¸€ä¸ªèŠ‚ç‚¹çš„çŠ¶æ€å˜åŒ–ã€‚ Tree Cache Tree Cacheå¯ä»¥ç›‘æ§æ•´ä¸ªæ ‘ä¸Šçš„æ‰€æœ‰èŠ‚ç‚¹ï¼Œç±»ä¼¼äºPathCacheå’ŒNodeCacheçš„ç»„åˆï¼Œä¸»è¦æ¶‰åŠåˆ°ä¸‹é¢å››ä¸ªç±»ï¼š TreeCache - Tree Cacheå®ç°ç±» TreeCacheListener - ç›‘å¬å™¨ç±» TreeCacheEvent - è§¦å‘çš„äº‹ä»¶ç±» ChildData - èŠ‚ç‚¹æ•°æ® 1234567891011121314151617181920212223242526public class TreeCacheDemo &#123; private static final String PATH = \"/example/cache\"; public static void main(String[] args) throws Exception &#123; TestingServer server = new TestingServer(); CuratorFramework client = CuratorFrameworkFactory.newClient(server.getConnectString(), new ExponentialBackoffRetry(1000, 3)); client.start(); client.create().creatingParentsIfNeeded().forPath(PATH); TreeCache cache = new TreeCache(client, PATH); TreeCacheListener listener = (client1, event) -&gt; System.out.println(\"äº‹ä»¶ç±»å‹ï¼š\" + event.getType() + \" | è·¯å¾„ï¼š\" + (null != event.getData() ? event.getData().getPath() : null)); cache.getListenable().addListener(listener); cache.start(); client.setData().forPath(PATH, \"01\".getBytes()); Thread.sleep(100); client.setData().forPath(PATH, \"02\".getBytes()); Thread.sleep(100); client.delete().deletingChildrenIfNeeded().forPath(PATH); Thread.sleep(1000 * 2); cache.close(); client.close(); System.out.println(\"OK!\"); &#125;&#125; **æ³¨æ„ï¼š**åœ¨æ­¤ç¤ºä¾‹ä¸­æ²¡æœ‰ä½¿ç”¨Thread.sleep(10)ï¼Œä½†æ˜¯äº‹ä»¶è§¦å‘æ¬¡æ•°ä¹Ÿæ˜¯æ­£å¸¸çš„ã€‚ **æ³¨æ„ï¼š**TreeCacheåœ¨åˆå§‹åŒ–(è°ƒç”¨start()æ–¹æ³•)çš„æ—¶å€™ä¼šå›è°ƒTreeCacheListenerå®ä¾‹ä¸€ä¸ªäº‹TreeCacheEventï¼Œè€Œå›è°ƒçš„TreeCacheEventå¯¹è±¡çš„Typeä¸ºINITIALIZEDï¼ŒChildDataä¸ºnullï¼Œæ­¤æ—¶event.getData().getPath()å¾ˆæœ‰å¯èƒ½å¯¼è‡´ç©ºæŒ‡é’ˆå¼‚å¸¸ï¼Œè¿™é‡Œåº”è¯¥ä¸»åŠ¨å¤„ç†å¹¶é¿å…è¿™ç§æƒ…å†µã€‚ Leaderé€‰ä¸¾ åœ¨åˆ†å¸ƒå¼è®¡ç®—ä¸­ï¼Œ leader electionsæ˜¯å¾ˆé‡è¦çš„ä¸€ä¸ªåŠŸèƒ½ï¼Œ è¿™ä¸ªé€‰ä¸¾è¿‡ç¨‹æ˜¯è¿™æ ·å­çš„ï¼š æŒ‡æ´¾ä¸€ä¸ªè¿›ç¨‹ä½œä¸ºç»„ç»‡è€…ï¼Œå°†ä»»åŠ¡åˆ†å‘ç»™å„èŠ‚ç‚¹ã€‚ åœ¨ä»»åŠ¡å¼€å§‹å‰ï¼Œ å“ªä¸ªèŠ‚ç‚¹éƒ½ä¸çŸ¥é“è°æ˜¯leader(é¢†å¯¼è€…)æˆ–è€…coordinator(åè°ƒè€…). å½“é€‰ä¸¾ç®—æ³•å¼€å§‹æ‰§è¡Œåï¼Œ æ¯ä¸ªèŠ‚ç‚¹æœ€ç»ˆä¼šå¾—åˆ°ä¸€ä¸ªå”¯ä¸€çš„èŠ‚ç‚¹ä½œä¸ºä»»åŠ¡leader. é™¤æ­¤ä¹‹å¤–ï¼Œ é€‰ä¸¾è¿˜ç»å¸¸ä¼šå‘ç”Ÿåœ¨leaderæ„å¤–å®•æœºçš„æƒ…å†µä¸‹ï¼Œæ–°çš„leaderè¦è¢«é€‰ä¸¾å‡ºæ¥ã€‚ åœ¨zookeeperé›†ç¾¤ä¸­ï¼Œleaderè´Ÿè´£å†™æ“ä½œï¼Œç„¶åé€šè¿‡Zabåè®®å®ç°followerçš„åŒæ­¥ï¼Œleaderæˆ–è€…followeréƒ½å¯ä»¥å¤„ç†è¯»æ“ä½œã€‚ Curator æœ‰ä¸¤ç§leaderé€‰ä¸¾çš„recipe,åˆ†åˆ«æ˜¯LeaderSelectorå’ŒLeaderLatchã€‚ å‰è€…æ˜¯æ‰€æœ‰å­˜æ´»çš„å®¢æˆ·ç«¯ä¸é—´æ–­çš„è½®æµåšLeaderï¼Œå¤§åŒç¤¾ä¼šã€‚åè€…æ˜¯ä¸€æ—¦é€‰ä¸¾å‡ºLeaderï¼Œé™¤éæœ‰å®¢æˆ·ç«¯æŒ‚æ‰é‡æ–°è§¦å‘é€‰ä¸¾ï¼Œå¦åˆ™ä¸ä¼šäº¤å‡ºé¢†å¯¼æƒã€‚æŸå…š? LeaderLatch LeaderLatchæœ‰ä¸¤ä¸ªæ„é€ å‡½æ•°ï¼š 12public LeaderLatch(CuratorFramework client, String latchPath)public LeaderLatch(CuratorFramework client, String latchPath, String id) LeaderLatchçš„å¯åŠ¨ï¼š leaderLatch.start( ); ä¸€æ—¦å¯åŠ¨ï¼ŒLeaderLatchä¼šå’Œå…¶å®ƒä½¿ç”¨ç›¸åŒlatch pathçš„å…¶å®ƒLeaderLatchäº¤æ¶‰ï¼Œç„¶åå…¶ä¸­ä¸€ä¸ªæœ€ç»ˆä¼šè¢«é€‰ä¸¾ä¸ºleaderï¼Œå¯ä»¥é€šè¿‡hasLeadershipæ–¹æ³•æŸ¥çœ‹LeaderLatchå®ä¾‹æ˜¯å¦leaderï¼š leaderLatch.hasLeadership( ); //è¿”å›trueè¯´æ˜å½“å‰å®ä¾‹æ˜¯leader ç±»ä¼¼JDKçš„CountDownLatchï¼Œ LeaderLatchåœ¨è¯·æ±‚æˆä¸ºleadershipä¼šblock(é˜»å¡)ï¼Œä¸€æ—¦ä¸ä½¿ç”¨LeaderLatchäº†ï¼Œå¿…é¡»è°ƒç”¨closeæ–¹æ³•ã€‚ å¦‚æœå®ƒæ˜¯leader,ä¼šé‡Šæ”¾leadershipï¼Œ å…¶å®ƒçš„å‚ä¸è€…å°†ä¼šé€‰ä¸¾ä¸€ä¸ªleaderã€‚ 1234public void await() throws InterruptedException,EOFException/*Causes the current thread to wait until this instance acquires leadershipunless the thread is interrupted or closed.*/public boolean await(long timeout,TimeUnit unit)throws InterruptedException å¼‚å¸¸å¤„ç†ï¼š LeaderLatchå®ä¾‹å¯ä»¥å¢åŠ ConnectionStateListeneræ¥ç›‘å¬ç½‘ç»œè¿æ¥é—®é¢˜ã€‚ å½“ SUSPENDED æˆ– LOST æ—¶, leaderä¸å†è®¤ä¸ºè‡ªå·±è¿˜æ˜¯leaderã€‚å½“LOSTåè¿æ¥é‡è¿åRECONNECTED,LeaderLatchä¼šåˆ é™¤å…ˆå‰çš„ZNodeç„¶åé‡æ–°åˆ›å»ºä¸€ä¸ªã€‚LeaderLatchç”¨æˆ·å¿…é¡»è€ƒè™‘å¯¼è‡´leadershipä¸¢å¤±çš„è¿æ¥é—®é¢˜ã€‚ å¼ºçƒˆæ¨èä½ ä½¿ç”¨ConnectionStateListenerã€‚ ä¸€ä¸ªLeaderLatchçš„ä½¿ç”¨ä¾‹å­ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364public class LeaderLatchDemo extends BaseConnectionInfo &#123; protected static String PATH = \"/francis/leader\"; private static final int CLIENT_QTY = 10; public static void main(String[] args) throws Exception &#123; List&lt;CuratorFramework&gt; clients = Lists.newArrayList(); List&lt;LeaderLatch&gt; examples = Lists.newArrayList(); TestingServer server=new TestingServer(); try &#123; for (int i = 0; i &lt; CLIENT_QTY; i++) &#123; CuratorFramework client = CuratorFrameworkFactory.newClient(server.getConnectString(), new ExponentialBackoffRetry(20000, 3)); clients.add(client); LeaderLatch latch = new LeaderLatch(client, PATH, \"Client #\" + i); latch.addListener(new LeaderLatchListener() &#123; @Override public void isLeader() &#123; // TODO Auto-generated method stub System.out.println(\"I am Leader\"); &#125; @Override public void notLeader() &#123; // TODO Auto-generated method stub System.out.println(\"I am not Leader\"); &#125; &#125;); examples.add(latch); client.start(); latch.start(); &#125; Thread.sleep(10000); LeaderLatch currentLeader = null; for (LeaderLatch latch : examples) &#123; if (latch.hasLeadership()) &#123; currentLeader = latch; &#125; &#125; System.out.println(\"current leader is \" + currentLeader.getId()); System.out.println(\"release the leader \" + currentLeader.getId()); currentLeader.close(); Thread.sleep(5000); for (LeaderLatch latch : examples) &#123; if (latch.hasLeadership()) &#123; currentLeader = latch; &#125; &#125; System.out.println(\"current leader is \" + currentLeader.getId()); System.out.println(\"release the leader \" + currentLeader.getId()); &#125; finally &#123; for (LeaderLatch latch : examples) &#123; if (null != latch.getState()) CloseableUtils.closeQuietly(latch); &#125; for (CuratorFramework client : clients) &#123; CloseableUtils.closeQuietly(client); &#125; &#125; &#125;&#125; å¯ä»¥æ·»åŠ test moduleçš„ä¾èµ–æ–¹ä¾¿è¿›è¡Œæµ‹è¯•ï¼Œä¸éœ€è¦å¯åŠ¨çœŸå®çš„zookeeperæœåŠ¡ç«¯ï¼š 12345&lt;dependency&gt; &lt;groupId&gt;org.apache.curator&lt;/groupId&gt; &lt;artifactId&gt;curator-test&lt;/artifactId&gt; &lt;version&gt;2.12.0&lt;/version&gt;&lt;/dependency&gt; é¦–å…ˆæˆ‘ä»¬åˆ›å»ºäº†10ä¸ªLeaderLatchï¼Œå¯åŠ¨åå®ƒä»¬ä¸­çš„ä¸€ä¸ªä¼šè¢«é€‰ä¸¾ä¸ºleaderã€‚ å› ä¸ºé€‰ä¸¾ä¼šèŠ±è´¹ä¸€äº›æ—¶é—´ï¼Œstartåå¹¶ä¸èƒ½é©¬ä¸Šå°±å¾—åˆ°leaderã€‚ é€šè¿‡hasLeadershipæŸ¥çœ‹è‡ªå·±æ˜¯å¦æ˜¯leaderï¼Œ å¦‚æœæ˜¯çš„è¯è¿”å›trueã€‚ å¯ä»¥é€šè¿‡.getLeader().getId()å¯ä»¥å¾—åˆ°å½“å‰çš„leaderçš„IDã€‚ åªèƒ½é€šè¿‡closeé‡Šæ”¾å½“å‰çš„é¢†å¯¼æƒã€‚ awaitæ˜¯ä¸€ä¸ªé˜»å¡æ–¹æ³•ï¼Œ å°è¯•è·å–leaderåœ°ä½ï¼Œä½†æ˜¯æœªå¿…èƒ½ä¸Šä½ã€‚ LeaderSelector LeaderSelectorä½¿ç”¨çš„æ—¶å€™ä¸»è¦æ¶‰åŠä¸‹é¢å‡ ä¸ªç±»ï¼š LeaderSelector LeaderSelectorListener LeaderSelectorListenerAdapter CancelLeadershipException æ ¸å¿ƒç±»æ˜¯LeaderSelectorï¼Œå®ƒçš„æ„é€ å‡½æ•°å¦‚ä¸‹ï¼š 12public LeaderSelector(CuratorFramework client, String mutexPath,LeaderSelectorListener listener)public LeaderSelector(CuratorFramework client, String mutexPath, ThreadFactory threadFactory, Executor executor, LeaderSelectorListener listener) ç±»ä¼¼LeaderLatch,LeaderSelectorå¿…é¡»start: leaderSelector.start(); ä¸€æ—¦å¯åŠ¨ï¼Œå½“å®ä¾‹å–å¾—é¢†å¯¼æƒæ—¶ä½ çš„listenerçš„takeLeadership()æ–¹æ³•è¢«è°ƒç”¨ã€‚è€ŒtakeLeadership()æ–¹æ³•åªæœ‰é¢†å¯¼æƒè¢«é‡Šæ”¾æ—¶æ‰è¿”å›ã€‚ å½“ä½ ä¸å†ä½¿ç”¨LeaderSelectorå®ä¾‹æ—¶ï¼Œåº”è¯¥è°ƒç”¨å®ƒçš„closeæ–¹æ³•ã€‚ å¼‚å¸¸å¤„ç† LeaderSelectorListenerç±»ç»§æ‰¿ConnectionStateListenerã€‚LeaderSelectorå¿…é¡»å°å¿ƒè¿æ¥çŠ¶æ€çš„æ”¹å˜ã€‚å¦‚æœå®ä¾‹æˆä¸ºleader, å®ƒåº”è¯¥å“åº”SUSPENDED æˆ– LOSTã€‚ å½“ SUSPENDED çŠ¶æ€å‡ºç°æ—¶ï¼Œ å®ä¾‹å¿…é¡»å‡å®šåœ¨é‡æ–°è¿æ¥æˆåŠŸä¹‹å‰å®ƒå¯èƒ½ä¸å†æ˜¯leaderäº†ã€‚ å¦‚æœLOSTçŠ¶æ€å‡ºç°ï¼Œ å®ä¾‹ä¸å†æ˜¯leaderï¼Œ takeLeadershipæ–¹æ³•è¿”å›ã€‚ é‡è¦: æ¨èå¤„ç†æ–¹å¼æ˜¯å½“æ”¶åˆ°SUSPENDED æˆ– LOSTæ—¶æŠ›å‡ºCancelLeadershipExceptionå¼‚å¸¸.ã€‚è¿™ä¼šå¯¼è‡´LeaderSelectorå®ä¾‹ä¸­æ–­å¹¶å–æ¶ˆæ‰§è¡ŒtakeLeadershipæ–¹æ³•çš„å¼‚å¸¸.ã€‚è¿™éå¸¸é‡è¦ï¼Œ ä½ å¿…é¡»è€ƒè™‘æ‰©å±•LeaderSelectorListenerAdapter. LeaderSelectorListenerAdapteræä¾›äº†æ¨èçš„å¤„ç†é€»è¾‘ã€‚ ä¸‹é¢çš„ä¸€ä¸ªä¾‹å­æ‘˜æŠ„è‡ªå®˜æ–¹ï¼š 1234567891011121314151617181920212223242526272829303132333435public class LeaderSelectorAdapter extends LeaderSelectorListenerAdapter implements Closeable &#123; private final String name; private final LeaderSelector leaderSelector; private final AtomicInteger leaderCount = new AtomicInteger(); public LeaderSelectorAdapter(CuratorFramework client, String path, String name) &#123; this.name = name; leaderSelector = new LeaderSelector(client, path, this); leaderSelector.autoRequeue(); &#125; public void start() throws IOException &#123; leaderSelector.start(); &#125; @Override public void close() throws IOException &#123; leaderSelector.close(); &#125; @Override public void takeLeadership(CuratorFramework client) throws Exception &#123; final int waitSeconds = (int) (5 * Math.random()) + 1; System.out.println(name + \" is now the leader. Waiting \" + waitSeconds + \" seconds...\"); System.out.println(name + \" has been leader \" + leaderCount.getAndIncrement() + \" time(s) before.\"); try &#123; Thread.sleep(TimeUnit.SECONDS.toMillis(waitSeconds)); &#125; catch (InterruptedException e) &#123; System.err.println(name + \" was interrupted.\"); Thread.currentThread().interrupt(); &#125; finally &#123; System.out.println(name + \" relinquishing leadership.\\n\"); &#125; &#125;&#125; ä½ å¯ä»¥åœ¨takeLeadershipè¿›è¡Œä»»åŠ¡çš„åˆ†é…ç­‰ç­‰ï¼Œå¹¶ä¸”ä¸è¦è¿”å›ï¼Œå¦‚æœä½ æƒ³è¦è¦æ­¤å®ä¾‹ä¸€ç›´æ˜¯leaderçš„è¯å¯ä»¥åŠ ä¸€ä¸ªæ­»å¾ªç¯ã€‚è°ƒç”¨ leaderSelector.autoRequeue();ä¿è¯åœ¨æ­¤å®ä¾‹é‡Šæ”¾é¢†å¯¼æƒä¹‹åè¿˜å¯èƒ½è·å¾—é¢†å¯¼æƒã€‚ åœ¨è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨AtomicIntegeræ¥è®°å½•æ­¤clientè·å¾—é¢†å¯¼æƒçš„æ¬¡æ•°ï¼Œ å®ƒæ˜¯â€fairâ€ï¼Œ æ¯ä¸ªclientæœ‰å¹³ç­‰çš„æœºä¼šè·å¾—é¢†å¯¼æƒã€‚ 12345678910111213141516171819202122232425262728293031323334public class LeaderSelectorDemo &#123; protected static String PATH = \"/francis/leader\"; private static final int CLIENT_QTY = 10; public static void main(String[] args) throws Exception &#123; List&lt;CuratorFramework&gt; clients = Lists.newArrayList(); List&lt;LeaderSelectorAdapter&gt; examples = Lists.newArrayList(); TestingServer server = new TestingServer(); try &#123; for (int i = 0; i &lt; CLIENT_QTY; i++) &#123; CuratorFramework client = CuratorFrameworkFactory.newClient(server.getConnectString(), new ExponentialBackoffRetry(20000, 3)); clients.add(client); LeaderSelectorAdapter selectorAdapter = new LeaderSelectorAdapter(client, PATH, \"Client #\" + i); examples.add(selectorAdapter); client.start(); selectorAdapter.start(); &#125; System.out.println(\"Press enter/return to quit\\n\"); new BufferedReader(new InputStreamReader(System.in)).readLine(); &#125; finally &#123; System.out.println(\"Shutting down...\"); for (LeaderSelectorAdapter exampleClient : examples) &#123; CloseableUtils.closeQuietly(exampleClient); &#125; for (CuratorFramework client : clients) &#123; CloseableUtils.closeQuietly(client); &#125; CloseableUtils.closeQuietly(server); &#125; &#125;&#125; å¯¹æ¯”å¯çŸ¥ï¼ŒLeaderLatchå¿…é¡»è°ƒç”¨close()æ–¹æ³•æ‰ä¼šé‡Šæ”¾é¢†å¯¼æƒï¼Œè€Œå¯¹äºLeaderSelectorï¼Œé€šè¿‡LeaderSelectorListenerå¯ä»¥å¯¹é¢†å¯¼æƒè¿›è¡Œæ§åˆ¶ï¼Œ åœ¨é€‚å½“çš„æ—¶å€™é‡Šæ”¾é¢†å¯¼æƒï¼Œè¿™æ ·æ¯ä¸ªèŠ‚ç‚¹éƒ½æœ‰å¯èƒ½è·å¾—é¢†å¯¼æƒã€‚ä»è€Œï¼ŒLeaderSelectorå…·æœ‰æ›´å¥½çš„çµæ´»æ€§å’Œå¯æ§æ€§ï¼Œå»ºè®®æœ‰LeaderElectionåº”ç”¨åœºæ™¯ä¸‹ä¼˜å…ˆä½¿ç”¨LeaderSelectorã€‚ åˆ†å¸ƒå¼é” æé†’ï¼š 1.æ¨èä½¿ç”¨ConnectionStateListenerç›‘æ§è¿æ¥çš„çŠ¶æ€ï¼Œå› ä¸ºå½“è¿æ¥LOSTæ—¶ä½ ä¸å†æ‹¥æœ‰é” 2.åˆ†å¸ƒå¼çš„é”å…¨å±€åŒæ­¥ï¼Œ è¿™æ„å‘³ç€ä»»ä½•ä¸€ä¸ªæ—¶é—´ç‚¹ä¸ä¼šæœ‰ä¸¤ä¸ªå®¢æˆ·ç«¯éƒ½æ‹¥æœ‰ç›¸åŒçš„é”ã€‚ å¯é‡å…¥å…±äº«é”â€”Shared Reentrant Lock Sharedæ„å‘³ç€é”æ˜¯å…¨å±€å¯è§çš„ï¼Œ å®¢æˆ·ç«¯éƒ½å¯ä»¥è¯·æ±‚é”ã€‚ Reentrantå’ŒJDKçš„ReentrantLockç±»ä¼¼ï¼Œå³å¯é‡å…¥ï¼Œ æ„å‘³ç€åŒä¸€ä¸ªå®¢æˆ·ç«¯åœ¨æ‹¥æœ‰é”çš„åŒæ—¶ï¼Œå¯ä»¥å¤šæ¬¡è·å–ï¼Œä¸ä¼šè¢«é˜»å¡ã€‚ å®ƒæ˜¯ç”±ç±»InterProcessMutexæ¥å®ç°ã€‚ å®ƒçš„æ„é€ å‡½æ•°ä¸ºï¼š 1public InterProcessMutex(CuratorFramework client, String path) é€šè¿‡acquire()è·å¾—é”ï¼Œå¹¶æä¾›è¶…æ—¶æœºåˆ¶ï¼š 123456789101112public void acquire()Acquire the mutex - blocking until it's available. Note: the same thread can call acquirere-entrantly. Each call to acquire must be balanced by a call to release()public boolean acquire(long time,TimeUnit unit)Acquire the mutex - blocks until it's available or the given time expires. Note: the same thread can call acquire re-entrantly. Each call to acquire that returns true must be balanced by a call to release()Parameters:time - time to waitunit - time unitReturns:true if the mutex was acquired, false if not é€šè¿‡release()æ–¹æ³•é‡Šæ”¾é”ã€‚ InterProcessMutex å®ä¾‹å¯ä»¥é‡ç”¨ã€‚ Revoking ZooKeeper recipes wikiå®šä¹‰äº†å¯åå•†çš„æ’¤é”€æœºåˆ¶ã€‚ ä¸ºäº†æ’¤é”€mutex, è°ƒç”¨ä¸‹é¢çš„æ–¹æ³•ï¼š 1234public void makeRevocable(RevocationListener&lt;T&gt; listener)å°†é”è®¾ä¸ºå¯æ’¤é”€çš„. å½“åˆ«çš„è¿›ç¨‹æˆ–çº¿ç¨‹æƒ³è®©ä½ é‡Šæ”¾é”æ—¶Listenerä¼šè¢«è°ƒç”¨ã€‚Parameters:listener - the listener å¦‚æœä½ è¯·æ±‚æ’¤é”€å½“å‰çš„é”ï¼Œ è°ƒç”¨attemptRevoke()æ–¹æ³•,æ³¨æ„é”é‡Šæ”¾æ—¶RevocationListenerå°†ä¼šå›è°ƒã€‚ 1234567public static void attemptRevoke(CuratorFramework client,String path) throws ExceptionUtility to mark a lock for revocation. Assuming that the lock has been registeredwith a RevocationListener, it will get called and the lock should be released. Note,however, that revocation is cooperative.Parameters:client - the clientpath - the path of the lock - usually from something like InterProcessMutex.getParticipantNodes() äºŒæ¬¡æé†’ï¼šé”™è¯¯å¤„ç† è¿˜æ˜¯å¼ºçƒˆæ¨èä½ ä½¿ç”¨ConnectionStateListenerå¤„ç†è¿æ¥çŠ¶æ€çš„æ”¹å˜ã€‚ å½“è¿æ¥LOSTæ—¶ä½ ä¸å†æ‹¥æœ‰é”ã€‚ é¦–å…ˆè®©æˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ¨¡æ‹Ÿçš„å…±äº«èµ„æºï¼Œ è¿™ä¸ªèµ„æºæœŸæœ›åªèƒ½å•çº¿ç¨‹çš„è®¿é—®ï¼Œå¦åˆ™ä¼šæœ‰å¹¶å‘é—®é¢˜ã€‚ 1234567891011121314151617public class FakeLimitedResource &#123; private final AtomicBoolean inUse = new AtomicBoolean(false); public void use() throws InterruptedException &#123; // çœŸå®ç¯å¢ƒä¸­æˆ‘ä»¬ä¼šåœ¨è¿™é‡Œè®¿é—®/ç»´æŠ¤ä¸€ä¸ªå…±äº«çš„èµ„æº //è¿™ä¸ªä¾‹å­åœ¨ä½¿ç”¨é”çš„æƒ…å†µä¸‹ä¸ä¼šéæ³•å¹¶å‘å¼‚å¸¸IllegalStateException //ä½†æ˜¯åœ¨æ— é”çš„æƒ…å†µç”±äºsleepäº†ä¸€æ®µæ—¶é—´ï¼Œå¾ˆå®¹æ˜“æŠ›å‡ºå¼‚å¸¸ if (!inUse.compareAndSet(false, true)) &#123; throw new IllegalStateException(\"Needs to be used by one client at a time\"); &#125; try &#123; Thread.sleep((long) (3 * Math.random())); &#125; finally &#123; inUse.set(false); &#125; &#125;&#125; ç„¶ååˆ›å»ºä¸€ä¸ªInterProcessMutexDemoç±»ï¼Œ å®ƒè´Ÿè´£è¯·æ±‚é”ï¼Œ ä½¿ç”¨èµ„æºï¼Œé‡Šæ”¾é”è¿™æ ·ä¸€ä¸ªå®Œæ•´çš„è®¿é—®è¿‡ç¨‹ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263public class InterProcessMutexDemo &#123; private InterProcessMutex lock; private final FakeLimitedResource resource; private final String clientName; public InterProcessMutexDemo(CuratorFramework client, String lockPath, FakeLimitedResource resource, String clientName) &#123; this.resource = resource; this.clientName = clientName; this.lock = new InterProcessMutex(client, lockPath); &#125; public void doWork(long time, TimeUnit unit) throws Exception &#123; if (!lock.acquire(time, unit)) &#123; throw new IllegalStateException(clientName + \" could not acquire the lock\"); &#125; try &#123; System.out.println(clientName + \" get the lock\"); resource.use(); //access resource exclusively &#125; finally &#123; System.out.println(clientName + \" releasing the lock\"); lock.release(); // always release the lock in a finally block &#125; &#125; private static final int QTY = 5; private static final int REPETITIONS = QTY * 10; private static final String PATH = \"/examples/locks\"; public static void main(String[] args) throws Exception &#123; final FakeLimitedResource resource = new FakeLimitedResource(); ExecutorService service = Executors.newFixedThreadPool(QTY); final TestingServer server = new TestingServer(); try &#123; for (int i = 0; i &lt; QTY; ++i) &#123; final int index = i; Callable&lt;Void&gt; task = new Callable&lt;Void&gt;() &#123; @Override public Void call() throws Exception &#123; CuratorFramework client = CuratorFrameworkFactory.newClient(server.getConnectString(), new ExponentialBackoffRetry(1000, 3)); try &#123; client.start(); final InterProcessMutexDemo example = new InterProcessMutexDemo(client, PATH, resource, \"Client \" + index); for (int j = 0; j &lt; REPETITIONS; ++j) &#123; example.doWork(10, TimeUnit.SECONDS); &#125; &#125; catch (Throwable e) &#123; e.printStackTrace(); &#125; finally &#123; CloseableUtils.closeQuietly(client); &#125; return null; &#125; &#125;; service.submit(task); &#125; service.shutdown(); service.awaitTermination(10, TimeUnit.MINUTES); &#125; finally &#123; CloseableUtils.closeQuietly(server); &#125; &#125;&#125; ä»£ç ä¹Ÿå¾ˆç®€å•ï¼Œç”Ÿæˆ10ä¸ªclientï¼Œ æ¯ä¸ªclienté‡å¤æ‰§è¡Œ10æ¬¡ è¯·æ±‚é”â€“è®¿é—®èµ„æºâ€“é‡Šæ”¾é”çš„è¿‡ç¨‹ã€‚æ¯ä¸ªclientéƒ½åœ¨ç‹¬ç«‹çš„çº¿ç¨‹ä¸­ã€‚ ç»“æœå¯ä»¥çœ‹åˆ°ï¼Œé”æ˜¯éšæœºçš„è¢«æ¯ä¸ªå®ä¾‹æ’ä»–æ€§çš„ä½¿ç”¨ã€‚ æ—¢ç„¶æ˜¯å¯é‡ç”¨çš„ï¼Œä½ å¯ä»¥åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸­å¤šæ¬¡è°ƒç”¨acquire(),åœ¨çº¿ç¨‹æ‹¥æœ‰é”æ—¶å®ƒæ€»æ˜¯è¿”å›trueã€‚ ä½ ä¸åº”è¯¥åœ¨å¤šä¸ªçº¿ç¨‹ä¸­ç”¨åŒä¸€ä¸ªInterProcessMutexï¼Œ ä½ å¯ä»¥åœ¨æ¯ä¸ªçº¿ç¨‹ä¸­éƒ½ç”Ÿæˆä¸€ä¸ªæ–°çš„InterProcessMutexå®ä¾‹ï¼Œå®ƒä»¬çš„pathéƒ½ä¸€æ ·ï¼Œè¿™æ ·å®ƒä»¬å¯ä»¥å…±äº«åŒä¸€ä¸ªé”ã€‚ ä¸å¯é‡å…¥å…±äº«é”â€”Shared Lock è¿™ä¸ªé”å’Œä¸Šé¢çš„InterProcessMutexç›¸æ¯”ï¼Œå°±æ˜¯å°‘äº†Reentrantçš„åŠŸèƒ½ï¼Œä¹Ÿå°±æ„å‘³ç€å®ƒä¸èƒ½åœ¨åŒä¸€ä¸ªçº¿ç¨‹ä¸­é‡å…¥ã€‚è¿™ä¸ªç±»æ˜¯InterProcessSemaphoreMutex,ä½¿ç”¨æ–¹æ³•å’ŒInterProcessMutexç±»ä¼¼ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172public class InterProcessSemaphoreMutexDemo &#123; private InterProcessSemaphoreMutex lock; private final FakeLimitedResource resource; private final String clientName; public InterProcessSemaphoreMutexDemo(CuratorFramework client, String lockPath, FakeLimitedResource resource, String clientName) &#123; this.resource = resource; this.clientName = clientName; this.lock = new InterProcessSemaphoreMutex(client, lockPath); &#125; public void doWork(long time, TimeUnit unit) throws Exception &#123; if (!lock.acquire(time, unit)) &#123; throw new IllegalStateException(clientName + \" ä¸èƒ½å¾—åˆ°äº’æ–¥é”\"); &#125; System.out.println(clientName + \" å·²è·å–åˆ°äº’æ–¥é”\"); if (!lock.acquire(time, unit)) &#123; throw new IllegalStateException(clientName + \" ä¸èƒ½å¾—åˆ°äº’æ–¥é”\"); &#125; System.out.println(clientName + \" å†æ¬¡è·å–åˆ°äº’æ–¥é”\"); try &#123; System.out.println(clientName + \" get the lock\"); resource.use(); //access resource exclusively &#125; finally &#123; System.out.println(clientName + \" releasing the lock\"); lock.release(); // always release the lock in a finally block lock.release(); // è·å–é”å‡ æ¬¡ é‡Šæ”¾é”ä¹Ÿè¦å‡ æ¬¡ &#125; &#125; private static final int QTY = 5; private static final int REPETITIONS = QTY * 10; private static final String PATH = \"/examples/locks\"; public static void main(String[] args) throws Exception &#123; final FakeLimitedResource resource = new FakeLimitedResource(); ExecutorService service = Executors.newFixedThreadPool(QTY); final TestingServer server = new TestingServer(); try &#123; for (int i = 0; i &lt; QTY; ++i) &#123; final int index = i; Callable&lt;Void&gt; task = new Callable&lt;Void&gt;() &#123; @Override public Void call() throws Exception &#123; CuratorFramework client = CuratorFrameworkFactory.newClient(server.getConnectString(), new ExponentialBackoffRetry(1000, 3)); try &#123; client.start(); final InterProcessSemaphoreMutexDemo example = new InterProcessSemaphoreMutexDemo(client, PATH, resource, \"Client \" + index); for (int j = 0; j &lt; REPETITIONS; ++j) &#123; example.doWork(10, TimeUnit.SECONDS); &#125; &#125; catch (Throwable e) &#123; e.printStackTrace(); &#125; finally &#123; CloseableUtils.closeQuietly(client); &#125; return null; &#125; &#125;; service.submit(task); &#125; service.shutdown(); service.awaitTermination(10, TimeUnit.MINUTES); &#125; finally &#123; CloseableUtils.closeQuietly(server); &#125; Thread.sleep(Integer.MAX_VALUE); &#125;&#125; è¿è¡Œåå‘ç°ï¼Œæœ‰ä¸”åªæœ‰ä¸€ä¸ªclientæˆåŠŸè·å–ç¬¬ä¸€ä¸ªé”(ç¬¬ä¸€ä¸ªacquire()æ–¹æ³•è¿”å›true)ï¼Œç„¶åå®ƒè‡ªå·±é˜»å¡åœ¨ç¬¬äºŒä¸ªacquire()æ–¹æ³•ï¼Œè·å–ç¬¬äºŒä¸ªé”è¶…æ—¶ï¼›å…¶ä»–æ‰€æœ‰çš„å®¢æˆ·ç«¯éƒ½é˜»å¡åœ¨ç¬¬ä¸€ä¸ªacquire()æ–¹æ³•è¶…æ—¶å¹¶ä¸”æŠ›å‡ºå¼‚å¸¸ã€‚ è¿™æ ·ä¹Ÿå°±éªŒè¯äº†InterProcessSemaphoreMutexå®ç°çš„é”æ˜¯ä¸å¯é‡å…¥çš„ã€‚ å¯é‡å…¥è¯»å†™é”â€”Shared Reentrant Read Write Lock ç±»ä¼¼JDKçš„ReentrantReadWriteLockã€‚ä¸€ä¸ªè¯»å†™é”ç®¡ç†ä¸€å¯¹ç›¸å…³çš„é”ã€‚ä¸€ä¸ªè´Ÿè´£è¯»æ“ä½œï¼Œå¦å¤–ä¸€ä¸ªè´Ÿè´£å†™æ“ä½œã€‚è¯»æ“ä½œåœ¨å†™é”æ²¡è¢«ä½¿ç”¨æ—¶å¯åŒæ—¶ç”±å¤šä¸ªè¿›ç¨‹ä½¿ç”¨ï¼Œè€Œå†™é”åœ¨ä½¿ç”¨æ—¶ä¸å…è®¸è¯»(é˜»å¡)ã€‚ æ­¤é”æ˜¯å¯é‡å…¥çš„ã€‚ä¸€ä¸ªæ‹¥æœ‰å†™é”çš„çº¿ç¨‹å¯é‡å…¥è¯»é”ï¼Œä½†æ˜¯è¯»é”å´ä¸èƒ½è¿›å…¥å†™é”ã€‚è¿™ä¹Ÿæ„å‘³ç€å†™é”å¯ä»¥é™çº§æˆè¯»é”ï¼Œ æ¯”å¦‚è¯·æ±‚å†™é” â€”&gt;è¯·æ±‚è¯»é”â€”&gt;é‡Šæ”¾è¯»é” ----&gt;é‡Šæ”¾å†™é”ã€‚ä»è¯»é”å‡çº§æˆå†™é”æ˜¯ä¸è¡Œçš„ã€‚ å¯é‡å…¥è¯»å†™é”ä¸»è¦ç”±ä¸¤ä¸ªç±»å®ç°ï¼šInterProcessReadWriteLockã€InterProcessMutexã€‚ä½¿ç”¨æ—¶é¦–å…ˆåˆ›å»ºä¸€ä¸ªInterProcessReadWriteLockå®ä¾‹ï¼Œç„¶åå†æ ¹æ®ä½ çš„éœ€æ±‚å¾—åˆ°è¯»é”æˆ–è€…å†™é”ï¼Œè¯»å†™é”çš„ç±»å‹æ˜¯InterProcessMutexã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071727374public class ReentrantReadWriteLockDemo &#123; private final InterProcessReadWriteLock lock; private final InterProcessMutex readLock; private final InterProcessMutex writeLock; private final FakeLimitedResource resource; private final String clientName; public ReentrantReadWriteLockDemo(CuratorFramework client, String lockPath, FakeLimitedResource resource, String clientName) &#123; this.resource = resource; this.clientName = clientName; lock = new InterProcessReadWriteLock(client, lockPath); readLock = lock.readLock(); writeLock = lock.writeLock(); &#125; public void doWork(long time, TimeUnit unit) throws Exception &#123; // æ³¨æ„åªèƒ½å…ˆå¾—åˆ°å†™é”å†å¾—åˆ°è¯»é”ï¼Œä¸èƒ½åè¿‡æ¥ï¼ï¼ï¼ if (!writeLock.acquire(time, unit)) &#123; throw new IllegalStateException(clientName + \" ä¸èƒ½å¾—åˆ°å†™é”\"); &#125; System.out.println(clientName + \" å·²å¾—åˆ°å†™é”\"); if (!readLock.acquire(time, unit)) &#123; throw new IllegalStateException(clientName + \" ä¸èƒ½å¾—åˆ°è¯»é”\"); &#125; System.out.println(clientName + \" å·²å¾—åˆ°è¯»é”\"); try &#123; resource.use(); // ä½¿ç”¨èµ„æº Thread.sleep(1000); &#125; finally &#123; System.out.println(clientName + \" é‡Šæ”¾è¯»å†™é”\"); readLock.release(); writeLock.release(); &#125; &#125; private static final int QTY = 5; private static final int REPETITIONS = QTY ; private static final String PATH = \"/examples/locks\"; public static void main(String[] args) throws Exception &#123; final FakeLimitedResource resource = new FakeLimitedResource(); ExecutorService service = Executors.newFixedThreadPool(QTY); final TestingServer server = new TestingServer(); try &#123; for (int i = 0; i &lt; QTY; ++i) &#123; final int index = i; Callable&lt;Void&gt; task = new Callable&lt;Void&gt;() &#123; @Override public Void call() throws Exception &#123; CuratorFramework client = CuratorFrameworkFactory.newClient(server.getConnectString(), new ExponentialBackoffRetry(1000, 3)); try &#123; client.start(); final ReentrantReadWriteLockDemo example = new ReentrantReadWriteLockDemo(client, PATH, resource, \"Client \" + index); for (int j = 0; j &lt; REPETITIONS; ++j) &#123; example.doWork(10, TimeUnit.SECONDS); &#125; &#125; catch (Throwable e) &#123; e.printStackTrace(); &#125; finally &#123; CloseableUtils.closeQuietly(client); &#125; return null; &#125; &#125;; service.submit(task); &#125; service.shutdown(); service.awaitTermination(10, TimeUnit.MINUTES); &#125; finally &#123; CloseableUtils.closeQuietly(server); &#125; &#125;&#125; ä¿¡å·é‡â€”Shared Semaphore ä¸€ä¸ªè®¡æ•°çš„ä¿¡å·é‡ç±»ä¼¼JDKçš„Semaphoreã€‚ JDKä¸­Semaphoreç»´æŠ¤çš„ä¸€ç»„è®¸å¯(permits)ï¼Œè€ŒCuratorä¸­ç§°ä¹‹ä¸ºç§Ÿçº¦(Lease)ã€‚ æœ‰ä¸¤ç§æ–¹å¼å¯ä»¥å†³å®šsemaphoreçš„æœ€å¤§ç§Ÿçº¦æ•°ã€‚ç¬¬ä¸€ç§æ–¹å¼æ˜¯ç”¨æˆ·ç»™å®špathå¹¶ä¸”æŒ‡å®šæœ€å¤§LeaseSizeã€‚ç¬¬äºŒç§æ–¹å¼ç”¨æˆ·ç»™å®špathå¹¶ä¸”ä½¿ç”¨SharedCountReaderç±»ã€‚å¦‚æœä¸ä½¿ç”¨SharedCountReader, å¿…é¡»ä¿è¯æ‰€æœ‰å®ä¾‹åœ¨å¤šè¿›ç¨‹ä¸­ä½¿ç”¨ç›¸åŒçš„(æœ€å¤§)ç§Ÿçº¦æ•°é‡,å¦åˆ™æœ‰å¯èƒ½å‡ºç°Aè¿›ç¨‹ä¸­çš„å®ä¾‹æŒæœ‰æœ€å¤§ç§Ÿçº¦æ•°é‡ä¸º10ï¼Œä½†æ˜¯åœ¨Bè¿›ç¨‹ä¸­æŒæœ‰çš„æœ€å¤§ç§Ÿçº¦æ•°é‡ä¸º20ï¼Œæ­¤æ—¶ç§Ÿçº¦çš„æ„ä¹‰å°±å¤±æ•ˆäº†ã€‚ è¿™æ¬¡è°ƒç”¨acquire()ä¼šè¿”å›ä¸€ä¸ªç§Ÿçº¦å¯¹è±¡ã€‚ å®¢æˆ·ç«¯å¿…é¡»åœ¨finallyä¸­closeè¿™äº›ç§Ÿçº¦å¯¹è±¡ï¼Œå¦åˆ™è¿™äº›ç§Ÿçº¦ä¼šä¸¢å¤±æ‰ã€‚ ä½†æ˜¯ï¼Œ ä½†æ˜¯ï¼Œå¦‚æœå®¢æˆ·ç«¯sessionç”±äºæŸç§åŸå› æ¯”å¦‚crashä¸¢æ‰ï¼Œ é‚£ä¹ˆè¿™äº›å®¢æˆ·ç«¯æŒæœ‰çš„ç§Ÿçº¦ä¼šè‡ªåŠ¨closeï¼Œ è¿™æ ·å…¶å®ƒå®¢æˆ·ç«¯å¯ä»¥ç»§ç»­ä½¿ç”¨è¿™äº›ç§Ÿçº¦ã€‚ ç§Ÿçº¦è¿˜å¯ä»¥é€šè¿‡ä¸‹é¢çš„æ–¹å¼è¿”è¿˜ï¼š 12public void returnAll(Collection&lt;Lease&gt; leases)public void returnLease(Lease lease) æ³¨æ„ä½ å¯ä»¥ä¸€æ¬¡æ€§è¯·æ±‚å¤šä¸ªç§Ÿçº¦ï¼Œå¦‚æœSemaphoreå½“å‰çš„ç§Ÿçº¦ä¸å¤Ÿï¼Œåˆ™è¯·æ±‚çº¿ç¨‹ä¼šè¢«é˜»å¡ã€‚ åŒæ—¶è¿˜æä¾›äº†è¶…æ—¶çš„é‡è½½æ–¹æ³•ã€‚ 1234public Lease acquire()public Collection&lt;Lease&gt; acquire(int qty)public Lease acquire(long time, TimeUnit unit)public Collection&lt;Lease&gt; acquire(int qty, long time, TimeUnit unit) Shared Semaphoreä½¿ç”¨çš„ä¸»è¦ç±»åŒ…æ‹¬ä¸‹é¢å‡ ä¸ªï¼š InterProcessSemaphoreV2 Lease SharedCountReader 123456789101112131415161718192021222324252627282930public class InterProcessSemaphoreDemo &#123; private static final int MAX_LEASE = 10; private static final String PATH = \"/examples/locks\"; public static void main(String[] args) throws Exception &#123; FakeLimitedResource resource = new FakeLimitedResource(); try (TestingServer server = new TestingServer()) &#123; CuratorFramework client = CuratorFrameworkFactory.newClient(server.getConnectString(), new ExponentialBackoffRetry(1000, 3)); client.start(); InterProcessSemaphoreV2 semaphore = new InterProcessSemaphoreV2(client, PATH, MAX_LEASE); Collection&lt;Lease&gt; leases = semaphore.acquire(5); System.out.println(\"get \" + leases.size() + \" leases\"); Lease lease = semaphore.acquire(); System.out.println(\"get another lease\"); resource.use(); Collection&lt;Lease&gt; leases2 = semaphore.acquire(5, 10, TimeUnit.SECONDS); System.out.println(\"Should timeout and acquire return \" + leases2); System.out.println(\"return one lease\"); semaphore.returnLease(lease); System.out.println(\"return another 5 leases\"); semaphore.returnAll(leases); &#125; &#125;&#125; é¦–å…ˆæˆ‘ä»¬å…ˆè·å¾—äº†5ä¸ªç§Ÿçº¦ï¼Œ æœ€åæˆ‘ä»¬æŠŠå®ƒè¿˜ç»™äº†semaphoreã€‚ æ¥ç€è¯·æ±‚äº†ä¸€ä¸ªç§Ÿçº¦ï¼Œå› ä¸ºsemaphoreè¿˜æœ‰5ä¸ªç§Ÿçº¦ï¼Œæ‰€ä»¥è¯·æ±‚å¯ä»¥æ»¡è¶³ï¼Œè¿”å›ä¸€ä¸ªç§Ÿçº¦ï¼Œè¿˜å‰©4ä¸ªç§Ÿçº¦ã€‚ ç„¶åå†è¯·æ±‚ä¸€ä¸ªç§Ÿçº¦ï¼Œå› ä¸ºç§Ÿçº¦ä¸å¤Ÿï¼Œé˜»å¡åˆ°è¶…æ—¶ï¼Œè¿˜æ˜¯æ²¡èƒ½æ»¡è¶³ï¼Œè¿”å›ç»“æœä¸ºnull(ç§Ÿçº¦ä¸è¶³ä¼šé˜»å¡åˆ°è¶…æ—¶ï¼Œç„¶åè¿”å›nullï¼Œä¸ä¼šä¸»åŠ¨æŠ›å‡ºå¼‚å¸¸ï¼›å¦‚æœä¸è®¾ç½®è¶…æ—¶æ—¶é—´ï¼Œä¼šä¸€è‡´é˜»å¡)ã€‚ ä¸Šé¢è¯´è®²çš„é”éƒ½æ˜¯å…¬å¹³é”(fair)ã€‚ æ€»ZooKeeperçš„è§’åº¦çœ‹ï¼Œ æ¯ä¸ªå®¢æˆ·ç«¯éƒ½æŒ‰ç…§è¯·æ±‚çš„é¡ºåºè·å¾—é”ï¼Œä¸å­˜åœ¨éå…¬å¹³çš„æŠ¢å çš„æƒ…å†µã€‚ å¤šå…±äº«é”å¯¹è±¡ â€”Multi Shared Lock Multi Shared Lockæ˜¯ä¸€ä¸ªé”çš„å®¹å™¨ã€‚ å½“è°ƒç”¨acquire()ï¼Œ æ‰€æœ‰çš„é”éƒ½ä¼šè¢«acquire()ï¼Œå¦‚æœè¯·æ±‚å¤±è´¥ï¼Œæ‰€æœ‰çš„é”éƒ½ä¼šè¢«releaseã€‚ åŒæ ·è°ƒç”¨releaseæ—¶æ‰€æœ‰çš„é”éƒ½è¢«release(å¤±è´¥è¢«å¿½ç•¥)ã€‚ åŸºæœ¬ä¸Šï¼Œå®ƒå°±æ˜¯ç»„é”çš„ä»£è¡¨ï¼Œåœ¨å®ƒä¸Šé¢çš„è¯·æ±‚é‡Šæ”¾æ“ä½œéƒ½ä¼šä¼ é€’ç»™å®ƒåŒ…å«çš„æ‰€æœ‰çš„é”ã€‚ ä¸»è¦æ¶‰åŠä¸¤ä¸ªç±»ï¼š InterProcessMultiLock InterProcessLock å®ƒçš„æ„é€ å‡½æ•°éœ€è¦åŒ…å«çš„é”çš„é›†åˆï¼Œæˆ–è€…ä¸€ç»„ZooKeeperçš„pathã€‚ 12public InterProcessMultiLock(List&lt;InterProcessLock&gt; locks)public InterProcessMultiLock(CuratorFramework client, List&lt;String&gt; paths) ç”¨æ³•å’ŒShared Lockç›¸åŒã€‚ 1234567891011121314151617181920212223242526272829303132333435public class MultiSharedLockDemo &#123; private static final String PATH1 = \"/examples/locks1\"; private static final String PATH2 = \"/examples/locks2\"; public static void main(String[] args) throws Exception &#123; FakeLimitedResource resource = new FakeLimitedResource(); try (TestingServer server = new TestingServer()) &#123; CuratorFramework client = CuratorFrameworkFactory.newClient(server.getConnectString(), new ExponentialBackoffRetry(1000, 3)); client.start(); InterProcessLock lock1 = new InterProcessMutex(client, PATH1); InterProcessLock lock2 = new InterProcessSemaphoreMutex(client, PATH2); InterProcessMultiLock lock = new InterProcessMultiLock(Arrays.asList(lock1, lock2)); if (!lock.acquire(10, TimeUnit.SECONDS)) &#123; throw new IllegalStateException(\"could not acquire the lock\"); &#125; System.out.println(\"has got all lock\"); System.out.println(\"has got lock1: \" + lock1.isAcquiredInThisProcess()); System.out.println(\"has got lock2: \" + lock2.isAcquiredInThisProcess()); try &#123; resource.use(); //access resource exclusively &#125; finally &#123; System.out.println(\"releasing the lock\"); lock.release(); // always release the lock in a finally block &#125; System.out.println(\"has got lock1: \" + lock1.isAcquiredInThisProcess()); System.out.println(\"has got lock2: \" + lock2.isAcquiredInThisProcess()); &#125; &#125;&#125; æ–°å»ºä¸€ä¸ªInterProcessMultiLockï¼Œ åŒ…å«ä¸€ä¸ªé‡å…¥é”å’Œä¸€ä¸ªéé‡å…¥é”ã€‚ è°ƒç”¨acquire()åå¯ä»¥çœ‹åˆ°çº¿ç¨‹åŒæ—¶æ‹¥æœ‰äº†è¿™ä¸¤ä¸ªé”ã€‚ è°ƒç”¨release()çœ‹åˆ°è¿™ä¸¤ä¸ªé”éƒ½è¢«é‡Šæ”¾äº†ã€‚ æœ€åå†é‡ç”³ä¸€æ¬¡ï¼Œ å¼ºçƒˆæ¨èä½¿ç”¨ConnectionStateListenerç›‘æ§è¿æ¥çš„çŠ¶æ€ï¼Œå½“è¿æ¥çŠ¶æ€ä¸ºLOSTï¼Œé”å°†ä¼šä¸¢å¤±ã€‚ åˆ†å¸ƒå¼è®¡æ•°å™¨ é¡¾åæ€ä¹‰ï¼Œè®¡æ•°å™¨æ˜¯ç”¨æ¥è®¡æ•°çš„, åˆ©ç”¨ZooKeeperå¯ä»¥å®ç°ä¸€ä¸ªé›†ç¾¤å…±äº«çš„è®¡æ•°å™¨ã€‚ åªè¦ä½¿ç”¨ç›¸åŒçš„pathå°±å¯ä»¥å¾—åˆ°æœ€æ–°çš„è®¡æ•°å™¨å€¼ï¼Œ è¿™æ˜¯ç”±ZooKeeperçš„ä¸€è‡´æ€§ä¿è¯çš„ã€‚Curatoræœ‰ä¸¤ä¸ªè®¡æ•°å™¨ï¼Œ ä¸€ä¸ªæ˜¯ç”¨intæ¥è®¡æ•°(SharedCount)ï¼Œä¸€ä¸ªç”¨longæ¥è®¡æ•°(DistributedAtomicLong)ã€‚ åˆ†å¸ƒå¼intè®¡æ•°å™¨â€”SharedCount è¿™ä¸ªç±»ä½¿ç”¨intç±»å‹æ¥è®¡æ•°ã€‚ ä¸»è¦æ¶‰åŠä¸‰ä¸ªç±»ã€‚ SharedCount SharedCountReader SharedCountListener SharedCountä»£è¡¨è®¡æ•°å™¨ï¼Œ å¯ä»¥ä¸ºå®ƒå¢åŠ ä¸€ä¸ªSharedCountListenerï¼Œå½“è®¡æ•°å™¨æ”¹å˜æ—¶æ­¤Listenerå¯ä»¥ç›‘å¬åˆ°æ”¹å˜çš„äº‹ä»¶ï¼Œè€ŒSharedCountReaderå¯ä»¥è¯»å–åˆ°æœ€æ–°çš„å€¼ï¼Œ åŒ…æ‹¬å­—é¢å€¼å’Œå¸¦ç‰ˆæœ¬ä¿¡æ¯çš„å€¼VersionedValueã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051public class SharedCounterDemo implements SharedCountListener &#123; private static final int QTY = 5; private static final String PATH = \"/examples/counter\"; public static void main(String[] args) throws IOException, Exception &#123; final Random rand = new Random(); SharedCounterDemo example = new SharedCounterDemo(); try (TestingServer server = new TestingServer()) &#123; CuratorFramework client = CuratorFrameworkFactory.newClient(server.getConnectString(), new ExponentialBackoffRetry(1000, 3)); client.start(); SharedCount baseCount = new SharedCount(client, PATH, 0); baseCount.addListener(example); baseCount.start(); List&lt;SharedCount&gt; examples = Lists.newArrayList(); ExecutorService service = Executors.newFixedThreadPool(QTY); for (int i = 0; i &lt; QTY; ++i) &#123; final SharedCount count = new SharedCount(client, PATH, 0); examples.add(count); Callable&lt;Void&gt; task = () -&gt; &#123; count.start(); Thread.sleep(rand.nextInt(10000)); System.out.println(\"Increment:\" + count.trySetCount(count.getVersionedValue(), count.getCount() + rand.nextInt(10))); return null; &#125;; service.submit(task); &#125; service.shutdown(); service.awaitTermination(10, TimeUnit.MINUTES); for (int i = 0; i &lt; QTY; ++i) &#123; examples.get(i).close(); &#125; baseCount.close(); &#125; Thread.sleep(Integer.MAX_VALUE); &#125; @Override public void stateChanged(CuratorFramework arg0, ConnectionState arg1) &#123; System.out.println(\"State changed: \" + arg1.toString()); &#125; @Override public void countHasChanged(SharedCountReader sharedCount, int newCount) throws Exception &#123; System.out.println(\"Counter's value is changed to \" + newCount); &#125;&#125; åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨baseCountæ¥ç›‘å¬è®¡æ•°å€¼(addListeneræ–¹æ³•æ¥æ·»åŠ SharedCountListener )ã€‚ ä»»æ„çš„SharedCountï¼Œ åªè¦ä½¿ç”¨ç›¸åŒçš„pathï¼Œéƒ½å¯ä»¥å¾—åˆ°è¿™ä¸ªè®¡æ•°å€¼ã€‚ ç„¶åæˆ‘ä»¬ä½¿ç”¨5ä¸ªçº¿ç¨‹ä¸ºè®¡æ•°å€¼å¢åŠ ä¸€ä¸ª10ä»¥å†…çš„éšæœºæ•°ã€‚ç›¸åŒçš„pathçš„SharedCountå¯¹è®¡æ•°å€¼è¿›è¡Œæ›´æ”¹ï¼Œå°†ä¼šå›è°ƒç»™baseCountçš„SharedCountListenerã€‚ 1count.trySetCount(count.getVersionedValue(), count.getCount() + rand.nextInt(10)) è¿™é‡Œæˆ‘ä»¬ä½¿ç”¨trySetCountå»è®¾ç½®è®¡æ•°å™¨ã€‚ ç¬¬ä¸€ä¸ªå‚æ•°æä¾›å½“å‰çš„VersionedValue,å¦‚æœæœŸé—´å…¶å®ƒclientæ›´æ–°äº†æ­¤è®¡æ•°å€¼ï¼Œ ä½ çš„æ›´æ–°å¯èƒ½ä¸æˆåŠŸï¼Œ ä½†æ˜¯è¿™æ—¶ä½ çš„clientæ›´æ–°äº†æœ€æ–°çš„å€¼ï¼Œæ‰€ä»¥å¤±è´¥äº†ä½ å¯ä»¥å°è¯•å†æ›´æ–°ä¸€æ¬¡ã€‚ è€ŒsetCountæ˜¯å¼ºåˆ¶æ›´æ–°è®¡æ•°å™¨çš„å€¼ã€‚ æ³¨æ„è®¡æ•°å™¨å¿…é¡»start,ä½¿ç”¨å®Œä¹‹åå¿…é¡»è°ƒç”¨closeå…³é—­å®ƒã€‚ å¼ºçƒˆæ¨èä½¿ç”¨ConnectionStateListenerã€‚ åœ¨æœ¬ä¾‹ä¸­SharedCountListeneræ‰©å±•ConnectionStateListenerã€‚ åˆ†å¸ƒå¼longè®¡æ•°å™¨â€”DistributedAtomicLong å†çœ‹ä¸€ä¸ªLongç±»å‹çš„è®¡æ•°å™¨ã€‚ é™¤äº†è®¡æ•°çš„èŒƒå›´æ¯”SharedCountå¤§äº†ä¹‹å¤–ï¼Œ å®ƒé¦–å…ˆå°è¯•ä½¿ç”¨ä¹è§‚é”çš„æ–¹å¼è®¾ç½®è®¡æ•°å™¨ï¼Œ å¦‚æœä¸æˆåŠŸ(æ¯”å¦‚æœŸé—´è®¡æ•°å™¨å·²ç»è¢«å…¶å®ƒclientæ›´æ–°äº†)ï¼Œ å®ƒä½¿ç”¨InterProcessMutexæ–¹å¼æ¥æ›´æ–°è®¡æ•°å€¼ã€‚ å¯ä»¥ä»å®ƒçš„å†…éƒ¨å®ç°DistributedAtomicValue.trySet()ä¸­çœ‹å‡ºï¼š 123456789101112AtomicValue&lt;byte[]&gt; trySet(MakeValue makeValue) throws Exception &#123; MutableAtomicValue&lt;byte[]&gt; result = new MutableAtomicValue&lt;byte[]&gt;(null, null, false); tryOptimistic(result, makeValue); if ( !result.succeeded() &amp;&amp; (mutex != null) ) &#123; tryWithMutex(result, makeValue); &#125; return result; &#125; æ­¤è®¡æ•°å™¨æœ‰ä¸€ç³»åˆ—çš„æ“ä½œï¼š get(): è·å–å½“å‰å€¼ increment()ï¼š åŠ ä¸€ decrement(): å‡ä¸€ add()ï¼š å¢åŠ ç‰¹å®šçš„å€¼ subtract(): å‡å»ç‰¹å®šçš„å€¼ trySet(): å°è¯•è®¾ç½®è®¡æ•°å€¼ forceSet(): å¼ºåˆ¶è®¾ç½®è®¡æ•°å€¼ ä½ å¿…é¡»æ£€æŸ¥è¿”å›ç»“æœçš„succeeded()ï¼Œ å®ƒä»£è¡¨æ­¤æ“ä½œæ˜¯å¦æˆåŠŸã€‚ å¦‚æœæ“ä½œæˆåŠŸï¼Œ preValue()ä»£è¡¨æ“ä½œå‰çš„å€¼ï¼Œ postValue()ä»£è¡¨æ“ä½œåçš„å€¼ã€‚ 1234567891011121314151617181920212223242526272829303132333435public class DistributedAtomicLongDemo &#123; private static final int QTY = 5; private static final String PATH = \"/examples/counter\"; public static void main(String[] args) throws IOException, Exception &#123; List&lt;DistributedAtomicLong&gt; examples = Lists.newArrayList(); try (TestingServer server = new TestingServer()) &#123; CuratorFramework client = CuratorFrameworkFactory.newClient(server.getConnectString(), new ExponentialBackoffRetry(1000, 3)); client.start(); ExecutorService service = Executors.newFixedThreadPool(QTY); for (int i = 0; i &lt; QTY; ++i) &#123; final DistributedAtomicLong count = new DistributedAtomicLong(client, PATH, new RetryNTimes(10, 10)); examples.add(count); Callable&lt;Void&gt; task = () -&gt; &#123; try &#123; AtomicValue&lt;Long&gt; value = count.increment(); System.out.println(\"succeed: \" + value.succeeded()); if (value.succeeded()) System.out.println(\"Increment: from \" + value.preValue() + \" to \" + value.postValue()); &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; return null; &#125;; service.submit(task); &#125; service.shutdown(); service.awaitTermination(10, TimeUnit.MINUTES); Thread.sleep(Integer.MAX_VALUE); &#125; &#125;&#125; åˆ†å¸ƒå¼é˜Ÿåˆ— ä½¿ç”¨Curatorä¹Ÿå¯ä»¥ç®€åŒ–Ephemeral Node (ä¸´æ—¶èŠ‚ç‚¹)çš„æ“ä½œã€‚Curatorä¹Ÿæä¾›ZK Recipeçš„åˆ†å¸ƒå¼é˜Ÿåˆ—å®ç°ã€‚ åˆ©ç”¨ZKçš„ PERSISTENTS_EQUENTIALèŠ‚ç‚¹ï¼Œ å¯ä»¥ä¿è¯æ”¾å…¥åˆ°é˜Ÿåˆ—ä¸­çš„é¡¹ç›®æ˜¯æŒ‰ç…§é¡ºåºæ’é˜Ÿçš„ã€‚ å¦‚æœå•ä¸€çš„æ¶ˆè´¹è€…ä»é˜Ÿåˆ—ä¸­å–æ•°æ®ï¼Œ é‚£ä¹ˆå®ƒæ˜¯å…ˆå…¥å…ˆå‡ºçš„ï¼Œè¿™ä¹Ÿæ˜¯é˜Ÿåˆ—çš„ç‰¹ç‚¹ã€‚ å¦‚æœä½ ä¸¥æ ¼è¦æ±‚é¡ºåºï¼Œä½ å°±çš„ä½¿ç”¨å•ä¸€çš„æ¶ˆè´¹è€…ï¼Œå¯ä»¥ä½¿ç”¨Leaderé€‰ä¸¾åªè®©Leaderä½œä¸ºå”¯ä¸€çš„æ¶ˆè´¹è€…ã€‚ ä½†æ˜¯ï¼Œ æ ¹æ®Netflixçš„Curatorä½œè€…æ‰€è¯´ï¼Œ ZooKeeperçœŸå¿ƒä¸é€‚åˆåšQueueï¼Œæˆ–è€…è¯´ZKæ²¡æœ‰å®ç°ä¸€ä¸ªå¥½çš„Queueï¼Œè¯¦ç»†å†…å®¹å¯ä»¥çœ‹ Tech Note 4ï¼Œ åŸå› æœ‰äº”ï¼š ZKæœ‰1MB çš„ä¼ è¾“é™åˆ¶ã€‚ å®è·µä¸­ZNodeå¿…é¡»ç›¸å¯¹è¾ƒå°ï¼Œè€Œé˜Ÿåˆ—åŒ…å«æˆåƒä¸Šä¸‡çš„æ¶ˆæ¯ï¼Œéå¸¸çš„å¤§ã€‚ å¦‚æœæœ‰å¾ˆå¤šèŠ‚ç‚¹ï¼ŒZKå¯åŠ¨æ—¶ç›¸å½“çš„æ…¢ã€‚ è€Œä½¿ç”¨queueä¼šå¯¼è‡´å¥½å¤šZNode. ä½ éœ€è¦æ˜¾è‘—å¢å¤§ initLimit å’Œ syncLimit. ZNodeå¾ˆå¤§çš„æ—¶å€™å¾ˆéš¾æ¸…ç†ã€‚Netflixä¸å¾—ä¸åˆ›å»ºäº†ä¸€ä¸ªä¸“é—¨çš„ç¨‹åºåšè¿™äº‹ã€‚ å½“å¾ˆå¤§é‡çš„åŒ…å«æˆåƒä¸Šä¸‡çš„å­èŠ‚ç‚¹çš„ZNodeæ—¶ï¼Œ ZKçš„æ€§èƒ½å˜å¾—ä¸å¥½ ZKçš„æ•°æ®åº“å®Œå…¨æ”¾åœ¨å†…å­˜ä¸­ã€‚ å¤§é‡çš„Queueæ„å‘³ç€ä¼šå ç”¨å¾ˆå¤šçš„å†…å­˜ç©ºé—´ã€‚ å°½ç®¡å¦‚æ­¤ï¼Œ Curatorè¿˜æ˜¯åˆ›å»ºäº†å„ç§Queueçš„å®ç°ã€‚ å¦‚æœQueueçš„æ•°æ®é‡ä¸å¤ªå¤šï¼Œæ•°æ®é‡ä¸å¤ªå¤§çš„æƒ…å†µä¸‹ï¼Œé…Œæƒ…è€ƒè™‘ï¼Œè¿˜æ˜¯å¯ä»¥ä½¿ç”¨çš„ã€‚ åˆ†å¸ƒå¼é˜Ÿåˆ—â€”DistributedQueue DistributedQueueæ˜¯æœ€æ™®é€šçš„ä¸€ç§é˜Ÿåˆ—ã€‚ å®ƒè®¾è®¡ä»¥ä¸‹å››ä¸ªç±»ï¼š QueueBuilder - åˆ›å»ºé˜Ÿåˆ—ä½¿ç”¨QueueBuilder,å®ƒä¹Ÿæ˜¯å…¶å®ƒé˜Ÿåˆ—çš„åˆ›å»ºç±» QueueConsumer - é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯æ¶ˆè´¹è€…æ¥å£ QueueSerializer - é˜Ÿåˆ—æ¶ˆæ¯åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ¥å£ï¼Œæä¾›äº†å¯¹é˜Ÿåˆ—ä¸­çš„å¯¹è±¡çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ– DistributedQueue - é˜Ÿåˆ—å®ç°ç±» QueueConsumeræ˜¯æ¶ˆè´¹è€…ï¼Œå®ƒå¯ä»¥æ¥æ”¶é˜Ÿåˆ—çš„æ•°æ®ã€‚å¤„ç†é˜Ÿåˆ—ä¸­çš„æ•°æ®çš„ä»£ç é€»è¾‘å¯ä»¥æ”¾åœ¨QueueConsumer.consumeMessage()ä¸­ã€‚ æ­£å¸¸æƒ…å†µä¸‹å…ˆå°†æ¶ˆæ¯ä»é˜Ÿåˆ—ä¸­ç§»é™¤ï¼Œå†äº¤ç»™æ¶ˆè´¹è€…æ¶ˆè´¹ã€‚ä½†è¿™æ˜¯ä¸¤ä¸ªæ­¥éª¤ï¼Œä¸æ˜¯åŸå­çš„ã€‚å¯ä»¥è°ƒç”¨Builderçš„lockPath()æ¶ˆè´¹è€…åŠ é”ï¼Œå½“æ¶ˆè´¹è€…æ¶ˆè´¹æ•°æ®æ—¶æŒæœ‰é”ï¼Œè¿™æ ·å…¶å®ƒæ¶ˆè´¹è€…ä¸èƒ½æ¶ˆè´¹æ­¤æ¶ˆæ¯ã€‚å¦‚æœæ¶ˆè´¹å¤±è´¥æˆ–è€…è¿›ç¨‹æ­»æ‰ï¼Œæ¶ˆæ¯å¯ä»¥äº¤ç»™å…¶å®ƒè¿›ç¨‹ã€‚è¿™ä¼šå¸¦æ¥ä¸€ç‚¹æ€§èƒ½çš„æŸå¤±ã€‚æœ€å¥½è¿˜æ˜¯å•æ¶ˆè´¹è€…æ¨¡å¼ä½¿ç”¨é˜Ÿåˆ—ã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566public class DistributedQueueDemo &#123; private static final String PATH = \"/example/queue\"; public static void main(String[] args) throws Exception &#123; TestingServer server = new TestingServer(); CuratorFramework clientA = CuratorFrameworkFactory.newClient(server.getConnectString(), new ExponentialBackoffRetry(1000, 3)); clientA.start(); CuratorFramework clientB = CuratorFrameworkFactory.newClient(server.getConnectString(), new ExponentialBackoffRetry(1000, 3)); clientB.start(); DistributedQueue&lt;String&gt; queueA; QueueBuilder&lt;String&gt; builderA = QueueBuilder.builder(clientA, createQueueConsumer(\"A\"), createQueueSerializer(), PATH); queueA = builderA.buildQueue(); queueA.start(); DistributedQueue&lt;String&gt; queueB; QueueBuilder&lt;String&gt; builderB = QueueBuilder.builder(clientB, createQueueConsumer(\"B\"), createQueueSerializer(), PATH); queueB = builderB.buildQueue(); queueB.start(); for (int i = 0; i &lt; 100; i++) &#123; queueA.put(\" test-A-\" + i); Thread.sleep(10); queueB.put(\" test-B-\" + i); &#125; Thread.sleep(1000 * 10);// ç­‰å¾…æ¶ˆæ¯æ¶ˆè´¹å®Œæˆ queueB.close(); queueA.close(); clientB.close(); clientA.close(); System.out.println(\"OK!\"); &#125; /** * é˜Ÿåˆ—æ¶ˆæ¯åºåˆ—åŒ–å®ç°ç±» */ private static QueueSerializer&lt;String&gt; createQueueSerializer() &#123; return new QueueSerializer&lt;String&gt;() &#123; @Override public byte[] serialize(String item) &#123; return item.getBytes(); &#125; @Override public String deserialize(byte[] bytes) &#123; return new String(bytes); &#125; &#125;; &#125; /** * å®šä¹‰é˜Ÿåˆ—æ¶ˆè´¹è€… */ private static QueueConsumer&lt;String&gt; createQueueConsumer(final String name) &#123; return new QueueConsumer&lt;String&gt;() &#123; @Override public void stateChanged(CuratorFramework client, ConnectionState newState) &#123; System.out.println(\"è¿æ¥çŠ¶æ€æ”¹å˜: \" + newState.name()); &#125; @Override public void consumeMessage(String message) throws Exception &#123; System.out.println(\"æ¶ˆè´¹æ¶ˆæ¯(\" + name + \"): \" + message); &#125; &#125;; &#125;&#125; ä¾‹å­ä¸­å®šä¹‰äº†ä¸¤ä¸ªåˆ†å¸ƒå¼é˜Ÿåˆ—å’Œä¸¤ä¸ªæ¶ˆè´¹è€…ï¼Œå› ä¸ºPATHæ˜¯ç›¸åŒçš„ï¼Œä¼šå­˜åœ¨æ¶ˆè´¹è€…æŠ¢å æ¶ˆè´¹æ¶ˆæ¯çš„æƒ…å†µã€‚ å¸¦Idçš„åˆ†å¸ƒå¼é˜Ÿåˆ—â€”DistributedIdQueue DistributedIdQueueå’Œä¸Šé¢çš„é˜Ÿåˆ—ç±»ä¼¼ï¼Œä½†æ˜¯å¯ä»¥ä¸ºé˜Ÿåˆ—ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ è®¾ç½®ä¸€ä¸ªIDã€‚ å¯ä»¥é€šè¿‡IDæŠŠé˜Ÿåˆ—ä¸­ä»»æ„çš„å…ƒç´ ç§»é™¤ã€‚ å®ƒæ¶‰åŠå‡ ä¸ªç±»ï¼š QueueBuilder QueueConsumer QueueSerializer DistributedQueue é€šè¿‡ä¸‹é¢æ–¹æ³•åˆ›å»ºï¼š 1builder.buildIdQueue() æ”¾å…¥å…ƒç´ æ—¶ï¼š 1queue.put(aMessage, messageId); ç§»é™¤å…ƒç´ æ—¶ï¼š 1int numberRemoved &#x3D; queue.remove(messageId); åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œ æœ‰äº›å…ƒç´ è¿˜æ²¡æœ‰è¢«æ¶ˆè´¹è€…æ¶ˆè´¹å‰å°±ç§»é™¤äº†ï¼Œè¿™æ ·æ¶ˆè´¹è€…ä¸ä¼šæ”¶åˆ°åˆ é™¤çš„æ¶ˆæ¯ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768public class DistributedIdQueueDemo &#123; private static final String PATH = \"/example/queue\"; public static void main(String[] args) throws Exception &#123; TestingServer server = new TestingServer(); CuratorFramework client = null; DistributedIdQueue&lt;String&gt; queue = null; try &#123; client = CuratorFrameworkFactory.newClient(server.getConnectString(), new ExponentialBackoffRetry(1000, 3)); client.getCuratorListenable().addListener((client1, event) -&gt; System.out.println(\"CuratorEvent: \" + event.getType().name())); client.start(); QueueConsumer&lt;String&gt; consumer = createQueueConsumer(); QueueBuilder&lt;String&gt; builder = QueueBuilder.builder(client, consumer, createQueueSerializer(), PATH); queue = builder.buildIdQueue(); queue.start(); for (int i = 0; i &lt; 10; i++) &#123; queue.put(\" test-\" + i, \"Id\" + i); Thread.sleep((long) (15 * Math.random())); queue.remove(\"Id\" + i); &#125; Thread.sleep(20000); &#125; catch (Exception ex) &#123; &#125; finally &#123; CloseableUtils.closeQuietly(queue); CloseableUtils.closeQuietly(client); CloseableUtils.closeQuietly(server); &#125; &#125; private static QueueSerializer&lt;String&gt; createQueueSerializer() &#123; return new QueueSerializer&lt;String&gt;() &#123; @Override public byte[] serialize(String item) &#123; return item.getBytes(); &#125; @Override public String deserialize(byte[] bytes) &#123; return new String(bytes); &#125; &#125;; &#125; private static QueueConsumer&lt;String&gt; createQueueConsumer() &#123; return new QueueConsumer&lt;String&gt;() &#123; @Override public void stateChanged(CuratorFramework client, ConnectionState newState) &#123; System.out.println(\"connection new state: \" + newState.name()); &#125; @Override public void consumeMessage(String message) throws Exception &#123; System.out.println(\"consume one message: \" + message); &#125; &#125;; &#125;&#125; ä¼˜å…ˆçº§åˆ†å¸ƒå¼é˜Ÿåˆ—â€”DistributedPriorityQueue ä¼˜å…ˆçº§é˜Ÿåˆ—å¯¹é˜Ÿåˆ—ä¸­çš„å…ƒç´ æŒ‰ç…§ä¼˜å…ˆçº§è¿›è¡Œæ’åºã€‚ Priorityè¶Šå°ï¼Œ å…ƒç´ è¶Šé å‰ï¼Œ è¶Šå…ˆè¢«æ¶ˆè´¹æ‰ã€‚ å®ƒæ¶‰åŠä¸‹é¢å‡ ä¸ªç±»ï¼š QueueBuilder QueueConsumer QueueSerializer DistributedPriorityQueue é€šè¿‡builder.buildPriorityQueue(minItemsBeforeRefresh)æ–¹æ³•åˆ›å»ºã€‚ å½“ä¼˜å…ˆçº§é˜Ÿåˆ—å¾—åˆ°å…ƒç´ å¢åˆ æ¶ˆæ¯æ—¶ï¼Œå®ƒä¼šæš‚åœå¤„ç†å½“å‰çš„å…ƒç´ é˜Ÿåˆ—ï¼Œç„¶ååˆ·æ–°é˜Ÿåˆ—ã€‚minItemsBeforeRefreshæŒ‡å®šåˆ·æ–°å‰å½“å‰æ´»åŠ¨çš„é˜Ÿåˆ—çš„æœ€å°æ•°é‡ã€‚ ä¸»è¦è®¾ç½®ä½ çš„ç¨‹åºå¯ä»¥å®¹å¿çš„ä¸æ’åºçš„æœ€å°å€¼ã€‚ æ”¾å…¥é˜Ÿåˆ—æ—¶éœ€è¦æŒ‡å®šä¼˜å…ˆçº§ï¼š 1queue.put(aMessage, priority); ä¾‹å­ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071public class DistributedPriorityQueueDemo &#123; private static final String PATH = \"/example/queue\"; public static void main(String[] args) throws Exception &#123; TestingServer server = new TestingServer(); CuratorFramework client = null; DistributedPriorityQueue&lt;String&gt; queue = null; try &#123; client = CuratorFrameworkFactory.newClient(server.getConnectString(), new ExponentialBackoffRetry(1000, 3)); client.getCuratorListenable().addListener((client1, event) -&gt; System.out.println(\"CuratorEvent: \" + event.getType().name())); client.start(); QueueConsumer&lt;String&gt; consumer = createQueueConsumer(); QueueBuilder&lt;String&gt; builder = QueueBuilder.builder(client, consumer, createQueueSerializer(), PATH); queue = builder.buildPriorityQueue(0); queue.start(); for (int i = 0; i &lt; 10; i++) &#123; int priority = (int) (Math.random() * 100); System.out.println(\"test-\" + i + \" priority:\" + priority); queue.put(\"test-\" + i, priority); Thread.sleep((long) (50 * Math.random())); &#125; Thread.sleep(20000); &#125; catch (Exception ex) &#123; &#125; finally &#123; CloseableUtils.closeQuietly(queue); CloseableUtils.closeQuietly(client); CloseableUtils.closeQuietly(server); &#125; &#125; private static QueueSerializer&lt;String&gt; createQueueSerializer() &#123; return new QueueSerializer&lt;String&gt;() &#123; @Override public byte[] serialize(String item) &#123; return item.getBytes(); &#125; @Override public String deserialize(byte[] bytes) &#123; return new String(bytes); &#125; &#125;; &#125; private static QueueConsumer&lt;String&gt; createQueueConsumer() &#123; return new QueueConsumer&lt;String&gt;() &#123; @Override public void stateChanged(CuratorFramework client, ConnectionState newState) &#123; System.out.println(\"connection new state: \" + newState.name()); &#125; @Override public void consumeMessage(String message) throws Exception &#123; Thread.sleep(1000); System.out.println(\"consume one message: \" + message); &#125; &#125;; &#125;&#125; æœ‰æ—¶å€™ä½ å¯èƒ½ä¼šæœ‰é”™è§‰ï¼Œä¼˜å…ˆçº§è®¾ç½®å¹¶æ²¡æœ‰èµ·æ•ˆã€‚é‚£æ˜¯å› ä¸ºä¼˜å…ˆçº§æ˜¯å¯¹äºé˜Ÿåˆ—ç§¯å‹çš„å…ƒç´ è€Œè¨€ï¼Œå¦‚æœæ¶ˆè´¹é€Ÿåº¦è¿‡å¿«æœ‰å¯èƒ½å‡ºç°åœ¨åä¸€ä¸ªå…ƒç´ å…¥é˜Ÿæ“ä½œä¹‹å‰å‰ä¸€ä¸ªå…ƒç´ å·²ç»è¢«æ¶ˆè´¹ï¼Œè¿™ç§æƒ…å†µä¸‹DistributedPriorityQueueä¼šé€€åŒ–ä¸ºDistributedQueueã€‚ åˆ†å¸ƒå¼å»¶è¿Ÿé˜Ÿåˆ—â€”DistributedDelayQueue JDKä¸­ä¹Ÿæœ‰DelayQueueï¼Œä¸çŸ¥é“ä½ æ˜¯å¦ç†Ÿæ‚‰ã€‚ DistributedDelayQueueä¹Ÿæä¾›äº†ç±»ä¼¼çš„åŠŸèƒ½ï¼Œ å…ƒç´ æœ‰ä¸ªdelayå€¼ï¼Œ æ¶ˆè´¹è€…éš”ä¸€æ®µæ—¶é—´æ‰èƒ½æ”¶åˆ°å…ƒç´ ã€‚ æ¶‰åŠåˆ°ä¸‹é¢å››ä¸ªç±»ã€‚ QueueBuilder QueueConsumer QueueSerializer DistributedDelayQueue é€šè¿‡ä¸‹é¢çš„è¯­å¥åˆ›å»ºï¼š 123QueueBuilder&lt;MessageType&gt; builder &#x3D; QueueBuilder.builder(client, consumer, serializer, path);... more builder method calls as needed ...DistributedDelayQueue&lt;MessageType&gt; queue &#x3D; builder.buildDelayQueue(); æ”¾å…¥å…ƒç´ æ—¶å¯ä»¥æŒ‡å®šdelayUntilEpochï¼š 1queue.put(aMessage, delayUntilEpoch); æ³¨æ„delayUntilEpochä¸æ˜¯ç¦»ç°åœ¨çš„ä¸€ä¸ªæ—¶é—´é—´éš”ï¼Œ æ¯”å¦‚20æ¯«ç§’ï¼Œè€Œæ˜¯æœªæ¥çš„ä¸€ä¸ªæ—¶é—´æˆ³ï¼Œå¦‚ System.currentTimeMillis() + 10ç§’ã€‚ å¦‚æœdelayUntilEpochçš„æ—¶é—´å·²ç»è¿‡å»ï¼Œæ¶ˆæ¯ä¼šç«‹åˆ»è¢«æ¶ˆè´¹è€…æ¥æ”¶ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768public class DistributedDelayQueueDemo &#123; private static final String PATH = \"/example/queue\"; public static void main(String[] args) throws Exception &#123; TestingServer server = new TestingServer(); CuratorFramework client = null; DistributedDelayQueue&lt;String&gt; queue = null; try &#123; client = CuratorFrameworkFactory.newClient(server.getConnectString(), new ExponentialBackoffRetry(1000, 3)); client.getCuratorListenable().addListener((client1, event) -&gt; System.out.println(\"CuratorEvent: \" + event.getType().name())); client.start(); QueueConsumer&lt;String&gt; consumer = createQueueConsumer(); QueueBuilder&lt;String&gt; builder = QueueBuilder.builder(client, consumer, createQueueSerializer(), PATH); queue = builder.buildDelayQueue(); queue.start(); for (int i = 0; i &lt; 10; i++) &#123; queue.put(\"test-\" + i, System.currentTimeMillis() + 10000); &#125; System.out.println(new Date().getTime() + \": already put all items\"); Thread.sleep(20000); &#125; catch (Exception ex) &#123; &#125; finally &#123; CloseableUtils.closeQuietly(queue); CloseableUtils.closeQuietly(client); CloseableUtils.closeQuietly(server); &#125; &#125; private static QueueSerializer&lt;String&gt; createQueueSerializer() &#123; return new QueueSerializer&lt;String&gt;() &#123; @Override public byte[] serialize(String item) &#123; return item.getBytes(); &#125; @Override public String deserialize(byte[] bytes) &#123; return new String(bytes); &#125; &#125;; &#125; private static QueueConsumer&lt;String&gt; createQueueConsumer() &#123; return new QueueConsumer&lt;String&gt;() &#123; @Override public void stateChanged(CuratorFramework client, ConnectionState newState) &#123; System.out.println(\"connection new state: \" + newState.name()); &#125; @Override public void consumeMessage(String message) throws Exception &#123; System.out.println(new Date().getTime() + \": consume one message: \" + message); &#125; &#125;; &#125;&#125; SimpleDistributedQueue å‰é¢è™½ç„¶å®ç°äº†å„ç§é˜Ÿåˆ—ï¼Œä½†æ˜¯ä½ æ³¨æ„åˆ°æ²¡æœ‰ï¼Œè¿™äº›é˜Ÿåˆ—å¹¶æ²¡æœ‰å®ç°ç±»ä¼¼JDKä¸€æ ·çš„æ¥å£ã€‚ SimpleDistributedQueueæä¾›äº†å’ŒJDKåŸºæœ¬ä¸€è‡´çš„æ¥å£(ä½†æ˜¯æ²¡æœ‰å®ç°Queueæ¥å£)ã€‚ åˆ›å»ºå¾ˆç®€å•ï¼š 1public SimpleDistributedQueue(CuratorFramework client,String path) å¢åŠ å…ƒç´ ï¼š 1public boolean offer(byte[] data) throws Exception åˆ é™¤å…ƒç´ ï¼š 1public byte[] take() throws Exception å¦å¤–è¿˜æä¾›äº†å…¶å®ƒæ–¹æ³•ï¼š 12345public byte[] peek() throws Exceptionpublic byte[] poll(long timeout, TimeUnit unit) throws Exceptionpublic byte[] poll() throws Exceptionpublic byte[] remove() throws Exceptionpublic byte[] element() throws Exception æ²¡æœ‰addæ–¹æ³•ï¼Œ å¤šäº†takeæ–¹æ³•ã€‚ takeæ–¹æ³•åœ¨æˆåŠŸè¿”å›ä¹‹å‰ä¼šè¢«é˜»å¡ã€‚ è€Œpollæ–¹æ³•åœ¨é˜Ÿåˆ—ä¸ºç©ºæ—¶ç›´æ¥è¿”å›nullã€‚ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172public class SimpleDistributedQueueDemo &#123; private static final String PATH = \"/example/queue\"; public static void main(String[] args) throws Exception &#123; TestingServer server = new TestingServer(); CuratorFramework client = null; SimpleDistributedQueue queue; try &#123; client = CuratorFrameworkFactory.newClient(server.getConnectString(), new ExponentialBackoffRetry(1000, 3)); client.getCuratorListenable().addListener((client1, event) -&gt; System.out.println(\"CuratorEvent: \" + event.getType().name())); client.start(); queue = new SimpleDistributedQueue(client, PATH); Producer producer = new Producer(queue); Consumer consumer = new Consumer(queue); new Thread(producer, \"producer\").start(); new Thread(consumer, \"consumer\").start(); Thread.sleep(20000); &#125; catch (Exception ex) &#123; &#125; finally &#123; CloseableUtils.closeQuietly(client); CloseableUtils.closeQuietly(server); &#125; &#125; public static class Producer implements Runnable &#123; private SimpleDistributedQueue queue; public Producer(SimpleDistributedQueue queue) &#123; this.queue = queue; &#125; @Override public void run() &#123; for (int i = 0; i &lt; 100; i++) &#123; try &#123; boolean flag = queue.offer((\"zjc-\" + i).getBytes()); if (flag) &#123; System.out.println(\"å‘é€ä¸€æ¡æ¶ˆæ¯æˆåŠŸï¼š\" + \"zjc-\" + i); &#125; else &#123; System.out.println(\"å‘é€ä¸€æ¡æ¶ˆæ¯å¤±è´¥ï¼š\" + \"zjc-\" + i); &#125; &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; &#125; &#125; &#125; public static class Consumer implements Runnable &#123; private SimpleDistributedQueue queue; public Consumer(SimpleDistributedQueue queue) &#123; this.queue = queue; &#125; @Override public void run() &#123; try &#123; byte[] datas = queue.take(); System.out.println(\"æ¶ˆè´¹ä¸€æ¡æ¶ˆæ¯æˆåŠŸï¼š\" + new String(datas, \"UTF-8\")); &#125; catch (Exception e) &#123; e.printStackTrace(); &#125; &#125; &#125;&#125; ä½†æ˜¯å®é™…ä¸Šå‘é€äº†100æ¡æ¶ˆæ¯ï¼Œæ¶ˆè´¹å®Œç¬¬ä¸€æ¡ä¹‹åï¼Œåé¢çš„æ¶ˆæ¯æ— æ³•æ¶ˆè´¹ï¼Œç›®å‰æ²¡æ‰¾åˆ°åŸå› ã€‚æŸ¥çœ‹ä¸€ä¸‹å®˜æ–¹æ–‡æ¡£æ¨èçš„demoä½¿ç”¨ä¸‹é¢å‡ ä¸ªApiï¼š 123456789101112131415161718192021222324Creating a SimpleDistributedQueuepublic SimpleDistributedQueue(CuratorFramework client, String path)Parameters:client - the clientpath - path to store queue nodesAdd to the queuepublic boolean offer(byte[] data) throws ExceptionInserts data into queue.Parameters:data - the dataReturns:true if data was successfully addedTake from the queuepublic byte[] take() throws ExceptionRemoves the head of the queue and returns it, blocks until it succeeds.Returns:The former head of the queueNOTE: see the Javadoc for additional methods ä½†æ˜¯å®é™…ä½¿ç”¨å‘ç°è¿˜æ˜¯å­˜åœ¨æ¶ˆè´¹é˜»å¡é—®é¢˜ã€‚ åˆ†å¸ƒå¼å±éšœâ€”Barrier åˆ†å¸ƒå¼Barrieræ˜¯è¿™æ ·ä¸€ä¸ªç±»ï¼š å®ƒä¼šé˜»å¡æ‰€æœ‰èŠ‚ç‚¹ä¸Šçš„ç­‰å¾…è¿›ç¨‹ï¼Œç›´åˆ°æŸä¸€ä¸ªè¢«æ»¡è¶³ï¼Œ ç„¶åæ‰€æœ‰çš„èŠ‚ç‚¹ç»§ç»­è¿›è¡Œã€‚ æ¯”å¦‚èµ›é©¬æ¯”èµ›ä¸­ï¼Œ ç­‰èµ›é©¬é™†ç»­æ¥åˆ°èµ·è·‘çº¿å‰ã€‚ ä¸€å£°ä»¤ä¸‹ï¼Œæ‰€æœ‰çš„èµ›é©¬éƒ½é£å¥”è€Œå‡ºã€‚ DistributedBarrier DistributedBarrierç±»å®ç°äº†æ …æ çš„åŠŸèƒ½ã€‚ å®ƒçš„æ„é€ å‡½æ•°å¦‚ä¸‹ï¼š 1234public DistributedBarrier(CuratorFramework client, String barrierPath)Parameters:client - clientbarrierPath - path to use as the barrier é¦–å…ˆä½ éœ€è¦è®¾ç½®æ …æ ï¼Œå®ƒå°†é˜»å¡åœ¨å®ƒä¸Šé¢ç­‰å¾…çš„çº¿ç¨‹: 1setBarrier(); ç„¶åéœ€è¦é˜»å¡çš„çº¿ç¨‹è°ƒç”¨æ–¹æ³•ç­‰å¾…æ”¾è¡Œæ¡ä»¶: 1public void waitOnBarrier() å½“æ¡ä»¶æ»¡è¶³æ—¶ï¼Œç§»é™¤æ …æ ï¼Œæ‰€æœ‰ç­‰å¾…çš„çº¿ç¨‹å°†ç»§ç»­æ‰§è¡Œï¼š 1removeBarrier(); å¼‚å¸¸å¤„ç† DistributedBarrier ä¼šç›‘æ§è¿æ¥çŠ¶æ€ï¼Œå½“è¿æ¥æ–­æ‰æ—¶waitOnBarrier()æ–¹æ³•ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ 1234567891011121314151617181920212223242526272829303132333435public class DistributedBarrierDemo &#123; private static final int QTY = 5; private static final String PATH = \"/examples/barrier\"; public static void main(String[] args) throws Exception &#123; try (TestingServer server = new TestingServer()) &#123; CuratorFramework client = CuratorFrameworkFactory.newClient(server.getConnectString(), new ExponentialBackoffRetry(1000, 3)); client.start(); ExecutorService service = Executors.newFixedThreadPool(QTY); DistributedBarrier controlBarrier = new DistributedBarrier(client, PATH); controlBarrier.setBarrier(); for (int i = 0; i &lt; QTY; ++i) &#123; final DistributedBarrier barrier = new DistributedBarrier(client, PATH); final int index = i; Callable&lt;Void&gt; task = () -&gt; &#123; Thread.sleep((long) (3 * Math.random())); System.out.println(\"Client #\" + index + \" waits on Barrier\"); barrier.waitOnBarrier(); System.out.println(\"Client #\" + index + \" begins\"); return null; &#125;; service.submit(task); &#125; Thread.sleep(10000); System.out.println(\"all Barrier instances should wait the condition\"); controlBarrier.removeBarrier(); service.shutdown(); service.awaitTermination(10, TimeUnit.MINUTES); Thread.sleep(20000); &#125; &#125;&#125; è¿™ä¸ªä¾‹å­åˆ›å»ºäº†controlBarrieræ¥è®¾ç½®æ …æ å’Œç§»é™¤æ …æ ã€‚ æˆ‘ä»¬åˆ›å»ºäº†5ä¸ªçº¿ç¨‹ï¼Œåœ¨æ­¤Barrierä¸Šç­‰å¾…ã€‚ æœ€åç§»é™¤æ …æ åæ‰€æœ‰çš„çº¿ç¨‹æ‰ç»§ç»­æ‰§è¡Œã€‚ å¦‚æœä½ å¼€å§‹ä¸è®¾ç½®æ …æ ï¼Œæ‰€æœ‰çš„çº¿ç¨‹å°±ä¸ä¼šé˜»å¡ä½ã€‚ åŒæ …æ â€”DistributedDoubleBarrier åŒæ …æ å…è®¸å®¢æˆ·ç«¯åœ¨è®¡ç®—çš„å¼€å§‹å’Œç»“æŸæ—¶åŒæ­¥ã€‚å½“è¶³å¤Ÿçš„è¿›ç¨‹åŠ å…¥åˆ°åŒæ …æ æ—¶ï¼Œè¿›ç¨‹å¼€å§‹è®¡ç®—ï¼Œ å½“è®¡ç®—å®Œæˆæ—¶ï¼Œç¦»å¼€æ …æ ã€‚ åŒæ …æ ç±»æ˜¯DistributedDoubleBarrierã€‚ æ„é€ å‡½æ•°ä¸º: 12345678910public DistributedDoubleBarrier(CuratorFramework client, String barrierPath, int memberQty)Creates the barrier abstraction. memberQty is the number of members in the barrier. When enter() is called, it blocks untilall members have entered. When leave() is called, it blocks until all members have left.Parameters:client - the clientbarrierPath - path to usememberQty - the number of members in the barrier memberQtyæ˜¯æˆå‘˜æ•°é‡ï¼Œå½“enter()æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œæˆå‘˜è¢«é˜»å¡ï¼Œç›´åˆ°æ‰€æœ‰çš„æˆå‘˜éƒ½è°ƒç”¨äº†enter()ã€‚ å½“leave()æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œå®ƒä¹Ÿé˜»å¡è°ƒç”¨çº¿ç¨‹ï¼Œç›´åˆ°æ‰€æœ‰çš„æˆå‘˜éƒ½è°ƒç”¨äº†leave()ã€‚ å°±åƒç™¾ç±³èµ›è·‘æ¯”èµ›ï¼Œ å‘ä»¤æªå“ï¼Œ æ‰€æœ‰çš„è¿åŠ¨å‘˜å¼€å§‹è·‘ï¼Œç­‰æ‰€æœ‰çš„è¿åŠ¨å‘˜è·‘è¿‡ç»ˆç‚¹çº¿ï¼Œæ¯”èµ›æ‰ç»“æŸã€‚ DistributedDoubleBarrierä¼šç›‘æ§è¿æ¥çŠ¶æ€ï¼Œå½“è¿æ¥æ–­æ‰æ—¶enter()å’Œleave()æ–¹æ³•ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ 12345678910111213141516171819202122232425262728293031323334public class DistributedDoubleBarrierDemo &#123; private static final int QTY = 5; private static final String PATH = \"/examples/barrier\"; public static void main(String[] args) throws Exception &#123; try (TestingServer server = new TestingServer()) &#123; CuratorFramework client = CuratorFrameworkFactory.newClient(server.getConnectString(), new ExponentialBackoffRetry(1000, 3)); client.start(); ExecutorService service = Executors.newFixedThreadPool(QTY); for (int i = 0; i &lt; QTY; ++i) &#123; final DistributedDoubleBarrier barrier = new DistributedDoubleBarrier(client, PATH, QTY); final int index = i; Callable&lt;Void&gt; task = () -&gt; &#123; Thread.sleep((long) (3 * Math.random())); System.out.println(\"Client #\" + index + \" enters\"); barrier.enter(); System.out.println(\"Client #\" + index + \" begins\"); Thread.sleep((long) (3000 * Math.random())); barrier.leave(); System.out.println(\"Client #\" + index + \" left\"); return null; &#125;; service.submit(task); &#125; service.shutdown(); service.awaitTermination(10, TimeUnit.MINUTES); Thread.sleep(Integer.MAX_VALUE); &#125; &#125;&#125; å‚è€ƒèµ„æ–™ï¼š ã€Šä»PAXOSåˆ°ZOOKEEPERåˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†ä¸å®è·µã€‹ ã€Šè·Ÿç€å®ä¾‹å­¦ä¹ ZooKeeperçš„ç”¨æ³•ã€‹åšå®¢ç³»åˆ— é¡¹ç›®ä»“åº“ï¼š https://github.com/zjcscut/curator-seed (e-a-2017-5-13 13:10 c-14-d r-a-20181216)","categories":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/categories/Middleware/"},{"name":"Zookeeper","slug":"Middleware/Zookeeper","permalink":"http://throwable.club/blog/categories/Middleware/Zookeeper/"}],"tags":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/tags/Middleware/"},{"name":"Zookeeper","slug":"Zookeeper","permalink":"http://throwable.club/blog/tags/Zookeeper/"}]},{"title":"æ·±å…¥åˆ†æJavaåå°„(å…«)-ä¼˜åŒ–åå°„è°ƒç”¨æ€§èƒ½","slug":"java-reflection-optimal-performance","date":"2018-12-16T04:00:50.000Z","updated":"2018-12-16T04:01:22.795Z","comments":true,"path":"2018/12/16/java-reflection-optimal-performance/","link":"","permalink":"http://throwable.club/2018/12/16/java-reflection-optimal-performance/","excerpt":"","text":"æ·±å…¥åˆ†æJavaåå°„(å…«)-ä¼˜åŒ–åå°„è°ƒç”¨æ€§èƒ½ Javaåå°„çš„APIåœ¨JavaSE1.7çš„æ—¶å€™å·²ç»åŸºæœ¬å®Œå–„ï¼Œä½†æ˜¯æœ¬æ–‡ç¼–å†™çš„æ—¶å€™ä½¿ç”¨çš„æ˜¯Oracle JDK11ï¼Œå› ä¸ºJDK11å¯¹äºsunåŒ…ä¸‹çš„æºç ä¹Ÿä¸Šä¼ äº†ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡IDEæŸ¥çœ‹å¯¹åº”çš„æºç å’Œè¿›è¡ŒDebugã€‚ å‰ä¸€ç¯‡æ–‡ç« å·²ç»ä»‹ç»äº†åå°„è°ƒç”¨çš„åº•å±‚åŸç†ï¼Œå…¶å®åœ¨å®é™…ä¸­å¯¹å¤§å¤šæ•°Javaä½¿ç”¨è€…æ¥è¯´æ›´å…³ç³»çš„æ˜¯å¦‚ä½•æå‡åå°„è°ƒç”¨çš„æ€§èƒ½ï¼Œæœ¬æ–‡ä¸»è¦æä¾›å‡ ä¸ªå¯è¡Œçš„æ–¹æ¡ˆã€‚å¦å¤–ï¼Œç”±äºæ–¹æ³•è°ƒç”¨æ—¶é¢‘ç‡æœ€é«˜çš„åå°„æ“ä½œï¼Œä¼šç€é‡ä»‹ç»æ–¹æ³•çš„åå°„è°ƒç”¨ä¼˜åŒ–ã€‚ æ–¹æ³•ä¸€ï¼šé€‰æ‹©åˆé€‚çš„API é€‰æ‹©åˆé€‚çš„APIä¸»è¦æ˜¯åœ¨è·å–åå°„ç›¸å…³å…ƒæ•°æ®çš„æ—¶å€™å°½é‡é¿å…ä½¿ç”¨éå†çš„æ–¹æ³•ï¼Œä¾‹å¦‚ï¼š è·å–Fieldå®ä¾‹ï¼šå°½é‡é¿å…é¢‘ç¹ä½¿ç”¨Class#getDeclaredFields()æˆ–è€…Class#getFields()ï¼Œåº”è¯¥æ ¹æ®Fieldçš„åç§°ç›´æ¥è°ƒç”¨Class#getDeclaredField()æˆ–è€…Class#getField()ã€‚ è·å–Methodå®ä¾‹ï¼šå°½é‡é¿å…é¢‘ç¹ä½¿ç”¨Class#getDeclaredMethods()æˆ–è€…Class#getMethods()ï¼Œåº”è¯¥æ ¹æ®Methodçš„åç§°å’Œå‚æ•°ç±»å‹æ•°ç»„è°ƒç”¨Class#getDeclaredMethod()æˆ–è€…Class#getMethod()ã€‚ è·å–Constructorå®ä¾‹ï¼šå°½é‡é¿å…é¢‘ç¹ä½¿ç”¨Class#getDeclaredConstructors()æˆ–è€…Class#getConstructors()ï¼Œåº”è¯¥æ ¹æ®Constructorå‚æ•°ç±»å‹æ•°ç»„è°ƒç”¨Class#getDeclaredConstructor()æˆ–è€…Class#getConstructor()ã€‚ å…¶å®æ€è·¯å¾ˆç®€å•ï¼Œé™¤éæˆ‘ä»¬æƒ³è¦è·å–Classçš„æ‰€æœ‰Fieldã€Methodæˆ–è€…Constructorï¼Œå¦åˆ™åº”è¯¥é¿å…ä½¿ç”¨è¿”å›ä¸€ä¸ªé›†åˆæˆ–è€…æ•°ç»„çš„APIï¼Œè¿™æ ·å­èƒ½å‡å°‘éå†æˆ–è€…åˆ¤æ–­å¸¦æ¥çš„æ€§èƒ½æŸè€—ã€‚ æ–¹æ³•äºŒï¼šç¼“å­˜åå°„æ“ä½œç›¸å…³å…ƒæ•°æ® ä½¿ç”¨ç¼“å­˜æœºåˆ¶ç¼“å­˜åå°„æ“ä½œç›¸å…³å…ƒæ•°æ®çš„åŸå› æ˜¯å› ä¸ºåå°„æ“ä½œç›¸å…³å…ƒæ•°æ®çš„å®æ—¶è·å–æ˜¯æ¯”è¾ƒè€—æ—¶çš„ï¼Œè¿™é‡Œåˆ—ä¸¾å‡ ä¸ªç›¸å¯¹è€—æ—¶çš„åœºæ™¯ï¼š è·å–Classå®ä¾‹ï¼šClass#forName()ï¼Œæ­¤æ–¹æ³•å¯ä»¥æŸ¥çœ‹æºç ï¼Œè€—æ—¶ç›¸å¯¹å…¶ä»–æ–¹æ³•é«˜å¾—å¤šã€‚ è·å–Fieldå®ä¾‹ï¼šClass#getDeclaredField()ã€Class#getDeclaredFields()ã€Class#getField()ã€Class#getFields()ã€‚ è·å–Methodå®ä¾‹ï¼šClass#getDeclaredMethod()ã€Class#getDeclaredMethods()ã€Class#getMethod()ã€Class#getMethods()ã€‚ è·å–Constructorå®ä¾‹ï¼šClass#getDeclaredConstructor()ã€Class#getDeclaredConstructors()ã€Class#getConstructor()ã€Class#getConstructors()ã€‚ è¿™é‡Œä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼Œéœ€è¦åå°„è°ƒç”¨ä¸€ä¸ªæ™®é€šJavaBeançš„Setterå’ŒGetteræ–¹æ³•ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182838485868788899091929394959697// JavaBean@Datapublic class JavaBean &#123; private String name;&#125;public class Main &#123; private static final Map&lt;Class&lt;?&gt;, List&lt;ReflectionMetadata&gt;&gt; METADATA = new HashMap&lt;&gt;(); private static final Map&lt;String, Class&lt;?&gt;&gt; CLASSES = new HashMap&lt;&gt;(); // è§£æçš„æ—¶å€™å°½é‡æ”¾åœ¨&lt;cinit&gt;é‡Œé¢ static &#123; Class&lt;?&gt; clazz = JavaBean.class; CLASSES.put(clazz.getName(), clazz); List&lt;ReflectionMetadata&gt; metadataList = new ArrayList&lt;&gt;(); METADATA.put(clazz, metadataList); try &#123; for (Field f : clazz.getDeclaredFields()) &#123; ReflectionMetadata metadata = new ReflectionMetadata(); metadataList.add(metadata); metadata.setTargetClass(clazz); metadata.setField(f); String name = f.getName(); Class&lt;?&gt; type = f.getType(); metadata.setReadMethod(clazz.getDeclaredMethod(String.format(\"get%s%s\", Character.toUpperCase(name.charAt(0)), name.substring(1)))); metadata.setWriteMethod(clazz.getDeclaredMethod(String.format(\"set%s%s\", Character.toUpperCase(name.charAt(0)), name.substring(1)), type)); &#125; &#125; catch (Exception e) &#123; throw new IllegalStateException(e); &#125; &#125; public static void main(String[] args) throws Exception &#123; String fieldName = \"name\"; Class&lt;JavaBean&gt; javaBeanClass = JavaBean.class; JavaBean javaBean = new JavaBean(); invokeSetter(javaBeanClass, javaBean, fieldName , \"Doge\"); System.out.println(invokeGetter(javaBeanClass,javaBean, fieldName)); invokeSetter(javaBeanClass.getName(), javaBean, fieldName , \"Throwable\"); System.out.println(invokeGetter(javaBeanClass.getName(),javaBean, fieldName)); &#125; private static void invokeSetter(String className, Object target, String fieldName, Object value) throws Exception &#123; METADATA.get(CLASSES.get(className)).forEach(each -&gt; &#123; Field field = each.getField(); if (field.getName().equals(fieldName)) &#123; try &#123; each.getWriteMethod().invoke(target, value); &#125; catch (Exception e) &#123; throw new IllegalStateException(e); &#125; &#125; &#125;); &#125; private static void invokeSetter(Class&lt;?&gt; clazz, Object target, String fieldName, Object value) throws Exception &#123; METADATA.get(clazz).forEach(each -&gt; &#123; Field field = each.getField(); if (field.getName().equals(fieldName)) &#123; try &#123; each.getWriteMethod().invoke(target, value); &#125; catch (Exception e) &#123; throw new IllegalStateException(e); &#125; &#125; &#125;); &#125; private static Object invokeGetter(String className, Object target, String fieldName) throws Exception &#123; for (ReflectionMetadata metadata : METADATA.get(CLASSES.get(className))) &#123; if (metadata.getField().getName().equals(fieldName)) &#123; return metadata.getReadMethod().invoke(target); &#125; &#125; throw new IllegalStateException(); &#125; private static Object invokeGetter(Class&lt;?&gt; clazz, Object target, String fieldName) throws Exception &#123; for (ReflectionMetadata metadata : METADATA.get(clazz)) &#123; if (metadata.getField().getName().equals(fieldName)) &#123; return metadata.getReadMethod().invoke(target); &#125; &#125; throw new IllegalStateException(); &#125; @Data private static class ReflectionMetadata &#123; private Class&lt;?&gt; targetClass; private Field field; private Method readMethod; private Method writeMethod; &#125;&#125; ç®€å•æ¥è¯´ï¼Œè§£æåå°„å…ƒæ•°æ®è¿›è¡Œç¼“å­˜çš„æ“ä½œæœ€å¥½æ”¾åœ¨é™æ€ä»£ç å—æˆ–è€…é¦–æ¬¡è°ƒç”¨çš„æ—¶å€™(ä¹Ÿå°±æ˜¯æ‡’åŠ è½½)ï¼Œè¿™æ ·èƒ½å¤Ÿé¿å…çœŸæ­£è°ƒç”¨çš„æ—¶å€™æ€»æ˜¯éœ€è¦é‡æ–°åŠ è½½ä¸€æ¬¡åå°„ç›¸å…³å…ƒæ•°æ®ã€‚ æ–¹æ³•ä¸‰ï¼šåå°„æ“ä½œè½¬å˜ä¸ºç›´æ¥è°ƒç”¨ &quot;åå°„æ“ä½œè½¬å˜ä¸ºç›´æ¥è°ƒç”¨&quot;å¹¶ä¸æ˜¯å®Œå…¨ä¸ä¾èµ–äºåå°„çš„ç±»åº“ï¼Œè¿™é‡Œçš„åšæ³•æ˜¯æŠŠåå°„æ“ä½œç›¸å…³å…ƒæ•°æ®ç›´æ¥æ”¾ç½®åœ¨ç±»çš„æˆå‘˜å˜é‡ä¸­ï¼Œè¿™æ ·å°±èƒ½çœå»ä»ç¼“å­˜ä¸­è¯»å–åå°„ç›¸å…³å…ƒæ•°æ®çš„æ¶ˆè€—ï¼Œè€Œæ‰€è°“&quot;ç›´æ¥è°ƒç”¨&quot;ä¸€èˆ¬æ˜¯é€šè¿‡ç»§æ‰¿æˆ–è€…å®ç°æ¥å£å®ç°ã€‚æœ‰ä¸€äº›é«˜æ€§èƒ½çš„åå°„ç±»åº“ä¹Ÿä¼šä½¿ç”¨ä¸€äº›åˆ›æ–°çš„æ–¹æ³•ï¼šä¾‹å¦‚ä½¿ç”¨æˆå‘˜å±æ€§ç¼“å­˜åå°„ç›¸å…³å…ƒæ•°æ®ï¼Œå¹¶ä¸”æŠŠæ–¹æ³•è°ƒç”¨é€šè¿‡æ•°å­—å»ºç«‹ç´¢å¼•[Number-&gt;Method]æˆ–è€…å»ºç«‹ç´¢å¼•ç±»(åƒCGLIBçš„FastClass)ï¼Œè¿™ç§åšæ³•åœ¨çˆ¶ç±»æˆ–è€…æ¥å£æ–¹æ³•æ¯”è¾ƒå°‘çš„æ—¶å€™ä¼šæœ‰ä¸€å®šçš„æ€§èƒ½æå‡ï¼Œä½†æ˜¯å®é™…ä¸Šæ€§èƒ½è¯„ä¼°éœ€è¦ä»å…·ä½“çš„åœºæ™¯é€šè¿‡æµ‹è¯•åˆ†æç»“æœè€Œä¸èƒ½ç›²ç›®ä½¿ç”¨ï¼Œä½¿ç”¨è¿™ä¸ªæ€æƒ³çš„ç±»åº“æœ‰CGLIBã€ReflectASMç­‰ã€‚&quot;åå°„æ“ä½œè½¬å˜ä¸ºç›´æ¥è°ƒç”¨&quot;çš„æœ€å…¸å‹çš„å®ç°å°±æ˜¯JDKçš„åŠ¨æ€ä»£ç†ï¼Œè¿™é‡Œç¿»å‡ºä¹‹å‰åŠ¨æ€ä»£ç†é‚£ç¯‡æ–‡ç« çš„ä¾‹å­æ¥è¯´ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596// æ¥å£public interface Simple &#123; void sayHello(String name);&#125;// æ¥å£å®ç°public class DefaultSimple implements Simple &#123; @Override public void sayHello(String name) &#123; System.out.println(String.format(\"%s say hello!\", name)); &#125;&#125;// åœºæ™¯ç±»public class Main &#123; public static void main(String[] args) throws Exception &#123; Simple simple = new DefaultSimple(); Object target = Proxy.newProxyInstance(Main.class.getClassLoader(), new Class[]&#123;Simple.class&#125;, new InvocationHandler() &#123; @Override public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123; System.out.println(\"Before say hello...\"); method.invoke(simple, args); System.out.println(\"After say hello...\"); return null; &#125; &#125;); Simple proxy = (Simple) target; proxy.sayHello(\"throwable\"); &#125;&#125;// ä»£ç†ç±»public final class $Proxy0 extends Proxy implements Simple &#123; private static Method m1; private static Method m3; private static Method m2; private static Method m0; public $Proxy0(InvocationHandler var1) throws &#123; super(var1); &#125; public final boolean equals(Object var1) throws &#123; try &#123; return (Boolean)super.h.invoke(this, m1, new Object[]&#123;var1&#125;); &#125; catch (RuntimeException | Error var3) &#123; throw var3; &#125; catch (Throwable var4) &#123; throw new UndeclaredThrowableException(var4); &#125; &#125; public final void sayHello(String var1) throws &#123; try &#123; super.h.invoke(this, m3, new Object[]&#123;var1&#125;); &#125; catch (RuntimeException | Error var3) &#123; throw var3; &#125; catch (Throwable var4) &#123; throw new UndeclaredThrowableException(var4); &#125; &#125; public final String toString() throws &#123; try &#123; return (String)super.h.invoke(this, m2, (Object[])null); &#125; catch (RuntimeException | Error var2) &#123; throw var2; &#125; catch (Throwable var3) &#123; throw new UndeclaredThrowableException(var3); &#125; &#125; public final int hashCode() throws &#123; try &#123; return (Integer)super.h.invoke(this, m0, (Object[])null); &#125; catch (RuntimeException | Error var2) &#123; throw var2; &#125; catch (Throwable var3) &#123; throw new UndeclaredThrowableException(var3); &#125; &#125; static &#123; try &#123; m1 = Class.forName(\"java.lang.Object\").getMethod(\"equals\", Class.forName(\"java.lang.Object\")); m3 = Class.forName(\"club.throwable.jdk.sample.reflection.proxy.Simple\").getMethod(\"sayHello\", Class.forName(\"java.lang.String\")); m2 = Class.forName(\"java.lang.Object\").getMethod(\"toString\"); m0 = Class.forName(\"java.lang.Object\").getMethod(\"hashCode\"); &#125; catch (NoSuchMethodException var2) &#123; throw new NoSuchMethodError(var2.getMessage()); &#125; catch (ClassNotFoundException var3) &#123; throw new NoClassDefFoundError(var3.getMessage()); &#125; &#125;&#125; è¿™æ ·åšçš„è¯Simpleæ¥å£å®ä¾‹è™½ç„¶æœ€ç»ˆæ˜¯é€šè¿‡åå°„è°ƒç”¨sayHello(String var1)æ–¹æ³•ï¼Œä½†æ˜¯ç›¸å…³å…ƒæ•°æ®åœ¨é™æ€ä»£ç å—ä¸­åˆ›å»ºå¹¶ä¸”å·²ç»ç¼“å­˜åœ¨ç±»æˆå‘˜å±æ€§ä¸­ï¼Œé‚£ä¹ˆåå°„è°ƒç”¨æ–¹æ³•çš„æ€§èƒ½å·²ç»ä¼˜åŒ–åˆ°æè‡´ï¼Œå‰©ä¸‹çš„éƒ½åªæ˜¯Nativeæ–¹æ³•çš„è€—æ—¶ï¼Œè¿™ä¸€ç‚¹ä½¿ç”¨è€…åœ¨ç¼–ç å±‚é¢å·²ç»æ²¡æœ‰åŠæ³•ä¼˜åŒ–ï¼Œåªèƒ½é€šè¿‡å‡çº§JVM(JDK)ã€ä½¿ç”¨JITç¼–è¯‘å™¨ç­‰éç¼–ç å±‚é¢çš„æ‰‹æ®µæå‡åå°„æ€§èƒ½ã€‚ å°ç»“ æœ¬æ–‡ä¸»è¦ä»ç¼–ç å±‚é¢åˆ†æåå°„æ“ä½œä¸€äº›æ€§èƒ½ä¼˜åŒ–çš„å¯è¡Œç»éªŒæˆ–è€…æ–¹æ¡ˆï¼Œæˆ–è®¸æœ‰å…¶ä»–æ›´å¥½çš„ä¼˜åŒ–æ–¹æ¡ˆï¼Œå…·ä½“è¿˜æ˜¯éœ€è¦çœ‹ä½¿ç”¨åœºæ™¯ã€‚ (æœ¬æ–‡å®Œ e-a-20181216 c-2-d)","categories":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/categories/Java/"},{"name":"Reflection","slug":"Java/Reflection","permalink":"http://throwable.club/blog/categories/Java/Reflection/"}],"tags":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/tags/Java/"},{"name":"Reflection","slug":"Reflection","permalink":"http://throwable.club/blog/tags/Reflection/"}]},{"title":"æ·±å…¥åˆ†æJavaåå°„(ä¸ƒ)-ç®€è¿°åå°„è°ƒç”¨çš„åº•å±‚å®ç°","slug":"java-reflection-implementance","date":"2018-12-15T17:07:58.000Z","updated":"2018-12-15T17:09:52.958Z","comments":true,"path":"2018/12/16/java-reflection-implementance/","link":"","permalink":"http://throwable.club/2018/12/16/java-reflection-implementance/","excerpt":"","text":"æ·±å…¥åˆ†æJavaåå°„(ä¸ƒ)-ç®€è¿°åå°„è°ƒç”¨çš„åº•å±‚å®ç° å‰æ Javaåå°„çš„APIåœ¨JavaSE1.7çš„æ—¶å€™å·²ç»åŸºæœ¬å®Œå–„ï¼Œä½†æ˜¯æœ¬æ–‡ç¼–å†™çš„æ—¶å€™ä½¿ç”¨çš„æ˜¯Oracle JDK11ï¼Œå› ä¸ºJDK11å¯¹äºsunåŒ…ä¸‹çš„æºç ä¹Ÿä¸Šä¼ äº†ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡IDEæŸ¥çœ‹å¯¹åº”çš„æºç å’Œè¿›è¡ŒDebugã€‚ æœ¬æ–‡ä¸»è¦ä»‹ç»åå°„è°ƒç”¨çš„åº•å±‚å®ç°ï¼Œå½“ç„¶è¿˜æ²¡æœ‰èƒ½åŠ›åˆ†æJVMçš„å®ç°ï¼Œè¿™é‡Œåªåˆ†æåˆ°æœ€ç»ˆNativeæ–¹æ³•çš„è°ƒç”¨ç‚¹ã€‚åº•å±‚ä¼šä¾èµ–åˆ°Unsafeç±»ï¼Œå¯ä»¥çš„è¯å¯ä»¥çœ‹ä¸‹ç¬”è€…ä¹‹å‰å†™çš„ä¸€ç¯‡æ–‡ç« ã€Šç¥å¥‡çš„é­”æ³•ç±»å’ŒåŒåˆƒå‰‘-Unsafeã€‹ã€‚ åå°„è°ƒç”¨çš„åº•å±‚å®ç°æ¢ç©¶ ä¸»è¦è€ƒè™‘ä¸‹é¢çš„æƒ…å†µï¼š å±æ€§æ“ä½œï¼šjava.lang.reflect.Field#set(Object obj, Object value)å’Œjava.lang.reflect.Field#get(Object obj)ã€‚ æ„é€ å™¨è°ƒç”¨ï¼šjava.lang.reflect.Constructor#newInstance(Object ... initargs)ã€‚ æ–¹æ³•è°ƒç”¨ï¼šjava.lang.reflect.Method#invoke(Object obj, Object... args)ã€‚ å¤„ç†å±æ€§æ“ä½œçš„åº•å±‚å®ç° å±æ€§æ“ä½œæ–¹æ³•Field#set(Object obj, Object value)å’ŒField#get(Object obj)åº•å±‚éƒ½æ˜¯å§”æ‰˜åˆ°jdk.internal.reflect.FieldAccessorå®ç°ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364public interface FieldAccessor &#123; /** Matches specification in &#123;@link java.lang.reflect.Field&#125; */ public Object get(Object obj) throws IllegalArgumentException; /** Matches specification in &#123;@link java.lang.reflect.Field&#125; */ public boolean getBoolean(Object obj) throws IllegalArgumentException; /** Matches specification in &#123;@link java.lang.reflect.Field&#125; */ public byte getByte(Object obj) throws IllegalArgumentException; /** Matches specification in &#123;@link java.lang.reflect.Field&#125; */ public char getChar(Object obj) throws IllegalArgumentException; /** Matches specification in &#123;@link java.lang.reflect.Field&#125; */ public short getShort(Object obj) throws IllegalArgumentException; /** Matches specification in &#123;@link java.lang.reflect.Field&#125; */ public int getInt(Object obj) throws IllegalArgumentException; /** Matches specification in &#123;@link java.lang.reflect.Field&#125; */ public long getLong(Object obj) throws IllegalArgumentException; /** Matches specification in &#123;@link java.lang.reflect.Field&#125; */ public float getFloat(Object obj) throws IllegalArgumentException; /** Matches specification in &#123;@link java.lang.reflect.Field&#125; */ public double getDouble(Object obj) throws IllegalArgumentException; /** Matches specification in &#123;@link java.lang.reflect.Field&#125; */ public void set(Object obj, Object value) throws IllegalArgumentException, IllegalAccessException; /** Matches specification in &#123;@link java.lang.reflect.Field&#125; */ public void setBoolean(Object obj, boolean z) throws IllegalArgumentException, IllegalAccessException; /** Matches specification in &#123;@link java.lang.reflect.Field&#125; */ public void setByte(Object obj, byte b) throws IllegalArgumentException, IllegalAccessException; /** Matches specification in &#123;@link java.lang.reflect.Field&#125; */ public void setChar(Object obj, char c) throws IllegalArgumentException, IllegalAccessException; /** Matches specification in &#123;@link java.lang.reflect.Field&#125; */ public void setShort(Object obj, short s) throws IllegalArgumentException, IllegalAccessException; /** Matches specification in &#123;@link java.lang.reflect.Field&#125; */ public void setInt(Object obj, int i) throws IllegalArgumentException, IllegalAccessException; /** Matches specification in &#123;@link java.lang.reflect.Field&#125; */ public void setLong(Object obj, long l) throws IllegalArgumentException, IllegalAccessException; /** Matches specification in &#123;@link java.lang.reflect.Field&#125; */ public void setFloat(Object obj, float f) throws IllegalArgumentException, IllegalAccessException; /** Matches specification in &#123;@link java.lang.reflect.Field&#125; */ public void setDouble(Object obj, double d) throws IllegalArgumentException, IllegalAccessException;&#125; FieldAccessoræ¥å£æœ‰å¾ˆå¤šçš„å®ç°ï¼ŒFieldAccessoræ¥å£å®ä¾‹æ˜¯é€šè¿‡jdk.internal.reflect.ReflectionFactoryè¿™ä¸ªå·¥å‚æ„é€ çš„ï¼š 12345678910111213public FieldAccessor newFieldAccessor(Field field, boolean override) &#123; checkInitted(); Field root = langReflectAccess.getRoot(field); if (root != null) &#123; // FieldAccessor will use the root unless the modifiers have // been overrridden if (root.getModifiers() == field.getModifiers() || !override) &#123; field = root; &#125; &#125; return UnsafeFieldAccessorFactory.newFieldAccessor(field, override);&#125; æœ€ç»ˆå§”æ‰˜åˆ°UnsafeFieldAccessorFactory#newFieldAccessor()ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100class UnsafeFieldAccessorFactory &#123; static FieldAccessor newFieldAccessor(Field field, boolean override) &#123; Class&lt;?&gt; type = field.getType(); boolean isStatic = Modifier.isStatic(field.getModifiers()); boolean isFinal = Modifier.isFinal(field.getModifiers()); boolean isVolatile = Modifier.isVolatile(field.getModifiers()); boolean isQualified = isFinal || isVolatile; boolean isReadOnly = isFinal &amp;&amp; (isStatic || !override); if (isStatic) &#123; // This code path does not guarantee that the field's // declaring class has been initialized, but it must be // before performing reflective operations. UnsafeFieldAccessorImpl.unsafe.ensureClassInitialized(field.getDeclaringClass()); if (!isQualified) &#123; if (type == Boolean.TYPE) &#123; return new UnsafeStaticBooleanFieldAccessorImpl(field); &#125; else if (type == Byte.TYPE) &#123; return new UnsafeStaticByteFieldAccessorImpl(field); &#125; else if (type == Short.TYPE) &#123; return new UnsafeStaticShortFieldAccessorImpl(field); &#125; else if (type == Character.TYPE) &#123; return new UnsafeStaticCharacterFieldAccessorImpl(field); &#125; else if (type == Integer.TYPE) &#123; return new UnsafeStaticIntegerFieldAccessorImpl(field); &#125; else if (type == Long.TYPE) &#123; return new UnsafeStaticLongFieldAccessorImpl(field); &#125; else if (type == Float.TYPE) &#123; return new UnsafeStaticFloatFieldAccessorImpl(field); &#125; else if (type == Double.TYPE) &#123; return new UnsafeStaticDoubleFieldAccessorImpl(field); &#125; else &#123; return new UnsafeStaticObjectFieldAccessorImpl(field); &#125; &#125; else &#123; if (type == Boolean.TYPE) &#123; return new UnsafeQualifiedStaticBooleanFieldAccessorImpl(field, isReadOnly); &#125; else if (type == Byte.TYPE) &#123; return new UnsafeQualifiedStaticByteFieldAccessorImpl(field, isReadOnly); &#125; else if (type == Short.TYPE) &#123; return new UnsafeQualifiedStaticShortFieldAccessorImpl(field, isReadOnly); &#125; else if (type == Character.TYPE) &#123; return new UnsafeQualifiedStaticCharacterFieldAccessorImpl(field, isReadOnly); &#125; else if (type == Integer.TYPE) &#123; return new UnsafeQualifiedStaticIntegerFieldAccessorImpl(field, isReadOnly); &#125; else if (type == Long.TYPE) &#123; return new UnsafeQualifiedStaticLongFieldAccessorImpl(field, isReadOnly); &#125; else if (type == Float.TYPE) &#123; return new UnsafeQualifiedStaticFloatFieldAccessorImpl(field, isReadOnly); &#125; else if (type == Double.TYPE) &#123; return new UnsafeQualifiedStaticDoubleFieldAccessorImpl(field, isReadOnly); &#125; else &#123; return new UnsafeQualifiedStaticObjectFieldAccessorImpl(field, isReadOnly); &#125; &#125; &#125; else &#123; if (!isQualified) &#123; if (type == Boolean.TYPE) &#123; return new UnsafeBooleanFieldAccessorImpl(field); &#125; else if (type == Byte.TYPE) &#123; return new UnsafeByteFieldAccessorImpl(field); &#125; else if (type == Short.TYPE) &#123; return new UnsafeShortFieldAccessorImpl(field); &#125; else if (type == Character.TYPE) &#123; return new UnsafeCharacterFieldAccessorImpl(field); &#125; else if (type == Integer.TYPE) &#123; return new UnsafeIntegerFieldAccessorImpl(field); &#125; else if (type == Long.TYPE) &#123; return new UnsafeLongFieldAccessorImpl(field); &#125; else if (type == Float.TYPE) &#123; return new UnsafeFloatFieldAccessorImpl(field); &#125; else if (type == Double.TYPE) &#123; return new UnsafeDoubleFieldAccessorImpl(field); &#125; else &#123; return new UnsafeObjectFieldAccessorImpl(field); &#125; &#125; else &#123; if (type == Boolean.TYPE) &#123; return new UnsafeQualifiedBooleanFieldAccessorImpl(field, isReadOnly); &#125; else if (type == Byte.TYPE) &#123; return new UnsafeQualifiedByteFieldAccessorImpl(field, isReadOnly); &#125; else if (type == Short.TYPE) &#123; return new UnsafeQualifiedShortFieldAccessorImpl(field, isReadOnly); &#125; else if (type == Character.TYPE) &#123; return new UnsafeQualifiedCharacterFieldAccessorImpl(field, isReadOnly); &#125; else if (type == Integer.TYPE) &#123; return new UnsafeQualifiedIntegerFieldAccessorImpl(field, isReadOnly); &#125; else if (type == Long.TYPE) &#123; return new UnsafeQualifiedLongFieldAccessorImpl(field, isReadOnly); &#125; else if (type == Float.TYPE) &#123; return new UnsafeQualifiedFloatFieldAccessorImpl(field, isReadOnly); &#125; else if (type == Double.TYPE) &#123; return new UnsafeQualifiedDoubleFieldAccessorImpl(field, isReadOnly); &#125; else &#123; return new UnsafeQualifiedObjectFieldAccessorImpl(field, isReadOnly); &#125; &#125; &#125; &#125;&#125; è¿™é‡Œæ³¨æ„ä¸€ä¸‹å±æ€§ä¿®é¥°ç¬¦çš„åˆ¤æ–­ï¼š isStaticï¼šé™æ€å±æ€§ï¼Œä¹Ÿå°±æ˜¯staticå…³é”®å­—ä¿®é¥°çš„å±æ€§ã€‚ isFinalï¼šfinalå…³é”®å­—ä¿®é¥°çš„å±æ€§ã€‚ isVolatileï¼švalatileå…³é”®å­—ä¿®é¥°çš„å±æ€§ã€‚ isQualifiedï¼švalatileå…³é”®å­—æˆ–è€…finalå…³é”®å­—ä¿®é¥°çš„å±æ€§ã€‚ isReadOnlyï¼šæ˜¯å¦åªè¯»å±æ€§ï¼Œfinalå…³é”®å­—ä¿®é¥°çš„å±æ€§æˆ–è€…staticå…³é”®å­—ä¿®é¥°å¹¶ä¸”ä¸èƒ½è¦†ç›–(override = false)çš„å±æ€§ã€‚ é€šè¿‡ä¸Šé¢ä¿®é¥°ç¬¦åšåˆ¤æ–­ï¼Œå¾—åˆ°æœ€ç»ˆçš„FieldAccessorå®ç°ã€‚è¿™é‡ŒæŒ‘ä¸€ä¸ªä¾‹å­è¿›è¡Œåˆ†æï¼Œä¾‹å¦‚ä¸€ä¸ªæ™®é€šéé™æ€æ²¡æœ‰volatileå’Œfinalå…³é”®å­—ä¿®é¥°å±æ€§æœ€ç»ˆå°±ä¼šå¾—åˆ°UnsafeObjectFieldAccessorImplçš„å®ä¾‹ï¼š 12345678910111213141516171819202122232425262728293031323334class UnsafeObjectFieldAccessorImpl extends UnsafeFieldAccessorImpl &#123; UnsafeObjectFieldAccessorImpl(Field field) &#123; super(field); &#125; public Object get(Object obj) throws IllegalArgumentException &#123; ensureObj(obj); return unsafe.getObject(obj, fieldOffset); &#125; public void set(Object obj, Object value) throws IllegalArgumentException, IllegalAccessException&#123; ensureObj(obj); if (isFinal) &#123; throwFinalFieldIllegalAccessException(value); &#125; if (value != null) &#123; if (!field.getType().isAssignableFrom(value.getClass())) &#123; throwSetIllegalArgumentException(value); &#125; &#125; unsafe.putObject(obj, fieldOffset, value); &#125; public boolean getBoolean(Object obj) throws IllegalArgumentException &#123; throw newGetBooleanIllegalArgumentException(); &#125; public byte getByte(Object obj) throws IllegalArgumentException &#123; throw newGetByteIllegalArgumentException(); &#125; // çœç•¥å…¶ä»–ç›´æ¥æŠ›å‡ºå¼‚å¸¸çš„æ–¹æ³• &#125; å¯è§UnsafeObjectFieldAccessorImplä¸­é™¤äº†get(Object obj)å’Œset(Object obj, Object value)æ–¹æ³•ï¼Œå…¶ä»–æ–¹æ³•éƒ½æ˜¯ç›´æ¥æŠ›å‡ºIllegalArgumentExceptionã€‚è€Œget(Object obj)å’Œset(Object obj, Object value)åº•å±‚åˆ†åˆ«ä¾èµ–äºjdk.internal.misc.Unsafeçš„putObject(obj, fieldOffset, value)å’ŒgetObject(obj, fieldOffset)æ–¹æ³•ã€‚è€Œå±æ€§çš„å†…å­˜åç§»åœ°å€æ˜¯åœ¨UnsafeObjectFieldAccessorImplçš„çˆ¶ç±»UnsafeFieldAccessorImplçš„æ„é€ å‡½æ•°ä¸­è®¡ç®—å‡ºæ¥çš„ï¼š 1234567891011121314151617abstract class UnsafeFieldAccessorImpl extends FieldAccessorImpl &#123; static final Unsafe unsafe = Unsafe.getUnsafe(); protected final Field field; protected final long fieldOffset; protected final boolean isFinal; UnsafeFieldAccessorImpl(Field field) &#123; this.field = field; if (Modifier.isStatic(field.getModifiers())) fieldOffset = unsafe.staticFieldOffset(field); else fieldOffset = unsafe.objectFieldOffset(field); isFinal = Modifier.isFinal(field.getModifiers()); &#125; // çœç•¥å…¶ä»–æ–¹æ³• &#125; è¿™é‡Œå¯ä»¥åšä¸ªå°ç»“ï¼Œå±æ€§åå°„æ“ä½œFieldçš„setXXå’ŒgetXXæ–¹æ³•æœ€ç»ˆå§”æ‰˜åˆ°jdk.internal.misc.Unsafeçš„putXXå’ŒgetXXæ–¹æ³•ï¼Œè€Œå±æ€§çš„å†…å­˜åç§»åœ°å€æ˜¯é€šè¿‡jdk.internal.misc.Unsafeçš„staticFieldBase()ã€staticFieldOffsetå’ŒobjectFieldOffsetå‡ ä¸ªæ–¹æ³•è®¡ç®—çš„ã€‚ å¤„ç†æ„é€ å™¨è°ƒç”¨çš„åº•å±‚å®ç° Constructor#newInstance()æ–¹æ³•è°ƒç”¨ä¾èµ–åˆ°ConstructorAccessorï¼š 123456789101112131415161718192021222324252627 public T newInstance(Object ... initargs) throws InstantiationException, IllegalAccessException, IllegalArgumentException, InvocationTargetException &#123; if (!override) &#123; Class&lt;?&gt; caller = Reflection.getCallerClass(); checkAccess(caller, clazz, clazz, modifiers); &#125; if ((clazz.getModifiers() &amp; Modifier.ENUM) != 0) throw new IllegalArgumentException(\"Cannot reflectively create enum objects\"); ConstructorAccessor ca = constructorAccessor; // read volatile if (ca == null) &#123; ca = acquireConstructorAccessor(); &#125; @SuppressWarnings(\"unchecked\") T inst = (T) ca.newInstance(initargs); return inst; &#125;// ConstructorAccessoræ¥å£public interface ConstructorAccessor &#123; /** Matches specification in &#123;@link java.lang.reflect.Constructor&#125; */ public Object newInstance(Object[] args) throws InstantiationException, IllegalArgumentException, InvocationTargetException;&#125; è€Œè·å–ConstructorAccessorå®ä¾‹ä¹Ÿæ˜¯é€šè¿‡åå°„å·¥å‚ç±»ReflectionFactoryï¼Œå…·ä½“æ˜¯ReflectionFactory#newConstructorAccessorï¼š 12345678910111213141516171819202122232425262728293031323334353637383940public ConstructorAccessor newConstructorAccessor(Constructor&lt;?&gt; c) &#123; checkInitted(); Class&lt;?&gt; declaringClass = c.getDeclaringClass(); // æŠ½è±¡æ–¹æ³•ä¼šè¿›å…¥æ­¤ifåˆ†æ”¯ if (Modifier.isAbstract(declaringClass.getModifiers())) &#123; return new InstantiationExceptionConstructorAccessorImpl(null); &#125; // å®¿ä¸»ç±»ç›´æ¥æ˜¯Classç±»å‹ï¼Œåˆ™æ— æ³•å®ä¾‹åŒ– if (declaringClass == Class.class) &#123; return new InstantiationExceptionConstructorAccessorImpl (\"Can not instantiate java.lang.Class\"); &#125; // use the root Constructor that will not cache caller class Constructor&lt;?&gt; root = langReflectAccess.getRoot(c); if (root != null) &#123; c = root; &#125; // å½“å‰å£°æ˜æ„é€ çš„å®¿ä¸»ç±»æ˜¯ConstructorAccessorImplçš„å­ç±» if (Reflection.isSubclassOf(declaringClass, ConstructorAccessorImpl.class)) &#123; return new BootstrapConstructorAccessorImpl(c); &#125; // if (noInflation &amp;&amp; !ReflectUtil.isVMAnonymousClass(c.getDeclaringClass())) &#123; return new MethodAccessorGenerator(). generateConstructor(c.getDeclaringClass(), c.getParameterTypes(), c.getExceptionTypes(), c.getModifiers()); &#125; else &#123; NativeConstructorAccessorImpl acc = new NativeConstructorAccessorImpl(c); DelegatingConstructorAccessorImpl res = new DelegatingConstructorAccessorImpl(acc); acc.setParent(res); return res; &#125;&#125; å¯è§æœ€ç»ˆå¾—åˆ°çš„ConstructorAccessorå®ä¾‹ä¸ºDelegatingConstructorAccessorImplï¼Œè€ŒDelegatingConstructorAccessorImplåªæ˜¯ä¸€ä¸ªå§”æ‰˜å®ç°ï¼Œåº•å±‚æ˜¯è°ƒç”¨NativeConstructorAccessorImplï¼š 12345678910111213141516171819202122232425262728293031323334353637383940class NativeConstructorAccessorImpl extends ConstructorAccessorImpl &#123; private final Constructor&lt;?&gt; c; private DelegatingConstructorAccessorImpl parent; private int numInvocations; NativeConstructorAccessorImpl(Constructor&lt;?&gt; c) &#123; this.c = c; &#125; public Object newInstance(Object[] args) throws InstantiationException, IllegalArgumentException, InvocationTargetException &#123; // We can't inflate a constructor belonging to a vm-anonymous class // because that kind of class can't be referred to by name, hence can't // be found from the generated bytecode. if (++numInvocations &gt; ReflectionFactory.inflationThreshold() &amp;&amp; !ReflectUtil.isVMAnonymousClass(c.getDeclaringClass())) &#123; ConstructorAccessorImpl acc = (ConstructorAccessorImpl) new MethodAccessorGenerator(). generateConstructor(c.getDeclaringClass(), c.getParameterTypes(), c.getExceptionTypes(), c.getModifiers()); parent.setDelegate(acc); &#125; return newInstance0(c, args); &#125; void setParent(DelegatingConstructorAccessorImpl parent) &#123; this.parent = parent; &#125; // è¿™ä¸ªå°±æ˜¯æœ€ç»ˆæ„é€ å®ä¾‹åŒ–å¯¹è±¡çš„nativeæ–¹æ³• private static native Object newInstance0(Constructor&lt;?&gt; c, Object[] args) throws InstantiationException, IllegalArgumentException, InvocationTargetException;&#125; NativeConstructorAccessorImpl#newInstance0()å°±æ˜¯æœ€ç»ˆæ„é€ å®ä¾‹åŒ–å¯¹è±¡çš„Nativeæ–¹æ³•ã€‚å½“ç„¶æœ‰ä¾‹å¤–çš„æƒ…å†µï¼Œä¾‹å¦‚éæ­£å¸¸è°ƒç”¨ä¸‹ï¼Œå¦‚æœæ„é€ å™¨çš„å®¿ä¸»ç±»æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œé‚£ä¹ˆæœ€ç»ˆä¼šè¿”å›ä¸€ä¸ªInstantiationExceptionConstructorAccessorImplå®ä¾‹ï¼Œé‡Œé¢ç›´æ¥æŠ›å‡ºInstantiationExceptionå¼‚å¸¸ã€‚ å¤„ç†æ–¹æ³•è°ƒç”¨çš„åº•å±‚å®ç° Method#invoke()è°ƒç”¨ä¾èµ–äºMethodAccessorï¼š 12345678910111213141516171819202122// MethodAccessoræ¥å£public interface MethodAccessor &#123; /** Matches specification in &#123;@link java.lang.reflect.Method&#125; */ public Object invoke(Object obj, Object[] args) throws IllegalArgumentException, InvocationTargetException;&#125; public Object invoke(Object obj, Object... args) throws IllegalAccessException, IllegalArgumentException, InvocationTargetException&#123; if (!override) &#123; Class&lt;?&gt; caller = Reflection.getCallerClass(); checkAccess(caller, clazz, Modifier.isStatic(modifiers) ? null : obj.getClass(), modifiers); &#125; MethodAccessor ma = methodAccessor; // read volatile if (ma == null) &#123; ma = acquireMethodAccessor(); &#125; return ma.invoke(obj, args); &#125; è·å–MethodAccessorå®ä¾‹çš„é€»è¾‘å’Œå‰ä¸¤èŠ‚ç±»ä¼¼ï¼Œæ˜¯é€šè¿‡ReflectionFactory#newMethodAccessor()ï¼š 123456789101112131415161718192021222324252627282930313233public MethodAccessor newMethodAccessor(Method method) &#123; checkInitted(); if (Reflection.isCallerSensitive(method)) &#123; Method altMethod = findMethodForReflection(method); if (altMethod != null) &#123; method = altMethod; &#125; &#125; // use the root Method that will not cache caller class Method root = langReflectAccess.getRoot(method); if (root != null) &#123; method = root; &#125; if (noInflation &amp;&amp; !ReflectUtil.isVMAnonymousClass(method.getDeclaringClass())) &#123; return new MethodAccessorGenerator(). generateMethod(method.getDeclaringClass(), method.getName(), method.getParameterTypes(), method.getReturnType(), method.getExceptionTypes(), method.getModifiers()); &#125; else &#123; NativeMethodAccessorImpl acc = new NativeMethodAccessorImpl(method); DelegatingMethodAccessorImpl res = new DelegatingMethodAccessorImpl(acc); acc.setParent(res); return res; &#125;&#125; æœ€ç»ˆä¼šå§”æ‰˜åˆ°NativeMethodAccessorImpl#invoke(Object obj, Object[] args)ï¼š 12345678910111213141516171819202122232425262728293031323334353637class NativeMethodAccessorImpl extends MethodAccessorImpl &#123; private final Method method; private DelegatingMethodAccessorImpl parent; private int numInvocations; NativeMethodAccessorImpl(Method method) &#123; this.method = method; &#125; public Object invoke(Object obj, Object[] args) throws IllegalArgumentException, InvocationTargetException &#123; // We can't inflate methods belonging to vm-anonymous classes because // that kind of class can't be referred to by name, hence can't be // found from the generated bytecode. if (++numInvocations &gt; ReflectionFactory.inflationThreshold() &amp;&amp; !ReflectUtil.isVMAnonymousClass(method.getDeclaringClass())) &#123; MethodAccessorImpl acc = (MethodAccessorImpl) new MethodAccessorGenerator(). generateMethod(method.getDeclaringClass(), method.getName(), method.getParameterTypes(), method.getReturnType(), method.getExceptionTypes(), method.getModifiers()); parent.setDelegate(acc); &#125; return invoke0(method, obj, args); &#125; void setParent(DelegatingMethodAccessorImpl parent) &#123; this.parent = parent; &#125; private static native Object invoke0(Method m, Object obj, Object[] args);&#125; è€ŒNativeMethodAccessorImpl#invoke0()å°±æ˜¯æ–¹æ³•è°ƒç”¨çš„æœ€ç»ˆè°ƒç”¨çš„Nativeæ–¹æ³•ã€‚ å°ç»“ å­¦ä¹ çŸ¥è¯†è¿‡ç¨‹æ€»æ˜¯é˜¶æ¢¯å¼ä¸Šå‡çš„ï¼ŒJDKä¸­çš„ç±»åº“è®¾è®¡ä¹Ÿç±»ä¼¼è¿™æ ·ï¼Œå¦‚æœæå‰ç†Ÿæ‚‰Unsafeç±»çš„ç›¸å…³æ–¹æ³•ï¼Œå…¶å®åå°„è°ƒç”¨çš„åº•å±‚å®ç°ä¹Ÿèƒ½å¤Ÿç›¸å¯¹è½»æ˜“åœ°ç†è§£ã€‚å±æ€§ã€æ„é€ å’Œæ–¹æ³•åå°„è°ƒç”¨åº•å±‚çš„å®ç°(åªè€ƒè™‘æ­£å¸¸è°ƒç”¨çš„æƒ…å†µä¸‹)å¦‚ä¸‹ï¼š å¯¹äºå±æ€§(Field)ï¼šField#setXX()å’ŒField#getXX()åˆ†åˆ«å¯¹åº”Unsafeçš„putXX()å’ŒgetXX()æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯è¯´å®Œå…¨ä¾èµ–Unsafeä¸­çš„Nativeæ–¹æ³•ã€‚ å¯¹äºæ„é€ (Constructor)ï¼šConstructor#newInstance()åº•å±‚è°ƒç”¨NativeConstructorAccessorImpl#newInstance0()ã€‚ å¯¹äºæ–¹æ³•(Method)ï¼šMethod#invoke()åº•å±‚è°ƒç”¨NativeMethodAccessorImpl#invoke0() (æœ¬æ–‡å®Œ e-a-20181216 c-1-d)","categories":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/categories/Java/"},{"name":"Reflection","slug":"Java/Reflection","permalink":"http://throwable.club/blog/categories/Java/Reflection/"}],"tags":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/tags/Java/"},{"name":"Reflection","slug":"Reflection","permalink":"http://throwable.club/blog/tags/Reflection/"}]},{"title":"æ·±å…¥åˆ†æJavaåå°„(å…­)-åå°„è°ƒç”¨å¼‚å¸¸å¤„ç†","slug":"java-reflection-handle-exception","date":"2018-12-15T15:07:23.000Z","updated":"2019-01-07T16:04:20.014Z","comments":true,"path":"2018/12/15/java-reflection-handle-exception/","link":"","permalink":"http://throwable.club/2018/12/15/java-reflection-handle-exception/","excerpt":"","text":"æ·±å…¥åˆ†æJavaåå°„(å…­)-åå°„è°ƒç”¨å¼‚å¸¸å¤„ç† å‰æ Javaåå°„çš„APIåœ¨JavaSE1.7çš„æ—¶å€™å·²ç»åŸºæœ¬å®Œå–„ï¼Œä½†æ˜¯æœ¬æ–‡ç¼–å†™çš„æ—¶å€™ä½¿ç”¨çš„æ˜¯Oracle JDK11ï¼Œå› ä¸ºJDK11å¯¹äºsunåŒ…ä¸‹çš„æºç ä¹Ÿä¸Šä¼ äº†ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡IDEæŸ¥çœ‹å¯¹åº”çš„æºç å’Œè¿›è¡ŒDebugã€‚ æœ¬æ–‡ä¸»è¦ä»‹ç»ä¸€ä¸ªä½¿ç”¨åå°„ä¸€å®šä¼šé‡åˆ°çš„é—®é¢˜-åå°„è°ƒç”¨å¼‚å¸¸å¤„ç†ã€‚ åå°„è°ƒç”¨å¼‚å¸¸å¤„ç† åå°„è°ƒç”¨å‡ºç°å¼‚å¸¸çš„æ–¹æ³•ä¸»è¦è€ƒè™‘ä¸‹é¢çš„æƒ…å†µï¼š å±æ€§æ“ä½œï¼šjava.lang.reflect.Field#set(Object obj, Object value)å’Œjava.lang.reflect.Field#get(Object obj)ã€‚ æ„é€ å™¨è°ƒç”¨ï¼šjava.lang.reflect.Constructor#newInstance(Object ... initargs)ã€‚ æ–¹æ³•è°ƒç”¨ï¼šjava.lang.reflect.Method#invoke(Object obj, Object... args)ã€‚ å¤„ç†å±æ€§æ“ä½œå¼‚å¸¸ å…ˆçœ‹è®¾ç½®å±æ€§çš„æ–¹æ³•ï¼š 1public void set(Object obj, Object value) throws IllegalArgumentException, IllegalAccessException å®é™…ä¸Šï¼Œé€šè¿‡æ–¹æ³•æ³¨é‡Šå¯ä»¥å¾—çŸ¥ä¼šæŠ›å‡ºå››ç§å¼‚å¸¸ï¼š IllegalAccessExceptionï¼šéæ³•è®¿é—®å¼‚å¸¸ï¼Œæ³¨æ„å®ƒæ˜¯æ£€æŸ¥(checked)å¼‚å¸¸ï¼Œä¹Ÿå°±æ˜¯éœ€è¦æ˜¾ç¤ºæ•è·ï¼Œæ­¤å¼‚å¸¸ä¼šåœ¨ä¿®é¥°ç¬¦ç¦ç”¨è®¿é—®çš„æ—¶å€™æŠ›å‡ºï¼Œå¯ä»¥é€šè¿‡setAccessible(true)æŠ‘åˆ¶ä¿®é¥°ç¬¦æ£€æŸ¥æ¥é¿å…æŠ›å‡ºæ­¤å¼‚å¸¸ã€‚ IllegalArgumentExceptionï¼šéæ³•å‚æ•°å¼‚å¸¸ï¼Œå®ƒæ˜¯è¿è¡Œæ—¶å¼‚å¸¸ï¼Œå½“å…¥å‚å®ä¾‹objä¸æ˜¯å½“å‰Fieldæ‰€åœ¨ç±»(åŒ…æ‹¬çˆ¶ç±»ã€å­ç±»å’Œæ¥å£)çš„æ—¶å€™ä¼šæŠ›å‡ºæ­¤å¼‚å¸¸ã€‚ NullPointerExceptionï¼šç©ºæŒ‡é’ˆå¼‚å¸¸ï¼Œå½“å…¥å‚å®ä¾‹objä¸ºnullçš„æ—¶å€™ä¼šæŠ›å‡ºæ­¤å¼‚å¸¸ã€‚ ExceptionInInitializerErrorï¼šåˆå§‹åŒ–å™¨è°ƒç”¨å¼‚å¸¸å¯¼è‡´çš„é”™è¯¯ï¼Œå¦‚æœç”±äºset(Object obj, Object value)æ–¹æ³•å¼•å‘çš„åˆå§‹åŒ–å¤±è´¥ä¼šåŒ…è£…æˆExceptionInInitializerErrorï¼Œæ­¤å¼‚å¸¸çš„çˆ¶ç±»ä¸ºErrorï¼Œå¸¸è§çš„å‘ç”Ÿæƒ…å†µå°±æ˜¯é™æ€æˆå‘˜æˆ–è€…é™æ€ä»£ç å—ä¾èµ–åˆ°åå°„å±æ€§è®¾ç½®ã€‚ å‰é¢ä¸‰ç§å¼‚å¸¸éƒ½å¾ˆå¥½ç†è§£ï¼Œæœ€åä¸€ä¸ªExceptionInInitializerErrorå¯èƒ½æœ‰ç‚¹é™Œç”Ÿï¼Œå®ƒçš„æŠ›å‡ºæ¡ä»¶æ˜¯ï¼šåœ¨é™æ€ä»£ç å—åˆå§‹åŒ–è§£æè¿‡ç¨‹æ€»æŠ›å‡ºå¼‚å¸¸æˆ–è€…é™æ€å˜é‡åˆå§‹åŒ–çš„æ—¶å€™æŠ›å‡ºå¼‚å¸¸ã€‚ç¬”è€…å°è¯•äº†å¾ˆå¤šä¾‹å­éƒ½æ²¡åŠæ³•é€ å‡ºæ¡ˆä¾‹ï¼Œä»Stackoverflowæ‰¾åˆ°ä¸€ä¸ªä¾‹å­ï¼š 123456789101112131415public class Example &#123; public static void main(String[] args) throws Exception &#123; Field field = Fail.class.getDeclaredField(\"number\"); field.set(null, 42); // Fail class isn't initialized at this point &#125;&#125;class Fail &#123; static int number; static &#123; boolean val = true; if (val) throw new RuntimeException(); // causes initialization to end with an exception &#125;&#125; ç®€å•æ¥è¯´å°±æ˜¯ï¼šé™æ€ä»£ç å—å’Œé™æ€å˜é‡çš„åˆå§‹åŒ–é¡ºåºå’Œå®ƒä»¬åœ¨ç±»æ–‡ä»¶ç¼–å†™çš„é¡ºåºæ˜¯ä¸€è‡´çš„ï¼Œå¦‚æœä¸€ä¸ªç±»æœªåˆå§‹åŒ–ç›´æ¥ä½¿ç”¨å®ƒçš„é™æ€ä»£ç å—å’Œé™æ€å˜é‡é€šè¿‡Field#set(Object obj, Object value)è°ƒç”¨å°±ä¼šå‡ºç°ExceptionInInitializerErrorå¼‚å¸¸ã€‚ å±æ€§çš„è·å–æ–¹æ³•æŠ›å‡ºçš„å¼‚å¸¸å’Œè®¾ç½®å€¼æ–¹æ³•æ˜¯ä¸€è‡´çš„ï¼Œè¿™é‡Œä¸åšè¯¦ç»†å±•å¼€ï¼š 1public Object get(Object obj) throws IllegalArgumentException, IllegalAccessException å¤„ç†æ„é€ å™¨è°ƒç”¨å¼‚å¸¸ æ„é€ å™¨è°ƒç”¨ä¸»è¦æ˜¯ç”¨äºå¯¹è±¡çš„å®ä¾‹åŒ–ï¼Œå…ˆçœ‹newInstanceæ–¹æ³•çš„ç­¾åï¼š 1public T newInstance(Object ... initargs) throws InstantiationException, IllegalAccessException, IllegalArgumentException, InvocationTargetException InstantiationExceptionï¼šå®ä¾‹åŒ–å¼‚å¸¸ï¼ŒæŠ›å‡ºæ­¤å¼‚å¸¸çš„ä¸€èˆ¬æƒ…å†µæ˜¯ï¼šå½“å‰æ„é€ æ‰€åœ¨ç±»å‹ä¸ºä¸€ä¸ªæŠ½è±¡ç±»å‹ã€‚ IllegalAccessExceptionï¼šéæ³•è®¿é—®å¼‚å¸¸ã€‚ IllegalArgumentExceptionï¼šéæ³•å‚æ•°å¼‚å¸¸ï¼Œä¸‹é¢çš„æƒ…å†µä¼šæŠ›å‡ºæ­¤å¼‚å¸¸ï¼šå‚æ•°æ•°é‡æˆ–è€…ç±»å‹ä¸åŒ¹é…ï¼Œå‚æ•°åˆ—è¡¨ä¸ºåŸå§‹ç±»å‹ä½†æ˜¯å®é™…ä½¿ç”¨äº†åŒ…è£…ç±»å‹ã€å‚æ•°åˆ—è¡¨ä¸ºåŸå§‹ç±»å‹ä½†æ˜¯å®é™…ä½¿ç”¨äº†åŒ…è£…ç±»å‹ã€æ„é€ æ‰€åœ¨çš„ç±»æ˜¯æšä¸¾ç±»å‹ç­‰ã€‚ InvocationTargetExceptionï¼šç›®æ ‡è°ƒç”¨å¼‚å¸¸ï¼Œè¿™ä¸ªæ˜¯éœ€è¦å¤„ç†çš„é‡ç‚¹å¼‚å¸¸ï¼Œåœ¨ä¸‹ä¸€èŠ‚&quot;å¤„ç†æ–¹æ³•è°ƒç”¨å¼‚å¸¸&quot;è¯¦ç»†æ¢è®¨ã€‚ è¿™é‡Œåªä¸¾ä¸ªä¾‹å­è¯´æ˜ä¸€ä¸‹InstantiationExceptionå‡ºç°çš„åœºæ™¯ï¼š 12345678910public abstract class AbstractSample &#123; public AbstractSample() &#123; &#125; public static void main(String[] args) throws Exception&#123; Constructor&lt;AbstractSample&gt; declaredConstructor = AbstractSample.class.getDeclaredConstructor(); declaredConstructor.newInstance(); &#125;&#125; åƒä¸Šé¢çš„æŠ½è±¡ç±»AbstractSampleåŒ…å«ä¸€ä¸ªé»˜è®¤çš„å…¬æœ‰æ„é€ ï¼Œä½¿ç”¨Constructor#newInstance()ä¼šæŠ›å‡ºInstantiationExceptionå¼‚å¸¸ï¼š 1234Exception in thread \"main\" java.lang.InstantiationException at java.base/jdk.internal.reflect.InstantiationExceptionConstructorAccessorImpl.newInstance(InstantiationExceptionConstructorAccessorImpl.java:48) at java.base/java.lang.reflect.Constructor.newInstance(Constructor.java:490) at club.throwable.jdk.sample.reflection.reflect.AbstractSample.main(AbstractSample.java:18) å¤„ç†æ–¹æ³•è°ƒç”¨å¼‚å¸¸ æ–¹æ³•è°ƒç”¨æ˜¯åå°„ä¸­ä½¿ç”¨é¢‘ç‡æœ€é«˜çš„åå°„æ“ä½œï¼Œä¸»è¦æ˜¯Method#invoke(Object obj, Object... args)æ–¹æ³•ï¼š 1public Object invoke(Object obj, Object... args) throws IllegalAccessException, IllegalArgumentException, InvocationTargetException ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹å‡ ç§å¼‚å¸¸ï¼š IllegalAccessExceptionï¼šéæ³•è®¿é—®å¼‚å¸¸ã€‚ IllegalArgumentExceptionï¼šéæ³•å‚æ•°å¼‚å¸¸ï¼Œä¸‹é¢çš„æƒ…å†µä¼šæŠ›å‡ºæ­¤å¼‚å¸¸ï¼šå…¥å‚objå¹¶ä¸æ˜¯å½“å‰å®ä¾‹æ–¹æ³•å¯¹åº”çš„å®ä¾‹å¯¹è±¡ã€å‚æ•°æ•°é‡æˆ–è€…ç±»å‹ä¸åŒ¹é…ï¼Œå‚æ•°åˆ—è¡¨ä¸ºåŸå§‹ç±»å‹ä½†æ˜¯å®é™…ä½¿ç”¨äº†åŒ…è£…ç±»å‹ã€å‚æ•°åˆ—è¡¨ä¸ºåŸå§‹ç±»å‹ä½†æ˜¯å®é™…ä½¿ç”¨äº†åŒ…è£…ç±»å‹ç­‰ç­‰ã€‚ NullPointerExceptionï¼šç©ºæŒ‡é’ˆå¼‚å¸¸ï¼Œå…¥å‚objä¸ºnullæ—¶å€™ä¼šæŠ›å‡ºæ­¤å¼‚å¸¸ã€‚ ExceptionInInitializerErrorï¼šåˆå§‹åŒ–å™¨è°ƒç”¨å¼‚å¸¸å¯¼è‡´çš„é”™è¯¯ã€‚ InvocationTargetExceptionï¼šç›®æ ‡è°ƒç”¨å¼‚å¸¸ã€‚ é‡ç‚¹çœ‹InvocationTargetException(ç»§æ‰¿è‡ªReflectiveOperationExceptionï¼Œè€ŒReflectiveOperationExceptionç»§æ‰¿è‡ªExceptionï¼Œä¹Ÿå°±æ˜¯å®ƒæ˜¯checkedå¼‚å¸¸ï¼Œå¿…é¡»æ˜¾å¼æ•è·)ï¼š 12345678910111213141516171819202122232425public class InvocationTargetException extends ReflectiveOperationException &#123; private static final long serialVersionUID = 4085088731926701167L; // æŒæœ‰çš„ç›®æ ‡å¼‚å¸¸å®ä¾‹ private Throwable target; public InvocationTargetException(Throwable target) &#123; super((Throwable)null); // Disallow initCause this.target = target; &#125; public InvocationTargetException(Throwable target) &#123; super((Throwable)null); // Disallow initCause this.target = target; &#125; public Throwable getTargetException() &#123; return target; &#125; public Throwable getCause() &#123; return target; &#125; &#125; ä»æ³¨é‡Šä¸­å¾—çŸ¥ï¼šæ–¹æ³•(Method)æˆ–è€…æ„é€ (Constructor)è°ƒç”¨å¼‚å¸¸ä¼šæŠ›å‡ºæ­¤InvocationTargetExceptionå¼‚å¸¸ï¼Œç”¨äºåŒ…è£…æºå¼‚å¸¸ï¼Œæºå¼‚å¸¸å®ä¾‹ä½œä¸ºç›®æ ‡è¢«InvocationTargetExceptioné€šè¿‡æˆå‘˜targetæŒæœ‰ï¼Œå¯ä»¥é€šè¿‡InvocationTargetException#getTargetException()æˆ–è€…InvocationTargetException#getCause()è·å–åŸå§‹çš„ç›®æ ‡å¼‚å¸¸ã€‚è¿™é‡Œæ³¨æ„åˆ°ï¼ŒInvocationTargetExceptionåœ¨è¦†ç›–çˆ¶ç±»æ„é€ çš„æ—¶å€™ä½¿ç”¨äº†nullï¼Œæ‰€ä»¥è°ƒç”¨å…¶getMessage()æ–¹æ³•ä¼šå¾—åˆ°nullã€‚ ä¸¾ä¸ªä¾‹å­ï¼š 12345678910111213141516171819202122public class InvocationTargetExceptionMain &#123; public void method() &#123; throw new NullPointerException(\"Null\"); &#125; public static void main(String[] args) throws NoSuchMethodException, SecurityException &#123; InvocationTargetExceptionMain main = new InvocationTargetExceptionMain(); Method method = InvocationTargetExceptionMain.class.getDeclaredMethod(\"method\"); try &#123; method.invoke(main); &#125; catch (IllegalAccessException e) &#123; //no-op &#125; catch (InvocationTargetException e) &#123; System.out.println(\"InvocationTargetException#message:\" + e.getMessage()); if (e.getTargetException() instanceof NullPointerException) &#123; NullPointerException nullPointerException = (NullPointerException) e.getTargetException(); System.out.println(\"NullPointerException#message:\" + nullPointerException.getMessage()); &#125; &#125; &#125;&#125; è¿è¡Œåè¾“å‡ºï¼š 12InvocationTargetException#message:nullNullPointerException#message:Null æ„é€ å™¨Constructor#newInstance()ä¸­æŠ›å‡ºInvocationTargetExceptionçš„åœºæ™¯æ˜¯ç±»ä¼¼çš„ã€‚ å°ç»“ åœ¨åå°„æ“ä½œä¸­ï¼Œæ–¹æ³•è°ƒç”¨çš„é¢‘æ¬¡æ˜¯æœ€é«˜çš„ï¼Œå…¶æ¬¡æ˜¯é€šè¿‡æ„é€ å™¨å®ä¾‹åŒ–å¯¹è±¡ã€‚éœ€è¦é‡ç‚¹å…³æ³¨è¿™ä¸¤ä¸ªåœ°æ–¹çš„å¼‚å¸¸å¤„ç†ï¼Œç‰¹åˆ«æ˜¯å¼‚å¸¸ç±»å‹InvocationTargetExceptionï¼Œç´§è®°éœ€è¦è·å–åŸå§‹ç›®æ ‡å¼‚å¸¸ç±»å‹å†è¿›è¡Œåˆ¤æ–­ï¼Œå¦åˆ™å¾ˆå®¹æ˜“å¯¼è‡´é€»è¾‘é”™è¯¯(æœ€è¿‘ç¬”è€…åœ¨åšä¸€ä¸ªåŠŸèƒ½çš„æ—¶å€™åˆšå¥½è¸©äº†è¿™ä¸ªå‘)ã€‚ (æœ¬æ–‡å®Œ e-a-20181215 c-2-d)","categories":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/categories/Java/"},{"name":"Reflection","slug":"Java/Reflection","permalink":"http://throwable.club/blog/categories/Java/Reflection/"}],"tags":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/tags/Java/"},{"name":"Reflection","slug":"Reflection","permalink":"http://throwable.club/blog/tags/Reflection/"}]},{"title":"ç¥å¥‡çš„é­”æ³•ç±»å’ŒåŒåˆƒå‰‘-Unsafe","slug":"java-magic-unsafe","date":"2018-12-13T15:46:58.000Z","updated":"2018-12-13T15:47:39.460Z","comments":true,"path":"2018/12/13/java-magic-unsafe/","link":"","permalink":"http://throwable.club/2018/12/13/java-magic-unsafe/","excerpt":"","text":"ç¥å¥‡çš„é­”æ³•ç±»å’ŒåŒåˆƒå‰‘-Unsafe å‰æ JDK9æˆ–è€…ä»¥åï¼Œsun.miscåŒ…çš„æºç ä¹Ÿå¯ä»¥ä¸Šä¼ åˆ°JDKç±»åº“ä¸­ï¼Œå¯ä»¥ç›´æ¥å¯¼å…¥IDEè¿›è¡Œæ³¨é‡Šçš„é˜…è¯»ï¼Œè¿™ä¸€ç‚¹æ˜¯æ¯”è¾ƒå¥½çš„æ”¹è¿›ã€‚æœ¬æ–‡åŸºäºJDK11çš„æºç é˜…è¯»Unsafeç±»çš„æ³¨é‡Šï¼Œä»‹ç»ä¸€ä¸‹è¿™ä¸ªç±»çš„ä½¿ç”¨æ–¹å¼ã€‚ Unsafeç®€ä»‹ åœ¨JDK9ä¹‹åï¼Œsun.misc.Unsafeè¢«ç§»åŠ¨åˆ°jdk.unsupportedæ¨¡å—ä¸­ï¼ŒåŒæ—¶åœ¨java.baseæ¨¡å—å…‹éš†äº†ä¸€ä¸ªjdk.internal.misc.Unsafeç±»ï¼Œä»£æ›¿äº†JDK8ä»¥å‰çš„sun.misc.Unsafeçš„åŠŸèƒ½ï¼Œjdk.internalåŒ…ä¸å¼€æ”¾ç»™å¼€å‘è€…è°ƒç”¨ã€‚ Unsafeæ˜¯ç”¨äºåœ¨å®è´¨ä¸Šæ‰©å±•Javaè¯­è¨€è¡¨è¾¾èƒ½åŠ›ã€ä¾¿äºåœ¨æ›´é«˜å±‚ï¼ˆJavaå±‚ï¼‰ä»£ç é‡Œå®ç°åŸæœ¬è¦åœ¨æ›´ä½å±‚ï¼ˆCå±‚ï¼‰å®ç°çš„æ ¸å¿ƒåº“åŠŸèƒ½ç”¨çš„ã€‚è¿™äº›åŠŸèƒ½åŒ…æ‹¬è£¸å†…å­˜çš„ç”³è¯·/é‡Šæ”¾/è®¿é—®ï¼Œä½å±‚ç¡¬ä»¶çš„atomic/volatileæ”¯æŒï¼Œåˆ›å»ºæœªåˆå§‹åŒ–å¯¹è±¡ç­‰ã€‚å®ƒåŸæœ¬çš„è®¾è®¡å°±åªåº”è¯¥è¢«æ ‡å‡†åº“ä½¿ç”¨ã€‚ ä¸ºäº†è®©å¼€å‘è€…æœ‰æœºä¼šè¿‡æ¸¡åˆ°å°½é‡ä¸ä½¿ç”¨sun.misc.Unsafeï¼Œé»˜è®¤ä¸å…è®¸Javaåº”ç”¨ä»£ç è®¿é—®sun.misc.Unsafeç±»ï¼ŒåŒæ—¶åœ¨java.baseæ¨¡å—å…‹éš†äº†ä¸€ä¸ªä¸èƒ½è¢«å¤–éƒ¨è®¿é—®çš„jdk.internal.misc.Unsafeç±»ç”¨äºJDKå†…éƒ¨APIæ¼”è¿›ã€‚ è·å–Unsafeå®ä¾‹ sun.misc.Unsafeæä¾›äº†ä¸€ä¸ªé™æ€æ–¹æ³•æ¥è·å–å…¶å®ä¾‹ï¼š 1234567891011@CallerSensitivepublic static Unsafe getUnsafe() &#123; Class&lt;?&gt; caller = Reflection.getCallerClass(); if (!VM.isSystemDomainLoader(caller.getClassLoader())) throw new SecurityException(\"Unsafe\"); return theUnsafe;&#125;// VMç±»ä¸­çš„ä»£ç public static boolean isSystemDomainLoader(ClassLoader loader) &#123; return loader == null || loader == ClassLoader.getPlatformClassLoader();&#125; è¿™ä¸ªé™æ€æ–¹æ³•getUnsafe()å¿…é¡»åœ¨å½“å‰è°ƒç”¨çš„ç±»å¯¹åº”çš„ç±»åŠ è½½å™¨ä¸ºnull(ç±»åŠ è½½å™¨ä¸ºnullä¹Ÿå°±æ˜¯å½“å‰è°ƒç”¨çš„ç±»å¿…é¡»ä½¿ç”¨Bootstrapç±»åŠ è½½å™¨åŠ è½½)æˆ–è€…ä¸ºPlatformClassLoaderæ‰ä¸ä¼šæŠ›å‡ºSecurityExceptionå¼‚å¸¸ã€‚ç”±äºå¯¹PlatformClassLoaderç†è§£ä¸æ·±å…¥ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç”¨VMå‚æ•°-Xbootclasspath:è®©å½“å‰çš„è°ƒç”¨ç±»è¢«Bootstrapç±»åŠ è½½å™¨åŠ è½½ã€‚ ä½†æ˜¯è¯•éªŒäº†ä¸€ä¸‹(å…¶å®æ–‡æ¡£ä¸­å·²ç»æåˆ°æ­¤å‚æ•°å·²ç»å¤±æ•ˆï¼Œä¸è¿‡è¿™é‡Œè¿˜æ˜¯è¯•äº†ä¸‹)ï¼Œå‘ç°è¿™ä¸ªå‚æ•°åœ¨JDK9ä¹‹åå·²ç»ä¸æ”¯æŒï¼Œä½¿ç”¨çš„æ—¶å€™ä¼šå¯¼è‡´JVMå¯åŠ¨å¤±è´¥ï¼Œå¼‚å¸¸ä¿¡æ¯æ˜¯ï¼š 123Error: Could not create the Java Virtual Machine.-Xbootclasspath is no longer a supported option.Error: A fatal exception has occurred. Program will exit. æ­¤ç‰¹æ€§æš‚æ—¶åœ¨JDK9ä»¥åæ‰¾ä¸åˆ°æ›¿ä»£çš„VMå‚æ•°ï¼Œæ‰€ä»¥è¿™é‡Œåªèƒ½é€‰æ‹©å…¶ä»–å¯è¡Œæ–¹æ³•ã€‚æŸ¥çœ‹sun.misc.Unsafeæ‰€åœ¨æ¨¡å—çš„ä¿¡æ¯ï¼š 12345678module jdk.unsupported &#123; exports com.sun.nio.file; exports sun.misc; exports sun.reflect; opens sun.misc; opens sun.reflect;&#125; ç”±äºsun.miscæ˜¯opensä¿®é¥°çš„ï¼Œå¯ä»¥ä½¿ç”¨åå°„ç›´æ¥è°ƒç”¨ã€‚å› æ­¤å¯ä»¥åƒä¸‹é¢è¿™æ ·è·å–sun.misc.Unsafeå¯¹è±¡ï¼š 12345678public class UnsafeMain &#123; public static void main(String[] args) throws Exception &#123; Field f = Unsafe.class.getDeclaredField(\"theUnsafe\"); f.setAccessible(true); Unsafe unsafe = (Unsafe) f.get(null); &#125;&#125; å…¶å®è¿˜æœ‰ç‰¹æ®Šçš„æŠ€å·§å¯ä»¥ç›´æ¥æš´éœ²jdk.internal.misc.Unsafeæ‰€åœ¨çš„æ¨¡å—è®©å®ƒå¯ä»¥ç›´æ¥ä½¿ç”¨åå°„è°ƒç”¨ï¼Œåªéœ€è¦ä½¿ç”¨å‚æ•°addExports:java.base/jdk.internal.misc=ALL-UNAMEDï¼Œè¿™æ ·å­å°±å¯ä»¥åå°„è·å–jdk.internal.misc.Unsafeçš„å®ä¾‹ï¼Œä¸è¿‡æ¨èè¿™ç§åšæ³•ï¼Œæ¯•ç«Ÿjdk.internal.misc.Unsafeä¸­æä¾›æ›´å¤šåº•å±‚çš„æ–¹æ³•ï¼Œèƒ½åŠ›è¶Šå¤§è¶Šå®¹æ˜“å¤±å»æ§åˆ¶ã€‚ Unsafeçš„ä½¿ç”¨å»ºè®® ä½¿ç”¨Unsafeè¦æ³¨æ„ä»¥ä¸‹å‡ ä¸ªé—®é¢˜ï¼š 1ã€Unsafeæœ‰å¯èƒ½åœ¨æœªæ¥çš„JDKç‰ˆæœ¬ç§»é™¤æˆ–è€…ä¸å…è®¸Javaåº”ç”¨ä»£ç ä½¿ç”¨ï¼Œè¿™ä¸€ç‚¹å¯èƒ½å¯¼è‡´ä½¿ç”¨äº†Unsafeçš„åº”ç”¨æ— æ³•è¿è¡Œåœ¨é«˜ç‰ˆæœ¬çš„JDKã€‚ 2ã€Unsafeçš„ä¸å°‘æ–¹æ³•ä¸­å¿…é¡»æä¾›åŸå§‹åœ°å€(å†…å­˜åœ°å€)å’Œè¢«æ›¿æ¢å¯¹è±¡çš„åœ°å€ï¼Œåç§»é‡è¦è‡ªå·±è®¡ç®—ï¼Œä¸€æ—¦å‡ºç°é—®é¢˜å°±æ˜¯JVMå´©æºƒçº§åˆ«çš„å¼‚å¸¸ï¼Œä¼šå¯¼è‡´æ•´ä¸ªJVMå®ä¾‹å´©æºƒï¼Œè¡¨ç°ä¸ºåº”ç”¨ç¨‹åºç›´æ¥crashæ‰(å…¶å®è¿™ä¸ªå¾ˆå¥½ç†è§£ï¼ŒJVMæ˜¯Cè¯­è¨€å†™å‡ºæ¥çš„è½¯ä»¶ï¼Œå¦‚æœæ“ä½œä¸€ä¸ªä¸å­˜åœ¨çš„å†…å­˜åœ°å€ï¼Œåœ¨Cç¨‹åºä¸­å°±æ˜¯å¼•å‘ç¨‹åºå´©æºƒçš„æ“ä½œ)ã€‚ 3ã€Unsafeæä¾›çš„ç›´æ¥å†…å­˜è®¿é—®çš„æ–¹æ³•ä¸­ä½¿ç”¨çš„å†…å­˜ä¸å—JVMç®¡ç†(æ— æ³•è¢«GC)ï¼Œéœ€è¦æ‰‹åŠ¨ç®¡ç†ï¼Œä¸€æ—¦å‡ºç°ç–å¿½å¾ˆæœ‰å¯èƒ½æˆä¸ºå†…å­˜æ³„æ¼çš„æºå¤´ã€‚ æš‚æ—¶æ€»ç»“å‡ºä»¥ä¸Šä¸‰ç‚¹é—®é¢˜ã€‚Unsafeåœ¨JUC(java.util.concurrent)åŒ…ä¸­å¤§é‡ä½¿ç”¨(ä¸»è¦æ˜¯CAS)ï¼Œåœ¨nettyä¸­æ–¹ä¾¿ä½¿ç”¨ç›´æ¥å†…å­˜ï¼Œè¿˜æœ‰ä¸€äº›é«˜å¹¶å‘çš„äº¤æ˜“ç³»ç»Ÿä¸ºäº†æé«˜CASçš„æ•ˆç‡ä¹Ÿæœ‰å¯èƒ½ç›´æ¥ä½¿ç”¨åˆ°Unsafeã€‚æ€»è€Œè¨€ä¹‹ï¼ŒUnsafeç±»æ˜¯é­”æ³•ç±»ï¼Œä¹Ÿå¯ä»¥è¯´æ˜¯ä¸€æŠŠåŒåˆƒå‰‘ã€‚ Unsafeçš„æ ¸å¿ƒæ–¹æ³• sun.misc.Unsafeä¸€å…±æä¾›äº†89ä¸ªpublicä¿®é¥°çš„æ–¹æ³•ï¼Œä¸‹é¢é’ˆå¯¹æ ¸å¿ƒæ–¹æ³•æŒ‰åŠŸèƒ½åˆ†ç»„ç®€å•ä»‹ç»ä¸€ä¸‹ã€‚ ç±»æ“ä½œ ç±»æ“ä½œç›¸å…³ä¸»è¦å’Œç±»å®ä¾‹åŒ–ã€å±æ€§åœ°å€è·å–ç­‰ç­‰æ“ä½œï¼ŒåŸæ¥å­˜åœ¨ä¸€ä¸ªdefineClassæ–¹æ³•ï¼Œå·²ç»è¢«ç§»é™¤ï¼Œä½†æ˜¯è¯¥æ–¹æ³•åœ¨jdk.internal.misc.Unsafeä¸­ä¾ç„¶å­˜åœ¨ã€‚ ensureClassInitialized public boolean shouldBeInitialized(Class&lt;?&gt; c) æ£€æµ‹ç»™å®šçš„ç±»æ˜¯å¦å·²ç»åˆå§‹åŒ–ã€‚é€šå¸¸éœ€è¦ä½¿ç”¨åœ¨è·å–ä¸€ä¸ªç±»çš„é™æ€å±æ€§çš„æ—¶å€™(å› ä¸ºä¸€ä¸ªç±»å¦‚æœæ²¡åˆå§‹åŒ–ï¼Œå®ƒçš„é™æ€å±æ€§ä¹Ÿä¸ä¼šåˆå§‹åŒ–)ã€‚ shouldBeInitialized public boolean shouldBeInitialized(Class&lt;?&gt; c) æ£€æµ‹ç»™å®šçš„ç±»æ˜¯å¦éœ€è¦åˆå§‹åŒ–ã€‚é€šå¸¸éœ€è¦ä½¿ç”¨åœ¨è·å–ä¸€ä¸ªç±»çš„é™æ€å±æ€§çš„æ—¶å€™(å› ä¸ºä¸€ä¸ªç±»å¦‚æœæ²¡åˆå§‹åŒ–ï¼Œå®ƒçš„é™æ€å±æ€§ä¹Ÿä¸ä¼šåˆå§‹åŒ–)ã€‚ æ­¤æ–¹æ³•å½“ä¸”ä»…å½“ensureClassInitializedæ–¹æ³•ä¸ç”Ÿæ•ˆçš„æ—¶å€™æ‰è¿”å›falseã€‚ defineAnonymousClass public Class&lt;?&gt; defineAnonymousClass(Class&lt;?&gt; hostClass, byte[] data, Object[] cpPatches) hostClassï¼šå®¿ä¸»ç±»ã€‚ dataï¼šå­—èŠ‚ç å­—èŠ‚æ•°ç»„ã€‚ cpPatchesï¼šæ›¿æ¢å¸¸é‡æ± (Constant Pool)ä¸­çš„å­—é¢é‡å¾—åˆ°çš„å¼•ç”¨æ•°ç»„ã€‚ è¿™ä¸ªæ–¹æ³•çš„ä½¿ç”¨å¯ä»¥çœ‹Rå¤§çš„çŸ¥ä¹å›ç­”ï¼šJVM crashes at libjvm.soï¼Œä¸‹é¢æˆªå–ä¸€ç‚¹å†…å®¹è§£é‡Šæ­¤æ–¹æ³•ã€‚ 1ã€VM Anonymous Classå¯ä»¥çœ‹ä½œä¸€ç§æ¨¡æ¿æœºåˆ¶ï¼Œå¦‚æœç¨‹åºè¦åŠ¨æ€ç”Ÿæˆå¾ˆå¤šç»“æ„ç›¸åŒã€åªæ˜¯è‹¥å¹²å˜é‡ä¸åŒçš„ç±»çš„è¯ï¼Œå¯ä»¥å…ˆåˆ›å»ºå‡ºä¸€ä¸ªåŒ…å«å ä½ç¬¦å¸¸é‡çš„æ­£å¸¸ç±»ä½œä¸ºæ¨¡æ¿ï¼Œç„¶ååˆ©ç”¨sun.misc.Unsafe#defineAnonymousClass()æ–¹æ³•ï¼Œä¼ å…¥è¯¥ç±»(host classï¼Œå®¿ä¸»ç±»æˆ–è€…æ¨¡æ¿ç±»)ä»¥åŠä¸€ä¸ªä½œä¸º&quot;constant pool path&quot;çš„æ•°ç»„æ¥æ›¿æ¢æŒ‡å®šçš„å¸¸é‡ä¸ºä»»æ„å€¼ï¼Œç»“æœå¾—åˆ°çš„å°±æ˜¯ä¸€ä¸ªæ›¿æ¢äº†å¸¸é‡çš„VM Anonymous Classã€‚ 2ã€VM Anonymous Classä»VMçš„è§’åº¦çœ‹æ˜¯çœŸæ­£çš„&quot;æ²¡æœ‰åå­—&quot;çš„ï¼Œåœ¨æ„é€ å‡ºæ¥ä¹‹ååªèƒ½é€šè¿‡Unsafe#defineAnonymousClass()è¿”å›å‡ºæ¥ä¸€ä¸ªClasså®ä¾‹æ¥è¿›è¡Œåå°„æ“ä½œã€‚ è¿˜æœ‰å…¶ä»–å‡ ç‚¹çœ‹ä»¥è‡ªè¡Œé˜…è¯»ã€‚è¿™ä¸ªæ–¹æ³•è™½ç„¶ç¿»è¯‘ä¸º&quot;å®šä¹‰åŒ¿åç±»&quot;ï¼Œä½†æ˜¯å®ƒæ‰€å®šä¹‰çš„ç±»å’Œå®é™…çš„åŒ¿åç±»æœ‰ç‚¹ä¸ç›¸åŒï¼Œå› æ­¤ä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬ä¸ä¼šç”¨åˆ°æ­¤æ–¹æ³•ã€‚åœ¨JDKä¸­Lambdaè¡¨è¾¾å¼çš„æ„é€ ä¾èµ–åˆ°æ­¤æ–¹æ³•ï¼Œå¯ä»¥çœ‹InnerClassLambdaMetafactoryè¿™ä¸ªç±»ã€‚æ–¹æ³•çš„æ³¨é‡Šï¼šå®šä¹‰ä¸€ä¸ªä¸è¢«ç±»åŠ è½½å™¨ç³»ç»Ÿæˆ–è€…ç³»ç»Ÿå­—å…¸æ„ŸçŸ¥çš„ç±»å‹ã€‚ allocateInstance public native Object allocateInstance(Class&lt;?&gt; cls) æ³¨æ„æ­¤æ–¹æ³•æ˜¯JVMæœ¬åœ°æ¥å£æ–¹æ³•ï¼Œé€šè¿‡Classå¯¹è±¡åˆ›å»ºä¸€ä¸ªç±»çš„å®ä¾‹ï¼Œä¸éœ€è¦è°ƒç”¨å…¶æ„é€ å‡½æ•°ã€åˆå§‹åŒ–ä»£ç ã€JVMå®‰å…¨æ£€æŸ¥ç­‰ç­‰ã€‚åŒæ—¶ï¼Œå®ƒæŠ‘åˆ¶ä¿®é¥°ç¬¦æ£€æµ‹ï¼Œä¹Ÿå°±æ˜¯å³ä½¿æ„é€ å™¨æ˜¯privateä¿®é¥°çš„ä¹Ÿèƒ½é€šè¿‡æ­¤æ–¹æ³•å®ä¾‹åŒ–ã€‚ staticFieldBase public Object staticFieldBase(Field f) è¿”å›ç»™å®šçš„é™æ€å±æ€§æ‰€åœ¨çš„ä½ç½®(å…¶å®å°±æ˜¯æ‰€åœ¨çš„å¯¹è±¡çš„å†…å­˜å¿«ç…§)ï¼Œé…åˆstaticFieldOffsetæ–¹æ³•ä½¿ç”¨ã€‚å®é™…ä¸Šï¼Œè¿™ä¸ªæ–¹æ³•è¿”å›å€¼å°±æ˜¯é™æ€å±æ€§æ‰€åœ¨çš„Classå¯¹è±¡çš„ä¸€ä¸ªå†…å­˜å¿«ç…§ã€‚æ³¨é‡Šä¸­è¯´åˆ°ï¼Œæ­¤æ–¹æ³•è¿”å›çš„Objectæœ‰å¯èƒ½ä¸ºnullï¼Œå®ƒåªæ˜¯ä¸€ä¸ªâ€™cookieâ€™è€Œä¸æ˜¯çœŸå®çš„å¯¹è±¡ï¼Œä¸è¦ç›´æ¥ä½¿ç”¨çš„å®ƒçš„å®ä¾‹ä¸­çš„è·å–å±æ€§å’Œè®¾ç½®å±æ€§çš„æ–¹æ³•ï¼Œå®ƒçš„ä½œç”¨åªæ˜¯æ–¹ä¾¿è°ƒç”¨åƒgetInt(Object,long)ç­‰ç­‰çš„ä»»æ„æ–¹æ³•ã€‚ staticFieldOffset public long staticFieldOffset(Field f) è¿”å›ç»™å®šçš„é™æ€å±æ€§åœ¨å®ƒçš„ç±»çš„å†…å­˜åˆ†é…ä¸­çš„ä½ç½®(å†…å­˜åç§»åœ°å€)ã€‚ä¸è¦åœ¨è¿™ä¸ªåç§»é‡ä¸Šæ‰§è¡Œä»»ä½•ç±»å‹çš„ç®—æœ¯è¿ç®—ï¼Œå®ƒåªæ˜¯ä¸€ä¸ªè¢«ä¼ é€’ç»™ä¸å®‰å…¨çš„å †å†…å­˜è®¿é—®å™¨çš„cookieã€‚æ³¨æ„ï¼šè¿™ä¸ªæ–¹æ³•ä»…ä»…é’ˆå¯¹é™æ€å±æ€§ï¼Œä½¿ç”¨åœ¨éé™æ€å±æ€§ä¸Šä¼šæŠ›å¼‚å¸¸ã€‚ objectFieldOffset public long staticFieldOffset(Field f) è¿”å›ç»™å®šçš„éé™æ€å±æ€§åœ¨å®ƒçš„ç±»çš„å†…å­˜åˆ†é…ä¸­çš„ä½ç½®(å†…å­˜åç§»åœ°å€)ã€‚ä¸è¦åœ¨è¿™ä¸ªåç§»é‡ä¸Šæ‰§è¡Œä»»ä½•ç±»å‹çš„ç®—æœ¯è¿ç®—ï¼Œå®ƒåªæ˜¯ä¸€ä¸ªè¢«ä¼ é€’ç»™ä¸å®‰å…¨çš„å †å†…å­˜è®¿é—®å™¨çš„cookieã€‚æ³¨æ„ï¼šè¿™ä¸ªæ–¹æ³•ä»…ä»…é’ˆå¯¹éé™æ€å±æ€§ï¼Œä½¿ç”¨åœ¨é™æ€å±æ€§ä¸Šä¼šæŠ›å¼‚å¸¸ã€‚ defineClass public Class&lt;?&gt; defineClass(String name, byte[] b, int off, int len, ClassLoader loader, ProtectionDomain protectionDomain) è¿™ä¸ªæ–¹æ³•ä½äºjdk.internal.misc.Unsafeï¼Œä¹Ÿå°±æ˜¯å¼€å‘è€…æ— æ³•ç›´æ¥ä½¿ç”¨ã€‚ä½œç”¨æ˜¯ï¼šç»•è¿‡å®‰å…¨æ£€æŸ¥å‘ŠçŸ¥JVMå®šä¹‰ä¸€ä¸ªç±»ã€‚é»˜è®¤æƒ…å†µä¸‹ï¼ŒClassLoader(ç±»åŠ è½½å™¨)å’ŒProtectionDomain(ä¿æŠ¤åŸŸ)å®ä¾‹åº”è¯¥æ¥æºäºè°ƒç”¨è€…ã€‚ åŸºäºå†…å­˜åœ°å€ç›´æ¥å­˜å–å±æ€§ å‰ä¸€èŠ‚ä¸­æä¾›äº†ä¸€äº›æ–¹æ³•å¯ä»¥ç›´æ¥è·å–é™æ€æˆ–è€…éé™æ€æˆå‘˜å±æ€§çš„å†…å­˜åœ°å€ï¼Œè¿™ä¸€èŠ‚ä»‹ç»çš„APIå¯ä»¥åŸºäºæˆå‘˜å±æ€§å†…å­˜åœ°å€ç›´æ¥è·å–æˆ–è€…è®¾ç½®å…¶å€¼ã€‚ getObject public Object getObject(Object o, long offset) é€šè¿‡ç»™å®šçš„Javaå¯¹è±¡å’Œå±æ€§å†…å­˜åœ°å€è·å–å¼•ç”¨å€¼ã€‚è¿™é‡Œå®é™…ä¸Šæ˜¯è·å–ä¸€ä¸ªJavaå¯¹è±¡oä¸­ï¼Œè·å–åç§»åœ°å€ä¸ºoffsetçš„å±æ€§çš„å€¼ï¼Œæ­¤æ–¹æ³•å¯ä»¥çªç ´ä¿®é¥°ç¬¦çš„æŠ‘åˆ¶ï¼Œä¹Ÿå°±æ˜¯æ— è§†privateã€protectedå’Œdefaultä¿®é¥°ç¬¦ã€‚ç±»ä¼¼çš„æ–¹æ³•æœ‰getIntã€getDoubleç­‰ç­‰ã€‚ putObject public void putObject(Object o, long offset, Object x) oï¼šå½“å‰æ“ä½œçš„å¯¹è±¡ã€‚ offsetï¼šæˆå‘˜å±æ€§çš„å†…å­˜åœ°å€ã€‚ xï¼šéœ€è¦è®¾ç½®çš„ç›®æ ‡å±æ€§å€¼ã€‚ å°†å¼•ç”¨å€¼å­˜å‚¨åˆ°ç»™å®šçš„Javaå˜é‡ä¸­ã€‚è¿™é‡Œå®é™…ä¸Šæ˜¯è®¾ç½®ä¸€ä¸ªJavaå¯¹è±¡oä¸­åç§»åœ°å€ä¸ºoffsetçš„å±æ€§çš„å€¼ä¸ºxï¼Œæ­¤æ–¹æ³•å¯ä»¥çªç ´ä¿®é¥°ç¬¦çš„æŠ‘åˆ¶ï¼Œä¹Ÿå°±æ˜¯æ— è§†privateã€protectedå’Œdefaultä¿®é¥°ç¬¦ã€‚ç±»ä¼¼çš„æ–¹æ³•æœ‰putIntã€putDoubleç­‰ç­‰ã€‚ getObjectVolatile public Object getObjectVolatile(Object o, long offset) æ­¤æ–¹æ³•å’Œä¸Šé¢çš„getObjectåŠŸèƒ½ç±»ä¼¼ï¼Œä¸è¿‡é™„åŠ äº†volatileå…³é”®å­—åŠ è½½è¯­ä¹‰ï¼Œä¹Ÿå°±æ˜¯å¼ºåˆ¶ä»ä¸»å­˜ä¸­è·å–å±æ€§å€¼ã€‚ç±»ä¼¼çš„æ–¹æ³•æœ‰getIntVolatileã€getDoubleVolatileç­‰ç­‰ã€‚è¿™ä¸ªæ–¹æ³•è¦æ±‚è¢«ä½¿ç”¨çš„å±æ€§è¢«volatileä¿®é¥°ï¼Œå¦åˆ™åŠŸèƒ½å’ŒgetObjectæ–¹æ³•ç›¸åŒã€‚ putObjectVolatile public void putObjectVolatile(Object o, long offset, Object x) æ­¤æ–¹æ³•å’Œä¸Šé¢çš„putObjectåŠŸèƒ½ç±»ä¼¼ï¼Œä¸è¿‡é™„åŠ äº†volatileå…³é”®å­—åŠ è½½è¯­ä¹‰ï¼Œä¹Ÿå°±æ˜¯è®¾ç½®å€¼çš„æ—¶å€™å¼ºåˆ¶(JMMä¼šä¿è¯è·å¾—é”åˆ°é‡Šæ”¾é”ä¹‹é—´æ‰€æœ‰å¯¹è±¡çš„çŠ¶æ€æ›´æ–°éƒ½ä¼šåœ¨é”è¢«é‡Šæ”¾ä¹‹å)æ›´æ–°åˆ°ä¸»å­˜ï¼Œä»è€Œä¿è¯è¿™äº›å˜æ›´å¯¹å…¶ä»–çº¿ç¨‹æ˜¯å¯è§çš„ã€‚ç±»ä¼¼çš„æ–¹æ³•æœ‰putIntVolatileã€putDoubleVolatileç­‰ç­‰ã€‚è¿™ä¸ªæ–¹æ³•è¦æ±‚è¢«ä½¿ç”¨çš„å±æ€§è¢«volatileä¿®é¥°ï¼Œå¦åˆ™åŠŸèƒ½å’ŒputObjectæ–¹æ³•ç›¸åŒã€‚ putOrderedObject public void putOrderedObject(Object o, long offset, Object x) è®¾ç½®oå¯¹è±¡ä¸­offsetåç§»åœ°å€offsetå¯¹åº”çš„Objectå‹fieldçš„å€¼ä¸ºæŒ‡å®šå€¼xã€‚è¿™æ˜¯ä¸€ä¸ªæœ‰åºæˆ–è€…æœ‰å»¶è¿Ÿçš„putObjectVolatileæ–¹æ³•ï¼Œå¹¶ä¸”ä¸ä¿è¯å€¼çš„æ”¹å˜è¢«å…¶ä»–çº¿ç¨‹ç«‹å³çœ‹åˆ°ã€‚åªæœ‰åœ¨å±æ€§è¢«volatileä¿®é¥°å¹¶ä¸”æœŸæœ›è¢«ä¿®æ”¹çš„æ—¶å€™ä½¿ç”¨æ‰ä¼šç”Ÿæ•ˆã€‚ç±»ä¼¼çš„æ–¹æ³•æœ‰putOrderedIntå’ŒputOrderedLongã€‚æ–¹æ³•æ³¨é‡Šä¸­æåˆ°ï¼šç›¸å½“äºC11ä¸­çš„atomic_store_explicit(..., memory_order_release)ã€‚ æ•°ç»„æ“ä½œ arrayBaseOffset public int arrayBaseOffset(Class&lt;?&gt; arrayClass) è¿”å›æ•°ç»„ç±»å‹çš„ç¬¬ä¸€ä¸ªå…ƒç´ çš„åç§»åœ°å€(åŸºç¡€åç§»åœ°å€)ã€‚å¦‚æœarrayIndexScaleæ–¹æ³•è¿”å›çš„æ¯”ä¾‹å› å­ä¸ä¸º0ï¼Œä½ å¯ä»¥é€šè¿‡ç»“åˆåŸºç¡€åç§»åœ°å€å’Œæ¯”ä¾‹å› å­è®¿é—®æ•°ç»„çš„æ‰€æœ‰å…ƒç´ ã€‚Unsafeä¸­å·²ç»åˆå§‹åŒ–äº†å¾ˆå¤šç±»ä¼¼çš„å¸¸é‡å¦‚ARRAY_BOOLEAN_BASE_OFFSETç­‰ã€‚ arrayIndexScale public int arrayIndexScale(Class&lt;?&gt; arrayClass) è¿”å›æ•°ç»„ç±»å‹çš„æ¯”ä¾‹å› å­(å…¶å®å°±æ˜¯æ•°æ®ä¸­å…ƒç´ åç§»åœ°å€çš„å¢é‡ï¼Œå› ä¸ºæ•°ç»„ä¸­çš„å…ƒç´ çš„åœ°å€æ˜¯è¿ç»­çš„)ã€‚æ­¤æ–¹æ³•ä¸é€‚ç”¨äºæ•°ç»„ç±»å‹ä¸º&quot;narrow&quot;ç±»å‹çš„æ•°ç»„ï¼Œ&quot;narrow&quot;ç±»å‹çš„æ•°ç»„ç±»å‹ä½¿ç”¨æ­¤æ–¹æ³•ä¼šè¿”å›0(è¿™é‡Œnarrowåº”è¯¥æ˜¯ç‹­ä¹‰çš„æ„æ€ï¼Œä½†æ˜¯å…·ä½“æŒ‡å“ªäº›ç±»å‹æš‚æ—¶ä¸æ˜ç¡®ï¼Œç¬”è€…æŸ¥äº†å¾ˆå¤šèµ„æ–™ä¹Ÿæ²¡æ‰¾åˆ°ç»“æœ)ã€‚Unsafeä¸­å·²ç»åˆå§‹åŒ–äº†å¾ˆå¤šç±»ä¼¼çš„å¸¸é‡å¦‚ARRAY_BOOLEAN_INDEX_SCALEç­‰ã€‚ ä½çº§åŒæ­¥åŸè¯­ ä½çº§åŒæ­¥åŸè¯­çš„ç›¸å…³æ–¹æ³•åœ¨JDK8è¿˜èƒ½é€šè¿‡sun.misc.Unsafeä½¿ç”¨ï¼Œåœ¨JDK9ä»¥åsun.misc.Unsafeå’Œjdk.internal.misc.Unsafeéƒ½ç§»é™¤äº†ç›¸å…³çš„æ–¹æ³•ã€‚ä½çº§åŒæ­¥åŸè¯­ä¸»è¦åŒ…æ‹¬ç›‘è§†å™¨é”å®šã€è§£é”æ–¹æ³•ã€‚ monitorEnter public native void monitorEnter(Object o) é”å®šå¯¹è±¡ï¼Œå¿…é¡»é€šè¿‡monitorExitæ–¹æ³•æ‰èƒ½è§£é”ã€‚æ­¤æ–¹æ³•ç»è¿‡å®éªŒæ˜¯å¯ä»¥é‡å…¥çš„ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥å¤šæ¬¡è°ƒç”¨ï¼Œç„¶åé€šè¿‡å¤šæ¬¡è°ƒç”¨monitorExitè¿›è¡Œè§£é”ã€‚ monitorExit public native void monitorExit(Object o) è§£é”å¯¹è±¡ï¼Œå‰ææ˜¯å¯¹è±¡å¿…é¡»å·²ç»è°ƒç”¨monitorEnterè¿›è¡ŒåŠ é”ï¼Œå¦åˆ™æŠ›å‡ºIllegalMonitorStateExceptionå¼‚å¸¸ã€‚ tryMonitorEnter public native boolean tryMonitorEnter(Object o) å°è¯•é”å®šå¯¹è±¡ï¼Œå¦‚æœåŠ é”æˆåŠŸè¿”å›trueï¼Œå¦åˆ™è¿”å›falseã€‚å¿…é¡»é€šè¿‡monitorExitæ–¹æ³•æ‰èƒ½è§£é”ã€‚ çº¿ç¨‹æŒ‚èµ·ä¸æ¢å¤ JDK1.5å¼•å…¥äº†å¹¶å‘åŒ…java.util.concurrentä¸­ç»„ä»¶æ§åˆ¶çº¿ç¨‹æŒ‚èµ·å’Œæ¢å¤å°±æ˜¯ä¾èµ–äºjava.util.concurrent.locks.LockSupportå®Œæˆï¼Œè€ŒLockSupportåº•å±‚ä¾èµ–äºsun.misc.Unsafeä¸­ä¸‹é¢æåˆ°çº¿ç¨‹çš„æŒ‚èµ·å’Œæ¢å¤æ–¹æ³•å®Œæˆçš„ã€‚ç›¸å…³æ–¹æ³•ä¸»è¦æ˜¯ç”¨äºæ›¿ä»£çº¿ç¨‹ç±»Threadä¸­è¿‡æ—¶å¹¶ä¸”ä¸å®‰å…¨çš„suspendå’Œresumeæ–¹æ³•ã€‚ park public void park(boolean isAbsolute, long time) timeï¼šæ—¶é—´é•¿åº¦ï¼Œå•ä½ç”±isAbsoluteæ§åˆ¶ï¼Œ0è¡¨ç¤ºæ°¸ä¹…é˜»å¡ã€‚ isAbsoluteï¼šå¦‚æœisAbsoluteä¸ºtrueï¼Œtimeæ˜¯ç›¸å¯¹äºæ–°çºªå…ƒä¹‹åçš„æ¯«ç§’ï¼Œå¦åˆ™timeè¡¨ç¤ºçº³ç§’ã€‚ æ³¨é‡Šï¼šé˜»å¡å½“å‰çº¿ç¨‹ç›´åˆ°ä¸€ä¸ªunparkæ–¹æ³•å‡ºç°(è¢«è°ƒç”¨)ã€ä¸€ä¸ªç”¨äºunparkæ–¹æ³•å·²ç»å‡ºç°è¿‡(åœ¨æ­¤parkæ–¹æ³•è°ƒç”¨ä¹‹å‰å·²ç»è°ƒç”¨è¿‡)ã€çº¿ç¨‹è¢«ä¸­æ–­æˆ–è€…timeæ—¶é—´åˆ°æœŸ(ä¹Ÿå°±æ˜¯é˜»å¡è¶…æ—¶)ã€‚åœ¨timeéé›¶çš„æƒ…å†µä¸‹ï¼Œå¦‚æœisAbsoluteä¸ºtrueï¼Œtimeæ˜¯ç›¸å¯¹äºæ–°çºªå…ƒä¹‹åçš„æ¯«ç§’ï¼Œå¦åˆ™timeè¡¨ç¤ºçº³ç§’ã€‚è¿™ä¸ªæ–¹æ³•æ‰§è¡Œæ—¶ä¹Ÿå¯èƒ½ä¸åˆç†åœ°è¿”å›(æ²¡æœ‰å…·ä½“åŸå› )ã€‚ unpark public void unpark(Object thread) é‡Šæ”¾è¢«parkåˆ›å»ºçš„åœ¨ä¸€ä¸ªçº¿ç¨‹ä¸Šçš„é˜»å¡ã€‚è¿™ä¸ªæ–¹æ³•ä¹Ÿå¯ä»¥è¢«ä½¿ç”¨æ¥ç»ˆæ­¢ä¸€ä¸ªå…ˆå‰è°ƒç”¨parkå¯¼è‡´çš„é˜»å¡ã€‚è¿™ä¸ªæ“ä½œæ˜¯ä¸å®‰å…¨çš„ï¼Œå› æ­¤å¿…é¡»ä¿è¯çº¿ç¨‹æ˜¯å­˜æ´»çš„(thread has not been destroyed)ã€‚ä»Javaä»£ç ä¸­åˆ¤æ–­ä¸€ä¸ªçº¿ç¨‹æ˜¯å¦å­˜æ´»çš„æ˜¯æ˜¾è€Œæ˜“è§çš„ï¼Œæ‰€ä»¥è§£é™¤é˜»å¡çš„æ—¶å€™éœ€è¦å¯¹çº¿ç¨‹çš„å­˜æ´»æ€§åšåˆ¤æ–­ã€‚ é‡ç‚¹æ³¨æ„ï¼š unparkæ–¹æ³•è°ƒç”¨å¤šæ¬¡ï¼Œå®é™…ä¸Šåªæœ‰ä¸€æ¬¡ä¼šç”Ÿæ•ˆï¼Œå¯ä»¥ç®€å•ç†è§£ä¸ºå®ƒæ˜¯ä¸€ä¸ªåªæœ‰0å’Œ1ä¸¤ä¸ªå€¼çš„è®¡æ•°å™¨ï¼Œè°ƒç”¨unparkå¤šæ¬¡ï¼Œè®¡æ•°ä»ç„¶ä¸º1ã€‚ parkæ–¹æ³•æ€»æ˜¯é’ˆå¯¹å½“å‰çº¿ç¨‹ï¼Œå¦‚æœé¢„å…ˆå·²ç»è°ƒç”¨è¿‡ä¸€æ¬¡unparkæ–¹æ³•åå†è°ƒç”¨parkæ–¹æ³•ï¼Œé‚£ä¹ˆå°†ä¸ä¼šè¿›å…¥é˜»å¡çŠ¶æ€ç›´æ¥é‡Šæ”¾ã€‚ CASæ“ä½œ CASï¼Œä¹Ÿå°±æ˜¯Compare And Swapï¼Œä¹Ÿå°±æ˜¯åœ¨ä¸€ä¸ªåŸå­æ“ä½œä¸­å®Œæˆæ¯”è¾ƒå’Œäº¤äº’ã€‚ compareAndSwapObject public final boolean compareAndSwapObject(Object o, long offset, Object expected, Object x) oï¼šç›®æ ‡Javaå˜é‡å¼•ç”¨ã€‚ offsetï¼šç›®æ ‡Javaå˜é‡ä¸­çš„ç›®æ ‡å±æ€§çš„åç§»åœ°å€ã€‚ expectedï¼šç›®æ ‡Javaå˜é‡ä¸­çš„ç›®æ ‡å±æ€§çš„æœŸæœ›çš„å½“å‰å€¼ã€‚ xï¼šç›®æ ‡Javaå˜é‡ä¸­çš„ç›®æ ‡å±æ€§çš„ç›®æ ‡æ›´æ–°å€¼ã€‚ é’ˆå¯¹Objectå¯¹è±¡è¿›è¡ŒCASæ“ä½œã€‚å³æ˜¯å¯¹åº”Javaå˜é‡å¼•ç”¨oï¼ŒåŸå­æ€§åœ°æ›´æ–°oä¸­åç§»åœ°å€ä¸ºoffsetçš„å±æ€§çš„å€¼ä¸ºxï¼Œå½“ä¸”ä»…çš„åç§»åœ°å€ä¸ºoffsetçš„å±æ€§çš„å½“å‰å€¼ä¸ºexpectedæ‰ä¼šæ›´æ–°æˆåŠŸè¿”å›trueï¼Œå¦åˆ™è¿”å›falseã€‚ç±»ä¼¼çš„æ–¹æ³•æœ‰compareAndSwapIntå’ŒcompareAndSwapLongï¼Œåœ¨Jdk8ä¸­åŸºäºCASæ‰©å±•å‡ºæ¥çš„ç›¸å…³æ–¹æ³•æœ‰getAndAddIntã€getAndAddLongã€getAndSetIntã€getAndSetLongã€getAndSetObjectï¼Œå®ƒä»¬çš„ä½œç”¨éƒ½æ˜¯ï¼šé€šè¿‡CASè®¾ç½®æ–°çš„å€¼ï¼Œè¿”å›æ—§çš„å€¼ã€‚ getAndSetObject public final Object getAndSetObject(Object o, long offset, Object newValue) è§compareAndSwapObjectä¸­çš„æè¿°ã€‚ å†…å­˜ç®¡ç† addressSize public int addressSize(); è·å–æœ¬åœ°æŒ‡é’ˆçš„å¤§å°(å•ä½æ˜¯byte)ï¼Œé€šå¸¸å€¼ä¸º4æˆ–è€…8ã€‚å¸¸é‡ADDRESS_SIZEå°±æ˜¯è°ƒç”¨æ­¤æ–¹æ³•ã€‚ pageSize public int pageSize(); è·å–æœ¬åœ°å†…å­˜çš„é¡µæ•°ï¼Œæ­¤å€¼ä¸º2çš„å¹‚æ¬¡æ–¹ã€‚ allocateMemory public long allocateMemory(long bytes); åˆ†é…ä¸€å—æ–°çš„æœ¬åœ°å†…å­˜ï¼Œé€šè¿‡bytesæŒ‡å®šå†…å­˜å—çš„å¤§å°(å•ä½æ˜¯byte)ï¼Œè¿”å›æ–°å¼€è¾Ÿçš„å†…å­˜çš„åœ°å€ã€‚å¦‚æœå†…å­˜å—çš„å†…å®¹ä¸è¢«åˆå§‹åŒ–ï¼Œé‚£ä¹ˆå®ƒä»¬ä¸€èˆ¬ä¼šå˜æˆå†…å­˜åƒåœ¾ã€‚ç”Ÿæˆçš„æœ¬æœºæŒ‡é’ˆæ°¸è¿œä¸ä¼šä¸ºé›¶ï¼Œå¹¶å°†å¯¹æ‰€æœ‰å€¼ç±»å‹è¿›è¡Œå¯¹é½ã€‚å¯ä»¥é€šè¿‡freeMemoryæ–¹æ³•é‡Šæ”¾å†…å­˜å—ï¼Œæˆ–è€…é€šè¿‡reallocateMemoryæ–¹æ³•è°ƒæ•´å†…å­˜å—å¤§å°ã€‚byteså€¼ä¸ºè´Ÿæ•°æˆ–è€…è¿‡å¤§ä¼šæŠ›å‡ºIllegalArgumentExceptionå¼‚å¸¸ï¼Œå¦‚æœç³»ç»Ÿæ‹’ç»åˆ†é…å†…å­˜ä¼šæŠ›å‡ºOutOfMemoryErrorå¼‚å¸¸ã€‚ reallocateMemory public long reallocateMemory(long address, long bytes); é€šè¿‡æŒ‡å®šçš„å†…å­˜åœ°å€addressé‡æ–°è°ƒæ•´æœ¬åœ°å†…å­˜å—çš„å¤§å°ï¼Œè°ƒæ•´åçš„å†…å­˜å—å¤§å°é€šè¿‡bytesæŒ‡å®š(å•ä½ä¸ºbyte)ã€‚å¯ä»¥é€šè¿‡freeMemoryæ–¹æ³•é‡Šæ”¾å†…å­˜å—ï¼Œæˆ–è€…é€šè¿‡reallocateMemoryæ–¹æ³•è°ƒæ•´å†…å­˜å—å¤§å°ã€‚byteså€¼ä¸ºè´Ÿæ•°æˆ–è€…è¿‡å¤§ä¼šæŠ›å‡ºIllegalArgumentExceptionå¼‚å¸¸ï¼Œå¦‚æœç³»ç»Ÿæ‹’ç»åˆ†é…å†…å­˜ä¼šæŠ›å‡ºOutOfMemoryErrorå¼‚å¸¸ã€‚ setMemory public void setMemory(Object o, long offset, long bytes, byte value); å°†ç»™å®šå†…å­˜å—ä¸­çš„æ‰€æœ‰å­—èŠ‚è®¾ç½®ä¸ºå›ºå®šå€¼(é€šå¸¸æ˜¯0)ã€‚å†…å­˜å—çš„åœ°å€ç”±å¯¹è±¡å¼•ç”¨oå’Œåç§»åœ°å€å…±åŒå†³å®šï¼Œå¦‚æœå¯¹è±¡å¼•ç”¨oä¸ºnullï¼Œoffsetå°±æ˜¯ç»å¯¹åœ°å€ã€‚ç¬¬ä¸‰ä¸ªå‚æ•°å°±æ˜¯å†…å­˜å—çš„å¤§å°ï¼Œå¦‚æœä½¿ç”¨allocateMemoryè¿›è¡Œå†…å­˜å¼€è¾Ÿçš„è¯ï¼Œè¿™é‡Œçš„å€¼åº”è¯¥å’ŒallocateMemoryçš„å‚æ•°ä¸€è‡´ã€‚valueå°±æ˜¯è®¾ç½®çš„å›ºå®šå€¼ï¼Œä¸€èˆ¬ä¸º0(è¿™é‡Œå¯ä»¥å‚è€ƒnettyçš„DirectByteBuffer)ã€‚ä¸€èˆ¬è€Œè¨€ï¼Œoä¸ºnullï¼Œæ‰€æœ‰æœ‰ä¸ªé‡è½½æ–¹æ³•æ˜¯public void setMemory(long offset, long bytes, byte value);ï¼Œç­‰æ•ˆäºsetMemory(null, long offset, long bytes, byte value);ã€‚ copyMemory public void copyMemory(Object srcBase, long srcOffset, Object destBase, long destOffset, long bytes) æ‹·è´ç»™å®šå†…å­˜åœ°å€çš„å­—èŠ‚é•¿åº¦å¯¹åº”çš„å­—èŠ‚åˆ°æŒ‡å®šå†…å­˜åœ°å€ä¸­ã€‚å¦‚æœsrcBaseæˆ–è€…destBaseä¸ºnullï¼Œåˆ™srcOffsetæˆ–è€…destOffsetåˆ†åˆ«æŒ‡ä»£ç»å¯¹åœ°å€ã€‚ å†…å­˜å±éšœ å†…å­˜å±éšœç›¸å…³çš„æ–¹æ³•æ˜¯åœ¨Jdk8æ·»åŠ çš„ã€‚å†…å­˜å±éšœç›¸å…³çš„çŸ¥è¯†å¯ä»¥å…ˆè‡ªè¡ŒæŸ¥é˜…ï¼Œç¬”è€…ç›®å‰ä¹Ÿæ²¡æœ‰æ·±å…¥äº†è§£ç›¸å…³çŸ¥è¯†ã€‚ loadFence public void loadFence(); åœ¨è¯¥æ–¹æ³•ä¹‹å‰çš„æ‰€æœ‰è¯»æ“ä½œï¼Œä¸€å®šåœ¨loadå±éšœä¹‹å‰æ‰§è¡Œå®Œæˆã€‚ storeFence public void storeFence(); åœ¨è¯¥æ–¹æ³•ä¹‹å‰çš„æ‰€æœ‰å†™æ“ä½œï¼Œä¸€å®šåœ¨storeå±éšœä¹‹å‰æ‰§è¡Œå®Œæˆ fullFence public void fullFence(); åœ¨è¯¥æ–¹æ³•ä¹‹å‰çš„æ‰€æœ‰è¯»å†™æ“ä½œï¼Œä¸€å®šåœ¨fullå±éšœä¹‹å‰æ‰§è¡Œå®Œæˆï¼Œè¿™ä¸ªå†…å­˜å±éšœç›¸å½“äºä¸Šé¢ä¸¤ä¸ª(loadå±éšœå’Œstoreå±éšœ)çš„åˆä½“åŠŸèƒ½ã€‚ å…¶å®ƒ invokeCleaner public void invokeCleaner(java.nio.ByteBuffer directBuffer) æ¸…ç©ºä½¿ç”¨äº†å †å¤–å†…å­˜çš„ByteBufferå®ä¾‹å æ®çš„å†…å­˜ï¼Œä¸€èˆ¬æ˜¯DirectBufferçš„å­ç±»ã€‚ throwException public void throwException(Throwable ee) ç»•è¿‡æ£€æµ‹æœºåˆ¶ç›´æ¥æŠ›å‡ºå¼‚å¸¸ã€‚ getLoadAverage public int getLoadAverage(double[] loadavg, int nelems); è·å–ç³»ç»Ÿçš„å¹³å‡è´Ÿè½½å€¼ï¼Œloadavgè¿™ä¸ªdoubleæ•°ç»„å°†ä¼šå­˜æ”¾è´Ÿè½½å€¼çš„ç»“æœï¼Œnelemså†³å®šæ ·æœ¬æ•°é‡ï¼Œnelemsåªèƒ½å–å€¼ä¸º1åˆ°3ï¼Œåˆ†åˆ«ä»£è¡¨æœ€è¿‘1ã€5ã€15åˆ†é’Ÿå†…ç³»ç»Ÿçš„å¹³å‡è´Ÿè½½ã€‚å¦‚æœæ— æ³•è·å–ç³»ç»Ÿçš„è´Ÿè½½ï¼Œæ­¤æ–¹æ³•è¿”å›-1ï¼Œå¦åˆ™è¿”å›è·å–åˆ°çš„æ ·æœ¬æ•°é‡(loadavgä¸­æœ‰æ•ˆçš„å…ƒç´ ä¸ªæ•°)ã€‚å®éªŒä¸­è¿™ä¸ªæ–¹æ³•ä¸€ç›´è¿”å›-1ï¼Œå…¶å®å®Œå…¨å¯ä»¥ä½¿ç”¨JMXä¸­çš„ç›¸å…³æ–¹æ³•æ›¿ä»£æ­¤æ–¹æ³•ã€‚ ä½¿ç”¨ä¾‹å­ å…ˆå°è£…ä¸€ä¸‹è·å–Unsafeå®ä¾‹çš„æ–¹æ³•ï¼š 12345private static Unsafe getUnsafe() throws Exception &#123; Field f = sun.misc.Unsafe.class.getDeclaredField(\"theUnsafe\"); f.setAccessible(true); return (Unsafe) f.get(null);&#125; é€šè¿‡å†…å­˜åœ°å€ç›´æ¥æ“ä½œå±æ€§ é€šè¿‡staticFieldOffsetå’ŒobjectFieldOffsetå¯ä»¥è·å–é™æ€å’Œéé™æ€æˆå‘˜å±æ€§çš„åç§»åœ°å€ï¼Œç„¶åç›´æ¥è¿›è¡Œå­˜å–å€¼æ“ä½œã€‚ 1234567891011121314151617181920212223242526272829303132public static class Simple &#123; static Integer STATIC_INT = 10086; Long longField = 1024L;&#125; public static void main(String[] args) throws Exception &#123; Unsafe unsafe = getUnsafe(); Field staticInt = Simple.class.getDeclaredField(\"STATIC_INT\"); staticInt.setAccessible(true); Object staticFieldBase = unsafe.staticFieldBase(staticInt); long staticFieldOffset = unsafe.staticFieldOffset(staticInt); // æ³¨æ„è¿™é‡Œä¸€å®šè¦getObject,getIntæ˜¯é’ˆå¯¹åŸå§‹ç±»å‹int,åŒ…è£…ç±»å‹è¦è‡ªå·±å¼ºè½¬ System.out.println(\"Sampleåˆå§‹åŒ–å‰,STATIC_INT = \" + unsafe.getObject(staticFieldBase, staticFieldOffset)); Simple simple = new Simple(); System.out.println(\"Sampleåˆå§‹åŒ–å,STATIC_INT = \" + unsafe.getObject(staticFieldBase, staticFieldOffset)); Field longField = Simple.class.getDeclaredField(\"longField\"); longField.setAccessible(true); long objectFieldOffset = unsafe.objectFieldOffset(longField); System.out.println(\"Sampleåˆå§‹åŒ–å,longField = \" + unsafe.getObject(simple, objectFieldOffset)); unsafe.putObject(simple,objectFieldOffset, 4201L); System.out.println(\"Sampleå±æ€§è¢«è¦†ç›–å,longField = \" + simple.longField); &#125;// è¾“å‡ºå¦‚ä¸‹ï¼šSampleåˆå§‹åŒ–å‰,STATIC_INT = nullSampleåˆå§‹åŒ–å,STATIC_INT = 10086Sampleåˆå§‹åŒ–å,longField = 1024Sampleå±æ€§è¢«è¦†ç›–å,longField = 4201 çº¿ç¨‹æŒ‚èµ·å’Œæ¢å¤ ä¸»è¦ä»‹ç»ä¸€ä¸‹parkå’Œunparkçš„ç”¨æ³•ï¼š 123456789101112131415161718192021 public static void main(String[] args) throws Exception &#123; Unsafe unsafe = getUnsafe(); Thread thread = new Thread(new Runnable() &#123; @Override public void run() &#123; System.out.println(\"çº¿ç¨‹park!\"); unsafe.park(false, 0); System.out.println(\"çº¿ç¨‹æ¢å¤è¿è¡Œ!\"); &#125; &#125;); thread.start(); TimeUnit.SECONDS.sleep(2); System.out.println(\"ä¸»çº¿ç¨‹unparké˜»å¡ç€çš„çº¿ç¨‹!\"); unsafe.unpark(thread); TimeUnit.SECONDS.sleep(Integer.MAX_VALUE); &#125;// è¿è¡Œåè¾“å‡ºï¼šçº¿ç¨‹park!ä¸»çº¿ç¨‹unparké˜»å¡ç€çš„çº¿ç¨‹!çº¿ç¨‹æ¢å¤è¿è¡Œ! å°ç»“ å­˜åœ¨å³åˆç†ï¼Œè™½ç„¶ä¸æ¨èä½¿ç”¨Unsafeï¼Œä½†æ˜¯å¦‚æœæœ‰éœ€è¦çš„è¿˜æ˜¯è¦æŒ¥åŠ¨è¿™æŠŠåŒåˆƒå‰‘ã€‚ å‚è€ƒèµ„æ–™ï¼š ä¸ºä»€ä¹ˆJUCä¸­å¤§é‡ä½¿ç”¨äº†sun.misc.Unsafe è¿™ä¸ªç±»ï¼Œä½†å®˜æ–¹å´ä¸å»ºè®®å¼€å‘è€…ä½¿ç”¨ï¼Ÿ JDK11ç›¸å…³æºç  Java Magic. Part 4: sun.misc.Unsafe (æœ¬æ–‡å®Œ e-a-20181213 c-3-d)","categories":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/tags/Java/"}]},{"title":"æ·±å…¥åˆ†æJavaåå°„(äº”)-ç±»å®ä¾‹åŒ–å’Œç±»åŠ è½½","slug":"java-reflection-class-load","date":"2018-12-09T07:58:40.000Z","updated":"2018-12-11T16:45:32.147Z","comments":true,"path":"2018/12/09/java-reflection-class-load/","link":"","permalink":"http://throwable.club/2018/12/09/java-reflection-class-load/","excerpt":"","text":"æ·±å…¥åˆ†æJavaåå°„(äº”)-ç±»å®ä¾‹åŒ–å’Œç±»åŠ è½½ å‰æ å…¶å®åœ¨å‰é¢å†™è¿‡çš„ã€Šæ·±å…¥åˆ†æJavaåå°„(ä¸€)-æ ¸å¿ƒç±»åº“å’Œæ–¹æ³•ã€‹å·²ç»ä»‹ç»è¿‡é€šè¿‡ç±»åæˆ–è€…java.lang.Classå®ä¾‹å»å®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡ï¼Œåœ¨ã€Šæµ…æJavaä¸­çš„èµ„æºåŠ è½½ã€‹ä¸­ä¹Ÿæ¯”è¾ƒè¯¦ç»†åœ°ä»‹ç»è¿‡ç±»åŠ è½½è¿‡ç¨‹ä¸­çš„åŒäº²å§”æ´¾æ¨¡å‹ï¼Œè¿™ç¯‡æ–‡ç« ä¸»è¦æ˜¯åŠ æ·±ä¸€äº›å¯¹ç±»å®ä¾‹åŒ–å’Œç±»åŠ è½½çš„è®¤è¯†ã€‚ ç±»å®ä¾‹åŒ– åœ¨åå°„ç±»åº“ä¸­ï¼Œç”¨äºå®ä¾‹åŒ–å¯¹è±¡åªæœ‰ä¸¤ä¸ªæ–¹æ³•ï¼š T java.lang.Class#newInstance()ï¼šè¿™ä¸ªæ–¹æ³•åªéœ€è¦æä¾›java.lang.Class&lt;T&gt;çš„å®ä¾‹å°±å¯ä»¥å®ä¾‹åŒ–å¯¹è±¡ï¼Œå¦‚æœæä¾›çš„æ˜¯æ— é™å®šç±»å‹Class&lt;?&gt;åˆ™å¾—åˆ°çš„æ˜¯Objectç±»å‹çš„è¿”å›å€¼ï¼Œå¯ä»¥è¿›è¡Œå¼ºè½¬ã€‚è¿™ä¸ªæ–¹æ³•ä¸æ”¯æŒä»»ä½•å…¥å‚ï¼Œåº•å±‚å®é™…ä¸Šä¹Ÿæ˜¯ä¾èµ–æ— å‚æ•°çš„æ„é€ å™¨Constructorè¿›è¡Œå®ä¾‹åŒ–ã€‚ T java.lang.reflect.Constructor#newInstance(Object ... initargs)ï¼šè¿™ä¸ªæ–¹æ³•éœ€è¦æä¾›java.lang.reflect.Constructor&lt;T&gt;å®ä¾‹å’Œä¸€ä¸ªå¯å˜å‚æ•°æ•°ç»„è¿›è¡Œå¯¹è±¡çš„å®ä¾‹åŒ–ï¼Œä¸Šé¢æåˆ°çš„T java.lang.Class#newInstance()åº•å±‚ä¹Ÿæ˜¯ä¾èµ–æ­¤æ–¹æ³•ã€‚è¿™ä¸ªæ–¹æ³•é™¤äº†å¯ä»¥ä¼ å…¥æ„é€ å‚æ•°ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªå¥½å¤„å°±æ˜¯å¯ä»¥é€šè¿‡``æŠ‘åˆ¶ä¿®é¥°ç¬¦è®¿é—®æƒé™æ£€æŸ¥ï¼Œä¹Ÿå°±æ˜¯ç§æœ‰çš„æ„é€ å™¨ä¹Ÿå¯ä»¥ç”¨äºå®ä¾‹åŒ–å¯¹è±¡ã€‚ åœ¨ç¼–å†™åå°„ç±»åº“çš„æ—¶å€™ï¼Œä¼˜å…ˆé€‰æ‹©T java.lang.reflect.Constructor#newInstance(Object ... initargs)è¿›è¡Œå¯¹è±¡å®ä¾‹åŒ–ï¼Œç›®å‰å‚è€ƒå¾ˆå¤šä¼˜ç§€çš„æ¡†æ¶(ä¾‹å¦‚Spring)éƒ½æ˜¯ç”¨è¿™ä¸ªæ–¹æ³•è¿›è¡Œå¯¹è±¡å®ä¾‹åŒ–ã€‚ ç±»åŠ è½½ ç±»åŠ è½½å®é™…ä¸Šç”±ç±»åŠ è½½å™¨(ClassLoader)å®Œæˆï¼Œprotected Class&lt;?&gt; java.lang.ClassLoader#loadClass(String name, boolean resolve)æ–¹æ³•æç°äº†ç±»åŠ è½½è¿‡ç¨‹ä¸­éµå¾ªäº†åŒäº²å§”æ´¾æ¨¡å‹ï¼Œå®é™…ä¸Šï¼Œæˆ‘ä»¬å¯ä»¥è¦†å†™æ­¤æ–¹æ³•å®Œå…¨ä¸éµå¾ªåŒäº²å§”æ´¾æ¨¡å‹ï¼Œå®ç°åŒä¸€ä¸ªç±»(è¿™é‡ŒæŒ‡çš„æ˜¯å…¨ç±»åå®Œå…¨ç›¸åŒ)é‡æ–°åŠ è½½ã€‚JDKä¸­æä¾›ç±»åŠ è½½ç›¸å…³çš„ç‰¹æ€§æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼š protected Class&lt;?&gt; java.lang.ClassLoader#loadClass(String name, boolean resolve)ï¼šé€šè¿‡ç±»åŠ è½½å™¨å®ä¾‹å»åŠ è½½ç±»ï¼Œä¸€èˆ¬åº”ç”¨ç±»è·¯å¾„ä¸‹çš„ç±»æ˜¯ç”±jdk.internal.loader.ClassLoaders$AppClassLoaderåŠ è½½ï¼Œä¹Ÿå¯ä»¥è‡ªè¡Œç»§æ‰¿java.lang.ClassLoaderå®ç°è‡ªå·±çš„ç±»åŠ è½½å™¨ã€‚ public static Class&lt;?&gt; forName(String name, boolean initialize, ClassLoader loader)ï¼šé€šè¿‡å…¨ç±»åè¿›è¡Œç±»åŠ è½½ï¼Œå¯ä»¥é€šè¿‡å‚æ•°æ§åˆ¶ç±»åˆå§‹åŒ–è¡Œä¸ºã€‚ ClassLoaderä¸­çš„ç±»åŠ è½½ ç±»åŠ è½½è¿‡ç¨‹å…¶å®æ˜¯ä¸€ä¸ªå¾ˆå¤æ‚çš„è¿‡ç¨‹ï¼Œä¸»è¦åŒ…æ‹¬ä¸‹é¢çš„æ­¥éª¤ï¼š 1ã€åŠ è½½è¿‡ç¨‹ï¼šä½¿ç”¨(è‡ªå®šä¹‰)ç±»åŠ è½½å™¨å»è·å–ç±»æ–‡ä»¶å­—èŠ‚ç å­—èŠ‚ç±»çš„è¿‡ç¨‹ï¼ŒClasså®ä¾‹åœ¨è¿™ä¸€æ­¥ç”Ÿæˆï¼Œä½œä¸ºæ–¹æ³•åŒºçš„å„ç§æ•°æ®ç±»å‹çš„è®¿é—®å…¥å£ã€‚ 2ã€éªŒè¯è¿‡ç¨‹ï¼šJVMéªŒè¯å­—èŠ‚ç çš„åˆæ³•æ€§ã€‚ 3ã€å‡†å¤‡è¿‡ç¨‹ï¼šä¸ºç±»å˜é‡åˆ†é…å†…å­˜å¹¶ä¸”è®¾ç½®åˆå§‹å€¼ã€‚ 4ã€è§£æè¿‡ç¨‹ï¼šJVMæŠŠå¸¸é‡æ± ä¸­çš„ç¬¦å·æ›¿æ¢ä¸ºç›´æ¥å¼•ç”¨ã€‚ 5ã€åˆå§‹åŒ–è¿‡ç¨‹ï¼šæ‰§è¡Œç±»æ„é€ å™¨&lt;cinit&gt;()æ–¹æ³•ï¼Œ&lt;cinit&gt;()æ–¹æ³•æ˜¯ç¼–è¯‘å™¨è‡ªåŠ¨æ”¶é›†æ‰€æœ‰ç±»å˜é‡çš„èµ‹å€¼åŠ¨ä½œå’Œé™æ€ä»£ç å—ä¸­çš„è¯­å¥åˆå¹¶ç”Ÿæˆï¼Œæ”¶é›†é¡ºåºç”±è¯­å¥åœ¨æºæ–‡ä»¶ä¸­å‡ºç°çš„é¡ºåºå†³å®šï¼ŒJVMä¿è¯åœ¨å­ç±»&lt;cinit&gt;()æ–¹æ³•è°ƒç”¨å‰çˆ¶ç±»çš„&lt;cinit&gt;()æ–¹æ³•å·²ç»æ‰§è¡Œå®Œæ¯•ã€‚ ClassLoader#loadClass()æ–¹æ³•å°±æ˜¯ç”¨äºæ§åˆ¶ç±»åŠ è½½è¿‡ç¨‹çš„ç¬¬ä¸€æ­¥-åŠ è½½è¿‡ç¨‹ï¼Œä¹Ÿå°±æ˜¯æ§åˆ¶å­—èŠ‚ç å­—èŠ‚æ•°ç»„å’Œç±»åç”ŸæˆClasså®ä¾‹çš„è¿‡ç¨‹ã€‚ClassLoaderä¸­è¿˜æœ‰ä¸€ä¸ªprotected final Class&lt;?&gt; defineClass(String name, byte[] b, int off, int len)æ–¹æ³•ç”¨äºæŒ‡å®šå…¨ç±»åå’Œå­—èŠ‚ç å­—èŠ‚æ•°ç»„å»å®šä¹‰ä¸€ä¸ªç±»ï¼Œæˆ‘ä»¬å†æ¬¡çœ‹ä¸‹loadClass()çš„æºç ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647protected Class&lt;?&gt; loadClass(String name, boolean resolve) throws ClassNotFoundException&#123; synchronized (getClassLoadingLock(name)) &#123; // æ£€æŸ¥ç±»æ˜¯å¦å·²ç»åŠ è½½è¿‡ï¼Œå¦‚æœå·²ç»åŠ è½½è¿‡ï¼Œåˆ™ç›´æ¥è¿”å› Class&lt;?&gt; c = findLoadedClass(name); if (c == null) &#123; long t0 = System.nanoTime(); // å§”æ´¾çˆ¶ç±»åŠ è½½å™¨å»åŠ è½½ç±» try &#123; if (parent != null) &#123; c = parent.loadClass(name, false); &#125; else &#123; c = findBootstrapClassOrNull(name); &#125; &#125; catch (ClassNotFoundException e) &#123; // ClassNotFoundException thrown if class not found // from the non-null parent class loader &#125; // å§”æ´¾çˆ¶ç±»åŠ è½½å™¨å¦‚æœåŠ è½½å¤±è´¥åˆ™è°ƒç”¨findClassæ–¹æ³•è¿›è¡ŒåŠ è½½åŠ¨ä½œ if (c == null) &#123; // If still not found, then invoke findClass in order // to find the class. long t1 = System.nanoTime(); c = findClass(name); // this is the defining class loader; record the stats PerfCounter.getParentDelegationTime().addTime(t1 - t0); PerfCounter.getFindClassTime().addElapsedTimeFrom(t1); PerfCounter.getFindClasses().increment(); &#125; &#125; if (resolve) &#123; resolveClass(c); &#125; return c; &#125;&#125;// æ‰©å±•ç‚¹-1protected Class&lt;?&gt; findClass(String name) throws ClassNotFoundException &#123; throw new ClassNotFoundException(name);&#125; // æ‰©å±•ç‚¹-2protected final void resolveClass(Class&lt;?&gt; c) &#123; if (c == null) &#123; throw new NullPointerException(); &#125;&#125; å®é™…ä¸Šï¼ŒloadClass()æ–¹æ³•ç•™ä¸‹äº†ä¸¤ä¸ªæ‰©å±•ç‚¹ç”¨äºæ”¹å˜ç±»åŠ è½½çš„è¡Œä¸ºï¼Œè€ŒfindClass()æ–¹æ³•å°±æ˜¯ç”¨äºæ‰©å±•çˆ¶ç±»åŠ è½½å™¨åŠ è½½å¤±è´¥çš„æƒ…å†µä¸‹ï¼Œå­ç±»åŠ è½½å™¨çš„è¡Œä¸ºã€‚å½“ç„¶ï¼Œå®é™…ä¸ŠClass&lt;?&gt; loadClass(String name, boolean resolve)æ–¹æ³•æ˜¯éfinalçš„æ–¹æ³•ï¼Œå¯ä»¥æ•´ä¸ªæ–¹æ³•è¦†å†™æ‰ï¼Œè¿™æ ·å­å°±æœ‰åŠæ³•å®Œå…¨æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶ã€‚ä½†æ˜¯æ³¨æ„ä¸€ç‚¹ï¼Œå³ä½¿æ‰“ç ´åŒäº²å§”æ´¾æœºåˆ¶ï¼Œå­ç±»åŠ è½½å™¨ä¹Ÿä¸å¯èƒ½é‡æ–°åŠ è½½ä¸€äº›ç”±Bootstrapç±»åŠ è½½å™¨åŠ è½½çš„ç±»åº“å¦‚java.lang.Stringï¼Œè¿™äº›æ˜¯ç”±JVMéªŒè¯å’Œä¿è¯çš„ã€‚è‡ªå®šä¹‰ç±»åŠ è½½å™¨çš„ä½¿ç”¨åœ¨ä¸‹ä¸€èŠ‚çš„&quot;ç±»é‡æ–°åŠ è½½&quot;ä¸­è¯¦ç»†å±•å¼€ã€‚ æœ€åè¿˜æœ‰ä¸¤ç‚¹ååˆ†é‡è¦ï¼š 1ã€å¯¹äºä»»æ„ä¸€ä¸ªç±»ï¼Œéƒ½éœ€è¦ç”±åŠ è½½å®ƒçš„ç±»åŠ è½½å™¨å’Œè¿™ä¸ªç±»æœ¬èº«ä¸€èµ·ç¡®ç«‹å…¶åœ¨Javaè™šæ‹Ÿæœºä¸­çš„å”¯ä¸€æ€§ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªç±»åœ¨JVMä¸­çš„ç­¾åæ˜¯åŠ è½½å®ƒçš„ç±»åŠ è½½å™¨å’Œå®ƒæœ¬èº«ï¼Œå¯¹äºæ¯ä¸€ä¸ªç±»åŠ è½½å™¨ï¼Œéƒ½æ‹¥æœ‰ä¸€ä¸ªç‹¬ç«‹çš„ç±»å‘½åç©ºé—´ã€‚ 2ã€æ¯”è¾ƒä¸¤ä¸ªç±»æ˜¯å¦&quot;ç›¸ç­‰&quot;ï¼Œåªæœ‰è¿™ä¸¤ä¸ªç±»æ˜¯ç”±åŒä¸€ä¸ªç±»åŠ è½½å™¨åŠ è½½çš„å‰æä¸‹æ‰æœ‰æ„ä¹‰ã€‚å³ä½¿è¿™ä¸¤ä¸ªç±»çš„å…¨ç±»åä¸€è‡´ã€æ¥æºäºåŒä¸€ä¸ªå­—èŠ‚ç æ–‡ä»¶ã€è¢«åŒä¸€ä¸ªJavaè™šæ‹ŸæœºåŠ è½½ï¼Œä½†æ˜¯åŠ è½½å®ƒä»¬çš„ç±»åŠ è½½å™¨ä¸åŒï¼Œé‚£ä¹ˆå®ƒä»¬å¿…å®šä¸ç›¸ç­‰ã€‚è¿™é‡Œç›¸ç­‰çš„èŒƒç•´åŒ…æ‹¬ï¼šClasså¯¹è±¡çš„equals()æ–¹æ³•ã€isAssignableForm()æ–¹æ³•ã€isInstance()æ–¹æ³•çš„è¿”å›ç»“æœä»¥åŠä½¿ç”¨instanceofå…³é”®å­—åšå¯¹è±¡æ‰€å±å…³ç³»æ—¶å€™çš„åˆ¤å®šç­‰æƒ…å†µã€‚ Classä¸­çš„ç±»åŠ è½½ java.lang.Classä¸­çš„ç±»åŠ è½½ä¸»è¦ç”±public static Class&lt;?&gt; forName(String name, boolean initialize, ClassLoader loader)æ–¹æ³•å®Œæˆï¼Œè¯¥æ–¹æ³•å¯ä»¥æŒ‡å®šå…¨ç±»åã€æ˜¯å¦åˆå§‹åŒ–å’Œç±»åŠ è½½å™¨å®ä¾‹ã€‚æºç å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425@CallerSensitivepublic static Class&lt;?&gt; forName(String name, boolean initialize, ClassLoader loader) throws ClassNotFoundException&#123; Class&lt;?&gt; caller = null; SecurityManager sm = System.getSecurityManager(); if (sm != null) &#123; // Reflective call to get caller class is only needed if a security manager // is present. Avoid the overhead of making this call otherwise. caller = Reflection.getCallerClass(); if (loader == null) &#123; ClassLoader ccl = ClassLoader.getClassLoader(caller); if (ccl != null) &#123; sm.checkPermission( SecurityConstants.GET_CLASSLOADER_PERMISSION); &#125; &#125; &#125; return forName0(name, initialize, loader, caller);&#125;private static native Class&lt;?&gt; forName0(String name, boolean initialize, ClassLoader loader, Class&lt;?&gt; caller) throws ClassNotFoundException; å®ƒæœ€ç»ˆè°ƒç”¨çš„æ˜¯JVMçš„æœ¬åœ°æ¥å£æ–¹æ³•ï¼Œç”±äºæš‚æ—¶æ²¡æœ‰èƒ½åŠ›åˆ†æJVMçš„æºç ï¼Œåªèƒ½é€šè¿‡forNameæ–¹æ³•çš„æ³¨é‡Šç†è§£æ–¹æ³•çš„åŠŸèƒ½ï¼š è¿”å›ç»™å®šå­—ç¬¦ä¸²å…¨é™å®šåç§°ã€æŒ‡å®šç±»åŠ è½½å™¨çš„ç±»æˆ–è€…æ¥å£çš„Classå®ä¾‹ï¼Œæ­¤æ–¹æ³•ä¼šå°è¯•å¯¹ç±»æˆ–è€…æ¥å£è¿›è¡Œlocateã€load and linkæ“ä½œï¼Œå¦‚æœloaderå‚æ•°ä¸ºnullï¼Œåˆ™ä½¿ç”¨bootstrapç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½ï¼Œå¦‚æœinitializeå‚æ•°ä¸ºtrueåŒæ—¶ç±»æˆ–è€…æ¥å£åœ¨æ—©æœŸæ²¡æœ‰è¢«åˆå§‹åŒ–ï¼Œåˆ™ä¼šè¿›è¡Œåˆå§‹åŒ–æ“ä½œã€‚ ä¹Ÿå°±æ˜¯è¯´initializeå‚æ•°å¯¹äºå·²ç»åˆå§‹åŒ–è¿‡çš„ç±»æˆ–è€…æ¥å£æ¥è¯´æ˜¯æ²¡æœ‰æ„ä¹‰çš„ã€‚è¿™ä¸ªæ–¹æ³•çš„ç‰¹æ€§è¿˜å¯ä»¥å‚è€ƒJavaè¯­è¨€è§„èŒƒçš„12ç« ä¸­çš„å†…å®¹ï¼Œè¿™é‡Œä¸åšå±•å¼€ã€‚ è™½ç„¶æš‚æ—¶æ²¡æ³•åˆ†æJVMæœ¬åœ°æ¥å£æ–¹æ³•native Class&lt;?&gt; forName0()çš„åŠŸèƒ½ï¼Œä½†æ˜¯å®ƒä¾èµ–ä¸€ä¸ªç±»åŠ è½½å™¨å®ä¾‹å…¥å‚ï¼Œå¯ä»¥å¤§èƒ†çŒœæµ‹å®ƒä¹Ÿæ˜¯ä¾èµ–äºç±»åŠ è½½å™¨çš„loadClass()è¿›è¡Œç±»åŠ è½½çš„ã€‚ ç±»é‡æ–°åŠ è½½ å…ˆæå‡ºä¸€ä¸ªå®éªŒï¼Œå¦‚æœå®šä¹‰ä¸€ä¸ªç±»å¦‚ä¸‹ï¼š 123456public class Sample &#123; public void say() &#123; System.out.println(\"Hello Doge!\"); &#125;&#125; å¦‚æœä½¿ç”¨å­—èŠ‚ç å·¥å…·ä¿®æ”¹say()æ–¹æ³•çš„å†…å®¹ä¸ºSystem.out.println(&quot;Hello Throwable!&quot;);ï¼Œå¹¶ä¸”ä½¿ç”¨è‡ªå®šä¹‰çš„ClassLoaderé‡æ–°åŠ è½½ä¸€ä¸ªåŒç±»åçš„Sampleç±»ï¼Œé‚£ä¹ˆé€šè¿‡newå…³é”®å­—å®ä¾‹åŒ–å‡ºæ¥çš„Sampleå¯¹è±¡è°ƒç”¨say()åˆ°åº•æ‰“å°&quot;Hello Doge!â€œè¿˜æ˜¯&quot;Hello Throwable!â€ï¼Ÿ å…ˆå¼•å…¥å­—èŠ‚ç å·¥å…·javassistç”¨äºä¿®æ”¹ç±»çš„å­—èŠ‚ç ï¼š 12345&lt;dependency&gt; &lt;groupId&gt;org.javassist&lt;/groupId&gt; &lt;artifactId&gt;javassist&lt;/artifactId&gt; &lt;version&gt;3.24.0-GA&lt;/version&gt;&lt;/dependency&gt; ä¸‹é¢æ˜¯æµ‹è¯•ä»£ç ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647// ä¾‹å­public class Demo &#123; public void say() &#123; System.out.println(\"Hello Doge!\"); &#125;&#125;// ä¸€æ¬¡æ€§ä½¿ç”¨çš„è‡ªå®šä¹‰ç±»åŠ è½½å™¨public class CustomClassLoader extends ClassLoader &#123; private final byte[] data; public CustomClassLoader(byte[] data) &#123; this.data = data; &#125; @Override public Class&lt;?&gt; loadClass(String name) throws ClassNotFoundException &#123; if (!Demo.class.getName().equals(name)) &#123; return super.loadClass(name); &#125; return defineClass(name, data, 0, data.length); &#125;&#125;public class Main &#123; public static void main(String[] args) throws Exception &#123; String name = Demo.class.getName(); CtClass ctClass = ClassPool.getDefault().getCtClass(name); CtMethod method = ctClass.getMethod(\"say\", \"()V\"); method.setBody(\"&#123;System.out.println(\\\"Hello Throwable!\\\");&#125;\"); byte[] bytes = ctClass.toBytecode(); CustomClassLoader classLoader = new CustomClassLoader(bytes); // æ–°çš„Demoç±»,åªèƒ½åå°„è°ƒç”¨,å› ä¸ºç±»è·¯å¾„ä¸­çš„Demoç±»å·²ç»è¢«åº”ç”¨ç±»åŠ è½½å™¨åŠ è½½ Class&lt;?&gt; newDemoClass = classLoader.loadClass(name); // ç±»è·¯å¾„ä¸­çš„Demoç±» Demo demo = new Demo(); demo.say(); // æ–°çš„Demoç±» newDemoClass.getDeclaredMethod(\"say\").invoke(newDemoClass.newInstance()); // æ¯”è¾ƒ System.out.println(newDemoClass.equals(Demo.class)); &#125;&#125; æ‰§è¡Œåè¾“å‡ºï¼š 123Hello Doge!Hello Throwable!false è¿™é‡Œå¾—å‡ºçš„ç»“è®ºæ˜¯ï¼š newå…³é”®å­—åªèƒ½ä½¿ç”¨åœ¨å½“å‰ç±»è·¯å¾„ä¸‹çš„ç±»çš„å®ä¾‹åŒ–ï¼Œè€Œè¿™äº›ç±»éƒ½æ˜¯ç”±åº”ç”¨ç±»åŠ è½½å™¨åŠ è½½ï¼Œå¦‚æœä¸Šé¢çš„ä¾‹å­ä¸­newDemoClass.newInstance()å¼ºåˆ¶è½¬æ¢ä¸ºDemoç±»å‹ä¼šæŠ¥é”™ã€‚ é€šè¿‡è‡ªå®šä¹‰ç±»åŠ è½½å™¨åŠ è½½çš„å’Œå½“å‰ç±»è·¯å¾„ç›¸åŒåå…¨ç±»åçš„ç±»åªèƒ½é€šè¿‡åå°„å»ä½¿ç”¨ï¼Œè€Œä¸”å³ä½¿å…¨ç±»åç›¸åŒï¼Œç”±äºç±»åŠ è½½å™¨éš”ç¦»ï¼Œå®ƒä»¬å…¶å®æ˜¯ä¸ç›¸åŒçš„ç±»ã€‚ å¦‚ä½•é¿å…ç±»é‡æ–°åŠ è½½å¯¼è‡´å†…å­˜æº¢å‡º å®é™…ä¸Šï¼ŒJDKæ²¡æœ‰æä¾›æ–¹æ³•å»å¸è½½ä¸€ä¸ªå·²ç»åŠ è½½çš„ç±»ï¼Œä¹Ÿå°±æ˜¯ç±»çš„ç”Ÿå‘½å‘¨æœŸæ˜¯ç”±JVMç®¡ç†çš„ï¼Œå› æ­¤è¦è§£å†³ç±»é‡æ–°åŠ è½½å¯¼è‡´å†…å­˜æº¢å‡ºçš„é—®é¢˜å½’æ ¹ç»“åº•å°±æ˜¯è§£å†³é‡æ–°åŠ è½½çš„ç±»è¢«å›æ”¶çš„é—®é¢˜ã€‚ç”±äºåˆ›å»ºå‡ºæ¥æ˜¯çš„java.lang.Classå¯¹è±¡ï¼Œå¦‚æœéœ€è¦å›æ”¶å®ƒï¼Œåˆ™è¦è€ƒè™‘ä¸‹é¢å‡ ç‚¹ï¼š 1ã€java.lang.Classå¯¹è±¡åå°„åˆ›å»ºçš„å®ä¾‹éœ€è¦è¢«å›æ”¶ã€‚ 2ã€java.lang.Classå¯¹è±¡ä¸èƒ½è¢«ä»»ä½•åœ°æ–¹å¼ºå¼•ç”¨ã€‚ 3ã€åŠ è½½java.lang.Classå¯¹è±¡çš„ClassLoderå·²ç»è¢«å›æ”¶ã€‚ åŸºäºè¿™å‡ ç‚¹è€ƒè™‘å¯ä»¥åšä¸ªè¯•éªŒéªŒè¯ä¸€ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445public class Demo &#123; // è¿™é‡Œæ•…æ„å»ºç«‹ä¸€ä¸ªæ•°ç»„å ç”¨å¤§é‡å†…å­˜ private int[] array = new int[1000]; public void say() &#123; System.out.println(\"Hello Doge!\"); &#125;&#125;public class Main &#123; private static final Map&lt;ClassLoader, List&lt;Class&lt;?&gt;&gt;&gt; CACHE = new HashMap&lt;&gt;(); public static void main(String[] args) throws Exception &#123; String name = Demo.class.getName(); CtClass ctClass = ClassPool.getDefault().getCtClass(name); CtMethod method = ctClass.getMethod(\"say\", \"()V\"); method.setBody(\"&#123;System.out.println(\\\"Hello Throwable!\\\");&#125;\"); for (int i = 0; i &lt; 100000; i++) &#123; byte[] bytes = ctClass.toBytecode(); CustomClassLoader classLoader = new CustomClassLoader(bytes); // æ–°çš„Demoç±»,åªèƒ½åå°„è°ƒç”¨,å› ä¸ºç±»è·¯å¾„ä¸­çš„Demoç±»å·²ç»è¢«åº”ç”¨ç±»åŠ è½½å™¨åŠ è½½ Class&lt;?&gt; newDemoClass = classLoader.loadClass(name); add(classLoader, newDemoClass); &#125; // æ¸…ç†ç±»åŠ è½½å™¨å’Œå®ƒåŠ è½½è¿‡çš„ç±» clear(); System.gc(); Thread.sleep(Integer.MAX_VALUE); &#125; private static void add(ClassLoader classLoader, Class&lt;?&gt; clazz) &#123; if (CACHE.containsKey(classLoader)) &#123; CACHE.get(classLoader).add(clazz); &#125; else &#123; List&lt;Class&lt;?&gt;&gt; classes = new ArrayList&lt;&gt;(); CACHE.put(classLoader, classes); classes.add(clazz); &#125; &#125; private static void clear() &#123; CACHE.clear(); &#125;&#125; ä½¿ç”¨VMå‚æ•°-XX:+PrintGC -XX:+PrintGCDetailsæ‰§è¡Œä¸Šé¢çš„æ–¹æ³•ï¼ŒJDK11é»˜è®¤ä½¿ç”¨G1æ”¶é›†å™¨ï¼Œç”±äºZæ”¶é›†å™¨è¿˜åœ¨å®éªŒé˜¶æ®µï¼Œä¸æ˜¯å¾ˆå»ºè®®ä½¿ç”¨ï¼Œæ‰§è¡Œmainæ–¹æ³•åè¾“å‡ºï¼š 123456789101112131415161718[11.374s][info ][gc,task ] GC(17) Using 8 workers of 8 for full compaction[11.374s][info ][gc,start ] GC(17) Pause Full (System.gc())[11.374s][info ][gc,phases,start] GC(17) Phase 1: Mark live objects[11.429s][info ][gc,stringtable ] GC(17) Cleaned string and symbol table, strings: 5637 processed, 0 removed, symbols: 135915 processed, 0 removed[11.429s][info ][gc,phases ] GC(17) Phase 1: Mark live objects 54.378ms[11.429s][info ][gc,phases,start] GC(17) Phase 2: Prepare for compaction[11.429s][info ][gc,phases ] GC(17) Phase 2: Prepare for compaction 0.422ms[11.429s][info ][gc,phases,start] GC(17) Phase 3: Adjust pointers[11.430s][info ][gc,phases ] GC(17) Phase 3: Adjust pointers 0.598ms[11.430s][info ][gc,phases,start] GC(17) Phase 4: Compact heap[11.430s][info ][gc,phases ] GC(17) Phase 4: Compact heap 0.362ms[11.648s][info ][gc,heap ] GC(17) Eden regions: 44-&gt;0(9)[11.648s][info ][gc,heap ] GC(17) Survivor regions: 12-&gt;0(12)[11.648s][info ][gc,heap ] GC(17) Old regions: 146-&gt;7[11.648s][info ][gc,heap ] GC(17) Humongous regions: 3-&gt;2[11.648s][info ][gc,metaspace ] GC(17) Metaspace: 141897K-&gt;9084K(1062912K)[11.648s][info ][gc ] GC(17) Pause Full (System.gc()) 205M-&gt;3M(30M) 273.440ms[11.648s][info ][gc,cpu ] GC(17) User=0.31s Sys=0.08s Real=0.27s å¯è§FullGCä¹‹åï¼Œå…ƒç©ºé—´(Metaspace)å›æ”¶äº†(141897-9084)KBï¼Œä¸€å…±å›æ”¶äº†202Mçš„å†…å­˜ç©ºé—´ï¼Œåˆæ­¥å¯ä»¥è®¤ä¸ºå…ƒç©ºé—´çš„å†…å­˜è¢«å›æ”¶äº†ï¼Œæ¥ä¸‹æ¥æ³¨é‡Šæ‰mainæ–¹æ³•ä¸­è°ƒç”¨çš„clear()æ–¹æ³•ï¼Œå†è°ƒç”¨ä¸€æ¬¡mainæ–¹æ³•ï¼š 12345....[4.083s][info ][gc,heap ] GC(17) Humongous regions: 3-&gt;2[4.083s][info ][gc,metaspace ] GC(17) Metaspace: 141884K-&gt;141884K(1458176K)[4.083s][info ][gc ] GC(17) Pause Full (System.gc()) 201M-&gt;166M(564M) 115.504ms[4.083s][info ][gc,cpu ] GC(17) User=0.84s Sys=0.00s Real=0.12s å¯è§å…ƒç©ºé—´åœ¨FullGCæ‰§è¡Œæ²¡æœ‰è¿›è¡Œå›æ”¶ï¼Œè€Œå †å†…å­˜çš„å›æ”¶ç‡ä¹Ÿæ¯”è¾ƒä½ï¼Œç”±æ­¤å¯ä»¥å¾—å‡ºä¸€ä¸ªç»éªŒæ€§çš„ç»“è®ºï¼šåªéœ€è¦é€šè¿‡ClassLoaderå¯¹è±¡åšæ˜ å°„å…³ç³»ä¿å­˜ä½¿ç”¨å®ƒåŠ è½½å‡ºæ¥çš„æ–°çš„ç±»ï¼Œåªéœ€è¦ç¡®ä¿è¿™äº›ç±»æ²¡æœ‰æ²¡å¼ºå¼•ç”¨ã€ç±»å®ä¾‹éƒ½å·²ç»é”€æ¯ï¼Œé‚£ä¹ˆåªéœ€è¦ç§»é™¤ClassLoaderå¯¹è±¡çš„å¼•ç”¨ï¼Œé‚£ä¹ˆåœ¨JVMè¿›è¡ŒGCçš„æ—¶å€™ä¼šæŠŠClassLoaderå¯¹è±¡ä»¥åŠä½¿ç”¨å®ƒåŠ è½½çš„ç±»å›æ”¶ï¼Œè¿™æ ·åšå°±å¯ä»¥é¿å…å…ƒç©ºé—´çš„å†…å­˜æ³„æ¼ã€‚ å°ç»“ é€šè¿‡ä¸€äº›èµ„æ–™å’Œå®éªŒï¼Œæ·±åŒ–äº†ç±»åŠ è½½è¿‡ç¨‹çš„ä¸€äº›è®¤è¯†ã€‚ å‚è€ƒèµ„æ–™ï¼š ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœº-ç¬¬äºŒç‰ˆã€‹ JDK11éƒ¨åˆ†æºç  (æœ¬æ–‡å®Œ e-2018129 c-2-d r-20181212)","categories":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/categories/Java/"},{"name":"Reflection","slug":"Java/Reflection","permalink":"http://throwable.club/blog/categories/Java/Reflection/"}],"tags":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/tags/Java/"},{"name":"Reflection","slug":"Reflection","permalink":"http://throwable.club/blog/tags/Reflection/"}]},{"title":"æ·±å…¥åˆ†æJavaåå°„(å››)-åŠ¨æ€ä»£ç†","slug":"java-reflection-dynamic-proxy","date":"2018-12-08T12:25:06.000Z","updated":"2018-12-08T12:25:34.127Z","comments":true,"path":"2018/12/08/java-reflection-dynamic-proxy/","link":"","permalink":"http://throwable.club/2018/12/08/java-reflection-dynamic-proxy/","excerpt":"","text":"æ·±å…¥åˆ†æJavaåå°„(å››)-åŠ¨æ€ä»£ç† åŠ¨æ€ä»£ç†çš„ç®€ä»‹ JavaåŠ¨æ€ä»£ç†æœºåˆ¶çš„å‡ºç°ï¼Œä½¿å¾—Javaå¼€å‘äººå‘˜ä¸ç”¨æ‰‹å·¥ç¼–å†™ä»£ç†ç±»ï¼Œåªè¦ç®€å•åœ°æŒ‡å®šä¸€ç»„æ¥å£åŠå§”æ‰˜ç±»å¯¹è±¡ï¼Œä¾¿èƒ½åŠ¨æ€åœ°è·å¾—ä»£ç†ç±»ã€‚ä»£ç†ç±»ä¼šè´Ÿè´£å°†æ‰€æœ‰çš„æ–¹æ³•è°ƒç”¨åˆ†æ´¾åˆ°å§”æ‰˜å¯¹è±¡ä¸Šåå°„æ‰§è¡Œï¼Œåœ¨åˆ†æ´¾æ‰§è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œå¼€å‘äººå‘˜è¿˜å¯ä»¥æŒ‰éœ€è°ƒæ•´å§”æ‰˜ç±»å¯¹è±¡åŠå…¶åŠŸèƒ½ï¼Œè¿™æ˜¯ä¸€å¥—éå¸¸çµæ´»æœ‰å¼¹æ€§çš„ä»£ç†æ¡†æ¶ã€‚JavaåŠ¨æ€ä»£ç†å®é™…ä¸Šé€šè¿‡åå°„æŠ€æœ¯ï¼ŒæŠŠä»£ç†å¯¹è±¡å’Œè¢«ä»£ç†å¯¹è±¡(çœŸå®å¯¹è±¡)çš„ä»£ç†å…³ç³»å»ºç«‹å»¶è¿Ÿåˆ°ç¨‹åºè¿è¡Œä¹‹åï¼ŒåŠ¨æ€åˆ›å»ºæ–°çš„ä»£ç†ç±»å»å®Œæˆå¯¹çœŸå®å¯¹è±¡çš„ä»£ç†æ“ä½œ(å¯ä»¥æ”¹å˜åŸæ¥çœŸå®å¯¹è±¡çš„æ–¹æ³•è¡Œä¸º)ï¼Œè¿™ä¸€ç‚¹æˆä¸ºäº†å½“å‰ä¸»æµçš„AOPæ¡†æ¶å’Œå»¶è¿ŸåŠ è½½åŠŸèƒ½çš„åŸºç¡€ã€‚æœ¬æ–‡åœ¨æŸ¥çœ‹å’Œç¼–å†™åŠ¨æ€ä»£ç†ç›¸å…³çš„ä»£ç ä½¿ç”¨çš„æ˜¯JDK11ï¼Œä¸è¿‡JDKåŠ¨æ€ä»£ç†ç›¸å…³çš„åŠŸèƒ½å’Œæ¥å£å·²ç»ç›¸å¯¹ç¨³å®šï¼Œä¸å¿…æ‹…å¿ƒJDKç‰ˆæœ¬å‡çº§å¸¦æ¥çš„å…¼å®¹æ€§é—®é¢˜ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„ç”±äºJDK9å¼•å…¥äº†æ¨¡å—æ¦‚å¿µï¼ŒåŠ¨æ€ä»£ç†çš„æºç ä¹Ÿæœ‰ä¸å°‘çš„æ”¹åŠ¨ã€‚ä¸‹æ–‡å…ˆä»‹ç»è®¾è®¡æ¨¡å¼ä¸­çš„ä»£ç†æ¨¡å¼ï¼Œæ¥ç€ä¼šåˆ†æJDKåŠ¨æ€ä»£ç†çš„æ ¸å¿ƒç±»åº“ã€æµç¨‹å’Œæœºåˆ¶ï¼Œæœ€ååˆ†æå…¶åº•å±‚æºç çº§åˆ«å®ç°ã€‚ è®¾è®¡æ¨¡å¼ä¸­çš„ä»£ç†æ¨¡å¼ ä»£ç†æ¨¡å¼æ˜¯ä¸€ç§å¸¸ç”¨çš„è®¾è®¡æ¨¡å¼ï¼Œå…¶ç›®çš„å°±æ˜¯ä¸ºå…¶ä»–å¯¹è±¡æä¾›ä¸€ä¸ªä»£ç†ä»¥æ§åˆ¶å¯¹æŸä¸ªå¯¹è±¡çš„è®¿é—®ã€‚ä»£ç†ç±»è´Ÿè´£ä¸ºå§”æ‰˜ç±»é¢„å¤„ç†æ¶ˆæ¯ï¼Œè¿‡æ»¤æ¶ˆæ¯å¹¶è½¬å‘æ¶ˆæ¯ï¼Œä»¥åŠè¿›è¡Œæ¶ˆæ¯è¢«å§”æ‰˜ç±»æ‰§è¡Œåçš„åç»­å¤„ç†ã€‚ ä»£ç†æ¨¡å¼ä¸»è¦åŒ…æ‹¬ä¸‰ç§è§’è‰²ï¼š SubjectæŠ½è±¡ä¸»é¢˜è§’è‰²ï¼šä¸€èˆ¬å®šä¹‰ä¸ºæŠ½è±¡ç±»æˆ–è€…æ¥å£ï¼Œæ˜¯ä½œä¸ºåŠŸèƒ½çš„å®šä¹‰ï¼Œæä¾›ä¸€ç³»åˆ—æŠ½è±¡çš„åŠŸèƒ½æ–¹æ³•ã€‚ RealSubjectå…·ä½“(çœŸå®)ä¸»é¢˜è§’è‰²ï¼šä¸€èˆ¬ç§°ä¸ºè¢«å§”æ‰˜è§’è‰²æˆ–è€…è¢«ä»£ç†è§’è‰²ï¼Œå®ƒæ˜¯Subjectçš„ä¸€ä¸ªå…·ä½“å®ç°ã€‚ ProxySubjectä»£ç†ä¸»é¢˜è§’è‰²ï¼šä¸€èˆ¬ç§°ä¸ºå§”æ‰˜è§’è‰²æˆ–è€…ä»£ç†è§’è‰²ï¼Œä¸€èˆ¬ProxySubjectä¹Ÿå®ç°(æˆ–è€…ç»§æ‰¿)Subjectï¼Œæ¥æ”¶ä¸€ä¸ªå…·ä½“çš„Subjectå®ä¾‹RealSubjectï¼Œåœ¨RealSubjectå¤„ç†å‰ååšé¢„å®šä¹‰æˆ–è€…åç½®æ“ä½œï¼Œç”šè‡³å¯ä»¥ç›´æ¥å¿½ç•¥RealSubjectåŸæ¥çš„æ–¹æ³•ã€‚ æŠŠä¸Šé¢çš„ç±»å›¾ç¼–å†™æˆä»£ç å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940public interface Subject &#123; void doSomething();&#125;public class RealSubject implements Subject &#123; @Override public void doSomething() &#123; System.out.println(\"RealSubject doSomething...\"); &#125;&#125;public class ProxySubject implements Subject &#123; private final Subject subject; public ProxySubject(Subject subject) &#123; this.subject = subject; &#125; @Override public void doSomething() &#123; subject.doSomething(); doOtherThing(); &#125; private void doOtherThing() &#123; System.out.println(\"ProxySubject doOtherThing...\"); &#125;&#125;public class Client &#123; public static void main(String[] args) throws Exception &#123; Subject subject = new RealSubject(); ProxySubject proxySubject = new ProxySubject(subject); proxySubject.doSomething(); &#125;&#125; è¿è¡ŒClient#main()è¾“å‡ºï¼š 12RealSubject doSomething...ProxySubject doOtherThing... ä»£ç†æ¨¡å¼åœ¨æ—¥å¸¸çš„åœºæ™¯ä¸­ä¹Ÿç»å¸¸ç¢°åˆ°ï¼Œæ¯”è¾ƒå¸¸è§çš„ä¸€ä¸ªåœºæ™¯å°±æ˜¯æ¸¸æˆä»£ç»ƒï¼Œå¥—è¿›å»ä¸Šé¢çš„ä»£ç å¯ä»¥å†™ä¸ªæ¯”è¾ƒç”ŸåŠ¨çš„ä¾‹å­ï¼š 123456789101112131415161718192021222324252627282930313233343536public interface Player &#123; void playGame();&#125;public class I implements Player &#123; @Override public void playGame() &#123; System.out.println(\"æ“ä½œThrowableæ¸¸æˆè§’è‰²æ‰“æ€ªå‡çº§\"); &#125;&#125;public class ProxyPlayer implements Player &#123; private final Player player; public ProxyPlayer(Player player) &#123; this.player = player; &#125; @Override public void playGame() &#123; login(); this.player.playGame(); logout(); &#125; private void login() &#123; System.out.println(\"ç™»å½•Throwableæ¸¸æˆè§’è‰²\"); &#125; private void logout() &#123; System.out.println(\"é€€å‡ºThrowableæ¸¸æˆè§’è‰²\"); &#125;&#125; ä»£ç†æ¨¡å¼æœ‰å‡ ä¸ªæ¯”è¾ƒå¤§çš„ä¼˜ç‚¹ï¼š èŒè´£æ¸…æ™°ï¼šä¹Ÿå°±æ˜¯çœŸå®ä¸»é¢˜è§’è‰²åªéœ€è¦å®ç°å…·ä½“çš„é€»è¾‘ï¼Œä¸éœ€å…³æ³¨ä»£ç†ç±»çš„èŒè´£ï¼Œè€Œä»£ç†ç±»ä¹Ÿåªéœ€è¦å¤„ç†é¢„å¤„ç†å’Œåç½®çš„é€»è¾‘ï¼Œç±»çš„èŒè´£åˆ†æ˜ã€‚ é«˜æ‰©å±•æ€§ï¼šç”±äºèŒè´£åˆ†æ˜ï¼Œä¹Ÿå°±æ˜¯çœŸå®ä¸»é¢˜è§’è‰²å¯ä»¥éšæ—¶ä¿®æ”¹å®ç°ï¼Œè¿™æ ·å°±èƒ½é€šè¿‡æ›´æ–°æˆ–è€…æ›¿æ¢çœŸå®ä¸»é¢˜çš„å®ç°å¹¶ä¸”ä¸æ”¹å˜ä»£ç†ä¸»é¢˜è§’è‰²çš„æƒ…å†µä¸‹æ”¹å˜å…·ä½“åŠŸèƒ½ã€‚ é«˜çµæ´»æ€§ï¼šä¸»è¦ä½“ç°åœ¨åé¢æåˆ°çš„åŠ¨æ€ä»£ç†ã€‚ JDKåŠ¨æ€ä»£ç†çš„æ ¸å¿ƒAPI JDKåŠ¨æ€ä»£ç†æä¾›å¤–éƒ¨ä½¿ç”¨çš„ä¸»è¦ä¾èµ–ä¸¤ä¸ªç±»ï¼š java.lang.reflect.Proxyï¼šå¯ä»¥ç†è§£ä¸ºä»£ç†ç±»çš„å·¥å‚ç±»(å…¶å®ä¹Ÿæ˜¯çˆ¶ç±»ï¼Œè§ä¸‹æ–‡)ã€‚ java.lang.reflect.InvocationHandlerï¼šä»£ç†å®ä¾‹éœ€è¦å®ç°çš„è°ƒç”¨å¤„ç†å™¨æ¥å£ã€‚ Proxy java.lang.reflect.Proxyæ˜¯JDKåŠ¨æ€ä»£ç†çš„æ ¸å¿ƒç±»ï¼Œå®ƒçš„æ ¸å¿ƒåŠŸèƒ½æ˜¯æä¾›é™æ€æ–¹æ³•æ¥ä¸ºä¸€ç»„æ¥å£åŠ¨æ€åœ°ç”Ÿæˆä»£ç†ç±»å¹¶ä¸”è¿”å›ä»£ç†å®ä¾‹å¯¹è±¡ï¼Œç±»ä¼¼äºä»£ç†ç±»å®ä¾‹çš„å·¥å‚ç±»ã€‚java.lang.reflect.Proxyä¸»è¦æä¾›å››ä¸ªpublicé™æ€æ–¹æ³•ï¼š 1234567891011// æ–¹æ³• 1: è¯¥æ–¹æ³•ç”¨äºè·å–æŒ‡å®šä»£ç†å¯¹è±¡æ‰€å…³è”çš„è°ƒç”¨å¤„ç†å™¨public static InvocationHandler getInvocationHandler(Object proxy) // æ–¹æ³• 2ï¼šè¯¥æ–¹æ³•ç”¨äºè·å–å…³è”äºæŒ‡å®šç±»è£…è½½å™¨å’Œä¸€ç»„æ¥å£çš„åŠ¨æ€ä»£ç†ç±»çš„ç±»å¯¹è±¡public static Class&lt;?&gt; getProxyClass(ClassLoader loader, Class&lt;?&gt;[] interfaces) // æ–¹æ³• 3ï¼šè¯¥æ–¹æ³•ç”¨äºåˆ¤æ–­æŒ‡å®šç±»å¯¹è±¡æ˜¯å¦æ˜¯ä¸€ä¸ªåŠ¨æ€ä»£ç†ç±»public static boolean isProxyClass(Class&lt;?&gt; cl) // æ–¹æ³• 4ï¼šè¯¥æ–¹æ³•ç”¨äºä¸ºæŒ‡å®šç±»è£…è½½å™¨ã€ä¸€ç»„æ¥å£åŠè°ƒç”¨å¤„ç†å™¨ç”ŸæˆåŠ¨æ€ä»£ç†ç±»å®ä¾‹public static Object newProxyInstance(ClassLoader loader, Class&lt;?&gt;[] interfaces, InvocationHandler h) InvocationHandler getInvocationHandler(Object proxy)ï¼šé€šè¿‡åˆ¶å®šçš„ä»£ç†ç±»å®ä¾‹æŸ¥æ‰¾å®ƒå…³è”çš„è°ƒç”¨å¤„ç†å™¨å®ä¾‹ã€‚ Class&lt;?&gt; getProxyClass(ClassLoader loader, Class&lt;?&gt;[] interfaces)ï¼šç”¨äºè·å–å…³è”äºæŒ‡å®šç±»è£…è½½å™¨å’Œä¸€ç»„æ¥å£çš„åŠ¨æ€ä»£ç†ç±»çš„ç±»å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯è·å–$ProxyXXXçš„ç±»å‹ï¼Œæ­¤æ–¹æ³•åœ¨JDK9ä»¥åæ ‡è®°ä¸ºè¿‡æœŸï¼ŒåŸå› æ˜¯ï¼šåœ¨å‘½åæ¨¡å—ä¸­ç”Ÿæˆçš„ä»£ç†ç±»æ˜¯å°é—­çš„ï¼Œæ¨¡å—å¤–çš„ä»£ç æ— æ³•è®¿é—®è¿™äº›ç±»(è¿åæ¨¡å—è§„åˆ™è°ƒç”¨äº†ä¼šæŠ›å¼‚å¸¸)ã€‚ boolean isProxyClass(Class&lt;?&gt; cl)ï¼šç”¨äºåˆ¤æ–­æŒ‡å®šç±»æ˜¯å¦æ˜¯ä¸€ä¸ªåŠ¨æ€ä»£ç†ç±»ã€‚ Object newProxyInstance(ClassLoader loader, Class[] interfaces, InvocationHandler h)ï¼šè¿™ä¸ªæ˜¯JDKåŠ¨æ€ä»£ç†æœ€æ ¸å¿ƒçš„æ–¹æ³•ï¼Œç”¨äºä¸ºæŒ‡å®šç±»è£…è½½å™¨ã€ä¸€ç»„æ¥å£åŠè°ƒç”¨å¤„ç†å™¨ç”ŸæˆåŠ¨æ€ä»£ç†ç±»å®ä¾‹ï¼Œä¹Ÿå°±æ˜¯ç”Ÿæˆ$ProxyXXXçš„å®ä¾‹ã€‚æ­¤æ–¹æ³•éœ€è¦æŒ‡å®šç±»åŠ è½½å™¨java.lang.ClassLoaderï¼ŒProxyé™æ€æ–¹æ³•ç”ŸæˆåŠ¨æ€ä»£ç†ç±»åŒæ ·éœ€è¦é€šè¿‡ç±»è£…è½½å™¨æ¥è¿›è¡Œè£…è½½æ‰èƒ½ä½¿ç”¨ï¼Œå®ƒä¸æ™®é€šç±»çš„å”¯ä¸€åŒºåˆ«å°±æ˜¯å…¶å­—èŠ‚ç æ˜¯åœ¨è¿è¡Œæ—¶åŠ¨æ€ç”Ÿæˆçš„è€Œéé¢„å­˜åœ¨äºä»»ä½•ä¸€ä¸ª.classæ–‡ä»¶ä¸­ã€‚interfacesæ˜¯Classæ•°ç»„ï¼Œä¹Ÿå°±æ˜¯éœ€è¦ä½¿ç”¨InvocationHandlerè¿›è¡Œä»£ç†è®¿é—®çš„æ¥å£ç±»å‹æ•°ç»„ï¼Œè¿™é‡Œçš„hå‚æ•°å°±æ˜¯è°ƒç”¨å¤„ç†å™¨çš„å®ä¾‹ã€‚ InvocationHandler java.lang.reflect.InvocationHandleræ˜¯è°ƒç”¨å¤„ç†å™¨æ¥å£ï¼Œå®ƒè‡ªå®šä¹‰äº†ä¸€ä¸ªinvokeæ–¹æ³•ï¼Œç”¨äºé›†ä¸­å¤„ç†åœ¨åŠ¨æ€ä»£ç†ç±»å¯¹è±¡ä¸Šçš„æ–¹æ³•è°ƒç”¨ï¼Œé€šå¸¸åœ¨è¯¥æ–¹æ³•ä¸­å®ç°å¯¹å§”æ‰˜ç±»çš„ä»£ç†è®¿é—®ã€‚ 123public interface InvocationHandler &#123; Object invoke(Object proxy, Method method, Object[] args) throws Throwable;&#125; å‚æ•°è¯´æ˜ï¼š proxyï¼šObjectç±»å‹ï¼Œæ­¤å‚æ•°å³æ˜¯ä»£ç†ç±»å®ä¾‹ï¼Œä¹Ÿå°±æ˜¯$ProxyXXXçš„å®ä¾‹ã€‚ methodï¼šjava.lang.reflect.Methodç±»å‹ï¼Œè¢«è°ƒç”¨çš„æ–¹æ³•çš„å®ä¾‹ã€‚ argsï¼šObject[]ç±»å‹ï¼Œè¢«è°ƒç”¨æ–¹æ³•çš„å‚æ•°æ•°ç»„ã€‚ å®ç°java.lang.reflect.InvocationHandleræ¥å£ï¼Œé€šè¿‡å®ç°invokeæ–¹æ³•å³å¯æ·»åŠ ä»£ç†è®¿é—®çš„é€»è¾‘ï¼Œåœ¨è¿™ä¸ªé€»è¾‘ä»£ç å—ä¸­é™¤äº†å¯ä»¥è°ƒç”¨å§”æ‰˜ç±»çš„æ–¹æ³•ï¼Œè¿˜å¯ä»¥ç»‡å…¥é¢å¤–çš„è‡ªå®šä¹‰é€»è¾‘ï¼ŒAOPå°±æ˜¯è¿™æ ·å®ç°çš„ã€‚ JDKåŠ¨æ€ä»£ç†çš„æµç¨‹ JDKåŠ¨æ€ä»£ç†çš„ä½¿ç”¨æµç¨‹å¦‚ä¸‹ï¼š 1ã€é€šè¿‡å®ç°java.lang.reflect.InvocationHandleræ¥å£åˆ›å»ºè‡ªå®šä¹‰çš„è°ƒç”¨å¤„ç†å™¨ã€‚ 2ã€é€šè¿‡ä¸ºjava.lang.reflect.Proxyç±»æŒ‡å®šClassLoaderå¯¹è±¡å’Œä¸€ç»„interfaceæ¥åˆ›å»ºåŠ¨æ€ä»£ç†ç±»ã€‚ 3ã€é€šè¿‡åå°„æœºåˆ¶è·å¾—åŠ¨æ€ä»£ç†ç±»çš„æ„é€ å‡½æ•°ï¼Œå…¶å”¯ä¸€å‚æ•°ç±»å‹æ˜¯è°ƒç”¨å¤„ç†å™¨æ¥å£ç±»å‹ã€‚ 4ã€é€šè¿‡æ„é€ å‡½æ•°åˆ›å»ºåŠ¨æ€ä»£ç†ç±»å®ä¾‹ï¼Œæ„é€ æ—¶è°ƒç”¨å¤„ç†å™¨å¯¹è±¡ä½œä¸ºå‚æ•°è¢«ä¼ å…¥ã€‚ ä¼ªä»£ç å¦‚ä¸‹ï¼š 123456789101112// InvocationHandlerImpl å®ç°äº† InvocationHandler æ¥å£ï¼Œå¹¶èƒ½å®ç°æ–¹æ³•è°ƒç”¨ä»ä»£ç†ç±»åˆ°å§”æ‰˜ç±»çš„åˆ†æ´¾è½¬å‘// å…¶å†…éƒ¨é€šå¸¸åŒ…å«æŒ‡å‘å§”æ‰˜ç±»å®ä¾‹çš„å¼•ç”¨ï¼Œç”¨äºçœŸæ­£æ‰§è¡Œåˆ†æ´¾è½¬å‘è¿‡æ¥çš„æ–¹æ³•è°ƒç”¨InvocationHandler handler = new InvocationHandlerImpl(..); // é€šè¿‡Proxyä¸ºåŒ…æ‹¬Interfaceæ¥å£åœ¨å†…çš„ä¸€ç»„æ¥å£åŠ¨æ€åˆ›å»ºä»£ç†ç±»çš„ç±»å¯¹è±¡Class clazz = Proxy.getProxyClass(classLoader, new Class[] &#123; Interface.class, ... &#125;); // é€šè¿‡åå°„ä»ç”Ÿæˆçš„ç±»å¯¹è±¡è·å¾—æ„é€ å‡½æ•°å¯¹è±¡Constructor constructor = clazz.getConstructor(new Class[] &#123; InvocationHandler.class &#125;); // é€šè¿‡æ„é€ å‡½æ•°å¯¹è±¡åˆ›å»ºåŠ¨æ€ä»£ç†ç±»å®ä¾‹Interface Proxy = (Interface)constructor.newInstance(new Object[] &#123; handler &#125;); ä¸Šé¢çš„è¿‡ç¨‹æ¯”è¾ƒå¤æ‚ï¼Œå¯ä»¥è¿›è¡Œç²¾ç®€ã€‚ç®€åŒ–åçš„ä¼ªä»£ç å¦‚ä¸‹ï¼š 12345// InvocationHandlerImplå®ç°äº†InvocationHandler æ¥å£ï¼Œå¹¶èƒ½å®ç°æ–¹æ³•è°ƒç”¨ä»ä»£ç†ç±»åˆ°å§”æ‰˜ç±»çš„åˆ†æ´¾è½¬å‘InvocationHandler handler = new InvocationHandlerImpl(..); // é€šè¿‡Proxyç›´æ¥åˆ›å»ºåŠ¨æ€ä»£ç†ç±»å®ä¾‹Interface proxy = (Interface) Proxy.newProxyInstance(classLoader, new Class[] &#123; Interface.class &#125;, handler); JDKåŠ¨æ€ä»£ç†çš„æœºåˆ¶ é¦–å…ˆæ˜¯JDKåŠ¨æ€ä»£ç†ç”Ÿæˆçš„ä»£ç†ç±»æœ¬èº«çš„ç‰¹ç‚¹ï¼š 1ã€åŒ…(æˆ–è€…JDK9å¼•å…¥çš„æ¨¡å—)ï¼šå¦‚æœæ‰€ä»£ç†çš„æ¥å£éƒ½æ˜¯publicçš„ï¼Œé‚£ä¹ˆå®ƒå°†è¢«å®šä¹‰åœ¨åŒ…com.sun.proxyï¼›å¦‚æœæ‰€ä»£ç†çš„æ¥å£ä¸­æœ‰épublicçš„æ¥å£(å› ä¸ºæ¥å£ä¸èƒ½è¢«å®šä¹‰ä¸ºprotectæˆ–privateï¼Œæ‰€ä»¥é™¤publicä¹‹å¤–å°±æ˜¯é»˜è®¤çš„packageè®¿é—®çº§åˆ«ï¼Œä¿®é¥°ç¬¦ä¸ºdefault)ï¼Œé‚£ä¹ˆå®ƒå°†è¢«å®šä¹‰åœ¨è¯¥æ¥å£æ‰€åœ¨åŒ…(å‡è®¾ä»£ç†äº†throwable.clubåŒ…ä¸­çš„æŸépublicæ¥å£Aï¼Œé‚£ä¹ˆæ–°ç”Ÿæˆçš„ä»£ç†ç±»æ‰€åœ¨çš„åŒ…å°±æ˜¯throwable.club)ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæ¥å£æ•°ç»„ä¸­å­˜åœ¨épublicçš„æ¥å£ï¼Œé‚£ä¹ˆå®ƒä»¬å¿…é¡»åœ¨åŒä¸€ä¸ªåŒ…è·¯å¾„ä¸‹ï¼Œå¦åˆ™ä¼šæŠ›å¼‚å¸¸ã€‚è¿™æ ·è®¾è®¡çš„ç›®çš„æ˜¯ä¸ºäº†æœ€å¤§ç¨‹åº¦çš„ä¿è¯åŠ¨æ€ä»£ç†ç±»ä¸ä¼šå› ä¸ºåŒ…ç®¡ç†çš„é—®é¢˜è€Œæ— æ³•è¢«æˆåŠŸå®šä¹‰å¹¶è®¿é—®ã€‚ 2ã€ç±»ä¿®é¥°ç¬¦ï¼šè¯¥ä»£ç†ç±»å…·æœ‰finalå’Œpublicä¿®é¥°ç¬¦ï¼Œæ„å‘³ç€å®ƒå¯ä»¥è¢«æ‰€æœ‰çš„ç±»è®¿é—®ï¼Œä½†æ˜¯ä¸èƒ½è¢«å†åº¦ç»§æ‰¿ã€‚ 3ã€ç±»åï¼šä»£ç†ç±»åç§°æ ¼å¼æ˜¯$ProxyNï¼Œå…¶ä¸­Næ˜¯ä¸€ä¸ªé€ä¸€é€’å¢çš„é˜¿æ‹‰ä¼¯æ•°å­—ï¼Œä»£è¡¨java.lang.reflect.Proxyç±»ç¬¬Næ¬¡ç”Ÿæˆçš„åŠ¨æ€ä»£ç†ç±»ï¼Œå€¼å¾—æ³¨æ„çš„ä¸€ç‚¹æ˜¯ï¼Œå¹¶ä¸æ˜¯æ¯æ¬¡è°ƒç”¨Proxyçš„é™æ€æ–¹æ³•åˆ›å»ºåŠ¨æ€ä»£ç†ç±»éƒ½ä¼šä½¿å¾—Nå€¼å¢åŠ ï¼ŒåŸå› æ˜¯å¦‚æœå¯¹åŒä¸€ç»„æ¥å£(åŒ…æ‹¬æ¥å£æ’åˆ—çš„é¡ºåºç›¸åŒ)è¯•å›¾é‡å¤åˆ›å»ºåŠ¨æ€ä»£ç†ç±»ï¼Œå®ƒä¼šä»ç¼“å­˜ä¸­è·å–å…ˆå‰å·²ç»åˆ›å»ºå¥½çš„ä»£ç†ç±»çš„ç±»å¯¹è±¡ï¼Œè€Œä¸ä¼šå†å°è¯•å»åˆ›å»ºä¸€ä¸ªå…¨æ–°çš„ä»£ç†ç±»ï¼Œè¿™æ ·å¯ä»¥èŠ‚çœä¸å¿…è¦çš„ä»£ç é‡å¤ç”Ÿæˆï¼Œæé«˜äº†ä»£ç†ç±»çš„åˆ›å»ºæ•ˆç‡ã€‚ 4ã€ç±»ç»§æ‰¿å…³ç³»ï¼šä»£ç†ç±»çš„ç»§æ‰¿å…³ç³»å›¾å¦‚ä¸‹ï¼š ç”±å›¾å¯çŸ¥ï¼Œjava.lang.reflect.Proxyç±»æ˜¯ä»£ç†ç±»çš„çˆ¶ç±»ï¼Œè¿™ä¸ªè§„åˆ™é€‚ç”¨äºæ‰€æœ‰ç”±java.lang.reflect.Proxyåˆ›å»ºçš„åŠ¨æ€ä»£ç†ç±»ã€‚è€Œä¸”è¯¥ç±»è¿˜å®ç°äº†å…¶æ‰€ä»£ç†çš„ä¸€ç»„æ¥å£ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆå®ƒèƒ½å¤Ÿè¢«å®‰å…¨åœ°ç±»å‹è½¬æ¢åˆ°å…¶æ‰€ä»£ç†çš„æŸæ¥å£çš„æ ¹æœ¬åŸå› ã€‚ ä»£ç†ç±»å®ä¾‹çš„ç‰¹ç‚¹ æ¯ä¸ªä»£ç†ç±»å®ä¾‹éƒ½ä¼šå…³è”ä¸€ä¸ªè°ƒç”¨å¤„ç†å™¨å¯¹è±¡ï¼Œå¯ä»¥é€šè¿‡java.lang.reflect.Proxyæä¾›çš„é™æ€æ–¹æ³•getInvocationHandler()å»è·å¾—ä»£ç†ç±»å®ä¾‹çš„è°ƒç”¨å¤„ç†å™¨å¯¹è±¡ã€‚åœ¨ä»£ç†ç±»å®ä¾‹ä¸Šè°ƒç”¨å…¶ä»£ç†çš„æ¥å£ä¸­æ‰€å£°æ˜çš„æ–¹æ³•æ—¶ï¼Œè¿™äº›æ–¹æ³•æœ€ç»ˆéƒ½ä¼šç”±è°ƒç”¨å¤„ç†å™¨çš„ invoke æ–¹æ³•æ‰§è¡Œï¼Œæ­¤å¤–ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œä»£ç†ç±»çš„æ ¹ç±»java.lang.Objectä¸­æœ‰ä¸‰ä¸ªæ–¹æ³•ä¹ŸåŒæ ·ä¼šè¢«åˆ†æ´¾åˆ°è°ƒç”¨å¤„ç†å™¨çš„invokeæ–¹æ³•æ‰§è¡Œï¼Œå®ƒä»¬æ˜¯hashCodeã€equalså’ŒtoStringï¼Œå¯èƒ½çš„åŸå› æœ‰ï¼š ä¸€ã€å› ä¸ºè¿™äº›æ–¹æ³•ä¸ºpublicä¸”éfinalç±»å‹ï¼Œèƒ½å¤Ÿè¢«ä»£ç†ç±»è¦†ç›–ã€‚ äºŒã€å› ä¸ºè¿™äº›æ–¹æ³•å¾€å¾€å‘ˆç°å‡ºä¸€ä¸ªç±»çš„æŸç§ç‰¹å¾å±æ€§ï¼Œå…·æœ‰ä¸€å®šçš„åŒºåˆ†åº¦ï¼Œæ‰€ä»¥ä¸ºäº†ä¿è¯ä»£ç†ç±»ä¸å§”æ‰˜ç±»å¯¹å¤–çš„ä¸€è‡´æ€§ï¼Œè¿™ä¸‰ä¸ªæ–¹æ³•ä¹Ÿåº”è¯¥è¢«åˆ†æ´¾åˆ°å§”æ‰˜ç±»æ‰§è¡Œã€‚å½“ä»£ç†çš„ä¸€ç»„æ¥å£æœ‰é‡å¤å£°æ˜çš„æ–¹æ³•ä¸”è¯¥æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œä»£ç†ç±»æ€»æ˜¯ä»æ’åœ¨æœ€å‰é¢çš„æ¥å£ä¸­è·å–æ–¹æ³•å¯¹è±¡å¹¶åˆ†æ´¾ç»™è°ƒç”¨å¤„ç†å™¨ï¼Œè€Œæ— è®ºä»£ç†ç±»å®ä¾‹æ˜¯å¦æ­£åœ¨ä»¥è¯¥æ¥å£(æˆ–ç»§æ‰¿äºè¯¥æ¥å£çš„æŸå­æ¥å£)çš„å½¢å¼è¢«å¤–éƒ¨å¼•ç”¨ï¼Œå› ä¸ºåœ¨ä»£ç†ç±»å†…éƒ¨æ— æ³•åŒºåˆ†å…¶å½“å‰çš„è¢«å¼•ç”¨ç±»å‹ã€‚ è¢«ä»£ç†çš„ä¸€ç»„æ¥å£çš„ç‰¹ç‚¹ é¦–å…ˆï¼Œè¦æ³¨æ„ä¸èƒ½æœ‰é‡å¤çš„æ¥å£ï¼Œä»¥é¿å…åŠ¨æ€ä»£ç†ç±»ä»£ç ç”Ÿæˆæ—¶çš„ç¼–è¯‘é”™è¯¯ã€‚å…¶æ¬¡ï¼Œè¿™äº›æ¥å£å¯¹äºç±»è£…è½½å™¨å¿…é¡»å¯è§ï¼Œå¦åˆ™ç±»è£…è½½å™¨å°†æ— æ³•é“¾æ¥å®ƒä»¬ï¼Œå°†ä¼šå¯¼è‡´ç±»å®šä¹‰å¤±è´¥ã€‚å†æ¬¡ï¼Œéœ€è¢«ä»£ç†çš„æ‰€æœ‰épublicçš„æ¥å£å¿…é¡»åœ¨åŒä¸€ä¸ªåŒ…ä¸­ï¼Œå¦åˆ™ä»£ç†ç±»ç”Ÿæˆä¹Ÿä¼šå¤±è´¥ã€‚æœ€åï¼Œæ¥å£çš„æ•°ç›®ä¸èƒ½è¶…è¿‡65535ï¼Œè¿™æ˜¯JVMè®¾å®šçš„é™åˆ¶ï¼Œè¿™ä¸€ç‚¹åœ¨ä»£ç†ç±»ç”Ÿæˆçš„æ—¶å€™ä¹Ÿåšäº†åˆ¤æ–­ã€‚ å¼‚å¸¸å¤„ç† ä»è°ƒç”¨å¤„ç†å™¨æ¥å£å£°æ˜çš„æ–¹æ³•ä¸­å¯ä»¥çœ‹åˆ°ç†è®ºä¸Šå®ƒèƒ½å¤ŸæŠ›å‡ºä»»ä½•ç±»å‹çš„å¼‚å¸¸ï¼Œå› ä¸ºæ‰€æœ‰çš„å¼‚å¸¸éƒ½ç»§æ‰¿äºThrowableæ¥å£ï¼Œä½†äº‹å®æ˜¯å¦å¦‚æ­¤å‘¢ï¼Ÿç­”æ¡ˆæ˜¯å¦å®šçš„ï¼ŒåŸå› æ˜¯æˆ‘ä»¬å¿…é¡»éµå®ˆä¸€ä¸ªç»§æ‰¿åŸåˆ™ï¼šå³å­ç±»è¦†ç›–çˆ¶ç±»æˆ–å®ç°çˆ¶æ¥å£çš„æ–¹æ³•æ—¶ï¼ŒæŠ›å‡ºçš„å¼‚å¸¸å¿…é¡»åœ¨åŸæ–¹æ³•æ”¯æŒçš„å¼‚å¸¸åˆ—è¡¨ä¹‹å†…ã€‚æ‰€ä»¥è™½ç„¶è°ƒç”¨å¤„ç†å™¨ç†è®ºä¸Šè®²èƒ½å¤Ÿï¼Œä½†å®é™…ä¸Šå¾€å¾€å—é™åˆ¶ï¼Œé™¤éçˆ¶æ¥å£ä¸­çš„æ–¹æ³•æ”¯æŒæŠ›Throwableå¼‚å¸¸ã€‚é‚£ä¹ˆå¦‚æœåœ¨invokeæ–¹æ³•ä¸­çš„ç¡®äº§ç”Ÿäº†æ¥å£æ–¹æ³•å£°æ˜ä¸­ä¸æ”¯æŒçš„å¼‚å¸¸ï¼Œé‚£å°†å¦‚ä½•å‘¢ï¼Ÿæ”¾å¿ƒï¼ŒJdkåŠ¨æ€ä»£ç†ç±»å·²ç»ä¸ºæˆ‘ä»¬è®¾è®¡å¥½äº†è§£å†³æ–¹æ³•ï¼šå®ƒå°†ä¼šæŠ›å‡ºUndeclaredThrowableException å¼‚å¸¸ã€‚è¿™ä¸ªå¼‚å¸¸æ˜¯ä¸€ä¸ªRuntimeExceptionç±»å‹ï¼Œæ‰€ä»¥ä¸ä¼šå¼•èµ·ç¼–è¯‘é”™è¯¯ã€‚é€šè¿‡è¯¥å¼‚å¸¸çš„getCauseæ–¹æ³•ï¼Œè¿˜å¯ä»¥è·å¾—åŸæ¥é‚£ä¸ªä¸å—æ”¯æŒçš„å¼‚å¸¸å¯¹è±¡ï¼Œä»¥ä¾¿äºé”™è¯¯è¯Šæ–­ã€‚ JDKåŠ¨æ€ä»£ç†æºç åˆ†æ å› ä¸ºJDKåŠ¨æ€ä»£ç†æ ¸å¿ƒé€»è¾‘éƒ½åœ¨java.lang.reflect.Proxyç±»ä¸­ï¼Œä¸‹é¢ç®€å•åˆ†æä¸€ä¸‹è¿™ä¸ªç±»çš„æºç ã€‚å…ˆçœ‹Proxyç±»ä¸­çš„å‡ ä¸ªé‡è¦çš„é™æ€å˜é‡ï¼š 12345678// æ¥å£ç»„ä¸­æ¥å£éƒ½ä¸ºä¸ºpublicæ—¶å€™ä»£ç†ç±»åˆ›å»ºçš„åŒ…è·¯å¾„ï¼šcom.sun.proxyprivate static final String PROXY_PACKAGE_PREFIX = ReflectUtil.PROXY_PACKAGE;// ä»£ç†ç±»çš„æ„é€ æ–¹æ³•å‚æ•°ç±»å‹æ•°ç»„ï¼Œå¯è§ä»£ç†ç±»çš„æ„é€ å‚æ•°åªæœ‰InvocationHandlerç±»å‹private static final Class&lt;?&gt;[] constructorParams = &#123; InvocationHandler.class &#125;;// ç¼“å­˜äº†æ‰€æœ‰å·²ç»è°ƒç”¨è¿‡setAccessible(true)çš„ä»£ç†ç±»çš„æ„é€ (Constructor)å®ä¾‹private static final ClassLoaderValue&lt;Constructor&lt;?&gt;&gt; proxyCache = new ClassLoaderValue&lt;&gt;(); è¿™é‡Œæ³¨æ„åˆ°ClassLoaderValueï¼Œä¸‹æ–‡ä¼šè°ƒç”¨åˆ°å®ƒçš„ä¸€ä¸ªå¾ˆå¤æ‚çš„è°ƒç”¨é“¾ï¼š 12345678910//intfæ˜¯Class&lt;?&gt;ç±»å‹//loaderæ˜¯ç±»åŠ è½½å™¨å®ä¾‹return proxyCache.sub(intf).computeIfAbsent( loader, (ld, clv) -&gt; new ProxyBuilder(ld, clv.key()).build());public V computeIfAbsent(ClassLoader cl, BiFunction&lt;? super ClassLoader,? super CLV,? extends V&gt; mappingFunction) throws IllegalStateException &#123; ä¸Šé¢çš„computeIfAbsentä¸­ä½¿ç”¨äº†å‡½æ•°å¼æ¥å£å’ŒLambdaè¡¨è¾¾å¼ï¼Œå¦‚æœLambdaè¡¨è¾¾å¼ç©çš„æ¯”è¾ƒç†Ÿç»ƒçœ‹èµ·æ¥åº”è¯¥æ²¡é—®é¢˜ï¼Œå®ƒçš„åŠŸèƒ½å¯ä»¥è§£è¯»ä¸ºï¼šé€šè¿‡æ¥å£ç±»å‹å’Œç±»åŠ è½½å™¨å®ä¾‹è®¡ç®—é€šè¿‡æ¥å£ç±»å‹å’Œç±»åŠ è½½å™¨å®ä¾‹æ„å»ºProxyBuilderå®ä¾‹å¹¶ä¸”è°ƒç”¨ProxyBuilder#build()å¾—åˆ°çš„ç»“æœï¼Œå¦‚æœç»“æœå·²ç»å­˜åœ¨åˆ™ç›´æ¥è¿”å›ç¼“å­˜ã€‚å…¶å®computeIfAbsentåœ¨Mapæ¥å£ä¸­ä¹Ÿå®šä¹‰äº†åŒæ ·çš„æ–¹æ³•ï¼ŒåŠŸèƒ½æ˜¯ç›¸ä¼¼çš„ã€‚ æ¥ç€çœ‹Proxyçš„æ„é€ å‡½æ•°ï¼š 123456789protected InvocationHandler h;private Proxy() &#123;&#125;protected Proxy(InvocationHandler h) &#123; Objects.requireNonNull(h); this.h = h;&#125; åˆ°æ­¤å¯ä»¥æ˜ç¡®ä¸€ç‚¹ï¼Œæ—¢ç„¶æ‰€æœ‰åŠ¨æ€ä»£ç†ç±»éƒ½æ˜¯java.lang.reflect.Proxyçš„å­ç±»ï¼Œé‚£ä¹ˆå®ƒä»¬ä¸€å®šå…·å¤‡ä¸€ä¸ªåŒ…å«InvocationHandlerå‚æ•°çš„æ„é€ å™¨ã€‚æ¥ç€æŸ¥çœ‹``æ–¹æ³•çš„æºç ï¼š 1234567891011121314public static Object newProxyInstance(ClassLoader loader, Class&lt;?&gt;[] interfaces, InvocationHandler h) &#123; // ç©ºåˆ¤æ–­ Objects.requireNonNull(h); // å½“å‰è°ƒç”¨ç±»è·å– final Class&lt;?&gt; caller = System.getSecurityManager() == null ? null : Reflection.getCallerClass(); // è·å–ä»£ç†ç±»çš„æ„é€ å™¨å®ä¾‹ Constructor&lt;?&gt; cons = getProxyConstructor(caller, loader, interfaces); // ç”Ÿæˆä»£ç†å®ä¾‹ return newProxyInstance(caller, cons, h);&#125; å…ˆçœ‹getProxyConstructoræ–¹æ³•ï¼š 123456789101112131415161718192021222324252627private static Constructor&lt;?&gt; getProxyConstructor(Class&lt;?&gt; caller, ClassLoader loader, Class&lt;?&gt;... interfaces)&#123; // è¿™é‡Œéœ€è¦åŒºåˆ†ä»£ç†æ¥å£æ•°ç»„ä¸­åªæœ‰å•ä¸ªæ¥å£å’Œå¤šä¸ªæ¥å£çš„é€»è¾‘ // è€ŒåŸºæœ¬çš„é€»è¾‘éƒ½æ˜¯å…ˆæ ¡éªŒå½“å‰è°ƒç”¨ç±»çš„æƒé™ï¼Œåç»­è·å–Constructorå®ä¾‹å§”æ‰˜åˆ°ProxyBuilder if (interfaces.length == 1) &#123; Class&lt;?&gt; intf = interfaces[0]; if (caller != null) &#123; checkProxyAccess(caller, loader, intf); &#125; return proxyCache.sub(intf).computeIfAbsent( loader, (ld, clv) -&gt; new ProxyBuilder(ld, clv.key()).build() ); &#125; else &#123; // æ¥å£å…‹éš† final Class&lt;?&gt;[] intfsArray = interfaces.clone(); if (caller != null) &#123; checkProxyAccess(caller, loader, intfsArray); &#125; final List&lt;Class&lt;?&gt;&gt; intfs = Arrays.asList(intfsArray); return proxyCache.sub(intfs).computeIfAbsent( loader, (ld, clv) -&gt; new ProxyBuilder(ld, clv.key()).build() ); &#125;&#125; å¯ä»¥æ˜ç¡®ï¼Œæ ¸å¿ƒçš„é€»è¾‘éƒ½äº¤ç»™äº†Proxyçš„å†…éƒ¨ç±»ProxyBuilderå®Œæˆï¼Œå…ˆçœ‹ProxyBuilderçš„é™æ€æˆå‘˜å˜é‡ï¼š 1234567891011// Unsafeå®ä¾‹private static final Unsafe UNSAFE = Unsafe.getUnsafe();// ä»£ç†ç±»çš„ç®€å•ç±»åçš„å‰ç½®å­—ç¬¦ä¸²private static final String proxyClassNamePrefix = \"$Proxy\";// ç”¨äºç”Ÿæˆä¸‹ä¸€ä¸ªä»£ç†ç±»çš„æ•°å­—è®¡æ•°å™¨ï¼Œè®°ä½å®ƒæ˜¯é™æ€çš„private static final AtomicLong nextUniqueNumber = new AtomicLong();// è®°å½•äº†å·²ç»ç”Ÿæˆçš„ä»£ç†ç±»-Booleançš„æ˜ å°„ï¼Œå·²ç»ç”Ÿæˆè¿‡å¯¹åº”ä»£ç†ç±»åˆ™è®°å½•ä¸ºtrueprivate static final ClassLoaderValue&lt;Boolean&gt; reverseProxyCache = new ClassLoaderValue&lt;&gt;(); 123456789101112131415161718192021222324252627282930// å•ä¸ªä»£ç†æ¥å£çš„æƒ…å†µï¼Œå…¶å®ä¹Ÿæ˜¯æŠŠæ¥å£è½¬æ¢ä¸ºListProxyBuilder(ClassLoader loader, Class&lt;?&gt; intf) &#123; this(loader, Collections.singletonList(intf));&#125;// å¤šä¸ªä»£ç†æ¥å£çš„æƒ…å†µProxyBuilder(ClassLoader loader, List&lt;Class&lt;?&gt;&gt; interfaces) &#123; // é€šè¿‡JVMå‚æ•°å¼ºåˆ¶å…³é—­åŠ¨æ€ä»£ç†åŠŸèƒ½åˆ™æŠ›å‡ºå¼‚å¸¸ if (!VM.isModuleSystemInited()) &#123; throw new InternalError(\"Proxy is not supported until \" + \"module system is fully initialized\"); &#125; // ä»£ç†æ¥å£æ•°é‡ä¸èƒ½è¶…è¿‡65535ï¼Œä¹Ÿå°±æ˜¯æœ€å¤šä»£ç†65535ä¸ªæ¥å£ if (interfaces.size() &gt; 65535) &#123; throw new IllegalArgumentException(\"interface limit exceeded: \" + interfaces.size()); &#125; // æ”¶é›†æ¥å£æ•°ç»„ä¸­æ‰€æœ‰æ¥å£çš„éé™æ€æ–¹æ³•çš„è¿”å›å€¼ç±»å‹ã€å…±äº«(shared)å‚æ•°ç±»å‹å’Œå…±äº«(shared)å¼‚å¸¸ç±»å‹ï¼Œæ³¨é‡Šè¯´æ˜¯æ”¶é›†ä»£ç†æ¥å£çš„æ–¹æ³•ç­¾å Set&lt;Class&lt;?&gt;&gt; refTypes = referencedTypes(loader, interfaces); // ç¡®ä¿ä¸Šä¸€æ­¥å¾—åˆ°çš„ä»£ç†æ¥å£æ–¹æ³•ç­¾åçš„ç±»å‹éƒ½æ˜¯\"å¯è§(å…¶å®å°±æ˜¯ç±»å‹éƒ½å­˜åœ¨)\"çš„ï¼Œé€šè¿‡éå†è°ƒç”¨Class.forName(type.getName(), false, ld)å»åˆ¤æ–­ validateProxyInterfaces(loader, interfaces, refTypes); this.interfaces = interfaces; // è·å–ä»£ç†ç±»æœ€ç»ˆç”Ÿæˆçš„æ¨¡å—ï¼Œè§„åˆ™å¦‚ä¸‹ï¼š // 1ã€æ‰€æœ‰ä»£ç†æ¥å£çš„ä¿®é¥°ç¬¦éƒ½ä¸ºpublicï¼Œæ¥å£æ‰€åœ¨æ¨¡å—éƒ½èƒ½å…¬å¼€è®¿é—®ï¼Œåˆ™è¿”å›unnamedæ¨¡å— // 2ã€å¦‚æœæœ‰ä»»æ„çš„ä»£ç†æ¥å£æ˜¯åŒ…ç§æœ‰ï¼Œåˆ™è¿”å›è¯¥åŒ…æ‰€åœ¨çš„æ¨¡å— ã€ // 3ã€æ‰€æœ‰ä»£ç†æ¥å£çš„ä¿®é¥°ç¬¦éƒ½ä¸ºpublicï¼Œæœ‰ä»»æ„è‡³å°‘ä¸€ä¸ªæ¥å£æ‰€åœ¨æ¨¡å—ä¸èƒ½å…¬å¼€è®¿é—®ï¼Œåˆ™è¿”å›è¯¥ä¸èƒ½å…¬å¼€è®¿é—®çš„æ¨¡å—ï¼Œ this.module = mapToModule(loader, interfaces, refTypes); assert getLoader(module) == loader;&#125; ä¸€ä¸ªæ„é€ å™¨å¤„ç†çš„é€»è¾‘ä¹Ÿæ˜¯ç›¸å¯¹å¤æ‚ï¼Œä¸»è¦æ˜¯å› ä¸ºå¼•å…¥æ¨¡å—ç®¡ç†çš„æ¦‚å¿µï¼Œæ¥ç€çœ‹ProxyBuilder#build()çš„æºç ï¼š 123456789101112131415161718Constructor&lt;?&gt; build() &#123; // å®šä¹‰ä»£ç†ç±»ï¼Œå®é™…ä¸Šæ˜¯åŠ¨æ€ç”Ÿæˆä»£ç†ç±»å­—èŠ‚ç å’Œç¼“å­˜å®ƒçš„ç±»å‹çš„è¿‡ç¨‹ Class&lt;?&gt; proxyClass = defineProxyClass(module, interfaces); final Constructor&lt;?&gt; cons; try &#123; // è¿”å›ä»£ç†ç±»çš„æ„é€  cons = proxyClass.getConstructor(constructorParams); &#125; catch (NoSuchMethodException e) &#123; throw new InternalError(e.toString(), e); &#125; AccessController.doPrivileged(new PrivilegedAction&lt;Void&gt;() &#123; public Void run() &#123; cons.setAccessible(true); return null; &#125; &#125;); return cons;&#125; æœ€ååˆ°é€»è¾‘æœ€å¤æ‚çš„ä»£ç†ç±»çš„ç”Ÿæˆè¿‡ç¨‹ProxyBuilder#defineProxyClass()ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263private static Class&lt;?&gt; defineProxyClass(Module m, List&lt;Class&lt;?&gt;&gt; interfaces) &#123; String proxyPkg = null; // package to define proxy class in int accessFlags = Modifier.PUBLIC | Modifier.FINAL; // è¿™é‡Œå°±æ˜¯å®šä¹‰ä»£ç†ç±»åŒ…è·¯å¾„çš„é€»è¾‘ï¼Œè§„åˆ™å¦‚ä¸‹ï¼š // 1ã€ä»£ç†æ¥å£æ•°ç»„æ‰€æœ‰æ¥å£éƒ½æ˜¯publicä¿®é¥°ï¼Œåˆ™ä»£ç†ç±»åŒ…è·¯å¾„ä¸ºcom.sun.proxy // 2ã€ä»£ç†æ¥å£æ•°ç»„æœ‰ä»»æ„æ¥å£æ˜¯åŒ…ç§æœ‰çš„ï¼Œåˆ™ä»£ç†ç±»åŒ…è·¯å¾„ä¸ºè¯¥ç§æœ‰åŒ…çš„è·¯å¾„ for (Class&lt;?&gt; intf : interfaces) &#123; int flags = intf.getModifiers(); if (!Modifier.isPublic(flags)) &#123; accessFlags = Modifier.FINAL; // non-public, final String pkg = intf.getPackageName(); if (proxyPkg == null) &#123; proxyPkg = pkg; &#125; else if (!pkg.equals(proxyPkg)) &#123; throw new IllegalArgumentException( \"non-public interfaces from different packages\"); &#125; &#125; &#125; // ä¸‹é¢å‡ ä¸ªiféƒ½æ˜¯åŒ…è·¯å¾„çš„åˆæ³•æ€§åˆ¤æ–­ if (proxyPkg == null) &#123; // all proxy interfaces are public proxyPkg = m.isNamed() ? PROXY_PACKAGE_PREFIX + \".\" + m.getName() : PROXY_PACKAGE_PREFIX; &#125; else if (proxyPkg.isEmpty() &amp;&amp; m.isNamed()) &#123; throw new IllegalArgumentException( \"Unnamed package cannot be added to \" + m); &#125; if (m.isNamed()) &#123; if (!m.getDescriptor().packages().contains(proxyPkg)) &#123; throw new InternalError(proxyPkg + \" not exist in \" + m.getName()); &#125; &#125; // è®¡æ•°å™¨åŠ 1è¿”å›æ–°çš„è®¡æ•°å€¼ long num = nextUniqueNumber.getAndIncrement(); // ç”Ÿæˆä»£ç†ç±»å…¨ç±»åï¼Œä¸€ä¸ªå¸¸è§çš„æ ¼å¼æ˜¯ï¼šcom.sun.proxy.$Proxy1 String proxyName = proxyPkg.isEmpty() ? proxyClassNamePrefix + num : proxyPkg + \".\" + proxyClassNamePrefix + num; ClassLoader loader = getLoader(m); trace(proxyName, m, loader, interfaces); // åŠ¨æ€ç”Ÿæˆä»£ç†ç±»å­—èŠ‚ç å­—èŠ‚æ•°ç»„ byte[] proxyClassFile = ProxyGenerator.generateProxyClass( proxyName, interfaces.toArray(EMPTY_CLASS_ARRAY), accessFlags); try &#123; // é€šè¿‡Unsafeå®šä¹‰ä»£ç†ç±»-è¿™é‡Œæ˜¯é€šè¿‡å­—èŠ‚ç å®šä¹‰æ–°çš„ç±» Class&lt;?&gt; pc = UNSAFE.defineClass(proxyName, proxyClassFile, 0, proxyClassFile.length, loader, null); // ç¼“å­˜ä»£ç†ç±»å·²ç»ç”Ÿæˆè¿‡çš„æ ‡è®° reverseProxyCache.sub(pc).putIfAbsent(loader, Boolean.TRUE); return pc; &#125; catch (ClassFormatError e) &#123; /* * A ClassFormatError here means that (barring bugs in the * proxy class generation code) there was some other * invalid aspect of the arguments supplied to the proxy * class creation (such as virtual machine limitations * exceeded). */ throw new IllegalArgumentException(e.toString()); &#125;&#125; åˆ°è¿™ä¸€æ­¥ä¸ºæ­¢ï¼Œä»£ç†ç±»çš„ç”Ÿæˆè¿‡ç¨‹å·²ç»å¤§è‡´åˆ†æå®Œæ¯•ï¼ŒProxyGeneratorä¸­æ¶‰åŠåˆ°å¤§é‡å­—èŠ‚ç æ“ä½œï¼Œè¿™é‡Œå°±ä¸æ·±å…¥åˆ†æäº†ã€‚é‚£ä¹ˆå›åˆ°æœ€å‰é¢çš„æ–¹æ³•ï¼Œå¾—åˆ°ä»£ç†ç±»å’Œå®ƒçš„æ„é€ å®ä¾‹ï¼Œæ¥ç€å°±å¯ä»¥ç”Ÿæˆä»£ç†å®ä¾‹ï¼š 1234567891011121314151617181920private static Object newProxyInstance(Class&lt;?&gt; caller, // null if no SecurityManager Constructor&lt;?&gt; cons, InvocationHandler h) &#123; try &#123; if (caller != null) &#123; checkNewProxyPermission(caller, cons.getDeclaringClass()); &#125; // è¿™é‡Œç®€å•åå°„è°ƒç”¨Constructor#newInstance(h) return cons.newInstance(new Object[]&#123;h&#125;); &#125; catch (IllegalAccessException | InstantiationException e) &#123; throw new InternalError(e.toString(), e); &#125; catch (InvocationTargetException e) &#123; Throwable t = e.getCause(); if (t instanceof RuntimeException) &#123; throw (RuntimeException) t; &#125; else &#123; throw new InternalError(t.toString(), t); &#125; &#125;&#125; å°ç»“ä¸€ä¸‹ï¼š æ¥å£æ•°ç»„ä¸­æ‰€æœ‰æ¥å£å…ƒç´ çš„ç±»ä¿®é¥°ç¬¦æœ€å¥½ä¸€è‡´ä¸ºpublicã€‚å¦‚æœæ¥å£æ•°ç»„ä¸­å­˜åœ¨édefaultä¿®é¥°çš„æ¥å£å…ƒç´ ï¼Œé‚£ä¹ˆæ¥å£æ•°ç»„ä¸­çš„æ‰€æœ‰æ¥å£ç±»éƒ½è¦æ”¾åœ¨åŒä¸€ä¸ªåŒ…ä¸‹ï¼Œå¹¶ä¸”éƒ½è¦ä½¿ç”¨defaultä¿®é¥°ã€‚ å¾ˆå°‘æƒ…å†µä¸‹æˆ‘ä»¬ä¿®æ”¹æ¥å£çš„ä¿®é¥°ç¬¦ï¼Œé»˜è®¤ä¸ºpublicï¼Œé‚£ä¹ˆæ‰€æœ‰ä»£ç†ç±»çš„åŒ…è·¯å¾„éƒ½æ˜¯com.sun.proxyï¼Œå…¨ç±»åæ˜¯:com.sun.proxy.$ProxyNã€‚ ä»£ç†æ¥å£æ•°é‡ä¸èƒ½è¶…è¿‡65535ã€‚ JDKåŠ¨æ€ä»£ç†ç±»çš„æºä»£ç  å‰é¢å·²ç»åˆ†æå®Œäº†ä»£ç†ç±»çš„ç”Ÿæˆè¿‡ç¨‹ï¼Œè¿™é‡Œä¸¾ä¸ªç®€å•çš„ä½¿ç”¨ä¾‹å­ï¼Œå¹¶ä¸”è§‚å¯Ÿç”Ÿæˆçš„åŠ¨æ€ä»£ç†ç±»çš„æºä»£ç ã€‚ ä½¿ç”¨ä¾‹å­ï¼š 12345678910111213141516171819202122232425262728293031// æ¥å£public interface Simple &#123; void sayHello(String name);&#125;// æ¥å£å®ç°public class DefaultSimple implements Simple &#123; @Override public void sayHello(String name) &#123; System.out.println(String.format(\"%s say hello!\", name)); &#125;&#125;// åœºæ™¯ç±»public class Main &#123; public static void main(String[] args) throws Exception &#123; Simple simple = new DefaultSimple(); Object target = Proxy.newProxyInstance(Main.class.getClassLoader(), new Class[]&#123;Simple.class&#125;, new InvocationHandler() &#123; @Override public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123; System.out.println(\"Before say hello...\"); method.invoke(simple, args); System.out.println(\"After say hello...\"); return null; &#125; &#125;); Simple proxy = (Simple) target; proxy.sayHello(\"throwable\"); &#125;&#125; è°ƒç”¨åè¾“å‡ºï¼š 123Before say hello...throwable say hello!After say hello... å¯ä»¥çœ‹åˆ°ï¼Œæˆ‘ä»¬åœ¨è¢«ä»£ç†ç±»DefaultSimpleå®ä¾‹çš„æ–¹æ³•è°ƒç”¨å‰åç»‡å…¥äº†è‡ªå®šä¹‰çš„é€»è¾‘ï¼Œè¿™å°±æ˜¯é€šè¿‡JDKåŠ¨æ€ä»£ç†å®ç°AOPçš„åº•å±‚åŸç†ã€‚åœ¨JDK8ä¸­å¯ä»¥ç›´æ¥ä½¿ç”¨sun.misc.ProxyGeneratorå»è¾“å‡ºä»£ç†ç±»çš„classæ–‡ä»¶ï¼Œä½†æ˜¯JDK11ä¸­è¿™ä¸ªä»£ç†ç±»ç”Ÿæˆå™¨å·²ç»å˜æˆjava.lang.reflect.ProxyGeneratorï¼Œå¹¶ä¸”è¿™ä¸ªç±»æ˜¯åŒ…ç§æœ‰çš„ï¼Œæˆ‘ä»¬æ— æ³•ä½¿ç”¨ï¼Œä½†æ˜¯å®ƒæä¾›äº†jdk.proxy.ProxyGenerator.saveGeneratedFilesè¿™ä¸ªVMå‚æ•°è®©æˆ‘ä»¬å¯ä»¥ä¿å­˜ä»£ç†ç±»çš„classæ–‡ä»¶ï¼š 12# JVMå‚æ•°-Djdk.proxy.ProxyGenerator.saveGeneratedFiles=true é…ç½®å¥½VMå‚æ•°åï¼Œå†æ¬¡è°ƒç”¨mianæ–¹æ³•å°±èƒ½çœ‹åˆ°åœ¨é¡¹ç›®çš„é¡¶å±‚åŒ…è·¯å¾„ä¸‹çœ‹åˆ°å¯¹åº”çš„ç±»com.sun.proxy.$Proxy0ï¼Œç›®å‰ä»java.lang.reflect.ProxyGeneratoræºç çœ‹æ— æ³•æ§åˆ¶ä»£ç†ç±»æ–‡ä»¶çš„è¾“å‡ºè·¯å¾„ï¼Œç”Ÿæˆçš„ä»£ç†ç±»å†…å®¹å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263public final class $Proxy0 extends Proxy implements Simple &#123; private static Method m1; private static Method m3; private static Method m2; private static Method m0; public $Proxy0(InvocationHandler var1) throws &#123; super(var1); &#125; public final boolean equals(Object var1) throws &#123; try &#123; return (Boolean)super.h.invoke(this, m1, new Object[]&#123;var1&#125;); &#125; catch (RuntimeException | Error var3) &#123; throw var3; &#125; catch (Throwable var4) &#123; throw new UndeclaredThrowableException(var4); &#125; &#125; public final void sayHello(String var1) throws &#123; try &#123; super.h.invoke(this, m3, new Object[]&#123;var1&#125;); &#125; catch (RuntimeException | Error var3) &#123; throw var3; &#125; catch (Throwable var4) &#123; throw new UndeclaredThrowableException(var4); &#125; &#125; public final String toString() throws &#123; try &#123; return (String)super.h.invoke(this, m2, (Object[])null); &#125; catch (RuntimeException | Error var2) &#123; throw var2; &#125; catch (Throwable var3) &#123; throw new UndeclaredThrowableException(var3); &#125; &#125; public final int hashCode() throws &#123; try &#123; return (Integer)super.h.invoke(this, m0, (Object[])null); &#125; catch (RuntimeException | Error var2) &#123; throw var2; &#125; catch (Throwable var3) &#123; throw new UndeclaredThrowableException(var3); &#125; &#125; static &#123; try &#123; m1 = Class.forName(\"java.lang.Object\").getMethod(\"equals\", Class.forName(\"java.lang.Object\")); m3 = Class.forName(\"club.throwable.jdk.sample.reflection.proxy.Simple\").getMethod(\"sayHello\", Class.forName(\"java.lang.String\")); m2 = Class.forName(\"java.lang.Object\").getMethod(\"toString\"); m0 = Class.forName(\"java.lang.Object\").getMethod(\"hashCode\"); &#125; catch (NoSuchMethodException var2) &#123; throw new NoSuchMethodError(var2.getMessage()); &#125; catch (ClassNotFoundException var3) &#123; throw new NoClassDefFoundError(var3.getMessage()); &#125; &#125;&#125; ä»£ç†ç±»çš„ä»£ç æ¯”è¾ƒç®€å•ï¼Œæœ‰å¦‚ä¸‹å‡ ä¸ªç‰¹ç‚¹ï¼š 1ã€ä»£ç†ç±»ç»§æ‰¿äºjava.lang.reflect.Proxyï¼Œå®ç°äº†æ¥å£æ•°ç»„ä¸­çš„æ¥å£å…ƒç´ ç±»ï¼Œæ„é€ å‡½æ•°åªæœ‰ä¸€ä¸ªInvocationHandlerç±»å‹çš„å‚æ•°ã€‚ 2ã€æ¥å£ä¸­çš„æ‰€æœ‰è¢«ä»£ç†æ–¹æ³•åŒ…æ‹¬equalsã€toStringã€hashCodeéƒ½å»ºç«‹äº†ä¸€ä¸ªå¯¹åº”çš„Methodç§æœ‰é™æ€å®ä¾‹ï¼Œåœ¨æœ€åé¢çš„é™æ€ä»£ç å—ä¸­å®ä¾‹åŒ–ã€‚ 3ã€æ‰€æœ‰ä»£ç†æ–¹æ³•éƒ½æ˜¯ç”¨public finalä¿®é¥°ï¼Œä¹Ÿå°±æ˜¯ä»£ç†ç±»ä¸­çš„ä»£ç†æ–¹æ³•æ˜¯ä¸èƒ½è¦†ç›–çš„ã€‚ 4ã€æ‰€æœ‰ä»£ç†æ–¹æ³•éƒ½æ˜¯é€šè¿‡InvocationHandlerå®ä¾‹çš„invokeæ–¹æ³•è¿›è¡Œè°ƒç”¨çš„ï¼Œè®°å¾—ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯ä»£ç†ç±»å®ä¾‹æœ¬èº«ï¼Œå¦‚æœç”¨äº†åœ¨InvocationHandler#invoke()æ–¹æ³•å®ç°è¿‡ç¨‹ä¸­ä½¿ç”¨äº†è¿™ä¸ªå‚æ•°æœ‰å¯èƒ½é€ æˆæ­»å¾ªç¯ã€‚ å°ç»“ è¯šç„¶ï¼ŒProxyå·²ç»è®¾è®¡å¾—éå¸¸ä¼˜ç¾ï¼Œä½†æ˜¯è¿˜æ˜¯æœ‰ä¸€ç‚¹ç‚¹å°å°çš„é—æ†¾ä¹‹å¤„ï¼Œé‚£å°±æ˜¯å®ƒå§‹ç»ˆæ— æ³•æ‘†è„±ä»…æ”¯æŒinterfaceä»£ç†çš„æ¡æ¢ï¼Œå› ä¸ºå®ƒçš„è®¾è®¡æ³¨å®šäº†è¿™ä¸ªé—æ†¾ã€‚å›æƒ³ä¸€ä¸‹é‚£äº›åŠ¨æ€ç”Ÿæˆçš„ä»£ç†ç±»çš„ç»§æ‰¿å…³ç³»å›¾ï¼Œå®ƒä»¬å·²ç»æ³¨å®šæœ‰ä¸€ä¸ªå…±åŒçš„çˆ¶ç±»å«Proxyã€‚Javaçš„å•ç»§æ‰¿æœºåˆ¶æ³¨å®šäº†è¿™äº›åŠ¨æ€ä»£ç†ç±»ä»¬æ— æ³•å®ç°å¯¹classçš„åŠ¨æ€ä»£ç†(æ‰€ä»¥åªèƒ½ä»£ç†æ¥å£ï¼Œå®é™…ä¸Šæ˜¯åŸºäºåå°„å¯¹æ–¹æ³•çº§åˆ«çš„é€»è¾‘è¿›è¡Œç¼–ç»‡)ã€‚æœ‰å¾ˆå¤šæ¡ç†ç”±ï¼Œå¯ä»¥å¦å®šå¯¹classä»£ç†çš„å¿…è¦æ€§ï¼Œä½†æ˜¯åŒæ ·æœ‰ä¸€äº›ç†ç”±ï¼Œç›¸ä¿¡æ”¯æŒclassåŠ¨æ€ä»£ç†ä¼šæ›´ç¾å¥½ã€‚ä½†æ˜¯ï¼Œä¸å®Œç¾å¹¶ä¸ç­‰äºä¸ä¼Ÿå¤§ï¼Œä¼Ÿå¤§æ˜¯ä¸€ç§æœ¬è´¨ï¼ŒJDKåŠ¨æ€ä»£ç†å°±æ˜¯ä½ä¾‹ã€‚ å‚è€ƒèµ„æ–™ï¼š JavaåŠ¨æ€ä»£ç†æœºåˆ¶åˆ†æåŠæ‰©å±•-ç¬¬1éƒ¨åˆ† JavaåŠ¨æ€ä»£ç†æœºåˆ¶åˆ†æåŠæ‰©å±•-ç¬¬2éƒ¨åˆ† JDK11ç›¸å…³æºç  (æœ¬æ–‡å®Œ e-20181208 c-3-d)","categories":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/categories/Java/"},{"name":"Reflection","slug":"Java/Reflection","permalink":"http://throwable.club/blog/categories/Java/Reflection/"}],"tags":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/tags/Java/"},{"name":"Reflection","slug":"Reflection","permalink":"http://throwable.club/blog/tags/Reflection/"}]},{"title":"æ·±å…¥åˆ†æJavaåå°„(ä¸‰)-æ³›å‹","slug":"java-reflection-generics","date":"2018-12-04T17:05:59.000Z","updated":"2018-12-05T15:20:21.522Z","comments":true,"path":"2018/12/05/java-reflection-generics/","link":"","permalink":"http://throwable.club/2018/12/05/java-reflection-generics/","excerpt":"","text":"æ·±å…¥åˆ†æJavaåå°„(ä¸‰)-æ³›å‹ å‰æ Javaåå°„çš„APIåœ¨JavaSE1.7çš„æ—¶å€™å·²ç»åŸºæœ¬å®Œå–„ï¼Œä½†æ˜¯æœ¬æ–‡ç¼–å†™çš„æ—¶å€™ä½¿ç”¨çš„æ˜¯Oracle JDK11ï¼Œå› ä¸ºJDK11å¯¹äºsunåŒ…ä¸‹çš„æºç ä¹Ÿä¸Šä¼ äº†ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡IDEæŸ¥çœ‹å¯¹åº”çš„æºç å’Œè¿›è¡ŒDebugã€‚ æœ¬æ–‡ä¸»è¦ä»‹ç»åå°„ä¸­ä¸€ä¸ªæ¯”è¾ƒéš¾çš„é—®é¢˜-æ³›å‹ã€‚ æ³›å‹çš„ç®€ä»‹ æ³›å‹æ˜¯åœ¨2004å¹´JavaSE 5.0(JDK1.5)ç‰ˆæœ¬ä¸­æ·»åŠ åˆ°Javaç¼–ç¨‹è¯­è¨€ä¸­çš„æ³›å‹ç¼–ç¨‹å·¥å…·ã€‚æ³›å‹çš„è®¾è®¡æ˜¯ä¸ºäº†åº”ç”¨åœ¨Javaçš„ç±»å‹ç³»ç»Ÿï¼Œæä¾›&quot;ç”¨ç±»å‹æˆ–è€…æ–¹æ³•æ“ä½œå„ç§ç±»å‹çš„å¯¹è±¡ä»è€Œæä¾›ç¼–è¯‘æœŸçš„ç±»å‹å®‰å…¨åŠŸèƒ½(åŸæ–‡ï¼ša type or method to operate on objects of various types while providing compile-time type safety)&quot;ã€‚ä½†æ˜¯åœ¨2016å¹´çš„ä¸€äº›ç ”ç©¶è¡¨æ˜ï¼Œæ³›å‹å¹¶ä¸æ˜¯åœ¨æ‰€æœ‰çš„æƒ…å†µä¸‹éƒ½èƒ½ä¿è¯ç¼–è¯‘æœŸçš„ç±»å‹å®‰å…¨ï¼Œä¾‹å¦‚åˆ‡é¢(Aspect)ç¼–ç¨‹çš„ç¼–è¯‘æœŸç±»å‹å®‰å…¨å¹¶æ²¡æœ‰å®Œå…¨å®ç°ã€‚ æ³›å‹çš„ä¸€ä¸ªæœ€å¤§çš„ä¼˜ç‚¹å°±æ˜¯ï¼šæä¾›ç¼–è¯‘æœŸçš„ç±»å‹å®‰å…¨ã€‚ä¸¾ä¸ªå¾ˆç®€å•çš„ä¾‹å­ï¼Œåœ¨å¼•å…¥æ³›å‹ä¹‹å‰ï¼ŒArrayListå†…éƒ¨åªç»´æŠ¤äº†ä¸€ä¸ªObjectæ•°ç»„å¼•ç”¨ï¼Œè¿™ç§åšæ³•æœ‰ä¸¤ä¸ªé—®é¢˜ï¼š ä»æ•°ç»„åˆ—è¡¨è·å–ä¸€ä¸ªå…ƒç´ çš„æ—¶å€™å¿…é¡»è¿›è¡Œç±»å‹çš„å¼ºè½¬ã€‚ å‘æ•°ç»„åˆ—è¡¨ä¸­å¯ä»¥æ·»åŠ ä»»ä½•ç±»å‹çš„å¯¹è±¡ï¼Œå¯¼è‡´æ— æ³•å¾—çŸ¥æ•°ç»„åˆ—è¡¨ä¸­å­˜æ”¾äº†ä»€ä¹ˆç±»å‹çš„å…ƒç´ ã€‚ å¼•å…¥æ³›å‹ä¹‹åï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡ç±»å‹å‚æ•°æ˜ç¡®å®šä¹‰ArrayListï¼š 1234ArrayList&lt;String&gt; list = new ArrayList&lt;String&gt;();// JavaSE 7ä»¥åçš„ç‰ˆæœ¬ä¸­æ„é€ å‡½æ•°å¯ä»¥çœç•¥ç±»å‹ï¼Œç¼–è¯‘å™¨å¯ä»¥æ¨å¯¼å‡ºå®é™…ç±»å‹ArrayList&lt;String&gt; list = new ArrayList&lt;&gt;(); ä¸‹é¢å…ˆåˆ—ä¸¾å‡ºJavaä¸­æ³›å‹çš„ä¸€äº›äº‹å®ï¼š Javaè™šæ‹Ÿæœºä¸­ä¸å­˜åœ¨æ³›å‹ï¼Œåªæœ‰æ™®é€šçš„ç±»å’Œæ–¹æ³•ï¼Œä½†æ˜¯å­—èŠ‚ç ä¸­å­˜æ”¾ç€æ³›å‹ç›¸å…³çš„ä¿¡æ¯ã€‚ æ‰€æœ‰çš„ç±»å‹å‚æ•°éƒ½ä½¿ç”¨å®ƒä»¬çš„é™å®šç±»å‹æ›¿æ¢ã€‚ æ¡¥æ–¹æ³•(Bridge Method)ç”±ç¼–è¯‘å™¨åˆæˆï¼Œç”¨äºä¿æŒå¤šæ€(Javaè™šæ‹Ÿæœºåˆ©ç”¨æ–¹æ³•çš„å‚æ•°ç±»å‹ã€æ–¹æ³•åç§°å’Œæ–¹æ³•è¿”å›å€¼ç±»å‹ç¡®å®šä¸€ä¸ªæ–¹æ³•)ã€‚ ä¸ºäº†ä¿æŒç±»å‹çš„å®‰å…¨æ€§ï¼Œå¿…è¦æ—¶éœ€è¦è¿›è¡Œç±»å‹çš„å¼ºåˆ¶è½¬æ¢ã€‚ ç†è§£ç±»å‹æ“¦é™¤ ç±»å‹æ“¦é™¤æ˜¯ä»€ä¹ˆ ç±»å‹æ“¦é™¤(æˆ–è€…æ›´å¤šæ—¶å€™å–œæ¬¢ç§°ä¸º&quot;æ³›å‹æ“¦é™¤&quot;)çš„å…·ä½“è¡¨ç°æ˜¯ï¼šæ— è®ºä½•æ—¶å®šä¹‰ä¸€ä¸ªæ³›å‹ç±»å‹ï¼Œéƒ½è‡ªåŠ¨æä¾›ä¸€ä¸ªç›¸åº”çš„åŸå§‹ç±»å‹(Raw Typeï¼Œè¿™é‡Œçš„åŸå§‹ç±»å‹å¹¶ä¸æ˜¯æŒ‡intã€booleanç­‰åŸºæœ¬æ•°æ®ç±»å‹)ï¼ŒåŸå§‹ç±»å‹çš„ç±»åç§°å°±æ˜¯å¸¦æœ‰æ³›å‹å‚æ•°çš„ç±»åˆ å»æ³›å‹å‚æ•°åçš„ç±»å‹åç§°ï¼Œè€ŒåŸå§‹ç±»å‹ä¼šæ“¦é™¤(Erased)ç±»å‹å˜é‡ï¼Œå¹¶ä¸”æŠŠå®ƒä»¬æ›¿æ¢ä¸ºé™å®šç±»å‹(å¦‚æœæ²¡æœ‰æŒ‡å®šé™å®šç±»å‹ï¼Œåˆ™æ“¦é™¤ä¸ºObjectç±»å‹)ï¼Œä¸¾ä¸ªä¾‹å­Pair&lt;T&gt;å¸¦æœ‰æ³›å‹å‚æ•°çš„ç±»å‹å¦‚ä¸‹ï¼š 123456789101112131415161718public class Pair&lt;T&gt;&#123; private T first; private T second; public Pair(T first,T second)&#123; this.first = first; this.second = second; &#125; public T getFirst()&#123; return first; &#125; public T getSecond()&#123; return second; &#125;&#125; æ“¦é™¤ç±»å‹åçš„Pair&lt;T&gt;çš„åŸå§‹ç±»å‹ä¸ºï¼š 123456789101112131415161718public class Pair&#123; private Object first; private Object second; public Pair(Object first,Object second)&#123; this.first = first; this.second = second; &#125; public Object getFirst()&#123; return first; &#125; public Object getSecond()&#123; return second; &#125;&#125; ä¸¾ä¸ªæ›´å¤æ‚çš„ä¾‹å­ï¼Œå¦‚æœæ³›å‹å‚æ•°ç±»å‹æ˜¯æœ‰ä¸Šé™çš„ï¼Œå˜é‡ä¼šæ“¦é™¤ä¸ºä¸Šé™çš„ç±»å‹ï¼š 123456789101112public class Interval&lt;T extends Comparable &amp; Serializable&gt; implements Serializable &#123; private T lower; private T upper; public Interval(T lower, T upper) &#123; this.lower = lower; this.upper = upper; &#125; //çœç•¥å…¶ä»–æ–¹æ³•&#125; ç±»å‹æ“¦é™¤åçš„Interval&lt;T extends Comparable &amp; Serializable&gt;åŸå§‹ç±»å‹ï¼š 123456789101112public class Interval implements Serializable &#123; private Comparable lower; private Comparable upper; public Interval(Comparable lower, Comparable upper) &#123; this.lower = lower; this.upper = upper; &#125; //çœç•¥å…¶ä»–æ–¹æ³•&#125; åƒä¸Šé¢è¿™ç§å¤šä¸ªæ³›å‹ä¸Šé™çš„ç±»å‹ï¼Œåº”è¯¥å°½é‡æŠŠæ ‡è¯†æ¥å£ä¸Šé™ç±»å‹æ”¾åœ¨è¾¹ç•Œåˆ—è¡¨çš„å°¾éƒ¨ï¼Œè¿™æ ·åšå¯ä»¥æé«˜æ•ˆç‡ã€‚ ä¸ºä»€ä¹ˆéœ€è¦æ“¦é™¤ç±»å‹ åœ¨JDK1.5ä¹‹å‰ï¼Œä¹Ÿå°±æ˜¯åœ¨æ³›å‹å‡ºç°ä¹‹å‰ï¼Œæ‰€æœ‰çš„ç±»å‹åŒ…æ‹¬åŸºæœ¬æ•°æ®ç±»å‹(intã€byteç­‰)ã€åŒ…è£…ç±»å‹ã€å…¶ä»–è‡ªå®šä¹‰çš„ç±»å‹ç­‰ç­‰éƒ½å¯ä»¥ä½¿ç”¨ç±»æ–‡ä»¶(.class)å­—èŠ‚ç å¯¹åº”çš„java.lang.Classæè¿°ï¼Œä¹Ÿå°±æ˜¯java.lang.Classç±»çš„ä¸€ä¸ªå…·ä½“å®ä¾‹å¯¹è±¡å°±å¯ä»¥ä»£è¡¨ä»»æ„ä¸€ä¸ªæŒ‡å®šç±»å‹çš„åŸå§‹ç±»å‹ã€‚è¿™é‡ŒæŠŠæ³›å‹å‡ºç°ä¹‹å‰çš„æ‰€æœ‰ç±»å‹æš‚æ—¶ç§°ä¸º&quot;å†å²åŸå§‹ç±»å‹&quot;ã€‚ åœ¨JDK1.5ä¹‹åï¼Œæ•°æ®ç±»å‹å¾—åˆ°äº†æ‰©å……ï¼Œå‡ºå†å²åŸå§‹ç±»å‹æ‰©å……äº†å››ç§æ³›å‹ç±»å‹ï¼šå‚æ•°åŒ–ç±»å‹(ParameterizedType)ã€ç±»å‹å˜é‡ç±»å‹(TypeVariable)ã€é™å®šç¬¦ç±»å‹(WildcardType)ã€æ³›å‹æ•°ç»„ç±»å‹(GenericArrayType)ã€‚å†å²åŸå§‹ç±»å‹å’Œæ–°æ‰©å……çš„æ³›å‹ç±»å‹éƒ½åº”è¯¥ç»Ÿä¸€æˆå„è‡ªçš„å­—èŠ‚ç æ–‡ä»¶ç±»å‹å¯¹è±¡ï¼Œä¹Ÿå°±åº”è¯¥æŠŠæ³›å‹ç±»å‹å½’å¹¶è¿›å»java.lang.Classä¸­ã€‚ä½†æ˜¯ç”±äºJDKå·²ç»è¿­ä»£äº†å¾ˆå¤šç‰ˆæœ¬ï¼Œæ³›å‹å¹¶ä¸å±äºå½“å‰Javaä¸­çš„åŸºæœ¬æˆåˆ†ï¼Œå¦‚æœJVMä¸­å¼•å…¥çœŸæ­£çš„æ³›å‹ç±»å‹ï¼Œé‚£ä¹ˆå¿…é¡»æ¶‰åŠåˆ°JVMæŒ‡ä»¤é›†å’Œå­—èŠ‚ç æ–‡ä»¶çš„ä¿®æ”¹(è¿™ä¸ªä¿®æ”¹è‚¯å®šä¸æ˜¯å°çš„ä¿®æ”¹ï¼Œå› ä¸ºJDKå½“æ—¶å·²ç»è¿­ä»£äº†å¾ˆå¤šå¹´ï¼Œè€Œç±»å‹æ˜¯ç¼–ç¨‹è¯­è¨€çš„ååˆ†åŸºç¡€çš„ç‰¹æ€§ï¼Œå¼•å…¥æ³›å‹ä»é¡¹ç›®åŠŸèƒ½è¿­ä»£è§’åº¦çœ‹å¯èƒ½éœ€è¦æ•´ä¸ªJVMé¡¹ç›®åšå›å½’æµ‹è¯•)ï¼Œè¿™ä¸ªåŠŸèƒ½çš„ä»£ä»·ååˆ†å·¨å¤§ï¼Œæ‰€ä»¥Javaæ²¡æœ‰åœ¨Javaè™šæ‹Ÿæœºå±‚é¢å¼•å…¥æ³›å‹ã€‚ Javaä¸ºäº†ä½¿ç”¨æ³›å‹ï¼Œäºæ˜¯ä½¿ç”¨äº†ç±»å‹æ“¦é™¤çš„æœºåˆ¶å¼•å…¥äº†&quot;æ³›å‹çš„ä½¿ç”¨&quot;ï¼Œå¹¶æ²¡æœ‰çœŸæ­£æ„ä¹‰ä¸Šå¼•å…¥å’Œå®ç°æ³›å‹ã€‚Javaä¸­çš„æ³›å‹å®ç°çš„æ˜¯ç¼–è¯‘æœŸçš„ç±»å‹å®‰å…¨ï¼Œä¹Ÿå°±æ˜¯æ³›å‹çš„ç±»å‹å®‰å…¨æ£€æŸ¥æ˜¯åœ¨ç¼–è¯‘æœŸç”±ç¼–è¯‘å™¨(å¸¸è§çš„æ˜¯javac)å®ç°çš„ï¼Œè¿™æ ·å°±èƒ½å¤Ÿç¡®ä¿æ•°æ®åŸºäºç±»å‹ä¸Šçš„å®‰å…¨æ€§å¹¶ä¸”é¿å…äº†å¼ºåˆ¶ç±»å‹è½¬æ¢çš„éº»çƒ¦(å®é™…ä¸Šï¼Œå¼ºåˆ¶ç±»å‹è½¬æ¢æ˜¯ç”±ç¼–è¯‘å™¨å®Œæˆäº†ï¼Œåªæ˜¯ä¸éœ€è¦äººä¸ºå»å®Œæˆè€Œå·²)ã€‚ä¸€æ—¦ç¼–è¯‘å®Œæˆï¼Œæ‰€æœ‰çš„æ³›å‹ç±»å‹éƒ½ä¼šè¢«æ“¦é™¤ï¼Œå¦‚æœæ²¡æœ‰æŒ‡å®šä¸Šé™ï¼Œå°±ä¼šæ“¦é™¤ä¸ºObjectç±»å‹ï¼Œå¦åˆ™æ“¦é™¤ä¸ºä¸Šé™ç±»å‹ã€‚ æ—¢ç„¶Javaè™šæ‹Ÿæœºä¸­ä¸å­˜åœ¨æ³›å‹ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆå¯ä»¥ä»JDKä¸­çš„ä¸€äº›ç±»åº“è·å–æ³›å‹ä¿¡æ¯ï¼Ÿè¿™æ˜¯å› ä¸ºç±»æ–‡ä»¶(.class)æˆ–è€…è¯´å­—èŠ‚ç æ–‡ä»¶æœ¬èº«å­˜å‚¨äº†æ³›å‹çš„ä¿¡æ¯ï¼Œç›¸å…³ç±»åº“(å¯ä»¥æ˜¯JDKçš„ç±»åº“ï¼Œä¹Ÿå¯ä»¥æ˜¯ç¬¬ä¸‰æ–¹çš„ç±»åº“)è¯»å–æ³›å‹ä¿¡æ¯çš„æ—¶å€™å¯ä»¥ä»å­—èŠ‚ç æ–‡ä»¶ä¸­æå–ï¼Œä¾‹å¦‚æ¯”è¾ƒå¸¸ç”¨çš„å­—èŠ‚ç æ“ä½œç±»åº“ASMå°±å¯ä»¥è¯»å–å­—èŠ‚ç ä¸­çš„ä¿¡æ¯ç”šè‡³æ”¹é€ å­—èŠ‚ç åŠ¨æ€ç”Ÿæˆç±»ã€‚ä¾‹å¦‚å‰é¢æåˆ°çš„Interval&lt;T extends Comparable &amp; Serializable&gt;ç±»ï¼Œä½¿ç”¨javap -c -vå‘½ä»¤æŸ¥çœ‹å…¶åç¼–è¯‘å¾—åˆ°çš„å­—èŠ‚ç ä¿¡æ¯ï¼Œå¯ä»¥çœ‹åˆ°å…¶ç­¾åå¦‚ä¸‹ï¼š 1Signature: #22 // &lt;T::Ljava/lang/Comparable;:Ljava/io/Serializable;&gt;Ljava/lang/Object;Ljava/io/Serializable; è¿™é‡Œçš„ç­¾åä¿¡æ¯å®é™…ä¸Šæ˜¯ä¿å­˜åœ¨å¸¸é‡æ± ä¸­çš„ï¼Œå…³äºå­—èŠ‚ç æ–‡ä»¶çš„è§£æå°†æ¥ä¼šå‡ºä¸€ä¸ªç³»åˆ—æ–‡ç« è¯¦ç»†å±•å¼€ã€‚ Typeä½“ç³» å‰æ–‡æåˆ°äº†åœ¨JDK1.5ä¸­å¼•å…¥äº†å››ç§æ–°çš„æ³›å‹ç±»å‹java.lang.reflect.ParameterizedTypeã€java.lang.reflect.TypeVariableã€java.lang.reflect.WildcardTypeã€java.lang.reflect.GenericArrayTypeï¼ŒåŒ…æ‹¬åŸæ¥å­˜åœ¨çš„java.lang.Classï¼Œä¸€å…±å­˜åœ¨äº”ç§ç±»å‹ã€‚ä¸ºäº†ç¨‹åºçš„æ‰©å±•æ€§ï¼Œå¼•å…¥äº†java.lang.reflect.Typeç±»ä½œä¸ºè¿™äº”ç§ç±»å‹çš„å…¬å…±çˆ¶æ¥å£ï¼Œè¿™æ ·å­å°±å¯ä»¥ä½¿ç”¨java.lang.reflect.Typeç±»å‹å‚æ•°å»æ¥æ”¶ä»¥ä¸Šäº”ç§å­ç±»å‹çš„å®å‚æˆ–è€…è¿”å›å€¼ï¼Œç”±æ­¤ä»é€»è¾‘ä¸Šç»Ÿä¸€äº†æ³›å‹ç›¸å…³çš„ç±»å‹å’ŒåŸå§‹å­˜åœ¨çš„java.lang.Classæè¿°çš„ç±»å‹ã€‚Typeä½“ç³»å¦‚ä¸‹ï¼š æ³¨æ„ï¼š ParameterizedTypeã€TypeVariableã€WildcardTypeã€GenericArrayTypeéƒ½æ˜¯æ¥å£ï¼Œå®ƒä»¬ä½äºjava.lang.reflectåŒ…ä¸­ã€‚ ParameterizedTypeImplã€TypeVariableImplã€WildcardTypeImplã€GenericArrayTypeImplæ˜¯å››ç§æ³›å‹ç±»å‹çš„å®ç°ï¼Œä½äºsun.reflect.generics.reflectiveObjectsåŒ…ä¸­ã€‚ Typeä½“ç³»è™½ç„¶çœ‹ä¼¼å¾ˆç¾å¥½è§£å†³äº†æ³›å‹ç›¸å…³çš„ç±»å‹å’ŒåŸå§‹å­˜åœ¨çš„java.lang.Classæè¿°çš„ç±»å‹çš„ç»Ÿä¸€é—®é¢˜ï¼Œä½†æ˜¯å¼•å…¥äº†æ–°çš„é—®é¢˜ï¼šå¦‚æœä¸€ä¸ªæ–¹æ³•è¿”å›å€¼ä¸ºjava.lang.reflect.Typeç±»å‹ï¼Œæˆ–è€…ä¸€ä¸ªæ–¹æ³•çš„å…¥å‚ç±»å‹ä¸ºjava.lang.reflect.Typeç±»å‹ï¼Œè¿™ä¸¤ç§æƒ…å†µä¸‹ï¼Œå¯èƒ½éœ€è¦å¯¹java.lang.reflect.Typeç±»å‹çš„å¯¹è±¡åšå­ç±»å‹åˆ¤æ–­ï¼Œå› ä¸ºå®ƒçš„å­ç±»å‹æœ‰å¯èƒ½æ˜¯ä¸Šé¢æåˆ°çš„äº”ç§ç±»å‹ä¸­çš„å…¶ä¸­ä¸€ç§ï¼Œè¿™ä¸€ç‚¹æé«˜äº†ç¼–ç çš„å¤æ‚æ€§ã€‚ ParameterizedType ParameterizedTypeï¼Œparameterized typeï¼Œä¹Ÿå°±æ˜¯å‚æ•°åŒ–ç±»å‹ï¼Œæ³¨é‡Šé‡Œé¢è¯´åˆ°ParameterizedTypeè¡¨ç¤ºä¸€ä¸ªå‚æ•°åŒ–ç±»å‹ï¼Œä¾‹å¦‚Collection&lt;String&gt;ï¼Œå®é™…ä¸Šåªè¦å¸¦æœ‰å‚æ•°åŒ–(æ³›å‹)æ ‡ç­¾&lt;ClassName&gt;çš„å‚æ•°æˆ–è€…å±æ€§ï¼Œéƒ½å±äºParameterizedTypeã€‚ä¾‹å¦‚ä¸‹é¢çš„ç±»å‹éƒ½æ˜¯ParameterizedTypeï¼š 12345678Set&lt;String&gt; set;Class&lt;Integer&gt; clazz;MyClass&lt;String&gt; myClass;List&lt;String&gt; list;class MyClass&lt;V&gt;&#123;&#125; è€Œåƒä¸‹é¢çš„å¿½ç•¥æ³›å‹å‚æ•°æˆ–è€…åŸºæœ¬æ•°æ®ç±»å‹å’ŒåŸºæœ¬æ•°æ®ç±»å‹çš„åŒ…è£…ç±»éƒ½ä¸æ˜¯ParameterizedTypeï¼š 12345678String name = \"throwbale\";int age = 25;Set set;List list;public String method(int age,String name)&#123;&#125; java.lang.reflect.ParameterizedTypeæ¥å£ç»§æ‰¿è‡ªjava.lang.reflect.Typeæ¥å£ï¼Œå®ç°ç±»æ˜¯sun.reflect.generics.reflectiveObjects.ParameterizedTypeImplï¼Œå…¶å®ï¼Œå¿…è¦çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªè¡Œå®ç°ParameterizedTypeï¼Œåƒä¸€äº›Jsonè§£æå·¥å…·éƒ½æ˜¯è‡ªè¡Œå®ç°ParameterizedTypeçš„ã€‚ParameterizedTypeæ¥å£çš„æ–¹æ³•å¦‚ä¸‹ï¼š 12345678public interface ParameterizedType extends Type &#123; Type[] getActualTypeArguments(); Type getRawType(); Type getOwnerType();&#125; Type[] getActualTypeArguments()ï¼šè¿”å›è¿™ä¸ªParameterizedTypeç±»å‹çš„å‚æ•°çš„å®é™…ç±»å‹Typeæ•°ç»„ï¼ŒTypeæ•°ç»„é‡Œé¢çš„å…ƒç´ æœ‰å¯èƒ½æ˜¯Classã€ParameterizedTypeã€TypeVariableã€GenericArrayTypeæˆ–è€…WildcardTypeä¹‹ä¸€ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œæ— è®ºæ³›å‹ç¬¦å·&lt;&gt;ä¸­æœ‰å‡ å±‚&lt;&gt;åµŒå¥—ï¼Œè¿™ä¸ªæ–¹æ³•ä»…ä»…è„±å»æœ€å¤–å±‚çš„&lt;&gt;ï¼Œä¹‹åå‰©ä¸‹çš„å†…å®¹å°±ä½œä¸ºè¿™ä¸ªæ–¹æ³•çš„è¿”å›å€¼ã€‚ Type getRawType()ï¼šè¿”å›çš„æ˜¯å½“å‰è¿™ä¸ªParameterizedTypeçš„åŸå§‹ç±»å‹ï¼Œä»ParameterizedTypeImplçš„æºç çœ‹æ¥ï¼ŒåŸå§‹ç±»å‹rawTypeä¸€å®šæ˜¯ä¸€ä¸ªClass&lt;?&gt;å®ä¾‹ã€‚ä¸¾ä¸ªä¾‹å­ï¼ŒList&lt;Person&gt;é€šè¿‡getRawType()è·å–åˆ°çš„Typeå®ä¾‹å®é™…ä¸Šæ˜¯Class&lt;?&gt;å®ä¾‹ï¼Œå’ŒList.classç­‰ä»·ã€‚ Type getOwnerType()ï¼šè·å–åŸå§‹ç±»å‹æ‰€å±çš„ç±»å‹ï¼Œä»ParameterizedTypeImplçš„æºç çœ‹æ¥ï¼Œå°±æ˜¯è°ƒç”¨äº†åŸå§‹ç±»å‹rawTypeçš„getDeclaringClass()æ–¹æ³•ï¼Œè€ŒåƒrawTypeä¸ºList&lt;T&gt;ã€Map&lt;T&gt;è¿™äº›ç±»å‹çš„getOwnerType()å®é™…ä¸Šå°±æ˜¯è°ƒç”¨List.class.getDeclaringClass()ï¼ŒMap.class.getDeclaringClass()ï¼Œè¿”å›å€¼éƒ½æ˜¯nullã€‚ ä¸¾ä¸ªå…³äºParameterizedTypeçš„ç®€å•ä½¿ç”¨ä¾‹å­ï¼š 123456789101112131415161718192021222324252627282930public class Main13 &#123; public static void main(String[] args) throws Exception &#123; Class&lt;Sub&gt; subClass = Sub.class; Type genericSuperclass = subClass.getGenericSuperclass(); if (genericSuperclass instanceof ParameterizedType) &#123; ParameterizedType parameterizedType = (ParameterizedType) genericSuperclass; //è·å–çˆ¶ç±»æ³›å‹ç±»å‹æ•°ç»„ Type[] actualTypeArguments = parameterizedType.getActualTypeArguments(); for (Type type : actualTypeArguments) &#123; System.out.println(type + \" is ParameterizedType -&gt; \" + (type instanceof ParameterizedType)); &#125; &#125; Field field = subClass.getDeclaredField(\"clazz\"); Type genericType = field.getGenericType(); System.out.println(genericType + \" is ParameterizedType -&gt; \" + (genericType instanceof ParameterizedType)); &#125; public static class Person &#123; &#125; public static abstract class Supper&lt;T, E&gt; &#123; &#125; public static class Sub extends Supper&lt;String, List&lt;Person&gt;&gt; &#123; &#125;&#125; è¾“å‡ºç»“æœï¼š 123class java.lang.String is ParameterizedType -&gt; falsejava.util.List&lt;org.throwable.inherited.Main13$Person&gt; is ParameterizedType -&gt; truejava.lang.Class&lt;?&gt; is ParameterizedType -&gt; true TypeVariable TypeVariableï¼Œtype variableï¼Œä¹Ÿå°±æ˜¯ç±»å‹å˜é‡ï¼Œå®ƒæ˜¯å„ç§ç±»å‹å˜é‡çš„å…¬å…±çˆ¶æ¥å£ï¼Œå®ƒä¸»è¦ç”¨æ¥è¡¨ç¤ºå¸¦æœ‰ä¸Šç•Œçš„æ³›å‹å‚æ•°çš„ä¿¡æ¯ï¼Œå®ƒå’ŒParameterizedTypeä¸åŒçš„åœ°æ–¹æ˜¯ï¼ŒParameterizedTypeè¡¨ç¤ºçš„å‚æ•°çš„æœ€å¤–å±‚ä¸€å®šæ˜¯å·²çŸ¥å…·ä½“ç±»å‹çš„(å¦‚List&lt;String&gt;)ï¼Œè€ŒTypeVariableé¢å‘çš„æ˜¯Kã€Vã€Eç­‰è¿™äº›æ³›å‹å‚æ•°å­—é¢é‡çš„è¡¨ç¤ºã€‚å¸¸è§çš„TypeVariableçš„è¡¨ç¤ºå½¢å¼æ˜¯&lt;T extends KnownType-1 &amp; KnownType-2&gt;ã€‚TypeVariableæ¥å£æºç å¦‚ä¸‹ï¼š 12345678910public interface TypeVariable&lt;D extends GenericDeclaration&gt; extends Type &#123; //è·å¾—æ³›å‹çš„ä¸Šé™ï¼Œè‹¥æœªæ˜ç¡®å£°æ˜ä¸Šè¾¹ç•Œåˆ™é»˜è®¤ä¸ºObject Type[] getBounds(); //è·å–å£°æ˜è¯¥ç±»å‹å˜é‡å®ä½“(å³è·å¾—ç±»ã€æ–¹æ³•æˆ–æ„é€ å™¨å) D getGenericDeclaration(); //è·å¾—åç§°ï¼Œå³Kã€Vã€Eä¹‹ç±»åç§° String getName(); //è·å¾—æ³¨è§£ç±»å‹çš„ä¸Šé™ï¼Œè‹¥æœªæ˜ç¡®å£°æ˜ä¸Šè¾¹ç•Œåˆ™é»˜è®¤ä¸ºé•¿åº¦ä¸º0çš„æ•°ç»„ AnnotatedType[] getAnnotatedBounds()&#125; Type[] getBounds()ï¼šè·å¾—è¯¥ç±»å‹å˜é‡çš„ä¸Šé™(ä¸Šè¾¹ç•Œ)ï¼Œè‹¥æ— æ˜¾å¼å®šä¹‰(extends)ï¼Œé»˜è®¤ä¸ºObjectï¼Œç±»å‹å˜é‡çš„ä¸Šé™å¯èƒ½ä¸æ­¢ä¸€ä¸ªï¼Œå› ä¸ºå¯ä»¥ç”¨&amp;ç¬¦å·é™å®šå¤šä¸ªï¼ˆè¿™å…¶ä¸­æœ‰ä¸”åªèƒ½æœ‰ä¸€ä¸ªä¸ºç±»æˆ–æŠ½è±¡ç±»ï¼Œä¸”å¿…é¡»æ”¾åœ¨extendsåçš„ç¬¬ä¸€ä¸ªï¼Œå³è‹¥æœ‰å¤šä¸ªä¸Šè¾¹ç•Œï¼Œåˆ™ç¬¬ä¸€ä¸ª&amp;ä¹‹åçš„å¿…ä¸ºæ¥å£ï¼‰ã€‚ D getGenericDeclarationï¼šè·å¾—å£°æ˜(å®šä¹‰)è¿™ä¸ªç±»å‹å˜é‡çš„ç±»å‹åŠåç§°ï¼Œä¼šä½¿ç”¨æ³›å‹çš„å‚æ•°å­—é¢é‡è¡¨ç¤ºï¼Œå¦‚public void club.throwable.Main.query(java.util.List&lt;club.throwable.Person&gt;)ã€‚ String getName()ï¼šè·å–æ³›å‹å‚æ•°çš„å­—é¢é‡åç§°ï¼Œå³Kã€Vã€Eä¹‹ç±»åç§°ã€‚ AnnotatedType[] getAnnotatedBounds()ï¼šJdk1.8æ–°å¢çš„æ–¹æ³•ï¼Œç”¨äºè·å¾—æ³¨è§£ç±»å‹çš„ä¸Šé™ï¼Œè‹¥æœªæ˜ç¡®å£°æ˜ä¸Šè¾¹ç•Œåˆ™é»˜è®¤ä¸ºé•¿åº¦ä¸º0çš„æ•°ç»„ã€‚ ä¸¾ä¸ªå…³äºTypeVariableçš„ç®€å•ä½¿ç”¨ä¾‹å­ï¼š 123456789101112131415161718192021222324252627282930313233343536373839public class Main14 &#123; public static void main(String[] args) throws Exception &#123; Class&lt;Supper&gt; subClass = Supper.class; TypeVariable&lt;Class&lt;Supper&gt;&gt;[] typeParameters = subClass.getTypeParameters(); for (TypeVariable&lt;Class&lt;Supper&gt;&gt; typeVariable : typeParameters) &#123; System.out.println(\"getBounds --&gt; \" + Arrays.toString(typeVariable.getBounds())); System.out.println(\"getGenericDeclaration --&gt; \" + typeVariable.getGenericDeclaration()); System.out.println(\"getName --&gt; \" + typeVariable.getName()); AnnotatedType[] annotatedBounds = typeVariable.getAnnotatedBounds(); StringBuilder stringBuilder = new StringBuilder(\"getAnnotatedBounds --&gt; \"); for (AnnotatedType annotatedType : annotatedBounds) &#123; java.lang.annotation.Annotation[] annotations = annotatedType.getAnnotations(); for (java.lang.annotation.Annotation annotation : annotations) &#123; stringBuilder.append(annotation).append(\",\"); &#125; &#125; System.out.println(stringBuilder.toString()); System.out.println(\"===================\"); &#125; &#125; @Target(ElementType.TYPE) public @interface Annotation &#123; &#125; interface InterFace &#123; &#125; public static class Person &#123; &#125; public static abstract class Supper&lt;T extends Person &amp; InterFace, E extends Annotation&gt; &#123; &#125;&#125; è¾“å‡ºç»“æœï¼š 12345678910getBounds --&gt; [class org.throwable.inherited.Main14$Person, interface org.throwable.inherited.Main14$InterFace]getGenericDeclaration --&gt; class org.throwable.inherited.Main14$SuppergetName --&gt; TgetAnnotatedBounds --&gt;===================getBounds --&gt; [interface org.throwable.inherited.Main14$Annotation]getGenericDeclaration --&gt; class org.throwable.inherited.Main14$SuppergetName --&gt; EgetAnnotatedBounds --&gt;=================== WildcardType WildcardTypeç”¨äºè¡¨ç¤ºé€šé…ç¬¦(?)ç±»å‹çš„è¡¨è¾¾å¼çš„æ³›å‹å‚æ•°ï¼Œä¾‹å¦‚&lt;? extends Number&gt;ç­‰ã€‚æ ¹æ®WildcardTypeæ³¨é‡Šæç¤ºï¼šç°é˜¶æ®µé€šé…ç¬¦è¡¨è¾¾å¼ä»…ä»…æ¥å—ä¸€ä¸ªä¸Šè¾¹ç•Œæˆ–è€…ä¸‹è¾¹ç•Œï¼Œè¿™ä¸ªå’Œå®šä¹‰ç±»å‹å˜é‡æ—¶å€™å¯ä»¥æŒ‡å®šå¤šä¸ªä¸Šè¾¹ç•Œæ˜¯ä¸ä¸€æ ·ã€‚ä½†æ˜¯ä¸ºäº†ä¿æŒæ‰©å±•æ€§ï¼Œè¿™é‡Œè¿”å›å€¼ç±»å‹å†™æˆäº†æ•°ç»„å½¢å¼ã€‚å®é™…ä¸Šç°åœ¨è¿”å›çš„æ•°ç»„çš„å¤§å°å°±æ˜¯1ã€‚WildcardTypeæ¥å£æºç å¦‚ä¸‹ï¼š 123456public interface WildcardType extends Type &#123; Type[] getUpperBounds(); Type[] getLowerBounds();&#125; Type[] getUpperBounds()ï¼šè·å–æ³›å‹é€šé…ç¬¦çš„ä¸Šé™ç±»å‹Typeæ•°ç»„ï¼Œå®é™…ä¸Šç›®å‰è¯¥æ•°ç»„åªæœ‰ä¸€ä¸ªå…ƒç´ ï¼Œä¹Ÿå°±æ˜¯è¯´åªèƒ½æœ‰ä¸€ä¸ªä¸Šé™ç±»å‹ã€‚ Type[] getLowerBounds()ï¼šè·å–æ³›å‹é€šé…ç¬¦çš„ä¸‹é™ç±»å‹Typeæ•°ç»„ï¼Œå®é™…ä¸Šç›®å‰è¯¥æ•°ç»„åªæœ‰ä¸€ä¸ªå…ƒç´ ï¼Œä¹Ÿå°±æ˜¯è¯´åªèƒ½æœ‰ä¸€ä¸ªä¸‹é™ç±»å‹ã€‚ ä¸¾ä¸ªå…³äºWildcardTypeçš„ç®€å•ä½¿ç”¨ä¾‹å­ï¼š 123456789101112131415161718192021222324252627282930313233343536public class Main16 &#123; public static void main(String[] args) &#123; Class&lt;Main16&gt; clazz = Main16.class; Method[] methods = clazz.getMethods(); for (Method method : methods) &#123; if (\"print\".equals(method.getName())) &#123; Type[] genericParameterTypes = method.getGenericParameterTypes(); for (Type type : genericParameterTypes) &#123; if (type instanceof ParameterizedType) &#123; ParameterizedType parameterizedType = (ParameterizedType) type; Type[] actualTypeArguments = parameterizedType.getActualTypeArguments(); for (Type actualType : actualTypeArguments) &#123; if (actualType instanceof WildcardType) &#123; WildcardType wildcardType = (WildcardType) actualType; System.out.println(\"WildcardType --&gt; \" + wildcardType + \" getUpperBounds--&gt; \" + Arrays.toString(wildcardType.getUpperBounds()) + \" getLowerBounds--&gt; \" + Arrays.toString(wildcardType.getLowerBounds())); &#125; else &#123; System.out.println(\"Not WildcardType --&gt; \" + actualType); &#125; &#125; &#125; &#125; &#125; &#125; &#125; interface Person &#123; &#125; public static void print(List&lt;? extends Number&gt; list, Set&lt;? super Person&gt; persons) &#123; &#125;&#125; è¾“å‡ºç»“æœï¼š 12WildcardType --&gt; ? extends java.lang.Number getUpperBounds--&gt; [class java.lang.Number] getLowerBounds--&gt; []WildcardType --&gt; ? super org.throwable.inherited.Main16$Person getUpperBounds--&gt; [class java.lang.Object] getLowerBounds--&gt; [interface org.throwable.inherited.Main16$Person] è¿™é‡Œæ³¨æ„çš„æ˜¯List&lt;? extends Number&gt; listè¿™ä¸ªå‚æ•°æ•´ä½“æ¥çœ‹æ˜¯ParameterizedTypeç±»å‹ï¼Œå‰¥æ‰ç¬¬ä¸€æ¬¡Listä¹‹åçš„? extends Numberæ˜¯WildcardTypeç±»å‹ã€‚ GenericArrayType GenericArrayTypeï¼Œgeneric array typeï¼Œä¹Ÿå°±æ˜¯æ³›å‹æ•°ç»„ï¼Œä¹Ÿå°±æ˜¯å…ƒç´ ç±»å‹ä¸ºæ³›å‹ç±»å‹çš„æ•°ç»„å®ç°äº†è¯¥æ¥å£ã€‚å®ƒè¦æ±‚å…ƒç´ çš„ç±»å‹æ˜¯ParameterizedTypeæˆ–TypeVariable(å®é™…ä¸­å‘ç°å…ƒç´ æ˜¯GenericArrayTypeä¹Ÿæ˜¯å…è®¸çš„)ã€‚ä¸¾ä¸ªä¾‹å­ï¼š 12345List&lt;String&gt;[] listArray; //æ˜¯GenericArrayType,å…ƒç´ æ˜¯List&lt;String&gt;ç±»å‹ï¼Œä¹Ÿå°±æ˜¯ParameterizedTypeç±»å‹T[] tArray; //æ˜¯GenericArrayType,å…ƒç´ æ˜¯Tç±»å‹ï¼Œä¹Ÿå°±æ˜¯TypeVariableç±»å‹Person[] persons; //ä¸æ˜¯GenericArrayTypeList&lt;String&gt; strings; //ä¸æ˜¯GenericArrayType GenericArrayTypeæ¥å£çš„æºç å¦‚ä¸‹ï¼š 1234public interface GenericArrayType extends Type &#123; Type getGenericComponentType();&#125; Type getGenericComponentType()ï¼šè·å–æ³›å‹æ•°ç»„ä¸­å…ƒç´ çš„ç±»å‹ã€‚æ³¨æ„æ— è®ºä»å·¦å‘å³æœ‰å‡ ä¸ª[]å¹¶åˆ—ï¼Œè¿™ä¸ªæ–¹æ³•ä»…ä»…è„±å»æœ€å³è¾¹çš„[]ä¹‹åå‰©ä¸‹çš„å†…å®¹å°±ä½œä¸ºè¿™ä¸ªæ–¹æ³•çš„è¿”å›å€¼ã€‚ ä¸¾ä¸ªå…³äºGenericArrayTypeçš„ç®€å•ä½¿ç”¨ä¾‹å­ï¼š 123456789101112131415161718192021222324public class Main15&lt;T&gt; &#123; public static void main(String[] args) throws Exception &#123; Method[] methods = Main15.class.getMethods(); for (Method method : methods) &#123; if (\"method\".equals(method.getName())) &#123; Type[] genericParameterTypes = method.getGenericParameterTypes(); for (Type type : genericParameterTypes) &#123; if (type instanceof GenericArrayType) &#123; System.out.println(\"GenericArrayType --&gt; \" + type + \" getGenericComponentType --&gt; \" + ((GenericArrayType) type).getGenericComponentType()); &#125; else &#123; System.out.println(\"Not GenericArrayType --&gt; \" + type); &#125; &#125; &#125; &#125; &#125; public static &lt;T&gt; void method(String[] strings, List&lt;String&gt; ls, List&lt;String&gt;[] lsa, T[] ts, List&lt;T&gt;[] tla, T[][] tts) &#123; &#125;&#125; è¾“å‡ºç»“æœï¼š 123456Not GenericArrayType --&gt; class [Ljava.lang.String;Not GenericArrayType --&gt; java.util.List&lt;java.lang.String&gt;GenericArrayType --&gt; java.util.List&lt;java.lang.String&gt;[] getGenericComponentType --&gt; java.util.List&lt;java.lang.String&gt;GenericArrayType --&gt; T[] getGenericComponentType --&gt; TGenericArrayType --&gt; java.util.List&lt;T&gt;[] getGenericComponentType --&gt; java.util.List&lt;T&gt;GenericArrayType --&gt; T[][] getGenericComponentType --&gt; T[] è¿™é‡Œåˆ†æä¸€ä¸‹ï¼š String[] stringsï¼šæ•°ç»„æ˜¯Classç±»å‹ã€‚ List&lt;String&gt; lsï¼šåˆ—è¡¨æ˜¯ParameterizedTypeç±»å‹ã€‚ List&lt;String&gt;[] lsaï¼šæ•°ç»„æ˜¯GenericArrayTypeç±»å‹ï¼Œè°ƒç”¨getGenericComponentTypeåè¿”å›çš„ç±»å‹æ˜¯java.util.List&lt;java.lang.String&gt;ï¼Œä¹Ÿå°±æ˜¯æ•°ç»„å…ƒç´ æ˜¯ParameterizedTypeç±»å‹ã€‚ T[] tsï¼šsæ•°ç»„æ˜¯GenericArrayTypeç±»å‹ï¼Œè°ƒç”¨getGenericComponentTypeåè¿”å›çš„ç±»å‹æ˜¯Tï¼Œä¹Ÿå°±æ˜¯æ•°ç»„å…ƒç´ æ˜¯TypeVariableç±»å‹ã€‚ List&lt;T&gt;[] tlaï¼šæ•°ç»„æ˜¯GenericArrayTypeç±»å‹ï¼Œè°ƒç”¨getGenericComponentTypeåè¿”å›çš„ç±»å‹æ˜¯java.util.List&lt;T&gt;ï¼Œä¹Ÿå°±æ˜¯æ•°ç»„å…ƒç´ æ˜¯ParameterizedTypeç±»å‹ã€‚ T[][] ttsï¼šæ•°ç»„æ˜¯GenericArrayTypeç±»å‹ï¼Œè°ƒç”¨getGenericComponentTypeåè¿”å›çš„ç±»å‹T[]ï¼Œä¹Ÿå°±æ˜¯æ•°ç»„å…ƒç´ æ˜¯GenericArrayTypeç±»å‹ã€‚ æ³›å‹çš„çº¦æŸ ä½¿ç”¨Javaæ³›å‹çš„æ—¶å€™éœ€è¦è€ƒè™‘ä¸€äº›é™åˆ¶ï¼Œè¿™äº›é™åˆ¶å¤§å¤šæ•°æ˜¯ç”±æ³›å‹ç±»å‹æ“¦é™¤å¼•èµ·çš„ã€‚ 1ã€ä¸èƒ½ç”¨åŸºæœ¬ç±»å‹å®ä¾‹åŒ–ç±»å‹å‚æ•°ï¼Œä¹Ÿå°±æ˜¯8ç§åŸºæœ¬ç±»å‹ä¸èƒ½ä½œä¸ºæ³›å‹å‚æ•°ï¼Œä¾‹å¦‚Pair&lt;int&gt;æ˜¯éæ³•çš„ï¼Œä¼šå¯¼è‡´ç¼–è¯‘é”™è¯¯ï¼Œè€ŒPair&lt;Integer&gt;æ˜¯åˆæ³•çš„ã€‚ 2ã€è¿è¡Œæ—¶çš„ç±»å‹æŸ¥è¯¢åªèƒ½é€‚ç”¨äºåŸå§‹ç±»å‹(éå‚æ•°åŒ–ç±»å‹)ã€‚ 1234567//ä¸‹é¢çš„ä¸¤ç§åšæ³•æ˜¯é”™è¯¯çš„if(a instanceof Pair&lt;String&gt;) //Errorif(a instanceof Pair&lt;T&gt;) //Error// æ­£ç¡®åšæ³•if(a instanceof Pair) //Right 3ã€ä¸èƒ½åˆ›å»ºå‚æ•°åŒ–ç±»å‹çš„æ•°ç»„ï¼Œä¾‹å¦‚Pair&lt;String&gt;[] arr = new Pair&lt;String&gt;[10]æ˜¯éæ³•çš„ã€‚ 4ã€ä¸èƒ½å®ä¾‹åŒ–ç±»å‹å˜é‡æˆ–è€…ç±»å‹å˜é‡æ•°ç»„ï¼Œä¾‹å¦‚T t = new T()æˆ–è€…T[] arr = new T[10]éƒ½æ˜¯éæ³•çš„ã€‚ 5ã€Varargsè­¦å‘Šï¼Œè¿™æ˜¯å› ä¸ºç¬¬4ç‚¹åŸå› å¯¼è‡´çš„ï¼Œä¸€èˆ¬ä¼šå‘ç”Ÿåœ¨æ³›å‹ç±»å‹å˜é‡ä½œä¸ºå¯å˜å‚æ•°çš„æƒ…å†µï¼Œä¾‹å¦‚public static &lt;T&gt; addAll(Collection&lt;T&gt; con,T ... ts)ï¼Œç¬¬äºŒä¸ªå‚æ•°å®é™…ä¸Šå°±æ˜¯æ³›å‹ç±»å‹å˜é‡æ•°ç»„ï¼Œä½†æ˜¯è¿™ç§æƒ…å†µæ˜¯åˆæ³•çš„ï¼Œä¸è¿‡ä¼šå—åˆ°ç¼–è¯‘å™¨çš„è­¦å‘Šï¼Œå¯ä»¥é€šè¿‡@SuppressWarnings(&quot;unchecked&quot;)æ³¨è§£æˆ–è€…@SafeVarargsæ³¨è§£æ ‡æ³¨è¯¥æ–¹æ³•ä»¥æ¶ˆé™¤è­¦å‘Šã€‚ 6ã€ä¸èƒ½åœ¨é™æ€åŸŸæˆ–è€…æ–¹æ³•ä¸­å¼•ç”¨ç±»å‹å˜é‡ï¼Œä¾‹å¦‚private static T singleInstance;è¿™æ ·æ˜¯éæ³•çš„ã€‚ 7ã€ä¸èƒ½æŠ›å‡ºæˆ–è€…æŠ›å‡ºæˆ–è€…æ•è·æ³›å‹ç±»å‹å˜é‡ï¼Œä½†æ˜¯å¦‚æœåœ¨å¼‚å¸¸è§„èŒƒä¸­ä½¿ç”¨æ³›å‹ç±»å‹å˜é‡åˆ™æ˜¯å…è®¸çš„ï¼Œä¸¾ä¸¤ä¸ªä¾‹å­ä»”ç»†å“å‘³ä¸€ä¸‹ï¼š 1234567891011121314151617// åä¾‹public static &lt;T extends Throwable&gt; void doWork(Class&lt;T&gt; t) &#123; try&#123; &#125;catch(T t)&#123; //Error &#125;&#125;// æ­£ä¾‹public static &lt;T extends Throwable&gt; void doWork(T t) throws T&#123; try&#123; &#125;catch(Throwable e)&#123; throw e; &#125;&#125; 8ã€é€šè¿‡ä½¿ç”¨@SuppressWarnings(&quot;unchecked&quot;)æ³¨è§£å¯ä»¥æ¶ˆé™¤Javaç±»å‹ç³»ç»Ÿçš„éƒ¨åˆ†åŸºæœ¬é™åˆ¶ï¼Œä¸€èˆ¬ä½¿ç”¨åœ¨å¼ºåˆ¶è½¬æ¢åŸå§‹ç±»å‹ä¸ºæ³›å‹ç±»å‹(åªæ˜¯åœ¨ç¼–è¯‘å±‚é¢å‘ŠçŸ¥ç¼–è¯‘å™¨)çš„æƒ…å†µï¼Œå¦‚ï¼š 12345// ä¸åŠ æ­¤æ³¨è§£ä¼šæ”¶åˆ°ç¼–è¯‘å™¨çš„è­¦å‘Š@SuppressWarnings(\"unchecked\")public static &lt;T extends Throwable&gt; void throwAs(Throwable e)&#123; throw (T) e;&#125; å…¶å®è¿˜æœ‰æ³›å‹çš„ç»§æ‰¿è§„åˆ™å’Œé€šé…ç¬¦è§„åˆ™(å¯ä»¥çœ‹ä¸‹å‰é¢ä»‹ç»çš„Typeçš„å­ç±»å‹)ç­‰ç­‰ï¼Œè¿™é‡Œä¸è¯¦ç»†å±•å¼€ã€‚ å†è®®æ³›å‹æ•°ç»„çš„é—®é¢˜ åœ¨Javaæ³›å‹çº¦æŸä¸­ï¼Œæ— æ³•å®ä¾‹åŒ–å‚æ•°åŒ–ç±»å‹æ•°ç»„ï¼Œä¾‹å¦‚Pair&lt;Integer&gt;[] table = new Pair&lt;Integer&gt;[10];æ˜¯éæ³•çš„ã€‚æ ¹æœ¬åŸå› åœ¨äºæ³›å‹ç±»å‹çš„æ“¦é™¤å’Œæ•°ç»„ä¼šè®°å½•å…ƒç´ ç±»å‹çš„ç‰¹æ€§ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾å¯ä»¥å®ä¾‹åŒ–å‚æ•°åŒ–ç±»å‹æ•°ç»„ï¼š 1Pair&lt;String&gt;[] table = new Pair&lt;String&gt;[10]; ä¸Šé¢çš„å‚æ•°åŒ–ç±»å‹æ•°ç»„åœ¨æ³›å‹æ“¦é™¤ä¹‹åï¼Œæ•°ç»„å®ä¾‹tableçš„ç±»å‹ä¸ºPair[]ï¼Œæ•°ç»„å…ƒç´ ç±»å‹ä¸ºPairï¼Œå¯ä»¥å¼ºè½¬ä¸ºObject[]ç±»å‹æ•°ç»„ï¼š 1Object[] objArray = table; åŸºäºæ³›å‹æ“¦é™¤ï¼Œæ•°ç»„objArrayå¯ä»¥ä»»æ„èµ‹å€¼Pair&lt;AnyType&gt;çš„æ³›å‹åŒ–å®ä¾‹ï¼Œä¾‹å¦‚ï¼š 1234objArray[0] = new Pair&lt;Integer&gt;();objArray[1] = new Pair&lt;Long&gt;();objArray[2] = new Pair&lt;String&gt;();.... è¿™æ ·å­èƒ½å¤Ÿé€šè¿‡æ•°ç»„å­˜å‚¨å…ƒç´ çš„æ£€æŸ¥ï¼Œåç»­æ“ä½œæ•°ç»„å…ƒç´ éšæ—¶ä¼šå‡ºç°ClassCastExceptionã€‚åŸºäºä»¥ä¸Šçš„åŸå› ï¼ŒJavaä»ç¼–è¯‘å±‚é¢ç›´æ¥æ‹’ç»åˆ›å»ºå‚æ•°åŒ–ç±»å‹æ•°ç»„ã€‚ å¦å¤–ï¼Œç±»å‹å˜é‡æ•°ç»„çš„å®ä¾‹åŒ–ä¹Ÿæ˜¯éæ³•çš„ï¼Œå¦‚T[] tt = new T[10];ï¼Œè¿™æ˜¯å› ä¸ºç±»å‹å˜é‡ä»…ä»…æ˜¯ç¼–è¯‘æœŸçš„å­—é¢é‡ï¼Œå…¶å®å’ŒJavaçš„ç±»å‹ä½“ç³»æ˜¯ä¸ç›¸å…³çš„ã€‚ ä½†æ˜¯è¦æ³¨æ„ä¸€ç‚¹ï¼šå‚æ•°åŒ–ç±»å‹æ•°ç»„å’Œç±»å‹å˜é‡æ•°ç»„å¯ä»¥ä½œä¸ºæ–¹æ³•å…¥å‚å˜é‡æˆ–è€…ç±»çš„æˆå‘˜å˜é‡ã€‚ä¾‹å¦‚ä¸‹é¢çš„åšæ³•æ˜¯åˆæ³•çš„ï¼š 12345678910111213public class Pair&lt;T&gt; &#123; private Pair&lt;T&gt;[] attr; private T[] ts; public static &lt;T&gt; void method(Pair&lt;T&gt; pair) &#123; &#125; public static &lt;T&gt; void method(T[] ts) &#123; &#125;&#125; æœ€åä¸€ç‚¹ï¼Œå¯ä»¥æŸ¥çœ‹å‰ä¸€ç¯‡æ–‡ç« ï¼Œå…¶å®å¯ä»¥ä½¿ç”¨åå°„åˆ›å»ºæ³›å‹æ•°ç»„ã€‚ æ— é™å®šé€šé…ç¬¦ æ³›å‹ä¸­æ”¯æŒæ— é™å®šé€šé…ç¬¦&lt;?&gt;ï¼Œä½¿ç”¨æ— é™å®šé€šé…ç¬¦ç±»å‹çš„å®ä¾‹æœ‰ä»¥ä¸‹é™åˆ¶ï¼š æ‰€æœ‰çš„Getteræ–¹æ³•åªèƒ½è¿”å›Objectç±»å‹çš„å€¼ã€‚ æ‰€æœ‰çš„Setteræ–¹æ³•åªèƒ½èµ‹å€¼nullï¼Œå…¶ä»–ç±»å‹çš„å€¼çš„è®¾ç½®éƒ½æ˜¯éæ³•çš„ã€‚ æ— é™å®šé€šé…ç¬¦ç±»å‹å¯ä»¥çœ‹åšåŸå§‹ç±»å‹çš„ä¸€ä¸ªå½±å­ç±»å‹ï¼Œå®ƒå±è”½äº†é™¤äº†nullä¹‹å¤–çš„è®¾å€¼æ“ä½œï¼Œæ‰€æœ‰è·å–å€¼çš„æ–¹æ³•åªèƒ½è¿”å›Objectç±»å‹ç»“æœï¼Œè¿™ç§ç‰¹æ€§ä½¿å¾—é€šè¿‡æ— é™å®šé€šé…ç¬¦ç±»å‹è¿›è¡Œä¸€äº›ç®€å•çš„æ“ä½œå˜å¾—ååˆ†æ–¹ä¾¿ï¼Œä¾‹å¦‚ï¼š 123public static boolean hasNulls(Pair&lt;?&gt; p)&#123; return p.getFirst() == null || p.getSecond() == null;&#125; å¦‚æœåå°„ç”¨å¾—æ¯”è¾ƒç†Ÿçš„è¯ï¼Œjava.lang.Classä¹Ÿæœ‰ç±»ä¼¼çš„ç”¨æ³•ï¼š 12Class&lt;?&gt; clazz = ...;Object instance = class.newInstance(); æ¡¥æ–¹æ³•(Bridge Method) å…ˆè¯´æ˜ä¸€ä¸‹ä»€ä¹ˆæ˜¯æ¡¥æ–¹æ³•ï¼Œçœ‹ä¸‹é¢çš„ä»£ç ï¼š 1234567891011121314// çˆ¶ç±»public interface Supper&lt;T&gt; &#123; void method(T t);&#125;// å…¶ä¸­ä¸€ä¸ªå­ç±»public class Sub implements Supper&lt;Integer&gt; &#123; @Override public void method(Integer value) &#123; System.out.println(value); &#125;&#125; çˆ¶ç±»Supper&lt;T&gt;åœ¨æ³›å‹æ“¦é™¤ååŸå§‹ç±»å‹æ˜¯ï¼š 1234public interface Supper&#123; void method(Object t);&#125; å­ç±»Subè™½ç„¶å®ç°äº†çˆ¶ç±»Supperï¼Œä½†æ˜¯å®ƒåªå®ç°äº†void method(Integer value)è€Œæ²¡æœ‰å®ç°çˆ¶ç±»ä¸­çš„void method(Object t)ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œç¼–è¯‘æœŸç¼–è¯‘å™¨ä¼šä¸ºå­ç±»Subåˆ›å»ºæ­¤æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯å­ç±»Subä¼šå˜æˆè¿™æ ·ï¼š 1234567891011public class Sub implements Supper&lt;Integer&gt; &#123; @Override public void method(Integer value) &#123; System.out.println(value); &#125; public void method(Object value) &#123; this.method((Integer) value); &#125;&#125; å¦‚æœä½ ç›´æ¥è¿™æ ·ç¼–å†™ä¸€ä¸ªå­ç±»Subæ˜¯ä¼šç¼–è¯‘æŠ¥é”™ï¼Œè€Œä¸Šé¢è¿™é‡Œç¼–è¯‘å™¨ç”Ÿæˆçš„void method(Object value)æ–¹æ³•å°±æ˜¯æ¡¥æ–¹æ³•ã€‚å¯ä»¥ç”¨åå°„éªŒè¯ä¸€ä¸‹ï¼š 1234567891011121314151617public static void main(String[] args) throws Exception &#123; Method[] declaredMethods = Sub.class.getDeclaredMethods(); List&lt;Method&gt; methods = new ArrayList&lt;&gt;(); for (Method method : declaredMethods) &#123; if (method.getName().equals(\"method\")) &#123; methods.add(method); &#125; &#125; for (Method method : methods) &#123; System.out.println(String.format(\"name=%s,paramTypes=%s,isBridge=%s\", method.getName(), Arrays.toString(method.getParameterTypes()), method.isBridge())); &#125;&#125;//è¾“å‡ºç»“æœname=method,paramTypes=[class java.lang.Integer],isBridge=falsename=method,paramTypes=[class java.lang.Object],isBridge=true æ¡¥æ–¹æ³•çš„å®šä¹‰æ¯”è¾ƒæ¨¡ç³Šï¼Œå› æ­¤è¿™é‡Œåªè€ƒè™‘å®ƒå‡ºç°çš„æƒ…å†µï¼Œä¸åšç›²ç›®çš„å®šä¹‰ã€‚ä¸å•åªæ˜¯å­ç±»å®ç°å¸¦æœ‰æ³›å‹å‚æ•°çš„çˆ¶ç±»ä¼šäº§ç”Ÿæ¡¥æ–¹æ³•ï¼Œè¿˜æœ‰ä¸€ç§æ¯”è¾ƒå¸¸è§çš„æƒ…å†µæ˜¯åœ¨æ–¹æ³•è¦†ç›–çš„æ—¶å€™æŒ‡å®šä¸€ä¸ªæ›´åŠ &quot;ä¸¥æ ¼çš„&quot;è¿”å›å€¼ç±»å‹çš„æ—¶å€™ï¼Œä¹Ÿä¼šäº§ç”Ÿæ¡¥æ–¹æ³•ï¼Œä¾‹å¦‚ï¼š 12345678910111213141516171819public Employee implements Cloneable&#123; public Employee clone() throws CloneNotSupportedException&#123; //... &#125;&#125;// è¿™é‡Œå®é™…ä¸Šï¼ŒEmployeeè¦†ç›–äº†Objectçš„clone()æ–¹æ³•ï¼Œå› æ­¤å®é™…ä¸Šç¼–è¯‘åEmployeeå¦‚ä¸‹public Employee implements Cloneable&#123; public Employee clone() throws CloneNotSupportedException&#123; //... &#125; // è¿™ä¸ªæ˜¯æ¡¥æ–¹æ³• public Object clone() throws CloneNotSupportedException&#123; //... &#125; &#125; è¿™æ˜¯å› ä¸ºï¼š ç¼–è¯‘çš„æ—¶å€™Javaçš„æ–¹æ³•ç­¾åæ˜¯æ–¹æ³•åç§°åŠ ä¸Šæ–¹æ³•å‚æ•°ç±»å‹åˆ—è¡¨ï¼Œä¹Ÿå°±æ˜¯æ–¹æ³•åå’Œå‚æ•°ç±»å‹åˆ—è¡¨ç¡®å®šä¸€ä¸ªæ–¹æ³•çš„ç­¾å(è¿™æ ·å°±å¯ä»¥å¾ˆå¥½ç†è§£æ–¹æ³•é‡è½½ï¼Œè¿˜æœ‰Javaä¸­çš„å‚æ•°éƒ½æ˜¯å½¢å‚ï¼Œæ‰€ä»¥å‚æ•°åç§°æ²¡æœ‰å®è´¨æ„ä¹‰ï¼Œåªæœ‰å‚æ•°ç±»å‹æ‰æ˜¯æœ‰æ„ä¹‰çš„)ã€‚ Javaè™šæ‹Ÿæœºå®šä¹‰ä¸€ä¸ªæ–¹æ³•çš„ç­¾åæ˜¯ç”±æ–¹æ³•åç§°ã€æ–¹æ³•è¿”å›å€¼ç±»å‹å’Œæ–¹æ³•å‚æ•°ç±»å‹åˆ—è¡¨ç»„æˆï¼Œæ‰€ä»¥JVMè®¤ä¸ºè¿”å›å€¼ç±»å‹ä¸åŒï¼Œè€Œæ–¹æ³•åç§°å’Œå‚æ•°ç±»å‹åˆ—è¡¨ä¸€è‡´çš„æ–¹æ³•æ˜¯ä¸ç›¸åŒçš„æ–¹æ³•ã€‚ ä»”ç»†çœ‹ï¼Œå…¶å®ä¸¤ç§æƒ…å†µéƒ½æ˜¯ç”±äºç»§æ‰¿æ‰å¯¼è‡´æ¡¥æ–¹æ³•å‡ºç°ã€‚ JDKä¸­æ“ä½œæ³›å‹çš„API è¿™é‡Œåˆ—ä¸¾ä¸€ä¸‹JDKä¸­ç¬”è€…æ‰€çŸ¥çš„æ“ä½œæ³›å‹çš„ç›¸å…³API(å¯ä»¥ä¼šæœ‰é—æ¼)ï¼Œè¿™äº›APIä¸»è¦å’Œåå°„æ“ä½œç›¸å…³ï¼š java.lang.Classä¸­çš„ç›¸å…³æ–¹æ³•ï¼š æ–¹æ³• åŠŸèƒ½ Type[] getGenericInterfaces() è¿”å›ç±»å®ä¾‹çš„æ¥å£çš„æ³›å‹ç±»å‹ Type getGenericSuperclass() è¿”å›ç±»å®ä¾‹çš„çˆ¶ç±»çš„æ³›å‹ç±»å‹ java.lang.reflect.Constructorä¸­çš„ç›¸å…³æ–¹æ³•ï¼š æ–¹æ³• åŠŸèƒ½ Type[] getGenericExceptionTypes() è¿”å›æ„é€ å™¨çš„å¼‚å¸¸çš„æ³›å‹ç±»å‹ Type[] getGenericParameterTypes() è¿”å›æ„é€ å™¨çš„æ–¹æ³•å‚æ•°çš„æ³›å‹ç±»å‹ java.lang.reflect.Methodä¸­çš„ç›¸å…³æ–¹æ³•ï¼š æ–¹æ³• åŠŸèƒ½ Type[] getGenericExceptionTypes() è¿”å›æ–¹æ³•çš„å¼‚å¸¸çš„æ³›å‹ç±»å‹ Type[] getGenericParameterTypes() è¿”å›æ–¹æ³•å‚æ•°çš„æ³›å‹ç±»å‹ Type getGenericReturnType() è¿”å›æ–¹æ³•è¿”å›å€¼çš„æ³›å‹ç±»å‹ java.lang.reflect.Fieldä¸­çš„ç›¸å…³æ–¹æ³•ï¼š æ–¹æ³• åŠŸèƒ½ Type getGenericType() è¿”å›å±æ€§çš„æ³›å‹ç±»å‹ å¦‚æœåœ¨ä½¿ç”¨ä¸Šé¢çš„æ–¹æ³•å¾—åˆ°çš„è¿”å›å€¼å’ŒæœŸæœ›çš„è¿”å›å€¼ä¸ç›¸åŒï¼Œè¯·åŠ æ·±å¯¹æ³›å‹ç±»å‹æ“¦é™¤çš„è®¤è¯†ã€‚ å°ç»“ å‚è€ƒèµ„æ–™ï¼š ä¸ªäººè®¤ä¸ºï¼Œæ³›å‹å…¶å®æ˜¯JDKè¿­ä»£è¿‡ç¨‹ä¸­å¦¥åå’Œå…¼å®¹å†å²çš„äº§ç‰©ï¼Œå®ƒæ˜¯ä¸€ç§æ²¡æœ‰å®ç°çš„æ³›å‹ï¼Œå½“ç„¶ï¼Œæä¾›ç¼–è¯‘æœŸç±»å‹å®‰å…¨è¿™ä¸€ç‚¹å¯ä»¥è®©å¼€å‘è€…é¿å…ç±»å‹è½¬æ¢å‡ºç°äººä¸ºé”™è¯¯ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼šJavaä¸­çš„æ³›å‹ä½¿å¾—ç¨‹åºæˆ–è€…ä»£ç çš„å¯è¯»æ€§å’Œå®‰å…¨æ€§æé«˜ï¼Œè¿™æ˜¯å®ƒçš„æœ€å¤§ä¼˜åŠ¿ã€‚ ã€ŠJavaæ ¸å¿ƒæŠ€æœ¯å·I-åŸºç¡€çŸ¥è¯†ã€‹ ç»´åŸºç™¾ç§‘-Generics in Java (æœ¬æ–‡å®Œ e-20181204-c-3d r-20181205)","categories":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/categories/Java/"},{"name":"Reflection","slug":"Java/Reflection","permalink":"http://throwable.club/blog/categories/Java/Reflection/"}],"tags":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/tags/Java/"},{"name":"Reflection","slug":"Reflection","permalink":"http://throwable.club/blog/tags/Reflection/"}]},{"title":"æ·±å…¥åˆ†æJavaåå°„(äºŒ)-æ•°ç»„å’Œæšä¸¾","slug":"java-reflection-array-enum","date":"2018-12-02T04:06:19.000Z","updated":"2018-12-04T15:42:12.368Z","comments":true,"path":"2018/12/02/java-reflection-array-enum/","link":"","permalink":"http://throwable.club/2018/12/02/java-reflection-array-enum/","excerpt":"","text":"æ·±å…¥åˆ†æJavaåå°„(äºŒ)-æ•°ç»„å’Œæšä¸¾ å‰æ Javaåå°„çš„APIåœ¨JavaSE1.7çš„æ—¶å€™å·²ç»åŸºæœ¬å®Œå–„ï¼Œä½†æ˜¯æœ¬æ–‡ç¼–å†™çš„æ—¶å€™ä½¿ç”¨çš„æ˜¯Oracle JDK11ï¼Œå› ä¸ºJDK11å¯¹äºsunåŒ…ä¸‹çš„æºç ä¹Ÿä¸Šä¼ äº†ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡IDEæŸ¥çœ‹å¯¹åº”çš„æºç å’Œè¿›è¡ŒDebugã€‚ æœ¬æ–‡ä¸»è¦ä»‹ç»åå°„ä¸­å¯èƒ½ç”¨åˆ°çš„ä¸¤ä¸ªæ¯”è¾ƒç‰¹æ®Šçš„ç±»å‹ï¼Œæ•°ç»„å’Œæšä¸¾ï¼Œåˆ†åˆ«å¯¹åº”java.lang.reflect.Arrayå’Œjava.lang.Enumï¼Œåè€…å…¶å®å¹¶ä¸æ˜¯åå°„ç±»åº“åŒ…ä¸­çš„ç±»ï¼Œä½†æ˜¯åå°„çš„åŸºç¡€ç±»åº“é‡Œé¢æœ‰ä½¿ç”¨æšä¸¾ç±»å‹çš„æ–¹æ³•ã€‚ æ•°ç»„ç±»å‹ æ•°ç»„æ˜¯ä¸€ç§åŒ…å«å›ºå®šæ•°é‡çš„ç›¸åŒç±»å‹ç»„ä»¶(Component)çš„å¼•ç”¨ç±»å‹å¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯è¯´æ•°ç»„çš„é•¿åº¦æ˜¯ä¸å¯å˜ï¼Œå®ƒçš„æ¯ä¸ªå…ƒç´ éƒ½æ˜¯ç›¸åŒç±»å‹çš„ã€‚åˆ›å»ºæ•°ç»„å®ä¾‹éœ€è¦å®šä¹‰æ•°ç»„çš„é•¿åº¦å’Œç»„ä»¶çš„ç±»å‹ã€‚æ•°ç»„æ˜¯ç”±Javaè™šæ‹Ÿæœºå®ç°(è¿™ä¸€ç‚¹å¾ˆé‡è¦ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆJDKç±»åº“ä¸­æ²¡æœ‰æ•°ç»„å¯¹åº”çš„ç±»å‹çš„åŸå› ï¼Œarrayä¹Ÿä¸æ˜¯Javaä¸­çš„ä¿ç•™å…³é”®å­—ï¼Œæ“ä½œæ•°ç»„çš„åº•å±‚æ–¹æ³•éƒ½æ˜¯nativeæ–¹æ³•)ï¼Œæ•°ç»„ç±»å‹åªæœ‰ç»§æ‰¿è‡ªjava.lang.Objectçš„æ–¹æ³•ï¼Œæ•°ç»„çš„lengthæ–¹æ³•å®é™…ä¸Šå¹¶ä¸å±äºæ•°ç»„ç±»å‹çš„ä¸€éƒ¨åˆ†ï¼Œæ•°ç»„çš„lengthæ–¹æ³•å…¶å®æœ€ç»ˆè°ƒç”¨çš„æ˜¯java.lang.reflect.Array#getLength()ï¼Œæ³¨æ„åˆ°è¿™ä¸ªæ–¹æ³•æ˜¯nativeæ–¹æ³•ã€‚java.lang.reflect.Arrayæ˜¯åŸºäºåå°„æ“ä½œæ•°ç»„çš„æ ¸å¿ƒç±»ã€‚ ä½¿ç”¨éåå°„æ–¹å¼åˆ›å»ºæ•°ç»„å®ä¾‹çš„è¿‡ç¨‹å¦‚ä¸‹ï¼š 12345fully_qualified_class_name[] variable_name = &#123;val1ï¼Œval2ï¼Œval3ï¼Œ...&#125;;fully_qualified_class_name[] variable_name = new fully_qualified_class_name[$&#123;fix_length&#125;];ä¾‹å¦‚ï¼šint[] arr = new int[10]; ä½¿ç”¨åå°„æ–¹å¼å°±æ˜¯ä½¿ç”¨java.lang.reflect.Arrayä¸­çš„ç›¸å…³æ–¹æ³•ï¼š 123456789Class&lt;?&gt; c = Class.forName(cName);Object o = Array.newInstance(c, n);for (int i = 0; i &lt; n; i++) &#123; String v = cVals[i]; Constructor ctor = c.getConstructor(String.class); Object val = ctor.newInstance(v); Array.set(o, i, val);&#125;Object[] oo = (Object[]) o; ä¸‹é¢åˆ—ä¸¾ä¸€ä¸‹java.lang.reflect.Arrayä¸­çš„æ–¹æ³•ï¼š æ–¹æ³• åŠŸèƒ½ static Object newInstance(Class&lt;?&gt; componentType, int length) æŒ‡å®šç»„ä»¶ç±»å‹å’Œæ•°ç»„å›ºå®šé•¿åº¦åˆ›å»ºä¸€ç»´æ•°ç»„ static Object newInstance(Class&lt;?&gt; componentType, intâ€¦ dimensions) æŒ‡å®šç»„ä»¶ç±»å‹å’Œå¤šä¸ªå›ºå®šé•¿åº¦åˆ›å»ºå¤šç»´æ•°ç»„ï¼Œç»´åº¦çš„æœ€å¤§å€¼ä¸º255 static native int getLength(Object array) è·å–æ•°ç»„é•¿åº¦ static native Object get(Object array, int index) é€šè¿‡ä¸‹æ ‡è®¿é—®æ•°ç»„å…ƒç´  static native void set(Object array, int index, Object value) é€šè¿‡ä¸‹æ ‡è®¾ç½®æ•°ç»„å…ƒç´  è¿™é‡Œçœç•¥äº†ä¸€éƒ¨åˆ†å¯¹äºIntã€Booleanç­‰åŸå§‹ç±»å‹çš„Setterå’ŒGetteræ–¹æ³•ã€‚ åœ¨java.lang.Classå’Œæ•°ç»„ç›¸å…³çš„æ–¹æ³•ï¼š æ–¹æ³• åŠŸèƒ½ native boolean isArray() åˆ¤æ–­ç±»å‹æ˜¯å¦æ•°ç»„ç±»å‹ Class&lt;?&gt; getComponentType() å¦‚æœæ˜¯æ•°ç»„ç±»å‹åˆ™è¿”å›å…¶ç»„ä»¶ç±»å‹ï¼Œå¦åˆ™è¿”å›null è¿™é‡Œä¸¾ä¸ªä¾‹å­åŠ æ·±ä¸‹å°è±¡ï¼š 1234567891011121314151617181920212223242526272829public class ArrayCreationMain &#123; /** * è¿™ä¸ªæ˜¯æˆ‘ä»¬åˆ›å»ºçš„æœ€ç»ˆç›®æ ‡æ•°ç»„ */ private static String R = \"java.math.BigInteger[] bi = &#123;123,234,345&#125;\"; private static final String[] S = new String[]&#123;\"123\", \"234\", \"345\"&#125;; public static void main(String[] args) throws Exception &#123; Class&lt;BigInteger&gt; componentType = BigInteger.class; Object arrayObject = Array.newInstance(componentType, 3); for (int i = 0; i &lt; S.length; i++) &#123; String each = S[i]; Constructor&lt;BigInteger&gt; constructor = componentType.getConstructor(String.class); BigInteger value = constructor.newInstance(each); Array.set(arrayObject, i, value); &#125; Object[] result = (Object[]) arrayObject; System.out.println(String.format(\"%s[] = %s\", componentType, Arrays.toString(result))); int length = Array.getLength(arrayObject); System.out.println(\"Length = \" + length); for (int i = 0; i &lt; length; i++) &#123; System.out.println(String.format(\"index = %d,value = %s\", i, Array.get(arrayObject, i))); &#125; Class&lt;?&gt; arrayObjectClass = arrayObject.getClass(); System.out.println(\"Is array type:\" + arrayObjectClass.isArray()); System.out.println(\"Component type:\" + arrayObjectClass.getComponentType()); &#125;&#125; è¿è¡Œåè¾“å‡ºï¼š 1234567class java.math.BigInteger[] = [123, 234, 345]Length = 3index = 0,value = 123index = 1,value = 234index = 2,value = 345Is array type:trueComponent type:class java.math.BigInteger éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œjava.lang.reflect.Arrayä¸­çš„Setterå’ŒGetteræ–¹æ³•å¦‚æœè¶Šç•Œæ“ä½œæ•°ç»„å…ƒç´ ï¼Œä¼šæŠ›å‡ºArrayIndexOutOfBoundsExceptionï¼Œé€šè¿‡Setterè®¾ç½®å’Œæ•°ç»„åˆå§‹åŒ–æ—¶å€™çš„ç»„ä»¶ç±»å‹ä¸ä¸€è‡´çš„å…ƒç´ ä¼šæŠ›å‡ºIllegalArgumentExceptionã€‚ ç»†è®®æ•°ç»„ç±»å‹ å‰é¢è¯´åˆ°äº†æ•°ç»„ç±»å‹çš„ä¸€äº›åŸºç¡€ç‰¹æ€§ï¼Œè¿™é‡Œè¡¥å……ä¸€äº›æ¯”è¾ƒé«˜çº§çš„ä½¿ç”¨æ–¹æ³•ã€‚ åˆ›å»ºç‰¹å®šå…ƒç´ ç±»å‹çš„æ•°ç»„ï¼š å› ä¸ºJavaæ³›å‹æ“¦é™¤çš„é—®é¢˜ï¼Œå®é™…ä¸Šæˆ‘ä»¬ä½¿ç”¨Array#newInstanceæ–¹æ³•åªèƒ½å¾—åˆ°ä¸€ä¸ªObjectç±»å‹çš„ç»“æœå®ä¾‹ï¼Œå…¶å®è¿™ä¸ªç»“æœå®ä¾‹çš„ç±»å‹å°±æ˜¯ComponentType[]ï¼Œè¿™é‡Œåªæ˜¯è¿”å›äº†å®ƒçš„çˆ¶ç±»(Object)ç±»å‹å®ä¾‹ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥ç›´æ¥å¼ºè½¬ï¼Œä¾‹å¦‚ï¼š 1String[] strArray = (String[]) Array.newInstance(String.class, 3); è·å–æ•°ç»„ç±»å‹ï¼š åœ¨éåå°„æ–¹å¼ä¸‹ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æ•°ç»„å®ä¾‹.classé€šè¿‡classå­—é¢é‡ç›´æ¥è·å–æ•°ç»„ç±»å‹ï¼Œä¾‹å¦‚ï¼š 1Class stringArrayClass = String[].class; åå°„æ¡ä»¶ä¸‹ï¼Œå¯ä»¥é€šè¿‡Class.forName()è·å–æ•°ç»„ç±»å‹ï¼Œä½†æ˜¯è°ƒç”¨æ­¤æ–¹æ³•çš„æ—¶å€™æœ‰ä¸ªé™åˆ¶ï¼Œç±»åå¿…é¡»ä½¿ç”¨JVMå¯ä»¥è¯†åˆ«çš„ç­¾åå½¢å¼ï¼Œå°±æ˜¯[L${ComponentType};ï¼Œæ³¨æ„Class.forName()æ— æ³•è·å–åŸå§‹ç±»å‹(å¦‚intã€boolean)çš„ç±»å‹ï¼Œä¾‹å¦‚ï¼š 123456// ä¸èƒ½æ¼äº†å·¦è¾¹çš„[Lå’Œå³è¾¹çš„;Class stringArrayClass = Class.forName(\"[Ljava.lang.String;\");// ä¸‹é¢è¿™æ ·åšä¼šæŠ›å‡ºClassNotFoundExceptionClass intClass1 = Class.forName(\"I\");Class intClass2 = Class.forName(\"int\"); è·å–æ•°ç»„å…ƒç´ (ç»„ä»¶)ç±»å‹ï¼š ç›®å‰è·å–æ•°ç»„ç»„ä»¶ç±»å‹åªèƒ½é€šè¿‡æ•°ç»„ç±»å‹å®ä¾‹å»è°ƒç”¨Class#getComponentType()ã€‚ æšä¸¾ç±»å‹ æšä¸¾æ˜¯ä¸€ç§è¯­è¨€ç»“æ„(Language Construct)ï¼Œç”¨äºå®šä¹‰å¯ä»¥ä½¿ç”¨ä¸€ç»„å›ºå®šçš„åå€¼å¯¹è¡¨ç¤ºçš„ç±»å‹å®‰å…¨çš„æšä¸¾(åŸæ–‡æ˜¯ï¼šAn enum is a language construct that is used to define type-safe enumerations which can be used when a fixed set of named values is desired)ã€‚æ‰€æœ‰æšä¸¾éƒ½ç»§æ‰¿è‡ªjava.lang.Enumã€‚æšä¸¾å¯ä»¥åŒ…å«ä¸€ä¸ªæˆ–è€…å¤šä¸ªæšä¸¾å¸¸é‡ï¼Œè¿™äº›æšä¸¾å¸¸é‡éƒ½æ˜¯è¯¥æšä¸¾çš„å®ä¾‹ã€‚æšä¸¾çš„å£°æ˜å…¶å®å’Œä¸€ä¸ªæ™®é€šçš„Classçš„å£°æ˜ç›¸ä¼¼ï¼Œå› ä¸ºå®ƒå¯ä»¥åŒ…å«å­—æ®µã€æ–¹æ³•å’Œæ„é€ å‡½æ•°ä¹‹ç±»çš„æˆå‘˜ã€‚ å› ä¸ºæšä¸¾å°±æ˜¯æ™®é€šçš„Javaç±»ï¼Œå› æ­¤åå°„ç›¸å…³ç±»åº“ä¸­å¹¶æ²¡æœ‰æ·»åŠ ä¸€ä¸ªjava.lang.reflect.Enumç±»å‹ï¼Œåå°„ä¸­çš„APIå’Œæšä¸¾ç›¸å…³çš„æœ‰ï¼š boolean java.lang.Class#isEnum()ï¼šåˆ¤æ–­ç±»å‹æ˜¯å¦æšä¸¾ç±»å‹ã€‚ T[] java.lang.Class#getEnumConstants()ï¼šè·å–ç±»å‹ä¸­æ‰€æœ‰çš„æšä¸¾å¸¸é‡ã€‚ boolean java.lang.reflect.Field#isEnumConstant()ï¼šåˆ¤æ–­å±æ€§æ˜¯å¦æšä¸¾ç±»å‹ã€‚ å¦‚æœå®ä¾‹ä¸­çš„æˆå‘˜å±æ€§ä¸ºæšä¸¾ï¼Œé‚£ä¹ˆæšä¸¾çš„åå°„æ“ä½œå®é™…ä¸Šå°±æ˜¯java.lang.reflect.Fieldçš„ç›¸å…³æ“ä½œã€‚ ä¸¾ä¸ªä¾‹å­ï¼š 12345678910111213141516171819202122232425public class EnumerationMain &#123; enum Color &#123; RED, BLACK, BLUE &#125; public static class ColorHolder &#123; private Color color = Color.BLACK; &#125; public static void main(String[] args) throws Exception &#123; Class&lt;Color&gt; colorClass = Color.class; System.out.println(\"Color class is enum:\" + colorClass.isEnum()); System.out.println(\"Color values:\" + Arrays.toString(colorClass.getEnumConstants())); ColorHolder colorHolder = new ColorHolder(); Class&lt;ColorHolder&gt; holderClass = ColorHolder.class; Field field = holderClass.getDeclaredField(\"color\"); field.setAccessible(true); System.out.println(\"Old color:\" + field.get(colorHolder)); field.set(colorHolder, Color.RED); System.out.println(\"New color:\" + field.get(colorHolder)); &#125;&#125; è¿è¡Œåè¾“å‡ºï¼š 1234Color class is enum:trueColor values:[RED, BLACK, BLUE]Old color:BLACKNew color:RED ä¹‹å‰å†™è¿‡ä¸€ç¯‡æ–‡ç« ã€ŠJDKä¸­æšä¸¾çš„åº•å±‚å®ç°ã€‹ï¼Œä»æšä¸¾ç±»çš„å­—èŠ‚ç ç¿»è¯‘å‡ºç±»çš„ä»£ç é€»è¾‘ï¼Œè¿™é‡Œç¿»å‡ºæ¥é‚£ä¸ªä¾‹å­(æ‰‹æœºæ“ä½œç³»ç»Ÿæšä¸¾)è¯´ä¸€ä¸‹ï¼š 1234567891011121314151617181920212223242526272829public enum PhoneOsEnum &#123; /** * å®‰å“ */ ANDROID(1, \"android\"), /** * ios */ IOS(2, \"ios\"); private final Integer type; private final String typeName; PhoneOsEnum(Integer type, String typeName) &#123; this.type = type; this.typeName = typeName; &#125; public Integer getType() &#123; return type; &#125; public String getTypeName() &#123; return typeName; &#125;&#125; è¿™ä¸ªæ˜¯æˆ‘ä»¬ä½¿ç”¨Javaçš„å…³äºæšä¸¾çš„è¯­æ³•åˆ›å»ºå‡ºæ¥çš„æšä¸¾ç±»å‹ï¼Œæ˜¯ç¼–è¯‘å‰æˆ‘ä»¬çœ‹åˆ°çš„Javaç±»æ–‡ä»¶ï¼Œå®é™…ä¸Šï¼Œç¼–è¯‘å®Œæˆä¹‹åï¼Œæšä¸¾ç±»å‹ä¼šå˜æˆä¸€ä¸ªæ™®é€šçš„Javaç±»ï¼Œå®ƒæœ‰ä»¥ä¸‹ç‰¹ç‚¹ï¼š 1ã€æšä¸¾ç±»å‹ä¼šå˜æˆä¸€ä¸ªæ™®é€šJavaç±»ï¼Œè¿™ä¸ªJavaç±»ä¼šç»§æ‰¿java.lang.Enumï¼Œå¹¶ä¸”æŠŠè‡ªèº«ç±»å‹ä½œä¸ºæ³›å‹å‚æ•°ç±»å‹ï¼Œæ„é€ å‡½æ•°ä¸­å¿…å®šåŒ…å«name(å­—ç¬¦ä¸²ç±»å‹String)ã€ordinal(æ•´å‹int)å‚æ•°ï¼Œå› ä¸ºçˆ¶ç±»java.lang.Enumçš„æ„é€ è¦æ±‚ä¼ å…¥è¿™ä¸¤ä¸ªå‚æ•°ã€‚ 2ã€æ‰€æœ‰çš„æšä¸¾æˆå‘˜å±æ€§éƒ½å˜æˆstatic finalä¿®é¥°çš„åœ¨ç¬¬1æ­¥ä¸­æåˆ°çš„Javaç±»çš„å®ä¾‹ï¼Œå±æ€§çš„åç§°å’ŒåŸæ¥æšä¸¾çš„åå­—ä¸€è‡´ï¼Œå®ä¾‹åœ¨é™æ€ä»£ç å—ä¸­åˆ›å»ºã€‚ 3ã€æ–°å¢äº†ä¸€ä¸ªstatic finalä¿®é¥°çš„ç¬¬1æ­¥ä¸­æåˆ°çš„Javaç±»çš„æ•°ç»„å®ä¾‹ï¼Œåç§°ä¸º$VALUESï¼Œæ­¤æ•°ç»„åœ¨é™æ€ä»£ç å—ä¸­åˆ›å»ºï¼ŒåŸºäºæ­¤æ•°ç»„è¿˜æ–°å¢äº†ä¸€ä¸ªé™æ€æ–¹æ³•values()ï¼Œæ­¤æ–¹æ³•å°±æ˜¯ç›´æ¥è¿”å›æ•°ç»„çš„å…‹éš†ã€‚ ä¹Ÿå°±æ˜¯ä¸Šé¢æåˆ°çš„PhoneOsEnumåœ¨ç¼–è¯‘å®Œæˆä¹‹åä¼šå˜æˆï¼š 123456789101112131415161718192021222324252627282930313233343536public final class PhoneOsEnumeration extends Enum&lt;PhoneOsEnumeration&gt; &#123; public PhoneOsEnumeration(String name, int ordinal, Integer type, String typeName) &#123; super(name, ordinal); this.type = type; this.typeName = typeName; &#125; public Integer getType() &#123; return type; &#125; public String getTypeName() &#123; return typeName; &#125; public static PhoneOsEnumeration[] values() &#123; return $VALUES.clone(); &#125; public static PhoneOsEnumeration valueOf(String name) &#123; return Enum.valueOf(PhoneOsEnumeration.class, name); &#125; private final Integer type; private final String typeName; public static final PhoneOsEnumeration ANDROID; public static final PhoneOsEnumeration IOS; private static final PhoneOsEnumeration[] $VALUES; static &#123; ANDROID = new PhoneOsEnumeration(\"ANDROID\", 0, 1, \"android\"); IOS = new PhoneOsEnumeration(\"IOS\", 1, 2, \"ios\"); $VALUES = new PhoneOsEnumeration[]&#123;ANDROID, IOS&#125;; &#125;&#125; å®é™…ä¸Šï¼Œå¦‚æœä½ ç›´æ¥ç¼–å†™ä¸€ä¸ªJavaç±»å»ç»§æ‰¿java.lang.Enumä¼šç¼–è¯‘æŠ¥é”™ï¼Œä¹Ÿå°±æ˜¯Javaå¸Œæœ›æŠŠæšä¸¾çš„è¡Œä¸ºå’Œç‰¹æ€§äº¤ç”±è‡ªèº«æ§åˆ¶è€Œä¸æ˜¯å¼€å‘è€…å»æ§åˆ¶ï¼Œä»ç¼–è¯‘å±‚é¢æ§åˆ¶æšä¸¾çš„ç±»å‹å®‰å…¨ã€‚å¦‚æœç»†å¿ƒä¸€ç‚¹ä¼šå‘ç°ï¼Œæšä¸¾ä¸­valueOf(String name)ä¹Ÿæ˜¯ç”±java.lang.Classæä¾›çš„ï¼Œè¿½æº¯åˆ°æœ€é‡Œå±‚æ˜¯T[] java.lang.Class#getEnumConstants()æ–¹æ³•ï¼Œå…¶å®æœ‰å¯èƒ½åœ¨æ„é€ $VALUESå±æ€§çš„æ—¶å€™ä¹Ÿæ˜¯ç”¨åˆ°è¿™ä¸ªæ–¹æ³•ï¼Œè¿™ä¸€ç‚¹å°±æ²¡æœ‰æ·±ç©¶ä¸‹å»ï¼Œç¼–è¯‘å±‚é¢çš„ä¸œè¥¿å¯èƒ½ä¼šç‰µæ¶‰å¾ˆå¤šæ–¹é¢çš„çŸ¥è¯†ï¼Œè¿˜æ²¡æœ‰åˆ°è¾¾é‚£ç§æ°´å¹³ã€‚ å°ç»“ æ•°ç»„å’Œæšä¸¾åœ¨Javaä¸­çš„ä½¿ç”¨é¢‘ç‡ä¹Ÿæ˜¯æ¯”è¾ƒé«˜çš„ï¼Œç‰¹åˆ«æ˜¯ç®—æ³•æˆ–è€…æ¡†æ¶ä¸­ï¼Œæœ¬æ–‡å°è¯•ä»åå°„è§’åº¦ä»‹ç»è¿™ä¸¤ä¸ªç±»å‹çš„ä½¿ç”¨æ–¹å¼ï¼ŒæŒæ¡å®ƒä»¬å¯¹æ•°ç»„æˆ–è€…æšä¸¾çš„ä½¿ç”¨æœ‰å¾ˆå¤§çš„å¸®åŠ©ã€‚ (æœ¬æ–‡å®Œ e-2018122-c-1-d r-2018124-c-1-d)","categories":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/categories/Java/"},{"name":"Reflection","slug":"Java/Reflection","permalink":"http://throwable.club/blog/categories/Java/Reflection/"}],"tags":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/tags/Java/"},{"name":"Reflection","slug":"Reflection","permalink":"http://throwable.club/blog/tags/Reflection/"}]},{"title":"æ·±å…¥åˆ†æJavaåå°„(ä¸€)-æ ¸å¿ƒç±»åº“å’Œæ–¹æ³•","slug":"java-reflection-lib","date":"2018-12-02T04:00:05.000Z","updated":"2018-12-02T04:24:09.929Z","comments":true,"path":"2018/12/02/java-reflection-lib/","link":"","permalink":"http://throwable.club/2018/12/02/java-reflection-lib/","excerpt":"","text":"æ·±å…¥åˆ†æJavaåå°„(ä¸€)-æ ¸å¿ƒç±»åº“å’Œæ–¹æ³• å‰æ Javaåå°„çš„APIåœ¨JavaSE1.7çš„æ—¶å€™å·²ç»åŸºæœ¬å®Œå–„ï¼Œä½†æ˜¯æœ¬æ–‡ç¼–å†™çš„æ—¶å€™ä½¿ç”¨çš„æ˜¯Oracle JDK11ï¼Œå› ä¸ºJDK11å¯¹äºsunåŒ…ä¸‹çš„æºç ä¹Ÿä¸Šä¼ äº†ï¼Œå¯ä»¥ç›´æ¥é€šè¿‡IDEæŸ¥çœ‹å¯¹åº”çš„æºç å’Œè¿›è¡ŒDebugã€‚ æœ¬æ–‡ä¸»è¦ä»‹ç»åå°„çš„åŸºæœ¬æ¦‚å¿µä»¥åŠæ ¸å¿ƒç±»Classã€Constructorã€Methodã€Fieldã€Parameterçš„å¸¸ç”¨æ–¹æ³•ã€‚ æœ¬æ–‡æé•¿ï¼Œè¯·å‡†å¤‡ä¸€ä¸ªä½¿è‡ªå·±èˆ’æœçš„å§¿åŠ¿é˜…è¯»ã€‚ ä»€ä¹ˆæ˜¯åå°„ åå°„(Reflection)æ˜¯ä¸€ç§å¯ä»¥åœ¨è¿è¡Œæ—¶æ£€æŸ¥å’ŒåŠ¨æ€è°ƒç”¨ç±»ã€æ„é€ ã€æ–¹æ³•ã€å±æ€§ç­‰ç­‰çš„ç¼–ç¨‹è¯­è¨€çš„èƒ½åŠ›ï¼Œç”šè‡³å¯ä»¥ä¸éœ€è¦åœ¨ç¼–è¯‘æœŸæ„ŸçŸ¥ç±»çš„åç§°ã€æ–¹æ³•çš„åç§°ç­‰ç­‰ã€‚Oracleå…³äºJavaåå°„çš„å®˜æ–¹æ•™ç¨‹ä¸­æŒ‡å‡ºåå°„æ˜¯ç”±åº”ç”¨ç¨‹åºä½¿ç”¨ï¼Œç”¨äºæ£€æŸ¥æˆ–ä¿®æ”¹åœ¨Javaè™šæ‹Ÿæœºä¸­è¿è¡Œçš„åº”ç”¨ç¨‹åºçš„è¿è¡Œæ—¶è¡Œä¸ºï¼Œè¿™æ˜¯ä¸€ä¸ªç›¸å¯¹é«˜çº§çš„åŠŸèƒ½ï¼Œéœ€è¦ç”±æŒæ¡Javaè¯­è¨€åŸºç¡€çŸ¥è¯†çš„å¼€å‘è€…ä½¿ç”¨ã€‚ åå°„çš„ä¼˜ç‚¹æœ‰å¾ˆå¤šï¼Œå‰é¢æåˆ°å¯ä»¥æ£€æŸ¥æˆ–ä¿®æ”¹åº”ç”¨ç¨‹åºçš„è¿è¡Œæ—¶è¡Œä¸ºã€æŠ‘åˆ¶ä¿®é¥°ç¬¦é™åˆ¶ç›´æ¥è®¿é—®ç§æœ‰å±æ€§ç­‰ç­‰ï¼Œè¿™é‡Œä¸»è¦åˆ—ä¸¾ä¸€ä¸‹å®ƒçš„ç¼ºç‚¹ï¼š æ€§èƒ½å¼€é”€ï¼šç”±äºåå°„æ¶‰åŠåŠ¨æ€è§£æçš„ç±»å‹ï¼Œå› æ­¤æ— æ³•æ‰§è¡ŒæŸäº›Javaè™šæ‹Ÿæœºä¼˜åŒ–ã€‚å› æ­¤ï¼Œåå°„æ“ä½œçš„æ€§èƒ½ä½äºéåå°„æ“ä½œï¼Œåº”é¿å…åœ¨æ€§èƒ½æ•æ„Ÿåº”ç”¨ç¨‹åºä¸­é¢‘ç¹è°ƒç”¨åå°„æ“ä½œä»£ç ç‰‡æ®µã€‚ å®‰å…¨é™åˆ¶ï¼šåå°„éœ€è¦è¿è¡Œæ—¶æƒé™ï¼Œä¸èƒ½åœ¨å®‰å…¨ç®¡ç†å™¨(security manager)ä¸‹è¿›è¡Œåå°„æ“ä½œã€‚ ä»£ç å¯ç§»æ¤æ€§ï¼šåå°„ä»£ç æ‰“ç ´äº†æŠ½è±¡ï¼Œåå°„çš„ç±»åº“æœ‰å¯èƒ½éšç€å¹³å°(JDK)å‡çº§å‘ç”Ÿæ”¹å˜ï¼Œåå°„ä»£ç ä¸­å…è®¸æ‰§è¡Œéåå°„ä»£ç çš„é€»è¾‘ä¾‹å¦‚å…è®¸è®¿é—®ç§æœ‰å­—æ®µï¼Œè¿™äº›é—®é¢˜éƒ½æœ‰å¯èƒ½å½±å“åˆ°ä»£ç çš„å¯ç§»æ¤æ€§ã€‚ JDKä¸­å¯¹å’Œåå°„ç›¸å…³çš„ç±»åº“é›†ä¸­åœ¨java.lang.reflectåŒ…å’Œjava.langåŒ…ä¸­ï¼Œjava.lang.reflectåŒ…å’Œjava.langåŒ…æ˜¯å¼€å‘è€…å¯ä»¥ç›´æ¥ä½¿ç”¨çš„ï¼Œéƒ¨åˆ†java.lang.reflectåŒ…ä¸­æ¥å£çš„å®ç°ç±»å­˜æ”¾åœ¨sun.reflectåŒ…ä¸­ï¼Œä¸€èˆ¬æƒ…å†µä¸‹sunåŒ…ä¸‹çš„ç±»åº“æœ‰å¯èƒ½è·Ÿéšå¹³å°å‡çº§å‘ç”Ÿæ”¹å˜ï¼Œä¸€èˆ¬å°½é‡å°‘ç”¨ï¼Œå¦åˆ™æœ‰å¯èƒ½å› ä¸ºJDKå‡çº§å¯¼è‡´åŸæ¥çš„ä»£ç æ— æ³•æ­£å¸¸è¿è¡Œã€‚è¿˜æœ‰éƒ¨åˆ†åå°„ç›¸å…³çš„ç±»åº“å­˜æ”¾åœ¨jdk.internal.reflectåŒ…ä¸­ï¼Œè¿™ä¸ªåŒ…æ˜¯JDKå†…éƒ¨ä½¿ç”¨çš„åŒ…ï¼Œä¸€èˆ¬ä¹Ÿä¸å»ºè®®æ»¥ç”¨å…¶ä¸­çš„ç±»åº“ã€‚å¯ä»¥ç†è§£ä¸ºjava.lang.reflectåŒ…å’Œjava.langåŒ…ä¸­çš„ç±»åº“å°±æ˜¯é¢å‘å¼€å‘è€…çš„ç±»åº“ã€‚ å›¾è§£åå°„æ ¸å¿ƒç±»çš„ä½“ç³» java.lang.reflectåŒ…åå°„æ ¸å¿ƒç±»æœ‰æ ¸å¿ƒç±»Classã€Constructorã€Methodã€Fieldã€Parameterï¼Œå®ƒä»¬çš„åŸºç¡€ä½“ç³»å¦‚ä¸‹ï¼š java.lang.Classç±»ç»§æ‰¿ä½“ç³»: java.lang.reflect.Constructorç±»ç»§æ‰¿ä½“ç³»: java.lang.reflect.Methodç±»ç»§æ‰¿ä½“ç³»: java.lang.reflect.Fieldç±»ç»§æ‰¿ä½“ç³»: java.lang.reflect.Parameterç±»ç»§æ‰¿ä½“ç³»: ç”±å®ƒä»¬çš„ç±»ç»§æ‰¿å›¾å¯ä»¥çœ‹å‡ºï¼š Classã€Constructorã€Methodã€Fieldã€Parameterå…±æœ‰çš„çˆ¶æ¥å£æ˜¯AnnotatedElementã€‚ Constructorã€Methodã€Fieldå…±æœ‰çš„çˆ¶ç±»æ˜¯AnnotatedElementã€AccessibleObjectå’ŒMemberã€‚ Constructorã€Methodå…±æœ‰çš„çˆ¶ç±»æ˜¯AnnotatedElementã€AccessibleObjectã€Memberã€GenericDeclarationå’ŒExecutableã€‚ ä¸‹é¢ä¼šå…ˆç®€å•åˆ†æAnnotatedElementã€AccessibleObjectã€Memberã€GenericDeclarationã€Executableå‡ ä¸ªç±»æä¾›çš„åŠŸèƒ½ï¼Œç„¶åé‡ç‚¹åˆ†æClassã€Constructorã€Methodã€Fieldã€Parameterçš„å¸¸ç”¨æ–¹æ³•ã€‚ è¿™é‡Œå…ˆè¯´ä¸€ä¸ªè§„å¾‹ï¼Œåœ¨Classä¸­ï¼ŒgetXXX()æ–¹æ³•å’ŒgetDeclearedXXX()æ–¹æ³•æœ‰æ‰€åŒºåˆ«ã€‚æ³¨è§£ç±»å‹Annotationçš„æ“ä½œæ–¹æ³•ä¾‹å¤–ï¼Œå› ä¸ºåŸºäºæ³¨è§£çš„ä¿®é¥°ç¬¦å¿…å®šæ˜¯publicçš„ï¼š getDeclaredMethod(s)ï¼šè¿”å›ç±»æˆ–æ¥å£å£°æ˜çš„æ‰€æœ‰æ–¹æ³•ï¼ŒåŒ…æ‹¬å…¬å…±ã€ä¿æŠ¤ã€é»˜è®¤(åŒ…)è®¿é—®å’Œç§æœ‰æ–¹æ³•ï¼Œä½†ä¸åŒ…æ‹¬ç»§æ‰¿çš„æ–¹æ³•ã€‚å¯¹äºè·å–Methodå¯¹è±¡ï¼ŒMethod[] methods = clazz.getDeclaredMethods();è¿”å›çš„æ˜¯clazzæœ¬ç±»æ‰€æœ‰ä¿®é¥°ç¬¦(publicã€defaultã€privateã€protected)çš„æ–¹æ³•æ•°ç»„ï¼Œä½†æ˜¯ä¸åŒ…å«ç»§æ‰¿è€Œæ¥çš„æ–¹æ³•ã€‚ getMethod(s):è¿”å›æŸä¸ªç±»çš„æ‰€æœ‰å…¬ç”¨(public)æ–¹æ³•åŒ…æ‹¬å…¶ç»§æ‰¿ç±»çš„å…¬ç”¨æ–¹æ³•ï¼Œå½“ç„¶ä¹ŸåŒ…æ‹¬å®ƒæ‰€å®ç°æ¥å£çš„æ–¹æ³•ã€‚å¯¹äºè·å–Methodå¯¹è±¡ï¼ŒMethod[] methods = clazz.getMethods();è¡¨ç¤ºè¿”å›clazzçš„çˆ¶ç±»ã€çˆ¶ç±»æ¥å£ã€æœ¬ç±»ã€æœ¬ç±»æ¥å£ä¸­çš„å…¨éƒ¨ä¿®é¥°ç¬¦ä¸ºpublicçš„æ–¹æ³•æ•°ç»„ã€‚ getDeclaredField(s)å’ŒgetField(s)ã€getDeclaredConstructor(s)å’ŒgetConstructor(s)åŒä¸Šã€‚ getDeclaredAnnotation(s)ï¼šè¿”å›ç›´æ¥å­˜åœ¨äºæ­¤å…ƒç´ ä¸Šçš„æ‰€æœ‰æ³¨è§£ï¼Œæ­¤æ–¹æ³•å°†å¿½ç•¥ç»§æ‰¿çš„æ³¨è§£ï¼Œå‡†ç¡®æ¥è¯´å°±æ˜¯å¿½ç•¥@Inheritedæ³¨è§£çš„ä½œç”¨ã€‚ getAnnotation(s)ï¼šè¿”å›æ­¤å…ƒç´ ä¸Šå­˜åœ¨çš„æ‰€æœ‰æ³¨è§£ï¼ŒåŒ…æ‹¬ç»§æ‰¿çš„æ‰€æœ‰æ³¨è§£ã€‚ å¦‚æœæƒ³è·å–ä¸€ä¸ªç±»çš„æ‰€æœ‰ä¿®é¥°ç¬¦çš„æ–¹æ³•ï¼ŒåŒ…æ‹¬æ‰€æœ‰çˆ¶ç±»ä¸­çš„æ–¹æ³•ï¼Œé‚£ä¹ˆå»ºè®®é€’å½’è°ƒç”¨getDeclaredMethods()(æ‰€è°“é€’å½’è°ƒç”¨å°±æ˜¯ä¸€ç›´è¿½æº¯ç›®æ ‡ç±»çš„çˆ¶ç±»é€’å½’è°ƒç”¨getDeclaredMethods()æ–¹æ³•ç›´åˆ°çˆ¶ç±»ä¸ºObjectç±»å‹ï¼Œè¿™ä¸ªæ€è·¯å¯ä»¥å‚è€ƒSpringæ¡†æ¶ä¸­çš„ç›¸å…³å·¥å…·ç±»)ã€‚è·å–ä¸€ä¸ªç±»çš„æ‰€æœ‰Fieldã€Constructorä¹Ÿå¯ä»¥ç±»ä¼¼æ“ä½œï¼Œå¯ä»¥å‚è€ƒæˆ–è€…ç›´æ¥ä½¿ç”¨Springä¸­çš„å·¥å…·ç±»ReflectionUtilsçš„ç›¸å…³æ–¹æ³•ã€‚@Inheritedå…ƒæ³¨è§£æ˜¯ä¸€ä¸ªæ ‡è®°æ³¨è§£ï¼Œ@Inheritedé˜è¿°äº†æŸä¸ªè¢«æ ‡æ³¨çš„Annotationç±»å‹æ˜¯å¯ä»¥è¢«ç»§æ‰¿çš„ï¼Œè¯¦ç»†çš„åœ¨åˆ†æAnnotatedElementçš„æ—¶å€™å†å±•å¼€ã€‚ Typeæ¥å£ java.lang.reflect.Typeæ¥å£æ˜¯Javaä¸­æ‰€æœ‰ç±»å‹çš„å…±åŒçˆ¶ç±»ï¼Œè¿™äº›ç±»å‹åŒ…æ‹¬åŸå§‹ç±»å‹ã€æ³›å‹ç±»å‹ã€æ•°ç»„ç±»å‹ã€ç±»å‹å˜é‡å’ŒåŸºæœ¬ç±»å‹ï¼Œæ¥å£å®šä¹‰å¦‚ä¸‹ï¼š 123456public interface Type &#123; default String getTypeName() &#123; return toString(); &#125;&#125; AnnotatedElementæ¥å£ AnnotatedElementæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ƒå®šä¹‰çš„æ–¹æ³•ä¸»è¦å’Œæ³¨è§£æ“ä½œç›¸å…³ï¼Œä¾‹å¦‚ç”¨äºåˆ¤æ–­æ³¨è§£çš„å­˜åœ¨æ€§å’Œè·å–æ³¨è§£ç­‰ç­‰ã€‚ æ–¹æ³• åŠŸèƒ½ boolean isAnnotationPresent(Class&lt;? extends Annotation&gt; annotationClass) åˆ¤æ–­æŒ‡å®šçš„æ³¨è§£ç±»å‹åœ¨å½“å‰çš„å®ä¾‹ä¸Šæ˜¯å¦å­˜åœ¨ &lt;T extends Annotation&gt; T getAnnotation(Class&lt;T&gt; annotationClass) è·å–å½“å‰å®ä¾‹ä¸ŠæŒ‡å®šæ³¨è§£ç±»å‹çš„æ³¨è§£å®ä¾‹ï¼Œä¸å­˜åœ¨æ—¶è¿”å›null Annotation[] getAnnotations() è·å–å½“å‰å®ä¾‹ä¸Šæ‰€æœ‰æ³¨è§£å®ä¾‹ï¼ŒåŒ…æ‹¬ç»§æ‰¿è·å¾—çš„æ³¨è§£ï¼Œä¸å­˜åœ¨åˆ™è¿”å›é•¿åº¦ä¸º0çš„æ•°ç»„ &lt;T extends Annotation&gt; T getDeclaredAnnotation(Class&lt;T&gt; annotationClass) è·å–å½“å‰å®ä¾‹ä¸ŠæŒ‡å®šæ³¨è§£ç±»å‹çš„æ³¨è§£å®ä¾‹ï¼Œä¸åŒ…æ‹¬ç»§æ‰¿è·å¾—çš„æ³¨è§£ï¼Œä¸å­˜åœ¨åˆ™è¿”å›é•¿åº¦ä¸º0çš„æ•°ç»„ &lt;T extends Annotation&gt; T[] getDeclaredAnnotations(Class&lt;T&gt; annotationClass) è·å–å½“å‰å®ä¾‹ä¸Šæ‰€æœ‰çš„æ³¨è§£å®ä¾‹ï¼Œä¸åŒ…æ‹¬ç»§æ‰¿è·å¾—çš„æ³¨è§£ï¼Œä¸å­˜åœ¨åˆ™è¿”å›é•¿åº¦ä¸º0çš„æ•°ç»„ &lt;T extends Annotation&gt; T[] getDeclaredAnnotationsByType(Class&lt;T&gt; annotationClass) åœ¨ä¸ä½¿ç”¨@Repeatableçš„æ—¶å€™ï¼ŒåŠŸèƒ½å’ŒgetDeclaredAnnotationsæ–¹æ³•ä¸€è‡´ï¼Œå¦‚æœä½¿ç”¨äº†@Repeatableï¼Œåˆ™åˆå¹¶è§£æ@Repeatableåçš„ç»“æœ &lt;T extends Annotation&gt; T[] getAnnotationsByType(Class&lt;T&gt; annotationClass) å¦‚æœæŒ‡å®šannotationClassæ³¨è§£ç±»å‹å¯ç»§æ‰¿(ä½¿ç”¨äº†@Inherited)ï¼Œé‚£ä¹ˆé€’å½’è°ƒç”¨getDeclaredAnnotationsByType ä¸¾ä¸ªç®€å•ä¾‹å­ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263public class Main &#123; public static void main(String[] args) &#123; Class&lt;?&gt; clazz = Sub.class; System.out.println(\"-----getAnnotations-----\"); Annotation[] annotations = clazz.getAnnotations(); for (Annotation annotation : annotations) &#123; System.out.println(annotation.toString()); &#125; System.out.println(\"-----getDeclaredAnnotation--&gt;SupperAnnotation-----\"); SupperAnnotation declaredSupperAnnotation = clazz.getDeclaredAnnotation(SupperAnnotation.class); System.out.println(declaredSupperAnnotation); System.out.println(\"-----getAnnotation--&gt;SupperAnnotation-----\"); SupperAnnotation supperAnnotation = clazz.getAnnotation(SupperAnnotation.class); System.out.println(supperAnnotation); System.out.println(\"-----getDeclaredAnnotation--&gt;SubAnnotation-----\"); SubAnnotation declaredSubAnnotation = clazz.getDeclaredAnnotation(SubAnnotation.class); System.out.println(declaredSubAnnotation); System.out.println(\"-----getDeclaredAnnotationsByType--&gt;SubAnnotation-----\"); SubAnnotation[] declaredSubAnnotationsByType = clazz.getDeclaredAnnotationsByType(SubAnnotation.class); for (SubAnnotation subAnnotation : declaredSubAnnotationsByType) &#123; System.out.println(subAnnotation); &#125; System.out.println(\"-----getDeclaredAnnotationsByType--&gt;SupperAnnotation-----\"); SupperAnnotation[] declaredSupperAnnotationsByType = clazz.getDeclaredAnnotationsByType(SupperAnnotation.class); for (SupperAnnotation supperAnnotation1 : declaredSupperAnnotationsByType) &#123; System.out.println(supperAnnotation1); &#125; System.out.println(\"-----getAnnotationsByType--&gt;SupperAnnotation-----\"); SupperAnnotation[] supperAnnotationsByType = clazz.getAnnotationsByType(SupperAnnotation.class); for (SupperAnnotation supperAnnotation2 : supperAnnotationsByType) &#123; System.out.println(supperAnnotation2); &#125; &#125; @SupperAnnotation private static class Supper &#123; &#125; @SubAnnotation private static class Sub extends Supper &#123; &#125; @Retention(RetentionPolicy.RUNTIME) @Inherited @Documented @Target(ElementType.TYPE) private @interface SupperAnnotation &#123; String value() default \"SupperAnnotation\"; &#125; @Retention(RetentionPolicy.RUNTIME) @Documented @Target(ElementType.TYPE) private @interface SubAnnotation &#123; String value() default \"SubAnnotation\"; &#125;&#125; è¿è¡Œåè¾“å‡ºï¼š 1234567891011121314-----getAnnotations-----@org.throwable.inherited.Main$SupperAnnotation(value=SupperAnnotation)@org.throwable.inherited.Main$SubAnnotation(value=SubAnnotation)-----getDeclaredAnnotation--&gt;SupperAnnotation-----null-----getAnnotation--&gt;SupperAnnotation-----@org.throwable.inherited.Main$SupperAnnotation(value=SupperAnnotation)-----getDeclaredAnnotation--&gt;SubAnnotation-----@org.throwable.inherited.Main$SubAnnotation(value=SubAnnotation)-----getDeclaredAnnotationsByType--&gt;SubAnnotation-----@org.throwable.inherited.Main$SubAnnotation(value=SubAnnotation)-----getDeclaredAnnotationsByType--&gt;SupperAnnotation----------getAnnotationsByType--&gt;SupperAnnotation-----@org.throwable.inherited.Main$SupperAnnotation(value=SupperAnnotation) å¯ä»¥å°è¯•æ³¨é‡Šæ‰@Inheritedå†è¿è¡Œä¸€æ¬¡ï¼Œå¯¹æ¯”ä¸€ä¸‹ç»“æœã€‚å¦‚æœæ³¨é‡Šæ‰@Inheritedï¼Œä»Subè¿™ä¸ªç±»æ°¸è¿œæ— æ³•è·å–åˆ°å®ƒçš„çˆ¶ç±»Supperä¸­çš„@SupperAnnotationã€‚Classã€Constructorã€Methodã€Fieldã€Parameteréƒ½å®ç°äº†AnnotatedElementæ¥å£ï¼Œæ‰€ä»¥å®ƒä»¬éƒ½å…·å¤‡æ“ä½œæ³¨è§£çš„åŠŸèƒ½ã€‚ Memberæ¥å£ Memberæ¥å£æ³¨è§£æä¾›æˆå‘˜å±æ€§çš„ä¸€äº›æè¿°ï¼Œä¸»è¦æä¾›çš„æ–¹æ³•å¦‚ä¸‹ï¼š æ–¹æ³• åŠŸèƒ½ Class&lt;?&gt; getDeclaringClass() è·å–å£°æ˜çš„Classå¯¹è±¡ï¼Œä¹Ÿå°±æ˜¯è·å–å½“å‰Memberå®ä¾‹çš„æ¥æºClasså¯¹è±¡ String getName() è·å–å®ä¾‹çš„åç§°ï¼Œå¯¹äºConstructorè¿”å›å…¨ç±»åï¼Œå¯¹äºMethodè¿”å›æ–¹æ³•åï¼Œå¯¹äºFieldè¿”å›å±æ€§å int getModifiers() è·å–å®ä¾‹çš„ä¿®é¥°ç¬¦ boolean isSynthetic() æ˜¯å¦åˆæˆçš„ è¿™äº›æ–¹æ³•é‡Œé¢é™¤äº†isSynthetic()éƒ½æ¯”è¾ƒå¥½ç†è§£ã€‚syntheticæ€»çš„æ¥è¯´ï¼Œæ˜¯ç”±ç¼–è¯‘å™¨å¼•å…¥çš„å­—æ®µã€æ–¹æ³•ã€ç±»æˆ–å…¶ä»–ç»“æ„ï¼Œä¸»è¦ç”¨äºJVMå†…éƒ¨ä½¿ç”¨ï¼Œä¸ºäº†éµå¾ªæŸäº›è§„èŒƒè€Œä½œçš„ä¸€äº›å°æŠ€å·§ä»è€Œç»•è¿‡è¿™äº›è§„èŒƒï¼Œæœ‰ç‚¹ä½œå¼Šçš„æ„Ÿè§‰ï¼Œåªä¸è¿‡æ˜¯ç”±ç¼–è¯‘å™¨å…‰æ˜æ­£å¤§ä¸ºä¹‹ï¼Œä¸€èˆ¬å¼€å‘è€…æ˜¯æ²¡æœ‰æƒé™çš„(ä½†äº‹å®ä¸Šæœ‰æ—¶å€™è¿˜æ˜¯èƒ½è¢«åˆ©ç”¨åˆ°çš„)ã€‚ä¸‹é¢è¿™ä¸ªä¾‹å­å‚è€ƒè‡ªsynthetic Javaåˆæˆç±»å‹: 123456789101112131415161718192021222324252627public class Main &#123; private static class Inner &#123; &#125; static void checkSynthetic (String name) &#123; try &#123; System.out.println (name + \" : \" + Class.forName (name).isSynthetic ()); &#125; catch (ClassNotFoundException exc) &#123; exc.printStackTrace (System.out); &#125; &#125; public static void main(String[] args) throws Exception &#123; new Inner (); checkSynthetic (\"com.fcc.test.Main\"); checkSynthetic (\"com.fcc.test.Main$Inner\"); checkSynthetic (\"com.fcc.test.Main$1\"); &#125;&#125;//æ‰“å°ç»“æœï¼šcom.fcc.test.Main : falsecom.fcc.test.Main$Inner : falsecom.fcc.test.Main$1 : true//ç¼–è¯‘ç»“æœï¼Œç”Ÿæˆä¸‰ä¸ªclassæ–‡ä»¶: Main.class/Main$Inner/Main$1.class// $FF: synthetic classclass Main$1 &#123;&#125; Innerè¿™ä¸ªå†…éƒ¨ç±»æ˜¯ç§æœ‰çš„ï¼Œç§æœ‰å†…éƒ¨ç±»ã€‚æ‹¥æœ‰å†…éƒ¨ç±»çš„ç±»ç¼–è¯‘åå†…å¤–éƒ¨ç±»ä¸¤è€…æ²¡æœ‰å…³ç³»ï¼Œé‚£ä¹ˆç§æœ‰å†…éƒ¨ç±»ç¼–è¯‘åé»˜è®¤æ˜¯æ²¡æœ‰å¯¹å¤–æ„é€ å™¨çš„(å¦‚æœä»¥ä¸Šä»£ç ä¸­åœ¨Inneræ‰‹åŠ¨ç»™ä¸€ä¸ªpublicçš„æ„é€ å™¨ï¼ŒMain$1æ˜¯ä¸ä¼šå‡ºç°çš„)ï¼Œä½†æ˜¯æˆ‘ä»¬åˆçŸ¥é“ï¼Œå¤–éƒ¨ç±»æ˜¯å¯ä»¥å¼•ç”¨å†…éƒ¨ç±»çš„ï¼Œé‚£ä¹ˆç¼–è¯‘åï¼Œåˆæ˜¯ä¸¤ä¸ªæ¯«æ— å…³ç³»çš„ç±»ï¼Œä¸€ä¸ªç±»æ²¡å¯¹å¤–æ„é€ å™¨ï¼Œä½†å¦ä¸€ä¸ªç±»ç¡®å®æ˜¯æœ‰å¯¹è¿™ä¸ªç±»çš„å®ä¾‹å¯¹è±¡æƒé™(è¿™é‡Œå°±æ˜¯é‡ç‚¹ï¼Œå†…éƒ¨ç±»å“ªæ€•æ²¡æœ‰publicæ„é€ å™¨ï¼Œå¤–éƒ¨ç±»éƒ½æœ‰å®ä¾‹åŒ–å†…éƒ¨ç±»å¯¹è±¡çš„æƒé™)çš„ï¼Œè¿™ç§æƒ…å†µä¸‹ç¼–è¯‘å™¨å°±ä¼šç”Ÿæˆä¸€ä¸ªåˆæˆç±»ï¼Œä¹Ÿå°±æ˜¯Main$1ï¼Œä¸€ä¸ªä»€ä¹ˆä¹Ÿæ²¡æœ‰çš„ç©ºç±»(æ˜¯çš„ï¼Œä»€ä¹ˆä¹Ÿæ²¡æœ‰ï¼Œè¿æ„é€ å™¨éƒ½æ²¡æœ‰)ã€‚ä½†åˆ°è¿™é‡Œï¼Œä»ç„¶ä¸æ˜ç™½å…¶å®ç°åŸç†æ˜¯æ€ä¹ˆæ ·çš„ï¼ŒåŸå…ˆä»¥ä¸ºåˆæˆç±»æ˜¯é‚£ä¸ªå†…éƒ¨ç±»çš„å‰¯æœ¬ï¼Œå¤–éƒ¨ç±»è®¿é—®å†…éƒ¨ç±»ï¼Œåœ¨ç¼–è¯‘å™¨è®¤ä¸ºåªæ˜¯å’Œåˆæˆç±»äº¤äº’ï¼Œåªæ˜¯åˆæˆç±»åªæœ‰å¤–éƒ¨ç±»æœ‰æƒé™è®¿é—®ï¼Œä½†æ˜¯äº‹å®ä¸Šï¼Œä¸ç®¡å†…éƒ¨ç±»æ€ä¹ˆå˜åŒ–ï¼Œåˆæˆç±»åªæ˜¯ä¸€ä¸ªç©ºçš„ç±»ï¼Œæœ‰ç‚¹ç±»ä¼¼æ ‡è®°ä½œç”¨(çœŸæ­£ä½œç”¨å´æ˜¯ä¸å¾—è€ŒçŸ¥)ã€‚ AccessibleObjectç±» AccessibleObjectæ˜¯ä¸€ä¸ªæ™®é€šJavaç±»ï¼Œå®ç°äº†AnnotatedElementæ¥å£ï¼Œä½†æ˜¯å¯¹åº”AnnotatedElementçš„éé»˜è®¤æ–¹æ³•çš„å®ç°éƒ½æ˜¯ç›´æ¥æŠ›å¼‚å¸¸ï¼Œä¹Ÿå°±æ˜¯AnnotatedElementçš„æ¥å£æ–¹æ³•å¿…é¡»ç”±AccessibleObjectçš„å­ç±»å»å®ç°ï¼Œä¸ªäººè®¤ä¸ºAccessibleObjectåº”è¯¥è®¾è®¡ä¸ºæŠ½è±¡ç±»ã€‚AccessibleObjectåœ¨JDK1.1çš„æ—¶å€™å·²ç»å­˜åœ¨ï¼Œåœ¨JDK9çš„æ—¶å€™è¢«æ”¹è¿›è¿‡ï¼Œæ·»åŠ äº†ä¸€äº›æ–°çš„æ–¹æ³•ï¼Œä¸‹é¢åˆ—ä¸¾ä¸€ä¸‹å¸¸ç”¨çš„æ–¹æ³•ï¼š æ–¹æ³• åŠŸèƒ½ void setAccessible(boolean flag) è®¾ç½®å®ä¾‹æ˜¯å¦å¯ä»¥è®¿é—®ï¼Œå¦‚æœè®¾ç½®ä¸ºtrueï¼Œå¯ä»¥æŠ‘åˆ¶ä¿®é¥°ç¬¦ï¼Œç›´æ¥è¿›è¡Œè®¿é—® boolean isAccessible() è¿”å›å®ä¾‹æ˜¯å¦å¯ä»¥è®¿é—®ï¼Œå®é™…ä¸Šè¿™ä¸ªå€¼å¹¶ä¸å‡†ç¡®ï¼Œå®ƒåªæœ‰åœ¨setAccessibleè¢«è°ƒç”¨çš„æ—¶å€™æ‰ä¼šæ›´æ–° boolean trySetAccessible() åŠŸèƒ½ç±»ä¼¼äºsetAccessible(boolean flag)ï¼Œè¿”å›å€¼å†³å®šæ˜¯å¦æŠ‘åˆ¶ä¿®é¥°ç¬¦æˆåŠŸ static void setAccessible(AccessibleObject[] array, boolean flag) setAccessible(boolean flag)çš„æ‰¹é‡æ“ä½œæ–¹æ³• ä¸€èˆ¬è€Œè¨€ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡getModifiers()æ–¹æ³•åˆ¤æ–­ä¿®é¥°ç¬¦æ˜¯å¦publicï¼Œå¦‚æœæ˜¯épublicï¼Œåˆ™éœ€è¦è°ƒç”¨setAccessible(true)è¿›è¡Œä¿®é¥°ç¬¦æŠ‘åˆ¶ï¼Œå¦åˆ™ä¼šå› ä¸ºæ— æƒé™è®¿é—®ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ GenericDeclarationæ¥å£ GenericDeclarationæ¥å£ç»§æ‰¿è‡ªAnnotatedElementï¼Œå®ƒçš„æºç å¦‚ä¸‹ï¼š 1234public interface GenericDeclaration extends AnnotatedElement &#123; public TypeVariable&lt;?&gt;[] getTypeParameters();&#125; æ–°å¢äº†ä¸€ä¸ªæ–¹æ³•getTypeParameters()ç”¨äºè¿”å›ç±»å‹å˜é‡TypeVariableæ•°ç»„ï¼Œè¿™é‡Œçš„TypeVariableæ˜¯ç±»å‹å˜é‡ï¼Œå®ƒçš„å®šä¹‰å¦‚ä¸‹ï¼š 12345678910public interface TypeVariable&lt;D extends GenericDeclaration&gt; extends Type, AnnotatedElement &#123; //è·å¾—æ³›å‹çš„ç±»å‹(Type)ä¸Šé™æ•°ç»„ï¼Œè‹¥æœªæ˜ç¡®å£°æ˜ä¸Šè¾¹ç•Œåˆ™é»˜è®¤ä¸ºObject Type[] getBounds(); //è·å–å£°æ˜è¯¥ç±»å‹å˜é‡å®ä½“(å³è·å¾—ç±»ã€æ–¹æ³•æˆ–æ„é€ å™¨å) D getGenericDeclaration(); //è·å¾—æ³›å‹å‚æ•°çš„å­—é¢é‡åç§°ï¼Œå³Kã€Vã€Eä¹‹ç±»åç§° String getName(); //è·å¾—æ³›å‹çš„æ³¨è§£ç±»å‹(AnnotatedType)ä¸Šé™æ•°ç»„ï¼Œè‹¥æœªæ˜ç¡®å£°æ˜ä¸Šåˆ™ä¸ºé•¿åº¦ä¸º0çš„ç©ºæ•°ç»„ AnnotatedType[] getAnnotatedBounds();&#125; åé¢çš„æ–‡ç« ä»‹ç»æ³›å‹çš„æ—¶å€™å†å±•å¼€ã€‚ Executableç±» Executableæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå®ƒç»§æ‰¿è‡ªAccessibleObjectï¼Œå®ç°äº†Memberå’ŒGenericDeclarationæ¥å£ã€‚Executableçš„å®ç°ç±»æ˜¯Methodå’ŒConstructorï¼Œå®ƒçš„ä¸»è¦åŠŸèƒ½æ˜¯ä»Methodå’ŒConstructoræŠ½å–å‡ºä¸¤è€…å¯ä»¥å…±ç”¨çš„ä¸€äº›æ–¹æ³•ä¾‹å¦‚æ³¨è§£çš„æ“ä½œï¼Œå‚æ•°çš„æ“ä½œç­‰ç­‰ï¼Œè¿™é‡Œä¸è¯¦ç»†å±•å¼€ã€‚ Modifier Modifierä¸»è¦æä¾›ä¸€ç³»åˆ—çš„é™æ€æ–¹æ³•ï¼Œç”¨äºåˆ¤æ–­åŸºäºintç±»å‹çš„ä¿®é¥°ç¬¦å‚æ•°çš„å…·ä½“ç±»å‹ï¼Œè¿™ä¸ªä¿®é¥°ç¬¦å‚æ•°æ¥æºäºClassã€Constructorã€Methodã€Fieldã€Parameterçš„getModifiers()æ–¹æ³•ã€‚ä¸‹é¢ä»‹ç»ä¸€ä¸‹Modifierçš„ä¸»è¦æ–¹æ³•ï¼š æ–¹æ³• åŠŸèƒ½ static boolean isAbstract(int mod) æ•´æ•°modifierå‚æ•°æ˜¯å¦åŒ…æ‹¬abstractä¿®é¥°ç¬¦ static boolean isFinal(int mod) æ•´æ•°modifierå‚æ•°æ˜¯å¦åŒ…æ‹¬finalä¿®é¥°ç¬¦ static boolean isInterface(int mod) æ•´æ•°modifierå‚æ•°æ˜¯å¦åŒ…æ‹¬interfaceä¿®é¥°ç¬¦ static boolean isNative(int mod) æ•´æ•°modifierå‚æ•°æ˜¯å¦åŒ…æ‹¬nativeä¿®é¥°ç¬¦ static boolean isPrivate(int mod) æ•´æ•°modifierå‚æ•°æ˜¯å¦åŒ…æ‹¬privateä¿®é¥°ç¬¦ static boolean isProtected(int mod) æ•´æ•°modifierå‚æ•°æ˜¯å¦åŒ…æ‹¬protectedä¿®é¥°ç¬¦ static boolean isPublic(int mod) æ•´æ•°modifierå‚æ•°æ˜¯å¦åŒ…æ‹¬publicä¿®é¥°ç¬¦ static boolean isStatic(int mod) æ•´æ•°modifierå‚æ•°æ˜¯å¦åŒ…æ‹¬staticä¿®é¥°ç¬¦ static boolean isStrict(int mod) æ•´æ•°modifierå‚æ•°æ˜¯å¦åŒ…æ‹¬strictfpä¿®é¥°ç¬¦ static boolean isSynchronized(int mod) æ•´æ•°modifierå‚æ•°æ˜¯å¦åŒ…æ‹¬synchronizedä¿®é¥°ç¬¦ static boolean isTransient(int mod) æ•´æ•°modifierå‚æ•°æ˜¯å¦åŒ…æ‹¬transientä¿®é¥°ç¬¦ static boolean isVolatile(int mod) æ•´æ•°modifierå‚æ•°æ˜¯å¦åŒ…æ‹¬volatileä¿®é¥°ç¬¦ static boolean toString(int mod) è¿”å›æè¿°æŒ‡å®šä¿®é¥°ç¬¦ä¸­çš„è®¿é—®ä¿®é¥°ç¬¦æ ‡å¿—çš„å­—ç¬¦ä¸² Classç±» Classå®ç°äº†Serializableã€GenericDeclarationã€Typeã€AnnotatedElementæ¥å£ï¼Œå®ƒæä¾›äº†ç±»å‹åˆ¤æ–­ã€ç±»å‹å®ä¾‹åŒ–ã€è·å–æ–¹æ³•åˆ—è¡¨ã€è·å–å­—æ®µåˆ—è¡¨ã€è·å–çˆ¶ç±»æ³›å‹ç±»å‹ç­‰æ–¹æ³•ã€‚ä¸‹é¢ä¸»è¦ä»‹ç»ä¸€ä¸‹å®ƒçš„ä¸»è¦æ–¹æ³•ï¼š æ–¹æ³• åŠŸèƒ½ Class&lt;?&gt; forName(String className) ä¼ å…¥å…¨ç±»ååˆ›å»ºClasså®ä¾‹ T newInstance() é€šè¿‡å½“å‰çš„Classå®ä¾‹è¿›è¡Œå®ä¾‹åŒ–å¯¹è±¡ï¼Œè¿”å›çš„å°±æ˜¯æ–°å»ºçš„å¯¹è±¡ int getModifiers() nativeæ–¹æ³•ï¼Œè¿”å›å½“å‰Classçš„ä¿®é¥°ç¬¦ String getName() è¿”å›ç±»åç§°ï¼Œè™šæ‹Ÿæœºä¸­ç±»åè¡¨ç¤º String getCanonicalName() è¿”å›ç±»åç§°ï¼Œä¾¿äºç†è§£çš„ç±»åè¡¨ç¤º String getSimpleName() è¿”å›ç±»åç§°ï¼Œæºä»£ç ä¸­ç»™å‡ºçš„åº•å±‚ç±»çš„ç®€å•åç§° Package getPackage() è¿”å›ç±»çš„åŒ…å±æ€§ String getPackageName() è¿”å›ç±»çš„åŒ…è·¯å¾„åç§° String toGenericString() è¿”å›æè¿°æ­¤Classçš„å­—ç¬¦ä¸²ï¼Œå…¶ä¸­åŒ…æ‹¬ç±»å‹å‚æ•°çš„å­—é¢é‡ TypeVariable&lt;Class&lt;T&gt;&gt;[] getTypeParameters() è·å–ç±»å®šä¹‰æ³›å‹çš„ç±»å‹å˜é‡ Class&lt;?&gt;[] getClasses() è·å–æ‰€æœ‰çš„ä¿®é¥°ç¬¦ä¸ºpublicçš„æˆå‘˜Classï¼ŒåŒ…æ‹¬çˆ¶ç±» Class&lt;?&gt;[] getDeclaredClasses() è·å–æœ¬ç±»æ‰€æœ‰ä¿®é¥°ç¬¦çš„æˆå‘˜Classï¼Œä¸åŒ…æ‹¬çˆ¶ç±» Constructor&lt;?&gt;[] getConstructors() è·å–æ‰€æœ‰çš„ä¿®é¥°ç¬¦ä¸ºpublicçš„æ„é€ å™¨ï¼ŒåŒ…æ‹¬çˆ¶ç±» Constructor&lt;T&gt; getConstructor(Class&lt;?&gt;... parameterTypes) è·å–å‚æ•°ç±»å‹åŒ¹é…çš„ä¿®é¥°ç¬¦ä¸ºpublicçš„æ„é€ å™¨ï¼ŒåŒ…æ‹¬çˆ¶ç±» Constructor&lt;?&gt;[] getDeclaredConstructors() è·å–æœ¬ç±»æ‰€æœ‰ä¿®é¥°ç¬¦çš„æ„é€ å™¨ï¼Œä¸åŒ…æ‹¬çˆ¶ç±» Constructor&lt;T&gt;[] getDeclaredConstructor(Class&lt;?&gt;... parameterTypes) è·å–æœ¬ç±»å‚æ•°ç±»å‹åŒ¹é…çš„æ‰€æœ‰ä¿®é¥°ç¬¦çš„æ„é€ å™¨ï¼Œä¸åŒ…æ‹¬çˆ¶ç±» Method[] getMethods() è·å–æœ¬ç±»æ‰€æœ‰çš„ä¿®é¥°ç¬¦ä¸ºpublicçš„æ–¹æ³•åˆ—è¡¨ï¼ŒåŒ…æ‹¬çˆ¶ç±» Method[] getDeclaredMethods() è·å–æœ¬ç±»æ‰€æœ‰ä¿®é¥°ç¬¦çš„æ–¹æ³•åˆ—è¡¨ï¼Œä¸åŒ…æ‹¬çˆ¶ç±» Method getMethod(String name, Class&lt;?&gt;... parameterTypes) é€šè¿‡æŒ‡å®šæ–¹æ³•åå’Œå‚æ•°ç±»å‹è·å–æœ¬ç±»ä¿®é¥°ç¬¦ä¸ºpublicçš„æ–¹æ³•ï¼ŒåŒ…æ‹¬çˆ¶ç±» Method getDeclaredMethod(String name, Class&lt;?&gt;... parameterTypes) é€šè¿‡æŒ‡å®šæ–¹æ³•åå’Œå‚æ•°ç±»å‹è·å–æœ¬ç±»ä¸é™ä¿®é¥°ç¬¦çš„æ–¹æ³•ï¼Œä¸åŒ…æ‹¬çˆ¶ç±» Field[] getFields() è·å–æœ¬ç±»æ‰€æœ‰çš„ä¿®é¥°ç¬¦ä¸ºpublicçš„å±æ€§åˆ—è¡¨ï¼ŒåŒ…æ‹¬çˆ¶ç±» Field[] getDeclaredFields() è·å–æœ¬ç±»æ‰€æœ‰ä¿®é¥°ç¬¦çš„å±æ€§åˆ—è¡¨ï¼Œä¸åŒ…æ‹¬çˆ¶ç±» Field getField(String name) é€šè¿‡æŒ‡å®šå±æ€§ååè·å–æœ¬ç±»ä¿®é¥°ç¬¦ä¸ºpublicçš„å±æ€§ï¼ŒåŒ…æ‹¬çˆ¶ç±» Field getDeclaredField(String name) é€šè¿‡æŒ‡å®šå±æ€§åè·å–æœ¬ç±»ä¸é™ä¿®é¥°ç¬¦çš„å±æ€§ï¼Œä¸åŒ…æ‹¬çˆ¶ç±» Class&lt;?&gt;[] getInterfaces() è·å–ç±»å®ç°çš„æ‰€æœ‰æ¥å£çš„Classæ•°ç»„ Type[] getGenericInterfaces() è·å–ç±»å®ç°çš„æ‰€æœ‰æ³›å‹å‚æ•°æ¥å£çš„Typeæ•°ç»„ Class&lt;? super T&gt; getSuperclass() è·å–å½“å‰ç±»çš„çˆ¶ç±»çš„Classï¼Œå¦‚æœå½“å‰ç±»æ˜¯Objectã€æ¥å£ã€åŸºæœ¬æ•°æ®ç±»å‹(primitive)æˆ–è€…voidï¼Œåˆ™è¿”å›null Type getGenericSuperclass() è·å–å½“å‰ç±»çš„æ³›å‹å‚æ•°çˆ¶ç±»çš„Typeï¼Œå¦‚æœå½“å‰ç±»æ˜¯Objectã€æ¥å£ã€åŸºæœ¬æ•°æ®ç±»å‹(primitive)æˆ–è€…voidï¼Œåˆ™è¿”å›null native boolean isInstance(Object obj) åˆ¤æ–­ä¼ å…¥çš„objectæ˜¯å¦å½“å‰ç±»çš„å®ä¾‹ native boolean isAssignableFrom(Class&lt;?&gt; cls) åˆ¤æ–­ä¼ å…¥çš„Classå¯¹è±¡æ˜¯å¦å’Œå½“å‰ç±»ç›¸åŒï¼Œæˆ–è€…æ˜¯å¦å½“å‰ç±»çš„è¶…ç±»æˆ–è¶…æ¥å£ native boolean isInterface() åˆ¤æ–­å½“å‰ç±»æ˜¯å¦æ¥å£ native boolean isArray() åˆ¤æ–­å½“å‰ç±»æ˜¯å¦æ•°ç»„ native boolean isPrimitive() åˆ¤æ–­å½“å‰ç±»æ˜¯å¦åŸºæœ¬æ•°æ®ç±»å‹ boolean isAnnotation() åˆ¤æ–­å½“å‰ç±»æ˜¯å¦æ³¨è§£ç±»å‹ boolean isSynthetic() åˆ¤æ–­å½“å‰ç±»æ˜¯å¦å¤åˆ native Class&lt;?&gt; getComponentType() å¦‚æœå½“å‰ç±»æ˜¯æ•°ç»„ï¼Œè¿”å›æ•°ç»„å…ƒç´ çš„ç±»å‹ Class&lt;?&gt; getEnclosingClass() è¿”å›ä¸€ä¸ªç±»ï¼Œå½“å‰ç±»(ä¸€èˆ¬æ˜¯æˆå‘˜ç±»)åœ¨è¿™ä¸ªç±»(å°é—­ç±»ï¼Œç›¸å¯¹äºå†…éƒ¨ç±»çš„å¤–éƒ¨ç±»æˆ–è€…è¯´å¤–é¢ä¸€å±‚)ä¸­å®šä¹‰ Constructor&lt;?&gt; getEnclosingConstructor() è¿”å›æ„é€ å™¨ï¼Œå½“å‰ç±»æ˜¯åœ¨è¿™ä¸ªæ„é€ å‡½æ•°ä¸­å®šä¹‰ Method getEnclosingMethod() è¿”å›æ–¹æ³•ï¼Œå½“å‰ç±»æ˜¯åœ¨è¿™ä¸ªæ–¹æ³•ä¸­å®šä¹‰ Module getModule() è¿”å›æ¨¡å—ï¼ŒJDK9æ–°å¢æ–¹æ³• getName()ã€getCanonicalName()å’ŒgetSimpleName()éƒ½æ˜¯ç”¨äºè·å–ç±»çš„åç§°ï¼Œä½†æ˜¯æœ‰æ‰€åŒºåˆ«ï¼Œä¸‹é¢ä¸¾ä¸ªåˆ—å­è¯´æ˜ä¸€ä¸‹ï¼š 123456789101112131415161718192021public class Main &#123; public static void main(String[] args) &#123; Supper&lt;String, List&lt;Integer&gt;&gt; supper = new Supper&lt;&gt;(); Class&lt;?&gt; clazz = supper.getClass(); System.out.println(\"name-&gt;\" + clazz.getName()); System.out.println(\"canonicalName-&gt;\" + clazz.getCanonicalName()); System.out.println(\"simpleName-&gt;\" + clazz.getSimpleName()); System.out.println(\"======================================\"); String[][] strings = new String[1][1]; System.out.println(\"name-&gt;\" + strings.getClass().getName()); System.out.println(\"canonicalName-&gt;\" + strings.getClass().getCanonicalName()); System.out.println(\"simpleName-&gt;\" + strings.getClass().getSimpleName()); &#125; private static class Supper&lt;K, V&gt; &#123; private K key; private V value; //çœç•¥setterå’Œgetteræ–¹æ³• &#125;&#125; è¿è¡Œåè¾“å‡ºç»“æœï¼š 1234567name-&gt;club.throwable.reflect.Main$SuppercanonicalName-&gt;club.throwable.reflect.Main.SuppersimpleName-&gt;Supper======================================name-&gt;[[Ljava.lang.String;canonicalName-&gt;java.lang.String[][]simpleName-&gt;String[][] ç®€å•ç†è§£ä¸ºï¼š getName()ï¼šç”¨äºè·å–ç±»åœ¨Javaè™šæ‹Ÿæœºä¸­çš„ç±»åè¡¨ç¤ºã€‚ getCanonicalName()ï¼šç”¨äºè·å–å…¨ç±»åï¼ŒåŒ…æ‹¬åŒ…è·¯å¾„ï¼ŒåŒ…è·¯å¾„ä»¥ç‚¹å·åˆ†éš”ã€‚ getSimpleName()ï¼šç”¨äºè·å–ç±»åï¼Œä¸åŒ…æ‹¬åŒ…è·¯å¾„ã€‚ ä¸‹é¢å†ä¸¾ä¸€ä¸ªä¾‹å­é€šè¿‡ç±»åè¿›è¡Œå®ä¾‹åŒ–å¯¹è±¡å’Œæ“ä½œï¼Œä»ä¾‹å­å¯ä»¥çœ‹åˆ°ï¼Œå®ä¾‹åŒ–å¯¹è±¡å¯ä»¥ä¸ä¾èµ–newå…³é”®å­—ï¼Œè¿™å°±æ˜¯åå°„çš„å¼ºå¤§ä¹‹å¤„ï¼š 123456789101112131415public class Main3 &#123; public static void main(String[] args) throws Exception &#123; Class&lt;?&gt; clazz = Class.forName(\"club.throwable.reflect.Main3$Supper\"); Supper supper = (Supper) clazz.newInstance(); System.out.println(supper.sayHello(\"throwable\")); &#125; public static class Supper &#123; public String sayHello(String name) &#123; return String.format(\"%s say hello!\", name); &#125; &#125;&#125; è¿™é‡Œéœ€è¦æ³¨æ„ä¸€ç‚¹ï¼ŒClass.forNameæ–¹æ³•åªèƒ½ä½¿ç”¨åœ¨ä¿®é¥°ç¬¦ä¸ºpublicçš„ç±»ä¸Šï¼Œå¦‚æœä½¿ç”¨åœ¨å…¶ä»–ä¿®é¥°ç¬¦ç±»ä¸Šä¼šæŠ›å‡ºå¼‚å¸¸(IllegalAccessException)ï¼Œé‚£ä¹ˆï¼Œå¦‚æœä¸Šé¢çš„Supperç±»çš„ä¿®é¥°ç¬¦ä¿®æ”¹ä¸ºprivateï¼Œæ€ä¹ˆæ ·æ‰èƒ½æ­£å¸¸å®ä¾‹åŒ–å®ƒï¼Ÿè¿™ä¸ªé—®é¢˜å°†ä¼šåœ¨ä¸‹é¢åˆ†æConstructorçš„æ—¶å€™å¾—åˆ°è§£å†³ã€‚å¦å¤–ï¼Œè¿™é‡Œçš„Class.forNameæ–¹æ³•ä¸æ˜¯è·å–Classå®ä¾‹çš„å”¯ä¸€æ–¹å¼ï¼Œæ€»ç»“æœ‰ä»¥ä¸‹ä¸‰ç§æ–¹å¼ï¼š 1ã€ä½¿ç”¨ç±»çš„å­—é¢é‡&quot;ç±»å.class&quot;ã€‚ç±»å­—é¢å¸¸é‡ä½¿å¾—åˆ›å»ºClasså¯¹è±¡çš„å¼•ç”¨æ—¶ä¸ä¼šè‡ªåŠ¨åœ°åˆå§‹åŒ–è¯¥å¯¹è±¡ï¼Œè€Œæ˜¯æŒ‰ç…§ä¹‹å‰æåˆ°çš„åŠ è½½ï¼Œé“¾æ¥ï¼Œåˆå§‹åŒ–ä¸‰ä¸ªæ­¥éª¤ï¼Œè¿™ä¸‰ä¸ªæ­¥éª¤æ˜¯ä¸ªæ‡’åŠ è½½çš„è¿‡ç¨‹ï¼Œä¸ä½¿ç”¨çš„æ—¶å€™å°±ä¸åŠ è½½ã€‚ 2ã€ä½¿ç”¨Class.forName(å…¨ç±»å);æ–¹æ³•ã€‚ 3ã€ä½¿ç”¨å®ä¾‹çš„getClass()æ–¹æ³•ã€‚getClass()æ˜¯æ‰€æœ‰çš„å¯¹è±¡éƒ½èƒ½å¤Ÿä½¿ç”¨çš„æ–¹æ³•ï¼Œå› ä¸ºgetClass()æ–¹æ³•æ˜¯Objectç±»çš„æ–¹æ³•ï¼Œæ‰€æœ‰çš„ç±»éƒ½ç»§æ‰¿äº†Objectï¼Œå› æ­¤æ‰€æœ‰ç±»çš„å¯¹è±¡ä¹Ÿéƒ½å…·æœ‰getClass()æ–¹æ³•ã€‚ ä¸€èˆ¬æ¥è¯´ï¼Œä½¿ç”¨&quot;ç±»å.class&quot;ï¼Œè¿™æ ·åšå³ç®€å•å®‰å…¨åˆæ¯”è¾ƒé«˜æ•ˆã€‚å› ä¸ºåœ¨ç¼–è¯‘æ—¶å°±ä¼šå—åˆ°æ£€æŸ¥ï¼Œå› æ­¤ä¸éœ€è¦ç½®äºtryè¯­å¥å—ä¸­ï¼Œå¹¶ä¸”å®ƒæ ¹é™¤äº†å¯¹forName()æ–¹æ³•çš„è°ƒç”¨(forName()æ–¹æ³•æ˜¯ä¸€ä¸ªè€—æ—¶æ¯”è¾ƒå¤šçš„æ–¹æ³•)ï¼Œæ‰€ä»¥ç›¸å¯¹æ¯”è¾ƒé«˜æ•ˆã€‚ æœ€åï¼Œåˆ†æä¸€ä¸‹è¿™å‡ ä¸ªæ¯”è¾ƒéš¾æ‡‚çš„æ–¹æ³•getEnclosingClass()ã€getEnclosingConstructor()ã€getEnclosingMethod()ï¼š getEnclosingClass()ï¼šè¿”å›ä¸€ä¸ªç±»ï¼Œå½“å‰ç±»(ä¸€èˆ¬æ˜¯æˆå‘˜ç±»)åœ¨è¿™ä¸ªç±»(ä¸€èˆ¬å«å°é—­ç±»ï¼Œç›¸å¯¹äºå†…éƒ¨ç±»çš„å¤–éƒ¨ç±»æˆ–è€…è¯´å¤–é¢ä¸€å±‚)ä¸­å®šä¹‰ã€‚ getEnclosingConstructor()ï¼šè¿”å›æ„é€ å™¨ï¼Œå½“å‰ç±»æ˜¯åœ¨è¿™ä¸ªæ„é€ å‡½æ•°ä¸­å®šä¹‰ã€‚ getEnclosingClass()ï¼šè¿”å›æ–¹æ³•ï¼Œå½“å‰ç±»æ˜¯åœ¨è¿™ä¸ªæ–¹æ³•ä¸­å®šä¹‰ã€‚ æˆ‘ä»¬åœ¨æ–°å»ºä¸€ä¸ªç±»çš„æ—¶å€™ï¼Œè¿™ä¸ªç±»å¯ä»¥ä½¿å¦ä¸€ä¸ªç±»ä¸­å®šä¹‰çš„æˆå‘˜ç±»ã€æ„é€ æ–¹æ³•ä¸­å®šä¹‰çš„å†…éƒ¨ç±»ã€æ–¹æ³•ä¸­å®šä¹‰çš„å†…éƒ¨ç±»ã€‚å¯ä»¥é€šè¿‡å½“å‰çš„ç±»åå‘è·å–å®šä¹‰å½“å‰çš„ç±»çš„ç±»ã€æ„é€ æˆ–è€…æ–¹æ³•ï¼Œè¿™ä¸‰ç§æƒ…å†µå¯¹åº”ä¸Šé¢ä¸‰ä¸ªæ–¹æ³•ã€‚ä¸¾ä¸ªä¾‹å­ï¼š getEnclosingClass()æ–¹æ³•ä½¿ç”¨ä¾‹å­ï¼š 123456789101112131415public class Main5 &#123; public static void main(String[] args) throws Exception&#123; Class&lt;Outter.Inner&gt; clazz = Outter.Inner.class; Class&lt;?&gt; enclosingClass = clazz.getEnclosingClass(); System.out.println(enclosingClass.getName()); &#125; // Innerç±»æ˜¯Outterç±»çš„æˆå‘˜ç±» public static class Outter &#123; public static class Inner &#123; &#125; &#125;&#125; è¾“å‡ºç»“æœï¼š 1org.throwable.inherited.Main5$Outter åœ¨è¿™é‡Œï¼ŒInnerå°±æ˜¯å½“å‰å®šä¹‰çš„ç±»ï¼Œå®ƒæ˜¯Outterçš„é™æ€æˆå‘˜ç±»ï¼Œæˆ–è€…è¯´Outteræ˜¯Innerçš„å°é—­ç±»ï¼Œé€šè¿‡Innerçš„Classçš„getEnclosingClass()æ–¹æ³•è·å–åˆ°çš„å°±æ˜¯Outterçš„Classå®ä¾‹ã€‚ getEnclosingConstructor()æ–¹æ³•ä½¿ç”¨ä¾‹å­ï¼š 1234567891011121314151617181920212223public class Main6 &#123; public static void main(String[] args) throws Exception &#123; Outter outter = new Outter(); &#125; public static class Outter &#123; //Outterçš„æ— å‚æ•°æ„é€ å™¨ public Outter() &#123; //æ„é€ ä¸­å®šä¹‰çš„å†…éƒ¨ç±» class Inner &#123; &#125; Class&lt;Inner&gt; innerClass = Inner.class; Class&lt;?&gt; enclosingClass = innerClass.getEnclosingClass(); System.out.println(enclosingClass.getName()); Constructor&lt;?&gt; enclosingConstructor = innerClass.getEnclosingConstructor(); System.out.println(enclosingConstructor.getName()); &#125; &#125;&#125; è¾“å‡ºç»“æœï¼š 12org.throwable.inherited.Main6$Outterorg.throwable.inherited.Main6$Outter åœ¨è¿™é‡Œï¼ŒInneræ˜¯Outterçš„æ— å‚æ•°æ„é€ é‡Œé¢å®šä¹‰çš„æ„é€ å†…éƒ¨ç±»ï¼Œå®ƒä¹Ÿåªèƒ½åœ¨Outterçš„æ— å‚æ•°æ„é€ é‡Œé¢ä½¿ç”¨ï¼Œé€šè¿‡Innerçš„Classçš„getEnclosingConstructor()æ–¹æ³•è·å–åˆ°çš„å°±æ˜¯Outterçš„æ— å‚æ•°æ„é€ ã€‚ getEnclosingMethod()æ–¹æ³•ä½¿ç”¨ä¾‹å­ï¼š 1234567891011121314151617181920212223public class Main7 &#123; public static void main(String[] args) throws Exception &#123; Outter outter = new Outter(); outter.print(); &#125; public static class Outter &#123; public void print()&#123; //æ–¹æ³•printä¸­å®šä¹‰çš„å†…éƒ¨ç±» class Inner &#123; &#125; Class&lt;Inner&gt; innerClass = Inner.class; Class&lt;?&gt; enclosingClass = innerClass.getEnclosingClass(); System.out.println(enclosingClass.getName()); Method enclosingMethod = innerClass.getEnclosingMethod(); System.out.println(enclosingMethod.getName()); &#125; &#125;&#125; è¾“å‡ºç»“æœï¼š 12org.throwable.inherited.Main7$Outterprint åœ¨è¿™é‡Œï¼ŒInneræ˜¯Outterçš„printæ–¹æ³•é‡Œé¢å®šä¹‰çš„æ–¹æ³•å†…éƒ¨ç±»ï¼Œå®ƒä¹Ÿåªèƒ½åœ¨Outterçš„printæ–¹æ³•é‡Œé¢ä½¿ç”¨ï¼Œé€šè¿‡Innerçš„Classçš„getEnclosingMethod()æ–¹æ³•è·å–åˆ°çš„å°±æ˜¯Outterçš„printæ–¹æ³•ã€‚è¿™ç§æ–¹å¼å¯èƒ½ä¸å¸¸ç”¨ï¼Œä½†æ˜¯å¯ä»¥åœ¨æŸç‰ˆæœ¬çš„spring-jdbcçš„JdbcTemplateçš„æºç ä¸­çœ‹åˆ°ç±»ä¼¼çš„ç±»å®šä¹‰é€»è¾‘ã€‚ å‰é¢ä»‹ç»è¿‡getXXX()æ–¹æ³•å’ŒgetDeclearedXXX()æ–¹æ³•æœ‰æ‰€åŒºåˆ«ï¼Œè¿™é‡Œåšä¸ªå¯¹æ¯”è¡¨æ ¼ï¼š Classä¸­è·å–Fieldåˆ—è¡¨çš„æ–¹æ³•ï¼š Classä¸­çš„API è·å–æ‰€æœ‰çš„Field åŒ…æ‹¬ç»§æ‰¿çš„Field åŒ…æ‹¬ç§æœ‰çš„Field getDeclaredField() N N Y getField() N Y N getDeclaredFields() Y N Y getFields() Y Y N Classä¸­è·å–Methodåˆ—è¡¨çš„æ–¹æ³•ï¼š Classä¸­çš„API è·å–æ‰€æœ‰çš„Method åŒ…æ‹¬ç»§æ‰¿çš„Method åŒ…æ‹¬ç§æœ‰çš„Method getDeclaredMethod() N N Y getMethod() N Y N getDeclaredMethods() Y N Y getMethods() Y Y N Classä¸­è·å–Constructoråˆ—è¡¨çš„æ–¹æ³•ï¼š Classä¸­çš„API è·å–æ‰€æœ‰çš„Constructor åŒ…æ‹¬ç§æœ‰çš„Constructor getDeclaredConstructor() N Y getConstructor() N N getDeclaredConstructors() Y Y getConstructors() Y N Constructorç±» Constructorç”¨äºæè¿°ä¸€ä¸ªç±»çš„æ„é€ å‡½æ•°ã€‚å®ƒé™¤äº†èƒ½è·å–åˆ°æ„é€ çš„æ³¨è§£ä¿¡æ¯ã€å‚æ•°çš„æ³¨è§£ä¿¡æ¯ã€å‚æ•°çš„ä¿¡æ¯ä¹‹å¤–ï¼Œè¿˜æœ‰ä¸€ä¸ªå¾ˆé‡è¦çš„ä½œç”¨æ˜¯å¯ä»¥æŠ‘åˆ¶ä¿®é¥°ç¬¦è¿›è¡Œå®ä¾‹åŒ–ï¼Œè€ŒClassçš„å®ä¾‹åŒ–æ–¹æ³•newInstanceåªèƒ½å®ä¾‹åŒ–ä¿®é¥°ç¬¦ä¸ºpublicçš„ç±»ã€‚Constructorçš„ä¸»è¦æ–¹æ³•å¦‚ä¸‹ï¼š æ–¹æ³• åŠŸèƒ½ Class&lt;T&gt; getDeclaringClass() è·å–å½“å‰æ„é€ çš„å®šä¹‰ç±» String getName() è·å–å½“å‰æ„é€ çš„åç§° int getModifiers() è·å–å½“å‰æ„é€ çš„ä¿®é¥°ç¬¦ String toGenericString() è¿”å›æè¿°æ­¤æ„é€ çš„å­—ç¬¦ä¸²ï¼Œå…¶ä¸­åŒ…æ‹¬ç±»å‹å‚æ•°çš„å­—é¢é‡ TypeVariable&lt;Constructor&lt;T&gt;&gt;[] getTypeParameters() è·å–ç±»å®šä¹‰æ³›å‹å‚æ•°çš„ç±»å‹å˜é‡ Class&lt;?&gt;[] getExceptionTypes() è·å–å½“å‰æ„é€ å¼‚å¸¸ç±»å‹æ•°ç»„ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¿”å›ä¸€ä¸ªé•¿åº¦ä¸º0çš„æ•°ç»„ Type[] getGenericExceptionTypes() è·å–å½“å‰æ„é€ å¼‚å¸¸ç±»å‹æ•°ç»„çš„æ³›å‹ç±»å‹ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¿”å›ä¸€ä¸ªé•¿åº¦ä¸º0çš„æ•°ç»„ Type[] getGenericParameterTypes() è·å–å½“å‰æ„é€ å‚æ•°çš„æ³›å‹ç±»å‹ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™è¿”å›ä¸€ä¸ªé•¿åº¦ä¸º0çš„æ•°ç»„ Annotation[][] getParameterAnnotations() è·å–å½“å‰æ„é€ å‚æ•°çš„æ³¨è§£æ•°ç»„ï¼Œè¿™é‡Œæ˜¯äºŒç»´æ•°ç»„çš„åŸå› æ˜¯ä¸€ä¸ªå‚æ•°å¯ä»¥ä½¿ç”¨å¤šä¸ªæ³¨è§£ int getParameterCount() è·å–å½“å‰æ„é€ å‚æ•°çš„æ•°é‡ Class&lt;?&gt;[] getParameterTypes() è·å–å½“å‰æ„é€ å‚æ•°çš„Classæ•°ç»„ boolean isSynthetic() å½“å‰æ„é€ æ˜¯å¦å¤åˆçš„ boolean isVarArgs() å½“å‰æ„é€ æ˜¯å¦ä½¿ç”¨ä¸å®šå‚æ•° T newInstance(Objectâ€¦initargs) ä½¿ç”¨æ­¤æ„é€ å¯¹è±¡è¡¨ç¤ºçš„æ„é€ æ–¹æ³•æ¥åˆ›å»ºè¯¥æ„é€ æ–¹æ³•çš„å£°æ˜ç±»çš„æ–°å®ä¾‹ï¼Œå¹¶ç”¨æŒ‡å®šçš„åˆå§‹åŒ–å‚æ•°åˆå§‹åŒ–è¯¥å®ä¾‹ Parameter[] getParameters() è¿”å›æ­¤æ„é€ å¯¹è±¡çš„å‚æ•°Parameteræ•°ç»„ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿”å›ä¸€ä¸ªé•¿åº¦ä¸º0çš„æ•°ç»„ void setAccessible(boolean flag) æŠ‘åˆ¶æ„é€ è®¿é—®ä¿®é¥°ç¬¦çš„æƒé™åˆ¤æ–­ ä¸‹é¢æˆ‘ä»¬ä¸¾ä¸ªä¾‹å­è¯´æ˜ä½¿ç”¨æ„é€ å®ä¾‹åŒ–å¯¹è±¡å¯ä»¥æŠ‘åˆ¶ä¿®é¥°ç¬¦è®¿é—®æƒé™æ§åˆ¶çš„é—®é¢˜ï¼š 1234567891011121314151617public class Main8 &#123; public static void main(String[] args) throws Exception&#123; Class&lt;Supper&gt; supperClass = Supper.class; Constructor&lt;Supper&gt; constructor = supperClass.getDeclaredConstructor(); constructor.setAccessible(Boolean.TRUE); Supper supper = constructor.newInstance(); supper.sayHello(\"throwable\"); &#125; private static class Supper &#123; public void sayHello(String name) &#123; System.out.println(String.format(\"%s say hello!\", name)); &#125; &#125;&#125; è¾“å‡ºç»“æœï¼š 1throwable say hello! è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¸€äº›IOCå®¹å™¨çš„å®ç°æ¡†æ¶ä¸­å®ä¾‹åŒ–ç±»çš„æ—¶å€™ä¼˜å…ˆä¾èµ–äºæ— å‚æ•°æ„é€ çš„åŸå› ï¼Œå¦‚æœä½¿ç”¨Class#newInstanceæ–¹æ³•ï¼Œä¸Šé¢çš„ä»£ç è°ƒç”¨é€»è¾‘ä¼šæŠ›å¼‚å¸¸ã€‚ Methodç±» Methodç”¨äºæè¿°ä¸€ä¸ªç±»çš„æ–¹æ³•ã€‚å®ƒé™¤äº†èƒ½è·å–æ–¹æ³•çš„æ³¨è§£ä¿¡æ¯ï¼Œè¿˜èƒ½è·å–æ–¹æ³•å‚æ•°ã€è¿”å›å€¼çš„æ³¨è§£ä¿¡æ¯å’Œå…¶ä»–ä¿¡æ¯ã€‚Methodå¸¸ç”¨çš„æ–¹æ³•å¦‚ä¸‹ï¼š æ–¹æ³• åŠŸèƒ½ Class&lt;?&gt; getDeclaringClass() è·å–æ–¹æ³•å¯¹åº”çš„Class Object getDefaultValue() è·å–æ–¹æ³•ä¸Šçš„æ³¨è§£æˆå‘˜çš„é»˜è®¤å€¼ Class&lt;?&gt;[] getExceptionTypes() è·å–æ–¹æ³•ä¸Šçš„å¼‚å¸¸ç±»å‹æ•°ç»„ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿”å›ä¸€ä¸ªé•¿åº¦ä¸º0çš„æ•°ç»„ Type[] getGenericExceptionTypes() è·å–æ–¹æ³•ä¸Šçš„å¼‚å¸¸æ³›å‹ç±»å‹Typeæ•°ç»„ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿”å›ä¸€ä¸ªé•¿åº¦ä¸º0çš„æ•°ç»„ Parameter[] getParameters() è¿”å›æ–¹æ³•çš„å‚æ•°Parameteræ•°ç»„ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿”å›ä¸€ä¸ªé•¿åº¦ä¸º0çš„æ•°ç»„ int getParameterCount() è¿”å›æ–¹æ³•çš„å‚æ•°çš„æ•°é‡ Class&lt;?&gt;[] getParameterTypes() è¿”å›æ–¹æ³•çš„å‚æ•°çš„ç±»å‹Classæ•°ç»„ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿”å›ä¸€ä¸ªé•¿åº¦ä¸º0çš„æ•°ç»„ Annotation[][] getParameterAnnotations() è¿”å›æ–¹æ³•çš„æ³¨è§£Annotationæ•°ç»„ï¼Œè¿™é‡Œä½¿ç”¨äºŒç»´æ•°ç»„çš„åŸå› æ˜¯ä¸€ä¸ªå‚æ•°å¯ä»¥ä½¿ç”¨å¤šä¸ªæ³¨è§£ TypeVariable&lt;Method&gt;[] getTypeParameters() è¿”å›æ–¹æ³•çš„æ³›å‹å‚æ•°çš„ç±»å‹å˜é‡ Type[] getGenericParameterTypes() è¿”å›æ–¹æ³•å‚æ•°çš„æ³›å‹ç±»å‹Typeæ•°ç»„ Class&lt;?&gt; getReturnType() è¿”å›æ–¹æ³•çš„è¿”å›å€¼çš„ç±»å‹Class Type getGenericReturnType() è¿”å›æ–¹æ³•çš„è¿”å›å€¼çš„æ³›å‹ç±»å‹Type AnnotatedType getAnnotatedReturnType() è·å–æ–¹æ³•è¿”å›å€¼çš„æ³¨è§£ç±»å‹å®ä¾‹AnnotatedType boolean isBridge() æ˜¯å¦æ¡¥æ–¹æ³• boolean isDefault() æ˜¯å¦æ¥å£çš„é»˜è®¤æ–¹æ³• boolean isSynthetic() æ˜¯å¦å¤åˆçš„ boolean isVarArgs() æ˜¯å¦ä½¿ç”¨äº†ä¸å®šå‚æ•° String toGenericString() è¿”å›æ–¹æ³•å¸¦æœ‰æ³›å‹å­—é¢é‡çš„æè¿°å­—ç¬¦ä¸² String getName() è¿”å›æ–¹æ³•çš„åç§° int getModifiers() è¿”å›æ–¹æ³•çš„ä¿®é¥°ç¬¦ Object invoke(Object obj, Objectâ€¦ args) å¯¹å¸¦æœ‰æŒ‡å®šå‚æ•°çš„æŒ‡å®šå¯¹è±¡è°ƒç”¨ç”±æ­¤æ–¹æ³•å¯¹è±¡è¡¨ç¤ºçš„åº•å±‚æ–¹æ³• void setAccessible(boolean flag) æŠ‘åˆ¶æ–¹æ³•è®¿é—®ä¿®é¥°ç¬¦çš„æƒé™åˆ¤æ–­ å…³æ³¨å…¶ä¸­çš„invoke(Object obj, Object... args)æ–¹æ³•ï¼Œç¬¬ä¸€ä¸ªæ˜¯è¦è°ƒç”¨è¿™ä¸ªæ–¹æ³•çš„å¯¹è±¡ï¼Œå‰©ä¸‹çš„æ–¹æ³•çš„å‚æ•°ï¼Œè¿”å›å€¼å°±æ˜¯è¯¥æ–¹æ³•æ‰§è¡Œçš„è¿”å›å€¼ã€‚å¦‚æœæ–¹æ³•çš„ä¿®é¥°ç¬¦ä¸æ˜¯publicï¼Œåœ¨è°ƒç”¨invokeæ–¹æ³•å‰éœ€è¦è°ƒç”¨setAccessible(boolean flag)æŠ‘åˆ¶æ–¹æ³•è®¿é—®ä¿®é¥°ç¬¦çš„æƒé™åˆ¤æ–­ï¼Œå¦åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ä¸¾ä¸ªä¾‹å­å¦‚ä¸‹ï¼š 1234567891011121314151617public class Main10 &#123; public static void main(String[] args) throws Exception&#123; Class&lt;Supper&gt; supperClass = Supper.class; Supper supper = supperClass.newInstance(); Method sayHello = supperClass.getDeclaredMethod(\"sayHello\", String.class); sayHello.setAccessible(Boolean.TRUE); sayHello.invoke(supper,\"throwable\"); &#125; public static class Supper&#123; private void sayHello(String name)&#123; System.out.println(String.format(\"%s say hello!\", name)); &#125; &#125;&#125; è¾“å‡ºç»“æœï¼š 1throwable say hello! Fieldç±» Fieldç±»ç”¨æ¥æè¿°ä¸€ä¸ªç±»é‡Œé¢çš„å±æ€§æˆ–è€…å«æˆå‘˜å˜é‡ï¼Œé€šè¿‡Fieldå¯ä»¥è·å–å±æ€§çš„æ³¨è§£ä¿¡æ¯ã€æ³›å‹ä¿¡æ¯ï¼Œè·å–å’Œè®¾ç½®å±æ€§çš„å€¼ç­‰ç­‰ã€‚Fieldçš„ä¸»è¦æ–¹æ³•å¦‚ä¸‹ï¼š æ–¹æ³• åŠŸèƒ½ String getName() è¿”å›è¯¥å±æ€§çš„åç§° int getModifiers() è¿”å›è¯¥å±æ€§çš„ä¿®é¥°ç¬¦ Class&lt;?&gt; getType() è¿”å›è¯¥å±æ€§çš„ç±»å‹Class Class&lt;?&gt; getParameterizedType() è¿”å›è¯¥å±æ€§çš„æ³›å‹ç±»å‹Type boolean isSynthetic() è¯¥å±æ€§æ˜¯å¦å¤åˆçš„ boolean isEnumConstant() è¯¥å±æ€§æ˜¯å¦æšä¸¾ç±»å‹çš„å…ƒç´  Object get(Object obj) é€šè¿‡å¯¹è±¡å®ä¾‹è·å–è¯¥å±æ€§çš„å€¼ void set(Object obj,Object value) é€šè¿‡å¯¹è±¡å®ä¾‹è®¾ç½®è¯¥å±æ€§çš„å€¼ void setAccessible(boolean flag) æŠ‘åˆ¶å±æ€§è®¿é—®ä¿®é¥°ç¬¦çš„æƒé™åˆ¤æ–­ è¿™é‡Œå¿½ç•¥äº†æ³¨è§£ä»¥åŠFieldå®ç°äº†FieldAccessoræ¥å£ä¸­çš„getBooleanã€setBooleanç­‰æ–¹æ³•ã€‚ä¸‹é¢ä¸¾ä¸ªä¾‹å­è¯´æ˜ä¸€ä¸‹Fieldçš„ç”¨æ³•ï¼š 1234567891011121314151617181920212223242526public class Main12 &#123; public static void main(String[] args) throws Exception &#123; Class&lt;Supper&gt; supperClass = Supper.class; Supper supper = supperClass.newInstance(); Method sayHello = supperClass.getDeclaredMethod(\"sayHello\"); sayHello.setAccessible(Boolean.TRUE); Field name = supperClass.getDeclaredField(\"name\"); name.setAccessible(Boolean.TRUE); name.set(supper,\"throwable\"); System.out.println(\"Field get--&gt;\" + name.get(supper)); sayHello.invoke(supper); name.set(supper, \"throwable-10086\"); System.out.println(\"Field get--&gt;\" + name.get(supper)); sayHello.invoke(supper); &#125; public static class Supper &#123; private String name; private void sayHello() &#123; System.out.println(String.format(\"%s say hello!\", name)); &#125; &#125;&#125; è¾“å‡ºç»“æœï¼š 1234Field get--&gt;throwablethrowable say hello!Field get--&gt;throwable-10086throwable-10086 say hello! Parameterç±» Parameterç”¨äºæè¿°Methodæˆ–è€…Constructorçš„å‚æ•°ï¼Œä¸»è¦æ˜¯ç”¨äºè·å–å‚æ•°çš„åç§°ã€‚å› ä¸ºåœ¨Javaä¸­æ²¡æœ‰å½¢å¼å‚æ•°çš„æ¦‚å¿µï¼Œä¹Ÿå°±æ˜¯å‚æ•°éƒ½æ˜¯æ²¡æœ‰åç§°çš„ã€‚Jdk1.8æ–°å¢äº†Parameterç”¨æ¥å¡«è¡¥è¿™ä¸ªé—®é¢˜ï¼Œä½¿ç”¨javacç¼–è¯‘å™¨çš„æ—¶å€™åŠ ä¸Š-parameterså‚æ•°çš„è¯ï¼Œä¼šåœ¨ç”Ÿæˆçš„.classæ–‡ä»¶ä¸­é¢å¤–å­˜å‚¨å‚æ•°çš„å…ƒä¿¡æ¯ï¼Œè¿™æ ·ä¼šå¯¼è‡´.classæ–‡ä»¶çš„å¤§å°å¢åŠ ã€‚å½“ä½ è¾“å…¥javac -helpçš„æ—¶å€™ï¼Œä½ ä¼šçœ‹åˆ°-parametersè¿™ä¸ªé€‰é¡¹ã€‚è·å–Parameterçš„æ–¹æ³•æ˜¯Methodæˆ–è€…Constructorçš„çˆ¶ç±»Executableçš„getParamatersæ–¹æ³•ã€‚ä¸€èˆ¬è€Œè¨€ï¼ŒParameteræ˜¯ç”¨äºè·å–å‚æ•°åç§°çš„åå¤‡æ–¹æ¡ˆï¼Œå› ä¸ºJdk1.8ä¹‹å‰æ²¡æœ‰è¿™ä¸ªç±»ï¼Œå¹¶ä¸”å³ä½¿ä½¿ç”¨äº†Jdk1.8å¦‚æœjavacç¼–è¯‘å™¨çš„æ—¶å€™æ²¡æœ‰åŠ ä¸Š-parameterså‚æ•°çš„è¯ï¼Œé€šè¿‡Parameterè·å–åˆ°çš„å‚æ•°åç§°å°†ä¼šæ˜¯&quot;arg0&quot;ã€â€œarg1â€â€¦&quot;argn&quot;ç±»ä¼¼çš„æ²¡æœ‰æ„ä¹‰çš„å‚æ•°åç§°ã€‚ä¸€èˆ¬æ¡†æ¶ä¸­ä½¿ç”¨å…¶ä»–æ–¹æ³•è§£ææ–¹æ³•æˆ–è€…æ„é€ å™¨çš„å‚æ•°åç§°ï¼Œå‚è€ƒSpringçš„æºç ï¼Œå…·ä½“æ˜¯LocalVariableTableParameterNameDiscovererï¼Œæ˜¯ä½¿ç”¨ASMå»è§£æå’Œè¯»å–ç±»æ–‡ä»¶å­—èŠ‚ç ï¼Œæå–å‚æ•°åç§°ã€‚Parameterçš„ä¸»è¦æ–¹æ³•å¦‚ä¸‹ï¼š æ–¹æ³• åŠŸèƒ½ String getName() è¿”å›è¯¥å‚æ•°çš„åç§° int getModifiers() è¿”å›è¯¥å‚æ•°çš„ä¿®é¥°ç¬¦ Class&lt;?&gt; getType() è¿”å›è¯¥å‚æ•°çš„ç±»å‹Class Class&lt;?&gt; getParameterizedType() è¿”å›è¯¥å‚æ•°çš„æ³›å‹ç±»å‹Type boolean isNamePresent() è¯¥å‚æ•°çš„åç§°æ˜¯å¦ä¿å­˜åœ¨classæ–‡ä»¶ä¸­ï¼Œéœ€è¦ç¼–è¯‘æ—¶åŠ å‚æ•°-parameters boolean isImplicit() è¯¥å‚æ•°æ˜¯å¦éšå¼å£°æ˜ boolean isSynthetic() è¯¥å‚æ•°æ˜¯å¦å¤åˆçš„ boolean isVarArgs() è¯¥å‚æ•°æ˜¯å¦ä¸å®šå‚æ•° è¿™é‡Œä¸¾ä¸ªä¾‹å­ï¼Œç¼–è¯‘æ—¶å€™æ·»åŠ å‚æ•°-parametersï¼š 1234567891011121314151617181920212223public class Main11 &#123; public static void main(String[] args) throws Exception &#123; Class&lt;Supper&gt; supperClass = Supper.class; Method sayHello = supperClass.getDeclaredMethod(\"sayHello\", String.class); sayHello.setAccessible(Boolean.TRUE); Parameter[] parameters = sayHello.getParameters(); for (Parameter parameter : parameters) &#123; System.out.println(\"isNamePresent-&gt;\" + parameter.isNamePresent()); System.out.println(\"isImplicit-&gt;\" + parameter.isImplicit()); System.out.println(\"getName-&gt;\" + parameter.getName()); System.out.println(\"=====================\"); &#125; &#125; public static class Supper &#123; private void sayHello(String name) &#123; System.out.println(String.format(\"%s say hello!\", name)); &#125; &#125;&#125; è¾“å‡ºç»“æœï¼š 1234isNamePresent-&gt;trueisImplicit-&gt;falsegetName-&gt;name===================== å¦‚æœä¸è®¾ç½®ç¼–è¯‘å‚æ•°-parametersï¼Œä¼šè¾“å‡ºä¸‹é¢çš„ç»“æœï¼š 1234isNamePresent-&gt;falseisImplicit-&gt;falsegetName-&gt;arg0===================== å°ç»“ è¿™ç¯‡æ–‡ç« å¼€ç¯‡å¯¹åå°„çš„åŸºæœ¬è¿›è¡Œä»‹ç»ï¼Œåé¢èŠ±å¤§é‡ç¯‡å¹…åˆ—ä¸¾äº†ç›¸å…³ç±»åº“çš„APIå’ŒAPIä½¿ç”¨ï¼ŒæŒæ¡è¿™äº›ç±»åº“ï¼Œæ‰èƒ½è½»æ¾åœ°è¿›è¡Œåå°„ç¼–ç¨‹ã€‚ (æœ¬æ–‡å®Œ e-2018122)","categories":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/categories/Java/"},{"name":"Reflection","slug":"Java/Reflection","permalink":"http://throwable.club/blog/categories/Java/Reflection/"}],"tags":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/tags/Java/"},{"name":"Reflection","slug":"Reflection","permalink":"http://throwable.club/blog/tags/Reflection/"}]},{"title":"RabbitMQæ‰©å±•ä¹‹ç›´æ¥å›å¤(Direct reply-to)","slug":"rabbitmq-extension-direct-reply-to","date":"2018-12-01T11:04:46.000Z","updated":"2018-12-01T11:05:19.173Z","comments":true,"path":"2018/12/01/rabbitmq-extension-direct-reply-to/","link":"","permalink":"http://throwable.club/2018/12/01/rabbitmq-extension-direct-reply-to/","excerpt":"","text":"å‰æ æœ¬æ–‡å†…å®¹å‚è€ƒRabbitMQå®˜æ–¹æ–‡æ¡£Direct reply-toã€‚ ç›´æ¥å›å¤ ç›´æ¥å›å¤(Direct reply-to)æ˜¯ä¸€ç§å¯ä»¥é¿å…å£°æ˜å›å¤é˜Ÿåˆ—å¹¶ä¸”å®ç°ç±»ä¼¼äºRPCåŠŸèƒ½çš„ä¸€ç§ç‰¹æ€§ã€‚RabbitMQä¸­å…è®¸ä½¿ç”¨å®¢æˆ·ç«¯å’ŒRabbitMQæ¶ˆæ¯ä»£ç†ä¸­é—´ä»¶å®ç°RPCæ¨¡å¼ï¼Œå…¸å‹çš„åšæ³•æ˜¯ï¼šRPCå®¢æˆ·ç«¯å‘é€è¯·æ±‚(æ¶ˆæ¯)åˆ°ä¸€ä¸ªæŒä¹…åŒ–çš„å·²çŸ¥æœåŠ¡ç«¯é˜Ÿåˆ—ï¼ŒRPCæœåŠ¡ç«¯æ¶ˆè´¹è¯¥æœåŠ¡ç«¯é˜Ÿåˆ—çš„æ¶ˆæ¯ï¼Œç„¶åä½¿ç”¨æ¶ˆæ¯å±æ€§ä¸­çš„reply-toå±æ€§å¯¹åº”çš„å€¼ä½œä¸ºå®¢æˆ·ç«¯å›å¤é˜Ÿåˆ—å‘é€å›å¤æ¶ˆæ¯åˆ°RPCå®¢æˆ·ç«¯ã€‚ å®¢æˆ·ç«¯å›å¤é˜Ÿåˆ—éœ€è¦è€ƒè™‘åˆ›å»ºé—®é¢˜ã€‚å®¢æˆ·ç«¯å¯ä»¥ä¸ºæ¯ä¸ªè¯·æ±‚-å“åº”å£°æ˜ä¸€ä¸ªä¸€æ¬¡æ€§çš„é˜Ÿåˆ—ï¼Œä½†æ˜¯è¿™æ ·çš„åšæ³•æ˜¯ååˆ†ä½æ•ˆçš„ï¼Œå› ä¸ºå³ä½¿æ˜¯éæŒä¹…çŠ¶æ€ä¸‹çš„éé•œåƒé˜Ÿåˆ—ï¼Œå…¶åˆ é™¤çš„ä»£ä»·æ˜¯æ˜‚è´µçš„ï¼Œç‰¹åˆ«æ˜¯åœ¨é›†ç¾¤æ¨¡å¼ä¹‹ä¸‹ã€‚å¦ä¸€ä¸ªå¯é€‰çš„åšæ³•æ˜¯ï¼šå®¢æˆ·ç«¯ä¸ºå›å¤åˆ›å»ºä¸€ä¸ªæŒä¹…åŒ–çš„é•¿æœŸå­˜åœ¨çš„é˜Ÿåˆ—ï¼Œè¿™ç§æƒ…å†µä¸‹é˜Ÿåˆ—çš„ç®¡ç†å¯èƒ½å˜å¾—å¤æ‚ï¼Œå› ä¸ºå®¢æˆ·ç«¯æœ¬èº«å¯èƒ½ä¸æ˜¯é•¿æœŸå­˜åœ¨çš„ã€‚ å®é™…ä¸Šï¼ŒRabbitMQæä¾›äº†ä¸€ä¸ªåŠŸèƒ½ï¼Œå…è®¸RPCå®¢æˆ·ç«¯ç›´æ¥ä»å…¶RPCæœåŠ¡ç«¯æ¥æ”¶å›å¤ï¼Œå¹¶ä¸”æ— éœ€åˆ›å»ºå›å¤é˜Ÿåˆ—ï¼Œä¾èµ–äºRabbitMQçš„æ¶ˆæ¯ä¸­é—´ä»¶çš„åŠŸèƒ½ï¼Œå…·ä½“åšæ³•æ˜¯ï¼š å¯¹äºRPCå®¢æˆ·ç«¯ï¼š RPCå®¢æˆ·ç«¯åˆ›å»ºæ¶ˆè´¹è€…çš„æ—¶å€™é˜Ÿåˆ—æŒ‡å®šä¸ºä¼ªé˜Ÿåˆ—amq.rabbitmq.reply-toï¼Œä½¿ç”¨éæ‰‹åŠ¨ackæ¨¡å¼(autoAck=true)è¿›è¡Œæ¶ˆè´¹ï¼Œä¼ªé˜Ÿåˆ—amq.rabbitmq.reply-toä¸éœ€è¦æ˜¾å¼å£°æ˜ï¼Œå½“ç„¶å¦‚æœéœ€è¦çš„è¯ä¹Ÿå¯ä»¥æ˜¾å¼å£°æ˜ã€‚ å‘å¸ƒæ¶ˆæ¯çš„æ—¶å€™ï¼Œæ¶ˆæ¯å±æ€§ä¸­çš„reply-toå±æ€§éœ€è¦æŒ‡å®šä¸ºamq.rabbitmq.reply-toã€‚ å¯¹äºRPCæœåŠ¡ç«¯ï¼š RPCæœåŠ¡ç«¯æ¥æ”¶æ¶ˆæ¯åæ„ŸçŸ¥æ¶ˆæ¯å±æ€§ä¸­çš„reply-toå±æ€§å­˜åœ¨ï¼Œå®ƒåº”è¯¥é€šè¿‡é»˜è®¤çš„äº¤æ¢å™¨(åç§°ä¸º&quot;&quot;)å’Œreply-toå±æ€§ä½œä¸ºè·¯ç”±é”®å‘é€å›å¤æ¶ˆæ¯ï¼Œé‚£ä¹ˆè¯¥å›å¤æ¶ˆæ¯å°±ä¼šç›´æ¥æŠ•é€’åˆ°RPCå®¢æˆ·ç«¯çš„æ¶ˆè´¹è€…ä¸­ã€‚ å¦‚æœRPCæœåŠ¡ç«¯éœ€è¦è¿›è¡Œä¸€äº›é•¿æ—¶é—´çš„è®¡ç®—é€»è¾‘ï¼Œå¯èƒ½éœ€è¦æ¢æµ‹RPCæœåŠ¡ç«¯æ˜¯å¦å­˜æ´»ï¼Œå¯ä»¥ä½¿ç”¨ä¸€ä¸ªä¸€æ¬¡æ€§ä½¿ç”¨çš„ä¿¡é“å¯¹reply-toå±æ€§åšä¸€æ¬¡é˜Ÿåˆ—å£°æ˜ï¼Œå¦‚æœå£°æ˜æˆåŠŸï¼Œé˜Ÿåˆ—amq.rabbitmq.reply-toå¹¶ä¸ä¼šåˆ›å»ºï¼Œå¦‚æœå£°æ˜å¤±è´¥ï¼Œé‚£ä¹ˆè¯´æ˜å®¢æˆ·ç«¯å·²ç»å¤±å»è¿æ¥ã€‚ æ³¨æ„äº‹é¡¹ï¼š RPCå®¢æˆ·ç«¯åœ¨åˆ›å»ºä¼ªé˜Ÿåˆ—amq.rabbitmq.reply-toæ¶ˆè´¹è€…çš„æ—¶å€™å¿…é¡»ä½¿ç”¨éæ‰‹åŠ¨ackæ¨¡å¼(autoAck=true)ã€‚ ä½¿ç”¨æ­¤æœºåˆ¶å‘é€çš„å›å¤æ¶ˆæ¯é€šå¸¸ä¸å…·æœ‰å®¹é”™èƒ½åŠ›ï¼Œå¦‚æœå‘å¸ƒåŸå§‹è¯·æ±‚çš„å®¢æˆ·ç«¯éšåæ–­å¼€è¿æ¥ï¼Œå®ƒä»¬å°†è¢«ä¸¢å¼ƒã€‚ ä¼ªé˜Ÿåˆ—amq.rabbitmq.reply-toå¯ä»¥åœ¨basic.consumeã€basic.publishå’Œæ¶ˆæ¯å±æ€§reply-toä¸­ä½¿ç”¨ï¼Œå®é™…ä¸Šï¼Œå®ƒå¹¶ä¸æ˜¯ä¸€ä¸ªçœŸå®å­˜åœ¨çš„é˜Ÿåˆ—ï¼ŒRabbitMQçš„Webç®¡ç†å™¨æˆ–è€…rabbitmqctl list_queueså‘½ä»¤éƒ½æ— æ³•å±•ç¤ºè¯¥ä¼ªé˜Ÿåˆ—çš„ç›¸å…³å±æ€§æˆ–è€…ä¿¡æ¯ã€‚ è¯´å®è¯ï¼Œä¸ªäººè®¤ä¸ºè¿™ç§æ–¹å¼æœ‰ä¸ªæ¯”è¾ƒå¤šçš„å±€é™æ€§ï¼š åŒä¸€ä¸ªåº”ç”¨é‡Œé¢ï¼Œåªèƒ½ä½¿ç”¨å”¯ä¸€ä¸€ä¸ªä¼ªé˜Ÿåˆ—amq.rabbitmq.reply-toæ¶ˆè´¹å›å¤æ¶ˆæ¯ï¼Œå¹¶ä¸”RabbitMQçš„Webç®¡ç†å™¨æˆ–è€…rabbitmqctl list_queueså‘½ä»¤éƒ½æ— æ³•å±•ç¤ºè¯¥ä¼ªé˜Ÿåˆ—çš„ç›¸å…³å±æ€§æˆ–è€…ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯æ— æ³•å¯¹å®ƒè¿›è¡Œç›‘æ§æˆ–è€…ç®¡ç†ã€‚ å¯¹äºå¤šåº”ç”¨åŒæ—¶æ¥è¿›å»åŒä¸€ä¸ªRabbitMQæ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†ï¼Œè¿™äº›åº”ç”¨ä¹‹é—´æ— æ³•åŒæ—¶ä½¿ç”¨amq.rabbitmq.reply-toè¿™ä¸ªç‰¹æ€§ï¼Œå› ä¸ºæœ‰å¯èƒ½Aå®¢æˆ·ç«¯å‘é€çš„æ¶ˆæ¯è¢«è¿œç¨‹æœåŠ¡å›è°ƒåˆ°å¦ä¸€ä¸ªä¸åŒçš„Bå®¢æˆ·ç«¯ã€‚ ç›´æ¥å›å¤ç‰¹æ€§ä½¿ç”¨ ä½¿ç”¨ä¼ªé˜Ÿåˆ—amq.rabbitmq.reply-toçš„ä¸€ä¸ªä¾‹å­ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758public class ReplyToRawMain extends BaseChannelFactory &#123; private static final String FAKE_QUEUE = \"amq.rabbitmq.reply-to\"; private static final String RPC_QUEUE = \"rpc.queue\"; private static final String DEFAULT_EXCHANGE = \"\"; public static void main(String[] args) throws Exception &#123; provideChannel(channel -&gt; &#123; // æœåŠ¡ç«¯é˜Ÿåˆ— channel.queueDeclare(RPC_QUEUE, true, false, false, null); client(channel); server(channel); Thread.sleep(5000); &#125;); &#125; private static void client(Channel channel) throws Exception &#123; // å®¢æˆ·ç«¯æ¶ˆè´¹ - no-ack,ä¹Ÿå°±æ˜¯autoAck = true channel.basicConsume(FAKE_QUEUE, true, new DefaultConsumer(channel) &#123; @Override public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException &#123; System.out.println(String.format(\"[X-Client]\\ndeliveryTag:%s\\nexchange:%s\\nroutingKey:%s\\ncorrelationId:%s\\nreplyTo:%s\\ncontent:%s\\n\", envelope.getDeliveryTag(), envelope.getExchange(), envelope.getRoutingKey(), properties.getCorrelationId(), properties.getReplyTo(), new String(body, StandardCharsets.UTF_8))); &#125; &#125;); // å®¢æˆ·ç«¯å‘é€ AMQP.BasicProperties basicProperties = new AMQP.BasicProperties.Builder() .correlationId(\"message-99999\") .replyTo(FAKE_QUEUE) .build(); channel.basicPublish(DEFAULT_EXCHANGE, RPC_QUEUE, basicProperties, \"Reply Message\".getBytes(StandardCharsets.UTF_8)); &#125; private static void server(Channel channel) throws Exception &#123; // æœåŠ¡ç«¯æ¶ˆè´¹ channel.basicConsume(RPC_QUEUE, true, new DefaultConsumer(channel) &#123; @Override public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException &#123; System.out.println(String.format(\"[X-Server]\\ndeliveryTag:%s\\nexchange:%s\\nroutingKey:%s\\ncorrelationId:%s\\nreplyTo:%s\\ncontent:%s\\n\", envelope.getDeliveryTag(), envelope.getExchange(), envelope.getRoutingKey(), properties.getCorrelationId(), properties.getReplyTo(), new String(body, StandardCharsets.UTF_8))); // æœåŠ¡ç«¯åº”ç­”-&gt;å®¢æˆ·ç«¯ AMQP.BasicProperties basicProperties = new AMQP.BasicProperties.Builder() .correlationId(properties.getCorrelationId()) .build(); channel.basicPublish(DEFAULT_EXCHANGE, properties.getReplyTo(), basicProperties, body); &#125; &#125;); &#125;&#125; å½“ç„¶ï¼Œå¯ä»¥ç›´æ¥åˆ›å»ºä¸€ä¸ªçœŸå®çš„ç‹¬å é˜Ÿåˆ—(ç”Ÿå‘½å‘¨æœŸè·Ÿå®¢æˆ·ç«¯çš„è¿æ¥ç»‘å®š)ä½œä¸ºå›å¤é˜Ÿåˆ—ï¼Œä¸¾ä¸ªä¾‹å­ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354public class ReplyToMain extends BaseChannelFactory &#123; public static void main(String[] args) throws Exception &#123; provideChannel(channel -&gt; &#123; // æœåŠ¡ç«¯é˜Ÿåˆ— channel.queueDeclare(\"rpc.queue\", true, false, false, null); // å®¢æˆ·ç«¯æ¥æ”¶åº”ç­”é˜Ÿåˆ— - æ’ä»–é˜Ÿåˆ—,ç”Ÿå‘½å‘¨æœŸå’Œè¿æ¥ç»‘å®š AMQP.Queue.DeclareOk callback = channel.queueDeclare(\"\", false, true, false, null); System.out.println(\"å»ºç«‹æ’ä»–åº”ç­”é˜Ÿåˆ—:\" + callback.getQueue()); // å®¢æˆ·ç«¯æ¶ˆè´¹ channel.basicConsume(callback.getQueue(), false, new DefaultConsumer(channel) &#123; @Override public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException &#123; System.out.println(String.format(\"[X-Client]\\ndeliveryTag:%s\\nroutingKey:%s\\ncorrelationId:%s\\nreplyTo:%s\\ncontent:%s\\n\", envelope.getDeliveryTag(), envelope.getRoutingKey(), properties.getCorrelationId(), properties.getReplyTo(), new String(body, StandardCharsets.UTF_8))); &#125; &#125;); // æœåŠ¡ç«¯æ¶ˆè´¹ channel.basicConsume(\"rpc.queue\", true, new DefaultConsumer(channel) &#123; @Override public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException &#123; System.out.println(String.format(\"[X-Server]\\ndeliveryTag:%s\\nroutingKey:%s\\ncorrelationId:%s\\nreplyTo:%s\\ncontent:%s\\n\", envelope.getDeliveryTag(), envelope.getRoutingKey(), properties.getCorrelationId(), properties.getReplyTo(), new String(body, StandardCharsets.UTF_8))); // æœåŠ¡ç«¯åº”ç­” AMQP.BasicProperties basicProperties = new AMQP.BasicProperties.Builder() .correlationId(properties.getCorrelationId()) .build(); channel.basicPublish(\"\", properties.getReplyTo(), basicProperties, body); &#125; &#125;); // å®¢æˆ·ç«¯å‘é€ AMQP.BasicProperties basicProperties = new AMQP.BasicProperties.Builder() .correlationId(\"message-99999\") .replyTo(callback.getQueue()) .build(); channel.basicPublish(\"\", \"rpc.queue\", basicProperties, \"Reply Message\".getBytes(StandardCharsets.UTF_8)); Thread.sleep(5000); &#125;); &#125;&#125; ä¸ªäººæƒ³æ³• åœ¨å®é™…é¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸è¢«RabbitMQæ¶ˆæ¯å‘é€æ˜¯å¦æˆåŠŸè¿™ä¸ªé—®é¢˜å›°æ‰°ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬è®¤ä¸ºè°ƒç”¨basic.publishåªè¦ä¸æŠ›å‡ºå¼‚å¸¸å°±æ˜¯å‘é€æ¶ˆæ¯æˆåŠŸï¼Œä¾‹å¦‚ä¸€ä¸ªä»£ç æ¨¡æ¿å¦‚ä¸‹ï¼š 123456789101112public boolean sendMessage()&#123; boolean success = false; try &#123; channel.basicPublish(); // å‘é€æˆåŠŸ success = true; &#125;catch (Exception e)&#123; // å‘é€å¤±è´¥ log.error(); &#125; return success;&#125; è¿™ä¸ªä»£ç æ¨¡æ¿åœ¨æå¤§å¤šæ•°æƒ…å†µä¸‹æ˜¯åˆé€‚çš„ï¼Œä½†æ˜¯æœ‰äº›æ—¶å€™æˆ‘ä»¬ç¡®å®éœ€è¦æ¶ˆæ¯çš„æ¥æ”¶æ–¹å‘ŠçŸ¥å‘é€æ–¹å·²ç»æ”¶åˆ°æ¶ˆæ¯ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦ç”¨åˆ°æ¶ˆæ¯çš„å›å¤åŠŸèƒ½ï¼Œä¸ªäººè®¤ä¸ºå¯é€‰çš„æ–¹æ¡ˆæœ‰ï¼š æ¶ˆæ¯å‘å¸ƒæ–¹åŸºäºä¼ªé˜Ÿåˆ—amq.rabbitmq.replyè¿›è¡Œæ¶ˆè´¹ï¼Œæ¶ˆæ¯æ¥æ”¶æ–¹å›å¤åˆ°ä¼ªé˜Ÿåˆ—amq.rabbitmq.replyä¸Šã€‚ æ¶ˆæ¯å‘å¸ƒæ–¹è‡ªå®šä¹‰ç‹¬å é˜Ÿåˆ—è¿›è¡Œæ¶ˆè´¹ï¼Œæ¶ˆæ¯æ¥æ”¶æ–¹å›å¤åˆ°æ­¤ç‹¬å é˜Ÿåˆ—ã€‚ æ¶ˆæ¯å‘å¸ƒæ–¹è‡ªå®šä¹‰æŒä¹…åŒ–é˜Ÿåˆ—è¿›è¡Œæ¶ˆè´¹ï¼Œæ¶ˆæ¯æ¥æ”¶æ–¹å›å¤åˆ°æ­¤æŒä¹…åŒ–é˜Ÿåˆ—ã€‚ å…¶å®ï¼Œåœ¨AMQP.BasicPropertiesçš„replyToå±æ€§ä¸­æŒ‡å®šéœ€è¦å›å¤çš„é˜Ÿåˆ—ååªæ˜¯RabbitMQæå‡ºçš„ä¸€ç§è§„çº¦æˆ–è€…å»ºè®®ï¼Œå¹¶ä¸æ˜¯å¼ºåˆ¶å®è¡Œçš„æ–¹æ¡ˆï¼Œå®é™…ä¸Šå¯ä»¥è‡ªè¡Œé€‰æ‹©å›å¤é˜Ÿåˆ—æˆ–è€…å¿½ç•¥replyToå±æ€§ã€‚","categories":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/categories/Middleware/"},{"name":"RabbitMQ","slug":"Middleware/RabbitMQ","permalink":"http://throwable.club/blog/categories/Middleware/RabbitMQ/"}],"tags":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/tags/Middleware/"},{"name":"RabbitMQ","slug":"RabbitMQ","permalink":"http://throwable.club/blog/tags/RabbitMQ/"}]},{"title":"æµ…æJDKä¸­ServiceLoaderçš„æºç ","slug":"java-service-loader","date":"2018-11-29T16:39:32.000Z","updated":"2018-11-29T16:41:40.973Z","comments":true,"path":"2018/11/30/java-service-loader/","link":"","permalink":"http://throwable.club/2018/11/30/java-service-loader/","excerpt":"","text":"å‰æ ç´§æ¥ç€ä¸Šä¸€ç¯‡ã€Šé€šè¿‡æºç æµ…æJDKä¸­çš„èµ„æºåŠ è½½ã€‹ï¼ŒServiceLoaderæ˜¯SPI(Service Provider Interface)ä¸­çš„æœåŠ¡ç±»åŠ è½½çš„æ ¸å¿ƒç±»ï¼Œä¹Ÿå°±æ˜¯ï¼Œè¿™ç¯‡æ–‡ç« å…ˆä»‹ç»ServiceLoaderçš„ä½¿ç”¨æ–¹å¼ï¼Œå†åˆ†æå®ƒçš„æºç ã€‚ ServiceLoaderçš„ä½¿ç”¨ è¿™é‡Œå…ˆåˆ—ä¸¾ä¸€ä¸ªç»å…¸çš„ä¾‹å­ï¼ŒMySQLçš„Javaé©±åŠ¨å°±æ˜¯é€šè¿‡ServiceLoaderåŠ è½½çš„ï¼Œå…ˆå¼•å…¥mysql-connector-javaçš„ä¾èµ–ï¼š 12345&lt;dependency&gt; &lt;groupId&gt;mysql&lt;/groupId&gt; &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt; &lt;version&gt;5.1.47&lt;/version&gt;&lt;/dependency&gt; æŸ¥çœ‹è¿™ä¸ªä¾èµ–çš„æºç åŒ…ä¸‹çš„META-INFç›®å½•ï¼Œå¯è§ï¼š æˆ‘ä»¬æ¥ç€æŸ¥çœ‹java.lang.DriverManagerï¼Œé™æ€ä»£ç å—é‡Œé¢æœ‰ï¼š 1234static &#123; loadInitialDrivers(); println(\"JDBC DriverManager initialized\");&#125; å…¶ä¸­ï¼Œå¯ä»¥æŸ¥çœ‹loadInitialDrivers()æœ‰å¦‚ä¸‹çš„ä»£ç ç‰‡æ®µï¼š java.lang.DriverManageræ˜¯å¯åŠ¨ç±»åŠ è½½å™¨åŠ è½½çš„åŸºç¡€ç±»ï¼Œä½†æ˜¯å®ƒå¯ä»¥åŠ è½½rt.jaråŒ…ä¹‹å¤–çš„ç±»ï¼Œä¸Šç¯‡æ–‡ç« æåˆ°ï¼Œè¿™é‡Œæ‰“ç ´äº†åŒäº²å§”æ´¾æ¨¡å‹ï¼ŒåŸå› æ˜¯ï¼šServiceLoaderä¸­ä½¿ç”¨äº†çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨å»åŠ è½½ç±»ã€‚è¿™é‡ŒJDBCåŠ è½½çš„è¿‡ç¨‹å°±æ˜¯å…¸å‹çš„SPIçš„ä½¿ç”¨ï¼Œæ€»ç»“è§„å¾‹å¦‚ä¸‹ï¼š 1ã€éœ€è¦å®šä¹‰ä¸€ä¸ªæ¥å£ã€‚ 2ã€æ¥å£æä¾›å•†éœ€è¦å®ç°ç¬¬1æ­¥ä¸­çš„æ¥å£ã€‚ 3ã€æ¥å£æä¾›å•†åœ¨META-INF/servicesç›®å½•ä¸‹å»ºç«‹ä¸€ä¸ªæ–‡æœ¬æ–‡ä»¶ï¼Œæ–‡ä»¶åæ˜¯ç¬¬1æ­¥ä¸­å®šä¹‰çš„æ¥å£çš„å…¨é™å®šç±»åï¼Œæ–‡æœ¬å†…å®¹æ˜¯æ¥å£çš„å®ç°ç±»çš„å…¨é™å®šç±»åï¼Œæ¯ä¸ªä¸åŒçš„å®ç°å ç‹¬ç«‹çš„ä¸€è¡Œã€‚ 4ã€ä½¿ç”¨ServiceLoaderåŠ è½½æ¥å£ç±»ï¼Œè·å–æ¥å£çš„å®ç°çš„å®ä¾‹è¿­ä»£å™¨ã€‚ ä¸¾ä¸ªç®€å•çš„å®ä¾‹ï¼Œå…ˆå®šä¹‰ä¸€ä¸ªæ¥å£å’Œä¸¤ä¸ªå®ç°ï¼š 1234567891011121314151617181920public interface Say &#123; void say();&#125;public class SayBye implements Say &#123; @Override public void say() &#123; System.out.println(\"Bye!\"); &#125;&#125;public class SayHello implements Say &#123; @Override public void say() &#123; System.out.println(\"Hello!\"); &#125;&#125; æ¥ç€åœ¨é¡¹ç›®çš„META-INF/servicesä¸­æ·»åŠ æ–‡ä»¶å¦‚ä¸‹ï¼š æœ€åé€šè¿‡mainå‡½æ•°éªŒè¯ï¼š åŸºäºSPIæˆ–è€…è¯´ServiceLoaderåŠ è½½æ¥å£å®ç°è¿™ç§æ–¹å¼ä¹Ÿå¯ä»¥å¹¿æ³›ä½¿ç”¨åœ¨ç›¸å¯¹åŸºç¡€çš„ç»„ä»¶ä¸­ï¼Œå› ä¸ºè¿™æ˜¯ä¸€ä¸ªæˆç†Ÿçš„è§„èŒƒã€‚ ServiceLoaderæºç åˆ†æ ä¸Šé¢é€šè¿‡ä¸€ä¸ªç»å…¸ä¾‹å­å’Œä¸€ä¸ªå®ä¾‹ä»‹ç»äº†ServiceLoaderçš„ä½¿ç”¨æ–¹å¼ï¼Œæ¥ç€æˆ‘ä»¬æ·±å…¥åˆ†æServiceLoaderçš„æºç ã€‚æˆ‘ä»¬å…ˆçœ‹ServiceLoaderçš„ç±»ç­¾åå’Œå±æ€§å®šä¹‰ï¼š 123456789101112131415161718192021public final class ServiceLoader&lt;S&gt; implements Iterable&lt;S&gt;&#123; //éœ€è¦åŠ è½½çš„èµ„æºçš„è·¯å¾„çš„ç›®å½•ï¼Œå›ºå®šæ˜¯ClassPathä¸‹çš„META-INF/services/ private static final String PREFIX = \"META-INF/services/\"; // ServiceLoaderéœ€è¦æ­£åœ¨éœ€è¦åŠ è½½çš„ç±»æˆ–è€…æ¥å£ // The class or interface representing the service being loaded private final Class&lt;S&gt; service; // ServiceLoaderè¿›è¡Œç±»åŠ è½½çš„æ—¶å€™ä½¿ç”¨çš„ç±»åŠ è½½å™¨å¼•ç”¨ // The class loader used to locate, load, and instantiate providers private final ClassLoader loader; // æƒé™æ§åˆ¶ä¸Šä¸‹æ–‡ // The access control context taken when the ServiceLoader is created private final AccessControlContext acc; //åŸºäºå®ä¾‹çš„é¡ºåºç¼“å­˜ç±»çš„å®ç°å®ä¾‹ï¼Œå…¶ä¸­Keyä¸ºå®ç°ç±»çš„å…¨é™å®šç±»å // Cached providers, in instantiation order private LinkedHashMap&lt;String,S&gt; providers = new LinkedHashMap&lt;&gt;(); // å½“å‰çš„\"æ‡’æŸ¥æ‰¾\"è¿­ä»£å™¨ï¼Œè¿™ä¸ªæ˜¯ServiceLoaderçš„æ ¸å¿ƒ // The current lazy-lookup iterator private LazyIterator lookupIterator; //æš‚æ—¶å¿½ç•¥å…¶ä»–ä»£ç ...&#125; ServiceLoaderå®ç°äº†Iterableæ¥å£ï¼Œè¿™ä¸€ç‚¹æç¤ºäº†ç­‰ä¸‹æˆ‘ä»¬åœ¨åˆ†æå®ƒæºç çš„æ—¶å€™ï¼Œéœ€è¦é‡ç‚¹åˆ†æiterator()æ–¹æ³•çš„å®ç°ã€‚ServiceLoaderä¾èµ–äºç±»åŠ è½½å™¨å®ä¾‹è¿›è¡Œç±»åŠ è½½ï¼Œå®ƒçš„æ ¸å¿ƒå±æ€§LazyIteratoræ˜¯å°±æ˜¯ç”¨æ¥å®ç°iterator()æ–¹æ³•çš„ï¼Œä¸‹æ–‡å†é‡ç‚¹åˆ†æã€‚æ¥ç€ï¼Œæˆ‘ä»¬åˆ†æServiceLoaderçš„æ„é€ å‡½æ•°ï¼š 12345678910111213public void reload() &#123; //æ¸…ç©ºç¼“å­˜ providers.clear(); //æ„é€ LazyIteratorå®ä¾‹ lookupIterator = new LazyIterator(service, loader);&#125;private ServiceLoader(Class&lt;S&gt; svc, ClassLoader cl) &#123; service = Objects.requireNonNull(svc, \"Service interface cannot be null\"); loader = (cl == null) ? ClassLoader.getSystemClassLoader() : cl; acc = (System.getSecurityManager() != null) ? AccessController.getContext() : null; reload();&#125; ServiceLoaderåªæœ‰ä¸€ä¸ªç§æœ‰çš„æ„é€ å‡½æ•°ï¼Œä¹Ÿå°±æ˜¯å®ƒä¸èƒ½é€šè¿‡æ„é€ å‡½æ•°å®ä¾‹åŒ–ï¼Œä½†æ˜¯è¦å®ä¾‹åŒ–ServiceLoaderå¿…é¡»ä¾èµ–äºå®ƒçš„é™æ€æ–¹æ³•è°ƒç”¨ç§æœ‰æ„é€ å»å®Œæˆå®ä¾‹åŒ–æ“ä½œï¼Œè€Œå®ä¾‹åŒ–è¿‡ç¨‹ä¸»è¦åšäº†å‡ æ­¥ï¼š 1ã€åˆ¤æ–­ä¼ å…¥çš„æ¥å£æˆ–è€…ç±»çš„Classå®ä¾‹ä¸èƒ½ä¸ºnullï¼Œå¦åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ 2ã€å¦‚æœä¼ å…¥çš„ClassLoaderå®ä¾‹ä¸ºnullï¼Œåˆ™ä½¿ç”¨åº”ç”¨ç±»åŠ è½½å™¨(Application ClassLoader)ã€‚ 3ã€å®ä¾‹åŒ–è®¿é—®æ§åˆ¶ä¸Šä¸‹æ–‡ã€‚ 4ã€è°ƒç”¨å®ä¾‹æ–¹æ³•reload()ï¼Œæ¸…ç©ºç›®æ ‡åŠ è½½ç±»çš„å®ç°ç±»å®ä¾‹çš„ç¼“å­˜å¹¶ä¸”æ„é€ LazyIteratorå®ä¾‹ã€‚ æ³¨æ„ä¸€ç‚¹æ˜¯å®ä¾‹æ–¹æ³•reload()çš„ä¿®é¥°ç¬¦æ˜¯publicï¼Œä¹Ÿå°±æ˜¯å¯ä»¥ä¸»åŠ¨è°ƒç”¨å»æ¸…ç©ºç›®æ ‡åŠ è½½ç±»çš„å®ç°ç±»å®ä¾‹çš„ç¼“å­˜å’Œé‡æ–°æ„é€ LazyIteratorå®ä¾‹ã€‚æ¥ç€çœ‹ServiceLoaderæä¾›çš„é™æ€æ–¹æ³•ï¼š 123456789101112131415161718public static &lt;S&gt; ServiceLoader&lt;S&gt; load(Class&lt;S&gt; service, ClassLoader loader)&#123; return new ServiceLoader&lt;&gt;(service, loader);&#125;public static &lt;S&gt; ServiceLoader&lt;S&gt; load(Class&lt;S&gt; service) &#123; ClassLoader cl = Thread.currentThread().getContextClassLoader(); return ServiceLoader.load(service, cl);&#125;public static &lt;S&gt; ServiceLoader&lt;S&gt; loadInstalled(Class&lt;S&gt; service) &#123; ClassLoader cl = ClassLoader.getSystemClassLoader(); ClassLoader prev = null; while (cl != null) &#123; prev = cl; cl = cl.getParent(); &#125; return ServiceLoader.load(service, prev);&#125; ä¸Šé¢çš„ä¸‰ä¸ªå…¬å…±é™æ€æ–¹æ³•éƒ½æ˜¯ç”¨äºæ„é€ ServiceLoaderå®ä¾‹ï¼Œå…¶ä¸­load(Class&lt;S&gt; service, ClassLoader loader)å°±æ˜¯å…¸å‹çš„é™æ€å·¥å‚æ–¹æ³•ï¼Œç›´æ¥è°ƒç”¨ServiceLoaderçš„ç§æœ‰æ„é€ å™¨è¿›è¡Œå®ä¾‹åŒ–ï¼Œé™¤äº†éœ€è¦æŒ‡å®šåŠ è½½ç±»çš„ç›®æ ‡ç±»å‹ï¼Œè¿˜éœ€è¦ä¼ å…¥ç±»åŠ è½½å™¨çš„å®ä¾‹ã€‚load(Class&lt;S&gt; service)å®é™…ä¸Šä¹Ÿæ˜¯å§”æ‰˜åˆ°load(Class&lt;S&gt; service, ClassLoader loader)ï¼Œä¸è¿‡å®ƒä½¿ç”¨çš„ç±»åŠ è½½å™¨æŒ‡å®šä¸ºçº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œçº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨è·å–åˆ°çš„å°±æ˜¯åº”ç”¨ç±»åŠ è½½å™¨(ç³»ç»Ÿç±»åŠ è½½å™¨)ã€‚loadInstalled(Class&lt;S&gt; service)æ–¹æ³•åˆçœ‹å‡ºäº†&quot;åŒäº²å§”æ´¾æ¨¡å‹&quot;çš„å½±å­ï¼Œå®ƒæŒ‡å®šç±»åŠ è½½å™¨ä¸ºæœ€é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨ï¼Œæœ€åä¹Ÿæ˜¯å§”æ‰˜åˆ°load(Class&lt;S&gt; service, ClassLoader loader)ã€‚æ¥ç€æˆ‘ä»¬éœ€è¦é‡ç‚¹åˆ†æServiceLoader#iterator()ï¼š 1234567891011121314151617181920212223242526272829public Iterator&lt;S&gt; iterator() &#123; //Iteratorçš„åŒ¿åå®ç° return new Iterator&lt;S&gt;() &#123; //ç›®æ ‡ç±»å®ç°ç±»å®ä¾‹ç¼“å­˜çš„Mapçš„Entryçš„è¿­ä»£å™¨å®ä¾‹ Iterator&lt;Map.Entry&lt;String,S&gt;&gt; knownProviders = providers.entrySet().iterator(); //å…ˆä»ç¼“å­˜ä¸­åˆ¤æ–­æ˜¯å¦æœ‰ä¸‹ä¸€ä¸ªå®ä¾‹ï¼Œå¦åˆ™é€šè¿‡æ‡’åŠ è½½è¿­ä»£å™¨LazyIteratorå»åˆ¤æ–­æ˜¯å¦å­˜åœ¨ä¸‹ä¸€ä¸ªå®ä¾‹ public boolean hasNext() &#123; if (knownProviders.hasNext()) return true; return lookupIterator.hasNext(); &#125; //å¦‚æœç¼“å­˜ä¸­åˆ¤æ–­æ˜¯å¦æœ‰ä¸‹ä¸€ä¸ªå®ä¾‹ï¼Œå¦‚æœæœ‰åˆ™ä»ç¼“å­˜ä¸­çš„å€¼ç›´æ¥è¿”å› //å¦åˆ™é€šè¿‡æ‡’åŠ è½½è¿­ä»£å™¨LazyIteratorè·å–ä¸‹ä¸€ä¸ªå®ä¾‹ public S next() &#123; if (knownProviders.hasNext()) return knownProviders.next().getValue(); return lookupIterator.next(); &#125; //ä¸æ”¯æŒç§»é™¤æ“ä½œï¼Œç›´æ¥æŠ›å¼‚å¸¸ public void remove() &#123; throw new UnsupportedOperationException(); &#125; &#125;;&#125; iterator()å†…éƒ¨ä»…ä»…æ˜¯Iteratoræ¥å£çš„åŒ¿åå®ç°ï¼ŒhasNext()å’Œnext()æ–¹æ³•éƒ½æ˜¯ä¼˜å…ˆåˆ¤æ–­ç¼“å­˜ä¸­æ˜¯å¦å·²ç»å­˜åœ¨å®ç°ç±»çš„å®ä¾‹ï¼Œå¦‚æœå­˜åœ¨åˆ™ç›´æ¥ä»ç¼“å­˜ä¸­è¿”å›ï¼Œå¦åˆ™è°ƒç”¨æ‡’åŠ è½½è¿­ä»£å™¨LazyIteratorçš„å®ä¾‹å»è·å–ï¼Œè€ŒLazyIteratoræœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªIteratoræ¥å£çš„å®ç°ï¼Œå®ƒæ˜¯ServiceLoaderçš„ä¸€ä¸ªç§æœ‰å†…éƒ¨ç±»ï¼Œæºç å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108private class LazyIteratorimplements Iterator&lt;S&gt;&#123; Class&lt;S&gt; service; ClassLoader loader; //åŠ è½½çš„èµ„æºçš„URLé›†åˆ Enumeration&lt;URL&gt; configs = null; //æ‰€æœ‰éœ€è¦åŠ è½½çš„å®ç°ç±»çš„å…¨é™å®šç±»åçš„é›†åˆ Iterator&lt;String&gt; pending = null; //ä¸‹ä¸€ä¸ªéœ€è¦åŠ è½½çš„å®ç°ç±»çš„å…¨é™å®šç±»å String nextName = null; private LazyIterator(Class&lt;S&gt; service, ClassLoader loader) &#123; this.service = service; this.loader = loader; &#125; private boolean hasNextService() &#123; //å¦‚æœä¸‹ä¸€ä¸ªéœ€è¦åŠ è½½çš„å®ç°ç±»çš„å…¨é™å®šç±»åä¸ä¸ºnullï¼Œåˆ™è¯´æ˜èµ„æºä¸­å­˜åœ¨å†…å®¹ if (nextName != null) &#123; return true; &#125; //å¦‚æœåŠ è½½çš„èµ„æºçš„URLé›†åˆä¸ºnullåˆ™å°è¯•è¿›è¡ŒåŠ è½½ if (configs == null) &#123; try &#123; //èµ„æºçš„åç§°ï¼ŒMETA-INF/services + 'éœ€è¦åŠ è½½çš„ç±»çš„å…¨é™å®šç±»å' //è¿™æ ·å¾—åˆ°çš„åˆšå¥½æ˜¯éœ€è¦åŠ è½½çš„æ–‡ä»¶çš„èµ„æºåç§° String fullName = PREFIX + service.getName(); //è¿™é‡Œå…¶å®ClassLoaderå®ä¾‹åº”è¯¥ä¸ä¼šä¸ºnull if (loader == null) configs = ClassLoader.getSystemResources(fullName); else //ä»ClassPathåŠ è½½èµ„æº configs = loader.getResources(fullName); &#125; catch (IOException x) &#123; fail(service, \"Error locating configuration files\", x); &#125; &#125; //ä»èµ„æºä¸­è§£æå‡ºéœ€è¦åŠ è½½çš„æ‰€æœ‰å®ç°ç±»çš„å…¨é™å®šç±»å while ((pending == null) || !pending.hasNext()) &#123; if (!configs.hasMoreElements()) &#123; return false; &#125; pending = parse(service, configs.nextElement()); &#125; //è·å–ä¸‹ä¸€ä¸ªéœ€è¦åŠ è½½çš„å®ç°ç±»çš„å…¨é™å®šç±»å nextName = pending.next(); return true; &#125; private S nextService() &#123; if (!hasNextService()) throw new NoSuchElementException(); String cn = nextName; nextName = null; Class&lt;?&gt; c = null; try &#123; //åå°„æ„é€ Class&lt;S&gt;å®ä¾‹ c = Class.forName(cn, false, loader); &#125; catch (ClassNotFoundException x) &#123; fail(service, \"Provider \" + cn + \" not found\"); &#125; //è¿™é‡Œä¼šåšä¸€æ¬¡ç±»å‹åˆ¤æ–­ï¼Œä¹Ÿå°±æ˜¯å®ç°ç±»å¿…é¡»æ˜¯å½“å‰åŠ è½½çš„ç±»æˆ–è€…æ¥å£çš„æ´¾ç”Ÿç±»ï¼Œå¦åˆ™æŠ›å‡ºå¼‚å¸¸ç»ˆæ­¢ if (!service.isAssignableFrom(c)) &#123; fail(service, \"Provider \" + cn + \" not a subtype\"); &#125; try &#123; //é€šè¿‡Class#newInstance()è¿›è¡Œå®ä¾‹åŒ–ï¼Œå¹¶ä¸”å¼ºåˆ¶è½¬åŒ–ä¸ºå¯¹åº”çš„ç±»å‹çš„å®ä¾‹ S p = service.cast(c.newInstance()); //æ·»åŠ ç¼“å­˜ï¼ŒKeyä¸ºå®ç°ç±»çš„å…¨é™å®šç±»åï¼ŒValueä¸ºå®ç°ç±»çš„å®ä¾‹ providers.put(cn, p); return p; &#125; catch (Throwable x) &#123; fail(service, \"Provider \" + cn + \" could not be instantiated\", x); &#125; throw new Error(); // This cannot happen &#125; public boolean hasNext() &#123; if (acc == null) &#123; return hasNextService(); &#125; else &#123; PrivilegedAction&lt;Boolean&gt; action = new PrivilegedAction&lt;Boolean&gt;() &#123; public Boolean run() &#123; return hasNextService(); &#125; &#125;; return AccessController.doPrivileged(action, acc); &#125; &#125; public S next() &#123; if (acc == null) &#123; return nextService(); &#125; else &#123; PrivilegedAction&lt;S&gt; action = new PrivilegedAction&lt;S&gt;() &#123; public S run() &#123; return nextService(); &#125; &#125;; return AccessController.doPrivileged(action, acc); &#125; &#125; public void remove() &#123; throw new UnsupportedOperationException(); &#125; &#125; LazyIteratorä¹Ÿæ˜¯Iteratoræ¥å£çš„å®ç°ï¼Œå®ƒçš„Lazyç‰¹æ€§è¡¨æ˜å®ƒæ€»æ˜¯åœ¨ServiceLoaderçš„Iteratoræ¥å£åŒ¿åå®ç°iterator()æ‰§è¡ŒhasNext()åˆ¤æ–­æ˜¯å¦æœ‰ä¸‹ä¸€ä¸ªå®ç°æˆ–è€…next()è·å–ä¸‹ä¸€ä¸ªå®ç°ç±»çš„å®ä¾‹çš„æ—¶å€™æ‰ä¼š&quot;æ‡’åˆ¤æ–­&quot;æˆ–è€…&quot;æ‡’åŠ è½½&quot;ä¸‹ä¸€ä¸ªå®ç°ç±»çš„å®ä¾‹ã€‚æœ€åæ˜¯åŠ è½½èµ„æºæ–‡ä»¶åå¯¹èµ„æºæ–‡ä»¶çš„è§£æè¿‡ç¨‹çš„æºç ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657private Iterator&lt;String&gt; parse(Class&lt;?&gt; service, URL u) throws ServiceConfigurationError&#123; InputStream in = null; BufferedReader r = null; //å­˜æ”¾æ–‡ä»¶ä¸­æ‰€æœ‰çš„å®ç°ç±»çš„å…¨ç±»åï¼Œæ¯ä¸€è¡Œæ˜¯ä¸€ä¸ªå…ƒç´  ArrayList&lt;String&gt; names = new ArrayList&lt;&gt;(); try &#123; in = u.openStream(); r = new BufferedReader(new InputStreamReader(in, \"utf-8\")); int lc = 1; while ((lc = parseLine(service, u, r, lc, names)) &gt;= 0); &#125; catch (IOException x) &#123; fail(service, \"Error reading configuration file\", x); &#125; finally &#123; try &#123; if (r != null) r.close(); if (in != null) in.close(); &#125; catch (IOException y) &#123; fail(service, \"Error closing configuration file\", y); &#125; &#125; //è¿”å›çš„æ˜¯ArrayListçš„è¿­ä»£å™¨å®ä¾‹ return names.iterator();&#125;//è§£æèµ„æºæ–‡ä»¶ä¸­æ¯ä¸€è¡Œçš„å†…å®¹private int parseLine(Class&lt;?&gt; service, URL u, BufferedReader r, int lc, List&lt;String&gt; names)throws IOException, ServiceConfigurationError&#123; // ä¸‹ä¸€è¡Œæ²¡æœ‰å†…å®¹ï¼Œè¿”å›-1ï¼Œä¾¿äºä¸Šå±‚å¯ä»¥è·³å‡ºå¾ªç¯ String ln = r.readLine(); if (ln == null) &#123; return -1; &#125; //å¦‚æœå­˜åœ¨'#'å­—ç¬¦ï¼Œæˆªå–ç¬¬ä¸€ä¸ª'#'å­—ç¬¦ä¸²ä¹‹å‰çš„å†…å®¹ï¼Œ'#'å­—ç¬¦ä¹‹åçš„å±äºæ³¨é‡Šå†…å®¹ int ci = ln.indexOf('#'); if (ci &gt;= 0) ln = ln.substring(0, ci); ln = ln.trim(); int n = ln.length(); if (n != 0) &#123; //ä¸èƒ½å­˜åœ¨ç©ºæ ¼å­—ç¬¦' 'å’Œç‰¹æ®Šå­—ç¬¦'\\t' if ((ln.indexOf(' ') &gt;= 0) || (ln.indexOf('\\t') &gt;= 0)) fail(service, u, lc, \"Illegal configuration-file syntax\"); int cp = ln.codePointAt(0); //åˆ¤æ–­ç¬¬ä¸€ä¸ªcharæ˜¯å¦ä¸€ä¸ªåˆæ³•çš„Javaèµ·å§‹æ ‡è¯†ç¬¦ if (!Character.isJavaIdentifierStart(cp)) fail(service, u, lc, \"Illegal provider-class name: \" + ln); //åˆ¤æ–­æ‰€æœ‰å…¶ä»–å­—ç¬¦ä¸²æ˜¯å¦å±äºåˆæ³•çš„Javaæ ‡è¯†ç¬¦ for (int i = Character.charCount(cp); i &lt; n; i += Character.charCount(cp)) &#123; cp = ln.codePointAt(i); if (!Character.isJavaIdentifierPart(cp) &amp;&amp; (cp != '.')) fail(service, u, lc, \"Illegal provider-class name: \" + ln); &#125; //å¦‚æœç¼“å­˜ä¸­ä¸å­˜åœ¨åŠ è½½å‡ºæ¥çš„å…¨ç±»åæˆ–è€…å·²ç»åŠ è½½çš„åˆ—è¡¨ä¸­ä¸å­˜åœ¨åŠ è½½å‡ºæ¥çš„å…¨ç±»ååˆ™æ·»åŠ è¿›å»åŠ è½½çš„å…¨ç±»ååˆ—è¡¨ä¸­ if (!providers.containsKey(ln) &amp;&amp; !names.contains(ln)) names.add(ln); &#125; return lc + 1; &#125; æ•´ä¸ªèµ„æºæ–‡ä»¶çš„è§£æè¿‡ç¨‹å¹¶ä¸å¤æ‚ï¼Œä¸»è¦åŒ…æ‹¬æ–‡ä»¶å†…å®¹çš„å­—ç¬¦åˆæ³•æ€§åˆ¤æ–­å’Œç¼“å­˜é¿å…é‡å¤åŠ è½½çš„åˆ¤æ–­ã€‚ å°ç»“ SPIè¢«å¹¿æ³›ä½¿ç”¨åœ¨ç¬¬ä¸‰æ–¹æ’ä»¶å¼ç±»åº“çš„åŠ è½½ï¼Œæœ€å¸¸è§çš„å¦‚JDBCã€JNDIã€JCE(JavaåŠ å¯†æ¨¡å—æ‰©å±•)ç­‰ç±»åº“ã€‚ç†è§£ServiceLoaderçš„å·¥ä½œåŸç†æœ‰åŠ©äºç¼–å†™æ‰©å±•æ€§è‰¯å¥½çš„å¯æ’æ‹”çš„ç±»åº“ã€‚ (æœ¬æ–‡å®Œ c-1-d e-20181014)","categories":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/tags/Java/"}]},{"title":"é€šè¿‡æºç æµ…æJavaä¸­çš„èµ„æºåŠ è½½","slug":"java-resource-load","date":"2018-11-29T16:37:41.000Z","updated":"2018-12-02T02:20:27.998Z","comments":true,"path":"2018/11/30/java-resource-load/","link":"","permalink":"http://throwable.club/2018/11/30/java-resource-load/","excerpt":"","text":"å‰æ æœ€è¿‘åœ¨åšä¸€ä¸ªåŸºç¡€ç»„ä»¶é¡¹ç›®åˆšå¥½éœ€è¦ç”¨åˆ°JDKä¸­çš„èµ„æºåŠ è½½ï¼Œè¿™é‡Œè¯´åˆ°çš„èµ„æºåŒ…æ‹¬ç±»æ–‡ä»¶å’Œå…¶ä»–é™æ€èµ„æºï¼Œåˆšå¥½éœ€è¦é‡æ–°è¡¥å……ä¸€ä¸‹ç±»åŠ è½½å™¨å’Œèµ„æºåŠ è½½çš„ç›¸å…³çŸ¥è¯†ï¼Œæ•´ç†æˆä¸€ç¯‡æ–‡ç« ã€‚ ä»€ä¹ˆæ˜¯ç±»åŠ è½½å™¨ è™šæ‹Ÿæœºè®¾è®¡å›¢é˜ŸæŠŠç±»åŠ è½½é˜¶æ®µä¸­çš„&quot;é€šè¿‡ä¸€ä¸ªç±»çš„å…¨é™å®šåæ¥è·å–æè¿°æ­¤ç±»çš„äºŒè¿›åˆ¶å­—èŠ‚æµ&quot;è¿™ä¸ªåŠ¨ä½œæ”¾åˆ°äº†Javaè™šæ‹Ÿæœºå¤–éƒ¨å®ç°ï¼Œä»¥ä¾¿è®©åº”ç”¨ç¨‹åºè‡ªå·±å†³å®šå¦‚ä½•å»è·å–æ‰€éœ€è¦çš„ç±»ï¼Œè€Œå®ç°è¿™ä¸ªåŠ¨ä½œçš„ä»£ç æ¨¡å—ç§°ä¸º&quot;ç±»åŠ è½½å™¨(ClassLoader)&quot;ã€‚ ç±»åŠ è½½å™¨è™½ç„¶åªç”¨äºå®ç°ç±»åŠ è½½çš„åŠŸèƒ½ï¼Œä½†æ˜¯å®ƒåœ¨Javaç¨‹åºä¸­èµ·åˆ°çš„ä½œç”¨ä¸å±€é™äºç±»åŠ è½½é˜¶æ®µã€‚å¯¹äºä»»æ„ä¸€ä¸ªç±»ï¼Œéƒ½éœ€è¦ç”±åŠ è½½å®ƒçš„ç±»åŠ è½½å™¨å’Œè¿™ä¸ªç±»æœ¬èº«ä¸€åŒç¡®ç«‹ç±»åœ¨Javaè™šæ‹Ÿæœºä¸­çš„å”¯ä¸€æ€§ï¼Œæ¯ä¸€ä¸ªç±»åŠ è½½å™¨ï¼Œéƒ½æ‹¥æœ‰ä¸€ä¸ªç‹¬ç«‹çš„ç±»å‘½åç©ºé—´ã€‚ä¸Šé¢è¿™å¥è¯ç›´è§‚æ¥è¯´å°±æ˜¯ï¼šæ¯”è¾ƒä¸¤ä¸ªç±»æ˜¯å¦&quot;ç›¸ç­‰&quot;ï¼Œåªæœ‰åœ¨è¿™ä¸¤ä¸ªç±»æ˜¯ç”±åŒä¸€ä¸ªç±»åŠ è½½å™¨åŠ è½½çš„å‰æä¸‹æ‰æœ‰æ„ä¹‰ï¼Œå¦åˆ™ï¼Œå³ä½¿è¿™ä¸ªä¸¤ä¸ªç±»æ˜¯æ¥æºäºåŒä¸€ä¸ªClassæ–‡ä»¶ï¼Œè¢«åŒä¸€ä¸ªè™šæ‹ŸæœºåŠ è½½ï¼Œåªè¦åŠ è½½å®ƒä»¬çš„ç±»åŠ è½½å™¨ä¸åŒï¼Œé‚£ä¹ˆè¿™ä¸¤ä¸ªç±»å¿…ç„¶&quot;ä¸ç›¸ç­‰&quot;ã€‚è¿™é‡Œè¯´åˆ°çš„&quot;ç›¸ç­‰&quot;åŒ…æ‹¬ä»£è¡¨ç±»çš„Classå¯¹è±¡çš„equals()æ–¹æ³•ã€isAssignableFrom()æ–¹æ³•ã€isInstance()æ–¹æ³•çš„è¿”å›ç»“æœï¼Œä¹ŸåŒ…æ‹¬ä½¿ç”¨instanceOfå…³é”®å­—åšå¯¹è±¡æ‰€å±å…³ç³»åˆ¤å®šç­‰æƒ…å†µã€‚ ç±»å’ŒåŠ è½½å®ƒçš„ç±»åŠ è½½å™¨ç¡®å®šç±»åœ¨Javaè™šæ‹Ÿæœºä¸­çš„å”¯ä¸€æ€§è¿™ä¸ªç‰¹ç‚¹ä¸ºåæ¥å‡ºç°çš„çƒ­æ›´æ–°ç±»ã€çƒ­éƒ¨ç½²ç­‰æŠ€æœ¯æä¾›äº†åŸºç¡€ã€‚ åŒäº²å§”æ´¾æ¨¡å‹ ä»Javaè™šæ‹Ÿæœºçš„è§’åº¦æ¥çœ‹ï¼Œåªæœ‰ä¸¤ç§ä¸åŒçš„ç±»åŠ è½½å™¨ï¼š 1ã€ç¬¬ä¸€ç§æ˜¯å¯åŠ¨ç±»åŠ è½½å™¨(Bootstrap ClassLoader)ï¼Œè¿™ä¸ªç±»åŠ è½½å™¨ä½¿ç”¨C++ç¼–ç¨‹è¯­è¨€å®ç°ï¼Œæ˜¯è™šæ‹Ÿæœºçš„ä¸€éƒ¨åˆ†ã€‚ 2ã€å¦ä¸€ç§æ˜¯å…¶ä»–çš„ç±»åŠ è½½å™¨ï¼Œè¿™äº›ç±»åŠ è½½å™¨éƒ½æ˜¯ç”±Javaè¯­è¨€å®ç°ï¼Œç‹¬ç«‹äºè™šæ‹Ÿæœºä¹‹å¤–ï¼Œä¸€èˆ¬å°±æ˜¯å†…éƒ¨äºJDKä¸­ï¼Œå®ƒä»¬éƒ½ç»§æ‰¿è‡ªæŠ½è±¡ç±»åŠ è½½å™¨java.lang.ClassLoaderã€‚ JDKä¸­æä¾›å‡ ä¸ªç³»ç»Ÿçº§åˆ«çš„ç±»åŠ è½½å™¨ï¼š 1ã€å¯åŠ¨ç±»åŠ è½½å™¨(Bootstrap ClassLoader)ï¼šè¿™ä¸ªç±»åŠ è½½å™¨è´Ÿè´£å°†å­˜æ”¾åœ¨${JAVA_HONE}\\libç›®å½•ä¸­ï¼Œæˆ–è€…è¢«XbootstrapPathå‚æ•°æ‰€æŒ‡å®šçš„ç›®å½•ä¸­ï¼Œå¹¶ä¸”æ˜¯è™šæ‹ŸæœºåŸºäºä¸€å®šè§„åˆ™(å¦‚æ–‡ä»¶åç§°è§„åˆ™ï¼Œå¦‚rt.jar)æ ‡è¯†çš„ç±»åº“åŠ è½½åˆ°è™šæ‹Ÿæœºå†…å­˜ä¸­ã€‚å¯åŠ¨ç±»åŠ è½½å™¨æ— æ³•è¢«Javaç¨‹åºç›´æ¥å¼•ç”¨ï¼Œå¼€å‘è€…åœ¨ç¼–å†™è‡ªå®šä¹‰ç±»åŠ è½½å™¨å¦‚æœæƒ³å§”æ´¾åˆ°å¯åŠ¨ç±»åŠ è½½å™¨åªéœ€ç›´æ¥ä½¿ç”¨nullæ›¿ä»£å³å¯ã€‚ 2ã€æ‰©å±•ç±»åŠ è½½å™¨(Extension ClassLoader)ï¼šè¿™ä¸ªç±»åŠ è½½å™¨ç”±sun.misc.Launcherçš„é™æ€å†…éƒ¨ç±»ExtClassLoaderå®ç°ï¼Œå®ƒè´Ÿè´£åŠ è½½${JAVA_HONE}\\lib\\extç›®å½•ä¸­ï¼Œæˆ–è€…é€šè¿‡java.ext.dirsç³»ç»Ÿå˜é‡æŒ‡å®šçš„è·¯å¾„ä¸­çš„æ‰€æœ‰ç±»åº“ï¼Œå¼€å‘è€…å¯ä»¥ç›´æ¥ä½¿ç”¨æ­¤ç±»åŠ è½½å™¨ã€‚ 3ã€åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨(Application ClassLoader)ï¼šè¿™ä¸ªç±»åŠ è½½å™¨ç”±sun.misc.Launcherçš„é™æ€å†…éƒ¨ç±»AppClassLoaderå®ç°ï¼Œä½†æ˜¯ç”±äºè¿™ä¸ªç±»åŠ è½½å™¨çš„å®ä¾‹æ˜¯ClassLoaderä¸­é™æ€æ–¹æ³•getSystemClassLoader()ä¸­çš„è¿”å›å€¼ï¼Œä¸€èˆ¬ä¹Ÿç§°å®ƒä¸ºç³»ç»Ÿç±»åŠ è½½å™¨ã€‚å®ƒè´Ÿè´£åŠ è½½ç”¨æˆ·ç±»è·¯å¾„(ClassPath)ä¸Šæ‰€æŒ‡å®šçš„ç±»åº“ï¼Œå¼€å‘è€…å¯ä»¥ç›´æ¥ä½¿ç”¨è¿™ä¸ªç±»åŠ è½½å™¨ï¼Œå¦‚æœåº”ç”¨ç¨‹åºä¸­æ²¡æœ‰è‡ªå®šä¹‰è¿‡è‡ªå®ç°çš„ç±»åŠ è½½å™¨ï¼Œä¸€èˆ¬æƒ…å†µä¸‹è¿™ä¸ªç³»ç»Ÿç±»åŠ è½½å™¨å°±æ˜¯åº”ç”¨ç¨‹åºä¸­é»˜è®¤ä½¿ç”¨çš„ç±»åŠ è½½å™¨ã€‚ 4ã€çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨(Thread Context ClassLoader)ï¼šè¿™ä¸ªåœ¨ä¸‹ä¸€å°èŠ‚&quot;ç ´ååŒäº²å§”æ´¾æ¨¡å‹&quot;å†åˆ†æã€‚ Javaå¼€å‘è€…å¼€å‘å‡ºæ¥çš„Javaåº”ç”¨ç¨‹åºéƒ½æ˜¯ç”±ä¸Šé¢å››ç§ç±»åŠ è½½å™¨ç›¸äº’é…åˆè¿›è¡Œç±»åŠ è½½çš„ï¼Œå¦‚æœæœ‰å¿…è¦è¿˜å¯ä»¥åŠ å…¥è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨ã€‚å…¶ä¸­ï¼Œå¯åŠ¨ç±»åŠ è½½å™¨ã€æ‰©å±•ç±»åŠ è½½å™¨ã€åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨å’Œè‡ªå®šä¹‰ç±»åŠ è½½å™¨ä¹‹é—´å­˜åœ¨ç€ä¸€å®šçš„å…³ç³»ï¼š ä¸Šå›¾å±•ç¤ºçš„ç±»åŠ è½½å™¨ä¹‹é—´çš„å±‚æ¬¡å…³ç³»ç§°ä¸ºåŒäº²å§”æ´¾æ¨¡å‹(Parents Delegation Model)ã€‚åŒäº²å§”æ´¾æ¨¡å‹è¦æ±‚é™¤äº†é¡¶å±‚çš„ç±»åŠ è½½å™¨(Javaä¸­é¡¶å±‚çš„ç±»åŠ è½½å™¨ä¸€èˆ¬æ˜¯Bootstrap ClassLoader)ï¼Œå…¶ä»–çš„ç±»åŠ è½½å™¨éƒ½åº”å½“æœ‰è‡ªå·±çš„çˆ¶ç±»åŠ è½½å™¨ã€‚è¿™äº›ç±»åŠ è½½å™¨ä¹‹é—´çš„çˆ¶å­å…³ç³»ä¸€èˆ¬ä¸ä¼šä»¥ç»§æ‰¿(Inheritance)çš„å…³ç³»æ¥å®ç°ï¼Œè€Œæ˜¯é€šè¿‡ç»„åˆ(Composition)çš„å…³ç³»å®ç°ã€‚ç±»åŠ è½½å™¨å±‚æ¬¡å…³ç³»è¿™ä¸€ç‚¹å¯ä»¥é€šè¿‡ä¸‹é¢çš„ä»£ç éªŒè¯ä¸€ä¸‹ï¼š 1234567891011121314public class Main &#123; public static void main(String[] args) throws Exception&#123; ClassLoader classLoader = Main.class.getClassLoader(); System.out.println(classLoader); System.out.println(classLoader.getParent()); System.out.println(classLoader.getParent().getParent()); &#125;&#125;//è¾“å‡ºç»“æœï¼Œæœ€åçš„nullè¯´æ˜æ˜¯Bootstrap ClassLoadersun.misc.Launcher$AppClassLoader@18b4aac2sun.misc.Launcher$ExtClassLoader@4629104anull åŒäº²å§”æ´¾æ¨¡å‹çš„å·¥ä½œæœºåˆ¶ï¼šå¦‚æœä¸€ä¸ªç±»åŠ è½½å™¨æ”¶åˆ°äº†ç±»åŠ è½½çš„è¯·æ±‚ï¼Œå®ƒé¦–å…ˆä¸ä¼šè‡ªå·±å°è¯•å»åŠ è½½è¿™ä¸ªç±»ï¼Œè€Œæ˜¯æŠŠè¿™ä¸ªè¯·æ±‚å§”æ´¾ç»™çˆ¶ç±»åŠ è½½å™¨å»å®Œæˆï¼Œæ¯ä¸€ä¸ªå±‚æ¬¡çš„ç±»åŠ è½½å™¨éƒ½æ˜¯å¦‚æ­¤ï¼Œå› æ­¤æ‰€æœ‰çš„ç±»åŠ è½½è¯·æ±‚æœ€ç»ˆéƒ½åº”è¯¥ä¼ é€åˆ°é¡¶å±‚çš„ç±»åŠ è½½å™¨ä¸­ï¼Œåªæœ‰å½“çˆ¶ç±»åŠ è½½å™¨åé¦ˆè‡ªå·±æ— æ³•å®Œæˆå½“å‰çš„ç±»åŠ è½½è¯·æ±‚çš„æ—¶å€™(ä¹Ÿå°±æ˜¯åœ¨å®ƒçš„æœç´¢èŒƒå›´ä¸­æ²¡æœ‰æ‰¾åˆ°æ‰€éœ€è¦çš„ç±»)ï¼Œå­ç±»åŠ è½½å™¨æ‰ä¼šå°è¯•è‡ªå·±å»åŠ è½½ç±»ã€‚ä¸è¿‡è¿™é‡Œæœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„ï¼Œæ¯ä¸€ä¸ªç±»åŠ è½½å™¨éƒ½ä¼šç¼“å­˜å·²ç»åŠ è½½è¿‡çš„ç±»ï¼Œä¹Ÿå°±æ˜¯é‡å¤åŠ è½½ä¸€ä¸ªå·²ç»å­˜åœ¨çš„ç±»ï¼Œé‚£ä¹ˆå°±ä¼šä»å·²ç»åŠ è½½çš„ç¼“å­˜ä¸­åŠ è½½ï¼Œå¦‚æœä»å½“å‰ç±»åŠ è½½çš„ç¼“å­˜ä¸­åˆ¤æ–­ç±»å·²ç»åŠ è½½è¿‡ï¼Œé‚£ä¹ˆç›´æ¥è¿”å›ï¼Œå¦åˆ™ä¼šå§”æ´¾ç±»åŠ è½½è¯·æ±‚åˆ°çˆ¶ç±»åŠ è½½å™¨ã€‚è¿™ä¸ªç¼“å­˜æœºåˆ¶åœ¨AppClassLoaderå’ŒExtensionClassLoaderä¸­éƒ½å­˜åœ¨ï¼Œè‡³äºBootstrapClassLoaderæœªçŸ¥ã€‚ åŒäº²å§”æ´¾æ¨¡å‹çš„ä¼˜åŠ¿ï¼šä½¿ç”¨åŒäº²å§”æ´¾æ¨¡å‹æ¥ç»„ç»‡ç±»åŠ è½½å™¨ä¹‹é—´çš„å…³ç³»ï¼Œä¸€ä¸ªæ¯”è¾ƒæ˜¾è‘—çš„ä¼˜ç‚¹æ˜¯Javaç±»éšç€åŠ è½½å®ƒçš„ç±»åŠ è½½å™¨ä¸€èµ·å…·å¤‡äº†ä¸€ç§å¸¦æœ‰ä¼˜å…ˆçº§çš„å±‚æ¬¡å…³ç³»ã€‚ä¾‹å¦‚java.langåŒ…ä¸­çš„ç±»åº“ï¼Œå®ƒå­˜æ”¾åœ¨rt.jarä¸­ï¼Œæ— è®ºä½¿ç”¨å“ªä¸€ä¸ªç±»åŠ è½½åŠ è½½java.langåŒ…ä¸­çš„ç±»ï¼Œæœ€ç»ˆéƒ½æ˜¯å§”æ´¾ç»™å¤„äºæ¨¡å‹é¡¶å±‚çš„å¯åŠ¨ç±»åŠ è½½å™¨è¿›è¡ŒåŠ è½½ï¼Œå› æ­¤java.langåŒ…ä¸­çš„ç±»å¦‚java.lang.Objectç±»åœ¨åº”ç”¨ç¨‹åºä¸­çš„å„ç±»åŠ è½½å™¨ç¯å¢ƒä¸­åŠ è½½çš„éƒ½æ˜¯åŒä¸€ä¸ªç±»ã€‚è¯•æƒ³ï¼Œå¦‚æœå¯ä»¥ä½¿ç”¨ç”¨æˆ·è‡ªå®šä¹‰çš„ClassLoaderå»åŠ è½½java.lang.Objectï¼Œé‚£ä¹ˆç”¨æˆ·åº”ç”¨ç¨‹åºä¸­å°±ä¼šå‡ºç°å¤šä¸ªjava.lang.Objectç±»ï¼ŒJavaç±»å‹ä½“ç³»ä¸­æœ€åŸºç¡€çš„ç±»å‹ä¹Ÿæœ‰å¤šä¸ªï¼Œç±»å‹ä½“ç³»çš„åŸºç¡€è¡Œä¸ºæ— æ³•ä¿è¯ï¼Œåº”ç”¨ç¨‹åºä¹Ÿä¼šè¶‹äºæ··ä¹±ã€‚å¦‚æœå°è¯•ç¼–å†™rt.jarä¸­å·²ç»å­˜åœ¨çš„åŒç±»åçš„ç±»é€šè¿‡è‡ªå®šä¹‰çš„ç±»åŠ è½½è¿›è¡ŒåŠ è½½ï¼Œå°†ä¼šæ¥æ”¶åˆ°è™šæ‹ŸæœºæŠ›å‡ºçš„å¼‚å¸¸ã€‚ åŒäº²å§”æ´¾æ¨¡å‹çš„å®ç°ï¼šç±»åŠ è½½å™¨åŒäº²å§”æ´¾æ¨¡å‹çš„å®ç°æç°åœ¨ClassLoaderçš„æºç ä¸­ï¼Œä¸»è¦æ˜¯ClassLoader#loadClass()ä¸­ã€‚ 1234567891011121314151617181920212223242526272829303132333435363738394041public Class&lt;?&gt; loadClass(String name) throws ClassNotFoundException &#123; return loadClass(name, false);&#125;protected Class&lt;?&gt; loadClass(String name, boolean resolve) throws ClassNotFoundException&#123; synchronized (getClassLoadingLock(name)) &#123; // First, check if the class has already been loaded Class&lt;?&gt; c = findLoadedClass(name); if (c == null) &#123; long t0 = System.nanoTime(); try &#123; //çˆ¶åŠ è½½å™¨ä¸ä¸ºnullï¼Œè¯´æ˜çˆ¶åŠ è½½å™¨ä¸æ˜¯BootstrapClassLoader if (parent != null) &#123; c = parent.loadClass(name, false); &#125; else &#123; //çˆ¶åŠ è½½å™¨ä¸ºnullï¼Œè¯´æ˜çˆ¶åŠ è½½å™¨æ˜¯BootstrapClassLoader c = findBootstrapClassOrNull(name); &#125; &#125; catch (ClassNotFoundException e) &#123; // ClassNotFoundException thrown if class not found // from the non-null parent class loader &#125; //æ‰€æœ‰çš„çˆ¶åŠ è½½åŠ è½½å¤±è´¥,åˆ™ä½¿ç”¨å½“å‰çš„ç±»åŠ è½½å™¨è¿›è¡Œç±»åŠ è½½ if (c == null) &#123; // If still not found, then invoke findClass in order // to find the class. long t1 = System.nanoTime(); c = findClass(name); //è®°å½•ä¸€äº›ç»Ÿè®¡æ•°æ®å¦‚åŠ è½½è€—æ—¶ã€è®¡æ•°ç­‰ // this is the defining class loader; record the stats sun.misc.PerfCounter.getParentDelegationTime().addTime(t1 - t0); sun.misc.PerfCounter.getFindClassTime().addElapsedTimeFrom(t1); sun.misc.PerfCounter.getFindClasses().increment(); &#125; &#125; if (resolve) &#123; resolveClass(c); &#125; return c; &#125;&#125; ç ´ååŒäº²å§”æ´¾æ¨¡å‹ åŒäº²å§”æ´¾æ¨¡å‹åœ¨Javaå‘å±•å†å²ä¸Šå‡ºç°äº†ä¸‰æ¬¡æ¯”è¾ƒå¤§&quot;è¢«ç ´å&quot;çš„æƒ…å†µ: 1ã€ClassLoaderåœ¨JDK1.0å·²ç»å­˜åœ¨ï¼ŒJDK1.2ä¸ºäº†å¼•å…¥åŒäº²å§”æ´¾æ¨¡å‹å¹¶ä¸”éœ€è¦å‘å‰å…¼å®¹ï¼Œjava.lang.ClassLoaderç±»æ·»åŠ äº†ä¸€ä¸ªæ–°çš„protectedçš„findClass()æ–¹æ³•ï¼Œåœ¨è¿™ä¹‹å‰ï¼Œç”¨æˆ·å»ç»§æ‰¿java.lang.ClassLoaderåªèƒ½é‡å†™å…¶loadClass()æ–¹æ³•æ‰èƒ½å®ç°è‡ªå·±çš„ç›®æ ‡ã€‚ 2ã€åŒäº²å§”æ´¾æ¨¡å‹è‡ªèº«å­˜åœ¨ç¼ºé™·ï¼šåŒäº²å§”æ´¾å¾ˆå¥½åœ°è§£å†³äº†å„ä¸ªç±»åŠ è½½å™¨çš„åŸºç¡€ç±»çš„åŠ è½½çš„ç»Ÿä¸€é—®é¢˜(è¶ŠåŸºç¡€çš„ç±»ç”±è¶Šä¸Šå±‚çš„ç±»åŠ è½½å™¨åŠ è½½)ï¼Œè¿™äº›æ‰€è°“çš„åŸºç¡€ç±»å°±æ˜¯å¤§å¤šæ•°æƒ…å†µä¸‹ä½œä¸ºç”¨æˆ·è°ƒç”¨çš„åŸºç¡€ç±»åº“å’ŒåŸºç¡€APIï¼Œä½†æ˜¯æ— æ³•è§£å†³è¿™äº›åŸºç¡€ç±»éœ€è¦å›è°ƒç”¨æˆ·çš„ä»£ç è¿™ä¸€ä¸ªé—®é¢˜ï¼Œå…¸å‹çš„ä¾‹å­å°±æ˜¯JNDIã€‚JNDIçš„ç±»åº“ä»£ç æ˜¯å¯åŠ¨ç±»åŠ è½½å™¨åŠ è½½çš„ï¼Œä½†æ˜¯å®ƒéœ€è¦è°ƒç”¨ç‹¬ç«‹å‚å•†å®ç°å¹¶ä¸”éƒ¨ç½²åœ¨åº”ç”¨çš„ClassPathçš„JNDIçš„æœåŠ¡æ¥å£æä¾›è€…(SPIï¼Œå³æ˜¯Service Provider Interface)çš„ä»£ç ï¼Œä½†æ˜¯å¯åŠ¨ç±»åŠ è½½å™¨æ— æ³•åŠ è½½ClassPathä¸‹çš„ç±»åº“ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒJavaè®¾è®¡å›¢é˜Ÿå¼•å…¥äº†ä¸ä¼˜é›…çš„è®¾è®¡ï¼šçº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨(Thread Context ClassLoader)ï¼Œè¿™ä¸ªç±»åŠ è½½å™¨å¯ä»¥é€šè¿‡java.lang.Threadç±»çš„setContextClassLoader()è®¾ç½®ï¼Œè¿™æ ·å­ï¼ŒJNDIæœåŠ¡å°±å¯ä»¥ä½¿ç”¨çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨å»åŠ è½½æ‰€éœ€çš„SPIç±»åº“ï¼Œä½†æ˜¯çˆ¶ç±»åŠ è½½å™¨ä¸­è¯·æ±‚å­ç±»åŠ è½½å™¨å»åŠ è½½ç±»è¿™ä¸€ç‚¹å·²ç»æ‰“ç ´äº†åŒäº²å§”æ´¾æ¨¡å‹ã€‚ç›®å‰ï¼ŒJNDIã€JDBCã€JCEã€JAXBå’ŒJBIç­‰æ¨¡å—éƒ½æ˜¯é€šè¿‡æ­¤æ–¹å¼å®ç°ã€‚ 3ã€åŸºäºç”¨æˆ·å¯¹åº”ç”¨ç¨‹åºåŠ¨æ€æ€§çš„çƒ­åˆ‡è¿½æ±‚ï¼šå¦‚ä»£ç çƒ­æ›¿æ¢(HotSwap)ã€çƒ­æ¨¡å—éƒ¨ç½²ç­‰ï¼Œè¯´ç™½äº†å°±æ˜¯å¸Œæœ›åº”ç”¨ç¨‹åºèƒ½åƒæˆ‘ä»¬çš„è®¡ç®—æœºå¤–è®¾é‚£æ ·å¯ä»¥çƒ­æ’æ‹”ï¼Œå› æ­¤å‚¬ç”Ÿå‡ºJSR-291ä»¥åŠå®ƒçš„ä¸šç•Œå®ç°OSGiï¼Œè€ŒOSGiå®šåˆ¶äº†è‡ªå·±çš„ç±»åŠ è½½è§„åˆ™ï¼Œä¸å†éµå¾ªåŒäº²å§”æ´¾æ¨¡å‹ï¼Œå› æ­¤å®ƒå¯ä»¥é€šè¿‡è‡ªå®šä¹‰çš„ç±»åŠ è½½å™¨æœºåˆ¶è½»æ˜“å®ç°æ¨¡å—çš„çƒ­éƒ¨ç½²ã€‚ JDKä¸­æä¾›çš„èµ„æºåŠ è½½API å‰è¾¹èŠ±å¤§é‡çš„ç¯‡å¹…å»åˆ†æç±»åŠ è½½å™¨çš„é¢„çƒ­çŸ¥è¯†ï¼Œæ˜¯å› ä¸ºJDKä¸­çš„èµ„æºåŠ è½½ä¾èµ–äºç±»åŠ è½½å™¨(å…¶å®ç±»æ–‡ä»¶æœ¬æ¥å°±æ˜¯èµ„æºæ–‡ä»¶çš„ä¸€ç§ï¼Œç±»åŠ è½½çš„è¿‡ç¨‹ä¹Ÿæ˜¯èµ„æºåŠ è½½çš„è¿‡ç¨‹)ã€‚è¿™é‡Œå…ˆåˆ—ä¸¾å‡ºJDKä¸­ç›®å‰å¸¸ç”¨çš„èµ„æº(Resource)åŠ è½½çš„APIï¼Œå…ˆçœ‹ClassLoaderä¸­æä¾›çš„æ–¹æ³•ã€‚ ClassLoaderæä¾›çš„èµ„æºåŠ è½½API 12345678910111213141516171819//1.å®ä¾‹æ–¹æ³•public URL getResource(String name)//è¿™ä¸ªæ–¹æ³•ä»…ä»…æ˜¯è°ƒç”¨getResource(String name)è¿”å›URLå®ä¾‹ç›´æ¥è°ƒç”¨URLå®ä¾‹çš„openStream()æ–¹æ³•public InputStream getResourceAsStream(String name)//è¿™ä¸ªæ–¹æ³•æ˜¯getResource(String name)æ–¹æ³•çš„å¤æ•°ç‰ˆæœ¬public Enumeration&lt;URL&gt; getResources(String name) throws IOException//2.é™æ€æ–¹æ³•public static URL getSystemResource(String name)//è¿™ä¸ªæ–¹æ³•ä»…ä»…æ˜¯è°ƒç”¨getSystemResource(String name)è¿”å›URLå®ä¾‹ç›´æ¥è°ƒç”¨URLå®ä¾‹çš„openStream()æ–¹æ³•public static InputStream getSystemResourceAsStream(String name)//è¿™ä¸ªæ–¹æ³•æ˜¯getSystemResources(String name)æ–¹æ³•çš„å¤æ•°ç‰ˆæœ¬public static Enumeration&lt;URL&gt; getSystemResources(String name) æ€»çš„æ¥çœ‹ï¼Œåªæœ‰ä¸¤ä¸ªæ–¹æ³•éœ€è¦åˆ†æï¼šgetResource(String name)å’ŒgetSystemResource(String name)ã€‚æŸ¥çœ‹getResource(String name)çš„æºç ï¼š 123456789101112public URL getResource(String name) &#123; URL url; if (parent != null) &#123; url = parent.getResource(name); &#125; else &#123; url = getBootstrapResource(name); &#125; if (url == null) &#123; url = findResource(name); &#125; return url;&#125; æ˜¯å¦ä¼¼æ›¾ç›¸è¯†?è¿™é‡Œæ˜æ˜¾å°±æ˜¯ä½¿ç”¨äº†ç±»åŠ è½½è¿‡ç¨‹ä¸­ç±»ä¼¼çš„åŒäº²å§”æ´¾æ¨¡å‹è¿›è¡Œèµ„æºåŠ è½½ï¼Œè¿™ä¸ªæ–¹æ³•åœ¨APIæ³¨é‡Šä¸­æè¿°é€šå¸¸ç”¨äºåŠ è½½æ•°æ®èµ„æºå¦‚imagesã€audioã€textç­‰ç­‰ï¼Œèµ„æºåç§°éœ€è¦ä½¿ç”¨è·¯å¾„åˆ†éš”ç¬¦â€™/â€™ã€‚getResource(String name)æ–¹æ³•ä¸­æŸ¥æ‰¾çš„æ ¹è·¯å¾„æˆ‘ä»¬å¯ä»¥é€šè¿‡ä¸‹é¢æ–¹æ³•éªŒè¯ï¼š 12345678910public class ResourceLoader &#123; public static void main(String[] args) throws Exception &#123; ClassLoader classLoader = ResourceLoader.class.getClassLoader(); URL resource = classLoader.getResource(\"\"); System.out.println(resource); &#125;&#125;//è¾“å‡ºï¼šfile:/D:/Projects/rxjava-seed/target/classes/ å¾ˆæ˜æ˜¾è¾“å‡ºçš„ç»“æœå°±æ˜¯å½“å‰åº”ç”¨çš„ClassPathï¼Œæ€»ç»“æ¥è¯´ï¼šClassLoader#getResource(String name)æ˜¯åŸºäºç”¨æˆ·åº”ç”¨ç¨‹åºçš„ClassPathæœç´¢èµ„æºï¼Œèµ„æºåç§°å¿…é¡»ä½¿ç”¨è·¯å¾„åˆ†éš”ç¬¦â€™/â€˜å»åˆ†éš”ç›®å½•ï¼Œä½†æ˜¯ä¸èƒ½ä»¥â€™/'ä½œä¸ºèµ„æºåçš„èµ·å§‹ï¼Œä¹Ÿå°±æ˜¯ä¸èƒ½è¿™æ ·ä½¿ç”¨ï¼šclassLoader.getResource(&quot;/img/doge.jpg&quot;)ã€‚æ¥ç€æˆ‘ä»¬å†çœ‹ä¸€ä¸‹ClassLoader#getSystemResource(String name)çš„æºç ï¼š 12345678public static URL getSystemResource(String name) &#123; //å®é™…ä¸ŠApplication ClassLoaderä¸€èˆ¬ä¸ä¼šä¸ºnull ClassLoader system = getSystemClassLoader(); if (system == null) &#123; return getBootstrapResource(name); &#125; return system.getResource(name);&#125; æ­¤æ–¹æ³•ä¼˜å…ˆä½¿ç”¨åº”ç”¨ç¨‹åºç±»åŠ è½½å™¨è¿›è¡Œèµ„æºåŠ è½½ï¼Œå¦‚æœåº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ä¸ºnull(å…¶å®è¿™ç§æƒ…å†µå¾ˆå°‘è§)ï¼Œåˆ™ä½¿ç”¨å¯åŠ¨ç±»åŠ è½½å™¨è¿›è¡Œèµ„æºåŠ è½½ã€‚å¦‚æœåº”ç”¨ç¨‹åºç±»åŠ è½½å™¨ä¸ä¸ºnullçš„æƒ…å†µä¸‹ï¼Œå®ƒå®é™…ä¸Šé€€åŒ–ä¸ºClassLoader#getResource(String name)æ–¹æ³•ã€‚ æ€»ç»“ä¸€ä¸‹ï¼šClassLoaderæä¾›çš„èµ„æºåŠ è½½çš„æ–¹æ³•ä¸­çš„æ ¸å¿ƒæ–¹æ³•æ˜¯ClassLoader#getResource(String name)ï¼Œå®ƒæ˜¯åŸºäºç”¨æˆ·åº”ç”¨ç¨‹åºçš„ClassPathæœç´¢èµ„æºï¼Œéµå¾ª&quot;èµ„æºåŠ è½½çš„åŒäº²å§”æ´¾æ¨¡å‹&quot;ï¼Œèµ„æºåç§°å¿…é¡»ä½¿ç”¨è·¯å¾„åˆ†éš”ç¬¦â€™/â€˜å»åˆ†éš”ç›®å½•ï¼Œä½†æ˜¯ä¸èƒ½ä»¥â€™/'ä½œä¸ºèµ„æºåçš„èµ·å§‹å­—ç¬¦ï¼Œå…¶ä»–å‡ ä¸ªæ–¹æ³•éƒ½æ˜¯åŸºäºæ­¤æ–¹æ³•è¿›è¡Œè¡ç”Ÿï¼Œæ·»åŠ å¤æ•°æ“ä½œç­‰å…¶ä»–æ“ä½œã€‚getResource(String name)æ–¹æ³•ä¸ä¼šæ˜¾ç¤ºæŠ›å‡ºå¼‚å¸¸ï¼Œå½“èµ„æºæœç´¢å¤±è´¥çš„æ—¶å€™ï¼Œä¼šè¿”å›nullã€‚ Classæä¾›çš„èµ„æºåŠ è½½API java.lang.Classä¸­ä¹Ÿæä¾›äº†èµ„æºåŠ è½½çš„æ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š 12345678910111213141516171819public java.net.URL getResource(String name) &#123; name = resolveName(name); ClassLoader cl = getClassLoader0(); if (cl==null) &#123; // A system class. return ClassLoader.getSystemResource(name); &#125; return cl.getResource(name);&#125;public InputStream getResourceAsStream(String name) &#123; name = resolveName(name); ClassLoader cl = getClassLoader0(); if (cl==null) &#123; // A system class. return ClassLoader.getSystemResourceAsStream(name); &#125; return cl.getResourceAsStream(name);&#125; ä»ä¸Šé¢çš„æºç æ¥çœ‹ï¼ŒClass#getResource(String name)å’ŒClass#getResourceAsStream(String name)åˆ†åˆ«æ¯”ClassLoader#getResource(String name)å’ŒClassLoader#getResourceAsStream(String name)åªå¤šäº†ä¸€æ­¥ï¼Œå°±æ˜¯æœç´¢ä¹‹å‰å…ˆè¿›è¡Œèµ„æºåç§°çš„é¢„å¤„ç†resolveName(name)ï¼Œæˆ‘ä»¬é‡ç‚¹çœ‹è¿™ä¸ªæ–¹æ³•åšäº†ä»€ä¹ˆï¼š 1234567891011121314151617181920private String resolveName(String name) &#123; if (name == null) &#123; return name; &#125; if (!name.startsWith(\"/\")) &#123; Class&lt;?&gt; c = this; while (c.isArray()) &#123; c = c.getComponentType(); &#125; String baseName = c.getName(); int index = baseName.lastIndexOf('.'); if (index != -1) &#123; name = baseName.substring(0, index).replace('.', '/') +\"/\"+name; &#125; &#125; else &#123; name = name.substring(1); &#125; return name;&#125; é€»è¾‘ç›¸å¯¹æ¯”è¾ƒç®€å•ï¼š 1ã€å¦‚æœèµ„æºåç§°ä»¥â€™/â€˜å¼€å¤´ï¼Œé‚£ä¹ˆç›´æ¥å»æ‰â€™/â€™ï¼Œè¿™ä¸ªæ—¶å€™çš„èµ„æºæŸ¥æ‰¾å®é™…ä¸Šé€€åŒ–ä¸ºClassPathä¸­çš„èµ„æºæŸ¥æ‰¾ã€‚ 2ã€å¦‚æœèµ„æºåç§°ä¸ä»¥â€™/â€˜å¼€å¤´ï¼Œé‚£ä¹ˆè§£æå‡ºå½“å‰ç±»çš„å®é™…ç±»å‹(å› ä¸ºå½“å‰ç±»æœ‰å¯èƒ½æ˜¯æ•°ç»„)ï¼Œå–å‡ºç±»å‹çš„åŒ…è·¯å¾„ï¼Œæ›¿æ¢åŒ…è·¯å¾„ä¸­çš„â€™.â€˜ä¸ºâ€™/â€™ï¼Œå†æ‹¼æ¥åŸæ¥çš„èµ„æºåç§°ã€‚ä¸¾ä¸ªä¾‹å­ï¼š&quot;club.throwable.Main.class&quot;ä¸­è°ƒç”¨äº†Main.class.getResource(&quot;doge.jpg&quot;)ï¼Œé‚£ä¹ˆè¿™ä¸ªè°ƒç”¨çš„å¤„ç†èµ„æºåç§°çš„ç»“æœå°±æ˜¯club/throwable/doge.jpgã€‚ å°ç»“ï¼šå¦‚æœçœ‹è¿‡æˆ‘ä¹‹å‰å†™è¿‡çš„ä¸€ç¯‡URLå’ŒURIç›¸å…³çš„æ–‡ç« å°±æ¸…æ¥šï¼Œå®é™…ä¸ŠClass#getResource(String name)å’ŒClass#getResourceAsStream(String name)çš„èµ„æºåç§°å¤„ç†ç±»ä¼¼äºç›¸å¯¹URLçš„å¤„ç†ï¼Œè€Œ&quot;ç›¸å¯¹URLçš„å¤„ç†&quot;çš„æ ¹è·¯å¾„å°±æ˜¯åº”ç”¨ç¨‹åºçš„ClassPathã€‚å¦‚æœèµ„æºåç§°ä»¥â€™/â€˜å¼€å¤´ï¼Œé‚£ä¹ˆç›¸å½“äºä»ClassPathä¸­åŠ è½½èµ„æºï¼Œå¦‚æœèµ„æºåç§°ä¸ä»¥â€™/'å¼€å¤´ï¼Œé‚£ä¹ˆç›¸å½“äºåŸºäºå½“å‰ç±»çš„å®é™…ç±»å‹çš„åŒ…ç›®å½•ä¸‹åŠ è½½èµ„æºã€‚ å®é™…ä¸Šç±»ä¼¼è¿™æ ·çš„èµ„æºåŠ è½½æ–¹å¼åœ¨Fileç±»ä¸­ä¹Ÿå­˜åœ¨ï¼Œè¿™é‡Œå°±ä¸å†å±•å¼€ã€‚ å°ç»“ ç†è§£JDKä¸­çš„èµ„æºåŠ è½½æ–¹å¼æœ‰åŠ©äºç¼–å†™ä¸€äº›é€šç”¨çš„åŸºç¡€ç»„ä»¶ï¼ŒåƒSpringé‡Œé¢çš„ResourceLoaderã€ClassPathResourceè¿™é‡Œæ¯”è¾ƒå®ç”¨çš„å·¥å…·ä¹Ÿæ˜¯åŸºäºJDKèµ„æºåŠ è½½çš„æ–¹å¼ç¼–å†™å‡ºæ¥ã€‚ä¸‹ä¸€ç¯‡åšæ–‡ã€Šæµ…æJDKä¸­ServiceLoaderçš„æºç ã€‹ä¸­çš„ä¸»è§’ServiceLoaderå°±æ˜¯åŸºäºç±»åŠ è½½å™¨çš„åŠŸèƒ½å®ç°ï¼Œå®ƒä¹Ÿæ˜¯SPIä¸­çš„æœåŠ¡ç±»åŠ è½½çš„æ ¸å¿ƒç±»ã€‚ è¯´å®è¯ï¼Œç±»åŠ è½½å™¨çš„&quot;åŒäº²å§”æ´¾æ¨¡å‹&quot;å’Œ&quot;ç ´ååŒäº²å§”æ´¾æ¨¡å‹&quot;æ˜¯å¸¸è§çš„é¢è¯•é¢˜ç›¸å…³å†…å®¹ï¼Œè¿™é‡Œå¯ä»¥ç®€å•åˆ—ä¸¾ä¸¤ä¸ªé¢è¯•é¢˜ï¼š 1ã€è°ˆè°ˆå¯¹ç±»åŠ è½½å™¨çš„&quot;åŒäº²å§”æ´¾æ¨¡å‹&quot;çš„ç†è§£ã€‚ 2ã€ä¸ºä»€ä¹ˆè¦å¼•å…¥çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨(æˆ–è€…æ˜¯å¯¹äºé—®é¢˜1æœ‰æ‰“ç ´è¿™ä¸ªæ¨¡å‹çš„æ¡ˆä¾‹å—)? å¸Œæœ›è¿™ç¯‡æ–‡ç« èƒ½å¸®åŠ©ä½ ç†è§£å’Œè§£å†³è¿™ä¸¤ä¸ªé—®é¢˜ã€‚ å‚è€ƒèµ„æ–™ï¼š ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœºç¬¬äºŒç‰ˆã€‹ JavaSE-8æºç  (æœ¬æ–‡å®Œ c-1-d e-20181014)","categories":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/categories/Java/"}],"tags":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/tags/Java/"}]},{"title":"RabbitMQæ‰©å±•ä¹‹æ¶ˆè´¹è€…ä¼˜å…ˆçº§","slug":"rabbitmq-extension-consumer-priority","date":"2018-11-29T16:21:49.000Z","updated":"2018-11-29T16:25:37.815Z","comments":true,"path":"2018/11/30/rabbitmq-extension-consumer-priority/","link":"","permalink":"http://throwable.club/2018/11/30/rabbitmq-extension-consumer-priority/","excerpt":"","text":"å‰æ æœ¬æ–‡æ¥æºäºå®˜æ–¹æ–‡æ¡£Consumer Prioritiesã€‚ æ¶ˆè´¹è€…ä¼˜å…ˆçº§ æ¶ˆè´¹è€…ä¼˜å…ˆçº§çš„æœºåˆ¶ï¼š é«˜ä¼˜å…ˆçº§çš„æ¶ˆè´¹è€…å¤„äºæ´»è·ƒçŠ¶æ€çš„æƒ…å†µä¸‹ä¼˜å…ˆæ¥æ”¶å’Œå¤„ç†æ¶ˆæ¯ã€‚ æ¶ˆæ¯ä¼šæµå…¥åˆ°ä½ä¼˜å…ˆçº§çš„æ´»è·ƒæ¶ˆè´¹è€…ä»…å½“é«˜ä¼˜å…ˆçº§çš„æ¶ˆè´¹è€…å¤„äºé˜»å¡çŠ¶æ€ã€‚ æ­£å¸¸æƒ…å†µä¸‹ï¼Œæ‰€æœ‰è®¢é˜…åŒä¸€ä¸ªé˜Ÿåˆ—çš„æ´»è·ƒæ¶ˆè´¹è€…ä»¥å¾ªç¯çš„(round-robin)æ–¹å¼ä»é˜Ÿåˆ—ä¸­æ¥æ”¶æ¶ˆæ¯ã€‚å½“ä½¿ç”¨äº†æ¶ˆè´¹è€…ä¼˜å…ˆçº§ï¼Œå¦‚æœå¤šä¸ªæ´»è·ƒæ¶ˆè´¹è€…ä½¿ç”¨äº†ç›¸åŒçš„é«˜ä¼˜å…ˆçº§å±æ€§ï¼Œé‚£ä¹ˆæ¶ˆæ¯æŠ•é€’ä¹Ÿæ˜¯ä»¥å¾ªç¯çš„æ–¹å¼è¿›è¡Œ(å…¶å®ä½¿ç”¨äº†ç›¸åŒçš„ä¼˜å…ˆçº§ç±»ä¼¼äºæ²¡æœ‰å¯ç”¨ä¼˜å…ˆçº§)ã€‚ æ´»è·ƒæ¶ˆè´¹è€…çš„å®šä¹‰ æ´»è·ƒçš„æ¶ˆè´¹è€…å°±æ˜¯å¯ä»¥åœ¨ä¸ç”¨ç­‰å¾…çš„æƒ…å†µä¸‹æ¥æ”¶å’Œå¤„ç†æ¶ˆæ¯çš„æ¶ˆè´¹è€…ï¼Œä¹Ÿå°±æ˜¯æ¶ˆè´¹è€…å¦‚æœæ— æ³•æ¥æ”¶æ¶ˆæ¯ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯å‡ºäºéæ´»è·ƒçŠ¶æ€(æˆ–è€…è¯´é˜»å¡çŠ¶æ€)ï¼Œé˜»å¡çš„å¸¸è§åŸå› æœ‰ï¼š ä½¿ç”¨äº†basic.qosä¹‹åï¼Œæ¶ˆè´¹è€…åœ¨ä¿¡é“ä¸­æœªç¡®è®¤çš„é¢„è¯»å–æ¶ˆæ¯è¾¾åˆ°äº†ä¸Šé™ã€‚ ç½‘ç»œé˜»å¡ã€‚ å› æ­¤ï¼Œå¯¹äºæ¯ä¸ªå­˜åœ¨çš„é˜Ÿåˆ—ï¼Œå¿…å®šè‡³å°‘å‡ºç°ä¸‹é¢ä¸‰ç§æƒ…å†µçš„å…¶ä¸­ä¸€ç§ï¼š é˜Ÿåˆ—æ²¡æœ‰æ´»è·ƒçš„æ¶ˆè´¹è€…ã€‚ é˜Ÿåˆ—æ˜¯ç©ºçš„ã€‚ é˜Ÿåˆ—æ­£åœ¨å¿™äºå‘æ¶ˆè´¹è€…æŠ•é€’æ¶ˆæ¯ã€‚ æ¶ˆè´¹è€…å¯èƒ½åœ¨ä¸€ç§’å†…å¤šæ¬¡åœ¨æ´»è·ƒå’Œé˜»å¡çŠ¶æ€ä¹‹é—´åˆ‡æ¢ï¼Œåªè¦æ¶ˆè´¹å¤„ç†é€Ÿåº¦è¶³å¤Ÿå¿«ã€‚RabbitMQä¸ä¼šé€šè¿‡Webç®¡ç†æ’ä»¶æˆ–è€…rabbitmqctlå‘½ä»¤å…¬å¼€æ¶ˆè´¹è€…å½“å‰æ˜¯æ´»è·ƒè¿˜æ˜¯é˜»å¡çŠ¶æ€ï¼Œæ¢è¨€ä¹‹ï¼Œåªèƒ½é€šè¿‡å®¢æˆ·ç«¯æ„ŸçŸ¥ã€‚ å¯ç”¨æ¶ˆè´¹è€…ä¼˜å…ˆçº§çš„æ—¶å€™ï¼ŒRabbitMQä¼šä¼˜å…ˆæŠ•é€’æ¶ˆæ¯åˆ°ä¼˜å…ˆçº§å±æ€§æ¯”è¾ƒé«˜çš„æ¶ˆè´¹è€…ï¼Œä½†æ˜¯å¦‚æœæ‰€æœ‰ä¼˜å…ˆçº§é«˜çš„æ¶ˆè´¹è€…éƒ½å¤„äºé˜»å¡çŠ¶æ€ï¼ŒRabbitMQä¼šæŠŠæ¶ˆæ¯æŠ•é€’åˆ°æ´»è·ƒçš„ä¼˜å…ˆçº§ç¨ä½çš„æ¶ˆè´¹è€…ï¼Œè€Œä¸æ˜¯ä¸€ç›´ç­‰å¾…ä¼˜å…ˆçº§é«˜çš„æ¶ˆè´¹è€…è§£é™¤é˜»å¡ï¼Œé€ æˆä¼˜å…ˆçº§ä½çš„æ¶ˆè´¹è€…ä¸€ç›´å¤„äºé¥¥é¥¿çŠ¶æ€ã€‚ ä½¿ç”¨æ¶ˆè´¹è€…ä¼˜å…ˆçº§ç‰¹æ€§ åœ¨ä½¿ç”¨basic.consumeæ–¹æ³•å¯ä»¥è®¾ç½®å‚æ•°x-priorityçš„å€¼ä¸ºæ•´æ•°ï¼Œæ•°å­—è¶Šå¤§åˆ™ä¼˜å…ˆçº§è¶Šé«˜ï¼Œæœªè®¾ç½®åˆ™ä½¿ç”¨é»˜è®¤å€¼0ã€‚ 1234567891011121314public class ConsumerPriorityMain extends BaseChannelFactory &#123; public static void main(String[] args) throws Exception &#123; provideChannel(channel -&gt; &#123; Map&lt;String, Object&gt; consumerArgs = new HashMap&lt;&gt;(8); consumerArgs.put(\"x-priority\", 10); channel.basicConsume(\"throwable.queue.direct\", true, consumerArgs, new DefaultConsumer(channel) &#123; &#125;); consumerArgs.put(\"x-priority\", 100); channel.basicConsume(\"throwable.queue.direct\", true, consumerArgs, new DefaultConsumer(channel) &#123; &#125;); &#125;); &#125;&#125; ä¸Šé¢çš„ä¾‹å­è®¾ç½®äº†ä¸¤ä¸ªæ¶ˆè´¹è€…ï¼Œåè€…çš„ä¼˜å…ˆçº§ä¸º100ï¼Œè€Œå‰è€…çš„ä¼˜å…ˆçº§ä¸º10ã€‚","categories":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/categories/Middleware/"},{"name":"RabbitMQ","slug":"Middleware/RabbitMQ","permalink":"http://throwable.club/blog/categories/Middleware/RabbitMQ/"}],"tags":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/tags/Middleware/"},{"name":"RabbitMQ","slug":"RabbitMQ","permalink":"http://throwable.club/blog/tags/RabbitMQ/"}]},{"title":"RabbitMQæ‰©å±•ä¹‹æ¶ˆè´¹è€…æ¶ˆæ¯é¢„è¯»å–","slug":"rabbitmq-extension-consumer-prefetch","date":"2018-11-28T15:01:46.000Z","updated":"2018-11-28T15:21:11.162Z","comments":true,"path":"2018/11/28/rabbitmq-extension-consumer-prefetch/","link":"","permalink":"http://throwable.club/2018/11/28/rabbitmq-extension-consumer-prefetch/","excerpt":"","text":"å‰æ æœ¬æ–‡æ¥æºäºå®˜æ–¹æ–‡æ¡£Consumer Prefetchã€‚ æ¶ˆè´¹è€…æ¶ˆæ¯é¢„è¯»å– æ¶ˆè´¹è€…æ¶ˆæ¯é¢„è¯»å–æ˜¯ä¸€ä¸ªæ›´åŠ åˆç†å’Œé«˜æ•ˆçš„é™åˆ¶æœªç¡®è®¤æ¶ˆæ¯æ•°é‡çš„è§£å†³æ–¹å¼ã€‚ AMQP 0-9-1åè®®ä¸­å®šä¹‰äº†basic.qosæ–¹æ³•ç”¨äºé™åˆ¶ä¿¡é“æˆ–è€…è¿æ¥ä¸Šçš„æœªç¡®è®¤æ¶ˆæ¯æ•°é‡ï¼Œè¿™ä¸ªæ¶ˆæ¯æ•°æ®é‡å‘½åä¸ºprefetch_countã€‚ä¸å¹¸çš„æ˜¯ï¼Œä¿¡é“å…¶å®å¹¶ä¸æ˜¯é™åˆ¶æœªç¡®è®¤æ¶ˆæ¯æ•°é‡çš„ç†æƒ³èŒƒç•´ï¼Œå› ä¸ºå•ä¸ªä¿¡é“æœ‰å¯èƒ½æœ‰å¤šä¸ªæ¶ˆè´¹è€…è®¢é˜…å¤šä¸ªä¸åŒçš„é˜Ÿåˆ—ï¼Œæ‰€ä»¥ä¿¡é“å’Œé˜Ÿåˆ—éœ€è¦ä¸ºå‘é€çš„æ¯ä¸ªæ¶ˆæ¯ç›¸äº’åè°ƒï¼Œä»¥ç¡®ä¿æ¶ˆæ¯æ€»æ•°é‡ä¸è¶…è¿‡é™åˆ¶ï¼Œé€ æˆäº†æ€§èƒ½ä¸‹é™ï¼Œå•æœºæ€§èƒ½å‡ºç°ç“¶é¢ˆï¼Œåœ¨é›†ç¾¤æ–¹æ¡ˆä¸­è€—æ—¶æ›´åŠ ä¸¥é‡ã€‚ basic.qoså®šä¹‰äº†ä¸¤ä¸ªå±æ€§ï¼š prefetch_countï¼šé¢„è¯»å–æ¶ˆæ¯çš„æ•°é‡ã€‚ globalï¼šæ˜¯å¦å…¨å±€çš„ã€‚ åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼ŒæŒ‡å®šæ¯ä¸ªæ¶ˆè´¹è€…çš„é¢„è¯»å–æ¶ˆæ¯æ•°é‡æ›´åŠ åˆç†ã€‚å› æ­¤ï¼ŒRabbitMQåœ¨basic.qosæ–¹æ³•ä¸­é‡æ–°å®šä¹‰äº†globalæ ‡å¿—çš„å«ä¹‰ï¼š globalçš„å€¼ prefetch_countåœ¨AMQP 0-9-1ä¸­çš„å«ä¹‰ prefetch_countåœ¨RabbitMQä¸­çš„å«ä¹‰ false åŒä¸€ä¸ªä¿¡é“ä¸Šçš„æ¶ˆè´¹è€…å…±äº« å•ç‹¬åº”ç”¨äºä¿¡é“ä¸Šçš„æ¯ä¸ªæ–°æ¶ˆè´¹è€… true æ‰€æœ‰æ¶ˆè´¹è€…åŸºäºåŒä¸€ä¸ªè¿æ¥å…±äº« åŒä¸€ä¸ªä¿¡é“ä¸Šçš„æ¶ˆè´¹è€…å…±äº« basic.qosæ–¹æ³•åœ¨RabbitMQçš„Javaé©±åŠ¨ä¸­å¯¹åº”ä¸‰ä¸ªæ–¹æ³•ï¼š 1234567void basicQos(int prefetchSize, int prefetchCount, boolean global) throws IOException;// prefetchSize = 0void basicQos(int prefetchCount, boolean global) throws IOException;// prefetchSize = 0 , global = falsevoid basicQos(int prefetchCount) throws IOException; prefetchSizeï¼šé¢„è¯»å–çš„æ¶ˆæ¯å†…å®¹å¤§å°ä¸Šé™(åŒ…å«)ï¼Œå¯ä»¥ç®€å•ç†è§£ä¸ºæ¶ˆæ¯æœ‰æ•ˆè½½è·å­—èŠ‚æ•°ç»„çš„æœ€å¤§é•¿åº¦é™åˆ¶ï¼Œ0è¡¨ç¤ºæ— ä¸Šé™ã€‚ prefetchCountï¼šé¢„è¯»å–çš„æ¶ˆæ¯æ•°é‡ä¸Šé™ï¼Œ0è¡¨ç¤ºæ— ä¸Šé™ã€‚ globalï¼šfalseè¡¨ç¤ºprefetchCountå•ç‹¬åº”ç”¨äºä¿¡é“ä¸Šçš„æ¯ä¸ªæ–°æ¶ˆè´¹è€…ï¼Œtrueè¡¨ç¤ºprefetchCountåœ¨åŒä¸€ä¸ªä¿¡é“ä¸Šçš„æ¶ˆè´¹è€…å…±äº«ã€‚ é™åˆ¶å•ä¸ªæ¶ˆè´¹è€… 123456789public class BasicQosSingle extends BaseChannelFactory &#123; public static void main(String[] args) throws Exception &#123; provideChannel(channel -&gt; &#123; channel.basicQos(10); //åŸºäºæ¶ˆè´¹è€…è¿›è¡Œé™åˆ¶ channel.basicConsume(\"throwable.queue.direct\",new DefaultConsumer(channel)&#123;&#125;); &#125;); &#125;&#125; æ­¤æ¶ˆè´¹è€…æœ€å¤šåªèƒ½æœ‰10æ¡é¢„è¯»å–çš„æœªç¡®è®¤çš„æ¶ˆæ¯ã€‚ ç‹¬ç«‹é™åˆ¶å¤šä¸ªæ¶ˆè´¹è€… åŸºäºåŒä¸€ä¸ªä¿¡é“å¯¹å¤šä¸ªé˜Ÿåˆ—å»ºç«‹ä¸åŒçš„æ¶ˆè´¹è€…ï¼š 123456789101112public class BasicQosMulti extends BaseChannelFactory &#123; public static void main(String[] args) throws Exception &#123; provideChannel(channel -&gt; &#123; DefaultConsumer consumer1 = new DefaultConsumer(channel) &#123;&#125;; DefaultConsumer consumer2 = new DefaultConsumer(channel) &#123;&#125;; channel.basicQos(10); //åŸºäºæ¶ˆè´¹è€…è¿›è¡Œé™åˆ¶ channel.basicConsume(\"throwable.queue.direct\",consumer1); channel.basicConsume(\"throwable.queue.fanout\",consumer2); &#125;); &#125;&#125; æ¯ä¸ªè´¹è€…æœ€å¤šåªèƒ½æœ‰10æ¡é¢„è¯»å–çš„æœªç¡®è®¤çš„æ¶ˆæ¯ã€‚ åŸºäºå…±äº«é™åˆ¶å¤šä¸ªæ¶ˆè´¹è€… AMQPè§„èŒƒæ²¡æœ‰è§£é‡Šå¦‚æœä½¿ç”¨ä¸åŒçš„globalå¤šæ¬¡è°ƒç”¨basic.qosä¼šå‘ç”Ÿä»€ä¹ˆï¼ŒRabbitMQå°†æ­¤è§£é‡Šä¸ºæ„å‘³ç€ä¸¤ä¸ªé¢„å–é™åˆ¶åº”è¯¥å½¼æ­¤ç‹¬ç«‹åœ°å¼ºåˆ¶æ‰§è¡Œã€‚ 12345678910111213public class BasicQosShare extends BaseChannelFactory &#123; public static void main(String[] args) throws Exception &#123; provideChannel(channel -&gt; &#123; DefaultConsumer consumer1 = new DefaultConsumer(channel) &#123;&#125;; DefaultConsumer consumer2 = new DefaultConsumer(channel) &#123;&#125;; channel.basicQos(10, false); //åŸºäºæ¶ˆè´¹è€…è¿›è¡Œé™åˆ¶ channel.basicQos(15, true); //åŸºäºä¿¡é“è¿›è¡Œé™åˆ¶ channel.basicConsume(\"throwable.queue.direct\",consumer1); channel.basicConsume(\"throwable.queue.fanout\",consumer2); &#125;); &#125;&#125; ä¸Šé¢çš„ä»£ç è¡¨ç¤ºï¼š ä¸¤ä¸ªæ¶ˆè´¹è€…consumer1å’Œconsumer2åŸºäºä¿¡é“æœ€å¤šåªèƒ½æœ‰15æ¡æœªç¡®è®¤çš„é¢„è¯»å–æ¶ˆæ¯ã€‚ æ¶ˆè´¹è€…consumer1å’Œconsumer2è‡ªèº«æœ€å¤šåªèƒ½æœ‰10æ¡æœªç¡®è®¤çš„é¢„è¯»å–æ¶ˆæ¯ã€‚ ä¹Ÿå°±æ˜¯æœ‰åŒé‡é™åˆ¶ï¼Œè¿™ç§é™åˆ¶éœ€è¦ä¿¡é“å’Œé˜Ÿåˆ—ä¹‹é—´åè°ƒï¼Œä¼šè€—è´¹é¢å¤–çš„æ€§èƒ½ã€‚ æ¶ˆæ¯é¢„è¯»å–çš„æ„ä¹‰ æ¶ˆæ¯é¢„è¯»å–å¯ä»¥ç†è§£ä¸ºRabbitMQ BrokeræŠŠæœªç¡®è®¤çš„æ¶ˆæ¯æ‰¹é‡æ¨é€åˆ°RabbitMQçš„Javaå®¢æˆ·ç«¯ä¸­ï¼Œç”±å®¢æˆ·ç«¯å…ˆç¼“å­˜è¿™äº›æ¶ˆæ¯ï¼Œç„¶åæŠ•é€’åˆ°æ¶ˆè´¹è€…ä¸­ã€‚è¯•æƒ³ï¼Œå¦‚æœåœ¨æ¨æ¨¡å¼ä¸‹ï¼Œæ²¡æœ‰æ¶ˆæ¯é¢„è¯»å–åŠŸèƒ½ï¼ŒRabbitMQ Brokeræ¯æ¬¡æŠ•é€’ä¸€æ¡æ¶ˆæ¯åˆ°å®¢æˆ·ç«¯æ¶ˆè´¹è€…ä¸­ï¼Œè¿™æ ·å°±ä¼šäº§ç”Ÿå¤§é‡çš„IOæ“ä½œï¼Œå¯¼è‡´æ€§èƒ½ä¸‹é™ï¼Œæ­¤å¤–ï¼Œæ¶ˆè´¹è€…å¤„ç†é€Ÿåº¦æœ‰å¯èƒ½æ¯”è¾ƒå¿«ï¼Œå®¹æ˜“äº§ç”Ÿæ¶ˆè´¹è€…é¥¥é¥¿çš„æƒ…å†µã€‚å¯ä»¥æ ¹æ®æ¶ˆè´¹è€…å®é™…çš„æ¶ˆè´¹é€Ÿåº¦å’Œæ¶ˆæ¯å‘å¸ƒçš„é€Ÿåº¦ï¼Œå¯¹æ¶ˆè´¹è€…çš„é¢„è¯»å–æœªç¡®è®¤æ¶ˆæ¯çš„ä¸Šé™è¿›è¡Œé…ç½®ï¼Œè¿™æ ·åœ¨å¤§å¤šæ•°åœºæ™¯ä¸‹å¯ä»¥æé«˜æ¶ˆè´¹è€…çš„æ€§èƒ½ã€‚","categories":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/categories/Middleware/"},{"name":"RabbitMQ","slug":"Middleware/RabbitMQ","permalink":"http://throwable.club/blog/categories/Middleware/RabbitMQ/"}],"tags":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/tags/Middleware/"},{"name":"RabbitMQ","slug":"RabbitMQ","permalink":"http://throwable.club/blog/tags/RabbitMQ/"}]},{"title":"RabbitMQæ‰©å±•ä¹‹æ¶ˆè´¹è€…å–æ¶ˆé€šçŸ¥","slug":"rabbitmq-extension-confirm-cancel","date":"2018-11-28T15:00:07.000Z","updated":"2018-11-28T15:03:26.340Z","comments":true,"path":"2018/11/28/rabbitmq-extension-confirm-cancel/","link":"","permalink":"http://throwable.club/2018/11/28/rabbitmq-extension-confirm-cancel/","excerpt":"","text":"å‰æ æœ¬æ–‡æ¥æºäºå®˜æ–¹æ–‡æ¡£Consumer Cancel Notificationã€‚ æ¶ˆè´¹è€…å–æ¶ˆé€šçŸ¥ å½“ä¸€ä¸ªä¿¡é“ä¸Šå»ºç«‹çš„æ¶ˆè´¹è€…è®¢é˜…äº†ä¸€ä¸ªé˜Ÿåˆ—ï¼Œæœ‰å¯èƒ½å‡ºç°å„ç§åŸå› å¯¼è‡´æ¶ˆè´¹åœæ­¢ã€‚ä¸€ä¸ªå¾ˆæ˜æ˜¾çš„åŸå› å°±æ˜¯å®¢æˆ·ç«¯åœ¨åŒä¸€ä¸ªä¿¡é“ä¸Šå‘å‡ºbasic.cancelå‘½ä»¤ï¼Œæ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†å“åº”basic.cancel-okï¼Œå°†ä¼šå¯¼è‡´æ¶ˆè´¹è€…è¢«å–æ¶ˆã€‚è¿˜æœ‰å…¶ä»–çš„äº‹ä»¶å¦‚é˜Ÿåˆ—çš„åˆ é™¤æˆ–è€…é›†ç¾¤æ–¹æ¡ˆæ‰€åœ¨é˜Ÿåˆ—çš„é›†ç¾¤èŠ‚ç‚¹å¤±è´¥ä¹Ÿæœ‰å¯èƒ½å¯¼è‡´æ¶ˆè´¹è€…è¢«å–æ¶ˆï¼Œæ¶ˆè´¹è€…è¢«å–æ¶ˆè¿™ä¸ªäº‹ä»¶å¹¶ä¸ä¼šé€šçŸ¥å®¢æˆ·ç«¯å¯¹åº”çš„ä¿¡é“ï¼Œè¿™æ ·å­ä¼šé€ æˆå®¢æˆ·ç«¯æ— æ³•æ„ŸçŸ¥æ¶ˆè´¹è€…è¢«å–æ¶ˆã€‚ ä¸ºäº†é¿å…ä¸Šé¢è¿™äº›æƒ…å†µå‡ºç°ï¼ŒRabbitMQå¼•å…¥äº†æ‰©å±•ç‰¹æ€§ï¼šç”±äºæ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†å‡ºç°çš„å¼‚å¸¸æˆ–è€…æ­£å¸¸æƒ…å†µå¯¼è‡´æ¶ˆè´¹è€…å–æ¶ˆï¼Œä¼šå‘å¯¹åº”çš„æ¶ˆè´¹è€…(ä¿¡é“)å‘é€basic.cancelï¼Œä½†æ˜¯ç”±å®¢æˆ·ç«¯ä¿¡é“ä¸»åŠ¨å‘æ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†å‘é€basic.cancelä»¥å–æ¶ˆæ¶ˆè´¹è€…çš„æƒ…å†µä¸‹ä¸ä¼šå—åˆ°æ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†çš„basic.cancelå›å¤ã€‚ æœ‰äº›æƒ…å†µä¸‹ï¼Œå®¢æˆ·ç«¯æ„ŸçŸ¥åˆ°å¼‚å¸¸(ä¾‹å¦‚é˜Ÿåˆ—åˆ é™¤ç­‰)ä¸»åŠ¨å‘æ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†å‘é€basic.cancelï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†ä¹Ÿæœ‰å¯èƒ½å› ä¸ºé˜Ÿåˆ—åˆ é™¤ä¸»åŠ¨å‘å¯¹åº”çš„æ¶ˆè´¹è€…(ä¿¡é“)å‘é€basic.cancelï¼Œä¹Ÿå°±æ˜¯å­˜åœ¨ç«äº‰ï¼ŒRabbitMQä»£ç†æ”¶åˆ°å‰è€…çš„basic.cancelæ—¶ä¸ä¼šå‡ºç°å¼‚å¸¸ï¼ŒåŸºäºåè€…è¿˜æ˜¯æ­£å¸¸å›å¤basic.cancel-okã€‚ ä¸¾ä¸ªä¾‹å­ï¼Œæƒ…å†µä¸€ï¼šä¾‹å¦‚æˆ‘ä»¬ä¸»åŠ¨å–æ¶ˆä¿¡é“ä¸Šçš„æ¶ˆè´¹è€…ï¼š 123456789101112public class InitiativeBasicCancel extends BaseChannelFactory &#123; public static void main(String[] args) throws Exception &#123; provideChannel(channel -&gt; &#123; // æ­¤æ–¹æ³•è¿”å›çš„æ˜¯æ¶ˆè´¹è€…çš„æ ‡ç­¾ String consumerTag = channel.basicConsume(\"throwable.queue.direct\", new DefaultConsumer(channel) &#123; &#125;); channel.basicCancel(consumerTag); &#125;); &#125;&#125; æƒ…å†µäºŒï¼šå‡å¦‚æˆ‘ä»¬æƒ³ç›‘å¬æ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†å¼‚æ­¥å›è°ƒçš„basic.cancelå’Œbasic.cancel-okï¼Œåº”è¯¥è¿™æ ·åšï¼š 12345678910111213141516171819public class AsyncBasicCancel extends BaseChannelFactory &#123; public static void main(String[] args) throws Exception &#123; provideChannel(channel -&gt; &#123; channel.basicConsume(\"throwable.queue.direct\", new DefaultConsumer(channel) &#123; @Override public void handleCancelOk(String consumerTag) &#123; System.out.println(\"æ”¶åˆ°æ¥è‡ªæ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†çš„basic.cancel-okå›å¤,consumerTag=\" + consumerTag); &#125; @Override public void handleCancel(String consumerTag) throws IOException &#123; System.out.println(\"æ”¶åˆ°æ¥è‡ªæ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†çš„basic.cancelå›å¤,consumerTag=\" + consumerTag); &#125; &#125;); &#125;); &#125;&#125; ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬åº”è¯¥åŒæ—¶è€ƒè™‘æƒ…å†µä¸€å’Œæƒ…å†µäºŒæœ‰å¯èƒ½åŒæ—¶å‘ç”Ÿ(ä¹Ÿå°±æ˜¯å‰é¢è¯´åˆ°çš„ç«äº‰)ï¼Œå¹¶ä¸”åšå¥½ç›¸åº”çš„å¤„ç†å³å¯ã€‚","categories":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/categories/Middleware/"},{"name":"RabbitMQ","slug":"Middleware/RabbitMQ","permalink":"http://throwable.club/blog/categories/Middleware/RabbitMQ/"}],"tags":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/tags/Middleware/"},{"name":"RabbitMQ","slug":"RabbitMQ","permalink":"http://throwable.club/blog/tags/RabbitMQ/"}]},{"title":"RabbitMQæ¶ˆæ¯å‘é€ã€æ¶ˆè´¹å’Œç¡®è®¤","slug":"rabbitmq-send-consume-confirm","date":"2018-11-25T14:06:08.000Z","updated":"2018-11-25T14:13:55.422Z","comments":true,"path":"2018/11/25/rabbitmq-send-consume-confirm/","link":"","permalink":"http://throwable.club/2018/11/25/rabbitmq-send-consume-confirm/","excerpt":"","text":"å‰æ å‰ä¸€ç¯‡æ–‡ç« ä»‹ç»åˆ°RabbitMQç›¸å…³ç»„ä»¶çš„å£°æ˜ï¼Œç»„ä»¶å£°æ˜å®Œæˆä¹‹åï¼Œå°±å¯ä»¥å‘é€æ¶ˆæ¯å’Œæ¶ˆè´¹æ¶ˆæ¯ï¼Œæ¶ˆè´¹æ¶ˆæ¯çš„æ—¶å€™éœ€è¦è€ƒè™‘æ¶ˆæ¯çš„ç¡®è®¤ã€‚ æ¶ˆæ¯çš„å‘é€ æ¶ˆæ¯çš„å‘é€åªä¾èµ–äºäº¤äº’å™¨(åç§°)ã€å¯é€‰è·¯ç”±é”®å’Œå¯é€‰çš„Headerå‚æ•°ï¼Œå¯é€‰è·¯ç”±é”®å’ŒHeaderå¯ä»¥è®¤ä¸ºæ˜¯è·¯ç”±å‚æ•°ã€‚å› ä¸ºRabbitMQæœ‰å››ç§å†…å»ºçš„äº¤æ¢å™¨ï¼ŒåŠ ä¸Šç‰¹æ®Šçš„é»˜è®¤äº¤æ¢å™¨å¯ä»¥è®¤ä¸ºæœ‰äº”ç§ï¼Œè¿™é‡Œåˆ—ä¸¾ä¸€ä¸‹é€šè¿‡è¿™äº”ç§äº¤æ¢å™¨å‘é€æ¶ˆæ¯éœ€è¦çš„å‚æ•°ï¼š äº¤æ¢å™¨ç±»å‹ è·¯ç”±å‚æ•° é»˜è®¤äº¤æ¢å™¨(AMQP default) äº¤æ¢å™¨åç§°(ç©ºå­—ç¬¦ä¸²)å’Œé˜Ÿåˆ—åç§° Directäº¤æ¢å™¨ äº¤æ¢å™¨åç§°å’Œè·¯ç”±é”® Fanoutäº¤æ¢å™¨ äº¤æ¢å™¨åç§°(APIä¸­å¿…é¡»æä¾›è·¯ç”±é”®ï¼Œå¯ä»¥éšæ„è¾“å…¥) Topicäº¤æ¢å™¨ äº¤æ¢å™¨åç§°å’Œè·¯ç”±é”® Headersäº¤æ¢å™¨ äº¤æ¢å™¨åç§°å’ŒHeaderå‚æ•°(APIä¸­å¿…é¡»æä¾›è·¯ç”±é”®ï¼Œå¯ä»¥éšæ„è¾“å…¥) æ¶ˆæ¯çš„å‘å¸ƒä¾èµ–äºChannelçš„basicPublishæ–¹æ³•ï¼ŒæŒ‰ç…§æƒ¯ä¾‹æŸ¥çœ‹å…¶é‡è½½æ–¹æ³•ä¸­å‚æ•°åˆ—è¡¨é•¿åº¦æœ€å¤§çš„æ–¹æ³•ï¼š 123456void basicPublish(String exchange, String routingKey, boolean mandatory, boolean immediate, BasicProperties props, byte[] body) throws IOException; exchangeï¼šäº¤æ¢å™¨åç§°ã€‚ routingKeyï¼šè·¯ç”±é”®ã€‚ mandatoryï¼šæ˜¯å¦å¼ºåˆ¶çš„ï¼Œå¦‚æœæ­¤å±æ€§è®¾ç½®ä¸ºtrueï¼Œæ¶ˆæ¯å‘å¸ƒçš„æ—¶å€™å¦‚æœæ ¹æ®exchangeå’ŒroutingKeyæ— æ³•æ‰¾åˆ°å¯è¾¾çš„ç›®æ ‡é˜Ÿåˆ—ï¼Œä¼šè°ƒç”¨AMQPæ–¹æ³•basic.returnå°†è¯¥æ¶ˆæ¯è¿”å›ç»™æ¶ˆæ¯å‘å¸ƒè€…ï¼›å¦‚æœæ­¤å±æ€§è®¾ç½®ä¸ºfalseï¼Œå‡ºç°ä¸Šé¢çš„æƒ…å†µï¼Œæ¶ˆæ¯ä¼šè¢«æ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†ç›´æ¥ä¸¢å¼ƒã€‚ immediateï¼šæ˜¯å¦ç«‹å³çš„ï¼Œå¦‚æœæ­¤å±æ€§è®¾ç½®ä¸ºtrueï¼Œæ¶ˆæ¯é€šè¿‡exchangeå’ŒroutingKeyæ‰¾åˆ°ç›®æ ‡é˜Ÿåˆ—(ä¸€ä¸ªæˆ–è€…å¤šä¸ª)ï¼Œå¦‚æœæ‰€æœ‰çš„ç›®æ ‡é˜Ÿåˆ—éƒ½æ²¡æœ‰æ¶ˆè´¹è€…ï¼Œé‚£ä¹ˆä¼šè°ƒç”¨AMQPæ–¹æ³•basic.returnå°†è¯¥æ¶ˆæ¯è¿”å›ç»™æ¶ˆæ¯å‘å¸ƒè€…ã€‚ propsï¼šBasicPropertiesç±»å‹ï¼Œæ¶ˆæ¯å±æ€§æˆ–è€…å«æ¶ˆæ¯å…ƒæ•°æ®ï¼Œcom.rabbitmq.client.MessagePropertieså·²ç»æä¾›äº†ä¸€äº›åˆ—çš„å®ç°ï¼Œå¦‚æœä¸æ»¡è¶³å¯ä»¥ä½¿ç”¨BasicProperties.Builderè‡ªè¡Œæ„å»ºã€‚ bodyï¼šå­—èŠ‚æ•°ç»„ç±»å‹ï¼Œæ¶ˆæ¯çš„æœ‰æ•ˆè´Ÿè½½ï¼Œä¸€èˆ¬æˆ‘ä»¬è¯´çš„æ¶ˆæ¯æˆ–è€…æ¶ˆæ¯ä½“å°±æ˜¯æŒ‡è¿™ä¸ªã€‚ å€¼å¾—æ³¨æ„çš„æ˜¯ï¼šimmediateå±æ€§åœ¨RabbitMQ-3.0ç‰ˆæœ¬å·²ç»è¢«ç§»é™¤ï¼Œå…·ä½“åŸå› æ˜¯ï¼š ç¿»è¯‘ä¸€ä¸‹å°±æ˜¯ï¼šimmediateå±æ€§åŸæœ‰çš„åŠŸèƒ½å¯¹äºåŸºç¡€ä»£ç çš„å¤æ‚æ€§å¤ªé«˜ï¼Œç‰¹åˆ«æ˜¯åœ¨é•œåƒé˜Ÿåˆ—çš„æ¡ä»¶ä¸‹ã€‚å®ƒè¿˜å½±å“åˆ°é•œåƒé˜Ÿåˆ—çš„æ€§èƒ½ä¼˜åŒ–ï¼Œæ¨èä½¿ç”¨TTL(Time To Liveï¼Œé˜Ÿåˆ—æ¶ˆæ¯è¿‡æœŸç‰¹æ€§)æˆ–è€…DLX(Dead Letter Exchangeï¼Œæ­»ä¿¡äº¤æ¢å™¨)æ›¿ä»£ã€‚åœ¨RabbitMQ-3.0åçš„ç‰ˆæœ¬å¦‚æœimmediateè®¾ç½®ä¸ºtrueï¼Œä¼šæŠ›å¼‚å¸¸ã€‚ ä¸¾ä¸ªæ¶ˆæ¯å‘é€çš„ä¾‹å­(ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œæ¯æ¬¡å‘é€ä¹‹å‰éƒ½å£°æ˜äº¤æ¢å™¨ã€é˜Ÿåˆ—å’Œç»‘å®šï¼Œå®é™…ä¸Šæˆ‘ä»¬ä¸éœ€è¦è¿™æ ·æ“ä½œï¼Œå¦‚æœä¾èµ–äºServletå®¹å™¨ï¼Œå¯ä»¥åœ¨å®¹å™¨å¯åŠ¨ä¹‹ååšä¸€æ¬¡å£°æ˜å³å¯)ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950public class MessageSendMain extends BaseChannelFactory &#123; private static final String DEFAULT_EXCHANGE = \"\"; public static void main(String[] args) throws Exception &#123; provideChannel(channel -&gt; &#123; //ä½¿ç”¨Directç±»å‹çš„äº¤æ¢å™¨ channel.queueDeclare(\"throwable.queue.direct\", true, false, false, null); channel.exchangeDeclare(\"throwable.exchange.direct\", BuiltinExchangeType.DIRECT, true, false, null); channel.queueBind(\"throwable.queue.direct\", \"throwable.exchange.direct\", \"direct.routingKey\", null); //å‘é€\"Direct Message\"åˆ°é˜Ÿåˆ—throwable.queue.direct channel.basicPublish(\"throwable.exchange.direct\", \"direct.routingKey\", MessageProperties.TEXT_PLAIN, \"Direct Message\".getBytes(StandardCharsets.UTF_8)); //å…¶å®ä¹Ÿå¯ä»¥é€šè¿‡é»˜è®¤çš„äº¤æ¢å™¨ç›´æ¥å‘é€æ¶ˆæ¯åˆ°é˜Ÿåˆ—throwable.queue.direct channel.basicPublish(DEFAULT_EXCHANGE, \"throwable.queue.direct\", MessageProperties.TEXT_PLAIN, \"Direct Message\".getBytes(StandardCharsets.UTF_8)); //ä½¿ç”¨Fanoutç±»å‹çš„äº¤æ¢å™¨ channel.queueDeclare(\"throwable.queue.fanout\", true, false, false, null); channel.exchangeDeclare(\"throwable.exchange.fanout\", BuiltinExchangeType.FANOUT, true, false, null); //è¿™é‡Œè·¯ç”±é”®éšä¾¿å†™ï¼Œæˆ–è€…ç”¨ç©ºå­—ç¬¦ä¸²ä¹Ÿå¯ä»¥ channel.queueBind(\"throwable.queue.fanout\", \"throwable.exchange.fanout\", \"random\", null); channel.basicPublish(\"throwable.exchange.fanout\", \"random\", MessageProperties.TEXT_PLAIN, \"Fanout Message\".getBytes(StandardCharsets.UTF_8)); //ä½¿ç”¨Topicç±»å‹çš„äº¤æ¢å™¨ channel.queueDeclare(\"throwable.queue.topic\", true, false, false, null); channel.exchangeDeclare(\"throwable.exchange.topic\", BuiltinExchangeType.TOPIC, true, false, null); channel.queueBind(\"throwable.queue.topic\", \"throwable.exchange.topic\", \"topic.routingKey.#\", null); channel.basicPublish(\"throwable.exchange.topic\", \"topic.routingKey.throwable\", MessageProperties.TEXT_PLAIN, \"Topic Message\".getBytes(StandardCharsets.UTF_8)); //ä½¿ç”¨Headersç±»å‹çš„äº¤æ¢å™¨ channel.queueDeclare(\"throwable.queue.headers\", true, false, false, null); channel.exchangeDeclare(\"throwable.exchange.headers\", BuiltinExchangeType.HEADERS, true, false, null); Map&lt;String, Object&gt; headerBindingArgs = new HashMap&lt;&gt;(8); headerBindingArgs.put(\"headers.name\", \"throwable\"); headerBindingArgs.put(\"headers.age\", 25); headerBindingArgs.put(\"x-match\", \"all\"); //è¿™é‡Œè·¯ç”±é”®éšä¾¿å†™ï¼Œæˆ–è€…ç”¨ç©ºå­—ç¬¦ä¸²ä¹Ÿå¯ä»¥,è¦æ·»åŠ Headerså‚æ•°åˆ°ç»‘å®šå‚æ•°ä¸­ channel.queueBind(\"throwable.queue.headers\", \"throwable.exchange.headers\", \"random\", headerBindingArgs); AMQP.BasicProperties basicProperties = MessageProperties.TEXT_PLAIN; //è¿™é‡Œå‘é€æ¶ˆæ¯çš„æ—¶å€™è¦æ·»åŠ Headerså‚æ•°åˆ°æ¶ˆæ¯å±æ€§ä¸­ AMQP.BasicProperties realBasicProperties = basicProperties.builder().headers(headerBindingArgs).build(); channel.basicPublish(\"throwable.exchange.headers\", \"random\", realBasicProperties, \"Headers Message\".getBytes(StandardCharsets.UTF_8)); &#125;); &#125;&#125; æ¶ˆæ¯çš„å…ƒæ•°æ® æ¶ˆæ¯å…ƒæ•°æ®æ¥å£æ˜¯com.rabbitmq.client.BasicPropertiesï¼Œå®ç°ç±»æ˜¯com.rabbitmq.client.AMQP$BasicPropertiesï¼Œå¯ä»¥çœ‹ä¸€ä¸‹å…·ä½“çš„å±æ€§ï¼š 123456789101112131415161718public static class BasicProperties extends com.rabbitmq.client.impl.AMQBasicProperties &#123; private String contentType; private String contentEncoding; private Map&lt;String,Object&gt; headers; private Integer deliveryMode; private Integer priority; private String correlationId; private String replyTo; private String expiration; private String messageId; private Date timestamp; private String type; private String userId; private String appId; private String clusterId; //çœç•¥Setterã€Getterå’ŒBuilderæ–¹æ³•&#125; å±æ€§åˆ†æï¼š contentTypeï¼šæ¶ˆæ¯å†…å®¹ç±»å‹ï¼Œç±»ä¼¼äºHTTPåè®®ä¸­çš„Content-Typeï¼Œä¾‹å¦‚ï¼šapplication/jsonã€‚ contentEncodingï¼šæ¶ˆæ¯å†…å®¹ç¼–ç ï¼Œç±»ä¼¼äºMIMEçš„å†…å®¹ç¼–ç ï¼Œä¾‹å¦‚ï¼šgzipã€‚ headersï¼šå¤´éƒ¨å±æ€§ï¼ŒK-Vç»“æ„ï¼Œä¸€èˆ¬ä½¿ç”¨åœ¨Headersçš„äº¤æ¢å™¨å’Œç»‘å®šä¸­ï¼Œå¾ˆå¤šæ—¶å€™è¢«å¼€å‘è€…æ»¥ç”¨ç”¨æ¥ä¼ è¾“ä¸€äº›è‡ªå®šä¹‰å±æ€§ï¼Œå…¶å®ä¹Ÿæ— å¯åšéã€‚ deliveryModeï¼šæ¶ˆæ¯çš„æŒä¹…åŒ–æ¨¡å¼ï¼ŒdeliveryMode=1ä»£è¡¨æ¶ˆæ¯ä¸æŒä¹…åŒ–(nonpersistent)ï¼ŒdeliveryMode=2ä»£è¡¨æ¶ˆæ¯æŒä¹…åŒ–(persistent)ã€‚ priorityï¼šæ¶ˆæ¯ä¼˜å…ˆçº§ï¼Œå¯é€‰å€¼ä¸º0-255ï¼Œå€¼è¶Šå¤§ä¼˜å…ˆçº§è¶Šå¤§ï¼Œæ³¨æ„è¦å’Œé˜Ÿåˆ—çš„ä¼˜å…ˆçº§åŒºåˆ†ã€‚ correlationIdï¼šå®¢æˆ·ç«¯å®šä¹‰çš„ç”¨äºå®¢æˆ·ç«¯åŒºåˆ†å’Œæ ‡è¯†æ¶ˆæ¯çš„å”¯ä¸€æ ‡è®°ã€‚ replyToï¼šéœ€è¦åº”ç­”çš„ç›®æ ‡é˜Ÿåˆ—åï¼Œåªæœ‰ä¸€ä¸ªæŒæœ‰å€¼ï¼Œä¸ä¼šæœ‰ä»»ä½•é¢å¤–çš„æ“ä½œï¼Œspring-amqpæ¨¡å—å¯¹è¿™ä¸ªå€¼åšäº†é¢å¤–çš„æ“ä½œï¼Œä¸è¦æ··æ·†åŸç”ŸJavaé©±åŠ¨å’ŒäºŒæ¬¡å°è£…çš„æ¡†æ¶ã€‚ expirationï¼šæ¶ˆæ¯è¿‡æœŸæ—¶é—´ï¼Œå•ä½ä¸ºæ¯«ç§’ã€‚ messageIdï¼šæ¶ˆæ¯çš„å”¯ä¸€æ ‡è¯†ï¼Œæ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†å¯¹æ¶ˆæ¯æ¥æ”¶å»é‡çš„ä¸€ä¸ªé‡è¦æ ‡è¯†ã€‚ timestampï¼šæ¶ˆæ¯å‘é€æ—¶çš„æ—¶é—´æˆ³ã€‚ typeï¼šå¯é€‰çš„æ¶ˆæ¯ç±»å‹ã€‚ userIdï¼šå¯é€‰çš„å‘å¸ƒæ¶ˆæ¯çš„ç”¨æˆ·çš„å”¯ä¸€æ ‡è¯†ã€‚ appIdï¼šå¯é€‰çš„å‘å¸ƒæ¶ˆæ¯çš„åº”ç”¨çš„å”¯ä¸€æ ‡è¯†ã€‚ clusterIdï¼šé›†ç¾¤å”¯ä¸€æ ‡è¯†ï¼ŒAMQP-0-9-1å·²ç»å¼ƒç”¨ï¼Œä¾›RabbitMQé›†ç¾¤åº”ç”¨ç¨‹åºä½¿ç”¨çš„é›†ç¾¤å†…è·¯ç”±æ ‡è¯†ç¬¦ã€‚ æ¶ˆæ¯å…ƒæ•°æ®çš„æ¯ä¸ªå±æ€§åŸºæœ¬å¯¹åº”ç€AMQPè§„èŒƒä¸­çš„å±æ€§å€¼ï¼Œä»¥ä¸Šçš„æè¿°æ¥æºäºAMQPåè®®ï¼ŒRabbitMQä¸­çš„å®ç°è¦è‡ªè¡Œå®è·µç›¸å…³çš„å±æ€§ã€‚com.rabbitmq.client.MessagePropertiesä¸­å·²ç»æœ‰å‡ ä¸ªç°æˆçš„BasicPropertieså®ä¾‹ï¼Œå¦‚æœåˆé€‚çš„è¯å¯ä»¥ç›´æ¥æ‹¿è¿‡æ¥ä½¿ç”¨ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455public class MessageProperties &#123; /** Empty basic properties, with no fields set */ public static final BasicProperties MINIMAL_BASIC = new BasicProperties(null, null, null, null, null, null, null, null, null, null, null, null, null, null); /** Empty basic properties, with only deliveryMode set to 2 (persistent) */ public static final BasicProperties MINIMAL_PERSISTENT_BASIC = new BasicProperties(null, null, null, 2, null, null, null, null, null, null, null, null, null, null); /** Content-type \"application/octet-stream\", deliveryMode 1 (nonpersistent), priority zero */ public static final BasicProperties BASIC = new BasicProperties(\"application/octet-stream\", null, null, 1, 0, null, null, null, null, null, null, null, null, null); /** Content-type \"application/octet-stream\", deliveryMode 2 (persistent), priority zero */ public static final BasicProperties PERSISTENT_BASIC = new BasicProperties(\"application/octet-stream\", null, null, 2, 0, null, null, null, null, null, null, null, null, null); /** Content-type \"text/plain\", deliveryMode 1 (nonpersistent), priority zero */ public static final BasicProperties TEXT_PLAIN = new BasicProperties(\"text/plain\", null, null, 1, 0, null, null, null, null, null, null, null, null, null); /** Content-type \"text/plain\", deliveryMode 2 (persistent), priority zero */ public static final BasicProperties PERSISTENT_TEXT_PLAIN = new BasicProperties(\"text/plain\", null, null, 2, 0, null, null, null, null, null, null, null, null, null);&#125; mandatoryå±æ€§çš„ä½œç”¨ mandatoryå±æ€§ä¸»è¦æ˜¯ç”¨äºæ¶ˆæ¯å‘é€è·¯ç”±å¤±è´¥åé…ç½®æ¶ˆæ¯è¿”å›(return)åŠŸèƒ½ä½¿ç”¨ï¼Œå¯ä»¥æ•…æ„é€ ä¸€ä¸‹æ¶ˆæ¯å‘å¸ƒè·¯ç”±å¤±è´¥çš„åœºæ™¯ï¼ŒéªŒè¯ä¸€ä¸‹mandatoryå±æ€§çš„ä½œç”¨ã€‚ä¹‹å‰çš„ä¾‹å­ä¸­æ›¾ç»å»ºç«‹è¿‡ä¸€ä¸ªDirectç±»å‹çš„äº¤æ¢throwable.exchange.directå’Œé˜Ÿåˆ—throwable.queue.directåŸºäºè·¯ç”±é”®direct.routingKeyè¿›è¡Œäº†ç»‘å®šï¼Œæˆ‘ä»¬å¼€å¯mandatoryç‰¹æ€§ï¼Œæ•…æ„æŠŠè·¯ç”±é”®å¼„é”™ï¼Œçœ‹æ•ˆæœï¼š 12345678910111213141516171819202122232425262728public class MandatoryMain extends BaseChannelFactory &#123; public static void main(String[] args) throws Exception &#123; provideChannel(channel -&gt; &#123; channel.basicPublish(\"throwable.exchange.direct\", \"doge\", true, false, null, \"Mandatory Message\".getBytes(StandardCharsets.UTF_8)); //ä½¿ç”¨addReturnListener(ReturnCallBack)ä¹Ÿå¯ä»¥ channel.addReturnListener(new ReturnListener() &#123; @Override public void handleReturn(int replyCode, String replyText, String exchange, String routingKey, AMQP.BasicProperties properties, byte[] body) throws IOException &#123; StringBuilder builder = new StringBuilder(); builder.append(\"è¿”å›ç :\").append(replyCode).append(\"\\n\"); builder.append(\"è¿”å›ä¿¡æ¯:\").append(replyText).append(\"\\n\"); builder.append(\"äº¤æ¢å™¨:\").append(exchange).append(\"\\n\"); builder.append(\"è·¯ç”±é”®:\").append(routingKey).append(\"\\n\"); builder.append(\"æ¶ˆæ¯ä½“:\").append(new String(body, StandardCharsets.UTF_8)); System.out.println(builder.toString()); &#125; &#125;); //å› ä¸ºæ˜¯å¼‚æ­¥å›è°ƒ,è¿™é‡Œè¦sleepä¸€ä¸‹ Thread.sleep(2000); &#125;); &#125;&#125; æ‰§è¡Œä¹‹åï¼Œæ§åˆ¶å°æ‰“å°ï¼š 12345è¿”å›ç :312è¿”å›ä¿¡æ¯:NO_ROUTEäº¤æ¢å™¨:throwable.exchange.directè·¯ç”±é”®:dogeæ¶ˆæ¯ä½“:Mandatory Message å¯è§è·¯ç”±å¤±è´¥çš„æ¶ˆæ¯ç›´æ¥åŸæ ·è¿”å›ï¼Œè¿™æ ·å°±èƒ½ç¡®ä¿è·¯ç”±é”™è¯¯çš„æƒ…å†µä¸‹æ¶ˆæ¯ä¹Ÿä¸ä¼šä¸¢å¤±ã€‚ æ¶ˆæ¯å‘é€çš„ç¡®è®¤æœºåˆ¶ å‰é¢æåˆ°çš„mandatoryå±æ€§å’Œæ¶ˆæ¯è¿”å›æœºåˆ¶èƒ½ä¿è¯è·¯ç”±å¤±è´¥çš„æ¶ˆæ¯ä¹Ÿä¸ä¸¢å¤±ï¼Œå®é™…ä¸Šæ¶ˆæ¯å‘é€çš„æ—¶å€™å…è®¸ä½¿ç”¨æ¶ˆæ¯å‘é€ç¡®è®¤(Confirm)æœºåˆ¶ï¼Œè¿™æ ·å¯ä»¥ç¡®è®¤å®¢æˆ·ç«¯å‘é€çš„æ¶ˆæ¯æ˜¯å¦å·²ç»åˆ°è¾¾äº†æ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†ã€‚æ¶ˆæ¯å‘é€çš„ç¡®è®¤æœºåˆ¶ä¸»è¦åŒ…æ‹¬è½»é‡çº§çš„ç¡®è®¤å’Œæ¶ˆæ¯äº‹åŠ¡ï¼Œè¿™ä¸€å°èŠ‚ä»‹ç»ä¸€ä¸‹è½»é‡çº§çš„ç¡®è®¤ã€‚æ¶ˆæ¯å‘é€çš„è½»é‡çº§ç¡®è®¤éœ€è¦æŠŠä¿¡é“(Channel)æ›´å˜ä¸ºConfirmæ¨¡å¼ï¼Œé€šè¿‡ç­‰å¾…æ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†æ¶ˆæ¯æ˜¯å¦åˆ°è¾¾çš„ç¡®è®¤å›è°ƒï¼Œä¾èµ–åˆ°çš„æ–¹æ³•æˆ–è€…ç±»å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223//ä¿¡é“æ›´å˜ä¸ºConfirmæ¨¡å¼Confirm.SelectOk confirmSelect() throws IOException;//ç­‰å¾…æ¶ˆæ¯ä¸­é—´ä»¶ç¡®è®¤æ¶ˆæ¯åˆ°è¾¾ - åŒæ­¥é˜»å¡æ³•æ³•boolean waitForConfirms() throws InterruptedException;//ç­‰å¾…æ¶ˆæ¯ä¸­é—´ä»¶ç¡®è®¤æ¶ˆæ¯åˆ°è¾¾ï¼Œå¯ä»¥è®¾ç½®è¶…æ—¶ï¼Œå•ä½æ¯«ç§’ - åŒæ­¥é˜»å¡æ–¹æ³•boolean waitForConfirms(long timeout) throws InterruptedException, TimeoutException;//ç­‰å¾…æ¶ˆæ¯ä¸­é—´ä»¶ç¡®è®¤æ¶ˆæ¯åˆ°è¾¾ï¼Œå­˜åœ¨ä»»ä¸€æ¶ˆæ¯æœªåˆ°è¾¾ï¼Œåˆ™æŠ›å‡ºIOException - åŒæ­¥é˜»å¡æ–¹æ³•void waitForConfirmsOrDie() throws IOException, InterruptedException;//ç­‰å¾…æ¶ˆæ¯ä¸­é—´ä»¶ç¡®è®¤æ¶ˆæ¯åˆ°è¾¾ï¼Œå¯ä»¥è®¾ç½®è¶…æ—¶ï¼Œå•ä½æ¯«ç§’ï¼Œå­˜åœ¨ä»»ä¸€æ¶ˆæ¯æœªåˆ°è¾¾ï¼Œåˆ™æŠ›å‡ºIOException - åŒæ­¥é˜»å¡æ–¹æ³•void waitForConfirmsOrDie(long timeout) throws IOException, InterruptedException, TimeoutException;//æ¶ˆæ¯å‘å¸ƒç¡®è®¤å›è°ƒæ¥å£public interface ConfirmListener &#123; void handleAck(long deliveryTag, boolean multiple) throws IOException; void handleNack(long deliveryTag, boolean multiple) throws IOException;&#125; æ¶ˆæ¯å‘é€ç¡®è®¤æ¨¡å¼å¼€å¯ä¹‹åï¼Œæ¯æ¡æ¶ˆæ¯éƒ½ä¼šåŸºäºåŒä¸€ä¸ªä¿¡é“ä¸‹æ–°å¢ä¸€ä¸ªæŠ•é€’æ ‡ç­¾(deliveryTag)å±æ€§ï¼ŒdeliveryTagå±æ€§æ˜¯ä»1å¼€å§‹é€’å¢çš„æ•´æ•°ï¼Œåªè¦æ–°å»ºä¸€ä¸ªä¿¡é“å®ä¾‹å°±ä¼šé‡ç½®ä¸º1ï¼Œä¸€å®šè¦ååˆ†æ³¨æ„ï¼Œè¿™ä¸ªæ¶ˆæ¯æŠ•é€’æ ‡ç­¾å’Œæ¶ˆæ¯æ¶ˆè´¹ä¸­çš„ä¿¡å°(Envelope)ä¸­çš„deliveryTagä¸æ˜¯åŒä¸€ä¸ªå±æ€§ï¼Œåè€…è™½ç„¶ä¹Ÿæ˜¯ä»1å¼€å§‹é€’å¢ï¼Œä½†æ˜¯å®ƒæ˜¯åŸºäºé˜Ÿåˆ—è€Œä¸æ˜¯ä¿¡é“ã€‚ä¸¾ä¸ªç®€å•çš„ä½¿ç”¨ä¾‹å­ï¼š 123456789101112131415161718192021222324252627public class ConfirmMain extends BaseChannelFactory &#123; public static void main(String[] args) throws Exception &#123; provideChannel(channel -&gt; &#123; channel.addConfirmListener(new ConfirmListener() &#123; @Override public void handleAck(long deliveryTag, boolean multiple) throws IOException &#123; System.out.println(String.format(\"æ¶ˆæ¯å‘é€ç¡®è®¤å›è°ƒæˆåŠŸ,åºå·:%s,æ˜¯å¦æ‰¹é‡:%s\", deliveryTag, multiple)); &#125; @Override public void handleNack(long deliveryTag, boolean multiple) throws IOException &#123; System.out.println(String.format(\"æ¶ˆæ¯å‘é€ç¡®è®¤å›è°ƒå¤±è´¥,åºå·:%s,æ˜¯å¦æ‰¹é‡:%s\", deliveryTag, multiple)); &#125; &#125;); channel.confirmSelect(); channel.basicPublish(\"throwable.exchange.direct\", \"direct.routingKey\", MessageProperties.TEXT_PLAIN, \"Direct Message\".getBytes(StandardCharsets.UTF_8)); if (!channel.waitForConfirms()) &#123; System.out.println(\"æ¶ˆæ¯å‘é€ç¡®è®¤å¤±è´¥!\"); &#125; else &#123; System.out.println(\"æ¶ˆæ¯å‘é€ç¡®è®¤æˆåŠŸ!\"); &#125; Thread.sleep(2000); &#125;); &#125;&#125; æ¶ˆæ¯å‘å¸ƒç¡®è®¤åŸºæœ¬ä¸Šæ˜¯éµå¾ªä¸‹é¢çš„ä»£ç æ¨¡æ¿ï¼š 12345678channel.addConfirmListener(new ConfirmListener() &#123; //...&#125;;channel.confirmSelect();channel.basicPublish();if (!channel.waitForConfirms()) &#123; //...&#125; å½“ç„¶ï¼Œè¿™é‡Œæ¼”ç¤ºçš„ä»…ä»…æ˜¯å•æ¡çš„æ¶ˆæ¯å‘å¸ƒç¡®è®¤ï¼Œè¿™ç§åšæ³•æ€§èƒ½ä¼šç›¸å¯¹ä½ä¸‹ï¼Œä½†æ˜¯å¯é æ€§ä¼šæé«˜ï¼Œç¼–ç éš¾åº¦ä¹Ÿç›¸å¯¹æ¯”è¾ƒä½ã€‚ æ¶ˆæ¯å‘å¸ƒäº‹åŠ¡ æ¶ˆæ¯å‘å¸ƒäº‹åŠ¡èƒ½å¤Ÿä¿è¯æ¶ˆæ¯å‘å¸ƒåˆ°RabbitMQçš„Brokerè¿™ä¸ªåŠ¨ä½œæ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼Œä¹Ÿå°±æ˜¯å¼€å¯äº†æ¶ˆæ¯å‘å¸ƒäº‹åŠ¡æ¨¡å¼ï¼Œæ¶ˆæ¯èƒ½æ˜ç¡®çŸ¥é“å‘å¸ƒæˆåŠŸæˆ–è€…å¤±è´¥ã€‚ä½¿ç”¨æ¶ˆæ¯å‘å¸ƒäº‹åŠ¡éœ€è¦æŠŠä¿¡é“è½¬æ¢ä¸ºäº‹åŠ¡æ¨¡å¼ï¼Œç„¶åè¿›è¡Œæ¶ˆæ¯å‘å¸ƒå’Œäº‹åŠ¡æäº¤(æˆ–è€…å›æ»š)ï¼Œä¾èµ–äºä¸‹é¢çš„æ–¹æ³•ï¼š 12345678//ä¿¡é“è½¬æ¢ä¸ºäº‹åŠ¡æ¨¡å¼Tx.SelectOk txSelect() throws IOException;//æäº¤äº‹åŠ¡Tx.CommitOk txCommit() throws IOException;//å›æ»šäº‹åŠ¡Tx.RollbackOk txRollback() throws IOException; æ¶ˆæ¯å‘å¸ƒäº‹åŠ¡çš„åŸºæœ¬ä»£ç æ¨¡æ¿å¦‚ä¸‹ï¼š 1234567try &#123; channel.txSelect(); channel.basicPublish(); channel.txCommit(); &#125;catch (Exception e)&#123; channel.txRollback(); &#125; ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼š 123456789101112131415public class MessagePublishTxMain extends BaseChannelFactory &#123; public static void main(String[] args) throws Exception &#123; provideChannel(channel -&gt; &#123; try &#123; channel.txSelect(); channel.basicPublish(\"throwable.exchange.direct\", \"direct.routingKey\", MessageProperties.TEXT_PLAIN, \"Direct Message\".getBytes(StandardCharsets.UTF_8)); channel.txCommit(); &#125; catch (Exception e) &#123; channel.txRollback(); &#125; &#125;); &#125;&#125; ä¸€èˆ¬æ¥è¯´ï¼Œäº‹ç‰©åŸºæœ¬æ˜¯éµå¾ª&quot;ç­‰ä»·äº¤æ¢çš„åŸåˆ™&quot;ï¼Œæ¶ˆæ¯å‘å¸ƒçš„å¯é æ€§æ˜¯éœ€è¦æ€§èƒ½æ¢å–çš„ï¼Œæ¶ˆæ¯å‘å¸ƒäº‹åŠ¡çš„å¯é æ€§æ˜¯æœ€é«˜çš„ï¼Œä½†æ˜¯ä»£ä»·æ˜¯å®ƒçš„æ€§èƒ½æ˜¯æ¯”è¾ƒä½çš„ã€‚ æ¶ˆæ¯çš„æ¶ˆè´¹ æ¶ˆæ¯æ¶ˆè´¹ä¸»è¦åŒ…æ‹¬æ¨æ¨¡å¼å’Œæ‹‰æ¨¡å¼ï¼ŒåŒºåˆ«å¦‚ä¸‹ï¼š æ¨æ¨¡å¼ï¼šå®¢æˆ·ç«¯æ³¨å†Œæ¶ˆè´¹è€…åˆ°æ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†çš„é˜Ÿåˆ—ï¼Œä¹Ÿå°±æ˜¯å¯¹é˜Ÿåˆ—è¿›è¡Œè®¢é˜…ï¼Œæ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†é€šè¿‡é˜Ÿåˆ—æŠ•é€’(deliver)æ¶ˆæ¯åˆ°æ¶ˆè´¹è€…ä¸­ï¼Œå…¸å‹æ–¹æ³•æ˜¯basic-consumeã€‚ æ‹‰æ¨¡å¼ï¼šå®¢æˆ·ç«¯ä¸»åŠ¨å‘æ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†æ‹‰å–é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯ï¼Œå…¸å‹æ–¹æ³•æ˜¯basic-getã€‚ æ¶ˆæ¯æ¶ˆè´¹ä¹‹æ¨æ¨¡å¼ æ¨æ¨¡å¼ä¸‹ï¼Œæ¶ˆæ¯çš„æ¶ˆè´¹ä¾èµ–äºChannelçš„basicConsumeæ–¹æ³•(ç”¨çš„æ˜¯æœ€æ–°çš„RabbitMQçš„Javaé©±åŠ¨ï¼Œå…³äºæ¶ˆæ¯æ¶ˆè´¹çš„æ–¹æ³•æ–°å¢äº†ä¸å°‘ï¼Œåœ¨3.Xç‰ˆæœ¬åªæœ‰å‡ ä¸ªæ–¹æ³•)ï¼š 1234567891011121314151617String basicConsume(String queue, boolean autoAck, String consumerTag, boolean noLocal, boolean exclusive, Map&lt;String, Object&gt; arguments, Consumer callback) throws IOException;String basicConsume(String queue, boolean autoAck, String consumerTag, boolean noLocal, boolean exclusive, Map&lt;String, Object&gt; arguments, DeliverCallback deliverCallback, CancelCallback cancelCallback, ConsumerShutdownSignalCallback shutdownSignalCallback) throws IOException; åˆ«çœ‹ç¬¬äºŒä¸ªæ–¹æ³•çš„å‚æ•°åˆ—è¡¨å¾ˆåºå¤§å¾ˆå“äººï¼Œå®ƒåªæ˜¯æŠŠcom.rabbitmq.client.Consumeræ¥å£çš„éƒ¨åˆ†æ–¹æ³•æ‹†è§£å‡ºæ¥åšæˆå•ç‹¬çš„æ¥å£ï¼Œæ–¹ä¾¿ä½¿ç”¨Lambdaè¡¨è¾¾å¼ï¼Œå‚æ•°åˆ†æå¦‚ä¸‹ï¼š queueï¼šæ¶ˆè´¹è€…è®¢é˜…çš„é˜Ÿåˆ—åç§°ã€‚ autoAckï¼šæ˜¯å¦è‡ªåŠ¨ç¡®è®¤(ä¸»åŠ¨ack)ã€‚ consumerTagï¼šæ¶ˆè´¹è€…æ ‡ç­¾ï¼Œé˜Ÿåˆ—ä¸­æ¶ˆè´¹è€…çš„å”¯ä¸€æ ‡è¯†ï¼Œå¦‚æœä¸æŒ‡å®šåˆ™ç”±æ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†è‡ªåŠ¨ç”Ÿæˆï¼Œåœæ­¢æ¶ˆè´¹è€…å’Œå–æ¶ˆæ¶ˆè´¹è€…éƒ½æ˜¯åŸºäºæ­¤æ ‡è¯†å±æ€§ã€‚ noLocalï¼šæ˜¯å¦éæœ¬åœ°çš„ï¼Œå¦‚æœæ­¤å±æ€§ä¸ºtrueï¼Œåˆ™æ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†ä¸ä¼šæŠ•é€’æ¶ˆæ¯åˆ°æ­¤æ¶ˆè´¹è€…å¦‚æœå‘å¸ƒæ¶ˆæ¯ä½¿ç”¨çš„è¿æ¥å’Œå½“å‰æ¶ˆè´¹è€…å»ºç«‹çš„é€šé“æ‰€åœ¨çš„è¿æ¥æ˜¯åŒä¸€ä¸ªè¿æ¥ï¼Œä½†æ˜¯RabbitMQä¸æ”¯æŒæ­¤å±æ€§ã€‚ exclusiveï¼šæ˜¯å¦ç‹¬å (æ’ä»–)çš„ï¼Œå¦‚æœæ­¤å±æ€§ä¸ºtrueï¼Œé˜Ÿåˆ—ä¸­åªèƒ½æœ‰ä¸€ä¸ªæ¶ˆè´¹è€…(ä¹Ÿå°±æ˜¯å½“å‰è®¾ç½®äº†exclusive=trueçš„æ¶ˆè´¹è€…)ï¼Œæ¶ˆè´¹è€…å…³é—­(shutdown) argumentsï¼šæ¶ˆè´¹è€…å‚æ•°ï¼ŒK-Vç»“æ„ã€‚ ä¸‹é¢çœ‹ä¸€ä¸‹Consumerã€DeliverCallbackã€CancelCallbackå’ŒConsumerShutdownSignalCallbackçš„å®šä¹‰ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243public interface Consumer &#123; //åˆ›å»ºæ¶ˆè´¹è€…æˆåŠŸçš„å›è°ƒ void handleConsumeOk(String consumerTag); //æ¶ˆè´¹è€…å–æ¶ˆæˆåŠŸçš„å›è°ƒ - ä¸»åŠ¨è°ƒç”¨basicCancelæˆ–è€…é˜Ÿåˆ—åˆ é™¤ç­‰å› ç´  void handleCancelOk(String consumerTag); //æ¶ˆè´¹è€…å–æ¶ˆçš„å›è°ƒ - ä¸»åŠ¨è°ƒç”¨basicCancelæˆ–è€…é˜Ÿåˆ—åˆ é™¤ç­‰å› ç´  void handleCancel(String consumerTag) throws IOException; //æ¶ˆè´¹è€…å…³é—­çš„ä¿¡å·å›è°ƒ void handleShutdownSignal(String consumerTag, ShutdownSignalException sig); //AMQPæ–¹æ³•basic.recover-okçš„å›è°ƒ void handleRecoverOk(String consumerTag); //æ¶ˆæ¯æ¨æ¨¡å¼ä¸‹æ¥å—æ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†æŠ•é€’çš„æ¶ˆæ¯ - æ ¸å¿ƒæ–¹æ³• void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException;&#125;@FunctionalInterfacepublic interface DeliverCallback &#123; //Deliveryä¸­æŒæœ‰äº†Envelopeã€AMQP.BasicPropertieså’Œæ¶ˆæ¯ä½“body void handle(String consumerTag, Delivery message) throws IOException;&#125;@FunctionalInterfacepublic interface CancelCallback &#123; void handle(String consumerTag) throws IOException;&#125;@FunctionalInterfacepublic interface ConsumerShutdownSignalCallback &#123; void handleShutdownSignal(String consumerTag, ShutdownSignalException sig); &#125; DeliverCallbackã€CancelCallbackå’ŒConsumerShutdownSignalCallbackå®é™…ä¸Šå°±æ˜¯æŠŠConsumeræ¥å£ä¸­çš„éƒ¨åˆ†æ–¹æ³•æŠ½ç¦»å‡ºæ¥ç¼–å†™ä¸ºå‡½æ•°å¼æ¥å£ï¼Œæ²¡æœ‰ç‰¹åˆ«çš„ä¸œè¥¿ï¼Œæ‰€ä»¥æˆ‘ä»¬è¿˜æ˜¯å…³æ³¨Consumeræ¥å£çš„ä½¿ç”¨å°±å¯ä»¥äº†ã€‚Consumeræ¥å£æœ‰ä¸€ä¸ªé»˜è®¤çš„å®ç°ç±»DefaultConsumerï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ã€‚åœ¨æ—§ç‰ˆæœ¬çš„Javaé©±åŠ¨ä¸­è¿˜å­˜åœ¨ä¸€ä¸ªåºŸå¼ƒçš„QueueingConsumerï¼Œåœ¨5.Xç‰ˆæœ¬çš„é©±åŠ¨å·²ç»åˆ é™¤è¯¥ç±»ã€‚å…¶å®ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªè¡Œå®ç°Consumeræ¥å£ï¼Œå› ä¸ºDefaultConsumerä¹Ÿä»…ä»…æ˜¯å¯¹Consumeræ¥å£è¿›è¡Œäº†ç©ºå®ç°ï¼Œå…·ä½“çš„æ–¹æ³•è¿˜æ˜¯éœ€è¦æˆ‘ä»¬è¦†ç›–å®ç°è‡ªå®šä¹‰çš„é€»è¾‘ã€‚è¿™é‡Œä¸¾ä¸ªç®€å•çš„ä½¿ç”¨ä¾‹å­ï¼š 123456789101112131415161718192021public class ConsumeMain extends BaseChannelFactory &#123; public static void main(String[] args) throws Exception &#123; provideChannel(channel -&gt; &#123; channel.basicConsume(\"throwable.queue.direct\", true, new DefaultConsumer(channel) &#123; @Override public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException &#123; System.out.println(\"æ¶ˆæ¯åºå·:\" + envelope.getDeliveryTag()); System.out.println(\"äº¤æ¢å™¨:\" + envelope.getExchange()); System.out.println(\"è·¯ç”±é”®:\" + envelope.getRoutingKey()); System.out.println(\"æ¶ˆæ¯å†…å®¹:\" + new String(body, StandardCharsets.UTF_8)); &#125; &#125;); //æ¶ˆæ¯æ¶ˆè´¹æ˜¯å¼‚æ­¥çš„ï¼Œè¦æƒ³åŠæ³•é˜»å¡æ¶ˆè´¹è€…æ‰€åœ¨çš„çº¿ç¨‹å’Œä¸»çº¿ç¨‹ï¼Œå¦åˆ™ä¼šé€€å‡º Thread.sleep(Integer.MAX_VALUE); &#125;); &#125;&#125; å¯ä»¥ä»Webç®¡ç†ç•Œé¢çœ‹åˆ°æ¶ˆè´¹è€…å·²ç»å¯åŠ¨ï¼Œæ¶ˆè´¹è€…æ ‡ç­¾æ˜¯ç”±RabbitMQä»£ç†éšæœºç”Ÿæˆçš„ï¼Œæˆ‘ä»¬å¼€å¯äº†æ¶ˆæ¯è‡ªåŠ¨ç¡®è®¤ï¼Œæ‰€ä»¥Ack requiredä¸€æ æ˜¯ç©ºå¿ƒçš„åœ†å½¢ï¼Œä¹Ÿå°±æ˜¯ä¸éœ€è¦è¿›è¡Œæ¶ˆæ¯æ¶ˆè´¹ç¡®è®¤ã€‚è¿˜æœ‰ä¸€ç‚¹éœ€è¦æ³¨æ„çš„æ˜¯ï¼šConsumeræ¥å£çš„å›è°ƒä¹Ÿå°±æ˜¯DefaultConsumerä¸­çš„æ–¹æ³•å›è°ƒæ˜¯å§”æ‰˜åˆ°RabbitMQçš„Javaé©±åŠ¨ä¸­çš„çº¿ç¨‹æ± æ‰§è¡Œï¼Œè¿‡ç¨‹æ˜¯å¼‚æ­¥çš„ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬åœ¨å†™Demoçš„æ—¶å€™éœ€è¦æƒ³åŠæ³•æŒ‚èµ·DefaultConsumerå®ä¾‹æ‰€åœ¨çš„çº¿ç¨‹å’Œä¸»çº¿ç¨‹ï¼Œå¦åˆ™ä¼šå¯¼è‡´çº¿ç¨‹é€€å‡ºæ— æ³•æ¶ˆè´¹æ¶ˆæ¯ã€‚ æ¶ˆæ¯æ¶ˆè´¹ä¹‹æ‹‰æ¨¡å¼ æ‹‰æ¨¡å¼ä¸‹ï¼Œæ¶ˆæ¯æ¶ˆè´¹ä¸»è¦ä¾èµ–äºChannelçš„basicGetæ–¹æ³•ï¼š 1GetResponse basicGet(String queue, boolean autoAck) throws IOException; æ­¤æ–¹æ³•å¾ˆç®€å•ï¼Œåªä¾èµ–äºé˜Ÿåˆ—åç§°å’Œæ˜¯å¦è‡ªåŠ¨ç¡®è®¤ä¸¤ä¸ªå‚æ•°ï¼Œå¦‚æœautoAckä¸ºfalseï¼Œéœ€è¦æ‰‹åŠ¨ç¡®è®¤ã€‚è¿”å›å€¼å¦‚ä¸‹ï¼š 123456789101112public class GetResponse &#123; //ä¿¡å°å¯¹è±¡ï¼Œä¸»è¦ç”¨äºè·å–æ¶ˆæ¯çš„æŠ•é€’æ ‡ç­¾DeliveryTagã€äº¤æ¢å™¨ã€è·¯ç”±é”®ç­‰ private final Envelope envelope; //æ¶ˆæ¯å…ƒæ•°æ® private final BasicProperties props; //æ¶ˆæ¯ä½“ private final byte[] body; //å½“å‰é˜Ÿåˆ—ä¸­å‰©ä½™æ¶ˆæ¯æ•°é‡ï¼Œåªæ˜¯ä¸ªå‚è€ƒå€¼ private final int messageCount; //çœç•¥Getteræ–¹æ³•&#125; ä¿¡å°å¯¹è±¡ä¸­çš„æŠ•é€’æ ‡ç­¾DeliveryTagå¾ˆé‡è¦ï¼Œç”¨äºæ‰‹åŠ¨ç¡®è®¤çš„æ—¶å€™æŒ‡å®šå¯¹åº”çš„å€¼ã€‚ä¸¾ä¸ªç®€å•çš„ä½¿ç”¨ä¾‹å­ï¼š 12345678910public class BasicGetMain extends BaseChannelFactory&#123; public static void main(String[] args) throws Exception&#123; provideChannel(channel -&gt; &#123; GetResponse getResponse = channel.basicGet(\"throwable.queue.direct\", true); System.out.println(String.format(\"æ¶ˆæ¯å†…å®¹:%s,æ¶ˆæ¯åºå·:%s\", new String(getResponse.getBody(), StandardCharsets.UTF_8), getResponse.getEnvelope().getDeliveryTag())); &#125;); &#125;&#125; æ¶ˆæ¯æ¶ˆè´¹çš„ç¡®è®¤æœºåˆ¶ æ¶ˆæ¯æ¶ˆè´¹çš„ç¡®è®¤æœºåˆ¶ä¿éšœæ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†çš„æ¶ˆæ¯æˆåŠŸæŠ•é€’åˆ°æ¶ˆè´¹è€…ä¸­ï¼Œä¸»è¦åŒ…æ‹¬ä¸‰ç§ç±»ç¡®è®¤ï¼š ä¸»åŠ¨ç§¯æç¡®è®¤ï¼šä¸»åŠ¨ç§¯æç¡®è®¤æˆåŠŸåï¼Œæ¶ˆæ¯ä¼šä»é˜Ÿåˆ—ä¸­ç§»é™¤ï¼Œæ”¯æŒæ‰¹é‡ç¡®è®¤æ“ä½œï¼Œå…¸å‹æ–¹æ³•æ˜¯basic-ackï¼Œä¸‹é¢ç›´æ¥å«ackã€‚ ä¸»åŠ¨æ¶ˆæç¡®è®¤ï¼šæ¶ˆæç§¯æç¡®è®¤æˆåŠŸåï¼ŒåŸºäºbasic-getæˆ–è€…basic-consumeç­‰åˆ°çš„æ¶ˆæ¯æ ‡ç­¾ï¼Œå¯ä»¥é€‰æ‹©æ¶ˆæ¯é‡æ–°å…¥é˜Ÿåˆ—æˆ–è€…ç›´æ¥ä¸¢å¼ƒï¼Œæ”¯æŒæ‰¹é‡æ“ä½œï¼Œå…¸å‹æ–¹æ³•æ˜¯basic-nackï¼Œä¸‹é¢ç›´æ¥å«nackã€‚ æ‹’ç»ï¼šåŸºäºbasic-getæˆ–è€…basic-consumeç­‰åˆ°çš„æ¶ˆæ¯æ ‡ç­¾è¿›è¡Œæ¶ˆæ¯æ‹’ç»ï¼Œå¯ä»¥é€‰æ‹©ä¸¢å¼ƒæˆ–è€…é‡æ–°å…¥é˜Ÿï¼Œä¸‹é¢å«åšrejectã€‚ nackå’Œrejectçš„åŸºæœ¬åŠŸèƒ½æ˜¯ç›¸åŒçš„ï¼ŒnackåŒæ—¶æ”¯æŒæ‰¹é‡æ“ä½œå’Œå•æ¡æ“ä½œï¼Œè€Œrejectåªæ”¯æŒå•æ¡æ“ä½œã€‚æ¶ˆæ¯æ¶ˆè´¹ç¡®è®¤å…¶å®æ˜¯æ‰‹åŠ¨ç¡®è®¤ï¼Œå¦‚æœé’ˆå¯¹çš„æ˜¯basicConsumeæ–¹æ³•ï¼Œåˆ™å…¶autoAckå±æ€§éœ€è¦è®¾ç½®ä¸ºfalseï¼Œå¦åˆ™æœ‰å¯èƒ½ä¼šå‡ºç°é‡å¤ç¡®è®¤å¯¼è‡´å¼‚å¸¸ã€‚ ack ackä¾èµ–äºChannelçš„basicAckæ–¹æ³•ï¼š 1void basicAck(long deliveryTag, boolean multiple) throws IOException; deliveryTagï¼šEnvelope(ä¿¡å°)å¯¹è±¡ä¸­çš„æ¶ˆæ¯æ ‡ç­¾ã€‚ multipleï¼šæ˜¯å¦ä½¿ç”¨æ‰¹é‡ç§¯æç¡®è®¤ï¼Œå¦‚æœæ­¤å±æ€§ä¸ºtrueï¼Œåˆ™æ¶ˆæ¯æ ‡ç­¾å°äºå½“å‰deliveryTagçš„æ‰€æœ‰æ¶ˆæ¯éƒ½ä¼šè¢«ä¸»åŠ¨ç§¯æç¡®è®¤ï¼Œä¸äº†è§£æ­¤å±æ€§æœ€å¥½ä½¿ç”¨falseã€‚ 1234567891011121314151617181920212223public class AckMain extends BaseChannelFactory &#123; public static void main(String[] args) throws Exception &#123; provideChannel(channel -&gt; &#123; //è¿™é‡ŒautoAckè®¾ç½®ä¸ºfalse channel.basicConsume(\"throwable.queue.direct\", false, new DefaultConsumer(channel) &#123; @Override public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException &#123; System.out.println(\"æ¶ˆæ¯åºå·:\" + envelope.getDeliveryTag()); System.out.println(\"äº¤æ¢å™¨:\" + envelope.getExchange()); System.out.println(\"è·¯ç”±é”®:\" + envelope.getRoutingKey()); System.out.println(\"æ¶ˆæ¯å†…å®¹:\" + new String(body, StandardCharsets.UTF_8)); channel.basicAck(envelope.getDeliveryTag(), false); &#125; &#125;); //æ¶ˆæ¯æ¶ˆè´¹æ˜¯å¼‚æ­¥çš„ï¼Œè¦æƒ³åŠæ³•é˜»å¡æ¶ˆè´¹è€…æ‰€åœ¨çš„çº¿ç¨‹å’Œä¸»çº¿ç¨‹ï¼Œå¦åˆ™ä¼šé€€å‡º Thread.sleep(Integer.MAX_VALUE); &#125;); &#125;&#125; nack nackä¾èµ–äºChannelçš„basicNackæ–¹æ³•ï¼š 1void basicNack(long deliveryTag, boolean multiple, boolean requeue) throws IOException; deliveryTagï¼šEnvelope(ä¿¡å°)å¯¹è±¡ä¸­çš„æ¶ˆæ¯æ ‡ç­¾ã€‚ multipleï¼šæ˜¯å¦ä½¿ç”¨æ‰¹é‡æ¶ˆæç¡®è®¤ï¼Œå¦‚æœæ­¤å±æ€§ä¸ºtrueï¼Œåˆ™æ¶ˆæ¯æ ‡ç­¾å°äºå½“å‰deliveryTagçš„æ‰€æœ‰æ¶ˆæ¯éƒ½ä¼šè¢«ä¸»åŠ¨æ¶ˆæç¡®è®¤ï¼Œä¸äº†è§£æ­¤å±æ€§æœ€å¥½ä½¿ç”¨falseã€‚ requeueï¼šæ˜¯å¦é‡æ–°å…¥é˜Ÿï¼Œå¦‚æœæ­¤å±æ€§ä¸ºtrueï¼Œæ¶ˆæ¯ä¼šè¢«é‡æ–°æ”¾ç½®å›å»å¯¹åº”é˜Ÿåˆ—(å¦‚æœå¯èƒ½çš„è¯ï¼Œä¼šæ”¾å›åˆ°åŸæ¥çš„ä½ç½®)ï¼Œå¦‚æœæ­¤å±æ€§ä¸ºfalseï¼Œæ¶ˆæ¯ç›´æ¥è¢«ä¸¢å¼ƒã€‚ 1234567891011121314151617181920212223public class NackMain extends BaseChannelFactory &#123; public static void main(String[] args) throws Exception &#123; provideChannel(channel -&gt; &#123; //è¿™é‡ŒautoAckè®¾ç½®ä¸ºfalse channel.basicConsume(\"throwable.queue.direct\", false, new DefaultConsumer(channel) &#123; @Override public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException &#123; System.out.println(\"æ¶ˆæ¯åºå·:\" + envelope.getDeliveryTag()); System.out.println(\"äº¤æ¢å™¨:\" + envelope.getExchange()); System.out.println(\"è·¯ç”±é”®:\" + envelope.getRoutingKey()); System.out.println(\"æ¶ˆæ¯å†…å®¹:\" + new String(body, StandardCharsets.UTF_8)); channel.basicNack(envelope.getDeliveryTag(), false, false); &#125; &#125;); //æ¶ˆæ¯æ¶ˆè´¹æ˜¯å¼‚æ­¥çš„ï¼Œè¦æƒ³åŠæ³•é˜»å¡æ¶ˆè´¹è€…æ‰€åœ¨çš„çº¿ç¨‹å’Œä¸»çº¿ç¨‹ï¼Œå¦åˆ™ä¼šé€€å‡º Thread.sleep(Integer.MAX_VALUE); &#125;); &#125;&#125; å±æ€§requeueå¦‚æœè®¾ç½®ä¸ºtrueï¼Œéœ€è¦è°¨æ…è®¾è®¡ç¨‹åºçš„é€»è¾‘ï¼Œå¦åˆ™å¾ˆæœ‰å¯èƒ½å¯¼è‡´æ¶ˆæ¯ä¸€ç›´é‡å¤æ¶ˆè´¹å¤±è´¥å¹¶ä¸”é‡å¤é‡æ–°å…¥é˜Ÿï¼Œè¡¨ç°ä¸ºæ¶ˆè´¹è€…çº¿ç¨‹å‡ºç°æ­»å¾ªç¯é€»è¾‘ï¼Œè€—å°½æœåŠ¡å™¨CPUèµ„æºã€‚ reject rejectçš„ç”¨æ³•å’ŒnackåŸºæœ¬ä¸€è‡´ï¼Œä¸è¿‡rejectæ²¡æœ‰æ‰¹é‡å¤„ç†åŠŸèƒ½ï¼Œä¾èµ–äºChannelçš„basicRejectæ–¹æ³•ï¼š 1void basicReject(long deliveryTag, boolean requeue) throws IOException; ç®€å•ä¸¾ä¸ªä½¿ç”¨ä¾‹å­ï¼š 123456789public class RejectMain extends BaseChannelFactory &#123; public static void main(String[] args) throws Exception &#123; provideChannel(channel -&gt; &#123; GetResponse getResponse = channel.basicGet(\"throwable.queue.direct\", true); channel.basicReject(getResponse.getEnvelope().getDeliveryTag(), false); &#125;); &#125;&#125; æ¶ˆè´¹æ¶ˆæ¯ä¸è¿›è¡Œæ¶ˆæ¯ç¡®è®¤ä¼šæ€ä¹ˆæ · æ¶ˆæ¯æ¶ˆè´¹æ–¹æ³•basiConsumeä¸­çš„autoAckå±æ€§è®¾ç½®ä¸ºfalseï¼Œä½†æ˜¯æ¶ˆè´¹è€…æ¥æ”¶åˆ°æ¶ˆæ¯åä¸è¿›è¡Œæ¶ˆæ¯ç¡®è®¤ä¼šæ€ä¹ˆæ ·ï¼Ÿä¸¾ä¸ªä¾‹å­ï¼š 123456789101112131415161718192021222324public class NoneAckMain extends BaseChannelFactory &#123; public static void main(String[] args) throws Exception &#123; provideChannel(channel -&gt; &#123; channel.basicPublish(\"throwable.exchange.direct\", \"direct.routingKey\", MessageProperties.TEXT_PLAIN, \"Direct Message\".getBytes(StandardCharsets.UTF_8)); //autoAck = false channel.basicConsume(\"throwable.queue.direct\", false, new DefaultConsumer(channel) &#123; @Override public void handleDelivery(String consumerTag, Envelope envelope, AMQP.BasicProperties properties, byte[] body) throws IOException &#123; System.out.println(\"æ¶ˆæ¯åºå·:\" + envelope.getDeliveryTag()); System.out.println(\"äº¤æ¢å™¨:\" + envelope.getExchange()); System.out.println(\"è·¯ç”±é”®:\" + envelope.getRoutingKey()); System.out.println(\"æ¶ˆæ¯å†…å®¹:\" + new String(body, StandardCharsets.UTF_8)); &#125; &#125;); //æ¶ˆæ¯æ¶ˆè´¹æ˜¯å¼‚æ­¥çš„ï¼Œè¦æƒ³åŠæ³•é˜»å¡æ¶ˆè´¹è€…æ‰€åœ¨çš„çº¿ç¨‹å’Œä¸»çº¿ç¨‹ï¼Œå¦åˆ™ä¼šé€€å‡º Thread.sleep(Integer.MAX_VALUE); &#125;); &#125;&#125; æ‰§è¡Œä¹‹åï¼Œæ§åˆ¶å°è¾“å‡ºï¼š 1234æ¶ˆæ¯åºå·:1äº¤æ¢å™¨:throwable.exchange.directè·¯ç”±é”®:direct.routingKeyæ¶ˆæ¯å†…å®¹:Direct Message æŸ¥çœ‹RabbitMQçš„Webç®¡ç†ç•Œé¢ï¼Œå‘ç°æ¶ˆæ¯ç”±Readyè½¬å˜ä¸ºUnackedçŠ¶æ€ï¼š å°è¯•ç»ˆæ­¢æ¶ˆè´¹è€…æ‰€åœ¨çº¿ç¨‹ï¼Œå†æ¬¡è§‚å¯ŸRabbitMQçš„Webç®¡ç†ç•Œé¢å¯¹åº”é˜Ÿåˆ—ï¼š å‘ç°æ¶ˆæ¯ç”±UnackedçŠ¶æ€æ¢å¤ä¸ºReadyã€‚è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œåªæœ‰ReadyçŠ¶æ€çš„æ¶ˆæ¯æ‰èƒ½è¢«æ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†æŠ•é€’åˆ°æ¶ˆè´¹è€…ã€‚æ€»çš„æ¥è¯´å°±æ˜¯ï¼š è¢«è·¯ç”±åˆ°é˜Ÿåˆ—çš„æ–°æ¶ˆæ¯çš„çŠ¶æ€ä¸ºReadyï¼Œè¿™ç§æ¶ˆæ¯å¯ä»¥è¢«æ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†æŠ•é€’åˆ°å®¢æˆ·ç«¯çš„æ¶ˆè´¹è€…ä¸­ã€‚ å®¢æˆ·ç«¯æ¶ˆè´¹è€…åœ¨æ¶ˆè´¹æ¶ˆæ¯çš„æ—¶å€™ï¼Œå¦‚æœé‡‡ç”¨æ‰‹åŠ¨ç¡®è®¤(autoAck=false)å¹¶ä¸”æ²¡æœ‰ä¸»åŠ¨ç¡®è®¤(ä¹Ÿå°±æ˜¯æ²¡æœ‰è°ƒç”¨basicAckã€basicNackæˆ–è€…basicReject)ï¼Œé‚£ä¹ˆæ¶ˆæ¯å°±ä¼šå˜ä¸ºUnackedçŠ¶æ€ï¼ŒUnackedçŠ¶æ€çš„æ¶ˆæ¯åªæœ‰å½“æ‰€æœ‰çš„æ¶ˆè´¹è€…çº¿ç¨‹ç»ˆæ­¢çš„æ—¶å€™ï¼Œæ‰ä¼šé‡æ–°è½¬å˜ä¸ºReadyçŠ¶æ€ã€‚ å°ç»“ è¿™ç¯‡æ–‡ç« ä»…ä»…ä»åŸºæœ¬ä½¿ç”¨æ¥åˆ†æRabbitMQä¸­çš„æ¶ˆæ¯å‘é€ã€æ¶ˆè´¹å’Œç¡®è®¤çš„ä¾‹å­ã€‚å…³äºæ¶ˆæ¯å‘å¸ƒç¡®è®¤æœºåˆ¶å’Œæ¶ˆæ¯å‘å¸ƒäº‹åŠ¡æœºåˆ¶åé¢æœ‰ä¸“é—¨çš„æ–‡ç« åˆ†æå…¶æ€§èƒ½å’Œå…·ä½“ä½¿ç”¨åœºæ™¯ã€‚ RabbitMQä¸­çš„æ¶ˆæ¯å‘å¸ƒç¡®è®¤(publish confirm)å’Œæ¶ˆæ¯æ¶ˆè´¹(æŠ•é€’)ç¡®è®¤(deliver confirm)èƒ½å¤Ÿç¡®ä¿æ¶ˆæ¯å‘å¸ƒå’Œæ¶ˆæ¯æ¶ˆè´¹é˜¶æ®µæ¶ˆæ¯ä¸ä¼šä¸¢å¤±ï¼Œè‡³äºç­–ç•¥åº”è¯¥æ ¹æ®å…·ä½“åœºæ™¯é€‰æ‹©ï¼ŒautoAckå¹¶ä¸é€‚åˆæ‰€æœ‰çš„åœºæ™¯ã€‚ (æœ¬æ–‡å®Œ c-2-d e-a-20181125)","categories":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/categories/Middleware/"},{"name":"RabbitMQ","slug":"Middleware/RabbitMQ","permalink":"http://throwable.club/blog/categories/Middleware/RabbitMQ/"}],"tags":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/tags/Middleware/"},{"name":"RabbitMQ","slug":"RabbitMQ","permalink":"http://throwable.club/blog/tags/RabbitMQ/"}]},{"title":"RabbitMQé˜Ÿåˆ—ã€äº¤æ¢å™¨å’Œç»‘å®šçš„æ“ä½œ","slug":"rabbitmq-component-operation","date":"2018-11-24T18:23:59.000Z","updated":"2018-11-24T18:26:00.922Z","comments":true,"path":"2018/11/25/rabbitmq-component-operation/","link":"","permalink":"http://throwable.club/2018/11/25/rabbitmq-component-operation/","excerpt":"","text":"å‰æ å¦‚æœèƒ½æå‰å…ˆé˜…è¯»ä¸€ä¸‹ä¹‹å‰å†™è¿‡çš„ä¸€ç¯‡æ–‡ç« ç†è§£RabbitMQä¸­çš„AMQP-0-9-1æ¨¡å‹ï¼Œé‚£ä¹ˆè¿™ç¯‡æ–‡ç« åº”è¯¥ä¼šæ¯”è¾ƒå®¹æ˜“ç†è§£ã€‚ å¼•å…¥ä¾èµ– å…ˆç¡®è®¤å·²ç»å®‰è£…äº†RabbitMQçš„æœåŠ¡ï¼Œå¹¶ä¸”å¼€å¯äº†Webç®¡ç†æ’ä»¶ï¼Œæ–¹ä¾¿ç›´æ¥ä»Webç®¡ç†ç•Œé¢æŸ¥æ‰¾åˆ°é˜Ÿåˆ—ã€äº¤æ¢å™¨å’Œç»‘å®šã€‚ä¸ªäººæœ‰è½¯ä»¶æ´ç™–ï¼Œå–œæ¬¢æŠŠè½¯ä»¶å’Œä¾èµ–ä¿æŒå‡çº§åˆ°æœ€æ–°ç‰ˆæœ¬ã€‚å¼•å…¥RabbitMQçš„Javaé©±åŠ¨ï¼š 12345&lt;dependency&gt; &lt;groupId&gt;com.rabbitmq&lt;/groupId&gt; &lt;artifactId&gt;amqp-client&lt;/artifactId&gt; &lt;version&gt;5.5.0&lt;/version&gt;&lt;/dependency&gt; æœ¬æ–‡ä»‹ç»RabbitMQé€šè¿‡å…¶Javaé©±åŠ¨å£°æ˜é˜Ÿåˆ—ã€äº¤æ¢å™¨å’Œç»‘å®šã€‚å¯¹äºé˜Ÿåˆ—å’Œäº¤æ¢å™¨ï¼Œå…¶é¦–æ¬¡å£°æ˜ä¹Ÿæ˜¯åˆ›å»ºçš„æ“ä½œã€‚é˜Ÿåˆ—ã€äº¤æ¢å™¨å’Œç»‘å®šçš„å£°æ˜ä¾èµ–äºé€šé“(Channel)ï¼Œå¯¹åº”çš„æ˜¯com.rabbitmq.client.Channelæ¥å£ã€‚åœ¨ä½¿ç”¨RabbitMQçš„Javaé©±åŠ¨çš„æ—¶å€™ï¼Œä¸€èˆ¬åœ¨æˆ‘ä»¬éƒ½ä½¿ç”¨ä¸‹é¢çš„æ–¹å¼è¿›è¡Œç»„ä»¶çš„å£°æ˜æ“ä½œï¼š 1ã€åŸºäºRabbitMQè¿æ¥ä¿¡æ¯æ„å»ºcom.rabbitmq.client.ConnectionFactoryå®ä¾‹ã€‚ 2ã€åŸºäºConnectionFactoryæ–°å»ºä¸€ä¸ªcom.rabbitmq.client.Connectionå®ä¾‹ã€‚ 3ã€åŸºäºConnectionæ–°å»ºä¸€ä¸ªcom.rabbitmq.client.Channelå®ä¾‹ã€‚ 4ã€é€šè¿‡Channelå®ä¾‹å£°æ˜(åˆ é™¤ã€è§£é™¤ç»‘å®š)é˜Ÿåˆ—ã€äº¤æ¢å™¨æˆ–è€…ç»‘å®š(Channelå®ä¾‹æ˜¯å¯ä»¥å¤ç”¨çš„)ã€‚ è™½ç„¶Channelå®ä¾‹æ˜¯å¯ä»¥å¤ç”¨çš„ï¼Œä½†æ˜¯ä¸ºäº†ç®€åŒ–æµ‹è¯•æ–¹æ³•çš„ç¼–å†™ï¼Œæˆ‘ä»¬å¯ä»¥å†™ä¸‹ä¸ªç®€å•çš„åŸºç¡€ç±»ï¼š 1234567891011121314151617181920212223public abstract class BaseChannelFactory &#123; protected static void provideChannel(ChannelAction channelAction) throws Exception &#123; ConnectionFactory connectionFactory = new ConnectionFactory(); connectionFactory.setHost(\"localhost\"); connectionFactory.setPort(5672); connectionFactory.setUsername(\"guest\"); connectionFactory.setPassword(\"guest\"); Connection connection = connectionFactory.newConnection(); Channel channel = connection.createChannel(); try &#123; channelAction.doInChannel(channel); &#125; finally &#123; channel.close(); connection.close(); &#125; &#125; interface ChannelAction &#123; void doInChannel(Channel channel) throws Exception; &#125;&#125; è¿™æ ·å­ï¼Œæ¯æ¬¡è°ƒç”¨éƒ½æ˜¯æ–°å»ºçš„Connectionå’ŒChannelï¼Œæˆ‘ä»¬åªéœ€è¦é‡ç‚¹å…³æ³¨ChannelActionçš„å®ç°å³å¯ã€‚ åœ¨æŸ¥çœ‹ä¸€ä¸‹æ¡†æ¶ç±»å‹çš„APIæ–‡æ¡£çš„æ—¶å€™æœ‰ä¸ªå¾ˆé‡è¦çš„æŠ€å·§ï¼šå¦‚æœæä¾›çš„æ–¹æ³•æœ‰é‡è½½ï¼Œåªéœ€è¦çœ‹å‚æ•°æœ€å¤šçš„åŸºç¡€æ–¹æ³•ã€‚ é˜Ÿåˆ—çš„ç›¸å…³æ“ä½œ é˜Ÿåˆ—çš„ç›¸å…³å‚æ•°ä¸»è¦åŒ…æ‹¬é˜Ÿåˆ—çš„å£°æ˜(declare)ã€åˆ é™¤(delete)å’Œæ¸…ç©ºé˜Ÿåˆ—æ¶ˆæ¯(purge)ã€‚ é˜Ÿåˆ—çš„å£°æ˜ é˜Ÿåˆ—çš„å£°æ˜ä¾èµ–äºcom.rabbitmq.client.Channelçš„queueDeclareæ–¹æ³•ã€‚queueDeclareæ–¹æ³•çš„å¤šä¸ªé‡è½½éƒ½æ˜¯åŒæ­¥æ–¹æ³•ï¼Œæä¾›åŒæ ·åŠŸèƒ½çš„è¿˜æœ‰ä¸€ä¸ªå¼‚æ­¥æ–¹æ³•queueDeclareNoWaitã€‚ä¸‹é¢é€‰å–queueDeclareå‚æ•°åˆ—è¡¨é•¿åº¦æœ€å¤§çš„æ–¹æ³•è¿›è¡Œåˆ†æï¼š 12345Queue.DeclareOk queueDeclare(String queue, boolean durable, boolean exclusive, boolean autoDelete, Map&lt;String, Object&gt; arguments) throws IOException; å‚æ•°å¦‚ä¸‹ï¼š queueï¼šéœ€è¦å£°æ˜çš„é˜Ÿåˆ—åç§°ã€‚ durableï¼šæ˜¯å¦å¼€å¯æŒä¹…åŒ–ç‰¹æ€§ï¼Œå¦‚æœæ­¤å±æ€§ä¸ºtrueï¼Œæ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†é‡å¯åé˜Ÿåˆ—ä¼šè¢«é‡æ–°å£°æ˜(ä¹Ÿå°±æ˜¯è¯´ä¸ä¼šè¢«åˆ é™¤)ï¼Œæ³¨æ„è¿™ä¸ªç‰¹æ€§å’Œæ¶ˆæ¯çš„æŒä¹…åŒ–ç‰¹æ€§å®Œå…¨ä¸ç›¸å…³ã€‚ exclusiveï¼šæ˜¯å¦ç‹¬å çš„ï¼Œå¦‚æœæ­¤å±æ€§ä¸ºtrueï¼Œåˆ™é˜Ÿåˆ—çš„å­˜åœ¨æ€§ç»‘å®šåœ¨åˆ›å»ºå®ƒçš„è¿æ¥ä¸Šï¼Œæ„å‘³ç€é˜Ÿåˆ—åªèƒ½è¢«ä¸€ä¸ªè¿æ¥ä½¿ç”¨å¹¶ä¸”è¿æ¥å…³é—­ä¹‹åé˜Ÿåˆ—ä¼šè¢«åˆ é™¤ã€‚ autoDeleteï¼šæ˜¯å¦è‡ªåŠ¨åˆ é™¤ï¼Œå¦‚æœæ­¤å±æ€§ä¸ºtrueï¼Œæ„å‘³ç€é˜Ÿåˆ—ä¸è¢«ä½¿ç”¨çš„æ—¶å€™ä¼šè¢«æ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†åˆ é™¤ï¼Œå®é™…ä¸Šæ„å‘³ç€é˜Ÿåˆ—è‡³å°‘æœ‰ä¸€ä¸ªæ¶ˆè´¹è€…å¹¶ä¸”æœ€åä¸€ä¸ªæ¶ˆè´¹è€…è§£é™¤è®¢é˜…çŠ¶æ€(ä¸€èˆ¬æ˜¯æ¶ˆè´¹è€…å¯¹åº”çš„é€šé“å…³é—­)åé˜Ÿåˆ—ä¼šè‡ªåŠ¨åˆ é™¤ã€‚ argumentsï¼šK-Vç»“æ„ï¼Œé˜Ÿåˆ—å‚æ•°ï¼Œä¸€èˆ¬å’Œæ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†æˆ–è€…æ’ä»¶çš„ç‰¹æ€§ç›¸å…³ï¼Œå¦‚æ¶ˆæ¯çš„è¿‡æœŸæ—¶é—´(Message TTL)å’Œé˜Ÿåˆ—é•¿åº¦ç­‰ï¼Œåé¢ä¼šæœ‰ä¸“é—¨æ–‡ç« ä»‹ç»è¿™äº›ç‰¹æ€§ã€‚ é˜Ÿåˆ—å£°æ˜çš„è¿”å›å€¼æ˜¯Queue.DeclareOkå®ä¾‹ï¼š 123456public interface DeclareOk extends Method &#123; String getQueue(); int getMessageCount(); int getConsumerCount(); //...&#125; å¯ä»¥ä»ä¸­å¾—çŸ¥å£°æ˜çš„é˜Ÿåˆ—åã€é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯æ•°é‡ã€é˜Ÿåˆ—å½“å‰çš„æ¶ˆè´¹è€…æ•°é‡ï¼Œè¿™ä¸ªè¿”å›å€¼å¯¹äºæ— å‚æ•°çš„queueDeclareæ–¹æ³•ååˆ†æœ‰æ„ä¹‰ï¼š 1Queue.DeclareOk queueDeclare() throws IOException; å› ä¸ºè¿™ä¸ªæ–¹æ³•å£°æ˜çš„é˜Ÿåˆ—åç§°æ˜¯ç”±æ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†éšæœºç”Ÿæˆï¼Œé˜Ÿåˆ—åå°±æ˜¯é€šè¿‡è¿”å›å€¼å‘ŠçŸ¥å®¢æˆ·ç«¯çš„ã€‚è¿™é‡Œè´´ä¸€ä¸ªç®€å•çš„ä¾‹å­ï¼š 123456789public class QueueDeclareMain extends BaseChannelFactory &#123; public static void main(String[] args) throws Exception &#123; provideChannel(channel -&gt; &#123; AMQP.Queue.DeclareOk declareOk = channel.queueDeclare(\"throwable.queue\", true, false, false, null); System.out.println(declareOk.getQueue()); &#125;); &#125;&#125; è¿è¡Œåæ§åˆ¶å°æ‰“å°throwable.queueè¯´æ˜é˜Ÿåˆ—å£°æ˜æˆåŠŸï¼Œå¯ä»¥æŸ¥çœ‹RabbitMQçš„Webç®¡ç†ç•Œé¢ï¼š å¯è§é˜Ÿåˆ—çš„ç¡®å·²ç»è¢«åˆ›å»ºï¼Œä½†æ˜¯Bindingsä¸€æ æ˜¾ç¤ºé˜Ÿåˆ—åªç»‘å®šåˆ°é»˜è®¤çš„äº¤æ¢å™¨ä¸­ï¼Œè¿™ä¸ªæ—¶å€™å…¶å®å·²ç»å¯ä»¥é€šè¿‡é»˜è®¤çš„äº¤æ¢å™¨å‘é˜Ÿåˆ—ä¸­å‘é€æ¶ˆæ¯ã€‚é˜Ÿåˆ—å£°æ˜å¤±è´¥çš„æ—¶å€™ä¼šç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œä¸€èˆ¬æ˜¯IOExceptionã€‚ä¸Šé¢çš„ä¾‹å­ä¸­æ˜¯æˆ‘ä»¬æœ€å¸¸è§åˆ°çš„é˜Ÿåˆ—å£°æ˜æ–¹å¼ï¼Œå£°æ˜å‡ºæ¥çš„é˜Ÿåˆ—å¼€å¯äº†é˜Ÿåˆ—æŒä¹…åŒ–ç‰¹æ€§ã€éç‹¬å çš„ã€éè‡ªåŠ¨åˆ é™¤çš„ï¼Œä¹Ÿå°±æ˜¯å³ä½¿RabbitMQæœåŠ¡é‡å¯äº†ï¼Œé˜Ÿåˆ—ä¾ç„¶ä¼šå­˜åœ¨(è¢«é‡æ–°å£°æ˜)ï¼Œä½†æ˜¯å¹¶ä¸æ˜¯æ‰€æœ‰çš„åœºæ™¯éƒ½éœ€è¦è¿™ç§å£°æ˜æ–¹å¼(è¯´å®è¯ï¼Œç›®å‰ç¬”è€…æ²¡ç¢°åˆ°ä¸ä½¿ç”¨è¿™ç§å£°æ˜æ–¹å¼çš„åœºæ™¯ï¼Œæœ‰ç‚¹æƒ­æ„§)ã€‚è¿˜æœ‰ä¸€ç‚¹éœ€è¦é‡ç‚¹å…³æ³¨ï¼šé˜Ÿåˆ—å¯ä»¥é‡å¤å£°æ˜ï¼Œä½†æ˜¯å£°æ˜æ‰€ä½¿ç”¨çš„å‚æ•°å¿…é¡»ä¸€è‡´ï¼Œå¦åˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ã€‚ é˜Ÿåˆ—çš„è¢«åŠ¨(Passive)å£°æ˜ é˜Ÿåˆ—çš„è¢«åŠ¨å£°æ˜ï¼Œå…¶å®æ˜¯æ£€æŸ¥é˜Ÿåˆ—åœ¨æ¶ˆæ¯ä»£ç†ä¸­é—´ä»¶æ˜¯å¦å­˜åœ¨çš„åˆ¤æ–­æ–¹æ³•ï¼Œä¾èµ–äºChannelçš„queueDeclarePassiveæ–¹æ³•ï¼š 1Queue.DeleteOk queueDelete(String queue) throws IOException; å®ƒåªä¾èµ–äºä¸€ä¸ªå‚æ•°-é˜Ÿåˆ—åç§°ï¼Œå¦‚æœé˜Ÿåˆ—åç§°å¯¹åº”çš„é˜Ÿåˆ—å·²ç»å­˜åœ¨ï¼Œåˆ™è¿”å›Queue.DeleteOkå®ä¾‹ï¼Œå¦‚æœé˜Ÿåˆ—ä¸å­˜åœ¨ï¼Œä¼šæŠ›å‡ºIOExceptionï¼Œé€šå¸¸æ˜¯ä¸€ä¸ªè¢«åŒ…è£…ä¸ºIOExceptionçš„ShutdownSignalExceptionï¼Œè€ŒShutdownSignalExceptionæ˜¯è¿è¡Œæ—¶å¼‚å¸¸çš„å­ç±»ã€‚ä¸¾ä¸ªåˆ—å­ï¼š 12345678910111213public class QueueDeclarePassiveMain extends BaseChannelFactory &#123; public static void main(String[] args) throws Exception &#123; provideChannel(channel -&gt; &#123; //é˜Ÿåˆ—throwable.queueå·²å­˜åœ¨ AMQP.Queue.DeclareOk declareOk = channel.queueDeclarePassive(\"throwable.queue\"); System.out.println(declareOk.getQueue()); //é˜Ÿåˆ—throwable.queue.passiveä¸å­˜åœ¨ declareOk = channel.queueDeclarePassive(\"throwable.queue.passive\"); System.out.println(declareOk.getQueue()); &#125;); &#125;&#125; ç”±äºthrowable.queue.passiveé˜Ÿåˆ—ä¸å­˜åœ¨ï¼Œå› æ­¤ä¼šæŠ›å‡ºIOExceptionï¼Œè¿½è¸ªå¼‚å¸¸æ ˆæŸ¥çœ‹åº•å±‚çš„å¼‚å¸¸æ˜¯ï¼š Caused by: com.rabbitmq.client.ShutdownSignalException: channel error; protocol method: #method&lt;channel.close&gt;(reply-code=404, reply-text=NOT_FOUND - no queue â€˜throwable.queue.passiveâ€™ in vhost â€˜/â€™, class-id=50, method-id=10) åˆ©ç”¨è¿™ä¸ªæ–¹æ³•çš„ç‰¹æ€§å¯ä»¥å°è¯•ç¼–å†™ä¸€ä¸ªæ–¹æ³•ç¡®è®¤é˜Ÿåˆ—æ˜¯å¦å­˜åœ¨ï¼Œä¾‹å¦‚ï¼š 12345678910private static boolean isQueueExisted(Channel channel, String queueName) &#123; boolean flag = false; try &#123; channel.queuePurge(queueName); flag = true; &#125; catch (IOException e) &#123; //no-op &#125; return flag;&#125; é˜Ÿåˆ—çš„åˆ é™¤ é˜Ÿåˆ—çš„åˆ é™¤å¯¹åº”çš„æ˜¯Channelçš„queueDeleteæ–¹æ³•ï¼š 1234//åŸºäºé˜Ÿåˆ—ååˆ é™¤é˜Ÿåˆ—ï¼Œä¸å…³æ³¨é˜Ÿåˆ—æ˜¯å¦è¢«ä½¿ç”¨ï¼Œä¹Ÿä¸å…³æ³¨é˜Ÿåˆ—ä¸­æ˜¯å¦å­˜åœ¨æ¶ˆæ¯Queue.DeleteOk queueDelete(String queue) throws IOException;Queue.DeleteOk queueDelete(String queue, boolean ifUnused, boolean ifEmpty) throws IOException; å‚æ•°å¦‚ä¸‹ï¼š queueï¼šé˜Ÿåˆ—åç§°ã€‚ ifUnusedï¼šåˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦è¢«ä¸è¢«ä½¿ç”¨ï¼Œå¦‚æœä¸ºtrueï¼Œåªæœ‰ä¸è¢«ä½¿ç”¨çš„é˜Ÿåˆ—æ‰èƒ½è¢«åˆ é™¤ã€‚ ifEmptyï¼šåˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦ä¸ºç©º(æ²¡æœ‰æ¶ˆæ¯ç§¯å‹)ï¼Œå¦‚æœä¸ºtrueï¼Œåªæœ‰ç©ºçš„é˜Ÿåˆ—æ‰èƒ½è¢«åˆ é™¤ã€‚ å…¶å®ä¹Ÿå°±æ˜¯åªä¾èµ–é˜Ÿåˆ—åçš„å•å‚æ•°çš„queueDeleteå°±æ˜¯å¼ºåˆ¶åˆ é™¤æ–¹æ³•ï¼Œä¸¾ä¸ªä¾‹å­ï¼š 12345678910public class QueueDeleteMain extends BaseChannelFactory &#123; public static void main(String[] args) throws Exception &#123; provideChannel(channel -&gt; &#123; AMQP.Queue.DeleteOk deleteOk = channel.queueDelete(\"throwable.queue\"); System.out.println(String.format(\"Delete queue [%s] successfully,message count = %d!\", \"throwable.queue\", deleteOk.getMessageCount())); &#125;); &#125;&#125; ä¸€èˆ¬æ¥è¯´ï¼Œé˜Ÿåˆ—çš„åˆ é™¤åŠŸèƒ½æƒé™æœ€å¥½ä¸è¦ä¸‹æ”¾åˆ°åº”ç”¨ç¨‹åºä¸­ï¼Œé™¤éæœ‰ç‰¹æ®Šçš„éœ€è¦ï¼Œå¦‚æœéœ€è¦åˆ é™¤é˜Ÿåˆ—ï¼Œæœ€å¥½ä½¿ç”¨queueDelete(String queue, boolean ifUnused, boolean ifEmpty)æ–¹æ³•ï¼Œå¦åˆ™æœ‰å¯èƒ½é€ æˆæ¶ˆæ¯ä¸¢å¤±ã€‚ é˜Ÿåˆ—çš„æ¸…ç©º é˜Ÿåˆ—çš„æ¸…ç©ºæ“ä½œä¼šåˆ é™¤é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰æ¶ˆæ¯ï¼Œä¾èµ–çš„æ–¹æ³•æ˜¯Channelçš„queuePurgeæ–¹æ³•ï¼š 1Queue.PurgeOk queuePurge(String queue) throws IOException; æ­¤æ–¹æ³•ä¼šåŸºäºé˜Ÿåˆ—åæ¸…é™¤å¯¹åº”é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰å†…å®¹ï¼Œä½¿ç”¨çš„æ—¶å€™éœ€è¦è°¨æ…ï¼Œä¸¾ä¸ªä¾‹å­ï¼š 12345678910public class QueuePurgeMain extends BaseChannelFactory &#123; public static void main(String[] args) throws Exception &#123; provideChannel(channel -&gt; &#123; AMQP.Queue.PurgeOk purgeOk = channel.queuePurge(\"throwable.queue\"); System.out.println(String.format(\"Purge queue [%s] successfully,message count = %d!\", \"throwable.queue\", purgeOk.getMessageCount())); &#125;); &#125;&#125; å…¶å®åœ¨Webç®¡ç†ç•Œé¢ä¸­ï¼Œæ¯ä¸ªé˜Ÿåˆ—æ‰€åœ¨çš„é¡µé¢ä¸‹æœ‰ä¸€ä¸ªPurgeæŒ‰é’®ï¼Œè¯¥æŒ‰é’®çš„åŠŸèƒ½å°±æ˜¯æ¸…ç©ºé˜Ÿåˆ—æ¶ˆæ¯ã€‚ äº¤æ¢å™¨çš„ç›¸å…³æ“ä½œ äº¤æ¢å™¨çš„ç›¸å…³æ“ä½œä¸»è¦åŒ…æ‹¬äº¤æ¢å™¨çš„å£°æ˜å’Œåˆ é™¤ã€‚ äº¤æ¢å™¨çš„å£°æ˜ äº¤æ¢å™¨çš„å£°æ˜æ–¹æ³•ä¾èµ–äºChannelçš„exchangeDeclareæ–¹æ³•ï¼ŒæŒ‰ç…§æƒ¯ä¾‹æŸ¥çœ‹å®ƒé‡è½½æ–¹æ³•ä¸­å‚æ•°åˆ—è¡¨é•¿åº¦æœ€å¤§çš„æ–¹æ³•ï¼š 12345678910111213Exchange.DeclareOk exchangeDeclare(String exchange, BuiltinExchangeType type, boolean durable, boolean autoDelete, boolean internal, Map&lt;String, Object&gt; arguments) throws IOException;Exchange.DeclareOk exchangeDeclare(String exchange, String type, boolean durable, boolean autoDelete, boolean internal, Map&lt;String, Object&gt; arguments) throws IOException; å‚æ•°è§£é‡Šå¦‚ä¸‹ï¼š exchangeï¼šäº¤æ¢å™¨åç§°ã€‚ typeï¼štypeå¯ä»¥ä¸ºå­—ç¬¦ä¸²æˆ–è€…BuiltinExchangeTypeç±»å‹ï¼ŒBuiltinExchangeTypeæšä¸¾åªåŒ…æ‹¬DIRECTã€FANOUTã€TOPICå’ŒHEADERSï¼Œè€Œå­—ç¬¦ä¸²ç±»å‹é™¤äº†å®šä¹‰å››ç§å†…å»ºç±»å‹çš„äº¤æ¢å™¨ï¼Œå®é™…ä¸ŠRabbitMQå…è®¸è‡ªå®šä¹‰ç±»å‹çš„äº¤æ¢å™¨ï¼Œä¸è¿‡å¾ˆå°‘ä½¿ç”¨ã€‚ durableï¼šæ˜¯å¦å¼€å¯æŒä¹…åŒ–ç‰¹æ€§ï¼Œå¦‚æœæ­¤å±æ€§ä¸ºtrueï¼Œåˆ™æ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†é‡å¯åï¼Œäº¤æ¢å™¨ä¸ä¼šåˆ é™¤ï¼Œå®é™…ä¸Šæ˜¯ä¼šè¢«é‡æ–°å£°æ˜ä¸€æ¬¡ã€‚ autoDeleteï¼šæ˜¯å¦è‡ªåŠ¨åˆ é™¤ï¼Œå¦‚æœæ­¤å±æ€§ä¸ºtrueï¼Œå½“æœ€åä¸€ä¸ªç»‘å®šåˆ°æ­¤äº¤æ¢å™¨çš„é˜Ÿåˆ—è§£é™¤ç»‘å®šå…³ç³»ï¼Œäº¤æ¢å™¨ä¼šè¢«åˆ é™¤ã€‚ internalï¼šæ˜¯å¦å†…éƒ¨çš„ï¼Œå¦‚æœæ­¤å±æ€§ä¸ºtrueï¼Œè¯¥äº¤æ¢å™¨åªå…è®¸æ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†ä½¿ç”¨ï¼Œå®¢æˆ·ç«¯æ— æ³•ä½¿ç”¨ã€‚ argumentsï¼šäº¤æ¢å™¨å‚æ•°ï¼ŒK-Vç»“æ„ï¼Œå‚æ•°ä¸€èˆ¬å’Œæ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†æˆ–è€…æ’ä»¶çš„ä¸€äº›æ‰©å±•ç‰¹æ€§ç›¸å…³ï¼Œä¸ä¾èµ–è¿™äº›æ‰©å±•ç‰¹æ€§ç›´æ¥ä½¿ç”¨nullå³å¯ã€‚ ä¸¾ä¸ªç®€å•çš„ä½¿ç”¨ä¾‹å­ï¼š 12345678910public class ExchangeDeclareMain extends BaseChannelFactory &#123; public static void main(String[] args) throws Exception &#123; provideChannel(channel -&gt; &#123; channel.exchangeDeclare(\"throwable.exchange.direct\", BuiltinExchangeType.DIRECT, true, false, null); &#125;); &#125;&#125; æ‰§è¡Œå®Œæ¯•ä¹‹åï¼ŒRabbitMQçš„Webç®¡ç†å™¨çš„Exchangesçš„é€‰é¡¹å¡ä¸­å°±èƒ½çœ‹åˆ°å¯¹åº”çš„äº¤æ¢å™¨ï¼š å› ä¸ºæ²¡æœ‰å£°æ˜äº¤æ¢å™¨å’Œé˜Ÿåˆ—çš„ç»‘å®šï¼Œæ‰€ä»¥Bindingsä¸€æ æ˜¯ç©ºçš„ã€‚ äº¤æ¢å™¨çš„è¢«åŠ¨å£°æ˜ äº¤æ¢å™¨çš„è¢«åŠ¨å£°æ˜ç±»ä¼¼äºé˜Ÿåˆ—çš„è¢«åŠ¨å£°æ˜ï¼Œç”¨äºé€šè¿‡äº¤æ¢å™¨åç§°æ£€æŸ¥æ˜¯å¦å­˜åœ¨å¯¹åº”çš„äº¤æ¢å™¨ï¼Œä¾èµ–äºChannelçš„exchangeDeclarePassiveæ–¹æ³•ï¼š 1Exchange.DeclareOk exchangeDeclarePassive(String name) throws IOException; ä¸¾ä¸ªä¾‹å­ï¼š 1234567891011public class ExchangeDeclarePassiveMain extends BaseChannelFactory &#123; public static void main(String[] args) throws Exception &#123; provideChannel(channel -&gt; &#123; //throwable.exchange.directå­˜åœ¨ channel.exchangeDeclarePassive(\"throwable.exchange.direct\"); //throwable.exchange.fanoutä¸å­˜åœ¨,ä¼šæŠ›å‡ºIOException channel.exchangeDeclarePassive(\"throwable.exchange.fanout\"); &#125;); &#125;&#125; ç±»ä¼¼å¯ä»¥å†™ä¸ªæ£€æŸ¥äº¤æ¢å™¨æ˜¯å¦å­˜åœ¨çš„å·¥å…·æ–¹æ³•ï¼š 12345678910private boolean isExchangeExisted(Channel channel, String exchangeName) &#123; boolean flag = false; try &#123; channel.exchangeDeclarePassive(exchangeName); flag = true; &#125; catch (IOException e) &#123; //no-op &#125; return flag;&#125; äº¤æ¢å™¨çš„åˆ é™¤ äº¤æ¢å™¨çš„åˆ é™¤ä¾èµ–äºChannelçš„exchangeDeleteæ–¹æ³•ï¼Œæ–¹æ³•åªä¾èµ–äºäº¤æ¢å™¨çš„åç§°ã€‚ 1Exchange.DeleteOk exchangeDelete(String exchange) throws IOException; ä¸¾ä¸ªä¾‹å­ï¼š 123456789public class ExchangeDeleteMain extends BaseChannelFactory &#123; public static void main(String[] args) throws Exception &#123; provideChannel(channel -&gt; &#123; channel.exchangeDelete(\"throwable.exchange.direct\"); &#125;); &#125;&#125; ç»‘å®šçš„å£°æ˜ å‰é¢æåˆ°é˜Ÿåˆ—çš„å£°æ˜å’Œäº¤æ¢å™¨çš„å£°æ˜ï¼Œé˜Ÿåˆ—å’Œäº¤æ¢å™¨åˆ›å»ºä¹‹åï¼Œéœ€è¦å£°æ˜ä¸¤è€…çš„ç»‘å®šå…³ç³»ï¼ŒChannelä¸­æä¾›äº†ä¸¤ç§å£°æ˜ç»‘å®šå…³ç³»çš„æ–¹æ³•ï¼š queueBindæ–¹æ³•ï¼Œå£°æ˜é˜Ÿåˆ—å’Œäº¤æ¢å™¨çš„ç»‘å®šå…³ç³»ã€‚ exchangeBindæ–¹æ³•ï¼Œå£°æ˜äº¤æ¢å™¨å’Œäº¤æ¢å™¨ä¹‹é—´çš„ç»‘å®šå…³ç³»ã€‚ åŒæ—¶ä¹Ÿæä¾›è§£é™¤ç»‘å®šçš„æ–¹æ³•ï¼š queueUnbindæ–¹æ³•ï¼šè§£é™¤é˜Ÿåˆ—å’Œäº¤æ¢å™¨çš„ç»‘å®šå…³ç³»ã€‚ exchangeUnbindæ–¹æ³•ï¼šè§£é™¤äº¤æ¢å™¨ä¹‹é—´çš„ç»‘å®šå…³ç³»ã€‚ é˜Ÿåˆ—å’Œäº¤æ¢å™¨çš„ç»‘å®šå’Œè§£ç»‘ é˜Ÿåˆ—å’Œäº¤æ¢å™¨çš„ç»‘å®šä¸»è¦ä¾èµ–äºChannelçš„queueBindï¼Œè€Œè§£ç»‘ä¸»è¦ä¾èµ–äºqueueUnbindæ–¹æ³•ï¼ŒæŒ‰ç…§æƒ¯ä¾‹çœ‹è¿™ä¸¤ä¸ªæ–¹æ³•é‡è½½æ–¹æ³•ä¸­å‚æ•°åˆ—è¡¨é•¿åº¦æœ€å¤§çš„æ–¹æ³•ï¼š 123456789Queue.BindOk queueBind(String queue, String exchange, String routingKey, Map&lt;String, Object&gt; arguments) throws IOException;Queue.UnbindOk queueUnbind(String queue, String exchange, String routingKey, Map&lt;String, Object&gt; arguments) throws IOException; æ³¨æ„è¿™ä¸¤ä¸ªæ–¹æ³•çš„å‚æ•°åˆ—è¡¨å®Œå…¨ä¸€è‡´ï¼š queueï¼šé˜Ÿåˆ—åç§°ã€‚ exchangeï¼šäº¤æ¢å™¨åç§°ã€‚ routingKeyï¼šè·¯ç”±é”®ã€‚ argumentsï¼šç»‘å®šå‚æ•°ï¼ŒK-Vç»“æ„ï¼Œå‚æ•°ä¸€èˆ¬å’Œæ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†æˆ–è€…æ’ä»¶çš„ä¸€äº›æ‰©å±•ç‰¹æ€§ç›¸å…³ï¼Œä¸ä¾èµ–è¿™äº›æ‰©å±•ç‰¹æ€§ç›´æ¥ä½¿ç”¨nullå³å¯ã€‚ åŸºäºå£°æ˜é˜Ÿåˆ—å’Œäº¤æ¢å™¨é—´çš„ç»‘å®šä¸¾ä¸ªä¾‹å­ï¼š 123456789public class QueueBindMain extends BaseChannelFactory&#123; public static void main(String[] args) throws Exception&#123; provideChannel(channel -&gt; &#123; //throwable.exchange.direct-&gt;throwable.queue channel.queueBind(\"throwable.queue\",\"throwable.exchange.direct\", \"throwable.routingKey\",null); &#125;); &#125;&#125; å£°æ˜æˆåŠŸä¹‹åï¼Œå¯ä»¥æŸ¥çœ‹å¯¹åº”çš„é˜Ÿåˆ—å’Œäº¤æ¢å™¨ä¸­çš„Bindingsä¸€æ ï¼š å¯è§äº¤æ¢å™¨å’Œé˜Ÿåˆ—æˆåŠŸå»ºç«‹äº†ç»‘å®šå…³ç³»ã€‚æ¥ç€å¯ä»¥å°è¯•ä½¿ç”¨è§£ç»‘æ–¹æ³•è¿›è¡Œç»‘å®šè§£é™¤ï¼š 12345678public class QueueUnbindMain extends BaseChannelFactory&#123; public static void main(String[] args) throws Exception&#123; provideChannel(channel -&gt; &#123; channel.queueUnbind(\"throwable.queue\",\"throwable.exchange.direct\", \"throwable.routingKey\",null); &#125;); &#125;&#125; äº¤æ¢å™¨ä¹‹é—´çš„ç»‘å®šå’Œè§£ç»‘ RabbitMQä¸­æ”¯æŒä¸¤ä¸ªä¸åŒçš„äº¤æ¢å™¨ä¹‹é—´è¿›è¡Œç»‘å®šå’Œè§£é™¤ç»‘å®šï¼Œç»‘å®šæ–¹æ³•ä¾èµ–äºChannelçš„exchangeBindæ–¹æ³•ï¼Œè§£é™¤ç»‘å®šä¾èµ–äºChannelçš„exchangeUnbindæ–¹æ³•ï¼š 123456789Exchange.BindOk exchangeBind(String destination, String source, String routingKey, Map&lt;String, Object&gt; arguments) throws IOException;Exchange.UnbindOk exchangeUnbind(String destination, String source, String routingKey, Map&lt;String, Object&gt; arguments) throws IOException; å‚æ•°å¦‚ä¸‹ï¼š destinationï¼šç›®æ ‡äº¤æ¢å™¨åç§°ã€‚ sourceï¼šæ¥æºäº¤æ¢å™¨åç§°ã€‚ routingKeyï¼šè·¯ç”±é”®ã€‚ argumentsï¼šå‚æ•°ï¼ŒK-Vç»“æ„ã€‚ æˆ‘ä»¬å…ˆé¢„å…ˆå»ºç«‹ä¸€ä¸ªFanoutç±»å‹çš„äº¤æ¢å™¨ï¼Œå‘½åä¸ºthrowable.exchange.fanoutï¼Œæ¥ç€ï¼Œæˆ‘ä»¬æŠŠFanoutç±»å‹çš„äº¤æ¢å™¨throwable.exchange.fanoutä½œä¸ºæ¥æºäº¤æ¢å™¨ï¼Œç»‘å®šåˆ°Directç±»å‹çš„ç›®æ ‡äº¤æ¢å™¨throwable.exchange.directä¸Šï¼š 123456789public class ExchangeBindMain extends BaseChannelFactory &#123; public static void main(String[] args) throws Exception &#123; provideChannel(channel -&gt; &#123; channel.exchangeDeclare(\"throwable.exchange.fanout\", BuiltinExchangeType.FANOUT, true, false, null); channel.exchangeBind(\"throwable.exchange.direct\", \"throwable.exchange.fanout\", \"exchange.routingKey\"); &#125;); &#125;&#125; ç°åœ¨å¯ä»¥æŸ¥çœ‹äº¤æ¢å™¨throwable.exchange.directçš„Bindingsä¸€æ çš„ä¿¡æ¯ï¼š è¿™å°±æ˜¯ç°åœ¨æˆ‘ä»¬é€šè¿‡äº¤æ¢å™¨throwable.exchange.fanoutå‘é€æ¶ˆæ¯ï¼Œæ¶ˆæ¯ä¼šå…ˆåˆ°è¾¾äº¤æ¢å™¨throwable.exchange.directï¼Œç„¶åå†è·¯ç”±åˆ°é˜Ÿåˆ—throwable.queueä¸­ã€‚å¤šé‡ç»‘å®šçš„äº¤æ¢å™¨åœ¨ä¸€äº›å¤æ‚çš„åœºæ™¯æœ‰é‡è¦çš„ä½œç”¨ï¼Œä½†æ˜¯ç›®å‰æ¥çœ‹è¿˜æ²¡æœ‰ç¢°åˆ°ä½¿ç”¨åœºæ™¯(ä¸€èˆ¬æ¥è¯´ï¼Œå­˜åœ¨å³åˆç†)ã€‚ æ¥ç€ä¸¾ä¸ªä¾‹å­è¿›è¡Œäº¤æ¢å™¨ä¹‹é—´çš„ç»‘å®šè§£é™¤ï¼š 12345678public class ExchangeUnbindMain extends BaseChannelFactory &#123; public static void main(String[] args) throws Exception &#123; provideChannel(channel -&gt; &#123; channel.exchangeUnbind(\"throwable.exchange.direct\", \"throwable.exchange.fanout\", \"exchange.routingKey\"); &#125;); &#125;&#125; å°ç»“ ä¸€æ—¦é˜Ÿåˆ—å’Œäº¤æ¢å™¨ä¹‹é—´çš„ç»‘å®šå…³ç³»å£°æ˜å®Œæ¯•ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡äº¤æ¢å™¨å’Œå¯é€‰çš„è·¯ç”±é”®å‘é˜Ÿåˆ—ä¸­å‘é€æ¶ˆæ¯ï¼Œå¯ä»¥æ³¨å†Œæ¶ˆè´¹è€…åˆ°é˜Ÿåˆ—ä¸­è·å–æ¶ˆæ¯ã€‚RabbitMQä¸­çš„é˜Ÿåˆ—ã€äº¤æ¢å™¨å’Œç»‘å®šæœ‰ä¸ªç‰¹ç‚¹ï¼šç»„ä»¶çš„å£°æ˜åªæ‰¿è®¤ç¬¬ä¸€æ¬¡ï¼Œä¹Ÿå°±æ˜¯é˜Ÿåˆ—åã€äº¤æ¢å™¨åæ˜¯å”¯ä¸€çš„ï¼Œç»„ä»¶å¯ä»¥åå¤å£°æ˜ï¼Œä¸è¿‡å£°æ˜æ‰€ä½¿ç”¨çš„å‚æ•°å¿…é¡»å’Œé¦–æ¬¡å£°æ˜çš„å‚æ•°ä¸€è‡´ã€‚ (æœ¬æ–‡å®Œ c-3-d e-a-20181125)","categories":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/categories/Middleware/"},{"name":"RabbitMQ","slug":"Middleware/RabbitMQ","permalink":"http://throwable.club/blog/categories/Middleware/RabbitMQ/"}],"tags":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/tags/Middleware/"},{"name":"RabbitMQ","slug":"RabbitMQ","permalink":"http://throwable.club/blog/tags/RabbitMQ/"}]},{"title":"ç†è§£RabbitMQä¸­çš„AMQP-0-9-1æ¨¡å‹","slug":"rabbitmq-amqp-model","date":"2018-11-21T15:51:22.000Z","updated":"2018-11-22T15:38:56.037Z","comments":true,"path":"2018/11/21/rabbitmq-amqp-model/","link":"","permalink":"http://throwable.club/2018/11/21/rabbitmq-amqp-model/","excerpt":"","text":"å‰æ ä¹‹å‰æœ‰ä¸ªæ‰“ç®—åœ¨å­¦ä¹ RabbitMQä¹‹å‰ï¼ŒæŠŠAMQPè¯¦ç»†é˜…è¯»ä¸€æ¬¡ï¼ŒæŒ‘å‡ºé‡Œé¢çš„é‡ç‚¹å†…å®¹ã€‚åæ¥æ‰¾äº†ä¸‹RabbitMQçš„å®˜æ–¹æ–‡æ¡£ï¼Œå‘ç°äº†æœ‰ä¸€ç¯‡æ–‡æ¡£ä¸“é—¨ä»‹ç»äº†RabbitMQä¸­å®ç°çš„AMQPæ¨¡å‹éƒ¨åˆ†ï¼Œäºæ˜¯ç›´æ¥åŸºäºæ­¤æ–‡æ¡£å’Œä¸ªäººç†è§£å†™ä¸‹è¿™ç¯‡æ–‡ç« ã€‚ AMQPåè®® AMQPå…¨ç§°æ˜¯Advanced Message Queuing Protocolï¼Œå®ƒæ˜¯ä¸€ä¸ª(åˆ†å¸ƒå¼)æ¶ˆæ¯ä¼ é€’åè®®ï¼Œä½¿ç”¨å’Œç¬¦åˆæ­¤åè®®çš„å®¢æˆ·ç«¯èƒ½å¤ŸåŸºäºä½¿ç”¨å’Œç¬¦åˆæ­¤åè®®çš„æ¶ˆæ¯ä¼ é€’ä¸­é—´ä»¶ä»£ç†(Brokerï¼Œä¹Ÿå°±æ˜¯ç»çºªäººï¼Œä¸ªäººæ„Ÿè§‰å«ä»£ç†åˆå£ä¸€äº›)è¿›è¡Œé€šä¿¡ã€‚AMQPç›®å‰å·²ç»æ¨å‡ºåè®®1.0ï¼Œå®ç°æ­¤åè®®çš„æ¯”è¾ƒçŸ¥åçš„äº§å“æœ‰StormMQã€RabbitMQã€Apache Qpidç­‰ã€‚RabbitMQå®ç°çš„AMQPç‰ˆæœ¬æ˜¯0.9.1ï¼Œå®˜æ–¹æ–‡æ¡£ä¸­ä¹Ÿæä¾›äº†è¯¥åè®®pdfæ–‡æœ¬ä¸‹è½½ï¼Œæœ‰å…´è¶£å¯ä»¥ç¿»é˜…ä¸€ä¸‹ã€‚ æ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†çš„èŒè´£ Messaging Brokerï¼Œè¿™é‡Œç§°ä¸ºæ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†ã€‚å®ƒçš„èŒè´£æ˜¯ä»å‘å¸ƒè€…(Publisherï¼Œæˆ–è€…æœ‰äº›æ—¶å€™ç§°ä¸ºProducerï¼Œç”Ÿäº§è€…)æ¥æ”¶æ¶ˆæ¯ï¼Œç„¶åæŠŠæ¶ˆæ¯è·¯ç”±åˆ°æ¶ˆè´¹è€…(Consumerï¼Œæˆ–è€…æœ‰äº›æ—¶å€™ç§°ä¸ºListenerï¼Œç›‘å¬è€…)ã€‚ å› ä¸ºæ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†ã€å‘å¸ƒè€…å®¢æˆ·ç«¯å’Œæ¶ˆè´¹è€…å®¢æˆ·ç«¯éƒ½æ˜¯åŸºäºAMQPè¿™ä¸€ç½‘ç»œæ¶ˆæ¯åè®®ï¼Œæ‰€ä»¥æ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†ã€å‘å¸ƒè€…å®¢æˆ·ç«¯å’Œæ¶ˆè´¹è€…å®¢æˆ·ç«¯å¯ä»¥åœ¨ä¸åŒçš„æœºå™¨ä¸Šï¼Œä»è€Œå®ç°åˆ†å¸ƒå¼é€šè®¯å’ŒæœåŠ¡è§£è€¦ã€‚ æ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†ä¸ä»…ä»…æä¾›äº†æ¶ˆæ¯æ¥æ”¶å’Œæ¶ˆæ¯è·¯ç”±è¿™ä¸¤ä¸ªåŸºæœ¬åŠŸèƒ½ï¼Œè¿˜æœ‰å…¶ä»–é«˜çº§çš„ç‰¹æ€§å¦‚æ¶ˆæ¯æŒä¹…åŒ–åŠŸèƒ½ã€ç›‘æ§åŠŸèƒ½ç­‰ç­‰ã€‚ AMQP-0-9-1åœ¨RabbitMQä¸­çš„åŸºæœ¬æ¨¡å‹ AMQP-0-9-1æ¨¡å‹çš„åŸºæœ¬è§†å›¾æ˜¯ï¼šæ¶ˆæ¯å‘å¸ƒè€…å°†æ¶ˆæ¯å‘å¸ƒåˆ°äº¤æ¢å™¨(Exchange)ä¸­ï¼Œäº¤æ¢å™¨çš„è§’è‰²æœ‰ç‚¹ç±»ä¼¼äºæ—¥å¸¸è§åˆ°çš„é‚®å±€æˆ–è€…ä¿¡ç®±ã€‚ç„¶åï¼Œäº¤æ¢å™¨æŠŠæ¶ˆæ¯çš„å‰¯æœ¬åˆ†å‘åˆ°é˜Ÿåˆ—(Queue)ä¸­ï¼Œåˆ†å‘æ¶ˆæ¯çš„æ—¶å€™éµå¾ªçš„è§„åˆ™å«åšç»‘å®š(Binding)ã€‚æ¥ç€ï¼Œæ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†å‘è®¢é˜…é˜Ÿåˆ—çš„æ¶ˆè´¹è€…å‘é€æ¶ˆæ¯(pushæ¨¡å¼)ï¼Œæˆ–è€…æ¶ˆè´¹è€…ä¹Ÿå¯ä»¥ä¸»åŠ¨ä»é˜Ÿåˆ—ä¸­æ‹‰å–æ¶ˆæ¯(fetch/pullæ¨¡å¼)ã€‚ å‘å¸ƒè€…åœ¨å‘å¸ƒæ¶ˆæ¯çš„æ—¶å€™å¯ä»¥æŒ‡å®šæ¶ˆæ¯å±æ€§(æ¶ˆæ¯å…ƒæ•°æ®)ï¼ŒæŸäº›æ¶ˆæ¯å…ƒæ•°æ®å¯èƒ½ç”±æ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†ä½¿ç”¨ï¼Œå…¶ä»–æ¶ˆæ¯å…ƒæ•°æ®å¯¹äºæ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†è€Œè¨€æ˜¯ä¸é€æ˜çš„ï¼Œä»…ä¾›æ¶ˆæ¯æ¶ˆè´¹è€…ä½¿ç”¨ã€‚ ç”±äºç½‘ç»œæ˜¯ä¸å¯é çš„ï¼Œå®¢æˆ·ç«¯å¯èƒ½æ— æ³•æ¥æ”¶æ¶ˆæ¯æˆ–è€…å¤„ç†æ¶ˆæ¯å¤±è´¥ï¼Œè¿™ä¸ªæ—¶å€™æ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†æ— æ³•æ„ŸçŸ¥æ¶ˆæ¯æ˜¯å¦æ­£ç¡®ä¼ é€’åˆ°æ¶ˆè´¹è€…ä¸­ï¼Œå› æ­¤AMQPæ¨¡å‹æä¾›äº†æ¶ˆæ¯ç¡®è®¤(Message Acknowledgement)çš„æ¦‚å¿µï¼šå½“æ¶ˆæ¯ä¼ é€’åˆ°æ¶ˆè´¹è€…ï¼Œæ¶ˆè´¹è€…å¯ä»¥è‡ªåŠ¨å‘æ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†ç¡®è®¤æ¶ˆæ¯å·²ç»æ¥æ”¶æˆåŠŸæˆ–è€…ç”±åº”ç”¨ç¨‹åºå¼€å‘è€…é€‰æ‹©æ‰‹åŠ¨ç¡®è®¤æ¶ˆæ¯å·²ç»æ¥æ”¶æˆåŠŸå¹¶ä¸”å‘æ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†ç¡®è®¤æ¶ˆæ¯ï¼Œæ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†åªæœ‰åœ¨æ¥æ”¶åˆ°è¯¥æ¶ˆæ¯(æˆ–è€…æ¶ˆæ¯ç»„)çš„ç¡®è®¤é€šçŸ¥åæ‰ä¼šä»é˜Ÿåˆ—ä¸­å®Œå…¨åˆ é™¤è¯¥æ¶ˆæ¯ã€‚ åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œäº¤æ¢å™¨æ— æ³•æ­£ç¡®è·¯ç”±åˆ°é˜Ÿåˆ—ä¸­ï¼Œé‚£ä¹ˆè¯¥æ¶ˆæ¯å°±ä¼šè¿”å›ç»™å‘å¸ƒè€…ï¼Œæˆ–è€…ä¸¢å¼ƒï¼Œæˆ–è€…å¦‚æœæ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†å®ç°äº†&quot;æ­»ä¿¡é˜Ÿåˆ—(Dead Letter Queue)&quot;æ‰©å±•ï¼Œæ¶ˆæ¯ä¼šè¢«æ”¾ç½®åˆ°æ­»ä¿¡é˜Ÿåˆ—ä¸­ã€‚æ¶ˆæ¯å‘å¸ƒè€…å¯ä»¥é€‰æ‹©ä½¿ç”¨å¯¹åº”çš„å‚æ•°æ§åˆ¶è·¯ç”±å¤±è´¥çš„å¤„ç†ç­–ç•¥ã€‚ äº¤æ¢å™¨å’Œäº¤æ¢å™¨ç±»å‹ äº¤äº’å™¨(Exchange)æ˜¯æ¶ˆæ¯å‘é€çš„ç¬¬ä¸€ç«™ç›®çš„åœ°ï¼Œå®ƒçš„ä½œç”¨å°±æ˜¯å°±æ”¶æ¶ˆæ¯å¹¶ä¸”å°†å…¶è·¯ç”±åˆ°é›¶ä¸ªæˆ–è€…å¤šä¸ªé˜Ÿåˆ—ã€‚è·¯ç”±æ¶ˆæ¯çš„ç®—æ³•å–å†³äºäº¤äº’å™¨çš„ç±»å‹å’Œè·¯ç”±è§„åˆ™(ä¹Ÿå°±æ˜¯Binding)ã€‚RabbitMQæ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†æ”¯æŒå››ç§ç±»å‹çš„äº¤äº’å™¨ï¼Œåˆ†åˆ«æ˜¯ï¼š äº¤æ¢å™¨ç±»å‹ Brokeré»˜è®¤é¢„å£°æ˜çš„äº¤æ¢å™¨ Direct (ç©ºå­—ç¬¦ä¸²[(AMQP default)])å’Œamq.direct Fanout amq.fanout Topic amq.topic Headers amq.match (å’ŒRabbitMQä¸­çš„amq.headers) å£°æ˜äº¤äº’å™¨çš„æ—¶å€™éœ€è¦æä¾›ä¸€äº›åˆ—çš„å±æ€§ï¼Œå…¶ä¸­æ¯”è¾ƒé‡è¦çš„å±æ€§å¦‚ä¸‹ï¼š Nameï¼šäº¤äº’å™¨çš„åç§°ã€‚ Typeï¼šäº¤æ¢å™¨çš„ç±»å‹ã€‚ Durabilityï¼š(äº¤æ¢å™¨)æŒä¹…åŒ–ç‰¹æ€§ï¼Œå¦‚æœå¯åŠ¨æ­¤ç‰¹æ€§ï¼Œåˆ™Brokeré‡å¯åäº¤æ¢å™¨ä¾ç„¶å­˜åœ¨ï¼Œå¦åˆ™äº¤æ¢å™¨ä¼šè¢«åˆ é™¤ã€‚ Auto-deleteï¼šæ˜¯å¦è‡ªåŠ¨åˆ é™¤ï¼Œå¦‚æœå¯ç”¨æ­¤ç‰¹æ€§ï¼Œå½“æœ€åä¸€ä¸ªé˜Ÿåˆ—è§£é™¤ä¸äº¤æ¢å™¨çš„ç»‘å®šå…³ç³»ï¼Œäº¤æ¢å™¨ä¼šè¢«åˆ é™¤ã€‚ Argumentsï¼šå¯é€‰å‚æ•°ï¼Œä¸€èˆ¬é…åˆæ’ä»¶æˆ–è€…Brokerçš„ç‰¹æ€§ä½¿ç”¨ã€‚ ä¹‹æ‰€ä»¥å­˜åœ¨Durabilityå’ŒAuto-deleteç‰¹æ€§æ˜¯å› ä¸ºå¹¶å‘æ‰€æœ‰çš„åœºæ™¯å’Œç”¨ä¾‹éƒ½è¦æ±‚äº¤äº’å™¨æ˜¯æŒä¹…åŒ–çš„ã€‚ Directäº¤æ¢å™¨ Directç±»å‹çš„äº¤æ¢å™¨åŸºäºæ¶ˆæ¯è·¯ç”±é”®(RoutingKey)æŠŠæ¶ˆæ¯ä¼ é€’åˆ°é˜Ÿåˆ—ä¸­ã€‚Directäº¤æ¢å™¨æ˜¯æ¶ˆæ¯å•æ’­è·¯ç”±çš„ç†æƒ³å®ç°(å½“ç„¶ï¼Œç”¨äºå¤šæ’­è·¯ç”±ä¹Ÿå¯ä»¥)ï¼Œå®ƒçš„å·¥ä½œåŸç†å¦‚ä¸‹ï¼š é˜Ÿåˆ—ä½¿ç”¨è·¯ç”±é”®Kç»‘å®šåˆ°äº¤æ¢å™¨ã€‚ å½“å…·æœ‰è·¯ç”±é”®Rçš„æ–°æ¶ˆæ¯åˆ°è¾¾äº¤æ¢å™¨çš„æ—¶å€™ï¼Œå¦‚æœK = Rï¼Œé‚£ä¹ˆäº¤æ¢å™¨ä¼šæŠŠæ¶ˆæ¯ä¼ é€’åˆ°é˜Ÿåˆ—ä¸­ã€‚ é»˜è®¤äº¤æ¢å™¨ é»˜è®¤äº¤æ¢å™¨(Default Exchange)æ˜¯ä¸€ç§ç‰¹æ®Šçš„Directäº¤äº’å™¨ï¼Œå®ƒçš„åç§°æ˜¯ç©ºå­—ç¬¦ä¸²(ä¹Ÿå°±æ˜¯&quot;&quot;)ï¼Œå®ƒç”±æ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†é¢„å£°æ˜ï¼Œåœ¨RabbitMQ Brokerä¸­ï¼Œå®ƒåœ¨Webç®¡ç†ç•Œé¢ä¸­çš„åç§°æ˜¯(AMQP default)ã€‚æ¯ä¸ªæ–°åˆ›å»ºçš„é˜Ÿåˆ—éƒ½ä¼šç»‘å®šåˆ°é»˜è®¤äº¤æ¢å™¨ï¼Œè·¯ç”±é”®å°±æ˜¯è¯¥é˜Ÿåˆ—çš„é˜Ÿåˆ—åï¼Œä¹Ÿå°±æ˜¯æ‰€æœ‰çš„é˜Ÿåˆ—éƒ½å¯ä»¥é€šè¿‡é»˜è®¤äº¤æ¢å™¨è¿›è¡Œæ¶ˆæ¯æŠ•é€’ï¼Œåªéœ€è¦æŒ‡å®šè·¯ç”±é”®ä¸ºç›¸åº”çš„é˜Ÿåˆ—åå³å¯ã€‚ Fanoutäº¤æ¢å™¨ Fanoutå…¶å®æ˜¯ä¸€ä¸ªç»„åˆå•è¯ï¼Œfanä¹Ÿå°±æ˜¯æ‰‡å½¢ï¼Œoutå°±æ˜¯å‘å¤–å‘æ•£çš„æ„æ€ï¼ŒFanoutäº¤æ¢å™¨å¯ä»¥æƒ³è±¡ä¸º&quot;æ‰‡å½¢&quot;äº¤æ¢å™¨ã€‚Fanoutäº¤æ¢å™¨ä¼šå¿½ç•¥è·¯ç”±é”®ï¼Œå®ƒä¼šè·¯ç”±æ¶ˆæ¯åˆ°æ‰€æœ‰ç»‘å®šåˆ°å®ƒçš„é˜Ÿåˆ—ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæœ‰Nä¸ªé˜Ÿåˆ—ç»‘å®šåˆ°ä¸€ä¸ªFanoutäº¤æ¢å™¨ï¼Œå½“ä¸€ä¸ªæ–°çš„æ¶ˆæ¯å‘å¸ƒåˆ°è¯¥Fanoutäº¤æ¢å™¨ï¼Œé‚£ä¹ˆè¿™æ¡æ–°æ¶ˆæ¯çš„ä¸€ä¸ªå‰¯æœ¬ä¼šåˆ†å‘åˆ°è¿™Nä¸ªé˜Ÿåˆ—ä¸­ã€‚Fanoutäº¤æ¢å™¨æ˜¯æ¶ˆæ¯å¹¿æ’­è·¯ç”±çš„ç†æƒ³å®ç°ã€‚ Topicäº¤æ¢å™¨ Topicäº¤æ¢å™¨åŸºäºè·¯ç”±é”®å’Œç»‘å®šé˜Ÿåˆ—å’Œäº¤æ¢å™¨çš„æ¨¡å¼è¿›è¡ŒåŒ¹é…ä»è€ŒæŠŠæ¶ˆæ¯è·¯ç”±åˆ°ä¸€ä¸ªæˆ–è€…å¤šä¸ªé˜Ÿåˆ—ã€‚ç»‘å®šé˜Ÿåˆ—å’Œäº¤æ¢å™¨çš„Topicæ¨¡å¼(è¿™ä¸ªæ¨¡å¼ä¸²å…¶å®å°±æ˜¯å£°æ˜ç»‘å®šæ—¶å€™çš„è·¯ç”±é”®ï¼Œå’Œæ¶ˆæ¯å‘å¸ƒçš„è·¯ç”±é”®å¹¶éåŒä¸€ä¸ª)ä¸€èˆ¬ä½¿ç”¨ç‚¹å·(dotï¼Œä¹Ÿå°±æ˜¯â€™.â€™)åˆ†éš”ï¼Œä¾‹å¦‚source.target.keyï¼Œç»‘å®šæ¨¡å¼æ”¯æŒé€šé…ç¬¦ï¼š ç¬¦å·#åŒ¹é…ä¸€ä¸ªæˆ–è€…å¤šä¸ªè¯ï¼Œä¾‹å¦‚ï¼šsource.target.#å¯ä»¥åŒ¹é…source.target.dogeã€source.target.doge.throwableç­‰ç­‰ã€‚ ç¬¦å·*åªèƒ½åŒ¹é…ä¸€ä¸ªè¯ï¼Œä¾‹å¦‚ï¼šsource.target.*å¯ä»¥åŒ¹é…source.target.dogeã€source.target.throwableç­‰ç­‰ã€‚ å¯¹æ¯ä¸€æ¡æ¶ˆæ¯ï¼ŒTopicäº¤æ¢å™¨ä¼šéå†æ‰€æœ‰çš„ç»‘å®šå…³ç³»ï¼Œæ£€æŸ¥æ¶ˆæ¯æŒ‡å®šçš„è·¯ç”±é”®æ˜¯å¦åŒ¹é…ç»‘å®šå…³ç³»ä¸­çš„è·¯ç”±é”®ï¼Œå¦‚æœåŒ¹é…ï¼Œåˆ™å°†æ¶ˆæ¯æ¨é€åˆ°ç›¸åº”é˜Ÿåˆ—ã€‚ Topicäº¤æ¢å™¨æ˜¯æ¶ˆæ¯å¤šæ’­è·¯ç”±çš„ç†æƒ³å®ç°ã€‚ Headersäº¤æ¢å™¨ Headersäº¤æ¢å™¨æ˜¯ä¸€ç§ä¸å¸¸ç”¨çš„äº¤æ¢å™¨ï¼Œå®ƒä½¿ç”¨å¤šä¸ªå±æ€§è¿›è¡Œè·¯ç”±ï¼Œè¿™äº›å±æ€§ä¸€èˆ¬ç§°ä¸ºæ¶ˆæ¯å¤´ï¼Œå®ƒä¸ä½¿ç”¨è·¯ç”±é”®è¿›è¡Œæ¶ˆæ¯è·¯ç”±ã€‚æ¶ˆæ¯å¤´(Message Headers)æ˜¯æ¶ˆæ¯å±æ€§(æ¶ˆæ¯å…ƒæ•°æ®)éƒ¨åˆ†ï¼Œå› æ­¤ï¼Œä½¿ç”¨Headersäº¤æ¢å™¨åœ¨å»ºç«‹é˜Ÿåˆ—å’Œäº¤æ¢å™¨çš„ç»‘å®šå…³ç³»çš„æ—¶å€™éœ€è¦æŒ‡å®šä¸€ç»„é”®å€¼å¯¹ï¼Œå‘é€æ¶ˆæ¯åˆ°Headersäº¤æ¢å™¨æ—¶å€™ï¼Œéœ€è¦åœ¨æ¶ˆæ¯å±æ€§ä¸­æºå¸¦ä¸€ç»„é”®å€¼å¯¹ä½œä¸ºæ¶ˆæ¯å¤´ã€‚æ¶ˆæ¯å¤´å±æ€§æ”¯æŒåŒ¹é…è§„åˆ™x-matchå¦‚ä¸‹ï¼š x-match = allï¼šè¡¨ç¤ºæ‰€æœ‰çš„é”®å€¼å¯¹éƒ½åŒ¹é…æ‰èƒ½æ¥å—åˆ°æ¶ˆæ¯ã€‚ x-match = anyï¼šè¡¨ç¤ºåªè¦å­˜åœ¨é”®å€¼å¯¹åŒ¹é…å°±èƒ½æ¥å—åˆ°æ¶ˆæ¯ã€‚ Headersäº¤æ¢å™¨ä¹Ÿæ˜¯å¿½ç•¥è·¯ç”±é”®çš„ï¼Œåªä¾èµ–äºæ¶ˆæ¯å±æ€§ä¸­çš„æ¶ˆæ¯å¤´è¿›è¡Œæ¶ˆæ¯è·¯ç”±ã€‚ é˜Ÿåˆ— AMQP 0-9-1æ¨¡å‹ä¸­çš„é˜Ÿåˆ—ä¸å…¶ä»–æ¶ˆæ¯æˆ–è€…ä»»åŠ¡é˜Ÿåˆ—ç³»ç»Ÿä¸­çš„é˜Ÿåˆ—éå¸¸ç›¸ä¼¼ï¼šå®ƒä»¬å­˜å‚¨åº”ç”¨ç¨‹åºæ‰€ä½¿ç”¨çš„æ¶ˆæ¯ã€‚é˜Ÿåˆ—å’Œäº¤æ¢å™¨çš„åŸºæœ¬å±æ€§æœ‰ç±»ä¼¼çš„åœ°æ–¹ï¼š Nameï¼šé˜Ÿåˆ—åç§°ã€‚ Durableï¼šæ˜¯å¦æŒä¹…åŒ–ï¼Œå¼€å¯æŒä¹…åŒ–æ„å‘³ç€æ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†é‡å¯åé˜Ÿåˆ—ä¾ç„¶å­˜åœ¨ï¼Œå¦åˆ™é˜Ÿåˆ—ä¼šè¢«åˆ é™¤ã€‚ Exclusiveï¼šæ˜¯å¦ç‹¬å çš„ï¼Œå¼€å¯é˜Ÿåˆ—ç‹¬å ç‰¹æ€§æ„å‘³ç€é˜Ÿåˆ—åªèƒ½è¢«ä¸€ä¸ªè¿æ¥ä½¿ç”¨å¹¶ä¸”è¿æ¥å…³é—­ä¹‹åé˜Ÿåˆ—ä¼šè¢«åˆ é™¤ã€‚ Auto-deleteï¼šæ˜¯å¦è‡ªåŠ¨åˆ é™¤ï¼Œå¼€å¯è‡ªåŠ¨åˆ é™¤ç‰¹æ€§æ„å‘³ç€é˜Ÿåˆ—è‡³å°‘æœ‰ä¸€ä¸ªæ¶ˆè´¹è€…å¹¶ä¸”æœ€åä¸€ä¸ªæ¶ˆè´¹è€…è§£é™¤è®¢é˜…çŠ¶æ€(ä¸€èˆ¬æ˜¯æ¶ˆè´¹è€…å¯¹åº”çš„é€šé“å…³é—­)åé˜Ÿåˆ—ä¼šè‡ªåŠ¨åˆ é™¤ã€‚ Argumentsï¼šé˜Ÿåˆ—å‚æ•°ï¼Œä¸€èˆ¬å’Œæ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†æˆ–è€…æ’ä»¶çš„ç‰¹æ€§ç›¸å…³ï¼Œå¦‚æ¶ˆæ¯çš„è¿‡æœŸæ—¶é—´(Message TTL)å’Œé˜Ÿåˆ—é•¿åº¦ç­‰ã€‚ ä¸€ä¸ªé˜Ÿåˆ—åªæœ‰è¢«å£°æ˜(Declare)äº†æ‰èƒ½ä½¿ç”¨ï¼Œä¹Ÿå°±æ˜¯é˜Ÿåˆ—çš„ç¬¬ä¸€æ¬¡å£°æ˜å°±æ˜¯é˜Ÿåˆ—çš„åˆ›å»ºæ“ä½œ(å› ä¸ºç¬¬ä¸€æ¬¡å£°æ˜çš„æ—¶å€™é˜Ÿåˆ—å¹¶ä¸å­˜åœ¨)ã€‚å¦‚æœä½¿ç”¨ç›¸åŒçš„å‚æ•°å†æ¬¡å£°æ˜å·²ç»å­˜åœ¨çš„é˜Ÿåˆ—ï¼Œé‚£ä¹ˆæ­¤æ¬¡å£°æ˜ä¼šä¸ç”Ÿæ•ˆ(å½“ç„¶ä¹Ÿä¸ä¼šå‡ºç°å¼‚å¸¸)ã€‚ä½†æ˜¯å¦‚æœä½¿ç”¨ä¸ç›¸åŒçš„å‚æ•°å†æ¬¡å£°æ˜å·²ç»å­˜åœ¨çš„é˜Ÿåˆ—ï¼Œé‚£ä¹ˆä¼šæŠ›å‡ºé€šé“çº§åˆ«çš„å¼‚å¸¸ï¼Œå¼‚å¸¸ä»£ç æ˜¯406(PRECONDITION_FAILED)ã€‚ é˜Ÿåˆ—åç§° é˜Ÿåˆ—åå¿…é¡»ç”±255å­—èŠ‚(bytes)é•¿åº¦ä»¥å†…çš„UTF-8ç¼–ç å­—ç¬¦ç»„æˆã€‚å®ç°AMQP 0-9-1è§„èŒƒçš„æ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†å…·å¤‡è‡ªåŠ¨ç”Ÿæˆéšæœºé˜Ÿåˆ—åçš„åŠŸèƒ½ï¼Œä¹Ÿå°±æ˜¯åœ¨å£°æ˜é˜Ÿåˆ—çš„æ—¶å€™ï¼Œé˜Ÿåˆ—åæŒ‡å®šä¸ºç©ºå­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆæ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†ä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªé˜Ÿåˆ—åï¼Œå¹¶ä¸”åœ¨é˜Ÿåˆ—å£°æ˜çš„è¿”å›ç»“æœä¸­å¸¦ä¸Šå¯¹åº”çš„é˜Ÿåˆ—åã€‚ ä»¥&quot;amq.&quot;å¼€å¤´çš„é˜Ÿåˆ—æ˜¯ç”±æ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†å†…éƒ¨ç”Ÿæˆçš„ï¼Œæœ‰å…¶ç‰¹æ®Šçš„ä½œç”¨ï¼Œå› æ­¤ä¸èƒ½å£°æ˜æ­¤ç±»åç§°çš„æ–°é˜Ÿåˆ—ï¼Œå¦åˆ™ä¼šå¯¼è‡´é€šé“çº§åˆ«çš„å¼‚å¸¸ï¼Œå¼‚å¸¸ä»£ç ä¸º403(ACCESS_REFUSED)ã€‚ é˜Ÿåˆ—çš„æŒä¹…åŒ–ç‰¹æ€§ æŒä¹…åŒ–çš„é˜Ÿåˆ—ä¼šæŒä¹…åŒ–åˆ°ç£ç›˜ä¸­ï¼Œè¿™ç§é˜Ÿåˆ—åœ¨æ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†é‡å¯åä¸ä¼šè¢«åˆ é™¤ã€‚ä¸å¼€å¯æŒä¹…åŒ–ç‰¹æ€§çš„é˜Ÿåˆ—ç§°ä¸ºç¬æ—¶(transient)é˜Ÿåˆ—ï¼Œå¹¶éæ‰€æœ‰çš„åœºæ™¯éƒ½éœ€è¦å¼€å¯é˜Ÿåˆ—çš„æŒä¹…åŒ–ç‰¹æ€§ã€‚ é˜Ÿåˆ—çš„æŒä¹…åŒ–ç‰¹æ€§å¹¶ä¸æ„å‘³ç€è·¯ç”±åˆ°å®ƒä¸Šé¢çš„æ¶ˆæ¯æ˜¯æŒä¹…åŒ–çš„ï¼Œä¹Ÿå°±æ˜¯é˜Ÿåˆ—çš„æŒä¹…åŒ–è·Ÿæ¶ˆæ¯çš„æŒä¹…åŒ–æ˜¯ä¸¤å›äº‹ã€‚å¦‚æœæ¯ä¸­é—´ä»¶ä»£ç†æŒ‚äº†ï¼Œå®ƒé‡å¯åä¼šé‡æ–°å£°æ˜å¼€å¯äº†æŒä¹…åŒ–ç‰¹æ€§çš„é˜Ÿåˆ—ï¼Œè¿™äº›é˜Ÿåˆ—ä¸­åªæœ‰ä½¿ç”¨äº†æ¶ˆæ¯æŒä¹…åŒ–ç‰¹æ€§çš„æ¶ˆæ¯ä¼šè¢«æ¢å¤ã€‚ ç»‘å®š ç»‘å®š(Binding)æ˜¯äº¤æ¢å™¨è·¯ç”±æ¶ˆæ¯åˆ°é˜Ÿåˆ—çš„è§„åˆ™ã€‚ä¾‹å¦‚äº¤æ¢å™¨Eå¯ä»¥è·¯ç”±æ¶ˆæ¯åˆ°é˜Ÿåˆ—Qï¼Œé‚£ä¹ˆQå¿…é¡»é€šè¿‡ä¸€å®šçš„è§„åˆ™ç»‘å®šåˆ°Eã€‚ç»‘å®šä¸­ä½¿ç”¨çš„æŸäº›äº¤æ¢å™¨çš„ç±»å‹å†³å®šäº†å®ƒå¯ä»¥ä½¿ç”¨å¯é€‰çš„è·¯ç”±é”®(RoutingKey)ã€‚è·¯ç”±é”®çš„ä½œç”¨ç±»ä¼¼äºè¿‡æ»¤å™¨ï¼Œå¯ä»¥ç­›é€‰æŸäº›å‘å¸ƒåˆ°äº¤æ¢å™¨çš„æ¶ˆæ¯è·¯ç”±åˆ°ç›®æ ‡é˜Ÿåˆ—ã€‚ å¦‚æœå‘å¸ƒçš„æ¶ˆæ¯æ²¡æœ‰è·¯ç”±åˆ°ä»»æ„ä¸€ä¸ªç›®æ ‡é˜Ÿåˆ—ï¼Œä¾‹å¦‚ï¼Œæ¶ˆæ¯å·²ç»å‘å¸ƒåˆ°äº¤æ¢å™¨ï¼Œäº¤æ¢å™¨ä¸­æ²¡æœ‰ä»»ä½•ç»‘å®šï¼Œè¿™ä¸ªæ—¶å€™æ¶ˆæ¯ä¼šè¢«ä¸¢å¼ƒæˆ–è€…è¿”å›ç»™å‘å¸ƒè€…ï¼Œå–å†³äºæ¶ˆæ¯å‘å¸ƒè€…å‘å¸ƒæ¶ˆæ¯æ—¶å€™ä½¿ç”¨çš„å‚æ•°ã€‚ æ¶ˆè´¹è€… å¦‚æœé˜Ÿåˆ—åªæœ‰å‘å¸ƒè€…ç”Ÿäº§æ¶ˆæ¯ï¼Œé‚£ä¹ˆæ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œå¿…é¡»æœ‰æ¶ˆè´¹è€…å¯¹æ¶ˆæ¯è¿›è¡Œä½¿ç”¨ï¼Œæˆ–è€…å«è¿™ä¸ªæ“ä½œä¸ºæ¶ˆæ¯æ¶ˆè´¹ï¼Œæ¶ˆæ¯æ¶ˆè´¹çš„æ–¹å¼æœ‰ä¸¤ç§ï¼š æ¶ˆæ¯ä»£ç†ä¸­é—´ä»¶å‘æ¶ˆè´¹è€…æ¨é€æ¶ˆæ¯(æ¨æ¨¡å¼ï¼Œä»£è¡¨æ–¹æ³•æ˜¯basic.consume)ã€‚ æ¶ˆè´¹è€…ä¸»åŠ¨å‘æ¶ˆæ¯ä»£ç†ä¸­é—´ä»¶æ‹‰å–æ¶ˆæ¯(æ‹‰æ¨¡å¼ï¼Œä»£è¡¨æ–¹æ³•æ˜¯basic.get)ã€‚ ä½¿ç”¨æ¨æ¨¡å¼çš„æƒ…å†µä¸‹ï¼Œæ¶ˆè´¹è€…å¿…é¡»æŒ‡å®šéœ€è¦è®¢é˜…çš„é˜Ÿåˆ—ã€‚æ¯ä¸ªé˜Ÿåˆ—å¯ä»¥å­˜åœ¨å¤šä¸ªæ¶ˆè´¹è€…ï¼Œæˆ–è€…ä»…ä»…æ³¨å†Œä¸€ä¸ªç‹¬å çš„æ¶ˆè´¹è€…ã€‚ æ¯ä¸ªæ¶ˆè´¹è€…(è®¢é˜…è€…)éƒ½æœ‰ä¸€ä¸ªç§°ä¸ºæ¶ˆè´¹è€…æ ‡ç­¾(consumer tag)çš„æ ‡è¯†ç¬¦ï¼Œæ¶ˆè´¹è€…æ ‡ç­¾æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ã€‚é€šè¿‡æ¶ˆè´¹è€…æ ‡ç­¾å¯ä»¥å®ç°å–æ¶ˆè®¢é˜…çš„æ“ä½œã€‚ æ¶ˆæ¯ç¡®è®¤ æ¶ˆè´¹è€…åº”ç”¨ç¨‹åºæœ‰å¯èƒ½åœ¨æ¥æ”¶å’Œå¤„ç†æ¶ˆæ¯çš„æ—¶å€™å´©æºƒï¼Œä¹Ÿæœ‰å¯èƒ½å› ä¸ºç½‘ç»œåŸå› å¯¼è‡´æ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†æŠ•é€’æ¶ˆæ¯åˆ°æ¶ˆè´¹è€…çš„æ—¶å€™å¤±è´¥äº†ï¼Œè¿™æ ·å°±ä¼šå‚¬ç”Ÿä¸€ä¸ªé—®é¢˜ï¼šAMQPæ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†åº”è¯¥åœ¨ä»€ä¹ˆæ—¶å€™ä»é˜Ÿåˆ—ä¸­åˆ é™¤æ¶ˆæ¯ï¼Ÿå› æ­¤ï¼ŒAMQP 0-9-1è§„èŒƒæä¾›äº†ä¸¤ç§é€‰æ‹©ï¼š æ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†å‘åº”ç”¨ç¨‹åºå‘é€æ¶ˆæ¯(ä½¿ç”¨AMQPæ–¹æ³•basic.deliveræˆ–basic.get-ok)ã€‚ åº”ç”¨ç¨‹åºæ”¶åˆ°æ¶ˆæ¯åå‘æ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†å‘é€ç¡®è®¤(ä½¿ç”¨AMQPæ–¹æ³•basic.ack &lt;= ä¸ªäººæ„Ÿè§‰è¿™ä¸ªåœ°æ–¹å°‘å†™äº†basic.nackå’Œbasic.reject) å‰ä¸€ç§ç§°ä¸ºè‡ªåŠ¨ç¡®è®¤æ¨¡å‹(åŠ¨ä½œè§¦å‘çš„åŒæ—¶è¿›è¡Œäº†æ¶ˆæ¯ç¡®è®¤)ï¼Œåä¸€ç§ç§°ä¸ºæ˜¾å¼ç¡®è®¤æ¨¡å‹ã€‚æ˜¾å¼ç¡®è®¤æ¨¡å‹ä¸­ï¼Œéœ€è¦æ¶ˆè´¹è€…ä¸»åŠ¨å‘æ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†è¿›è¡Œæ¶ˆæ¯ä¸»åŠ¨ç¡®è®¤ï¼Œè¿™ä¸ªæ¶ˆæ¯ä¸»åŠ¨ç¡®è®¤åŠ¨ä½œçš„æ‰§è¡Œæ—¶æœºå®Œå…¨ç”±åº”ç”¨ç¨‹åºæ§åˆ¶ã€‚æ¶ˆæ¯ä¸»åŠ¨ç¡®è®¤æœ‰ä¸‰ç§æ–¹å¼ï¼šç§¯æç¡®è®¤(ack)ã€æ¶ˆæç¡®è®¤(nack)å’Œæ‹’ç»(reject)ã€‚ é¢„å–æ¶ˆæ¯ é¢„å–æ¶ˆæ¯(Prefetching Messages)æ˜¯ä¸€ä¸ªç‰¹æ€§ã€‚å¯¹äºå¤šä¸ªæ¶ˆè´¹è€…å…±äº«åŒä¸€ä¸ªé˜Ÿåˆ—çš„æƒ…å†µï¼Œèƒ½å¤Ÿå‘ŠçŸ¥æ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†åœ¨å‘é€ä¸‹ä¸€ä¸ªç¡®è®¤ä¹‹å‰æŒ‡å®šæ¯ä¸ªæ¶ˆè´¹è€…ä¸€æ¬¡å¯ä»¥æ¥æ”¶æ¶ˆæ¯çš„æ¶ˆæ¯é‡ã€‚è¿™ä¸ªç‰¹æ€§å¯ä»¥ç†è§£ä¸ºç®€å•çš„è´Ÿè½½å‡è¡¡æŠ€æœ¯ï¼Œåœ¨æ‰¹é‡å‘å¸ƒæ¶ˆæ¯çš„åœºæ™¯ä¸‹èƒ½å¤Ÿæé«˜ååé‡ã€‚ æ¶ˆæ¯å±æ€§å’Œæœ‰æ•ˆè´Ÿè½½ AMQPæ¨¡å‹ä¸­ï¼Œæ¶ˆæ¯å…·æœ‰å±æ€§å€¼ã€‚AMQP 0-9-1è§„èŒƒå®šä¹‰äº†ä¸€äº›å¸¸è§çš„å±æ€§ï¼Œä¸€èˆ¬å¼€å‘äººå‘˜ä¸éœ€è¦å¤ªå…³æ³¨è¿™äº›å±æ€§ï¼š Content type Content encoding Routing key Delivery mode (persistent or not) Message priority Message publishing timestamp Expiration period Publisher application id è¿™äº›é€šç”¨çš„å±æ€§ä¸€èˆ¬æ˜¯æ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†ä½¿ç”¨çš„ï¼Œè¿˜æœ‰å¯ä»¥å®šåˆ¶çš„å¯é€‰å±æ€§headerï¼Œå½¢å¼æ˜¯é”®å€¼å¯¹ï¼Œç±»ä¼¼äºHTTPä¸­çš„è¯·æ±‚å¤´ã€‚æ¶ˆæ¯å±æ€§æ˜¯åœ¨å‘å¸ƒæ¶ˆæ¯çš„æ—¶å€™è®¾ç½®çš„ã€‚ AMQPæ¶ˆæ¯è¿˜æœ‰ä¸€ä¸ªæœ‰æ•ˆè½½è·(payloadï¼Œå…¶å®å°±æ˜¯æ¶ˆæ¯æ•°æ®ä½“)ï¼ŒAMQPä»£ç†å°†å…¶è§†ä¸ºä¸é€æ˜çš„å­—èŠ‚æ•°ç»„ï¼Œä¹Ÿå°±æ˜¯AMQPä»£ç†ä¸ä¼šæ£€æŸ¥æˆ–è€…ä¿®æ”¹æ¶ˆæ¯çš„æœ‰æ•ˆè½½è·ã€‚æœ‰äº›æ¶ˆæ¯å¯èƒ½åªåŒ…å«å±æ€§è€Œæ²¡æœ‰æœ‰æ•ˆè´Ÿè½½ã€‚é€šå¸¸ä½¿ç”¨åºåˆ—åŒ–æ ¼å¼(å¦‚JSONï¼ŒThriftï¼ŒProtocol Bufferså’ŒMessagePack)æ¥åºåˆ—åŒ–å’Œç»“æ„åŒ–æ•°æ®ï¼Œä»¥ä¾¿å°†å…¶ä½œä¸ºæ¶ˆæ¯æœ‰æ•ˆè´Ÿè½½å‘å¸ƒã€‚åœ¨ä¸€èˆ¬çº¦å®šä¸‹ï¼Œæ¶ˆæ¯å±æ€§ä¸­çš„Content typeå’ŒContent encodingä¸€èˆ¬å¯ä»¥è¡¨æ˜å…¶åºåˆ—åŒ–çš„æ–¹å¼ã€‚ æ¶ˆæ¯å‘å¸ƒæ”¯æŒæ¶ˆæ¯çš„æŒä¹…åŒ–ç‰¹æ€§ï¼Œæ¶ˆæ¯æŒä¹…åŒ–ç‰¹æ€§å¼€å¯åï¼Œæ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†ä¼šæŠŠæ¶ˆæ¯ä¿å­˜åˆ°ç£ç›˜ä¸­ï¼Œå¦‚æœé‡å¯ä»£ç†æ¶ˆæ¯ä¹Ÿä¸ä¼šä¸¢å¤±ã€‚å¼€å¯æ¶ˆæ¯æŒä¹…åŒ–ç‰¹æ€§å°†ä¼šå½±å“æ€§èƒ½ï¼Œä¸»è¦æ˜¯å› ä¸ºæ¶‰åŠåˆ°åˆ·ç›˜æ“ä½œã€‚ AMQP-0-9-1æ–¹æ³• AMQP 0-9-1å®šä¹‰äº†ä¸€äº›æ–¹æ³•ï¼Œå¯¹åº”äº†å®¢æˆ·ç«¯å’Œæ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†ä¹‹é—´äº¤äº’çš„ä¸€äº›æ“ä½œæ–¹æ³•ï¼Œè¿™äº›æ“ä½œæ–¹æ³•çš„è®¾è®¡è·Ÿé¢å‘å¯¹è±¡ç¼–ç¨‹è¯­è¨€ä¸­çš„æ–¹æ³•æ²¡æœ‰ä»»ä½•å…±åŒä¹‹å¤„ã€‚å¸¸ç”¨çš„äº¤æ¢å™¨ç›¸å…³çš„æ“ä½œæ–¹æ³•æœ‰ï¼š exchange.declare exchange.declare-OK exchange.delete exchange.delete-OK åœ¨é€»è¾‘ä¸Šï¼Œä¸Šé¢å‡ ä¸ªæ“ä½œæ–¹æ³•åœ¨å®¢æˆ·ç«¯å’Œæ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†ä¹‹é—´çš„äº¤äº’å¦‚ä¸‹ï¼š å¯¹äºé˜Ÿåˆ—ï¼Œä¹Ÿæœ‰ç±»ä¼¼çš„æ“ä½œæ–¹æ³•ï¼š queue.declare queue.declare-OK queue.delete queue.delete-OK å¹¶éæ‰€æœ‰çš„AMQPæ“ä½œæ–¹æ³•éƒ½æœ‰å“åº”ç»“æœæ“ä½œæ–¹æ³•ï¼Œåƒæ¶ˆæ¯å‘å¸ƒæ–¹æ³•basic.publishçš„ä½¿ç”¨æ˜¯æœ€å¹¿æ³›çš„ï¼Œæ­¤æ“ä½œæ–¹æ³•æ²¡æœ‰å¯¹åº”çš„å“åº”ç»“æœæ“ä½œæ–¹æ³•ã€‚æœ‰äº›æ“ä½œæ–¹æ³•å¯èƒ½æœ‰å¤šä¸ªå“åº”ç»“æœ(æ“ä½œæ–¹æ³•)ï¼Œä¾‹å¦‚basic.getã€‚ è¿æ¥(Connection) AMQPçš„è¿æ¥(Connection)é€šå¸¸æ˜¯é•¿æœŸå­˜åœ¨çš„ã€‚AMQPæ˜¯ä¸€ç§ä½¿ç”¨TCPè¿›è¡Œå¯é ä¼ é€’çš„åº”ç”¨ç¨‹åºçº§åè®®ã€‚AMQPè¿æ¥ä½¿ç”¨ç”¨æˆ·èº«ä»½éªŒè¯ï¼Œå¯ä»¥ä½¿ç”¨TLS(SSL)è¿›è¡Œä¿æŠ¤ã€‚å½“åº”ç”¨ç¨‹åºä¸å†éœ€è¦è¿æ¥åˆ°AMQPä»£ç†æ—¶ï¼Œå®ƒåº”è¯¥æ­£å¸¸å…³é—­AMQPè¿æ¥ï¼Œè€Œä¸æ˜¯çªç„¶å…³é—­åº•å±‚TCPè¿æ¥ã€‚ é€šé“(Channel) æŸäº›åº”ç”¨ç¨‹åºéœ€è¦ä¸AMQPä»£ç†ç¨‹åºå»ºç«‹å¤šä¸ªè¿æ¥ã€‚ä½†æ˜¯ï¼Œä¸å¸Œæœ›åŒæ—¶æ‰“å¼€è®¸å¤šTCPè¿æ¥ï¼Œå› ä¸ºè¿™æ ·åšä¼šæ¶ˆè€—ç³»ç»Ÿèµ„æºå¹¶ä½¿é…ç½®é˜²ç«å¢™å˜å¾—ååˆ†å›°éš¾ã€‚é€šé“(Channel)å¯ä»¥è®¤ä¸ºæ˜¯&quot;å…±äº«ä¸€ä¸ªå•ç‹¬çš„TCPè¿æ¥çš„è½»é‡çº§è¿æ¥&quot;ï¼Œä¸€ä¸ªAMQPè¿æ¥å¯ä»¥æ‹¥æœ‰å¤šä¸ªé€šé“ã€‚ å¯¹äºä½¿ç”¨äº†å¤šçº¿ç¨‹å¤„ç†çš„åº”ç”¨ç¨‹åºï¼Œæœ‰ä¸€ç§ä½¿ç”¨åœºæ™¯ååˆ†æ™®éï¼šæ¯ä¸ªçº¿ç¨‹å¼€å¯ä¸€ä¸ªæ–°çš„é€šé“ä½¿ç”¨ï¼Œè¿™äº›é€šé“æ˜¯çº¿ç¨‹é—´éš”ç¦»çš„ã€‚ å¦å¤–ï¼Œæ¯ä¸ªç‰¹å®šçš„é€šé“å’Œå…¶ä»–é€šé“æ˜¯ç›¸äº’éš”ç¦»çš„ï¼Œæ¯ä¸ªæ‰§è¡Œçš„AMQPæ“ä½œæ–¹æ³•(åŒ…æ‹¬å“åº”)éƒ½æºå¸¦ä¸€ä¸ªé€šé“çš„å”¯ä¸€æ ‡è¯†ï¼Œè¿™æ ·å®¢æˆ·ç«¯å°±èƒ½é€šè¿‡è¯¥é€šé“çš„å”¯ä¸€æ ‡è¯†å¾—çŸ¥æ“ä½œæ–¹æ³•æ˜¯å¯¹åº”å“ªä¸ªé€šé“å‘ç”Ÿçš„ã€‚ è™šæ‹Ÿä¸»æœº(Virtual Host) ä¸ºäº†ä½¿å•ä¸ªæ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†å¯ä»¥æ‰˜ç®¡å¤šä¸ªå®Œå…¨éš”ç¦»çš„&quot;ç¯å¢ƒ&quot;(è¿™é‡Œçš„éš”ç¦»æŒ‡çš„æ˜¯ç”¨æˆ·ç»„ã€äº¤äº’å™¨ã€é˜Ÿåˆ—ç­‰)ï¼ŒAMQPæä¾›äº†è™šæ‹Ÿä¸»æœº(Virtual Host)çš„æ¦‚å¿µã€‚å¤šä¸ªè™šæ‹Ÿä¸»æœºç±»ä¼¼äºè®¸å¤šä¸»æµçš„WebæœåŠ¡å™¨çš„è™šæ‹Ÿä¸»æœºï¼Œæä¾›äº†AMQPç»„ä»¶å®Œå…¨éš”ç¦»çš„ç¯å¢ƒã€‚AMQPå®¢æˆ·ç«¯å¯ä»¥åœ¨è¿æ¥æ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†æ—¶æŒ‡å®šéœ€è¦è¿æ¥çš„è™šæ‹Ÿä¸»æœºã€‚ ä¸ªäººç†è§£ å…³äºExchangeã€Queueå’ŒBinding ç†è§£RabbitMQä¸­çš„AMQPæ¨¡å‹ï¼Œå…¶å®ä»å¼€å‘è€…çš„è§’åº¦æ¥çœ‹ï¼Œæœ€é‡è¦çš„æ˜¯Exchangeã€Queueã€Bindingä¸‰è€…çš„å…³ç³»ï¼Œè¿™é‡Œè°ˆè°ˆä¸ªäººçš„è§è§£ã€‚æ¶ˆæ¯çš„å‘å¸ƒç¬¬ä¸€ç«™æ€»æ˜¯Exchangeï¼Œä»æ¨¡å‹ä¸Šçœ‹ï¼Œæ¶ˆæ¯å‘å¸ƒæ— æ³•ç›´æ¥å‘é€åˆ°é˜Ÿåˆ—ä¸­ã€‚Exchangeæœ¬èº«ä¸å­˜å‚¨æ¶ˆæ¯ï¼Œå®ƒåœ¨æ¥æ”¶åˆ°æ¶ˆæ¯ä¹‹åï¼Œä¼šåŸºäºè·¯ç”±è§„åˆ™ä¹Ÿå°±æ˜¯Bindingï¼ŒæŠŠæ¶ˆæ¯è·¯ç”±åˆ°ç›®æ ‡Queueä¸­ã€‚ä»å®é™…æ“ä½œæ¥çœ‹ï¼Œå£°æ˜è·¯ç”±è§„åˆ™æ€»æ˜¯åœ¨å‘å¸ƒæ¶ˆæ¯å’Œæ¶ˆè´¹æ¶ˆæ¯ä¹‹å‰ï¼Œä¹Ÿå°±æ˜¯ä¸€èˆ¬æ­¥éª¤å¦‚ä¸‹ï¼š 1ã€å£°æ˜Exchangeã€‚ 2ã€å£°æ˜Queueã€‚ 3ã€åŸºäºExchangeå’ŒQueueå£°æ˜Bindingï¼Œè¿™ä¸ªè¿‡ç¨‹æœ‰å¯èƒ½è‡ªå®šä¹‰ä¸€ä¸ªRoutingKeyã€‚ 4ã€é€šè¿‡Exchangeæ¶ˆæ¯å‘å¸ƒï¼Œè¿™ä¸ªè¿‡ç¨‹æœ‰å¯èƒ½ä½¿ç”¨åˆ°ä¸Šä¸€æ­¥å®šä¹‰çš„RoutingKeyã€‚ 5ã€é€šè¿‡Queueæ¶ˆè´¹æ¶ˆæ¯ã€‚ æˆ‘ä»¬æœ€å…³æ³¨çš„ä¸¤ä¸ªé˜¶æ®µï¼Œæ¶ˆæ¯å‘å¸ƒå’Œæ¶ˆæ¯æ¶ˆè´¹ä¸­ï¼Œæ¶ˆæ¯å‘å¸ƒå®é™…ä¸Šåªè·ŸExchangeæœ‰å…³ï¼Œè€Œæ¶ˆæ¯æ¶ˆè´¹å®é™…ä¸Šåªè·ŸQueueæœ‰å…³ã€‚Bindingå®é™…ä¸Šå°±æ˜¯Exchangeå’ŒQueueçš„å¥‘çº¦å…³ç³»ï¼Œä¼šç›´æ¥å½±å“æ¶ˆæ¯å‘å¸ƒé˜¶æ®µçš„æ¶ˆæ¯è·¯ç”±ã€‚é‚£ä¹ˆï¼Œè·¯ç”±å¤±è´¥ä¸€èˆ¬æ˜¯ä»€ä¹ˆæƒ…å†µå¯¼è‡´çš„ï¼Ÿè·¯ç”±å¤±è´¥ï¼Œå…¶å®å°±æ˜¯æ¶ˆæ¯å·²ç»å‘å¸ƒåˆ°Exchangeï¼Œè€ŒExchangeä¸­ä»æ—¢æœ‰çš„Bindingä¸­æ— æ³•æ‰¾åˆ°å­˜åœ¨çš„ç›®æ ‡Queueç”¨äºä¼ é€’æ¶ˆæ¯å‰¯æœ¬(ä¸€èˆ¬è€Œè¨€ï¼Œå¾ˆå°‘äººä¼šå‘é€æ¶ˆæ¯åˆ°ä¸€ä¸ªä¸å­˜åœ¨çš„Exchange)ã€‚æ¶ˆæ¯è·¯ç”±å¤±è´¥ï¼Œä»ç†è§£AMQPçš„æ¨¡å‹æ¥çœ‹ï¼Œå¯ä»¥ä»æ ¹æœ¬ä¸Šé¿å…çš„ï¼Œé™¤éæ˜¯æ¶ˆæ¯å‘å¸ƒè€…æ•…æ„èƒ¡ä¹±ä½¿ç”¨æˆ–è€…äººä¸ºé”™è¯¯ä½¿ç”¨äº†æœªå­˜åœ¨çš„RoutingKeyã€Exchangeæˆ–è€…è¯´æ˜¯Bindingå…³ç³»è€Œå¯¼è‡´çš„ã€‚ å…³äºExchangeçš„ç±»å‹ AMQP-0-9-1æ¨¡å‹ä¸­æ”¯æŒäº†å››ç§äº¤æ¢å™¨direct(å•æ’­)ã€fanout(å¹¿æ’­)ã€topic(å¤šæ’­)ã€headersï¼Œå®é™…ä¸Šï¼Œä»ä½¿ç”¨è€…è§’åº¦æ¥çœ‹ï¼Œå››ç§äº¤æ¢å™¨çš„åŠŸèƒ½æ˜¯å¯ä»¥ç›¸äº’å–ä»£çš„ã€‚ä¾‹å¦‚å¯ä»¥ä½¿ç”¨fanoutç±»å‹äº¤æ¢å™¨å®ç°å¹¿æ’­ï¼Œå…¶å®ä½¿ç”¨directç±»å‹äº¤æ¢å™¨ä¹Ÿæ˜¯å¯ä»¥å®ç°å¹¿æ’­çš„ï¼Œåªæ˜¯å¯¹åº”çš„directç±»å‹äº¤æ¢å™¨éœ€è¦é€šè¿‡å¤šä¸ªè·¯ç”±é”®ç»‘å®šåˆ°å¤šä¸ªç›®æ ‡é˜Ÿåˆ—ä¸­ã€‚åœ¨é¢å¯¹ç”Ÿäº§ç¯å¢ƒçš„æŠ€æœ¯é€‰å‹çš„æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦è€ƒè™‘æ€§èƒ½ã€ç»´æŠ¤éš¾åº¦ã€åˆç†æ€§ç­‰è§’åº¦å»è€ƒè™‘é€‰æ‹©ä»€ä¹ˆç±»å‹çš„äº¤æ¢å™¨ï¼Œå°±ä¸Šé¢çš„å¹¿æ’­æ¶ˆæ¯çš„ä¾‹å­ï¼Œæ˜¾ç„¶ä½¿ç”¨fanoutç±»å‹äº¤æ¢å™¨å¯ä»¥é¿å…å£°æ˜å¤šä¸ªç»‘å®šå…³ç³»ï¼Œè¿™æ ·åœ¨æ€§èƒ½ã€åˆç†æ€§ä¸Šæ˜¯æ›´ä¼˜çš„é€‰æ‹©ã€‚ å…³äºè´Ÿè½½å‡è¡¡ åœ¨AMQP-0-9-1æ¨¡å‹ä¸­ï¼Œè´Ÿè½½å‡è¡¡çš„å®ç°æ˜¯åŸºäºæ¶ˆè´¹è€…è€Œä¸æ˜¯åŸºäºé˜Ÿåˆ—(å‡†ç¡®æ¥è¯´åº”è¯¥æ˜¯æ¶ˆæ¯ä¼ é€’åˆ°é˜Ÿåˆ—çš„æ–¹å¼)ã€‚å®é™…ä¸Šï¼Œå‡ºç°æ¶ˆæ¯ç”Ÿäº§é€Ÿåº¦å¤§å¤§è¶…è¿‡æ¶ˆè´¹è€…çš„æ¶ˆè´¹é€Ÿåº¦çš„æ—¶å€™ï¼Œé˜Ÿåˆ—ä¸­æœ‰å¯èƒ½ä¼šå‡ºç°æ¶ˆæ¯ç§¯å‹ã€‚AMQP-0-9-1æ¨¡å‹ä¸­æ²¡æœ‰æä¾›åŸºäºé˜Ÿåˆ—è´Ÿè½½å‡è¡¡çš„ç‰¹æ€§ï¼Œä¹Ÿå°±æ˜¯å‡ºç°æ¶ˆæ¯ç”Ÿäº§é€Ÿåº¦å¤§å¤§è¶…è¿‡æ¶ˆè´¹è€…çš„æ¶ˆè´¹é€Ÿåº¦æ—¶å€™ï¼Œå¹¶ä¸ä¼šæŠŠæ¶ˆæ¯è·¯ç”±åˆ°å¤šä¸ªé˜Ÿåˆ—ä¸­ï¼Œè€Œæ˜¯é€šè¿‡é¢„å–æ¶ˆæ¯(Prefetching Messages)çš„ç‰¹æ€§ï¼Œç¡®å®šæ¶ˆæ¯è€…çš„æ¶ˆè´¹èƒ½åŠ›ï¼Œä»è€Œè°ƒæ•´æ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†æ¨é€æ¶ˆæ¯åˆ°å¯¹åº”æ¶ˆè´¹è€…çš„æ•°é‡ï¼Œè¿™æ ·å°±èƒ½å¤Ÿå®ç°æ¶ˆè´¹é€Ÿåº¦å¿«çš„æ¶ˆè´¹è€…èƒ½å¤Ÿæ¶ˆè´¹æ›´å¤šçš„æ¶ˆæ¯ï¼Œå‡å°‘äº§ç”Ÿæœ‰æ¶ˆè´¹è€…å¤„äºé¥¥é¥¿çŠ¶æ€å’Œæœ‰æ¶ˆè´¹è€…é•¿æœŸå¤„äºå¿™ç¢ŒçŠ¶æ€çš„é—®é¢˜ã€‚ å…³äºæ¶ˆæ¯ç¡®è®¤æœºåˆ¶ AMQPä¸­æä¾›çš„æ¶ˆæ¯ç¡®è®¤æœºåˆ¶ä¸»è¦åŒ…æ‹¬ç§¯æç¡®è®¤(ä¸€èˆ¬å«ackï¼ŒAcknowledgement)ã€æ¶ˆæç¡®è®¤(ä¸€èˆ¬å«nackï¼ŒNegative Acknowledgement)å’Œæ‹’ç»(reject)ã€‚æ¶ˆæ¯ç¡®è®¤æœºåˆ¶æ˜¯ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤±çš„é‡è¦æªæ–½ï¼Œå½“æ¶ˆè´¹è€…æ¥æ”¶åˆ°æ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†æ¨é€çš„æ¶ˆæ¯æ—¶å€™ï¼Œéœ€è¦ä¸»åŠ¨é€šçŸ¥æ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†æ¶ˆæ¯å·²ç»ç¡®è®¤æŠ•é€’æˆåŠŸï¼Œç„¶åæ¶ˆæ¯ä¸­é—´ä»¶ä»£ç†æ‰ä¼šä»é˜Ÿåˆ—ä¸­åˆ é™¤å¯¹åº”çš„æ¶ˆæ¯ã€‚æ²¡æœ‰ä¸»åŠ¨ç¡®è®¤çš„æ¶ˆæ¯å°±ä¼šå˜ä¸º&quot;nack&quot;çŠ¶æ€ï¼Œå¯ä»¥æƒ³è±¡ä¸ºæš‚å­˜åœ¨é˜Ÿåˆ—çš„&quot;nackåŒº&quot;ä¸­ï¼Œè¿™äº›æ¶ˆæ¯ä¸ä¼šæŠ•é€’åˆ°æ¶ˆè´¹è€…ï¼Œç›´åˆ°æ¶ˆè´¹è€…é‡å¯åï¼Œ&quot;nackåŒº&quot;ä¸­çš„æ¶ˆæ¯ä¼šé‡æ–°å˜ä¸º&quot;ready&quot;çŠ¶æ€ï¼Œå¯ä»¥é‡æ–°æŠ•é€’ç»™æ¶ˆè´¹è€…ã€‚å…³äºæ¶ˆæ¯ç¡®è®¤æœºåˆ¶å…¶å®åœºæ™¯æ¯”è¾ƒå¤æ‚ï¼Œåé¢å†åšä¸€ç¯‡æ–‡ç« ä¸“é—¨åˆ†æã€‚ å°ç»“ å‚è€ƒèµ„æ–™ï¼š AMQP 0-9-1 Model Explained","categories":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/categories/Middleware/"},{"name":"RabbitMQ","slug":"Middleware/RabbitMQ","permalink":"http://throwable.club/blog/categories/Middleware/RabbitMQ/"}],"tags":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/tags/Middleware/"},{"name":"RabbitMQ","slug":"RabbitMQ","permalink":"http://throwable.club/blog/tags/RabbitMQ/"}]},{"title":"RabbitMQæœåŠ¡ç«¯çš„å®‰è£…å’Œä½¿ç”¨","slug":"rabbitmq-installation","date":"2018-11-17T17:05:10.000Z","updated":"2018-11-20T15:50:43.252Z","comments":true,"path":"2018/11/18/rabbitmq-installation/","link":"","permalink":"http://throwable.club/2018/11/18/rabbitmq-installation/","excerpt":"","text":"å‰æ å·¥ä½œæ¥è¿‘3å¹´ï¼Œä¸€ç›´æœ‰ä½¿ç”¨RabbitMQä½œä¸ºæœåŠ¡é—´è§£è€¦çš„ä¸­é—´ä»¶ï¼Œä½†æ˜¯ä¸€ç›´æ²¡æœ‰åšä¸€ç³»åˆ—å­¦ä¹ å’Œæ€»ç»“ï¼Œè¿™é‡Œå†³å¿ƒåšä¸€ä¸ªç³»åˆ—æ€»ç»“ä¸€ä¸‹RabbitMQçš„è¿ç»´ã€ä½¿ç”¨ä»¥åŠç”Ÿäº§ä¸­é‡åˆ°çš„é—®é¢˜ç­‰ï¼Œä»¥ä¾¿æ—¥åç›´æ¥æ‹¿èµ·æ¥ä½¿ç”¨ã€‚æ•´ä¸ªç³»åˆ—ä½¿ç”¨çš„Linuxç³»ç»Ÿä¸ºCentOS 7çš„æœ€æ–°ç‰ˆæœ¬CentOS-7-x86_64-Minimal-1804ã€‚è€ŒRabbitMQ Serverä½¿ç”¨å½“å‰æœ€æ–°çš„ç‰ˆæœ¬3.7.9.RELEASEã€‚ RabbitMQ Serverçš„å®‰è£… RabbitMQ Serverä½¿ç”¨Erlangè¯­è¨€ç¼–å†™ï¼ŒErlangè¯­è¨€çš„å¹¶å‘ç¼–ç¨‹æ”¯æŒæ¯”è¾ƒä¼˜å¼‚ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦å…ˆå®‰è£…Erlang(ç±»ä¼¼äºæˆ‘ä»¬éœ€è¦è¿è¡ŒJavaç¨‹åºï¼Œè¦å…ˆå®‰è£…JVM)ï¼š 12# æ·»åŠ erlangçš„yumæºrpm --import https://packages.erlang-solutions.com/rpm/erlang_solutions.asc æˆ–è€…ç›´æ¥åœ¨ç›®å½•/etc/yum.repos.d/æ‰‹åŠ¨æ·»åŠ ä¸€ä¸ªæ–°çš„.repoæ–‡ä»¶(æ–‡ä»¶åå¯ä»¥éšæ„å¦‚erlang.repos)ï¼Œå†…å®¹æ˜¯ï¼š 123456[erlang-solutions]name=CentOS $releasever - $basearch - Erlang Solutionsbaseurl=https://packages.erlang-solutions.com/rpm/centos/$releasever/$basearchgpgcheck=1gpgkey=https://packages.erlang-solutions.com/rpm/erlang_solutions.ascenabled=1 ç„¶åæ‰§è¡Œå‘½ä»¤å®‰è£…Erlangï¼š 12# å®‰è£…erlangsudo yum install erlang å®‰è£…å®Œæˆä¹‹åErlangä¼šè‡ªè¡Œåå°è¿è¡Œï¼Œè¾“å…¥erlå°±èƒ½è¿›å…¥Erlangçš„å‘½ä»¤è¡Œå·¥å…·è¯´æ˜å®‰è£…æˆåŠŸï¼š å®‰è£…Erlangè¿‡ç¨‹ä¸­å¦‚æœæç¤ºï¼š 12error: Failed dependencies: epel-release is needed by erlang-solutions-1.0-1.noarch è¯´æ˜ç¼ºå°‘epel-releaseä¾èµ–ï¼Œé€šè¿‡sudo yum install epel-releaseå®‰è£…epel-releaseå³å¯ã€‚ æ¥ç€å¯ä»¥å®‰è£…RabbitMQ Serverï¼Œå…ˆä¸‹è½½å…¶RPMå®‰è£…åŒ…ï¼š 12## ä¸‹è½½wget https://github.com/rabbitmq/rabbitmq-server/releases/download/v3.7.9/rabbitmq-server-3.7.9-1.el7.noarch.rpm æ¥ç€åœ¨ä¸‹è½½æ–‡ä»¶ç›®å½•ä¸­æ‰§è¡Œå®‰è£…å‘½ä»¤ï¼š 1234# åœ¨Yumä»“åº“å¯ä»¥ä½¿ç”¨ä¹‹å‰ï¼Œéœ€è¦è®©RPMå·¥å…·ä¿¡ä»»RabbitMQçš„rpmåŒ…çš„ç­¾åï¼Œéœ€è¦æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤rpm --import https://www.rabbitmq.com/rabbitmq-release-signing-key.asc# Yumå®‰è£…yum install rabbitmq-server-3.7.9-1.el7.noarch.rpm å®‰è£…å®Œæˆåï¼ŒRabbitMQ Serverä¼šè‡ªè¡Œåœ¨åå°è¿è¡Œï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥æ‰§è¡Œå‘½ä»¤rabbitmqctl statuséªŒè¯å…¶çŠ¶æ€ï¼š RabbitMQ Serverå¯åŠ¨äºåœæ­¢ RabbitMQ Serverå·²ç»æˆåŠŸå®‰è£…ä¸ºCentOS 7çš„æœåŠ¡ï¼Œå®ƒçš„å¯åŠ¨å’Œåœæ­¢å¯ä»¥ç›´æ¥ä½¿ç”¨systemctlå‘½ä»¤ï¼š 1234567891011121314# å¯åŠ¨systemctl start rabbitmq-server# åœæ­¢systemctl stop rabbitmq-server# é‡å¯systemctl restart rabbitmq-server# å‰å°å¯åŠ¨,shellå…³é—­ä¼šshutdownrabbitmq-server start# åå°å¯åŠ¨rabbitmq-server -detached å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨RabbitMQ Serverçš„rabbitmqctlå‘½ä»¤(æ ¼å¼æ˜¯ï¼šrabbitmqctl [-n &lt;node&gt;] [-l] [-q] &lt;command&gt; [&lt;command options&gt;])ï¼š 1234# åœæ­¢Erlangä¸Šçš„nodeèŠ‚ç‚¹rabbitmqctl stop_app# å¯åŠ¨rabbitmqctl start_app å®‰è£…Webç®¡ç†æ’ä»¶ RabbitMQ Serverç®¡ç†æ’ä»¶çš„å‘½ä»¤æ˜¯rabbitmq-plugins [-n &lt;node&gt;] [-l] [-q] &lt;command&gt; [&lt;command options&gt;]ï¼Œcommandéƒ¨åˆ†ç›®å‰åªæœ‰ä¸‹é¢å‡ ä¸ªï¼š 123456Commands: disable &lt;plugin&gt;|--all [--offline] [--online] enable &lt;plugin&gt;|--all [--offline] [--online] help &lt;command&gt; list [pattern] [--verbose] [--minimal] [--enabled] [--implicitly-enabled] set [&lt;plugin&gt;] [--offline] [--online] æˆ‘ä»¬å¯ä»¥é€šè¿‡å‘½ä»¤rabbitmq-plugins listå…ˆå±•ç¤ºæ‰€æœ‰å¯ç”¨çš„æ’ä»¶ï¼š å…¶ä¸­çš„rabbitmq_managementå°±æ˜¯æˆ‘ä»¬éœ€è¦å®‰è£…çš„Webç®¡ç†ç•Œé¢ï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤å¯ç”¨Webç®¡ç†æ’ä»¶ï¼š 1rabbitmq-plugins enable rabbitmq_management å®é™…ä¸Šæ˜¯å¯ç”¨äº†rabbitmq_managementã€rabbitmq_management_agentã€rabbitmq_web_dispatchä¸‰ä¸ªæ’ä»¶ã€‚æ’ä»¶å¯åŠ¨å®Œæ¯•åï¼Œæˆ‘ä»¬éœ€è¦æ·»åŠ ä¸€ä¸ªæ–°çš„ç”¨æˆ·æˆ–è€…ä¿®æ”¹åŸæœ‰çš„guestç”¨æˆ·çš„æƒé™ï¼Œå› ä¸ºguestç”¨æˆ·åªå…è®¸ä½¿ç”¨localhostè®¿é—®Webç®¡ç†ç•Œé¢ã€‚ ç”¨æˆ·ç®¡ç† ç”¨æˆ·è´¦å·å¯†ç ç®¡ç†å¸¸ç”¨å‘½ä»¤å¦‚ä¸‹ï¼š 12345678910# æ–°å¢ä¸€ä¸ªç”¨æˆ·rabbitmqctl add_user $&#123;username&#125; $&#123;password&#125;# ä¿®æ”¹ç”¨æˆ·å¯†ç rabbitmqctl change_password $&#123;old_password&#125; $&#123;new_password&#125;# éªŒè¯ç”¨æˆ·å¯†ç rabbitmqctl authenticate_user $&#123;username&#125; $&#123;password&#125;# åˆ é™¤ç”¨æˆ·rabbitmqctl delete_user $&#123;username&#125;# å±•ç¤ºç”¨æˆ·åˆ—è¡¨rabbitmqctl list_users ä¾‹å¦‚åˆ›å»ºä¸€ä¸ªç”¨æˆ·åå’Œå¯†ç éƒ½æ˜¯rootçš„è´¦å·ï¼šrabbitmqctl add_user root rootã€‚ ç”¨æˆ·è§’è‰²(Tag)ç®¡ç†å¸¸ç”¨å‘½ä»¤æ ¼å¼æ˜¯rabbitmqctl set_user_tags ${username} ${tag...}ï¼Œå¯é€‰çš„è§’è‰²ç±»å‹æœ‰ï¼š Tag æè¿° none æ— è§’è‰²ï¼Œæ–°åˆ›å»ºçš„ç”¨æˆ·å°±æ˜¯è¿™ç±»å‹çš„Tag management å…·å¤‡Webç®¡ç†ç•Œé¢è®¿é—®æƒé™ policymaker å…·å¤‡managementæ‰€æœ‰æƒé™ï¼Œå¯ä»¥ç®¡ç†policyå’Œparameter monitoring å…·å¤‡policymakeræ‰€æœ‰æƒé™ï¼Œå¯ä»¥ç›‘æ§è¿æ¥ã€channelã€èŠ‚ç‚¹ä¿¡æ¯ç­‰ administrator ç®¡ç†å‘˜æƒé™ ä¾‹å¦‚ä¸ºrootè´¦å·èµ‹äºˆç®¡ç†å‘˜æƒé™ï¼šrabbitmqctl set_user_tags root administratorã€‚ ç”¨æˆ·æƒé™(Permission)ç®¡ç†å¸¸ç”¨å‘½ä»¤å¦‚ä¸‹ï¼š 12345678910111213141516# æ·»åŠ æƒé™# vhostï¼šè™šæ‹Ÿhostï¼Œé»˜è®¤ä¸º\"/\"# usernameï¼šç”¨æˆ·å# confï¼šé…ç½®æƒé™ï¼Œå¯ä»¥ç”¨æ­£åˆ™è¡¨è¾¾å¼# writeï¼šå†™æƒé™ï¼Œå¯ä»¥ç”¨æ­£åˆ™è¡¨è¾¾å¼# readï¼šè¯»æƒé™ï¼Œå¯ä»¥ç”¨æ­£åˆ™è¡¨è¾¾å¼rabbitmqctl set_permissions [-p vhost] $&#123;username&#125; $&#123;conf&#125; $&#123;write&#125; $&#123;read&#125;# æŸ¥çœ‹è™šæ‹Ÿhostæƒé™rabbitmqctl list_permissions [-p vhost]# æŸ¥çœ‹ç”¨æˆ·æƒé™rabbitmqctl list_user_permissions $&#123;username&#125;# æ¸…é™¤ç”¨æˆ·æƒé™rabbitmqctl clear_permissions [-p vhost] $&#123;username&#125; ä¾‹å¦‚ä¸ºrootè´¦å·èµ‹äºˆè™šæ‹Ÿhostä¸º&quot;/&quot;ä¸‹çš„æ‰€æœ‰çš„é…ç½®ã€è¯»ã€å†™æƒé™ï¼šrabbitmqctl set_permissions root &quot;.*&quot; &quot;.*&quot; &quot;.*&quot;ã€‚ æˆ‘ä»¬å¯ä»¥ä½¿ç”¨rootè´¦å·ç™»å½•Webç®¡ç†ç•Œé¢ï¼š å…³äºRabbitMQ Serverå¤šç§Ÿæˆ·(è™šæ‹ŸHost)ã€è§’è‰²ã€æƒé™ç®¡ç†çš„å…¶ä»–ç»†èŠ‚æš‚æ—¶ä¸å±•å¼€ï¼Œå› ä¸ºå¯èƒ½éœ€è¦ä¸å°‘çš„ç¯‡å¹…æ‰èƒ½è¯´æ˜ã€‚ å°ç»“ å…³äºRabbitMQ Serverçš„å‘½ä»¤å’Œè¿ç»´æ–¹é¢çš„ä¸œè¥¿æš‚æ—¶ä¸å¤§é‡å±•å¼€ï¼ŒæŒ‰ç…§ä¸Šé¢å‡ èŠ‚æ­å»ºå¥½çš„RabbitMQæœåŠ¡å¯¹äºæµ‹è¯•æˆ–è€…å¼€å‘è°ƒè¯•å·²ç»åŸºæœ¬å¯ç”¨ï¼Œæ¥ç€å°±å¯ä»¥é€šè¿‡å®˜æ–¹æä¾›çš„ä¾‹å­è¿›è¡Œå­¦ä¹ ã€‚ å‚è€ƒèµ„æ–™ï¼š https://www.erlang-solutions.com/resources/download.html http://www.rabbitmq.com/install-rpm.html å‚è€ƒèµ„æ–™çš„é“¾æ¥åœ¨å°†æ¥ä¸ç¡®å®šæ˜¯å¦æœ‰å˜ï¼Œä¸»è¦æ˜¯å‚è€ƒäº†erlangå’Œrabbitmqçš„å®˜æ–¹æ–‡æ¡£çš„å®‰è£…æç¤ºã€‚ (æœ¬æ–‡å®Œ c-1-d e-20181118)","categories":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/categories/Middleware/"},{"name":"RabbitMQ","slug":"Middleware/RabbitMQ","permalink":"http://throwable.club/blog/categories/Middleware/RabbitMQ/"}],"tags":[{"name":"Middleware","slug":"Middleware","permalink":"http://throwable.club/blog/tags/Middleware/"},{"name":"RabbitMQ","slug":"RabbitMQ","permalink":"http://throwable.club/blog/tags/RabbitMQ/"}]},{"title":"JVMåº”ç”¨åº¦é‡æ¡†æ¶Micrometerå®æˆ˜","slug":"jvm-micrometer-prometheus","date":"2018-11-17T03:34:18.000Z","updated":"2019-01-08T14:46:58.169Z","comments":true,"path":"2018/11/17/jvm-micrometer-prometheus/","link":"","permalink":"http://throwable.club/2018/11/17/jvm-micrometer-prometheus/","excerpt":"","text":"JVMåº”ç”¨åº¦é‡æ¡†æ¶Micrometerå®æˆ˜ å‰æ æœ€è¿‘çº¿ä¸Šçš„é¡¹ç›®ä½¿ç”¨äº†spring-actuatoråšåº¦é‡ç»Ÿè®¡æ”¶é›†ï¼Œä½¿ç”¨Prometheusè¿›è¡Œæ•°æ®æ”¶é›†ï¼ŒGrafanaè¿›è¡Œæ•°æ®å±•ç¤ºï¼Œç”¨äºç›‘æ§ç”Ÿæˆç¯å¢ƒæœºå™¨çš„æ€§èƒ½æŒ‡æ ‡å’Œä¸šåŠ¡æ•°æ®æŒ‡æ ‡ã€‚ä¸€èˆ¬ï¼Œæˆ‘ä»¬å«è¿™æ ·çš„æ“ä½œä¸º&quot;åŸ‹ç‚¹&quot;ã€‚SpringBootä¸­çš„ä¾èµ–spring-actuatorä¸­é›†æˆçš„åº¦é‡ç»Ÿè®¡APIä½¿ç”¨çš„æ¡†æ¶æ˜¯Micrometerï¼Œå®˜ç½‘æ˜¯Micrometer.ioã€‚åœ¨å®è·µä¸­å‘ç°äº†ä¸šåŠ¡å¼€å‘è€…æ»¥ç”¨äº†Micrometerçš„åº¦é‡ç±»å‹Counterï¼Œå¯¼è‡´æ— è®ºä»€ä¹ˆæƒ…å†µä¸‹éƒ½åªä½¿ç”¨è®¡æ•°ç»Ÿè®¡çš„åŠŸèƒ½ã€‚è¿™ç¯‡æ–‡ç« å°±æ˜¯åŸºäºMicrometeråˆ†æå…¶ä»–çš„åº¦é‡ç±»å‹APIçš„ä½œç”¨å’Œé€‚ç”¨åœºæ™¯ã€‚ Micrometeræä¾›çš„åº¦é‡ç±»åº“ Meteræ˜¯æŒ‡ä¸€ç»„ç”¨äºæ”¶é›†åº”ç”¨ä¸­çš„åº¦é‡æ•°æ®çš„æ¥å£ï¼ŒMeterå•è¯å¯ä»¥ç¿»è¯‘ä¸º&quot;ç±³&quot;æˆ–è€…&quot;åƒåˆ†å°º&quot;ï¼Œä½†æ˜¯æ˜¾ç„¶å¬èµ·æ¥éƒ½ä¸æ˜¯å¾ˆåˆç†ï¼Œå› æ­¤ä¸‹æ–‡ç›´æ¥å«Meterï¼Œç†è§£å®ƒä¸ºåº¦é‡æ¥å£å³å¯ã€‚Meteræ˜¯ç”±MeterRegistryåˆ›å»ºå’Œä¿å­˜çš„ï¼Œå¯ä»¥ç†è§£MeterRegistryæ˜¯Meterçš„å·¥å‚å’Œç¼“å­˜ä¸­å¿ƒï¼Œä¸€èˆ¬è€Œè¨€æ¯ä¸ªJVMåº”ç”¨åœ¨ä½¿ç”¨Micrometerçš„æ—¶å€™å¿…é¡»åˆ›å»ºä¸€ä¸ªMeterRegistryçš„å…·ä½“å®ç°ã€‚Micrometerä¸­ï¼ŒMeterçš„å…·ä½“ç±»å‹åŒ…æ‹¬ï¼šTimerï¼ŒCounterï¼ŒGaugeï¼ŒDistributionSummaryï¼ŒLongTaskTimerï¼ŒFunctionCounterï¼ŒFunctionTimerå’ŒTimeGaugeã€‚ä¸‹é¢åˆ†èŠ‚è¯¦ç»†ä»‹ç»è¿™äº›ç±»å‹çš„ä½¿ç”¨æ–¹æ³•å’Œå®æˆ˜ä½¿ç”¨åœºæ™¯ã€‚è€Œä¸€ä¸ªMeterå…·ä½“ç±»å‹éœ€è¦é€šè¿‡åå­—å’ŒTag(è¿™é‡ŒæŒ‡çš„æ˜¯Micrometeræä¾›çš„Tagæ¥å£)ä½œä¸ºå®ƒçš„å”¯ä¸€æ ‡è¯†ï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯å¯ä»¥ä½¿ç”¨åå­—è¿›è¡Œæ ‡è®°ï¼Œé€šè¿‡ä¸åŒçš„Tagå»åŒºåˆ†å¤šç§ç»´åº¦è¿›è¡Œæ•°æ®ç»Ÿè®¡ã€‚ MeterRegistry MeterRegistryåœ¨Micrometeræ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œä¸»è¦å®ç°åŒ…æ‹¬ï¼š 1ã€SimpleMeterRegistryï¼šæ¯ä¸ªMeterçš„æœ€æ–°æ•°æ®å¯ä»¥æ”¶é›†åˆ°SimpleMeterRegistryå®ä¾‹ä¸­ï¼Œä½†æ˜¯è¿™äº›æ•°æ®ä¸ä¼šå‘å¸ƒåˆ°å…¶ä»–ç³»ç»Ÿï¼Œä¹Ÿå°±æ˜¯æ•°æ®æ˜¯ä½äºåº”ç”¨çš„å†…å­˜ä¸­çš„ã€‚ 2ã€CompositeMeterRegistryï¼šå¤šä¸ªMeterRegistryèšåˆï¼Œå†…éƒ¨ç»´æŠ¤äº†ä¸€ä¸ªMeterRegistryçš„åˆ—è¡¨ã€‚ 3ã€å…¨å±€çš„MeterRegistryï¼šå·¥å‚ç±»io.micrometer.core.instrument.Metricsä¸­æŒæœ‰ä¸€ä¸ªé™æ€finalçš„CompositeMeterRegistryå®ä¾‹globalRegistryã€‚ å½“ç„¶ï¼Œä½¿ç”¨è€…ä¹Ÿå¯ä»¥è‡ªè¡Œç»§æ‰¿MeterRegistryå»å®ç°è‡ªå®šä¹‰çš„MeterRegistryã€‚SimpleMeterRegistryé€‚åˆåšè°ƒè¯•çš„æ—¶å€™ä½¿ç”¨ï¼Œå®ƒçš„ç®€å•ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š 123MeterRegistry registry = new SimpleMeterRegistry();Counter counter = registry.counter(\"counter\");counter.increment(); CompositeMeterRegistryå®ä¾‹åˆå§‹åŒ–çš„æ—¶å€™ï¼Œå†…éƒ¨æŒæœ‰çš„MeterRegistryåˆ—è¡¨æ˜¯ç©ºçš„ï¼Œå¦‚æœæ­¤æ—¶ç”¨å®ƒæ–°å¢ä¸€ä¸ªMeterå®ä¾‹ï¼ŒMeterå®ä¾‹çš„æ“ä½œæ˜¯æ— æ•ˆçš„ï¼š 123456789CompositeMeterRegistry composite = new CompositeMeterRegistry();Counter compositeCounter = composite.counter(\"counter\");compositeCounter.increment(); // &lt;- å®é™…ä¸Šè¿™ä¸€æ­¥æ“ä½œæ˜¯æ— æ•ˆçš„,ä½†æ˜¯ä¸ä¼šæŠ¥é”™SimpleMeterRegistry simple = new SimpleMeterRegistry();composite.add(simple); // &lt;- å‘CompositeMeterRegistryå®ä¾‹ä¸­æ·»åŠ SimpleMeterRegistryå®ä¾‹compositeCounter.increment(); // &lt;-è®¡æ•°æˆåŠŸ å…¨å±€çš„MeterRegistryçš„ä½¿ç”¨æ–¹å¼æ›´åŠ ç®€å•ä¾¿æ·ï¼Œå› ä¸ºä¸€åˆ‡åªéœ€è¦æ“ä½œå·¥å‚ç±»Metricsçš„é™æ€æ–¹æ³•ï¼š 123Metrics.addRegistry(new SimpleMeterRegistry());Counter counter = Metrics.counter(\"counter\", \"tag-1\", \"tag-2\");counter.increment(); Tagä¸Meterçš„å‘½å Micrometerä¸­ï¼ŒMeterçš„å‘½åçº¦å®šä½¿ç”¨è‹±æ–‡é€—å·(dotï¼Œä¹Ÿå°±æ˜¯&quot;.&quot;)åˆ†éš”å•è¯ã€‚ä½†æ˜¯å¯¹äºä¸åŒçš„ç›‘æ§ç³»ç»Ÿï¼Œå¯¹å‘½åçš„è§„çº¦å¯èƒ½å¹¶ä¸ç›¸åŒï¼Œå¦‚æœå‘½åè§„çº¦ä¸ä¸€è‡´ï¼Œåœ¨åšç›‘æ§ç³»ç»Ÿè¿ç§»æˆ–è€…åˆ‡æ¢çš„æ—¶å€™ï¼Œå¯èƒ½ä¼šå¯¹æ–°çš„ç³»ç»Ÿé€ æˆç ´åã€‚Micrometerä¸­ä½¿ç”¨è‹±æ–‡é€—å·åˆ†éš”å•è¯çš„å‘½åè§„åˆ™ï¼Œå†é€šè¿‡åº•å±‚çš„å‘½åè½¬æ¢æ¥å£NamingConventionè¿›è¡Œè½¬æ¢ï¼Œæœ€ç»ˆå¯ä»¥é€‚é…ä¸åŒçš„ç›‘æ§ç³»ç»Ÿï¼ŒåŒæ—¶å¯ä»¥æ¶ˆé™¤ç›‘æ§ç³»ç»Ÿä¸å…è®¸çš„ç‰¹æ®Šå­—ç¬¦çš„åç§°å’Œæ ‡è®°ç­‰ã€‚å¼€å‘è€…ä¹Ÿå¯ä»¥è¦†ç›–NamingConventionå®ç°è‡ªå®šä¹‰çš„å‘½åè½¬æ¢è§„åˆ™ï¼šregistry.config().namingConvention(myCustomNamingConvention);ã€‚åœ¨Micrometerä¸­ï¼Œå¯¹ä¸€äº›ä¸»æµçš„ç›‘æ§ç³»ç»Ÿæˆ–è€…å­˜å‚¨ç³»ç»Ÿçš„å‘½åè§„åˆ™æä¾›äº†é»˜è®¤çš„è½¬æ¢æ–¹å¼ï¼Œä¾‹å¦‚å½“æˆ‘ä»¬ä½¿ç”¨ä¸‹é¢çš„å‘½åæ—¶å€™ï¼š 12MeterRegistry registry = ...registry.timer(\"http.server.requests\"); å¯¹äºä¸åŒçš„ç›‘æ§ç³»ç»Ÿæˆ–è€…å­˜å‚¨ç³»ç»Ÿï¼Œå‘½åä¼šè‡ªåŠ¨è½¬æ¢å¦‚ä¸‹ï¼š 1ã€Prometheus - http_server_requests_duration_secondsã€‚ 2ã€Atlas - httpServerRequestsã€‚ 3ã€Graphite - http.server.requestsã€‚ 4ã€InfluxDB - http_server_requestsã€‚ å…¶å®NamingConventionå·²ç»æä¾›äº†5ç§é»˜è®¤çš„è½¬æ¢è§„åˆ™ï¼šdotã€snakeCaseã€camelCaseã€upperCamelCaseå’Œslashesã€‚ å¦å¤–ï¼ŒTag(æ ‡ç­¾)æ˜¯Micrometerçš„ä¸€ä¸ªé‡è¦çš„åŠŸèƒ½ï¼Œä¸¥æ ¼æ¥è¯´ï¼Œä¸€ä¸ªåº¦é‡æ¡†æ¶åªæœ‰å®ç°äº†æ ‡ç­¾çš„åŠŸèƒ½ï¼Œæ‰èƒ½çœŸæ­£åœ°å¤šç»´åº¦è¿›è¡Œåº¦é‡æ•°æ®æ”¶é›†ã€‚Tagçš„å‘½åä¸€èˆ¬éœ€è¦æ˜¯æœ‰æ„ä¹‰çš„ï¼Œæ‰€è°“æœ‰æ„ä¹‰å°±æ˜¯å¯ä»¥æ ¹æ®Tagçš„å‘½åå¯ä»¥æ¨æ–­å‡ºå®ƒæŒ‡å‘çš„æ•°æ®åˆ°åº•ä»£è¡¨ä»€ä¹ˆç»´åº¦æˆ–è€…ä»€ä¹ˆç±»å‹çš„åº¦é‡æŒ‡æ ‡ã€‚å‡è®¾æˆ‘ä»¬éœ€è¦ç›‘æ§æ•°æ®åº“çš„è°ƒç”¨å’ŒHttpè¯·æ±‚è°ƒç”¨ç»Ÿè®¡ï¼Œä¸€èˆ¬æ¨èçš„åšæ³•æ˜¯ï¼š 123MeterRegistry registry = ...registry.counter(\"database.calls\", \"db\", \"users\")registry.counter(\"http.requests\", \"uri\", \"/api/users\") è¿™æ ·ï¼Œå½“æˆ‘ä»¬é€‰æ‹©å‘½åä¸º&quot;database.calls&quot;çš„è®¡æ•°å™¨ï¼Œæˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥é€‰æ‹©åˆ†ç»„&quot;db&quot;æˆ–è€…&quot;users&quot;åˆ†åˆ«ç»Ÿè®¡ä¸åŒåˆ†ç»„å¯¹æ€»è°ƒç”¨æ•°çš„è´¡çŒ®æˆ–è€…ç»„æˆã€‚ä¸€ä¸ªåä¾‹å¦‚ä¸‹ï¼š 12345678MeterRegistry registry = ...registry.counter(\"calls\", \"class\", \"database\", \"db\", \"users\");registry.counter(\"calls\", \"class\", \"http\", \"uri\", \"/api/users\"); é€šè¿‡å‘½å&quot;calls&quot;å¾—åˆ°çš„è®¡æ•°å™¨ï¼Œç”±äºæ ‡ç­¾æ··ä¹±ï¼Œæ•°æ®æ˜¯åŸºæœ¬æ— æ³•åˆ†ç»„ç»Ÿè®¡åˆ†æï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥è®¤ä¸ºå¾—åˆ°çš„æ—¶é—´åºåˆ—çš„ç»Ÿè®¡æ•°æ®æ˜¯æ²¡æœ‰æ„ä¹‰çš„ã€‚å¯ä»¥å®šä¹‰å…¨å±€çš„Tagï¼Œä¹Ÿå°±æ˜¯å…¨å±€çš„Tagå®šä¹‰ä¹‹åï¼Œä¼šé™„åŠ åˆ°æ‰€æœ‰çš„ä½¿ç”¨åˆ°çš„Meterä¸Š(åªè¦æ˜¯ä½¿ç”¨åŒä¸€ä¸ªMeterRegistry)ï¼Œå…¨å±€çš„Tagå¯ä»¥è¿™æ ·å®šä¹‰ï¼š 1234MeterRegistry registry = ...registry.config().commonTags(\"stack\", \"prod\", \"region\", \"us-east-1\");// å’Œä¸Šé¢çš„æ„ä¹‰æ˜¯ä¸€æ ·çš„registry.config().commonTags(Arrays.asList(Tag.of(\"stack\", \"prod\"), Tag.of(\"region\", \"us-east-1\"))); åƒä¸Šé¢è¿™æ ·å­ä½¿ç”¨ï¼Œå°±èƒ½é€šè¿‡ä¸»æœºï¼Œå®ä¾‹ï¼ŒåŒºåŸŸï¼Œå †æ ˆç­‰æ“ä½œç¯å¢ƒè¿›è¡Œå¤šç»´åº¦æ·±å…¥åˆ†æã€‚ è¿˜æœ‰ä¸¤ç‚¹ç‚¹éœ€è¦æ³¨æ„ï¼š 1ã€Tagçš„å€¼å¿…é¡»ä¸ä¸ºnullã€‚ 2ã€Micrometerä¸­ï¼ŒTagå¿…é¡»æˆå¯¹å‡ºç°ï¼Œä¹Ÿå°±æ˜¯Tagå¿…é¡»è®¾ç½®ä¸ºå¶æ•°ä¸ªï¼Œå®é™…ä¸Šå®ƒä»¬ä»¥Key=Valueçš„å½¢å¼å­˜åœ¨ï¼Œå…·ä½“å¯ä»¥çœ‹io.micrometer.core.instrument.Tagæ¥å£ï¼š 12345678910111213public interface Tag extends Comparable&lt;Tag&gt; &#123; String getKey(); String getValue(); static Tag of(String key, String value) &#123; return new ImmutableTag(key, value); &#125; default int compareTo(Tag o) &#123; return this.getKey().compareTo(o.getKey()); &#125;&#125; å½“ç„¶ï¼Œæœ‰äº›æ—¶å€™ï¼Œæˆ‘ä»¬éœ€è¦è¿‡æ»¤ä¸€äº›å¿…è¦çš„æ ‡ç­¾æˆ–è€…åç§°è¿›è¡Œç»Ÿè®¡ï¼Œæˆ–è€…ä¸ºMeterçš„åç§°æ·»åŠ ç™½åå•ï¼Œè¿™ä¸ªæ—¶å€™å¯ä»¥ä½¿ç”¨MeterFilterã€‚MeterFilteræœ¬èº«æä¾›ä¸€äº›åˆ—çš„é™æ€æ–¹æ³•ï¼Œå¤šä¸ªMeterFilterå¯ä»¥å åŠ æˆ–è€…ç»„æˆé“¾å®ç°ç”¨æˆ·æœ€ç»ˆçš„è¿‡æ»¤ç­–ç•¥ã€‚ä¾‹å¦‚ï¼š 1234MeterRegistry registry = ...registry.config() .meterFilter(MeterFilter.ignoreTags(\"http\")) .meterFilter(MeterFilter.denyNameStartsWith(\"jvm\")); è¡¨ç¤ºå¿½ç•¥&quot;http&quot;æ ‡ç­¾ï¼Œæ‹’ç»åç§°ä»¥&quot;jvm&quot;å­—ç¬¦ä¸²å¼€å¤´çš„Meterã€‚æ›´å¤šç”¨æ³•å¯ä»¥å‚è¯¦ä¸€ä¸‹MeterFilterè¿™ä¸ªç±»ã€‚ Meterçš„å‘½åå’ŒMeterçš„Tagç›¸äº’ç»“åˆï¼Œä»¥å‘½åä¸ºè½´å¿ƒï¼Œä»¥Tagä¸ºå¤šç»´åº¦è¦ç´ ï¼Œå¯ä»¥ä½¿åº¦é‡æ•°æ®çš„ç»´åº¦æ›´åŠ ä¸°å¯Œï¼Œä¾¿äºç»Ÿè®¡å’Œåˆ†æã€‚ Meters å‰é¢æåˆ°Meterä¸»è¦åŒ…æ‹¬ï¼šTimerï¼ŒCounterï¼ŒGaugeï¼ŒDistributionSummaryï¼ŒLongTaskTimerï¼ŒFunctionCounterï¼ŒFunctionTimerå’ŒTimeGaugeã€‚ä¸‹é¢é€ä¸€åˆ†æå®ƒä»¬çš„ä½œç”¨å’Œä¸ªäººç†è§£çš„å®é™…ä½¿ç”¨åœºæ™¯(åº”è¯¥è¯´æ˜¯ç”Ÿäº§ç¯å¢ƒ)ã€‚ Counter Counteræ˜¯ä¸€ç§æ¯”è¾ƒç®€å•çš„Meterï¼Œå®ƒæ˜¯ä¸€ç§å•å€¼çš„åº¦é‡ç±»å‹ï¼Œæˆ–è€…è¯´æ˜¯ä¸€ä¸ªå•å€¼è®¡æ•°å™¨ã€‚Counteræ¥å£å…è®¸ä½¿ç”¨è€…ä½¿ç”¨ä¸€ä¸ªå›ºå®šå€¼(å¿…é¡»ä¸ºæ­£æ•°)è¿›è¡Œè®¡æ•°ã€‚å‡†ç¡®æ¥è¯´ï¼šCounterå°±æ˜¯ä¸€ä¸ªå¢é‡ä¸ºæ­£æ•°çš„å•å€¼è®¡æ•°å™¨ã€‚è¿™ä¸ªä¸¾ä¸ªå¾ˆç®€å•çš„ä½¿ç”¨ä¾‹å­ï¼š 1234MeterRegistry meterRegistry = new SimpleMeterRegistry();Counter counter = meterRegistry.counter(\"http.request\", \"createOrder\", \"/order/create\");counter.increment();System.out.println(counter.measure()); // [Measurement&#123;statistic='COUNT', value=1.0&#125;] ä½¿ç”¨åœºæ™¯ï¼š Counterçš„ä½œç”¨æ˜¯è®°å½•XXXçš„æ€»é‡æˆ–è€…è®¡æ•°å€¼ï¼Œé€‚ç”¨äºä¸€äº›å¢é•¿ç±»å‹çš„ç»Ÿè®¡ï¼Œä¾‹å¦‚ä¸‹å•ã€æ”¯ä»˜æ¬¡æ•°ã€Httpè¯·æ±‚æ€»é‡è®°å½•ç­‰ç­‰ï¼Œé€šè¿‡Tagå¯ä»¥åŒºåˆ†ä¸åŒçš„åœºæ™¯ï¼Œå¯¹äºä¸‹å•ï¼Œå¯ä»¥ä½¿ç”¨ä¸åŒçš„Tagæ ‡è®°ä¸åŒçš„ä¸šåŠ¡æ¥æºæˆ–è€…æ˜¯æŒ‰æ—¥æœŸåˆ’åˆ†ï¼Œå¯¹äºHttpè¯·æ±‚æ€»é‡è®°å½•ï¼Œå¯ä»¥ä½¿ç”¨TagåŒºåˆ†ä¸åŒçš„URLã€‚ç”¨ä¸‹å•ä¸šåŠ¡ä¸¾ä¸ªä¾‹å­ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051//å®ä½“@Datapublic class Order &#123; private String orderId; private Integer amount; private String channel; private LocalDateTime createTime;&#125;public class CounterMain &#123; private static final DateTimeFormatter FORMATTER = DateTimeFormatter.ofPattern(\"yyyy-MM-dd\"); static &#123; Metrics.addRegistry(new SimpleMeterRegistry()); &#125; public static void main(String[] args) throws Exception &#123; Order order1 = new Order(); order1.setOrderId(\"ORDER_ID_1\"); order1.setAmount(100); order1.setChannel(\"CHANNEL_A\"); order1.setCreateTime(LocalDateTime.now()); createOrder(order1); Order order2 = new Order(); order2.setOrderId(\"ORDER_ID_2\"); order2.setAmount(200); order2.setChannel(\"CHANNEL_B\"); order2.setCreateTime(LocalDateTime.now()); createOrder(order2); Search.in(Metrics.globalRegistry).meters().forEach(each -&gt; &#123; StringBuilder builder = new StringBuilder(); builder.append(\"name:\") .append(each.getId().getName()) .append(\",tags:\") .append(each.getId().getTags()) .append(\",type:\").append(each.getId().getType()) .append(\",value:\").append(each.measure()); System.out.println(builder.toString()); &#125;); &#125; private static void createOrder(Order order) &#123; //å¿½ç•¥è®¢å•å…¥åº“ç­‰æ“ä½œ Metrics.counter(\"order.create\", \"channel\", order.getChannel(), \"createTime\", FORMATTER.format(order.getCreateTime())).increment(); &#125;&#125; æ§åˆ¶å°è¾“å‡ºï¼š 12name:order.create,tags:[tag(channel=CHANNEL_A), tag(createTime=2018-11-10)],type:COUNTER,value:[Measurement&#123;statistic='COUNT', value=1.0&#125;]name:order.create,tags:[tag(channel=CHANNEL_B), tag(createTime=2018-11-10)],type:COUNTER,value:[Measurement&#123;statistic='COUNT', value=1.0&#125;] ä¸Šé¢çš„ä¾‹å­æ˜¯ä½¿ç”¨å…¨å±€é™æ€æ–¹æ³•å·¥å‚ç±»Metricså»æ„é€ Counterå®ä¾‹ï¼Œå®é™…ä¸Šï¼Œio.micrometer.core.instrument.Counteræ¥å£æä¾›äº†ä¸€ä¸ªå†…éƒ¨å»ºé€ å™¨ç±»Counter.Builderå»å®ä¾‹åŒ–Counterï¼ŒCounter.Builderçš„ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š 1234567891011public class CounterBuilderMain &#123; public static void main(String[] args) throws Exception&#123; Counter counter = Counter.builder(\"name\") //åç§° .baseUnit(\"unit\") //åŸºç¡€å•ä½ .description(\"desc\") //æè¿° .tag(\"tagKey\", \"tagValue\") //æ ‡ç­¾ .register(new SimpleMeterRegistry());//ç»‘å®šçš„MeterRegistry counter.increment(); &#125;&#125; FunctionCounter FunctionCounteræ˜¯Counterçš„ç‰¹åŒ–ç±»å‹ï¼Œå®ƒæŠŠè®¡æ•°å™¨æ•°å€¼å¢åŠ çš„åŠ¨ä½œæŠ½è±¡æˆæ¥å£ç±»å‹ToDoubleFunctionï¼Œè¿™ä¸ªæ¥å£JDK1.8ä¸­å¯¹äºFunctionçš„ç‰¹åŒ–ç±»å‹æ¥å£ã€‚FunctionCounterçš„ä½¿ç”¨åœºæ™¯å’ŒCounteræ˜¯ä¸€è‡´çš„ï¼Œè¿™é‡Œä»‹ç»ä¸€ä¸‹å®ƒçš„ç”¨æ³•ï¼š 123456789101112131415161718192021public class FunctionCounterMain &#123; public static void main(String[] args) throws Exception &#123; MeterRegistry registry = new SimpleMeterRegistry(); AtomicInteger n = new AtomicInteger(0); //è¿™é‡ŒToDoubleFunctionåŒ¿åå®ç°å…¶å®å¯ä»¥ä½¿ç”¨Lambdaè¡¨è¾¾å¼ç®€åŒ–ä¸ºAtomicInteger::get FunctionCounter.builder(\"functionCounter\", n, new ToDoubleFunction&lt;AtomicInteger&gt;() &#123; @Override public double applyAsDouble(AtomicInteger value) &#123; return value.get(); &#125; &#125;).baseUnit(\"function\") .description(\"functionCounter\") .tag(\"createOrder\", \"CHANNEL-A\") .register(registry); //ä¸‹é¢æ¨¡æ‹Ÿä¸‰æ¬¡è®¡æ•° n.incrementAndGet(); n.incrementAndGet(); n.incrementAndGet(); &#125;&#125; FunctionCounterä½¿ç”¨çš„ä¸€ä¸ªæ˜æ˜¾çš„å¥½å¤„æ˜¯ï¼Œæˆ‘ä»¬ä¸éœ€è¦æ„ŸçŸ¥FunctionCounterå®ä¾‹çš„å­˜åœ¨ï¼Œå®é™…ä¸Šæˆ‘ä»¬åªéœ€è¦æ“ä½œä½œä¸ºFunctionCounterå®ä¾‹æ„å»ºå…ƒç´ ä¹‹ä¸€çš„AtomicIntegerå®ä¾‹å³å¯ï¼Œè¿™ç§æ¥å£çš„è®¾è®¡æ–¹å¼åœ¨å¾ˆå¤šæ¡†æ¶é‡Œé¢éƒ½å¯ä»¥çœ‹åˆ°ã€‚ Timer Timer(è®¡æ—¶å™¨)é€‚ç”¨äºè®°å½•è€—æ—¶æ¯”è¾ƒçŸ­çš„äº‹ä»¶çš„æ‰§è¡Œæ—¶é—´ï¼Œé€šè¿‡æ—¶é—´åˆ†å¸ƒå±•ç¤ºäº‹ä»¶çš„åºåˆ—å’Œå‘ç”Ÿé¢‘ç‡ã€‚æ‰€æœ‰çš„Timerçš„å®ç°è‡³å°‘è®°å½•äº†å‘ç”Ÿçš„äº‹ä»¶çš„æ•°é‡å’Œè¿™äº›äº‹ä»¶çš„æ€»è€—æ—¶ï¼Œä»è€Œç”Ÿæˆä¸€ä¸ªæ—¶é—´åºåˆ—ã€‚Timerçš„åŸºæœ¬å•ä½åŸºäºæœåŠ¡ç«¯çš„æŒ‡æ ‡è€Œå®šï¼Œä½†æ˜¯å®é™…ä¸Šæˆ‘ä»¬ä¸éœ€è¦è¿‡äºå…³æ³¨Timerçš„åŸºæœ¬å•ä½ï¼Œå› ä¸ºMicrometeråœ¨å­˜å‚¨ç”Ÿæˆçš„æ—¶é—´åºåˆ—çš„æ—¶å€™ä¼šè‡ªåŠ¨é€‰æ‹©é€‚å½“çš„åŸºæœ¬å•ä½ã€‚Timeræ¥å£æä¾›çš„å¸¸ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š 12345678910111213141516171819202122232425262728293031323334353637public interface Timer extends Meter &#123; ... void record(long var1, TimeUnit var3); default void record(Duration duration) &#123; this.record(duration.toNanos(), TimeUnit.NANOSECONDS); &#125; &lt;T&gt; T record(Supplier&lt;T&gt; var1); &lt;T&gt; T recordCallable(Callable&lt;T&gt; var1) throws Exception; void record(Runnable var1); default Runnable wrap(Runnable f) &#123; return () -&gt; &#123; this.record(f); &#125;; &#125; default &lt;T&gt; Callable&lt;T&gt; wrap(Callable&lt;T&gt; f) &#123; return () -&gt; &#123; return this.recordCallable(f); &#125;; &#125; long count(); double totalTime(TimeUnit var1); default double mean(TimeUnit unit) &#123; return this.count() == 0L ? 0.0D : this.totalTime(unit) / (double)this.count(); &#125; double max(TimeUnit var1); ...&#125; å®é™…ä¸Šï¼Œæ¯”è¾ƒå¸¸ç”¨å’Œæ–¹ä¾¿çš„æ–¹æ³•æ˜¯å‡ ä¸ªå‡½æ•°å¼æ¥å£å…¥å‚çš„æ–¹æ³•ï¼š 123456Timer timer = ...timer.record(() -&gt; dontCareAboutReturnValue());timer.recordCallable(() -&gt; returnValue());Runnable r = timer.wrap(() -&gt; dontCareAboutReturnValue());Callable c = timer.wrap(() -&gt; returnValue()); ä½¿ç”¨åœºæ™¯ï¼š æ ¹æ®ä¸ªäººç»éªŒå’Œå®è·µï¼Œæ€»ç»“å¦‚ä¸‹ï¼š 1ã€è®°å½•æŒ‡å®šæ–¹æ³•çš„æ‰§è¡Œæ—¶é—´ç”¨äºå±•ç¤ºã€‚ 2ã€è®°å½•ä¸€äº›ä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´ï¼Œä»è€Œç¡®å®šæŸäº›æ•°æ®æ¥æºçš„é€Ÿç‡ï¼Œä¾‹å¦‚æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆæ¯çš„æ¶ˆè´¹é€Ÿç‡ç­‰ã€‚ è¿™é‡Œä¸¾ä¸ªå®é™…çš„ä¾‹å­ï¼Œè¦å¯¹ç³»ç»Ÿåšä¸€ä¸ªåŠŸèƒ½ï¼Œè®°å½•æŒ‡å®šæ–¹æ³•çš„æ‰§è¡Œæ—¶é—´ï¼Œè¿˜æ˜¯ç”¨ä¸‹å•æ–¹æ³•åšä¾‹å­ï¼š 1234567891011121314151617181920212223242526public class TimerMain &#123; private static final Random R = new Random(); static &#123; Metrics.addRegistry(new SimpleMeterRegistry()); &#125; public static void main(String[] args) throws Exception &#123; Order order1 = new Order(); order1.setOrderId(\"ORDER_ID_1\"); order1.setAmount(100); order1.setChannel(\"CHANNEL_A\"); order1.setCreateTime(LocalDateTime.now()); Timer timer = Metrics.timer(\"timer\", \"createOrder\", \"cost\"); timer.record(() -&gt; createOrder(order1)); &#125; private static void createOrder(Order order) &#123; try &#123; TimeUnit.SECONDS.sleep(R.nextInt(5)); //æ¨¡æ‹Ÿæ–¹æ³•è€—æ—¶ &#125; catch (InterruptedException e) &#123; //no-op &#125; &#125;&#125; åœ¨å®é™…ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œå¯ä»¥é€šè¿‡spring-aopæŠŠè®°å½•æ–¹æ³•è€—æ—¶çš„é€»è¾‘æŠ½è±¡åˆ°ä¸€ä¸ªåˆ‡é¢ä¸­ï¼Œè¿™æ ·å°±èƒ½å‡å°‘ä¸å¿…è¦çš„å†—ä½™çš„æ¨¡æ¿ä»£ç ã€‚ä¸Šé¢çš„ä¾‹å­æ˜¯é€šè¿‡Merticsæ„é€ Timerå®ä¾‹ï¼Œå®é™…ä¸Šä¹Ÿå¯ä»¥ä½¿ç”¨Builderæ„é€ ï¼š 123456MeterRegistry registry = ...Timer timer = Timer .builder(\"my.timer\") .description(\"a description of what this timer does\") // å¯é€‰ .tags(\"region\", \"test\") // å¯é€‰ .register(registry); å¦å¤–ï¼ŒTimerçš„ä½¿ç”¨è¿˜å¯ä»¥åŸºäºå®ƒçš„å†…éƒ¨ç±»Timer.Sampleï¼Œé€šè¿‡startå’Œstopä¸¤ä¸ªæ–¹æ³•è®°å½•ä¸¤è€…ä¹‹é—´çš„é€»è¾‘çš„æ‰§è¡Œè€—æ—¶ã€‚ä¾‹å¦‚ï¼š 123456Timer.Sample sample = Timer.start(registry);// è¿™é‡Œåšä¸šåŠ¡é€»è¾‘Response response = ...sample.stop(registry.timer(\"my.timer\", \"response\", response.status())); FunctionTimer FunctionTimeræ˜¯Timerçš„ç‰¹åŒ–ç±»å‹ï¼Œå®ƒä¸»è¦æä¾›ä¸¤ä¸ªå•è°ƒé€’å¢çš„å‡½æ•°(å…¶å®å¹¶ä¸æ˜¯å•è°ƒé€’å¢ï¼Œåªæ˜¯åœ¨ä½¿ç”¨ä¸­ä¸€èˆ¬éœ€è¦éšç€æ—¶é—´æœ€å°‘ä¿æŒä¸å˜æˆ–è€…è¯´ä¸å‡å°‘)ï¼šä¸€ä¸ªç”¨äºè®¡æ•°çš„å‡½æ•°å’Œä¸€ä¸ªç”¨äºè®°å½•æ€»è°ƒç”¨è€—æ—¶çš„å‡½æ•°ï¼Œå®ƒçš„å»ºé€ å™¨çš„å…¥å‚å¦‚ä¸‹ï¼š 12345678public interface FunctionTimer extends Meter &#123; static &lt;T&gt; Builder&lt;T&gt; builder(String name, T obj, ToLongFunction&lt;T&gt; countFunction, ToDoubleFunction&lt;T&gt; totalTimeFunction, TimeUnit totalTimeFunctionUnit) &#123; return new Builder&lt;&gt;(name, obj, countFunction, totalTimeFunction, totalTimeFunctionUnit); &#125; ...&#125; å®˜æ–¹æ–‡æ¡£ä¸­çš„ä¾‹å­å¦‚ä¸‹ï¼š 123456IMap&lt;?, ?&gt; cache = ...; // å‡è®¾ä½¿ç”¨äº†Hazelcastç¼“å­˜registry.more().timer(\"cache.gets.latency\", Tags.of(\"name\", cache.getName()), cache, c -&gt; c.getLocalMapStats().getGetOperationCount(), //å®é™…ä¸Šå°±æ˜¯cacheçš„ä¸€ä¸ªæ–¹æ³•ï¼Œè®°å½•ç¼“å­˜ç”Ÿå‘½å‘¨æœŸåˆå§‹åŒ–çš„å¢é‡(ä¸ªæ•°) c -&gt; c.getLocalMapStats().getTotalGetLatency(), // Getæ“ä½œçš„å»¶è¿Ÿæ—¶é—´æ€»é‡ï¼Œå¯ä»¥ç†è§£ä¸ºè€—æ—¶ TimeUnit.NANOSECONDS); æŒ‰ç…§ä¸ªäººç†è§£ï¼ŒToDoubleFunctionç”¨äºç»Ÿè®¡äº‹ä»¶ä¸ªæ•°ï¼ŒToDoubleFunctionç”¨äºè®°å½•æ‰§è¡Œæ€»æ—¶é—´ï¼Œå®é™…ä¸Šä¸¤ä¸ªå‡½æ•°éƒ½åªæ˜¯Functionå‡½æ•°çš„å˜ä½“ï¼Œè¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„æ˜¯æ€»æ—¶é—´çš„å•ä½totalTimeFunctionUnitã€‚ç®€å•çš„ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š 1234567891011121314public class FunctionTimerMain &#123; public static void main(String[] args) throws Exception &#123; //è¿™ä¸ªæ˜¯ä¸ºäº†æ»¡è¶³å‚æ•°,æš‚æ—¶ä¸éœ€è¦ç†ä¼š Object holder = new Object(); AtomicLong totalTimeNanos = new AtomicLong(0); AtomicLong totalCount = new AtomicLong(0); FunctionTimer.builder(\"functionTimer\", holder, p -&gt; totalCount.get(), p -&gt; totalTimeNanos.get(), TimeUnit.NANOSECONDS) .register(new SimpleMeterRegistry()); totalTimeNanos.addAndGet(10000000); totalCount.incrementAndGet(); &#125;&#125; LongTaskTimer LongTaskTimerä¹Ÿæ˜¯ä¸€ç§Timerçš„ç‰¹åŒ–ç±»å‹ï¼Œä¸»è¦ç”¨äºè®°å½•é•¿æ—¶é—´æ‰§è¡Œçš„ä»»åŠ¡çš„æŒç»­æ—¶é—´ï¼Œåœ¨ä»»åŠ¡å®Œæˆä¹‹å‰ï¼Œè¢«ç›‘æµ‹çš„äº‹ä»¶æˆ–è€…ä»»åŠ¡ä»ç„¶å¤„äºè¿è¡ŒçŠ¶æ€ï¼Œä»»åŠ¡å®Œæˆçš„æ—¶å€™ï¼Œä»»åŠ¡æ‰§è¡Œçš„æ€»è€—æ—¶æ‰ä¼šè¢«è®°å½•ä¸‹æ¥ã€‚LongTaskTimeré€‚åˆç”¨äºé•¿æ—¶é—´æŒç»­è¿è¡Œçš„äº‹ä»¶è€—æ—¶çš„è®°å½•ï¼Œä¾‹å¦‚ç›¸å¯¹è€—æ—¶çš„å®šæ—¶ä»»åŠ¡ã€‚åœ¨Springåº”ç”¨ä¸­ï¼Œå¯ä»¥ç®€å•åœ°ä½¿ç”¨@Scheduledå’Œ@Timedæ³¨è§£ï¼ŒåŸºäºspring-aopå®Œæˆå®šæ—¶è°ƒåº¦ä»»åŠ¡çš„æ€»è€—æ—¶è®°å½•ï¼š 12345@Timed(value = \"aws.scrape\", longTask = true)@Scheduled(fixedDelay = 360000)void scrapeResources() &#123; //è¿™é‡Œåšç›¸å¯¹è€—æ—¶çš„ä¸šåŠ¡é€»è¾‘&#125; å½“ç„¶ï¼Œåœ¨éspringä½“ç³»ä¸­ä¹Ÿèƒ½æ–¹ä¾¿åœ°ä½¿ç”¨LongTaskTimerï¼š 123456789101112131415public class LongTaskTimerMain &#123; public static void main(String[] args) throws Exception&#123; MeterRegistry meterRegistry = new SimpleMeterRegistry(); LongTaskTimer longTaskTimer = meterRegistry.more().longTaskTimer(\"longTaskTimer\"); longTaskTimer.record(() -&gt; &#123; //è¿™é‡Œç¼–å†™Taskçš„é€»è¾‘ &#125;); //æˆ–è€…è¿™æ · Metrics.more().longTaskTimer(\"longTaskTimer\").record(()-&gt; &#123; //è¿™é‡Œç¼–å†™Taskçš„é€»è¾‘ &#125;); &#125;&#125; Gauge Gauge(ä»ªè¡¨)æ˜¯è·å–å½“å‰åº¦é‡è®°å½•å€¼çš„å¥æŸ„ï¼Œä¹Ÿå°±æ˜¯å®ƒè¡¨ç¤ºä¸€ä¸ªå¯ä»¥ä»»æ„ä¸Šä¸‹æµ®åŠ¨çš„å•æ•°å€¼åº¦é‡Meterã€‚Gaugeé€šå¸¸ç”¨äºå˜åŠ¨çš„æµ‹é‡å€¼ï¼Œæµ‹é‡å€¼ç”¨ToDoubleFunctionå‚æ•°çš„è¿”å›å€¼è®¾ç½®ï¼Œå¦‚å½“å‰çš„å†…å­˜ä½¿ç”¨æƒ…å†µï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥æµ‹é‡ä¸Šä¸‹ç§»åŠ¨çš„&quot;è®¡æ•°&quot;ï¼Œæ¯”å¦‚é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯æ•°é‡ã€‚å®˜ç½‘æ–‡æ¡£ä¸­æåˆ°Gaugeçš„å…¸å‹ä½¿ç”¨åœºæ™¯æ˜¯ç”¨äºæµ‹é‡é›†åˆæˆ–æ˜ å°„çš„å¤§å°æˆ–è¿è¡ŒçŠ¶æ€ä¸­çš„çº¿ç¨‹æ•°ã€‚Gaugeä¸€èˆ¬ç”¨äºç›‘æµ‹æœ‰è‡ªç„¶ä¸Šç•Œçš„äº‹ä»¶æˆ–è€…ä»»åŠ¡ï¼Œè€ŒCounterä¸€èˆ¬ä½¿ç”¨äºæ— è‡ªç„¶ä¸Šç•Œçš„äº‹ä»¶æˆ–è€…ä»»åŠ¡çš„ç›‘æµ‹ï¼Œæ‰€ä»¥åƒHttpè¯·æ±‚æ€»é‡è®¡æ•°åº”è¯¥ä½¿ç”¨Counterè€ŒéGaugeã€‚MeterRegistryä¸­æä¾›äº†ä¸€äº›ä¾¿äºæ„å»ºç”¨äºè§‚å¯Ÿæ•°å€¼ã€å‡½æ•°ã€é›†åˆå’Œæ˜ å°„çš„Gaugeç›¸å…³çš„æ–¹æ³•ï¼š 123List&lt;String&gt; list = registry.gauge(\"listGauge\", Collections.emptyList(), new ArrayList&lt;&gt;(), List::size); List&lt;String&gt; list2 = registry.gaugeCollectionSize(\"listSize2\", Tags.empty(), new ArrayList&lt;&gt;()); Map&lt;String, Integer&gt; map = registry.gaugeMapSize(\"mapGauge\", Tags.empty(), new HashMap&lt;&gt;()); ä¸Šé¢çš„ä¸‰ä¸ªæ–¹æ³•é€šè¿‡MeterRegistryæ„å»ºGaugeå¹¶ä¸”è¿”å›äº†é›†åˆæˆ–è€…æ˜ å°„å®ä¾‹ï¼Œä½¿ç”¨è¿™äº›é›†åˆæˆ–è€…æ˜ å°„å®ä¾‹å°±èƒ½åœ¨å…¶sizeå˜åŒ–è¿‡ç¨‹ä¸­è®°å½•è¿™ä¸ªå˜æ›´å€¼ã€‚æ›´é‡è¦çš„ä¼˜ç‚¹æ˜¯ï¼Œæˆ‘ä»¬ä¸éœ€è¦æ„ŸçŸ¥Gaugeæ¥å£çš„å­˜åœ¨ï¼Œåªéœ€è¦åƒå¹³æ—¶ä¸€æ ·ä½¿ç”¨é›†åˆæˆ–è€…æ˜ å°„å®ä¾‹å°±å¯ä»¥äº†ã€‚æ­¤å¤–ï¼ŒGaugeè¿˜æ”¯æŒjava.lang.Numberçš„å­ç±»ï¼Œjava.util.concurrent.atomicåŒ…ä¸­çš„AtomicIntegerå’ŒAtomicLongï¼Œè¿˜æœ‰Guavaæä¾›çš„AtomicDoubleï¼š 123AtomicInteger n = registry.gauge(\"numberGauge\", new AtomicInteger(0));n.set(1);n.set(2); é™¤äº†ä½¿ç”¨MeterRegistryåˆ›å»ºGaugeä¹‹å¤–ï¼Œè¿˜å¯ä»¥ä½¿ç”¨å»ºé€ å™¨æµå¼åˆ›å»ºï¼š 123456//ä¸€èˆ¬æˆ‘ä»¬ä¸éœ€è¦æ“ä½œGaugeå®ä¾‹Gauge gauge = Gauge .builder(\"gauge\", myObj, myObj::gaugeValue) .description(\"a description of what this gauge does\") // å¯é€‰ .tags(\"region\", \"test\") // å¯é€‰ .register(registry); ä½¿ç”¨åœºæ™¯ï¼š æ ¹æ®ä¸ªäººç»éªŒå’Œå®è·µï¼Œæ€»ç»“å¦‚ä¸‹ï¼š 1ã€æœ‰è‡ªç„¶(ç‰©ç†)ä¸Šç•Œçš„æµ®åŠ¨å€¼çš„ç›‘æµ‹ï¼Œä¾‹å¦‚ç‰©ç†å†…å­˜ã€é›†åˆã€æ˜ å°„ã€æ•°å€¼ç­‰ã€‚ 2ã€æœ‰é€»è¾‘ä¸Šç•Œçš„æµ®åŠ¨å€¼çš„ç›‘æµ‹ï¼Œä¾‹å¦‚ç§¯å‹çš„æ¶ˆæ¯ã€(çº¿ç¨‹æ± ä¸­)ç§¯å‹çš„ä»»åŠ¡ç­‰ï¼Œå…¶å®æœ¬è´¨ä¹Ÿæ˜¯é›†åˆæˆ–è€…æ˜ å°„çš„ç›‘æµ‹ã€‚ ä¸¾ä¸ªç›¸å¯¹å®é™…çš„ä¾‹å­ï¼Œå‡è®¾æˆ‘ä»¬éœ€è¦å¯¹ç™»å½•åçš„ç”¨æˆ·å‘é€ä¸€æ¡çŸ­ä¿¡æˆ–è€…æ¨é€ï¼Œåšæ³•æ˜¯æ¶ˆæ¯å…ˆæŠ•æ”¾åˆ°ä¸€ä¸ªé˜»å¡é˜Ÿåˆ—ï¼Œå†ç”±ä¸€ä¸ªçº¿ç¨‹æ¶ˆè´¹æ¶ˆæ¯è¿›è¡Œå…¶ä»–æ“ä½œï¼š 1234567891011121314151617181920212223242526272829303132public class GaugeMain &#123; private static final MeterRegistry MR = new SimpleMeterRegistry(); private static final BlockingQueue&lt;Message&gt; QUEUE = new ArrayBlockingQueue&lt;&gt;(500); private static BlockingQueue&lt;Message&gt; REAL_QUEUE; static &#123; REAL_QUEUE = MR.gauge(\"messageGauge\", QUEUE, Collection::size); &#125; public static void main(String[] args) throws Exception &#123; consume(); Message message = new Message(); message.setUserId(1L); message.setContent(\"content\"); REAL_QUEUE.put(message); &#125; private static void consume() throws Exception &#123; new Thread(() -&gt; &#123; while (true) &#123; try &#123; Message message = REAL_QUEUE.take(); //handle message System.out.println(message); &#125; catch (InterruptedException e) &#123; //no-op &#125; &#125; &#125;).start(); &#125;&#125; ä¸Šé¢çš„ä¾‹å­ä»£ç å†™å¾—æ¯”è¾ƒç³Ÿç³•ï¼Œåªä¸ºäº†æ¼”ç¤ºç›¸å…³ä½¿ç”¨æ–¹å¼ï¼Œåˆ‡å‹¿ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚ TimeGauge TimeGaugeæ˜¯Gaugeçš„ç‰¹åŒ–ç±»å‹ï¼Œç›¸æ¯”Gaugeï¼Œå®ƒçš„æ„å»ºå™¨ä¸­å¤šäº†ä¸€ä¸ªTimeUnitç±»å‹çš„å‚æ•°ï¼Œç”¨äºæŒ‡å®šToDoubleFunctionå…¥å‚çš„åŸºç¡€æ—¶é—´å•ä½ã€‚è¿™é‡Œç®€å•ä¸¾ä¸ªä½¿ç”¨ä¾‹å­ï¼š 1234567891011121314151617181920212223242526272829303132public class TimeGaugeMain &#123; private static final SimpleMeterRegistry R = new SimpleMeterRegistry(); public static void main(String[] args) throws Exception&#123; AtomicInteger count = new AtomicInteger(); TimeGauge.Builder&lt;AtomicInteger&gt; timeGauge = TimeGauge.builder(\"timeGauge\", count, TimeUnit.SECONDS, AtomicInteger::get); timeGauge.register(R); count.addAndGet(10086); print(); count.set(1); print(); &#125; private static void print()throws Exception&#123; Search.in(R).meters().forEach(each -&gt; &#123; StringBuilder builder = new StringBuilder(); builder.append(\"name:\") .append(each.getId().getName()) .append(\",tags:\") .append(each.getId().getTags()) .append(\",type:\").append(each.getId().getType()) .append(\",value:\").append(each.measure()); System.out.println(builder.toString()); &#125;); &#125;&#125;//è¾“å‡ºname:timeGauge,tags:[],type:GAUGE,value:[Measurement&#123;statistic='VALUE', value=10086.0&#125;]name:timeGauge,tags:[],type:GAUGE,value:[Measurement&#123;statistic='VALUE', value=1.0&#125;] DistributionSummary Summary(æ‘˜è¦)ä¸»è¦ç”¨äºè·Ÿè¸ªäº‹ä»¶çš„åˆ†å¸ƒï¼Œåœ¨Micrometerä¸­ï¼Œå¯¹åº”çš„ç±»æ˜¯DistributionSummary(åˆ†å‘æ‘˜è¦)ã€‚å®ƒçš„ä½¿ç”¨æ–¹å¼å’ŒTimerååˆ†ç›¸ä¼¼ï¼Œä½†æ˜¯å®ƒçš„è®°å½•å€¼å¹¶ä¸ä¾èµ–äºæ—¶é—´å•ä½ã€‚å¸¸è§çš„ä½¿ç”¨åœºæ™¯ï¼šä½¿ç”¨DistributionSummaryæµ‹é‡å‘½ä¸­æœåŠ¡å™¨çš„è¯·æ±‚çš„æœ‰æ•ˆè´Ÿè½½å¤§å°ã€‚ä½¿ç”¨MeterRegistryåˆ›å»ºDistributionSummaryå®ä¾‹å¦‚ä¸‹ï¼š 1DistributionSummary summary = registry.summary(\"response.size\"); é€šè¿‡å»ºé€ å™¨æµå¼åˆ›å»ºå¦‚ä¸‹ï¼š 1234567DistributionSummary summary = DistributionSummary .builder(\"response.size\") .description(\"a description of what this summary does\") // å¯é€‰ .baseUnit(\"bytes\") // å¯é€‰ .tags(\"region\", \"test\") // å¯é€‰ .scale(100) // å¯é€‰ .register(registry); DistributionSummaryä¸­æœ‰å¾ˆå¤šæ„å»ºå‚æ•°è·Ÿç¼©æ”¾å’Œç›´æ–¹å›¾çš„è¡¨ç¤ºç›¸å…³ï¼Œè§ä¸‹ä¸€èŠ‚ã€‚ ä½¿ç”¨åœºæ™¯ï¼š æ ¹æ®ä¸ªäººç»éªŒå’Œå®è·µï¼Œæ€»ç»“å¦‚ä¸‹ï¼š 1ã€ä¸ä¾èµ–äºæ—¶é—´å•ä½çš„è®°å½•å€¼çš„æµ‹é‡ï¼Œä¾‹å¦‚æœåŠ¡å™¨æœ‰æ•ˆè´Ÿè½½å€¼ï¼Œç¼“å­˜çš„å‘½ä¸­ç‡ç­‰ã€‚ ä¸¾ä¸ªç›¸å¯¹å…·ä½“çš„ä¾‹å­ï¼š 1234567891011121314151617181920212223242526272829public class DistributionSummaryMain &#123; private static final DistributionSummary DS = DistributionSummary.builder(\"cacheHitPercent\") .register(new SimpleMeterRegistry()); private static final LoadingCache&lt;String, String&gt; CACHE = CacheBuilder.newBuilder() .maximumSize(1000) .recordStats() .expireAfterWrite(60, TimeUnit.SECONDS) .build(new CacheLoader&lt;String, String&gt;() &#123; @Override public String load(String s) throws Exception &#123; return selectFromDatabase(); &#125; &#125;); public static void main(String[] args) throws Exception&#123; String key = \"doge\"; String value = CACHE.get(key); record(); &#125; private static void record()throws Exception&#123; CacheStats stats = CACHE.stats(); BigDecimal hitCount = new BigDecimal(stats.hitCount()); BigDecimal requestCount = new BigDecimal(stats.requestCount()); DS.record(hitCount.divide(requestCount,2,BigDecimal.ROUND_HALF_DOWN).doubleValue()); &#125;&#125; ç›´æ–¹å›¾å’Œç™¾åˆ†æ•°é…ç½® ç›´æ–¹å›¾å’Œç™¾åˆ†æ•°é…ç½®é€‚ç”¨äºSummaryå’ŒTimerï¼Œè¿™éƒ¨åˆ†ç›¸å¯¹å¤æ‚ï¼Œç­‰ç ”ç©¶é€äº†å†è¡¥å……ã€‚ åŸºäºSpirngBootã€Prometheusã€Grafanaé›†æˆ é›†æˆäº†Micrometeræ¡†æ¶çš„JVMåº”ç”¨ä½¿ç”¨åˆ°Micrometerçš„APIæ”¶é›†çš„åº¦é‡æ•°æ®ä½äºå†…å­˜ä¹‹ä¸­ï¼Œå› æ­¤ï¼Œéœ€è¦é¢å¤–çš„å­˜å‚¨ç³»ç»Ÿå»å­˜å‚¨è¿™äº›åº¦é‡æ•°æ®ï¼Œéœ€è¦æœ‰ç›‘æ§ç³»ç»Ÿè´Ÿè´£ç»Ÿä¸€æ”¶é›†å’Œå¤„ç†è¿™äº›æ•°æ®ï¼Œè¿˜éœ€è¦æœ‰ä¸€äº›UIå·¥å…·å»å±•ç¤ºæ•°æ®ï¼Œä¸€èˆ¬å¤§ä½¬åªå–œæ¬¢çœ‹ç‚«é…·çš„å›¾è¡¨æˆ–è€…åŠ¨ç”»ã€‚å¸¸è§çš„å­˜å‚¨ç³»ç»Ÿå°±æ˜¯æ—¶åºæ•°æ®åº“ï¼Œä¸»æµçš„æœ‰Influxã€Datadogç­‰ã€‚æ¯”è¾ƒä¸»æµçš„ç›‘æ§ç³»ç»Ÿ(ä¸»è¦æ˜¯ç”¨äºæ•°æ®æ”¶é›†å’Œå¤„ç†)å°±æ˜¯Prometheus(ä¸€èˆ¬å«æ™®ç½—ç±³ä¿®æ–¯ï¼Œä¸‹é¢å°±è¿™æ ·å«å§)ã€‚è€Œå±•ç¤ºçš„UIç›®å‰ç›¸å¯¹ç”¨å¾—æ¯”è¾ƒå¤šçš„å°±æ˜¯Grafanaã€‚å¦å¤–ï¼ŒPrometheuså·²ç»å†…ç½®äº†ä¸€ä¸ªæ—¶åºæ•°æ®åº“çš„å®ç°ï¼Œå› æ­¤ï¼Œåœ¨åšä¸€å¥—ç›¸å¯¹å®Œå–„çš„åº¦é‡æ•°æ®ç›‘æ§çš„ç³»ç»Ÿåªéœ€è¦ä¾èµ–ç›®æ ‡JVMåº”ç”¨ï¼ŒPrometheusç»„ä»¶å’ŒGrafanaç»„ä»¶å³å¯ã€‚ä¸‹é¢èŠ±ä¸€ç‚¹æ—¶é—´ä»é›¶å¼€å§‹æ­å»ºä¸€ä¸ªè¿™æ ·çš„ç³»ç»Ÿï¼Œä¹‹å‰å†™çš„ä¸€ç¯‡æ–‡ç« åŸºäºWindowsç³»ç»Ÿï¼Œæ“ä½œå¯èƒ½è·Ÿç”Ÿäº§ç¯å¢ƒä¸å¤Ÿæ¥è¿‘ï¼Œè¿™æ¬¡ä½¿ç”¨CentOS7ã€‚ SpirngBootä¸­ä½¿ç”¨Micrometer SpringBootä¸­çš„spring-boot-starter-actuatorä¾èµ–å·²ç»é›†æˆäº†å¯¹Micrometerçš„æ”¯æŒï¼Œå…¶ä¸­çš„metricsç«¯ç‚¹çš„å¾ˆå¤šåŠŸèƒ½å°±æ˜¯é€šè¿‡Micrometerå®ç°çš„ï¼Œprometheusç«¯ç‚¹é»˜è®¤ä¹Ÿæ˜¯å¼€å¯æ”¯æŒçš„ï¼Œå®é™…ä¸Šactuatorä¾èµ–çš„spring-boot-actuator-autoconfigureä¸­é›†æˆäº†å¯¹å¾ˆå¤šæ¡†æ¶çš„å¼€ç®±å³ç”¨çš„APIï¼Œå…¶ä¸­prometheusåŒ…ä¸­é›†æˆäº†å¯¹Prometheusçš„æ”¯æŒï¼Œä½¿å¾—ä½¿ç”¨äº†actuatorå¯ä»¥è½»æ˜“åœ°è®©é¡¹ç›®æš´éœ²å‡ºprometheusç«¯ç‚¹ï¼Œä½œä¸ºPrometheusæ”¶é›†æ•°æ®çš„å®¢æˆ·ç«¯ï¼ŒPrometheus(æœåŠ¡ç«¯è½¯ä»¶)å¯ä»¥é€šè¿‡æ­¤ç«¯ç‚¹æ”¶é›†åº”ç”¨ä¸­Micrometerçš„åº¦é‡æ•°æ®ã€‚ æˆ‘ä»¬å…ˆå¼•å…¥spring-boot-starter-actuatorå’Œspring-boot-starter-webï¼Œå®ç°ä¸€ä¸ªCounterå’ŒTimerä½œä¸ºç¤ºä¾‹ã€‚ä¾èµ–ï¼š 1234567891011121314151617181920212223242526272829303132333435 &lt;dependencyManagement&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-dependencies&lt;/artifactId&gt; &lt;version&gt;2.1.0.RELEASE&lt;/version&gt; &lt;type&gt;pom&lt;/type&gt; &lt;scope&gt;import&lt;/scope&gt; &lt;/dependency&gt; &lt;/dependencies&gt; &lt;/dependencyManagement&gt; &lt;dependencies&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-web&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-aop&lt;/artifactId&gt; &lt;/dependency&gt; &lt;dependency&gt; &lt;groupId&gt;org.projectlombok&lt;/groupId&gt; &lt;artifactId&gt;lombok&lt;/artifactId&gt; &lt;version&gt;1.16.22&lt;/version&gt; &lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;io.micrometer&lt;/groupId&gt; &lt;artifactId&gt;micrometer-registry-prometheus&lt;/artifactId&gt; &lt;version&gt;1.1.0&lt;/version&gt; &lt;/dependency&gt; &lt;/dependencies&gt; æ¥ç€ç¼–å†™ä¸€ä¸ªä¸‹å•æ¥å£å’Œä¸€ä¸ªæ¶ˆæ¯å‘é€æ¨¡å—ï¼Œæ¨¡æ‹Ÿç”¨æˆ·ä¸‹å•ä¹‹åå‘ç”¨æˆ·å‘é€æ¶ˆæ¯ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129//å®ä½“@Datapublic class Message &#123; private String orderId; private Long userId; private String content;&#125;@Datapublic class Order &#123; private String orderId; private Long userId; private Integer amount; private LocalDateTime createTime;&#125;//æ§åˆ¶å™¨å’ŒæœåŠ¡ç±»@RestControllerpublic class OrderController &#123; @Autowired private OrderService orderService; @PostMapping(value = \"/order\") public ResponseEntity&lt;Boolean&gt; createOrder(@RequestBody Order order)&#123; return ResponseEntity.ok(orderService.createOrder(order)); &#125;&#125;@Slf4j@Servicepublic class OrderService &#123; private static final Random R = new Random(); @Autowired private MessageService messageService; public Boolean createOrder(Order order) &#123; //æ¨¡æ‹Ÿä¸‹å• try &#123; int ms = R.nextInt(50) + 50; TimeUnit.MILLISECONDS.sleep(ms); log.info(\"ä¿å­˜è®¢å•æ¨¡æ‹Ÿè€—æ—¶&#123;&#125;æ¯«ç§’...\", ms); &#125; catch (Exception e) &#123; //no-op &#125; //è®°å½•ä¸‹å•æ€»æ•° Metrics.counter(\"order.count\", \"order.channel\", order.getChannel()).increment(); //å‘é€æ¶ˆæ¯ Message message = new Message(); message.setContent(\"æ¨¡æ‹ŸçŸ­ä¿¡...\"); message.setOrderId(order.getOrderId()); message.setUserId(order.getUserId()); messageService.sendMessage(message); return true; &#125;&#125;@Slf4j@Servicepublic class MessageService implements InitializingBean &#123; private static final BlockingQueue&lt;Message&gt; QUEUE = new ArrayBlockingQueue&lt;&gt;(500); private static BlockingQueue&lt;Message&gt; REAL_QUEUE; private static final Executor EXECUTOR = Executors.newSingleThreadExecutor(); private static final Random R = new Random(); static &#123; REAL_QUEUE = Metrics.gauge(\"message.gauge\", Tags.of(\"message.gauge\", \"message.queue.size\"), QUEUE, Collection::size); &#125; public void sendMessage(Message message) &#123; try &#123; REAL_QUEUE.put(message); &#125; catch (InterruptedException e) &#123; //no-op &#125; &#125; @Override public void afterPropertiesSet() throws Exception &#123; EXECUTOR.execute(() -&gt; &#123; while (true) &#123; try &#123; Message message = REAL_QUEUE.take(); log.info(\"æ¨¡æ‹Ÿå‘é€çŸ­ä¿¡,orderId:&#123;&#125;,userId:&#123;&#125;,å†…å®¹:&#123;&#125;,è€—æ—¶:&#123;&#125;æ¯«ç§’\", message.getOrderId(), message.getUserId(), message.getContent(), R.nextInt(50)); &#125; catch (Exception e) &#123; throw new IllegalStateException(e); &#125; &#125; &#125;); &#125;&#125;//åˆ‡é¢ç±»@Component@Aspectpublic class TimerAspect &#123; @Around(value = \"execution(* club.throwable.smp.service.*Service.*(..))\") public Object around(ProceedingJoinPoint joinPoint) throws Throwable &#123; Signature signature = joinPoint.getSignature(); MethodSignature methodSignature = (MethodSignature) signature; Method method = methodSignature.getMethod(); Timer timer = Metrics.timer(\"method.cost.time\", \"method.name\", method.getName()); ThrowableHolder holder = new ThrowableHolder(); Object result = timer.recordCallable(() -&gt; &#123; try &#123; return joinPoint.proceed(); &#125; catch (Throwable e) &#123; holder.throwable = e; &#125; return null; &#125;); if (null != holder.throwable) &#123; throw holder.throwable; &#125; return result; &#125; private class ThrowableHolder &#123; Throwable throwable; &#125;&#125; yamlçš„é…ç½®å¦‚ä¸‹ï¼š 12345678910server: port: 9091management: server: port: 10091 endpoints: web: exposure: include: '*' base-path: /management æ³¨æ„å¤šçœ‹springå®˜æ–¹æ–‡æ¡£å…³äºActuatorçš„è¯¦ç»†æè¿°ï¼Œåœ¨SpringBoot-2.xä¹‹åï¼Œé…ç½®Webç«¯ç‚¹æš´éœ²çš„æƒé™æ§åˆ¶å’Œ1.xæœ‰å¾ˆå¤§çš„ä¸åŒã€‚æ€»ç»“ä¸€ä¸‹å°±æ˜¯ï¼šé™¤äº†shutdownç«¯ç‚¹ä¹‹å¤–ï¼Œå…¶ä»–ç«¯ç‚¹é»˜è®¤éƒ½æ˜¯å¼€å¯æ”¯æŒçš„(è¿™é‡Œä»…ä»…æ˜¯å¼€å¯æ”¯æŒï¼Œå¹¶ä¸æ˜¯æš´éœ²ä¸ºWebç«¯ç‚¹ï¼Œç«¯ç‚¹å¿…é¡»æš´éœ²ä¸ºWebç«¯ç‚¹æ‰èƒ½è¢«è®¿é—®)ï¼Œç¦ç”¨æˆ–è€…å¼€å¯ç«¯ç‚¹æ”¯æŒçš„é…ç½®æ–¹å¼å¦‚ä¸‹ï¼š 1management.endpoint.$&#123;ç«¯ç‚¹ID&#125;.enabled=true/false å¯ä»¥æŸ¥çœ‹actuator-apiæ–‡æ¡£æŸ¥çœ‹æ‰€æœ‰æ”¯æŒçš„ç«¯ç‚¹çš„ç‰¹æ€§ï¼Œè¿™ä¸ªæ˜¯2.1.0.RELEASEç‰ˆæœ¬çš„å®˜æ–¹æ–‡æ¡£ï¼Œä¸çŸ¥é“æ—¥åé“¾æ¥ä¼šä¸ä¼šæŒ‚æ‰ã€‚ç«¯ç‚¹åªå¼€å¯æ”¯æŒï¼Œä½†æ˜¯ä¸æš´éœ²ä¸ºWebç«¯ç‚¹ï¼Œæ˜¯æ— æ³•é€šè¿‡http://{host}:{management.port}/{management.endpoints.web.base-path}/{endpointId}è®¿é—®çš„ã€‚æš´éœ²ç›‘æ§ç«¯ç‚¹ä¸ºWebç«¯ç‚¹çš„é…ç½®æ˜¯ï¼š 12management.endpoints.web.exposure.include=info,healthmanagement.endpoints.web.exposure.exclude=prometheus management.endpoints.web.exposure.includeç”¨äºæŒ‡å®šæš´éœ²ä¸ºWebç«¯ç‚¹çš„ç›‘æ§ç«¯ç‚¹ï¼ŒæŒ‡å®šå¤šä¸ªçš„æ—¶å€™ç”¨è‹±æ–‡é€—å·åˆ†éš”ã€‚management.endpoints.web.exposure.excludeç”¨äºæŒ‡å®šä¸æš´éœ²ä¸ºWebç«¯ç‚¹çš„ç›‘æ§ç«¯ç‚¹ï¼ŒæŒ‡å®šå¤šä¸ªçš„æ—¶å€™ç”¨è‹±æ–‡é€—å·åˆ†éš”ã€‚ management.endpoints.web.exposure.includeé»˜è®¤æŒ‡å®šçš„åªæœ‰infoå’Œhealthä¸¤ä¸ªç«¯ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥æŒ‡å®šæš´éœ²æ‰€æœ‰çš„ç«¯ç‚¹ï¼šmanagement.endpoints.web.exposure.include=*ï¼Œå¦‚æœé‡‡ç”¨YAMLé…ç½®ï¼Œè®°å¾—*è¦åŠ å•å¼•å·â€™*â€™ã€‚æš´éœ²æ‰€æœ‰Webç›‘æ§ç«¯ç‚¹æ˜¯ä¸€ä»¶æ¯”è¾ƒå±é™©çš„äº‹æƒ…ï¼Œå¦‚æœéœ€è¦åœ¨ç”Ÿäº§ç¯å¢ƒè¿™æ ·åšï¼Œè¯·åŠ¡å¿…å…ˆç¡®è®¤http://{host}:{management.port}ä¸èƒ½é€šè¿‡å…¬ç½‘è®¿é—®(ä¹Ÿå°±æ˜¯ç›‘æ§ç«¯ç‚¹è®¿é—®çš„ç«¯å£åªèƒ½é€šè¿‡å†…ç½‘è®¿é—®ï¼Œè¿™æ ·å¯ä»¥æ–¹ä¾¿åé¢è¯´åˆ°çš„PrometheusæœåŠ¡ç«¯é€šè¿‡æ­¤ç«¯å£æ”¶é›†æ•°æ®)ã€‚ Prometheusçš„å®‰è£…å’Œé…ç½® Prometheusç›®å‰çš„æœ€æ–°ç‰ˆæœ¬æ˜¯2.5ï¼Œé‰´äºç¬”è€…æ²¡æ·±å…¥ç©è¿‡Dockerï¼Œè¿™é‡Œè¿˜æ˜¯ç›´æ¥ä¸‹è½½å®ƒçš„å‹ç¼©åŒ…è§£å‹å®‰è£…ã€‚ 123wget https://github.com/prometheus/prometheus/releases/download/v2.5.0/prometheus-2.5.0.linux-amd64.tar.gztar xvfz prometheus-*.tar.gzcd prometheus-* å…ˆç¼–è¾‘è§£å‹å‡ºæ¥çš„ç›®å½•ä¸‹çš„prometheusé…ç½®æ–‡ä»¶prometheus.ymlï¼Œä¸»è¦ä¿®æ”¹scrape_configsèŠ‚ç‚¹çš„å±æ€§ï¼š 1234567891011scrape_configs: # The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config. - job_name: 'prometheus' # metrics_path defaults to '/metrics' # scheme defaults to 'http'. # è¿™é‡Œé…ç½®éœ€è¦æ‹‰å–åº¦é‡ä¿¡æ¯çš„URLè·¯å¾„ï¼Œè¿™é‡Œé€‰æ‹©åº”ç”¨ç¨‹åºçš„prometheusç«¯ç‚¹ metrics_path: /management/prometheus static_configs: # è¿™é‡Œé…ç½®hostå’Œport - targets: ['localhost:10091'] é…ç½®æ‹‰å–åº¦é‡æ•°æ®çš„è·¯å¾„ä¸ºlocalhost:10091/management/metricsï¼Œæ­¤å‰è®°å¾—æŠŠå‰ä¸€èŠ‚æåˆ°çš„åº”ç”¨åœ¨è™šæ‹Ÿæœºä¸­å¯åŠ¨ã€‚æ¥ç€å¯åŠ¨Prometheusåº”ç”¨ï¼š 12# å¯é€‰å‚æ•° --storage.tsdb.path=å­˜å‚¨æ•°æ®çš„è·¯å¾„ï¼Œé»˜è®¤è·¯å¾„ä¸º./data./prometheus --config.file=prometheus.yml Prometheuså¼•ç”¨çš„é»˜è®¤å¯åŠ¨ç«¯å£æ˜¯9090ï¼Œå¯åŠ¨æˆåŠŸåï¼Œæ—¥å¿—å¦‚ä¸‹ï¼š æ­¤æ—¶ï¼Œè®¿é—®http://${è™šæ‹Ÿæœºhost}:9090/targetså°±èƒ½çœ‹åˆ°å½“å‰Prometheusä¸­æ‰§è¡Œçš„Jobï¼š è®¿é—®http://${è™šæ‹Ÿæœºhost}:9090/graphå¯ä»¥æŸ¥æ‰¾åˆ°æˆ‘ä»¬å®šä¹‰çš„åº¦é‡Meterå’Œspring-boot-starter-actuatorä¸­å·²ç»å®šä¹‰å¥½çš„ä¸€äº›å…³äºJVMæˆ–è€…Tomcatçš„åº¦é‡Meterã€‚æˆ‘ä»¬å…ˆå¯¹åº”ç”¨çš„/orderæ¥å£è¿›è¡Œè°ƒç”¨ï¼Œç„¶åæŸ¥çœ‹ä¸€ä¸‹ç›‘æ§å‰é¢åœ¨åº”ç”¨ä¸­å®šä¹‰çš„order_count_totalå’Œmethod_cost_time_seconds_sumï¼š å¯ä»¥çœ‹åˆ°ï¼ŒMeterçš„ä¿¡æ¯å·²ç»è¢«æ”¶é›†å’Œå±•ç¤ºï¼Œä½†æ˜¯æ˜¾ç„¶ä¸å¤Ÿè¯¦ç»†å’Œç‚«é…·ï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦ä½¿ç”¨Grafanaçš„UIåšä¸€ä¸‹ç‚¹ç¼€ã€‚ Grafanaçš„å®‰è£…å’Œä½¿ç”¨ Grafanaçš„å®‰è£…è¿‡ç¨‹å¦‚ä¸‹ï¼š 12wget https://s3-us-west-2.amazonaws.com/grafana-releases/release/grafana-5.3.4-1.x86_64.rpm sudo yum localinstall grafana-5.3.4-1.x86_64.rpm å®‰è£…å®Œæˆåï¼Œé€šè¿‡å‘½ä»¤service grafana-server startå¯åŠ¨å³å¯ï¼Œé»˜è®¤çš„å¯åŠ¨ç«¯å£ä¸º3000ï¼Œé€šè¿‡http://${host}:3000è®¿é—®å³å¯ã€‚åˆå§‹çš„è´¦å·å¯†ç éƒ½ä¸ºadminï¼Œæƒé™æ˜¯ç®¡ç†å‘˜æƒé™ã€‚æ¥ç€éœ€è¦åœ¨Homeé¢æ¿æ·»åŠ ä¸€ä¸ªæ•°æ®æºï¼Œç›®çš„æ˜¯å¯¹æ¥PrometheusæœåŠ¡ç«¯ä»è€Œå¯ä»¥æ‹‰å–å®ƒé‡Œé¢çš„åº¦é‡æ•°æ®ã€‚æ•°æ®æºæ·»åŠ é¢æ¿å¦‚ä¸‹ï¼š å…¶å®å°±æ˜¯æŒ‡å‘PrometheusæœåŠ¡ç«¯çš„ç«¯å£å°±å¯ä»¥äº†ã€‚æ¥ä¸‹æ¥å¯ä»¥å¤©é©¬è¡Œç©ºåœ°æ·»åŠ éœ€è¦çš„é¢æ¿ï¼Œå°±ä¸‹å•æ•°é‡ç»Ÿè®¡çš„æŒ‡æ ‡ï¼Œå¯ä»¥æ·»åŠ ä¸€ä¸ªGraphçš„é¢æ¿ï¼š é…ç½®é¢æ¿çš„æ—¶å€™ï¼Œéœ€è¦åœ¨åŸºç¡€(General)ä¸­æŒ‡å®šTitleï¼š æ¥ç€æ¯”è¾ƒé‡è¦çš„æ˜¯Metricsçš„é…ç½®ï¼Œéœ€è¦æŒ‡å®šæ•°æ®æºå’ŒPrometheusçš„æŸ¥è¯¢è¯­å¥ï¼š æœ€å¥½å‚è€ƒä¸€ä¸‹Prometheusçš„å®˜æ–¹æ–‡æ¡£ï¼Œç¨å¾®å­¦ä¹ ä¸€ä¸‹å®ƒçš„æŸ¥è¯¢è¯­è¨€PromQLçš„ä½¿ç”¨æ–¹å¼ï¼Œä¸€ä¸ªé¢æ¿å¯ä»¥æ”¯æŒå¤šä¸ªPromQLæŸ¥è¯¢ã€‚å‰é¢æåˆ°çš„ä¸¤é¡¹æ˜¯åŸºæœ¬é…ç½®ï¼Œå…¶ä»–é…ç½®é¡¹ä¸€èˆ¬æ˜¯å›¾è¡¨å±•ç¤ºçš„è¾…åŠ©æˆ–è€…é¢„è­¦ç­‰è¾…åŠ©åŠŸèƒ½ï¼Œè¿™é‡Œå…ˆä¸å±•å¼€ï¼Œå¯ä»¥å–Grafanaçš„å®˜ç½‘æŒ–æ˜ä¸€ä¸‹ä½¿ç”¨æ–¹å¼ã€‚ç„¶åæˆ‘ä»¬å†è°ƒç”¨ä¸€ä¸‹ä¸‹å•æ¥å£ï¼Œè¿‡ä¸€æ®µæ—¶é—´ï¼Œå›¾è¡¨çš„æ•°æ®å°±ä¼šè‡ªåŠ¨æ›´æ–°å’Œå±•ç¤ºï¼š æ¥ç€æ·»åŠ ä¸€ä¸‹é¡¹ç›®ä¸­ä½¿ç”¨çš„Timerçš„Meterï¼Œä¾¿äºç›‘æ§æ–¹æ³•çš„æ‰§è¡Œæ—¶é—´ï¼Œå®Œæˆä¹‹åå¤§è‡´å¦‚ä¸‹ï¼š ä¸Šé¢çš„é¢æ¿è™½ç„¶è®¾è®¡ç›¸å½“ç²—ç³™ï¼Œä½†æ˜¯åŸºæœ¬åŠŸèƒ½å·²ç»å®ç°ã€‚è®¾è®¡é¢æ¿å¹¶ä¸æ˜¯ä¸€ä»¶å®¹æ˜“çš„äº‹ï¼Œå¦‚æœæœ‰éœ€è¦å¯ä»¥ä»Githubä¸­æœç´¢ä¸€ä¸‹grafana dashboardå…³é”®å­—æ‰¾ç°æˆçš„å¼€æºé…ç½®ä½¿ç”¨æˆ–è€…äºŒæ¬¡åŠ å·¥åä½¿ç”¨ã€‚ å°ç»“ å¸¸è¨€é“ï¼šå·¥æ¬²å–„å…¶äº‹ï¼Œå¿…å…ˆåˆ©å…¶å™¨ã€‚Micrometeræ˜¯JVMåº”ç”¨çš„ä¸€æ¬¾ç›¸å½“ä¼˜å¼‚çš„åº¦é‡æ¡†æ¶ï¼Œå®ƒæä¾›åŸºäºTagå’Œä¸°å¯Œçš„åº¦é‡ç±»å‹å’ŒAPIä¾¿äºå¤šç»´åº¦åœ°è¿›è¡Œä¸åŒè§’åº¦åº¦é‡æ•°æ®çš„ç»Ÿè®¡ï¼Œå¯ä»¥æ–¹ä¾¿åœ°æ¥å…¥Prometheusè¿›è¡Œæ•°æ®æ”¶é›†ï¼Œä½¿ç”¨Grafanaçš„é¢æ¿è¿›è¡Œç‚«é…·çš„å±•ç¤ºï¼Œæä¾›äº†å¤©ç„¶çš„spring-bootä½“ç³»æ”¯æŒã€‚ä½†æ˜¯ï¼Œåœ¨å®é™…çš„ä¸šåŠ¡ä»£ç ä¸­ï¼Œåº¦é‡ç±»å‹Counterç»å¸¸è¢«æ»¥ç”¨ï¼Œä¸€æ—¦å·¥å…·è¢«ä¸åŠ æ€è€ƒåœ°æ»¥ç”¨ï¼Œå°±åè€Œä¼šæˆä¸ºæ··ä¹±æˆ–è€…æ¯’ç˜¤ã€‚å› æ­¤ï¼Œè¿™ç¯‡æ–‡ç« å°±æ˜¯å¯¹Micrometerä¸­çš„å„ç§Meterçš„ä½¿ç”¨åœºæ™¯åŸºäºä¸ªäººçš„ç†è§£åšäº†è°ƒç ”å’Œåˆ†æï¼Œåˆ†äº«ä¸€ä¸‹å®æˆ˜ä¸­çš„ç»éªŒå’Œè¸©å‘ç»å†ã€‚ ä»¥å‰å†™è¿‡çš„ä¸€ç¯‡æ–‡ç« ï¼š åŸºäºPrometheusæ­å»ºSpringCloudå…¨æ–¹ä½ç«‹ä½“ç›‘æ§ä½“ç³» å‚è€ƒèµ„æ–™ï¼š https://micrometer.io/docs https://grafana.com https://prometheus.io (To be continue c-10-d n-e-20181102 æœ€è¿‘æœ‰ç‚¹å¿™ï¼Œæ²¡åŠæ³•ç»å¸¸æ›´æ–° r-a-201918)","categories":[{"name":"Framework","slug":"Framework","permalink":"http://throwable.club/blog/categories/Framework/"},{"name":"Micrometer","slug":"Framework/Micrometer","permalink":"http://throwable.club/blog/categories/Framework/Micrometer/"}],"tags":[{"name":"Framework","slug":"Framework","permalink":"http://throwable.club/blog/tags/Framework/"},{"name":"Micrometer","slug":"Micrometer","permalink":"http://throwable.club/blog/tags/Micrometer/"}]},{"title":"åŸºäºPrometheusæ­å»ºSpringCloudå…¨æ–¹ä½ç«‹ä½“ç›‘æ§ä½“ç³»","slug":"spring-cloud-prometheus","date":"2018-11-10T08:54:27.000Z","updated":"2019-01-08T14:41:56.513Z","comments":true,"path":"2018/11/10/spring-cloud-prometheus/","link":"","permalink":"http://throwable.club/2018/11/10/spring-cloud-prometheus/","excerpt":"","text":"åŸºäºPrometheusæ­å»ºSpringCloudå…¨æ–¹ä½ç«‹ä½“ç›‘æ§ä½“ç³» å‰æ æœ€è¿‘å…¬å¸åœ¨è”åˆè¿ç»´åšä¸€å¥—å…¨æ–¹ä½ç›‘æ§çš„ç³»ç»Ÿï¼Œåº”ç”¨é›†ç¾¤çš„æŠ€æœ¯æ ˆæ˜¯SpringCloudä½“ç³»ã€‚è™½ç„¶æœ¬äººæ²¡æœ‰å‚ä¸å…·ä½“åŸºç¡€æ¶æ„çš„ç ”å‘ï¼Œä½†æ˜¯ä»åº”ç”¨å¼•å…¥çš„åŒ…å’Œä¸€äº›èµ„æ–™çš„æŸ¥é˜…å¤§è‡´æ¨ç®—å‡ºå…·ä½“çš„å®ç°æ–¹æ¡ˆï¼Œè¿™é‡Œåšä¸€æ¬¡æ¨æ¼”ï¼Œè¯¦ç»†è®°å½•ä¸€ä¸‹æ•´ä¸ªæ­å»ºè¿‡ç¨‹ã€‚ Prometheusæ˜¯ä»€ä¹ˆ Prometheus(æ™®ç½—ç±³ä¿®æ–¯)ï¼Œæ˜¯ä¸€ä¸ªå¼€æºçš„ç³»ç»Ÿç›‘æ§å’Œå‘Šè­¦çš„å·¥å…·åŒ…ï¼Œå…¶é‡‡ç”¨Pullæ–¹å¼é‡‡é›†æ—¶é—´åºåˆ—çš„åº¦é‡æ•°æ®ï¼Œé€šè¿‡Httpåè®®ä¼ è¾“ã€‚å®ƒçš„å·¥ä½œæ–¹å¼æ˜¯è¢«ç›‘æ§çš„æœåŠ¡éœ€è¦å…¬å¼€ä¸€ä¸ªPrometheusç«¯ç‚¹ï¼Œè¿™ç«¯ç‚¹æ˜¯ä¸€ä¸ªHTTPæ¥å£ï¼Œè¯¥æ¥å£å…¬å¼€äº†åº¦é‡çš„åˆ—è¡¨å’Œå½“å‰çš„å€¼ï¼Œç„¶åPrometheusåº”ç”¨ä»æ­¤æ¥å£å®šæ—¶æ‹‰å–æ•°æ®ï¼Œä¸€èˆ¬å¯ä»¥å­˜æ”¾åœ¨æ—¶åºæ•°æ®åº“ä¸­ï¼Œç„¶åé€šè¿‡å¯è§†åŒ–çš„Dashboard(ä¾‹å¦‚Promdashæˆ–è€…Grafana)è¿›è¡Œæ•°æ®å±•ç¤ºã€‚å½“ç„¶ï¼Œæ­¤æ–‡ç« ä¸æ‰“ç®—æ·±å…¥ç ”ç©¶è¿™ä¸ªå·¥å…·ï¼Œåªåšåº”ç”¨å±‚é¢çš„å±•ç¤ºã€‚è¿™ç¯‡æ–‡ç« å°†ä¼šç”¨åˆ°ä¸‹é¢å‡ ä¸ªæŠ€æœ¯æ ˆï¼š SpringCloudä½“ç³»ï¼Œä¸»è¦æ˜¯æ³¨å†Œä¸­å¿ƒå’Œæ³¨å†Œå®¢æˆ·ç«¯ã€‚ spring-boot-starter-actuatorï¼Œä¸»è¦æ˜¯æä¾›äº†Prometheusç«¯ç‚¹ï¼Œä¸ç”¨é‡å¤é€ è½®å­ã€‚ Prometheusçš„Javaå®¢æˆ·ç«¯ã€‚ Prometheusåº”ç”¨ã€‚ io.micrometerï¼ŒSpringBootæ ‡å‡†ä¸‹ä½¿ç”¨çš„åº¦é‡å·¥å…·åŒ…ã€‚ Grafanaï¼Œå¯è§†åŒ–çš„Dashboardã€‚ è¿™é‡Œæ‰€æœ‰çš„è½¯ä»¶æˆ–è€…ä¾èµ–å…¨éƒ¨ä½¿ç”¨å½“å‰çš„æœ€æ–°ç‰ˆæœ¬ï¼Œå¦‚æœæœ‰å‘è¸©äº†å†å¡«ã€‚å…¶å®ï¼ŒPrometheusæœ¬èº«ä¹Ÿå¼€å‘äº†ä¸€å¥—Counterã€Gaugeã€Timerç­‰ç›¸å…³æ¥å£ï¼Œä¸è¿‡SpringBootä¸­ä½¿ç”¨äº†io.micrometerä¸­çš„å¥—ä»¶ï¼Œæ‰€ä»¥æœ¬æ–‡ä¸æ·±å…¥åˆ†æPrometheusçš„Javaå®¢æˆ·ç«¯ã€‚ io.micrometerçš„ä½¿ç”¨ åœ¨SpringBoot2.Xä¸­ï¼Œspring-boot-starter-actuatorå¼•å…¥äº†io.micrometerï¼Œå¯¹1.Xä¸­çš„metricsè¿›è¡Œäº†é‡æ„ï¼Œä¸»è¦ç‰¹ç‚¹æ˜¯æ”¯æŒtag/labelï¼Œé…åˆæ”¯æŒtag/labelçš„ç›‘æ§ç³»ç»Ÿï¼Œä½¿å¾—æˆ‘ä»¬å¯ä»¥æ›´åŠ æ–¹ä¾¿åœ°å¯¹metricsè¿›è¡Œå¤šç»´åº¦çš„ç»Ÿè®¡æŸ¥è¯¢åŠç›‘æ§ã€‚io.micrometerç›®å‰æ”¯æŒCounterã€Gaugeã€Timerã€Summaryç­‰å¤šç§ä¸åŒç±»å‹çš„åº¦é‡æ–¹å¼(ä¸çŸ¥é“æœ‰æ²¡æœ‰é—æ¼)ï¼Œä¸‹é¢é€ä¸ªç®€å•åˆ†æä¸€ä¸‹å®ƒä»¬çš„ä½œç”¨å’Œä½¿ç”¨æ–¹å¼ã€‚ éœ€è¦åœ¨SpringBooté¡¹ç›®ä¸‹å¼•å…¥ä¸‹é¢çš„ä¾èµ–ï¼š 12345&lt;dependency&gt; &lt;groupId&gt;io.micrometer&lt;/groupId&gt; &lt;artifactId&gt;micrometer-core&lt;/artifactId&gt; &lt;version&gt;$&#123;micrometer.version&#125;&lt;/version&gt;&lt;/dependency&gt; ç›®å‰æœ€æ–°çš„micrometer.versionä¸º1.0.5ã€‚æ³¨æ„ä¸€ç‚¹çš„æ˜¯ï¼šio.micrometeræ”¯æŒTag(æ ‡ç­¾)çš„æ¦‚å¿µï¼ŒTagæ˜¯å…¶metricsæ˜¯å¦èƒ½å¤Ÿæœ‰å¤šç»´åº¦çš„æ”¯æŒçš„åŸºç¡€ï¼ŒTagå¿…é¡»æˆå¯¹å‡ºç°ï¼Œä¹Ÿå°±æ˜¯å¿…é¡»é…ç½®ä¹Ÿå°±æ˜¯å¶æ•°ä¸ªTagï¼Œæœ‰ç‚¹ç±»ä¼¼äºK-Vçš„å…³ç³»ã€‚ Counter Counter(è®¡æ•°å™¨)ç®€å•ç†è§£å°±æ˜¯ä¸€ç§åªå¢ä¸å‡çš„è®¡æ•°å™¨ã€‚å®ƒé€šå¸¸ç”¨äºè®°å½•æœåŠ¡çš„è¯·æ±‚æ•°é‡ã€å®Œæˆçš„ä»»åŠ¡æ•°é‡ã€é”™è¯¯çš„å‘ç”Ÿæ•°é‡ç­‰ç­‰ã€‚ä¸¾ä¸ªä¾‹å­ï¼š 12345678910111213141516171819202122232425262728293031import io.micrometer.core.instrument.Counter;import io.micrometer.core.instrument.Metrics;import io.micrometer.core.instrument.simple.SimpleMeterRegistry;/** * @author throwable * @version v1.0 * @description * @since 2018/7/19 23:10 */public class CounterSample &#123; public static void main(String[] args) throws Exception &#123; //tagå¿…é¡»æˆå¯¹å‡ºç°ï¼Œä¹Ÿå°±æ˜¯å¶æ•°ä¸ª Counter counter = Counter.builder(\"counter\") .tag(\"counter\", \"counter\") .description(\"counter\") .register(new SimpleMeterRegistry()); counter.increment(); counter.increment(2D); System.out.println(counter.count()); System.out.println(counter.measure()); //å…¨å±€é™æ€æ–¹æ³• Metrics.addRegistry(new SimpleMeterRegistry()); counter = Metrics.counter(\"counter\", \"counter\", \"counter\"); counter.increment(10086D); counter.increment(10087D); System.out.println(counter.count()); System.out.println(counter.measure()); &#125;&#125; è¾“å‡ºï¼š 12343.0[Measurement&#123;statistic='COUNT', value=3.0&#125;]20173.0[Measurement&#123;statistic='COUNT', value=20173.0&#125;] Counterçš„Measurementçš„statistic(å¯ä»¥ç†è§£ä¸ºåº¦é‡çš„ç»Ÿè®¡è§’åº¦)åªæœ‰COUNTï¼Œä¹Ÿå°±æ˜¯å®ƒåªå…·å¤‡è®¡æ•°(å®ƒåªæœ‰å¢é‡çš„æ–¹æ³•ï¼Œå› æ­¤åªå¢ä¸å‡)ï¼Œè¿™ä¸€ç‚¹ä»å®ƒçš„æ¥å£å®šä¹‰å¯çŸ¥ï¼š 123456789101112public interface Counter extends Meter &#123; default void increment() &#123; increment(1.0); &#125; void increment(double amount); double count(); //å¿½ç•¥å…¶ä»–æ–¹æ³•æˆ–è€…æˆå‘˜&#125; Counterè¿˜æœ‰ä¸€ä¸ªè¡ç”Ÿç±»å‹FunctionCounterï¼Œå®ƒæ˜¯åŸºäºå‡½æ•°å¼æ¥å£ToDoubleFunctionè¿›è¡Œè®¡æ•°ç»Ÿè®¡çš„ï¼Œç”¨æ³•å·®ä¸å¤šã€‚ Gauge Gauge(ä»ªè¡¨)æ˜¯ä¸€ä¸ªè¡¨ç¤ºå•ä¸ªæ•°å€¼çš„åº¦é‡ï¼Œå®ƒå¯ä»¥è¡¨ç¤ºä»»æ„åœ°ä¸Šä¸‹ç§»åŠ¨çš„æ•°å€¼æµ‹é‡ã€‚Gaugeé€šå¸¸ç”¨äºå˜åŠ¨çš„æµ‹é‡å€¼ï¼Œå¦‚å½“å‰çš„å†…å­˜ä½¿ç”¨æƒ…å†µï¼ŒåŒæ—¶ä¹Ÿå¯ä»¥æµ‹é‡ä¸Šä¸‹ç§»åŠ¨çš„&quot;è®¡æ•°&quot;ï¼Œæ¯”å¦‚é˜Ÿåˆ—ä¸­çš„æ¶ˆæ¯æ•°é‡ã€‚ä¸¾ä¸ªä¾‹å­ï¼š 12345678910111213141516171819202122232425262728293031import io.micrometer.core.instrument.Gauge;import io.micrometer.core.instrument.Metrics;import io.micrometer.core.instrument.simple.SimpleMeterRegistry;import java.util.concurrent.atomic.AtomicInteger;/** * @author throwable * @version v1.0 * @description * @since 2018/7/19 23:30 */public class GaugeSample &#123; public static void main(String[] args) throws Exception &#123; AtomicInteger atomicInteger = new AtomicInteger(); Gauge gauge = Gauge.builder(\"gauge\", atomicInteger, AtomicInteger::get) .tag(\"gauge\", \"gauge\") .description(\"gauge\") .register(new SimpleMeterRegistry()); atomicInteger.addAndGet(5); System.out.println(gauge.value()); System.out.println(gauge.measure()); atomicInteger.decrementAndGet(); System.out.println(gauge.value()); System.out.println(gauge.measure()); //å…¨å±€é™æ€æ–¹æ³•ï¼Œè¿”å›å€¼ç«Ÿç„¶æ˜¯ä¾èµ–å€¼ï¼Œæœ‰ç‚¹å¥‡æ€ªï¼Œæš‚æ—¶ä¸é€‰ç”¨ Metrics.addRegistry(new SimpleMeterRegistry()); AtomicInteger other = Metrics.gauge(\"gauge\", atomicInteger, AtomicInteger::get); &#125;&#125; è¾“å‡ºç»“æœ: 12345.0[Measurement&#123;statistic='VALUE', value=5.0&#125;]4.0[Measurement&#123;statistic='VALUE', value=4.0&#125;] Gaugeå…³æ³¨çš„åº¦é‡ç»Ÿè®¡è§’åº¦æ˜¯VALUE(å€¼)ï¼Œå®ƒçš„æ„å»ºæ–¹æ³•ä¸­ä¾èµ–äºå‡½æ•°å¼æ¥å£ToDoubleFunctionçš„å®ä¾‹(å¦‚ä¾‹å­ä¸­çš„å®ä¾‹æ–¹æ³•å¼•ç”¨AtomicInteger::get)å’Œä¸€ä¸ªä¾èµ–äºToDoubleFunctionæ”¹å˜è‡ªèº«å€¼çš„å®ä¾‹(å¦‚ä¾‹å­ä¸­çš„AtomicIntegerå®ä¾‹)ï¼Œå®ƒçš„æ¥å£æ–¹æ³•å¦‚ä¸‹ï¼š 123456public interface Gauge extends Meter &#123; double value(); //å¿½ç•¥å…¶ä»–æ–¹æ³•æˆ–è€…æˆå‘˜&#125; Timer Timer(è®¡æ—¶å™¨)åŒæ—¶æµ‹é‡ä¸€ä¸ªç‰¹å®šçš„ä»£ç é€»è¾‘å—çš„è°ƒç”¨(æ‰§è¡Œ)é€Ÿåº¦å’Œå®ƒçš„æ—¶é—´åˆ†å¸ƒã€‚ç®€å•æ¥è¯´ï¼Œå°±æ˜¯åœ¨è°ƒç”¨ç»“æŸçš„æ—¶é—´ç‚¹è®°å½•æ•´ä¸ªè°ƒç”¨å—æ‰§è¡Œçš„æ€»æ—¶é—´ï¼Œé€‚ç”¨äºæµ‹é‡çŸ­æ—¶é—´æ‰§è¡Œçš„äº‹ä»¶çš„è€—æ—¶åˆ†å¸ƒï¼Œä¾‹å¦‚æ¶ˆæ¯é˜Ÿåˆ—æ¶ˆæ¯çš„æ¶ˆè´¹é€Ÿç‡ã€‚ä¸¾ä¸ªä¾‹å­ï¼š 1234567891011121314151617181920212223242526272829303132import io.micrometer.core.instrument.Timer;import io.micrometer.core.instrument.simple.SimpleMeterRegistry;import java.util.concurrent.TimeUnit;/** * @author throwable * @version v1.0 * @description * @since 2018/7/19 23:44 */public class TimerSample &#123; public static void main(String[] args) throws Exception&#123; Timer timer = Timer.builder(\"timer\") .tag(\"timer\",\"timer\") .description(\"timer\") .register(new SimpleMeterRegistry()); timer.record(()-&gt;&#123; try &#123; TimeUnit.SECONDS.sleep(2); &#125;catch (InterruptedException e)&#123; //ignore &#125; &#125;); System.out.println(timer.count()); System.out.println(timer.measure()); System.out.println(timer.totalTime(TimeUnit.SECONDS)); System.out.println(timer.mean(TimeUnit.SECONDS)); System.out.println(timer.max(TimeUnit.SECONDS)); &#125;&#125; è¾“å‡ºç»“æœï¼š 123451[Measurement&#123;statistic='COUNT', value=1.0&#125;, Measurement&#123;statistic='TOTAL_TIME', value=2.000603975&#125;, Measurement&#123;statistic='MAX', value=2.000603975&#125;]2.0006039752.0006039752.000603975 Timerçš„åº¦é‡ç»Ÿè®¡è§’åº¦ä¸»è¦åŒ…æ‹¬è®°å½•æ‰§è¡Œçš„æœ€å¤§æ—¶é—´ã€æ€»æ—¶é—´ã€å¹³å‡æ—¶é—´ã€æ‰§è¡Œå®Œæˆçš„æ€»ä»»åŠ¡æ•°ï¼Œå®ƒæä¾›å¤šç§çš„ç»Ÿè®¡æ–¹æ³•å˜ä½“ï¼š 123456789101112131415161718192021222324public interface Timer extends Meter, HistogramSupport &#123; void record(long amount, TimeUnit unit); default void record(Duration duration) &#123; record(duration.toNanos(), TimeUnit.NANOSECONDS); &#125; &lt;T&gt; T record(Supplier&lt;T&gt; f); &lt;T&gt; T recordCallable(Callable&lt;T&gt; f) throws Exception; void record(Runnable f); default Runnable wrap(Runnable f) &#123; return () -&gt; record(f); &#125; default &lt;T&gt; Callable&lt;T&gt; wrap(Callable&lt;T&gt; f) &#123; return () -&gt; recordCallable(f); &#125; //å¿½ç•¥å…¶ä»–æ–¹æ³•æˆ–è€…æˆå‘˜&#125; è¿™äº›recordæˆ–è€…åŒ…è£…æ–¹æ³•å¯ä»¥æ ¹æ®éœ€è¦é€‰æ‹©åˆé€‚çš„ä½¿ç”¨ï¼Œå¦å¤–ï¼Œä¸€äº›åº¦é‡å±æ€§(å¦‚ä¸‹é™å’Œä¸Šé™)æˆ–è€…å•ä½å¯ä»¥è‡ªè¡Œé…ç½®ï¼Œå…·ä½“å±æ€§çš„ç›¸å…³å†…å®¹å¯ä»¥æŸ¥çœ‹DistributionStatisticConfigç±»ï¼Œè¿™é‡Œä¸è¯¦ç»†å±•å¼€ã€‚ å¦å¤–ï¼ŒTimeræœ‰ä¸€ä¸ªè¡ç”Ÿç±»LongTaskTimerï¼Œä¸»è¦æ˜¯ç”¨æ¥è®°å½•æ­£åœ¨æ‰§è¡Œä½†æ˜¯å°šæœªå®Œæˆçš„ä»»åŠ¡æ•°ï¼Œç”¨æ³•å·®ä¸å¤šã€‚ Summary Summary(æ‘˜è¦)ç”¨äºè·Ÿè¸ªäº‹ä»¶çš„åˆ†å¸ƒã€‚å®ƒç±»ä¼¼äºä¸€ä¸ªè®¡æ—¶å™¨ï¼Œä½†æ›´ä¸€èˆ¬çš„æƒ…å†µæ˜¯ï¼Œå®ƒçš„å¤§å°å¹¶ä¸ä¸€å®šæ˜¯ä¸€æ®µæ—¶é—´çš„æµ‹é‡å€¼ã€‚åœ¨micrometerä¸­ï¼Œå¯¹åº”çš„ç±»æ˜¯DistributionSummaryï¼Œå®ƒçš„ç”¨æ³•æœ‰ç‚¹åƒTimerï¼Œä½†æ˜¯è®°å½•çš„å€¼æ˜¯éœ€è¦ç›´æ¥æŒ‡å®šï¼Œè€Œä¸æ˜¯é€šè¿‡æµ‹é‡ä¸€ä¸ªä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´ã€‚ä¸¾ä¸ªä¾‹å­ï¼š 123456789101112131415161718192021222324252627import io.micrometer.core.instrument.DistributionSummary;import io.micrometer.core.instrument.simple.SimpleMeterRegistry;/** * @author throwable * @version v1.0 * @description * @since 2018/7/19 23:55 */public class SummarySample &#123; public static void main(String[] args) throws Exception &#123; DistributionSummary summary = DistributionSummary.builder(\"summary\") .tag(\"summary\", \"summary\") .description(\"summary\") .register(new SimpleMeterRegistry()); summary.record(2D); summary.record(3D); summary.record(4D); System.out.println(summary.measure()); System.out.println(summary.count()); System.out.println(summary.max()); System.out.println(summary.mean()); System.out.println(summary.totalAmount()); &#125;&#125; è¾“å‡ºç»“æœï¼š 12345[Measurement&#123;statistic='COUNT', value=3.0&#125;, Measurement&#123;statistic='TOTAL', value=9.0&#125;, Measurement&#123;statistic='MAX', value=4.0&#125;]34.03.09.0 Summaryçš„åº¦é‡ç»Ÿè®¡è§’åº¦ä¸»è¦åŒ…æ‹¬è®°å½•è¿‡çš„æ•°æ®ä¸­çš„æœ€å¤§å€¼ã€æ€»æ•°å€¼ã€å¹³å‡å€¼å’Œæ€»æ¬¡æ•°ã€‚å¦å¤–ï¼Œä¸€äº›åº¦é‡å±æ€§(å¦‚ä¸‹é™å’Œä¸Šé™)æˆ–è€…å•ä½å¯ä»¥è‡ªè¡Œé…ç½®ï¼Œå…·ä½“å±æ€§çš„ç›¸å…³å†…å®¹å¯ä»¥æŸ¥çœ‹DistributionStatisticConfigç±»ï¼Œè¿™é‡Œä¸è¯¦ç»†å±•å¼€ã€‚ å°ç»“ ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸Šé¢çš„Counterã€Gaugeã€Timerã€DistributionSummaryä¾‹å­å¯ä»¥æ»¡è¶³æ—¥å¸¸å¼€å‘éœ€è¦ï¼Œä½†æ˜¯æœ‰äº›é«˜çº§çš„ç‰¹æ€§è¿™é‡Œæ²¡æœ‰å±•å¼€ï¼Œå…·ä½“å¯ä»¥å‚è€ƒmicrometer-spring-legacyè¿™ä¸ªä¾èµ–åŒ…ï¼Œæ¯•ç«Ÿæºç æ˜¯è€å¸ˆï¼Œæºç ä¸ä¼šéª—äººã€‚ spring-boot-starter-actuatorçš„ä½¿ç”¨ spring-boot-starter-actuatoråœ¨2.Xç‰ˆæœ¬ä¸­ä¸ä»…å‡çº§äº†metricsä¸ºio.micrometerï¼Œå¾ˆå¤šé…ç½®æ–¹å¼ä¹Ÿå’Œ1.Xå®Œå…¨ä¸åŒï¼Œé‰´äºå‰æ®µæ—¶é—´æ²¡æœ‰ç»´æŠ¤SpringBootæŠ€æœ¯æ ˆçš„é¡¹ç›®ï¼Œç°åœ¨é‡æ–°çœ‹äº†ä¸‹å®˜ç½‘å¤ä¹ ä¸€ä¸‹ã€‚å¼•å…¥ä¾èµ–ï¼š 12345&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt; &lt;version&gt;$&#123;springboot.version&#125;&lt;/version&gt;&lt;/dependency&gt; ç›®å‰æœ€æ–°çš„springboot.versionä¸º2.0.3.RELEASEã€‚åœ¨spring-boot-starter-actuatorä¸­ï¼Œæœ€å¤§çš„å˜åŒ–å°±æ˜¯é…ç½®çš„å˜åŒ–ï¼ŒåŸæ¥åœ¨1.Xç‰ˆæœ¬æ˜¯é€šè¿‡management.security.enabledæ§åˆ¶æ˜¯å¦å¯ä»¥å¿½ç•¥æƒé™è®¿é—®æ‰€æœ‰çš„ç›‘æ§ç«¯ç‚¹ï¼Œåœ¨2.Xç‰ˆæœ¬ä¸­ï¼Œå¿…é¡»æ˜¾å¼é…ç½®ä¸éœ€è¦æƒé™éªŒè¯å¯¹å¤–å¼€æ”¾çš„ç«¯ç‚¹ï¼š 1234management.endpoints.web.exposure.include=*management.endpoints.web.exposure.exclude=env,beansmanagement.endpoints.jmx.exposure.include=management.endpoints.jmx.exposure.include=* ä¾‹å¦‚ä¸Šé¢çš„é…ç½®ï¼Œè®¿é—®é/envå’Œé/beansçš„ç«¯ç‚¹ï¼Œå¯ä»¥ä¸å—æƒé™æ§åˆ¶ï¼Œä¹Ÿå°±æ˜¯æ‰€æœ‰äººéƒ½å¯ä»¥è®¿é—®é/envå’Œé/beansçš„ç«¯ç‚¹ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘åªæƒ³æš´éœ²/healthç«¯ç‚¹ï¼Œåªéœ€é…ç½®ï¼š 1management.endpoints.web.exposure.include=health è¿™ä¸€ç‚¹éœ€è¦ç‰¹åˆ«æ³¨æ„ï¼Œå…¶ä»–ä½¿ç”¨å’Œ1.Xå·®ä¸å¤šã€‚è¿˜æœ‰ä¸€ç‚¹æ˜¯ï¼Œ2.Xä¸­æ‰€æœ‰ç›‘æ§ç«¯ç‚¹çš„è®¿é—®urlçš„é»˜è®¤è·¯å¾„å‰ç¼€ä¸ºï¼šhttp://${host}/${port}/actuatorï¼Œä¹Ÿå°±æ˜¯æƒ³è®¿é—®healthç«¯ç‚¹å°±è¦è®¿é—®http://${host}/${port}/actuator/healthï¼Œå½“ç„¶ä¹Ÿå¯ä»¥ä¿®æ”¹/actuatorè¿™ä¸ªè·¯å¾„å‰ç¼€ã€‚å…¶ä»–ç»†èŠ‚åŒºåˆ«æ²¡æœ‰æ·±å…¥ç ”ç©¶ï¼Œå¯ä»¥å‚è€ƒæ–‡æ¡£ã€‚ æ­å»ºSpringCloudåº”ç”¨ æ¥ç€å…ˆæ­å»ºä¸€ä¸ªSpringCloudåº”ç”¨ç¾¤ï¼Œä¸»è¦åŒ…æ‹¬æ³¨å†Œä¸­å¿ƒ(registry-center)å’Œä¸€ä¸ªç®€å•çš„æœåŠ¡èŠ‚ç‚¹(cloud-prometheus-sample)ï¼Œå…¶ä¸­æ³¨å†Œä¸­å¿ƒåªå¼•å…¥eureka-serverçš„ä¾èµ–ï¼Œè€ŒæœåŠ¡èŠ‚ç‚¹ç”¨äºå¯¹æ¥Prometheusï¼Œå¼•å…¥eureka-clientã€spring-boot-starter-actuatorã€prometheusç­‰ä¾èµ–ã€‚ registry-center registry-centeræ˜¯ä¸€ä¸ªå•çº¯çš„æœåŠ¡æ³¨å†Œä¸­å¿ƒï¼Œåªéœ€è¦å¼•å…¥eureka-serverçš„ä¾èµ–ï¼Œæ·»åŠ ä¸€ä¸ªå¯åŠ¨ç±»å³å¯ï¼Œæ·»åŠ çš„ä¾èµ–å¦‚ä¸‹ï¼š 1234&lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-server&lt;/artifactId&gt;&lt;/dependency&gt; æ·»åŠ ä¸€ä¸ªå¯åŠ¨ç±»ï¼š 123456789101112131415161718import org.springframework.boot.SpringApplication;import org.springframework.boot.autoconfigure.SpringBootApplication;import org.springframework.cloud.netflix.eureka.server.EnableEurekaServer;/** * @author throwable * @version v1.0 * @description * @since 2018/7/21 9:06 */@SpringBootApplication@EnableEurekaServerpublic class RegistryCenterApplication &#123; public static void main(String[] args) &#123; SpringApplication.run(RegistryCenterApplication.class, args); &#125;&#125; é…ç½®æ–‡ä»¶application.yamlå¦‚ä¸‹ï¼š 1234567891011121314server: port: 9091spring: application: name: registry-centereureka: instance: hostname: localhost client: enabled: true register-with-eureka: false fetch-registry: false service-url: defaultZone: http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/ å°±æ˜¯è¿™ä¹ˆç®€å•ï¼Œå¯åŠ¨å…¥å£ç±»å³å¯ï¼Œå¯åŠ¨çš„ç«¯å£ä¸º9091ã€‚ cloud-prometheus-sample cloud-prometheus-sampleä¸»è¦ä½œä¸ºeureka-clientï¼Œæ¥å…¥spring-boot-starter-actuatorå’Œprometheusä¾èµ–ï¼Œå¼•å…¥ä¾èµ–å¦‚ä¸‹ï¼š 123456789101112&lt;dependency&gt; &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt; &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt; &lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;&lt;/dependency&gt;&lt;dependency&gt; &lt;groupId&gt;io.micrometer&lt;/groupId&gt; &lt;artifactId&gt;micrometer-registry-prometheus&lt;/artifactId&gt;&lt;/dependency&gt; è¿™é‡Œå¼•å…¥çš„æ˜¯micrometer-registry-prometheusè€Œä¸æ˜¯micrometer-spring-legacyæ˜¯å› ä¸ºmicrometer-spring-legacyæ˜¯spring-integration(springç³»ç»Ÿé›†æˆ)çš„ä¾èµ–ï¼Œè¿™é‡Œæ²¡æœ‰ç”¨åˆ°ï¼Œä½†æ˜¯é‡Œé¢å¾ˆå¤šå®ç°å¯ä»¥å‚è€ƒã€‚micrometer-registry-prometheusæä¾›äº†åŸºäºactuatorçš„ç«¯ç‚¹ï¼Œè·¯å¾„æ˜¯â€¦/prometheusã€‚å¯åŠ¨ç±»å¦‚ä¸‹ï¼š 123456789101112131415161718import org.springframework.boot.SpringApplication;import org.springframework.boot.autoconfigure.SpringBootApplication;import org.springframework.cloud.netflix.eureka.EnableEurekaClient;/** * @author throwable * @version v1.0 * @description * @since 2018/7/21 9:13 */@SpringBootApplication@EnableEurekaClientpublic class SampleApplication &#123; public static void main(String[] args) &#123; SpringApplication.run(SampleApplication.class, args); &#125;&#125; é…ç½®æ–‡ä»¶application.yamlå¦‚ä¸‹ï¼š 12345678910server: port: 9092spring: application: name: cloud-prometheus-sampleeureka: instance: hostname: localhost client: service-url: http://localhost:9091/eureka/ å¯åŠ¨ç«¯å£ä¸º9092ï¼Œeurekaçš„æœåŠ¡æ³¨å†Œåœ°å€ä¸ºï¼šhttp://localhost:9091/eureka/ï¼Œä¹Ÿå°±æ˜¯registry-centerä¸­æŒ‡å®šçš„é»˜è®¤æ•°æ®åŒº(defaultZone)çš„æ³¨å†Œåœ°å€ï¼Œå…ˆå¯åŠ¨registry-centerï¼Œå†å¯åŠ¨cloud-prometheus-sampleï¼Œç„¶åè®¿é—®http://localhost:9091/ï¼š è®¿é—®http://localhost:9092/actuator/prometheusï¼š è¿™äº›æ•°æ®å°±æ˜¯å®æ—¶çš„åº¦é‡æ•°æ®ï¼ŒPrometheus(è½¯ä»¶)é…ç½®å¥½ä»»åŠ¡å¹¶ä¸”å¯åŠ¨æ‰§è¡Œåï¼Œå°±æ˜¯é€šè¿‡å®šæ—¶æ‹‰å–/prometheusè¿™ä¸ªç«¯ç‚¹è¿”å›çš„æ•°æ®è¿›è¡Œæ•°æ®èšåˆå’Œå±•ç¤ºçš„ã€‚ æ¥ç€ï¼Œæˆ‘ä»¬å…ˆå®šåˆ¶ä¸€ä¸ªåŠŸèƒ½ï¼Œç»Ÿè®¡cloud-prometheus-sampleæ‰€æœ‰å…¥ç«™çš„Httpè¯·æ±‚æ•°é‡(åŒ…æ‹¬æˆåŠŸã€å¤±è´¥å’Œéæ³•çš„)ï¼Œæ·»åŠ å¦‚ä¸‹ä»£ç ï¼š 123456789101112131415161718192021222324252627//è¯·æ±‚æ‹¦æˆªå™¨@Componentpublic class SampleMvcInterceptor extends HandlerInterceptorAdapter &#123; private static final Counter COUNTER = Counter.builder(\"Httpè¯·æ±‚ç»Ÿè®¡\") .tag(\"HttpCount\", \"HttpCount\") .description(\"Httpè¯·æ±‚ç»Ÿè®¡\") .register(Metrics.globalRegistry); @Override public void afterCompletion(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex) throws Exception &#123; COUNTER.increment(); &#125;&#125;//è‡ªå®šä¹‰Mvcé…ç½®@Componentpublic class SampleWebMvcConfigurer implements WebMvcConfigurer &#123; @Autowired private SampleMvcInterceptor sampleMvcInterceptor; @Override public void addInterceptors(InterceptorRegistry registry) &#123; registry.addInterceptor(sampleMvcInterceptor); &#125;&#125; é‡å¯cloud-prometheus-sampleï¼Œç›´æ¥è®¿é—®å‡ æ¬¡ä¸å­˜åœ¨çš„æ ¹èŠ‚ç‚¹è·¯å¾„http://localhost:9092ï¼Œå†æŸ¥çœ‹ç«¯ç‚¹ç»Ÿè®¡æ•°æ®ï¼š å®‰è£…å’Œä½¿ç”¨Prometheus å…ˆä»Prometheuså®˜æ–¹ä¸‹è½½åœ°å€ä¸‹è½½è½¯ä»¶ï¼Œè¿™é‡Œç”¨Windows10å¹³å°æ¼”ç¤ºï¼Œç›´æ¥ä¸‹è½½prometheus-2.3.2.windows-amd64.tar.gzï¼Œä¸ªäººæœ‰è½¯ä»¶æ´ç™–ï¼Œç”¨è½¯ä»¶æˆ–è€…ä¾èµ–å–œæ¬¢æœ€é«˜ç‰ˆæœ¬ï¼Œå‡ºç°å‘äº†è‡ªå·±å¡«ã€‚è§£å‹åç›®å½•å¦‚ä¸‹ï¼š å¯åŠ¨çš„è¯ï¼Œç›´æ¥è¿è¡Œprometheus.exeå³å¯ï¼Œè¿™é‡Œå…ˆé…ç½®ä¸€ä¸‹prometheus.ymlï¼š 12345678910111213global: scrape_interval: 15s # Set the scrape interval to every 15 seconds. Default is every 1 minute. evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.alerting: alertmanagers: - static_configs: - targets: # - alertmanager:9093scrape_configs: - job_name: 'prometheus' metrics_path: /actuator/prometheus static_configs: - targets: ['localhost:9092'] æˆ‘ä»¬ä¸»è¦ä¿®æ”¹çš„æ˜¯scrape_configsèŠ‚ç‚¹ä¸‹çš„é…ç½®ï¼Œè¿™ä¸ªèŠ‚ç‚¹æ—¶é…ç½®åŒæ­¥ä»»åŠ¡çš„ï¼Œè¿™é‡Œé…ç½®ä¸€ä¸ªä»»åŠ¡ä¸ºâ€™prometheusâ€™ï¼Œæ‹‰å–æ•°æ®çš„è·¯å¾„ä¸º/actuator/prometheusï¼Œç›®æ ‡host-portä¸ºâ€™localhost:9092â€™ï¼Œä¹Ÿå°±æ˜¯cloud-prometheus-sampleæš´éœ²çš„prometheusç«¯ç‚¹ï¼ŒPrometheus(è½¯ä»¶)çš„é»˜è®¤å¯åŠ¨ç«¯å£ä¸º9090ã€‚å¯åŠ¨åï¼ŒåŒçº§ç›®å½•ä¸‹ä¼šç”Ÿæˆä¸€ä¸ªdataç›®å½•ï¼Œå®é™…ä¸Šèµ·åˆ°&quot;æ—¶åºæ•°æ®åº“&quot;çš„ç±»ä¼¼ä½œç”¨ã€‚è®¿é—®Prometheus(è½¯ä»¶)çš„æ§åˆ¶å°http://localhost:9090/targets: Prometheusåº¦é‡ç»Ÿè®¡çš„æ‰€æœ‰ç›‘æ§é¡¹å¯ä»¥åœ¨http://localhost:9090/graphä¸­æŸ¥çœ‹åˆ°ã€‚è¿™é‡Œå¯ä»¥è§‚å¯Ÿåˆ°HttpCountçš„ç»Ÿè®¡ï¼Œä½†æ˜¯ç•Œé¢ä¸å¤Ÿç‚«é…·ï¼Œé…ç½®é¡¹ä¹Ÿå°‘ï¼Œå› æ­¤éœ€è¦å¼•å…¥Grafanaã€‚ å®‰è£…å’Œæ¥å…¥Grafana Grafanaçš„å®‰è£…ä¹Ÿååˆ†ç®€å•ï¼Œå®ƒä¹Ÿæ˜¯å¼€ç®±å³ç”¨çš„ï¼Œå°±æ˜¯é…ç½®çš„æ—¶å€™éœ€è¦ç†Ÿæ‚‰å®ƒçš„è¯­æ³•ã€‚å…ˆåˆ°Grafanaå®˜ç½‘ä¸‹è½½é¡µé¢ä¸‹è½½ä¸€ä¸ªé€‚åˆç³»ç»Ÿçš„ç‰ˆæœ¬ï¼Œè¿™é‡Œé€‰æ‹©Windowsç‰ˆæœ¬ã€‚è§£å‹ä¹‹åï¼Œç›´æ¥è¿è¡Œbinç›®å½•ä¸‹çš„grafana-server.exeå³å¯ï¼Œé»˜è®¤çš„å¯åŠ¨ç«¯å£æ˜¯3000ï¼Œè®¿é—®http://localhost:3000/ï¼Œåˆå§‹åŒ–è´¦å·å¯†ç æ˜¯admin/adminï¼Œé¦–æ¬¡ç™»é™†éœ€è¦ä¿®æ”¹å¯†ç ï¼Œæ¥ç€æ·»åŠ ä¸€ä¸ªæ•°æ®æºï¼š æ¥ç€æ·»åŠ ä¸€ä¸ªæ–°çš„å‘½åä¸ºâ€™sampleâ€™çš„Dashboardï¼Œæ·»åŠ ä¸€ä¸ªGraphç±»å‹çš„Panelï¼Œé…ç½®å…¶å±æ€§ï¼š Aè®°å½•(æŸ¥è¯¢å‘½ä»¤)å°±æ˜¯å¯¹åº”http://localhost:9090/graphä¸­çš„æŸ¥è¯¢å‘½ä»¤çš„ç›®æ ‡ï¼š å¾ˆç®€å•ï¼Œé…ç½®å®Œæ¯•ä¹‹åï¼Œå°±å¯ä»¥çœ‹åˆ°é«˜å¤§ä¸Šçš„ç»Ÿè®¡å›¾ï¼š è¿™é‡Œåªæ˜¯ä»‹ç»äº†Grafanaä½¿ç”¨çš„å†°å±±ä¸€è§’ï¼Œæ›´å¤šé…ç½®å’Œä½¿ç”¨å‘½ä»¤å¯ä»¥è‡ªè¡ŒæŸ¥é˜…å®ƒçš„å®˜æ–¹æ–‡æ¡£ã€‚ åŸç†å’Œæ‰©å±• åŸç† ä¸‹é¢æ˜¯Prometheusçš„å·¥ä½œåŸç†æµç¨‹å›¾ï¼Œæ¥æºäºå…¶å®˜ç½‘ï¼š åœ¨SpringBooté¡¹ç›®ä¸­ï¼Œå®ƒçš„å·¥ä½œåŸç†å¦‚ä¸‹ï¼š è¿™å°±æ˜¯ä¸ºä»€ä¹ˆèƒ½å¤Ÿä½¿ç”¨Metricsçš„é™æ€æ–¹æ³•ç›´æ¥è¿›è¡Œæ•°æ®ç»Ÿè®¡ï¼Œå› ä¸ºSpringå†…éƒ¨ç”¨MeterRegistryPostProcessorå¯¹Metricså†…éƒ¨æŒæœ‰çš„å…¨å±€çš„CompositeMeterRegistryè¿›è¡Œäº†åˆæˆæ“ä½œï¼Œä¹Ÿå°±æ˜¯æ‰€æœ‰MeterRegistryç±»å‹çš„Beanéƒ½ä¼šæ·»åŠ åˆ°Metricså†…éƒ¨æŒæœ‰çš„é™æ€globalRegistryã€‚ æ‰©å±• ä¸‹é¢æ¥ä¸ªç›¸å¯¹æœ‰ç”Ÿäº§æ„ä¹‰çš„æ‰©å±•å®ç°ï¼Œè¿™ç¯‡æ–‡ç« æåˆ°SpringCloudä½“ç³»çš„ç›‘æ§ï¼Œæˆ‘ä»¬éœ€è¦æ‰©å±•ä¸€ä¸ªåŠŸèƒ½ï¼Œè®°å½•ä¸€ä¸‹æ¯ä¸ªæœ‰æ•ˆçš„è¯·æ±‚çš„æ‰§è¡Œæ—¶é—´ã€‚æ·»åŠ ä¸‹é¢å‡ ä¸ªç±»æˆ–è€…æ–¹æ³•ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576777879808182//æ³¨è§£@Documented@Retention(RetentionPolicy.RUNTIME)@Target(ElementType.METHOD)public @interface MethodMetric &#123; String name() default \"\"; String description() default \"\"; String[] tags() default &#123;&#125;;&#125;//åˆ‡é¢ç±»@Aspect@Componentpublic class HttpMethodCostAspect &#123; @Autowired private MeterRegistry meterRegistry; @Pointcut(\"@annotation(club.throwable.sample.aspect.MethodMetric)\") public void pointcut() &#123; &#125; @Around(value = \"pointcut()\") public Object process(ProceedingJoinPoint joinPoint) throws Throwable &#123; Method targetMethod = ((MethodSignature) joinPoint.getSignature()).getMethod(); //è¿™é‡Œæ˜¯ä¸ºäº†æ‹¿åˆ°å®ç°ç±»çš„æ³¨è§£ Method currentMethod = ClassUtils.getUserClass(joinPoint.getTarget().getClass()) .getDeclaredMethod(targetMethod.getName(), targetMethod.getParameterTypes()); if (currentMethod.isAnnotationPresent(MethodMetric.class)) &#123; MethodMetric methodMetric = currentMethod.getAnnotation(MethodMetric.class); return processMetric(joinPoint, currentMethod, methodMetric); &#125; else &#123; return joinPoint.proceed(); &#125; &#125; private Object processMetric(ProceedingJoinPoint joinPoint, Method currentMethod, MethodMetric methodMetric) throws Throwable &#123; String name = methodMetric.name(); if (!StringUtils.hasText(name)) &#123; name = currentMethod.getName(); &#125; String desc = methodMetric.description(); if (!StringUtils.hasText(desc)) &#123; desc = name; &#125; String[] tags = methodMetric.tags(); if (tags.length == 0) &#123; tags = new String[2]; tags[0] = name; tags[1] = name; &#125; Timer timer = Timer.builder(name).tags(tags) .description(desc) .register(meterRegistry); return timer.record(() -&gt; &#123; try &#123; return joinPoint.proceed(); &#125; catch (Throwable throwable) &#123; throw new IllegalStateException(throwable); &#125; &#125;); &#125;&#125;//å¯åŠ¨ç±»é‡Œé¢æ·»åŠ æ–¹æ³•@SpringBootApplication@EnableEurekaClient@RestControllerpublic class SampleApplication &#123; public static void main(String[] args) &#123; SpringApplication.run(SampleApplication.class, args); &#125; @MethodMetric @GetMapping(value = \"/hello\") public String hello(@RequestParam(name = \"name\", required = false, defaultValue = \"doge\") String name) &#123; return String.format(\"%s say hello!\", name); &#125;&#125; é…ç½®å¥½Grafanaçš„é¢æ¿ï¼Œé‡å¯é¡¹ç›®ï¼Œå¤šæ¬¡è°ƒç”¨/helloæ¥å£ï¼š åè®° å¦‚æœæƒ³æŠŠç›‘æ§ç•Œé¢åšå¾—æ›´ç‚«é…·ã€æ›´ç›´è§‚ã€æ›´è¯¦ç»†ï¼Œå¯ä»¥å…ˆç†Ÿæ‚‰ä¸€ä¸‹Prometheusçš„æŸ¥è¯¢è¯­æ³•å’ŒGrafanaçš„é¢æ¿é…ç½®ï¼Œæ­¤å¤–ï¼ŒGrafanaæˆ–è€…Prometheuséƒ½æ”¯æŒé¢„è­¦åŠŸèƒ½ï¼Œå¯ä»¥æ¥å…¥é’‰é’‰æœºå™¨äººç­‰ä»¥ä¾¿åŠæ—¶å‘ç°é—®é¢˜ä½œå‡ºé¢„è­¦ã€‚ å‚è€ƒèµ„æ–™ï¼š https://prometheus.io/ https://spring.io/ https://github.com/percona/grafana-dashboards æœ¬æ–‡Demoé¡¹ç›®ä»“åº“ï¼šhttps://github.com/zjcscut/spring-cloud-prometheus-sample (æœ¬æ–‡å®Œ c-5-d e-a-20180721 r-a-201918)","categories":[{"name":"Spring","slug":"Spring","permalink":"http://throwable.club/blog/categories/Spring/"},{"name":"Prometheus","slug":"Spring/Prometheus","permalink":"http://throwable.club/blog/categories/Spring/Prometheus/"}],"tags":[{"name":"Spring","slug":"Spring","permalink":"http://throwable.club/blog/tags/Spring/"},{"name":"SpringCloud","slug":"SpringCloud","permalink":"http://throwable.club/blog/tags/SpringCloud/"}]},{"title":"JDKä¸­æ³¨è§£çš„åº•å±‚å®ç°","slug":"annotation-implementation","date":"2018-11-04T10:41:44.000Z","updated":"2018-11-04T10:45:13.629Z","comments":true,"path":"2018/11/04/annotation-implementation/","link":"","permalink":"http://throwable.club/2018/11/04/annotation-implementation/","excerpt":"","text":"å‰æ ç”¨Javaå¿«ä¸‰å¹´äº†ï¼Œæ³¨è§£ç®—æ˜¯ä¸€ä¸ªå¸¸ç”¨çš„ç±»å‹ï¼Œç‰¹åˆ«æ˜¯åœ¨ä¸€äº›æ¡†æ¶é‡Œé¢ä¼šå¤§é‡ä½¿ç”¨æ³¨è§£åšç»„ä»¶æ ‡è¯†ã€é…ç½®æˆ–è€…ç­–ç•¥ã€‚ä½†æ˜¯ä¸€ç›´æ²¡æœ‰æ·±å…¥å»æ¢ç©¶JDKä¸­çš„æ³¨è§£åˆ°åº•æ˜¯ä»€ä¹ˆï¼Œåº•å±‚æ˜¯æ€ä¹ˆå®ç°äº†?äºæ˜¯å‚è€ƒäº†ä¸€äº›èµ„æ–™ï¼Œåšäº†ä¸€æ¬¡ç¨å¾®è¯¦ç»†çš„åˆ†æã€‚ JDKçš„æ³¨è§£æè¿° å‚è€ƒJavaSE-8é‡Œé¢çš„JLS-9.6å¯¹æ³¨è§£çš„æè¿°å¦‚ä¸‹ï¼š æ³¨è§£çš„å£°æ˜å¦‚ä¸‹ï¼š 123&#123;InterfaceModifier&#125; @ interface Identifier AnnotationTypeBodyæ¥å£ä¿®é¥°ç¬¦ @ interface æ³¨è§£æ ‡è¯†ç¬¦ æ³¨è§£ç±»å‹çš„å†…å®¹ å…¶ä¸­ï¼š æ³¨è§£ç±»å‹å£°æ˜ä¸­çš„æ ‡è¯†ç¬¦æŒ‡å®šäº†æ³¨è§£ç±»å‹çš„åç§°ã€‚ å¦‚æœæ³¨è§£ç±»å‹ä¸å®ƒçš„ä»»ä½•å°é—­ç±»æˆ–æ¥å£å…·æœ‰ç›¸åŒçš„ç®€å•åç§°ï¼Œåˆ™ç¼–è¯‘æ—¶ä¼šå‡ºç°é”™è¯¯ã€‚ æ¯ä¸ªæ³¨è§£ç±»å‹çš„ç›´æ¥çˆ¶æ¥å£éƒ½æ˜¯java.lang.annotation.Annotationã€‚ æ—¢ç„¶æ‰€æœ‰æ³¨è§£ç±»å‹çš„çˆ¶æ¥å£éƒ½æ˜¯java.lang.annotation.Annotationï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥çœ‹ä¸€ä¸‹Annotationæ¥å£çš„æ–‡æ¡£ï¼š public interface Annotation The common interface extended by all annotation types. Note that an interface that manually extends this one does not define an annotation type. Also note that this interface does not itself define an annotation type. More information about annotation types can be found in section 9.6 of The Javaâ„¢ Language Specification. The AnnotatedElement interface discusses compatibility concerns when evolving an annotation type from being non-repeatable to being repeatable. Since: 1.5 JavaSE-8ä¸­çš„æ–‡æ¡£å¯¹Annotationçš„æè¿°å’ŒJLS-9.6ä¸­å·®ä¸å¤šï¼Œä¸è¿‡æœ€åæŒ‡æ˜äº†å¯é‡å¤æ³¨è§£çš„å…¼å®¹æ€§è€ƒè™‘çš„é—®é¢˜ï¼Œå¯é‡å¤æ³¨è§£åœ¨JDK1.8ä¸­ç”±å…ƒæ³¨è§£@Repeatableå®ç°ã€‚ä¸‹é¢åŸºäºJDK8çš„æœ€åä¸€ä¸ªç‰ˆæœ¬java version 1.8.0_181æ¢ç©¶ä¸€ä¸‹æ³¨è§£åœ¨JDKä¸­çš„åº•å±‚å®ç°ã€‚ æ³¨è§£å®ç°æ¢ç©¶ æˆ‘ä»¬å…ˆå®šä¹‰ä¸€ä¸ªååˆ†ç®€å•çš„Counteræ³¨è§£å¦‚ä¸‹ï¼š 1234567891011package club.throwable.annotation;import java.lang.annotation.*;@Retention(RetentionPolicy.RUNTIME)@Documented@Target(ElementType.TYPE)public @interface Counter &#123; int count() default 0;&#125; æˆ‘ä»¬å…ˆä»ç›´æ¥ä½¿ç”¨@Counteræ³¨è§£ï¼Œä»ç›´è§‚ä¸Šè§‚å¯Ÿ@Counterå®ä¾‹çš„ç±»å‹ï¼š 12345678@Counter(count = 1)public class Main &#123; public static void main(String[] args) throws Exception&#123; Counter counter = Main.class.getAnnotation(Counter.class); System.out.println(counter.count()); &#125;&#125; @Counterå®ä¾‹ä»Debugè¿‡ç¨‹ä¸­è§‚å¯Ÿå‘ç°æ˜¯JDKçš„ä¸€ä¸ªä»£ç†ç±»(å¹¶ä¸”InvocationHandlerçš„å®ä¾‹æ˜¯sun.reflect.annotation.AnnotationInvocationHandlerï¼Œå®ƒæ˜¯ä¸€ä¸ªä¿®é¥°ç¬¦ä¸ºdefaultçš„sunåŒ…å†…å¯ç”¨çš„ç±»)ï¼Œä¸ºäº†éªŒè¯è¿™ä¸€ç‚¹æˆ‘ä»¬ä½¿ç”¨JDKçš„åç¼–è¯‘å‘½ä»¤æŸ¥çœ‹@Counterçš„å­—èŠ‚ç ï¼š 1javap -c -v D:\\Projects\\rxjava-seed\\target\\classes\\club\\throwable\\annotation\\Counter.class @Counteråç¼–è¯‘åçš„å­—èŠ‚ç å¦‚ä¸‹ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041Classfile /D:/Projects/rxjava-seed/target/classes/club/throwable/annotation/Counter.class Last modified 2018-10-6; size 487 bytes MD5 checksum 83cee23f426e5b51a096281068d8b555 Compiled from \"Counter.java\"public interface club.throwable.annotation.Counter extends java.lang.annotation.Annotation minor version: 0 major version: 52 flags: ACC_PUBLIC, ACC_INTERFACE, ACC_ABSTRACT, ACC_ANNOTATIONConstant pool: #1 = Class #19 // club/throwable/annotation/Counter #2 = Class #20 // java/lang/Object #3 = Class #21 // java/lang/annotation/Annotation #4 = Utf8 count #5 = Utf8 ()I #6 = Utf8 AnnotationDefault #7 = Integer 0 #8 = Utf8 SourceFile #9 = Utf8 Counter.java #10 = Utf8 RuntimeVisibleAnnotations #11 = Utf8 Ljava/lang/annotation/Retention; #12 = Utf8 value #13 = Utf8 Ljava/lang/annotation/RetentionPolicy; #14 = Utf8 RUNTIME #15 = Utf8 Ljava/lang/annotation/Documented; #16 = Utf8 Ljava/lang/annotation/Target; #17 = Utf8 Ljava/lang/annotation/ElementType; #18 = Utf8 TYPE #19 = Utf8 club/throwable/annotation/Counter #20 = Utf8 java/lang/Object #21 = Utf8 java/lang/annotation/Annotation&#123; public abstract int count(); descriptor: ()I flags: ACC_PUBLIC, ACC_ABSTRACT AnnotationDefault: default_value: I#7&#125;SourceFile: \"Counter.java\"RuntimeVisibleAnnotations: 0: #11(#12=e#13.#14) 1: #15() 2: #16(#12=[e#17.#18]) å¦‚æœç†Ÿæ‚‰å­—èŠ‚ç ï¼Œä»ç›´è§‚ä¸Šå¯ä»¥å¾—åˆ°ä¸‹é¢çš„ä¿¡æ¯ï¼š æ³¨è§£æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ƒç»§æ‰¿è‡ªjava.lang.annotation.Annotationçˆ¶æ¥å£ã€‚ @Counterå¯¹åº”çš„æ¥å£æ¥å£é™¤äº†ç»§æ‰¿äº†java.lang.annotation.Annotationä¸­çš„æŠ½è±¡æ–¹æ³•ï¼Œè‡ªèº«å®šä¹‰äº†ä¸€ä¸ªæŠ½è±¡æ–¹æ³•public abstract int count();ã€‚ æ—¢ç„¶æ³¨è§£æœ€åè½¬åŒ–ä¸ºä¸€ä¸ªæ¥å£ï¼Œæ³¨è§£ä¸­å®šä¹‰çš„æ³¨è§£æˆå‘˜å±æ€§ä¼šè½¬åŒ–ä¸ºæŠ½è±¡æ–¹æ³•ï¼Œé‚£ä¹ˆæœ€åè¿™äº›æ³¨è§£æˆå‘˜å±æ€§æ€ä¹ˆè¿›è¡Œèµ‹å€¼çš„å‘¢?ç­”æ¡ˆå°±æ˜¯ï¼šä¸ºæ³¨è§£å¯¹åº”çš„æ¥å£ç”Ÿæˆä¸€ä¸ªå®ç°è¯¥æ¥å£çš„åŠ¨æ€ä»£ç†ç±»ã€‚ç›´æ¥ç‚¹è¯´å°±æ˜¯ï¼šJavaé€šè¿‡åŠ¨æ€ä»£ç†çš„æ–¹å¼ç”Ÿæˆäº†ä¸€ä¸ªå®ç°äº†&quot;æ³¨è§£å¯¹åº”æ¥å£&quot;çš„å®ä¾‹ï¼Œè¯¥ä»£ç†ç±»å®ä¾‹å®ç°äº†&quot;æ³¨è§£æˆå‘˜å±æ€§å¯¹åº”çš„æ–¹æ³•&quot;ï¼Œè¿™ä¸ªæ­¥éª¤ç±»ä¼¼äº&quot;æ³¨è§£æˆå‘˜å±æ€§&quot;çš„èµ‹å€¼è¿‡ç¨‹ï¼Œè¿™æ ·å­å°±å¯ä»¥åœ¨ç¨‹åºè¿è¡Œçš„æ—¶å€™é€šè¿‡åå°„è·å–åˆ°æ³¨è§£çš„æˆå‘˜å±æ€§(è¿™é‡Œæ³¨è§£å¿…é¡»æ˜¯è¿è¡Œæ—¶å¯è§çš„ï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨äº†@Retention(RetentionPolicy.RUNTIME)ï¼Œå¦å¤–éœ€è¦ç†è§£JDKåŸç”ŸåŠ¨æ€ä»£ç†å’Œåå°„ç›¸å…³å†…å®¹)ã€‚ æ³¨è§£å¯¹åº”çš„åŠ¨æ€ä»£ç†ç±»å®ä¾‹ ä¸Šé¢ä¸€äº›å·²ç»æŒ‡å‡ºäº†ï¼Œæ³¨è§£çš„æœ€åº•å±‚å®ç°å°±æ˜¯ä¸€ä¸ªJDKçš„åŠ¨æ€ä»£ç†ç±»ï¼Œè€Œè¿™ä¸ªåŠ¨æ€ä»£ç†ç±»çš„ç”Ÿæˆè¿‡ç¨‹æˆ‘ä»¬å®Œå…¨å¯ä»¥é€šè¿‡Debugè·Ÿè¸ªï¼Œè¿™é‡Œåˆ—ä¸¾ä¸€ä¸‹ç¬”è€…è·Ÿè¸ªæ•´ä¸ªè¿‡ç¨‹çš„æµæ°´è´¦ï¼š 1ã€Class&lt;?&gt;#getAnnotation(Class&lt;A&gt; annotationClass)ï¼Œé€šè¿‡ç±»å‹è·å–æ³¨è§£å®ä¾‹ã€‚ 2ã€Class&lt;?&gt;#annotationData()ï¼Œè·å–æ³¨è§£çš„æ•°æ®ã€‚ 3ã€Class&lt;?&gt;#createAnnotationData(int classRedefinedCount)ï¼Œæ„å»ºæ³¨è§£çš„æ•°æ®ã€‚ 4ã€AnnotationParser#parseAnnotations(byte[] var0, ConstantPool var1, Class&lt;?&gt; var2)ï¼Œè¿™é‡Œå·²ç»æ˜¯sunåŒ…ä¸‹çš„ç±»ï¼Œæ— æ³•çœ‹åˆ°æºç ï¼Œè¿™ä¸ªæ–¹æ³•ç”¨äºè§£ææ³¨è§£ï¼Œè¿™ä¸€æ­¥ä½¿ç”¨åˆ°å­—èŠ‚ç ä¸­å¸¸é‡æ± çš„ç´¢å¼•è§£æï¼Œå¸¸é‡è§£æå®Œæ¯•ä¼šç”Ÿæˆä¸€ä¸ªæˆå‘˜å±æ€§é”®å€¼å¯¹ä½œä¸ºä¸‹ä¸€ä¸ªç¯èŠ‚çš„å…¥å‚ï¼Œå¸¸é‡æ± çš„è§£æå¯ä»¥çœ‹AnnotationParser#parseMemberValueæ–¹æ³•ã€‚ 5ã€AnnotationParser#annotationForMap(final Class&lt;? extends Annotation&gt; var0, final Map&lt;String, Object&gt; var1)ï¼ŒåŒæ ·æ˜¯sun.reflect.annotation.AnnotationParserä¸­çš„æ–¹æ³•ï¼Œç”¨äºç”Ÿæˆæ³¨è§£çš„åŠ¨æ€ä»£ç†ç±»ã€‚ æ³¨æ„ç¬¬5æ­¥ï¼Œè´´å‡ºå®ƒçš„æºç ï¼š 1234567public static Annotation annotationForMap(final Class&lt;? extends Annotation&gt; var0, final Map&lt;String, Object&gt; var1) &#123; return (Annotation)AccessController.doPrivileged(new PrivilegedAction&lt;Annotation&gt;() &#123; public Annotation run() &#123; return (Annotation)Proxy.newProxyInstance(var0.getClassLoader(), new Class[]&#123;var0&#125;, new AnnotationInvocationHandler(var0, var1)); &#125; &#125;);&#125; ç†Ÿæ‚‰JDKåŠ¨æ€ä»£ç†çš„è¿™é‡Œçš„ä»£ç åº”è¯¥çœ‹èµ·æ¥å¾ˆç®€å•ï¼Œå°±æ˜¯ç”Ÿæˆä¸€ä¸ªæ ‡å‡†çš„JDKåŠ¨æ€ä»£ç†ï¼Œè€ŒInvocationHandlerçš„å®ä¾‹æ˜¯AnnotationInvocationHandlerï¼Œå¯ä»¥çœ‹å®ƒçš„æˆå‘˜å˜é‡ã€æ„é€ æ–¹æ³•å’Œå®ç°InvocationHandleræ¥å£çš„invokeæ–¹æ³•ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253545556575859606162636465666768697071class AnnotationInvocationHandler implements InvocationHandler, Serializable &#123; private static final long serialVersionUID = 6182022883658399397L; //ä¿å­˜äº†å½“å‰æ³¨è§£çš„ç±»å‹ private final Class&lt;? extends Annotation&gt; type; //ä¿å­˜äº†æ³¨è§£çš„æˆå‘˜å±æ€§çš„åç§°å’Œå€¼çš„æ˜ å°„ï¼Œæ³¨è§£æˆå‘˜å±æ€§çš„åç§°å®é™…ä¸Šå°±å¯¹åº”ç€æ¥å£ä¸­æŠ½è±¡æ–¹æ³•çš„åç§° private final Map&lt;String, Object&gt; memberValues; private transient volatile Method[] memberMethods = null; AnnotationInvocationHandler(Class&lt;? extends Annotation&gt; var1, Map&lt;String, Object&gt; var2) &#123; Class[] var3 = var1.getInterfaces(); if (var1.isAnnotation() &amp;&amp; var3.length == 1 &amp;&amp; var3[0] == Annotation.class) &#123; this.type = var1; this.memberValues = var2; &#125; else &#123; throw new AnnotationFormatError(\"Attempt to create proxy for a non-annotation type.\"); &#125; &#125; public Object invoke(Object var1, Method var2, Object[] var3) &#123; //è·å–å½“å‰æ‰§è¡Œçš„æ–¹æ³•åç§° String var4 = var2.getName(); Class[] var5 = var2.getParameterTypes(); if (var4.equals(\"equals\") &amp;&amp; var5.length == 1 &amp;&amp; var5[0] == Object.class) &#123; return this.equalsImpl(var3[0]); &#125; else if (var5.length != 0) &#123; throw new AssertionError(\"Too many parameters for an annotation method\"); &#125; else &#123; byte var7 = -1; switch(var4.hashCode()) &#123; case -1776922004: if (var4.equals(\"toString\")) &#123; var7 = 0; &#125; break; case 147696667: if (var4.equals(\"hashCode\")) &#123; var7 = 1; &#125; break; case 1444986633: if (var4.equals(\"annotationType\")) &#123; var7 = 2; &#125; &#125; switch(var7) &#123; case 0: return this.toStringImpl(); case 1: return this.hashCodeImpl(); case 2: return this.type; default: //åˆ©ç”¨æ–¹æ³•åç§°ä»memberValuesè·å–æˆå‘˜å±æ€§çš„èµ‹å€¼ Object var6 = this.memberValues.get(var4); if (var6 == null) &#123; throw new IncompleteAnnotationException(this.type, var4); &#125; else if (var6 instanceof ExceptionProxy) &#123; throw ((ExceptionProxy)var6).generateException(); &#125; else &#123; //è¿™ä¸€æ­¥å°±æ˜¯æ³¨è§£æˆå‘˜å±æ€§è¿”å›å€¼è·å–çš„å®é™…é€»è¾‘ //éœ€è¦åˆ¤æ–­æ˜¯å¦æ•°æ®ï¼Œå¦‚æœæ˜¯æ•°æ®éœ€è¦å…‹éš†ä¸€ä¸ªæ•°ç»„ //ä¸æ˜¯æ•°ç»„ç›´æ¥è¿”å› if (var6.getClass().isArray() &amp;&amp; Array.getLength(var6) != 0) &#123; var6 = this.cloneArray(var6); &#125; return var6; &#125; &#125; &#125; &#125;//å¿½ç•¥å…¶ä»–æ–¹æ³• è¿™é‡Œéœ€è¦é‡ç‚¹æ³¨æ„ä¸€ä¸‹çš„æ˜¯ï¼šAnnotationInvocationHandlerçš„æˆå‘˜å˜é‡Map&lt;String, Object&gt; memberValueså­˜æ”¾ç€æ³¨è§£çš„æˆå‘˜å±æ€§çš„åç§°å’Œå€¼çš„æ˜ å°„ï¼Œæ³¨è§£æˆå‘˜å±æ€§çš„åç§°å®é™…ä¸Šå°±å¯¹åº”ç€æ¥å£ä¸­æŠ½è±¡æ–¹æ³•çš„åç§°ï¼Œä¾‹å¦‚ä¸Šé¢æˆ‘ä»¬å®šä¹‰çš„@Counteræ³¨è§£ç”Ÿæˆä»£ç†ç±»åï¼Œå®ƒçš„AnnotationInvocationHandlerå®ä¾‹ä¸­çš„memberValueså±æ€§å­˜æ”¾ç€é”®å€¼å¯¹count=1ã€‚ æ—¢ç„¶çŸ¥é“äº†æ³¨è§£åº•å±‚ä½¿ç”¨äº†JDKåŸç”Ÿçš„Proxyï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥ç›´æ¥è¾“å‡ºä»£ç†ç±»åˆ°æŒ‡å®šç›®å½•å»åˆ†æä»£ç†ç±»çš„æºç ï¼Œæœ‰ä¸¤ç§æ–¹å¼å¯ä»¥è¾“å‡ºProxyç±»çš„æºç ï¼š 1ã€é€šè¿‡Javaç³»ç»Ÿå±æ€§è®¾ç½®System.setProperty(&quot;sun.misc.ProxyGenerator.saveGeneratedFiles&quot;, &quot;true&quot;);ã€‚ 2ã€é€šè¿‡-Då‚æ•°æŒ‡å®šï¼Œå…¶å®è·Ÿ1å·®ä¸å¤šï¼Œå‚æ•°æ˜¯ï¼š-Dsun.misc.ProxyGenerator.saveGeneratedFiles=trueã€‚ è¿™é‡Œä½¿ç”¨æ–¹å¼1ï¼Œä¿®æ”¹ä¸€ä¸‹ä¸Šé¢ç”¨åˆ°çš„mainæ–¹æ³•ï¼š 12345public static void main(String[] args) throws Exception &#123; System.setProperty(\"sun.misc.ProxyGenerator.saveGeneratedFiles\", \"true\"); Counter counter = Main.class.getAnnotation(Counter.class); System.out.println(counter.count());&#125; æ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œé¡¹ç›®ä¸­å¤šäº†ä¸€ä¸ªç›®å½•ï¼š å…¶ä¸­$Proxy0æ˜¯@Retentionæ³¨è§£å¯¹åº”çš„åŠ¨æ€ä»£ç†ç±»ï¼Œè€Œ$Proxy1æ‰æ˜¯æˆ‘ä»¬çš„@Counterå¯¹åº”çš„åŠ¨æ€ä»£ç†ç±»ï¼Œå½“ç„¶å¦‚æœæœ‰æ›´å¤šçš„æ³¨è§£ï¼Œé‚£ä¹ˆæœ‰å¯èƒ½ç”Ÿæˆ$ProxyNã€‚æ¥ç€æˆ‘ä»¬ç›´æ¥çœ‹$Proxy1çš„æºç ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475public final class $Proxy1 extends Proxy implements Counter &#123; private static Method m1; private static Method m2; private static Method m3; private static Method m4; private static Method m0; public $Proxy1(InvocationHandler var1) throws &#123; super(var1); &#125; public final boolean equals(Object var1) throws &#123; try &#123; return (Boolean)super.h.invoke(this, m1, new Object[]&#123;var1&#125;); &#125; catch (RuntimeException | Error var3) &#123; throw var3; &#125; catch (Throwable var4) &#123; throw new UndeclaredThrowableException(var4); &#125; &#125; public final String toString() throws &#123; try &#123; return (String)super.h.invoke(this, m2, (Object[])null); &#125; catch (RuntimeException | Error var2) &#123; throw var2; &#125; catch (Throwable var3) &#123; throw new UndeclaredThrowableException(var3); &#125; &#125; public final int count() throws &#123; try &#123; return (Integer)super.h.invoke(this, m3, (Object[])null); &#125; catch (RuntimeException | Error var2) &#123; throw var2; &#125; catch (Throwable var3) &#123; throw new UndeclaredThrowableException(var3); &#125; &#125; public final Class annotationType() throws &#123; try &#123; return (Class)super.h.invoke(this, m4, (Object[])null); &#125; catch (RuntimeException | Error var2) &#123; throw var2; &#125; catch (Throwable var3) &#123; throw new UndeclaredThrowableException(var3); &#125; &#125; public final int hashCode() throws &#123; try &#123; return (Integer)super.h.invoke(this, m0, (Object[])null); &#125; catch (RuntimeException | Error var2) &#123; throw var2; &#125; catch (Throwable var3) &#123; throw new UndeclaredThrowableException(var3); &#125; &#125; static &#123; try &#123; m1 = Class.forName(\"java.lang.Object\").getMethod(\"equals\", Class.forName(\"java.lang.Object\")); m2 = Class.forName(\"java.lang.Object\").getMethod(\"toString\"); m3 = Class.forName(\"club.throwable.annotation.Counter\").getMethod(\"count\"); m4 = Class.forName(\"club.throwable.annotation.Counter\").getMethod(\"annotationType\"); m0 = Class.forName(\"java.lang.Object\").getMethod(\"hashCode\"); &#125; catch (NoSuchMethodException var2) &#123; throw new NoSuchMethodError(var2.getMessage()); &#125; catch (ClassNotFoundException var3) &#123; throw new NoClassDefFoundError(var3.getMessage()); &#125; &#125;&#125; æ˜¾ç„¶ï¼Œ$Proxy1å®ç°äº†Counteræ¥å£ï¼Œå®ƒåœ¨ä»£ç çš„æœ€åéƒ¨åˆ†ä½¿ç”¨äº†é™æ€ä»£ç å—å®ä¾‹åŒ–äº†æˆå‘˜æ–¹æ³•çš„Methodå®ä¾‹ï¼Œåœ¨å‰é¢çš„ä»£ç å¯¹è¿™äº›Methodè¿›è¡Œäº†ç¼“å­˜ï¼Œåœ¨è°ƒç”¨æˆå‘˜æ–¹æ³•çš„æ—¶å€™éƒ½æ˜¯ç›´æ¥å§”æ‰˜åˆ°InvocationHandler(AnnotationInvocationHandler)å®ä¾‹å®Œæˆè°ƒç”¨ã€‚æˆ‘ä»¬åœ¨åˆ†æAnnotationInvocationHandlerçš„æ—¶å€™çœ‹åˆ°ï¼Œå®ƒåªç”¨åˆ°äº†Methodçš„åç§°ä»Mapä»åŒ¹é…å‡ºæˆå‘˜æ–¹æ³•çš„ç»“æœï¼Œå› æ­¤è°ƒç”¨è¿‡ç¨‹å¹¶ä¸æ˜¯åå°„è°ƒç”¨ï¼Œåè€Œæ˜¯ç›´æ¥çš„è°ƒç”¨ï¼Œæ•ˆç‡ç±»ä¼¼äºé€šè¿‡Keyä»Mapå®ä¾‹ä¸­è·å–Valueä¸€æ ·ï¼Œæ˜¯ååˆ†é«˜æ•ˆçš„ã€‚ å°ç»“ æ—¢ç„¶çŸ¥é“äº†æ³¨è§£çš„åº•å±‚åŸç†ï¼Œæˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸€ä¸ª&quot;æ³¨è§£æ¥å£&quot;å’ŒInvocationHandlerå®ç°æ¥ç®€å•æ¨¡æ‹Ÿæ•´ä¸ªè¿‡ç¨‹ã€‚å…ˆå®šä¹‰ä¸€ä¸ªæ¥å£ï¼š 1234public interface CounterAnnotation extends Annotation &#123; int count();&#125; InvocationHandlerçš„ç®€å•å®ç°ï¼š 123456789101112131415161718192021222324252627282930313233public class CounterAnnotationInvocationHandler implements InvocationHandler &#123; private final Map&lt;String, Object&gt; memberValues; private final Class&lt;? extends Annotation&gt; clazz; public CounterAnnotationInvocationHandler(Map&lt;String, Object&gt; memberValues, Class&lt;? extends Annotation&gt; clazz) &#123; this.memberValues = memberValues; this.clazz = clazz; &#125; @Override public Object invoke(Object proxy, Method method, Object[] args) throws Throwable &#123; String methodName = method.getName(); Object value; switch (methodName) &#123; case \"toString\": value = super.toString(); break; case \"hashCode\": value = super.hashCode(); break; case \"equals\": value = super.equals(args[0]); break; case \"annotationType\": value = clazz; break; default: value = memberValues.get(methodName); &#125; return value; &#125;&#125; ç¼–å†™ä¸€ä¸ªmainæ–¹æ³•ï¼š 1234567891011121314public class CounterAnnotationMain &#123; public static void main(String[] args) throws Exception&#123; //è¿™é‡Œæ¨¡æ‹Ÿäº†æ³¨è§£æˆå‘˜å±æ€§ä»å¸¸é‡æ± è§£æçš„è¿‡ç¨‹ Map&lt;String,Object&gt; values = new HashMap&lt;&gt;(8); values.put(\"count\", 1); //ç”Ÿæˆä»£ç†ç±» CounterAnnotation proxy = (CounterAnnotation)Proxy.newProxyInstance(CounterAnnotationMain.class.getClassLoader(), new Class[]&#123;CounterAnnotation.class&#125;, new CounterAnnotationInvocationHandler(values, CounterAnnotation.class)); System.out.println(proxy.count()); &#125;&#125;//è¿è¡Œåæ§åˆ¶å°è¾“å‡º:1 (æœ¬æ–‡å®Œ c-1-d e-20181006)","categories":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/categories/Java/"},{"name":"Annotation","slug":"Java/Annotation","permalink":"http://throwable.club/blog/categories/Java/Annotation/"}],"tags":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/tags/Java/"},{"name":"Annotation","slug":"Annotation","permalink":"http://throwable.club/blog/tags/Annotation/"}]},{"title":"JDKä¸­æšä¸¾çš„åº•å±‚å®ç°","slug":"enum-implementation","date":"2018-11-04T10:36:23.000Z","updated":"2018-11-17T07:52:01.552Z","comments":true,"path":"2018/11/04/enum-implementation/","link":"","permalink":"http://throwable.club/2018/11/04/enum-implementation/","excerpt":"","text":"å‰æ ä¸Šä¸€ç¯‡æ–‡ç« å¤ä¹ ä»‹ç»äº†JDKä¸­æ³¨è§£çš„åº•å±‚å®ç°ï¼Œè·Ÿæ³¨è§£ä¸€æ ·æ¯”è¾ƒå¸¸ç”¨ï¼Œä½†æ˜¯åº•å±‚å®ç°æ¯”è¾ƒç¥ç§˜çš„è¿˜æœ‰æšä¸¾ç±»å‹ã€‚è¶ç€å›½åº†å‡æœŸçš„æœ€åä¸¤å¤©ï¼ŒæŠŠJDKä¸­æšä¸¾çš„åº•å±‚å®ç°ä¹Ÿè¿›è¡Œä¸€æ¬¡æ¢ç©¶ã€‚ é€šè¿‡ä¾‹å­æŸ¥æ‰¾æœ¬è´¨ åœ¨æ¢ç©¶JDKæ³¨è§£çš„åº•å±‚å®ç°çš„æ—¶å€™ï¼Œå› ä¸ºé¢„å…ˆå‚è€ƒäº†ä¸å°‘èµ„æ–™ï¼Œæ‰€ä»¥æ•´ä¸ªè¿‡ç¨‹æœ‰ç‚¹&quot;æœªåœå…ˆçŸ¥&quot;çš„æ„å‘³ï¼Œè¿™é‡Œå°è¯•ç”¨æœªçŸ¥çš„è§’åº¦å»çœ‹æ³¨è§£çš„åº•å±‚å®ç°ã€‚å…ˆå®šä¹‰ä¸€ä¸ªæ‰‹æœºæ“ä½œç³»ç»Ÿç±»å‹æšä¸¾PhoneOsEnumï¼š 12345678910111213141516171819202122232425262728293031package club.throwable.enumeration;public enum PhoneOsEnum &#123; /** * å®‰å“ */ ANDROID(1, \"android\"), /** * ios */ IOS(2, \"ios\"); private final Integer type; private final String typeName; PhoneOsEnum(Integer type, String typeName) &#123; this.type = type; this.typeName = typeName; &#125; public Integer getType() &#123; return type; &#125; public String getTypeName() &#123; return typeName; &#125;&#125; è¿™æ˜¯ä¸€ä¸ªå¾ˆç®€å•çš„æšä¸¾ï¼Œæ¥ç€ä½¿ç”¨JDKçš„åç¼–è¯‘å·¥å…·åç¼–è¯‘å‡ºå…¶å­—èŠ‚ç ï¼Œæ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼š 1javap -c -v D:\\Projects\\rxjava-seed\\target\\classes\\club\\throwable\\enumeration\\PhoneOsEnum.class ç„¶åå°±å¾—åˆ°äº†å…³äºPhoneOsEnum.classçš„å¾ˆé•¿çš„å­—èŠ‚ç ï¼Œè¿™é‡Œå…¨éƒ¨è´´å‡ºæ¥ï¼š 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186Classfile /D:/Projects/rxjava-seed/target/classes/club/throwable/enumeration/PhoneOsEnum.class Last modified 2018-10-6; size 1561 bytes MD5 checksum 6d3186042f54233219000927a2f196aa Compiled from \"PhoneOsEnum.java\"public final class club.throwable.enumeration.PhoneOsEnum extends java.lang.Enum&lt;club.throwable.enumeration.PhoneOsEnum&gt; minor version: 0 major version: 52 flags: ACC_PUBLIC, ACC_FINAL, ACC_SUPER, ACC_ENUMConstant pool: #1 = Fieldref #4.#49 // club/throwable/enumeration/PhoneOsEnum.$VALUES:[Lclub/throwable/enumeration/PhoneOsEnum; #2 = Methodref #50.#51 // \"[Lclub/throwable/enumeration/PhoneOsEnum;\".clone:()Ljava/lang/Object; #3 = Class #26 // \"[Lclub/throwable/enumeration/PhoneOsEnum;\" #4 = Class #52 // club/throwable/enumeration/PhoneOsEnum #5 = Methodref #17.#53 // java/lang/Enum.valueOf:(Ljava/lang/Class;Ljava/lang/String;)Ljava/lang/Enum; #6 = Methodref #17.#54 // java/lang/Enum.\"&lt;init&gt;\":(Ljava/lang/String;I)V #7 = Fieldref #4.#55 // club/throwable/enumeration/PhoneOsEnum.type:Ljava/lang/Integer; #8 = Fieldref #4.#56 // club/throwable/enumeration/PhoneOsEnum.typeName:Ljava/lang/String; #9 = String #18 // ANDROID #10 = Methodref #57.#58 // java/lang/Integer.valueOf:(I)Ljava/lang/Integer; #11 = String #59 // android #12 = Methodref #4.#60 // club/throwable/enumeration/PhoneOsEnum.\"&lt;init&gt;\":(Ljava/lang/String;ILjava/lang/Integer;Ljava/lang/String;)V #13 = Fieldref #4.#61 // club/throwable/enumeration/PhoneOsEnum.ANDROID:Lclub/throwable/enumeration/PhoneOsEnum; #14 = String #20 // IOS #15 = String #62 // ios #16 = Fieldref #4.#63 // club/throwable/enumeration/PhoneOsEnum.IOS:Lclub/throwable/enumeration/PhoneOsEnum; #17 = Class #64 // java/lang/Enum #18 = Utf8 ANDROID #19 = Utf8 Lclub/throwable/enumeration/PhoneOsEnum; #20 = Utf8 IOS #21 = Utf8 type #22 = Utf8 Ljava/lang/Integer; #23 = Utf8 typeName #24 = Utf8 Ljava/lang/String; #25 = Utf8 $VALUES #26 = Utf8 [Lclub/throwable/enumeration/PhoneOsEnum; #27 = Utf8 values #28 = Utf8 ()[Lclub/throwable/enumeration/PhoneOsEnum; #29 = Utf8 Code #30 = Utf8 LineNumberTable #31 = Utf8 valueOf #32 = Utf8 (Ljava/lang/String;)Lclub/throwable/enumeration/PhoneOsEnum; #33 = Utf8 LocalVariableTable #34 = Utf8 name #35 = Utf8 &lt;init&gt; #36 = Utf8 (Ljava/lang/String;ILjava/lang/Integer;Ljava/lang/String;)V #37 = Utf8 this #38 = Utf8 Signature #39 = Utf8 (Ljava/lang/Integer;Ljava/lang/String;)V #40 = Utf8 getType #41 = Utf8 ()Ljava/lang/Integer; #42 = Utf8 getTypeName #43 = Utf8 ()Ljava/lang/String; #44 = Utf8 &lt;clinit&gt; #45 = Utf8 ()V #46 = Utf8 Ljava/lang/Enum&lt;Lclub/throwable/enumeration/PhoneOsEnum;&gt;; #47 = Utf8 SourceFile #48 = Utf8 PhoneOsEnum.java #49 = NameAndType #25:#26 // $VALUES:[Lclub/throwable/enumeration/PhoneOsEnum; #50 = Class #26 // \"[Lclub/throwable/enumeration/PhoneOsEnum;\" #51 = NameAndType #65:#66 // clone:()Ljava/lang/Object; #52 = Utf8 club/throwable/enumeration/PhoneOsEnum #53 = NameAndType #31:#67 // valueOf:(Ljava/lang/Class;Ljava/lang/String;)Ljava/lang/Enum; #54 = NameAndType #35:#68 // \"&lt;init&gt;\":(Ljava/lang/String;I)V #55 = NameAndType #21:#22 // type:Ljava/lang/Integer; #56 = NameAndType #23:#24 // typeName:Ljava/lang/String; #57 = Class #69 // java/lang/Integer #58 = NameAndType #31:#70 // valueOf:(I)Ljava/lang/Integer; #59 = Utf8 android #60 = NameAndType #35:#36 // \"&lt;init&gt;\":(Ljava/lang/String;ILjava/lang/Integer;Ljava/lang/String;)V #61 = NameAndType #18:#19 // ANDROID:Lclub/throwable/enumeration/PhoneOsEnum; #62 = Utf8 ios #63 = NameAndType #20:#19 // IOS:Lclub/throwable/enumeration/PhoneOsEnum; #64 = Utf8 java/lang/Enum #65 = Utf8 clone #66 = Utf8 ()Ljava/lang/Object; #67 = Utf8 (Ljava/lang/Class;Ljava/lang/String;)Ljava/lang/Enum; #68 = Utf8 (Ljava/lang/String;I)V #69 = Utf8 java/lang/Integer #70 = Utf8 (I)Ljava/lang/Integer;&#123; public static final club.throwable.enumeration.PhoneOsEnum ANDROID; descriptor: Lclub/throwable/enumeration/PhoneOsEnum; flags: ACC_PUBLIC, ACC_STATIC, ACC_FINAL, ACC_ENUM public static final club.throwable.enumeration.PhoneOsEnum IOS; descriptor: Lclub/throwable/enumeration/PhoneOsEnum; flags: ACC_PUBLIC, ACC_STATIC, ACC_FINAL, ACC_ENUM public static club.throwable.enumeration.PhoneOsEnum[] values(); descriptor: ()[Lclub/throwable/enumeration/PhoneOsEnum; flags: ACC_PUBLIC, ACC_STATIC Code: stack=1, locals=0, args_size=0 0: getstatic #1 // Field $VALUES:[Lclub/throwable/enumeration/PhoneOsEnum; 3: invokevirtual #2 // Method \"[Lclub/throwable/enumeration/PhoneOsEnum;\".clone:()Ljava/lang/Object; 6: checkcast #3 // class \"[Lclub/throwable/enumeration/PhoneOsEnum;\" 9: areturn LineNumberTable: line 9: 0 public static club.throwable.enumeration.PhoneOsEnum valueOf(java.lang.String); descriptor: (Ljava/lang/String;)Lclub/throwable/enumeration/PhoneOsEnum; flags: ACC_PUBLIC, ACC_STATIC Code: stack=2, locals=1, args_size=1 0: ldc #4 // class club/throwable/enumeration/PhoneOsEnum 2: aload_0 3: invokestatic #5 // Method java/lang/Enum.valueOf:(Ljava/lang/Class;Ljava/lang/String;)Ljava/lang/Enum; 6: checkcast #4 // class club/throwable/enumeration/PhoneOsEnum 9: areturn LineNumberTable: line 9: 0 LocalVariableTable: Start Length Slot Name Signature 0 10 0 name Ljava/lang/String; public java.lang.Integer getType(); descriptor: ()Ljava/lang/Integer; flags: ACC_PUBLIC Code: stack=1, locals=1, args_size=1 0: aload_0 1: getfield #7 // Field type:Ljava/lang/Integer; 4: areturn LineNumberTable: line 31: 0 LocalVariableTable: Start Length Slot Name Signature 0 5 0 this Lclub/throwable/enumeration/PhoneOsEnum; public java.lang.String getTypeName(); descriptor: ()Ljava/lang/String; flags: ACC_PUBLIC Code: stack=1, locals=1, args_size=1 0: aload_0 1: getfield #8 // Field typeName:Ljava/lang/String; 4: areturn LineNumberTable: line 35: 0 LocalVariableTable: Start Length Slot Name Signature 0 5 0 this Lclub/throwable/enumeration/PhoneOsEnum; static &#123;&#125;; descriptor: ()V flags: ACC_STATIC Code: stack=6, locals=0, args_size=0 0: new #4 // class club/throwable/enumeration/PhoneOsEnum 3: dup 4: ldc #9 // String ANDROID 6: iconst_0 7: iconst_1 8: invokestatic #10 // Method java/lang/Integer.valueOf:(I)Ljava/lang/Integer; 11: ldc #11 // String android 13: invokespecial #12 // Method \"&lt;init&gt;\":(Ljava/lang/String;ILjava/lang/Integer;Ljava/lang/String;)V 16: putstatic #13 // Field ANDROID:Lclub/throwable/enumeration/PhoneOsEnum; 19: new #4 // class club/throwable/enumeration/PhoneOsEnum 22: dup 23: ldc #14 // String IOS 25: iconst_1 26: iconst_2 27: invokestatic #10 // Method java/lang/Integer.valueOf:(I)Ljava/lang/Integer; 30: ldc #15 // String ios 32: invokespecial #12 // Method \"&lt;init&gt;\":(Ljava/lang/String;ILjava/lang/Integer;Ljava/lang/String;)V 35: putstatic #16 // Field IOS:Lclub/throwable/enumeration/PhoneOsEnum; 38: iconst_2 39: anewarray #4 // class club/throwable/enumeration/PhoneOsEnum 42: dup 43: iconst_0 44: getstatic #13 // Field ANDROID:Lclub/throwable/enumeration/PhoneOsEnum; 47: aastore 48: dup 49: iconst_1 50: getstatic #16 // Field IOS:Lclub/throwable/enumeration/PhoneOsEnum; 53: aastore 54: putstatic #1 // Field $VALUES:[Lclub/throwable/enumeration/PhoneOsEnum; 57: return LineNumberTable: line 14: 0 line 19: 19 line 9: 38&#125;Signature: #46 // Ljava/lang/Enum&lt;Lclub/throwable/enumeration/PhoneOsEnum;&gt;;SourceFile: \"PhoneOsEnum.java\" å…ˆçœ‹ç±»çš„ç­¾åæ˜¯public final class club.throwable.enumeration.PhoneOsEnum extends java.lang.Enum&lt;club.throwable.enumeration.PhoneOsEnum&gt;ï¼Œå®ƒçš„çˆ¶ç±»æ˜¯java.lang.Enumï¼Œçˆ¶ç±»çš„æ³›å‹å°±æ˜¯è‡ªèº«club.throwable.enumeration.PhoneOsEnumã€‚ä¸Šé¢çš„å­—èŠ‚ç çš„å¯è¯»æ€§ç›¸å¯¹æ¯”è¾ƒä½ï¼Œç›´æ¥ç¿»è¯‘ä¸ºJavaä»£ç (å½“ç„¶æˆ‘ä»¬ä¸èƒ½å£°æ˜ä¸€ä¸ªç±»ç›´æ¥ç»§æ‰¿java.lang.Enumï¼Œè¿™é‡Œä»…ä»…ä¸ºäº†è¯´æ˜åç¼–è¯‘åçš„æšä¸¾ç±»çš„åŸå‹)å¦‚ä¸‹ï¼š 123456789101112131415161718192021222324252627282930313233343536public final class PhoneOsEnumeration extends Enum&lt;PhoneOsEnumeration&gt; &#123; public PhoneOsEnumeration(String name, int ordinal, Integer type, String typeName) &#123; super(name, ordinal); this.type = type; this.typeName = typeName; &#125; public Integer getType() &#123; return type; &#125; public String getTypeName() &#123; return typeName; &#125; public static PhoneOsEnumeration[] values() &#123; return $VALUES.clone(); &#125; public static PhoneOsEnumeration valueOf(String name) &#123; return Enum.valueOf(PhoneOsEnumeration.class, name); &#125; private final Integer type; private final String typeName; public static final PhoneOsEnumeration ANDROID; public static final PhoneOsEnumeration IOS; private static final PhoneOsEnumeration[] $VALUES; static &#123; ANDROID = new PhoneOsEnumeration(\"ANDROID\", 0, 1, \"android\"); IOS = new PhoneOsEnumeration(\"IOS\", 1, 2, \"ios\"); $VALUES = new PhoneOsEnumeration[]&#123;ANDROID, IOS&#125;; &#125;&#125; æ¦‚æ‹¬æ¥è¯´å°±æ˜¯æˆå‘˜å˜é‡éƒ½æ˜¯é€šè¿‡é™æ€ä»£ç å—å£°æ˜ï¼Œè¿™é‡Œæ³¨æ„ä¸€ç‚¹çˆ¶ç±»Enumå®ä¾‹åŒ–çš„æ—¶å€™éœ€è¦è¦†ç›–çˆ¶ç±»æ„é€ å™¨protected Enum(String name, int ordinal)ï¼Œå…¶ä»–æ–¹æ³•çš„å®ç°éƒ½æ˜¯ååˆ†ç®€å•ã€‚ JDKçš„æšä¸¾æè¿° å›½é™…æƒ¯ä¾‹ï¼Œå…ˆçœ‹ä¸€ä¸‹JavaSE-8çš„è¯­è¨€è§„èŒƒä¸­JLS-8.9å¯¹æšä¸¾ç±»å‹çš„å®šä¹‰å’Œæè¿°ï¼š æ„Ÿè§‰æœ‰ç‚¹ä¼¼æ›¾ç›¸è¯†ï¼Œæ€»ç»“ä¸€ä¸‹é‡è¦å†…å®¹æœ‰ä»¥ä¸‹å‡ ç‚¹ï¼š æšä¸¾çš„å£°æ˜æ ¼å¼æ˜¯ï¼š{ClassModifier} enum Identifier [Superinterfaces] EnumBodyï¼ŒClassModifieræ˜¯ä¿®é¥°ç¬¦ï¼ŒIdentifieræ˜¯æšä¸¾çš„åç§°å¯ä»¥ç±»æ¯”ä¸ºç±»åï¼Œæšä¸¾ç±»å‹å¯ä»¥å®ç°æ¥å£ã€‚ æšä¸¾ç±»å‹ä¸èƒ½ä½¿ç”¨abstractæˆ–è€…finalä¿®é¥°ï¼Œå¦åˆ™ä¼šäº§ç”Ÿç¼–è¯‘é”™è¯¯ã€‚ æšä¸¾ç±»å‹çš„ç›´æ¥è¶…ç±»æ˜¯java.lang.Enumã€‚ æšä¸¾ç±»å‹é™¤äº†æšä¸¾å¸¸é‡å®šä¹‰ä¹‹å¤–æ²¡æœ‰å…¶ä»–å®ä¾‹ï¼Œä¹Ÿå°±æ˜¯æšä¸¾ç±»å‹ä¸èƒ½å®ä¾‹åŒ–ã€‚ æšä¸¾ç±»å‹ç¦ç”¨åå°„æ“ä½œè¿›è¡Œå®ä¾‹åŒ–(è¿™ä¸ªç‰¹æ€§å°±æ˜¯Effetive Javaä¸­æ¨èä½¿ç”¨æšä¸¾å®ç°å•ä¾‹çš„åŸå› )ã€‚ æšä¸¾çš„å…¬å…±çˆ¶ç±»java.lang.Enumçš„æºç å¦‚ä¸‹(å·²ç»å»æ‰å…¨éƒ¨æ³¨é‡Š)ï¼š 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273public abstract class Enum&lt;E extends Enum&lt;E&gt;&gt; implements Comparable&lt;E&gt;, Serializable &#123; private final String name; public final String name() &#123; return name; &#125; private final int ordinal; public final int ordinal() &#123; return ordinal; &#125; protected Enum(String name, int ordinal) &#123; this.name = name; this.ordinal = ordinal; &#125; public String toString() &#123; return name; &#125; public final boolean equals(Object other) &#123; return this==other; &#125; public final int hashCode() &#123; return super.hashCode(); &#125; protected final Object clone() throws CloneNotSupportedException &#123; throw new CloneNotSupportedException(); &#125; public final int compareTo(E o) &#123; Enum&lt;?&gt; other = (Enum&lt;?&gt;)o; Enum&lt;E&gt; self = this; if (self.getClass() != other.getClass() &amp;&amp; // optimization self.getDeclaringClass() != other.getDeclaringClass()) throw new ClassCastException(); return self.ordinal - other.ordinal; &#125; public final Class&lt;E&gt; getDeclaringClass() &#123; Class&lt;?&gt; clazz = getClass(); Class&lt;?&gt; zuper = clazz.getSuperclass(); return (zuper == Enum.class) ? (Class&lt;E&gt;)clazz : (Class&lt;E&gt;)zuper; &#125; public static &lt;T extends Enum&lt;T&gt;&gt; T valueOf(Class&lt;T&gt; enumType, String name) &#123; T result = enumType.enumConstantDirectory().get(name); if (result != null) return result; if (name == null) throw new NullPointerException(\"Name is null\"); throw new IllegalArgumentException( \"No enum constant \" + enumType.getCanonicalName() + \".\" + name); &#125; protected final void finalize() &#123; &#125; private void readObject(ObjectInputStream in) throws IOException, ClassNotFoundException &#123; throw new InvalidObjectException(\"can't deserialize enum\"); &#125; private void readObjectNoData() throws ObjectStreamException &#123; throw new InvalidObjectException(\"can't deserialize enum\"); &#125; &#125; å¤§éƒ¨åˆ†æ–¹æ³•éƒ½æ¯”è¾ƒç®€å•ï¼Œå€¼å¾—æ³¨æ„çš„å‡ ç‚¹æ˜¯ï¼š 1ã€valueOfæ–¹æ³•ä¾èµ–åˆ°çš„Class&lt;?&gt;#enumConstantDirectory()ï¼Œè¿™ä¸ªæ–¹æ³•é¦–æ¬¡è°ƒç”¨å®Œæˆä¹‹åï¼Œç»“æœä¼šç¼“å­˜åœ¨Class&lt;?&gt;#enumConstantDirectoryå˜é‡ä¸­ã€‚ 2ã€Enumå®ç°äº†Serializableæ¥å£ï¼Œä½†æ˜¯readObjectå’ŒreadObjectNoDataç›´æ¥æŠ›å‡ºäº†InvalidObjectExceptionå¼‚å¸¸ï¼Œæ³¨é‡Šè¯´åˆ°æ˜¯&quot;é˜²æ­¢é»˜è®¤çš„ååºåˆ—åŒ–&quot;ï¼Œè¿™ä¸€ç‚¹æœ‰ç‚¹ä¸æ˜ä¸ç™½ï¼Œæ—¢ç„¶ç¦ç”¨ååºåˆ—åŒ–ä¸ºä½•è¦å®ç°Serializableæ¥å£ï¼Œè¿™é‡Œå¯èƒ½è€ƒè™‘åˆ°æ˜¯å¦å®ç°Serializableæ¥å£åº”è¯¥äº¤ç»™å¼€å‘è€…å†³å®šã€‚ 3ã€Enumç¦ç”¨å…‹éš†ã€‚ å°ç»“ JDKä¸­æšä¸¾çš„åº•å±‚å®ç°å°±æ˜¯ä½¿ç”¨äº†enumå…³é”®å­—å£°æ˜çš„æšä¸¾ç±»ç¼–è¯‘åæœ€ç»ˆä¼šå˜æˆpublic finalä¿®é¥°åŒæ—¶å®ç°äº†æ³›å‹æ¥å£java.lang.Enumå¹¶ä¸”æŒ‡å®šæ³›å‹å‚æ•°ä¸ºè‡ªèº«çš„æ™®é€šJavaç±»ï¼Œè€Œæˆå‘˜å±æ€§å’Œæ–¹æ³•å®ç°ç›¸å…³éƒ½æ˜¯åœ¨ç¼–è¯‘å®Œæˆåå°±å·²ç»æˆå‹çš„ï¼Œæšä¸¾ç±»å‹çš„æˆå‘˜å˜é‡éƒ½æ˜¯é€šè¿‡é™æ€ä»£ç å—å£°æ˜çš„ã€‚ (æœ¬æ–‡å®Œ c-1-d e-20181006)","categories":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/categories/Java/"},{"name":"Enum","slug":"Java/Enum","permalink":"http://throwable.club/blog/categories/Java/Enum/"}],"tags":[{"name":"Java","slug":"Java","permalink":"http://throwable.club/blog/tags/Java/"},{"name":"Enum","slug":"Enum","permalink":"http://throwable.club/blog/tags/Enum/"}]},{"title":"Hi, theme-melody!","slug":"helloworld","date":"2018-11-03T16:00:00.000Z","updated":"2019-07-22T14:58:31.762Z","comments":true,"path":"2018/11/04/helloworld/","link":"","permalink":"http://throwable.club/2018/11/04/helloworld/","excerpt":"","text":"init 1hexo init [folder] Initializes a website. new 1hexo new [layout] &lt;title&gt; # hexo new post $&#123;article&#125; Creates a new article. generate 1$ hexo generate # hexo g Generates static files. Option Description -d, --deploy Deploy after generation finishes -w, --watch Watch file changes -b, --bail Raise an error if any unhandled exception is thrown during generation -f, --force Force regenerate publish 1$ hexo publish [layout] &lt;filename&gt; Publishes a draft. server 1$ hexo server # hexo s Option Description -p, --port Override default port -s, --static Only serve static files -l, --log Enable logger. Override logger format Starts a local server. By default, this is at http://localhost:4000/. deploy 1$ hexo deploy # hexo d clean 1$ hexo clean end I spent an afternoon updating blog topics and migrating articles.The theme has been updated to melody and I like it very much! test Not bloÄŸuBurasÄ± bir not bloÄŸu Ä°pucu bloÄŸuBurasÄ± bir ipucu bloÄŸu Ä°pucu bloÄŸuBurasÄ± bir ipucu bloÄŸu Dikkat bloÄŸuBurasÄ± bir dikkat bloÄŸu UyarÄ± bloÄŸuBurasÄ± bir uyarÄ± bloÄŸu (To be continueâ€¦)","categories":[{"name":"hexo","slug":"hexo","permalink":"http://throwable.club/blog/categories/hexo/"}],"tags":[{"name":"hexo","slug":"hexo","permalink":"http://throwable.club/blog/tags/hexo/"},{"name":"hexo theme","slug":"hexo-theme","permalink":"http://throwable.club/blog/tags/hexo-theme/"}]}]}