<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Throwable&#39;s Blog</title>
  <icon>https://www.gravatar.com/avatar/f911a15e0873ff511c29d73cd84dfa48</icon>
  <subtitle>å»åˆ›ä¸šäº†ï¼Œå¤ªå¿™äº†ï¼Œå¯èƒ½ä¼šä¸å®šæœŸé¸½ğŸ˜ğŸ˜ğŸ˜ğŸ˜‚ğŸ˜‚ğŸ˜‚</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://throwable.club/"/>
  <updated>2020-02-09T14:45:48.809Z</updated>
  <id>http://throwable.club/</id>
  
  <author>
    <name>Throwable</name>
    <email>739805340@qq.com</email>
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ç†è§£å’Œè¿ç”¨Javaä¸­çš„Lambda</title>
    <link href="http://throwable.club/2020/02/09/java-understand-and-use-lambda/"/>
    <id>http://throwable.club/2020/02/09/java-understand-and-use-lambda/</id>
    <published>2020-02-09T10:13:50.000Z</published>
    <updated>2020-02-09T14:45:48.809Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰æ">å‰æ</h2><p>å›æƒ³ä¸€ä¸‹ï¼Œ<code>JDK8</code>æ˜¯2014å¹´å‘å¸ƒæ­£å¼ç‰ˆçš„ï¼Œåˆ°ç°åœ¨ä¸ºï¼ˆ<code>2020-02-08</code>ï¼‰æ­¢å·²ç»è¿‡å»äº†5å¹´å¤šã€‚<code>JDK8</code>å¼•å…¥çš„ä¸¤ä¸ªæ¯”è¾ƒå¼ºå¤§çš„æ–°ç‰¹æ€§æ˜¯<code>Lambda</code>è¡¨è¾¾å¼ï¼ˆä¸‹æ–‡çš„<code>Lambda</code>ç‰¹æŒ‡<code>JDK</code>æä¾›çš„<code>Lambda</code>ï¼‰å’Œ<code>Stream</code>ï¼Œè¿™ä¸¤ä¸ªå¼ºå¤§çš„ç‰¹æ€§è®©å‡½æ•°å¼ç¼–ç¨‹åœ¨<code>Java</code>å¼€å‘ä¸­å‘æ‰¬å…‰å¤§ã€‚è¿™ç¯‡æ–‡ç« ä¼šä»åŸºæœ¬æ¦‚å¿µã€ä½¿ç”¨æ–¹å¼ã€å®ç°åŸç†å’Œå®æˆ˜åœºæ™¯ç­‰è§’åº¦ä»‹ç»<code>Lambda</code>çš„å…¨è²Œï¼Œå…¶ä¸­è¿˜ä¼šæ¶‰åŠä¸€äº›å‡½æ•°å¼ç¼–ç¨‹æ¦‚å¿µã€<code>JVM</code>ä¸€äº›çŸ¥è¯†ç­‰ç­‰ã€‚</p><a id="more"></a><h2 id="åŸºæœ¬æ¦‚å¿µ">åŸºæœ¬æ¦‚å¿µ</h2><p>ä¸‹é¢ä»‹ç»ä¸€äº›åŸºæœ¬æ¦‚å¿µï¼Œä¸€æ­¥ä¸€æ­¥å¼•å‡º<code>Lambda</code>çš„æ¦‚å¿µã€‚</p><h3 id="å‡½æ•°å¼æ¥å£">å‡½æ•°å¼æ¥å£</h3><p>å‡½æ•°å¼æ¥å£å’Œæ¥å£é»˜è®¤æ–¹æ³•éƒ½æ˜¯<code>JDK8</code>å¼•å…¥çš„æ–°ç‰¹æ€§ã€‚å‡½æ•°å¼æ¥å£çš„æ¦‚å¿µå¯ä»¥ä»<code>java.lang.FunctionalInterface</code>æ³¨è§£çš„<code>API</code>æ³¨é‡Šä¸­å¾—çŸ¥ï¼š</p><blockquote><p>An informative annotation type used to indicate that an interface type declaration is intended to be a functional interface as defined by the Java Language Specification.</p></blockquote><blockquote><p>Conceptually, a functional interface has exactly one abstract method.  Since {@linkplain java.lang.reflect.Method#isDefault() default methods} have an implementation, they are not abstract.</p></blockquote><p>ç®€å•æ¥è¯´å°±æ˜¯ï¼š<code>@FunctionalInterface</code>æ˜¯ä¸€ä¸ªæä¾›ä¿¡æ¯çš„æ¥å£ï¼ˆå…¶å®å°±æ˜¯<strong>æ ‡è¯†æ¥å£</strong>ï¼‰ï¼Œç”¨äºè¡¨æ˜å¯¹åº”çš„æ¥å£ç±»å‹å£°æ˜æ˜¯ä¸€ä¸ª<code>Java</code>è¯­è¨€è§„èŒƒå®šä¹‰çš„å‡½æ•°å¼æ¥å£ã€‚ä»æ¦‚å¿µä¸Šè¯´ï¼Œä¸€ä¸ªå‡½æ•°å¼æ¥å£æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œå› ä¸ºæ¥å£é»˜è®¤æ–¹æ³•å¿…é¡»äºˆä»¥å®ç°ï¼Œå®ƒä»¬ä¸æ˜¯æŠ½è±¡æ–¹æ³•ã€‚</p><p>æ‰€ä»¥å¯ä»¥è¿™æ ·ç»™å‡½æ•°å¼æ¥å£å®šä¹‰ï¼šå¦‚æœä¸€ä¸ªæ¥å£å£°æ˜çš„æ—¶å€™<strong>æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªæŠ½è±¡æ–¹æ³•</strong>ï¼Œé‚£ä¹ˆå®ƒå°±æ˜¯å‡½æ•°å¼æ¥å£ï¼Œå¯ä»¥ä½¿ç”¨<code>@FunctionalInterface</code>æ³¨è§£æ ‡è¯†ã€‚</p><p><code>JDK</code>ä¸­å·²ç»å®šä¹‰äº†å¾ˆå¤šå†…ç½®çš„å‡½æ•°å¼æ¥å£ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// java.lang.Runnable</span></span><br><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>;</span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="comment">// java.util.function.Supplier</span></span><br><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Supplier</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">T <span class="title">get</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä»¥è‡ªå®šä¹‰å‡½æ•°å¼æ¥å£ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CustomFunctionalInterface</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¯ä»¥ç¼©å†™ä¸ºvoid process();  æ¥å£æ–¹æ³•å®šä¹‰çš„æ—¶å€™ï¼Œé»˜è®¤ä½¿ç”¨public abstractä¿®é¥°</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ¥å£é»˜è®¤æ–¹æ³•">æ¥å£é»˜è®¤æ–¹æ³•</h3><p>æ¥å£é»˜è®¤æ–¹æ³•çš„å«ä¹‰å¯ä»¥è§<code>Java</code>å®˜æ–¹æ•™ç¨‹ä¸­å¯¹åº”çš„ç« èŠ‚ï¼Œåœ¨æ–‡æœ«çš„å‚è€ƒèµ„æ–™å¯ä»¥æŸ¥çœ‹å…·ä½“çš„é“¾æ¥ï¼š</p><blockquote><p>Default methods enable you to add new functionality to the interfaces of your libraries and ensure binary compatibility with code written for older versions of those interfaces.</p></blockquote><p>ç®€å•æ¥è¯´å°±æ˜¯ï¼šé»˜è®¤æ–¹æ³•å…è®¸ä½ åœ¨ä½ çš„ç±»åº“ä¸­å‘æ¥å£æ·»åŠ æ–°çš„åŠŸèƒ½ï¼Œå¹¶ç¡®ä¿æ–°å¢çš„é»˜è®¤æ–¹æ³•ä¸è¿™äº›æ¥å£çš„è¾ƒæ—©ç‰ˆæœ¬ç¼–å†™çš„ä»£ç <strong>äºŒè¿›åˆ¶å…¼å®¹</strong>ã€‚</p><p>æ¥å£é»˜è®¤æ–¹æ³•ï¼ˆä¸‹ç§°é»˜è®¤æ–¹æ³•ï¼‰é€šè¿‡<code>default</code>å…³é”®å­—å£°æ˜ï¼Œå¯ä»¥ç›´æ¥åœ¨æ¥å£ä¸­ç¼–å†™æ–¹æ³•ä½“ã€‚<strong>ä¹Ÿå°±æ˜¯é»˜è®¤æ–¹æ³•æ—¢å£°æ˜äº†æ–¹æ³•ï¼Œä¹Ÿå®ç°äº†æ–¹æ³•</strong>ã€‚è¿™ä¸€ç‚¹å¾ˆé‡è¦ï¼Œåœ¨é»˜è®¤æ–¹æ³•ç‰¹æ€§å‡ºç°ä¹‹å‰ï¼Œ<code>Java</code>ç¼–ç¨‹è¯­è¨€è§„èŒƒä¸­ï¼Œæ¥å£çš„æœ¬è´¨å°±æ˜¯æ–¹æ³•å£°æ˜çš„é›†åˆä½“ï¼Œè€Œè‡ªé»˜è®¤æ–¹æ³•ç‰¹æ€§å‡ºç°ä¹‹åï¼Œæ¥å£çš„æœ¬è´¨ä¹Ÿæ”¹å˜äº†ã€‚é»˜è®¤æ–¹æ³•çš„ä¸€ä¸ªä¾‹å­å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">DefaultMethod</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">defaultVoidMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">default</span> String <span class="title">sayHello</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">"%s say hello!"</span>, name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="class"><span class="keyword">class</span> <span class="title">Impl</span> <span class="keyword">implements</span> <span class="title">DefaultMethod</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        DefaultMethod defaultMethod = <span class="keyword">new</span> Impl();</span><br><span class="line">        System.out.println(defaultMethod.sayHello(<span class="string">"throwable"</span>));  <span class="comment">// throwable say hello!</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœç»§æ‰¿ä¸€ä¸ªå®šä¹‰äº†é»˜è®¤æ–¹æ³•çš„æ¥å£ï¼Œé‚£ä¹ˆå¯ä»¥æœ‰å¦‚ä¸‹çš„åšæ³•ï¼š</p><ul><li>å®Œå…¨å¿½ç•¥çˆ¶æ¥å£çš„é»˜è®¤æ–¹æ³•ï¼Œé‚£ä¹ˆç›¸å½“äºç›´æ¥ç»§æ‰¿çˆ¶æ¥å£çš„é»˜è®¤æ–¹æ³•çš„å®ç°ï¼ˆ<strong>æ–¹æ³•ç»§æ‰¿</strong>ï¼‰ã€‚</li><li>é‡æ–°å£°æ˜é»˜è®¤æ–¹æ³•ï¼Œè¿™é‡Œç‰¹æŒ‡å»æ‰<code>default</code>å…³é”®å­—ï¼Œç”¨<code>public abstract</code>å…³é”®å­—é‡æ–°å£°æ˜å¯¹åº”çš„æ–¹æ³•ï¼Œç›¸å½“äºè®©é»˜è®¤æ–¹æ³•è½¬å˜ä¸ºæŠ½è±¡æ–¹æ³•ï¼Œå­ç±»éœ€è¦è¿›è¡Œå®ç°ï¼ˆ<strong>æ–¹æ³•æŠ½è±¡</strong>ï¼‰ã€‚</li><li>é‡æ–°å®šä¹‰é»˜è®¤æ–¹æ³•ï¼Œä¹Ÿå°±æ˜¯ç›´æ¥è¦†ç›–çˆ¶æ¥å£ä¸­çš„å®ç°ï¼ˆ<strong>æ–¹æ³•è¦†ç›–</strong>ï¼‰ã€‚</li></ul><p>ç»“åˆå‰é¢ä¸€èŠ‚æåˆ°çš„å‡½æ•°å¼æ¥å£ï¼Œè¿™é‡Œå¯ä»¥ç»¼åˆå¾—å‡ºä¸€ä¸ªç»“è®ºï¼š<strong>å‡½æ•°å¼æ¥å£ï¼Œä¹Ÿå°±æ˜¯æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªæŠ½è±¡æ–¹æ³•çš„æ¥å£ï¼Œå¯ä»¥å®šä¹‰0ä¸ªæˆ–è€…Nï¼ˆN &gt;= 1ï¼‰ä¸ªé»˜è®¤æ–¹æ³•</strong>ã€‚è¿™ä¸€ç‚¹æ­£æ˜¯<code>Stream</code>ç‰¹æ€§å¼•å…¥çš„ç†è®ºåŸºç¡€ã€‚ä¸¾ä¸ªä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">CustomFunctionalInterface</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">void</span> <span class="title">defaultVoidMethod</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">default</span> String <span class="title">sayHello</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">"%s say hello!"</span>, name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè¯´ç‚¹é¢˜å¤–è¯ã€‚</p><p>åœ¨å†™è¿™ç¯‡æ–‡ç« çš„æ—¶å€™ï¼Œç¬”è€…æƒ³èµ·äº†ä¸€ä¸ªå‰åŒäº‹è¯´è¿‡çš„è¯ï¼Œå¤§æ„å¦‚ä¸‹ï¼š<strong>åœ¨è½¯ä»¶å·¥ç¨‹ä¸­ï¼Œå¦‚æœä»é›¶åšèµ·ï¼Œä»»ä½•æ–°åŠŸèƒ½çš„å¼€å‘éƒ½æ˜¯ååˆ†ç®€å•çš„ï¼Œå›°éš¾çš„æ˜¯åœ¨å…¼å®¹æ‰€æœ‰å†å²åŠŸèƒ½çš„å‰æä¸‹è¿›è¡Œæ–°åŠŸèƒ½çš„è¿­ä»£</strong>ã€‚è¯•æƒ³ä¸€ä¸‹ï¼Œ<code>Java</code>è¿­ä»£åˆ°ä»Šå¤©å·²ç»è¿‡å»åå¤šå¹´äº†ï¼Œ<code>Hotspot VM</code>æºç å·¥ç¨‹å·²ç»ååˆ†åºå¤§ï¼ˆæ‰‹åŠ¨ç¼–è¯‘è¿‡<code>OpenJDK Hotspot VM</code>æºç çš„äººéƒ½çŸ¥é“è¿‡ç¨‹çš„ç—›è‹¦ï¼‰ï¼Œä»»ä½•æ–°å¢çš„ç‰¹æ€§éƒ½è¦å‘å‰å…¼å®¹ï¼Œå¦åˆ™å¾ˆå¤šç”¨äº†å†å²ç‰ˆæœ¬çš„<code>Java</code>åº”ç”¨ä¼šæ— æ³•å‡çº§æ–°çš„<code>JDK</code>ç‰ˆæœ¬ã€‚æ—¢è¦äºŒè¿›åˆ¶å‘å‰å…¼å®¹ï¼Œåˆè¦è¿­ä»£å‡ºæ–°çš„ç‰¹æ€§ï¼Œ<code>Java</code>éœ€è¦è¿›è¡Œèˆå¤ºï¼Œé»˜è®¤æ–¹æ³•å°±æ˜¯ä¸€ä¸ªä¾‹å­ï¼Œå¿…é¡»èˆå»æ¥å£åªèƒ½å®šä¹‰æŠ½è±¡æ–¹æ³•è¿™ä¸ªå»¶ç»­äº†å¤šå¹´åœ¨<code>Java</code>å¼€å‘è€…ä¸­æ ¹æ·±è’‚å›ºçš„æ¦‚å¿µï¼Œå¤ºå–äº†åŸºäºé»˜è®¤æ–¹æ³•å®ç°æ„ç­‘å‡ºæ¥çš„æµå¼ç¼–ç¨‹ä½“ç³»ã€‚ç¬”è€…æœ‰æ—¶å€™ä¹Ÿåœ¨æ€è€ƒï¼šå¦‚æœè¦æˆ‘å»å¼€å‘<code>Stream</code>è¿™ä¸ªæ–°ç‰¹æ€§ï¼Œæˆ‘ä¼šæ€ä¹ˆåšæˆ–è€…æˆ‘èƒ½æ€ä¹ˆåšï¼Ÿ</p><h3 id="åµŒå¥—ç±»-Nested-Classes">åµŒå¥—ç±»(Nested Classes)</h3><p>åµŒå¥—ç±»ï¼ˆ<code>Nested Classes</code>ï¼‰ï¼Œç®€å•æ¥è¯´å°±æ˜¯ï¼šåœ¨ä¸€ä¸ªç±»ä¸­å®šä¹‰å¦ä¸€ä¸ªç±»ï¼Œé‚£ä¹ˆåœ¨ç±»å†…<strong>è¢«å®šä¹‰</strong>çš„é‚£ä¸ªç±»å°±æ˜¯åµŒå¥—ç±»ï¼Œæœ€å¤–å±‚çš„ç±»ä¸€èˆ¬ç§°ä¸ºå°é—­ç±»ï¼ˆ<code>Enclosing Class</code>ï¼‰ã€‚åµŒå¥—ç±»ä¸»è¦åˆ†ä¸ºä¸¤ç§ï¼šé™æ€åµŒå¥—ç±»å’Œéé™æ€åµŒå¥—ç±»ï¼Œè€Œ<strong>éé™æ€åµŒå¥—ç±»åˆç§°ä¸ºå†…éƒ¨ç±»ï¼ˆ<code>Inner Classes</code>ï¼‰</strong>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å°é—­ç±»</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OuterClass</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// é™æ€åµŒå¥—ç±»</span></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">StaticNestedClass</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å†…éƒ¨ç±»</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">InnerClass</span> </span>&#123;</span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é™æ€åµŒå¥—ç±»å¯ä»¥ç›´æ¥ä½¿ç”¨å°é—­çš„ç±»åç§°å»è®¿é—®ä¾‹å¦‚ï¼š<code>OuterClass.StaticNestedClass x = new OuterClass.StaticNestedClass();</code>ï¼Œè¿™ç§ä½¿ç”¨å½¢å¼å’Œä¸€èˆ¬ç±»å®ä¾‹åŒ–åŸºæœ¬æ²¡æœ‰åŒºåˆ«ã€‚</p><p>å†…éƒ¨ç±»å®ä¾‹çš„å­˜åœ¨å¿…é¡»ä¾èµ–äºå°é—­ç±»å®ä¾‹çš„å­˜åœ¨ï¼Œå¹¶ä¸”å†…éƒ¨ç±»å¯ä»¥ç›´æ¥è®¿é—®å°é—­ç±»çš„ä»»æ„å±æ€§å’Œæ–¹æ³•ï¼Œç®€å•æ¥è¯´å°±æ˜¯å†…éƒ¨ç±»çš„å®ä¾‹åŒ–å¿…é¡»åœ¨å°é—­ç±»å®ä¾‹åŒ–ä¹‹åï¼Œå¹¶ä¸”ä¾èµ–äºå°é—­ç±»çš„å®ä¾‹ï¼Œå£°æ˜çš„è¯­æ³•æœ‰ç‚¹å¥‡ç‰¹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OuterClass</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> x = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">StaticNestedClass</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">InnerClass</span> </span>&#123;</span><br><span class="line">        <span class="comment">// å†…éƒ¨ç±»å¯ä»¥è®¿é—®å°é—­ç±»çš„å±æ€§</span></span><br><span class="line">        <span class="keyword">int</span> y = x;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        OuterClass outerClass = <span class="keyword">new</span> OuterClass();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¿…é¡»è¿™æ ·å®ä¾‹åŒ–å†…éƒ¨ç±» - å£°æ˜çš„è¯­æ³•ç›¸å¯¹å¥‡ç‰¹</span></span><br><span class="line">        OuterClass.InnerClass innerClass = outerClass.<span class="keyword">new</span> InnerClass();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// é™æ€åµŒå¥—ç±»å¯ä»¥ä¸€èˆ¬å®ä¾‹åŒ–,å½¢å¼ä¸º:å°é—­ç±».é™æ€åµŒå¥—ç±»</span></span><br><span class="line">        OuterClass.StaticNestedClass staticNestedClass = <span class="keyword">new</span> OuterClass.StaticNestedClass();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¦‚æœmainæ–¹æ³•åœ¨å°é—­ç±»å†…,å¯ä»¥ç›´æ¥ä½¿ç”¨é™æ€åµŒå¥—ç±»è¿›è¡Œå®ä¾‹åŒ–</span></span><br><span class="line">        StaticNestedClass x = <span class="keyword">new</span> StaticNestedClass();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†…éƒ¨ç±»ä¸­æœ‰ä¸¤ç§ç‰¹æ®Šçš„ç±»å‹ï¼šæœ¬åœ°ç±»(<code>Local Classes</code>)å’ŒåŒ¿åç±»(<code>Anonymous Classes</code>)ã€‚</p><p>æœ¬åœ°ç±»æ˜¯ä¸€ç§å£°æ˜åœ¨ä»»æ„å—ï¼ˆ<code>block</code>ï¼‰çš„ç±»ï¼Œä¾‹å¦‚å£°æ˜åœ¨ä»£ç å—ã€é™æ€ä»£ç å—ã€å®ä¾‹æ–¹æ³•æˆ–è€…é™æ€æ–¹æ³•ä¸­ï¼Œå®ƒå¯ä»¥è®¿é—®å°é—­ç±»çš„æ‰€æœ‰æˆå‘˜å±æ€§å’Œæ–¹æ³•ï¼Œå®ƒçš„ä½œç”¨åŸŸå°±æ˜¯å—å†…ï¼Œä¸èƒ½åœ¨å—å¤–ä½¿ç”¨ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OuterClass</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">int</span> y = <span class="number">1</span>;</span><br><span class="line">    </span><br><span class="line">    &#123;    </span><br><span class="line">        <span class="comment">// æœ¬åœ°ç±»A</span></span><br><span class="line">        <span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">            <span class="keyword">int</span> z = y;</span><br><span class="line">        &#125;</span><br><span class="line">        A a = <span class="keyword">new</span> A();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="comment">// æœ¬åœ°ç±»B</span></span><br><span class="line">        <span class="class"><span class="keyword">class</span> <span class="title">B</span></span>&#123;</span><br><span class="line">            <span class="keyword">int</span> z = y;</span><br><span class="line">        &#125;</span><br><span class="line">        B b = <span class="keyword">new</span> B();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">method</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">// æœ¬åœ°ç±»C</span></span><br><span class="line">        <span class="class"><span class="keyword">class</span> <span class="title">C</span></span>&#123;</span><br><span class="line">            <span class="keyword">int</span> z = y;</span><br><span class="line">        &#125;</span><br><span class="line">        C c = <span class="keyword">new</span> C();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒ¿åç±»å¯ä»¥è®©ä»£ç æ›´åŠ ç®€æ˜ï¼Œå…è®¸ä½¿ç”¨è€…åœ¨<strong>å®šä¹‰ç±»çš„åŒæ—¶äºˆä»¥å®ç°</strong>ï¼ŒåŒ¿åç±»å’Œå…¶ä»–å†…éƒ¨ç±»ä¸åŒçš„åœ°æ–¹æ˜¯ï¼šå®ƒæ˜¯ä¸€ç§<strong>è¡¨è¾¾å¼</strong>ï¼Œè€Œä¸æ˜¯ç±»å£°æ˜ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OuterClass</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">In</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">method</span><span class="params">(String value)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="comment">// æœ¬åœ°ç±» - ç±»å£°æ˜</span></span><br><span class="line">        <span class="class"><span class="keyword">class</span> <span class="title">LocalClass</span></span>&#123;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// åŒ¿åç±» - æ˜¯ä¸€ä¸ªè¡¨è¾¾å¼</span></span><br><span class="line">        In in = <span class="keyword">new</span> In() &#123;</span><br><span class="line">            </span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method</span><span class="params">(String value)</span> </span>&#123;</span><br><span class="line">                </span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœç”¨<code>Java</code>åšè¿‡<code>GUI</code>å¼€å‘ï¼ŒåŒ¿åç±»åœ¨<code>Swing</code>æˆ–è€…<code>JavaFx</code>çš„äº‹ä»¶å›è°ƒä¸­å¤§é‡ä½¿ç”¨ï¼Œç»å¸¸ä¼šçœ‹åˆ°ç±»ä¼¼è¿™æ ·çš„ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">JButton button = <span class="keyword">new</span> JButton();</span><br><span class="line">button.addActionListener(<span class="keyword">new</span> AbstractAction() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">actionPerformed</span><span class="params">(ActionEvent e)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"æŒ‰é’®äº‹ä»¶è¢«è§¦å‘..."</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>åµŒå¥—ç±»çš„ç±»å‹å…³ç³»å›¾å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Nested Classes</span><br><span class="line">  - Static Nested Classes</span><br><span class="line">  - None Nested Classes</span><br><span class="line">    - Local Classes</span><br><span class="line">    - Anonymous Classes</span><br><span class="line">    - Other Inner Classes</span><br></pre></td></tr></table></figure><h2 id="Lambdaè¡¨è¾¾å¼">Lambdaè¡¨è¾¾å¼</h2><p>ä¸‹é¢æ˜¯æ¥è‡ªæŸæœç´¢å¼•æ“ç™¾ç§‘å…³äº<code>Lambda</code>è¡¨è¾¾å¼çš„å®šä¹‰ï¼š</p><p><code>Lambda</code>è¡¨è¾¾å¼ï¼ˆ<code>Lambda Expression</code>ï¼‰æ˜¯ä¸€ä¸ªåŒ¿åå‡½æ•°ï¼Œ<code>Lambda</code>è¡¨è¾¾å¼åŸºäºæ•°å­¦ä¸­çš„<code>Î»</code>æ¼”ç®—å¾—åï¼Œç›´æ¥å¯¹åº”äºå…¶ä¸­çš„<code>Lambda</code>æŠ½è±¡ï¼ˆ<code>Lambda Abstraction</code>ï¼‰ï¼Œæ˜¯ä¸€ä¸ªåŒ¿åå‡½æ•°ï¼Œå³æ²¡æœ‰å‡½æ•°åçš„å‡½æ•°ã€‚<code>Lambda</code>è¡¨è¾¾å¼å¯ä»¥è¡¨ç¤ºé—­åŒ…ï¼ˆæ³¨æ„å’Œæ•°å­¦ä¼ ç»Ÿæ„ä¹‰ä¸Šçš„ä¸åŒï¼‰ã€‚</p><p><code>Java</code>ä¸­çš„<code>Lambda</code>è¡¨è¾¾å¼ï¼ˆä¸‹é¢ç§°<code>Lambda</code>ï¼‰è¡¨é¢ä¸Šå’Œä¸Šé¢çš„å®šä¹‰ç±»ä¼¼ï¼Œæœ¬è´¨ä¹Ÿæ˜¯åŒ¿åå‡½æ•°ï¼Œä½†å…¶å®ç°åŸç†åŒºåˆ«äºä¸€èˆ¬çš„åŒ¿åç±»ä¸­çš„åŒ¿åå‡½æ•°å®ç°ï¼Œå¥¹æ˜¯<code>JDK8</code>å¼•å…¥çš„ä¸€é¢—æ–°çš„è¯­æ³•ç³–ã€‚</p><h3 id="å¼•å…¥Lambdaè¡¨è¾¾å¼çš„åˆè¡·">å¼•å…¥Lambdaè¡¨è¾¾å¼çš„åˆè¡·</h3><p>å¦‚æœä¸€ä¸ªæ¥å£åªåŒ…å«ä¸€ä¸ªæ–¹æ³•ï¼Œé‚£ä¹ˆåŒ¿åç±»çš„è¯­æ³•ä¼šå˜å¾—ååˆ†ç¬¨æ‹™å’Œä¸æ¸…æ¥šï¼Œäº§ç”Ÿå¤§é‡çš„æ¨¡æ¿ä»£ç ï¼Œå½’ç»“ä¸€ä¸‹å°±æ˜¯ï¼šä»£ç å†—ä½™æ˜¯åŒ¿åç±»çš„æœ€å¤§å¼Šç«¯ã€‚åœ¨ç¼–ç¨‹çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¾ˆå¤šæ—¶å€™å¸Œæœ›æŠŠåŠŸèƒ½ä½œä¸ºå‚æ•°ä¼ é€’åˆ°å¦ä¸€ä¸ªæ–¹æ³•ï¼Œ<code>Lambda</code>å°±æ˜¯ä¸ºæ­¤è€Œç”Ÿï¼Œ<code>Lambda</code>å…è®¸ä½¿ç”¨è€…å°†åŠŸèƒ½è§†ä¸ºæ–¹æ³•å‚æ•°ï¼Œå°†ä»£ç è§†ä¸ºæ•°æ®ã€‚å¼•å…¥<code>Lambda</code>å¸¦æ¥äº†å¦‚ä¸‹ä¼˜åŠ¿ï¼š</p><ul><li>ç®€åŒ–ä»£ç ï¼Œå¼•å…¥äº†å¼ºå¤§çš„ç±»å‹æ¨æ–­å’Œæ–¹æ³•å¼•ç”¨ç‰¹æ€§ï¼Œç®€å•çš„åŠŸèƒ½ç”šè‡³å¯ä»¥ä¸€è¡Œä»£ç è§£å†³ï¼Œè§£æ”¾åŒ¿åç±»çš„æŸç¼šã€‚</li><li>æŠŠåŠŸèƒ½ä½œä¸ºå‚æ•°å‘ä¸‹ä¼ é€’ï¼Œä¸ºå‡½æ•°å¼ç¼–ç¨‹æä¾›äº†æ”¯æŒã€‚</li></ul><p>è‡³æ­¤è¿˜å¾—å‡ºä¸€ä¸ªç»“è®ºï¼š<strong><code>Lambda</code>åªé€‚ç”¨äºå‡½æ•°å¼æ¥å£å¯¹åº”å”¯ä¸€æŠ½è±¡æ–¹æ³•çš„å®ç°</strong>ã€‚</p><h3 id="Lambdaè¡¨è¾¾å¼çš„è¯­æ³•å®šä¹‰">Lambdaè¡¨è¾¾å¼çš„è¯­æ³•å®šä¹‰</h3><p><code>Lambda</code>è¯­æ³•çš„è¯¦ç»†å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// en_US</span></span><br><span class="line">InterfaceType interfaceObject = [Method Argument List] -&gt; Method Body</span><br><span class="line"></span><br><span class="line"><span class="comment">// zh_CN</span></span><br><span class="line">æ¥å£ç±»å‹ æ¥å£å®ä¾‹ = [æ–¹æ³•å‚æ•°åˆ—è¡¨] -&gt; æ–¹æ³•ä½“</span><br></pre></td></tr></table></figure><p>æ›´å…·ä½“çš„æè¿°åº”è¯¥æ˜¯ï¼š</p><p><code>æ¥å£ç±»å‹ æ¥å£å®ä¾‹ä¸´æ—¶å˜é‡ = (æ–¹æ³•å‚æ•°ç±»å‹X æ–¹æ³•å‚æ•°ç±»å‹Xä¸´æ—¶å˜é‡ , æ–¹æ³•å‚æ•°ç±»å‹Y æ–¹æ³•å‚æ•°ç±»å‹Yä¸´æ—¶å˜é‡...) -&gt; { æ–¹æ³•ä½“... return æ¥å£æŠ½è±¡æ–¹æ³•è¿”å›å€¼å¯¹åº”ç±»å‹ç±»å‹å®ä¾‹;}</code></p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/202002/j-l-u-u-1.png" alt=""></p><p>ä¸€ä¸ª<code>Lambda</code>è¡¨è¾¾å¼ç”±äº”ä¸ªéƒ¨åˆ†ç»„æˆï¼š</p><ul><li>è¿”å›å€¼ï¼šæ¥å£ç±»å‹ä»¥åŠæ¥å£ç±»å‹å¯¹åº”çš„ä¸´æ—¶å®ä¾‹å˜é‡ã€‚</li><li>ç­‰å·ï¼š<code>=</code>ã€‚</li><li>æ–¹æ³•å‚æ•°åˆ—è¡¨ï¼šä¸€èˆ¬ç”±ä¸­æ‹¬å·<code>()</code>åŒ…è£¹ï¼Œæ ¼å¼æ˜¯<code>(ç±»å‹1 ç±»å‹1çš„ä¸´æ—¶å˜é‡,...,ç±»å‹N ç±»å‹Nçš„ä¸´æ—¶å˜é‡)</code>ï¼Œåœ¨æ–¹æ³•æ²¡æœ‰é‡è½½å¯ä»¥æ˜ç¡®æ¨æ–­å‚æ•°ç±»å‹çš„æ—¶å€™ï¼Œå‚æ•°ç±»å‹å¯ä»¥çœç•¥ï¼Œåªç•™ä¸‹ä¸´æ—¶å˜é‡åˆ—è¡¨ã€‚ç‰¹æ®Šåœ°ï¼Œç©ºå‚æ•°åˆ—è¡¨ç”¨<code>()</code>è¡¨ç¤ºï¼Œå¦‚æœå‚æ•°åªæœ‰ä¸€ä¸ªï¼Œå¯ä»¥çœç•¥<code>()</code>ã€‚</li><li>ç®­å¤´ï¼š<code>-&gt;</code>ã€‚</li><li>æ–¹æ³•ä½“ï¼šä¸€èˆ¬ç”±èŠ±æ‹¬å·<code>{}</code>åŒ…è£¹ï¼Œæ ¼å¼æ˜¯<code>{æ–¹æ³•é€»è¾‘... return å‡½æ•°å¼æ¥å£æ–¹æ³•è¿”å›å€¼ç±»å‹çš„å€¼;}</code>ï¼Œæœ‰å‡ ç‚¹éœ€è¦æ³¨æ„ï¼š<ul><li>å¦‚æœæ–¹æ³•ä½“æ˜¯ç©ºå®ç°ï¼Œç”¨<code>{}</code>è¡¨ç¤ºï¼Œå¦‚<code>Runnable runnable = () -&gt; {};</code>ã€‚</li><li>å¦‚æœå‡½æ•°å¼æ¥å£æŠ½è±¡æ–¹æ³•çš„è¿”å›å€¼ä¸º<code>void</code>ç±»å‹ï¼Œåˆ™ä¸éœ€è¦<code>return</code>å…³é”®å­—è¯­å¥ï¼Œå¦‚<code>Runnable runnable = () -&gt; {int i=0; i++;};</code>ã€‚</li><li>å¦‚æœå‡½æ•°å¼æ¥å£æŠ½è±¡æ–¹æ³•çš„æ–¹æ³•ä½“ä»…ä»…åŒ…å«ä¸€ä¸ªè¡¨è¾¾å¼ï¼Œåˆ™ä¸éœ€è¦ä½¿ç”¨<code>{}</code>åŒ…è£¹ï¼Œå¦‚<code>Runnable runnable = () -&gt; System.out.println(&quot;Hello World!&quot;);</code>ã€‚</li></ul></li></ul><p>ä¸¾ä¸€äº›ä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Function - å…·ä½“</span></span><br><span class="line">java.util.function.Function&lt;String, Integer&gt; functionY = (String string) -&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> Integer.parseInt(string);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// Function - ç®€åŒ–</span></span><br><span class="line">java.util.function.Function&lt;String, Integer&gt; functionX = string -&gt; Integer.parseInt(string);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Runnable - å…·ä½“</span></span><br><span class="line">Runnable runnableX = () -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">"Hello World!"</span>);</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">// Runnable - ç®€åŒ–</span></span><br><span class="line">Runnable runnableY = () -&gt; System.out.println(<span class="string">"Hello World!"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ•´æ•°1-100çš„å’Œ - å…·ä½“</span></span><br><span class="line"><span class="keyword">int</span> reduceX = IntStream.range(<span class="number">1</span>, <span class="number">101</span>).reduce(<span class="number">0</span>, (<span class="keyword">int</span> addend, <span class="keyword">int</span> augend) -&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> addend + augend;</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// æ•´æ•°1-100çš„å’Œ - ç®€åŒ–</span></span><br><span class="line"><span class="keyword">int</span> reduceY = IntStream.range(<span class="number">1</span>, <span class="number">101</span>).reduce(<span class="number">0</span>, Integer::sum);</span><br></pre></td></tr></table></figure><h3 id="ç›®æ ‡ç±»å‹ä¸ç±»å‹æ¨æ–­">ç›®æ ‡ç±»å‹ä¸ç±»å‹æ¨æ–­</h3><p>å…ˆå¼•å…¥ä¸‹é¢çš„ä¸€ä¸ªåœºæ™¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// club.throwable.Runnable</span></span><br><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        java.lang.Runnable langRunnable = () -&gt; &#123;&#125;;</span><br><span class="line">        club.throwable.Runnable customRunnable = () -&gt; &#123;&#125;;</span><br><span class="line">        langRunnable.run();</span><br><span class="line">        customRunnable.run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¬”è€…å®šä¹‰äº†ä¸€ä¸ªå’Œ<code>java.lang.Runnable</code>å®Œå…¨ä¸€è‡´çš„å‡½æ•°å¼æ¥å£<code>club.throwable.Runnable</code>ï¼Œä¸Šé¢<code>main()</code>æ–¹æ³•ä¸­ï¼Œå¯ä»¥çœ‹åˆ°ä¸¤ä¸ªæ¥å£å¯¹åº”çš„<code>Lambda</code>è¡¨è¾¾å¼çš„æ–¹æ³•ä½“å®ç°ä¹Ÿæ˜¯å®Œå…¨ä¸€è‡´ï¼Œä½†æ˜¯å¾ˆæ˜æ˜¾æœ€ç»ˆå¯ä»¥ä½¿ç”¨ä¸åŒç±»å‹çš„æ¥å£å»æ¥æ”¶è¿”å›å€¼ï¼Œä¹Ÿå°±æ˜¯è¿™ä¸¤ä¸ª<code>Lambda</code>çš„ç±»å‹æ˜¯ä¸ç›¸åŒçš„ã€‚è€Œè¿™ä¸¤ä¸ª<code>Lambda</code>è¡¨è¾¾å¼è¿”å›å€¼çš„ç±»å‹æ˜¯æˆ‘ä»¬æœ€ç»ˆæœŸå¾…çš„è¿”å›å€¼ç±»å‹ï¼ˆ<code>expecting a data type of XX</code>ï¼‰ï¼Œé‚£ä¹ˆ<code>Lambda</code>è¡¨è¾¾å¼å°±æ˜¯å¯¹åº”çš„<strong>è¢«æœŸå¾…çš„ç±»å‹</strong>ï¼Œè¿™ä¸ªè¢«æœŸå¾…çš„ç±»å‹å°±æ˜¯<code>Lambda</code>è¡¨è¾¾å¼çš„<strong>ç›®æ ‡ç±»å‹</strong>ã€‚</p><p>ä¸ºäº†ç¡®å®š<code>Lambda</code>è¡¨è¾¾å¼çš„ç›®æ ‡ç±»å‹ï¼Œ<code>Java</code>ç¼–è¯‘å™¨ä¼šåŸºäºå¯¹åº”çš„<code>Lambda</code>è¡¨è¾¾å¼ï¼Œä½¿ç”¨<strong>ä¸Šä¸‹æ–‡</strong>æˆ–è€…åœºæ™¯è¿›è¡Œç»¼åˆæ¨å¯¼ï¼Œåˆ¤æ–­çš„ä¸€ä¸ªå› ç´ å°±æ˜¯ä¸Šä¸‹æ–‡ä¸­å¯¹è¯¥<code>Lambda</code>è¡¨è¾¾å¼æ‰€æœŸå¾…çš„ç±»å‹ã€‚å› æ­¤ï¼Œ<strong>åªèƒ½åœ¨<code>Java</code>ç¼–è¯‘å™¨èƒ½å¤Ÿæ­£ç¡®æ¨æ–­<code>Lambda</code>è¡¨è¾¾å¼ç›®æ ‡ç±»å‹çš„åœºæ™¯ä¸‹æ‰èƒ½ä½¿ç”¨<code>Lambda</code>è¡¨è¾¾å¼</strong>ï¼Œè¿™äº›åœºæ™¯åŒ…æ‹¬ï¼š</p><ul><li>å˜é‡å£°æ˜ã€‚</li><li>èµ‹å€¼ã€‚</li><li>è¿”å›è¯­å¥ã€‚</li><li>æ•°ç»„åˆå§‹åŒ–å™¨ã€‚</li><li><code>Lambda</code>è¡¨è¾¾å¼å‡½æ•°ä½“ã€‚</li><li>æ¡ä»¶è¡¨è¾¾å¼ï¼ˆ<code>condition ? processIfTrue() : processIfFalse()</code>ï¼‰ã€‚</li><li>ç±»å‹è½¬æ¢ï¼ˆCastï¼‰è¡¨è¾¾å¼ã€‚</li></ul><p><code>Lambda</code>è¡¨è¾¾å¼é™¤äº†ç›®æ ‡ç±»å‹ï¼Œè¿˜åŒ…å«å‚æ•°åˆ—è¡¨å’Œæ–¹æ³•ä½“ï¼Œè€Œæ–¹æ³•ä½“éœ€è¦ä¾èµ–äºå‚æ•°åˆ—è¡¨è¿›è¡Œå®ç°ï¼Œæ‰€ä»¥æ–¹æ³•å‚æ•°ä¹Ÿæ˜¯å†³å®šç›®æ ‡ç±»å‹çš„ä¸€ä¸ªå› ç´ ã€‚</p><p>æ–¹æ³•å‚æ•°çš„ç±»å‹æ¨å¯¼çš„è¿‡ç¨‹ä¸»è¦ä¾èµ–äºä¸¤ä¸ªè¯­è¨€ç‰¹æ€§ï¼šé‡è½½è§£æï¼ˆ<code>Overload Resolution</code>ï¼‰å’Œå‚æ•°ç±»å‹æ¨å¯¼ï¼ˆ<code>Type Argument Inference</code>ï¼‰ã€‚</p><blockquote><p>åŸæ–‡ï¼šFor method arguments, the Java compiler determines the target type with two other language features: overload resolution and type argument inference</p></blockquote><p>é‡è½½è§£æä¼šä¸ºä¸€ä¸ªç»™å®šçš„æ–¹æ³•è°ƒç”¨ï¼ˆ<code>Method Invocation</code>ï¼‰å¯»æ‰¾æœ€åˆé€‚çš„æ–¹æ³•å£°æ˜ï¼ˆ<code>Method Declaration</code>ï¼‰ã€‚ç”±äºä¸åŒçš„å£°æ˜å…·æœ‰ä¸åŒçš„ç­¾åï¼Œå½“<code>Lambda</code>è¡¨è¾¾å¼ä½œä¸ºæ–¹æ³•å‚æ•°æ—¶ï¼Œé‡è½½è§£æå°±ä¼šå½±å“åˆ°<code>Lambda</code>è¡¨è¾¾å¼çš„ç›®æ ‡ç±»å‹ã€‚ç¼–è¯‘å™¨ä¼šæ ¹æ®å®ƒå¯¹è¯¥<code>Lambda</code>è¡¨è¾¾å¼çš„æ‰€æä¾›çš„ä¿¡æ¯çš„ç†è§£åšå‡ºå†³å®šã€‚å¦‚æœ<code>Lambda</code>è¡¨è¾¾å¼å…·æœ‰æ˜¾å¼ç±»å‹ï¼ˆå‚æ•°ç±»å‹è¢«æ˜¾å¼æŒ‡å®šï¼‰ï¼Œç¼–è¯‘å™¨å°±å¯ä»¥ç›´æ¥ä½¿ç”¨<code>Lambda</code>è¡¨è¾¾å¼çš„è¿”å›ç±»å‹ï¼›å¦‚æœ<code>Lambda</code>è¡¨è¾¾å¼å…·æœ‰éšå¼ç±»å‹ï¼ˆå‚æ•°ç±»å‹è¢«æ¨å¯¼è€ŒçŸ¥ï¼‰ï¼Œé‡è½½è§£æåˆ™ä¼šå¿½ç•¥<code>Lambda</code>è¡¨è¾¾å¼å‡½æ•°ä½“è€Œåªä¾èµ–<code>Lambda</code>è¡¨è¾¾å¼å‚æ•°çš„æ•°é‡ã€‚</p><p>ä¸¾ä¸ªä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ˜¾å¼ç±»å‹</span></span><br><span class="line">Function&lt;String, String&gt; functionX = (String x) -&gt; x;</span><br><span class="line"></span><br><span class="line"><span class="comment">// éšå¼ç±»å‹</span></span><br><span class="line">Function&lt;String, Integer&gt; functionY = x -&gt; Integer.parseInt(x);</span><br></pre></td></tr></table></figure><p>å¦‚æœä¾èµ–äºæ–¹æ³•å‚æ•°çš„ç±»å‹æ¨å¯¼æœ€ä½³æ–¹æ³•å£°æ˜æ—¶å­˜åœ¨äºŒä¹‰æ€§ï¼ˆ<code>Ambiguous</code>ï¼‰ï¼Œæˆ‘ä»¬å°±éœ€è¦åˆ©ç”¨è½¬å‹ï¼ˆ<code>Cast</code>ï¼‰æˆ–æ˜¾å¼<code>Lambda</code>è¡¨è¾¾å¼æ¥æä¾›æ›´å¤šçš„ç±»å‹ä¿¡æ¯ï¼Œä»è€Œ<code>Lambda</code>è¡¨è¾¾å¼çš„ç›®æ ‡ç±»å‹ã€‚ä¸¾ä¸ªä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç¼–è¯‘ä¸é€šè¿‡</span></span><br><span class="line">Object runnableX = () -&gt; &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç¼–è¯‘é€šè¿‡ - Cast</span></span><br><span class="line">Object runnableY = (Runnable) () -&gt; &#123;&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// é™æ€æ–¹æ³•å…¥å‚ç±»å‹æ˜¯å‡½æ•°å¼æ¥å£</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">function</span><span class="params">(java.util.function.Function function)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function((Function&lt;String, Long&gt;) (x) -&gt; Long.parseLong(x));</span><br></pre></td></tr></table></figure><h3 id="ä½œç”¨åŸŸ">ä½œç”¨åŸŸ</h3><p>å…³äºä½œç”¨åŸŸçš„é—®é¢˜è®°ä½å‡ ç‚¹å³å¯ï¼š</p><ul><li><code>&lt;1&gt;</code>ï¼š<code>Lambda</code>è¡¨è¾¾å¼å†…çš„<code>this</code>å¼•ç”¨å’Œå°é—­ç±»çš„<code>this</code>å¼•ç”¨ç›¸åŒã€‚</li><li><code>&lt;2&gt;</code>ï¼š<code>Lambda</code>è¡¨è¾¾å¼åŸºäºè¯æ³•ä½œç”¨åŸŸï¼Œå®ƒä¸ä¼šä»è¶…ç±»ä¸­ç»§æ‰¿ä»»ä½•å˜é‡ï¼Œæ–¹æ³•ä½“é‡Œé¢çš„å˜é‡å’Œå®ƒå¤–éƒ¨ç¯å¢ƒçš„å˜é‡å…·æœ‰ç›¸åŒçš„è¯­ä¹‰ã€‚</li><li><code>&lt;3&gt;</code>ï¼š<code>Lambda expressions close over values, not variables</code>ï¼Œä¹Ÿå°±æ˜¯<code>Lambda</code>è¡¨è¾¾å¼å¯¹å€¼ç±»å‹å°é—­ï¼Œå¯¹å˜é‡ï¼ˆå¼•ç”¨ï¼‰ç±»å‹å¼€æ”¾ï¼ˆè¿™ä¸€ç‚¹æ­£å¥½è§£é‡Šäº†<code>Lambda</code>è¡¨è¾¾å¼å†…éƒ¨å¼•ç”¨å¤–éƒ¨çš„å±æ€§çš„æ—¶å€™ï¼Œè¯¥å±æ€§å¿…é¡»å®šä¹‰ä¸º<code>final</code>ï¼‰ã€‚</li></ul><p>å¯¹äºç¬¬<code>&lt;1&gt;</code>ç‚¹ä¸¾ä¸ªä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LambdaThis</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> x = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Runnable runnable = () -&gt; &#123;</span><br><span class="line">            <span class="keyword">int</span> y = <span class="keyword">this</span>.x;</span><br><span class="line">            y++;</span><br><span class="line">            System.out.println(y);</span><br><span class="line">        &#125;;</span><br><span class="line">        runnable.run();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        LambdaThis lambdaThis = <span class="keyword">new</span> LambdaThis();</span><br><span class="line">        lambdaThis.method();   <span class="comment">// 2</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äºç¬¬<code>&lt;2&gt;</code>ç‚¹ä¸¾ä¸ªä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LambdaScope</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> x = <span class="number">1</span>;</span><br><span class="line">        Runnable runnable = () -&gt; &#123;</span><br><span class="line">            <span class="comment">// ç¼–è¯‘ä¸é€šè¿‡ - Lambdaæ–¹æ³•ä½“å¤–éƒ¨å·²ç»å®šä¹‰äº†åŒåå˜é‡</span></span><br><span class="line">            <span class="keyword">int</span> x = <span class="number">2</span>;</span><br><span class="line">        &#125;;</span><br><span class="line">        runnable.run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äºç¬¬<code>&lt;3&gt;</code>ç‚¹ä¸¾ä¸ªä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LambdaValue</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        (<span class="keyword">final</span>) <span class="keyword">int</span> x = <span class="number">1</span>;</span><br><span class="line">        Runnable runnable = () -&gt; &#123;</span><br><span class="line">            <span class="comment">// ç¼–è¯‘ä¸é€šè¿‡ - å¤–éƒ¨å€¼ç±»å‹ä½¿ç”¨äº†final</span></span><br><span class="line">            x ++;</span><br><span class="line">        &#125;;</span><br><span class="line">        runnable.run();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LambdaValue</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">method</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        (<span class="keyword">final</span>) IntHolder holder = <span class="keyword">new</span> IntHolder();</span><br><span class="line">        Runnable runnable = () -&gt; &#123;</span><br><span class="line">            <span class="comment">// ç¼–è¯‘é€šè¿‡ - ä½¿ç”¨äº†å¼•ç”¨ç±»å‹</span></span><br><span class="line">            holder.x++;</span><br><span class="line">        &#125;;</span><br><span class="line">        runnable.run();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">IntHolder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> x = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ–¹æ³•å¼•ç”¨">æ–¹æ³•å¼•ç”¨</h3><p>æ–¹æ³•å¼•ç”¨ï¼ˆ<code>Method Reference</code>ï¼‰æ˜¯ä¸€ç§åŠŸèƒ½å’Œ<code>Lambda</code>è¡¨è¾¾å¼ç±»ä¼¼çš„è¡¨è¾¾å¼ï¼Œéœ€è¦ç›®æ ‡ç±»å‹å’Œå®ç°å‡½æ•°å¼æ¥å£ï¼Œä½†æ˜¯è¿™ä¸ªå®ç°å½¢å¼å¹¶ä¸æ˜¯é€šè¿‡æ–¹æ³•ä½“ï¼Œè€Œæ˜¯é€šè¿‡æ–¹æ³•åç§°ï¼ˆæˆ–è€…å…³é”®å­—ï¼‰å…³è”åˆ°ä¸€ä¸ªå·²ç»å­˜åœ¨çš„æ–¹æ³•ï¼Œæœ¬è´¨æ˜¯ç¼–è¯‘å±‚é¢çš„æŠ€æœ¯ï¼Œæ—¨åœ¨è¿›ä¸€æ­¥ç®€åŒ–<code>Lambda</code>è¡¨è¾¾å¼æ–¹æ³•ä½“å’Œä¸€äº›ç‰¹å®šè¡¨è¾¾å¼çš„å®ç°ã€‚æ–¹æ³•å¼•ç”¨çš„ç±»å‹å½’ç»“å¦‚ä¸‹ï¼š</p><table><thead><tr><th style="text-align:center">ç±»å‹</th><th style="text-align:center">ä¾‹å­</th></tr></thead><tbody><tr><td style="text-align:center">é™æ€æ–¹æ³•å¼•ç”¨</td><td style="text-align:center"><code>ClassName::methodName</code></td></tr><tr><td style="text-align:center">æŒ‡å®šå¯¹è±¡å®ä¾‹æ–¹æ³•å¼•ç”¨</td><td style="text-align:center"><code>instanceRef::methodName</code></td></tr><tr><td style="text-align:center">ç‰¹å®šç±»å‹ä»»æ„å¯¹è±¡æ–¹æ³•å¼•ç”¨</td><td style="text-align:center"><code>ContainingType::methodName</code></td></tr><tr><td style="text-align:center">è¶…ç±»æ–¹æ³•å¼•ç”¨</td><td style="text-align:center"><code>supper::methodName</code></td></tr><tr><td style="text-align:center">æ„é€ å™¨æ–¹æ³•å¼•ç”¨</td><td style="text-align:center"><code>ClassName::new</code></td></tr><tr><td style="text-align:center">æ•°ç»„æ„é€ å™¨æ–¹æ³•å¼•ç”¨</td><td style="text-align:center"><code>TypeName[]::new</code></td></tr></tbody></table><p>å¯è§å…¶åŸºæœ¬å½¢å¼æ˜¯ï¼š<code>æ–¹æ³•å®¹å™¨::æ–¹æ³•åç§°æˆ–è€…å…³é”®å­—</code>ã€‚</p><p>ä¸¾ä¸€äº›åŸºæœ¬çš„ä½¿ç”¨ä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é™æ€æ–¹æ³•å¼•ç”¨</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StaticMethodRef</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Function&lt;String, Integer&gt; function = StaticMethodRef::staticMethod;</span><br><span class="line">        Integer result = function.apply(<span class="string">"10086"</span>);</span><br><span class="line">        System.out.println(result);  <span class="comment">// 10086</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Integer <span class="title">staticMethod</span><span class="params">(String value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Integer.parseInt(value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŒ‡å®šå¯¹è±¡å®ä¾‹æ–¹æ³•å¼•ç”¨</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ParticularInstanceRef</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Integer <span class="title">refMethod</span><span class="params">(String value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Integer.parseInt(value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">        ParticularInstanceRef ref = <span class="keyword">new</span> ParticularInstanceRef();</span><br><span class="line">        Function&lt;String, Integer&gt; function = ref::refMethod;</span><br><span class="line">        Integer result = function.apply(<span class="string">"10086"</span>);</span><br><span class="line">        System.out.println(result);  <span class="comment">// 10086</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç‰¹å®šç±»å‹ä»»æ„å¯¹è±¡æ–¹æ³•å¼•ç”¨</span></span><br><span class="line">String[] stringArray = &#123;<span class="string">"C"</span>, <span class="string">"a"</span>, <span class="string">"B"</span>&#125;;</span><br><span class="line">Arrays.sort(stringArray, String::compareToIgnoreCase);</span><br><span class="line">System.out.println(Arrays.toString(stringArray)); <span class="comment">// [a, B, C]</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// è¶…ç±»æ–¹æ³•å¼•ç”¨</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SupperRef</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Sub sub = <span class="keyword">new</span> Sub();</span><br><span class="line">        System.out.println(sub.refMethod(<span class="string">"10086"</span>)); <span class="comment">// 10086</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Supper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> Integer <span class="title">supperRefMethod</span><span class="params">(String value)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> Integer.parseInt(value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Sub</span> <span class="keyword">extends</span> <span class="title">Supper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">private</span> Integer <span class="title">refMethod</span><span class="params">(String value)</span> </span>&#123;</span><br><span class="line">            Function&lt;String, Integer&gt; function = <span class="keyword">super</span>::supperRefMethod;</span><br><span class="line">            <span class="keyword">return</span> function.apply(value);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ„é€ å™¨æ–¹æ³•å¼•ç”¨</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConstructorRef</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Function&lt;String, Person&gt; function = Person::<span class="keyword">new</span>;</span><br><span class="line">        Person person = function.apply(<span class="string">"doge"</span>);</span><br><span class="line">        System.out.println(person.getName()); <span class="comment">// doge</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.name = name;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> name;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ•°ç»„æ„é€ å™¨æ–¹æ³•å¼•ç”¨</span></span><br><span class="line">Function&lt;Integer, Integer[]&gt; function = Integer[]::<span class="keyword">new</span>;</span><br><span class="line">Integer[] array = function.apply(<span class="number">10</span>);</span><br><span class="line">System.out.println(array.length); <span class="comment">// 10</span></span><br></pre></td></tr></table></figure><h2 id="Javaä¸­Lambdaçš„åº•å±‚å®ç°åŸç†">Javaä¸­Lambdaçš„åº•å±‚å®ç°åŸç†</h2><p>é‡ç‚¹è¦è¯´ä¸‰æ¬¡ï¼š</p><ul><li><code>Lambda</code>è¡¨è¾¾å¼åº•å±‚<strong>ä¸æ˜¯</strong>åŒ¿åç±»å®ç°ã€‚</li><li><code>Lambda</code>è¡¨è¾¾å¼åº•å±‚<strong>ä¸æ˜¯</strong>åŒ¿åç±»å®ç°ã€‚</li><li><code>Lambda</code>è¡¨è¾¾å¼åº•å±‚<strong>ä¸æ˜¯</strong>åŒ¿åç±»å®ç°ã€‚</li></ul><p>åœ¨æ·±å…¥å­¦ä¹ <code>Lambda</code>è¡¨è¾¾å¼ä¹‹å‰ï¼Œç¬”è€…ä¹Ÿæ›¾ç»è®¤ä¸º<code>Lambda</code>å°±æ˜¯åŒ¿åç±»çš„è¯­æ³•ç³–ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Lambda</span></span><br><span class="line">Function&lt;String, String&gt; functionX = (String x) -&gt; x;</span><br><span class="line"></span><br><span class="line"><span class="comment">// é”™è¯¯è®¤çŸ¥</span></span><br><span class="line">Function&lt;String, String&gt; functionX = <span class="keyword">new</span> Function&lt;String, String&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> Void <span class="title">apply</span><span class="params">(String x)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> x;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong><code>Lambda</code>å°±æ˜¯åŒ¿åç±»çš„è¯­æ³•ç³–è¿™ä¸ªè®¤çŸ¥æ˜¯é”™è¯¯çš„</strong>ã€‚ä¸‹é¢ä¸¾ä¸€ä¸ªä¾‹å­ï¼Œä»æºç å’Œå­—èŠ‚ç çš„è§’åº¦åˆ†æä¸€ä¸‹<code>Lambda</code>è¡¨è¾¾å¼ç¼–è¯‘å’Œæ‰§è¡Œçš„æ•´ä¸ªæµç¨‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Sample</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Runnable runnable = () -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">"Hello World!"</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">        runnable.run();</span><br><span class="line">        String hello = <span class="string">"Hello "</span>;</span><br><span class="line">        Function&lt;String, String&gt; function = string -&gt; hello + string;</span><br><span class="line">        function.apply(<span class="string">"Doge"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ·»åŠ <code>VM</code>å‚æ•°<code>-Djdk.internal.lambda.dumpProxyClasses=.</code>è¿è¡Œä¸Šé¢çš„<code>Sample#main()</code>æ–¹æ³•ï¼Œé¡¹ç›®æ ¹ç›®å½•åŠ¨æ€ç”Ÿæˆäº†ä¸¤ä¸ªç±»å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.lang.invoke.LambdaForm.Hidden;</span><br><span class="line"></span><br><span class="line"><span class="comment">// $FF: synthetic class</span></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Sample</span>$$<span class="title">Lambda</span>$14 <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Sample$$Lambda$<span class="number">14</span>() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Hidden</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Sample.lambda$main$<span class="number">0</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.invoke.LambdaForm.Hidden;</span><br><span class="line"><span class="keyword">import</span> java.util.function.Function;</span><br><span class="line"></span><br><span class="line"><span class="comment">// $FF: synthetic class</span></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Sample</span>$$<span class="title">Lambda</span>$15 <span class="keyword">implements</span> <span class="title">Function</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String arg$<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Sample$$Lambda$<span class="number">15</span>(String var1) &#123;</span><br><span class="line">        <span class="keyword">this</span>.arg$<span class="number">1</span> = var1;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Function get$Lambda(String var0) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Sample$$Lambda$<span class="number">15</span>(var0);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Hidden</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">apply</span><span class="params">(Object var1)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Sample.lambda$main$<span class="number">1</span>(<span class="keyword">this</span>.arg$<span class="number">1</span>, (String)var1);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åæŸ¥ä¸¤ä¸ªç±»çš„å­—èŠ‚ç ï¼Œå‘ç°äº†ç±»ä¿®é¥°ç¬¦ä¸º<code>final synthetic</code>ã€‚æ¥ç€ç›´æ¥çœ‹å°é—­ç±»<code>Sample</code>çš„å­—èŠ‚ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">club</span>/<span class="title">throwable</span>/<span class="title">Sample</span> </span>&#123;</span><br><span class="line">     &lt;ClassVersion=<span class="number">52</span>&gt;</span><br><span class="line">     &lt;SourceFile=Sample.java&gt;</span><br><span class="line"></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="title">Sample</span><span class="params">()</span> </span>&#123; <span class="comment">// &lt;init&gt; //()V</span></span><br><span class="line">         &lt;localVar:index=<span class="number">0</span> , name=<span class="keyword">this</span> , desc=Lclub/throwable/Sample;, sig=<span class="keyword">null</span>, start=L1, end=L2&gt;</span><br><span class="line"></span><br><span class="line">         L1 &#123;</span><br><span class="line">             aload0 <span class="comment">// reference to self</span></span><br><span class="line">             invokespecial java/lang/Object.&lt;init&gt;()V</span><br><span class="line">             <span class="keyword">return</span></span><br><span class="line">         &#125;</span><br><span class="line">         L2 &#123;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="title">main</span><span class="params">(java.lang.String[] arg0)</span> <span class="keyword">throws</span> java/lang/Exception </span>&#123; <span class="comment">//([Ljava/lang/String;)V</span></span><br><span class="line">         &lt;localVar:index=<span class="number">0</span> , name=args , desc=[Ljava/lang/String;, sig=<span class="keyword">null</span>, start=L1, end=L2&gt;</span><br><span class="line">         &lt;localVar:index=<span class="number">1</span> , name=runnable , desc=Lclub/throwable/Runnable;, sig=<span class="keyword">null</span>, start=L3, end=L2&gt;</span><br><span class="line">         &lt;localVar:index=<span class="number">2</span> , name=hello , desc=Ljava/lang/String;, sig=<span class="keyword">null</span>, start=L4, end=L2&gt;</span><br><span class="line">         &lt;localVar:index=<span class="number">3</span> , name=function , desc=Ljava/util/function/Function;, sig=Ljava/util/function/Function&lt;Ljava/lang/String;Ljava/lang/String;&gt;;, start=L5, end=L2&gt;</span><br><span class="line"></span><br><span class="line">         L1 &#123;</span><br><span class="line">             invokedynamic java/lang/invoke/LambdaMetafactory.metafactory(Ljava/lang/invoke/MethodHandles$Lookup;Ljava/lang/String;Ljava/lang/invoke/MethodType;Ljava/lang/invoke/MethodType;Ljava/lang/invoke/MethodHandle;Ljava/lang/invoke/MethodType;)Ljava/lang/invoke/CallSite; : run()Lclub/throwable/Runnable; ()V club/throwable/Sample.lambda$main$<span class="number">0</span>()V (<span class="number">6</span>) ()V</span><br><span class="line">             astore1</span><br><span class="line">         &#125;</span><br><span class="line">         L3 &#123;</span><br><span class="line">             aload1</span><br><span class="line">             invokeinterface club/throwable/Runnable.run()V</span><br><span class="line">         &#125;</span><br><span class="line">         L6 &#123;</span><br><span class="line">             ldc <span class="string">"Hello "</span> (java.lang.String)</span><br><span class="line">             astore2</span><br><span class="line">         &#125;</span><br><span class="line">         L4 &#123;</span><br><span class="line">             aload2</span><br><span class="line">             invokedynamic java/lang/invoke/LambdaMetafactory.metafactory(Ljava/lang/invoke/MethodHandles$Lookup;Ljava/lang/String;Ljava/lang/invoke/MethodType;Ljava/lang/invoke/MethodType;Ljava/lang/invoke/MethodHandle;Ljava/lang/invoke/MethodType;)Ljava/lang/invoke/CallSite; : apply(Ljava/lang/String;)Ljava/util/function/Function; (Ljava/lang/Object;)Ljava/lang/Object; club/throwable/Sample.lambda$main$<span class="number">1</span>(Ljava/lang/String;Ljava/lang/String;)Ljava/lang/String; (<span class="number">6</span>) (Ljava/lang/String;)Ljava/lang/String;</span><br><span class="line">             astore3</span><br><span class="line">         &#125;</span><br><span class="line">         L5 &#123;</span><br><span class="line">             aload3</span><br><span class="line">             ldc <span class="string">"Doge"</span> (java.lang.String)</span><br><span class="line">             invokeinterface java/util/function/Function.apply(Ljava/lang/Object;)Ljava/lang/Object;</span><br><span class="line">             pop</span><br><span class="line">         &#125;</span><br><span class="line">         L7 &#123;</span><br><span class="line">             <span class="keyword">return</span></span><br><span class="line">         &#125;</span><br><span class="line">         L2 &#123;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">private</span> <span class="keyword">static</span> synthetic lambda$main$<span class="number">1</span>(java.lang.String arg0, java.lang.String arg1) &#123; <span class="comment">//(Ljava/lang/String;Ljava/lang/String;)Ljava/lang/String;</span></span><br><span class="line">         &lt;localVar:index=<span class="number">0</span> , name=hello , desc=Ljava/lang/String;, sig=<span class="keyword">null</span>, start=L1, end=L2&gt;</span><br><span class="line">         &lt;localVar:index=<span class="number">1</span> , name=string , desc=Ljava/lang/String;, sig=<span class="keyword">null</span>, start=L1, end=L2&gt;</span><br><span class="line"></span><br><span class="line">         L1 &#123;</span><br><span class="line">             <span class="keyword">new</span> java/lang/StringBuilder</span><br><span class="line">             dup</span><br><span class="line">             invokespecial java/lang/StringBuilder.&lt;init&gt;()V</span><br><span class="line">             aload0 <span class="comment">// reference to arg0</span></span><br><span class="line">             invokevirtual java/lang/StringBuilder.append(Ljava/lang/String;)Ljava/lang/StringBuilder;</span><br><span class="line">             aload1</span><br><span class="line">             invokevirtual java/lang/StringBuilder.append(Ljava/lang/String;)Ljava/lang/StringBuilder;</span><br><span class="line">             invokevirtual java/lang/StringBuilder.toString()Ljava/lang/String;</span><br><span class="line">             areturn</span><br><span class="line">         &#125;</span><br><span class="line">         L2 &#123;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">private</span> <span class="keyword">static</span> synthetic lambda$main$<span class="number">0</span>() &#123; <span class="comment">//()V</span></span><br><span class="line">         L1 &#123;</span><br><span class="line">             getstatic java/lang/System.out:java.io.PrintStream</span><br><span class="line">             ldc <span class="string">"Hello World!"</span> (java.lang.String)</span><br><span class="line">             invokevirtual java/io/PrintStream.println(Ljava/lang/String;)V</span><br><span class="line">         &#125;</span><br><span class="line">         L2 &#123;</span><br><span class="line">             <span class="keyword">return</span></span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"><span class="comment">// The following inner classes couldn't be decompiled: java/lang/invoke/MethodHandles$Lookup </span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„å­—èŠ‚ç å·²ç»è¢«<code>Bytecode-Viewer</code>å·¥å…·æ ¼å¼åŒ–è¿‡ï¼Œç¬¦åˆäºäººçš„é˜…è¯»ä¹ æƒ¯ï¼Œä»å­—èŠ‚ç çš„é˜…è¯»ï¼Œç»“åˆå‰é¢çš„åˆ†æå¤§æ¦‚å¯ä»¥å¾—å‡ºä¸‹é¢çš„ç»“è®ºï¼š</p><ul><li><code>&lt;1&gt;</code>ï¼š<code>Lambda</code>è¡¨è¾¾å¼åœ¨ç¼–è¯‘æœŸé€šè¿‡å­—èŠ‚ç å¢å¼ºæŠ€æœ¯æ–°å¢ä¸€ä¸ªæ¨¡æ¿ç±»å®ç°å¯¹åº”çš„æ¥å£ç±»å‹ï¼Œè¿™ä¸ª<strong>æ¨¡æ¿ç±»</strong>çš„æ‰€æœ‰å±æ€§éƒ½ä½¿ç”¨<code>final</code>ä¿®é¥°ï¼Œæ¨¡æ¿ç±»ç”±å…³é”®å­—<code>final synthetic</code>ä¿®é¥°ã€‚</li><li><code>&lt;2&gt;</code>ï¼šå°é—­ç±»ä¼šåŸºäºç±»å†…çš„<code>Lambda</code>è¡¨è¾¾å¼ç±»å‹ç”Ÿæˆ<code>private static synthetic</code>ä¿®é¥°çš„é™æ€æ–¹æ³•ï¼Œè¯¥é™æ€æ–¹æ³•çš„æ–¹æ³•ä½“å°±æ˜¯æ¥æºäº<code>Lambda</code>æ–¹æ³•ä½“ï¼Œè¿™äº›é™æ€æ–¹æ³•çš„åç§°æ˜¯<code>lambda$å°é—­ç±»æ–¹æ³•å$é€’å¢æ•°å­—</code>ã€‚</li><li><code>&lt;3&gt;</code>ï¼š<code>Lambda</code>è¡¨è¾¾å¼è°ƒç”¨æœ€ç»ˆé€šè¿‡å­—èŠ‚ç æŒ‡ä»¤<code>invokedynamic</code>ï¼Œå¿½ç•¥ä¸­é—´è¿‡ç¨‹ï¼Œæœ€åè°ƒç”¨åˆ°ç¬¬<code>&lt;2&gt;</code>æ­¥ä¸­å¯¹åº”çš„æ–¹æ³•ã€‚</li></ul><p>é™äºç¯‡å¹…é—®é¢˜ï¼Œè¿™é‡ŒæŠŠ<code>Lambda</code>è¡¨è¾¾å¼çš„åº•å±‚åŸç†åšäº†ç®€å•çš„æ¢³ç†ï¼ˆè¿™ä¸ªæ¨å¯¼è¿‡ç¨‹ä»…é™äºä¸ªäººç†è§£ï¼Œä¾æ®å°šæœªå……åˆ†ï¼‰ï¼š</p><ul><li><code>&lt;1&gt;</code>ï¼šå°é—­ç±»ä¼šåŸºäºç±»å†…çš„<code>Lambda</code>è¡¨è¾¾å¼ç±»å‹ç”Ÿæˆ<code>private static synthetic</code>ä¿®é¥°çš„é™æ€æ–¹æ³•ï¼Œè¯¥é™æ€æ–¹æ³•çš„æ–¹æ³•ä½“å°±æ˜¯æ¥æºäº<code>Lambda</code>æ–¹æ³•ä½“ï¼Œè¿™äº›é™æ€æ–¹æ³•çš„åç§°æ˜¯<code>lambda$å°é—­ç±»æ–¹æ³•å$é€’å¢æ•°å­—</code>ã€‚</li><li><code>&lt;2&gt;</code>ï¼š<code>Lambda</code>è¡¨è¾¾å¼ä¼šé€šè¿‡<code>LambdaMetafactory#metafactory()</code>æ–¹æ³•ï¼Œç”Ÿæˆä¸€ä¸ªå¯¹åº”å‡½æ•°å¼æ¥å£çš„æ¨¡æ¿ç±»ï¼Œæ¨¡æ¿ç±»çš„æ¥å£æ–¹æ³•å®ç°å¼•ç”¨äº†ç¬¬<code>&lt;1&gt;</code>æ­¥ä¸­å®šä¹‰çš„é™æ€æ–¹æ³•ï¼ŒåŒæ—¶åˆ›å»ºä¸€ä¸ªè°ƒç”¨ç‚¹<code>ConstantCallSite</code>å®ä¾‹ï¼Œåé¢ä¼šé€šè¿‡<code>Unsafe#defineAnonymousClass()</code>å®ä¾‹åŒ–æ¨¡æ¿ç±»ã€‚ã€‚</li><li><code>&lt;3&gt;</code>ï¼šè°ƒç”¨ç‚¹<code>ConstantCallSite</code>å®ä¾‹ä¸­çš„æ–¹æ³•å¥æŸ„<code>MethodHandle</code>ä¼šæ ¹æ®ä¸åŒåœºæ™¯é€‰å–ä¸åŒçš„å®ç°ï¼Œ<code>MethodHandle</code>çš„å­ç±»å¾ˆå¤šï¼Œè¿™é‡Œæ— æ³•ä¸€ä¸€å±•å¼€ã€‚</li><li><code>&lt;4&gt;</code>ï¼šé€šè¿‡<code>invokedynamice</code>æŒ‡ä»¤ï¼ŒåŸºäºç¬¬<code>&lt;1&gt;</code>æ­¥ä¸­çš„æ¨¡æ¿ç±»å®ä¾‹ã€ç¬¬<code>&lt;3&gt;</code>æ­¥ä¸­çš„æ–¹æ³•å¥æŸ„ä»¥åŠæ–¹æ³•å…¥å‚è¿›è¡Œæ–¹æ³•å¥æŸ„çš„è°ƒç”¨ï¼Œå®é™…ä¸Šæœ€ç»ˆå§”æ‰˜åˆ°ç¬¬<code>&lt;1&gt;</code>æ­¥ä¸­å®šä¹‰çš„é™æ€æ–¹æ³•ä¸­æ‰§è¡Œã€‚</li></ul><p>å¦‚æœæƒ³è¦è·Ÿè¸ª<code>Lambda</code>è¡¨è¾¾å¼çš„æ•´ä¸ªè°ƒç”¨ç”Ÿå‘½å‘¨æœŸï¼Œå¯ä»¥ä»¥<code>LambdaMetafactory#metafactory()</code>æ–¹æ³•ä¸ºå…¥å£å¼€å§‹<code>DEBUG</code>ï¼Œè°ƒç”¨é“¾è·¯ååˆ†åºå¤§ï¼Œéœ€è¦æœ‰è¶³å¤Ÿçš„è€å¿ƒã€‚æ€»çš„æ¥è¯´å°±æ˜¯ï¼š<code>Lambda</code>è¡¨è¾¾å¼æ˜¯åŸºäº<code>JSR-292</code>å¼•å…¥çš„åŠ¨æ€è¯­è¨€è°ƒç”¨åŒ…<code>java.lang.invoke</code>å’Œ<code>Unsafe#defineAnonymousClass()</code>å®šä¹‰çš„è½»é‡çº§æ¨¡æ¿ç±»å®ç°çš„ï¼Œä¸»è¦ç”¨åˆ°äº†<code>invokedynamice</code>å­—èŠ‚ç æŒ‡ä»¤ï¼Œå…³è”åˆ°æ–¹æ³•å¥æŸ„<code>MethodHandle</code>ã€è°ƒç”¨ç‚¹<code>CallSite</code>ç­‰ç›¸å¯¹å¤æ‚çš„çŸ¥è¯†ç‚¹ï¼Œè¿™é‡Œä¸å†è¯¦ç»†å±•å¼€ã€‚</p><h2 id="å®æˆ˜">å®æˆ˜</h2><h3 id="åŸºäºJdbcTemplateè¿›è¡Œè½»é‡çº§DAOå°è£…">åŸºäºJdbcTemplateè¿›è¡Œè½»é‡çº§DAOå°è£…</h3><p>å‡è®¾è®¢å•è¡¨çš„<code>DDL</code>å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">CREATE TABLE `t_order`</span><br><span class="line">(</span><br><span class="line">    id          BIGINT UNSIGNED AUTO_INCREMENT PRIMARY KEY,</span><br><span class="line">    create_time DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP,</span><br><span class="line">    edit_time   DATETIME        NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,</span><br><span class="line">    user_id     BIGINT UNSIGNED NOT NULL COMMENT <span class="string">'ç”¨æˆ·ID'</span>,</span><br><span class="line">    <span class="function">order_id    <span class="title">VARCHAR</span><span class="params">(<span class="number">64</span>)</span>     NOT NULL COMMENT 'è®¢å•ID',</span></span><br><span class="line"><span class="function">    amount      <span class="title">DECIMAL</span><span class="params">(<span class="number">12</span>, <span class="number">2</span>)</span>  NOT NULL DEFAULT 0 COMMENT 'è®¢å•é‡‘é¢',</span></span><br><span class="line"><span class="function">    INDEX <span class="title">idx_user_id</span> <span class="params">(user_id)</span>,</span></span><br><span class="line"><span class="function">    UNIQUE <span class="title">uniq_order_id</span> <span class="params">(order_id)</span></span></span><br><span class="line"><span class="function">) COMMENT 'è®¢å•è¡¨'</span>;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢åŸºäº<code>JdbcTemplate</code>å°è£…ä¸€ä¸ªè½»é‡çº§çš„<code>OrderDao</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¾…åŠ©æ¥å£</span></span><br><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PreparedStatementProcessor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">process</span><span class="params">(PreparedStatement ps)</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ResultSetConverter</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">T <span class="title">convert</span><span class="params">(ResultSet resultSet)</span> <span class="keyword">throws</span> SQLException</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// OrderDaoæ¥å£</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OrderDao</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">insertSelective</span><span class="params">(Order record)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">updateSelective</span><span class="params">(Order record)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Order <span class="title">selectOneByOrderId</span><span class="params">(String orderId)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">List&lt;Order&gt; <span class="title">selectByUserId</span><span class="params">(Long userId)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// OrderDaoå®ç°</span></span><br><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MySqlOrderDao</span> <span class="keyword">implements</span> <span class="title">OrderDao</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JdbcTemplate jdbcTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ResultSetConverter&lt;Order&gt; CONVERTER = r -&gt; &#123;</span><br><span class="line">        Order order = <span class="keyword">new</span> Order();</span><br><span class="line">        order.setId(r.getLong(<span class="string">"id"</span>));</span><br><span class="line">        order.setCreateTime(r.getTimestamp(<span class="string">"create_time"</span>).toLocalDateTime());</span><br><span class="line">        order.setEditTime(r.getTimestamp(<span class="string">"edit_time"</span>).toLocalDateTime());</span><br><span class="line">        order.setUserId(r.getLong(<span class="string">"user_id"</span>));</span><br><span class="line">        order.setAmount(r.getBigDecimal(<span class="string">"amount"</span>));</span><br><span class="line">        order.setOrderId(r.getString(<span class="string">"order_id"</span>));</span><br><span class="line">        <span class="keyword">return</span> order;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ResultSetExtractor&lt;List&lt;Order&gt;&gt; MULTI = r -&gt; &#123;</span><br><span class="line">        List&lt;Order&gt; list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">while</span> (r.next()) &#123;</span><br><span class="line">            list.add(CONVERTER.convert(r));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> list;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ResultSetExtractor&lt;Order&gt; SINGLE = r -&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (r.next()) &#123;</span><br><span class="line">            <span class="keyword">return</span> CONVERTER.convert(r);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">insertSelective</span><span class="params">(Order record)</span> </span>&#123;</span><br><span class="line">        List&lt;PreparedStatementProcessor&gt; processors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        StringBuilder sql = <span class="keyword">new</span> StringBuilder(<span class="string">"INSERT INTO t_order("</span>);</span><br><span class="line">        Cursor cursor = <span class="keyword">new</span> Cursor();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != record.getId()) &#123;</span><br><span class="line">            <span class="keyword">int</span> idx = cursor.add();</span><br><span class="line">            sql.append(<span class="string">"id,"</span>);</span><br><span class="line">            processors.add(p -&gt; p.setLong(idx, record.getId()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != record.getOrderId()) &#123;</span><br><span class="line">            <span class="keyword">int</span> idx = cursor.add();</span><br><span class="line">            sql.append(<span class="string">"order_id,"</span>);</span><br><span class="line">            processors.add(p -&gt; p.setString(idx, record.getOrderId()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != record.getUserId()) &#123;</span><br><span class="line">            <span class="keyword">int</span> idx = cursor.add();</span><br><span class="line">            sql.append(<span class="string">"user_id,"</span>);</span><br><span class="line">            processors.add(p -&gt; p.setLong(idx, record.getUserId()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != record.getAmount()) &#123;</span><br><span class="line">            <span class="keyword">int</span> idx = cursor.add();</span><br><span class="line">            sql.append(<span class="string">"amount,"</span>);</span><br><span class="line">            processors.add(p -&gt; p.setBigDecimal(idx, record.getAmount()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != record.getCreateTime()) &#123;</span><br><span class="line">            <span class="keyword">int</span> idx = cursor.add();</span><br><span class="line">            sql.append(<span class="string">"create_time,"</span>);</span><br><span class="line">            processors.add(p -&gt; p.setTimestamp(idx, Timestamp.valueOf(record.getCreateTime())));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != record.getEditTime()) &#123;</span><br><span class="line">            <span class="keyword">int</span> idx = cursor.add();</span><br><span class="line">            sql.append(<span class="string">"edit_time,"</span>);</span><br><span class="line">            processors.add(p -&gt; p.setTimestamp(idx, Timestamp.valueOf(record.getEditTime())));</span><br><span class="line">        &#125;</span><br><span class="line">        StringBuilder realSql = <span class="keyword">new</span> StringBuilder(sql.substring(<span class="number">0</span>, sql.lastIndexOf(<span class="string">","</span>)));</span><br><span class="line">        realSql.append(<span class="string">") VALUES ("</span>);</span><br><span class="line">        <span class="keyword">int</span> idx = cursor.idx();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; idx; i++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (i != idx - <span class="number">1</span>) &#123;</span><br><span class="line">                realSql.append(<span class="string">"?,"</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                realSql.append(<span class="string">"?"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        realSql.append(<span class="string">")"</span>);</span><br><span class="line">        <span class="comment">// ä¼ å…¥ä¸»é”®çš„æƒ…å†µ</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != record.getId()) &#123;</span><br><span class="line">            <span class="keyword">return</span> jdbcTemplate.update(realSql.toString(), p -&gt; &#123;</span><br><span class="line">                <span class="keyword">for</span> (PreparedStatementProcessor processor : processors) &#123;</span><br><span class="line">                    processor.process(p);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// è‡ªå¢ä¸»é”®çš„æƒ…å†µ</span></span><br><span class="line">            KeyHolder keyHolder = <span class="keyword">new</span> GeneratedKeyHolder();</span><br><span class="line">            <span class="keyword">int</span> count = jdbcTemplate.update(p -&gt; &#123;</span><br><span class="line">                PreparedStatement ps = p.prepareStatement(realSql.toString(), Statement.RETURN_GENERATED_KEYS);</span><br><span class="line">                <span class="keyword">for</span> (PreparedStatementProcessor processor : processors) &#123;</span><br><span class="line">                    processor.process(ps);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> ps;</span><br><span class="line">            &#125;, keyHolder);</span><br><span class="line">            record.setId(Objects.requireNonNull(keyHolder.getKey()).longValue());</span><br><span class="line">            <span class="keyword">return</span> count;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">updateSelective</span><span class="params">(Order record)</span> </span>&#123;</span><br><span class="line">        List&lt;PreparedStatementProcessor&gt; processors = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        StringBuilder sql = <span class="keyword">new</span> StringBuilder(<span class="string">"UPDATE t_order SET "</span>);</span><br><span class="line">        Cursor cursor = <span class="keyword">new</span> Cursor();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != record.getOrderId()) &#123;</span><br><span class="line">            <span class="keyword">int</span> idx = cursor.add();</span><br><span class="line">            sql.append(<span class="string">"order_id = ?,"</span>);</span><br><span class="line">            processors.add(p -&gt; p.setString(idx, record.getOrderId()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != record.getUserId()) &#123;</span><br><span class="line">            <span class="keyword">int</span> idx = cursor.add();</span><br><span class="line">            sql.append(<span class="string">"user_id = ?,"</span>);</span><br><span class="line">            processors.add(p -&gt; p.setLong(idx, record.getUserId()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != record.getAmount()) &#123;</span><br><span class="line">            <span class="keyword">int</span> idx = cursor.add();</span><br><span class="line">            sql.append(<span class="string">"amount = ?,"</span>);</span><br><span class="line">            processors.add(p -&gt; p.setBigDecimal(idx, record.getAmount()));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != record.getCreateTime()) &#123;</span><br><span class="line">            <span class="keyword">int</span> idx = cursor.add();</span><br><span class="line">            sql.append(<span class="string">"create_time = ?,"</span>);</span><br><span class="line">            processors.add(p -&gt; p.setTimestamp(idx, Timestamp.valueOf(record.getCreateTime())));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != record.getEditTime()) &#123;</span><br><span class="line">            <span class="keyword">int</span> idx = cursor.add();</span><br><span class="line">            sql.append(<span class="string">"edit_time = ?,"</span>);</span><br><span class="line">            processors.add(p -&gt; p.setTimestamp(idx, Timestamp.valueOf(record.getEditTime())));</span><br><span class="line">        &#125;</span><br><span class="line">        StringBuilder realSql = <span class="keyword">new</span> StringBuilder(sql.substring(<span class="number">0</span>, sql.lastIndexOf(<span class="string">","</span>)));</span><br><span class="line">        <span class="keyword">int</span> idx = cursor.add();</span><br><span class="line">        processors.add(p -&gt; p.setLong(idx, record.getId()));</span><br><span class="line">        realSql.append(<span class="string">" WHERE id = ?"</span>);</span><br><span class="line">        <span class="keyword">return</span> jdbcTemplate.update(realSql.toString(), p -&gt; &#123;</span><br><span class="line">            <span class="keyword">for</span> (PreparedStatementProcessor processor : processors) &#123;</span><br><span class="line">                processor.process(p);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Order <span class="title">selectOneByOrderId</span><span class="params">(String orderId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jdbcTemplate.query(<span class="string">"SELECT * FROM t_order WHERE order_id = ?"</span>, p -&gt; p.setString(<span class="number">1</span>, orderId), SINGLE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;Order&gt; <span class="title">selectByUserId</span><span class="params">(Long userId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> jdbcTemplate.query(<span class="string">"SELECT * FROM t_order WHERE order_id = ?"</span>, p -&gt; p.setLong(<span class="number">1</span>, userId), MULTI);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Cursor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">int</span> idx;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">add</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            idx++;</span><br><span class="line">            <span class="keyword">return</span> idx;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">idx</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> idx;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç±»ä¼¼äº<code>Mybatis Generator</code>ï¼Œä¸Šé¢çš„<code>DAO</code>å®ç°ç¬”è€…å·²ç»åšäº†ä¸€ä¸ªç®€å•çš„ç”Ÿæˆå™¨ï¼Œåªè¦é…ç½®å¥½æ•°æ®æºçš„è¿æ¥å±æ€§å’Œè¡¨è¿‡æ»¤è§„åˆ™å°±å¯ä»¥ç”Ÿæˆå¯¹åº”çš„å®ä½“ç±»å’Œ<code>DAO</code>ç±»ã€‚</p><h3 id="åŸºäºOptionalè¿›è¡ŒVOè®¾ç½®å€¼">åŸºäºOptionalè¿›è¡ŒVOè®¾ç½®å€¼</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‡è®¾VOæœ‰å¤šä¸ªå±‚çº§ï¼Œæ¯ä¸ªå±‚çº§éƒ½ä¸çŸ¥é“çˆ¶èŠ‚ç‚¹æ˜¯å¦ä¸ºNULLï¼Œå¦‚ä¸‹</span></span><br><span class="line"><span class="comment">// - OrderInfoVo</span></span><br><span class="line"><span class="comment">//   - UserInfoVo</span></span><br><span class="line"><span class="comment">//     - AddressInfoVo</span></span><br><span class="line"><span class="comment">//        - address(å±æ€§)</span></span><br><span class="line"><span class="comment">// å‡è®¾æˆ‘è¦ä¸ºaddresså±æ€§èµ‹å€¼ï¼Œé‚£ä¹ˆå°±ä¼šäº§ç”Ÿç®­å¤´å‹ä»£ç ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// å¸¸è§„æ–¹æ³•</span></span><br><span class="line">String address = <span class="string">"xxx"</span>;</span><br><span class="line">OrderInfoVo o = ...;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">null</span> != o)&#123;</span><br><span class="line">    UserInfoVo uiv = o.getUserInfoVo();</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> != uiv)&#123;</span><br><span class="line">        AddressInfoVo aiv = uiv.getAddressInfoVo();</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != aiv)&#123;</span><br><span class="line">            aiv.setAddress(address);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä½¿ç”¨Optionalå’ŒLambda</span></span><br><span class="line">String address = <span class="string">"xxx"</span>;</span><br><span class="line">OrderInfoVo o = ...;</span><br><span class="line">Optional.ofNullable(o).map(OrderInfoVo::getUserInfoVo).map(UserInfoVo::getAddressInfoVo).ifPresent(a -&gt; a.setAddress(address));</span><br></pre></td></tr></table></figure><h2 id="å°ç»“">å°ç»“</h2><p><code>Lambda</code>æ˜¯<code>Java</code>ä¸­ä¸€ä¸ªé¦™ç”œçš„è¯­æ³•ç³–ï¼Œæ‹¥æŠ±<code>Lambda</code>ï¼Œæ‹¥æŠ±å‡½æ•°å¼ç¼–ç¨‹ï¼Œç¬”è€…ä¹Ÿç»å†è¿‡æŠ—æ‹’ã€ä¸çœ‹å¥½ã€ä¸Šæ‰‹å’ŒçœŸé¦™çš„è¿‡ç¨‹ï¼Œç›®å‰ä¹Ÿå¤§é‡ä½¿ç”¨<code>Stream</code>å’Œ<code>Lambda</code>ï¼Œèƒ½åœ¨ä¿è¯æ€§èƒ½çš„å‰æä¸‹ï¼Œå°½å¯èƒ½ç®€åŒ–ä»£ç ï¼Œè§£æ”¾åŠ³åŠ¨åŠ›ã€‚æ—¶ä»£åœ¨è¿›æ­¥ï¼Œ<code>Java</code>ä¹Ÿåœ¨è¿›æ­¥ï¼Œè¿™æ˜¯å¾ˆå¤šäººæ´»ç€å’ŒåšæŒç¼–ç¨‹äº‹ä¸šçš„ä¿¡å¿µã€‚</p><p>å‚è€ƒèµ„æ–™ï¼š</p><ul><li><a href="https://docs.oracle.com/javase/tutorial/java/javaOO/lambdaexpressions.html" target="_blank" rel="noopener">Lambda Expressions</a></li><li><a href="https://docs.oracle.com/javase/tutorial/java/IandI/defaultmethods.html" target="_blank" rel="noopener">Default Methods</a></li><li><a href="http://cr.openjdk.java.net/~briangoetz/lambda/lambda-state-final.html" target="_blank" rel="noopener">State of the Lambda</a></li><li>JDK11éƒ¨åˆ†æºç </li></ul><p>ï¼ˆæœ¬æ–‡å®Œ e-a-20200208 c-5-dï¼‰</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰æ&quot;&gt;å‰æ&lt;/h2&gt;
&lt;p&gt;å›æƒ³ä¸€ä¸‹ï¼Œ&lt;code&gt;JDK8&lt;/code&gt;æ˜¯2014å¹´å‘å¸ƒæ­£å¼ç‰ˆçš„ï¼Œåˆ°ç°åœ¨ä¸ºï¼ˆ&lt;code&gt;2020-02-08&lt;/code&gt;ï¼‰æ­¢å·²ç»è¿‡å»äº†5å¹´å¤šã€‚&lt;code&gt;JDK8&lt;/code&gt;å¼•å…¥çš„ä¸¤ä¸ªæ¯”è¾ƒå¼ºå¤§çš„æ–°ç‰¹æ€§æ˜¯&lt;code&gt;Lambda&lt;/code&gt;è¡¨è¾¾å¼ï¼ˆä¸‹æ–‡çš„&lt;code&gt;Lambda&lt;/code&gt;ç‰¹æŒ‡&lt;code&gt;JDK&lt;/code&gt;æä¾›çš„&lt;code&gt;Lambda&lt;/code&gt;ï¼‰å’Œ&lt;code&gt;Stream&lt;/code&gt;ï¼Œè¿™ä¸¤ä¸ªå¼ºå¤§çš„ç‰¹æ€§è®©å‡½æ•°å¼ç¼–ç¨‹åœ¨&lt;code&gt;Java&lt;/code&gt;å¼€å‘ä¸­å‘æ‰¬å…‰å¤§ã€‚è¿™ç¯‡æ–‡ç« ä¼šä»åŸºæœ¬æ¦‚å¿µã€ä½¿ç”¨æ–¹å¼ã€å®ç°åŸç†å’Œå®æˆ˜åœºæ™¯ç­‰è§’åº¦ä»‹ç»&lt;code&gt;Lambda&lt;/code&gt;çš„å…¨è²Œï¼Œå…¶ä¸­è¿˜ä¼šæ¶‰åŠä¸€äº›å‡½æ•°å¼ç¼–ç¨‹æ¦‚å¿µã€&lt;code&gt;JVM&lt;/code&gt;ä¸€äº›çŸ¥è¯†ç­‰ç­‰ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Java" scheme="http://throwable.club/blog/categories/Java/"/>
    
      <category term="Lambda" scheme="http://throwable.club/blog/categories/Java/Lambda/"/>
    
    
      <category term="Java" scheme="http://throwable.club/blog/tags/Java/"/>
    
      <category term="Lambda" scheme="http://throwable.club/blog/tags/Lambda/"/>
    
  </entry>
  
  <entry>
    <title>ä¸€ä¸ªåŸºäºRabbitMQçš„å¯å¤ç”¨çš„äº‹åŠ¡æ¶ˆæ¯æ–¹æ¡ˆ</title>
    <link href="http://throwable.club/2020/02/05/j-action-transactional-message-by-rabbit/"/>
    <id>http://throwable.club/2020/02/05/j-action-transactional-message-by-rabbit/</id>
    <published>2020-02-05T13:37:56.000Z</published>
    <updated>2020-02-05T13:39:07.621Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰æ">å‰æ</h2><p>åˆ†å¸ƒå¼äº‹åŠ¡æ˜¯å¾®æœåŠ¡å®è·µä¸­ä¸€ä¸ªæ¯”è¾ƒæ£˜æ‰‹çš„é—®é¢˜ï¼Œåœ¨ç¬”è€…æ‰€å®æ–½çš„å¾®æœåŠ¡å®è·µæ–¹æ¡ˆä¸­ï¼Œéƒ½é‡‡ç”¨äº†æŠ˜ä¸­æˆ–è€…è§„é¿å¼ºä¸€è‡´æ€§çš„æ–¹æ¡ˆã€‚å‚è€ƒ<code>Ebay</code>å¤šå¹´å‰æå‡ºçš„æœ¬åœ°æ¶ˆæ¯è¡¨æ–¹æ¡ˆï¼ŒåŸºäº<code>RabbitMQ</code>å’Œ<code>MySQL</code>ï¼ˆ<code>JDBC</code>ï¼‰åšäº†è½»é‡çº§çš„å°è£…ï¼Œå®ç°äº†ä½å…¥ä¾µæ€§çš„äº‹åŠ¡æ¶ˆæ¯æ¨¡å—ã€‚æœ¬æ–‡çš„å†…å®¹å°±æ˜¯è¯¦ç»†åˆ†ææ•´ä¸ªæ–¹æ¡ˆçš„è®¾è®¡æ€è·¯å’Œå®æ–½ã€‚ç¯å¢ƒä¾èµ–å¦‚ä¸‹ï¼š</p><ul><li><code>JDK1.8+</code></li><li><code>spring-boot-start-web:2.x.x</code>ã€<code>spring-boot-start-jdbc:2.x.x</code>ã€<code>spring-boot-start-amqp:2.x.x</code></li><li><code>HikariCP:3.x.x</code>ï¼ˆ<code>spring-boot-start-jdbc</code>è‡ªå¸¦ï¼‰ã€<code>mysql-connector-java:5.1.48</code></li><li><code>redisson:3.12.1</code></li></ul><a id="more"></a><h2 id="æ–¹æ¡ˆè®¾è®¡æ€è·¯">æ–¹æ¡ˆè®¾è®¡æ€è·¯</h2><p>äº‹åŠ¡æ¶ˆæ¯åŸåˆ™ä¸Šåªé€‚åˆå¼±ä¸€è‡´æ€§ï¼ˆæˆ–è€…è¯´<strong>æœ€ç»ˆä¸€è‡´æ€§</strong>ï¼‰çš„åœºæ™¯ï¼Œå¸¸è§çš„å¼±ä¸€è‡´æ€§åœºæ™¯å¦‚ï¼š</p><ul><li>ç”¨æˆ·æœåŠ¡å®Œæˆäº†æ³¨å†ŒåŠ¨ä½œï¼Œå‘çŸ­ä¿¡æœåŠ¡æ¨é€ä¸€æ¡è¥é”€ç›¸å…³çš„æ¶ˆæ¯ã€‚</li><li>ä¿¡è´·ä½“ç³»ä¸­ï¼Œè®¢å•æœåŠ¡ä¿å­˜è®¢å•å®Œæ¯•ï¼Œå‘å®¡æ‰¹æœåŠ¡æ¨é€ä¸€æ¡å¾…å®¡æ‰¹çš„è®¢å•è®°å½•ä¿¡æ¯ã€‚</li><li>â€¦</li></ul><p><strong>å¼ºä¸€è‡´æ€§çš„åœºæ™¯ä¸€èˆ¬ä¸åº”è¯¥é€‰ç”¨äº‹åŠ¡æ¶ˆæ¯</strong>ã€‚</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/202002/r-r-t-m-3.png" alt=""></p><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œè¦æ±‚å¼ºä¸€è‡´æ€§è¯´æ˜è¦ä¸¥æ ¼åŒæ­¥ï¼Œä¹Ÿå°±æ˜¯æ‰€æœ‰æ“ä½œå¿…é¡»åŒæ—¶æˆåŠŸæˆ–è€…åŒæ—¶å¤±è´¥ï¼Œè¿™æ ·å°±ä¼šå¼•å…¥åŒæ­¥å¸¦æ¥çš„é¢å¤–æ¶ˆè€—ã€‚å¦‚æœä¸€ä¸ªäº‹åŠ¡æ¶ˆæ¯æ¨¡å—è®¾è®¡åˆç†ï¼Œè¡¥å¿ã€æŸ¥è¯¢ã€ç›‘æ§ç­‰ç­‰åŠŸèƒ½éƒ½å®Œæ¯•ï¼Œç”±äºç³»ç»Ÿäº¤äº’æ˜¯å¼‚æ­¥çš„ï¼Œæ•´ä½“ååè¦æ¯”ä¸¥æ ¼åŒæ­¥é«˜ã€‚åœ¨ç¬”è€…è´Ÿè´£çš„ä¸šåŠ¡ç³»ç»Ÿä¸­åŸºäºäº‹åŠ¡æ¶ˆæ¯ä½¿ç”¨è¿˜å®šåˆ¶äº†ä¸€æ¡åŸºæœ¬åŸåˆ™ï¼š<strong>æ¶ˆæ¯å†…å®¹æ­£ç¡®çš„å‰æä¸‹ï¼Œæ¶ˆè´¹æ–¹å‡ºç°å¼‚å¸¸éœ€è¦è‡ªç†</strong>ã€‚</p><blockquote><p>ç®€å•æ¥è¯´å°±æ˜¯ï¼šä¸Šæ¸¸ä¿è¯äº†è‡ªèº«çš„ä¸šåŠ¡æ­£ç¡®æ€§ï¼ŒæˆåŠŸæ¨é€äº†æ­£ç¡®çš„æ¶ˆæ¯åˆ°RabbitMQå°±è®¤ä¸ºä¸Šæ¸¸ä¹‰åŠ¡å·²ç»ç»“æŸã€‚</p></blockquote><p>ä¸ºäº†é™ä½ä»£ç çš„å…¥ä¾µæ€§ï¼Œäº‹åŠ¡æ¶ˆæ¯éœ€è¦å€ŸåŠ©<code>Spring</code>çš„<strong>ç¼–ç¨‹å¼äº‹åŠ¡</strong>æˆ–è€…<strong>å£°æ˜å¼äº‹åŠ¡</strong>ã€‚ç¼–ç¨‹å¼äº‹åŠ¡ä¸€èˆ¬ä¾èµ–äº<code>TransactionTemplate</code>ï¼Œè€Œå£°æ˜å¼äº‹åŠ¡ä¾æ‰˜äº<code>AOP</code>æ¨¡å—ï¼Œä¾èµ–äºæ³¨è§£<code>@Transactional</code>ã€‚</p><p>æ¥ç€éœ€è¦è‡ªå®šä¹‰ä¸€ä¸ªäº‹åŠ¡æ¶ˆæ¯åŠŸèƒ½æ¨¡å—ï¼Œæ–°å¢ä¸€ä¸ªäº‹åŠ¡æ¶ˆæ¯è®°å½•è¡¨ï¼ˆå…¶å®å°±æ˜¯<strong>æœ¬åœ°æ¶ˆæ¯è¡¨</strong>ï¼‰ï¼Œç”¨äºä¿å­˜æ¯ä¸€æ¡éœ€è¦å‘é€çš„æ¶ˆæ¯è®°å½•ã€‚äº‹åŠ¡æ¶ˆæ¯åŠŸèƒ½æ¨¡å—çš„ä¸»è¦åŠŸèƒ½æ˜¯ï¼š</p><ul><li>ä¿å­˜æ¶ˆæ¯è®°å½•ã€‚</li><li>æ¨é€æ¶ˆæ¯åˆ°<code>RabbitMQ</code>æœåŠ¡ç«¯ã€‚</li><li>æ¶ˆæ¯è®°å½•çš„æŸ¥è¯¢ã€è¡¥å¿æ¨é€ç­‰ç­‰ã€‚</li></ul><h3 id="äº‹åŠ¡æ‰§è¡Œçš„é€»è¾‘å•å…ƒ">äº‹åŠ¡æ‰§è¡Œçš„é€»è¾‘å•å…ƒ</h3><p>åœ¨äº‹åŠ¡æ‰§è¡Œçš„é€»è¾‘å•å…ƒé‡Œé¢ï¼Œéœ€è¦è¿›è¡Œå¾…æ¨é€çš„äº‹åŠ¡æ¶ˆæ¯è®°å½•çš„ä¿å­˜ï¼Œä¹Ÿå°±æ˜¯ï¼š<strong>æœ¬åœ°ï¼ˆä¸šåŠ¡ï¼‰é€»è¾‘å’Œäº‹åŠ¡æ¶ˆæ¯è®°å½•ä¿å­˜æ“ä½œç»‘å®šåœ¨åŒä¸€ä¸ªäº‹åŠ¡</strong>ã€‚</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/202002/r-r-t-m-1.png" alt=""></p><p>å‘é€æ¶ˆæ¯åˆ°<code>RabbitMQ</code>æœåŠ¡ç«¯è¿™ä¸€æ­¥éœ€è¦å»¶ååˆ°<strong>äº‹åŠ¡æäº¤ä¹‹å</strong>ï¼Œè¿™æ ·æ‰èƒ½ä¿è¯äº‹åŠ¡æäº¤æˆåŠŸå’Œæ¶ˆæ¯æˆåŠŸå‘é€åˆ°<code>RabbitMQ</code>æœåŠ¡ç«¯è¿™ä¸¤ä¸ªæ“ä½œæ˜¯ä¸€è‡´çš„ã€‚ä¸ºäº†æŠŠ<strong>ä¿å­˜å¾…å‘é€çš„äº‹åŠ¡æ¶ˆæ¯</strong>å’Œ<strong>å‘é€æ¶ˆæ¯åˆ°RabbitMQ</strong>ä¸¤ä¸ªåŠ¨ä½œä»ä½¿ç”¨è€…æ„ŸçŸ¥è§’åº¦åˆå¹¶ä¸ºä¸€ä¸ªåŠ¨ä½œï¼Œè¿™é‡Œéœ€è¦ç”¨åˆ°<code>Spring</code>ç‰¹æœ‰çš„äº‹åŠ¡åŒæ­¥å™¨<code>TransactionSynchronization</code>ï¼Œè¿™é‡Œåˆ†æä¸€ä¸‹äº‹åŠ¡åŒæ­¥å™¨çš„ä¸»è¦æ–¹æ³•çš„å›è°ƒä½ç½®ï¼Œä¸»è¦å‚è€ƒ<code>AbstractPlatformTransactionManager#commit()</code>æˆ–è€…<code>AbstractPlatformTransactionManager#processCommit()</code>æ–¹æ³•ï¼š</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/202002/r-r-t-m-2.png" alt=""></p><p>ä¸Šå›¾ä»…ä»…æ¼”ç¤ºäº†äº‹åŠ¡æ­£ç¡®æäº¤çš„åœºæ™¯ï¼ˆä¸åŒ…å«å¼‚å¸¸çš„åœºæ™¯ï¼‰ã€‚è¿™é‡Œå¯ä»¥æ˜ç¡®çŸ¥é“ï¼Œäº‹åŠ¡åŒæ­¥å™¨<code>TransactionSynchronization</code>çš„<code>afterCommit()</code>å’Œ<code>afterCompletion(int status)</code>æ–¹æ³•éƒ½åœ¨çœŸæ­£çš„äº‹åŠ¡æäº¤ç‚¹<code>AbstractPlatformTransactionManager#doCommit()</code>ä¹‹åå›è°ƒï¼Œå› æ­¤å¯ä»¥é€‰ç”¨è¿™ä¸¤ä¸ªæ–¹æ³•å…¶ä¸­ä¹‹ä¸€ç”¨äºæ‰§è¡Œæ¨é€æ¶ˆæ¯åˆ°<code>RabbitMQ</code>æœåŠ¡ç«¯ï¼Œæ•´ä½“çš„ä¼ªä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Transactional</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Dto <span class="title">businessMethod</span><span class="params">()</span></span>&#123;</span><br><span class="line">    business transaction code block ...</span><br><span class="line">    <span class="comment">// ä¿å­˜äº‹åŠ¡æ¶ˆæ¯</span></span><br><span class="line">    [saveTransactionMessageRecord()]</span><br><span class="line">    <span class="comment">// æ³¨å†Œäº‹åŠ¡åŒæ­¥å™¨ - åœ¨afterCommit()æ–¹æ³•ä¸­æ¨é€æ¶ˆæ¯åˆ°RabbitMQ</span></span><br><span class="line">    [register TransactionSynchronization,<span class="function">send message in method <span class="title">afterCommit</span><span class="params">()</span>]</span></span><br><span class="line"><span class="function">    business transaction code block ...</span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä¼ªä»£ç ä¸­ï¼Œ<strong>ä¿å­˜äº‹åŠ¡æ¶ˆæ¯</strong>å’Œ<strong>æ³¨å†Œäº‹åŠ¡åŒæ­¥å™¨</strong>ä¸¤ä¸ªæ­¥éª¤å¯ä»¥å®‰æ’åœ¨äº‹åŠ¡æ–¹æ³•ä¸­çš„ä»»æ„ä½ç½®ï¼Œä¹Ÿå°±æ˜¯è¯´ä¸æ‰§è¡Œé¡ºåºæ— å…³ã€‚</p><h3 id="äº‹åŠ¡æ¶ˆæ¯çš„è¡¥å¿">äº‹åŠ¡æ¶ˆæ¯çš„è¡¥å¿</h3><p>è™½ç„¶ä¹‹å‰æåˆ°ç¬”è€…å»ºè®®ä¸‹æ¸¸æœåŠ¡è‡ªç†è‡ªèº«æœåŠ¡æ¶ˆè´¹å¼‚å¸¸çš„åœºæ™¯ï¼Œä½†æ˜¯æœ‰äº›æ—¶å€™è¿«äºæ— å¥ˆè¿˜æ˜¯éœ€è¦ä¸Šæ¸¸æŠŠå¯¹åº”çš„æ¶ˆæ¯é‡æ–°æ¨é€ï¼Œè¿™ä¸ªç®—æ˜¯ç‰¹æ®Šçš„åœºæ™¯ã€‚å¦å¤–è¿˜æœ‰ä¸€ä¸ªåœºæ™¯éœ€è¦è€ƒè™‘ï¼šäº‹åŠ¡æäº¤ä¹‹åè§¦å‘äº‹åŠ¡åŒæ­¥å™¨<code>TransactionSynchronization</code>çš„<code>afterCommit()</code>æ–¹æ³•å¤±è´¥ã€‚è¿™æ˜¯ä¸€ä¸ªä½æ¦‚ç‡çš„åœºæ™¯ï¼Œä½†æ˜¯åœ¨ç”Ÿäº§ä¸­ä¸€å®šä¼šå‡ºç°ï¼Œä¸€ä¸ªæ¯”è¾ƒå…¸å‹çš„åŸå› å°±æ˜¯ï¼š<strong>äº‹åŠ¡æäº¤å®Œæˆåå°šæœªæ¥å¾—åŠè§¦å‘<code>TransactionSynchronization#afterCommit()</code>æ–¹æ³•è¿›è¡Œæ¨é€æœåŠ¡å®ä¾‹å°±è¢«é‡å¯</strong>ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/202002/r-r-t-m-5.png" alt=""></p><p>ä¸ºäº†ç»Ÿä¸€å¤„ç†è¡¥å¿æ¨é€çš„é—®é¢˜ï¼Œä½¿ç”¨äº†æœ‰é™çŠ¶æ€åˆ¤æ–­æ¶ˆæ¯æ˜¯å¦å·²ç»æ¨é€æˆåŠŸï¼š</p><ul><li>åœ¨äº‹åŠ¡æ–¹æ³•å†…ï¼Œä¿å­˜äº‹åŠ¡æ¶ˆæ¯çš„æ—¶å€™ï¼Œæ ‡è®°æ¶ˆæ¯è®°å½•æ¨é€çŠ¶æ€ä¸º<strong>å¤„ç†ä¸­</strong>ã€‚</li><li>äº‹åŠ¡åŒæ­¥å™¨æ¥å£<code>TransactionSynchronization</code>çš„<code>afterCommit()</code>æ–¹æ³•çš„å®ç°ä¸­ï¼Œæ¨é€å¯¹åº”çš„æ¶ˆæ¯åˆ°<code>RabbitMQ</code>ï¼Œç„¶åæ›´å˜äº‹åŠ¡æ¶ˆæ¯è®°å½•çš„çŠ¶æ€ä¸º<strong>æ¨é€æˆåŠŸ</strong>ã€‚</li></ul><p>è¿˜æœ‰ä¸€ç§æä¸ºç‰¹æ®Šçš„æƒ…å†µæ˜¯<code>RabbitMQ</code>æœåŠ¡ç«¯æœ¬èº«å‡ºç°æ•…éšœå¯¼è‡´æ¶ˆæ¯æ¨é€å¼‚å¸¸ï¼Œè¿™ç§æƒ…å†µä¸‹éœ€è¦è¿›è¡Œé‡è¯•ï¼ˆè¡¥å¿æ¨é€ï¼‰ï¼Œ<strong>ç»éªŒè¯æ˜çŸ­æ—¶é—´å†…çš„åå¤é‡è¯•æ˜¯æ²¡æœ‰æ„ä¹‰çš„</strong>ï¼Œæ•…éšœçš„æœåŠ¡ä¸€èˆ¬ä¸ä¼šç¬æ—¶æ¢å¤ï¼Œæ‰€ä»¥å¯ä»¥è€ƒè™‘ä½¿ç”¨<strong>æŒ‡æ•°é€€é¿ç®—æ³•</strong>è¿›è¡Œé‡è¯•ï¼ŒåŒæ—¶éœ€è¦é™åˆ¶æœ€å¤§é‡è¯•æ¬¡æ•°ã€‚</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/202002/r-r-t-m-6.png" alt=""></p><p>æŒ‡æ•°å€¼ã€é—´éš”å€¼å’Œæœ€å¤§é‡è¯•æ¬¡æ•°ä¸Šé™éœ€è¦æ ¹æ®å®é™…æƒ…å†µè®¾å®šï¼Œå¦åˆ™å®¹æ˜“å‡ºç°æ¶ˆæ¯å»¶æ—¶è¿‡å¤§æˆ–è€…é‡è¯•è¿‡äºé¢‘ç¹ç­‰é—®é¢˜ã€‚</p><h2 id="æ–¹æ¡ˆå®æ–½">æ–¹æ¡ˆå®æ–½</h2><p>å¼•å…¥æ ¸å¿ƒä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">spring.boot.version</span>&gt;</span>2.2.4.RELEASE<span class="tag">&lt;/<span class="name">spring.boot.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">redisson.version</span>&gt;</span>3.12.1<span class="tag">&lt;/<span class="name">redisson.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mysql.connector.version</span>&gt;</span>5.1.48<span class="tag">&lt;/<span class="name">mysql.connector.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;mysql.connector.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-aop<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.redisson<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>redisson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;redisson.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>spring-boot-starter-jdbc</code>ã€<code>mysql-connector-java</code>å’Œ<code>spring-boot-starter-aop</code>æ˜¯<code>MySQL</code>äº‹åŠ¡ç›¸å…³ï¼Œè€Œ<code>spring-boot-starter-amqp</code>æ˜¯<code>RabbitMQ</code>å®¢æˆ·ç«¯çš„å°è£…ï¼Œ<code>redisson</code>ä¸»è¦ä½¿ç”¨å…¶åˆ†å¸ƒå¼é”ï¼Œç”¨äºè¡¥å¿å®šæ—¶ä»»åŠ¡çš„åŠ é”æ‰§è¡Œï¼ˆä»¥é˜²æ­¢æœåŠ¡å¤šä¸ªèŠ‚ç‚¹å¹¶å‘æ‰§è¡Œè¡¥å¿æ¨é€ï¼‰ã€‚</p><h3 id="è¡¨è®¾è®¡">è¡¨è®¾è®¡</h3><p>äº‹åŠ¡æ¶ˆæ¯æ¨¡å—ä¸»è¦æ¶‰åŠä¸¤å¼ è¡¨ï¼Œä»¥<code>MySQL</code>ä¸ºä¾‹ï¼Œå»ºè¡¨<code>DDL</code>å¦‚ä¸‹ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`t_transactional_message`</span></span><br><span class="line">(</span><br><span class="line">    <span class="keyword">id</span>                  <span class="built_in">BIGINT</span> <span class="keyword">UNSIGNED</span> AUTO_INCREMENT PRIMARY <span class="keyword">KEY</span>,</span><br><span class="line">    create_time         DATETIME        <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    edit_time           DATETIME        <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">ON</span> <span class="keyword">UPDATE</span> <span class="keyword">CURRENT_TIMESTAMP</span>,</span><br><span class="line">    creator             <span class="built_in">VARCHAR</span>(<span class="number">20</span>)     <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'admin'</span>,</span><br><span class="line">    editor              <span class="built_in">VARCHAR</span>(<span class="number">20</span>)     <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'admin'</span>,</span><br><span class="line">    deleted             <span class="built_in">TINYINT</span>         <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span>,</span><br><span class="line">    current_retry_times <span class="built_in">TINYINT</span>         <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">'å½“å‰é‡è¯•æ¬¡æ•°'</span>,</span><br><span class="line">    max_retry_times     <span class="built_in">TINYINT</span>         <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">5</span> <span class="keyword">COMMENT</span> <span class="string">'æœ€å¤§é‡è¯•æ¬¡æ•°'</span>,</span><br><span class="line">    queue_name          <span class="built_in">VARCHAR</span>(<span class="number">255</span>)    <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'é˜Ÿåˆ—å'</span>,</span><br><span class="line">    exchange_name       <span class="built_in">VARCHAR</span>(<span class="number">255</span>)    <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'äº¤æ¢å™¨å'</span>,</span><br><span class="line">    exchange_type       <span class="built_in">VARCHAR</span>(<span class="number">8</span>)      <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'äº¤æ¢ç±»å‹'</span>,</span><br><span class="line">    routing_key         <span class="built_in">VARCHAR</span>(<span class="number">255</span>) <span class="keyword">COMMENT</span> <span class="string">'è·¯ç”±é”®'</span>,</span><br><span class="line">    business_module     <span class="built_in">VARCHAR</span>(<span class="number">32</span>)     <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'ä¸šåŠ¡æ¨¡å—'</span>,</span><br><span class="line">    business_key        <span class="built_in">VARCHAR</span>(<span class="number">255</span>)    <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'ä¸šåŠ¡é”®'</span>,</span><br><span class="line">    next_schedule_time  DATETIME        <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'ä¸‹ä¸€æ¬¡è°ƒåº¦æ—¶é—´'</span>,</span><br><span class="line">    message_status      <span class="built_in">TINYINT</span>         <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">'æ¶ˆæ¯çŠ¶æ€'</span>,</span><br><span class="line">    init_backoff        <span class="built_in">BIGINT</span> <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">10</span> <span class="keyword">COMMENT</span> <span class="string">'é€€é¿åˆå§‹åŒ–å€¼,å•ä½ä¸ºç§’'</span>,</span><br><span class="line">    backoff_factor      <span class="built_in">TINYINT</span>         <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">2</span> <span class="keyword">COMMENT</span> <span class="string">'é€€é¿å› å­(ä¹Ÿå°±æ˜¯æŒ‡æ•°)'</span>,</span><br><span class="line">    <span class="keyword">INDEX</span> idx_queue_name (queue_name),</span><br><span class="line">    <span class="keyword">INDEX</span> idx_create_time (create_time),</span><br><span class="line">    <span class="keyword">INDEX</span> idx_next_schedule_time (next_schedule_time),</span><br><span class="line">    <span class="keyword">INDEX</span> idx_business_key (business_key)</span><br><span class="line">) <span class="keyword">COMMENT</span> <span class="string">'äº‹åŠ¡æ¶ˆæ¯è¡¨'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`t_transactional_message_content`</span></span><br><span class="line">(</span><br><span class="line">    <span class="keyword">id</span>         <span class="built_in">BIGINT</span> <span class="keyword">UNSIGNED</span> AUTO_INCREMENT PRIMARY <span class="keyword">KEY</span>,</span><br><span class="line">    message_id <span class="built_in">BIGINT</span> <span class="keyword">UNSIGNED</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'äº‹åŠ¡æ¶ˆæ¯è®°å½•ID'</span>,</span><br><span class="line">    <span class="keyword">content</span>    <span class="built_in">TEXT</span> <span class="keyword">COMMENT</span> <span class="string">'æ¶ˆæ¯å†…å®¹'</span></span><br><span class="line">) <span class="keyword">COMMENT</span> <span class="string">'äº‹åŠ¡æ¶ˆæ¯å†…å®¹è¡¨'</span>;</span><br></pre></td></tr></table></figure><p>å› ä¸ºæ­¤æ¨¡å—æœ‰å¯èƒ½æ‰©å±•å‡ºä¸€ä¸ªåå°ç®¡ç†æ¨¡å—ï¼Œæ‰€ä»¥è¦æŠŠæ¶ˆæ¯çš„ç®¡ç†å’ŒçŠ¶æ€ç›¸å…³å­—æ®µå’Œå¤§ä½“ç§¯çš„æ¶ˆæ¯å†…å®¹åˆ†åˆ«å­˜æ”¾åœ¨ä¸¤ä¸ªè¡¨ï¼Œä»è€Œé¿å…å¤§æ‰¹é‡æŸ¥è¯¢æ¶ˆæ¯è®°å½•çš„æ—¶å€™<code>MySQL</code>æœåŠ¡<code>IO</code>ä½¿ç”¨ç‡è¿‡é«˜çš„é—®é¢˜ï¼ˆè¿™æ˜¯å’Œä¸Šä¸€ä¸ªå…¬å¸çš„<code>DBA</code>å›¢é˜Ÿå•†è®¨åå¾—åˆ°çš„ä¸€ä¸ªæ¯”è¾ƒåˆç†çš„æ–¹æ¡ˆï¼‰ã€‚é¢„ç•™äº†ä¸¤ä¸ªä¸šåŠ¡å­—æ®µ<code>business_module</code>å’Œ<code>business_key</code>ç”¨äºæ ‡è¯†ä¸šåŠ¡æ¨¡å—å’Œä¸šåŠ¡é”®ï¼ˆä¸€èˆ¬æ˜¯å”¯ä¸€è¯†åˆ«å·ï¼Œä¾‹å¦‚è®¢å•å·ï¼‰ã€‚</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/202002/r-r-t-m-4.png" alt=""></p><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¦‚æœæœåŠ¡é€šè¿‡é…ç½®è‡ªè¡Œæå‰å£°æ˜é˜Ÿåˆ—å’Œäº¤æ¢å™¨çš„ç»‘å®šå…³ç³»ï¼Œé‚£ä¹ˆå‘é€<code>RabbitMQ</code>æ¶ˆæ¯çš„æ—¶å€™å…¶å®åªä¾èµ–äº<code>exchangeName</code>å’Œ<code>routingKey</code>ä¸¤ä¸ªå­—æ®µï¼ˆ<code>header</code>ç±»å‹çš„äº¤æ¢å™¨æ˜¯ç‰¹æ®Šçš„ï¼Œä¹Ÿæ¯”è¾ƒå°‘ç”¨ï¼Œè¿™é‡Œæš‚æ—¶ä¸ç”¨è€ƒè™‘ï¼‰ï¼Œè€ƒè™‘åˆ°æœåŠ¡å¯èƒ½ä¼šé—æ¼å£°æ˜æ“ä½œï¼Œå‘é€æ¶ˆæ¯çš„æ—¶å€™ä¼šåŸºäºé˜Ÿåˆ—è¿›è¡Œé¦–æ¬¡ç»‘å®šå£°æ˜å¹¶ä¸”ç¼“å­˜ç›¸å…³çš„ä¿¡æ¯ï¼ˆ<code>RabbitMQ</code>ä¸­çš„é˜Ÿåˆ—-äº¤æ¢å™¨ç»‘å®šå£°æ˜åªè¦æ¯æ¬¡å£°æ˜ç»‘å®šå…³ç³»çš„å‚æ•°ä¸€è‡´ï¼Œåˆ™ä¸ä¼šæŠ›å‡ºå¼‚å¸¸ï¼‰ã€‚</p><h3 id="æ–¹æ¡ˆä»£ç è®¾è®¡">æ–¹æ¡ˆä»£ç è®¾è®¡</h3><p>ä¸‹é¢çš„æ–¹æ¡ˆè®¾è®¡æè¿°ä¸­ï¼Œæš‚æ—¶å¿½ç•¥äº†æ¶ˆæ¯äº‹åŠ¡ç®¡ç†åå°çš„<code>API</code>è®¾è®¡ï¼Œè¿™äº›å¯ä»¥åœ¨åæœŸè¡¥å……ã€‚</p><p>å®šä¹‰è´«è¡€æ¨¡å‹å®ä½“ç±»<code>TransactionalMessage</code>å’Œ<code>TransactionalMessageContent</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionalMessage</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> LocalDateTime createTime;</span><br><span class="line">    <span class="keyword">private</span> LocalDateTime editTime;</span><br><span class="line">    <span class="keyword">private</span> String creator;</span><br><span class="line">    <span class="keyword">private</span> String editor;</span><br><span class="line">    <span class="keyword">private</span> Integer deleted;</span><br><span class="line">    <span class="keyword">private</span> Integer currentRetryTimes;</span><br><span class="line">    <span class="keyword">private</span> Integer maxRetryTimes;</span><br><span class="line">    <span class="keyword">private</span> String queueName;</span><br><span class="line">    <span class="keyword">private</span> String exchangeName;</span><br><span class="line">    <span class="keyword">private</span> String exchangeType;</span><br><span class="line">    <span class="keyword">private</span> String routingKey;</span><br><span class="line">    <span class="keyword">private</span> String businessModule;</span><br><span class="line">    <span class="keyword">private</span> String businessKey;</span><br><span class="line">    <span class="keyword">private</span> LocalDateTime nextScheduleTime;</span><br><span class="line">    <span class="keyword">private</span> Integer messageStatus;</span><br><span class="line">    <span class="keyword">private</span> Long initBackoff;</span><br><span class="line">    <span class="keyword">private</span> Integer backoffFactor;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionalMessageContent</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="keyword">private</span> Long messageId;</span><br><span class="line">    <span class="keyword">private</span> String content;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åå®šä¹‰<code>dao</code>æ¥å£ï¼ˆè¿™é‡Œæš‚æ—¶ä¸å±•å¼€å®ç°çš„ç»†èŠ‚ä»£ç ï¼Œå­˜å‚¨ä½¿ç”¨<code>MySQL</code>ï¼Œå¦‚æœè¦æ›¿æ¢ä¸ºå…¶ä»–ç±»å‹çš„æ•°æ®åº“ï¼Œåªéœ€è¦ä½¿ç”¨ä¸åŒçš„å®ç°å³å¯ï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TransactionalMessageDao</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">insertSelective</span><span class="params">(TransactionalMessage record)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">updateStatusSelective</span><span class="params">(TransactionalMessage record)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">List&lt;TransactionalMessage&gt; <span class="title">queryPendingCompensationRecords</span><span class="params">(LocalDateTime minScheduleTime,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                               LocalDateTime maxScheduleTime,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                               <span class="keyword">int</span> limit)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TransactionalMessageContentDao</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">insert</span><span class="params">(TransactionalMessageContent record)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">List&lt;TransactionalMessageContent&gt; <span class="title">queryByMessageIds</span><span class="params">(String messageIds)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ç€å®šä¹‰äº‹åŠ¡æ¶ˆæ¯æœåŠ¡æ¥å£<code>TransactionalMessageService</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¯¹å¤–æä¾›çš„æœåŠ¡ç±»æ¥å£</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TransactionalMessageService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">sendTransactionalMessage</span><span class="params">(Destination destination, TxMessage message)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> ExchangeType &#123;</span><br><span class="line"></span><br><span class="line">    FANOUT(<span class="string">"fanout"</span>),</span><br><span class="line"></span><br><span class="line">    DIRECT(<span class="string">"direct"</span>),</span><br><span class="line"></span><br><span class="line">    TOPIC(<span class="string">"topic"</span>),</span><br><span class="line"></span><br><span class="line">    DEFAULT(<span class="string">""</span>),</span><br><span class="line"></span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String type;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‘é€æ¶ˆæ¯çš„ç›®çš„åœ°</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Destination</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">ExchangeType <span class="title">exchangeType</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">queueName</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">exchangeName</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">routingKey</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultDestination</span> <span class="keyword">implements</span> <span class="title">Destination</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> ExchangeType exchangeType;</span><br><span class="line">    <span class="keyword">private</span> String queueName;</span><br><span class="line">    <span class="keyword">private</span> String exchangeName;</span><br><span class="line">    <span class="keyword">private</span> String routingKey;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ExchangeType <span class="title">exchangeType</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> exchangeType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">queueName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> queueName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">exchangeName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> exchangeName;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">routingKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> routingKey;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// äº‹åŠ¡æ¶ˆæ¯</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">TxMessage</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">businessModule</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">businessKey</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">content</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Builder</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultTxMessage</span> <span class="keyword">implements</span> <span class="title">TxMessage</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String businessModule;</span><br><span class="line">    <span class="keyword">private</span> String businessKey;</span><br><span class="line">    <span class="keyword">private</span> String content;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">businessModule</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> businessModule;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">businessKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> businessKey;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">content</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> content;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¶ˆæ¯çŠ¶æ€</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> TxMessageStatus &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æˆåŠŸ</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    SUCCESS(<span class="number">1</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¾…å¤„ç†</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    PENDING(<span class="number">0</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å¤„ç†å¤±è´¥</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    FAIL(-<span class="number">1</span>),</span><br><span class="line"></span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Integer status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>TransactionalMessageService</code>çš„å®ç°ç±»æ˜¯äº‹åŠ¡æ¶ˆæ¯çš„æ ¸å¿ƒåŠŸèƒ½å®ç°ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RabbitTransactionalMessageService</span> <span class="keyword">implements</span> <span class="title">TransactionalMessageService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> AmqpAdmin amqpAdmin;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TransactionalMessageManagementService managementService;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ConcurrentMap&lt;String, Boolean&gt; QUEUE_ALREADY_DECLARE = <span class="keyword">new</span> ConcurrentHashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendTransactionalMessage</span><span class="params">(Destination destination, TxMessage message)</span> </span>&#123;</span><br><span class="line">        String queueName = destination.queueName();</span><br><span class="line">        String exchangeName = destination.exchangeName();</span><br><span class="line">        String routingKey = destination.routingKey();</span><br><span class="line">        ExchangeType exchangeType = destination.exchangeType();</span><br><span class="line">        <span class="comment">// åŸå­æ€§çš„é¢„å£°æ˜</span></span><br><span class="line">        QUEUE_ALREADY_DECLARE.computeIfAbsent(queueName, k -&gt; &#123;</span><br><span class="line">            Queue queue = <span class="keyword">new</span> Queue(queueName);</span><br><span class="line">            amqpAdmin.declareQueue(queue);</span><br><span class="line">            Exchange exchange = <span class="keyword">new</span> CustomExchange(exchangeName, exchangeType.getType());</span><br><span class="line">            amqpAdmin.declareExchange(exchange);</span><br><span class="line">            Binding binding = BindingBuilder.bind(queue).to(exchange).with(routingKey).noargs();</span><br><span class="line">            amqpAdmin.declareBinding(binding);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;);</span><br><span class="line">        TransactionalMessage record = <span class="keyword">new</span> TransactionalMessage();</span><br><span class="line">        record.setQueueName(queueName);</span><br><span class="line">        record.setExchangeName(exchangeName);</span><br><span class="line">        record.setExchangeType(exchangeType.getType());</span><br><span class="line">        record.setRoutingKey(routingKey);</span><br><span class="line">        record.setBusinessModule(message.businessModule());</span><br><span class="line">        record.setBusinessKey(message.businessKey());</span><br><span class="line">        String content = message.content();</span><br><span class="line">        <span class="comment">// ä¿å­˜äº‹åŠ¡æ¶ˆæ¯è®°å½•</span></span><br><span class="line">        managementService.saveTransactionalMessageRecord(record, content);</span><br><span class="line">        <span class="comment">// æ³¨å†Œäº‹åŠ¡åŒæ­¥å™¨</span></span><br><span class="line">        TransactionSynchronizationManager.registerSynchronization(<span class="keyword">new</span> TransactionSynchronizationAdapter() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterCommit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                managementService.sendMessageSync(record, content);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¶ˆæ¯è®°å½•çŠ¶æ€å’Œå†…å®¹æŒä¹…åŒ–çš„ç®¡ç†ç»Ÿä¸€æ”¾åœ¨<code>TransactionalMessageManagementService</code>ä¸­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionalMessageManagementService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TransactionalMessageDao messageDao;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TransactionalMessageContentDao contentDao;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RabbitTemplate rabbitTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> LocalDateTime END = LocalDateTime.of(<span class="number">2999</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> DEFAULT_INIT_BACKOFF = <span class="number">10L</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_BACKOFF_FACTOR = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_MAX_RETRY_TIMES = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> LIMIT = <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveTransactionalMessageRecord</span><span class="params">(TransactionalMessage record, String content)</span> </span>&#123;</span><br><span class="line">        record.setMessageStatus(TxMessageStatus.PENDING.getStatus());</span><br><span class="line">        record.setNextScheduleTime(calculateNextScheduleTime(LocalDateTime.now(), DEFAULT_INIT_BACKOFF,</span><br><span class="line">                DEFAULT_BACKOFF_FACTOR, <span class="number">0</span>));</span><br><span class="line">        record.setCurrentRetryTimes(<span class="number">0</span>);</span><br><span class="line">        record.setInitBackoff(DEFAULT_INIT_BACKOFF);</span><br><span class="line">        record.setBackoffFactor(DEFAULT_BACKOFF_FACTOR);</span><br><span class="line">        record.setMaxRetryTimes(DEFAULT_MAX_RETRY_TIMES);</span><br><span class="line">        messageDao.insertSelective(record);</span><br><span class="line">        TransactionalMessageContent messageContent = <span class="keyword">new</span> TransactionalMessageContent();</span><br><span class="line">        messageContent.setContent(content);</span><br><span class="line">        messageContent.setMessageId(record.getId());</span><br><span class="line">        contentDao.insert(messageContent);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendMessageSync</span><span class="params">(TransactionalMessage record, String content)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            rabbitTemplate.convertAndSend(record.getExchangeName(), record.getRoutingKey(), content);</span><br><span class="line">            <span class="keyword">if</span> (log.isDebugEnabled()) &#123;</span><br><span class="line">                log.debug(<span class="string">"å‘é€æ¶ˆæ¯æˆåŠŸ,ç›®æ ‡é˜Ÿåˆ—:&#123;&#125;,æ¶ˆæ¯å†…å®¹:&#123;&#125;"</span>, record.getQueueName(), content);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// æ ‡è®°æˆåŠŸ</span></span><br><span class="line">            markSuccess(record);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="comment">// æ ‡è®°å¤±è´¥</span></span><br><span class="line">            markFail(record, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">markSuccess</span><span class="params">(TransactionalMessage record)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// æ ‡è®°ä¸‹ä¸€æ¬¡æ‰§è¡Œæ—¶é—´ä¸ºæœ€å¤§å€¼</span></span><br><span class="line">        record.setNextScheduleTime(END);</span><br><span class="line">        record.setCurrentRetryTimes(record.getCurrentRetryTimes().compareTo(record.getMaxRetryTimes()) &gt;= <span class="number">0</span> ?</span><br><span class="line">                record.getMaxRetryTimes() : record.getCurrentRetryTimes() + <span class="number">1</span>);</span><br><span class="line">        record.setMessageStatus(TxMessageStatus.SUCCESS.getStatus());</span><br><span class="line">        record.setEditTime(LocalDateTime.now());</span><br><span class="line">        messageDao.updateStatusSelective(record);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">markFail</span><span class="params">(TransactionalMessage record, Exception e)</span> </span>&#123;</span><br><span class="line">        log.error(<span class="string">"å‘é€æ¶ˆæ¯å¤±è´¥,ç›®æ ‡é˜Ÿåˆ—:&#123;&#125;"</span>, record.getQueueName(), e);</span><br><span class="line">        record.setCurrentRetryTimes(record.getCurrentRetryTimes().compareTo(record.getMaxRetryTimes()) &gt;= <span class="number">0</span> ?</span><br><span class="line">                record.getMaxRetryTimes() : record.getCurrentRetryTimes() + <span class="number">1</span>);</span><br><span class="line">        <span class="comment">// è®¡ç®—ä¸‹ä¸€æ¬¡çš„æ‰§è¡Œæ—¶é—´</span></span><br><span class="line">        LocalDateTime nextScheduleTime = calculateNextScheduleTime(</span><br><span class="line">                record.getNextScheduleTime(),</span><br><span class="line">                record.getInitBackoff(),</span><br><span class="line">                record.getBackoffFactor(),</span><br><span class="line">                record.getCurrentRetryTimes()</span><br><span class="line">        );</span><br><span class="line">        record.setNextScheduleTime(nextScheduleTime);</span><br><span class="line">        record.setMessageStatus(TxMessageStatus.FAIL.getStatus());</span><br><span class="line">        record.setEditTime(LocalDateTime.now());</span><br><span class="line">        messageDao.updateStatusSelective(record);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è®¡ç®—ä¸‹ä¸€æ¬¡æ‰§è¡Œæ—¶é—´</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> base          åŸºç¡€æ—¶é—´</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> initBackoff   é€€é¿åŸºå‡†å€¼</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> backoffFactor é€€é¿æŒ‡æ•°</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> round         è½®æ•°</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> LocalDateTime</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> LocalDateTime <span class="title">calculateNextScheduleTime</span><span class="params">(LocalDateTime base,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                    <span class="keyword">long</span> initBackoff,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                    <span class="keyword">long</span> backoffFactor,</span></span></span><br><span class="line"><span class="function"><span class="params">                                                    <span class="keyword">long</span> round)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">double</span> delta = initBackoff * Math.pow(backoffFactor, round);</span><br><span class="line">        <span class="keyword">return</span> base.plusSeconds((<span class="keyword">long</span>) delta);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ¨é€è¡¥å¿ - é‡Œé¢çš„å‚æ•°åº”è¯¥æ ¹æ®å®é™…åœºæ™¯å®šåˆ¶</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processPendingCompensationRecords</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// æ—¶é—´çš„å³å€¼ä¸ºå½“å‰æ—¶é—´å‡å»é€€é¿åˆå§‹å€¼ï¼Œè¿™é‡Œé¢„é˜²æŠŠåˆšä¿å­˜çš„æ¶ˆæ¯ä¹Ÿæ¨é€äº†</span></span><br><span class="line">        LocalDateTime max = LocalDateTime.now().plusSeconds(-DEFAULT_INIT_BACKOFF);</span><br><span class="line">        <span class="comment">// æ—¶é—´çš„å·¦å€¼ä¸ºå³å€¼å‡å»1å°æ—¶</span></span><br><span class="line">        LocalDateTime min = max.plusHours(-<span class="number">1</span>);</span><br><span class="line">        Map&lt;Long, TransactionalMessage&gt; collect = messageDao.queryPendingCompensationRecords(min, max, LIMIT)</span><br><span class="line">                .stream()</span><br><span class="line">                .collect(Collectors.toMap(TransactionalMessage::getId, x -&gt; x));</span><br><span class="line">        <span class="keyword">if</span> (!collect.isEmpty()) &#123;</span><br><span class="line">            StringJoiner joiner = <span class="keyword">new</span> StringJoiner(<span class="string">","</span>, <span class="string">"("</span>, <span class="string">")"</span>);</span><br><span class="line">            collect.keySet().forEach(x -&gt; joiner.add(x.toString()));</span><br><span class="line">            contentDao.queryByMessageIds(joiner.toString())</span><br><span class="line">                    .forEach(item -&gt; &#123;</span><br><span class="line">                        TransactionalMessage message = collect.get(item.getMessageId());</span><br><span class="line">                        sendMessageSync(message, item.getContent());</span><br><span class="line">                    &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰ä¸€ç‚¹å°šå¾…ä¼˜åŒ–ï¼šæ›´æ–°äº‹åŠ¡æ¶ˆæ¯è®°å½•çŠ¶æ€çš„æ–¹æ³•å¯ä»¥ä¼˜åŒ–ä¸ºæ‰¹é‡æ›´æ–°ï¼Œåœ¨<code>limit</code>æ¯”è¾ƒå¤§çš„æ—¶å€™ï¼Œæ‰¹é‡æ›´æ–°çš„æ•ˆç‡ä¼šæ›´é«˜ã€‚</p><p>æœ€åæ˜¯å®šæ—¶ä»»åŠ¡çš„é…ç½®ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableScheduling</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ScheduleJobAutoConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TransactionalMessageManagementService managementService;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¿™é‡Œç”¨çš„æ˜¯æœ¬åœ°çš„Redis,å®é™…ä¸Šè¦åšæˆé…ç½®</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RedissonClient redisson = Redisson.create();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Scheduled</span>(fixedDelay = <span class="number">10000</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transactionalMessageCompensationTask</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        RLock lock = redisson.getLock(<span class="string">"transactionalMessageCompensationTask"</span>);</span><br><span class="line">        <span class="comment">// ç­‰å¾…æ—¶é—´5ç§’,é¢„æœŸ300ç§’æ‰§è¡Œå®Œæ¯•,è¿™ä¸¤ä¸ªå€¼éœ€è¦æŒ‰ç…§å®é™…åœºæ™¯å®šåˆ¶</span></span><br><span class="line">        <span class="keyword">boolean</span> tryLock = lock.tryLock(<span class="number">5</span>, <span class="number">300</span>, TimeUnit.SECONDS);</span><br><span class="line">        <span class="keyword">if</span> (tryLock) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">                log.info(<span class="string">"å¼€å§‹æ‰§è¡Œäº‹åŠ¡æ¶ˆæ¯æ¨é€è¡¥å¿å®šæ—¶ä»»åŠ¡..."</span>);</span><br><span class="line">                managementService.processPendingCompensationRecords();</span><br><span class="line">                <span class="keyword">long</span> end = System.currentTimeMillis();</span><br><span class="line">                <span class="keyword">long</span> delta = end - start;</span><br><span class="line">                <span class="comment">// ä»¥é˜²é”è¿‡æ—©é‡Šæ”¾</span></span><br><span class="line">                <span class="keyword">if</span> (delta &lt; <span class="number">5000</span>) &#123;</span><br><span class="line">                    Thread.sleep(<span class="number">5000</span> - delta);</span><br><span class="line">                &#125;</span><br><span class="line">                log.info(<span class="string">"æ‰§è¡Œäº‹åŠ¡æ¶ˆæ¯æ¨é€è¡¥å¿å®šæ—¶ä»»åŠ¡å®Œæ¯•,è€—æ—¶:&#123;&#125; ms..."</span>, end - start);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                lock.unlock();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŸºæœ¬ä»£ç ç¼–å†™å®Œï¼Œæ•´ä¸ªé¡¹ç›®çš„ç»“æ„å¦‚ä¸‹ï¼š</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/202002/r-r-t-m-7.png" alt=""></p><p>æœ€åæ·»åŠ ä¸¤ä¸ªæµ‹è¯•ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MockBusinessRunner</span> <span class="keyword">implements</span> <span class="title">CommandLineRunner</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> MockBusinessService mockBusinessService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(String... args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        mockBusinessService.saveOrder();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MockBusinessService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> JdbcTemplate jdbcTemplate;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> TransactionalMessageService transactionalMessageService;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ObjectMapper objectMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Transactional</span>(rollbackFor = Exception<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">public</span> <span class="title">void</span> <span class="title">saveOrder</span>() <span class="title">throws</span> <span class="title">Exception</span> </span>&#123;</span><br><span class="line">        String orderId = UUID.randomUUID().toString();</span><br><span class="line">        BigDecimal amount = BigDecimal.valueOf(<span class="number">100L</span>);</span><br><span class="line">        Map&lt;String, Object&gt; message = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">        message.put(<span class="string">"orderId"</span>, orderId);</span><br><span class="line">        message.put(<span class="string">"amount"</span>, amount);</span><br><span class="line">        jdbcTemplate.update(<span class="string">"INSERT INTO t_order(order_id,amount) VALUES (?,?)"</span>, p -&gt; &#123;</span><br><span class="line">            p.setString(<span class="number">1</span>, orderId);</span><br><span class="line">            p.setBigDecimal(<span class="number">2</span>, amount);</span><br><span class="line">        &#125;);</span><br><span class="line">        String content = objectMapper.writeValueAsString(message);</span><br><span class="line">        transactionalMessageService.sendTransactionalMessage(</span><br><span class="line">                DefaultDestination.builder()</span><br><span class="line">                        .exchangeName(<span class="string">"tm.test.exchange"</span>)</span><br><span class="line">                        .queueName(<span class="string">"tm.test.queue"</span>)</span><br><span class="line">                        .routingKey(<span class="string">"tm.test.key"</span>)</span><br><span class="line">                        .exchangeType(ExchangeType.DIRECT)</span><br><span class="line">                        .build(),</span><br><span class="line">                DefaultTxMessage.builder()</span><br><span class="line">                        .businessKey(orderId)</span><br><span class="line">                        .businessModule(<span class="string">"SAVE_ORDER"</span>)</span><br><span class="line">                        .content(content)</span><br><span class="line">                        .build()</span><br><span class="line">        );</span><br><span class="line">        log.info(<span class="string">"ä¿å­˜è®¢å•:&#123;&#125;æˆåŠŸ..."</span>, orderId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŸæ¬¡æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2020-02-05 21:10:13.287  INFO 49556 --- [           main] club.throwable.cm.MockBusinessService    : ä¿å­˜è®¢å•:07a75323-460b-42cb-aa63-1a0a45ce19bfæˆåŠŸ...</span><br></pre></td></tr></table></figure><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/202002/r-r-t-m-8.png" alt=""></p><p>æ¨¡æ‹Ÿè®¢å•æ•°æ®æˆåŠŸä¿å­˜ï¼Œè€Œä¸”<code>RabbitMQ</code>æ¶ˆæ¯åœ¨äº‹åŠ¡æˆåŠŸæäº¤åæ­£å¸¸å‘é€åˆ°<code>RabbitMQ</code>æœåŠ¡ç«¯ä¸­ï¼Œå¦‚<code>RabbitMQ</code>æ§åˆ¶å°æ•°æ®æ‰€ç¤ºã€‚</p><h2 id="å°ç»“">å°ç»“</h2><p>äº‹åŠ¡æ¶ˆæ¯æ¨¡å—çš„è®¾è®¡ä»…ä»…æ˜¯ä½¿å¼‚æ­¥æ¶ˆæ¯æ¨é€è¿™ä¸ªåŠŸèƒ½å®ç°è¶‹å‘äºå®Œå¤‡ï¼Œå…¶å®ä¸€ä¸ªåˆç†çš„å¼‚æ­¥æ¶ˆæ¯äº¤äº’ç³»ç»Ÿï¼Œä¸€å®šä¼šæä¾›åŒæ­¥æŸ¥è¯¢æ¥å£ï¼Œè¿™ä¸€ç‚¹æ˜¯åŸºäºå¼‚æ­¥æ¶ˆæ¯æ²¡æœ‰å›è°ƒæˆ–è€…æ²¡æœ‰å“åº”çš„ç‰¹æ€§å¯¼è‡´çš„ã€‚ä¸€èˆ¬è€Œè¨€ï¼Œä¸€ä¸ªç³»ç»Ÿçš„ååé‡å’Œç³»ç»Ÿçš„å¼‚æ­¥åŒ–å¤„ç†å æ¯”æˆæ­£ç›¸å…³ï¼ˆè¿™ä¸€ç‚¹å¯ä»¥å‚è€ƒ<code>Amdahl's Law</code>ï¼‰ï¼Œæ‰€ä»¥åœ¨ç³»ç»Ÿæ¶æ„è®¾è®¡å®é™…ä¸­åº”è¯¥å°½å¯èƒ½ä½¿ç”¨å¼‚æ­¥äº¤äº’ï¼Œæé«˜ç³»ç»Ÿååé‡åŒæ—¶å‡å°‘åŒæ­¥é˜»å¡å¸¦æ¥çš„æ— è°“ç­‰å¾…ã€‚äº‹åŠ¡æ¶ˆæ¯æ¨¡å—å¯ä»¥æ‰©å±•å‡ºä¸€ä¸ªåå°ç®¡ç†ï¼Œç”šè‡³å¯ä»¥é…åˆ<code>Micrometer</code>ã€<code>Prometheus</code>å’Œ<code>Grafana</code>ä½“ç³»åšå®æ—¶æ•°æ®ç›‘æ§ã€‚</p><p>æœ¬æ–‡<code>demo</code>é¡¹ç›®ä»“åº“ï¼š<a href="https://github.com/zjcscut/framework-mesh/tree/master/rabbit-transactional-message" target="_blank" rel="noopener">rabbit-transactional-message</a></p><p><code>demo</code>å¿…é¡»æœ¬åœ°å®‰è£…<code>MySQL</code>ã€<code>Redis</code>å’Œ<code>RabbitMQ</code>æ‰èƒ½æ­£å¸¸å¯åŠ¨ï¼Œæœ¬åœ°å¿…é¡»æ–°å»ºä¸€ä¸ªæ•°æ®åº“å‘½å<code>local</code>ã€‚</p><p>ï¼ˆæœ¬æ–‡å®Œ c-5-d e-a-20200202 ç–«æƒ…ä¸¥é‡ï¼Œé©¬ä¸Šè¦å¼€å§‹åœ¨å®¶åŠå…¬ï¼Œå°‘å‡ºé—¨å¤šçœ‹ä¹¦ï¼‰</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰æ&quot;&gt;å‰æ&lt;/h2&gt;
&lt;p&gt;åˆ†å¸ƒå¼äº‹åŠ¡æ˜¯å¾®æœåŠ¡å®è·µä¸­ä¸€ä¸ªæ¯”è¾ƒæ£˜æ‰‹çš„é—®é¢˜ï¼Œåœ¨ç¬”è€…æ‰€å®æ–½çš„å¾®æœåŠ¡å®è·µæ–¹æ¡ˆä¸­ï¼Œéƒ½é‡‡ç”¨äº†æŠ˜ä¸­æˆ–è€…è§„é¿å¼ºä¸€è‡´æ€§çš„æ–¹æ¡ˆã€‚å‚è€ƒ&lt;code&gt;Ebay&lt;/code&gt;å¤šå¹´å‰æå‡ºçš„æœ¬åœ°æ¶ˆæ¯è¡¨æ–¹æ¡ˆï¼ŒåŸºäº&lt;code&gt;RabbitMQ&lt;/code&gt;å’Œ&lt;code&gt;MySQL&lt;/code&gt;ï¼ˆ&lt;code&gt;JDBC&lt;/code&gt;ï¼‰åšäº†è½»é‡çº§çš„å°è£…ï¼Œå®ç°äº†ä½å…¥ä¾µæ€§çš„äº‹åŠ¡æ¶ˆæ¯æ¨¡å—ã€‚æœ¬æ–‡çš„å†…å®¹å°±æ˜¯è¯¦ç»†åˆ†ææ•´ä¸ªæ–¹æ¡ˆçš„è®¾è®¡æ€è·¯å’Œå®æ–½ã€‚ç¯å¢ƒä¾èµ–å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;JDK1.8+&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;spring-boot-start-web:2.x.x&lt;/code&gt;ã€&lt;code&gt;spring-boot-start-jdbc:2.x.x&lt;/code&gt;ã€&lt;code&gt;spring-boot-start-amqp:2.x.x&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;HikariCP:3.x.x&lt;/code&gt;ï¼ˆ&lt;code&gt;spring-boot-start-jdbc&lt;/code&gt;è‡ªå¸¦ï¼‰ã€&lt;code&gt;mysql-connector-java:5.1.48&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;redisson:3.12.1&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
    
      <category term="In Action" scheme="http://throwable.club/blog/categories/In-Action/"/>
    
      <category term="Distributed Transaction" scheme="http://throwable.club/blog/categories/In-Action/Distributed-Transaction/"/>
    
    
      <category term="In Action" scheme="http://throwable.club/blog/tags/In-Action/"/>
    
      <category term="Distributed Transaction" scheme="http://throwable.club/blog/tags/Distributed-Transaction/"/>
    
  </entry>
  
  <entry>
    <title>ä»æºç ä¸Šç†è§£Nettyå¹¶å‘å·¥å…·-Promise</title>
    <link href="http://throwable.club/2020/01/23/netty-common-promise-source-code-usage/"/>
    <id>http://throwable.club/2020/01/23/netty-common-promise-source-code-usage/</id>
    <published>2020-01-23T15:34:42.000Z</published>
    <updated>2020-01-23T15:36:23.803Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰æ">å‰æ</h2><p>æœ€è¿‘ä¸€ç›´åœ¨çœ‹<code>Netty</code>ç›¸å…³çš„å†…å®¹ï¼Œä¹Ÿåœ¨ç¼–å†™ä¸€ä¸ªè½»é‡çº§çš„<code>RPC</code>æ¡†æ¶æ¥ç»ƒæ‰‹ï¼Œé€”ä¸­å‘ç°äº†<code>Netty</code>çš„æºç æœ‰å¾ˆå¤šäº®ç‚¹ï¼ŒæŸäº›å®ç°ç”šè‡³å¯ä»¥ç”¨<strong>è‹›åˆ»</strong>æ¥å½¢å®¹ã€‚å¦å¤–ï¼Œ<code>Netty</code>æä¾›çš„å·¥å…·ç±»ä¹Ÿæ˜¯ç›¸å½“ä¼˜ç§€ï¼Œå¯ä»¥å¼€ç®±å³ç”¨ã€‚è¿™é‡Œåˆ†æä¸€ä¸‹ä¸ªäººæ¯”è¾ƒå–œæ¬¢çš„é¢†åŸŸï¼Œå¹¶å‘æ–¹é¢çš„ä¸€ä¸ª<code>Netty</code>å·¥å…·æ¨¡å— - <code>Promise</code>ã€‚</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/202001/n-c-u-p-1.png" alt=""></p><p>ç¯å¢ƒç‰ˆæœ¬ï¼š</p><ul><li><code>Netty:4.1.44.Final</code></li><li><code>JDK1.8</code></li></ul><a id="more"></a><h2 id="Promiseç®€ä»‹">Promiseç®€ä»‹</h2><blockquote><p>Promiseï¼Œä¸­æ–‡ç¿»è¯‘ä¸ºæ‰¿è¯ºæˆ–è€…è®¸è¯ºï¼Œå«ä¹‰æ˜¯äººä¸äººä¹‹é—´ï¼Œä¸€ä¸ªäººå¯¹å¦ä¸€ä¸ªäººæ‰€è¯´çš„å…·æœ‰ä¸€å®šæ†§æ†¬çš„è¯ï¼Œä¸€èˆ¬æ˜¯å¯ä»¥å®ç°çš„ã€‚</p></blockquote><p><code>io.netty.util.concurrent.Promise</code>åœ¨æ³¨é‡Šä¸­åªæœ‰ä¸€å¥è¯ï¼š<strong>ç‰¹æ®Šçš„å¯å†™çš„</strong><code>io.netty.util.concurrent.Future</code>ï¼ˆ<code>Promise</code>æ¥å£æ˜¯<code>io.netty.util.concurrent.Future</code>çš„å­æ¥å£ï¼‰ã€‚è€Œ<code>io.netty.util.concurrent.Future</code>æ˜¯<code>java.util.concurrent.Future</code>çš„æ‰©å±•ï¼Œè¡¨ç¤º<strong>ä¸€ä¸ªå¼‚æ­¥æ“ä½œçš„ç»“æœ</strong>ã€‚æˆ‘ä»¬çŸ¥é“ï¼Œ<code>JDK</code>å¹¶å‘åŒ…ä¸­çš„<code>Future</code>æ˜¯ä¸å¯å†™ï¼Œä¹Ÿæ²¡æœ‰æä¾›å¯ç›‘å¬çš„å…¥å£ï¼ˆæ²¡æœ‰åº”ç”¨è§‚å¯Ÿè€…æ¨¡å¼ï¼‰ï¼Œè€Œ<code>Promise</code>å¾ˆå¥½åœ°å¼¥è¡¥äº†è¿™ä¸¤ä¸ªé—®é¢˜ã€‚å¦ä¸€æ–¹é¢ä»ç»§æ‰¿å…³ç³»æ¥çœ‹ï¼Œ<code>DefaultPromise</code>æ˜¯è¿™äº›æ¥å£çš„æœ€ç»ˆå®ç°ç±»ï¼Œæ‰€ä»¥åˆ†ææºç çš„æ—¶å€™éœ€è¦æŠŠé‡å¿ƒæ”¾åœ¨<code>DefaultPromise</code>ç±»ã€‚ä¸€èˆ¬ä¸€ä¸ªæ¨¡å—æä¾›çš„åŠŸèƒ½éƒ½ç”±æ¥å£å®šä¹‰ï¼Œè¿™é‡Œåˆ†æä¸€ä¸‹ä¸¤ä¸ªæ¥å£çš„åŠŸèƒ½åˆ—è¡¨ï¼š</p><ul><li><code>io.netty.util.concurrent.Promise</code></li><li><code>io.netty.util.concurrent.Future</code></li></ul><p>å…ˆçœ‹<code>io.netty.util.concurrent.Future</code>æ¥å£ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Future</span>&lt;<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">java</span>.<span class="title">util</span>.<span class="title">concurrent</span>.<span class="title">Future</span>&lt;<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// I/Oæ“ä½œæ˜¯å¦æ‰§è¡ŒæˆåŠŸ</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isSuccess</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ‡è®°æ˜¯å¦å¯ä»¥é€šè¿‡ä¸‹é¢çš„cancel(boolean mayInterruptIfRunning)å–æ¶ˆI/Oæ“ä½œ</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isCancellable</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿”å›I/Oæ“ä½œçš„å¼‚å¸¸å®ä¾‹ - å¦‚æœI/Oæ“ä½œæœ¬èº«æ˜¯æˆåŠŸçš„ï¼Œæ­¤æ–¹æ³•è¿”å›null</span></span><br><span class="line">    <span class="function">Throwable <span class="title">cause</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸ºå½“å‰Futureå®ä¾‹æ·»åŠ ç›‘å¬Futureæ“ä½œå®Œæˆçš„ç›‘å¬å™¨ - isDone()æ–¹æ³•æ¿€æ´»ä¹‹åæ‰€æœ‰ç›‘å¬å™¨å®ä¾‹ä¼šå¾—åˆ°å›è°ƒ</span></span><br><span class="line">    <span class="function">Future&lt;V&gt; <span class="title">addListener</span><span class="params">(GenericFutureListener&lt;? extends Future&lt;? <span class="keyword">super</span> V&gt;&gt; listener)</span></span>;</span><br><span class="line">    <span class="function">Future&lt;V&gt; <span class="title">addListeners</span><span class="params">(GenericFutureListener&lt;? extends Future&lt;? <span class="keyword">super</span> V&gt;&gt;... listeners)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä¸ºå½“å‰Futureç§»é™¤ç›‘å¬Futureæ“ä½œå®Œæˆçš„ç›‘å¬å™¨</span></span><br><span class="line">    <span class="function">Future&lt;V&gt; <span class="title">removeListener</span><span class="params">(GenericFutureListener&lt;? extends Future&lt;? <span class="keyword">super</span> V&gt;&gt; listener)</span></span>;</span><br><span class="line">    <span class="function">Future&lt;V&gt; <span class="title">removeListeners</span><span class="params">(GenericFutureListener&lt;? extends Future&lt;? <span class="keyword">super</span> V&gt;&gt;... listeners)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŒæ­¥ç­‰å¾…Futureå®Œæˆå¾—åˆ°æœ€ç»ˆç»“æœï¼ˆæˆåŠŸï¼‰æˆ–è€…æŠ›å‡ºå¼‚å¸¸ï¼ˆå¤±è´¥ï¼‰ï¼Œå“åº”ä¸­æ–­</span></span><br><span class="line">    <span class="function">Future&lt;V&gt; <span class="title">sync</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åŒæ­¥ç­‰å¾…Futureå®Œæˆå¾—åˆ°æœ€ç»ˆç»“æœï¼ˆæˆåŠŸï¼‰æˆ–è€…æŠ›å‡ºå¼‚å¸¸ï¼ˆå¤±è´¥ï¼‰ï¼Œä¸å“åº”ä¸­æ–­</span></span><br><span class="line">    <span class="function">Future&lt;V&gt; <span class="title">syncUninterruptibly</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç­‰å¾…Futureå®Œæˆï¼Œå“åº”ä¸­æ–­</span></span><br><span class="line">    <span class="function">Future&lt;V&gt; <span class="title">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç­‰å¾…Futureå®Œæˆï¼Œä¸å“åº”ä¸­æ–­</span></span><br><span class="line">    <span class="function">Future&lt;V&gt; <span class="title">awaitUninterruptibly</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¸¦è¶…æ—¶æ—¶é™çš„ç­‰å¾…Futureå®Œæˆï¼Œå“åº”ä¸­æ–­</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">await</span><span class="params">(<span class="keyword">long</span> timeout, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">await</span><span class="params">(<span class="keyword">long</span> timeoutMillis)</span> <span class="keyword">throws</span> InterruptedException</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¸¦è¶…æ—¶æ—¶é™çš„ç­‰å¾…Futureå®Œæˆï¼Œä¸å“åº”ä¸­æ–­</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">awaitUninterruptibly</span><span class="params">(<span class="keyword">long</span> timeout, TimeUnit unit)</span></span>;</span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">awaitUninterruptibly</span><span class="params">(<span class="keyword">long</span> timeoutMillis)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// éé˜»å¡é©¬ä¸Šè¿”å›Futureçš„ç»“æœï¼Œå¦‚æœFutureæœªå®Œæˆï¼Œæ­¤æ–¹æ³•ä¸€å®šè¿”å›nullï¼›æœ‰äº›åœºæ™¯ä¸‹å¦‚æœFutureæˆåŠŸè·å–åˆ°çš„ç»“æœæ˜¯nullåˆ™éœ€è¦äºŒæ¬¡æ£€æŸ¥isDone()æ–¹æ³•æ˜¯å¦ä¸ºtrue</span></span><br><span class="line">    <span class="function">V <span class="title">getNow</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å–æ¶ˆå½“å‰Futureå®ä¾‹çš„æ‰§è¡Œï¼Œå¦‚æœå–æ¶ˆæˆåŠŸä¼šæŠ›å‡ºCancellationExceptionå¼‚å¸¸</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">cancel</span><span class="params">(<span class="keyword">boolean</span> mayInterruptIfRunning)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>sync()</code>å’Œ<code>await()</code>æ–¹æ³•ç±»ä¼¼ï¼Œåªæ˜¯<code>sync()</code>ä¼šæ£€æŸ¥å¼‚å¸¸æ‰§è¡Œçš„æƒ…å†µï¼Œä¸€æ—¦å‘ç°æ‰§è¡Œå¼‚å¸¸é©¬ä¸ŠæŠŠå¼‚å¸¸å®ä¾‹åŒ…è£…æŠ›å‡ºï¼Œè€Œ<code>await()</code>æ–¹æ³•å¯¹å¼‚å¸¸æ— æ„ŸçŸ¥ã€‚</p><p>æ¥ç€çœ‹<code>io.netty.util.concurrent.Promise</code>æ¥å£ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Promise</span>&lt;<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">Future</span>&lt;<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">// æ ‡è®°å½“å‰FutureæˆåŠŸï¼Œè®¾ç½®ç»“æœï¼Œå¦‚æœè®¾ç½®æˆåŠŸï¼Œåˆ™é€šçŸ¥æ‰€æœ‰çš„ç›‘å¬å™¨ï¼Œå¦‚æœFutureå·²ç»æˆåŠŸæˆ–è€…å¤±è´¥ï¼Œåˆ™æŠ›å‡ºIllegalStateException</span></span><br><span class="line">    <span class="function">Promise&lt;V&gt; <span class="title">setSuccess</span><span class="params">(V result)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ‡è®°å½“å‰FutureæˆåŠŸï¼Œè®¾ç½®ç»“æœï¼Œå¦‚æœè®¾ç½®æˆåŠŸï¼Œåˆ™é€šçŸ¥æ‰€æœ‰çš„ç›‘å¬å™¨å¹¶ä¸”è¿”å›trueï¼Œå¦åˆ™è¿”å›false</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">trySuccess</span><span class="params">(V result)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ‡è®°å½“å‰Futureå¤±è´¥ï¼Œè®¾ç½®ç»“æœä¸ºå¼‚å¸¸å®ä¾‹ï¼Œå¦‚æœè®¾ç½®æˆåŠŸï¼Œåˆ™é€šçŸ¥æ‰€æœ‰çš„ç›‘å¬å™¨ï¼Œå¦‚æœFutureå·²ç»æˆåŠŸæˆ–è€…å¤±è´¥ï¼Œåˆ™æŠ›å‡ºIllegalStateException</span></span><br><span class="line">    <span class="function">Promise&lt;V&gt; <span class="title">setFailure</span><span class="params">(Throwable cause)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ‡è®°å½“å‰Futureå¤±è´¥ï¼Œè®¾ç½®ç»“æœä¸ºå¼‚å¸¸å®ä¾‹ï¼Œå¦‚æœè®¾ç½®æˆåŠŸï¼Œåˆ™é€šçŸ¥æ‰€æœ‰çš„ç›‘å¬å™¨å¹¶ä¸”è¿”å›trueï¼Œå¦åˆ™è¿”å›false</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">tryFailure</span><span class="params">(Throwable cause)</span></span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ ‡è®°å½“å‰çš„Promiseå®ä¾‹ä¸ºä¸å¯å–æ¶ˆï¼Œè®¾ç½®æˆåŠŸè¿”å›trueï¼Œå¦åˆ™è¿”å›false</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">setUncancellable</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸‹é¢çš„æ–¹æ³•å’Œio.netty.util.concurrent.Futureä¸­çš„æ–¹æ³•åŸºæœ¬ä¸€è‡´ï¼Œåªæ˜¯ä¿®æ”¹äº†è¿”å›ç±»å‹ä¸ºPromise</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function">Promise&lt;V&gt; <span class="title">addListener</span><span class="params">(GenericFutureListener&lt;? extends Future&lt;? <span class="keyword">super</span> V&gt;&gt; listener)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function">Promise&lt;V&gt; <span class="title">addListeners</span><span class="params">(GenericFutureListener&lt;? extends Future&lt;? <span class="keyword">super</span> V&gt;&gt;... listeners)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function">Promise&lt;V&gt; <span class="title">removeListener</span><span class="params">(GenericFutureListener&lt;? extends Future&lt;? <span class="keyword">super</span> V&gt;&gt; listener)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function">Promise&lt;V&gt; <span class="title">removeListeners</span><span class="params">(GenericFutureListener&lt;? extends Future&lt;? <span class="keyword">super</span> V&gt;&gt;... listeners)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function">Promise&lt;V&gt; <span class="title">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function">Promise&lt;V&gt; <span class="title">awaitUninterruptibly</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function">Promise&lt;V&gt; <span class="title">sync</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function">Promise&lt;V&gt; <span class="title">syncUninterruptibly</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°æ­¤ï¼Œ<code>Promise</code>æ¥å£çš„æ‰€æœ‰åŠŸèƒ½éƒ½åˆ†æå®Œæ¯•ï¼Œæ¥ä¸‹æ¥ä»æºç è§’åº¦è¯¦ç»†åˆ†æ<code>Promise</code>çš„å®ç°ã€‚</p><h2 id="Promiseæºç å®ç°">Promiseæºç å®ç°</h2><p><code>Promise</code>çš„å®ç°ç±»ä¸º<code>io.netty.util.concurrent.DefaultPromise</code>ï¼ˆå…¶å®<code>DefaultPromise</code>è¿˜æœ‰å¾ˆå¤šå­ç±»ï¼ŒæŸäº›å®ç°æ˜¯ä¸ºäº†å®šåˆ¶ç‰¹å®šçš„åœºæ™¯åšäº†æ‰©å±•ï¼‰ï¼Œè€Œ<code>DefaultPromise</code>ç»§æ‰¿è‡ª<code>io.netty.util.concurrent.AbstractFuture</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">AbstractFuture</span>&lt;<span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">Future</span>&lt;<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ°¸ä¹…é˜»å¡ç­‰å¾…è·å–ç»“æœçš„æ–¹æ³•</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, ExecutionException </span>&#123;</span><br><span class="line">        <span class="comment">// è°ƒç”¨å“åº”ä¸­æ–­çš„æ°¸ä¹…ç­‰å¾…æ–¹æ³•è¿›è¡Œé˜»å¡</span></span><br><span class="line">        await();</span><br><span class="line">        <span class="comment">// ä»æ°¸ä¹…é˜»å¡ä¸­å”¤é†’åï¼Œå…ˆåˆ¤æ–­Futureæ˜¯å¦æ‰§è¡Œå¼‚å¸¸</span></span><br><span class="line">        Throwable cause = cause();</span><br><span class="line">        <span class="keyword">if</span> (cause == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// å¼‚å¸¸ä¸ºç©ºè¯´æ˜æ‰§è¡ŒæˆåŠŸï¼Œè°ƒç”¨getNow()æ–¹æ³•è¿”å›ç»“æœ</span></span><br><span class="line">            <span class="keyword">return</span> getNow();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¼‚å¸¸ä¸ºç©ºä¸ä¸ºç©ºï¼Œè¿™é‡ŒåŒºåˆ†ç‰¹å®šçš„å–æ¶ˆå¼‚å¸¸åˆ™è½¬æ¢ä¸ºCancellationExceptionæŠ›å‡º</span></span><br><span class="line">        <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> CancellationException) &#123;</span><br><span class="line">            <span class="keyword">throw</span> (CancellationException) cause;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// éå–æ¶ˆå¼‚å¸¸çš„å…¶ä»–æ‰€æœ‰å¼‚å¸¸éƒ½è¢«åŒ…è£…ä¸ºæ‰§è¡Œå¼‚å¸¸ExecutionExceptionæŠ›å‡º</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ExecutionException(cause);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// å¸¦è¶…æ—¶é˜»å¡ç­‰å¾…è·å–ç»“æœçš„æ–¹æ³•</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(<span class="keyword">long</span> timeout, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException, ExecutionException, TimeoutException </span>&#123;</span><br><span class="line">        <span class="comment">// è°ƒç”¨å“åº”ä¸­æ–­çš„å¸¦è¶…æ—¶æ—¶é™ç­‰å¾…æ–¹æ³•è¿›è¡Œé˜»å¡</span></span><br><span class="line">        <span class="keyword">if</span> (await(timeout, unit)) &#123;</span><br><span class="line">             <span class="comment">// ä»å¸¦è¶…æ—¶æ—¶é™é˜»å¡ä¸­å”¤é†’åï¼Œå…ˆåˆ¤æ–­Futureæ˜¯å¦æ‰§è¡Œå¼‚å¸¸</span></span><br><span class="line">            Throwable cause = cause();</span><br><span class="line">            <span class="keyword">if</span> (cause == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">// å¼‚å¸¸ä¸ºç©ºè¯´æ˜æ‰§è¡ŒæˆåŠŸï¼Œè°ƒç”¨getNow()æ–¹æ³•è¿”å›ç»“æœ</span></span><br><span class="line">                <span class="keyword">return</span> getNow();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å¼‚å¸¸ä¸ºç©ºä¸ä¸ºç©ºï¼Œè¿™é‡ŒåŒºåˆ†ç‰¹å®šçš„å–æ¶ˆå¼‚å¸¸åˆ™è½¬æ¢ä¸ºCancellationExceptionæŠ›å‡º</span></span><br><span class="line">            <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> CancellationException) &#123;</span><br><span class="line">                <span class="keyword">throw</span> (CancellationException) cause;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// åœ¨éç­‰å¾…è¶…æ—¶çš„å‰æä¸‹ï¼Œéå–æ¶ˆå¼‚å¸¸çš„å…¶ä»–æ‰€æœ‰å¼‚å¸¸éƒ½è¢«åŒ…è£…ä¸ºæ‰§è¡Œå¼‚å¸¸ExecutionExceptionæŠ›å‡º</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ExecutionException(cause);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ–¹æ³•æ­¥å…¥æ­¤å¤„è¯´æ˜ç­‰å¾…è¶…æ—¶ï¼Œåˆ™æŠ›å‡ºè¶…æ—¶å¼‚å¸¸TimeoutException</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> TimeoutException();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>AbstractFuture</code>ä»…ä»…å¯¹<code>get()</code>å’Œ<code>get(long timeout, TimeUnit unit)</code>ä¸¤ä¸ªæ–¹æ³•è¿›è¡Œäº†å®ç°ï¼Œå…¶å®è¿™ä¸¤å¤„çš„å®ç°å’Œ<code>java.util.concurrent.FutureTask</code>ä¸­çš„å®ç°æ–¹å¼ååˆ†ç›¸ä¼¼ã€‚</p><p><code>DefaultPromise</code>çš„æºç æ¯”è¾ƒå¤šï¼Œè¿™é‡Œåˆ†å¼€å¤šä¸ªéƒ¨åˆ†å»é˜…è¯»ï¼Œå…ˆçœ‹å®ƒçš„å±æ€§å’Œæ„é€ å‡½æ•°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultPromise</span>&lt;<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractFuture</span>&lt;<span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">Promise</span>&lt;<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ­£å¸¸æ—¥å¿—çš„æ—¥å¿—å¥æŸ„ï¼ŒInternalLoggeræ˜¯Nettyå†…éƒ¨å°è£…çš„æ—¥å¿—æ¥å£</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> InternalLogger logger = InternalLoggerFactory.getInstance(DefaultPromise<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä»»åŠ¡æ‹’ç»æ‰§è¡Œæ—¶å€™çš„æ—¥å¿—å¥æŸ„ - Promiseéœ€è¦ä½œä¸ºä¸€ä¸ªä»»åŠ¡æäº¤åˆ°çº¿ç¨‹ä¸­æ‰§è¡Œï¼Œå¦‚æœä»»åŠ¡æ‹’ç»åˆ™ä½¿ç”¨æ­¤æ—¥å¿—å¥æŸ„æ‰“å°æ—¥å¿—</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> InternalLogger rejectedExecutionLogger =</span><br><span class="line">            InternalLoggerFactory.getInstance(DefaultPromise.class.getName() + ".rejectedExecution");</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç›‘å¬å™¨çš„æœ€å¤§æ ˆæ·±åº¦ï¼Œé»˜è®¤å€¼ä¸º8ï¼Œè¿™ä¸ªå€¼æ˜¯é˜²æ­¢åµŒå¥—å›è°ƒè°ƒç”¨çš„æ—¶å€™æ ˆæ·±åº¦è¿‡å¤§å¯¼è‡´å†…å­˜æº¢å‡ºï¼Œåé¢ä¼šä¸¾ä¸ªä¾‹å­è¯´æ˜å®ƒçš„ç”¨æ³•</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX_LISTENER_STACK_DEPTH = Math.min(<span class="number">8</span>,</span><br><span class="line">            SystemPropertyUtil.getInt(<span class="string">"io.netty.defaultPromise.maxListenerStackDepth"</span>, <span class="number">8</span>));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç»“æœæ›´æ–°å™¨ï¼Œç”¨äºCASæ›´æ–°ç»“æœresultçš„å€¼</span></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"rawtypes"</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AtomicReferenceFieldUpdater&lt;DefaultPromise, Object&gt; RESULT_UPDATER =</span><br><span class="line">            AtomicReferenceFieldUpdater.newUpdater(DefaultPromise.class, Object.class, "result");</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç”¨äºå¡«å……resultçš„å€¼ï¼Œå½“è®¾ç½®ç»“æœresultä¼ å…¥nullï¼ŒPromiseæ‰§è¡ŒæˆåŠŸï¼Œç”¨è¿™ä¸ªå€¼å»è¡¨ç¤ºæˆåŠŸçš„ç»“æœ</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object SUCCESS = <span class="keyword">new</span> Object();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç”¨äºå¡«å……resultçš„å€¼ï¼Œè¡¨ç¤ºPromiseä¸èƒ½è¢«å–æ¶ˆ</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Object UNCANCELLABLE = <span class="keyword">new</span> Object();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// CancellationExceptionå®ä¾‹çš„æŒæœ‰å™¨ï¼Œç”¨äºåˆ¤æ–­Promiseå–æ¶ˆçŠ¶æ€å’ŒæŠ›å‡ºCancellationException</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> CauseHolder CANCELLATION_CAUSE_HOLDER = <span class="keyword">new</span> CauseHolder(ThrowableUtil.unknownStackTrace(</span><br><span class="line">            new CancellationException(), DefaultPromise.class, "cancel(...)"));</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// CANCELLATION_CAUSE_HOLDERçš„å¼‚å¸¸æ ˆä¿¡æ¯å…ƒç´ æ•°ç»„</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> StackTraceElement[] CANCELLATION_STACK = CANCELLATION_CAUSE_HOLDER.cause.getStackTrace();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// çœŸæ­£çš„ç»“æœå¯¹è±¡ï¼Œä½¿ç”¨Objectç±»å‹ï¼Œæœ€ç»ˆæœ‰å¯èƒ½ä¸ºnullã€çœŸæ­£çš„ç»“æœå®ä¾‹ã€SUCCESSã€UNCANCELLABLEæˆ–è€…CANCELLATION_CAUSE_HOLDERç­‰ç­‰</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> Object result;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// äº‹ä»¶æ‰§è¡Œå™¨ï¼Œè¿™é‡Œæš‚æ—¶ä¸åšå±•å¼€ï¼Œå¯ä»¥ç†è§£ä¸ºå•ä¸ªè°ƒåº¦çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> EventExecutor executor;</span><br><span class="line">    </span><br><span class="line">     <span class="comment">// ç›‘å¬å™¨é›†åˆï¼Œå¯èƒ½æ˜¯å•ä¸ªGenericFutureListenerå®ä¾‹æˆ–è€…DefaultFutureListenersï¼ˆç›‘å¬å™¨é›†åˆï¼‰å®ä¾‹</span></span><br><span class="line">    <span class="keyword">private</span> Object listeners;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ç­‰å¾…è·å–ç»“æœçš„çº¿ç¨‹æ•°é‡</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">short</span> waiters;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ ‡è®°æ˜¯å¦æ­£åœ¨å›è°ƒç›‘å¬å™¨</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> notifyingListeners;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ„é€ å‡½æ•°ä¾èµ–äºEventExecutor</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DefaultPromise</span><span class="params">(EventExecutor executor)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.executor = checkNotNull(executor, <span class="string">"executor"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="title">DefaultPromise</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// only for subclasses - è¿™ä¸ªæ„é€ å‡½æ•°é¢„ç•™ç»™å­ç±»</span></span><br><span class="line">        executor = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... çœç•¥å…¶ä»–ä»£ç  ...</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç§æœ‰é™æ€å†…éƒ¨ç±»ï¼Œç”¨äºå­˜æ”¾Throwableå®ä¾‹ï¼Œä¹Ÿå°±æ˜¯æŒæœ‰å¼‚å¸¸çš„åŸå› å®ä¾‹</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">CauseHolder</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Throwable cause;</span><br><span class="line">        CauseHolder(Throwable cause) &#123;</span><br><span class="line">            <span class="keyword">this</span>.cause = cause;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç§æœ‰é™æ€å†…éƒ¨ç±»ï¼Œç”¨äºè¦†ç›–CancellationExceptionçš„æ ˆä¿¡æ¯ä¸ºå‰é¢å®šä¹‰çš„CANCELLATION_STACKï¼ŒåŒæ—¶è¦†ç›–äº†toString()è¿”å›CancellationExceptionçš„å…¨ç±»å</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">LeanCancellationException</span> <span class="keyword">extends</span> <span class="title">CancellationException</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">2794674970981187807L</span>;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Throwable <span class="title">fillInStackTrace</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            setStackTrace(CANCELLATION_STACK);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> CancellationException<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>()</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ... çœç•¥å…¶ä»–ä»£ç  ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>Promise</code>ç›®å‰æ”¯æŒä¸¤ç§ç±»å‹çš„ç›‘å¬å™¨ï¼š</p><ul><li><code>GenericFutureListener</code>ï¼šæ”¯æŒæ³›å‹çš„<code>Future</code>ç›‘å¬å™¨ã€‚</li><li><code>GenericProgressiveFutureListener</code>ï¼šå®ƒæ˜¯<code>GenericFutureListener</code>çš„å­ç±»ï¼Œæ”¯æŒè¿›åº¦è¡¨ç¤ºå’Œæ”¯æŒæ³›å‹çš„<code>Future</code>ç›‘å¬å™¨ï¼ˆæœ‰äº›åœºæ™¯éœ€è¦å¤šä¸ªæ­¥éª¤å®ç°ï¼Œç±»ä¼¼äºè¿›åº¦æ¡é‚£æ ·ï¼‰ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// GenericFutureListener</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">GenericFutureListener</span>&lt;<span class="title">F</span> <span class="keyword">extends</span> <span class="title">Future</span>&lt;?&gt;&gt; <span class="keyword">extends</span> <span class="title">EventListener</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">operationComplete</span><span class="params">(F future)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// GenericProgressiveFutureListener</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">GenericProgressiveFutureListener</span>&lt;<span class="title">F</span> <span class="keyword">extends</span> <span class="title">ProgressiveFuture</span>&lt;?&gt;&gt; <span class="keyword">extends</span> <span class="title">GenericFutureListener</span>&lt;<span class="title">F</span>&gt; </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">operationProgressed</span><span class="params">(F future, <span class="keyword">long</span> progress, <span class="keyword">long</span> total)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸ºäº†è®©<code>Promise</code>æ”¯æŒå¤šä¸ªç›‘å¬å™¨ï¼Œ<code>Netty</code>æ·»åŠ äº†ä¸€ä¸ªé»˜è®¤ä¿®é¥°ç¬¦ä¿®é¥°çš„<code>DefaultFutureListeners</code>ç±»ç”¨äºä¿å­˜ç›‘å¬å™¨å®ä¾‹æ•°ç»„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DefaultFutureListeners</span></span><br><span class="line"><span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultFutureListeners</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> GenericFutureListener&lt;? extends Future&lt;?&gt;&gt;[] listeners;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> size;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> progressiveSize; <span class="comment">// the number of progressive listeners</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è¿™ä¸ªæ„é€ ç›¸å¯¹ç‰¹åˆ«ï¼Œæ˜¯ä¸ºäº†è®©Promiseä¸­çš„listenersï¼ˆObjectç±»å‹ï¼‰å®ä¾‹ç”±å•ä¸ªGenericFutureListenerå®ä¾‹è½¬æ¢ä¸ºDefaultFutureListenersç±»å‹</span></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    DefaultFutureListeners(GenericFutureListener&lt;? extends Future&lt;?&gt;&gt; first, GenericFutureListener&lt;? extends Future&lt;?&gt;&gt; second) &#123;</span><br><span class="line">        listeners = <span class="keyword">new</span> GenericFutureListener[<span class="number">2</span>];</span><br><span class="line">        listeners[<span class="number">0</span>] = first;</span><br><span class="line">        listeners[<span class="number">1</span>] = second;</span><br><span class="line">        size = <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (first <span class="keyword">instanceof</span> GenericProgressiveFutureListener) &#123;</span><br><span class="line">            progressiveSize ++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (second <span class="keyword">instanceof</span> GenericProgressiveFutureListener) &#123;</span><br><span class="line">            progressiveSize ++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(GenericFutureListener&lt;? extends Future&lt;?&gt;&gt; l)</span> </span>&#123;</span><br><span class="line">        GenericFutureListener&lt;? extends Future&lt;?&gt;&gt;[] listeners = <span class="keyword">this</span>.listeners;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> size = <span class="keyword">this</span>.size;</span><br><span class="line">        <span class="comment">// æ³¨æ„è¿™é‡Œï¼Œæ¯æ¬¡æ‰©å®¹æ•°ç»„é•¿åº¦æ˜¯åŸæ¥çš„2å€</span></span><br><span class="line">        <span class="keyword">if</span> (size == listeners.length) &#123;</span><br><span class="line">            <span class="keyword">this</span>.listeners = listeners = Arrays.copyOf(listeners, size &lt;&lt; <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æŠŠå½“å‰çš„GenericFutureListeneråŠ å…¥æ•°ç»„ä¸­</span></span><br><span class="line">        listeners[size] = l;</span><br><span class="line">        <span class="comment">// ç›‘å¬å™¨æ€»æ•°é‡åŠ 1</span></span><br><span class="line">        <span class="keyword">this</span>.size = size + <span class="number">1</span>;</span><br><span class="line">        <span class="comment">// å¦‚æœä¸ºGenericProgressiveFutureListenerï¼Œåˆ™å¸¦è¿›åº¦æŒ‡ç¤ºçš„ç›‘å¬å™¨æ€»æ•°é‡åŠ 1</span></span><br><span class="line">        <span class="keyword">if</span> (l <span class="keyword">instanceof</span> GenericProgressiveFutureListener) &#123;</span><br><span class="line">            progressiveSize ++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(GenericFutureListener&lt;? extends Future&lt;?&gt;&gt; l)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> GenericFutureListener&lt;? extends Future&lt;?&gt;&gt;[] listeners = <span class="keyword">this</span>.listeners;</span><br><span class="line">        <span class="keyword">int</span> size = <span class="keyword">this</span>.size;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i ++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (listeners[i] == l) &#123;</span><br><span class="line">                <span class="comment">// è®¡ç®—éœ€è¦éœ€è¦ç§»åŠ¨çš„ç›‘å¬å™¨çš„ä¸‹æ ‡</span></span><br><span class="line">                <span class="keyword">int</span> listenersToMove = size - i - <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">if</span> (listenersToMove &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">// listenersToMoveåé¢çš„å…ƒç´ å…¨éƒ¨ç§»åŠ¨åˆ°æ•°ç»„çš„å‰ç«¯</span></span><br><span class="line">                    System.arraycopy(listeners, i + <span class="number">1</span>, listeners, i, listenersToMove);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// å½“å‰ç›‘å¬å™¨æ€»é‡çš„æœ€åä¸€ä¸ªä½ç½®è®¾ç½®ä¸ºnullï¼Œæ•°é‡å‡1</span></span><br><span class="line">                listeners[-- size] = <span class="keyword">null</span>;</span><br><span class="line">                <span class="keyword">this</span>.size = size;</span><br><span class="line">                <span class="comment">// å¦‚æœç›‘å¬å™¨æ˜¯GenericProgressiveFutureListenerï¼Œåˆ™å¸¦è¿›åº¦æŒ‡ç¤ºçš„ç›‘å¬å™¨æ€»æ•°é‡å‡1</span></span><br><span class="line">                <span class="keyword">if</span> (l <span class="keyword">instanceof</span> GenericProgressiveFutureListener) &#123;</span><br><span class="line">                    progressiveSize --;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è¿”å›ç›‘å¬å™¨å®ä¾‹æ•°ç»„</span></span><br><span class="line">    <span class="keyword">public</span> GenericFutureListener&lt;? extends Future&lt;?&gt;&gt;[] listeners() &#123;</span><br><span class="line">        <span class="keyword">return</span> listeners;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è¿”å›ç›‘å¬å™¨æ€»æ•°é‡</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> size;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è¿”å›å¸¦è¿›åº¦æŒ‡ç¤ºçš„ç›‘å¬å™¨æ€»æ•°é‡</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">progressiveSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> progressiveSize;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥çœ‹<code>DefaultPromise</code>çš„å‰©ä½™æ–¹æ³•å®ç°ï¼Œç¬”è€…è§‰å¾—<code>DefaultPromise</code>æ–¹æ³•å®ç°åœ¨ä»£ç é¡ºåºä¸Šæ˜¯æœ‰ä¸€å®šçš„è‰ºæœ¯çš„ã€‚å…ˆçœ‹å‡ ä¸ªåˆ¤æ–­<code>Promise</code>æ‰§è¡ŒçŠ¶æ€çš„æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultPromise</span>&lt;<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractFuture</span>&lt;<span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">Promise</span>&lt;<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... çœç•¥å…¶ä»–ä»£ç  ...</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">setUncancellable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// é€šè¿‡ç»“æœæ›´æ–°å™¨CASæ›´æ–°resultä¸ºUNCANCELLABLEï¼ŒæœŸæœ›æ—§å€¼ä¸ºnullï¼Œæ›´æ–°å€¼ä¸ºUNCANCELLABLEå±æ€§ï¼Œå¦‚æœæˆåŠŸåˆ™è¿”å›true</span></span><br><span class="line">        <span class="keyword">if</span> (RESULT_UPDATER.compareAndSet(<span class="keyword">this</span>, <span class="keyword">null</span>, UNCANCELLABLE)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Object result = <span class="keyword">this</span>.result;</span><br><span class="line">        <span class="comment">// æ­¥å…¥è¿™é‡Œè¯´æ˜resultå½“å‰å€¼ä¸ä¸ºnullï¼ŒisDone0()å’ŒisCancelled0()éƒ½æ˜¯ç»ˆæ€ï¼Œè¿™é‡Œå¦‚æœå‘½ä¸­ç»ˆæ€å°±è¿”å›false</span></span><br><span class="line">        <span class="comment">//ï¼ˆç¬”è€…æ³¨ï¼šå…¶å®å¯ä»¥è¿™æ ·è®¤ä¸ºï¼Œè¿™é‡Œresultä¸èƒ½ä¸ºnullï¼Œå¦‚æœä¸ä¸ºç»ˆæ€ï¼Œå®ƒåªèƒ½æ˜¯UNCANCELLABLEå±æ€§å®ä¾‹ï¼‰</span></span><br><span class="line">        <span class="keyword">return</span> !isDone0(result) || !isCancelled0(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isSuccess</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Object result = <span class="keyword">this</span>.result;</span><br><span class="line">        <span class="comment">// å¦‚æœæ‰§è¡ŒæˆåŠŸï¼Œåˆ™ç»“æœä¸ä¸ºnullï¼ŒåŒæ—¶ä¸ä¸ºUNCANCELLABLEï¼ŒåŒæ—¶ä¸ä¸ºCauseHolderç±»å‹</span></span><br><span class="line">        <span class="comment">//ï¼ˆç¬”è€…æ³¨ï¼šå…¶å®å¯ä»¥è¿™æ ·è®¤ä¸ºï¼ŒPromiseä¸ºæˆåŠŸï¼Œåˆ™resultåªèƒ½æ˜¯ä¸€ä¸ªå¼€å‘è€…å®šä¹‰çš„å®ä¾‹æˆ–è€…SUCCESSå±æ€§å®ä¾‹ï¼‰</span></span><br><span class="line">        <span class="keyword">return</span> result != <span class="keyword">null</span> &amp;&amp; result != UNCANCELLABLE &amp;&amp; !(result <span class="keyword">instanceof</span> CauseHolder);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isCancellable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// æ˜¯å¦å¯å–æ¶ˆçš„ï¼Œresultä¸ºnullè¯´æ˜Promiseå¤„äºåˆå§‹åŒ–çŠ¶æ€å°šæœªæ‰§è¡Œï¼Œåˆ™è®¤ä¸ºå¯ä»¥å–æ¶ˆ</span></span><br><span class="line">        <span class="keyword">return</span> result == <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Throwable <span class="title">cause</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// é€šè¿‡å½“å‰resultè·å–Throwableå®ä¾‹</span></span><br><span class="line">        <span class="keyword">return</span> cause0(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Throwable <span class="title">cause0</span><span class="params">(Object result)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// resultéCauseHolderç±»å‹ï¼Œåˆ™ç›´æ¥è¿”å›null</span></span><br><span class="line">        <span class="keyword">if</span> (!(result <span class="keyword">instanceof</span> CauseHolder)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚æœresultä¸ºCANCELLATION_CAUSE_HOLDERï¼ˆé™æ€CancellationExceptionçš„æŒæœ‰ï¼‰</span></span><br><span class="line">        <span class="keyword">if</span> (result == CANCELLATION_CAUSE_HOLDER) &#123;</span><br><span class="line">            <span class="comment">// åˆ™æ–°å»ºä¸€ä¸ªè‡ªå®šä¹‰LeanCancellationExceptionå®ä¾‹</span></span><br><span class="line">            CancellationException ce = <span class="keyword">new</span> LeanCancellationException();</span><br><span class="line">            <span class="comment">// å¦‚æœCASæ›´æ–°ç»“æœresultä¸ºLeanCancellationExceptionæ–°å®ä¾‹åˆ™è¿”å›</span></span><br><span class="line">            <span class="keyword">if</span> (RESULT_UPDATER.compareAndSet(<span class="keyword">this</span>, CANCELLATION_CAUSE_HOLDER, <span class="keyword">new</span> CauseHolder(ce))) &#123;</span><br><span class="line">                <span class="keyword">return</span> ce;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// èµ°åˆ°è¿™é‡Œè¯´æ˜äº†resultæ˜¯éCANCELLATION_CAUSE_HOLDERçš„è‡ªå®šä¹‰CauseHolderå®ä¾‹</span></span><br><span class="line">            result = <span class="keyword">this</span>.result;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å…œåº•è¿”å›CauseHolderæŒæœ‰çš„cause</span></span><br><span class="line">        <span class="keyword">return</span> ((CauseHolder) result).cause;</span><br><span class="line">    &#125;</span><br><span class="line">      </span><br><span class="line">    <span class="comment">// é™æ€æ–¹æ³•ï¼Œåˆ¤æ–­Promiseæ˜¯å¦ä¸ºå–æ¶ˆï¼Œä¾æ®æ˜¯resultå¿…é¡»æ˜¯CauseHolderç±»å‹ï¼ŒåŒæ—¶CauseHolderä¸­çš„causeå¿…é¡»ä¸ºCancellationExceptionç±»å‹æˆ–è€…å…¶å­ç±»</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isCancelled0</span><span class="params">(Object result)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> result <span class="keyword">instanceof</span> CauseHolder &amp;&amp; ((CauseHolder) result).cause <span class="keyword">instanceof</span> CancellationException;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// é™æ€æ–¹æ³•ï¼Œåˆ¤æ–­Promiseæ˜¯å¦å®Œæˆï¼Œä¾æ®æ˜¯resultä¸ä¸ºnullåŒæ—¶ä¸ä¸ºUNCANCELLABLEå±æ€§å®ä¾‹</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isDone0</span><span class="params">(Object result)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> result != <span class="keyword">null</span> &amp;&amp; result != UNCANCELLABLE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åˆ¤æ–­Promiseå®ä¾‹æ˜¯å¦å–æ¶ˆ</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isCancelled</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> isCancelled0(result);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ¤æ–­Promiseå®ä¾‹æ˜¯å¦å®Œæˆ</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isDone</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> isDone0(result);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ... çœç•¥å…¶ä»–ä»£ç  ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ç€çœ‹ç›‘å¬å™¨çš„æ·»åŠ å’Œç§»é™¤æ–¹æ³•ï¼ˆè¿™å…¶ä¸­ä¹ŸåŒ…å«äº†é€šçŸ¥ç›‘å¬å™¨çš„é€»è¾‘ï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultPromise</span>&lt;<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractFuture</span>&lt;<span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">Promise</span>&lt;<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... çœç•¥å…¶ä»–ä»£ç  ...</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Promise&lt;V&gt; <span class="title">addListener</span><span class="params">(GenericFutureListener&lt;? extends Future&lt;? <span class="keyword">super</span> V&gt;&gt; listener)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// å…¥å‚éç©ºæ ¡éªŒ</span></span><br><span class="line">        checkNotNull(listener, <span class="string">"listener"</span>);</span><br><span class="line">        <span class="comment">// åŠ é”ï¼Œé”å®šçš„å¯¹è±¡æ˜¯Promiseå®ä¾‹è‡ªèº«</span></span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="comment">// æ·»åŠ ç›‘å¬å™¨</span></span><br><span class="line">            addListener0(listener);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚æœPromiseå®ä¾‹å·²ç»æ‰§è¡Œå®Œæ¯•ï¼Œåˆ™é€šçŸ¥ç›‘å¬å™¨è¿›è¡Œå›è°ƒ</span></span><br><span class="line">        <span class="keyword">if</span> (isDone()) &#123;</span><br><span class="line">            notifyListeners();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Promise&lt;V&gt; <span class="title">addListeners</span><span class="params">(GenericFutureListener&lt;? extends Future&lt;? <span class="keyword">super</span> V&gt;&gt;... listeners)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// å…¥å‚éç©ºæ ¡éªŒ</span></span><br><span class="line">        checkNotNull(listeners, <span class="string">"listeners"</span>);</span><br><span class="line">        <span class="comment">// åŠ é”ï¼Œé”å®šçš„å¯¹è±¡æ˜¯Promiseå®ä¾‹è‡ªèº«</span></span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="comment">// éå†å…¥å‚æ•°ç»„æ·»åŠ ç›‘å¬å™¨ï¼Œæœ‰ç©ºå…ƒç´ ç›´æ¥è·³å‡º</span></span><br><span class="line">            <span class="keyword">for</span> (GenericFutureListener&lt;? extends Future&lt;? <span class="keyword">super</span> V&gt;&gt; listener : listeners) &#123;</span><br><span class="line">                <span class="keyword">if</span> (listener == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                addListener0(listener);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚æœPromiseå®ä¾‹å·²ç»æ‰§è¡Œå®Œæ¯•ï¼Œåˆ™é€šçŸ¥ç›‘å¬å™¨è¿›è¡Œå›è°ƒ</span></span><br><span class="line">        <span class="keyword">if</span> (isDone()) &#123;</span><br><span class="line">            notifyListeners();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Promise&lt;V&gt; <span class="title">removeListener</span><span class="params">(<span class="keyword">final</span> GenericFutureListener&lt;? extends Future&lt;? <span class="keyword">super</span> V&gt;&gt; listener)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// å…¥å‚éç©ºæ ¡éªŒ</span></span><br><span class="line">        checkNotNull(listener, <span class="string">"listener"</span>);</span><br><span class="line">        <span class="comment">// åŠ é”ï¼Œé”å®šçš„å¯¹è±¡æ˜¯Promiseå®ä¾‹è‡ªèº«</span></span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="comment">// ç§»é™¤ç›‘å¬å™¨</span></span><br><span class="line">            removeListener0(listener);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Promise&lt;V&gt; <span class="title">removeListeners</span><span class="params">(<span class="keyword">final</span> GenericFutureListener&lt;? extends Future&lt;? <span class="keyword">super</span> V&gt;&gt;... listeners)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// å…¥å‚éç©ºæ ¡éªŒ</span></span><br><span class="line">        checkNotNull(listeners, <span class="string">"listeners"</span>);</span><br><span class="line">        <span class="comment">// åŠ é”ï¼Œé”å®šçš„å¯¹è±¡æ˜¯Promiseå®ä¾‹è‡ªèº«</span></span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="comment">// éå†å…¥å‚æ•°ç»„ç§»é™¤ç›‘å¬å™¨ï¼Œæœ‰ç©ºå…ƒç´ ç›´æ¥è·³å‡º</span></span><br><span class="line">            <span class="keyword">for</span> (GenericFutureListener&lt;? extends Future&lt;? <span class="keyword">super</span> V&gt;&gt; listener : listeners) &#123;</span><br><span class="line">                <span class="keyword">if</span> (listener == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                removeListener0(listener);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addListener0</span><span class="params">(GenericFutureListener&lt;? extends Future&lt;? <span class="keyword">super</span> V&gt;&gt; listener)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// å¦‚æœPromiseå®ä¾‹æŒæœ‰listenersä¸ºnullï¼Œåˆ™ç›´æ¥è®¾ç½®ä¸ºå…¥å‚listener</span></span><br><span class="line">        <span class="keyword">if</span> (listeners == <span class="keyword">null</span>) &#123;</span><br><span class="line">            listeners = listener;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (listeners <span class="keyword">instanceof</span> DefaultFutureListeners) &#123;</span><br><span class="line">             <span class="comment">// å¦‚æœå½“å‰Promiseå®ä¾‹æŒæœ‰listenersçš„æ˜¯DefaultFutureListenersç±»å‹ï¼Œåˆ™è°ƒç”¨å®ƒçš„add()æ–¹æ³•è¿›è¡Œæ·»åŠ </span></span><br><span class="line">            ((DefaultFutureListeners) listeners).add(listener);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// æ­¥å…¥è¿™é‡Œè¯´æ˜å½“å‰Promiseå®ä¾‹æŒæœ‰listenersä¸ºå•ä¸ªGenericFutureListenerå®ä¾‹ï¼Œéœ€è¦è½¬æ¢ä¸ºDefaultFutureListenerså®ä¾‹</span></span><br><span class="line">            listeners = <span class="keyword">new</span> DefaultFutureListeners((GenericFutureListener&lt;?&gt;) listeners, listener);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">removeListener0</span><span class="params">(GenericFutureListener&lt;? extends Future&lt;? <span class="keyword">super</span> V&gt;&gt; listener)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// å¦‚æœå½“å‰Promiseå®ä¾‹æŒæœ‰listenersçš„æ˜¯DefaultFutureListenersç±»å‹ï¼Œåˆ™è°ƒç”¨å®ƒçš„remove()æ–¹æ³•è¿›è¡Œç§»é™¤</span></span><br><span class="line">        <span class="keyword">if</span> (listeners <span class="keyword">instanceof</span> DefaultFutureListeners) &#123;</span><br><span class="line">            ((DefaultFutureListeners) listeners).remove(listener);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (listeners == listener) &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœå½“å‰Promiseå®ä¾‹æŒæœ‰listenersä¸ä¸ºDefaultFutureListenersç±»å‹ï¼Œä¹Ÿå°±æ˜¯å•ä¸ªGenericFutureListenerå¹¶ä¸”å’Œä¼ å…¥çš„listenerç›¸åŒï¼Œ</span></span><br><span class="line">            <span class="comment">// åˆ™Promiseå®ä¾‹æŒæœ‰listenersç½®ä¸ºnull</span></span><br><span class="line">            listeners = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">notifyListeners</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        EventExecutor executor = executor();</span><br><span class="line">        <span class="comment">// å½“å‰æ‰§è¡Œçº¿ç¨‹æ˜¯äº‹ä»¶å¾ªç¯çº¿ç¨‹ï¼Œé‚£ä¹ˆç›´æ¥åŒæ­¥è°ƒç”¨ï¼Œç®€å•æ¥è¯´å°±æ˜¯è°ƒç”¨notifyListeners()æ–¹æ³•çš„çº¿ç¨‹å’ŒEventExecutoræ˜¯åŒä¸€ä¸ªçº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">if</span> (executor.inEventLoop()) &#123;</span><br><span class="line">            <span class="comment">// ä¸‹é¢çš„ThreadLocalå’ŒlistenerStackDepthæ˜¯è°ƒç”¨æ ˆæ·±åº¦ä¿æŠ¤ç›¸å…³ï¼Œåšæ–‡ä¼šå¦èµ·ä¸€ä¸ªç« èŠ‚ä¸“é—¨è®²è§£è¿™ä¸ªé—®é¢˜ï¼Œè¿™é‡Œå¯ä»¥æš‚æ—¶å¿½ç•¥</span></span><br><span class="line">            <span class="keyword">final</span> InternalThreadLocalMap threadLocals = InternalThreadLocalMap.get();</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> stackDepth = threadLocals.futureListenerStackDepth();</span><br><span class="line">            <span class="keyword">if</span> (stackDepth &lt; MAX_LISTENER_STACK_DEPTH) &#123;</span><br><span class="line">                threadLocals.setFutureListenerStackDepth(stackDepth + <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    notifyListenersNow();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    threadLocals.setFutureListenerStackDepth(stackDepth);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å½“å‰æ‰§è¡Œçº¿ç¨‹ä¸æ˜¯äº‹ä»¶å¾ªç¯çº¿ç¨‹ï¼Œåˆ™æŠŠnotifyListenersNow()åŒ…è£…ä¸ºRunnableå®ä¾‹æ”¾åˆ°EventExecutorä¸­æ‰§è¡Œ</span></span><br><span class="line">        safeExecute(executor, <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                notifyListenersNow();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ä½¿ç”¨EventExecutorè¿›è¡Œä»»åŠ¡æ‰§è¡Œï¼Œexecute()æ–¹æ³•æŠ›å‡ºçš„å¼‚å¸¸ä¼šä½¿ç”¨rejectedExecutionLoggerå¥æŸ„æ‰“å°</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">safeExecute</span><span class="params">(EventExecutor executor, Runnable task)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            executor.execute(task);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            rejectedExecutionLogger.error(<span class="string">"Failed to submit a listener notification task. Event loop shut down?"</span>, t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">// é©¬ä¸Šé€šçŸ¥æ‰€æœ‰ç›‘å¬å™¨è¿›è¡Œå›è°ƒ</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">notifyListenersNow</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Object listeners;</span><br><span class="line">        <span class="comment">// è¿™é‡ŒåŠ é”ï¼Œåœ¨é”çš„ä¿æŠ¤ä¸‹è®¾ç½®notifyingListenersçš„å€¼ï¼Œå¦‚æœå¤šä¸ªçº¿ç¨‹è°ƒç”¨åŒä¸€ä¸ªPromiseå®ä¾‹çš„notifyListenersNow()æ–¹æ³•</span></span><br><span class="line">        <span class="comment">// å‘½ä¸­notifyingListenersçš„çº¿ç¨‹å¯ä»¥ç›´æ¥è¿”å›</span></span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="comment">// Only proceed if there are listeners to notify and we are not already notifying listeners.</span></span><br><span class="line">            <span class="keyword">if</span> (notifyingListeners || <span class="keyword">this</span>.listeners == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            notifyingListeners = <span class="keyword">true</span>;</span><br><span class="line">            <span class="comment">// ä¸´æ—¶å˜é‡listenerså­˜æ”¾ç¬æ—¶çš„ç›‘å¬å™¨å®ä¾‹ï¼Œæ–¹ä¾¿ä¸‹ä¸€æ­¥è®¾ç½®Promiseå®ä¾‹çš„listenersä¸ºnull</span></span><br><span class="line">            listeners = <span class="keyword">this</span>.listeners;</span><br><span class="line">            <span class="comment">// é‡ç½®å½“å‰Promiseå®ä¾‹çš„listenersä¸ºnull</span></span><br><span class="line">            <span class="keyword">this</span>.listeners = <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">            <span class="keyword">if</span> (listeners <span class="keyword">instanceof</span> DefaultFutureListeners) &#123;</span><br><span class="line">                <span class="comment">// å¤šä¸ªç›‘å¬å™¨æƒ…å†µä¸‹çš„é€šçŸ¥</span></span><br><span class="line">                notifyListeners0((DefaultFutureListeners) listeners);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// å•ä¸ªç›‘å¬å™¨æƒ…å†µä¸‹çš„é€šçŸ¥</span></span><br><span class="line">                notifyListener0(<span class="keyword">this</span>, (GenericFutureListener&lt;?&gt;) listeners);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">this</span>.listeners == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// è¿™é‡Œå› ä¸ºæ²¡æœ‰å¼‚å¸¸æŠ›å‡ºçš„å¯èƒ½ï¼Œä¸ç”¨åœ¨finallyå—ä¸­ç¼–å†™ï¼Œé‡ç½®notifyingListenersä¸ºfalseå¹¶ä¸”è¿”å›è·³å‡ºå¾ªç¯</span></span><br><span class="line">                    notifyingListeners = <span class="keyword">false</span>;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                  <span class="comment">// ä¸´æ—¶å˜é‡listenerså­˜æ”¾ç¬æ—¶çš„ç›‘å¬å™¨å®ä¾‹ï¼Œå›è°ƒæ“ä½œåˆ¤æ–­æ˜¯åŸºäºä¸´æ—¶å®ä¾‹å»åš - è¿™é‡Œå¯èƒ½ç”±å¦ä¸€ä¸ªçº¿ç¨‹æ›´æ–°äº†listenersçš„å€¼</span></span><br><span class="line">                listeners = <span class="keyword">this</span>.listeners;</span><br><span class="line">                <span class="comment">// é‡ç½®å½“å‰Promiseå®ä¾‹çš„listenersä¸ºnullï¼Œç¡®ä¿ç›‘å¬å™¨åªä¼šè¢«å›è°ƒä¸€æ¬¡ï¼Œä¸‹ä¸€æ¬¡è·³å‡ºforæ­»å¾ªç¯</span></span><br><span class="line">                <span class="keyword">this</span>.listeners = <span class="keyword">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">    <span class="comment">// éå†DefaultFutureListenersä¸­çš„listenersæ•°ç»„ï¼Œè°ƒç”¨é™æ€æ–¹æ³•notifyListener0()</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">notifyListeners0</span><span class="params">(DefaultFutureListeners listeners)</span> </span>&#123;</span><br><span class="line">        GenericFutureListener&lt;?&gt;[] a = listeners.listeners();</span><br><span class="line">        <span class="keyword">int</span> size = listeners.size();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i ++) &#123;</span><br><span class="line">            notifyListener0(<span class="keyword">this</span>, a[i]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è¿™ä¸ªé™æ€æ–¹æ³•æ˜¯æœ€ç»ˆç›‘å¬å™¨å›è°ƒçš„æ–¹æ³•,ä¹Ÿå°±æ˜¯ç®€å•è°ƒç”¨GenericFutureListener#operationComplete()ä¼ å…¥çš„æ˜¯å½“å‰çš„Promiseå®ä¾‹ï¼Œæ•è·ä¸€åˆ‡å¼‚å¸¸æ‰“å°warnæ—¥å¿—</span></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(&#123; <span class="string">"unchecked"</span>, <span class="string">"rawtypes"</span> &#125;)</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">notifyListener0</span><span class="params">(Future future, GenericFutureListener l)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            l.operationComplete(future);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            <span class="keyword">if</span> (logger.isWarnEnabled()) &#123;</span><br><span class="line">                logger.warn(<span class="string">"An exception was thrown by "</span> + l.getClass().getName() + <span class="string">".operationComplete()"</span>, t);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åçœ‹<code>wait()</code>å’Œ<code>sync()</code>æ–¹æ³•ä½“ç³»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultPromise</span>&lt;<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractFuture</span>&lt;<span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">Promise</span>&lt;<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... çœç•¥å…¶ä»–ä»£ç  ...</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Promise&lt;V&gt; <span class="title">await</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">// å¦‚æœPromiseæ‰§è¡Œå®Œæ¯•ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">        <span class="keyword">if</span> (isDone()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚æœå½“å‰çº¿ç¨‹ä¸­æ–­åˆ™ç›´æ¥æŠ›å‡ºInterruptedException</span></span><br><span class="line">        <span class="keyword">if</span> (Thread.interrupted()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException(toString());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ­»é”æ£€æµ‹</span></span><br><span class="line">        checkDeadLock();</span><br><span class="line">        <span class="comment">// åŠ é”ï¼ŒåŠ é”å¯¹è±¡æ˜¯å½“å‰Promiseå®ä¾‹</span></span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="comment">// è¿™é‡Œè®¾ç½®ä¸€ä¸ªæ­»å¾ªç¯ï¼Œç»ˆæ­¢æ¡ä»¶æ˜¯isDone()ä¸ºtrue</span></span><br><span class="line">            <span class="keyword">while</span> (!isDone()) &#123;</span><br><span class="line">                <span class="comment">// ç­‰å¾…çº¿ç¨‹æ•°åŠ 1</span></span><br><span class="line">                incWaiters();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// è¿™é‡Œè°ƒç”¨çš„æ˜¯Object#wait()æ–¹æ³•è¿›è¡Œé˜»å¡ï¼Œå¦‚æœçº¿ç¨‹è¢«ä¸­æ–­ä¼šæŠ›å‡ºInterruptedException</span></span><br><span class="line">                    wait();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="comment">// è§£é™¤é˜»å¡åç­‰å¾…çº¿ç¨‹æ•°å‡1</span></span><br><span class="line">                    decWaiters();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Promise&lt;V&gt; <span class="title">awaitUninterruptibly</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// å¦‚æœPromiseæ‰§è¡Œå®Œæ¯•ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">        <span class="keyword">if</span> (isDone()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ­»é”æ£€æµ‹</span></span><br><span class="line">        checkDeadLock();</span><br><span class="line">        <span class="keyword">boolean</span> interrupted = <span class="keyword">false</span>;</span><br><span class="line">        <span class="comment">// åŠ é”ï¼ŒåŠ é”å¯¹è±¡æ˜¯å½“å‰Promiseå®ä¾‹</span></span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            <span class="comment">// è¿™é‡Œè®¾ç½®ä¸€ä¸ªæ­»å¾ªç¯ï¼Œç»ˆæ­¢æ¡ä»¶æ˜¯isDone()ä¸ºtrue</span></span><br><span class="line">            <span class="keyword">while</span> (!isDone()) &#123;</span><br><span class="line">                 <span class="comment">// ç­‰å¾…çº¿ç¨‹æ•°åŠ 1</span></span><br><span class="line">                incWaiters();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// è¿™é‡Œè°ƒç”¨çš„æ˜¯Object#wait()æ–¹æ³•è¿›è¡Œé˜»å¡ï¼Œæ•è·äº†InterruptedExceptionå¼‚å¸¸ï¼Œå¦‚æœæŠ›å‡ºInterruptedExceptionè®°å½•çº¿ç¨‹çš„ä¸­æ–­çŠ¶æ€åˆ°interrupted</span></span><br><span class="line">                    wait();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    <span class="comment">// Interrupted while waiting.</span></span><br><span class="line">                    interrupted = <span class="keyword">true</span>;</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    <span class="comment">// è§£é™¤é˜»å¡åç­‰å¾…çº¿ç¨‹æ•°å‡1</span></span><br><span class="line">                    decWaiters();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚æœçº¿ç¨‹è¢«ä¸­æ–­è·³å‡ºç­‰å¾…é˜»å¡ï¼Œåˆ™æ¸…é™¤çº¿ç¨‹çš„ä¸­æ–­æ ‡å¿—ä½</span></span><br><span class="line">        <span class="keyword">if</span> (interrupted) &#123;</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// åé¢çš„å‡ ä¸ªå¸¦è¶…æ—¶æ—¶é™çš„wait()æ–¹æ³•éƒ½æ˜¯è°ƒç”¨await0()</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">await</span><span class="params">(<span class="keyword">long</span> timeout, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> await0(unit.toNanos(timeout), <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">await</span><span class="params">(<span class="keyword">long</span> timeoutMillis)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> await0(MILLISECONDS.toNanos(timeoutMillis), <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">awaitUninterruptibly</span><span class="params">(<span class="keyword">long</span> timeout, TimeUnit unit)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> await0(unit.toNanos(timeout), <span class="keyword">false</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="comment">// Should not be raised at all.</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InternalError();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">awaitUninterruptibly</span><span class="params">(<span class="keyword">long</span> timeoutMillis)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> await0(MILLISECONDS.toNanos(timeoutMillis), <span class="keyword">false</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            <span class="comment">// Should not be raised at all.</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InternalError();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// æ£€æŸ¥æ­»é”ï¼Œè¿™é‡Œåˆ¤æ–­äº†ç­‰å¾…çº¿ç¨‹æ˜¯äº‹ä»¶å¾ªç¯çº¿ç¨‹åˆ™ç›´æ¥æŠ›å‡ºBlockingOperationExceptionå¼‚å¸¸</span></span><br><span class="line">    <span class="comment">// ç®€å•æ¥è¯´å°±æ˜¯ï¼šPromiseçš„æ‰§è¡Œçº¿ç¨‹å’Œç­‰å¾…ç»“æœçš„çº¿ç¨‹ï¼Œä¸èƒ½æ˜¯åŒä¸€ä¸ªçº¿ç¨‹ï¼Œå¦åˆ™ä¾èµ–ä¼šæˆç¯</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">checkDeadLock</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        EventExecutor e = executor();</span><br><span class="line">        <span class="keyword">if</span> (e != <span class="keyword">null</span> &amp;&amp; e.inEventLoop()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> BlockingOperationException(toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Promise&lt;V&gt; <span class="title">sync</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">// åŒæ­¥æ°¸ä¹…é˜»å¡ç­‰å¾…</span></span><br><span class="line">        await();</span><br><span class="line">        <span class="comment">// é˜»å¡ç­‰å¾…è§£é™¤ï¼Œå¦‚æœæ‰§è¡Œå­˜åœ¨å¼‚å¸¸ï¼Œåˆ™ç›´æ¥æŠ›å‡º</span></span><br><span class="line">        rethrowIfFailed();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Promise&lt;V&gt; <span class="title">syncUninterruptibly</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// åŒæ­¥æ°¸ä¹…é˜»å¡ç­‰å¾… - å“åº”ä¸­æ–­</span></span><br><span class="line">        awaitUninterruptibly();</span><br><span class="line">        <span class="comment">// å¡ç­‰å¾…è§£é™¤ï¼Œå¦‚æœæ‰§è¡Œå­˜åœ¨å¼‚å¸¸ï¼Œåˆ™ç›´æ¥æŠ›å‡º</span></span><br><span class="line">        rethrowIfFailed();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// waitersåŠ 1ï¼Œå¦‚æœè¶…è¿‡Short.MAX_VALUEåˆ™æŠ›å‡ºIllegalStateException</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">incWaiters</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (waiters == Short.MAX_VALUE) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"too many waiters: "</span> + <span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        ++waiters;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// waiterså‡1</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">decWaiters</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        --waiters;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// causeä¸ä¸ºnullåˆ™æŠ›å‡º</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">rethrowIfFailed</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Throwable cause = cause();</span><br><span class="line">        <span class="keyword">if</span> (cause == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        PlatformDependent.throwException(cause);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">await0</span><span class="params">(<span class="keyword">long</span> timeoutNanos, <span class="keyword">boolean</span> interruptable)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">// å¦‚æœPromiseæ‰§è¡Œå®Œæ¯•ï¼Œç›´æ¥è¿”å›</span></span><br><span class="line">        <span class="keyword">if</span> (isDone()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚æœè¶…æ—¶æ—¶é™å°äº0é‚£ä¹ˆè¿”å›isDone()çš„ç»“æœ</span></span><br><span class="line">        <span class="keyword">if</span> (timeoutNanos &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> isDone();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚æœå…è®¸ä¸­æ–­ï¼Œå½“å‰çº¿ç¨‹çš„ä¸­æ–­æ ‡å¿—ä½ä¸ºtrueï¼Œåˆ™æŠ›å‡ºInterruptedException</span></span><br><span class="line">        <span class="keyword">if</span> (interruptable &amp;&amp; Thread.interrupted()) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> InterruptedException(toString());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ­»é”æ£€æµ‹</span></span><br><span class="line">        checkDeadLock();</span><br><span class="line">        <span class="comment">// è®°å½•å½“å‰çš„çº³ç§’æ—¶é—´æˆ³</span></span><br><span class="line">        <span class="keyword">long</span> startTime = System.nanoTime();</span><br><span class="line">        <span class="comment">// ç­‰å¾…æ—¶é—´çš„é•¿åº¦ - å•ä½ä¸ºçº³ç§’</span></span><br><span class="line">        <span class="keyword">long</span> waitTime = timeoutNanos;</span><br><span class="line">        <span class="comment">// è®°å½•çº¿ç¨‹æ˜¯å¦è¢«ä¸­æ–­</span></span><br><span class="line">        <span class="keyword">boolean</span> interrupted = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// æ­»å¾ªç¯</span></span><br><span class="line">            <span class="keyword">for</span> (;;) &#123;</span><br><span class="line">                <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">                    <span class="comment">// å¦‚æœPromiseæ‰§è¡Œå®Œæ¯•ï¼Œç›´æ¥è¿”å›true - è¿™ä¸€æ­¥æ˜¯å…ˆéªŒåˆ¤æ–­ï¼Œå‘½ä¸­äº†å°±ä¸éœ€è¦é˜»å¡ç­‰å¾…</span></span><br><span class="line">                    <span class="keyword">if</span> (isDone()) &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// ç­‰å¾…çº¿ç¨‹æ•°åŠ 1</span></span><br><span class="line">                    incWaiters();</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        <span class="comment">// è¿™é‡Œè°ƒç”¨çš„æ˜¯å¸¦è¶…æ—¶æ—¶é™çš„Object#wait()æ–¹æ³•è¿›è¡Œé˜»å¡</span></span><br><span class="line">                        wait(waitTime / <span class="number">1000000</span>, (<span class="keyword">int</span>) (waitTime % <span class="number">1000000</span>));</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        <span class="comment">// çº¿ç¨‹è¢«ä¸­æ–­å¹¶ä¸”å¤–éƒ¨å…è®¸ä¸­æ–­ï¼Œé‚£ä¹ˆç›´æ¥æŠ›å‡ºInterruptedException</span></span><br><span class="line">                        <span class="keyword">if</span> (interruptable) &#123;</span><br><span class="line">                            <span class="keyword">throw</span> e;</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="comment">// å¦åˆ™åªè®°å½•ä¸­æ–­è¿‡çš„çŠ¶æ€</span></span><br><span class="line">                            interrupted = <span class="keyword">true</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        <span class="comment">// è§£é™¤é˜»å¡åç­‰å¾…çº¿ç¨‹æ•°å‡1</span></span><br><span class="line">                        decWaiters();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">// è§£é™¤é˜»å¡åï¼Œå¦‚æœPromiseæ‰§è¡Œå®Œæ¯•ï¼Œç›´æ¥è¿”å›true</span></span><br><span class="line">                <span class="keyword">if</span> (isDone()) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// æ­¥å…¥è¿™é‡Œè¯´æ˜Promiseå°šæœªæ‰§è¡Œå®Œæ¯•ï¼Œåˆ™é‡æ–°è®¡ç®—ç­‰å¾…æ—¶é—´é—´éš”çš„é•¿åº¦æ•°é‡ï¼ˆä¿®æ­£ï¼‰ï¼Œå¦‚æœå¤§äº0åˆ™è¿›å…¥ä¸‹ä¸€è½®å¾ªç¯</span></span><br><span class="line">                    waitTime = timeoutNanos - (System.nanoTime() - startTime);</span><br><span class="line">                    <span class="keyword">if</span> (waitTime &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">                        <span class="keyword">return</span> isDone();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="comment">// å¦‚æœçº¿ç¨‹è¢«ä¸­æ–­è·³å‡ºç­‰å¾…é˜»å¡ï¼Œåˆ™æ¸…é™¤çº¿ç¨‹çš„ä¸­æ–­æ ‡å¿—ä½</span></span><br><span class="line">            <span class="keyword">if</span> (interrupted) &#123;</span><br><span class="line">                Thread.currentThread().interrupt();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ... çœç•¥å…¶ä»–ä»£ç  ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åæ˜¯å‡ ä¸ªè®¾ç½®ç»“æœå’Œè·å–ç»“æœçš„æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultPromise</span>&lt;<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractFuture</span>&lt;<span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">Promise</span>&lt;<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ... çœç•¥å…¶ä»–ä»£ç  ...</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Promise&lt;V&gt; <span class="title">setSuccess</span><span class="params">(V result)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// è®¾ç½®æˆåŠŸç»“æœï¼Œå¦‚æœè®¾ç½®æˆåŠŸåˆ™è¿”å›å½“å‰Promiseå®ä¾‹</span></span><br><span class="line">        <span class="keyword">if</span> (setSuccess0(result)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è®¾ç½®å¤±è´¥è¯´æ˜äº†å¤šæ¬¡è®¾ç½®ï¼ŒPromiseå·²ç»æ‰§è¡Œå®Œæ¯•ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"complete already: "</span> + <span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">trySuccess</span><span class="params">(V result)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// è®¾ç½®æˆåŠŸç»“æœï¼Œè¿”å›çš„å¸ƒå°”å€¼è¡¨ç¤ºæˆåŠŸæˆ–å¤±è´¥</span></span><br><span class="line">        <span class="keyword">return</span> setSuccess0(result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Promise&lt;V&gt; <span class="title">setFailure</span><span class="params">(Throwable cause)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// è®¾ç½®å¤±è´¥ç»“æœï¼Œå¦‚æœè®¾ç½®æˆåŠŸåˆ™è¿”å›å½“å‰Promiseå®ä¾‹</span></span><br><span class="line">        <span class="keyword">if</span> (setFailure0(cause)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è®¾ç½®å¤±è´¥è¯´æ˜äº†å¤šæ¬¡è®¾ç½®ï¼ŒPromiseå·²ç»æ‰§è¡Œå®Œæ¯•ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"complete already: "</span> + <span class="keyword">this</span>, cause);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">tryFailure</span><span class="params">(Throwable cause)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// è®¾ç½®å¤±è´¥ç»“æœï¼Œè¿”å›çš„å¸ƒå°”å€¼è¡¨ç¤ºæˆåŠŸæˆ–å¤±è´¥</span></span><br><span class="line">        <span class="keyword">return</span> setFailure0(cause);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> V <span class="title">getNow</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// éé˜»å¡è·å–ç»“æœï¼Œå¦‚æœresultæ˜¯CauseHolderç±»å‹ã€SUCCESSå±æ€§å®ä¾‹æˆ–è€…UNCANCELLABLEå®è¡Œå®ä¾‹åˆ™è¿”å›nullï¼Œå¦åˆ™è¿”å›è½¬æ¢ç±»å‹åçš„resultå€¼</span></span><br><span class="line">        <span class="comment">// å¯¹å¼‚å¸¸æ— æ„ŸçŸ¥ï¼Œå¦‚æœCauseHolderåŒ…è£¹äº†å¼‚å¸¸ï¼Œæ­¤æ–¹æ³•ä¾ç„¶è¿”å›null</span></span><br><span class="line">        Object result = <span class="keyword">this</span>.result;</span><br><span class="line">        <span class="keyword">if</span> (result <span class="keyword">instanceof</span> CauseHolder || result == SUCCESS || result == UNCANCELLABLE) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (V) result;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, ExecutionException </span>&#123;</span><br><span class="line">        <span class="comment">// æ°¸ä¹…é˜»å¡è·å–ç»“æœ</span></span><br><span class="line">        Object result = <span class="keyword">this</span>.result;</span><br><span class="line">        <span class="comment">// å¦‚æœPromiseæœªæ‰§è¡Œå®Œæ¯•åˆ™è¿›è¡Œæ°¸ä¹…é˜»å¡ç­‰å¾…</span></span><br><span class="line">        <span class="keyword">if</span> (!isDone0(result)) &#123;</span><br><span class="line">            await();</span><br><span class="line">            <span class="comment">// æ›´æ–°ç»“æœä¸´æ—¶å˜é‡</span></span><br><span class="line">            result = <span class="keyword">this</span>.result;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// resultä¸ºSUCCESSå±æ€§å®ä¾‹æˆ–è€…UNCANCELLABLEå±æ€§å®ä¾‹çš„æ—¶å€™ç›´æ¥è¿”å›null</span></span><br><span class="line">        <span class="keyword">if</span> (result == SUCCESS || result == UNCANCELLABLE) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚æœresultä¸ºCauseHolderç±»å‹ï¼Œåˆ™è·å–å…¶ä¸­æŒæœ‰çš„causeå±æ€§ï¼Œä¹Ÿæœ‰å¯èƒ½ä¸ºnull</span></span><br><span class="line">        Throwable cause = cause0(result);</span><br><span class="line">        <span class="keyword">if</span> (cause == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// æ‰§è¡ŒæˆåŠŸçš„å‰æä¸‹è½¬æ¢ç±»å‹åçš„resultå€¼è¿”å›</span></span><br><span class="line">            <span class="keyword">return</span> (V) result;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å–æ¶ˆçš„æƒ…å†µï¼ŒæŠ›å‡ºCancellationException</span></span><br><span class="line">        <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> CancellationException) &#123;</span><br><span class="line">            <span class="keyword">throw</span> (CancellationException) cause;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å‰©ä½™çš„æƒ…å†µä¸€å¾‹å°è£…ä¸ºExecutionExceptionå¼‚å¸¸</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ExecutionException(cause);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(<span class="keyword">long</span> timeout, TimeUnit unit)</span> <span class="keyword">throws</span> InterruptedException, ExecutionException, TimeoutException </span>&#123;</span><br><span class="line">        <span class="comment">// å¸¦è¶…æ—¶æ—¶é™çš„é˜»å¡è·å–ç»“æœ</span></span><br><span class="line">        Object result = <span class="keyword">this</span>.result;</span><br><span class="line">        <span class="comment">// å¦‚æœPromiseæœªæ‰§è¡Œå®Œæ¯•åˆ™è¿›è¡Œå¸¦è¶…æ—¶æ—¶é™çš„é˜»å¡ç­‰å¾…</span></span><br><span class="line">        <span class="keyword">if</span> (!isDone0(result)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!await(timeout, unit)) &#123;</span><br><span class="line">                <span class="comment">// ç­‰å¾…è¶…æ—¶ç›´æ¥æŠ›å‡ºTimeoutException</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> TimeoutException();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// æ›´æ–°ç»“æœä¸´æ—¶å˜é‡</span></span><br><span class="line">            result = <span class="keyword">this</span>.result;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// resultä¸ºSUCCESSå±æ€§å®ä¾‹æˆ–è€…UNCANCELLABLEå±æ€§å®ä¾‹çš„æ—¶å€™ç›´æ¥è¿”å›null</span></span><br><span class="line">        <span class="keyword">if</span> (result == SUCCESS || result == UNCANCELLABLE) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚æœresultä¸ºCauseHolderç±»å‹ï¼Œåˆ™è·å–å…¶ä¸­æŒæœ‰çš„causeå±æ€§ï¼Œä¹Ÿæœ‰å¯èƒ½ä¸ºnull</span></span><br><span class="line">        Throwable cause = cause0(result);</span><br><span class="line">        <span class="keyword">if</span> (cause == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="comment">// æ‰§è¡ŒæˆåŠŸçš„å‰æä¸‹è½¬æ¢ç±»å‹åçš„resultå€¼è¿”å›</span></span><br><span class="line">            <span class="keyword">return</span> (V) result;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å–æ¶ˆçš„æƒ…å†µï¼ŒæŠ›å‡ºCancellationException</span></span><br><span class="line">        <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> CancellationException) &#123;</span><br><span class="line">            <span class="keyword">throw</span> (CancellationException) cause;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å‰©ä½™çš„æƒ…å†µä¸€å¾‹å°è£…ä¸ºExecutionExceptionå¼‚å¸¸</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ExecutionException(cause);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">cancel</span><span class="params">(<span class="keyword">boolean</span> mayInterruptIfRunning)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// CASæ›´æ–°resultä¸ºCANCELLATION_CAUSE_HOLDERï¼Œresultçš„æœŸæœ›å€¼å¿…é¡»ä¸ºnull</span></span><br><span class="line">        <span class="keyword">if</span> (RESULT_UPDATER.compareAndSet(<span class="keyword">this</span>, <span class="keyword">null</span>, CANCELLATION_CAUSE_HOLDER)) &#123;</span><br><span class="line">            <span class="comment">// åˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡Œç­‰å¾…çº¿ç¨‹çš„é€šçŸ¥</span></span><br><span class="line">            <span class="keyword">if</span> (checkNotifyWaiters()) &#123;</span><br><span class="line">                <span class="comment">// é€šçŸ¥ç›‘å¬å™¨è¿›è¡Œå›è°ƒ</span></span><br><span class="line">                notifyListeners();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">setSuccess0</span><span class="params">(V result)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// è®¾ç½®æ‰§è¡ŒæˆåŠŸçš„ç»“æœï¼Œå¦‚æœå…¥å‚resultä¸ºnullï¼Œåˆ™é€‰ç”¨SUCCESSå±æ€§ï¼Œå¦åˆ™ä½¿ç”¨result</span></span><br><span class="line">        <span class="keyword">return</span> setValue0(result == <span class="keyword">null</span> ? SUCCESS : result);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">setFailure0</span><span class="params">(Throwable cause)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// è®¾ç½®æ‰§è¡Œå¤±è´¥çš„ç»“æœï¼Œå…¥å‚æ˜¯Throwableç±»å‹ï¼Œå°è£…ä¸ºCauseHolderï¼Œå­˜æ”¾åœ¨CauseHolderå®ä¾‹çš„causeå±æ€§</span></span><br><span class="line">        <span class="keyword">return</span> setValue0(<span class="keyword">new</span> CauseHolder(checkNotNull(cause, <span class="string">"cause"</span>)));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">setValue0</span><span class="params">(Object objResult)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// CASæ›´æ–°resultä¸ºå…¥å‚objResultï¼Œresultçš„æœŸæœ›å€¼å¿…é¡»ä¸ºnullæˆ–è€…UNCANCELLABLEæ‰èƒ½æ›´æ–°æˆåŠŸ</span></span><br><span class="line">        <span class="keyword">if</span> (RESULT_UPDATER.compareAndSet(<span class="keyword">this</span>, <span class="keyword">null</span>, objResult) || RESULT_UPDATER.compareAndSet(<span class="keyword">this</span>, UNCANCELLABLE, objResult)) &#123;</span><br><span class="line">            <span class="comment">// åˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡Œç­‰å¾…çº¿ç¨‹çš„é€šçŸ¥</span></span><br><span class="line">            <span class="keyword">if</span> (checkNotifyWaiters()) &#123;</span><br><span class="line">                <span class="comment">// é€šçŸ¥ç›‘å¬å™¨è¿›è¡Œå›è°ƒ</span></span><br><span class="line">                notifyListeners();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡Œç­‰å¾…çº¿ç¨‹çš„é€šçŸ¥ - å…¶å®æ˜¯åˆ¤æ–­æ˜¯å¦éœ€è¦é€šçŸ¥ç›‘å¬å™¨å›è°ƒ</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">boolean</span> <span class="title">checkNotifyWaiters</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// å¦‚æœç­‰å¾…çº¿ç¨‹æ•°é‡å¤§äº0åˆ™è°ƒç”¨Object#notifyAll()å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹</span></span><br><span class="line">        <span class="keyword">if</span> (waiters &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¦‚æœlistenersä¸ä¸ºç©ºï¼ˆä¹Ÿå°±æ˜¯å­˜åœ¨ç›‘å¬å™¨ï¼‰çš„æ—¶å€™æ‰è¿”å›true</span></span><br><span class="line">        <span class="keyword">return</span> listeners != <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ... çœç•¥å…¶ä»–ä»£ç  ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Promiseçš„åŸºæœ¬ä½¿ç”¨">Promiseçš„åŸºæœ¬ä½¿ç”¨</h2><p>è¦ä½¿ç”¨<code>Netty</code>çš„<code>Promise</code>æ¨¡å—ï¼Œå¹¶ä¸éœ€è¦å¼•å…¥<code>Netty</code>çš„æ‰€æœ‰ä¾èµ–ï¼Œè¿™é‡Œåªéœ€è¦å¼•å…¥<code>netty-common</code>ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.netty<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>netty-common<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.44.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>EventExecutor</code>é€‰å–æ–¹é¢ï¼Œ<code>Netty</code>å·²ç»å‡†å¤‡äº†ä¸€ä¸ª<code>GlobalEventExecutor</code>ç”¨äºå…¨å±€äº‹ä»¶å¤„ç†ï¼Œè¿™é‡Œå¯ä»¥ç›´æ¥é€‰ç”¨ï¼ˆå½“ç„¶ä¹Ÿå¯ä»¥è‡ªè¡Œå®ç°<code>EventExecutor</code>æˆ–è€…ç”¨<code>EventExecutor</code>çš„å…¶ä»–å®ç°ç±»ï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">EventExecutor executor = GlobalEventExecutor.INSTANCE;</span><br><span class="line">Promise&lt;String&gt; promise = <span class="keyword">new</span> DefaultPromise&lt;&gt;(executor);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè®¾è®¡ä¸€ä¸ªåœºæ™¯ï¼šå¼‚æ­¥ä¸‹è½½ä¸€ä¸ªé“¾æ¥çš„èµ„æºåˆ°ç£ç›˜ä¸Šï¼Œä¸‹è½½å®Œæˆä¹‹åéœ€è¦å¼‚æ­¥é€šçŸ¥ä¸‹è½½å®Œçš„ç£ç›˜æ–‡ä»¶è·¯å¾„ï¼Œå¾—åˆ°é€šçŸ¥ä¹‹åæ‰“å°ä¸‹è½½ç»“æœåˆ°æ§åˆ¶å°ä¸­ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PromiseMain</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String url = <span class="string">"http://xxx.yyy.zzz"</span>;</span><br><span class="line">        EventExecutor executor = GlobalEventExecutor.INSTANCE;</span><br><span class="line">        Promise&lt;DownloadResult&gt; promise = <span class="keyword">new</span> DefaultPromise&lt;&gt;(executor);</span><br><span class="line">        promise.addListener(<span class="keyword">new</span> DownloadResultListener());</span><br><span class="line">        Thread thread = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                System.out.println(<span class="string">"å¼€å§‹ä¸‹è½½èµ„æº,url:"</span> + url);</span><br><span class="line">                <span class="keyword">long</span> start = System.currentTimeMillis();</span><br><span class="line">                <span class="comment">// æ¨¡æ‹Ÿä¸‹è½½è€—æ—¶</span></span><br><span class="line">                Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">                String location = <span class="string">"C:\\xxx\\yyy\\z.md"</span>;</span><br><span class="line">                <span class="keyword">long</span> cost = System.currentTimeMillis() - start;</span><br><span class="line">                System.out.println(String.format(<span class="string">"ä¸‹è½½èµ„æºæˆåŠŸ,url:%s,ä¿å­˜åˆ°:%s,è€—æ—¶:%d ms"</span>, url, location, cost));</span><br><span class="line">                DownloadResult result = <span class="keyword">new</span> DownloadResult();</span><br><span class="line">                result.setUrl(url);</span><br><span class="line">                result.setFileDiskLocation(location);</span><br><span class="line">                result.setCost(cost);</span><br><span class="line">                <span class="comment">// é€šçŸ¥ç»“æœ</span></span><br><span class="line">                promise.setSuccess(result);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception ignore) &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="string">"Download-Thread"</span>);</span><br><span class="line">        thread.start();</span><br><span class="line">        Thread.sleep(Long.MAX_VALUE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DownloadResult</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String url;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String fileDiskLocation;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">long</span> cost;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DownloadResultListener</span> <span class="keyword">implements</span> <span class="title">GenericFutureListener</span>&lt;<span class="title">Future</span>&lt;<span class="title">DownloadResult</span>&gt;&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operationComplete</span><span class="params">(Future&lt;DownloadResult&gt; future)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (future.isSuccess()) &#123;</span><br><span class="line">                DownloadResult downloadResult = future.getNow();</span><br><span class="line">                System.out.println(String.format(<span class="string">"ä¸‹è½½å®Œæˆé€šçŸ¥,url:%s,æ–‡ä»¶ç£ç›˜è·¯å¾„:%s,è€—æ—¶:%d ms"</span>, downloadResult.getUrl(),</span><br><span class="line">                        downloadResult.getFileDiskLocation(), downloadResult.getCost()));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œåæ§åˆ¶å°è¾“å‡ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">å¼€å§‹ä¸‹è½½èµ„æº,url:http://xxx.yyy.zzz</span><br><span class="line">ä¸‹è½½èµ„æºæˆåŠŸ,url:http://xxx.yyy.zzz,ä¿å­˜åˆ°:C:\xxx\yyy\z.md,è€—æ—¶:2000 ms</span><br><span class="line">ä¸‹è½½å®Œæˆé€šçŸ¥,url:http://xxx.yyy.zzz,æ–‡ä»¶ç£ç›˜è·¯å¾„:C:\xxx\yyy\z.md,è€—æ—¶:2000 ms</span><br></pre></td></tr></table></figure><p><code>Promise</code>é€‚ç”¨çš„åœºæ™¯å¾ˆå¤šï¼Œé™¤äº†å¼‚æ­¥é€šçŸ¥çš„åœºæ™¯ä¹Ÿèƒ½ç”¨äºåŒæ­¥è°ƒç”¨ï¼Œå®ƒåœ¨è®¾è®¡ä¸Šæ¯”<code>JUC</code>çš„<code>Future</code>çµæ´»å¾ˆå¤šï¼ŒåŸºäº<code>Future</code>æ‰©å±•å‡ºå¾ˆå¤šæ–°çš„ç‰¹æ€§ï¼Œæœ‰éœ€è¦çš„å¯ä»¥å•ç‹¬å¼•å…¥æ­¤ä¾èµ–ç›´æ¥ä½¿ç”¨ã€‚</p><h2 id="Promiseç›‘å¬å™¨æ ˆæ·±åº¦çš„é—®é¢˜">Promiseç›‘å¬å™¨æ ˆæ·±åº¦çš„é—®é¢˜</h2><p>æœ‰äº›æ—¶å€™ï¼Œç”±äºå°è£…æˆ–è€…äººä¸ºç¼–ç å¼‚å¸¸ç­‰åŸå› ï¼Œç›‘å¬å™¨çš„å›è°ƒå¯èƒ½å‡ºç°åŸºäºå¤šä¸ª<code>Promise</code>å½¢æˆçš„é“¾ï¼ˆå‚è€ƒ<a href="https://github.com/netty/netty/pull/5302" target="_blank" rel="noopener">Issue-5302</a>ï¼Œ<code>a promise listener chain</code>ï¼‰ï¼Œè¿™æ ·å­æœ‰å¯èƒ½å‡ºç°é€’å½’è°ƒç”¨æ·±åº¦è¿‡å¤§è€Œå¯¼è‡´æ ˆæº¢å‡ºï¼Œå› æ­¤éœ€è¦è®¾ç½®ä¸€ä¸ªé˜ˆå€¼ï¼Œé™åˆ¶é€’å½’è°ƒç”¨çš„æœ€å¤§æ ˆæ·±åº¦ï¼Œè¿™ä¸ªæ·±åº¦é˜ˆå€¼æš‚ä¸”ç§°ä¸ºæ ˆæ·±åº¦ä¿æŠ¤é˜ˆå€¼ï¼Œé»˜è®¤å€¼æ˜¯8ï¼Œå¯ä»¥é€šè¿‡ç³»ç»Ÿå‚æ•°<code>io.netty.defaultPromise.maxListenerStackDepth</code>è¦†ç›–è®¾ç½®ã€‚è¿™é‡Œè´´å‡ºå‰é¢æåˆ°è¿‡çš„ä»£ç å—ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">notifyListeners</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    EventExecutor executor = executor();</span><br><span class="line">    <span class="comment">// äº‹ä»¶æ‰§è¡Œå™¨å¿…é¡»æ˜¯äº‹ä»¶å¾ªç¯ç±»å‹ï¼Œä¹Ÿå°±æ˜¯executor.inEventLoop()ä¸ºtrueçš„æ—¶å€™æ‰å¯ç”¨é€’å½’æ ˆæ·±åº¦ä¿æŠ¤</span></span><br><span class="line">    <span class="keyword">if</span> (executor.inEventLoop()) &#123;</span><br><span class="line">        <span class="comment">// è·å–å½“å‰çº¿ç¨‹ç»‘å®šçš„InternalThreadLocalMapå®ä¾‹ï¼Œè¿™é‡Œç±»ä¼¼äºThreadLocal</span></span><br><span class="line">        <span class="keyword">final</span> InternalThreadLocalMap threadLocals = InternalThreadLocalMap.get();</span><br><span class="line">        <span class="comment">// è·å–å½“å‰çº¿ç¨‹çš„ç›‘å¬å™¨è°ƒç”¨æ ˆæ·±åº¦</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> stackDepth = threadLocals.futureListenerStackDepth();</span><br><span class="line">        <span class="comment">// ç›‘å¬å™¨è°ƒç”¨æ ˆæ·±åº¦å¦‚æœä¸è¶…è¿‡é˜ˆå€¼MAX_LISTENER_STACK_DEPTH</span></span><br><span class="line">        <span class="keyword">if</span> (stackDepth &lt; MAX_LISTENER_STACK_DEPTH) &#123;</span><br><span class="line">            <span class="comment">// è°ƒç”¨notifyListenersNow()å‰å…ˆè®¾ç½®ç›‘å¬å™¨è°ƒç”¨æ ˆæ·±åº¦ + 1</span></span><br><span class="line">            threadLocals.setFutureListenerStackDepth(stackDepth + <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                notifyListenersNow();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="comment">// è°ƒç”¨notifyListenersNow()å®Œæ¯•åè®¾ç½®ç›‘å¬å™¨è°ƒç”¨æ ˆæ·±åº¦ä¸ºè°ƒç”¨å‰çš„æ•°å€¼ï¼Œä¹Ÿå°±æ˜¯æ¢å¤çº¿ç¨‹çš„ç›‘å¬å™¨è°ƒç”¨æ ˆæ·±åº¦</span></span><br><span class="line">                threadLocals.setFutureListenerStackDepth(stackDepth);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœç›‘å¬å™¨è°ƒç”¨æ ˆæ·±åº¦è¶…è¿‡é˜ˆå€¼MAX_LISTENER_STACK_DEPTHï¼Œåˆ™ç›´æ¥æ¯æ¬¡é€šçŸ¥ç›‘å¬å™¨å½“æˆä¸€ä¸ªæ–°çš„å¼‚æ­¥ä»»åŠ¡å¤„ç†</span></span><br><span class="line">    safeExecute(executor, <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            notifyListenersNow();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœæˆ‘ä»¬æƒ³æ¨¡æ‹Ÿä¸€ä¸ªä¾‹å­è§¦å‘<strong>ç›‘å¬å™¨è°ƒç”¨æ ˆæ·±åº¦ä¿æŠ¤</strong>ï¼Œé‚£ä¹ˆåªéœ€è¦æƒ³åŠæ³•åœ¨åŒä¸€ä¸ª<code>EventLoop</code>ç±»å‹çš„çº¿ç¨‹ä¸­é€’å½’è°ƒç”¨<code>notifyListeners()</code>æ–¹æ³•å³å¯ã€‚</p><p>æœ€å…¸å‹çš„ä¾‹å­å°±æ˜¯åœ¨ä¸Šä¸€ä¸ª<code>Promise</code>ç›‘å¬å™¨å›è°ƒçš„æ–¹æ³•é‡Œé¢è§¦å‘ä¸‹ä¸€ä¸ª<code>Promise</code>çš„ç›‘å¬å™¨çš„<code>setSuccess()</code>ï¼ˆç®€å•ç†è§£å°±æ˜¯<strong>å¥—å¨ƒ</strong>ï¼‰ï¼Œç”»ä¸ªå›¾ç†è§£ä¸€ä¸‹ï¼š</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/202001/n-c-u-p-2.png" alt=""></p><p>æµ‹è¯•ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PromiseListenerMain</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> AtomicInteger COUNTER = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        EventExecutor executor = ImmediateEventExecutor.INSTANCE;</span><br><span class="line">        <span class="comment">// root</span></span><br><span class="line">        Promise&lt;String&gt; root = <span class="keyword">new</span> DefaultPromise&lt;&gt;(executor);</span><br><span class="line">        Promise&lt;String&gt; p1 = <span class="keyword">new</span> DefaultPromise&lt;&gt;(executor);</span><br><span class="line">        Promise&lt;String&gt; p2 = <span class="keyword">new</span> DefaultPromise&lt;&gt;(executor);</span><br><span class="line">        Promise&lt;String&gt; p3 = <span class="keyword">new</span> DefaultPromise&lt;&gt;(executor);</span><br><span class="line">        Promise&lt;String&gt; p4 = <span class="keyword">new</span> DefaultPromise&lt;&gt;(executor);</span><br><span class="line">        Promise&lt;String&gt; p5 = <span class="keyword">new</span> DefaultPromise&lt;&gt;(executor);</span><br><span class="line">        Promise&lt;String&gt; p6 = <span class="keyword">new</span> DefaultPromise&lt;&gt;(executor);</span><br><span class="line">        Promise&lt;String&gt; p7 = <span class="keyword">new</span> DefaultPromise&lt;&gt;(executor);</span><br><span class="line">        Promise&lt;String&gt; p8 = <span class="keyword">new</span> DefaultPromise&lt;&gt;(executor);</span><br><span class="line">        Promise&lt;String&gt; p9 = <span class="keyword">new</span> DefaultPromise&lt;&gt;(executor);</span><br><span class="line">        Promise&lt;String&gt; p10 = <span class="keyword">new</span> DefaultPromise&lt;&gt;(executor);</span><br><span class="line">        p1.addListener(<span class="keyword">new</span> Listener(p2));</span><br><span class="line">        p2.addListener(<span class="keyword">new</span> Listener(p3));</span><br><span class="line">        p3.addListener(<span class="keyword">new</span> Listener(p4));</span><br><span class="line">        p4.addListener(<span class="keyword">new</span> Listener(p5));</span><br><span class="line">        p5.addListener(<span class="keyword">new</span> Listener(p6));</span><br><span class="line">        p6.addListener(<span class="keyword">new</span> Listener(p7));</span><br><span class="line">        p7.addListener(<span class="keyword">new</span> Listener(p8));</span><br><span class="line">        p8.addListener(<span class="keyword">new</span> Listener(p9));</span><br><span class="line">        p9.addListener(<span class="keyword">new</span> Listener(p10));</span><br><span class="line">        root.addListener(<span class="keyword">new</span> Listener(p1));</span><br><span class="line">        root.setSuccess(<span class="string">"success"</span>);</span><br><span class="line">        Thread.sleep(Long.MAX_VALUE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Listener</span> <span class="keyword">implements</span> <span class="title">GenericFutureListener</span>&lt;<span class="title">Future</span>&lt;<span class="title">String</span>&gt;&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String name;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Promise&lt;String&gt; promise;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Listener</span><span class="params">(Promise&lt;String&gt; promise)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.name = <span class="string">"listener-"</span> + COUNTER.getAndIncrement();</span><br><span class="line">            <span class="keyword">this</span>.promise = promise;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">operationComplete</span><span class="params">(Future&lt;String&gt; future)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">            System.out.println(String.format(<span class="string">"ç›‘å¬å™¨[%s]å›è°ƒæˆåŠŸ..."</span>, name));</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> != promise) &#123;</span><br><span class="line">                promise.setSuccess(<span class="string">"success"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› ä¸ºæœ‰<code>safeExecute()</code>å…œåº•æ‰§è¡Œï¼Œä¸Šé¢çš„æ‰€æœ‰<code>Promise</code>éƒ½ä¼šå›è°ƒï¼Œè¿™é‡Œå¯ä»¥é‡‡ç”¨<code>IDEA</code>çš„é«˜çº§æ–­ç‚¹åŠŸèƒ½ï¼Œåœ¨æ­¥å…¥æ–­ç‚¹çš„åœ°æ–¹æ·»åŠ é¢å¤–çš„æ—¥å¿—ï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">MAX_LISTENER_STACK_DEPTH(notifyListenersNow)æ‰§è¡Œ---</span><br><span class="line">ç›‘å¬å™¨[listener-<span class="number">9</span>]å›è°ƒæˆåŠŸ...</span><br><span class="line">MAX_LISTENER_STACK_DEPTH(notifyListenersNow)æ‰§è¡Œ---</span><br><span class="line">ç›‘å¬å™¨[listener-<span class="number">0</span>]å›è°ƒæˆåŠŸ...</span><br><span class="line">MAX_LISTENER_STACK_DEPTH(notifyListenersNow)æ‰§è¡Œ---</span><br><span class="line">ç›‘å¬å™¨[listener-<span class="number">1</span>]å›è°ƒæˆåŠŸ...</span><br><span class="line">MAX_LISTENER_STACK_DEPTH(notifyListenersNow)æ‰§è¡Œ---</span><br><span class="line">ç›‘å¬å™¨[listener-<span class="number">2</span>]å›è°ƒæˆåŠŸ...</span><br><span class="line">MAX_LISTENER_STACK_DEPTH(notifyListenersNow)æ‰§è¡Œ---</span><br><span class="line">ç›‘å¬å™¨[listener-<span class="number">3</span>]å›è°ƒæˆåŠŸ...</span><br><span class="line">MAX_LISTENER_STACK_DEPTH(notifyListenersNow)æ‰§è¡Œ---</span><br><span class="line">ç›‘å¬å™¨[listener-<span class="number">4</span>]å›è°ƒæˆåŠŸ...</span><br><span class="line">MAX_LISTENER_STACK_DEPTH(notifyListenersNow)æ‰§è¡Œ---</span><br><span class="line">ç›‘å¬å™¨[listener-<span class="number">5</span>]å›è°ƒæˆåŠŸ...</span><br><span class="line">MAX_LISTENER_STACK_DEPTH(notifyListenersNow)æ‰§è¡Œ---</span><br><span class="line">ç›‘å¬å™¨[listener-<span class="number">6</span>]å›è°ƒæˆåŠŸ...</span><br><span class="line">safeExecute(notifyListenersNow)æ‰§è¡Œ----------</span><br><span class="line">ç›‘å¬å™¨[listener-<span class="number">7</span>]å›è°ƒæˆåŠŸ...</span><br><span class="line">safeExecute(notifyListenersNow)æ‰§è¡Œ----------</span><br><span class="line">ç›‘å¬å™¨[listener-<span class="number">8</span>]å›è°ƒæˆåŠŸ...</span><br></pre></td></tr></table></figure><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/202001/n-c-u-p-3.png" alt=""></p><p>è¿™é‡Œç¬”è€…æœ‰ç‚¹ç–‘æƒ‘ï¼Œå¦‚æœè°ƒç”¨æ ˆæ·±åº¦å¤§äº8ï¼Œè¶…å‡ºçš„éƒ¨åˆ†ä¼šåŒ…è£…ä¸º<code>Runnable</code>å®ä¾‹æäº¤åˆ°äº‹ä»¶æ‰§è¡Œå™¨æ‰§è¡Œï¼Œå²‚ä¸æ˜¯æŠŠé€’å½’æ ˆæº¢å‡ºçš„éšæ‚£å˜æˆäº†å†…å­˜æº¢å‡ºçš„éšæ‚£ï¼ˆå› ä¸ºå¼‚æ­¥ä»»åŠ¡ä¹Ÿæœ‰å¯èƒ½ç§¯å‹ï¼Œé™¤éæ‹’ç»ä»»åŠ¡æäº¤ï¼Œé‚£ä¹ˆå…·ä½“è¦çœ‹<code>EventExecutor</code>çš„å®ç°äº†ï¼‰ï¼Ÿ</p><h2 id="å°ç»“">å°ç»“</h2><p><code>Netty</code>æä¾›çš„<code>Promise</code>å·¥å…·çš„æºç å’Œä½¿ç”¨æ–¹å¼éƒ½åˆ†æå®Œäº†ï¼Œè®¾è®¡ç†å¿µå’Œä»£ç éƒ½æ˜¯ååˆ†å€¼å¾—å€Ÿé‰´ï¼ŒåŒæ—¶èƒ½å¤Ÿå¼€ç®±å³ç”¨ï¼Œå¯ä»¥åœ¨æ—¥å¸¸ç¼–ç ä¸­ç›´æ¥å¼•å…¥ï¼Œå‡å°‘é‡å¤é€ è½®å­çš„åŠ³åŠ¨å’Œé£é™©ã€‚</p><p>ï¼ˆæœ¬æ–‡å®Œ e-a-20200123 c-3-dï¼‰</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰æ&quot;&gt;å‰æ&lt;/h2&gt;
&lt;p&gt;æœ€è¿‘ä¸€ç›´åœ¨çœ‹&lt;code&gt;Netty&lt;/code&gt;ç›¸å…³çš„å†…å®¹ï¼Œä¹Ÿåœ¨ç¼–å†™ä¸€ä¸ªè½»é‡çº§çš„&lt;code&gt;RPC&lt;/code&gt;æ¡†æ¶æ¥ç»ƒæ‰‹ï¼Œé€”ä¸­å‘ç°äº†&lt;code&gt;Netty&lt;/code&gt;çš„æºç æœ‰å¾ˆå¤šäº®ç‚¹ï¼ŒæŸäº›å®ç°ç”šè‡³å¯ä»¥ç”¨&lt;strong&gt;è‹›åˆ»&lt;/strong&gt;æ¥å½¢å®¹ã€‚å¦å¤–ï¼Œ&lt;code&gt;Netty&lt;/code&gt;æä¾›çš„å·¥å…·ç±»ä¹Ÿæ˜¯ç›¸å½“ä¼˜ç§€ï¼Œå¯ä»¥å¼€ç®±å³ç”¨ã€‚è¿™é‡Œåˆ†æä¸€ä¸‹ä¸ªäººæ¯”è¾ƒå–œæ¬¢çš„é¢†åŸŸï¼Œå¹¶å‘æ–¹é¢çš„ä¸€ä¸ª&lt;code&gt;Netty&lt;/code&gt;å·¥å…·æ¨¡å— - &lt;code&gt;Promise&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/202001/n-c-u-p-1.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
&lt;p&gt;ç¯å¢ƒç‰ˆæœ¬ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;Netty:4.1.44.Final&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;JDK1.8&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
    
      <category term="Netty" scheme="http://throwable.club/blog/categories/Netty/"/>
    
      <category term="Java" scheme="http://throwable.club/blog/categories/Netty/Java/"/>
    
    
      <category term="Java" scheme="http://throwable.club/blog/tags/Java/"/>
    
      <category term="Netty" scheme="http://throwable.club/blog/tags/Netty/"/>
    
  </entry>
  
  <entry>
    <title>çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ContextClassLoaderå†…å­˜æ³„æ¼éšæ‚£</title>
    <link href="http://throwable.club/2020/01/19/java-thread-context-class-loader-memory-leak-risk/"/>
    <id>http://throwable.club/2020/01/19/java-thread-context-class-loader-memory-leak-risk/</id>
    <published>2020-01-19T15:07:48.000Z</published>
    <updated>2020-01-20T00:32:17.916Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰æ">å‰æ</h2><p>ä»Šå¤©ï¼ˆ<code>2020-01-18</code>ï¼‰åœ¨ç¼–å†™<code>Netty</code>ç›¸å…³ä»£ç çš„æ—¶å€™ï¼Œä»<code>Netty</code>æºç ä¸­çš„<code>ThreadDeathWatcher</code>å’Œ<code>GlobalEventExecutor</code>è¿½æº¯åˆ°ä¸¤ä¸ªå’Œçº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨<code>ContextClassLoader</code>å†…å­˜æ³„æ¼ç›¸å…³çš„<code>Issue</code>ï¼š</p><ul><li><a href="https://github.com/netty/netty/issues/7290" target="_blank" rel="noopener">ThreadDeathWatcher causes custom classLoader script memory leaks</a></li><li><a href="https://github.com/netty/netty/pull/7493" target="_blank" rel="noopener">Ensure ThreadDeathWatcher and GlobalEventExecutor will not cause clasâ€¦</a></li></ul><p>ä¸¤ä¸ª<code>Issue</code>åˆ†åˆ«æ˜¯ä¸¤ä½å‰è¾ˆåœ¨<code>2017-12</code>çš„æ—¶å€™æå‡ºçš„ï¼Œæè¿°çš„æ˜¯åŒä¸€ç±»é—®é¢˜ï¼Œæœ€åè¢«<code>Netty</code>çš„è´Ÿè´£äººé‡‡çº³ï¼Œå¹¶ä¸”ä¿®å¤äº†å¯¹åº”çš„é—®é¢˜ä»è€Œå…³é—­äº†<code>Issue</code>ã€‚è¿™é‡ŒåŸºäºè¿™ä¸¤ä¸ª<code>Issue</code>æè¿°çš„å†…å®¹ï¼Œå¯¹<code>ContextClassLoader</code>å†…å­˜æ³„æ¼éšæ‚£åšä¸€æ¬¡å¤ç›˜ã€‚</p><a id="more"></a><h2 id="ClassLoaderç›¸å…³çš„å†…å®¹">ClassLoaderç›¸å…³çš„å†…å®¹</h2><ul><li>ä¸€ä¸ª<code>JVM</code>å®ä¾‹ï¼ˆ<code>Java</code>åº”ç”¨ç¨‹åºï¼‰é‡Œé¢çš„æ‰€æœ‰ç±»éƒ½æ˜¯é€šè¿‡<code>ClassLoader</code>åŠ è½½çš„ã€‚</li><li>ä¸åŒçš„<code>ClassLoader</code>åœ¨<code>JVM</code>ä¸­æœ‰ä¸åŒçš„å‘½åç©ºé—´ï¼Œä¸€ä¸ªç±»å®ä¾‹ï¼ˆ<code>Class</code>ï¼‰çš„å”¯ä¸€æ ‡è¯†æ˜¯å…¨ç±»å + <code>ClassLoader</code>ï¼Œä¹Ÿå°±æ˜¯ä¸åŒçš„<code>ClassLoader</code>åŠ è½½åŒä¸€ä¸ªç±»æ–‡ä»¶ï¼Œä¹Ÿä¼šå¾—åˆ°ä¸ç›¸åŒçš„<code>Class</code>å®ä¾‹ã€‚</li><li><code>JVM</code>ä¸æä¾›ç±»å¸è½½çš„åŠŸèƒ½ï¼Œä»ç›®å‰å‚è€ƒåˆ°çš„èµ„æ–™æ¥çœ‹ï¼Œç±»å¸è½½éœ€è¦æ»¡è¶³ä¸‹é¢å‡ ç‚¹ï¼š<ul><li>æ¡ä»¶ä¸€ï¼š<code>Class</code>çš„æ‰€æœ‰å®ä¾‹ä¸è¢«å¼ºå¼•ç”¨ï¼ˆä¸å¯è¾¾ï¼‰ã€‚</li><li>æ¡ä»¶äºŒï¼š<code>Class</code>æœ¬èº«ä¸è¢«å¼ºå¼•ç”¨ï¼ˆä¸å¯è¾¾ï¼‰ã€‚</li><li><font color=red>æ¡ä»¶ä¸‰</font>ï¼šåŠ è½½è¯¥<code>Class</code>çš„<code>ClassLoader</code>å®ä¾‹ä¸è¢«å¼ºå¼•ç”¨ï¼ˆä¸å¯è¾¾ï¼‰ã€‚</li></ul></li></ul><p>æœ‰äº›åœºæ™¯ä¸‹éœ€è¦å®ç°ç±»çš„çƒ­éƒ¨ç½²å’Œå¸è½½ï¼Œä¾‹å¦‚å®šä¹‰ä¸€ä¸ªæ¥å£ï¼Œç„¶åç”±å¤–éƒ¨åŠ¨æ€ä¼ å…¥ä»£ç çš„å®ç°ã€‚</p><blockquote><p>è¿™ä¸€ç‚¹å¾ˆå¸¸è§ï¼Œæœ€å…¸å‹çš„å°±æ˜¯åœ¨çº¿ç¼–ç¨‹ï¼Œä»£ç ä¼ åˆ°æœåŠ¡ç«¯å†è¿›è¡Œç¼–è¯‘å’Œè¿è¡Œã€‚</p></blockquote><p>ç”±äºåº”ç”¨å¯åŠ¨æœŸæ‰€æœ‰é<code>JDK</code>ç±»åº“çš„ç±»éƒ½æ˜¯ç”±<code>AppClassLoader</code>åŠ è½½ï¼Œæˆ‘ä»¬æ²¡æœ‰åŠæ³•é€šè¿‡<code>AppClassLoader</code>å»åŠ è½½éç±»è·¯å¾„ä¸‹çš„å·²å­˜åœ¨åŒåçš„ç±»æ–‡ä»¶ï¼ˆå¯¹äºä¸€ä¸ª<code>ClassLoader</code>è€Œè¨€ï¼Œæ¯ä¸ªç±»æ–‡ä»¶åªèƒ½åŠ è½½ä¸€æ¬¡ï¼Œç”Ÿæˆå”¯ä¸€çš„<code>Class</code>ï¼‰ï¼Œæ‰€ä»¥ä¸ºäº†åŠ¨æ€åŠ è½½ç±»ï¼Œæ¯æ¬¡å¿…é¡»ä½¿ç”¨å®Œå…¨ä¸åŒçš„è‡ªå®šä¹‰<code>ClassLoader</code>å®ä¾‹åŠ è½½åŒä¸€ä¸ªç±»æ–‡ä»¶æˆ–è€…ä½¿ç”¨åŒä¸€ä¸ªè‡ªå®šä¹‰çš„<code>ClassLoader</code>å®ä¾‹åŠ è½½ä¸åŒçš„ç±»æ–‡ä»¶ã€‚ç±»çš„çƒ­éƒ¨ç½²è¿™é‡Œä¸¾ä¸ªç®€å•ä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ­¤æ–‡ä»¶åœ¨é¡¹ç›®ç±»è·¯å¾„</span></span><br><span class="line"><span class="keyword">package</span> club.throwable.loader;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultHelloService</span> <span class="keyword">implements</span> <span class="title">HelloService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"default say hello!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¸‹é¢ä¸¤ä¸ªæ–‡ä»¶ç¼–è¯‘åæ”¾åœ¨Iç›˜æ ¹ç›®å½•</span></span><br><span class="line"><span class="comment">// I:\\DefaultHelloService1.class</span></span><br><span class="line"><span class="keyword">package</span> club.throwable.loader;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultHelloService1</span> <span class="keyword">implements</span> <span class="title">HelloService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"1 say hello!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// I:\\DefaultHelloService2.class</span></span><br><span class="line"><span class="keyword">package</span> club.throwable.loader;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultHelloService2</span> <span class="keyword">implements</span> <span class="title">HelloService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"2 say hello!"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¥å£å’Œè¿è¡Œæ–¹æ³•</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HelloService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">sayHello</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        HelloService helloService = <span class="keyword">new</span> DefaultHelloService();</span><br><span class="line">        System.out.println(helloService.sayHello());</span><br><span class="line">        ClassLoader loader = <span class="keyword">new</span> ClassLoader() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">                String location = <span class="string">"I:\\DefaultHelloService1.class"</span>;</span><br><span class="line">                <span class="keyword">if</span> (name.contains(<span class="string">"DefaultHelloService2"</span>)) &#123;</span><br><span class="line">                    location = <span class="string">"I:\\DefaultHelloService2.class"</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                File classFile = <span class="keyword">new</span> File(location);</span><br><span class="line">                ByteArrayOutputStream outputStream = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    InputStream stream = <span class="keyword">new</span> FileInputStream(classFile);</span><br><span class="line">                    <span class="keyword">int</span> b;</span><br><span class="line">                    <span class="keyword">while</span> ((b = stream.read()) != -<span class="number">1</span>) &#123;</span><br><span class="line">                        outputStream.write(b);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(e);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">byte</span>[] bytes = outputStream.toByteArray();</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">super</span>.defineClass(name, bytes, <span class="number">0</span>, bytes.length);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        Class&lt;?&gt; klass = loader.loadClass(<span class="string">"club.throwable.loader.DefaultHelloService1"</span>);</span><br><span class="line">        helloService = (HelloService) klass.newInstance();</span><br><span class="line">        System.out.println(helloService.sayHello());</span><br><span class="line">        klass = loader.loadClass(<span class="string">"club.throwable.loader.DefaultHelloService2"</span>);</span><br><span class="line">        helloService = (HelloService) klass.newInstance();</span><br><span class="line">        System.out.println(helloService.sayHello());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ§åˆ¶å°è¾“å‡º</span></span><br><span class="line"><span class="keyword">default</span> say hello!</span><br><span class="line"><span class="number">1</span> say hello!</span><br><span class="line"><span class="number">2</span> say hello!</span><br></pre></td></tr></table></figure><p>å¦‚æœæ–°å»ºè¿‡å¤šçš„<code>ClassLoader</code>å®ä¾‹å’Œ<code>Class</code>å®ä¾‹ï¼Œä¼šå ç”¨å¤§é‡çš„å†…å­˜ï¼Œå¦‚æœç”±äºä¸Šé¢å‡ ä¸ªæ¡ä»¶æ— æ³•å…¨éƒ¨æ»¡è¶³ï¼Œä¹Ÿå°±æ˜¯è¿™äº›<code>ClassLoader</code>å®ä¾‹å’Œ<code>Class</code>å®ä¾‹ä¸€ç›´å †ç§¯æ— æ³•å¸è½½ï¼Œé‚£ä¹ˆå°±ä¼šå¯¼è‡´å†…å­˜æ³„æ¼ï¼ˆ<code>memory leak</code>ï¼Œåæœå¾ˆä¸¥é‡ï¼Œæœ‰å¯èƒ½è€—å°½æœåŠ¡å™¨çš„ç‰©ç†å†…å­˜ï¼Œå› ä¸º<code>JDK1.8+</code>ç±»ç›¸å…³å…ƒä¿¡æ¯å­˜åœ¨åœ¨å…ƒç©ºé—´<code>metaspace</code>ï¼Œè€Œå…ƒç©ºé—´ä½¿ç”¨çš„æ˜¯<code>native memory</code>ï¼‰ã€‚</p><h2 id="çº¿ç¨‹ä¸­çš„ContextClassLoader">çº¿ç¨‹ä¸­çš„ContextClassLoader</h2><p><code>ContextClassLoader</code>å…¶å®æŒ‡çš„æ˜¯çº¿ç¨‹ç±»<code>java.lang.Thread</code>ä¸­çš„<code>contextClassLoader</code>å±æ€§ï¼Œå®ƒæ˜¯<code>ClassLoader</code>ç±»å‹ï¼Œä¹Ÿå°±æ˜¯ç±»åŠ è½½å™¨å®ä¾‹ã€‚æœ‰äº›åœºæ™¯ä¸‹ï¼Œ<code>JDK</code>æä¾›äº†ä¸€äº›æ ‡å‡†æ¥å£éœ€è¦ç¬¬ä¸‰æ–¹æä¾›å•†å»å®ç°ï¼ˆæœ€å¸¸è§çš„å°±æ˜¯<code>SPI</code>ï¼Œ<code>Service Provider Interface</code>ï¼Œä¾‹å¦‚<code>java.sql.Driver</code>ï¼‰ï¼Œè¿™äº›æ ‡å‡†æ¥å£ç±»æ˜¯ç”±å¯åŠ¨ç±»åŠ è½½å™¨(<code>Bootstrap ClassLoader</code>)åŠ è½½ï¼Œä½†æ˜¯è¿™äº›æ¥å£çš„å®ç°ç±»éœ€è¦ä»å¤–éƒ¨å¼•å…¥ï¼Œæœ¬èº«ä¸å±äº<code>JDK</code>çš„åŸç”Ÿç±»åº“ï¼Œæ— æ³•ç”¨å¯åŠ¨ç±»åŠ è½½å™¨åŠ è½½ã€‚ä¸ºäº†è§£å†³æ­¤å›°å¢ƒï¼Œå¼•å…¥äº†çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨<code>Thread Context ClassLoader</code>ã€‚çº¿ç¨‹<code>java.lang.Thread</code>å®ä¾‹åœ¨åˆå§‹åŒ–çš„æ—¶å€™ä¼šè°ƒç”¨<code>Thread#init()</code>æ–¹æ³•ï¼Œ<code>Thread</code>ç±»å’Œ<code>contextClassLoader</code>ç›¸å…³çš„æ ¸å¿ƒä»£ç å—å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// çº¿ç¨‹å®ä¾‹çš„åˆå§‹åŒ–æ–¹æ³•,new Thread()çš„æ—¶å€™ä¸€å®šä¼šè°ƒç”¨</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ThreadGroup g, Runnable target, String name,</span></span></span><br><span class="line"><span class="function"><span class="params">                      <span class="keyword">long</span> stackSize, AccessControlContext acc,</span></span></span><br><span class="line"><span class="function"><span class="params">                      <span class="keyword">boolean</span> inheritThreadLocals)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// çœç•¥å…¶ä»–ä»£ç </span></span><br><span class="line">    Thread parent = currentThread();</span><br><span class="line">    <span class="comment">// çœç•¥å…¶ä»–ä»£ç </span></span><br><span class="line">    <span class="keyword">if</span> (security == <span class="keyword">null</span> || isCCLOverridden(parent.getClass()))</span><br><span class="line">        <span class="keyword">this</span>.contextClassLoader = parent.getContextClassLoader();</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">this</span>.contextClassLoader = parent.contextClassLoader;</span><br><span class="line">    <span class="comment">// çœç•¥å…¶ä»–ä»£ç </span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setContextClassLoader</span><span class="params">(ClassLoader cl)</span> </span>&#123;</span><br><span class="line">    SecurityManager sm = System.getSecurityManager();</span><br><span class="line">    <span class="keyword">if</span> (sm != <span class="keyword">null</span>) &#123;</span><br><span class="line">        sm.checkPermission(<span class="keyword">new</span> RuntimePermission(<span class="string">"setContextClassLoader"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    contextClassLoader = cl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@CallerSensitive</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ClassLoader <span class="title">getContextClassLoader</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (contextClassLoader == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    SecurityManager sm = System.getSecurityManager();</span><br><span class="line">    <span class="keyword">if</span> (sm != <span class="keyword">null</span>) &#123;</span><br><span class="line">        ClassLoader.checkClassLoaderPermission(contextClassLoader, Reflection.getCallerClass());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> contextClassLoader;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆæ˜ç¡®ä¸¤ç‚¹ï¼š</p><ul><li><code>Thread</code>å®ä¾‹å…è®¸æ‰‹åŠ¨è®¾ç½®<code>contextClassLoader</code>å±æ€§ï¼Œè¦†ç›–å½“å‰çš„çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨å®ä¾‹ã€‚</li><li><code>Thread</code>åœ¨åˆå§‹åŒ–å®ä¾‹ï¼ˆè°ƒç”¨<code>new Thread()</code>ï¼‰çš„æ—¶å€™ä¸€å®šä¼šè°ƒç”¨<code>Thread#init()</code>æ–¹æ³•ï¼Œæ–°å»ºçš„å­çº¿ç¨‹å®ä¾‹ä¼šç»§æ‰¿çˆ¶çº¿ç¨‹çš„<code>contextClassLoader</code>å±æ€§ï¼Œè€Œåº”ç”¨ä¸»çº¿ç¨‹<code>[main]</code>çš„<code>contextClassLoader</code>ä¸€èˆ¬æ˜¯åº”ç”¨ç±»åŠ è½½å™¨ï¼ˆ<code>Application ClassLoader</code>ï¼Œæœ‰æ—¶ä¹Ÿç§°ä¸ºç³»ç»Ÿç±»åŠ è½½å™¨ï¼‰ï¼Œå…¶ä»–ç”¨æˆ·çº¿ç¨‹éƒ½æ˜¯ä¸»çº¿ç¨‹æ´¾ç”Ÿå‡ºæ¥çš„åä»£çº¿ç¨‹ï¼Œå¦‚æœä¸è¦†ç›–<code>contextClassLoader</code>ï¼Œé‚£ä¹ˆæ–°å»ºçš„åä»£çº¿ç¨‹çš„<code>contextClassLoader</code>å°±æ˜¯åº”ç”¨ç±»åŠ è½½å™¨ã€‚</li></ul><p>åˆ†æåˆ°è¿™é‡Œï¼Œç¬”è€…åªæƒ³è¯´æ˜ä¸€ä¸ªç»“è®ºï¼šåä»£çº¿ç¨‹çš„çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ä¼šç»§æ‰¿çˆ¶çº¿ç¨‹çš„çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼Œå…¶å®è¿™é‡Œç”¨ç»§æ‰¿è¿™ä¸ªè¯è¯­ä¹Ÿä¸æ˜¯å¤ªå‡†ç¡®ï¼Œå‡†ç¡®æ¥è¯´åº”è¯¥æ˜¯<strong>åä»£çº¿ç¨‹çš„çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨å’Œçˆ¶çº¿ç¨‹çš„ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨å®Œå…¨ç›¸åŒï¼Œå¦‚æœéƒ½æ´¾ç”Ÿè‡ªä¸»çº¿ç¨‹ï¼Œé‚£ä¹ˆéƒ½æ˜¯åº”ç”¨ç±»åŠ è½½å™¨</strong>ã€‚å¯¹äºè¿™ä¸ªç»“è®ºå¯ä»¥éªŒè¯ä¸€ä¸‹ï¼ˆä¸‹é¢ä¾‹å­åœ¨<code>JDK8</code>ä¸­è¿è¡Œï¼‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ThreadContextClassLoaderMain</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        AtomicReference&lt;Thread&gt; grandSonThreadReference = <span class="keyword">new</span> AtomicReference&lt;&gt;();</span><br><span class="line">        Thread sonThread = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            Thread thread = <span class="keyword">new</span> Thread(()-&gt; &#123;&#125;,<span class="string">"grand-son-thread"</span>);</span><br><span class="line">            grandSonThreadReference.set(thread);</span><br><span class="line">        &#125;, <span class="string">"son-thread"</span>);</span><br><span class="line">        sonThread.start();</span><br><span class="line">        Thread.sleep(<span class="number">100</span>);</span><br><span class="line">        Thread main = Thread.currentThread();</span><br><span class="line">        Thread grandSonThread = grandSonThreadReference.get();</span><br><span class="line">        System.out.println(String.format(<span class="string">"ContextClassLoader of [main]:%s"</span>, main.getContextClassLoader()));</span><br><span class="line">        System.out.println(String.format(<span class="string">"ContextClassLoader of [%s]:%s"</span>,sonThread.getName(), sonThread.getContextClassLoader()));</span><br><span class="line">        System.out.println(String.format(<span class="string">"ContextClassLoader of [%s]:%s"</span>, grandSonThread.getName(), grandSonThread.getContextClassLoader()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ContextClassLoader of [main]:sun.misc.Launcher$AppClassLoader@18b4aac2</span><br><span class="line">ContextClassLoader of [son-thread]:sun.misc.Launcher$AppClassLoader@18b4aac2</span><br><span class="line">ContextClassLoader of [grand-son-thread]:sun.misc.Launcher$AppClassLoader@18b4aac2</span><br></pre></td></tr></table></figure><p>å°è¯äº†å‰é¢çš„ç»“è®ºï¼Œä¸»çº¿ç¨‹ã€å­çº¿ç¨‹ã€å­™å­çº¿ç¨‹çš„çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨éƒ½æ˜¯<code>AppClassLoader</code>ç±»å‹ï¼Œå¹¶ä¸”æŒ‡å‘åŒä¸€ä¸ªå®ä¾‹<code>sun.misc.Launcher$AppClassLoader@18b4aac2</code>ã€‚</p><h2 id="ContextClassLoaderè®¾ç½®ä¸å½“å¯¼è‡´å†…å­˜æ³„æ¼çš„éšæ‚£">ContextClassLoaderè®¾ç½®ä¸å½“å¯¼è‡´å†…å­˜æ³„æ¼çš„éšæ‚£</h2><p>åªè¦æœ‰å¤§é‡çƒ­åŠ è½½å’Œå¸è½½åŠ¨æ€ç±»çš„åœºæ™¯ï¼Œå°±éœ€è¦è­¦æƒ•åä»£çº¿ç¨‹<code>ContextClassLoader</code>è®¾ç½®ä¸å½“å¯¼è‡´å†…å­˜æ³„æ¼ã€‚ç”»ä¸ªå›¾å°±èƒ½æ¯”è¾ƒæ¸…æ¥šï¼š</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/202001/j-c-t-c-1.png" alt=""></p><p>çˆ¶çº¿ç¨‹ä¸­è®¾ç½®äº†ä¸€ä¸ªè‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼Œç”¨äºåŠ è½½åŠ¨æ€ç±»ï¼Œ<strong>å­çº¿ç¨‹æ–°å»ºçš„æ—¶å€™ç›´æ¥ä½¿ç”¨äº†çˆ¶çº¿ç¨‹çš„è‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼Œå¯¼è‡´è¯¥è‡ªå®šä¹‰ç±»åŠ è½½å™¨ä¸€ç›´è¢«å­çº¿ç¨‹å¼ºå¼•ç”¨</strong>ï¼Œç»“åˆå‰é¢çš„ç±»å¸è½½æ¡ä»¶åˆ†æï¼Œæ‰€æœ‰ç”±è¯¥è‡ªå®šä¹‰ç±»åŠ è½½å™¨åŠ è½½å‡ºæ¥çš„åŠ¨æ€ç±»éƒ½ä¸èƒ½è¢«å¸è½½ï¼Œå¯¼è‡´äº†å†…å­˜æ³„æ¼ã€‚è¿™é‡Œè¿˜æ˜¯åŸºäºæ–‡ç« å‰é¢çš„é‚£ä¸ªä¾‹å­åšæ”¹é€ ï¼š</p><ul><li>æ–°å¢ä¸€ä¸ªçº¿ç¨‹<code>X</code>ç”¨äºè¿›è¡Œç±»åŠ è½½ï¼Œæ–°å»ºä¸€ä¸ªè‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼Œè®¾ç½®çº¿ç¨‹<code>X</code>çš„ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ä¸ºè¯¥è‡ªå®šä¹‰ç±»åŠ è½½å™¨ã€‚</li><li>çº¿ç¨‹<code>X</code>è¿è¡Œæ–¹æ³•ä¸­åˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹<code>Y</code>ï¼Œç”¨äºæ¥æ”¶ç±»åŠ è½½æˆåŠŸçš„äº‹ä»¶å¹¶ä¸”è¿›è¡Œæ‰“å°ã€‚</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HelloService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">sayHello</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    BlockingQueue&lt;String&gt; CLASSES = <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    BlockingQueue&lt;String&gt; EVENTS = <span class="keyword">new</span> LinkedBlockingQueue&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    AtomicBoolean START = <span class="keyword">new</span> AtomicBoolean(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Thread thread = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            ClassLoader loader = <span class="keyword">new</span> ClassLoader() &#123;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">protected</span> Class&lt;?&gt; findClass(String name) <span class="keyword">throws</span> ClassNotFoundException &#123;</span><br><span class="line">                    String location = <span class="string">"I:\\DefaultHelloService1.class"</span>;</span><br><span class="line">                    <span class="keyword">if</span> (name.contains(<span class="string">"DefaultHelloService2"</span>)) &#123;</span><br><span class="line">                        location = <span class="string">"I:\\DefaultHelloService2.class"</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    File classFile = <span class="keyword">new</span> File(location);</span><br><span class="line">                    ByteArrayOutputStream outputStream = <span class="keyword">new</span> ByteArrayOutputStream();</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        InputStream stream = <span class="keyword">new</span> FileInputStream(classFile);</span><br><span class="line">                        <span class="keyword">int</span> b;</span><br><span class="line">                        <span class="keyword">while</span> ((b = stream.read()) != -<span class="number">1</span>) &#123;</span><br><span class="line">                            outputStream.write(b);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(e);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">byte</span>[] bytes = outputStream.toByteArray();</span><br><span class="line">                    Class&lt;?&gt; defineClass = <span class="keyword">super</span>.defineClass(name, bytes, <span class="number">0</span>, bytes.length);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        EVENTS.put(String.format(<span class="string">"åŠ è½½ç±»æˆåŠŸ,ç±»å:%s"</span>, defineClass.getName()));</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (Exception ignore) &#123;</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">return</span> defineClass;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;;</span><br><span class="line">            Thread x = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">if</span> (START.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">                        Thread y = <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">                            <span class="keyword">try</span> &#123;</span><br><span class="line">                                <span class="keyword">for</span> (; ; ) &#123;</span><br><span class="line">                                    String event = EVENTS.take();</span><br><span class="line">                                    System.out.println(<span class="string">"æ¥æ”¶åˆ°äº‹ä»¶,äº‹ä»¶å†…å®¹:"</span> + event);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125; <span class="keyword">catch</span> (Exception ignore) &#123;</span><br><span class="line"></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;, <span class="string">"Y"</span>);</span><br><span class="line">                        y.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">                        y.start();</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">for</span> (; ; ) &#123;</span><br><span class="line">                        String take = CLASSES.take();</span><br><span class="line">                        Class&lt;?&gt; klass = loader.loadClass(take);</span><br><span class="line">                        HelloService helloService = (HelloService) klass.newInstance();</span><br><span class="line">                        System.out.println(helloService.sayHello());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Exception ignore) &#123;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;, <span class="string">"X"</span>);</span><br><span class="line">            x.setContextClassLoader(loader);</span><br><span class="line">            x.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">            x.start();</span><br><span class="line">        &#125;);</span><br><span class="line">        thread.start();</span><br><span class="line">        CLASSES.put(<span class="string">"club.throwable.loader.DefaultHelloService1"</span>);</span><br><span class="line">        CLASSES.put(<span class="string">"club.throwable.loader.DefaultHelloService2"</span>);</span><br><span class="line">        Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">        System.gc();</span><br><span class="line">        Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">        System.gc();</span><br><span class="line">        Thread.sleep(Long.MAX_VALUE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ§åˆ¶å°è¾“å‡ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">æ¥æ”¶åˆ°äº‹ä»¶,äº‹ä»¶å†…å®¹:åŠ è½½ç±»æˆåŠŸ,ç±»å:club.throwable.loader.DefaultHelloService1</span><br><span class="line">1 say hello!</span><br><span class="line">æ¥æ”¶åˆ°äº‹ä»¶,äº‹ä»¶å†…å®¹:åŠ è½½ç±»æˆåŠŸ,ç±»å:club.throwable.loader.DefaultHelloService2</span><br><span class="line">2 say hello!</span><br></pre></td></tr></table></figure><p>æ‰“å¼€<code>VisualVM</code>ï¼Œ<code>Dump</code>å¯¹åº”è¿›ç¨‹çš„å†…å­˜å¿«ç…§ï¼Œå¤šæ‰§è¡Œå‡ æ¬¡<code>GC</code>ï¼Œå‘ç°äº†æ‰€æœ‰åŠ¨æ€ç±»éƒ½æ²¡æœ‰è¢«å¸è½½ï¼ˆè¿™é‡Œé™¤éä¸»åŠ¨ç»ˆæ­¢çº¿ç¨‹<code>Y</code>é‡Šæ”¾è‡ªå®šä¹‰<code>ClassLoader</code>ï¼Œå¦åˆ™æ°¸è¿œéƒ½ä¸å¯èƒ½é‡Šæ”¾è¯¥å¼ºå¼•ç”¨ï¼‰ï¼ŒéªŒè¯äº†å‰é¢çš„ç»“è®ºã€‚</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/202001/j-c-t-c-2.png" alt=""></p><p>å½“ç„¶ï¼Œè¿™é‡Œåªæ˜¯åŠ è½½äº†ä¸¤ä¸ªåŠ¨æ€ç±»ï¼Œå¦‚æœåœ¨ç‰¹æ®Šåœºæ™¯ä¹‹ä¸‹ï¼Œä¾‹å¦‚åœ¨çº¿ç¼–ç å’Œè¿è¡Œä»£ç ï¼Œé‚£ä¹ˆæœ‰å¯èƒ½æåº¦é¢‘ç¹åŠ¨æ€ç¼–è¯‘å’ŒåŠ¨æ€ç±»åŠ è½½ï¼Œå¦‚æœå‡ºç°äº†ä¸Šé¢ç±»ä¼¼çš„å†…å­˜æ³„æ¼ï¼Œé‚£ä¹ˆå¾ˆå®¹æ˜“å¯¼è‡´æœåŠ¡å™¨å†…å­˜è€—å°½ã€‚</p><h2 id="è§£å†³æ–¹æ¡ˆ">è§£å†³æ–¹æ¡ˆ</h2><p>å‚è€ƒé‚£ä¸¤ä¸ª<code>Issue</code>ï¼Œè§£å†³æ–¹æ¡ˆï¼ˆæˆ–è€…è¯´é¢„é˜²æ‰‹æ®µï¼‰åŸºæœ¬ä¸Šæœ‰ä¸¤ä¸ªï¼š</p><ol><li>ä¸éœ€è¦ä½¿ç”¨è‡ªå®šä¹‰ç±»åŠ è½½å™¨çš„çº¿ç¨‹ï¼ˆå¦‚äº‹ä»¶æ´¾å‘çº¿ç¨‹ç­‰ï¼‰ä¼˜å…ˆåˆå§‹åŒ–ï¼Œé‚£ä¹ˆä¸€èˆ¬å®ƒçš„çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨æ˜¯åº”ç”¨ç±»åŠ è½½å™¨ã€‚</li><li>æ–°å»ºåä»£çº¿ç¨‹çš„æ—¶å€™ï¼Œæ‰‹åŠ¨è¦†ç›–å®ƒçš„çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼Œå‚è€ƒ<code>Netty</code>çš„åšæ³•ï¼Œåœ¨çº¿ç¨‹åˆå§‹åŒ–çš„æ—¶å€™åšå¦‚ä¸‹çš„æ“ä½œï¼š</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ThreadDeathWatcher || GlobalEventExecutor</span></span><br><span class="line">AccessController.doPrivileged(<span class="keyword">new</span> PrivilegedAction&lt;Void&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Void <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        watcherThread.setContextClassLoader(<span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h2 id="å°ç»“">å°ç»“</h2><p>è¿™ç¯‡æ–‡ç« ç®—æ˜¯è¿‘æœŸç ”ç©¶å¾—æ¯”è¾ƒæ·±å…¥çš„ä¸€ç¯‡æ–‡ç« ï¼Œ<code>ContextClassLoader</code>å†…å­˜æ³„æ¼çš„éšæ‚£å½’æ ¹åˆ°åº•æ˜¯å¼•ç”¨ä½¿ç”¨ä¸å½“å¯¼è‡´ä¸€äº›æœ¬æ¥åœ¨æ–¹æ³•æ ˆé€€å‡ºä¹‹åéœ€è¦é‡Šæ”¾çš„å¼•ç”¨æ— æ³•é‡Šæ”¾å¯¼è‡´çš„ã€‚è¿™ç§é—®é¢˜æœ‰äº›æ—¶å€™éšè—å¾—å¾ˆæ·±ï¼Œè€Œä¸€æ—¦å‘½ä¸­äº†åŒæ ·çš„é—®é¢˜å¹¶ä¸”åœ¨å¹¶å‘çš„åœºæ™¯ä¹‹ä¸‹ï¼Œé‚£ä¹ˆå†…å­˜æ³„æ¼çš„é—®é¢˜ä¼šæ¶åŒ–å¾—ååˆ†å¿«ã€‚è¿™ç±»é—®é¢˜å½’ç±»ä¸ºæ€§èƒ½ä¼˜åŒ–ï¼Œè€Œæ€§èƒ½ä¼˜åŒ–æ˜¯ååˆ†å¤§çš„ä¸“é¢˜ï¼Œä»¥ååº”è¯¥ä¹Ÿä¼šé‡åˆ°ç±»ä¼¼çš„å„ç±»é—®é¢˜ï¼Œè¿™äº›ç»éªŒå¸Œæœ›èƒ½å¯¹æœªæ¥äº§ç”Ÿæ­£å‘çš„ä½œç”¨ã€‚</p><p>å‚è€ƒèµ„æ–™ï¼š</p><ul><li>ã€Šæ·±å…¥ç†è§£Javaè™šæ‹Ÿæœº - 3rdã€‹</li></ul><p>ï¼ˆæœ¬æ–‡å®Œ c-2-d e-a-20200119ï¼‰</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰æ&quot;&gt;å‰æ&lt;/h2&gt;
&lt;p&gt;ä»Šå¤©ï¼ˆ&lt;code&gt;2020-01-18&lt;/code&gt;ï¼‰åœ¨ç¼–å†™&lt;code&gt;Netty&lt;/code&gt;ç›¸å…³ä»£ç çš„æ—¶å€™ï¼Œä»&lt;code&gt;Netty&lt;/code&gt;æºç ä¸­çš„&lt;code&gt;ThreadDeathWatcher&lt;/code&gt;å’Œ&lt;code&gt;GlobalEventExecutor&lt;/code&gt;è¿½æº¯åˆ°ä¸¤ä¸ªå’Œçº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨&lt;code&gt;ContextClassLoader&lt;/code&gt;å†…å­˜æ³„æ¼ç›¸å…³çš„&lt;code&gt;Issue&lt;/code&gt;ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/netty/netty/issues/7290&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;ThreadDeathWatcher causes custom classLoader script memory leaks&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/netty/netty/pull/7493&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;Ensure ThreadDeathWatcher and GlobalEventExecutor will not cause clasâ€¦&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ä¸¤ä¸ª&lt;code&gt;Issue&lt;/code&gt;åˆ†åˆ«æ˜¯ä¸¤ä½å‰è¾ˆåœ¨&lt;code&gt;2017-12&lt;/code&gt;çš„æ—¶å€™æå‡ºçš„ï¼Œæè¿°çš„æ˜¯åŒä¸€ç±»é—®é¢˜ï¼Œæœ€åè¢«&lt;code&gt;Netty&lt;/code&gt;çš„è´Ÿè´£äººé‡‡çº³ï¼Œå¹¶ä¸”ä¿®å¤äº†å¯¹åº”çš„é—®é¢˜ä»è€Œå…³é—­äº†&lt;code&gt;Issue&lt;/code&gt;ã€‚è¿™é‡ŒåŸºäºè¿™ä¸¤ä¸ª&lt;code&gt;Issue&lt;/code&gt;æè¿°çš„å†…å®¹ï¼Œå¯¹&lt;code&gt;ContextClassLoader&lt;/code&gt;å†…å­˜æ³„æ¼éšæ‚£åšä¸€æ¬¡å¤ç›˜ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Java" scheme="http://throwable.club/blog/categories/Java/"/>
    
      <category term="Concurrency" scheme="http://throwable.club/blog/categories/Java/Concurrency/"/>
    
    
      <category term="Java" scheme="http://throwable.club/blog/tags/Java/"/>
    
      <category term="Thread" scheme="http://throwable.club/blog/tags/Thread/"/>
    
  </entry>
  
  <entry>
    <title>åŸºäºNettyå’ŒSpringBootå®ç°ä¸€ä¸ªè½»é‡çº§RPCæ¡†æ¶-Clientç«¯è¯·æ±‚å“åº”åŒæ­¥åŒ–å¤„ç†</title>
    <link href="http://throwable.club/2020/01/18/netty-custom-rpc-framework-client-sync/"/>
    <id>http://throwable.club/2020/01/18/netty-custom-rpc-framework-client-sync/</id>
    <published>2020-01-18T06:52:32.000Z</published>
    <updated>2020-01-18T06:53:02.380Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰æ">å‰æ</h2><p>å‰ç½®æ–‡ç« ï¼š</p><ul><li><a href="http://www.throwable.club/2020/01/12/netty-custom-rpc-framework-protocol" target="_blank" rel="noopener">ã€ŠåŸºäºNettyå’ŒSpringBootå®ç°ä¸€ä¸ªè½»é‡çº§RPCæ¡†æ¶-åè®®ç¯‡ã€‹</a></li><li><a href="http://www.throwable.club/2020/01/15/netty-custom-rpc-framework-server" target="_blank" rel="noopener">ã€ŠåŸºäºNettyå’ŒSpringBootå®ç°ä¸€ä¸ªè½»é‡çº§RPCæ¡†æ¶-Serverç¯‡ã€‹</a></li><li><a href="http://www.throwable.club/2020/01/16/netty-custom-rpc-framework-client" target="_blank" rel="noopener">ã€ŠåŸºäºNettyå’ŒSpringBootå®ç°ä¸€ä¸ªè½»é‡çº§RPCæ¡†æ¶-Clientç¯‡ã€‹</a></li></ul><p>å‰ä¸€ç¯‡æ–‡ç« ç®€å•ä»‹ç»äº†é€šè¿‡åŠ¨æ€ä»£ç†å®Œæˆäº†<code>Client</code>ç«¯å¥‘çº¦æ¥å£è°ƒç”¨è½¬æ¢ä¸ºå‘é€<code>RPC</code>åè®®è¯·æ±‚çš„åŠŸèƒ½ã€‚è¿™ç¯‡æ–‡ç« ä¸»è¦è§£å†³ä¸€ä¸ªé—ç•™çš„æŠ€æœ¯éš¾é¢˜ï¼šè¯·æ±‚-å“åº”åŒæ­¥åŒ–å¤„ç†ã€‚</p><p>éœ€è¦çš„ä¾èµ–å¦‚ä¸‹ï¼š</p><ul><li><code>JDK1.8+</code></li><li><code>Netty:4.1.44.Final</code></li><li><code>SpringBoot:2.2.2.RELEASE</code></li></ul><a id="more"></a><h2 id="ç®€å•åˆ†æNettyè¯·æ±‚-å“åº”çš„å¤„ç†æµç¨‹">ç®€å•åˆ†æNettyè¯·æ±‚-å“åº”çš„å¤„ç†æµç¨‹</h2><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/202001/n-s-b-r-c-r-r-1.png" alt=""></p><p>å›¾ä¸­å·²ç»å¿½ç•¥äº†ç¼–ç è§£ç å™¨å’Œå…¶ä»–å…¥ç«™å‡ºç«™å¤„ç†å™¨ï¼Œä¸åŒé¢œè‰²çš„çº¿ç¨‹ä»£è¡¨å®Œå…¨ä¸ç›¸åŒçš„çº¿ç¨‹ï¼Œä¸åŒçº¿ç¨‹ä¹‹é—´çš„å¤„ç†é€»è¾‘æ˜¯å®Œå…¨å¼‚æ­¥ï¼Œä¹Ÿå°±æ˜¯<code>Netty IO</code>çº¿ç¨‹ï¼ˆ<code>n-l-g-1</code>ï¼‰æ¥æ”¶åˆ°<code>Server</code>ç«¯çš„æ¶ˆæ¯å¹¶ä¸”è§£æå®Œæˆçš„æ—¶å€™ï¼Œç”¨æˆ·è°ƒç”¨çº¿ç¨‹ï¼ˆ<code>u-t-1</code>ï¼‰æ— æ³•æ„ŸçŸ¥åˆ°è§£æå®Œæ¯•çš„æ¶ˆæ¯åŒ…ï¼Œé‚£ä¹ˆè¿™é‡Œè¦åšçš„äº‹æƒ…å°±æ˜¯è®©ç”¨æˆ·è°ƒç”¨çº¿ç¨‹ï¼ˆ<code>u-t-1</code>ï¼‰è·å–åˆ°<code>Netty IO</code>çº¿ç¨‹ï¼ˆ<code>n-l-g-1</code>ï¼‰æ¥æ”¶å¹¶ä¸”è§£æå®Œæˆçš„æ¶ˆæ¯åŒ…ã€‚</p><p>è¿™é‡Œå¯ä»¥ç”¨ä¸€ä¸ªç®€å•çš„ä¾‹å­æ¥è¯´æ˜æ¨¡æ‹Ÿ<code>Client</code>ç«¯è°ƒç”¨çº¿ç¨‹ç­‰å¾…<code>Netty IO</code>çº¿ç¨‹çš„å¤„ç†ç»“æœå†åŒæ­¥è¿”å›çš„è¿‡ç¨‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NettyThreadSyncTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@ToString</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">ResponseFuture</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> beginTimestamp = System.currentTimeMillis();</span><br><span class="line">        <span class="meta">@Getter</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> timeoutMilliseconds;</span><br><span class="line">        <span class="meta">@Getter</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String requestId;</span><br><span class="line">        <span class="meta">@Setter</span></span><br><span class="line">        <span class="meta">@Getter</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> sendRequestSucceed = <span class="keyword">false</span>;</span><br><span class="line">        <span class="meta">@Setter</span></span><br><span class="line">        <span class="meta">@Getter</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">volatile</span> Throwable cause;</span><br><span class="line">        <span class="meta">@Getter</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">volatile</span> Object response;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> CountDownLatch latch = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">ResponseFuture</span><span class="params">(String requestId, <span class="keyword">long</span> timeoutMilliseconds)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.requestId = requestId;</span><br><span class="line">            <span class="keyword">this</span>.timeoutMilliseconds = timeoutMilliseconds;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">timeout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> System.currentTimeMillis() - beginTimestamp &gt; timeoutMilliseconds;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">waitResponse</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> timeoutMilliseconds)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">            latch.await(timeoutMilliseconds, TimeUnit.MILLISECONDS);</span><br><span class="line">            <span class="keyword">return</span> response;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putResponse</span><span class="params">(Object response)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.response = response;</span><br><span class="line">            latch.countDown();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> ExecutorService REQUEST_THREAD;</span><br><span class="line">    <span class="keyword">static</span> ExecutorService NETTY_IO_THREAD;</span><br><span class="line">    <span class="keyword">static</span> Callable&lt;Object&gt; REQUEST_TASK;</span><br><span class="line">    <span class="keyword">static</span> Runnable RESPONSE_TASK;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> String <span class="title">processBusiness</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">"%s say hello!"</span>, name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;String <span class="comment">/* request id */</span>, ResponseFuture&gt; RESPONSE_FUTURE_TABLE = Maps.newConcurrentMap();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@BeforeClass</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">beforeClass</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        String requestId = UUID.randomUUID().toString();</span><br><span class="line">        String requestContent = <span class="string">"throwable"</span>;</span><br><span class="line">        REQUEST_TASK = () -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 3ç§’æ²¡æœ‰å¾—åˆ°å“åº”è®¤ä¸ºè¶…æ—¶</span></span><br><span class="line">                ResponseFuture responseFuture = <span class="keyword">new</span> ResponseFuture(requestId, <span class="number">3000</span>);</span><br><span class="line">                RESPONSE_FUTURE_TABLE.put(requestId, responseFuture);</span><br><span class="line">                <span class="comment">// è¿™é‡Œå¿½ç•¥å‘é€è¯·æ±‚çš„æ“ä½œ,åªæ‰“å°æ—¥å¿—å’Œæ¨¡æ‹Ÿè€—æ—¶1ç§’</span></span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                log.info(<span class="string">"å‘é€è¯·æ±‚æˆåŠŸ,è¯·æ±‚ID:&#123;&#125;,è¯·æ±‚å†…å®¹:&#123;&#125;"</span>, requestId, requestContent);</span><br><span class="line">                <span class="comment">// æ›´æ–°æ ‡è®°å±æ€§</span></span><br><span class="line">                responseFuture.setSendRequestSucceed(<span class="keyword">true</span>);</span><br><span class="line">                <span class="comment">// å‰©ä½™2ç§’ç­‰å¾…æ—¶é—´ - è¿™é‡Œåªæ˜¯ç²—ç•¥è®¡ç®—</span></span><br><span class="line">                <span class="keyword">return</span> responseFuture.waitResponse(<span class="number">3000</span> - <span class="number">1000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.info(<span class="string">"å‘é€è¯·æ±‚å¤±è´¥,è¯·æ±‚ID:&#123;&#125;,è¯·æ±‚å†…å®¹:&#123;&#125;"</span>, requestId, requestContent);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        RESPONSE_TASK = () -&gt; &#123;</span><br><span class="line">            String responseContent = processBusiness(requestContent);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                ResponseFuture responseFuture = RESPONSE_FUTURE_TABLE.get(requestId);</span><br><span class="line">                <span class="keyword">if</span> (<span class="keyword">null</span> != responseFuture) &#123;</span><br><span class="line">                    log.warn(<span class="string">"å¤„ç†å“åº”æˆåŠŸ,è¯·æ±‚ID:&#123;&#125;,å“åº”å†…å®¹:&#123;&#125;"</span>, requestId, responseContent);</span><br><span class="line">                    responseFuture.putResponse(responseContent);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    log.warn(<span class="string">"è¯·æ±‚ID[&#123;&#125;]å¯¹åº”çš„ResponseFutureä¸å­˜åœ¨,å¿½ç•¥å¤„ç†"</span>, requestId);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.info(<span class="string">"å¤„ç†å“åº”å¤±è´¥,è¯·æ±‚ID:&#123;&#125;,å“åº”å†…å®¹:&#123;&#125;"</span>, requestId, responseContent);</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        REQUEST_THREAD = Executors.newSingleThreadExecutor(runnable -&gt; &#123;</span><br><span class="line">            Thread thread = <span class="keyword">new</span> Thread(runnable, <span class="string">"REQUEST_THREAD"</span>);</span><br><span class="line">            thread.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">return</span> thread;</span><br><span class="line">        &#125;);</span><br><span class="line">        NETTY_IO_THREAD = Executors.newSingleThreadExecutor(runnable -&gt; &#123;</span><br><span class="line">            Thread thread = <span class="keyword">new</span> Thread(runnable, <span class="string">"NETTY_IO_THREAD"</span>);</span><br><span class="line">            thread.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">            <span class="keyword">return</span> thread;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testProcessSync</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        log.info(<span class="string">"å¼‚æ­¥æäº¤è¯·æ±‚å¤„ç†ä»»åŠ¡......"</span>);</span><br><span class="line">        Future&lt;Object&gt; future = REQUEST_THREAD.submit(REQUEST_TASK);</span><br><span class="line">        <span class="comment">// æ¨¡æ‹Ÿè¯·æ±‚è€—æ—¶</span></span><br><span class="line">        Thread.sleep(<span class="number">1500</span>);</span><br><span class="line">        log.info(<span class="string">"å¼‚æ­¥æäº¤å“åº”å¤„ç†ä»»åŠ¡......"</span>);</span><br><span class="line">        NETTY_IO_THREAD.execute(RESPONSE_TASK);</span><br><span class="line">        <span class="comment">// è¿™é‡Œå¯ä»¥è®¾ç½®è¶…æ—¶</span></span><br><span class="line">        log.info(<span class="string">"åŒæ­¥è·å–è¯·æ±‚ç»“æœ:&#123;&#125;"</span>, future.get());</span><br><span class="line">        Thread.sleep(Long.MAX_VALUE);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œ<code>testProcessSync()</code>æ–¹æ³•ï¼Œæ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">2020-01-18 13:17:07 [main] INFO  c.t.client.NettyThreadSyncTest - å¼‚æ­¥æäº¤è¯·æ±‚å¤„ç†ä»»åŠ¡......</span><br><span class="line">2020-01-18 13:17:08 [REQUEST_THREAD] INFO  c.t.client.NettyThreadSyncTest - å‘é€è¯·æ±‚æˆåŠŸ,è¯·æ±‚ID:71f47e27-c17c-458d-b271-4e74fad33a7b,è¯·æ±‚å†…å®¹:throwable</span><br><span class="line">2020-01-18 13:17:09 [main] INFO  c.t.client.NettyThreadSyncTest - å¼‚æ­¥æäº¤å“åº”å¤„ç†ä»»åŠ¡......</span><br><span class="line">2020-01-18 13:17:09 [NETTY_IO_THREAD] WARN  c.t.client.NettyThreadSyncTest - å¤„ç†å“åº”æˆåŠŸ,è¯·æ±‚ID:71f47e27-c17c-458d-b271-4e74fad33a7b,å“åº”å†…å®¹:throwable say hello!</span><br><span class="line">2020-01-18 13:17:09 [main] INFO  c.t.client.NettyThreadSyncTest - åŒæ­¥è·å–è¯·æ±‚ç»“æœ:throwable say hello!</span><br></pre></td></tr></table></figure><p>ä¸Šé¢è¿™ä¸ªä¾‹å­é‡Œé¢çš„çº¿ç¨‹åŒæ­¥å¤„ç†ä¸»è¦å‚è€ƒä¸»æµçš„<code>Netty</code>æ¡†æ¶å®¢æˆ·ç«¯éƒ¨åˆ†çš„å®ç°é€»è¾‘ï¼š<code>RocketMQ</code>ï¼ˆå…·ä½“æ˜¯<code>NettyRemotingClient</code>ç±»ï¼‰ä»¥åŠ<code>Redisson</code>ï¼ˆå…·ä½“æ˜¯<code>RedisExecutor</code>ç±»ï¼‰ï¼Œå®ƒä»¬å°±æ˜¯ç”¨è¿™ç§æ–¹å¼ä½¿å¾—å¼‚æ­¥çº¿ç¨‹å¤„ç†è½¬åŒ–ä¸ºåŒæ­¥å¤„ç†ã€‚</p><h2 id="Clientç«¯è¯·æ±‚å“åº”åŒæ­¥åŒ–å¤„ç†">Clientç«¯è¯·æ±‚å“åº”åŒæ­¥åŒ–å¤„ç†</h2><p>æŒ‰ç…§å‰é¢çš„ä¾‹å­ï¼Œé¦–å…ˆæ–°å¢ä¸€ä¸ª<code>ResponseFuture</code>ç”¨äºæ‰¿è½½å·²å‘é€ä½†æœªå“åº”çš„è¯·æ±‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ToString</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResponseFuture</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> beginTimestamp = System.currentTimeMillis();</span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> timeoutMilliseconds;</span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String requestId;</span><br><span class="line">    <span class="meta">@Setter</span></span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> sendRequestSucceed = <span class="keyword">false</span>;</span><br><span class="line">    <span class="meta">@Setter</span></span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> Throwable cause;</span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">volatile</span> ResponseMessagePacket response;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> CountDownLatch latch = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">ResponseFuture</span><span class="params">(String requestId, <span class="keyword">long</span> timeoutMilliseconds)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.requestId = requestId;</span><br><span class="line">        <span class="keyword">this</span>.timeoutMilliseconds = timeoutMilliseconds;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">timeout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> System.currentTimeMillis() - beginTimestamp &gt; timeoutMilliseconds;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ResponseMessagePacket <span class="title">waitResponse</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> timeoutMilliseconds)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        latch.await(timeoutMilliseconds, TimeUnit.MILLISECONDS);</span><br><span class="line">        <span class="keyword">return</span> response;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putResponse</span><span class="params">(ResponseMessagePacket response)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.response = response;</span><br><span class="line">        latch.countDown();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ç€éœ€è¦æ–°å¢ä¸€ä¸ª<code>HashMap</code>å»ç¼“å­˜è¿™äº›è¿”é€æˆåŠŸä½†æ˜¯æœªå¾—åˆ°å“åº”å¤„ç†çš„<code>ResponseFuture</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Map&lt;String <span class="comment">/* request id */</span>, ResponseFuture&gt; RESPONSE_FUTURE_TABLE = Maps.newConcurrentMap();</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„<code>KEY</code>é€‰ç”¨<code>requestId</code>ï¼Œè€Œ<code>requestId</code>ä¹‹å‰å·²ç»å®šä¹‰ä¸º<code>UUID</code>ï¼Œç¡®ä¿æ¯ä¸ªè¯·æ±‚ä¸ä¼šé‡å¤ã€‚ä¸ºäº†ç®€å•èµ·è§ï¼Œç›®å‰æ‰€æœ‰çš„é€»è¾‘éƒ½ç¼–å†™åœ¨å¥‘çº¦ä»£ç†å·¥å‚<code>ContractProxyFactory</code>ï¼Œæ·»åŠ ä¸‹é¢çš„åŠŸèƒ½ï¼š</p><ul><li>æ·»åŠ ä¸€ä¸ªåŒæ­¥å‘é€æ–¹æ³•<code>sendRequestSync()</code>å¤„ç†æ¶ˆæ¯åŒ…çš„å‘é€å’ŒåŒæ­¥å“åº”ï¼Œ<code>RequestMessagePacket</code>è½¬æ¢ä¸ºè°ƒç”¨ä»£ç†ç›®æ ‡æ–¹æ³•è¿”å›å€¼ç±»å‹çš„é€»è¾‘æš‚æ—¶ä¹Ÿç¼–å†™åœ¨æ­¤æ–¹æ³•ä¸­ã€‚</li><li>æ·»åŠ ä¸€ä¸ªæ ¸å¿ƒçº¿ç¨‹æ•°é‡ä¸ºé€»è¾‘æ ¸å¿ƒæ•°é‡ * 2çš„çº¿ç¨‹æ± ç”¨äºå¤„ç†è¯·æ±‚ã€‚</li><li>æ·»åŠ ä¸€ä¸ªå•çº¿ç¨‹çš„è°ƒåº¦çº¿ç¨‹æ± ç”¨äºå®šæ—¶æ¸…ç†é‚£äº›è¿‡æœŸçš„<code>ResponseFuture</code>ï¼Œæ¸…ç†æ–¹æ³•ä¸º<code>scanResponseFutureTable()</code>ã€‚</li></ul><p>ä¿®æ”¹åçš„<code>ContractProxyFactory</code>å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ContractProxyFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> RequestArgumentExtractor EXTRACTOR = <span class="keyword">new</span> DefaultRequestArgumentExtractor();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ConcurrentMap&lt;Class&lt;?&gt;, Object&gt; CACHE = Maps.newConcurrentMap();</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> ConcurrentMap&lt;String <span class="comment">/* request id */</span>, ResponseFuture&gt; RESPONSE_FUTURE_TABLE = Maps.newConcurrentMap();</span><br><span class="line">    <span class="comment">// å®šä¹‰è¯·æ±‚çš„æœ€å¤§è¶…æ—¶æ—¶é—´ä¸º3ç§’</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> REQUEST_TIMEOUT_MS = <span class="number">3000</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ExecutorService EXECUTOR;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ScheduledExecutorService CLIENT_HOUSE_KEEPER;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Serializer SERIALIZER = FastJsonSerializer.X;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">ofProxy</span><span class="params">(Class&lt;T&gt; interfaceKlass)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ç¼“å­˜å¥‘çº¦æ¥å£çš„ä»£ç†ç±»å®ä¾‹</span></span><br><span class="line">        <span class="keyword">return</span> (T) CACHE.computeIfAbsent(interfaceKlass, x -&gt;</span><br><span class="line">                Proxy.newProxyInstance(interfaceKlass.getClassLoader(), <span class="keyword">new</span> Class[]&#123;interfaceKlass&#125;, (target, method, args) -&gt; &#123;</span><br><span class="line">                    RequestArgumentExtractInput input = <span class="keyword">new</span> RequestArgumentExtractInput();</span><br><span class="line">                    input.setInterfaceKlass(interfaceKlass);</span><br><span class="line">                    input.setMethod(method);</span><br><span class="line">                    RequestArgumentExtractOutput output = EXTRACTOR.extract(input);</span><br><span class="line">                    <span class="comment">// å°è£…è¯·æ±‚å‚æ•°</span></span><br><span class="line">                    RequestMessagePacket packet = <span class="keyword">new</span> RequestMessagePacket();</span><br><span class="line">                    packet.setMagicNumber(ProtocolConstant.MAGIC_NUMBER);</span><br><span class="line">                    packet.setVersion(ProtocolConstant.VERSION);</span><br><span class="line">                    packet.setSerialNumber(SerialNumberUtils.X.generateSerialNumber());</span><br><span class="line">                    packet.setMessageType(MessageType.REQUEST);</span><br><span class="line">                    packet.setInterfaceName(output.getInterfaceName());</span><br><span class="line">                    packet.setMethodName(output.getMethodName());</span><br><span class="line">                    packet.setMethodArgumentSignatures(output.getMethodArgumentSignatures().toArray(<span class="keyword">new</span> String[<span class="number">0</span>]));</span><br><span class="line">                    packet.setMethodArguments(args);</span><br><span class="line">                    Channel channel = ClientChannelHolder.CHANNEL_REFERENCE.get();</span><br><span class="line">                    <span class="keyword">return</span> sendRequestSync(channel, packet, method.getReturnType());</span><br><span class="line">                &#125;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * åŒæ­¥å‘é€è¯·æ±‚</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> channel channel</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> packet  packet</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> Object</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">static</span> Object <span class="title">sendRequestSync</span><span class="params">(Channel channel, RequestMessagePacket packet, Class&lt;?&gt; returnType)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> beginTimestamp = System.currentTimeMillis();</span><br><span class="line">        ResponseFuture responseFuture = <span class="keyword">new</span> ResponseFuture(packet.getSerialNumber(), REQUEST_TIMEOUT_MS);</span><br><span class="line">        RESPONSE_FUTURE_TABLE.put(packet.getSerialNumber(), responseFuture);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// è·å–åˆ°æ‰¿è½½å“åº”Packetçš„Future</span></span><br><span class="line">            Future&lt;ResponseMessagePacket&gt; packetFuture = EXECUTOR.submit(() -&gt; &#123;</span><br><span class="line">                channel.writeAndFlush(packet).addListener((ChannelFutureListener)</span><br><span class="line">                        future -&gt; responseFuture.setSendRequestSucceed(<span class="keyword">true</span>));</span><br><span class="line">                <span class="keyword">return</span> responseFuture.waitResponse(REQUEST_TIMEOUT_MS - (System.currentTimeMillis() - beginTimestamp));</span><br><span class="line">            &#125;);</span><br><span class="line">            ResponseMessagePacket responsePacket = packetFuture.get(</span><br><span class="line">                    REQUEST_TIMEOUT_MS - (System.currentTimeMillis() - beginTimestamp), TimeUnit.MILLISECONDS);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> == responsePacket) &#123;</span><br><span class="line">                <span class="comment">// è¶…æ—¶å¯¼è‡´å“åº”åŒ…è·å–å¤±è´¥</span></span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> SendRequestException(String.format(<span class="string">"ResponseMessagePacketè·å–è¶…æ—¶,è¯·æ±‚ID:%s"</span>, packet.getSerialNumber()));</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                ByteBuf payload = (ByteBuf) responsePacket.getPayload();</span><br><span class="line">                <span class="keyword">byte</span>[] bytes = ByteBufferUtils.X.readBytes(payload);</span><br><span class="line">                <span class="keyword">return</span> SERIALIZER.decode(bytes, returnType);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            log.error(<span class="string">"åŒæ­¥å‘é€è¯·æ±‚å¼‚å¸¸,è¯·æ±‚åŒ…:&#123;&#125;"</span>, JSON.toJSONString(packet), e);</span><br><span class="line">            <span class="keyword">if</span> (e <span class="keyword">instanceof</span> RuntimeException) &#123;</span><br><span class="line">                <span class="keyword">throw</span> (RuntimeException) e;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> SendRequestException(e);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">scanResponseFutureTable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"å¼€å§‹æ‰§è¡ŒResponseFutureTableæ¸…ç†ä»»åŠ¡......"</span>);</span><br><span class="line">        Iterator&lt;Map.Entry&lt;String, ResponseFuture&gt;&gt; iterator = RESPONSE_FUTURE_TABLE.entrySet().iterator();</span><br><span class="line">        <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">            Map.Entry&lt;String, ResponseFuture&gt; entry = iterator.next();</span><br><span class="line">            ResponseFuture responseFuture = entry.getValue();</span><br><span class="line">            <span class="keyword">if</span> (responseFuture.timeout()) &#123;</span><br><span class="line">                iterator.remove();</span><br><span class="line">                log.warn(<span class="string">"ç§»é™¤è¿‡æœŸçš„è¯·æ±‚ResponseFuture,è¯·æ±‚ID:&#123;&#125;"</span>, entry.getKey());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        log.info(<span class="string">"æ‰§è¡ŒResponseFutureTableæ¸…ç†ä»»åŠ¡ç»“æŸ......"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> n = Runtime.getRuntime().availableProcessors();</span><br><span class="line">        EXECUTOR = <span class="keyword">new</span> ThreadPoolExecutor(n * <span class="number">2</span>, n * <span class="number">2</span>, <span class="number">0</span>, TimeUnit.SECONDS,</span><br><span class="line">                <span class="keyword">new</span> ArrayBlockingQueue&lt;&gt;(<span class="number">50</span>), runnable -&gt; &#123;</span><br><span class="line">            Thread thread = <span class="keyword">new</span> Thread(runnable);</span><br><span class="line">            thread.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">            thread.setName(<span class="string">"CLIENT_REQUEST_EXECUTOR"</span>);</span><br><span class="line">            <span class="keyword">return</span> thread;</span><br><span class="line">        &#125;);</span><br><span class="line">        CLIENT_HOUSE_KEEPER = <span class="keyword">new</span> ScheduledThreadPoolExecutor(<span class="number">1</span>, runnable -&gt; &#123;</span><br><span class="line">            Thread thread = <span class="keyword">new</span> Thread(runnable);</span><br><span class="line">            thread.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">            thread.setName(<span class="string">"CLIENT_HOUSE_KEEPER"</span>);</span><br><span class="line">            <span class="keyword">return</span> thread;</span><br><span class="line">        &#125;);</span><br><span class="line">        CLIENT_HOUSE_KEEPER.scheduleWithFixedDelay(ContractProxyFactory::scanResponseFutureTable, <span class="number">5</span>, <span class="number">5</span>, TimeUnit.SECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ç€æ·»åŠ ä¸€ä¸ªå®¢æˆ·ç«¯å…¥ç«™å¤„ç†å™¨ï¼Œç”¨äºé€šè¿‡<code>reuqestId</code>åŒ¹é…ç›®æ ‡<code>ResponseFuture</code>å®ä¾‹ï¼ŒåŒæ—¶è®¾ç½®<code>ResponseFuture</code>å®ä¾‹ä¸­çš„<code>response</code>å±æ€§ä¸ºå“åº”åŒ…ï¼ŒåŒæ—¶é‡Šæ”¾é—­é”ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientHandler</span> <span class="keyword">extends</span> <span class="title">SimpleChannelInboundHandler</span>&lt;<span class="title">ResponseMessagePacket</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">channelRead0</span><span class="params">(ChannelHandlerContext ctx, ResponseMessagePacket packet)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        log.info(<span class="string">"æ¥æ”¶åˆ°å“åº”åŒ…,å†…å®¹:&#123;&#125;"</span>, JSON.toJSONString(packet));</span><br><span class="line">        ResponseFuture responseFuture = ContractProxyFactory.RESPONSE_FUTURE_TABLE.get(packet.getSerialNumber());</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != responseFuture) &#123;</span><br><span class="line">            responseFuture.putResponse(packet);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            log.warn(<span class="string">"æ¥æ”¶å“åº”åŒ…æŸ¥è¯¢ResponseFutureä¸å­˜åœ¨,è¯·æ±‚ID:&#123;&#125;"</span>, packet.getSerialNumber());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åï¼Œå®¢æˆ·ç«¯å¯åŠ¨ç±»<code>ClientApplication</code>ä¸­æ·»åŠ <code>ClientHandler</code>åˆ°<code>Netty</code>çš„å¤„ç†å™¨æµæ°´çº¿ä¸­å³å¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">bootstrap.handler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ch.pipeline().addLast(<span class="keyword">new</span> LengthFieldBasedFrameDecoder(<span class="number">1024</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">0</span>, <span class="number">4</span>));</span><br><span class="line">        ch.pipeline().addLast(<span class="keyword">new</span> LengthFieldPrepender(<span class="number">4</span>));</span><br><span class="line">        ch.pipeline().addLast(<span class="keyword">new</span> LoggingHandler(LogLevel.DEBUG));</span><br><span class="line">        ch.pipeline().addLast(<span class="keyword">new</span> RequestMessagePacketEncoder(FastJsonSerializer.X));</span><br><span class="line">        ch.pipeline().addLast(<span class="keyword">new</span> ResponseMessagePacketDecoder());</span><br><span class="line">        ch.pipeline().addLast(<span class="keyword">new</span> ClientHandler());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>å…ˆè¿è¡Œä¹‹å‰- <a href="http://www.throwable.club/2020/01/15/netty-custom-rpc-framework-server" target="_blank" rel="noopener">ã€ŠåŸºäºNettyå’ŒSpringBootå®ç°ä¸€ä¸ªè½»é‡çº§RPCæ¡†æ¶-Serverç¯‡ã€‹</a>ä¸­ç¼–å†™å¥½çš„<code>ServerApplication</code>ï¼Œå†å¯åŠ¨<code>ClientApplication</code>ï¼Œæ—¥å¿—è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// æœåŠ¡ç«¯</span><br><span class="line">2020-01-18 14:32:59 [nioEventLoopGroup-3-2] INFO  club.throwable.server.ServerHandler - æœåŠ¡ç«¯æ¥æ”¶åˆ°:RequestMessagePacket(interfaceName=club.throwable.contract.HelloService, methodName=sayHello, methodArgumentSignatures=[java.lang.String], methodArguments=[PooledUnsafeDirectByteBuf(ridx: 0, widx: 11, cap: 11/144)])</span><br><span class="line">2020-01-18 14:32:59 [nioEventLoopGroup-3-2] INFO  club.throwable.server.ServerHandler - æŸ¥æ‰¾ç›®æ ‡å®ç°æ–¹æ³•æˆåŠŸ,ç›®æ ‡ç±»:club.throwable.server.contract.DefaultHelloService,å®¿ä¸»ç±»:club.throwable.server.contract.DefaultHelloService,å®¿ä¸»æ–¹æ³•:sayHello</span><br><span class="line">2020-01-18 14:32:59 [nioEventLoopGroup-3-2] INFO  club.throwable.server.ServerHandler - æœåŠ¡ç«¯è¾“å‡º:&#123;"attachments":&#123;&#125;,"errorCode":200,"magicNumber":10086,"message":"Success","messageType":"RESPONSE","payload":"\"throwable say hello!\"","serialNumber":"21d131d26fc74f91b4691e0207826b90","version":1&#125;</span><br><span class="line"></span><br><span class="line">// å®¢æˆ·ç«¯</span><br><span class="line">2020-01-18 14:32:59 [nioEventLoopGroup-2-1] INFO  club.throwable.client.ClientHandler - æ¥æ”¶åˆ°å“åº”åŒ…,å†…å®¹:&#123;"attachments":&#123;&#125;,"errorCode":200,"magicNumber":10086,"message":"Success","messageType":"RESPONSE","payload":&#123;"contiguous":true,"direct":true,"readOnly":false,"readable":true,"writable":false&#125;,"serialNumber":"21d131d26fc74f91b4691e0207826b90","version":1&#125;</span><br><span class="line">2020-01-18 14:32:59 [main] INFO  c.throwable.client.ClientApplication - HelloService[throwable]è°ƒç”¨ç»“æœ:"throwable say hello!"</span><br><span class="line">2020-01-18 14:33:04 [CLIENT_HOUSE_KEEPER] INFO  c.t.client.ContractProxyFactory - å¼€å§‹æ‰§è¡ŒResponseFutureTableæ¸…ç†ä»»åŠ¡......</span><br><span class="line">2020-01-18 14:33:04 [CLIENT_HOUSE_KEEPER] WARN  c.t.client.ContractProxyFactory - ç§»é™¤è¿‡æœŸçš„è¯·æ±‚ResponseFuture,è¯·æ±‚ID:21d131d26fc74f91b4691e0207826b90</span><br></pre></td></tr></table></figure><p>å¯è§å¼‚æ­¥çº¿ç¨‹æ¨¡å‹å·²ç»è¢«æ”¹é€ ä¸ºåŒæ­¥åŒ–ï¼Œç°åœ¨å¯ä»¥é€šè¿‡å¥‘çº¦æ¥å£é€šè¿‡<code>RPC</code>åŒæ­¥è°ƒç”¨æœåŠ¡ç«¯ã€‚</p><h2 id="å°ç»“">å°ç»“</h2><p><code>Client</code>ç«¯çš„è¯·æ±‚-å“åº”åŒæ­¥åŒ–å¤„ç†åŸºæœ¬æ”¹é€ å®Œæ¯•ï¼Œåˆ°æ­¤ä¸ºæ­¢ï¼Œä¸€ä¸ª<code>RPC</code>æ¡†æ¶å¤§è‡´å·²ç»å®Œæˆï¼Œæ¥ä¸‹æ¥ä¼šå¯¹<code>Client</code>ç«¯å’Œ<code>Server</code>ç«¯è¿›è¡Œä¸€äº›æ”¹é€ ï¼Œè®©å¥‘çº¦ç›¸å…³ç»„ä»¶æ‰˜ç®¡åˆ°<code>IOC</code>å®¹å™¨ï¼Œå®ç°å¥‘çº¦æ¥å£è‡ªåŠ¨æ³¨å…¥ç­‰ç­‰åŠŸèƒ½ã€‚</p><p><code>Demo</code>é¡¹ç›®åœ°å€ï¼š</p><ul><li><a href="https://github.com/zjcscut/netty-tutorials/tree/master/ch0-custom-rpc-protocol" target="_blank" rel="noopener">ch0-custom-rpc-protocol</a></li></ul><p>ï¼ˆæœ¬æ–‡å®Œe-a-20200118 c-2-dï¼‰</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰æ&quot;&gt;å‰æ&lt;/h2&gt;
&lt;p&gt;å‰ç½®æ–‡ç« ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://www.throwable.club/2020/01/12/netty-custom-rpc-framework-protocol&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;ã€ŠåŸºäºNettyå’ŒSpringBootå®ç°ä¸€ä¸ªè½»é‡çº§RPCæ¡†æ¶-åè®®ç¯‡ã€‹&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://www.throwable.club/2020/01/15/netty-custom-rpc-framework-server&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;ã€ŠåŸºäºNettyå’ŒSpringBootå®ç°ä¸€ä¸ªè½»é‡çº§RPCæ¡†æ¶-Serverç¯‡ã€‹&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://www.throwable.club/2020/01/16/netty-custom-rpc-framework-client&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;ã€ŠåŸºäºNettyå’ŒSpringBootå®ç°ä¸€ä¸ªè½»é‡çº§RPCæ¡†æ¶-Clientç¯‡ã€‹&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å‰ä¸€ç¯‡æ–‡ç« ç®€å•ä»‹ç»äº†é€šè¿‡åŠ¨æ€ä»£ç†å®Œæˆäº†&lt;code&gt;Client&lt;/code&gt;ç«¯å¥‘çº¦æ¥å£è°ƒç”¨è½¬æ¢ä¸ºå‘é€&lt;code&gt;RPC&lt;/code&gt;åè®®è¯·æ±‚çš„åŠŸèƒ½ã€‚è¿™ç¯‡æ–‡ç« ä¸»è¦è§£å†³ä¸€ä¸ªé—ç•™çš„æŠ€æœ¯éš¾é¢˜ï¼šè¯·æ±‚-å“åº”åŒæ­¥åŒ–å¤„ç†ã€‚&lt;/p&gt;
&lt;p&gt;éœ€è¦çš„ä¾èµ–å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;JDK1.8+&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Netty:4.1.44.Final&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;SpringBoot:2.2.2.RELEASE&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
    
      <category term="Netty" scheme="http://throwable.club/blog/categories/Netty/"/>
    
      <category term="Java" scheme="http://throwable.club/blog/categories/Netty/Java/"/>
    
    
      <category term="Java" scheme="http://throwable.club/blog/tags/Java/"/>
    
      <category term="Netty" scheme="http://throwable.club/blog/tags/Netty/"/>
    
  </entry>
  
  <entry>
    <title>åŸºäºNettyå’ŒSpringBootå®ç°ä¸€ä¸ªè½»é‡çº§RPCæ¡†æ¶-Clientç¯‡</title>
    <link href="http://throwable.club/2020/01/16/netty-custom-rpc-framework-client/"/>
    <id>http://throwable.club/2020/01/16/netty-custom-rpc-framework-client/</id>
    <published>2020-01-16T14:56:51.000Z</published>
    <updated>2020-01-16T14:57:36.225Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰æ">å‰æ</h2><p>å‰ç½®æ–‡ç« ï¼š</p><ul><li><a href="http://www.throwable.club/2020/01/12/netty-custom-rpc-framework-protocol" target="_blank" rel="noopener">ã€ŠåŸºäºNettyå’ŒSpringBootå®ç°ä¸€ä¸ªè½»é‡çº§RPCæ¡†æ¶-åè®®ç¯‡ã€‹</a></li><li><a href="http://www.throwable.club/2020/01/15/netty-custom-rpc-framework-server" target="_blank" rel="noopener">ã€ŠåŸºäºNettyå’ŒSpringBootå®ç°ä¸€ä¸ªè½»é‡çº§RPCæ¡†æ¶-Serverç¯‡ã€‹</a></li></ul><p>å‰ä¸€ç¯‡æ–‡ç« ç›¸å¯¹ç®€ç•¥åœ°ä»‹ç»äº†<code>RPC</code>æœåŠ¡ç«¯çš„ç¼–å†™ï¼Œè€Œè¿™ç¯‡åšæ–‡æœ€è¦ä»‹ç»æœåŠ¡ç«¯ï¼ˆ<code>Client</code>ï¼‰çš„å®ç°ã€‚<code>RPC</code>è°ƒç”¨ä¸€èˆ¬æ˜¯é¢å‘å¥‘çº¦ç¼–ç¨‹çš„ï¼Œè€Œ<code>Client</code>çš„æ ¸å¿ƒåŠŸèƒ½å°±æ˜¯ï¼šæŠŠå¥‘çº¦æ¥å£æ–¹æ³•çš„è°ƒç”¨æŠ½è±¡ä¸ºä½¿ç”¨<code>Netty</code>å‘<code>RPC</code>æœåŠ¡ç«¯é€šè¿‡ç§æœ‰åè®®å‘é€ä¸€ä¸ªè¯·æ±‚ã€‚è¿™é‡Œæœ€åº•å±‚çš„å®ç°ä¾èµ–äºåŠ¨æ€ä»£ç†ï¼Œå› æ­¤åŠ¨æ€ä»£ç†æ˜¯åŠ¨æ€å®ç°æ¥å£çš„æœ€ç®€å•æ–¹å¼ï¼ˆå¦‚æœå­—èŠ‚ç ç ”ç©¶å¾—æ¯”è¾ƒæ·±å…¥ï¼Œå¯ä»¥é€šè¿‡å­—èŠ‚ç ç¼–ç¨‹å®ç°æ¥å£ï¼‰ã€‚éœ€è¦çš„ä¾èµ–å¦‚ä¸‹ï¼š</p><ul><li><code>JDK1.8+</code></li><li><code>Netty:4.1.44.Final</code></li><li><code>SpringBoot:2.2.2.RELEASE</code></li></ul><a id="more"></a><h2 id="åŠ¨æ€ä»£ç†çš„ç®€å•ä½¿ç”¨">åŠ¨æ€ä»£ç†çš„ç®€å•ä½¿ç”¨</h2><p>ä¸€èˆ¬å¯ä»¥é€šè¿‡<code>JDK</code>åŠ¨æ€ä»£ç†æˆ–è€…<code>Cglib</code>çš„å­—èŠ‚ç å¢å¼ºæ¥å®ç°æ­¤åŠŸèƒ½ï¼Œä¸ºäº†ç®€å•èµ·è§ï¼Œä¸å¼•å…¥é¢å¤–çš„ä¾èµ–ï¼Œè¿™é‡Œé€‰ç”¨<code>JDK</code>åŠ¨æ€ä»£ç†ã€‚è¿™é‡Œé‡æ–°æ¬å‡ºå‰é¢æåˆ°çš„å¥‘çº¦æ¥å£<code>HelloService</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HelloService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">sayHello</span><span class="params">(String name)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥éœ€è¦é€šè¿‡åŠ¨æ€ä»£ç†ä¸ºæ­¤æ¥å£æ·»åŠ ä¸€ä¸ªå®ç°ï¼š</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestDynamicProxy</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Class&lt;HelloService&gt; interfaceKlass = HelloService<span class="class">.<span class="keyword">class</span></span>;</span><br><span class="line">        InvocationHandler handler = <span class="keyword">new</span> HelloServiceImpl(interfaceKlass);</span><br><span class="line">        HelloService helloService = (HelloService)</span><br><span class="line">                Proxy.newProxyInstance(interfaceKlass.getClassLoader(), <span class="keyword">new</span> Class[]&#123;interfaceKlass&#125;, handler);</span><br><span class="line">        System.out.println(helloService.sayHello(<span class="string">"throwable"</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequiredArgsConstructor</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloServiceImpl</span> <span class="keyword">implements</span> <span class="title">InvocationHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> Class&lt;?&gt; interfaceKlass;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">            <span class="comment">// è¿™é‡Œåº”è¯¥æ ¹æ®æ–¹æ³•çš„è¿”å›å€¼ç±»å‹å»å†³å®šè¿”å›ç»“æœ</span></span><br><span class="line">            <span class="keyword">return</span> String.format(<span class="string">"[%s#%s]æ–¹æ³•è¢«è°ƒç”¨,å‚æ•°åˆ—è¡¨:%s"</span>, interfaceKlass.getName(), method.getName(),</span><br><span class="line">                    JSON.toJSONString(args));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ§åˆ¶å°è¾“å‡ºç»“æœ</span></span><br><span class="line">[club.throwable.contract.HelloService#sayHello]æ–¹æ³•è¢«è°ƒç”¨,å‚æ•°åˆ—è¡¨:["throwable"]</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯ä»¥ç¡®è®¤ä¸¤ç‚¹ï¼š</p><ol><li><code>InvocationHandler</code>å®ç°åä¼šå¯¹è¢«ä»£ç†æ¥å£ç”Ÿæˆä¸€ä¸ªåŠ¨æ€å®ç°ç±»ã€‚</li><li>åŠ¨æ€å®ç°ç±»ï¼ˆæ¥å£ï¼‰æ–¹æ³•è¢«è°ƒç”¨çš„æ—¶å€™ï¼Œå®é™…ä¸Šæ˜¯è°ƒç”¨<code>InvocationHandler</code>å¯¹åº”å®ä¾‹çš„<code>invoke()</code>æ–¹æ³•ï¼Œä¼ å…¥çš„å‚æ•°å°±æ˜¯å½“å‰æ–¹æ³•è°ƒç”¨çš„å…ƒæ•°æ®ã€‚</li></ol><h2 id="Clientç«¯ä»£ç å®ç°">Clientç«¯ä»£ç å®ç°</h2><p><code>Client</code>ç«¯éœ€è¦é€šè¿‡åŠ¨æ€ä»£ç†ä¸ºå¥‘çº¦æ¥å£ç”Ÿæˆä¸€ä¸ªåŠ¨æ€å®ç°ç±»ï¼Œç„¶åæå–å¥‘çº¦æ¥å£è°ƒç”¨æ–¹æ³•æ—¶å€™æ‰€èƒ½æä¾›çš„å…ƒæ•°æ®ï¼Œé€šè¿‡è¿™äº›å…ƒæ•°æ®å’Œ<code>Netty</code>å®¢æˆ·ç«¯çš„æ”¯æŒï¼ˆä¾‹å¦‚<code>Netty</code>çš„<code>Channel</code>ï¼‰åŸºäºç§æœ‰<code>RPC</code>åè®®ç»„è£…è¯·æ±‚ä¿¡æ¯å¹¶ä¸”å‘é€è¯·æ±‚ã€‚è¿™é‡Œå…ˆå®šä¹‰ä¸€ä¸ªè¯·æ±‚å‚æ•°æå–å™¨æ¥å£<code>RequestArgumentExtractor</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestArgumentExtractInput</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Class&lt;?&gt; interfaceKlass;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Method method;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestArgumentExtractOutput</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String interfaceName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String methodName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; methodArgumentSignatures;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ¥å£</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RequestArgumentExtractor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">RequestArgumentExtractOutput <span class="title">extract</span><span class="params">(RequestArgumentExtractInput input)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç®€å•å®ç°ä¸€ä¸‹ï¼Œè§£æç»“æœæ·»åŠ åˆ°ç¼“å­˜ä¸­ï¼Œå®ç°ç±»<code>DefaultRequestArgumentExtractor</code>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultRequestArgumentExtractor</span> <span class="keyword">implements</span> <span class="title">RequestArgumentExtractor</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;CacheKey, RequestArgumentExtractOutput&gt; cache = Maps.newConcurrentMap();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RequestArgumentExtractOutput <span class="title">extract</span><span class="params">(RequestArgumentExtractInput input)</span> </span>&#123;</span><br><span class="line">        Class&lt;?&gt; interfaceKlass = input.getInterfaceKlass();</span><br><span class="line">        Method method = input.getMethod();</span><br><span class="line">        String methodName = method.getName();</span><br><span class="line">        Class&lt;?&gt;[] parameterTypes = method.getParameterTypes();</span><br><span class="line">        <span class="keyword">return</span> cache.computeIfAbsent(<span class="keyword">new</span> CacheKey(interfaceKlass.getName(), methodName,</span><br><span class="line">                Lists.newArrayList(parameterTypes)), x -&gt; &#123;</span><br><span class="line">            RequestArgumentExtractOutput output = <span class="keyword">new</span> RequestArgumentExtractOutput();</span><br><span class="line">            output.setInterfaceName(interfaceKlass.getName());</span><br><span class="line">            List&lt;String&gt; methodArgumentSignatures = Lists.newArrayList();</span><br><span class="line">            <span class="keyword">for</span> (Class&lt;?&gt; klass : parameterTypes) &#123;</span><br><span class="line">                methodArgumentSignatures.add(klass.getName());</span><br><span class="line">            &#125;</span><br><span class="line">            output.setMethodArgumentSignatures(methodArgumentSignatures);</span><br><span class="line">            output.setMethodName(methodName);</span><br><span class="line">            <span class="keyword">return</span> output;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequiredArgsConstructor</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CacheKey</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String interfaceName;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> String methodName;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> List&lt;Class&lt;?&gt;&gt; parameterTypes;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">equals</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span> == o) <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (o == <span class="keyword">null</span> || getClass() != o.getClass()) <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            CacheKey cacheKey = (CacheKey) o;</span><br><span class="line">            <span class="keyword">return</span> Objects.equals(interfaceName, cacheKey.interfaceName) &amp;&amp;</span><br><span class="line">                    Objects.equals(methodName, cacheKey.methodName) &amp;&amp;</span><br><span class="line">                    Objects.equals(parameterTypes, cacheKey.parameterTypes);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> Objects.hash(interfaceName, methodName, parameterTypes);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä¸è€ƒè™‘é‡è¿ã€æ–­è¿ç­‰æƒ…å†µä¸‹ï¼Œæ–°å¢ä¸€ä¸ªç±»<code>ClientChannelHolder</code>ç”¨äºä¿å­˜<code>Netty</code>å®¢æˆ·ç«¯çš„<code>Channel</code>å®ä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientChannelHolder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> AtomicReference&lt;Channel&gt; CHANNEL_REFERENCE = <span class="keyword">new</span> AtomicReference&lt;&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ç€æ–°å¢ä¸€ä¸ªå¥‘çº¦åŠ¨æ€ä»£ç†å·¥å‚ï¼ˆå·¥å…·ç±»ï¼‰<code>ContractProxyFactory</code>ï¼Œç”¨äºä¸ºå¥‘çº¦æ¥å£ç”Ÿæˆä»£ç†ç±»å®ä¾‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ContractProxyFactory</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> RequestArgumentExtractor EXTRACTOR = <span class="keyword">new</span> DefaultRequestArgumentExtractor();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> ConcurrentMap&lt;Class&lt;?&gt;, Object&gt; CACHE = Maps.newConcurrentMap();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">ofProxy</span><span class="params">(Class&lt;T&gt; interfaceKlass)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ç¼“å­˜å¥‘çº¦æ¥å£çš„ä»£ç†ç±»å®ä¾‹</span></span><br><span class="line">        <span class="keyword">return</span> (T) CACHE.computeIfAbsent(interfaceKlass, x -&gt;</span><br><span class="line">                Proxy.newProxyInstance(interfaceKlass.getClassLoader(), <span class="keyword">new</span> Class[]&#123;interfaceKlass&#125;, (target, method, args) -&gt; &#123;</span><br><span class="line">                    RequestArgumentExtractInput input = <span class="keyword">new</span> RequestArgumentExtractInput();</span><br><span class="line">                    input.setInterfaceKlass(interfaceKlass);</span><br><span class="line">                    input.setMethod(method);</span><br><span class="line">                    RequestArgumentExtractOutput output = EXTRACTOR.extract(input);</span><br><span class="line">                    <span class="comment">// å°è£…è¯·æ±‚å‚æ•°</span></span><br><span class="line">                    RequestMessagePacket packet = <span class="keyword">new</span> RequestMessagePacket();</span><br><span class="line">                    packet.setMagicNumber(ProtocolConstant.MAGIC_NUMBER);</span><br><span class="line">                    packet.setVersion(ProtocolConstant.VERSION);</span><br><span class="line">                    packet.setSerialNumber(SerialNumberUtils.X.generateSerialNumber());</span><br><span class="line">                    packet.setMessageType(MessageType.REQUEST);</span><br><span class="line">                    packet.setInterfaceName(output.getInterfaceName());</span><br><span class="line">                    packet.setMethodName(output.getMethodName());</span><br><span class="line">                    packet.setMethodArgumentSignatures(output.getMethodArgumentSignatures().toArray(<span class="keyword">new</span> String[<span class="number">0</span>]));</span><br><span class="line">                    packet.setMethodArguments(args);</span><br><span class="line">                    Channel channel = ClientChannelHolder.CHANNEL_REFERENCE.get();</span><br><span class="line">                    <span class="comment">// å‘èµ·è¯·æ±‚</span></span><br><span class="line">                    channel.writeAndFlush(packet);</span><br><span class="line">                    <span class="comment">// è¿™é‡Œæ–¹æ³•è¿”å›å€¼éœ€è¦è¿›è¡ŒåŒæ­¥å¤„ç†,ç›¸å¯¹å¤æ‚,åé¢ä¸“é—¨å¼€ä¸€ç¯‡æ–‡ç« è®²è§£,æš‚æ—¶ç»Ÿä¸€è¿”å›å­—ç¬¦ä¸²</span></span><br><span class="line">                    <span class="comment">// å¦‚æœå¥‘çº¦æ¥å£çš„è¿”å›å€¼ç±»å‹ä¸æ˜¯å­—ç¬¦ä¸²,è¿™é‡Œæ–¹æ³•è¿”å›åä¼šæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">                    <span class="keyword">return</span> String.format(<span class="string">"[%s#%s]è°ƒç”¨æˆåŠŸ,å‘é€äº†[%s]åˆ°NettyServer[%s]"</span>, output.getInterfaceName(),</span><br><span class="line">                            output.getMethodName(), JSON.toJSONString(packet), channel.remoteAddress());</span><br><span class="line">                &#125;));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åç¼–å†™å®¢æˆ·ç«¯<code>ClientApplication</code>çš„ä»£ç :</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> port = <span class="number">9092</span>;</span><br><span class="line">        EventLoopGroup workerGroup = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">        Bootstrap bootstrap = <span class="keyword">new</span> Bootstrap();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            bootstrap.group(workerGroup);</span><br><span class="line">            bootstrap.channel(NioSocketChannel<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            bootstrap.option(ChannelOption.SO_KEEPALIVE, Boolean.TRUE);</span><br><span class="line">            bootstrap.option(ChannelOption.TCP_NODELAY, Boolean.TRUE);</span><br><span class="line">            bootstrap.handler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                    ch.pipeline().addLast(<span class="keyword">new</span> LengthFieldBasedFrameDecoder(<span class="number">1024</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">0</span>, <span class="number">4</span>));</span><br><span class="line">                    ch.pipeline().addLast(<span class="keyword">new</span> LengthFieldPrepender(<span class="number">4</span>));</span><br><span class="line">                    ch.pipeline().addLast(<span class="keyword">new</span> LoggingHandler(LogLevel.DEBUG));</span><br><span class="line">                    ch.pipeline().addLast(<span class="keyword">new</span> RequestMessagePacketEncoder(FastJsonSerializer.X));</span><br><span class="line">                    ch.pipeline().addLast(<span class="keyword">new</span> ResponseMessagePacketDecoder());</span><br><span class="line">                    ch.pipeline().addLast(<span class="keyword">new</span> SimpleChannelInboundHandler&lt;ResponseMessagePacket&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">channelRead0</span><span class="params">(ChannelHandlerContext ctx, ResponseMessagePacket packet)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                            Object targetPayload = packet.getPayload();</span><br><span class="line">                            <span class="keyword">if</span> (targetPayload <span class="keyword">instanceof</span> ByteBuf) &#123;</span><br><span class="line">                                ByteBuf byteBuf = (ByteBuf) targetPayload;</span><br><span class="line">                                <span class="keyword">int</span> readableByteLength = byteBuf.readableBytes();</span><br><span class="line">                                <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[readableByteLength];</span><br><span class="line">                                byteBuf.readBytes(bytes);</span><br><span class="line">                                targetPayload = FastJsonSerializer.X.decode(bytes, String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">                                byteBuf.release();</span><br><span class="line">                            &#125;</span><br><span class="line">                            packet.setPayload(targetPayload);</span><br><span class="line">                            log.info(<span class="string">"æ¥æ”¶åˆ°æ¥è‡ªæœåŠ¡ç«¯çš„å“åº”æ¶ˆæ¯,æ¶ˆæ¯å†…å®¹:&#123;&#125;"</span>, JSON.toJSONString(packet));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            ChannelFuture future = bootstrap.connect(<span class="string">"localhost"</span>, port).sync();</span><br><span class="line">            <span class="comment">// ä¿å­˜Channelå®ä¾‹,æš‚æ—¶ä¸è€ƒè™‘æ–­è¿é‡è¿</span></span><br><span class="line">            ClientChannelHolder.CHANNEL_REFERENCE.set(future.channel());</span><br><span class="line">            <span class="comment">// æ„é€ å¥‘çº¦æ¥å£ä»£ç†ç±»å®ä¾‹</span></span><br><span class="line">            HelloService helloService = ContractProxyFactory.ofProxy(HelloService<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            String result = helloService.sayHello(<span class="string">"throwable"</span>);</span><br><span class="line">            log.info(result);</span><br><span class="line">            future.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            workerGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆå¯åŠ¨<a href="http://www.throwable.club/2020/01/15/netty-custom-rpc-framework-server" target="_blank" rel="noopener">ã€ŠåŸºäºNettyå’ŒSpringBootå®ç°ä¸€ä¸ªè½»é‡çº§RPCæ¡†æ¶-Serverç¯‡ã€‹</a>ä¸€æ–‡ä¸­çš„<code>ServerApplication</code>ï¼Œå†å¯åŠ¨<code>ClientApplication</code>ï¼Œæ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// æœåŠ¡ç«¯æ—¥å¿—</span><br><span class="line">2020-01-16 22:34:51 [main] INFO  c.throwable.server.ServerApplication - å¯åŠ¨NettyServer[9092]æˆåŠŸ...</span><br><span class="line">2020-01-16 22:36:35 [nioEventLoopGroup-3-1] INFO  club.throwable.server.ServerHandler - æœåŠ¡ç«¯æ¥æ”¶åˆ°:RequestMessagePacket(interfaceName=club.throwable.contract.HelloService, methodName=sayHello, methodArgumentSignatures=[java.lang.String], methodArguments=[PooledUnsafeDirectByteBuf(ridx: 0, widx: 11, cap: 11/144)])</span><br><span class="line">2020-01-16 22:36:35 [nioEventLoopGroup-3-1] INFO  club.throwable.server.ServerHandler - æŸ¥æ‰¾ç›®æ ‡å®ç°æ–¹æ³•æˆåŠŸ,ç›®æ ‡ç±»:club.throwable.server.contract.DefaultHelloService,å®¿ä¸»ç±»:club.throwable.server.contract.DefaultHelloService,å®¿ä¸»æ–¹æ³•:sayHello</span><br><span class="line">2020-01-16 22:36:35 [nioEventLoopGroup-3-1] INFO  club.throwable.server.ServerHandler - æœåŠ¡ç«¯è¾“å‡º:&#123;"attachments":&#123;&#125;,"errorCode":200,"magicNumber":10086,"message":"Success","messageType":"RESPONSE","payload":"\"throwable say hello!\"","serialNumber":"63d386214d30410c9e5f04de03d8b2da","version":1&#125;</span><br><span class="line"></span><br><span class="line">// å®¢æˆ·ç«¯æ—¥å¿—</span><br><span class="line">2020-01-16 22:36:35 [main] INFO  c.throwable.client.ClientApplication - [club.throwable.contract.HelloService#sayHello]è°ƒç”¨æˆåŠŸ,å‘é€äº†[&#123;"attachments":&#123;&#125;,"interfaceName":"club.throwable.contract.HelloService","magicNumber":10086,"messageType":"REQUEST","methodArgumentSignatures":["java.lang.String"],"methodArguments":["throwable"],"methodName":"sayHello","serialNumber":"63d386214d30410c9e5f04de03d8b2da","version":1&#125;]åˆ°NettyServer[localhost/127.0.0.1:9092]</span><br><span class="line">2020-01-16 22:36:35 [nioEventLoopGroup-2-1] INFO  c.throwable.client.ClientApplication - æ¥æ”¶åˆ°æ¥è‡ªæœåŠ¡ç«¯çš„å“åº”æ¶ˆæ¯,æ¶ˆæ¯å†…å®¹:&#123;"attachments":&#123;&#125;,"errorCode":200,"magicNumber":10086,"message":"Success","messageType":"RESPONSE","payload":"\"throwable say hello!\"","serialNumber":"63d386214d30410c9e5f04de03d8b2da","version":1&#125;</span><br></pre></td></tr></table></figure><h2 id="å°ç»“">å°ç»“</h2><p><code>Client</code>ç«¯ä¸»è¦è´Ÿè´£å¥‘çº¦æ¥å£è°ƒç”¨è½¬æ¢ä¸ºå‘é€<code>RPC</code>åè®®è¯·æ±‚è¿™ä¸€æ­¥ï¼Œæ ¸å¿ƒæŠ€æœ¯å°±æ˜¯åŠ¨æ€ä»£ç†ï¼Œåœ¨ä¸è¿›è¡Œæ¨¡å—å°è£…ä¼˜åŒ–çš„å‰æä¸‹å®ç°æ˜¯ç›¸å¯¹ç®€å•çš„ã€‚è¿™é‡Œå…¶å®<code>Client</code>ç«¯è¿˜æœ‰ä¸€ä¸ªæ¯”è¾ƒå¤§çš„æŠ€æœ¯éš¾é¢˜æ²¡æœ‰è§£å†³ï¼Œä¸Šé¢ä¾‹å­ä¸­å®¢æˆ·ç«¯æ—¥å¿—è¾“å‡ºå¦‚æœçœ¼å°–çš„ä¼™ä¼´ä¼šå‘ç°ï¼Œ<code>Client</code>ç«¯å‘é€<code>RPC</code>è¯·æ±‚çš„çº¿ç¨‹ï¼ˆ<code>main</code>çº¿ç¨‹ï¼‰å’Œ<code>Client</code>ç«¯æ¥æ”¶<code>Server</code>ç«¯<code>RPC</code>å“åº”å¤„ç†çš„çº¿ç¨‹ï¼ˆ<code>nioEventLoopGroup-2-1</code>çº¿ç¨‹ï¼‰å¹¶ä¸ç›¸åŒï¼Œè¿™ä¸€ç‚¹æ˜¯<code>Netty</code>å¤„ç†ç½‘ç»œè¯·æ±‚ä¹‹æ‰€ä»¥èƒ½å¤Ÿå¦‚æ­¤é«˜æ•ˆçš„æ ¹æºï¼ˆç®€å•æ¥è¯´å°±æ˜¯è¯·æ±‚å’Œå“åº”æ˜¯å¼‚æ­¥çš„ï¼Œä¸¤ä¸ªæµç¨‹æœ¬æ¥æ˜¯äº’ä¸æ„ŸçŸ¥çš„ï¼‰ã€‚ä½†æ˜¯æ›´å¤šæƒ…å†µä¸‹ï¼Œæˆ‘ä»¬å¸Œæœ›å¤–éƒ¨è¯·æ±‚æ˜¯åŒæ­¥çš„ï¼Œå¸Œæœ›å‘é€<code>RPC</code>è¯·æ±‚çš„çº¿ç¨‹å¾—åˆ°å“åº”ç»“æœå†è¿”å›ï¼ˆè¿™é‡Œè¯·æ±‚å’Œå“åº”æœ‰å¯èƒ½ä¾ç„¶æ˜¯å¼‚æ­¥æµç¨‹ï¼‰ã€‚ä¸‹ä¸€ç¯‡æ–‡ç« ä¼šè¯¦ç»†åˆ†æä¸€ä¸‹å¦‚æœå¯¹è¯·æ±‚-å“åº”åšåŒæ­¥åŒ–å¤„ç†ã€‚</p><p><code>Demo</code>é¡¹ç›®åœ°å€ï¼š</p><ul><li><a href="https://github.com/zjcscut/netty-tutorials/tree/master/ch0-custom-rpc-protocol" target="_blank" rel="noopener">ch0-custom-rpc-protocol</a></li></ul><p>ï¼ˆc-2-d e-a-20200116ï¼‰</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰æ&quot;&gt;å‰æ&lt;/h2&gt;
&lt;p&gt;å‰ç½®æ–‡ç« ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href=&quot;http://www.throwable.club/2020/01/12/netty-custom-rpc-framework-protocol&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;ã€ŠåŸºäºNettyå’ŒSpringBootå®ç°ä¸€ä¸ªè½»é‡çº§RPCæ¡†æ¶-åè®®ç¯‡ã€‹&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;http://www.throwable.club/2020/01/15/netty-custom-rpc-framework-server&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;ã€ŠåŸºäºNettyå’ŒSpringBootå®ç°ä¸€ä¸ªè½»é‡çº§RPCæ¡†æ¶-Serverç¯‡ã€‹&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;å‰ä¸€ç¯‡æ–‡ç« ç›¸å¯¹ç®€ç•¥åœ°ä»‹ç»äº†&lt;code&gt;RPC&lt;/code&gt;æœåŠ¡ç«¯çš„ç¼–å†™ï¼Œè€Œè¿™ç¯‡åšæ–‡æœ€è¦ä»‹ç»æœåŠ¡ç«¯ï¼ˆ&lt;code&gt;Client&lt;/code&gt;ï¼‰çš„å®ç°ã€‚&lt;code&gt;RPC&lt;/code&gt;è°ƒç”¨ä¸€èˆ¬æ˜¯é¢å‘å¥‘çº¦ç¼–ç¨‹çš„ï¼Œè€Œ&lt;code&gt;Client&lt;/code&gt;çš„æ ¸å¿ƒåŠŸèƒ½å°±æ˜¯ï¼šæŠŠå¥‘çº¦æ¥å£æ–¹æ³•çš„è°ƒç”¨æŠ½è±¡ä¸ºä½¿ç”¨&lt;code&gt;Netty&lt;/code&gt;å‘&lt;code&gt;RPC&lt;/code&gt;æœåŠ¡ç«¯é€šè¿‡ç§æœ‰åè®®å‘é€ä¸€ä¸ªè¯·æ±‚ã€‚è¿™é‡Œæœ€åº•å±‚çš„å®ç°ä¾èµ–äºåŠ¨æ€ä»£ç†ï¼Œå› æ­¤åŠ¨æ€ä»£ç†æ˜¯åŠ¨æ€å®ç°æ¥å£çš„æœ€ç®€å•æ–¹å¼ï¼ˆå¦‚æœå­—èŠ‚ç ç ”ç©¶å¾—æ¯”è¾ƒæ·±å…¥ï¼Œå¯ä»¥é€šè¿‡å­—èŠ‚ç ç¼–ç¨‹å®ç°æ¥å£ï¼‰ã€‚éœ€è¦çš„ä¾èµ–å¦‚ä¸‹ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;JDK1.8+&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Netty:4.1.44.Final&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;SpringBoot:2.2.2.RELEASE&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
    
      <category term="Netty" scheme="http://throwable.club/blog/categories/Netty/"/>
    
      <category term="Java" scheme="http://throwable.club/blog/categories/Netty/Java/"/>
    
    
      <category term="Java" scheme="http://throwable.club/blog/tags/Java/"/>
    
      <category term="Netty" scheme="http://throwable.club/blog/tags/Netty/"/>
    
  </entry>
  
  <entry>
    <title>åŸºäºNettyå’ŒSpringBootå®ç°ä¸€ä¸ªè½»é‡çº§RPCæ¡†æ¶-Serverç¯‡</title>
    <link href="http://throwable.club/2020/01/15/netty-custom-rpc-framework-server/"/>
    <id>http://throwable.club/2020/01/15/netty-custom-rpc-framework-server/</id>
    <published>2020-01-14T16:13:38.000Z</published>
    <updated>2020-01-15T13:27:37.832Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰æ">å‰æ</h2><p>å‰ç½®æ–‡ç« ï¼š</p><ul><li><code>Github Page</code>ï¼š<a href="http://throwable.club/2020/01/12/netty-custom-rpc-framework-protocol">ã€ŠåŸºäºNettyå’ŒSpringBootå®ç°ä¸€ä¸ªè½»é‡çº§RPCæ¡†æ¶-åè®®ç¯‡ã€‹</a></li><li><code>Coding Page</code>ï¼š<a href="http://throwable.coding.me/2020/01/12/netty-custom-rpc-framework-protocol" target="_blank" rel="noopener">ã€ŠåŸºäºNettyå’ŒSpringBootå®ç°ä¸€ä¸ªè½»é‡çº§RPCæ¡†æ¶-åè®®ç¯‡ã€‹</a></li></ul><p>åœ¨å‰ç½®çš„ã€ŠåŸºäºNettyå’ŒSpringBootå®ç°ä¸€ä¸ªè½»é‡çº§RPCæ¡†æ¶-åè®®ç¯‡ã€‹ä¸€æ–‡ä¸­å·²ç»å®šä¹‰äº†ä¸€ä¸ªç›¸å¯¹ç®€å•çš„<code>RPC</code>ç§æœ‰åè®®ï¼Œå¹¶ä¸”å®ç°äº†å¯¹åº”çš„ç¼–ç å’Œè§£ç æ¨¡å—ã€‚è¿™ç¯‡æ–‡ç« åŸºäºåè®®ç¯‡ï¼Œå®Œæˆ<code>Server</code>ç«¯ä»£ç è°ƒç”¨çš„ç¼–å†™ã€‚è€ƒè™‘åˆ°ç›®å‰ç›¸å¯¹ä¸»æµçš„<code>IOC</code>å®¹å™¨æ˜¯<code>Spring</code>ï¼Œè¿™é‡Œé€‰ç”¨äº†<code>spring-boot-starter</code>ï¼ˆé<code>MVC</code>å®¹å™¨ï¼Œåªæ˜¯å•çº¯ç®¡ç†<code>Bean</code>ï¼‰ï¼Œä¾èµ–<code>JDK1.8+</code>ã€‚</p><a id="more"></a><h2 id="æ€è·¯">æ€è·¯</h2><p>é¦–å…ˆ<code>RPC</code>ç§æœ‰åè®®å®šä¹‰äº†<code>Client</code>ç«¯ä¼šä¼ è¿‡æ¥å››ä¸ªå’ŒæœåŠ¡è°ƒç”¨æ¯æ¯ç›¸å…³çš„å­—æ®µï¼šæ¥å£å…¨ç±»å<code>interfaceName</code>ã€æ–¹æ³•å<code>methodName</code>ã€æ–¹æ³•å‚æ•°ç­¾åå­—ç¬¦ä¸²æ•°ç»„<code>methodArgumentSignatures</code>ï¼ˆå¯é€‰ï¼Œè¿™ä¸ªå‚æ•°ä¸æ˜¯å¿…é¡»ä¼ å…¥çš„ï¼‰ä»¥åŠæ–¹æ³•å‚æ•°æ•°ç»„<code>methodArguments</code>ï¼ˆå¯é€‰ï¼Œç©ºæ–¹æ³•åˆ—è¡¨çš„æ—¶å€™ä¸éœ€è¦ä¼ å…¥å‚æ•°ï¼‰ã€‚ä¸»è¦æµç¨‹å¦‚ä¸‹ï¼š</p><ul><li>æŠŠ<code>Server</code>ç«¯çš„æ‰€æœ‰æœåŠ¡ç«¯ï¼ˆå®ç°ï¼‰ç±»äº¤ç”±<code>IOC</code>å®¹å™¨æ‰˜ç®¡ã€‚</li><li><code>Client</code>ç«¯å‘èµ·<code>RPC</code>è¯·æ±‚ã€‚</li><li>é€šè¿‡å‰é¢æåˆ°çš„æœ€å¤šå››ä¸ªå‚æ•°ï¼Œä»<code>Server</code>æœåŠ¡å®ä¾‹çš„<code>IOC</code>å®¹å™¨ä¸­<strong>åŒ¹é…å‡ºå»åˆåº¦æœ€é«˜çš„ä¸€ä¸ªæ–¹æ³•</strong><code>java.lang.reflect.Method</code>å®ä¾‹ã€è¯¥æ–¹æ³•å®ä¾‹çš„å®¿ä¸»ç±»ä»¥åŠå®¿ä¸»ç±»å¯¹åº”çš„<code>Bean</code>å®ä¾‹ï¼Œå¦‚æœè¿™ä¸€æ­¥åŒ¹é…çš„ç›®æ ‡æ–¹æ³•è¶…è¿‡1ä¸ªæˆ–è€…ä¸º0ä¸ªï¼Œå¯ä»¥ç›´æ¥è¿”å›å¼‚å¸¸ä¿¡æ¯ã€‚</li><li>æŠŠå‰ä¸€æ­¥å¾—åˆ°çš„<code>Method</code>å®ä¾‹ã€å®¿ä¸»ç±»<code>Bean</code>å®ä¾‹ï¼Œç»“åˆæ–¹æ³•å‚æ•°æ•°ç»„<code>methodArguments</code>è¿›è¡Œåå°„è°ƒç”¨ï¼Œå¾—åˆ°è°ƒç”¨ç»“æœã€‚</li><li><code>Server</code>ç«¯æŠŠå“åº”ç»“æœå°è£…åˆ°<code>payload</code>é€šè¿‡ç§æœ‰åè®®å‘é€å›<code>Client</code>ç«¯ã€‚</li></ul><h2 id="Serverç«¯ä»£ç å®ç°">Serverç«¯ä»£ç å®ç°</h2><p>ä¸ºäº†æš‚æ—¶æ–¹ä¾¿èµ·è§ï¼Œéƒ¨åˆ†æ•°ç»„å…¥å‚è¢«é‡æ–°å°è£…ä¸º<code>ArrayList</code>ï¼Œå®é™…ä¸Šç¼–å†™<code>RPC</code>æ¡†æ¶çš„æ—¶å€™åº”è¯¥ä¼˜å…ˆè€ƒè™‘æ€§èƒ½é—®é¢˜ï¼Œåƒ<code>JDK</code>æä¾›çš„é›†åˆç±»åº“ç­‰ç­‰åº”è¯¥å°½å¯èƒ½å°‘ç”¨ï¼ˆä»¥<code>ArrayList</code>ä¸ºä¾‹ï¼Œæ‰©å®¹çš„æ—¶å€™å­˜åœ¨åº•å±‚<code>Object[]</code>æ‹·è´ï¼Œé€ æˆæ€§èƒ½æŸå¤±å’Œé¢å¤–çš„å†…å­˜æ¶ˆè€—ï¼‰ï¼Œæå°½å¯èƒ½ä½¿ç”¨åŸºæœ¬ç±»å‹å’Œæ•°ç»„ã€‚</p><p>å…ˆå®šä¹‰<strong>æ–¹æ³•åŒ¹é…å™¨</strong><code>MethodMatcher</code>ç›¸å…³çš„ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MethodMatcher</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æŸ¥æ‰¾ä¸€ä¸ªåŒ¹é…åº¦æœ€é«˜çš„æ–¹æ³•ä¿¡æ¯</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> input input</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> output</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">MethodMatchOutput <span class="title">selectOneBestMatchMethod</span><span class="params">(MethodMatchInput input)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¾“å…¥å€¼</span></span><br><span class="line"><span class="meta">@EqualsAndHashCode</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodMatchInput</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String interfaceName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String methodName;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> List&lt;String&gt; methodArgumentSignatures;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> methodArgumentArraySize;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¾“å‡ºå€¼</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodMatchOutput</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç›®æ ‡æ–¹æ³•å®ä¾‹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Method targetMethod;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç›®æ ‡å®ç°ç±» - è¿™ä¸ªæœ‰å¯èƒ½æ˜¯è¢«Cglibå¢å¼ºè¿‡çš„ç±»å‹,æ˜¯å®¿ä¸»ç±»çš„å­ç±»,å¦‚æœæ²¡æœ‰è¢«Cglibå¢å¼ºè¿‡,é‚£ä¹ˆå®ƒå°±æ˜¯å®¿ä¸»ç±»</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Class&lt;?&gt; targetClass;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å®¿ä¸»ç±»</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Class&lt;?&gt; targetUserClass;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å®¿ä¸»ç±»Beanå®ä¾‹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Object target;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ–¹æ³•å‚æ•°ç±»å‹åˆ—è¡¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Class&lt;?&gt;&gt; parameterTypes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç›®æ ‡æ–¹æ³•åŒ¹é…çš„é€»è¾‘å¤§è‡´å¦‚ä¸‹ï¼š</p><ol><li>æ–¹æ³•åç§°å’Œæ–¹æ³•å®ä¾‹çš„å®¿ä¸»ç±»å‹ä¸€å®šä½œä¸ºåŒ¹é…æ¡ä»¶çš„ä¸€éƒ¨åˆ†ã€‚</li><li>å¦‚æœä¼ å…¥äº†å‚æ•°ç­¾ååˆ—è¡¨ï¼Œä¼˜å…ˆä½¿ç”¨å‚æ•°ç­¾ååˆ—è¡¨ç±»å‹è¿›è¡ŒåŒ¹é…ã€‚</li><li>å¦‚æœæ²¡æœ‰ä¼ å…¥å‚æ•°ç­¾ååˆ—è¡¨ï¼Œé‚£ä¹ˆä½¿ç”¨å‚æ•°çš„æ•°é‡è¿›è¡ŒåŒ¹é…ã€‚</li><li>å¦‚æœå‚æ•°ç­¾ååˆ—è¡¨å’Œå‚æ•°åˆ—è¡¨éƒ½æ²¡æœ‰ä¼ å…¥ï¼Œé‚£ä¹ˆåªèƒ½é€šè¿‡æ–¹æ³•åç§°å’Œæ–¹æ³•å®ä¾‹çš„å®¿ä¸»ç±»å‹åŒ¹é…ã€‚</li><li>è€ƒè™‘åˆ°æ–¹æ³•åŒ¹é…è§£æçš„è¿‡ç¨‹ç›¸å¯¹è€—æ—¶ï¼Œéœ€è¦æŠŠç»“æœç¼“å­˜èµ·æ¥ã€‚</li></ol><p>åˆ†æè‡³æ­¤ï¼Œå¯ä»¥åŸºäºåå°„ï¼Œç¼–å†™ä¸€ä¸ªæŠ½è±¡çš„æ–¹æ³•åŒ¹é…å™¨<code>BaseMethodMatcher</code>ï¼Œç„¶åæŠŠè·å–å®¿ä¸»ç±»ä¿¡æ¯çš„åŠŸèƒ½å§”æ‰˜åˆ°å­ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodMatchException</span> <span class="keyword">extends</span> <span class="title">RuntimeException</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MethodMatchException</span><span class="params">(String message)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(message);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MethodMatchException</span><span class="params">(String message, Throwable cause)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(message, cause);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MethodMatchException</span><span class="params">(Throwable cause)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(cause);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HostClassMethodInfo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Class&lt;?&gt; hostClass;</span><br><span class="line">    <span class="keyword">private</span> Class&lt;?&gt; hostUserClass;</span><br><span class="line">    <span class="keyword">private</span> Object hostTarget;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseMethodMatcher</span> <span class="keyword">implements</span> <span class="title">MethodMatcher</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> ConcurrentMap&lt;MethodMatchInput, MethodMatchOutput&gt; cache = Maps.newConcurrentMap();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> MethodMatchOutput <span class="title">selectOneBestMatchMethod</span><span class="params">(MethodMatchInput input)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> cache.computeIfAbsent(input, in -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                MethodMatchOutput output = <span class="keyword">new</span> MethodMatchOutput();</span><br><span class="line">                Class&lt;?&gt; interfaceClass = Class.forName(in.getInterfaceName());</span><br><span class="line">                <span class="comment">// è·å–å®¿ä¸»ç±»ä¿¡æ¯</span></span><br><span class="line">                HostClassMethodInfo info = findHostClassMethodInfo(interfaceClass);</span><br><span class="line">                List&lt;Method&gt; targetMethods = Lists.newArrayList();</span><br><span class="line">                ReflectionUtils.doWithMethods(info.getHostUserClass(), targetMethods::add, method -&gt; &#123;</span><br><span class="line">                    String methodName = method.getName();</span><br><span class="line">                    Class&lt;?&gt; declaringClass = method.getDeclaringClass();</span><br><span class="line">                    List&lt;Class&lt;?&gt;&gt; inputParameterTypes = Optional.ofNullable(in.getMethodArgumentSignatures())</span><br><span class="line">                            .map(mas -&gt; &#123;</span><br><span class="line">                                List&lt;Class&lt;?&gt;&gt; list = Lists.newArrayList();</span><br><span class="line">                                mas.forEach(ma -&gt; list.add(ClassUtils.resolveClassName(ma, <span class="keyword">null</span>)));</span><br><span class="line">                                <span class="keyword">return</span> list;</span><br><span class="line">                            &#125;).orElse(Lists.newArrayList());</span><br><span class="line">                    output.setParameterTypes(inputParameterTypes);</span><br><span class="line">                    <span class="comment">// å¦‚æœä¼ å…¥äº†å‚æ•°ç­¾ååˆ—è¡¨ï¼Œä¼˜å…ˆä½¿ç”¨å‚æ•°ç­¾ååˆ—è¡¨ç±»å‹è¿›è¡ŒåŒ¹é…</span></span><br><span class="line">                    <span class="keyword">if</span> (!inputParameterTypes.isEmpty()) &#123;</span><br><span class="line">                        List&lt;Class&lt;?&gt;&gt; parameterTypes = Lists.newArrayList(method.getParameterTypes());</span><br><span class="line">                        <span class="keyword">return</span> Objects.equals(methodName, in.getMethodName()) &amp;&amp;</span><br><span class="line">                                Objects.equals(info.getHostUserClass(), declaringClass) &amp;&amp;</span><br><span class="line">                                Objects.equals(parameterTypes, inputParameterTypes);</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// å¦‚æœæ²¡æœ‰ä¼ å…¥å‚æ•°ç­¾ååˆ—è¡¨ï¼Œé‚£ä¹ˆä½¿ç”¨å‚æ•°çš„æ•°é‡è¿›è¡ŒåŒ¹é…</span></span><br><span class="line">                    <span class="keyword">if</span> (in.getMethodArgumentArraySize() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                        List&lt;Class&lt;?&gt;&gt; parameterTypes = Lists.newArrayList(method.getParameterTypes());</span><br><span class="line">                        <span class="keyword">return</span> Objects.equals(methodName, in.getMethodName()) &amp;&amp;</span><br><span class="line">                                Objects.equals(info.getHostUserClass(), declaringClass) &amp;&amp;</span><br><span class="line">                                in.getMethodArgumentArraySize() == parameterTypes.size();</span><br><span class="line"></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="comment">// å¦‚æœå‚æ•°ç­¾ååˆ—è¡¨å’Œå‚æ•°åˆ—è¡¨éƒ½æ²¡æœ‰ä¼ å…¥ï¼Œé‚£ä¹ˆåªèƒ½é€šè¿‡æ–¹æ³•åç§°å’Œæ–¹æ³•å®ä¾‹çš„å®¿ä¸»ç±»å‹åŒ¹é…</span></span><br><span class="line">                    <span class="keyword">return</span> Objects.equals(methodName, in.getMethodName()) &amp;&amp;</span><br><span class="line">                            Objects.equals(info.getHostUserClass(), declaringClass);</span><br><span class="line"></span><br><span class="line">                &#125;);</span><br><span class="line">                <span class="keyword">if</span> (targetMethods.size() != <span class="number">1</span>) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> MethodMatchException(String.format(<span class="string">"æŸ¥æ‰¾åˆ°ç›®æ ‡æ–¹æ³•æ•°é‡ä¸ç­‰äº1,interface:%s,method:%s"</span>,</span><br><span class="line">                            in.getInterfaceName(), in.getMethodName()));</span><br><span class="line">                &#125;</span><br><span class="line">                Method targetMethod = targetMethods.get(<span class="number">0</span>);</span><br><span class="line">                output.setTargetClass(info.getHostClass());</span><br><span class="line">                output.setTargetMethod(targetMethod);</span><br><span class="line">                output.setTargetUserClass(info.getHostUserClass());</span><br><span class="line">                output.setTarget(info.getHostTarget());</span><br><span class="line">                <span class="keyword">return</span> output;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">                log.error(<span class="string">"æŸ¥æ‰¾åŒ¹é…åº¦æœ€é«˜çš„æ–¹æ³•å¤±è´¥,è¾“å…¥å‚æ•°:&#123;&#125;"</span>, JSON.toJSONString(in), e);</span><br><span class="line">                <span class="keyword">if</span> (e <span class="keyword">instanceof</span> MethodMatchException) &#123;</span><br><span class="line">                    <span class="keyword">throw</span> (MethodMatchException) e;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> MethodMatchException(e);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è·å–å®¿ä¸»ç±»çš„ä¿¡æ¯</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> interfaceClass interfaceClass</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> HostClassMethodInfo</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">abstract</span> HostClassMethodInfo <span class="title">findHostClassMethodInfo</span><span class="params">(Class&lt;?&gt; interfaceClass)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ç€ï¼Œé€šè¿‡æ¥å£ç±»å‹è·å–å®¿ä¸»ç±»çš„åŠŸèƒ½å°±å§”æ‰˜ç»™<code>Spring</code>å®ç°ï¼Œä»<code>IOC</code>å®¹å™¨ä¸­è·å–ï¼Œå®šä¹‰<code>SpringMethodMatcher</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringMethodMatcher</span> <span class="keyword">extends</span> <span class="title">BaseMethodMatcher</span> <span class="keyword">implements</span> <span class="title">BeanFactoryAware</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> DefaultListableBeanFactory beanFactory;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setBeanFactory</span><span class="params">(@NonNull BeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.beanFactory = (DefaultListableBeanFactory) beanFactory;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function">HostClassMethodInfo <span class="title">findHostClassMethodInfo</span><span class="params">(Class&lt;?&gt; interfaceClass)</span> </span>&#123;</span><br><span class="line">        HostClassMethodInfo info = <span class="keyword">new</span> HostClassMethodInfo();</span><br><span class="line">        <span class="comment">// ä»å®¹å™¨ä¸­é€šè¿‡æ¥å£ç±»å‹è·å–å¯¹åº”çš„å®ç°,å®ç°å¿…é¡»åªæœ‰ä¸€ä¸ª</span></span><br><span class="line">        Object bean = beanFactory.getBean(interfaceClass);</span><br><span class="line">        info.setHostTarget(bean);</span><br><span class="line">        info.setHostClass(bean.getClass());</span><br><span class="line">        info.setHostUserClass(ClassUtils.getUserClass(bean.getClass()));</span><br><span class="line">        <span class="keyword">return</span> info;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œç›®æ ‡æ–¹æ³•åŒ¹é…çš„æ¨¡å—å·²ç»ç¼–å†™å®Œæ¯•ï¼Œæ¥ä¸‹æ¥éœ€è¦å¤„ç†æ–¹æ³•å‚æ•°åˆ—è¡¨çš„ååºåˆ—åŒ–ã€‚ç¼–å†™åè®®çš„æ—¶å€™ï¼Œç¬”è€…æŠŠæ–¹æ³•å‚æ•°åˆ—è¡¨<code>methodArguments</code>å­˜æ”¾åœ¨<code>Object</code>æ•°ç»„ä¸­ï¼Œä¼ è¾“çš„æ—¶å€™åºåˆ—åŒ–ä¸º<code>byte</code>æ•°ç»„ï¼Œç»è¿‡åè®®è§£æä¹‹åï¼Œæ–¹æ³•å‚æ•°åˆ—è¡¨çš„å®é™…ç±»å‹ä¸º<code>ByteBuf</code>æ•°ç»„ï¼ˆè¿™æ˜¯å› ä¸º<code>Netty</code>ä¸­çš„å­—èŠ‚å®¹å™¨å°±æ˜¯<code>ByteBuf</code>ï¼‰ï¼Œé‚£ä¹ˆéœ€è¦è€ƒè™‘æŠŠ<code>ByteBuf</code>æ•°ç»„è½¬æ¢ä¸ºç›®æ ‡æ–¹æ³•çš„å‚æ•°ç±»å‹å®ä¾‹ã€‚ä¸»è¦æ­¥éª¤å¦‚ä¸‹ï¼š</p><ol><li>å¦‚æœæ–¹æ³•å‚æ•°åˆ—è¡¨ä¸ºç©ºï¼Œé‚£ä¹ˆä»€ä¹ˆéƒ½ä¸ç”¨åšï¼Œä¹Ÿå°±æ˜¯è°ƒç”¨äº†æ— å‚æ•°çš„æ–¹æ³•ã€‚</li><li>å¦‚æœæ–¹æ³•å‚æ•°åˆ—è¡¨ä¸ä¸ºç©ºåŒæ—¶æ–¹æ³•å‚æ•°ç±»å‹åˆ—è¡¨ä¸ä¸ºç©ºï¼Œä¼˜å…ˆé€‰ç”¨æ–¹æ³•å‚æ•°ç±»å‹åˆ—è¡¨è¿›è¡Œè½¬æ¢ã€‚</li><li>å¦‚æœæ–¹æ³•å‚æ•°åˆ—è¡¨ä¸ä¸ºç©ºåŒæ—¶æ–¹æ³•å‚æ•°ç±»å‹åˆ—è¡¨ä¸ºç©ºï¼Œåˆ™ä½¿ç”¨<code>Method#getParameterTypes()</code>å¾—åˆ°çš„æ–¹æ³•å‚æ•°åˆ—è¡¨ç±»å‹è¿›è¡Œè½¬æ¢ã€‚</li></ol><p>å®šä¹‰ä¸€ä¸ªæ–¹æ³•å‚æ•°è½¬æ¢å™¨æ¥å£<code>MethodArgumentConverter</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MethodArgumentConverter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">ArgumentConvertOutput <span class="title">convert</span><span class="params">(ArgumentConvertInput input)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArgumentConvertInput</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç›®æ ‡æ–¹æ³•</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Method method;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ–¹æ³•å‚æ•°ç±»å‹åˆ—è¡¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Class&lt;?&gt;&gt; parameterTypes;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ–¹æ³•å‚æ•°åˆ—è¡¨</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Object&gt; arguments;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ArgumentConvertOutput</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Object[] arguments;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ–¹æ³•å‚æ•°è½¬æ¢å™¨çš„é»˜è®¤å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultMethodArgumentConverter</span> <span class="keyword">implements</span> <span class="title">MethodArgumentConverter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Serializer serializer = FastJsonSerializer.X;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ArgumentConvertOutput <span class="title">convert</span><span class="params">(ArgumentConvertInput input)</span> </span>&#123;</span><br><span class="line">        ArgumentConvertOutput output = <span class="keyword">new</span> ArgumentConvertOutput();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> == input.getArguments() || input.getArguments().isEmpty()) &#123;</span><br><span class="line">                output.setArguments(<span class="keyword">new</span> Object[<span class="number">0</span>]);</span><br><span class="line">                <span class="keyword">return</span> output;</span><br><span class="line">            &#125;</span><br><span class="line">            List&lt;Class&lt;?&gt;&gt; inputParameterTypes = input.getParameterTypes();</span><br><span class="line">            <span class="keyword">int</span> size = inputParameterTypes.size();</span><br><span class="line">            <span class="keyword">if</span> (size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                Object[] arguments = <span class="keyword">new</span> Object[size];</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">                    ByteBuf byteBuf = (ByteBuf) input.getArguments().get(i);</span><br><span class="line">                    <span class="keyword">int</span> readableBytes = byteBuf.readableBytes();</span><br><span class="line">                    <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[readableBytes];</span><br><span class="line">                    byteBuf.readBytes(bytes);</span><br><span class="line">                    arguments[i] = serializer.decode(bytes, inputParameterTypes.get(i));</span><br><span class="line">                    byteBuf.release();</span><br><span class="line">                &#125;</span><br><span class="line">                output.setArguments(arguments);</span><br><span class="line">                <span class="keyword">return</span> output;</span><br><span class="line">            &#125;</span><br><span class="line">            Class&lt;?&gt;[] parameterTypes = input.getMethod().getParameterTypes();</span><br><span class="line">            <span class="keyword">int</span> len = parameterTypes.length;</span><br><span class="line">            Object[] arguments = <span class="keyword">new</span> Object[len];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">                ByteBuf byteBuf = (ByteBuf) input.getArguments().get(i);</span><br><span class="line">                <span class="keyword">int</span> readableBytes = byteBuf.readableBytes();</span><br><span class="line">                <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[readableBytes];</span><br><span class="line">                byteBuf.readBytes(bytes);</span><br><span class="line">                arguments[i] = serializer.decode(bytes, parameterTypes[i]);</span><br><span class="line">                byteBuf.release();</span><br><span class="line">            &#125;</span><br><span class="line">            output.setArguments(arguments);</span><br><span class="line">            <span class="keyword">return</span> output;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> ArgumentConvertException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰€æœ‰å‰ç½®å·¥ä½œéƒ½å®Œæˆäº†ï¼Œç°åœ¨ç¼–å†™ä¸€ä¸ª<code>Server</code>ç«¯çš„å…¥ç«™å¤„ç†å™¨<code>ServerHandler</code>ï¼Œæš‚æ—¶ä¸åšä»£ç é€»è¾‘ä¼˜åŒ–ï¼Œåªåšå®ç°ï¼ŒæŠŠåå°„è°ƒç”¨çš„æ¨¡å—ç›´æ¥åœ¨æ­¤ç±»ä¸­ç¼–å†™ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerHandler</span> <span class="keyword">extends</span> <span class="title">SimpleChannelInboundHandler</span>&lt;<span class="title">RequestMessagePacket</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MethodMatcher methodMatcher;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MethodArgumentConverter methodArgumentConverter;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">channelRead0</span><span class="params">(ChannelHandlerContext ctx, RequestMessagePacket packet)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        log.info(<span class="string">"æœåŠ¡ç«¯æ¥æ”¶åˆ°:&#123;&#125;"</span>, packet);</span><br><span class="line">        MethodMatchInput input = <span class="keyword">new</span> MethodMatchInput();</span><br><span class="line">        input.setInterfaceName(packet.getInterfaceName());</span><br><span class="line">        input.setMethodArgumentSignatures(Optional.ofNullable(packet.getMethodArgumentSignatures())</span><br><span class="line">                .map(Lists::newArrayList).orElse(Lists.newArrayList()));</span><br><span class="line">        input.setMethodName(packet.getMethodName());</span><br><span class="line">        Object[] methodArguments = packet.getMethodArguments();</span><br><span class="line">        input.setMethodArgumentArraySize(<span class="keyword">null</span> != methodArguments ? methodArguments.length : <span class="number">0</span>);</span><br><span class="line">        MethodMatchOutput output = methodMatcher.selectOneBestMatchMethod(input);</span><br><span class="line">        log.info(<span class="string">"æŸ¥æ‰¾ç›®æ ‡å®ç°æ–¹æ³•æˆåŠŸ,ç›®æ ‡ç±»:&#123;&#125;,å®¿ä¸»ç±»:&#123;&#125;,å®¿ä¸»æ–¹æ³•:&#123;&#125;"</span>,</span><br><span class="line">                output.getTargetClass().getCanonicalName(),</span><br><span class="line">                output.getTargetUserClass().getCanonicalName(),</span><br><span class="line">                output.getTargetMethod().getName()</span><br><span class="line">        );</span><br><span class="line">        Method targetMethod = output.getTargetMethod();</span><br><span class="line">        ArgumentConvertInput convertInput = <span class="keyword">new</span> ArgumentConvertInput();</span><br><span class="line">        convertInput.setArguments(input.getMethodArgumentArraySize() &gt; <span class="number">0</span> ? Lists.newArrayList(methodArguments) : Lists.newArrayList());</span><br><span class="line">        convertInput.setMethod(output.getTargetMethod());</span><br><span class="line">        convertInput.setParameterTypes(output.getParameterTypes());</span><br><span class="line">        ArgumentConvertOutput convertOutput = methodArgumentConverter.convert(convertInput);</span><br><span class="line">        ReflectionUtils.makeAccessible(targetMethod);</span><br><span class="line">        <span class="comment">// åå°„è°ƒç”¨</span></span><br><span class="line">        Object result = targetMethod.invoke(output.getTarget(), convertOutput.getArguments());</span><br><span class="line">        ResponseMessagePacket response = <span class="keyword">new</span> ResponseMessagePacket();</span><br><span class="line">        response.setMagicNumber(packet.getMagicNumber());</span><br><span class="line">        response.setVersion(packet.getVersion());</span><br><span class="line">        response.setSerialNumber(packet.getSerialNumber());</span><br><span class="line">        response.setAttachments(packet.getAttachments());</span><br><span class="line">        response.setMessageType(MessageType.RESPONSE);</span><br><span class="line">        response.setErrorCode(<span class="number">200L</span>);</span><br><span class="line">        response.setMessage(<span class="string">"Success"</span>);</span><br><span class="line">        response.setPayload(JSON.toJSONString(result));</span><br><span class="line">        log.info(<span class="string">"æœåŠ¡ç«¯è¾“å‡º:&#123;&#125;"</span>, JSON.toJSONString(response));</span><br><span class="line">        ctx.writeAndFlush(response);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¼–å†™ä¸€ä¸ª<code>Server</code>çš„å¯åŠ¨ç±»<code>ServerApplication</code>ï¼Œåœ¨<code>Spring</code>å®¹å™¨å¯åŠ¨ä¹‹åï¼Œå¯åŠ¨<code>Netty</code>æœåŠ¡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span>(scanBasePackages = <span class="string">"club.throwable.server"</span>)</span><br><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerApplication</span> <span class="keyword">implements</span> <span class="title">CommandLineRunner</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;netty.port:9092&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> Integer nettyPort;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ServerHandler serverHandler;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        SpringApplication.run(ServerApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(String... args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> port = nettyPort;</span><br><span class="line">        ServerBootstrap bootstrap = <span class="keyword">new</span> ServerBootstrap();</span><br><span class="line">        EventLoopGroup bossGroup = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">        EventLoopGroup workerGroup = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            bootstrap.group(bossGroup, workerGroup)</span><br><span class="line">                    .channel(NioServerSocketChannel<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">                    .<span class="title">childHandler</span>(<span class="title">new</span> <span class="title">ChannelInitializer</span>&lt;<span class="title">SocketChannel</span>&gt;() </span>&#123;</span><br><span class="line"></span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                            ch.pipeline().addLast(<span class="keyword">new</span> LengthFieldBasedFrameDecoder(<span class="number">1024</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">0</span>, <span class="number">4</span>));</span><br><span class="line">                            ch.pipeline().addLast(<span class="keyword">new</span> LengthFieldPrepender(<span class="number">4</span>));</span><br><span class="line">                            ch.pipeline().addLast(<span class="keyword">new</span> RequestMessagePacketDecoder());</span><br><span class="line">                            ch.pipeline().addLast(<span class="keyword">new</span> ResponseMessagePacketEncoder(FastJsonSerializer.X));</span><br><span class="line">                            ch.pipeline().addLast(serverHandler);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">            ChannelFuture future = bootstrap.bind(port).sync();</span><br><span class="line">            log.info(<span class="string">"å¯åŠ¨NettyServer[&#123;&#125;]æˆåŠŸ..."</span>, port);</span><br><span class="line">            future.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            workerGroup.shutdownGracefully();</span><br><span class="line">            bossGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åï¼Œç¼–å†™å¥‘çº¦åŒ…å’Œå¥‘çº¦å®ç°ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">- ch0-custom-rpc-protocol          é¡¹ç›®æ ¹ç›®å½•</span><br><span class="line">  - club.throwable</span><br><span class="line">    - utils                        å·¥å…·ç±»</span><br><span class="line">    - protocol                     åè®®</span><br><span class="line">    - exception                    å¼‚å¸¸</span><br><span class="line">    - contract                     å¥‘çº¦</span><br><span class="line">      - HelloService               å¥‘çº¦æ¥å£</span><br><span class="line">    - server                       æœåŠ¡ç«¯</span><br><span class="line">      - contract</span><br><span class="line">        - DefaultHelloService      å¥‘çº¦æ¥å£å®ç°</span><br></pre></td></tr></table></figure><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HelloService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">sayHello</span><span class="params">(String name)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å®ç°</span></span><br><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultHelloService</span> <span class="keyword">implements</span> <span class="title">HelloService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">"%s say hello!"</span>, name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆå¯åŠ¨æœåŠ¡ç«¯<code>ServerApplication</code>ï¼Œå†å¯åŠ¨ä¸Šä¸€èŠ‚æåˆ°çš„<code>TestProtocolClient</code>ï¼Œè¾“å‡ºç»“æœï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">// æœåŠ¡ç«¯æ—¥å¿—</span><br><span class="line">2020-01-15 00:05:57.898  INFO 14420 --- [           main] club.throwable.server.ServerApplication  : å¯åŠ¨NettyServer[9092]æˆåŠŸ...</span><br><span class="line">2020-01-15 00:06:05.980  INFO 14420 --- [ntLoopGroup-3-1] club.throwable.server.ServerHandler      : æœåŠ¡ç«¯æ¥æ”¶åˆ°:RequestMessagePacket(interfaceName=club.throwable.contract.HelloService, methodName=sayHello, methodArgumentSignatures=[java.lang.String], methodArguments=[PooledUnsafeDirectByteBuf(ridx: 0, widx: 6, cap: 6/139)])</span><br><span class="line">2020-01-15 00:06:07.448  INFO 14420 --- [ntLoopGroup-3-1] club.throwable.server.ServerHandler      : æŸ¥æ‰¾ç›®æ ‡å®ç°æ–¹æ³•æˆåŠŸ,ç›®æ ‡ç±»:club.throwable.server.contract.DefaultHelloService,å®¿ä¸»ç±»:club.throwable.server.contract.DefaultHelloService,å®¿ä¸»æ–¹æ³•:sayHello</span><br><span class="line">2020-01-15 00:06:07.521  INFO 14420 --- [ntLoopGroup-3-1] club.throwable.server.ServerHandler      : æœåŠ¡ç«¯è¾“å‡º:&#123;"attachments":&#123;&#125;,"errorCode":200,"magicNumber":10086,"message":"Success","messageType":"RESPONSE","payload":"\"doge say hello!\"","serialNumber":"65f01b8e89bb479b8a36a60bd6519617","version":1&#125;</span><br><span class="line"></span><br><span class="line">// å®¢æˆ·ç«¯æ—¥å¿—</span><br><span class="line">00:06:05.891 [main] INFO club.throwable.protocol.TestProtocolClient - å¯åŠ¨NettyClient[9092]æˆåŠŸ...</span><br><span class="line">...çœç•¥...</span><br><span class="line">00:06:13.197 [nioEventLoopGroup-2-1] INFO club.throwable.protocol.TestProtocolClient - æ¥æ”¶åˆ°æ¥è‡ªæœåŠ¡ç«¯çš„å“åº”æ¶ˆæ¯,æ¶ˆæ¯å†…å®¹:&#123;"attachments":&#123;&#125;,"errorCode":200,"magicNumber":10086,"message":"Success","messageType":"RESPONSE","payload":"\"doge say hello!\"","serialNumber":"65f01b8e89bb479b8a36a60bd6519617","version":1&#125;</span><br></pre></td></tr></table></figure><p>å¯è§<code>RPC</code>è°ƒç”¨æˆåŠŸã€‚</p><h2 id="å°ç»“">å°ç»“</h2><p>ç¼–å†™<code>RPC</code>çš„<code>Server</code>ç«¯æŠ€å·§åœ¨äºå¤„ç†ç›®æ ‡æ–¹æ³•å’Œå®¿ä¸»ç±»çš„æŸ¥æ‰¾ï¼Œåœ¨è½¬æ¢æ–¹æ³•å‚æ•°çš„æ—¶å€™ï¼Œéœ€è¦è€ƒè™‘ç®€åŒ–å¤„ç†å’Œæé«˜æ•ˆç‡ï¼Œå‰©ä¸‹çš„å°±æ˜¯åšå¥½å¼‚å¸¸å¤„ç†å’Œæ¨¡å—å°è£…ã€‚é™äºç¯‡å¹…ï¼Œåé¢ä¼šå…ˆåˆ†æ<code>Client</code>ç«¯çš„å¤„ç†ï¼Œå†åˆ†æå¿ƒè·³å¤„ç†ã€æœåŠ¡ç«¯ä¼˜åŒ–ã€ç”šè‡³æ˜¯å¯¹æ¥æ³¨å†Œä¸­å¿ƒç­‰ç­‰ï¼Œåœ¨<code>Netty</code>ã€<code>SpringBoot</code>ç­‰ä¼˜ç§€æ¡†æ¶çš„åŠ æŒä¸‹ç¼–å†™ä¸€ä¸ª<code>RPC</code>æ¡†æ¶å…¶å®å¹¶ä¸å›°éš¾ï¼Œå›°éš¾çš„æ˜¯æ€§èƒ½ä¼˜åŒ–å’Œç”Ÿæ€åœˆçš„æ”¯æŒã€‚</p><p><code>Demo</code>é¡¹ç›®åœ°å€ï¼š</p><ul><li><a href="https://github.com/zjcscut/netty-tutorials/tree/master/ch0-custom-rpc-protocol" target="_blank" rel="noopener">ch0-custom-rpc-protocol</a></li></ul><p>ï¼ˆæœ¬æ–‡å®Œ c-1-d e-a-20200115ï¼‰</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰æ&quot;&gt;å‰æ&lt;/h2&gt;
&lt;p&gt;å‰ç½®æ–‡ç« ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;Github Page&lt;/code&gt;ï¼š&lt;a href=&quot;http://throwable.club/2020/01/12/netty-custom-rpc-framework-protocol&quot;&gt;ã€ŠåŸºäºNettyå’ŒSpringBootå®ç°ä¸€ä¸ªè½»é‡çº§RPCæ¡†æ¶-åè®®ç¯‡ã€‹&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;Coding Page&lt;/code&gt;ï¼š&lt;a href=&quot;http://throwable.coding.me/2020/01/12/netty-custom-rpc-framework-protocol&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;ã€ŠåŸºäºNettyå’ŒSpringBootå®ç°ä¸€ä¸ªè½»é‡çº§RPCæ¡†æ¶-åè®®ç¯‡ã€‹&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;åœ¨å‰ç½®çš„ã€ŠåŸºäºNettyå’ŒSpringBootå®ç°ä¸€ä¸ªè½»é‡çº§RPCæ¡†æ¶-åè®®ç¯‡ã€‹ä¸€æ–‡ä¸­å·²ç»å®šä¹‰äº†ä¸€ä¸ªç›¸å¯¹ç®€å•çš„&lt;code&gt;RPC&lt;/code&gt;ç§æœ‰åè®®ï¼Œå¹¶ä¸”å®ç°äº†å¯¹åº”çš„ç¼–ç å’Œè§£ç æ¨¡å—ã€‚è¿™ç¯‡æ–‡ç« åŸºäºåè®®ç¯‡ï¼Œå®Œæˆ&lt;code&gt;Server&lt;/code&gt;ç«¯ä»£ç è°ƒç”¨çš„ç¼–å†™ã€‚è€ƒè™‘åˆ°ç›®å‰ç›¸å¯¹ä¸»æµçš„&lt;code&gt;IOC&lt;/code&gt;å®¹å™¨æ˜¯&lt;code&gt;Spring&lt;/code&gt;ï¼Œè¿™é‡Œé€‰ç”¨äº†&lt;code&gt;spring-boot-starter&lt;/code&gt;ï¼ˆé&lt;code&gt;MVC&lt;/code&gt;å®¹å™¨ï¼Œåªæ˜¯å•çº¯ç®¡ç†&lt;code&gt;Bean&lt;/code&gt;ï¼‰ï¼Œä¾èµ–&lt;code&gt;JDK1.8+&lt;/code&gt;ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Netty" scheme="http://throwable.club/blog/categories/Netty/"/>
    
      <category term="Java" scheme="http://throwable.club/blog/categories/Netty/Java/"/>
    
    
      <category term="Java" scheme="http://throwable.club/blog/tags/Java/"/>
    
      <category term="Netty" scheme="http://throwable.club/blog/tags/Netty/"/>
    
  </entry>
  
  <entry>
    <title>åŸºäºNettyå’ŒSpringBootå®ç°ä¸€ä¸ªè½»é‡çº§RPCæ¡†æ¶-åè®®ç¯‡</title>
    <link href="http://throwable.club/2020/01/12/netty-custom-rpc-framework-protocol/"/>
    <id>http://throwable.club/2020/01/12/netty-custom-rpc-framework-protocol/</id>
    <published>2020-01-12T14:47:21.000Z</published>
    <updated>2020-01-15T13:25:44.253Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰æ">å‰æ</h2><p>æœ€è¿‘å¯¹ç½‘ç»œç¼–ç¨‹æ–¹é¢æ¯”è¾ƒæœ‰å…´è¶£ï¼Œåœ¨å¾®æœåŠ¡å®è·µä¸Šä¹Ÿç”¨åˆ°äº†ç›¸å¯¹ä¸»æµçš„<code>RPC</code>æ¡†æ¶å¦‚<code>Spring Cloud Gateway</code>åº•å±‚ä¹Ÿåˆ‡æ¢ä¸º<code>Reactor-Netty</code>ï¼Œåƒ<code>Redisson</code>åº•å±‚ä¹Ÿæ˜¯ä½¿ç”¨<code>Netty</code>å°è£…é€šè®¯åè®®ï¼Œæœ€è¿‘è°ƒç ”å’Œå‡†å¤‡ä½¿ç”¨çš„<code>SOFARpc</code>ä¹Ÿæ˜¯åŸºäº<code>Netty</code>å°è£…å®ç°äº†å¤šç§åè®®çš„å…¼å®¹ã€‚å› æ­¤ï¼ŒåŸºäº<code>Netty</code>é€ ä¸€ä¸ªè½®å­ï¼Œåœ¨<code>SpringBoot</code>çš„åŠ æŒä¸‹ï¼Œå®ç°ä¸€ä¸ªè½»é‡çº§çš„<code>RPC</code>æ¡†æ¶ã€‚è¿™ç¯‡åšæ–‡ä»‹ç»çš„æ˜¯<code>RPC</code>æ¡†æ¶åè®®çš„å®šä¹‰ä»¥åŠå¯¹åº”çš„ç¼–ç è§£ç å¤„ç†çš„å®ç°ã€‚</p><a id="more"></a><h2 id="ä¾èµ–å¼•å…¥">ä¾èµ–å¼•å…¥</h2><p>æˆªæ­¢æœ¬æ–‡ï¼ˆ<code>2020-01-12</code>ï¼‰ç¼–å†™å®Œæˆä¹‹æ—¶ï¼Œ<code>Netty</code>çš„æœ€æ–°ç‰ˆæœ¬ä¸º<code>4.1.44.Final</code>ï¼Œè€Œ<code>SpringBoot</code>çš„æœ€æ–°ç‰ˆæœ¬ä¸º<code>2.2.2.RELEASE</code>ï¼Œå› æ­¤å¼•å…¥è¿™ä¸¤ä¸ªç‰ˆæœ¬çš„ä¾èµ–ï¼ŒåŠ ä¸Šå…¶ä»–å·¥å…·åŒ…å’Œåºåˆ—åŒ–ç­‰ç­‰çš„æ”¯æŒï¼Œ<code>pom</code>æ–‡ä»¶çš„æ ¸å¿ƒå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.netty<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>netty-all<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;netty.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.18.10<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.61<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.google.guava<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>guava<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>28.1-jre<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p>éƒ¨åˆ†å‚æ•°çš„åºåˆ—åŒ–ä¼šä¾èµ–åˆ°<code>FastJson</code>æˆ–è€…<code>Jackson</code>ï¼Œå…·ä½“çœ‹åå¥½è€Œå®šã€‚</p><h2 id="è‡ªå®šä¹‰åè®®çš„å®šä¹‰">è‡ªå®šä¹‰åè®®çš„å®šä¹‰</h2><p>ä¸ºäº†æé«˜åè®®ä¼ è¾“çš„æ•ˆç‡ï¼Œéœ€è¦å®šåˆ¶ä¸€å¥—é«˜æ•ˆçš„<code>RPC</code>åè®®ï¼Œè®¾è®¡åè®®æ‰€éœ€çš„å­—æ®µå’Œç±»å‹ã€‚</p><p><strong>åŸºç¡€Packetå­—æ®µ</strong>ï¼š</p><table><thead><tr><th style="text-align:center">å­—æ®µå</th><th style="text-align:center">å­—æ®µç±»å‹</th><th style="text-align:center">å­—èŠ‚æ•°(byte)</th><th style="text-align:center">å­—æ®µåŠŸèƒ½</th><th style="text-align:center">å¤‡æ³¨</th></tr></thead><tbody><tr><td style="text-align:center"><code>magicNumber</code></td><td style="text-align:center"><code>int</code></td><td style="text-align:center">2</td><td style="text-align:center">é­”æ•°ï¼Œç±»ä¼¼äº<code>Java</code>çš„å­—èŠ‚ç æ–‡ä»¶çš„é­”æ•°æ˜¯<code>0xcafebase</code></td><td style="text-align:center"></td></tr><tr><td style="text-align:center"><code>version</code></td><td style="text-align:center"><code>int</code></td><td style="text-align:center">2</td><td style="text-align:center">ç‰ˆæœ¬å·</td><td style="text-align:center">é¢„ç•™å­—æ®µï¼Œé»˜è®¤ä¸º1</td></tr><tr><td style="text-align:center"><code>serialNumber</code></td><td style="text-align:center"><code>java.lang.String</code></td><td style="text-align:center">4</td><td style="text-align:center">è¯·æ±‚æµæ°´å·</td><td style="text-align:center">ååˆ†é‡è¦ï¼Œæ¯ä¸ªè¯·æ±‚çš„å”¯ä¸€æ ‡è¯†</td></tr><tr><td style="text-align:center"><code>messageType</code></td><td style="text-align:center"><code>MessageType</code></td><td style="text-align:center">1</td><td style="text-align:center">æ¶ˆæ¯ç±»å‹</td><td style="text-align:center">è‡ªå®šä¹‰çš„æšä¸¾ç±»å‹ï¼Œè§ä¸‹é¢çš„<code>MessageType</code>ç±»</td></tr><tr><td style="text-align:center"><code>attachments</code></td><td style="text-align:center"><code>Map&lt;String, String&gt;</code></td><td style="text-align:center">è§†å®é™…æƒ…å†µè€Œå®š</td><td style="text-align:center">é™„ä»¶</td><td style="text-align:center"><code>K-V</code>å½¢å¼ï¼Œç±»ä¼¼äº<code>HTTP</code>åè®®ä¸­çš„<code>Header</code></td></tr></tbody></table><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ¶ˆæ¯æšä¸¾ç±»å‹</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> MessageType &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * è¯·æ±‚</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    REQUEST((<span class="keyword">byte</span>) <span class="number">1</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å“åº”</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    RESPONSE((<span class="keyword">byte</span>) <span class="number">2</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * PING</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    PING((<span class="keyword">byte</span>) <span class="number">3</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * PONG</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    PONG((<span class="keyword">byte</span>) <span class="number">4</span>),</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * NULL</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    NULL((<span class="keyword">byte</span>) <span class="number">5</span>),</span><br><span class="line"></span><br><span class="line">    ;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Getter</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Byte type;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> MessageType <span class="title">fromValue</span><span class="params">(<span class="keyword">byte</span> value)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (MessageType type : MessageType.values()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (type.getType() == value) &#123;</span><br><span class="line">                <span class="keyword">return</span> type;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(String.format(<span class="string">"value = %s"</span>, value));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// åŸºç¡€Packet</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseMessagePacket</span> <span class="keyword">implements</span> <span class="title">Serializable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é­”æ•°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> magicNumber;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * ç‰ˆæœ¬å·</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> version;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æµæ°´å·</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String serialNumber;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ¶ˆæ¯ç±»å‹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> MessageType messageType;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * é™„ä»¶ - K-Vå½¢å¼</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, String&gt; attachments = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ·»åŠ é™„ä»¶</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addAttachment</span><span class="params">(String key, String value)</span> </span>&#123;</span><br><span class="line">        attachments.put(key, value);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è¯·æ±‚Packetæ‰©å±•å­—æ®µ</strong>ï¼š</p><table><thead><tr><th style="text-align:center">å­—æ®µå</th><th style="text-align:center">å­—æ®µç±»å‹</th><th style="text-align:center">å­—èŠ‚æ•°(byte)</th><th style="text-align:center">å­—æ®µåŠŸèƒ½</th><th style="text-align:center">å¤‡æ³¨</th></tr></thead><tbody><tr><td style="text-align:center"><code>interfaceName</code></td><td style="text-align:center"><code>java.lang.String</code></td><td style="text-align:center">è§†å®é™…æƒ…å†µè€Œå®š</td><td style="text-align:center">æ¥å£å…¨ç±»å</td><td style="text-align:center"></td></tr><tr><td style="text-align:center"><code>methodName</code></td><td style="text-align:center"><code>java.lang.String</code></td><td style="text-align:center">è§†å®é™…æƒ…å†µè€Œå®š</td><td style="text-align:center">æ–¹æ³•å</td><td style="text-align:center"></td></tr><tr><td style="text-align:center"><code>methodArgumentSignatures</code></td><td style="text-align:center"><code>java.lang.String[]</code></td><td style="text-align:center">è§†å®é™…æƒ…å†µè€Œå®š</td><td style="text-align:center">æ–¹æ³•å‚æ•°ç­¾åå­—ç¬¦ä¸²æ•°ç»„</td><td style="text-align:center">å­˜æ”¾æ–¹æ³•å‚æ•°ç±»å‹å…¨ç±»åå­—ç¬¦ä¸²æ•°ç»„</td></tr><tr><td style="text-align:center"><code>methodArguments</code></td><td style="text-align:center"><code>java.lang.Object[]</code></td><td style="text-align:center">è§†å®é™…æƒ…å†µè€Œå®š</td><td style="text-align:center">æ–¹æ³•å‚æ•°æ•°ç»„</td><td style="text-align:center">å› ä¸ºæœªçŸ¥æ–¹æ³•å‚æ•°ç±»å‹ï¼Œæ‰€ä»¥ç”¨<code>Object</code>è¡¨ç¤º</td></tr></tbody></table><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EqualsAndHashCode</span>(callSuper = <span class="keyword">true</span>)</span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestMessagePacket</span> <span class="keyword">extends</span> <span class="title">BaseMessagePacket</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ¥å£å…¨ç±»å</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String interfaceName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ–¹æ³•å</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String methodName;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ–¹æ³•å‚æ•°ç­¾å</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String[] methodArgumentSignatures;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ–¹æ³•å‚æ•°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Object[] methodArguments;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>å“åº”Packetæ‰©å±•å­—æ®µ</strong>ï¼š</p><table><thead><tr><th style="text-align:center">å­—æ®µå</th><th style="text-align:center">å­—æ®µç±»å‹</th><th style="text-align:center">å­—èŠ‚æ•°(byte)</th><th style="text-align:center">å­—æ®µåŠŸèƒ½</th><th style="text-align:center">å¤‡æ³¨</th></tr></thead><tbody><tr><td style="text-align:center"><code>errorCode</code></td><td style="text-align:center"><code>java.lang.Long</code></td><td style="text-align:center">4</td><td style="text-align:center">å“åº”ç </td><td style="text-align:center"></td></tr><tr><td style="text-align:center"><code>message</code></td><td style="text-align:center"><code>java.lang.String</code></td><td style="text-align:center">è§†å®é™…æƒ…å†µè€Œå®š</td><td style="text-align:center">å“åº”æ¶ˆæ¯</td><td style="text-align:center">å¦‚æœå‡ºç°å¼‚å¸¸ï¼Œ<code>message</code>å°±æ˜¯å¯¹åº”çš„å¼‚å¸¸ä¿¡æ¯</td></tr><tr><td style="text-align:center"><code>payload</code></td><td style="text-align:center"><code>java.lang.Object</code></td><td style="text-align:center">è§†å®é™…æƒ…å†µè€Œå®š</td><td style="text-align:center">æ¶ˆæ¯è½½è·</td><td style="text-align:center">ä¸šåŠ¡å¤„ç†è¿”å›çš„æ¶ˆæ¯è½½è·ï¼Œå®šä¹‰ä¸º<code>Object</code>ç±»å‹</td></tr></tbody></table><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EqualsAndHashCode</span>(callSuper = <span class="keyword">true</span>)</span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResponseMessagePacket</span> <span class="keyword">extends</span> <span class="title">BaseMessagePacket</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * error code</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Long errorCode;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ¶ˆæ¯æè¿°</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> String message;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * æ¶ˆæ¯è½½è·</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Object payload;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>éœ€è¦æ³¨æ„ä»¥ä¸‹å‡ ç‚¹</strong>ï¼š</p><ul><li>éåŸºæœ¬ç±»å‹åœ¨åºåˆ—åŒ–å’Œååºåˆ—åŒ–çš„æ—¶å€™ï¼Œä¸€å®šæ³¨æ„è¦å…ˆå†™å…¥æˆ–è€…å…ˆè¯»å–åºåˆ—çš„é•¿åº¦ï¼Œä»¥<code>java.lang.String</code>ç±»å‹ä¸ºä¾‹ï¼š</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åºåˆ—åŒ– - æµæ°´å·</span></span><br><span class="line">out.writeInt(packet.getSerialNumber().length());</span><br><span class="line">out.writeCharSequence(packet.getSerialNumber(), ProtocolConstant.UTF_8);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ååºåˆ—åŒ– - æµæ°´å·</span></span><br><span class="line"><span class="keyword">int</span> serialNumberLength = in.readInt();</span><br><span class="line">packet.setSerialNumber(in.readCharSequence(serialNumberLength, ProtocolConstant.UTF_8).toString());</span><br></pre></td></tr></table></figure><ul><li>ç‰¹æ®Šç¼–ç çš„å­—ç¬¦ä¸²åœ¨åºåˆ—åŒ–çš„æ—¶å€™ï¼Œè¦æ³¨æ„å­—ç¬¦ä¸²ç¼–ç çš„é•¿åº¦ï¼Œä¾‹å¦‚<code>UTF-8</code>ç¼–ç ä¸‹ä¸€ä¸ªä¸­æ–‡å­—ç¬¦å 3ä¸ªå­—èŠ‚ï¼Œè¿™ä¸€ç‚¹å¯ä»¥æŠ½å–ä¸€ä¸ªå·¥å…·ç±»ä¸“é—¨å¤„ç†å­—ç¬¦ä¸²çš„åºåˆ—åŒ–ï¼š</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> ByteBufferUtils &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å•ä¾‹</span></span><br><span class="line">    X;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">encodeUtf8CharSequence</span><span class="params">(ByteBuf byteBuf, CharSequence charSequence)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> writerIndex = byteBuf.writerIndex();</span><br><span class="line">        byteBuf.writeInt(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">int</span> length = ByteBufUtil.writeUtf8(byteBuf, charSequence);</span><br><span class="line">        byteBuf.setInt(writerIndex, length);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>æ–¹æ³•å‚æ•°æ•°ç»„çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–æ–¹æ¡ˆéœ€è¦å®šåˆ¶ï¼Œç¬”è€…ä¸ºäº†ç®€åŒ–è‡ªå®šä¹‰åè®®ï¼Œ<strong>å®šä¹‰äº†æ–¹æ³•å‚æ•°ç­¾åæ•°ç»„</strong>ï¼Œé•¿åº¦å’Œæ–¹æ³•å‚æ•°æ•°ç»„ä¸€è‡´ï¼Œè¿™æ ·åšæ–¹ä¾¿åé¢ç¼–å†™æœåŠ¡ç«¯ä»£ç çš„æ—¶å€™ï¼Œ<strong>ç®€åŒ–å¯¹æ–¹æ³•å‚æ•°æ•°ç»„è¿›è¡Œååºåˆ—åŒ–ä»¥åŠå®¿ä¸»ç±»ç›®æ ‡æ–¹æ³•çš„æŸ¥æ‰¾</strong>ã€‚æ³¨æ„ä¸€ä¸‹<code>Object[]</code>çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ç›¸å¯¹ç‰¹æ®Šï¼Œå› ä¸º<code>ByteBuf</code>æ— æ³•å¤„ç†è‡ªå®šä¹‰ç±»å‹çš„å†™å…¥å’Œè¯»å–ï¼ˆè¿™ä¸ªå¾ˆå¥½ç†è§£ï¼Œç½‘ç»œç¼–ç¨‹å°±æ˜¯é¢å‘<code>0</code>å’Œ<code>1</code>çš„ç¼–ç¨‹ï¼‰ï¼š</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">write Object --&gt; ByteBuf#writeInt() &amp;&amp; ByteBuf#writeBytes()</span><br><span class="line"></span><br><span class="line">read Object --&gt; ByteBuf#readInt() &amp;&amp; ByteBuf#readBytes() [&lt;== è¿™ä¸ªæ–¹æ³•è¿”å›å€¼æ˜¯ByteBufå®ä¾‹]</span><br></pre></td></tr></table></figure><ul><li>æœ€åæ³¨æ„é‡Šæ”¾<code>ByteBuf</code>çš„å¼•ç”¨ï¼Œå¦åˆ™æœ‰å¯èƒ½å¯¼è‡´å†…å­˜æ³„æ¼ã€‚</li></ul><h2 id="è‡ªå®šä¹‰åè®®ç¼–ç è§£ç å®ç°">è‡ªå®šä¹‰åè®®ç¼–ç è§£ç å®ç°</h2><p>è‡ªå®šä¹‰åè®®ç¼–ç è§£ç ä¸»è¦åŒ…æ‹¬å››ä¸ªéƒ¨åˆ†çš„ç¼–ç è§£ç å™¨ï¼š</p><ul><li>è¯·æ±‚<code>Packet</code>ç¼–ç å™¨ï¼š<code>RequestMessagePacketEncoder</code>ï¼Œä¸»è¦ç”¨äº<strong>å®¢æˆ·ç«¯</strong>æŠŠ<code>RequestMessagePacket</code>å®ä¾‹åºåˆ—åŒ–ä¸ºäºŒè¿›åˆ¶åºåˆ—ã€‚</li><li>è¯·æ±‚<code>Packet</code>è§£ç å™¨ï¼š<code>RequestMessagePacketDecoder</code>ï¼Œä¸»è¦ç”¨äº<strong>æœåŠ¡ç«¯</strong>æŠŠäºŒè¿›åˆ¶åºåˆ—ååºåˆ—åŒ–ä¸º<code>RequestMessagePacket</code>å®ä¾‹ã€‚</li><li>å“åº”<code>Packet</code>ç¼–ç å™¨ï¼š<code>ResponseMessagePacketEncoder</code>ï¼Œä¸»è¦ç”¨äº<strong>æœåŠ¡ç«¯</strong>æŠŠ<code>ResponseMessagePacket</code>å®ä¾‹åºåˆ—åŒ–ä¸ºäºŒè¿›åˆ¶åºåˆ—ã€‚</li><li>å“åº”<code>Packet</code>è§£ç å™¨ï¼š<code>ResponseMessagePacketDecoder</code>ï¼Œä¸»è¦ç”¨äº<strong>å®¢æˆ·ç«¯</strong>æŠŠäºŒè¿›åˆ¶åºåˆ—ååºåˆ—åŒ–ä¸º<code>ResponseMessagePacket</code>å®ä¾‹ã€‚</li></ul><p>ç”»ä¸ªå›¾æè¿°ä¸€ä¸‹å‡ ä¸ªç»„ä»¶çš„äº¤äº’æµç¨‹ï¼ˆçœç•¥äº†éƒ¨åˆ†å…¥ç«™å’Œå‡ºç«™å¤„ç†å™¨ï¼‰ï¼š</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/202001/n-s-b-c-p-1.png" alt=""></p><p>åºåˆ—åŒ–å™¨<code>Serializer</code>çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Serializer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">byte</span>[] encode(Object target);</span><br><span class="line"></span><br><span class="line">    <span class="function">Object <span class="title">decode</span><span class="params">(<span class="keyword">byte</span>[] bytes, Class&lt;?&gt; targetClass)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// FastJsonå®ç°</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> FastJsonSerializer implements Serializer &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å•ä¾‹</span></span><br><span class="line">    X;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] encode(Object target) &#123;</span><br><span class="line">        <span class="keyword">return</span> JSON.toJSONBytes(target);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">decode</span><span class="params">(<span class="keyword">byte</span>[] bytes, Class&lt;?&gt; targetClass)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> JSON.parseObject(bytes, targetClass);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯·æ±‚<code>Packet</code>ç¼–ç å™¨<code>RequestMessagePacketEncoder</code>çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestMessagePacketEncoder</span> <span class="keyword">extends</span> <span class="title">MessageToByteEncoder</span>&lt;<span class="title">RequestMessagePacket</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Serializer serializer;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">encode</span><span class="params">(ChannelHandlerContext context, RequestMessagePacket packet, ByteBuf out)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// é­”æ•°</span></span><br><span class="line">        out.writeInt(packet.getMagicNumber());</span><br><span class="line">        <span class="comment">// ç‰ˆæœ¬</span></span><br><span class="line">        out.writeInt(packet.getVersion());</span><br><span class="line">        <span class="comment">// æµæ°´å·</span></span><br><span class="line">        out.writeInt(packet.getSerialNumber().length());</span><br><span class="line">        out.writeCharSequence(packet.getSerialNumber(), ProtocolConstant.UTF_8);</span><br><span class="line">        <span class="comment">// æ¶ˆæ¯ç±»å‹</span></span><br><span class="line">        out.writeByte(packet.getMessageType().getType());</span><br><span class="line">        <span class="comment">// é™„ä»¶size</span></span><br><span class="line">        Map&lt;String, String&gt; attachments = packet.getAttachments();</span><br><span class="line">        out.writeInt(attachments.size());</span><br><span class="line">        <span class="comment">// é™„ä»¶å†…å®¹</span></span><br><span class="line">        attachments.forEach((k, v) -&gt; &#123;</span><br><span class="line">            out.writeInt(k.length());</span><br><span class="line">            out.writeCharSequence(k, ProtocolConstant.UTF_8);</span><br><span class="line">            out.writeInt(v.length());</span><br><span class="line">            out.writeCharSequence(v, ProtocolConstant.UTF_8);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// æ¥å£å…¨ç±»å</span></span><br><span class="line">        out.writeInt(packet.getInterfaceName().length());</span><br><span class="line">        out.writeCharSequence(packet.getInterfaceName(), ProtocolConstant.UTF_8);</span><br><span class="line">        <span class="comment">// æ–¹æ³•å</span></span><br><span class="line">        out.writeInt(packet.getMethodName().length());</span><br><span class="line">        out.writeCharSequence(packet.getMethodName(), ProtocolConstant.UTF_8);</span><br><span class="line">        <span class="comment">// æ–¹æ³•å‚æ•°ç­¾å(String[]ç±»å‹) - éå¿…é¡»</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != packet.getMethodArgumentSignatures()) &#123;</span><br><span class="line">            <span class="keyword">int</span> len = packet.getMethodArgumentSignatures().length;</span><br><span class="line">            <span class="comment">// æ–¹æ³•å‚æ•°ç­¾åæ•°ç»„é•¿åº¦</span></span><br><span class="line">            out.writeInt(len);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">                String methodArgumentSignature = packet.getMethodArgumentSignatures()[i];</span><br><span class="line">                out.writeInt(methodArgumentSignature.length());</span><br><span class="line">                out.writeCharSequence(methodArgumentSignature, ProtocolConstant.UTF_8);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            out.writeInt(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ–¹æ³•å‚æ•°(Object[]ç±»å‹) - éå¿…é¡»</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != packet.getMethodArguments()) &#123;</span><br><span class="line">            <span class="keyword">int</span> len = packet.getMethodArguments().length;</span><br><span class="line">            <span class="comment">// æ–¹æ³•å‚æ•°æ•°ç»„é•¿åº¦</span></span><br><span class="line">            out.writeInt(len);</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">                <span class="keyword">byte</span>[] bytes = serializer.encode(packet.getMethodArguments()[i]);</span><br><span class="line">                out.writeInt(bytes.length);</span><br><span class="line">                out.writeBytes(bytes);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            out.writeInt(<span class="number">0</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯·æ±‚<code>Packet</code>è§£ç å™¨<code>RequestMessagePacketDecoder</code>çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RequestMessagePacketDecoder</span> <span class="keyword">extends</span> <span class="title">ByteToMessageDecoder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">decode</span><span class="params">(ChannelHandlerContext context, ByteBuf in, List&lt;Object&gt; list)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        RequestMessagePacket packet = <span class="keyword">new</span> RequestMessagePacket();</span><br><span class="line">        <span class="comment">// é­”æ•°</span></span><br><span class="line">        packet.setMagicNumber(in.readInt());</span><br><span class="line">        <span class="comment">// ç‰ˆæœ¬</span></span><br><span class="line">        packet.setVersion(in.readInt());</span><br><span class="line">        <span class="comment">// æµæ°´å·</span></span><br><span class="line">        <span class="keyword">int</span> serialNumberLength = in.readInt();</span><br><span class="line">        packet.setSerialNumber(in.readCharSequence(serialNumberLength, ProtocolConstant.UTF_8).toString());</span><br><span class="line">        <span class="comment">// æ¶ˆæ¯ç±»å‹</span></span><br><span class="line">        <span class="keyword">byte</span> messageTypeByte = in.readByte();</span><br><span class="line">        packet.setMessageType(MessageType.fromValue(messageTypeByte));</span><br><span class="line">        <span class="comment">// é™„ä»¶</span></span><br><span class="line">        Map&lt;String, String&gt; attachments = Maps.newHashMap();</span><br><span class="line">        packet.setAttachments(attachments);</span><br><span class="line">        <span class="keyword">int</span> attachmentSize = in.readInt();</span><br><span class="line">        <span class="keyword">if</span> (attachmentSize &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; attachmentSize; i++) &#123;</span><br><span class="line">                <span class="keyword">int</span> keyLength = in.readInt();</span><br><span class="line">                String key = in.readCharSequence(keyLength, ProtocolConstant.UTF_8).toString();</span><br><span class="line">                <span class="keyword">int</span> valueLength = in.readInt();</span><br><span class="line">                String value = in.readCharSequence(valueLength, ProtocolConstant.UTF_8).toString();</span><br><span class="line">                attachments.put(key, value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ¥å£å…¨ç±»å</span></span><br><span class="line">        <span class="keyword">int</span> interfaceNameLength = in.readInt();</span><br><span class="line">        packet.setInterfaceName(in.readCharSequence(interfaceNameLength, ProtocolConstant.UTF_8).toString());</span><br><span class="line">        <span class="comment">// æ–¹æ³•å</span></span><br><span class="line">        <span class="keyword">int</span> methodNameLength = in.readInt();</span><br><span class="line">        packet.setMethodName(in.readCharSequence(methodNameLength, ProtocolConstant.UTF_8).toString());</span><br><span class="line">        <span class="comment">// æ–¹æ³•å‚æ•°ç­¾å</span></span><br><span class="line">        <span class="keyword">int</span> methodArgumentSignatureArrayLength = in.readInt();</span><br><span class="line">        <span class="keyword">if</span> (methodArgumentSignatureArrayLength &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            String[] methodArgumentSignatures = <span class="keyword">new</span> String[methodArgumentSignatureArrayLength];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; methodArgumentSignatureArrayLength; i++) &#123;</span><br><span class="line">                <span class="keyword">int</span> methodArgumentSignatureLength = in.readInt();</span><br><span class="line">                methodArgumentSignatures[i] = in.readCharSequence(methodArgumentSignatureLength, ProtocolConstant.UTF_8).toString();</span><br><span class="line">            &#125;</span><br><span class="line">            packet.setMethodArgumentSignatures(methodArgumentSignatures);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ–¹æ³•å‚æ•°</span></span><br><span class="line">        <span class="keyword">int</span> methodArgumentArrayLength = in.readInt();</span><br><span class="line">        <span class="keyword">if</span> (methodArgumentArrayLength &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="comment">// è¿™é‡Œçš„Object[]å®é™…ä¸Šæ˜¯ByteBuf[] - åé¢éœ€è¦äºŒæ¬¡åŠ å·¥ä¸ºå¯¹åº”ç±»å‹çš„å®ä¾‹</span></span><br><span class="line">            Object[] methodArguments = <span class="keyword">new</span> Object[methodArgumentArrayLength];</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; methodArgumentArrayLength; i++) &#123;</span><br><span class="line">                <span class="keyword">int</span> byteLength = in.readInt();</span><br><span class="line">                methodArguments[i] = in.readBytes(byteLength);</span><br><span class="line">            &#125;</span><br><span class="line">            packet.setMethodArguments(methodArguments);</span><br><span class="line">        &#125;</span><br><span class="line">        list.add(packet);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å“åº”<code>Packet</code>ç¼–ç å™¨<code>ResponseMessagePacketEncoder</code>çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResponseMessagePacketEncoder</span> <span class="keyword">extends</span> <span class="title">MessageToByteEncoder</span>&lt;<span class="title">ResponseMessagePacket</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Serializer serializer;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">encode</span><span class="params">(ChannelHandlerContext ctx, ResponseMessagePacket packet, ByteBuf out)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// é­”æ•°</span></span><br><span class="line">        out.writeInt(packet.getMagicNumber());</span><br><span class="line">        <span class="comment">// ç‰ˆæœ¬</span></span><br><span class="line">        out.writeInt(packet.getVersion());</span><br><span class="line">        <span class="comment">// æµæ°´å·</span></span><br><span class="line">        out.writeInt(packet.getSerialNumber().length());</span><br><span class="line">        out.writeCharSequence(packet.getSerialNumber(), ProtocolConstant.UTF_8);</span><br><span class="line">        <span class="comment">// æ¶ˆæ¯ç±»å‹</span></span><br><span class="line">        out.writeByte(packet.getMessageType().getType());</span><br><span class="line">        <span class="comment">// é™„ä»¶size</span></span><br><span class="line">        Map&lt;String, String&gt; attachments = packet.getAttachments();</span><br><span class="line">        out.writeInt(attachments.size());</span><br><span class="line">        <span class="comment">// é™„ä»¶å†…å®¹</span></span><br><span class="line">        attachments.forEach((k, v) -&gt; &#123;</span><br><span class="line">            out.writeInt(k.length());</span><br><span class="line">            out.writeCharSequence(k, ProtocolConstant.UTF_8);</span><br><span class="line">            out.writeInt(v.length());</span><br><span class="line">            out.writeCharSequence(v, ProtocolConstant.UTF_8);</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="comment">// error code</span></span><br><span class="line">        out.writeLong(packet.getErrorCode());</span><br><span class="line">        <span class="comment">// message</span></span><br><span class="line">        String message = packet.getMessage();</span><br><span class="line">        ByteBufferUtils.X.encodeUtf8CharSequence(out, message);</span><br><span class="line">        <span class="comment">// payload</span></span><br><span class="line">        <span class="keyword">byte</span>[] bytes = serializer.encode(packet.getPayload());</span><br><span class="line">        out.writeInt(bytes.length);</span><br><span class="line">        out.writeBytes(bytes);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å“åº”<code>Packet</code>è§£ç å™¨<code>ResponseMessagePacketDecoder</code>çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ResponseMessagePacketDecoder</span> <span class="keyword">extends</span> <span class="title">ByteToMessageDecoder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">decode</span><span class="params">(ChannelHandlerContext ctx, ByteBuf in, List&lt;Object&gt; out)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        ResponseMessagePacket packet = <span class="keyword">new</span> ResponseMessagePacket();</span><br><span class="line">        <span class="comment">// é­”æ•°</span></span><br><span class="line">        packet.setMagicNumber(in.readInt());</span><br><span class="line">        <span class="comment">// ç‰ˆæœ¬</span></span><br><span class="line">        packet.setVersion(in.readInt());</span><br><span class="line">        <span class="comment">// æµæ°´å·</span></span><br><span class="line">        <span class="keyword">int</span> serialNumberLength = in.readInt();</span><br><span class="line">        packet.setSerialNumber(in.readCharSequence(serialNumberLength, ProtocolConstant.UTF_8).toString());</span><br><span class="line">        <span class="comment">// æ¶ˆæ¯ç±»å‹</span></span><br><span class="line">        <span class="keyword">byte</span> messageTypeByte = in.readByte();</span><br><span class="line">        packet.setMessageType(MessageType.fromValue(messageTypeByte));</span><br><span class="line">        <span class="comment">// é™„ä»¶</span></span><br><span class="line">        Map&lt;String, String&gt; attachments = Maps.newHashMap();</span><br><span class="line">        packet.setAttachments(attachments);</span><br><span class="line">        <span class="keyword">int</span> attachmentSize = in.readInt();</span><br><span class="line">        <span class="keyword">if</span> (attachmentSize &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; attachmentSize; i++) &#123;</span><br><span class="line">                <span class="keyword">int</span> keyLength = in.readInt();</span><br><span class="line">                String key = in.readCharSequence(keyLength, ProtocolConstant.UTF_8).toString();</span><br><span class="line">                <span class="keyword">int</span> valueLength = in.readInt();</span><br><span class="line">                String value = in.readCharSequence(valueLength, ProtocolConstant.UTF_8).toString();</span><br><span class="line">                attachments.put(key, value);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// error code</span></span><br><span class="line">        packet.setErrorCode(in.readLong());</span><br><span class="line">        <span class="comment">// message</span></span><br><span class="line">        <span class="keyword">int</span> messageLength = in.readInt();</span><br><span class="line">        packet.setMessage(in.readCharSequence(messageLength, ProtocolConstant.UTF_8).toString());</span><br><span class="line">        <span class="comment">// payload - ByteBufå®ä¾‹</span></span><br><span class="line">        <span class="keyword">int</span> payloadLength = in.readInt();</span><br><span class="line">        packet.setPayload(in.readBytes(payloadLength));</span><br><span class="line">        out.add(packet);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¸å¿ƒçš„ç¼–ç è§£ç å™¨å·²ç»ç¼–å†™å®Œï¼Œæ¥ç€è¦æ³¨æ„ä¸€ä¸‹<code>TCP</code>åè®®äºŒè¿›åˆ¶åŒ…å‘é€çš„æ—¶å€™åªä¿è¯äº†åŒ…çš„å‘é€é¡ºåºã€ç¡®è®¤å‘é€ä»¥åŠé‡ä¼ ï¼Œæ— æ³•ä¿è¯äºŒè¿›åˆ¶åŒ…æ˜¯å¦å®Œæ•´ï¼ˆæœ‰äº›åšå®¢ä¹Ÿç§°æ­¤ç±»åœºæ™¯ä¸ºç²˜åŒ…ã€åŠåŒ…ç­‰ç­‰ï¼Œå…¶å®ç½‘ç»œåè®®é‡Œé¢å¹¶æ²¡æœ‰å®šä¹‰è¿™äº›æœ¯è¯­ï¼Œä¼°è®¡æ˜¯æœ‰äººæœæ’°å‡ºæ¥ï¼‰ï¼Œå› æ­¤è¿™é‡Œé‡‡å–äº†å®šé•¿å¸§ç¼–ç å’Œè§£ç å™¨<code>LengthFieldPrepender</code>å’Œ<code>LengthFieldBasedFrameDecoder</code>ï¼Œç®€å•æ¥è¯´å°±æ˜¯åœ¨æ¶ˆæ¯å¸§çš„å¼€å¤´å‡ ä½å®šä¹‰äº†æ•´ä¸ªå¸§çš„é•¿åº¦ï¼Œè¯»å–åˆ°æ•´ä¸ªé•¿åº¦çš„æ¶ˆæ¯å¸§æ‰è®¤ä¸ºæ˜¯ä¸€ä¸ªå®Œæ•´çš„äºŒè¿›åˆ¶æŠ¥æ–‡ã€‚ä¸¾ä¸ªå‡ ä¸ªä¾‹å­ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">|&lt;--------packet frame---------&gt;|</span><br><span class="line">| Length Field | Actual Content |</span><br></pre></td></tr></table></figure><table><thead><tr><th style="text-align:center">åºå·</th><th style="text-align:center">Length Field</th><th style="text-align:center">Actual Content</th></tr></thead><tbody><tr><td style="text-align:center">0</td><td style="text-align:center">4</td><td style="text-align:center">abcd</td></tr><tr><td style="text-align:center">1</td><td style="text-align:center">9</td><td style="text-align:center">throwable</td></tr><tr><td style="text-align:center">2</td><td style="text-align:center">14</td><td style="text-align:center">{â€œnameâ€:â€œdogeâ€}</td></tr></tbody></table><h2 id="ç¼–å†™æµ‹è¯•å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯">ç¼–å†™æµ‹è¯•å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯</h2><p>å®¢æˆ·ç«¯ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestProtocolClient</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> port = <span class="number">9092</span>;</span><br><span class="line">        EventLoopGroup workerGroup = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">        Bootstrap bootstrap = <span class="keyword">new</span> Bootstrap();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            bootstrap.group(workerGroup);</span><br><span class="line">            bootstrap.channel(NioSocketChannel<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            bootstrap.option(ChannelOption.SO_KEEPALIVE, Boolean.TRUE);</span><br><span class="line">            bootstrap.option(ChannelOption.TCP_NODELAY, Boolean.TRUE);</span><br><span class="line">            bootstrap.handler(<span class="keyword">new</span> ChannelInitializer&lt;SocketChannel&gt;() &#123;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                    ch.pipeline().addLast(<span class="keyword">new</span> LengthFieldBasedFrameDecoder(<span class="number">1024</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">0</span>, <span class="number">4</span>));</span><br><span class="line">                    ch.pipeline().addLast(<span class="keyword">new</span> LengthFieldPrepender(<span class="number">4</span>));</span><br><span class="line">                    ch.pipeline().addLast(<span class="keyword">new</span> RequestMessagePacketEncoder(FastJsonSerializer.X));</span><br><span class="line">                    ch.pipeline().addLast(<span class="keyword">new</span> ResponseMessagePacketDecoder());</span><br><span class="line">                    ch.pipeline().addLast(<span class="keyword">new</span> SimpleChannelInboundHandler&lt;ResponseMessagePacket&gt;() &#123;</span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">channelRead0</span><span class="params">(ChannelHandlerContext ctx, ResponseMessagePacket packet)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                            Object targetPayload = packet.getPayload();</span><br><span class="line">                            <span class="keyword">if</span> (targetPayload <span class="keyword">instanceof</span> ByteBuf) &#123;</span><br><span class="line">                                ByteBuf byteBuf = (ByteBuf) targetPayload;</span><br><span class="line">                                <span class="keyword">int</span> readableByteLength = byteBuf.readableBytes();</span><br><span class="line">                                <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[readableByteLength];</span><br><span class="line">                                byteBuf.readBytes(bytes);</span><br><span class="line">                                targetPayload = FastJsonSerializer.X.decode(bytes, String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">                                byteBuf.release();</span><br><span class="line">                            &#125;</span><br><span class="line">                            packet.setPayload(targetPayload);</span><br><span class="line">                            log.info(<span class="string">"æ¥æ”¶åˆ°æ¥è‡ªæœåŠ¡ç«¯çš„å“åº”æ¶ˆæ¯,æ¶ˆæ¯å†…å®¹:&#123;&#125;"</span>, JSON.toJSONString(packet));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            ChannelFuture future = bootstrap.connect(<span class="string">"localhost"</span>, port).sync();</span><br><span class="line">            log.info(<span class="string">"å¯åŠ¨NettyClient[&#123;&#125;]æˆåŠŸ..."</span>, port);</span><br><span class="line">            Channel channel = future.channel();</span><br><span class="line">            RequestMessagePacket packet = <span class="keyword">new</span> RequestMessagePacket();</span><br><span class="line">            packet.setMagicNumber(ProtocolConstant.MAGIC_NUMBER);</span><br><span class="line">            packet.setVersion(ProtocolConstant.VERSION);</span><br><span class="line">            packet.setSerialNumber(SerialNumberUtils.X.generateSerialNumber());</span><br><span class="line">            packet.setMessageType(MessageType.REQUEST);</span><br><span class="line">            packet.setInterfaceName(<span class="string">"club.throwable.contract.HelloService"</span>);</span><br><span class="line">            packet.setMethodName(<span class="string">"sayHello"</span>);</span><br><span class="line">            packet.setMethodArgumentSignatures(<span class="keyword">new</span> String[]&#123;<span class="string">"java.lang.String"</span>&#125;);</span><br><span class="line">            packet.setMethodArguments(<span class="keyword">new</span> Object[]&#123;<span class="string">"doge"</span>&#125;);</span><br><span class="line">            channel.writeAndFlush(packet);</span><br><span class="line">            future.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            workerGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœåŠ¡ç«¯ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestProtocolServer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> port = <span class="number">9092</span>;</span><br><span class="line">        ServerBootstrap bootstrap = <span class="keyword">new</span> ServerBootstrap();</span><br><span class="line">        EventLoopGroup bossGroup = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">        EventLoopGroup workerGroup = <span class="keyword">new</span> NioEventLoopGroup();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            bootstrap.group(bossGroup, workerGroup)</span><br><span class="line">                    .channel(NioServerSocketChannel<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">                    .<span class="title">childHandler</span>(<span class="title">new</span> <span class="title">ChannelInitializer</span>&lt;<span class="title">SocketChannel</span>&gt;() </span>&#123;</span><br><span class="line"></span><br><span class="line">                        <span class="meta">@Override</span></span><br><span class="line">                        <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initChannel</span><span class="params">(SocketChannel ch)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                            ch.pipeline().addLast(<span class="keyword">new</span> LengthFieldBasedFrameDecoder(<span class="number">1024</span>, <span class="number">0</span>, <span class="number">4</span>, <span class="number">0</span>, <span class="number">4</span>));</span><br><span class="line">                            ch.pipeline().addLast(<span class="keyword">new</span> LengthFieldPrepender(<span class="number">4</span>));</span><br><span class="line">                            ch.pipeline().addLast(<span class="keyword">new</span> RequestMessagePacketDecoder());</span><br><span class="line">                            ch.pipeline().addLast(<span class="keyword">new</span> ResponseMessagePacketEncoder(FastJsonSerializer.X));</span><br><span class="line">                            ch.pipeline().addLast(<span class="keyword">new</span> SimpleChannelInboundHandler&lt;RequestMessagePacket&gt;() &#123;</span><br><span class="line"></span><br><span class="line">                                <span class="meta">@Override</span></span><br><span class="line">                                <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">channelRead0</span><span class="params">(ChannelHandlerContext ctx, RequestMessagePacket packet)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                                    log.info(<span class="string">"æ¥æ”¶åˆ°æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚æ¶ˆæ¯,æ¶ˆæ¯å†…å®¹:&#123;&#125;"</span>, JSON.toJSONString(packet));</span><br><span class="line">                                    ResponseMessagePacket response = <span class="keyword">new</span> ResponseMessagePacket();</span><br><span class="line">                                    response.setMagicNumber(packet.getMagicNumber());</span><br><span class="line">                                    response.setVersion(packet.getVersion());</span><br><span class="line">                                    response.setSerialNumber(packet.getSerialNumber());</span><br><span class="line">                                    response.setAttachments(packet.getAttachments());</span><br><span class="line">                                    response.setMessageType(MessageType.RESPONSE);</span><br><span class="line">                                    response.setErrorCode(<span class="number">200L</span>);</span><br><span class="line">                                    response.setMessage(<span class="string">"Success"</span>);</span><br><span class="line">                                    response.setPayload(<span class="string">"&#123;\"name\":\"throwable\"&#125;"</span>);</span><br><span class="line">                                    ctx.writeAndFlush(response);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">            ChannelFuture future = bootstrap.bind(port).sync();</span><br><span class="line">            log.info(<span class="string">"å¯åŠ¨NettyServer[&#123;&#125;]æˆåŠŸ..."</span>, port);</span><br><span class="line">            future.channel().closeFuture().sync();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            workerGroup.shutdownGracefully();</span><br><span class="line">            bossGroup.shutdownGracefully();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåœ¨æµ‹è¯•çš„ç¯å¢ƒä¸­ï¼Œæœ€å¤§çš„æ¶ˆæ¯å¸§é•¿åº¦æš‚æ—¶å®šä¹‰ä¸º1024ã€‚å…ˆå¯åŠ¨æœåŠ¡ç«¯ï¼Œå†å¯åŠ¨å®¢æˆ·ç«¯ï¼Œè§æ§åˆ¶å°è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">// æœåŠ¡ç«¯</span><br><span class="line">22:29:32.596 [main] INFO club.throwable.protocol.TestProtocolServer - å¯åŠ¨NettyServer[9092]æˆåŠŸ...</span><br><span class="line">...çœç•¥å…¶ä»–æ—¥å¿—...</span><br><span class="line">22:29:53.538 [nioEventLoopGroup-3-1] INFO club.throwable.protocol.TestProtocolServer - æ¥æ”¶åˆ°æ¥è‡ªå®¢æˆ·ç«¯çš„è¯·æ±‚æ¶ˆæ¯,æ¶ˆæ¯å†…å®¹:&#123;"attachments":&#123;&#125;,"interfaceName":"club.throwable.contract.HelloService","magicNumber":10086,"messageType":"REQUEST","methodArgumentSignatures":["java.lang.String"],"methodArguments":[&#123;"contiguous":true,"direct":true,"readOnly":false,"readable":true,"writable":false&#125;],"methodName":"sayHello","serialNumber":"7f992c7cf9f445258601def1cac9bec0","version":1&#125;</span><br><span class="line"></span><br><span class="line">// å®¢æˆ·ç«¯</span><br><span class="line">22:31:28.360 [main] INFO club.throwable.protocol.TestProtocolClient - å¯åŠ¨NettyClient[9092]æˆåŠŸ...</span><br><span class="line">...çœç•¥å…¶ä»–æ—¥å¿—...</span><br><span class="line">22:31:39.320 [nioEventLoopGroup-2-1] INFO club.throwable.protocol.TestProtocolClient - æ¥æ”¶åˆ°æ¥è‡ªæœåŠ¡ç«¯çš„å“åº”æ¶ˆæ¯,æ¶ˆæ¯å†…å®¹:&#123;"attachments":&#123;&#125;,"errorCode":200,"magicNumber":10086,"message":"Success","messageType":"RESPONSE","payload":"&#123;\"name\":\"throwable\"&#125;","serialNumber":"320808e709b34edbb91ba557780b58ad","version":1&#125;</span><br></pre></td></tr></table></figure><h2 id="å°ç»“">å°ç»“</h2><p>ä¸€ä¸ªåŸºäº<code>Netty</code>å®ç°çš„ç®€å•çš„è‡ªå®šä¹‰åè®®åŸºæœ¬å®Œæˆï¼Œä½†æ˜¯è¦ç¼–å†™ä¸€ä¸ªä¼˜ç§€çš„<code>RPC</code>æ¡†æ¶ï¼Œè¿˜éœ€è¦åšæœåŠ¡ç«¯çš„å®¿ä¸»ç±»å’Œç›®æ ‡æ–¹æ³•æŸ¥è¯¢ã€è°ƒç”¨ï¼Œå®¢æˆ·ç«¯çš„åŠ¨æ€ä»£ç†ï¼Œ<code>Netty</code>çš„<code>NIO</code>æ¨¡å¼ä¸‹çš„åŒæ­¥è°ƒç”¨æ”¹é€ ï¼Œå¿ƒè·³å¤„ç†ï¼Œå¼‚å¸¸å¤„ç†ç­‰ç­‰ã€‚åé¢ä¼šä½¿ç”¨å¤šç¯‡æ–‡ç« é€ä¸ªé—®é¢˜è§£å†³ï¼Œç½‘ç»œç¼–ç¨‹å…¶å®æŒºå¥½ç©äº†ï¼Œå°±æ˜¯ç¼–ç é‡ä¼šæ¯”è¾ƒå¤§<code>(ã‚œ-ã‚œ)ã¤ãƒ­</code>ã€‚</p><p><code>Demo</code>é¡¹ç›®ï¼š</p><ul><li><a href="https://github.com/zjcscut/netty-tutorials/tree/master/ch0-custom-rpc-protocol" target="_blank" rel="noopener">ch0-custom-rpc-protocol</a></li></ul><p>ï¼ˆe-a-20200112 c-1-dï¼‰</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰æ&quot;&gt;å‰æ&lt;/h2&gt;
&lt;p&gt;æœ€è¿‘å¯¹ç½‘ç»œç¼–ç¨‹æ–¹é¢æ¯”è¾ƒæœ‰å…´è¶£ï¼Œåœ¨å¾®æœåŠ¡å®è·µä¸Šä¹Ÿç”¨åˆ°äº†ç›¸å¯¹ä¸»æµçš„&lt;code&gt;RPC&lt;/code&gt;æ¡†æ¶å¦‚&lt;code&gt;Spring Cloud Gateway&lt;/code&gt;åº•å±‚ä¹Ÿåˆ‡æ¢ä¸º&lt;code&gt;Reactor-Netty&lt;/code&gt;ï¼Œåƒ&lt;code&gt;Redisson&lt;/code&gt;åº•å±‚ä¹Ÿæ˜¯ä½¿ç”¨&lt;code&gt;Netty&lt;/code&gt;å°è£…é€šè®¯åè®®ï¼Œæœ€è¿‘è°ƒç ”å’Œå‡†å¤‡ä½¿ç”¨çš„&lt;code&gt;SOFARpc&lt;/code&gt;ä¹Ÿæ˜¯åŸºäº&lt;code&gt;Netty&lt;/code&gt;å°è£…å®ç°äº†å¤šç§åè®®çš„å…¼å®¹ã€‚å› æ­¤ï¼ŒåŸºäº&lt;code&gt;Netty&lt;/code&gt;é€ ä¸€ä¸ªè½®å­ï¼Œåœ¨&lt;code&gt;SpringBoot&lt;/code&gt;çš„åŠ æŒä¸‹ï¼Œå®ç°ä¸€ä¸ªè½»é‡çº§çš„&lt;code&gt;RPC&lt;/code&gt;æ¡†æ¶ã€‚è¿™ç¯‡åšæ–‡ä»‹ç»çš„æ˜¯&lt;code&gt;RPC&lt;/code&gt;æ¡†æ¶åè®®çš„å®šä¹‰ä»¥åŠå¯¹åº”çš„ç¼–ç è§£ç å¤„ç†çš„å®ç°ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Netty" scheme="http://throwable.club/blog/categories/Netty/"/>
    
      <category term="Java" scheme="http://throwable.club/blog/categories/Netty/Java/"/>
    
    
      <category term="Java" scheme="http://throwable.club/blog/tags/Java/"/>
    
      <category term="Netty" scheme="http://throwable.club/blog/tags/Netty/"/>
    
  </entry>
  
  <entry>
    <title>SofaBootä½¿ç”¨Nacosè¿›è¡ŒæœåŠ¡æ³¨å†Œå‘ç°</title>
    <link href="http://throwable.club/2020/01/01/sofa-boot-nacos-get-start/"/>
    <id>http://throwable.club/2020/01/01/sofa-boot-nacos-get-start/</id>
    <published>2020-01-01T15:30:41.000Z</published>
    <updated>2020-01-02T09:35:56.367Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰æ">å‰æ</h2><p>æœ€è¿‘åˆ›ä¸šå…¬å¸çš„é¡¹ç›®ç»„åŸºäºä¸šåŠ¡éœ€è¦ï¼Œå¼€å‘ä¸€å¥—æ–°çš„å¾®æœåŠ¡ï¼Œè€ƒè™‘åˆ°é€‰ç”¨çš„ç»„ä»¶å¿…é¡»æ˜¯ä¸»æµã€ç¤¾åŒºæ´»è·ƒã€ç”Ÿæ€å®Œå–„ä»¥åŠæ–¹ä¾¿è¿ç§»åˆ°äº‘ä¸Šç­‰å› ç´ ï¼Œå¼•å…¥äº†<code>SOFAStack</code>å…¨å®¶æ¡¶ã€‚å¾®æœåŠ¡å¼€å‘é‡Œé¢ï¼Œä¸€ä¸ªå¾ˆé‡è¦çš„åŠŸèƒ½å°±æ˜¯æœåŠ¡å‘ç°ä¸æ³¨å†Œï¼Œç¬”è€…èŠ±äº†ç‚¹æ—¶é—´åšäº†ä¸€ä¸ª<code>SOFABoot</code>ã€<code>SOFARpc</code>ç»“åˆ<code>Nacos</code>å®ç°å¾®æœåŠ¡å‘ç°æ³¨å†Œä¸è¿œç¨‹è°ƒç”¨çš„ç¤ºä¾‹ã€‚</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/202001/s-f-s-n-1.png" alt=""></p><a id="more"></a><h2 id="ä¾èµ–ç‰ˆæœ¬è¸©å‘">ä¾èµ–ç‰ˆæœ¬è¸©å‘</h2><p>ç¬”è€…èŠ±äº†ç‚¹æ—¶é—´å»å°è¯•<code>SOFABoot</code>ã€<code>SOFARpc</code>ç»“åˆ<code>Nacos</code>å®¢æˆ·ç«¯çš„ä¾èµ–ç‰ˆæœ¬å…³ç³»ï¼Œæˆªæ­¢æœ¬æ–‡ç¼–å†™å®Œæˆçš„æ—¶å€™ï¼ˆ2020-01-01ï¼‰ï¼Œ<code>sofaboot-dependencies</code>çš„æœ€æ–°ç‰ˆæœ¬ä¸º<code>3.2.1</code>ï¼Œå¯¹åº”äº<code>SOFABoot-3.2.1</code>ã€<code>SOFARpc-5.6.3</code>å’Œ<code>SpringBoot-2.1.x.RELEASE</code>ã€‚åœ¨è¿™ä¸¤ä¸ªæœ€æ–°ç‰ˆæœ¬çš„é¡¹ç›®ä¸­ï¼Œæ— è®ºå¼•å…¥ä»€ä¹ˆç‰ˆæœ¬çš„<code>nacos-clinet</code>ï¼Œéƒ½æ²¡æœ‰åŠæ³•å‘<code>Nacos-Server</code>æ³¨å†ŒæœåŠ¡ä¿¡æ¯ã€‚å…³äºè¿™ä¸€ç‚¹ï¼Œç¬”è€…æ›¾ç»ä»<code>Issues</code>é‡Œé¢æŸ¥æ‰¾ç›¸å…³çš„å†…å®¹ï¼Œæš‚æ—¶æ— æœï¼Œäºæ˜¯æŠŠç¤ºä¾‹é¡¹ç›®åˆ†äº«ç»™ç¤¾åŒºçš„å¤§ä½¬è¿›è¡Œåˆ†æï¼Œå¦‚æœæœ‰è§£å†³æ–¹æ¡ˆï¼Œä¼šåœ¨è¿™ç¯‡åšæ–‡ä¸­æ›´æ–°ã€‚è¯•å‡ºæ¥çš„å¯ç”¨çš„ç‰ˆæœ¬ç»„åˆä¸ºï¼š</p><ul><li><code>sofaboot-dependencies:3.2.0</code></li><li><code>spring-boot-dependencies:2.1.0.RELEASE</code></li><li><code>nacos-api:0.6.0</code>å’Œ<code>nacos-client:0.6.0</code></li></ul><p>å¼•å…¥ä¾èµ–å¦‚ä¸‹ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sofa.boot.version</span>&gt;</span>3.2.0<span class="tag">&lt;/<span class="name">sofa.boot.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">spring.boot.version</span>&gt;</span>2.1.0.RELEASE<span class="tag">&lt;/<span class="name">spring.boot.version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">nacos.version</span>&gt;</span>0.6.0<span class="tag">&lt;/<span class="name">nacos.version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alipay.sofa<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sofaboot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;sofa.boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alipay.sofa<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>healthcheck-sofa-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alipay.sofa<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>rpc-sofa-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.nacos<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>nacos-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;nacos.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.nacos<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>nacos-api<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;nacos.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><h2 id="ç¼–å†™æœåŠ¡æä¾›æ–¹å’ŒæœåŠ¡æ¶ˆè´¹æ–¹ä»£ç ">ç¼–å†™æœåŠ¡æä¾›æ–¹å’ŒæœåŠ¡æ¶ˆè´¹æ–¹ä»£ç </h2><p>è¿™é‡Œæœ‰ä¸€ä¸ªå‰æï¼Œéœ€è¦å¯åŠ¨ä¸€ä¸ª<code>Nacos-Server</code>ï¼Œä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œä½¿ç”¨å•æœºæ¨¡å¼æœ¬åœ°å¯åŠ¨å³å¯ï¼Œé‚£ä¹ˆæœåŠ¡æ³¨å†Œçš„åœ°å€å°±æ˜¯<code>http://127.0.0.1:8848</code>ã€‚ç¤ºä¾‹é¡¹ç›®çš„ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">â”œâ”€src</span><br><span class="line">â”‚  â””â”€main</span><br><span class="line">â”‚      â”œâ”€java</span><br><span class="line">â”‚      â”‚  â””â”€club</span><br><span class="line">â”‚      â”‚      â””â”€throwable</span><br><span class="line">â”‚      â”‚          â”œâ”€client</span><br><span class="line">â”‚      â”‚          â”‚      ClientApplication.java</span><br><span class="line">â”‚      â”‚          â”‚      </span><br><span class="line">â”‚      â”‚          â”œâ”€contract</span><br><span class="line">â”‚      â”‚          â”‚      HelloService.java</span><br><span class="line">â”‚      â”‚          â”‚      </span><br><span class="line">â”‚      â”‚          â””â”€server</span><br><span class="line">â”‚      â”‚                 DefaultHelloService.java</span><br><span class="line">â”‚      â”‚                 ServerApplication.java</span><br><span class="line">â”‚      â”‚                  </span><br><span class="line">â”‚      â””â”€resources</span><br><span class="line">â”‚              application-client.properties</span><br><span class="line">â”‚              application-server.properties</span><br></pre></td></tr></table></figure><p>å…¶ä¸­<code>contract</code>ä¸ºå¥‘çº¦åŒ…ï¼Œå¯ä»¥æä¾›ç»™å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä½¿ç”¨ï¼Œ<code>client</code>åŒ…é‡Œé¢ç¼–å†™å®¢æˆ·ç«¯ï¼ˆ<code>comsumer</code>ï¼‰çš„ä»£ç ï¼Œè€Œ<code>server</code>åŒ…é‡Œé¢ç¼–å†™æœåŠ¡ç«¯ï¼ˆ<code>provider</code>ï¼‰çš„ä»£ç ã€‚</p><p>å¥‘çº¦æ¥å£<code>HelloService</code>å¾ˆç®€å•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">HelloService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">sayHello</span><span class="params">(String name)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœåŠ¡æä¾›æ–¹éœ€è¦å®ç°æ­¤æ¥å£ï¼Œå®ç°ç±»æ˜¯<code>DefaultHelloService</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span><br><span class="line"><span class="meta">@SofaService</span>(interfaceType = HelloService<span class="class">.<span class="keyword">class</span>, <span class="title">bindings</span> </span>= &#123;</span><br><span class="line">        <span class="meta">@SofaServiceBinding</span>(bindingType = <span class="string">"bolt"</span>)</span><br><span class="line">&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultHelloService</span> <span class="keyword">implements</span> <span class="title">HelloService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">sayHello</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">"%s say hello!"</span>, name);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä½¿ç”¨çš„æœåŠ¡åè®®ç»‘å®šç±»å‹ä¸º<code>bolt</code>ï¼Œæ˜¯å®˜æ–¹ç¤ºä¾‹å»ºè®®çš„åè®®ï¼Œå½“ç„¶è¿˜æœ‰<code>dubbo</code>ã€<code>http</code>ç­‰ç­‰ï¼Œå¯ä»¥æ··åˆé…ç½®ã€‚æ¥ç€ç¼–å†™æœåŠ¡æä¾›æ–¹å¯åŠ¨ç±»<code>ServerApplication</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span>(scanBasePackages = &#123;<span class="string">"club.throwable.server"</span>, <span class="string">"club.throwable.contract"</span>&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ServerApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ServerApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœåŠ¡æä¾›æ–¹åº”ç”¨çš„é…ç½®æ–‡ä»¶<code>application-server.properties</code>å¦‚ä¸‹ï¼š</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.application.name</span>=<span class="string">sofa-rpc-provider</span></span><br><span class="line"><span class="meta">server.port</span>=<span class="string">9092</span></span><br><span class="line"><span class="comment"># ç”¨Nacosåšæ³¨å†Œä¸­å¿ƒ</span></span><br><span class="line"><span class="meta">com.alipay.sofa.rpc.registry-address</span>=<span class="string">nacos://127.0.0.1:8848</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>spring.profiles.active=server</code>å¯åŠ¨<code>ServerApplication</code>ï¼Œå¯åŠ¨æˆåŠŸåç”¨æµè§ˆå™¨æ‰“å¼€<code>Nacos-Console</code>ï¼š</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/202001/s-f-s-n-2.png" alt=""></p><p>å¯è§ç›®å‰<code>sofa-rpc-provider</code>æœåŠ¡å·²ç»æˆåŠŸæ³¨å†Œåˆ°<code>Nacos-Server</code>ã€‚æ¥ç€ç¼–å†™å®¢æˆ·ç«¯ä»£ç ï¼Œä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œæ‰€æœ‰çš„ä»£ç ç¼–å†™åœ¨å¯åŠ¨ç±»<code>ClientApplication</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@SpringBootApplication</span>(scanBasePackages = &#123;<span class="string">"club.throwable.client"</span>, <span class="string">"club.throwable.contract"</span>&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientApplication</span> <span class="keyword">implements</span> <span class="title">CommandLineRunner</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SofaReference</span>(binding = <span class="meta">@SofaReferenceBinding</span>(bindingType = <span class="string">"bolt"</span>))</span><br><span class="line">    <span class="keyword">private</span> HelloService helloService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ClientApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(String... args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        log.info(<span class="string">"è°ƒç”¨HelloService#sayHello(),ç»“æœ:&#123;&#125;"</span>, helloService.sayHello(<span class="string">"throwable"</span>));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœåŠ¡æ¶ˆè´¹æ–¹çš„é…ç½®æ–‡ä»¶<code>application-client.properties</code>å¦‚ä¸‹ï¼š</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.application.name</span>=<span class="string">sofa-rpc-consumer</span></span><br><span class="line"><span class="meta">server.port</span>=<span class="string">9091</span></span><br><span class="line"><span class="comment"># ç”¨Nacosåšæ³¨å†Œä¸­å¿ƒ</span></span><br><span class="line"><span class="meta">com.alipay.sofa.rpc.registry-address</span>=<span class="string">nacos://127.0.0.1:8848</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>spring.profiles.active=client</code>å¯åŠ¨<code>ClientApplication</code>ï¼Œå¯åŠ¨å®Œæˆåæ§åˆ¶å°è¾“å‡ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2020-01-02 17:07:58.782  INFO 2900 --- [main] club.throwable.client.ClientApplication  : è°ƒç”¨HelloService#sayHello(),ç»“æœ:throwable say hello!</span><br></pre></td></tr></table></figure><p>åŸºæœ¬åŸç†å¦‚ä¸‹ï¼š</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/202001/s-f-s-n-3.png" alt=""></p><h2 id="å°ç»“">å°ç»“</h2><p><code>SOFABoot</code>ã€<code>SOFARpc</code>åº•å±‚ä¾èµ–äº<code>Spring</code>å®¹å™¨ï¼Œå¯ä»¥è·Ÿéš<code>SpringBoot</code>ç‰ˆæœ¬è¿­ä»£å‡çº§ï¼Œåº•å±‚é€šè®¯ä½¿ç”¨<code>Netty</code>ï¼Œåœ¨æ€§èƒ½ä¸Šæœ‰ä¿éšœï¼Œè€Œä¸”çœŸæ­£åšåˆ°äº†å…¼å®¹<code>HTTP</code>ã€<code>Dubbo</code>ã€<code>Service Mesh</code>ï¼ˆåé¢åº”è¯¥ä¼šæŠŠ<code>Service Mesh</code>ä½œä¸ºé€šè®¯åè®®è¿›è¡Œå…¼å®¹ï¼‰ç­‰ç­‰åè®®ï¼Œå¯¹äºå¼€å‘è€…è€Œè¨€ç›¸å¯¹å‹å¥½ï¼Œå­¦ä¹ æˆæœ¬ä½ï¼Œåšåˆ°çœŸæ­£çš„å¼€ç®±æ·»åŠ å°‘é‡é…ç½®å³å¯ä½¿ç”¨ã€‚é™¤äº†ç›®å‰å‘ç°ä¾èµ–ç‰ˆæœ¬çš„é—®é¢˜ï¼Œæš‚æ—¶æ²¡æœ‰å¤§çš„å‘ï¼Œå°å°é²œçš„æ„Ÿè§‰è¿˜æ˜¯æŒºä¸é”™çš„ã€‚</p><p>ç¤ºä¾‹é¡¹ç›®ï¼š</p><ul><li><a href="https://github.com/zjcscut/framework-mesh/tree/master/sofa-boot-nacos" target="_blank" rel="noopener">sofa-boot-nacos</a></li></ul><p>ï¼ˆæœ¬æ–‡å®Œ c-1-d e-a-20200101ï¼‰</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰æ&quot;&gt;å‰æ&lt;/h2&gt;
&lt;p&gt;æœ€è¿‘åˆ›ä¸šå…¬å¸çš„é¡¹ç›®ç»„åŸºäºä¸šåŠ¡éœ€è¦ï¼Œå¼€å‘ä¸€å¥—æ–°çš„å¾®æœåŠ¡ï¼Œè€ƒè™‘åˆ°é€‰ç”¨çš„ç»„ä»¶å¿…é¡»æ˜¯ä¸»æµã€ç¤¾åŒºæ´»è·ƒã€ç”Ÿæ€å®Œå–„ä»¥åŠæ–¹ä¾¿è¿ç§»åˆ°äº‘ä¸Šç­‰å› ç´ ï¼Œå¼•å…¥äº†&lt;code&gt;SOFAStack&lt;/code&gt;å…¨å®¶æ¡¶ã€‚å¾®æœåŠ¡å¼€å‘é‡Œé¢ï¼Œä¸€ä¸ªå¾ˆé‡è¦çš„åŠŸèƒ½å°±æ˜¯æœåŠ¡å‘ç°ä¸æ³¨å†Œï¼Œç¬”è€…èŠ±äº†ç‚¹æ—¶é—´åšäº†ä¸€ä¸ª&lt;code&gt;SOFABoot&lt;/code&gt;ã€&lt;code&gt;SOFARpc&lt;/code&gt;ç»“åˆ&lt;code&gt;Nacos&lt;/code&gt;å®ç°å¾®æœåŠ¡å‘ç°æ³¨å†Œä¸è¿œç¨‹è°ƒç”¨çš„ç¤ºä¾‹ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/202001/s-f-s-n-1.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="SOFAStack" scheme="http://throwable.club/blog/categories/SOFAStack/"/>
    
      <category term="Nacos" scheme="http://throwable.club/blog/categories/SOFAStack/Nacos/"/>
    
    
      <category term="SOFAStack" scheme="http://throwable.club/blog/tags/SOFAStack/"/>
    
      <category term="Nacos" scheme="http://throwable.club/blog/tags/Nacos/"/>
    
  </entry>
  
  <entry>
    <title>SpringBootä½¿ç”¨Nacosè¿›è¡ŒæœåŠ¡æ³¨å†Œå‘ç°ä¸é…ç½®ç®¡ç†</title>
    <link href="http://throwable.club/2020/01/01/spring-boot-nacos-get-start/"/>
    <id>http://throwable.club/2020/01/01/spring-boot-nacos-get-start/</id>
    <published>2020-01-01T15:20:41.000Z</published>
    <updated>2020-01-02T03:31:05.133Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰æ">å‰æ</h2><p>æœ€è¿‘ç”±äºä¸šåŠ¡å‘å±•ï¼Œéœ€è¦è°ƒç ”ä¸€å¥—å®Œå–„å’Œä¸»æµçš„åŸºç¡€æ¶æ„ï¼Œè¿›è¡Œä¸­å°åŒ–ï¼ˆå¾®æœåŠ¡ï¼‰çš„å®æ–½ï¼Œè€ƒè™‘åˆ°æŠ€æœ¯æ ˆåˆ‡æ¢åˆ°<a href="https://www.sofastack.tech" target="_blank" rel="noopener"><code>SOFAStack</code></a>ã€‚æ—¢ç„¶æ•´ä¸ªä½“ç³»éƒ½åˆ‡æ¢åˆ°èš‚èšé‡‘æœçš„æŠ€æœ¯æ ˆï¼Œé‚£ä¹ˆè‡ªç„¶è€ƒè™‘ä¸€äº›åŸºç¡€ç»„ä»¶å¦‚æœåŠ¡æ³¨å†Œå‘ç°ã€é…ç½®ç®¡ç†ç­‰éƒ½åˆ‡æ¢ä¸ºé˜¿é‡Œçš„æŠ€æœ¯æ ˆã€‚è€ƒè™‘åˆ°ç›®å‰æ¯”è¾ƒçƒ­çš„æœåŠ¡å‘ç°ç»„ä»¶æ˜¯<a href="https://nacos.io" target="_blank" rel="noopener"><code>Nacos</code></a>ï¼Œéœ€è¦è°ƒç ”<code>SpringBoot</code>æœåŠ¡æ¥å…¥<code>Nacos</code>çš„å¯è¡Œæ€§ï¼Œä¸ºä»¥åå¼ºåˆ¶è¦æ±‚æ–°æœåŠ¡ä½¿ç”¨<code>SOFAStack</code> + <code>Nacos</code>çš„æŠ€æœ¯æ ˆè¿›è¡ŒæœåŠ¡å¼€å‘æ‰“ä¸‹åŸºç¡€ã€‚</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/202001/s-b-n-1.png" alt=""></p><a id="more"></a><h2 id="Nacosç®€ä»‹">Nacosç®€ä»‹</h2><p>ä¸‹é¢çš„ç®€ä»‹æ¥æºäº<code>Nacos</code>çš„å®˜ç½‘ï¼š</p><p><code>Nacos</code>è‡´åŠ›äºå¸®åŠ©æ‚¨å‘ç°ã€é…ç½®å’Œç®¡ç†å¾®æœåŠ¡ã€‚<code>Nacos</code>æä¾›äº†ä¸€ç»„ç®€å•æ˜“ç”¨çš„ç‰¹æ€§é›†ï¼Œå¸®åŠ©æ‚¨å¿«é€Ÿå®ç°åŠ¨æ€æœåŠ¡å‘ç°ã€æœåŠ¡é…ç½®ã€æœåŠ¡å…ƒæ•°æ®åŠæµé‡ç®¡ç†ã€‚</p><p><code>Nacos</code>å¸®åŠ©æ‚¨æ›´æ•æ·å’Œå®¹æ˜“åœ°æ„å»ºã€äº¤ä»˜å’Œç®¡ç†å¾®æœåŠ¡å¹³å°ã€‚<code>Nacos</code>æ˜¯æ„å»ºä»¥<strong>æœåŠ¡</strong>ä¸ºä¸­å¿ƒçš„ç°ä»£åº”ç”¨æ¶æ„ï¼ˆä¾‹å¦‚å¾®æœåŠ¡èŒƒå¼ã€äº‘åŸç”ŸèŒƒå¼ï¼‰çš„æœåŠ¡åŸºç¡€è®¾æ–½ã€‚</p><p><code>Nacos</code>åœ°å›¾ï¼š</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/202001/s-b-n-2.png" alt=""></p><p><code>Nacos</code>ç”Ÿæ€å›¾ï¼š</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/202001/s-b-n-3.png" alt=""></p><p>ä»<code>Nacos</code>æä¾›çš„å‘å±•åœ°å›¾æ¥çœ‹ï¼Œå®ƒåŸºæœ¬æä¾›äº†ç›®å‰å¾®æœåŠ¡å®æ–½ä¸­ä¸€äº›æ ¸å¿ƒé—®é¢˜ï¼šç›‘æ§ã€æœåŠ¡å‘ç°æ³¨å†Œã€é…ç½®ç°åº¦å‘å¸ƒã€é…ç½®å›æ»šç­‰ç­‰ã€‚å¦å¤–ï¼Œå®ƒåœ¨ç”Ÿæ€ä¸Šèƒ½å¤Ÿèå…¥ç›®å‰ä¸»æµçš„<code>K8S</code>ã€<code>Docker</code>ã€<code>SpringCloud</code>ã€<code>Consul</code>ã€<code>Zookeeper</code>ç­‰ç­‰ï¼ˆæœ‰ç‚¹åƒå±è”½åº•å±‚ç»†èŠ‚ï¼Œåªéœ€å°‘é‡é…ç½®å°±å¯ä»¥åˆ‡æ¢åº•å±‚æ¶æ„çš„å®ç°ï¼‰ï¼Œè¿™ä¸€ç‚¹ååˆ†é‡è¦ã€‚ç›®å‰<code>Nacos</code>åœ¨é˜¿é‡Œäº‘ä¸Šæä¾›äº†å•†ç”¨ç‰ˆæœ¬ï¼ˆè®°å¾—æœ‰å‰è¾ˆè¯´è¿‡å¼€æºçš„ç»ˆæç›®æ ‡å°±æ˜¯å•†ç”¨ï¼Œå¤§æ¦‚å¦‚æ­¤ï¼‰ã€‚å¦‚æœåœ¨é¡¹ç›®ä¸­ä½¿ç”¨çš„æ˜¯<code>SpringCloud</code>å…¨å®¶æ¡¶ï¼Œå¼•å…¥<code>Nacos</code>ä»¥åŠå®ƒå’Œ<code>SpringCloud</code>ä¹‹é—´çš„èƒ¶æ°´å±‚ï¼Œå¯ä»¥å®Œå…¨æ›¿ä»£<code>Eureka</code>ç»„ä»¶çš„åŠŸèƒ½ï¼Œæ›¿ä»£å’Œå¼ºåŒ–éƒ¨åˆ†<code>Spring Cloud Config</code>çš„åŠŸèƒ½ã€‚</p><h2 id="NacosæœåŠ¡éƒ¨ç½²">NacosæœåŠ¡éƒ¨ç½²</h2><p><code>Nacos-Server</code>éƒ¨ç½²ç›¸å¯¹ç®€å•ï¼Œå®ƒçš„å‘å¸ƒç‰ˆæœ¬è§<a href="https://github.com/alibaba/nacos/releases" target="_blank" rel="noopener">Githubçš„Releasesé¡µé¢</a>ã€‚ä¸‹è½½å®Œæˆåè¿›è¡Œè§£å‹ï¼Œ<code>Windows</code>ç³»ä¸‹å¯åŠ¨<code>Nacos-Server</code>åªéœ€è¿›å…¥è§£å‹åçš„<code>${è§£å‹ç›®å½•}\nacos\bin</code>ç›®å½•ï¼Œæ‰§è¡Œ<code>startup.cmd</code>å³å¯ï¼ŒæœåŠ¡å¯åŠ¨æˆåŠŸçš„ç»“æœå¦‚ä¸‹ï¼š</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/202001/s-b-n-4.png" alt=""></p><p><strong>å•æœºæ¨¡å¼åœ¨ä¸ä¿®æ”¹é…ç½®çš„å‰æä¸‹ç›´æ¥å¯åŠ¨</strong>ï¼Œä½¿ç”¨çš„æ˜¯å†…å­˜æ•°æ®åº“ï¼Œé‡å¯åæ•°æ®ä¼šè¢«æ¸…ç©ºã€‚å¦‚æœéœ€è¦æ•°æ®æŒä¹…åŒ–ï¼Œåˆ™éœ€è¦å»ºç«‹æ•°æ®åº“ï¼Œå…·ä½“çš„æ­¥éª¤æ˜¯ï¼š</p><ul><li>å»ºè¡¨çš„è„šæœ¬åœ¨<code>${è§£å‹ç›®å½•}\nacos\conf</code>ç›®å½•ä¸‹ï¼Œè§<code>schema.sql</code>å’Œ<code>nacos-mysql.sql</code>ä¸¤ä¸ªæ–‡ä»¶ã€‚</li><li>è‡ªè¡Œé€šè¿‡å»ºè¡¨çš„è„šæœ¬å»ºç«‹æ•°æ®åº“ã€‚</li><li>éœ€è¦æŒ‡å®šæ•°æ®åº“ï¼Œåˆ™éœ€è¦ä¿®æ”¹<code>${è§£å‹ç›®å½•}\nacos\conf\application.properties</code>ï¼Œåœ¨æ–‡ä»¶çš„å°¾éƒ¨è¿½åŠ æ•°æ®æºçš„è¿æ¥é…ç½®ï¼Œä¸‹é¢æ˜¯å®˜æ–¹ç»™å‡ºçš„å¤šæ•°æ®æºçš„ä¾‹å­ï¼š</li></ul><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># éœ€è¦ç¡®ä¿å¤šä¸ªæ•°æ®æºçš„ç”¨æˆ·åå’Œå¯†ç ä¸€è‡´</span></span><br><span class="line"><span class="meta">db.num</span>=<span class="string">2</span></span><br><span class="line"><span class="meta">db.url.0</span>=<span class="string">jdbc:mysql://11.162.196.16:3306/nacos_devtest?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true</span></span><br><span class="line"><span class="meta">db.url.1</span>=<span class="string">jdbc:mysql://11.163.152.9:3306/nacos_devtest?characterEncoding=utf8&amp;connectTimeout=1000&amp;socketTimeout=3000&amp;autoReconnect=true</span></span><br><span class="line"><span class="meta">db.user</span>=<span class="string">nacos_devtest</span></span><br><span class="line"><span class="meta">db.password</span>=<span class="string">nacos</span></span><br></pre></td></tr></table></figure><p>æµ‹è¯•è·å–å·²ç»æ³¨å†Œçš„æœåŠ¡ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Î» curl -X GET http://127.0.0.1:8848/nacos/v1/ns/instance/list?serviceName=nacos.naming.serviceName</span><br><span class="line">&#123;"hosts":[],"name":"DEFAULT_GROUP@@nacos.naming.serviceName","clusters":""&#125;</span><br></pre></td></tr></table></figure><p>è®¿é—®<code>http://127.0.0.1:8848/nacos</code>å³å¯æ‰“å¼€<code>Nacos-Console</code>ï¼Œåˆå§‹çš„ç™»å½•è´¦å·å’Œå¯†ç éƒ½æ˜¯<code>nacos</code>ï¼š</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/202001/s-b-n-5.png" alt=""></p><p>æ›´å¤šè¿ç»´éƒ¨ç½²ç›¸å…³çš„å†…å®¹è§æ–‡æ¡£<strong>è¿ç»´æŒ‡å—</strong>ä¸­çš„ä¸€èŠ‚ã€‚</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/202001/s-b-n-6.png" alt=""></p><h2 id="SpirngBootåº”ç”¨ä½¿ç”¨Nacosä½œä¸ºæ³¨å†Œä¸­å¿ƒ">SpirngBootåº”ç”¨ä½¿ç”¨Nacosä½œä¸ºæ³¨å†Œä¸­å¿ƒ</h2><p><code>SpringBoot</code>åº”ç”¨ä½¿ç”¨<code>Nacos</code>ä½œä¸ºæ³¨å†Œä¸­å¿ƒéœ€è¦å¼•å…¥ä¾èµ–<code>nacos-discovery-spring-boot-starter</code>ï¼Œç¬”è€…ç¼–å†™æœ¬æ–‡çš„æ—¶å€™ï¼ˆ2020-01-01ï¼‰ï¼Œè¯¥ä¾èµ–çš„æœ€æ–°ç‰ˆæœ¬ä¸º<code>0.2.4</code>ï¼Œå¯¹åº”äº<code>SpringBoot</code>çš„ç‰ˆæœ¬ä¸º<code>2.0.3.RELEASE</code>ï¼Œå¼•å…¥å¦‚ä¸‹ä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.0.3.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>nacos-discovery-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.2.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ä¸ºäº†æ–¹ä¾¿èµ·è§ï¼Œç¬”è€…æŠŠæ§åˆ¶å™¨ã€æœåŠ¡æ³¨å†Œçš„ä»£ç éƒ½å†™åœ¨å¯åŠ¨ç±»<code>ProvideApplication</code>ä¸­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span>(scanBasePackages = <span class="string">"club.throwable.provide"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProvideApplication</span> <span class="keyword">implements</span> <span class="title">CommandLineRunner</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NacosInjected</span></span><br><span class="line">    <span class="keyword">private</span> NamingService namingService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;spring.application.name&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String applicationName;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;server.port&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> Integer serverPort;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ProvideApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(path = <span class="string">"/hello"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">hello</span><span class="params">(@RequestParam(name = <span class="string">"name"</span>)</span> String name) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">"%s say hello!"</span>, name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(String... args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// é€šè¿‡NamingæœåŠ¡æ³¨å†Œå®ä¾‹åˆ°æ³¨å†Œä¸­å¿ƒ</span></span><br><span class="line">        namingService.registerInstance(applicationName, <span class="string">"127.0.0.1"</span>, serverPort);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é…ç½®æ–‡ä»¶<code>application-provide.properties</code>å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.application.name</span>=<span class="string">provide-service</span></span><br><span class="line"><span class="meta">server.port</span>=<span class="string">9092</span></span><br><span class="line"><span class="meta">nacos.discovery.server-addr</span>=<span class="string">127.0.0.1:8848</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>spring.profiles.active=provide</code>å¯åŠ¨<code>ProvideApplication</code>ï¼Œå¯åŠ¨æˆåŠŸåç”¨æµè§ˆå™¨æ‰“å¼€<code>Nacos-Console</code>ï¼š</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/202001/s-b-n-7.png" alt=""></p><p>æš‚æ—¶å¯çŸ¥æœåŠ¡çš„æä¾›æ–¹å·²ç»æ³¨å†ŒæˆåŠŸã€‚æ¥ç€ç¼–å†™æœåŠ¡çš„æ¶ˆè´¹æ–¹ä»£ç ï¼Œå¼•å…¥çš„æœ€å°ä¾èµ–å’ŒæœåŠ¡æä¾›æ–¹å®Œå…¨ä¸€è‡´ï¼Œç¼–å†™å¯åŠ¨ç±»<code>ConsumeApplication</code>å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span>(scanBasePackages = <span class="string">"club.throwable.consume"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConsumeApplication</span> <span class="keyword">implements</span> <span class="title">CommandLineRunner</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NacosInjected</span></span><br><span class="line">    <span class="keyword">private</span> NamingService namingService;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ConsumeApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(String... args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// æ ¹æ®æœåŠ¡åä»æ³¨å†Œä¸­å¿ƒè·å–ä¸€ä¸ªå¥åº·çš„æœåŠ¡å®ä¾‹</span></span><br><span class="line">        Instance instance = namingService.selectOneHealthyInstance(<span class="string">"provide-service"</span>);</span><br><span class="line">        <span class="comment">// è¿™é‡Œåªæ˜¯ä¸ºäº†æ–¹ä¾¿æ‰æ–°å»ºRestTemplateå®ä¾‹</span></span><br><span class="line">        RestTemplate template = <span class="keyword">new</span> RestTemplate();</span><br><span class="line">        String url = String.format(<span class="string">"http://%s:%d/hello?name=throwable"</span>, instance.getIp(), instance.getPort());</span><br><span class="line">        String result = template.getForObject(url, String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        System.out.println(String.format(<span class="string">"è¯·æ±‚URL:%s,å“åº”ç»“æœ:%s"</span>, url, result));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¶ˆè´¹æœåŠ¡çš„é…ç½®æ–‡ä»¶<code>application-consume.properties</code>å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.application.name</span>=<span class="string">consume-service</span></span><br><span class="line"><span class="meta">server.port</span>=<span class="string">9091</span></span><br><span class="line"><span class="meta">nacos.discovery.server-addr</span>=<span class="string">127.0.0.1:8848</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>spring.profiles.active=consume</code>å¯åŠ¨<code>ConsumeApplication</code>ï¼Œ<code>CommandLineRunner</code>æ‰§è¡Œå®Œæ¯•åæ§åˆ¶å°æ‰“å°ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">è¯·æ±‚URL:http://127.0.0.1:9092/hello?name=throwable,å“åº”ç»“æœ:throwable say hello!</span><br></pre></td></tr></table></figure><p>è¿™ç§æ–¹å¼ä½¿ç”¨èµ·æ¥ä¼šæ„Ÿè§‰æ¨¡æ¿ä»£ç æ¯”è¾ƒå¤šï¼Œä¸å¤Ÿç®€æ´ã€‚å¦‚æœåœ¨<code>SpringCloud</code>ä½“ç³»ä¸­ï¼Œç»“åˆ<code>Feign</code>å®¢æˆ·ç«¯åˆ™å¯ä»¥çœç•¥è¿™äº›æ¨¡æ¿ä»£ç ã€‚</p><h2 id="SpirngBootåº”ç”¨ä½¿ç”¨Nacosç®¡ç†é…ç½®">SpirngBootåº”ç”¨ä½¿ç”¨Nacosç®¡ç†é…ç½®</h2><p>å¦‚æœä½¿ç”¨<code>Nacos</code>è¿›è¡Œé…ç½®ç®¡ç†ï¼Œåˆ™éœ€è¦å¼•å…¥<code>nacos-config-spring-boot-starter</code>ä¾èµ–ï¼Œç¬”è€…ç¼–å†™æœ¬æ–‡çš„æ—¶å€™ï¼ˆ2020-01-01ï¼‰ï¼Œè¯¥ä¾èµ–çš„æœ€æ–°ç‰ˆæœ¬ä¸º<code>0.2.4</code>ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>nacos-config-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>0.2.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æ–°å»ºä¸€ä¸ªå¯åŠ¨ç±»<code>ConfigApplication</code>å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@NacosPropertySource</span>(dataId = <span class="string">"example"</span>, autoRefreshed = <span class="keyword">true</span>)</span><br><span class="line"><span class="meta">@SpringBootApplication</span>(scanBasePackages = <span class="string">"club.throwable.config"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NacosValue</span>(value = <span class="string">"$&#123;counter:0&#125;"</span>, autoRefreshed = <span class="keyword">true</span>)</span><br><span class="line">    <span class="keyword">public</span> Long counter;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(ConfigApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(path = <span class="string">"/get"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">get</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> String.format(<span class="string">"Counter value:%d"</span>, counter);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¬”è€…å®šä¹‰äº†ä¸€ä¸ªé•¿æ•´å‹çš„è®¡æ•°å™¨ï¼Œè®¾ç½®äº†<code>autoRefreshed</code>ï¼ˆè‡ªåŠ¨åˆ·æ–°ï¼‰ä¸º<code>true</code>ï¼Œæ–°å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶<code>application-config.properties</code>ï¼š</p><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">spring.application.name</span>=<span class="string">config-service</span></span><br><span class="line"><span class="meta">server.port</span>=<span class="string">9093</span></span><br><span class="line"><span class="meta">nacos.config.server-addr</span>=<span class="string">127.0.0.1:8848</span></span><br></pre></td></tr></table></figure><p>ä½¿ç”¨<code>spring.profiles.active=config</code>å¯åŠ¨<code>ConfigApplication</code>ï¼Œå¯åŠ¨æˆåŠŸåé€šè¿‡<code>CURL</code>è°ƒç”¨ä¸‹é¢çš„æ¥å£ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Î» curl -X GET http://127.0.0.1:9093/get</span><br><span class="line">Counter value:0</span><br></pre></td></tr></table></figure><p>æ¥ç€é€šè¿‡<code>Nacos-Console</code>æ·»åŠ ä¸€ä¸ªé…ç½®ï¼š</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/202001/s-b-n-9.png" alt=""></p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/202001/s-b-n-8.png" alt=""></p><p>ç‚¹å‡»å‘å¸ƒæŒ‰é’®åå†æ¬¡è°ƒç”¨æ¥å£ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Î» curl -X GET http://127.0.0.1:9093/get</span><br><span class="line">Counter value:10086</span><br></pre></td></tr></table></figure><p>å¯è§è®¡æ•°å™¨çš„å€¼å·²ç»åŠ¨æ€åˆ·æ–°ã€‚é…ç½®é¡¹é‡Œé¢è¿˜æœ‰å¾ˆå¤šé«˜çº§é…ç½®å¦‚ï¼šæŒ‡å®šé…ç½®ç”Ÿæ•ˆçš„æœåŠ¡ã€<code>Beta</code>å‘å¸ƒç­‰ç­‰ï¼Œå¯ä»¥æŒ‰ç…§åˆé€‚çš„åœºæ™¯è¿›è¡Œè®¾ç½®ã€‚</p><p>å¦å¤–ï¼Œ<code>Nacos Server</code>æä¾›<code>Open API</code>ä»è€Œå¯ä»¥ä½¿ç”¨<code>HTTP</code>å®¢æˆ·ç«¯å°±å¯ä»¥è½»æ¾è¿›è¡Œé…ç½®æŸ¥è¯¢ã€é…ç½®æ›´æ–°å‘å¸ƒç­‰æ“ä½œï¼ˆ<strong>ç›®å‰è¿™äº›APIæ²¡æœ‰åšé‰´æƒï¼Œç¤¾åŒºä¹Ÿæœ‰äººæ›¾æå‡ºè¿™æ ·ä¼šå¼•å‘å®‰å…¨æ€§é—®é¢˜ï¼ŒNacoså®˜æ–¹å·²ç»ç«‹é¡¹åœ¨åç»­æ–°ç‰ˆæœ¬ä¸­åŠ å…¥é‰´æƒçš„åŠŸèƒ½ï¼Œç›®å‰å»ºè®®å±è”½æˆ–è€…ä»…å…è®¸å†…ç½‘è®¿é—®è¿™äº›Open API</strong>ï¼‰ï¼š</p><ul><li>è·å–é…ç½®ï¼š<code>curl -X GET http://127.0.0.1:8848/nacos/v1/cs/configs?dataId=${DATA_ID}&amp;group=${GROUP}</code></li><li>å‘å¸ƒé…ç½®ï¼š<code>curl -X POST http://127.0.0.1:8848/nacos/v1/cs/configs?dataId=${DATA_ID}&amp;group=${GROUP}&amp;content=${CONFIG_CONTENT}</code></li></ul><h2 id="å°ç»“">å°ç»“</h2><p>æœ¬æ–‡åªæ˜¯ç®€å•ä»‹ç»äº†<code>SpringBoot</code>ä¸­ä½¿ç”¨<code>Nacos</code>ä½œä¸ºæ³¨å†Œä¸­å¿ƒä»¥åŠè¿›è¡Œé…ç½®ç®¡ç†ã€‚<code>Nacos</code>é¡¹ç›®<code>Github</code>ä»“åº“å½“å‰ï¼ˆ2020-01-01ï¼‰çš„<code>star</code>æ•°å·²ç»æ¥è¿‘10000ï¼Œç¤¾åŒºä¹Ÿååˆ†æ´»è·ƒï¼Œ<code>Issues</code>å’Œäº¤æµç¾¤çš„å“åº”éƒ½ååˆ†è¿…é€Ÿã€‚åŠ ä¹‹<code>Netflix</code>çš„éƒ¨åˆ†å¼€æºäº§å“å¦‚<code>Eureka</code>ã€<code>Hystrix</code>ç­‰å·²ç»åœæ­¢è¿­ä»£ï¼Œä½†<code>Nacos</code>è¿˜åœ¨é£é€Ÿè¿­ä»£ï¼Œç”šè‡³å·²ç»åœ¨é˜¿é‡Œäº‘è¡ç”Ÿå‡ºå•†ä¸šç‰ˆæœ¬ï¼Œæ‰€ä»¥ç¬”è€…è®¤ä¸º<code>Nacos</code>å€¼å¾—ä½¿ç”¨ï¼Œåœ¨ç›¸å¯¹ç†Ÿæ‚‰å®ƒçš„å¤§éƒ¨åˆ†ç‰¹æ€§ä¹‹åä¼šä»˜ä¹‹äºç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨ã€‚</p><p>å‚è€ƒèµ„æ–™ï¼š</p><ul><li><a href="https://nacos.io/zh-cn/index.html" target="_blank" rel="noopener">Nacosæ–‡æ¡£</a></li></ul><p>æœ¬æ–‡çš„<code>Demo</code>é¡¹ç›®ï¼š</p><ul><li><a href="https://github.com/zjcscut/framework-mesh/tree/master/spring-boot-nacos" target="_blank" rel="noopener">spring-boot-nacos</a></li></ul><p>ä¸‹ä¸€ç¯‡åšæ–‡ä¼šä»‹ç»ä¸€ä¸‹<code>SOFAStack</code>ä¸­åŸºäº<code>SOFABoot</code>ã€<code>SOFARpc</code>ä»¥åŠ<code>Nacos</code>ç­‰ç»„ä»¶ä½œä¸ºåŸºç¡€æ¶æ„æ­å»ºä¸€å¥—å¾®æœåŠ¡çš„è¯¦ç»†è¿‡ç¨‹ã€‚</p><p>ï¼ˆæœ¬æ–‡å®Œ c-2-d e-a-20200101 23:11ï¼‰</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰æ&quot;&gt;å‰æ&lt;/h2&gt;
&lt;p&gt;æœ€è¿‘ç”±äºä¸šåŠ¡å‘å±•ï¼Œéœ€è¦è°ƒç ”ä¸€å¥—å®Œå–„å’Œä¸»æµçš„åŸºç¡€æ¶æ„ï¼Œè¿›è¡Œä¸­å°åŒ–ï¼ˆå¾®æœåŠ¡ï¼‰çš„å®æ–½ï¼Œè€ƒè™‘åˆ°æŠ€æœ¯æ ˆåˆ‡æ¢åˆ°&lt;a href=&quot;https://www.sofastack.tech&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;&lt;code&gt;SOFAStack&lt;/code&gt;&lt;/a&gt;ã€‚æ—¢ç„¶æ•´ä¸ªä½“ç³»éƒ½åˆ‡æ¢åˆ°èš‚èšé‡‘æœçš„æŠ€æœ¯æ ˆï¼Œé‚£ä¹ˆè‡ªç„¶è€ƒè™‘ä¸€äº›åŸºç¡€ç»„ä»¶å¦‚æœåŠ¡æ³¨å†Œå‘ç°ã€é…ç½®ç®¡ç†ç­‰éƒ½åˆ‡æ¢ä¸ºé˜¿é‡Œçš„æŠ€æœ¯æ ˆã€‚è€ƒè™‘åˆ°ç›®å‰æ¯”è¾ƒçƒ­çš„æœåŠ¡å‘ç°ç»„ä»¶æ˜¯&lt;a href=&quot;https://nacos.io&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;&lt;code&gt;Nacos&lt;/code&gt;&lt;/a&gt;ï¼Œéœ€è¦è°ƒç ”&lt;code&gt;SpringBoot&lt;/code&gt;æœåŠ¡æ¥å…¥&lt;code&gt;Nacos&lt;/code&gt;çš„å¯è¡Œæ€§ï¼Œä¸ºä»¥åå¼ºåˆ¶è¦æ±‚æ–°æœåŠ¡ä½¿ç”¨&lt;code&gt;SOFAStack&lt;/code&gt; + &lt;code&gt;Nacos&lt;/code&gt;çš„æŠ€æœ¯æ ˆè¿›è¡ŒæœåŠ¡å¼€å‘æ‰“ä¸‹åŸºç¡€ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/202001/s-b-n-1.png&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="SpringBoot" scheme="http://throwable.club/blog/categories/SpringBoot/"/>
    
      <category term="Nacos" scheme="http://throwable.club/blog/categories/SpringBoot/Nacos/"/>
    
    
      <category term="Nacos" scheme="http://throwable.club/blog/tags/Nacos/"/>
    
      <category term="SpringBoot" scheme="http://throwable.club/blog/tags/SpringBoot/"/>
    
  </entry>
  
  <entry>
    <title>èŠèŠJavaå†…çœIntrospector</title>
    <link href="http://throwable.club/2019/12/25/java-introspector-usage/"/>
    <id>http://throwable.club/2019/12/25/java-introspector-usage/</id>
    <published>2019-12-25T00:45:06.000Z</published>
    <updated>2020-01-18T07:07:04.344Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰æ">å‰æ</h2><p>è¿™ç¯‡æ–‡ç« ä¸»è¦åˆ†æä¸€ä¸‹<code>Introspector</code>(å†…çœ)çš„ç”¨æ³•ã€‚<code>Introspector</code>æ˜¯ä¸€ä¸ªä¸“é—¨å¤„ç†<code>JavaBean</code>çš„å·¥å…·ç±»ï¼Œç”¨æ¥è·å–<code>JavaBean</code>é‡Œæè¿°ç¬¦å·ï¼Œå¸¸ç”¨çš„<code>JavaBean</code>çš„æè¿°ç¬¦å·ç›¸å…³ç±»æœ‰<code>BeanInfo</code>ã€<code>PropertyDescriptor</code>ï¼Œ<code>MethodDescriptor</code>ã€<code>BeanDescriptor</code>ã€<code>EventSetDescriptor</code>å’Œ<code>ParameterDescriptor</code>ã€‚ä¸‹é¢ä¼šæ…¢æ…¢åˆ†æè¿™äº›ç±»çš„ä½¿ç”¨æ–¹å¼ï¼Œä»¥åŠ<code>Introspector</code>çš„ä¸€äº›ç‰¹ç‚¹ã€‚</p><a id="more"></a><h2 id="JavaBeanæ˜¯ä»€ä¹ˆ">JavaBeanæ˜¯ä»€ä¹ˆ</h2><p><code>JavaBean</code>æ˜¯ä¸€ç§ç‰¹æ®Šï¼ˆå…¶å®è¯´æ™®é€šä¹Ÿå¯ä»¥ï¼Œä¹Ÿä¸æ˜¯ååˆ†ç‰¹æ®Šï¼‰çš„ç±»ï¼Œä¸»è¦ç”¨äºä¼ é€’æ•°æ®ä¿¡æ¯ï¼Œè¿™ç§ç±»ä¸­çš„æ–¹æ³•ä¸»è¦ç”¨äºè®¿é—®ç§æœ‰çš„å­—æ®µï¼Œä¸”æ–¹æ³•åç¬¦åˆæŸç§å‘½åè§„åˆ™ï¼ˆå­—æ®µéƒ½æ˜¯ç§æœ‰ï¼Œæ¯ä¸ªå­—æ®µå…·å¤‡<code>Setter</code>å’Œ<code>Getter</code>æ–¹æ³•ï¼Œæ–¹æ³•å’Œå­—æ®µå‘½åæ»¡è¶³é¦–å­—æ¯å°å†™é©¼å³°å‘½åè§„åˆ™ï¼‰ã€‚å¦‚æœåœ¨ä¸¤ä¸ªæ¨¡å—ä¹‹é—´ä¼ é€’ä¿¡æ¯ï¼Œå¯ä»¥å°†ä¿¡æ¯å°è£…è¿›<code>JavaBean</code>ä¸­ï¼Œè¿™ç§å¯¹è±¡ç§°ä¸ºå€¼å¯¹è±¡(<code>Value Object</code>)æˆ–è€…<code>VO</code>ã€‚è¿™äº›ä¿¡æ¯å‚¨å­˜åœ¨ç±»çš„ç§æœ‰å˜é‡ä¸­ï¼Œé€šè¿‡<code>Setter</code>ã€<code>Getter</code>æ–¹æ³•è·å¾—ã€‚<code>JavaBean</code>çš„ä¿¡æ¯åœ¨<code>Introspector</code>é‡Œå¯¹åº”çš„æ¦‚å¿µæ˜¯<code>BeanInfo</code>ï¼Œå®ƒåŒ…å«äº†<code>JavaBean</code>æ‰€æœ‰çš„<code>Descriptor</code>(æè¿°ç¬¦)ï¼Œä¸»è¦æœ‰<code>PropertyDescriptor</code>ï¼Œ<code>MethodDescriptor</code>(<code>MethodDescriptor</code>é‡Œé¢åŒ…å«<code>ParameterDescriptor</code>)ã€<code>BeanDescriptor</code>å’Œ<code>EventSetDescriptor</code>ã€‚</p><h2 id="å±æ€§Fieldå’Œå±æ€§æè¿°PropertiesDescriptorçš„åŒºåˆ«">å±æ€§Fieldå’Œå±æ€§æè¿°PropertiesDescriptorçš„åŒºåˆ«</h2><p>å¦‚æœæ˜¯ä¸¥æ ¼çš„<code>JavaBean</code>(<code>Field</code>åç§°ä¸é‡å¤ï¼Œå¹¶ä¸”<code>Field</code>å…·å¤‡<code>Setter</code>å’Œ<code>Getter</code>æ–¹æ³•)ï¼Œå®ƒçš„<code>PropertyDescriptor</code>ä¼šé€šè¿‡è§£æ<code>Setter</code>å’Œ<code>Getter</code>æ–¹æ³•ï¼Œåˆå¹¶è§£æç»“æœï¼Œæœ€ç»ˆå¾—åˆ°å¯¹åº”çš„<code>PropertyDescriptor</code>å®ä¾‹ã€‚æ‰€ä»¥<code>PropertyDescriptor</code>åŒ…å«äº†å±æ€§åç§°å’Œå±æ€§çš„<code>Setter</code>å’Œ<code>Getter</code>æ–¹æ³•(å¦‚æœå­˜åœ¨çš„è¯)ã€‚</p><h2 id="å†…çœIntrospectorå’Œåå°„Reflectionçš„åŒºåˆ«">å†…çœIntrospectorå’Œåå°„Reflectionçš„åŒºåˆ«</h2><ul><li><code>Reflection</code>ï¼šåå°„å°±æ˜¯è¿è¡Œæ—¶è·å–ä¸€ä¸ªç±»çš„æ‰€æœ‰ä¿¡æ¯ï¼Œå¯ä»¥è·å–åˆ°ç±»çš„æ‰€æœ‰å®šä¹‰çš„ä¿¡æ¯ï¼ˆåŒ…æ‹¬æˆå‘˜å˜é‡ï¼Œæˆå‘˜æ–¹æ³•ï¼Œæ„é€ å™¨ç­‰ï¼‰å¯ä»¥æ“çºµç±»çš„å­—æ®µã€æ–¹æ³•ã€æ„é€ å™¨ç­‰éƒ¨åˆ†ã€‚å¯ä»¥æƒ³è±¡ä¸ºé•œé¢åå°„æˆ–è€…ç…§é•œå­ï¼Œè¿™æ ·çš„æ“ä½œæ˜¯å¸¦æœ‰å®¢è§‚è‰²å½©çš„ï¼Œä¹Ÿå°±æ˜¯åå°„è·å–åˆ°çš„ç±»ä¿¡æ¯æ˜¯å¿…å®šæ­£ç¡®çš„ã€‚</li><li><code>Introspector</code>ï¼šå†…çœåŸºäºåå°„å®ç°ï¼Œä¸»è¦ç”¨äºæ“ä½œ<code>JavaBean</code>ï¼ŒåŸºäº<code>JavaBean</code>çš„è§„èŒƒè¿›è¡Œ<code>Bean</code>ä¿¡æ¯æè¿°ç¬¦çš„è§£æï¼Œä¾æ®äºç±»çš„<code>Setter</code>å’Œ<code>Getter</code>æ–¹æ³•ï¼Œå¯ä»¥è·å–åˆ°ç±»çš„æè¿°ç¬¦ã€‚å¯ä»¥æƒ³è±¡ä¸ºâ€œè‡ªæˆ‘åçœâ€ï¼Œè¿™æ ·çš„æ“ä½œå¸¦æœ‰ä¸»è§‚çš„è‰²å½©ï¼Œä¸ä¸€å®šæ˜¯æ­£ç¡®çš„(å¦‚æœä¸€ä¸ªç±»ä¸­çš„å±æ€§æ²¡æœ‰<code>Setter</code>å’Œ<code>Getter</code>æ–¹æ³•ï¼Œæ— æ³•ä½¿ç”¨å†…çœ)ã€‚</li></ul><h2 id="å¸¸ç”¨çš„å†…çœç›¸å…³ç±»">å¸¸ç”¨çš„å†…çœç›¸å…³ç±»</h2><p>ä¸»è¦ä»‹ç»ä¸€ä¸‹å‡ ä¸ªæ ¸å¿ƒç±»æ‰€æä¾›çš„æ–¹æ³•ã€‚</p><h3 id="Introspector">Introspector</h3><p><code>Introspector</code>ç±»ä¼¼äº<code>BeanInfo</code>çš„é™æ€å·¥å‚ç±»ï¼Œä¸»è¦æ˜¯æä¾›é™æ€æ–¹æ³•é€šè¿‡<code>Class</code>å®ä¾‹è·å–åˆ°<code>BeanInfo</code>ï¼Œå¾—åˆ°<code>BeanInfo</code>ä¹‹åï¼Œå°±èƒ½å¤Ÿè·å–åˆ°å…¶ä»–æè¿°ç¬¦ã€‚ä¸»è¦æ–¹æ³•ï¼š</p><ul><li><code>public static BeanInfo getBeanInfo(Class&lt;?&gt; beanClass)</code>ï¼šé€šè¿‡<code>Class</code>å®ä¾‹è·å–åˆ°<code>BeanInfo</code>å®ä¾‹ã€‚</li></ul><h3 id="BeanInfo">BeanInfo</h3><p><code>BeanInfo</code>æ˜¯ä¸€ä¸ªæ¥å£ï¼Œå…·ä½“å®ç°æ˜¯<code>GenericBeanInfo</code>ï¼Œé€šè¿‡è¿™ä¸ªæ¥å£å¯ä»¥è·å–ä¸€ä¸ªç±»çš„å„ç§ç±»å‹çš„æè¿°ç¬¦ã€‚ä¸»è¦æ–¹æ³•ï¼š</p><ul><li><code>BeanDescriptor getBeanDescriptor()</code>ï¼šè·å–<code>JavaBean</code>æè¿°ç¬¦ã€‚</li><li><code>EventSetDescriptor[] getEventSetDescriptors()</code>ï¼šè·å–<code>JavaBean</code>çš„æ‰€æœ‰çš„<code>EventSetDescriptor</code>ã€‚</li><li><code>PropertyDescriptor[] getPropertyDescriptors()</code>ï¼šè·å–<code>JavaBean</code>çš„æ‰€æœ‰çš„<code>PropertyDescriptor</code>ã€‚</li><li><code>MethodDescriptor[] getMethodDescriptors()</code>ï¼šè·å–<code>JavaBean</code>çš„æ‰€æœ‰çš„<code>MethodDescriptor</code>ã€‚</li></ul><p>è¿™é‡Œè¦æ³¨æ„ä¸€ç‚¹ï¼Œé€šè¿‡<code>BeanInfo#getPropertyDescriptors()</code>è·å–åˆ°çš„<code>PropertyDescriptor</code>æ•°ç»„ä¸­ï¼Œé™¤äº†<code>Bean</code>å±æ€§çš„ä¹‹å¤–ï¼Œè¿˜ä¼šå¸¦æœ‰ä¸€ä¸ªå±æ€§åä¸º<code>class</code>çš„<code>PropertyDescriptor</code>å®ä¾‹ï¼Œå®ƒçš„æ¥æºæ˜¯<code>Class</code>çš„<code>getClass</code>æ–¹æ³•ï¼Œå¦‚æœä¸éœ€è¦è¿™ä¸ªå±æ€§é‚£ä¹ˆæœ€å¥½åˆ¤æ–­åè¿‡æ»¤ã€‚</p><h3 id="PropertyDescriptor">PropertyDescriptor</h3><p><code>PropertyDescriptor</code>ç±»è¡¨ç¤º<code>JavaBean</code>ç±»é€šè¿‡å­˜å‚¨å™¨(<code>Setter</code>å’Œ<code>Getter</code>)å¯¼å‡ºä¸€ä¸ªå±æ€§ï¼Œå®ƒåº”è¯¥æ˜¯å†…çœä½“ç³»ä¸­æœ€å¸¸è§çš„ç±»ã€‚ä¸»è¦æ–¹æ³•ï¼š</p><ul><li><code>synchronized Class&lt;?&gt; getPropertyType()</code>ï¼šè·å¾—å±æ€§çš„<code>Class</code>å¯¹è±¡ã€‚</li><li><code>synchronized Method getReadMethod()</code>ï¼šè·å¾—ç”¨äºè¯»å–å±æ€§å€¼çš„æ–¹æ³•ï¼›</li><li><code>synchronized Method getWriteMethod()</code>ï¼šè·å¾—ç”¨äºå†™å…¥å±æ€§å€¼çš„æ–¹æ³•ã€‚</li><li><code>int hashCode()</code>ï¼šè·å–å¯¹è±¡çš„å“ˆå¸Œå€¼ã€‚</li><li><code>synchronized void setReadMethod(Method readMethod)</code>ï¼šè®¾ç½®ç”¨äºè¯»å–å±æ€§(<code>Getter</code>)å€¼çš„æ–¹æ³•ã€‚</li><li><code>synchronized void setWriteMethod(Method writeMethod)</code>ï¼šè®¾ç½®ç”¨äºå†™å…¥å±æ€§å€¼(<code>Setter</code>)çš„æ–¹æ³•ã€‚</li></ul><p>ä¸¾ä¸ªä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        BeanInfo beanInfo = Introspector.getBeanInfo(Person<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">        PropertyDescriptor[] propertyDescriptors = beanInfo.getPropertyDescriptors();</span><br><span class="line">        <span class="keyword">for</span> (PropertyDescriptor propertyDescriptor : propertyDescriptors) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!<span class="string">"class"</span>.equals(propertyDescriptor.getName())) &#123;</span><br><span class="line">                System.out.println(propertyDescriptor.getName());</span><br><span class="line">                System.out.println(propertyDescriptor.getWriteMethod().getName());</span><br><span class="line">                System.out.println(propertyDescriptor.getReadMethod().getName());</span><br><span class="line">                System.out.println(<span class="string">"======================="</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Long id;</span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line">        <span class="keyword">private</span> Integer age;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Long <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> id;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.id = id;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> name;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setName</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.name = name;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> Integer <span class="title">getAge</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> age;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAge</span><span class="params">(Integer age)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.age = age;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">age</span><br><span class="line">setAge</span><br><span class="line">getAge</span><br><span class="line">=======================</span><br><span class="line">id</span><br><span class="line">setId</span><br><span class="line">getId</span><br><span class="line">=======================</span><br><span class="line">name</span><br><span class="line">setName</span><br><span class="line">getName</span><br><span class="line">=======================</span><br></pre></td></tr></table></figure><h2 id="ä¸æ­£å½“ä½¿ç”¨Introspectorä¼šå¯¼è‡´å†…å­˜æº¢å‡º">ä¸æ­£å½“ä½¿ç”¨Introspectorä¼šå¯¼è‡´å†…å­˜æº¢å‡º</h2><p>å¦‚æœæ¡†æ¶æˆ–è€…ç¨‹åºç”¨åˆ°äº†<code>JavaBeans Introspector</code>ï¼Œé‚£ä¹ˆå°±ç›¸å½“äºå¯ç”¨äº†ä¸€ä¸ªç³»ç»Ÿçº§åˆ«çš„ç¼“å­˜ï¼Œè¿™ä¸ªç¼“å­˜ä¼šå­˜æ”¾ä¸€äº›æ›¾åŠ è½½å¹¶åˆ†æè¿‡çš„<code>Javabean</code>çš„å¼•ç”¨ï¼Œå½“<code>web</code>æœåŠ¡å™¨å…³é—­çš„æ—¶å€™ï¼Œç”±äºè¿™ä¸ªç¼“å­˜ä¸­å­˜æ”¾ç€è¿™äº›<code>Javabean</code>çš„å¼•ç”¨ï¼Œæ‰€ä»¥åƒåœ¾å›æ”¶å™¨ä¸èƒ½å¯¹<code>Web</code>å®¹å™¨ä¸­çš„<code>JavaBean</code>å¯¹è±¡è¿›è¡Œå›æ”¶ï¼Œå¯¼è‡´å†…å­˜è¶Šæ¥è¶Šå¤§ã€‚è¿˜æœ‰ä¸€ç‚¹å€¼å¾—æ³¨æ„ï¼Œæ¸…é™¤<code>Introspector</code>ç¼“å­˜çš„å”¯ä¸€æ–¹å¼æ˜¯åˆ·æ–°æ•´ä¸ªç¼“å­˜ç¼“å†²åŒºï¼Œè¿™æ˜¯å› ä¸º<code>JDK</code>æ²¡æ³•åˆ¤æ–­å“ªäº›æ˜¯å±äºå½“å‰çš„åº”ç”¨çš„å¼•ç”¨ï¼Œæ‰€ä»¥åˆ·æ–°æ•´ä¸ª<code>Introspector</code>ç¼“å­˜ç¼“å†²åŒºä¼šå¯¼è‡´æŠŠæœåŠ¡å™¨çš„æ‰€æœ‰åº”ç”¨çš„<code>Introspector</code>ç¼“å­˜éƒ½åˆ æ‰ã€‚<code>Spring</code>ä¸­æä¾›çš„<code>org.springframework.web.util.IntrospectorCleanupListener</code>å°±æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå®ƒä¼šåœ¨<code>Web</code>æœåŠ¡å™¨åœæ­¢çš„æ—¶å€™ï¼Œæ¸…ç†ä¸€ä¸‹è¿™ä¸ª<code>Introspector</code>ç¼“å­˜ï¼Œä½¿é‚£äº›<code>Javabean</code>èƒ½è¢«åƒåœ¾å›æ”¶å™¨æ­£ç¡®å›æ”¶ã€‚</p><p>ä¹Ÿå°±æ˜¯è¯´<code>JDK</code>çš„<code>Introspector</code>ç¼“å­˜ç®¡ç†æ˜¯æœ‰ä¸€å®šç¼ºé™·çš„ã€‚ä½†æ˜¯å¦‚æœä½¿ç”¨åœ¨<code>Spring</code>ä½“ç³»åˆ™ä¸ä¼šå‡ºç°è¿™ç§é—®é¢˜ï¼Œå› ä¸º<code>Spring</code>æŠŠ<code>Introspector</code>ç¼“å­˜çš„ç®¡ç†ç§»äº¤åˆ°<code>Spring</code>è‡ªèº«è€Œä¸æ˜¯<code>JDK</code>ï¼ˆæˆ–è€…åœ¨<code>Web</code>å®¹å™¨é”€æ¯åå®Œå…¨ä¸ç®¡ï¼‰ï¼Œåœ¨åŠ è½½å¹¶åˆ†æå®Œæ‰€æœ‰ç±»ä¹‹åï¼Œä¼šé’ˆå¯¹ç±»åŠ è½½å™¨å¯¹<code>Introspector</code>ç¼“å­˜è¿›è¡Œæ¸…ç†ï¼Œé¿å…å†…å­˜æ³„æ¼çš„é—®é¢˜ï¼Œè¯¦æƒ…å¯ä»¥çœ‹<code>CachedIntrospectionResults</code>å’Œ<code>SpringBoot</code>åˆ·æ–°ä¸Šä¸‹æ–‡çš„æ–¹æ³•<code>AbstractApplicationContext#refresh()</code>ä¸­<code>finally</code>ä»£ç å—ä¸­å­˜åœ¨æ¸…ç†ç¼“å­˜çš„æ–¹æ³•<code>AbstractApplicationContext#resetCommonCaches();</code>ã€‚ä½†æ˜¯æœ‰å¾ˆå¤šç¨‹åºå’Œæ¡†æ¶åœ¨ä½¿ç”¨äº†<code>JavaBeans Introspector</code>ä¹‹åï¼Œéƒ½æ²¡æœ‰è¿›è¡Œæ¸…ç†å·¥ä½œï¼Œæ¯”å¦‚<code>Quartzã€Struts</code>ç­‰ï¼Œè¿™ç±»æ“ä½œä¼šæˆä¸ºå†…å­˜æ³„æ¼çš„éšæ‚£ã€‚</p><h1>å°ç»“</h1><ul><li>åœ¨æ ‡å‡†çš„<code>JavaBean</code>ä¸­ï¼Œå¯ä»¥è€ƒè™‘ä½¿ç”¨<code>Introspector</code>ä½“ç³»è§£æ<code>JavaBean</code>ï¼Œä¸»è¦æ˜¯æ–¹ä¾¿ä½¿ç”¨åå°„ä¹‹å‰çš„æ—¶å€™å¿«é€Ÿè·å–åˆ°<code>JavaBean</code>çš„<code>Setter</code>å’Œ<code>Getter</code>æ–¹æ³•ã€‚</li><li>åœ¨<code>Spring</code>ä½“ç³»ä¸­ï¼Œä¸ºäº†é˜²æ­¢<code>JDK</code>å¯¹å†…çœä¿¡æ¯çš„ç¼“å­˜æ— æ³•è¢«åƒåœ¾å›æ”¶æœºåˆ¶å›æ”¶å¯¼è‡´å†…å­˜æº¢å‡ºï¼Œä¸»è¦çš„æ“ä½œé™¤äº†å¯ä»¥é€šè¿‡é…ç½®<code>IntrospectorCleanupListener</code>é¢„é˜²ï¼Œè¿˜æœ‰å¦å¤–ä¸€ç§æ–¹å¼ï¼Œå°±æ˜¯é€šè¿‡<code>CachedIntrospectionResults</code>ç±»è‡ªè¡Œç®¡ç†<code>Introspector</code>ä¸­çš„ç¼“å­˜(è¿™ç§æ–¹å¼æ‰æ˜¯ä¼˜é›…çš„æ–¹å¼ï¼Œè¿™æ ·å¯ä»¥é¿å…åˆ·æ–°æ•´ä¸ª<code>Introspector</code>çš„ç¼“å­˜ç¼“å†²åŒºè€Œå¯¼è‡´å…¶ä»–åº”ç”¨çš„<code>Introspector</code>ä¹Ÿè¢«æ¸…ç©º)ï¼Œ<strong>ä¹Ÿå°±æ˜¯æŠŠJdkè‡ªè¡Œç®¡ç†çš„Introspectorç›¸å…³ç¼“å­˜äº¤ç»™Springè‡ªå·±å»ç®¡ç†</strong>ã€‚åœ¨<code>SpringBoot</code>åˆ·æ–°ä¸Šä¸‹æ–‡çš„æ–¹æ³•<code>AbstractApplicationContext#refresh()</code>ä¸­finallyä»£ç å—ä¸­å­˜åœ¨æ¸…ç†ç¼“å­˜çš„æ–¹æ³•<code>AbstractApplicationContext#resetCommonCaches();</code>ï¼Œé‡Œé¢è°ƒç”¨åˆ°çš„<code>CachedIntrospectionResults#clearClassLoader(getClassLoader())</code>æ–¹æ³•å°±æ˜¯æ¸…ç†æŒ‡å®šçš„<code>ClassLoader</code>ä¸‹çš„æ‰€æœ‰<code>Introspector</code>ä¸­çš„ç¼“å­˜çš„å¼•ç”¨ã€‚</li></ul><p>ï¼ˆæœ¬æ–‡å®Œ e-a-20191225 c-1-d æ›´æ–°äº†åšå®¢ä¸»é¢˜ï¼Œæ„Ÿè§‰æ¯”ä»¥å‰å¥½çœ‹ä¸€ç‚¹ç‚¹â€¦ï¼‰</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰æ&quot;&gt;å‰æ&lt;/h2&gt;
&lt;p&gt;è¿™ç¯‡æ–‡ç« ä¸»è¦åˆ†æä¸€ä¸‹&lt;code&gt;Introspector&lt;/code&gt;(å†…çœ)çš„ç”¨æ³•ã€‚&lt;code&gt;Introspector&lt;/code&gt;æ˜¯ä¸€ä¸ªä¸“é—¨å¤„ç†&lt;code&gt;JavaBean&lt;/code&gt;çš„å·¥å…·ç±»ï¼Œç”¨æ¥è·å–&lt;code&gt;JavaBean&lt;/code&gt;é‡Œæè¿°ç¬¦å·ï¼Œå¸¸ç”¨çš„&lt;code&gt;JavaBean&lt;/code&gt;çš„æè¿°ç¬¦å·ç›¸å…³ç±»æœ‰&lt;code&gt;BeanInfo&lt;/code&gt;ã€&lt;code&gt;PropertyDescriptor&lt;/code&gt;ï¼Œ&lt;code&gt;MethodDescriptor&lt;/code&gt;ã€&lt;code&gt;BeanDescriptor&lt;/code&gt;ã€&lt;code&gt;EventSetDescriptor&lt;/code&gt;å’Œ&lt;code&gt;ParameterDescriptor&lt;/code&gt;ã€‚ä¸‹é¢ä¼šæ…¢æ…¢åˆ†æè¿™äº›ç±»çš„ä½¿ç”¨æ–¹å¼ï¼Œä»¥åŠ&lt;code&gt;Introspector&lt;/code&gt;çš„ä¸€äº›ç‰¹ç‚¹ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Java" scheme="http://throwable.club/blog/categories/Java/"/>
    
      <category term="Introspector" scheme="http://throwable.club/blog/categories/Java/Introspector/"/>
    
    
      <category term="Java" scheme="http://throwable.club/blog/tags/Java/"/>
    
      <category term="Introspector" scheme="http://throwable.club/blog/tags/Introspector/"/>
    
  </entry>
  
  <entry>
    <title>Goè¯­è¨€åŸºæœ¬ç¯å¢ƒå˜é‡ä¸ä¾èµ–ç®¡ç†</title>
    <link href="http://throwable.club/2019/12/23/golang-module-usage/"/>
    <id>http://throwable.club/2019/12/23/golang-module-usage/</id>
    <published>2019-12-22T16:29:00.000Z</published>
    <updated>2019-12-22T16:36:18.310Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰æ">å‰æ</h2><p>æœ€è¿‘å¼€å§‹ç³»ç»Ÿå­¦ä¹ ä¸€ä¸‹<code>Golang</code>è¿™ä¹ˆæ–°è¯­è¨€ï¼Œè®°å½•ä¸€ä¸‹å®ƒçš„åŸºæœ¬ç¯å¢ƒå˜é‡é…ç½®ä»¥åŠä¾èµ–ç®¡ç†æ–¹å¼ã€‚ç¼–å†™æœ¬æ–‡çš„æ—¶å€™ä½¿ç”¨çš„<code>Golang</code>ç‰ˆæœ¬ä¸º<code>go1.13.5 windows/amd64</code>ï¼Œå…¶ä»–ç‰ˆæœ¬ä¸ä¸€å®šä¿è¯é€‚åˆæœ¬æ–‡çš„å†…å®¹ã€‚å› ä¸ºä¹ æƒ¯ï¼Œå¯èƒ½æœ‰æ—¶å€™æŠŠ<code>Go</code>è¯­è¨€ç§°ä¸º<code>Go</code>ï¼Œæœ‰æ—¶å€™ç§°ä¸º<code>Golang</code>ã€‚</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201912/Golang.jpg" alt=""></p><a id="more"></a><h2 id="ç†è§£ä¸€ä¸‹Golangçš„ç¯å¢ƒå˜é‡">ç†è§£ä¸€ä¸‹Golangçš„ç¯å¢ƒå˜é‡</h2><p>å®‰è£…å®Œ<code>Golang</code>ä¹‹åï¼Œå¯ä»¥é€šè¿‡<code>go env</code>å‘½ä»¤æŸ¥çœ‹ç¯å¢ƒå˜é‡é…ç½®ï¼Œä¸‹é¢æ˜¯ç¬”è€…æ‰§è¡Œæ­¤å‘½ä»¤çš„ç»“æœï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">Î» go env</span><br><span class="line">set GO111MODULE=</span><br><span class="line">set GOARCH=amd64</span><br><span class="line">set GOBIN=</span><br><span class="line">set GOCACHE=C:\Users\doge\AppData\Local\go-build</span><br><span class="line">set GOENV=C:\Users\doge\AppData\Roaming\go\env</span><br><span class="line">set GOEXE=.exe</span><br><span class="line">set GOFLAGS=</span><br><span class="line">set GOHOSTARCH=amd64</span><br><span class="line">set GOHOSTOS=windows</span><br><span class="line">set GONOPROXY=</span><br><span class="line">set GONOSUMDB=</span><br><span class="line">set GOOS=windows</span><br><span class="line">set GOPATH=C:\Users\doge\go</span><br><span class="line">set GOPRIVATE=</span><br><span class="line">set GOPROXY=https://goproxy.cn,direct</span><br><span class="line">set GOROOT=I:\Environment\Go</span><br><span class="line">set GOSUMDB=sum.golang.org</span><br><span class="line">set GOTMPDIR=</span><br><span class="line">set GOTOOLDIR=I:\Environment\Go\pkg\tool\windows_amd64</span><br><span class="line">set GCCGO=gccgo</span><br><span class="line">set AR=ar</span><br><span class="line">set CC=gcc</span><br><span class="line">set CXX=g++</span><br><span class="line">set CGO_ENABLED=1</span><br><span class="line">set GOMOD=</span><br><span class="line">set CGO_CFLAGS=-g -O2</span><br><span class="line">set CGO_CPPFLAGS=</span><br><span class="line">set CGO_CXXFLAGS=-g -O2</span><br><span class="line">set CGO_FFLAGS=-g -O2</span><br><span class="line">set CGO_LDFLAGS=-g -O2</span><br><span class="line">set PKG_CONFIG=pkg-config</span><br><span class="line">set GOGCCFLAGS=-m64 -mthreads -fmessage-length=0 -fdebug-prefix-map=C:\Users\doge\AppData\Local\Temp\go-build779409438=/tmp/go-build -gno-record-gcc-switches</span><br></pre></td></tr></table></figure><p>åœ¨æ—¥å¸¸å¼€å‘ä¸­ï¼Œæˆ‘ä»¬éœ€è¦é‡ç‚¹å…³æ³¨<code>GOPROXY</code>ã€<code>GOROOT</code>ã€<code>GOPATH</code>å’Œ<code>GOBIN</code>ï¼Œå…¶ä»–é…ç½®é¡¹å¯ä»¥åœ¨éœ€è¦çš„æ—¶å€™å†æŸ¥è¯¢æ–‡æ¡£è¿›è¡Œé…ç½®ã€‚</p><h3 id="GOPROXY">GOPROXY</h3><p><code>GOPROXY</code>å°±æ˜¯è®¾ç½®<code>Golang</code>çš„å…¨å±€ä»£ç†ã€‚åœ¨ä¸‹è½½ä¾èµ–åŒ…çš„æ—¶å€™ï¼Œä¸€èˆ¬æ˜¯è®¿é—®<code>github</code>çš„ä»“åº“ï¼Œå›½å†…çš„ç¯å¢ƒå¾ˆå®¹æ˜“è¢«å¢™ï¼Œæ‰€ä»¥æœ€å¥½è®¾ç½®ä¸€ä¸ªé€Ÿåº¦å¿«çš„ä»£ç†ã€‚<code>Go</code>åœ¨æ­¤ç‰ˆæœ¬ä¸­<code>GOPROXY</code>çš„é»˜è®¤å€¼ä¸º<code>https://proxy.golang.org</code>ï¼Œå›½å†…æ˜¯æ— æ³•è®¿é—®çš„ã€‚å› æ­¤ï¼Œè¿™é‡Œæ¨èä½¿ç”¨ä¸ƒç‰›äº‘çš„ä»£ç†<a href="https://goproxy.cn" target="_blank" rel="noopener">https://goproxy.cn</a>ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">go env -w GOPROXY=https://goproxy.cn,direct</span><br></pre></td></tr></table></figure><p>è®¾ç½®å®Œæ­¤ä»£ç†ä¹‹åï¼Œä¸‹è½½ä¾èµ–çš„é€Ÿåº¦å°±èƒ½ç›¸å¯¹æ­£å¸¸ã€‚</p><h3 id="GOROOT">GOROOT</h3><p><code>GOROOT</code>å…¶å®å°±æ˜¯<code>Golang</code>å®‰è£…çš„ç»å¯¹è·¯å¾„ï¼Œä¾‹å¦‚ç¬”è€…æŠŠä»–å®‰è£…åœ¨<code>I:\Environment\Go</code>ç›®å½•ä¸‹ï¼Œæ‰€ä»¥ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Î» go env</span><br><span class="line">...</span><br><span class="line">set GOROOT=I:\Environment\Go</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p><code>GOROOT</code>éœ€è¦åŠ å…¥åˆ°ç³»ç»Ÿå˜é‡<code>Path</code>é‡Œé¢ï¼Œæ·»åŠ æˆåŠŸåæ‰èƒ½åœ¨å‘½ä»¤è¡Œä½¿ç”¨<code>go [Command]</code>ã€‚</p><h3 id="GOPATHå’ŒGOBIN">GOPATHå’ŒGOBIN</h3><p><code>GOPATH</code>å¯ä»¥ç®€å•ç†è§£ä¸ºå·¥ä½œç›®å½•ï¼Œå¦‚æœç”¨è¿‡<code>Eclipse</code>ï¼Œé‚£ä¹ˆ<code>GOPATH</code>å¯ä»¥ç±»æ¯”ä¸º<code>Eclipse</code>ä¸­çš„<code>WorkSpace</code>çš„æ¦‚å¿µã€‚<code>GOPATH</code>ç›®å½•çº¦å®šç”±ä¸‰ä¸ªå­ç›®å½•ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$GOPATH</span><br><span class="line">  - src  ---  å­˜æ”¾æºä»£ç ï¼Œ<span class="keyword">go</span> runã€<span class="keyword">go</span> installç­‰å‘½ä»¤å°±æ˜¯åœ¨å½“å‰çš„å·¥ä½œè·¯å¾„ä¸­æ‰§è¡Œï¼ˆä¹Ÿå°±æ˜¯è¿™äº›å‘½ä»¤æ‰§è¡Œçš„ç›®æ ‡æ–‡ä»¶å¤¹å°±æ˜¯è¿™ä¸ªsrcæ–‡ä»¶å¤¹ï¼‰</span><br><span class="line">  - pkg  ---  å­˜æ”¾ç¼–è¯‘æ—¶ç”Ÿæˆçš„ä¸­é—´æ–‡ä»¶</span><br><span class="line">  - bin  ---  å­˜æ”¾ç¼–è¯‘åç”Ÿæˆçš„å¯æ‰§è¡Œæ–‡ä»¶</span><br></pre></td></tr></table></figure><p><code>GOPATH</code>å˜é‡å¯ä»¥è®¾ç½®å¤šä¸ªå€¼ï¼Œå¤šä¸ªå€¼ä¹‹é—´ä½¿ç”¨ç‰¹å®šçš„åˆ†éš”ç¬¦éš”å¼€ï¼Œä¾‹å¦‚åœ¨<code>Windows</code>ç³»ç»Ÿï¼Œåˆ†éš”ç¬¦æ˜¯è‹±æ–‡çš„åˆ†å·<code>;</code>ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Î» go env</span><br><span class="line">...</span><br><span class="line">set GOPATH=C:\Users\doge\go;I:G-Projects</span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼š<code>go get</code>å‘½ä»¤ä¸‹è½½çš„ä¾èµ–åŒ…ä¼šä¸‹è½½åœ¨<code>GOPATH</code>æŒ‡å®šçš„ç¬¬ä¸€ä¸ªå€¼å¯¹åº”çš„ç›®å½•ä¸­ï¼Œä¹Ÿå°±æ˜¯<code>$Users/$User/go</code>ç›®å½•ä¸‹ã€‚</p><p><code>GOBIN</code>ç”¨äºæŒ‡å®š<code>go install</code>ç›®æ ‡ä¿å­˜è·¯å¾„ï¼Œç›®çš„æ˜¯é¿å…å°†æ‰€æœ‰å·¥ä½œç©ºé—´çš„<code>bin</code>è·¯å¾„æ·»åŠ åˆ°<code>PATH</code>ç¯å¢ƒå˜é‡ä¸­ï¼ˆå› æ­¤åœ¨ä½¿ç”¨ç‰ˆæœ¬æ§åˆ¶æ—¶ï¼Œå°½é‡å¿½ç•¥<code>bin</code>ã€<code>pkg</code>ï¼Œå»ºè®®ç›´æ¥åœ¨<code>src</code>ï¼Œæˆ–è€…å…·ä½“çš„å­åŒ…ä¸‹åˆ›å»ºä»£ç ä»“åº“ï¼‰ã€‚äºæ­¤ç›¸åçš„åšæ³•ï¼Œå°±æ˜¯åœ¨<code>Linux</code>æˆ–è€…<code>Unix</code>ç³»ç»Ÿä¸­ï¼Œå¯ä»¥åœ¨<code>PATH</code>ä¸­æ·»åŠ <code>export PATH=$PATH:${GOPATH//://bin:}/bin</code>ä¸‹æŠŠæ¯ä¸ª<code>GOPATH</code>ä¸‹çš„<code>bin</code>éƒ½åŠ å…¥åˆ°<code>PATH</code>ä¸­ã€‚</p><p>é‡ç‚¹æ¥äº†ï¼š<code>Module</code>çš„å‡ºç°ï¼Œå°±æ˜¯ä¸ºäº†å¼±åŒ–<code>GOPATH</code>çš„æ¦‚å¿µï¼Œä½¿ç”¨<code>Module</code>å»ç®¡ç†é¡¹ç›®çš„ä¾èµ–ï¼Œé‚£ä¹ˆå¯ä»¥åŸºæœ¬å¿½ç•¥<code>GOPATH</code>çš„åŸæœ‰çš„åŠŸèƒ½ã€‚</p><h2 id="Golangæä¾›çš„å‘½ä»¤">Golangæä¾›çš„å‘½ä»¤</h2><p>å¯ä»¥é€šè¿‡å‘½ä»¤è¡Œ<code>go help</code>æŸ¥çœ‹<code>Go</code>æä¾›çš„å‘½ä»¤è¡Œå·¥å…·ï¼š</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201912/go-e-d-m-1.png" alt=""></p><p>è¿™é‡Œå¯ä»¥å…³æ³¨ä¸€ä¸‹å‰é¢ä¸€ä¸ªæ ç›®çš„åŸºç¡€å‘½ä»¤å³å¯ï¼š</p><table><thead><tr><th style="text-align:center">å‘½ä»¤</th><th style="text-align:center">åŠŸèƒ½</th><th style="text-align:center">ä½¿ç”¨ä¾‹å­</th></tr></thead><tbody><tr><td style="text-align:center"><code>go bug</code></td><td style="text-align:center">æŠ¥å‘Šä¸€ä¸ª<code>BUG</code>ï¼Œä¼šè°ƒç”¨ç³»ç»Ÿé»˜è®¤æµè§ˆå™¨æ‰“å¼€æäº¤<code>BUG</code>æŠ¥å‘Šçš„é¡µé¢</td><td style="text-align:center"><code>go bug</code></td></tr><tr><td style="text-align:center"><code>go build</code></td><td style="text-align:center">ç¼–è¯‘æ‰€æœ‰çš„åŒ…å’Œä¾èµ–</td><td style="text-align:center"><code>go build [-o output] [-i] [build flags] [packages]</code></td></tr><tr><td style="text-align:center"><code>go clean</code></td><td style="text-align:center">æ¸…ç†æ‰§è¡Œå…¶å®ƒå‘½ä»¤æ—¶äº§ç”Ÿçš„ä¸€äº›æ–‡ä»¶å’Œç›®å½•</td><td style="text-align:center"><code>go clean [clean flags] [build flags] [packages]</code></td></tr><tr><td style="text-align:center"><code>go doc</code></td><td style="text-align:center">æ‰“å°é™„äº<code>Go</code>è¯­è¨€ç¨‹åºå®ä½“ä¸Šçš„æ–‡æ¡£</td><td style="text-align:center"><code>go doc pkg.app</code></td></tr><tr><td style="text-align:center"><code>go env</code></td><td style="text-align:center">å±•ç¤º<code>Go</code>çš„ç¯å¢ƒå˜é‡é…ç½®</td><td style="text-align:center"><code>go env</code></td></tr><tr><td style="text-align:center"><code>go fix</code></td><td style="text-align:center">æŠŠæŒ‡å®šä»£ç åŒ…çš„æ‰€æœ‰<code>Go</code>è¯­è¨€æºç æ–‡ä»¶ä¸­çš„æ—§ç‰ˆæœ¬ä»£ç ä¿®æ­£ä¸ºæ–°ç‰ˆæœ¬çš„ä»£ç ï¼Œè¿™é‡Œçš„ç‰ˆæœ¬æ˜¯æŒ‡<code>Go</code>çš„ç‰ˆæœ¬</td><td style="text-align:center">-</td></tr><tr><td style="text-align:center"><code>go fmt</code></td><td style="text-align:center">æ ¼å¼åŒ–æŒ‡å®šä»£ç ä¸ºç»Ÿä¸€çš„é£æ ¼</td><td style="text-align:center">-</td></tr><tr><td style="text-align:center"><code>go generate</code></td><td style="text-align:center">æ‰«æä¸å½“å‰åŒ…ç›¸å…³çš„æºä»£ç æ–‡ä»¶ï¼Œæ‰¾å‡ºæ‰€æœ‰åŒ…å«&quot;//go:generate&quot;çš„ç‰¹æ®Šæ³¨é‡Šï¼Œæå–å¹¶æ‰§è¡Œè¯¥ç‰¹æ®Šæ³¨é‡Šåé¢çš„å‘½ä»¤ï¼Œå‘½ä»¤ä¸ºå¯æ‰§è¡Œç¨‹åº</td><td style="text-align:center">-</td></tr><tr><td style="text-align:center"><code>go get</code></td><td style="text-align:center">æ ¹æ®è¦æ±‚å’Œå®é™…æƒ…å†µä»äº’è”ç½‘ä¸Šä¸‹è½½æˆ–æ›´æ–°æŒ‡å®šçš„ä»£ç åŒ…åŠå…¶ä¾èµ–åŒ…ï¼Œå¹¶å¯¹å®ƒä»¬è¿›è¡Œç¼–è¯‘å’Œå®‰è£…</td><td style="text-align:center"><code>go get github.com/x/y</code></td></tr><tr><td style="text-align:center"><code>go install</code></td><td style="text-align:center">ç¼–è¯‘å¹¶å®‰è£…æŒ‡å®šçš„ä»£ç åŒ…åŠå®ƒä»¬çš„ä¾èµ–åŒ…</td><td style="text-align:center"><code>go install</code></td></tr><tr><td style="text-align:center"><code>go list</code></td><td style="text-align:center">åˆ—å‡ºæŒ‡å®šçš„ä»£ç åŒ…çš„ä¿¡æ¯</td><td style="text-align:center">-</td></tr><tr><td style="text-align:center"><code>go mod</code></td><td style="text-align:center"><code>Module</code>ç›¸å…³å‘½ä»¤</td><td style="text-align:center">è§ä¸‹æ–‡åˆ†æ</td></tr><tr><td style="text-align:center"><code>go run</code></td><td style="text-align:center">ç¼–è¯‘å¹¶è¿è¡Œå‘½ä»¤æºç æ–‡ä»¶</td><td style="text-align:center">-</td></tr><tr><td style="text-align:center"><code>go test</code></td><td style="text-align:center">å¯¹<code>Go</code>è¯­è¨€ç¼–å†™çš„ç¨‹åºè¿›è¡Œæµ‹è¯•ï¼Œç®€å•æ¥è¯´å°±æ˜¯è¿è¡Œæµ‹è¯•ä»£ç </td><td style="text-align:center"><code>go test mine_test.go</code></td></tr><tr><td style="text-align:center"><code>go tool</code></td><td style="text-align:center">è¿è¡Œç‰¹å®šçš„<code>Go</code>æä¾›çš„å·¥å…·</td><td style="text-align:center"><code>go tool fix</code></td></tr><tr><td style="text-align:center"><code>go version</code></td><td style="text-align:center">æ‰“å°<code>Golang</code>çš„ç‰ˆæœ¬</td><td style="text-align:center"><code>go version</code></td></tr><tr><td style="text-align:center"><code>go vet</code></td><td style="text-align:center">æ£€æŸ¥<code>Go</code>è¯­è¨€æºç ä¸­é™æ€é”™è¯¯</td><td style="text-align:center"><code>go vet</code></td></tr></tbody></table><p>å¦‚æœæƒ³äº†è§£æ¯ä¸ªå‘½ä»¤çš„è¯¦ç»†ä½¿ç”¨æ•™ç¨‹å¯ä»¥é€šè¿‡<code>go help å‘½ä»¤Topic</code>å¾—åˆ°å¯¹åº”çš„ç»“æœï¼Œæ›´å¤šæˆ–æ›´è¯¦ç»†çš„ç”¨æ³•åé¢åœ¨æ¢ç©¶<code>Golang</code>ç¼–ç å’ŒåŸºç¡€çŸ¥è¯†çš„æ—¶å€™å†æ·±å…¥å±•å¼€ã€‚</p><h2 id="Golangä¾èµ–ç®¡ç†">Golangä¾èµ–ç®¡ç†</h2><p>ä¹‹å‰è·Ÿä¸€ä¸ªå‰è¾ˆè®¨è®ºå¯¹æ¯”<code>Java</code>å’Œ<code>Golang</code>çš„ç”Ÿæ€çš„æ—¶å€™ï¼Œç¬”è€…æŒ‡å‡ºäº†<code>Golang</code>åœ¨å·¥ç¨‹åŒ–æ–¹é¢å¯¹æ¯”<code>Java</code>æ„Ÿè§‰åå¼±ï¼Œæœ€å¸¸è§çš„ä¾‹å­å°±æ˜¯<code>Java</code>æœ‰å…¨çƒé€šç”¨çš„ä¾èµ–ä¸­å¤®ä»“åº“ï¼Œå›½å†…ä¹Ÿæœ‰é˜¿é‡Œçš„<code>Maven</code>ä»“åº“åšåŠ é€Ÿï¼Œå¼€å‘è€…å¯ä»¥å¾ˆè½»æ˜“é€šè¿‡<code>GAV</code>ï¼ˆ<code>GroupId</code>ã€<code>ArtifactId</code>å’Œ<code>Version</code>ï¼‰å»æ‹‰å–ä¸åŒç‰ˆæœ¬çš„ä¾èµ–åŒ…ï¼Œè¿™ä¸€ç‚¹åœ¨<code>Golang</code>ä¸­å±•ç°å‡ºäº†å¼±åŠ¿ã€‚å›æƒ³èµ·æ¥æ—¶é—´<strong>å·²ç»è¿‡å»ä¸€å¹´äº†</strong>ï¼Œ<code>Golang</code>ä¹Ÿåœ¨è¿›æ­¥ï¼Œä¾èµ–ç®¡ç†ä¹Ÿå¼€å§‹å®Œå–„ï¼Œç¬”è€…çš„è¿‡å»ç‹­éš˜çš„æ€ç»´ä¹Ÿæ”¹å˜äº†ï¼ˆå…¶å®ä¸èƒ½æ€»ç”¨<code>Java</code>çš„è§’åº¦å»å­¦ä¹ å…¶ä»–ç¼–ç¨‹è¯­è¨€ï¼Œå¦åˆ™å¾ˆéš¾ä½“ä¼šåˆ°å…¶ä»–è¯­è¨€çš„ç²¾é«“ï¼Œç”šè‡³æœ‰æ—¶å€™ä¼šè¡ç”Ÿä¸€äº›å¥‡æ€ªçš„æƒ³æ³•ï¼Œä¾‹å¦‚ï¼šæ€»æ˜¯æƒ³<code>Golang</code>ä¸­æ˜¯å¦å­˜åœ¨ç±»ä¼¼<code>Java</code>ä¸­çš„<code>Spring</code>æˆ–è€…<code>Mybatis</code>è¿™ç±»æ¡†æ¶ï¼‰ã€‚</p><p><code>Golang</code>ä»<code>1.11</code>ç‰ˆæœ¬ä¹‹åå¼•å…¥äº†<code>Module</code>ä½œä¸ºä¾èµ–ç®¡ç†å·¥å…·ï¼Œä»<code>1.13</code>æˆ–è€…ä¹‹åçš„ç‰ˆæœ¬ï¼Œ<code>Module</code>ä½œä¸ºå®˜æ–¹é»˜è®¤çš„ä¾èµ–ç®¡ç†å·¥å…·ï¼Œå¯¹åº”çš„å‘½ä»¤æ˜¯<code>go mod [Command]</code>ã€‚<code>Module</code>åŠŸèƒ½çš„å¯ç”¨ä¸å¦ç”±ç¯å¢ƒå˜é‡ä¸­çš„<code>GO111MODULE</code>å†³å®šï¼Œè€Œ<code>GO111MODULE</code>æœ‰ä¸‰ä¸ªå¯é€‰å€¼ï¼š</p><ul><li><code>GO111MODULE=off</code>ï¼Œç¦ç”¨<code>Module</code>åŠŸèƒ½ï¼Œåˆ™ç¼–è¯‘çš„æ—¶å€™ä¼šä»<code>GOPATH</code>å’Œ<code>vendor</code>æ–‡ä»¶å¤¹ä¸­æŸ¥æ‰¾ä¾èµ–åŒ…ã€‚</li><li><code>GO111MODULE=on</code>ï¼Œå¯ç”¨<code>Module</code>åŠŸèƒ½ï¼Œåˆ™ç¼–è¯‘çš„æ—¶å€™ä¼šå¿½ç•¥<code>GOPATH</code>å’Œ<code>vendor</code>æ–‡ä»¶å¤¹ï¼Œç¼–è¯‘æ‰€éœ€çš„ä¾èµ–ç”±<code>go.mod</code>æ–‡ä»¶æè¿°ï¼Œä»æœ¬åœ°ç¼“å­˜<code>$GOPATH/pkg/mod</code>ç›®å½•ä¸­åŠ è½½ã€‚</li><li><code>GO111MODULE=auto</code>ï¼Œè‡ªåŠ¨åˆ¤æ–­æ˜¯å¦å¯ç”¨<code>Module</code>åŠŸèƒ½ï¼Œ<strong>æ­¤é€‰é¡¹æ˜¯é»˜è®¤å€¼</strong>ï¼Œå½“é¡¹ç›®åœ¨<code>$GOPATH/src</code>å¤–ä¸”é¡¹ç›®æ ¹ç›®å½•æœ‰<code>go.mod</code>æ–‡ä»¶æ—¶ï¼Œåˆ™å¯ç”¨<code>Module</code>åŠŸèƒ½ã€‚</li></ul><p><code>Module</code>å­˜åœ¨çš„æ„ä¹‰æ˜¯ï¼šæ²¡æœ‰å¿…è¦åœ¨<code>GOPATH</code>ä¸­åˆ›å»ºé¡¹ç›®ï¼Œç®¡ç†é¡¹ç›®ä¾èµ–çš„ç¬¬ä¸‰æ–¹åŒ…ä¿¡æ¯å¯ä»¥ç‹¬ç«‹ç®¡ç†ã€‚<code>go mod</code>æ”¯æŒçš„æ‰€æœ‰å‘½ä»¤å¦‚ä¸‹ï¼š</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201912/go-e-d-m-2.png" alt=""></p><table><thead><tr><th style="text-align:center"><code>go mod</code>å‘½ä»¤</th><th style="text-align:center">åŠŸèƒ½</th></tr></thead><tbody><tr><td style="text-align:center"><code>go mod download</code></td><td style="text-align:center">ä¸‹è½½ä¾èµ–çš„æ¨¡å—åˆ°æœ¬åœ°ç¼“å­˜ä¸­ï¼Œæœ¬åœ°ç¼“å­˜çš„é»˜è®¤è·¯å¾„æ˜¯<code>$GOPATH/pkg/mod</code>ç›®å½•</td></tr><tr><td style="text-align:center"><code>go mod edit</code></td><td style="text-align:center">ç¼–è¾‘<code>go.mod</code>æ–‡ä»¶</td></tr><tr><td style="text-align:center"><code>go mod graph</code></td><td style="text-align:center">æ‰“å°æ¨¡å—ä¾èµ–å›¾</td></tr><tr><td style="text-align:center"><code>go mod init</code></td><td style="text-align:center">åŸºäºå½“å‰æ–‡ä»¶å¤¹åˆå§‹åŒ–ä¸€ä¸ªæ–°æ¨¡å—,ï¼Œåˆ›å»º<code>go.mod</code>æ–‡ä»¶</td></tr><tr><td style="text-align:center"><code>go mod tidy</code></td><td style="text-align:center">æ·»åŠ ç¼ºå¤±çš„æ¨¡å—ï¼Œç§»é™¤æ— ç”¨çš„æ¨¡å—</td></tr><tr><td style="text-align:center"><code>go mod vendor</code></td><td style="text-align:center">æŠŠæ‰€æœ‰ä¾èµ–æ‹·è´åˆ°<code>vendor</code>æ–‡ä»¶å¤¹ä¸­</td></tr><tr><td style="text-align:center"><code>go mod verify</code></td><td style="text-align:center">æ ¡éªŒä¾èµ–ï¼Œæ£€æŸ¥ä¾èµ–å†…å®¹æ˜¯å¦å’Œé¢„æœŸä¸€è‡´</td></tr><tr><td style="text-align:center"><code>go mod why</code></td><td style="text-align:center">è§£é‡Šä¸ºä»€ä¹ˆéœ€è¦å¼•å…¥åŒ…ï¼ˆ<code>packages</code>ï¼‰å’Œæ¨¡å—ï¼ˆ<code>modules</code>ï¼‰</td></tr></tbody></table><h3 id="ä½¿ç”¨Moduleè¿›è¡Œä¾èµ–ç®¡ç†">ä½¿ç”¨Moduleè¿›è¡Œä¾èµ–ç®¡ç†</h3><p>å…ˆä½¿ç”¨<code>JetBrains Goland</code>åˆ›å»ºä¸€ä¸ªæ–°é¡¹ç›®ï¼Œé¡¹ç›®é‡Œé¢åˆ›å»º<code>bin</code>ã€<code>pkg</code>å’Œ<code>src</code>ä¸‰ä¸ªç›®å½•ï¼š</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201912/go-e-d-m-3.png" alt=""></p><p>é¡¹ç›®åˆ›å»ºå®Œæˆåï¼Œæ ¹ç›®å½•ä¸­å·²ç»å­˜åœ¨äº†ä¸€ä¸ª<code>go.mod</code>æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯<code>JetBrains Goland</code>å·²ç»å¸®æˆ‘ä»¬åœ¨å½“å‰ç›®å½•æ‰§è¡Œè¿‡<code>go mod init</code>ï¼Œæ–‡ä»¶å†…å®¹æ˜¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">module "module-sample"</span><br></pre></td></tr></table></figure><p><code>src</code>ç›®å½•ä¸‹å¼•å…¥ä¸€ä¸ª<code>app.go</code>æ–‡ä»¶ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">"fmt"</span></span><br><span class="line"><span class="string">"github.com/garyburd/redigo/redis"</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">connection, err := redis.Dial(<span class="string">"tcp"</span>, <span class="string">"127.0.0.1:6379"</span>, redis.DialDatabase(<span class="number">0</span>))</span><br><span class="line"><span class="keyword">if</span> <span class="literal">nil</span> != err &#123;</span><br><span class="line">fmt.Println(<span class="string">"è¿æ¥åˆ°Rediså¼‚å¸¸"</span>, err)</span><br><span class="line"><span class="keyword">return</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">defer</span> connection.Close()</span><br><span class="line">n, err := connection.Do(<span class="string">"SET"</span>, <span class="string">"name"</span>, <span class="string">"throwable"</span>)</span><br><span class="line"><span class="keyword">if</span> <span class="literal">nil</span> != err &#123;</span><br><span class="line">fmt.Println(err)</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> n == <span class="string">"OK"</span> &#123;</span><br><span class="line">fmt.Println(<span class="string">"æ‰§è¡ŒSetå‘½ä»¤æˆåŠŸ"</span>)</span><br><span class="line">&#125;</span><br><span class="line">value, err := redis.String(connection.Do(<span class="string">"GET"</span>, <span class="string">"name"</span>))</span><br><span class="line"><span class="keyword">if</span> <span class="literal">nil</span> != err &#123;</span><br><span class="line">fmt.Println(err)</span><br><span class="line">&#125;</span><br><span class="line">fmt.Println(<span class="string">"Getå‘½ä»¤æ‰§è¡Œç»“æœ:"</span>, value)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¼šå‘ç°ï¼Œæ•´ä¸ªæ–‡ä»¶çš„ä¾èµ–éƒ½æ˜¯æ ‡çº¢çš„ï¼Œä¹Ÿå°±æ˜¯ä¾èµ–æ²¡æœ‰ä¸‹è½½å’Œå¯¼å…¥ï¼š</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201912/go-e-d-m-4.png" alt=""></p><p>æ­¤æ—¶ä½¿ç”¨<code>go mod tidy</code>è¿›è¡Œä¾èµ–æ•´ç†ï¼Œæ‰§è¡Œå®Œæ¯•ä¹‹åï¼Œå‘ç°æ ¹ç›®å½•ç”Ÿæˆäº†ä¸€ä¸ªæ–°çš„<code>go.sum</code>ï¼Œå®ƒç”¨äºè®°å½•é”å®šçš„ä¾èµ–è®°å½•ï¼ˆä¾èµ–çš„åŒ…ã€è·¯å¾„ã€ç‰ˆæœ¬ä»¥åŠå“ˆå¸Œå€¼ï¼‰ã€‚<code>go.sum</code>æ–‡ä»¶å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">github.com/garyburd/redigo v1.6.0 h1:0VruCpn7yAIIu7pWVClQC8wxCJEcG3nyzpMSHKi1PQc=</span><br><span class="line">github.com/garyburd/redigo v1.6.0/go.mod h1:NR3MbYisc3/PwhQ00EMzDiPmrwpPxAn5GI05/YaO1SY=</span><br></pre></td></tr></table></figure><p>è€Œ<code>go.mod</code>æ–‡ä»¶ä¹Ÿè¢«ä¿®æ”¹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">module module-sample</span><br><span class="line"></span><br><span class="line">go 1.13</span><br><span class="line"></span><br><span class="line">require github.com/garyburd/redigo v1.6.0</span><br></pre></td></tr></table></figure><p>ç„¶åä½¿ç”¨<code>go mod download</code>ä¸‹è½½ä¾èµ–åˆ°æœ¬åœ°ç¼“å­˜ä¸­ï¼Œä¸‹è½½å®Œæˆåï¼Œä½¿ç”¨<code>go mod vendor</code>æŠŠä¾èµ–æ‹·è´åˆ°å½“å‰æ¨¡å—çš„<code>vendor</code>ç›®å½•ä¸‹ï¼Œé‚£ä¹ˆåŸæ¥æ ‡çº¢çš„æ–‡ä»¶å°±èƒ½æ­£å¸¸ç¼–è¯‘äº†ã€‚</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201912/go-e-d-m-5.png" alt=""></p><p><code>go mod</code>ç®¡ç†ä¾èµ–æ”¯æŒ<strong>è¯­ä¹‰åŒ–ç‰ˆæœ¬å·</strong>ï¼Œä¾‹å¦‚ï¼š</p><ul><li>ä¾èµ–ç‰ˆæœ¬ï¼š<strong><code>foo@v1.2.3</code></strong>ã€‚</li><li><code>Git</code>åˆ†æ”¯çš„<code>Tag</code>ï¼š<code>foo@master</code>ã€‚</li><li><code>Git</code>æäº¤ç‚¹çš„<code>SHA-1</code>å€¼ï¼š<code>foo@e3702bed2</code>ã€‚</li><li>å…¶ä»–å€¼ï¼šå¦‚<code>&lt;=v1.1.1</code>ã€<code>latest</code>ç­‰ç­‰ã€‚</li></ul><p><code>go.mod</code>æ–‡ä»¶ä¸­å¯ä»¥ä½¿ç”¨å¦‚ä¸‹å…³é”®å­—ï¼š</p><ul><li><code>module</code>ï¼šæ¨¡å—åã€‚</li><li><code>require</code>ï¼šå¼•å…¥æ‰€éœ€ä¾èµ–ï¼Œæ³¨æ„åŒ…åå’Œç‰ˆæœ¬ï¼Œä¾‹å¦‚ï¼š</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">require github.com/garyburd/redigo v1.6.0</span><br></pre></td></tr></table></figure><ul><li><code>replace</code>ï¼šæ›¿æ¢ä¾èµ–ï¼Œä¾‹å¦‚ï¼š</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">replace (</span><br><span class="line">    golang.org/x/crypto v0.0.0-20180820150726-614d502a4dac =&gt; github.com/golang/crypto v0.0.0-20180820150726-614d502a4dac</span><br><span class="line">    golang.org/x/net v0.0.0-20180821023952-922f4815f713 =&gt; github.com/golang/net v0.0.0-20180826012351-8a410e7b638d</span><br><span class="line">    golang.org/x/text v0.3.0 =&gt; github.com/golang/text v0.3.0</span><br><span class="line">)</span><br></pre></td></tr></table></figure><ul><li><code>indirect</code>ï¼šæŒ‡æ˜æ˜¯é—´æ¥å¼•ç”¨ï¼Œä¾‹å¦‚ï¼š</li></ul><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">require (</span><br><span class="line">    github.com/garyburd/redigo v1.6.0</span><br><span class="line">    github.com/garyburd/xx v1.0.0  // indirect</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>å¦å¤–ï¼Œå¯ä»¥å•ç‹¬ä½¿ç”¨<code>go get</code>å‘½ä»¤ä¸‹è½½å¯¹åº”çš„ä¾èµ–ï¼Œè€Œ<code>go mod download</code>ä¼šä¸‹è½½æ‰€æœ‰ç”¨åˆ°çš„ä¾èµ–ã€‚æœ€åé™„ä¸Šä¸€äº›å°æŠ€å·§ï¼š</p><table><thead><tr><th style="text-align:center">å‘½ä»¤</th><th style="text-align:center">åŠŸèƒ½</th></tr></thead><tbody><tr><td style="text-align:center"><code>go mod edit -fmt</code></td><td style="text-align:center">æ ¼å¼åŒ–<code>go.mod</code>æ–‡ä»¶</td></tr><tr><td style="text-align:center"><code>go mod edit -require=éœ€è¦çš„ä¾èµ–</code></td><td style="text-align:center">æ·»åŠ ä¾èµ–åˆ°<code>go.mod</code>æ–‡ä»¶</td></tr><tr><td style="text-align:center"><code>go mod edit -droprequire=æŒ‡å®šçš„ä¾èµ–</code></td><td style="text-align:center">ä»<code>go.mod</code>æ–‡ä»¶ç§»é™¤å¯¹åº”çš„ä¾èµ–</td></tr><tr><td style="text-align:center"><code>go mod tidy</code>ã€<code>go mod download</code>ã€<code>go mod vendor</code></td><td style="text-align:center">ä¸‰ä¸ªå‘½ä»¤ç»„åˆä½¿ç”¨ï¼Œç›¸å½“äºå…¨å±€æ›´æ–°ä¸€æ¬¡æ‰€éœ€çš„ä¾èµ–</td></tr></tbody></table><p>å¦‚æœç†Ÿç»ƒä½¿ç”¨è¿™äº›å‘½ä»¤ï¼Œé‚£ä¹ˆä¾èµ–ç®¡ç†å°±ä¼šå˜å¾—ç›¸å¯¹å®¹æ˜“ã€‚</p><h2 id="å°ç»“">å°ç»“</h2><p>æœ¬æ–‡ç®€å•ä»‹ç»äº†<code>Golang</code>çš„<code>Module</code>ä¾èµ–ç®¡ç†åŠŸèƒ½ï¼Œè¿™é‡Œç®€å•è®°å½•å‡ ä¸ªè¦ç‚¹ï¼š</p><ul><li><code>go mod download</code>ä¸‹è½½çš„ä¾èµ–åŒ…ä¼šå­˜æ”¾åœ¨<code>Go</code>æœ¬åœ°ç¼“å­˜ä¸­ï¼Œå…·ä½“ä½ç½®æ˜¯<code>$GOPATH/pkg/mod</code>ï¼ˆè¿™é‡Œçš„<code>GOPATH</code>ä¸€èˆ¬æ˜¯å°±æ˜¯å…¨å±€çš„é‚£ä¸ª<code>GOPATH</code>ï¼Œå€¼ä¸º<code>$Users/$User/go</code>ï¼‰</li><li>å¯ç”¨<code>Module</code>åŠŸèƒ½åï¼Œæ¨¡å—æ ¹ç›®å½•ç”Ÿæˆä¸€ä¸ª<code>go.mod</code>ç”¨äºè®°å½•å½“å‰æ¨¡å—çš„ä¾èµ–å…³ç³»ã€‚</li><li>å¯ç”¨<code>Module</code>åŠŸèƒ½åï¼Œä¸€æ—¦ä¸‹è½½äº†æ–°çš„ä¾èµ–ï¼Œå°±ä¼šåœ¨æ¨¡å—æ ¹ç›®å½•ç”Ÿæˆä¸€ä¸ª<code>go.sum</code>ç”¨äºè®°å½•è¢«é”å®šçš„ä¾èµ–è®°å½•ã€‚</li></ul><p><code>go.mod</code>å’Œ<code>go.sum</code>æœ€ç»ˆå†³å®šäº†ä¸€æ£µé”å®šå¥½çš„ä¾èµ–æ ‘ï¼Œæœ€ç»ˆç¼–è¯‘ä»¥åŠå®‰è£…éƒ½æ˜¯é€šè¿‡è¿™ä¸¤ä¸ªæè¿°æ–‡ä»¶ï¼Œå…³è”åˆ°æœ¬åœ°ç¼“å­˜ä¸‹è½½å¥½çš„ä¾èµ–åŒ…å®Œæˆåç»­çš„å·¥ä½œã€‚</p><p>ï¼ˆæœ¬æ–‡å®Œ c-1-d e-a-20191222ï¼‰</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰æ&quot;&gt;å‰æ&lt;/h2&gt;
&lt;p&gt;æœ€è¿‘å¼€å§‹ç³»ç»Ÿå­¦ä¹ ä¸€ä¸‹&lt;code&gt;Golang&lt;/code&gt;è¿™ä¹ˆæ–°è¯­è¨€ï¼Œè®°å½•ä¸€ä¸‹å®ƒçš„åŸºæœ¬ç¯å¢ƒå˜é‡é…ç½®ä»¥åŠä¾èµ–ç®¡ç†æ–¹å¼ã€‚ç¼–å†™æœ¬æ–‡çš„æ—¶å€™ä½¿ç”¨çš„&lt;code&gt;Golang&lt;/code&gt;ç‰ˆæœ¬ä¸º&lt;code&gt;go1.13.5 windows/amd64&lt;/code&gt;ï¼Œå…¶ä»–ç‰ˆæœ¬ä¸ä¸€å®šä¿è¯é€‚åˆæœ¬æ–‡çš„å†…å®¹ã€‚å› ä¸ºä¹ æƒ¯ï¼Œå¯èƒ½æœ‰æ—¶å€™æŠŠ&lt;code&gt;Go&lt;/code&gt;è¯­è¨€ç§°ä¸º&lt;code&gt;Go&lt;/code&gt;ï¼Œæœ‰æ—¶å€™ç§°ä¸º&lt;code&gt;Golang&lt;/code&gt;ã€‚&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201912/Golang.jpg&quot; alt=&quot;&quot;&gt;&lt;/p&gt;
    
    </summary>
    
    
      <category term="Go" scheme="http://throwable.club/blog/categories/Go/"/>
    
      <category term="Golang" scheme="http://throwable.club/blog/categories/Go/Golang/"/>
    
    
      <category term="Go" scheme="http://throwable.club/blog/tags/Go/"/>
    
      <category term="Golang" scheme="http://throwable.club/blog/tags/Golang/"/>
    
  </entry>
  
  <entry>
    <title>Mybatisä»£ç ç”Ÿæˆå™¨Mybatis-Generatorä½¿ç”¨è¯¦è§£</title>
    <link href="http://throwable.club/2019/12/16/mybatis-generator-usage/"/>
    <id>http://throwable.club/2019/12/16/mybatis-generator-usage/</id>
    <published>2019-12-15T17:06:00.000Z</published>
    <updated>2019-12-15T17:07:59.251Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰æ">å‰æ</h2><p>æœ€è¿‘åœ¨åšåˆ›ä¸šé¡¹ç›®çš„æ—¶å€™å› ä¸ºæœ‰æ¯”è¾ƒå¤šçš„æ–°éœ€æ±‚ï¼Œéœ€è¦é¢‘ç¹åŸºäº<code>DDL</code>ç”Ÿæˆ<code>Mybatis</code>é€‚åˆçš„å®ä½“ã€<code>Mapper</code>æ¥å£å’Œæ˜ å°„æ–‡ä»¶ã€‚å…¶ä¸­ï¼Œä»£ç ç”Ÿæˆå™¨æ˜¯<code>MyBatis Generator(MBG)</code>ï¼Œç”¨åˆ°äº†<code>Mybatis-Generator-Core</code>ç›¸å…³ä¾èµ–ï¼Œè¿™é‡Œé€šè¿‡ä¸€ç¯‡æ–‡ç« è¯¦ç»†åœ°åˆ†æè¿™ä¸ªä»£ç ç”Ÿæˆå™¨çš„ä½¿ç”¨æ–¹å¼ã€‚æœ¬æ–‡ç¼–å†™çš„æ—¶å€™ä½¿ç”¨çš„<code>Mybatis-Generator</code>ç‰ˆæœ¬ä¸º<code>1.4.0</code>ï¼Œå…¶ä»–ç‰ˆæœ¬æ²¡æœ‰è¿›è¡Œè¿‡è°ƒç ”ã€‚</p><a id="more"></a><h2 id="å¼•å…¥æ’ä»¶">å¼•å…¥æ’ä»¶</h2><p><code>Mybatis-Generator</code>çš„è¿è¡Œæ–¹å¼æœ‰å¾ˆå¤šç§ï¼š</p><ul><li>åŸºäº<code>mybatis-generator-core-x.x.x.jar</code>å’Œå…¶<code>XML</code>é…ç½®æ–‡ä»¶ï¼Œé€šè¿‡å‘½ä»¤è¡Œè¿è¡Œã€‚</li><li>é€šè¿‡<code>Ant</code>çš„<code>Task</code>ç»“åˆå…¶<code>XML</code>é…ç½®æ–‡ä»¶è¿è¡Œã€‚</li><li>é€šè¿‡<code>Maven</code>æ’ä»¶è¿è¡Œã€‚</li><li>é€šè¿‡<code>Java</code>ä»£ç å’Œå…¶<code>XML</code>é…ç½®æ–‡ä»¶è¿è¡Œã€‚</li><li>é€šè¿‡<code>Java</code>ä»£ç å’Œç¼–ç¨‹å¼é…ç½®è¿è¡Œã€‚</li><li>é€šè¿‡<code>Eclipse Feature</code>è¿è¡Œã€‚</li></ul><p>è¿™é‡Œåªä»‹ç»é€šè¿‡<code>Maven</code>æ’ä»¶è¿è¡Œå’Œé€šè¿‡<code>Java</code>ä»£ç å’Œå…¶<code>XML</code>é…ç½®æ–‡ä»¶è¿è¡Œè¿™ä¸¤ç§æ–¹å¼ï¼Œä¸¤ç§æ–¹å¼æœ‰ä¸ªç‰¹ç‚¹ï¼šéƒ½è¦æå‰ç¼–å†™å¥½<code>XML</code>é…ç½®æ–‡ä»¶ã€‚ä¸ªäººæ„Ÿè§‰<code>XML</code>é…ç½®æ–‡ä»¶ç›¸å¯¹ç›´è§‚ï¼Œåæ–‡ä¼šèŠ±å¤§é‡ç¯‡å¹…å»è¯´æ˜<code>XML</code>é…ç½®æ–‡ä»¶ä¸­çš„é…ç½®é¡¹åŠå…¶ä½œç”¨ã€‚è¿™é‡Œå…ˆæ³¨æ„ä¸€ç‚¹ï¼šé»˜è®¤çš„é…ç½®æ–‡ä»¶ä¸º<code>ClassPath:generatorConfig.xml</code>ã€‚</p><h3 id="é€šè¿‡ç¼–ç å’Œé…ç½®æ–‡ä»¶è¿è¡Œ">é€šè¿‡ç¼–ç å’Œé…ç½®æ–‡ä»¶è¿è¡Œ</h3><p>é€šè¿‡ç¼–ç æ–¹å¼å»è¿è¡Œæ’ä»¶å…ˆéœ€è¦å¼•å…¥<code>mybatis-generator-core</code>ä¾èµ–ï¼Œç¼–å†™æœ¬æ–‡çš„æ—¶å€™æœ€æ–°çš„ç‰ˆæœ¬ä¸ºï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.generator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-generator-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å‡è®¾ç¼–å†™å¥½çš„<code>XML</code>é…ç½®æ–‡ä»¶æ˜¯<code>ClassPath</code>ä¸‹çš„<code>generator-configuration.xml</code>ï¼Œé‚£ä¹ˆä½¿ç”¨ä»£ç ç”Ÿæˆå™¨çš„ç¼–ç æ–¹å¼å¤§è‡´å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">List&lt;String&gt; warnings = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"><span class="comment">// å¦‚æœå·²ç»å­˜åœ¨ç”Ÿæˆè¿‡çš„æ–‡ä»¶æ˜¯å¦è¿›è¡Œè¦†ç›–</span></span><br><span class="line"><span class="keyword">boolean</span> overwrite = <span class="keyword">true</span>;</span><br><span class="line">File configFile = <span class="keyword">new</span> File(<span class="string">"ClassPathè·¯å¾„/generator-configuration.xml"</span>);</span><br><span class="line">ConfigurationParser cp = <span class="keyword">new</span> ConfigurationParser(warnings);</span><br><span class="line">Configuration config = cp.parseConfiguration(configFile);</span><br><span class="line">DefaultShellCallback callback = <span class="keyword">new</span> DefaultShellCallback(overwrite);</span><br><span class="line">MyBatisGenerator generator = <span class="keyword">new</span> MyBatisGenerator(config, callback, warnings);</span><br><span class="line">generator.generate(<span class="keyword">null</span>);</span><br></pre></td></tr></table></figure><h3 id="é€šè¿‡Mavenæ’ä»¶è¿è¡Œ">é€šè¿‡Mavenæ’ä»¶è¿è¡Œ</h3><p>å¦‚æœä½¿ç”¨<code>Maven</code>æ’ä»¶ï¼Œé‚£ä¹ˆ<strong>ä¸éœ€è¦</strong>å¼•å…¥<code>mybatis-generator-core</code>ä¾èµ–ï¼Œåªéœ€è¦å¼•å…¥ä¸€ä¸ª<code>Maven</code>çš„æ’ä»¶<code>mybatis-generator-maven-plugin</code>ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.generator<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-generator-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">id</span>&gt;</span>Generate MyBatis Artifacts<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">goal</span>&gt;</span>generate<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- è¾“å‡ºè¯¦ç»†ä¿¡æ¯ --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">verbose</span>&gt;</span>true<span class="tag">&lt;/<span class="name">verbose</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- è¦†ç›–ç”Ÿæˆæ–‡ä»¶ --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">overwrite</span>&gt;</span>true<span class="tag">&lt;/<span class="name">overwrite</span>&gt;</span></span><br><span class="line">            <span class="comment">&lt;!-- å®šä¹‰é…ç½®æ–‡ä»¶ --&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configurationFile</span>&gt;</span>$&#123;basedir&#125;/src/main/resources/generator-configuration.xml<span class="tag">&lt;/<span class="name">configurationFile</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>mybatis-generator-maven-plugin</code>çš„æ›´è¯¦ç»†é…ç½®å’Œå¯é€‰å‚æ•°å¯ä»¥å‚è€ƒï¼š<a href="http://mybatis.org/generator/running/runningWithMaven.html" target="_blank" rel="noopener">Running With Maven</a>ã€‚æ’ä»¶é…ç½®å®Œæ¯•ä¹‹åï¼Œä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤å³å¯è¿è¡Œï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn mybatis-generator:generate</span><br></pre></td></tr></table></figure><h2 id="XMLé…ç½®æ–‡ä»¶è¯¦è§£">XMLé…ç½®æ–‡ä»¶è¯¦è§£</h2><p><code>XML</code>é…ç½®æ–‡ä»¶æ‰æ˜¯<code>Mybatis-Generator</code>çš„æ ¸å¿ƒï¼Œå®ƒç”¨äºæ§åˆ¶ä»£ç ç”Ÿæˆçš„æ‰€æœ‰è¡Œä¸ºã€‚æ‰€æœ‰éæ ‡ç­¾ç‹¬æœ‰çš„å…¬å…±é…ç½®çš„<code>Key</code>å¯ä»¥åœ¨<code>mybatis-generator-core</code>çš„<code>PropertyRegistry</code>ç±»ä¸­æ‰¾åˆ°ã€‚ä¸‹é¢æ˜¯ä¸€ä¸ªç›¸å¯¹å®Œæ•´çš„é…ç½®æ–‡ä»¶çš„æ¨¡æ¿ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">generatorConfiguration</span></span></span><br><span class="line"><span class="meta">  <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN"</span></span></span><br><span class="line"><span class="meta">  <span class="meta-string">"http://mybatis.org/dtd/mybatis-generator-config_1_0.dtd"</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">generatorConfiguration</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">properties</span> <span class="attr">resource</span>=<span class="string">"db.properties"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">classPathEntry</span> <span class="attr">location</span>=<span class="string">"/Program Files/IBM/SQLLIB/java/db2java.zip"</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;<span class="name">context</span> <span class="attr">id</span>=<span class="string">"DB2Tables"</span> <span class="attr">targetRuntime</span>=<span class="string">"MyBatis3"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">jdbcConnection</span> <span class="attr">driverClass</span>=<span class="string">"COM.ibm.db2.jdbc.app.DB2Driver"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">connectionURL</span>=<span class="string">"jdbc:db2:TEST"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">userId</span>=<span class="string">"db2admin"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">password</span>=<span class="string">"db2admin"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">jdbcConnection</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugin</span> <span class="attr">type</span>=<span class="string">"org.mybatis.generator.plugins.SerializablePlugin"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">commentGenerator</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"suppressDate"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"suppressAllComments"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">commentGenerator</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">javaTypeResolver</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"forceBigDecimals"</span> <span class="attr">value</span>=<span class="string">"false"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">javaTypeResolver</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">javaModelGenerator</span> <span class="attr">targetPackage</span>=<span class="string">"test.model"</span> <span class="attr">targetProject</span>=<span class="string">"\MBGTestProject\src"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"enableSubPackages"</span> <span class="attr">value</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"trimStrings"</span> <span class="attr">value</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">javaModelGenerator</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">sqlMapGenerator</span> <span class="attr">targetPackage</span>=<span class="string">"test.xml"</span>  <span class="attr">targetProject</span>=<span class="string">"\MBGTestProject\src"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"enableSubPackages"</span> <span class="attr">value</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">sqlMapGenerator</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">javaClientGenerator</span> <span class="attr">type</span>=<span class="string">"XMLMAPPER"</span> <span class="attr">targetPackage</span>=<span class="string">"test.dao"</span>  <span class="attr">targetProject</span>=<span class="string">"\MBGTestProject\src"</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"enableSubPackages"</span> <span class="attr">value</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">javaClientGenerator</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">schema</span>=<span class="string">"DB2ADMIN"</span> <span class="attr">tableName</span>=<span class="string">"ALLTYPES"</span> <span class="attr">domainObjectName</span>=<span class="string">"Customer"</span> &gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"useActualColumnNames"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">generatedKey</span> <span class="attr">column</span>=<span class="string">"ID"</span> <span class="attr">sqlStatement</span>=<span class="string">"DB2"</span> <span class="attr">identity</span>=<span class="string">"true"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">columnOverride</span> <span class="attr">column</span>=<span class="string">"DATE_FIELD"</span> <span class="attr">property</span>=<span class="string">"startDate"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">ignoreColumn</span> <span class="attr">column</span>=<span class="string">"FRED"</span> /&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">columnOverride</span> <span class="attr">column</span>=<span class="string">"LONG_VARCHAR_FIELD"</span> <span class="attr">jdbcType</span>=<span class="string">"VARCHAR"</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"></span><br><span class="line">  <span class="tag">&lt;/<span class="name">context</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">generatorConfiguration</span>&gt;</span></span><br></pre></td></tr></table></figure><p>é…ç½®æ–‡ä»¶ä¸­ï¼Œæœ€å¤–å±‚çš„æ ‡ç­¾ä¸º<code>&lt;generatorConfiguration&gt;</code>ï¼Œå®ƒçš„å­æ ‡ç­¾åŒ…æ‹¬ï¼š</p><ul><li>0æˆ–è€…1ä¸ª<code>&lt;properties&gt;</code>æ ‡ç­¾ï¼Œç”¨äºæŒ‡å®šå…¨å±€é…ç½®æ–‡ä»¶ï¼Œä¸‹é¢å¯ä»¥é€šè¿‡å ä½ç¬¦çš„å½¢å¼è¯»å–<code>&lt;properties&gt;</code>æŒ‡å®šæ–‡ä»¶ä¸­çš„å€¼ã€‚</li><li>0æˆ–è€…Nä¸ª<code>&lt;classPathEntry&gt;</code>æ ‡ç­¾ï¼Œ<code>&lt;classPathEntry&gt;</code>åªæœ‰ä¸€ä¸ª<code>location</code>å±æ€§ï¼Œç”¨äºæŒ‡å®šæ•°æ®æºé©±åŠ¨åŒ…ï¼ˆ<code>jar</code>æˆ–è€…<code>zip</code>ï¼‰çš„ç»å¯¹è·¯å¾„ï¼Œå…·ä½“é€‰æ‹©ä»€ä¹ˆé©±åŠ¨åŒ…å–å†³äºè¿æ¥ä»€ä¹ˆç±»å‹çš„æ•°æ®æºã€‚</li><li>1æˆ–è€…Nä¸ª<code>&lt;context&gt;</code>æ ‡ç­¾ï¼Œç”¨äºè¿è¡Œæ—¶çš„è§£ææ¨¡å¼å’Œå…·ä½“çš„ä»£ç ç”Ÿæˆè¡Œä¸ºï¼Œæ‰€ä»¥è¿™ä¸ªæ ‡ç­¾é‡Œé¢çš„é…ç½®æ˜¯æœ€é‡è¦çš„ã€‚</li></ul><p>ä¸‹é¢åˆ†åˆ«åˆ—ä¸¾å’Œåˆ†æä¸€ä¸‹<code>&lt;context&gt;</code>æ ‡ç­¾å’Œå®ƒçš„ä¸»è¦å­æ ‡ç­¾çš„ä¸€äº›å±æ€§é…ç½®å’ŒåŠŸèƒ½ã€‚</p><h3 id="contextæ ‡ç­¾">contextæ ‡ç­¾</h3><p><code>&lt;context&gt;</code>æ ‡ç­¾åœ¨<code>mybatis-generator-core</code>ä¸­å¯¹åº”çš„å®ç°ç±»ä¸º<code>org.mybatis.generator.config.Context</code>ï¼Œå®ƒé™¤äº†å¤§é‡çš„å­æ ‡ç­¾é…ç½®ä¹‹å¤–ï¼Œæ¯”è¾ƒä¸»è¦çš„å±æ€§æ˜¯ï¼š</p><ul><li><code>id</code>ï¼š<code>Context</code>ç¤ºä¾‹çš„å”¯ä¸€<code>ID</code>ï¼Œç”¨äºè¾“å‡ºé”™è¯¯ä¿¡æ¯æ—¶å€™ä½œä¸ºå”¯ä¸€æ ‡è®°ã€‚</li><li><code>targetRuntime</code>ï¼šç”¨äºæ‰§è¡Œä»£ç ç”Ÿæˆæ¨¡å¼ã€‚</li><li><code>defaultModelType</code>ï¼šæ§åˆ¶<code>Domain</code>ç±»çš„ç”Ÿæˆè¡Œä¸ºã€‚æ‰§è¡Œå¼•æ“ä¸º<code>MyBatis3DynamicSql</code>æˆ–è€…<code>MyBatis3Kotlin</code>æ—¶å¿½ç•¥æ­¤é…ç½®ï¼Œå¯é€‰å€¼ï¼š<ul><li><code>conditional</code>ï¼šé»˜è®¤å€¼ï¼Œç±»ä¼¼<code>hierarchical</code>ï¼Œä½†æ˜¯åªæœ‰ä¸€ä¸ªä¸»é”®çš„æ—¶å€™ä¼šåˆå¹¶æ‰€æœ‰å±æ€§ç”Ÿæˆåœ¨åŒä¸€ä¸ªç±»ã€‚</li><li><code>flat</code>ï¼šæ‰€æœ‰å†…å®¹å…¨éƒ¨ç”Ÿæˆåœ¨ä¸€ä¸ªå¯¹è±¡ä¸­ã€‚</li><li><code>hierarchical</code>ï¼šé”®ç”Ÿæˆä¸€ä¸ªXXKeyå¯¹è±¡ï¼ŒBlobç­‰å•ç‹¬ç”Ÿæˆä¸€ä¸ªå¯¹è±¡ï¼Œå…¶ä»–ç®€å•å±æ€§åœ¨ä¸€ä¸ªå¯¹è±¡ä¸­ã€‚</li></ul></li></ul><p><code>targetRuntime</code>å±æ€§çš„å¯é€‰å€¼æ¯”è¾ƒå¤šï¼Œè¿™é‡Œåšä¸ªç®€å•çš„å°ç»“ï¼š</p><table><thead><tr><th style="text-align:center">å±æ€§</th><th style="text-align:center">åŠŸèƒ½æè¿°</th></tr></thead><tbody><tr><td style="text-align:center"><code>MyBatis3DynamicSql</code></td><td style="text-align:center">é»˜è®¤å€¼ï¼Œå…¼å®¹<code>JDK8+</code>å’Œ<code>MyBatis 3.4.2+</code>ï¼Œä¸ä¼šç”Ÿæˆ<code>XML</code>æ˜ å°„æ–‡ä»¶ï¼Œå¿½ç•¥<code>&lt;sqlMapGenerator&gt;</code>çš„é…ç½®é¡¹ï¼Œä¹Ÿå°±æ˜¯<code>Mapper</code>å…¨éƒ¨æ³¨è§£åŒ–ï¼Œä¾èµ–äº<code>MyBatis Dynamic SQL</code>ç±»åº“</td></tr><tr><td style="text-align:center"><code>MyBatis3Kotlin</code></td><td style="text-align:center">è¡Œä¸ºç±»ä¼¼äº<code>MyBatis3DynamicSql</code>ï¼Œä¸è¿‡å…¼å®¹<code>Kotlin</code>çš„ä»£ç ç”Ÿæˆ</td></tr><tr><td style="text-align:center"><code>MyBatis3</code></td><td style="text-align:center">æä¾›åŸºæœ¬çš„åŸºäºåŠ¨æ€<code>SQL</code>çš„<code>CRUD</code>æ–¹æ³•å’Œ<code>XXXByExample</code>æ–¹æ³•ï¼Œä¼šç”Ÿæˆ<code>XML</code>æ˜ å°„æ–‡ä»¶</td></tr><tr><td style="text-align:center"><code>MyBatis3Simple</code></td><td style="text-align:center">æä¾›åŸºæœ¬çš„åŸºäºåŠ¨æ€<code>SQL</code>çš„<code>CRUD</code>æ–¹æ³•ï¼Œä¼šç”Ÿæˆ<code>XML</code>æ˜ å°„æ–‡ä»¶</td></tr><tr><td style="text-align:center"><code>MyBatis3DynamicSqlV1</code></td><td style="text-align:center">å·²ç»è¿‡æ—¶ï¼Œä¸æ¨èä½¿ç”¨</td></tr></tbody></table><p>ç¬”è€…åå‘äºæŠŠ<code>SQL</code>æ–‡ä»¶å’Œä»£ç åˆ†ç¦»ï¼Œæ‰€ä»¥ä¸€èˆ¬é€‰ç”¨<code>MyBatis3</code>æˆ–è€…<code>MyBatis3Simple</code>ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context</span> <span class="attr">id</span>=<span class="string">"default"</span> <span class="attr">targetRuntime</span>=<span class="string">"MyBatis3"</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>&lt;context&gt;</code>æ ‡ç­¾æ”¯æŒ0æˆ–Nä¸ª<code>&lt;property&gt;</code>æ ‡ç­¾ï¼Œ<code>&lt;property&gt;</code>çš„å¯é€‰å±æ€§æœ‰ï¼š</p><table><thead><tr><th style="text-align:center">propertyå±æ€§</th><th style="text-align:center">åŠŸèƒ½æè¿°</th><th style="text-align:center">é»˜è®¤å€¼</th><th style="text-align:center">å¤‡æ³¨</th></tr></thead><tbody><tr><td style="text-align:center"><code>autoDelimitKeywords</code></td><td style="text-align:center">æ˜¯å¦ä½¿ç”¨åˆ†éš”ç¬¦å·æ‹¬ä½æ•°æ®åº“å…³é”®å­—</td><td style="text-align:center"><code>false</code></td><td style="text-align:center">ä¾‹å¦‚<code>MySQL</code>ä¸­ä¼šä½¿ç”¨åå¼•å·æ‹¬ä½å…³é”®å­—</td></tr><tr><td style="text-align:center"><code>beginningDelimiter</code></td><td style="text-align:center">åˆ†éš”ç¬¦å·çš„å¼€å§‹ç¬¦å·</td><td style="text-align:center"><code>&quot;</code></td><td style="text-align:center"></td></tr><tr><td style="text-align:center"><code>endingDelimiter</code></td><td style="text-align:center">åˆ†éš”ç¬¦å·çš„ç»“æŸå·</td><td style="text-align:center"><code>&quot;</code></td><td style="text-align:center"></td></tr><tr><td style="text-align:center"><code>javaFileEncoding</code></td><td style="text-align:center">æ–‡ä»¶çš„ç¼–ç </td><td style="text-align:center"><code>ç³»ç»Ÿé»˜è®¤å€¼</code></td><td style="text-align:center">æ¥æºäº<code>java.nio.charset.Charset</code></td></tr><tr><td style="text-align:center"><code>javaFormatter</code></td><td style="text-align:center">ç±»åå’Œæ–‡ä»¶æ ¼å¼åŒ–å™¨</td><td style="text-align:center"><code>DefaultJavaFormatter</code></td><td style="text-align:center">è§<code>JavaFormatter</code>å’Œ<code>DefaultJavaFormatter</code></td></tr><tr><td style="text-align:center"><code>targetJava8</code></td><td style="text-align:center">æ˜¯å¦JDK8å’Œå¯åŠ¨å…¶ç‰¹æ€§</td><td style="text-align:center"><code>true</code></td><td style="text-align:center"></td></tr><tr><td style="text-align:center"><code>kotlinFileEncoding</code></td><td style="text-align:center"><code>Kotlin</code>æ–‡ä»¶ç¼–ç </td><td style="text-align:center"><code>ç³»ç»Ÿé»˜è®¤å€¼</code></td><td style="text-align:center">æ¥æºäº<code>java.nio.charset.Charset</code></td></tr><tr><td style="text-align:center"><code>kotlinFormatter</code></td><td style="text-align:center"><code>Kotlin</code>ç±»åå’Œæ–‡ä»¶æ ¼å¼åŒ–å™¨</td><td style="text-align:center"><code>DefaultKotlinFormatter</code></td><td style="text-align:center">è§<code>KotlinFormatter</code>å’Œ<code>DefaultKotlinFormatter</code></td></tr><tr><td style="text-align:center"><code>xmlFormatter</code></td><td style="text-align:center"><code>XML</code>æ–‡ä»¶æ ¼å¼åŒ–å™¨</td><td style="text-align:center"><code>DefaultXmlFormatter</code></td><td style="text-align:center">è§<code>XmlFormatter</code>å’Œ<code>DefaultXmlFormatter</code></td></tr></tbody></table><h3 id="jdbcConnectionæ ‡ç­¾">jdbcConnectionæ ‡ç­¾</h3><p><code>&lt;jdbcConnection&gt;</code>æ ‡ç­¾ç”¨äº<strong>æŒ‡å®šæ•°æ®æºçš„è¿æ¥ä¿¡æ¯</strong>ï¼Œå®ƒåœ¨<code>mybatis-generator-core</code>ä¸­å¯¹åº”çš„å®ç°ç±»ä¸º<code>org.mybatis.generator.config.JDBCConnectionConfiguration</code>ï¼Œä¸»è¦å±æ€§åŒ…æ‹¬ï¼š</p><table><thead><tr><th style="text-align:center">å±æ€§</th><th style="text-align:center">åŠŸèƒ½æè¿°</th><th style="text-align:center">æ˜¯å¦å¿…é¡»</th></tr></thead><tbody><tr><td style="text-align:center"><code>driverClass</code></td><td style="text-align:center">æ•°æ®æºé©±åŠ¨çš„å…¨ç±»å</td><td style="text-align:center"><code>Y</code></td></tr><tr><td style="text-align:center"><code>connectionURL</code></td><td style="text-align:center"><code>JDBC</code>çš„è¿æ¥<code>URL</code></td><td style="text-align:center"><code>Y</code></td></tr><tr><td style="text-align:center"><code>userId</code></td><td style="text-align:center">è¿æ¥åˆ°æ•°æ®æºçš„ç”¨æˆ·å</td><td style="text-align:center"><code>N</code></td></tr><tr><td style="text-align:center"><code>password</code></td><td style="text-align:center">è¿æ¥åˆ°æ•°æ®æºçš„å¯†ç </td><td style="text-align:center"><code>N</code></td></tr></tbody></table><h3 id="commentGeneratoræ ‡ç­¾">commentGeneratoræ ‡ç­¾</h3><p><code>&lt;commentGenerator&gt;</code>æ ‡ç­¾æ˜¯å¯é€‰çš„ï¼Œç”¨äº<strong>æ§åˆ¶ç”Ÿæˆçš„å®ä½“çš„æ³¨é‡Šå†…å®¹</strong>ã€‚å®ƒåœ¨<code>mybatis-generator-core</code>ä¸­å¯¹åº”çš„å®ç°ç±»ä¸º<code>org.mybatis.generator.internal.DefaultCommentGenerator</code>ï¼Œå¯ä»¥é€šè¿‡å¯é€‰çš„<code>type</code>å±æ€§æŒ‡å®šä¸€ä¸ªè‡ªå®šä¹‰çš„<code>CommentGenerator</code>å®ç°ã€‚<code>&lt;commentGenerator&gt;</code>æ ‡ç­¾æ”¯æŒ0æˆ–Nä¸ª<code>&lt;property&gt;</code>æ ‡ç­¾ï¼Œ<code>&lt;property&gt;</code>çš„å¯é€‰å±æ€§æœ‰ï¼š</p><table><thead><tr><th style="text-align:center">propertyå±æ€§</th><th style="text-align:center">åŠŸèƒ½æè¿°</th><th style="text-align:center">é»˜è®¤å€¼</th></tr></thead><tbody><tr><td style="text-align:center"><code>suppressAllComments</code></td><td style="text-align:center">æ˜¯å¦ç”Ÿæˆæ³¨é‡Š</td><td style="text-align:center"><code>false</code></td></tr><tr><td style="text-align:center"><code>suppressDate</code></td><td style="text-align:center">æ˜¯å¦åœ¨æ³¨é‡Šä¸­æ·»åŠ ç”Ÿæˆçš„æ—¶é—´æˆ³</td><td style="text-align:center"><code>false</code></td></tr><tr><td style="text-align:center"><code>dateFormat</code></td><td style="text-align:center">é…åˆ<code>suppressDate</code>ä½¿ç”¨ï¼ŒæŒ‡å®šè¾“å‡ºæ—¶é—´æˆ³çš„æ ¼å¼</td><td style="text-align:center"><code>java.util.Date#toString()</code></td></tr><tr><td style="text-align:center"><code>addRemarkComments</code></td><td style="text-align:center">æ˜¯å¦è¾“å‡ºè¡¨å’Œåˆ—çš„<code>Comment</code>ä¿¡æ¯</td><td style="text-align:center"><code>false</code></td></tr></tbody></table><p>ç¬”è€…å»ºè®®ä¿æŒé»˜è®¤å€¼ï¼Œä¹Ÿå°±æ˜¯ä»€ä¹ˆæ³¨é‡Šéƒ½ä¸è¾“å‡ºï¼Œç”Ÿæˆä»£ç å¹²å‡€çš„å®ä½“ã€‚</p><h3 id="javaTypeResolveræ ‡ç­¾">javaTypeResolveræ ‡ç­¾</h3><p><code>&lt;javaTypeResolver&gt;</code>æ ‡ç­¾æ˜¯<code>&lt;context&gt;</code>çš„å­æ ‡ç­¾ï¼Œç”¨äºè§£æå’Œè®¡ç®—æ•°æ®åº“åˆ—ç±»å‹å’Œ<code>Java</code>ç±»å‹çš„æ˜ å°„å…³ç³»ï¼Œè¯¥æ ‡ç­¾åªåŒ…å«ä¸€ä¸ª<code>type</code>å±æ€§ï¼Œç”¨äºæŒ‡å®š<code>org.mybatis.generator.api.JavaTypeResolver</code>æ¥å£çš„å®ç°ç±»ã€‚<code>&lt;javaTypeResolver&gt;</code>æ ‡ç­¾æ”¯æŒ0æˆ–Nä¸ª<code>&lt;property&gt;</code>æ ‡ç­¾ï¼Œ<code>&lt;property&gt;</code>çš„å¯é€‰å±æ€§æœ‰ï¼š</p><table><thead><tr><th style="text-align:center">propertyå±æ€§</th><th style="text-align:center">åŠŸèƒ½æè¿°</th><th style="text-align:center">é»˜è®¤å€¼</th></tr></thead><tbody><tr><td style="text-align:center"><code>forceBigDecimals</code></td><td style="text-align:center">æ˜¯å¦å¼ºåˆ¶æŠŠæ‰€æœ‰çš„æ•°å­—ç±»å‹å¼ºåˆ¶ä½¿ç”¨<code>java.math.BigDecimal</code>ç±»å‹è¡¨ç¤º</td><td style="text-align:center"><code>false</code></td></tr><tr><td style="text-align:center"><code>useJSR310Types</code></td><td style="text-align:center">æ˜¯å¦æ”¯æŒ<code>JSR310</code>ï¼Œä¸»è¦æ˜¯<code>JSR310</code>çš„æ–°æ—¥æœŸç±»å‹</td><td style="text-align:center"><code>false</code></td></tr></tbody></table><p>å¦‚æœ<code>useJSR310Types</code>å±æ€§è®¾ç½®ä¸º<code>true</code>ï¼Œé‚£ä¹ˆç”Ÿæˆä»£ç çš„æ—¶å€™ç±»å‹æ˜ å°„å…³ç³»å¦‚ä¸‹ï¼ˆä¸»è¦é’ˆå¯¹æ—¥æœŸæ—¶é—´ç±»å‹ï¼‰ï¼š</p><table><thead><tr><th style="text-align:center">æ•°æ®åº“ï¼ˆJDBCï¼‰ç±»å‹</th><th style="text-align:center">Javaç±»å‹</th></tr></thead><tbody><tr><td style="text-align:center"><code>DATE</code></td><td style="text-align:center"><code>java.time.LocalDate</code></td></tr><tr><td style="text-align:center"><code>TIME</code></td><td style="text-align:center"><code>java.time.LocalTime</code></td></tr><tr><td style="text-align:center"><code>TIMESTAMP</code></td><td style="text-align:center"><code>java.time.LocalDateTime</code></td></tr><tr><td style="text-align:center"><code>TIME_WITH_TIMEZONE</code></td><td style="text-align:center"><code>java.time.OffsetTime</code></td></tr><tr><td style="text-align:center"><code>TIMESTAMP_WITH_TIMEZONE</code></td><td style="text-align:center"><code>java.time.OffsetDateTime</code></td></tr></tbody></table><p>å¼•å…¥<code>mybatis-generator-core</code>åï¼Œå¯ä»¥æŸ¥çœ‹<code>JavaTypeResolver</code>çš„é»˜è®¤å®ç°ä¸º<code>JavaTypeResolverDefaultImpl</code>ï¼Œä»å®ƒçš„æºç å¯ä»¥å¾—çŸ¥ä¸€äº›æ˜ å°„å…³ç³»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">BIGINT --&gt; Long</span><br><span class="line">BIT --&gt; Boolean</span><br><span class="line">INTEGER --&gt; Integer</span><br><span class="line">SMALLINT --&gt; Short</span><br><span class="line">TINYINT --&gt; Byte</span><br><span class="line">......</span><br></pre></td></tr></table></figure><p>æœ‰äº›æ—¶å€™ï¼Œæˆ‘ä»¬å¸Œæœ›<code>INTEGER</code>ã€<code>SMALLINT</code>å’Œ<code>TINYINT</code>éƒ½æ˜ å°„ä¸º<code>Integer</code>ï¼Œé‚£ä¹ˆæˆ‘ä»¬éœ€è¦è¦†ç›–<code>JavaTypeResolverDefaultImpl</code>çš„æ„é€ æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultJavaTypeResolver</span> <span class="keyword">extends</span> <span class="title">JavaTypeResolverDefaultImpl</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DefaultJavaTypeResolver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        typeMap.put(Types.SMALLINT, <span class="keyword">new</span> JdbcTypeInformation(<span class="string">"SMALLINT"</span>,</span><br><span class="line">                <span class="keyword">new</span> FullyQualifiedJavaType(Integer<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())))</span>;</span><br><span class="line">        typeMap.put(Types.TINYINT, <span class="keyword">new</span> JdbcTypeInformation(<span class="string">"TINYINT"</span>,</span><br><span class="line">                <span class="keyword">new</span> FullyQualifiedJavaType(Integer<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())))</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„ä¸€ç‚¹çš„æ˜¯è¿™ç§è‡ªå®šä¹‰å®ç°<code>JavaTypeResolver</code>æ¥å£çš„æ–¹å¼ä½¿ç”¨ç¼–ç¨‹å¼è¿è¡Œ<code>MBG</code>ä¼šç›¸å¯¹æ–¹ä¾¿ï¼Œå¦‚æœéœ€è¦ä½¿ç”¨<code>Maven</code>æ’ä»¶è¿è¡Œï¼Œé‚£ä¹ˆéœ€è¦æŠŠä¸Šé¢çš„<code>DefaultJavaTypeResolver</code>ç±»æ‰“åŒ…åˆ°æ’ä»¶ä¸­ã€‚</p><h3 id="javaModelGeneratoræ ‡ç­¾">javaModelGeneratoræ ‡ç­¾</h3><p><code>&lt;javaModelGeneratoræ ‡ç­¾&gt;</code>æ ‡ç­¾æ˜¯<code>&lt;context&gt;</code>çš„å­æ ‡ç­¾ï¼Œä¸»è¦ç”¨äºæ§åˆ¶å®ä½“ï¼ˆ<code>Model</code>ï¼‰ç±»çš„ä»£ç ç”Ÿæˆè¡Œä¸ºã€‚å®ƒæ”¯æŒçš„å±æ€§å¦‚ä¸‹ï¼š</p><table><thead><tr><th style="text-align:center">å±æ€§</th><th style="text-align:center">åŠŸèƒ½æè¿°</th><th style="text-align:center">æ˜¯å¦å¿…é¡»</th><th style="text-align:center">å¤‡æ³¨</th></tr></thead><tbody><tr><td style="text-align:center"><code>targetPackage</code></td><td style="text-align:center">ç”Ÿæˆçš„å®ä½“ç±»çš„åŒ…å</td><td style="text-align:center"><code>Y</code></td><td style="text-align:center">ä¾‹å¦‚<code>club.throwable.model</code></td></tr><tr><td style="text-align:center"><code>targetProject</code></td><td style="text-align:center">ç”Ÿæˆçš„å®ä½“ç±»æ–‡ä»¶ç›¸å¯¹äºé¡¹ç›®ï¼ˆæ ¹ç›®å½•ï¼‰çš„ä½ç½®</td><td style="text-align:center"><code>Y</code></td><td style="text-align:center">ä¾‹å¦‚<code>src/main/java</code></td></tr></tbody></table><p><code>&lt;javaModelGeneratoræ ‡ç­¾&gt;</code>æ ‡ç­¾æ”¯æŒ0æˆ–Nä¸ª<code>&lt;property&gt;</code>æ ‡ç­¾ï¼Œ<code>&lt;property&gt;</code>çš„å¯é€‰å±æ€§æœ‰ï¼š</p><table><thead><tr><th style="text-align:center">propertyå±æ€§</th><th style="text-align:center">åŠŸèƒ½æè¿°</th><th style="text-align:center">é»˜è®¤å€¼</th><th style="text-align:center">å¤‡æ³¨</th></tr></thead><tbody><tr><td style="text-align:center"><code>constructorBased</code></td><td style="text-align:center">æ˜¯å¦ç”Ÿæˆä¸€ä¸ªå¸¦æœ‰æ‰€æœ‰å­—æ®µå±æ€§çš„æ„é€ å‡½æ•°</td><td style="text-align:center"><code>false</code></td><td style="text-align:center"><code>MyBatis3Kotlin</code>æ¨¡å¼ä¸‹å¿½ç•¥æ­¤å±æ€§é…ç½®</td></tr><tr><td style="text-align:center"><code>enableSubPackages</code></td><td style="text-align:center">æ˜¯å¦å…è®¸é€šè¿‡<code>Schema</code>ç”Ÿæˆå­åŒ…</td><td style="text-align:center"><code>false</code></td><td style="text-align:center">å¦‚æœä¸º<code>true</code>ï¼Œä¾‹å¦‚åŒ…åä¸º<code>club.throwable</code>ï¼Œå¦‚æœ<code>Schema</code>ä¸º<code>xyz</code>ï¼Œé‚£ä¹ˆå®ä½“ç±»æ–‡ä»¶æœ€ç»ˆä¼šç”Ÿæˆåœ¨<code>club.throwable.xyz</code>ç›®å½•</td></tr><tr><td style="text-align:center"><code>exampleTargetPackage</code></td><td style="text-align:center">ç”Ÿæˆçš„ä¼´éšå®ä½“ç±»çš„<code>Example</code>ç±»çš„åŒ…å</td><td style="text-align:center">-</td><td style="text-align:center">-</td></tr><tr><td style="text-align:center"><code>exampleTargetProject</code></td><td style="text-align:center">ç”Ÿæˆçš„ä¼´éšå®ä½“ç±»çš„<code>Example</code>ç±»æ–‡ä»¶ç›¸å¯¹äºé¡¹ç›®ï¼ˆæ ¹ç›®å½•ï¼‰çš„ä½ç½®</td><td style="text-align:center">-</td><td style="text-align:center">-</td></tr><tr><td style="text-align:center"><code>immutable</code></td><td style="text-align:center">æ˜¯å¦ä¸å¯å˜</td><td style="text-align:center"><code>false</code></td><td style="text-align:center">å¦‚æœä¸º<code>true</code>ï¼Œåˆ™ä¸ä¼šç”Ÿæˆ<code>Setter</code>æ–¹æ³•ï¼Œæ‰€æœ‰å­—æ®µéƒ½ä½¿ç”¨<code>final</code>ä¿®é¥°ï¼Œæä¾›ä¸€ä¸ªå¸¦æœ‰æ‰€æœ‰å­—æ®µå±æ€§çš„æ„é€ å‡½æ•°</td></tr><tr><td style="text-align:center"><code>rootClass</code></td><td style="text-align:center">ä¸ºç”Ÿæˆçš„å®ä½“ç±»æ·»åŠ çˆ¶ç±»</td><td style="text-align:center">-</td><td style="text-align:center">é€šè¿‡<code>value</code>æŒ‡å®šçˆ¶ç±»çš„å…¨ç±»åå³å¯</td></tr><tr><td style="text-align:center"><code>trimStrings</code></td><td style="text-align:center"><code>Setter</code>æ–¹æ³•æ˜¯å¦å¯¹å­—ç¬¦ä¸²ç±»å‹è¿›è¡Œä¸€æ¬¡<code>trim</code>æ“ä½œ</td><td style="text-align:center"><code>false</code></td><td style="text-align:center">-</td></tr></tbody></table><h3 id="javaClientGeneratoræ ‡ç­¾">javaClientGeneratoræ ‡ç­¾</h3><p><code>&lt;javaClientGenerator&gt;</code>æ ‡ç­¾æ˜¯<code>&lt;context&gt;</code>çš„å­æ ‡ç­¾ï¼Œä¸»è¦ç”¨äºæ§åˆ¶<code>Mapper</code>æ¥å£çš„ä»£ç ç”Ÿæˆè¡Œä¸ºã€‚å®ƒæ”¯æŒçš„å±æ€§å¦‚ä¸‹ï¼š</p><table><thead><tr><th style="text-align:center">å±æ€§</th><th style="text-align:center">åŠŸèƒ½æè¿°</th><th style="text-align:center">æ˜¯å¦å¿…é¡»</th><th style="text-align:center">å¤‡æ³¨</th></tr></thead><tbody><tr><td style="text-align:center"><code>type</code></td><td style="text-align:center"><code>Mapper</code>æ¥å£ç”Ÿæˆç­–ç•¥</td><td style="text-align:center"><code>Y</code></td><td style="text-align:center"><code>&lt;context&gt;</code>æ ‡ç­¾çš„<code>targetRuntime</code>å±æ€§ä¸º<code>MyBatis3DynamicSql</code>æˆ–è€…<code>MyBatis3Kotlin</code>æ—¶æ­¤å±æ€§é…ç½®å¿½ç•¥</td></tr><tr><td style="text-align:center"><code>targetPackage</code></td><td style="text-align:center">ç”Ÿæˆçš„<code>Mapper</code>æ¥å£çš„åŒ…å</td><td style="text-align:center"><code>Y</code></td><td style="text-align:center">ä¾‹å¦‚<code>club.throwable.mapper</code></td></tr><tr><td style="text-align:center"><code>targetProject</code></td><td style="text-align:center">ç”Ÿæˆçš„<code>Mapper</code>æ¥å£æ–‡ä»¶ç›¸å¯¹äºé¡¹ç›®ï¼ˆæ ¹ç›®å½•ï¼‰çš„ä½ç½®</td><td style="text-align:center"><code>Y</code></td><td style="text-align:center">ä¾‹å¦‚<code>src/main/java</code></td></tr></tbody></table><p><code>type</code>å±æ€§çš„å¯é€‰å€¼å¦‚ä¸‹ï¼š</p><ul><li><code>ANNOTATEDMAPPER</code>ï¼š<code>Mapper</code>æ¥å£ç”Ÿæˆçš„æ—¶å€™ä¾èµ–äºæ³¨è§£å’Œ<code>SqlProviders</code>ï¼ˆä¹Ÿå°±æ˜¯çº¯æ³¨è§£å®ç°ï¼‰ï¼Œä¸ä¼šç”Ÿæˆ<code>XML</code>æ˜ å°„æ–‡ä»¶ã€‚</li><li><code>XMLMAPPER</code>ï¼š<code>Mapper</code>æ¥å£ç”Ÿæˆæ¥å£æ–¹æ³•ï¼Œå¯¹åº”çš„å®ç°ä»£ç ç”Ÿæˆåœ¨<code>XML</code>æ˜ å°„æ–‡ä»¶ä¸­ï¼ˆä¹Ÿå°±æ˜¯çº¯æ˜ å°„æ–‡ä»¶å®ç°ï¼‰ã€‚</li><li><code>MIXEDMAPPER</code>ï¼š<code>Mapper</code>æ¥å£ç”Ÿæˆçš„æ—¶å€™å¤æ‚çš„æ–¹æ³•å®ç°ç”Ÿæˆåœ¨<code>XML</code>æ˜ å°„æ–‡ä»¶ä¸­ï¼Œè€Œç®€å•çš„å®ç°é€šè¿‡æ³¨è§£å’Œ<code>SqlProviders</code>å®ç°ï¼ˆä¹Ÿå°±æ˜¯æ³¨è§£å’Œæ˜ å°„æ–‡ä»¶æ··åˆå®ç°ï¼‰ã€‚</li></ul><p>æ³¨æ„ä¸¤ç‚¹ï¼š</p><ul><li><code>&lt;context&gt;</code>æ ‡ç­¾çš„<code>targetRuntime</code>å±æ€§æŒ‡å®šä¸º<code>MyBatis3Simple</code>çš„æ—¶å€™ï¼Œ<code>type</code>åªèƒ½é€‰ç”¨<code>ANNOTATEDMAPPER</code>æˆ–è€…<code>XMLMAPPER</code>ã€‚</li><li><code>&lt;context&gt;</code>æ ‡ç­¾çš„<code>targetRuntime</code>å±æ€§æŒ‡å®šä¸º<code>MyBatis3</code>çš„æ—¶å€™ï¼Œ<code>type</code>å¯ä»¥é€‰ç”¨<code>ANNOTATEDMAPPER</code>ã€<code>XMLMAPPER</code>æˆ–è€…<code>MIXEDMAPPER</code>ã€‚</li></ul><p><code>&lt;javaClientGenerator&gt;</code>æ ‡ç­¾æ”¯æŒ0æˆ–Nä¸ª<code>&lt;property&gt;</code>æ ‡ç­¾ï¼Œ<code>&lt;property&gt;</code>çš„å¯é€‰å±æ€§æœ‰ï¼š</p><table><thead><tr><th style="text-align:center">propertyå±æ€§</th><th style="text-align:center">åŠŸèƒ½æè¿°</th><th style="text-align:center">é»˜è®¤å€¼</th><th style="text-align:center">å¤‡æ³¨</th></tr></thead><tbody><tr><td style="text-align:center"><code>enableSubPackages</code></td><td style="text-align:center">æ˜¯å¦å…è®¸é€šè¿‡<code>Schema</code>ç”Ÿæˆå­åŒ…</td><td style="text-align:center"><code>false</code></td><td style="text-align:center">å¦‚æœä¸º<code>true</code>ï¼Œä¾‹å¦‚åŒ…åä¸º<code>club.throwable</code>ï¼Œå¦‚æœ<code>Schema</code>ä¸º<code>xyz</code>ï¼Œé‚£ä¹ˆ<code>Mapper</code>æ¥å£æ–‡ä»¶æœ€ç»ˆä¼šç”Ÿæˆåœ¨<code>club.throwable.xyz</code>ç›®å½•</td></tr><tr><td style="text-align:center"><code>useLegacyBuilder</code></td><td style="text-align:center">æ˜¯å¦é€šè¿‡<code>SQL Builder</code>ç”ŸæˆåŠ¨æ€<code>SQL</code></td><td style="text-align:center"><code>false</code></td><td style="text-align:center"></td></tr><tr><td style="text-align:center"><code>rootInterface</code></td><td style="text-align:center">ä¸ºç”Ÿæˆçš„<code>Mapper</code>æ¥å£æ·»åŠ çˆ¶æ¥å£</td><td style="text-align:center">-</td><td style="text-align:center">é€šè¿‡<code>value</code>æŒ‡å®šçˆ¶æ¥å£çš„å…¨ç±»åå³å¯</td></tr></tbody></table><h3 id="sqlMapGeneratoræ ‡ç­¾">sqlMapGeneratoræ ‡ç­¾</h3><p><code>&lt;sqlMapGenerator&gt;</code>æ ‡ç­¾æ˜¯<code>&lt;context&gt;</code>çš„å­æ ‡ç­¾ï¼Œä¸»è¦ç”¨äºæ§åˆ¶<code>XML</code>æ˜ å°„æ–‡ä»¶çš„ä»£ç ç”Ÿæˆè¡Œä¸ºã€‚å®ƒæ”¯æŒçš„å±æ€§å¦‚ä¸‹ï¼š</p><table><thead><tr><th style="text-align:center">å±æ€§</th><th style="text-align:center">åŠŸèƒ½æè¿°</th><th style="text-align:center">æ˜¯å¦å¿…é¡»</th><th style="text-align:center">å¤‡æ³¨</th></tr></thead><tbody><tr><td style="text-align:center"><code>targetPackage</code></td><td style="text-align:center">ç”Ÿæˆçš„<code>XML</code>æ˜ å°„æ–‡ä»¶çš„åŒ…å</td><td style="text-align:center"><code>Y</code></td><td style="text-align:center">ä¾‹å¦‚<code>mappings</code></td></tr><tr><td style="text-align:center"><code>targetProject</code></td><td style="text-align:center">ç”Ÿæˆçš„<code>XML</code>æ˜ å°„æ–‡ä»¶ç›¸å¯¹äºé¡¹ç›®ï¼ˆæ ¹ç›®å½•ï¼‰çš„ä½ç½®</td><td style="text-align:center"><code>Y</code></td><td style="text-align:center">ä¾‹å¦‚<code>src/main/resources</code></td></tr></tbody></table><p><code>&lt;sqlMapGenerator&gt;</code>æ ‡ç­¾æ”¯æŒ0æˆ–Nä¸ª<code>&lt;property&gt;</code>æ ‡ç­¾ï¼Œ<code>&lt;property&gt;</code>çš„å¯é€‰å±æ€§æœ‰ï¼š</p><table><thead><tr><th style="text-align:center">propertyå±æ€§</th><th style="text-align:center">åŠŸèƒ½æè¿°</th><th style="text-align:center">é»˜è®¤å€¼</th><th style="text-align:center">å¤‡æ³¨</th></tr></thead><tbody><tr><td style="text-align:center"><code>enableSubPackages</code></td><td style="text-align:center">æ˜¯å¦å…è®¸é€šè¿‡<code>Schema</code>ç”Ÿæˆå­åŒ…</td><td style="text-align:center"><code>false</code></td><td style="text-align:center">-</td></tr></tbody></table><h3 id="pluginæ ‡ç­¾">pluginæ ‡ç­¾</h3><p><code>&lt;plugin&gt;</code>æ ‡ç­¾æ˜¯<code>&lt;context&gt;</code>çš„å­æ ‡ç­¾ï¼Œç”¨äºå¼•å…¥ä¸€äº›æ’ä»¶å¯¹ä»£ç ç”Ÿæˆçš„ä¸€äº›ç‰¹æ€§è¿›è¡Œæ‰©å±•ï¼Œè¯¥æ ‡ç­¾åªåŒ…å«ä¸€ä¸ª<code>type</code>å±æ€§ï¼Œç”¨äºæŒ‡å®š<code>org.mybatis.generator.api.Plugin</code>æ¥å£çš„å®ç°ç±»ã€‚å†…ç½®çš„æ’ä»¶å®ç°è§<a href="http://mybatis.org/generator/reference/plugins.html" target="_blank" rel="noopener">Supplied Plugins</a>ã€‚ä¾‹å¦‚ï¼šå¼•å…¥<code>org.mybatis.generator.plugins.SerializablePlugin</code>æ’ä»¶ä¼šè®©ç”Ÿæˆçš„å®ä½“ç±»è‡ªåŠ¨å®ç°<code>java.io.Serializable</code>æ¥å£å¹¶ä¸”æ·»åŠ <code>serialVersionUID</code>å±æ€§ã€‚</p><h3 id="tableæ ‡ç­¾">tableæ ‡ç­¾</h3><p><code>&lt;table&gt;</code>æ ‡ç­¾æ˜¯<code>&lt;context&gt;</code>çš„å­æ ‡ç­¾ï¼Œä¸»è¦ç”¨äºé…ç½®è¦ç”Ÿæˆä»£ç çš„æ•°æ®åº“è¡¨æ ¼ï¼Œå®šåˆ¶ä¸€äº›ä»£ç ç”Ÿæˆè¡Œä¸ºç­‰ç­‰ã€‚å®ƒæ”¯æŒçš„å±æ€§ä¼—å¤šï¼Œåˆ—ä¸¾å¦‚ä¸‹ï¼š</p><table><thead><tr><th style="text-align:center">å±æ€§</th><th style="text-align:center">åŠŸèƒ½æè¿°</th><th style="text-align:center">æ˜¯å¦å¿…é¡»</th><th style="text-align:center">å¤‡æ³¨</th></tr></thead><tbody><tr><td style="text-align:center"><code>tableName</code></td><td style="text-align:center">æ•°æ®åº“è¡¨åç§°</td><td style="text-align:center"><code>Y</code></td><td style="text-align:center">ä¾‹å¦‚<code>t_order</code></td></tr><tr><td style="text-align:center"><code>schema</code></td><td style="text-align:center">æ•°æ®åº“<code>Schema</code></td><td style="text-align:center"><code>N</code></td><td style="text-align:center">-</td></tr><tr><td style="text-align:center"><code>catalog</code></td><td style="text-align:center">æ•°æ®åº“<code>Catalog</code></td><td style="text-align:center"><code>N</code></td><td style="text-align:center">-</td></tr><tr><td style="text-align:center"><code>alias</code></td><td style="text-align:center">è¡¨åç§°æ ‡ç­¾</td><td style="text-align:center"><code>N</code></td><td style="text-align:center">å¦‚æœæŒ‡å®šäº†æ­¤å€¼ï¼Œåˆ™æŸ¥è¯¢åˆ—çš„æ—¶å€™ç»“æœæ ¼å¼ä¸º<code>alias_column</code></td></tr><tr><td style="text-align:center"><code>domainObjectName</code></td><td style="text-align:center">è¡¨å¯¹åº”çš„å®ä½“ç±»åç§°ï¼Œå¯ä»¥é€šè¿‡<code>.</code>æŒ‡å®šåŒ…è·¯å¾„</td><td style="text-align:center"><code>N</code></td><td style="text-align:center">å¦‚æœæŒ‡å®šäº†<code>bar.User</code>ï¼Œåˆ™åŒ…åä¸º<code>bar</code>ï¼Œå®ä½“ç±»åç§°ä¸º<code>User</code></td></tr><tr><td style="text-align:center"><code>mapperName</code></td><td style="text-align:center">è¡¨å¯¹åº”çš„<code>Mapper</code>æ¥å£ç±»åç§°ï¼Œå¯ä»¥é€šè¿‡<code>.</code>æŒ‡å®šåŒ…è·¯å¾„</td><td style="text-align:center"><code>N</code></td><td style="text-align:center">å¦‚æœæŒ‡å®šäº†<code>bar.UserMapper</code>ï¼Œåˆ™åŒ…åä¸º<code>bar</code>ï¼Œ<code>Mapper</code>æ¥å£ç±»åç§°ä¸º<code>UserMapper</code></td></tr><tr><td style="text-align:center"><code>sqlProviderName</code></td><td style="text-align:center">åŠ¨æ€<code>SQL</code>æä¾›ç±»<code>SqlProvider</code>çš„ç±»åç§°</td><td style="text-align:center"><code>N</code></td><td style="text-align:center">-</td></tr><tr><td style="text-align:center"><code>enableInsert</code></td><td style="text-align:center">æ˜¯å¦å…è®¸ç”Ÿæˆ<code>insert</code>æ–¹æ³•</td><td style="text-align:center"><code>N</code></td><td style="text-align:center">é»˜è®¤å€¼ä¸º<code>true</code>ï¼Œæ‰§è¡Œå¼•æ“ä¸º<code>MyBatis3DynamicSql</code>æˆ–è€…<code>MyBatis3Kotlin</code>æ—¶å¿½ç•¥æ­¤é…ç½®</td></tr><tr><td style="text-align:center"><code>enableSelectByPrimaryKey</code></td><td style="text-align:center">æ˜¯å¦å…è®¸ç”Ÿæˆ<code>selectByPrimaryKey</code>æ–¹æ³•</td><td style="text-align:center"><code>N</code></td><td style="text-align:center">é»˜è®¤å€¼ä¸º<code>true</code>ï¼Œæ‰§è¡Œå¼•æ“ä¸º<code>MyBatis3DynamicSql</code>æˆ–è€…<code>MyBatis3Kotlin</code>æ—¶å¿½ç•¥æ­¤é…ç½®</td></tr><tr><td style="text-align:center"><code>enableSelectByExample</code></td><td style="text-align:center">æ˜¯å¦å…è®¸ç”Ÿæˆ<code>selectByExample</code>æ–¹æ³•</td><td style="text-align:center"><code>N</code></td><td style="text-align:center">é»˜è®¤å€¼ä¸º<code>true</code>ï¼Œæ‰§è¡Œå¼•æ“ä¸º<code>MyBatis3DynamicSql</code>æˆ–è€…<code>MyBatis3Kotlin</code>æ—¶å¿½ç•¥æ­¤é…ç½®</td></tr><tr><td style="text-align:center"><code>enableUpdateByPrimaryKey</code></td><td style="text-align:center">æ˜¯å¦å…è®¸ç”Ÿæˆ<code>updateByPrimaryKey</code>æ–¹æ³•</td><td style="text-align:center"><code>N</code></td><td style="text-align:center">é»˜è®¤å€¼ä¸º<code>true</code>ï¼Œæ‰§è¡Œå¼•æ“ä¸º<code>MyBatis3DynamicSql</code>æˆ–è€…<code>MyBatis3Kotlin</code>æ—¶å¿½ç•¥æ­¤é…ç½®</td></tr><tr><td style="text-align:center"><code>enableDeleteByPrimaryKey</code></td><td style="text-align:center">æ˜¯å¦å…è®¸ç”Ÿæˆ<code>deleteByPrimaryKey</code>æ–¹æ³•</td><td style="text-align:center"><code>N</code></td><td style="text-align:center">é»˜è®¤å€¼ä¸º<code>true</code>ï¼Œæ‰§è¡Œå¼•æ“ä¸º<code>MyBatis3DynamicSql</code>æˆ–è€…<code>MyBatis3Kotlin</code>æ—¶å¿½ç•¥æ­¤é…ç½®</td></tr><tr><td style="text-align:center"><code>enableDeleteByExample</code></td><td style="text-align:center">æ˜¯å¦å…è®¸ç”Ÿæˆ<code>deleteByExample</code>æ–¹æ³•</td><td style="text-align:center"><code>N</code></td><td style="text-align:center">é»˜è®¤å€¼ä¸º<code>true</code>ï¼Œæ‰§è¡Œå¼•æ“ä¸º<code>MyBatis3DynamicSql</code>æˆ–è€…<code>MyBatis3Kotlin</code>æ—¶å¿½ç•¥æ­¤é…ç½®</td></tr><tr><td style="text-align:center"><code>enableCountByExample</code></td><td style="text-align:center">æ˜¯å¦å…è®¸ç”Ÿæˆ<code>countByExample</code>æ–¹æ³•</td><td style="text-align:center"><code>N</code></td><td style="text-align:center">é»˜è®¤å€¼ä¸º<code>true</code>ï¼Œæ‰§è¡Œå¼•æ“ä¸º<code>MyBatis3DynamicSql</code>æˆ–è€…<code>MyBatis3Kotlin</code>æ—¶å¿½ç•¥æ­¤é…ç½®</td></tr><tr><td style="text-align:center"><code>enableUpdateByExample</code></td><td style="text-align:center">æ˜¯å¦å…è®¸ç”Ÿæˆ<code>updateByExample</code>æ–¹æ³•</td><td style="text-align:center"><code>N</code></td><td style="text-align:center">é»˜è®¤å€¼ä¸º<code>true</code>ï¼Œæ‰§è¡Œå¼•æ“ä¸º<code>MyBatis3DynamicSql</code>æˆ–è€…<code>MyBatis3Kotlin</code>æ—¶å¿½ç•¥æ­¤é…ç½®</td></tr><tr><td style="text-align:center"><code>selectByPrimaryKeyQueryId</code></td><td style="text-align:center"><code>value</code>æŒ‡å®šå¯¹åº”çš„ä¸»é”®åˆ—æä¾›åˆ—è¡¨æŸ¥è¯¢åŠŸèƒ½</td><td style="text-align:center"><code>N</code></td><td style="text-align:center">æ‰§è¡Œå¼•æ“ä¸º<code>MyBatis3DynamicSql</code>æˆ–è€…<code>MyBatis3Kotlin</code>æ—¶å¿½ç•¥æ­¤é…ç½®</td></tr><tr><td style="text-align:center"><code>selectByExampleQueryId</code></td><td style="text-align:center"><code>value</code>æŒ‡å®šå¯¹åº”çš„æŸ¥è¯¢<code>ID</code>æä¾›åˆ—è¡¨æŸ¥è¯¢åŠŸèƒ½</td><td style="text-align:center"><code>N</code></td><td style="text-align:center">æ‰§è¡Œå¼•æ“ä¸º<code>MyBatis3DynamicSql</code>æˆ–è€…<code>MyBatis3Kotlin</code>æ—¶å¿½ç•¥æ­¤é…ç½®</td></tr><tr><td style="text-align:center"><code>modelType</code></td><td style="text-align:center">è¦†ç›–<code>&lt;context&gt;</code>çš„<code>defaultModelType</code>å±æ€§</td><td style="text-align:center"><code>N</code></td><td style="text-align:center">è§<code>&lt;context&gt;</code>çš„<code>defaultModelType</code>å±æ€§</td></tr><tr><td style="text-align:center"><code>escapeWildcards</code></td><td style="text-align:center">æ˜¯å¦å¯¹é€šé…ç¬¦è¿›è¡Œè½¬ä¹‰</td><td style="text-align:center"><code>N</code></td><td style="text-align:center">-</td></tr><tr><td style="text-align:center"><code>delimitIdentifiers</code></td><td style="text-align:center">æ ‡è®°åŒ¹é…è¡¨åç§°çš„æ—¶å€™æ˜¯å¦éœ€è¦ä½¿ç”¨åˆ†éš”ç¬¦å»æ ‡è®°ç”Ÿæˆçš„SQL</td><td style="text-align:center"><code>N</code></td><td style="text-align:center">-</td></tr><tr><td style="text-align:center"><code>delimitAllColumns</code></td><td style="text-align:center">æ˜¯å¦æ‰€æœ‰çš„åˆ—éƒ½æ·»åŠ åˆ†éš”ç¬¦</td><td style="text-align:center"><code>N</code></td><td style="text-align:center">é»˜è®¤å€¼ä¸º<code>false</code>ï¼Œå¦‚æœè®¾ç½®ä¸º<code>true</code>ï¼Œæ‰€æœ‰åˆ—åä¼šæ·»åŠ èµ·å§‹å’Œç»“æŸåˆ†éš”ç¬¦</td></tr></tbody></table><p><code>&lt;table&gt;</code>æ ‡ç­¾æ”¯æŒ0æˆ–Nä¸ª<code>&lt;property&gt;</code>æ ‡ç­¾ï¼Œ<code>&lt;property&gt;</code>çš„å¯é€‰å±æ€§æœ‰ï¼š</p><table><thead><tr><th style="text-align:center">propertyå±æ€§</th><th style="text-align:center">åŠŸèƒ½æè¿°</th><th style="text-align:center">é»˜è®¤å€¼</th><th style="text-align:center">å¤‡æ³¨</th></tr></thead><tbody><tr><td style="text-align:center"><code>constructorBased</code></td><td style="text-align:center">æ˜¯å¦ä¸ºå®ä½“ç±»ç”Ÿæˆä¸€ä¸ªå¸¦æœ‰æ‰€æœ‰å­—æ®µçš„æ„é€ å‡½æ•°</td><td style="text-align:center"><code>false</code></td><td style="text-align:center">æ‰§è¡Œå¼•æ“ä¸º<code>MyBatis3Kotlin</code>çš„æ—¶å€™æ­¤å±æ€§å¿½ç•¥</td></tr><tr><td style="text-align:center"><code>ignoreQualifiersAtRuntime</code></td><td style="text-align:center">æ˜¯å¦åœ¨è¿è¡Œæ—¶å¿½ç•¥åˆ«å</td><td style="text-align:center"><code>false</code></td><td style="text-align:center">å¦‚æœä¸º<code>true</code>ï¼Œåˆ™ä¸ä¼šåœ¨ç”Ÿæˆè¡¨çš„æ—¶å€™æŠŠ<code>schema</code>å’Œ<code>catalog</code>ä½œä¸ºè¡¨çš„å‰ç¼€</td></tr><tr><td style="text-align:center"><code>immutable</code></td><td style="text-align:center">å®ä½“ç±»æ˜¯å¦ä¸å¯å˜</td><td style="text-align:center"><code>false</code></td><td style="text-align:center">æ‰§è¡Œå¼•æ“ä¸º<code>MyBatis3Kotlin</code>çš„æ—¶å€™æ­¤å±æ€§å¿½ç•¥</td></tr><tr><td style="text-align:center"><code>modelOnly</code></td><td style="text-align:center">æ˜¯å¦ä»…ä»…ç”Ÿæˆå®ä½“ç±»</td><td style="text-align:center"><code>false</code></td><td style="text-align:center">-</td></tr><tr><td style="text-align:center"><code>rootClass</code></td><td style="text-align:center">å¦‚æœé…ç½®æ­¤å±æ€§ï¼Œåˆ™å®ä½“ç±»ä¼šç»§æ‰¿æ­¤æŒ‡å®šçš„è¶…ç±»</td><td style="text-align:center"><code>-</code></td><td style="text-align:center">å¦‚æœæœ‰ä¸»é”®å±æ€§ä¼šæŠŠä¸»é”®å±æ€§åœ¨è¶…ç±»ç”Ÿæˆ</td></tr><tr><td style="text-align:center"><code>rootInterface</code></td><td style="text-align:center">å¦‚æœé…ç½®æ­¤å±æ€§ï¼Œåˆ™å®ä½“ç±»ä¼šå®ç°æ­¤æŒ‡å®šçš„æ¥å£</td><td style="text-align:center"><code>-</code></td><td style="text-align:center">æ‰§è¡Œå¼•æ“ä¸º<code>MyBatis3Kotlin</code>æˆ–è€…<code>MyBatis3DynamicSql</code>çš„æ—¶å€™æ­¤å±æ€§å¿½ç•¥</td></tr><tr><td style="text-align:center"><code>runtimeCatalog</code></td><td style="text-align:center">æŒ‡å®šè¿è¡Œæ—¶çš„<code>Catalog</code></td><td style="text-align:center"><code>-</code></td><td style="text-align:center">å½“ç”Ÿæˆè¡¨å’Œè¿è¡Œæ—¶çš„è¡¨çš„<code>Catalog</code>ä¸ä¸€æ ·çš„æ—¶å€™å¯ä»¥ä½¿ç”¨è¯¥å±æ€§è¿›è¡Œé…ç½®</td></tr><tr><td style="text-align:center"><code>runtimeSchema</code></td><td style="text-align:center">æŒ‡å®šè¿è¡Œæ—¶çš„<code>Schema</code></td><td style="text-align:center"><code>-</code></td><td style="text-align:center">å½“ç”Ÿæˆè¡¨å’Œè¿è¡Œæ—¶çš„è¡¨çš„<code>Schema</code>ä¸ä¸€æ ·çš„æ—¶å€™å¯ä»¥ä½¿ç”¨è¯¥å±æ€§è¿›è¡Œé…ç½®</td></tr><tr><td style="text-align:center"><code>runtimeTableName</code></td><td style="text-align:center">æŒ‡å®šè¿è¡Œæ—¶çš„è¡¨åç§°</td><td style="text-align:center"><code>-</code></td><td style="text-align:center">å½“ç”Ÿæˆè¡¨å’Œè¿è¡Œæ—¶çš„è¡¨çš„è¡¨åç§°ä¸ä¸€æ ·çš„æ—¶å€™å¯ä»¥ä½¿ç”¨è¯¥å±æ€§è¿›è¡Œé…ç½®</td></tr><tr><td style="text-align:center"><code>selectAllOrderByClause</code></td><td style="text-align:center">æŒ‡å®šå­—å¥å†…å®¹æ·»åŠ åˆ°<code>selectAll()</code>æ–¹æ³•çš„<code>order by</code>å­å¥ä¹‹ä¸­</td><td style="text-align:center"><code>-</code></td><td style="text-align:center">æ‰§è¡Œå¼•æ“ä¸º<code>MyBatis3Simple</code>çš„æ—¶å€™æ­¤å±æ€§æ‰é€‚ç”¨</td></tr><tr><td style="text-align:center"><code>trimStrings</code></td><td style="text-align:center">å®ä½“ç±»çš„å­—ç¬¦ä¸²ç±»å‹å±æ€§ä¼šåš<code>trim</code>å¤„ç†</td><td style="text-align:center"><code>-</code></td><td style="text-align:center">æ‰§è¡Œå¼•æ“ä¸º<code>MyBatis3Kotlin</code>çš„æ—¶å€™æ­¤å±æ€§å¿½ç•¥</td></tr><tr><td style="text-align:center"><code>useActualColumnNames</code></td><td style="text-align:center">æ˜¯å¦ä½¿ç”¨åˆ—åä½œä¸ºå®ä½“ç±»çš„å±æ€§å</td><td style="text-align:center"><code>false</code></td><td style="text-align:center">-</td></tr><tr><td style="text-align:center"><code>useColumnIndexes</code></td><td style="text-align:center"><code>XML</code>æ˜ å°„æ–‡ä»¶ä¸­ç”Ÿæˆçš„<code>ResultMap</code>ä½¿ç”¨åˆ—ç´¢å¼•å®šä¹‰è€Œä¸æ˜¯åˆ—åç§°</td><td style="text-align:center"><code>false</code></td><td style="text-align:center">æ‰§è¡Œå¼•æ“ä¸º<code>MyBatis3Kotlin</code>æˆ–è€…<code>MyBatis3DynamicSql</code>çš„æ—¶å€™æ­¤å±æ€§å¿½ç•¥</td></tr><tr><td style="text-align:center"><code>useCompoundPropertyNames</code></td><td style="text-align:center">æ˜¯å¦æŠŠåˆ—åå’Œåˆ—å¤‡æ³¨æ‹¼æ¥èµ·æ¥ç”Ÿæˆå®ä½“ç±»å±æ€§å</td><td style="text-align:center"><code>false</code></td><td style="text-align:center">-</td></tr></tbody></table><p><code>&lt;table&gt;</code>æ ‡ç­¾è¿˜æ”¯æŒä¼—å¤šçš„<strong>é</strong><code>property</code>çš„å­æ ‡ç­¾ï¼š</p><ul><li>0æˆ–1ä¸ª<code>&lt;generatedKey&gt;</code>ç”¨äºæŒ‡å®šä¸»é”®ç”Ÿæˆçš„è§„åˆ™ï¼ŒæŒ‡å®šæ­¤æ ‡ç­¾åä¼šç”Ÿæˆä¸€ä¸ª<code>&lt;selectKey&gt;</code>æ ‡ç­¾ï¼š</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- columnï¼šæŒ‡å®šä¸»é”®åˆ— --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- sqlStatementï¼šæŸ¥è¯¢ä¸»é”®çš„SQLè¯­å¥ï¼Œä¾‹å¦‚å¡«å†™äº†MySqlï¼Œåˆ™ä½¿ç”¨SELECT LAST_INSERT_ID() --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- typeï¼šå¯é€‰å€¼ä¸ºpreæˆ–è€…postï¼ŒpreæŒ‡å®šselectKeyæ ‡ç­¾çš„orderä¸ºBEFOREï¼ŒpostæŒ‡å®šselectKeyæ ‡ç­¾çš„orderä¸ºAFTER --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- identityï¼štrueçš„æ—¶å€™ï¼ŒæŒ‡å®šselectKeyæ ‡ç­¾çš„orderä¸ºAFTER --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">generatedKey</span> <span class="attr">column</span>=<span class="string">"id"</span> <span class="attr">sqlStatement</span>=<span class="string">"MySql"</span> <span class="attr">type</span>=<span class="string">"post"</span> <span class="attr">identity</span>=<span class="string">"true"</span> /&gt;</span></span><br></pre></td></tr></table></figure><ul><li>0æˆ–1ä¸ª<code>&lt;domainObjectRenamingRule&gt;</code>ç”¨äºæŒ‡å®šå®ä½“ç±»é‡å‘½åè§„åˆ™ï¼š</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- searchStringä¸­æ­£åˆ™å‘½ä¸­çš„å®ä½“ç±»åéƒ¨åˆ†ä¼šæ›¿æ¢ä¸ºreplaceString --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">domainObjectRenamingRule</span> <span class="attr">searchString</span>=<span class="string">"^Sys"</span> <span class="attr">replaceString</span>=<span class="string">""</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- ä¾‹å¦‚ SysUserä¼šå˜æˆUser --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- ä¾‹å¦‚ SysUserMapperä¼šå˜æˆUserMapper --&gt;</span></span><br></pre></td></tr></table></figure><ul><li>0æˆ–1ä¸ª<code>&lt;columnRenamingRule&gt;</code>ç”¨äºæŒ‡å®šåˆ—é‡å‘½åè§„åˆ™ï¼š</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- searchStringä¸­æ­£åˆ™å‘½ä¸­çš„åˆ—åéƒ¨åˆ†ä¼šæ›¿æ¢ä¸ºreplaceString --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">columnRenamingRule</span> <span class="attr">searchString</span>=<span class="string">"^CUST_"</span> <span class="attr">replaceString</span>=<span class="string">""</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- ä¾‹å¦‚ CUST_BUSINESS_NAMEä¼šå˜æˆBUSINESS_NAMEï¼ˆuseActualColumnNames=trueï¼‰ --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- ä¾‹å¦‚ CUST_BUSINESS_NAMEä¼šå˜æˆbusinessNameï¼ˆuseActualColumnNames=falseï¼‰ --&gt;</span></span><br></pre></td></tr></table></figure><ul><li>0æˆ–Nä¸ª<code>&lt;columnOverride&gt;</code>ç”¨äºæŒ‡å®šå…·ä½“åˆ—çš„è¦†ç›–æ˜ å°„è§„åˆ™ï¼š</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- columnï¼šæŒ‡å®šè¦è¦†ç›–é…ç½®çš„åˆ— --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- propertyï¼šæŒ‡å®šè¦è¦†ç›–é…ç½®çš„å±æ€§ --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- delimitedColumnNameï¼šæ˜¯å¦ä¸ºåˆ—åæ·»åŠ å®šç•Œç¬¦ï¼Œä¾‹å¦‚`&#123;column&#125;` --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- isGeneratedAlwaysï¼šæ˜¯å¦ä¸€å®šç”Ÿæˆæ­¤åˆ— --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">columnOverride</span> <span class="attr">column</span>=<span class="string">"customer_name"</span> <span class="attr">property</span>=<span class="string">"customerName"</span> <span class="attr">javaType</span>=<span class="string">""</span> <span class="attr">jdbcType</span>=<span class="string">""</span> <span class="attr">typeHandler</span>=<span class="string">""</span> <span class="attr">delimitedColumnName</span>=<span class="string">""</span> <span class="attr">isGeneratedAlways</span>=<span class="string">""</span>&gt;</span></span><br><span class="line">   <span class="comment">&lt;!-- è¦†ç›–tableæˆ–è€…javaModelGeneratorçº§åˆ«çš„trimStringså±æ€§é…ç½® --&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"trimStrings"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">columnOverride</span>/&gt;</span></span><br></pre></td></tr></table></figure><ul><li>0æˆ–Nä¸ª<code>&lt;ignoreColumn&gt;</code>ç”¨äºæŒ‡å®šå¿½ç•¥ç”Ÿæˆçš„åˆ—ï¼š</li></ul><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">ignoreColumn</span> <span class="attr">column</span>=<span class="string">"version"</span> <span class="attr">delimitedColumnName</span>=<span class="string">"false"</span>/&gt;</span></span><br></pre></td></tr></table></figure><h2 id="å®æˆ˜">å®æˆ˜</h2><p>å¦‚æœéœ€è¦æ·±åº¦å®šåˆ¶ä¸€äº›ä»£ç ç”Ÿæˆè¡Œä¸ºï¼Œå»ºè®®å¼•å…¥<code>mybatis-generator-core</code>å¹¶ä¸”é€šè¿‡ç¼–ç¨‹å¼æ‰§è¡Œä»£ç ç”Ÿæˆæ–¹æ³•ï¼Œå¦åˆ™å¯ä»¥é€‰ç”¨<code>Maven</code>æ’ä»¶ã€‚å‡è®¾æˆ‘ä»¬åœ¨æœ¬åœ°æ•°æ®<code>local</code>æœ‰ä¸€å¼ <code>t_order</code>è¡¨å¦‚ä¸‹ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`t_order`</span></span><br><span class="line">(</span><br><span class="line">    <span class="keyword">id</span>           <span class="built_in">BIGINT</span> <span class="keyword">UNSIGNED</span> PRIMARY <span class="keyword">KEY</span> <span class="keyword">COMMENT</span> <span class="string">'ä¸»é”®'</span>,</span><br><span class="line">    order_id     <span class="built_in">VARCHAR</span>(<span class="number">64</span>)    <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">COMMENT</span> <span class="string">'è®¢å•ID'</span>,</span><br><span class="line">    create_time  DATETIME       <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="keyword">CURRENT_TIMESTAMP</span> <span class="keyword">COMMENT</span> <span class="string">'åˆ›å»ºæ—¶é—´'</span>,</span><br><span class="line">    amount       <span class="built_in">DECIMAL</span>(<span class="number">10</span>, <span class="number">2</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">'é‡‘é¢'</span>,</span><br><span class="line">    order_status <span class="built_in">TINYINT</span>        <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="number">0</span> <span class="keyword">COMMENT</span> <span class="string">'è®¢å•çŠ¶æ€'</span>,</span><br><span class="line">    <span class="keyword">UNIQUE</span> uniq_order_id (<span class="string">`order_id`</span>)</span><br><span class="line">) <span class="keyword">COMMENT</span> <span class="string">'è®¢å•è¡¨'</span>;</span><br></pre></td></tr></table></figure><p>å‡è®¾é¡¹ç›®çš„ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mbg-sample</span><br><span class="line">  - main</span><br><span class="line">   - java</span><br><span class="line">    - club</span><br><span class="line">     - throwable</span><br><span class="line">   - resources</span><br></pre></td></tr></table></figure><p>ä¸‹é¢ä¼šåŸºäºæ­¤å‰æä¸¾ä¸‰ä¸ªä¾‹å­ã€‚ç¼–å†™åŸºç¡€çš„<code>XML</code>é…ç½®æ–‡ä»¶ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">generatorConfiguration</span></span></span><br><span class="line"><span class="meta">        <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org//DTD MyBatis Generator Configuration 1.0//EN"</span></span></span><br><span class="line"><span class="meta">        <span class="meta-string">"http://mybatis.org/dtd/mybatis-generator-config_1_0.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">generatorConfiguration</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- é©±åŠ¨åŒ…ç»å¯¹è·¯å¾„ --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">classPathEntry</span></span></span><br><span class="line"><span class="tag">            <span class="attr">location</span>=<span class="string">"I:\Develop\Maven-Repository\mysql\mysql-connector-java\5.1.48\mysql-connector-java-5.1.48.jar"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">context</span> <span class="attr">id</span>=<span class="string">"default"</span> <span class="attr">targetRuntime</span>=<span class="string">"è¿™é‡Œé€‰æ‹©åˆé€‚çš„å¼•æ“"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"javaFileEncoding"</span> <span class="attr">value</span>=<span class="string">"UTF-8"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- ä¸è¾“å‡ºæ³¨é‡Š --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">commentGenerator</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"suppressDate"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"suppressAllComments"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">commentGenerator</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">jdbcConnection</span> <span class="attr">driverClass</span>=<span class="string">"com.mysql.jdbc.Driver"</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">connectionURL</span>=<span class="string">"jdbc:mysql://localhost:3306/local"</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">userId</span>=<span class="string">"root"</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">password</span>=<span class="string">"root"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">jdbcConnection</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">&lt;!-- ä¸å¼ºåˆ¶æŠŠæ‰€æœ‰çš„æ•°å­—ç±»å‹è½¬åŒ–ä¸ºBigDecimal --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">javaTypeResolver</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"forceBigDecimals"</span> <span class="attr">value</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">javaTypeResolver</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">javaModelGenerator</span> <span class="attr">targetPackage</span>=<span class="string">"club.throwable.entity"</span> <span class="attr">targetProject</span>=<span class="string">"src/main/java"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"enableSubPackages"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">javaModelGenerator</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">sqlMapGenerator</span> <span class="attr">targetPackage</span>=<span class="string">"mappings"</span> <span class="attr">targetProject</span>=<span class="string">"src/main/resources"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"enableSubPackages"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">sqlMapGenerator</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">javaClientGenerator</span> <span class="attr">type</span>=<span class="string">"è¿™é‡Œé€‰æ‹©åˆé€‚çš„Mapperç±»å‹"</span> <span class="attr">targetPackage</span>=<span class="string">"club.throwable.dao"</span> <span class="attr">targetProject</span>=<span class="string">"src/main/java"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"enableSubPackages"</span> <span class="attr">value</span>=<span class="string">"true"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">javaClientGenerator</span>&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">table</span> <span class="attr">tableName</span>=<span class="string">"t_order"</span></span></span><br><span class="line"><span class="tag">               <span class="attr">enableCountByExample</span>=<span class="string">"false"</span></span></span><br><span class="line"><span class="tag">               <span class="attr">enableDeleteByExample</span>=<span class="string">"false"</span></span></span><br><span class="line"><span class="tag">               <span class="attr">enableSelectByExample</span>=<span class="string">"false"</span></span></span><br><span class="line"><span class="tag">               <span class="attr">enableUpdateByExample</span>=<span class="string">"false"</span></span></span><br><span class="line"><span class="tag">               <span class="attr">domainObjectName</span>=<span class="string">"Order"</span></span></span><br><span class="line"><span class="tag">               <span class="attr">mapperName</span>=<span class="string">"OrderMapper"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">generatedKey</span> <span class="attr">column</span>=<span class="string">"id"</span> <span class="attr">sqlStatement</span>=<span class="string">"MySql"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">context</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">generatorConfiguration</span>&gt;</span></span><br></pre></td></tr></table></figure><h3 id="çº¯æ³¨è§£">çº¯æ³¨è§£</h3><p>ä½¿ç”¨çº¯æ³¨è§£éœ€è¦å¼•å…¥<code>mybatis-dynamic-sql</code>ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.dynamic-sql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-dynamic-sql<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.4<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>éœ€è¦ä¿®æ”¹ä¸¤ä¸ªä½ç½®ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context</span> <span class="attr">id</span>=<span class="string">"default"</span> <span class="attr">targetRuntime</span>=<span class="string">"MyBatis3DynamicSql"</span>&gt;</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">javaClientGenerator</span> <span class="attr">type</span>=<span class="string">"ANNOTATEDMAPPER"</span></span></span><br><span class="line"><span class="tag"><span class="attr">...</span></span></span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœä¼šç”Ÿæˆä¸‰ä¸ªç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// club.throwable.entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Order</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Generated</span>(<span class="string">"org.mybatis.generator.api.MyBatisGenerator"</span>)</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Generated</span>(<span class="string">"org.mybatis.generator.api.MyBatisGenerator"</span>)</span><br><span class="line">    <span class="keyword">private</span> String orderId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Generated</span>(<span class="string">"org.mybatis.generator.api.MyBatisGenerator"</span>)</span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Generated</span>(<span class="string">"org.mybatis.generator.api.MyBatisGenerator"</span>)</span><br><span class="line">    <span class="keyword">private</span> BigDecimal amount;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Generated</span>(<span class="string">"org.mybatis.generator.api.MyBatisGenerator"</span>)</span><br><span class="line">    <span class="keyword">private</span> Byte orderStatus;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Generated</span>(<span class="string">"org.mybatis.generator.api.MyBatisGenerator"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Generated</span>(<span class="string">"org.mybatis.generator.api.MyBatisGenerator"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Generated</span>(<span class="string">"org.mybatis.generator.api.MyBatisGenerator"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getOrderId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> orderId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Generated</span>(<span class="string">"org.mybatis.generator.api.MyBatisGenerator"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOrderId</span><span class="params">(String orderId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.orderId = orderId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Generated</span>(<span class="string">"org.mybatis.generator.api.MyBatisGenerator"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Date <span class="title">getCreateTime</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> createTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Generated</span>(<span class="string">"org.mybatis.generator.api.MyBatisGenerator"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCreateTime</span><span class="params">(Date createTime)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.createTime = createTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Generated</span>(<span class="string">"org.mybatis.generator.api.MyBatisGenerator"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> BigDecimal <span class="title">getAmount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> amount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Generated</span>(<span class="string">"org.mybatis.generator.api.MyBatisGenerator"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAmount</span><span class="params">(BigDecimal amount)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.amount = amount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Generated</span>(<span class="string">"org.mybatis.generator.api.MyBatisGenerator"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Byte <span class="title">getOrderStatus</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> orderStatus;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Generated</span>(<span class="string">"org.mybatis.generator.api.MyBatisGenerator"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOrderStatus</span><span class="params">(Byte orderStatus)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.orderStatus = orderStatus;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// club.throwable.dao</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderDynamicSqlSupport</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Generated</span>(<span class="string">"org.mybatis.generator.api.MyBatisGenerator"</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Order order = <span class="keyword">new</span> Order();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Generated</span>(<span class="string">"org.mybatis.generator.api.MyBatisGenerator"</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> SqlColumn&lt;Long&gt; id = order.id;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Generated</span>(<span class="string">"org.mybatis.generator.api.MyBatisGenerator"</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> SqlColumn&lt;String&gt; orderId = order.orderId;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Generated</span>(<span class="string">"org.mybatis.generator.api.MyBatisGenerator"</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> SqlColumn&lt;Date&gt; createTime = order.createTime;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Generated</span>(<span class="string">"org.mybatis.generator.api.MyBatisGenerator"</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> SqlColumn&lt;BigDecimal&gt; amount = order.amount;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Generated</span>(<span class="string">"org.mybatis.generator.api.MyBatisGenerator"</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> SqlColumn&lt;Byte&gt; orderStatus = order.orderStatus;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Generated</span>(<span class="string">"org.mybatis.generator.api.MyBatisGenerator"</span>)</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">Order</span> <span class="keyword">extends</span> <span class="title">SqlTable</span> </span>&#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> SqlColumn&lt;Long&gt; id = column(<span class="string">"id"</span>, JDBCType.BIGINT);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> SqlColumn&lt;String&gt; orderId = column(<span class="string">"order_id"</span>, JDBCType.VARCHAR);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> SqlColumn&lt;Date&gt; createTime = column(<span class="string">"create_time"</span>, JDBCType.TIMESTAMP);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> SqlColumn&lt;BigDecimal&gt; amount = column(<span class="string">"amount"</span>, JDBCType.DECIMAL);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">final</span> SqlColumn&lt;Byte&gt; orderStatus = column(<span class="string">"order_status"</span>, JDBCType.TINYINT);</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Order</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">super</span>(<span class="string">"t_order"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Mapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OrderMapper</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Generated</span>(<span class="string">"org.mybatis.generator.api.MyBatisGenerator"</span>)</span><br><span class="line">    BasicColumn[] selectList = BasicColumn.columnList(id, orderId, createTime, amount, orderStatus);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Generated</span>(<span class="string">"org.mybatis.generator.api.MyBatisGenerator"</span>)</span><br><span class="line">    <span class="meta">@SelectProvider</span>(type=SqlProviderAdapter<span class="class">.<span class="keyword">class</span>, <span class="title">method</span></span>=<span class="string">"select"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">count</span><span class="params">(SelectStatementProvider selectStatement)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Generated</span>(<span class="string">"org.mybatis.generator.api.MyBatisGenerator"</span>)</span><br><span class="line">    <span class="meta">@DeleteProvider</span>(type=SqlProviderAdapter<span class="class">.<span class="keyword">class</span>, <span class="title">method</span></span>=<span class="string">"delete"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">delete</span><span class="params">(DeleteStatementProvider deleteStatement)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Generated</span>(<span class="string">"org.mybatis.generator.api.MyBatisGenerator"</span>)</span><br><span class="line">    <span class="meta">@InsertProvider</span>(type=SqlProviderAdapter<span class="class">.<span class="keyword">class</span>, <span class="title">method</span></span>=<span class="string">"insert"</span>)</span><br><span class="line">    <span class="meta">@SelectKey</span>(statement=<span class="string">"SELECT LAST_INSERT_ID()"</span>, keyProperty=<span class="string">"record.id"</span>, before=<span class="keyword">true</span>, resultType=Long<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class">    <span class="title">int</span> <span class="title">insert</span>(<span class="title">InsertStatementProvider</span>&lt;<span class="title">Order</span>&gt; <span class="title">insertStatement</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Generated</span>(<span class="string">"org.mybatis.generator.api.MyBatisGenerator"</span>)</span><br><span class="line">    <span class="meta">@SelectProvider</span>(type=SqlProviderAdapter<span class="class">.<span class="keyword">class</span>, <span class="title">method</span></span>=<span class="string">"select"</span>)</span><br><span class="line">    <span class="meta">@Results</span>(id=<span class="string">"OrderResult"</span>, value = &#123;</span><br><span class="line">        <span class="meta">@Result</span>(column=<span class="string">"id"</span>, property=<span class="string">"id"</span>, jdbcType=JdbcType.BIGINT, id=<span class="keyword">true</span>),</span><br><span class="line">        <span class="meta">@Result</span>(column=<span class="string">"order_id"</span>, property=<span class="string">"orderId"</span>, jdbcType=JdbcType.VARCHAR),</span><br><span class="line">        <span class="meta">@Result</span>(column=<span class="string">"create_time"</span>, property=<span class="string">"createTime"</span>, jdbcType=JdbcType.TIMESTAMP),</span><br><span class="line">        <span class="meta">@Result</span>(column=<span class="string">"amount"</span>, property=<span class="string">"amount"</span>, jdbcType=JdbcType.DECIMAL),</span><br><span class="line">        <span class="meta">@Result</span>(column=<span class="string">"order_status"</span>, property=<span class="string">"orderStatus"</span>, jdbcType=JdbcType.TINYINT)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="function">Optional&lt;Order&gt; <span class="title">selectOne</span><span class="params">(SelectStatementProvider selectStatement)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Generated</span>(<span class="string">"org.mybatis.generator.api.MyBatisGenerator"</span>)</span><br><span class="line">    <span class="meta">@SelectProvider</span>(type=SqlProviderAdapter<span class="class">.<span class="keyword">class</span>, <span class="title">method</span></span>=<span class="string">"select"</span>)</span><br><span class="line">    <span class="meta">@Results</span>(id=<span class="string">"OrderResult"</span>, value = &#123;</span><br><span class="line">        <span class="meta">@Result</span>(column=<span class="string">"id"</span>, property=<span class="string">"id"</span>, jdbcType=JdbcType.BIGINT, id=<span class="keyword">true</span>),</span><br><span class="line">        <span class="meta">@Result</span>(column=<span class="string">"order_id"</span>, property=<span class="string">"orderId"</span>, jdbcType=JdbcType.VARCHAR),</span><br><span class="line">        <span class="meta">@Result</span>(column=<span class="string">"create_time"</span>, property=<span class="string">"createTime"</span>, jdbcType=JdbcType.TIMESTAMP),</span><br><span class="line">        <span class="meta">@Result</span>(column=<span class="string">"amount"</span>, property=<span class="string">"amount"</span>, jdbcType=JdbcType.DECIMAL),</span><br><span class="line">        <span class="meta">@Result</span>(column=<span class="string">"order_status"</span>, property=<span class="string">"orderStatus"</span>, jdbcType=JdbcType.TINYINT)</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="function">List&lt;Order&gt; <span class="title">selectMany</span><span class="params">(SelectStatementProvider selectStatement)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Generated</span>(<span class="string">"org.mybatis.generator.api.MyBatisGenerator"</span>)</span><br><span class="line">    <span class="meta">@UpdateProvider</span>(type=SqlProviderAdapter<span class="class">.<span class="keyword">class</span>, <span class="title">method</span></span>=<span class="string">"update"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">update</span><span class="params">(UpdateStatementProvider updateStatement)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Generated</span>(<span class="string">"org.mybatis.generator.api.MyBatisGenerator"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">long</span> <span class="title">count</span><span class="params">(CountDSLCompleter completer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> MyBatis3Utils.countFrom(<span class="keyword">this</span>::count, order, completer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Generated</span>(<span class="string">"org.mybatis.generator.api.MyBatisGenerator"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">int</span> <span class="title">delete</span><span class="params">(DeleteDSLCompleter completer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> MyBatis3Utils.deleteFrom(<span class="keyword">this</span>::delete, order, completer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Generated</span>(<span class="string">"org.mybatis.generator.api.MyBatisGenerator"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">int</span> <span class="title">deleteByPrimaryKey</span><span class="params">(Long id_)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> delete(c -&gt; </span><br><span class="line">            c.where(id, isEqualTo(id_))</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Generated</span>(<span class="string">"org.mybatis.generator.api.MyBatisGenerator"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">int</span> <span class="title">insert</span><span class="params">(Order record)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> MyBatis3Utils.insert(<span class="keyword">this</span>::insert, record, order, c -&gt;</span><br><span class="line">            c.map(id).toProperty(<span class="string">"id"</span>)</span><br><span class="line">            .map(orderId).toProperty(<span class="string">"orderId"</span>)</span><br><span class="line">            .map(createTime).toProperty(<span class="string">"createTime"</span>)</span><br><span class="line">            .map(amount).toProperty(<span class="string">"amount"</span>)</span><br><span class="line">            .map(orderStatus).toProperty(<span class="string">"orderStatus"</span>)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Generated</span>(<span class="string">"org.mybatis.generator.api.MyBatisGenerator"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">int</span> <span class="title">insertSelective</span><span class="params">(Order record)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> MyBatis3Utils.insert(<span class="keyword">this</span>::insert, record, order, c -&gt;</span><br><span class="line">            c.map(id).toProperty(<span class="string">"id"</span>)</span><br><span class="line">            .map(orderId).toPropertyWhenPresent(<span class="string">"orderId"</span>, record::getOrderId)</span><br><span class="line">            .map(createTime).toPropertyWhenPresent(<span class="string">"createTime"</span>, record::getCreateTime)</span><br><span class="line">            .map(amount).toPropertyWhenPresent(<span class="string">"amount"</span>, record::getAmount)</span><br><span class="line">            .map(orderStatus).toPropertyWhenPresent(<span class="string">"orderStatus"</span>, record::getOrderStatus)</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Generated</span>(<span class="string">"org.mybatis.generator.api.MyBatisGenerator"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">default</span> Optional&lt;Order&gt; <span class="title">selectOne</span><span class="params">(SelectDSLCompleter completer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> MyBatis3Utils.selectOne(<span class="keyword">this</span>::selectOne, selectList, order, completer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Generated</span>(<span class="string">"org.mybatis.generator.api.MyBatisGenerator"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">default</span> List&lt;Order&gt; <span class="title">select</span><span class="params">(SelectDSLCompleter completer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> MyBatis3Utils.selectList(<span class="keyword">this</span>::selectMany, selectList, order, completer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Generated</span>(<span class="string">"org.mybatis.generator.api.MyBatisGenerator"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">default</span> List&lt;Order&gt; <span class="title">selectDistinct</span><span class="params">(SelectDSLCompleter completer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> MyBatis3Utils.selectDistinct(<span class="keyword">this</span>::selectMany, selectList, order, completer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Generated</span>(<span class="string">"org.mybatis.generator.api.MyBatisGenerator"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">default</span> Optional&lt;Order&gt; <span class="title">selectByPrimaryKey</span><span class="params">(Long id_)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> selectOne(c -&gt;</span><br><span class="line">            c.where(id, isEqualTo(id_))</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Generated</span>(<span class="string">"org.mybatis.generator.api.MyBatisGenerator"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">int</span> <span class="title">update</span><span class="params">(UpdateDSLCompleter completer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> MyBatis3Utils.update(<span class="keyword">this</span>::update, order, completer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Generated</span>(<span class="string">"org.mybatis.generator.api.MyBatisGenerator"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">static</span> UpdateDSL&lt;UpdateModel&gt; <span class="title">updateAllColumns</span><span class="params">(Order record, UpdateDSL&lt;UpdateModel&gt; dsl)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> dsl.set(id).equalTo(record::getId)</span><br><span class="line">                .set(orderId).equalTo(record::getOrderId)</span><br><span class="line">                .set(createTime).equalTo(record::getCreateTime)</span><br><span class="line">                .set(amount).equalTo(record::getAmount)</span><br><span class="line">                .set(orderStatus).equalTo(record::getOrderStatus);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Generated</span>(<span class="string">"org.mybatis.generator.api.MyBatisGenerator"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">static</span> UpdateDSL&lt;UpdateModel&gt; <span class="title">updateSelectiveColumns</span><span class="params">(Order record, UpdateDSL&lt;UpdateModel&gt; dsl)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> dsl.set(id).equalToWhenPresent(record::getId)</span><br><span class="line">                .set(orderId).equalToWhenPresent(record::getOrderId)</span><br><span class="line">                .set(createTime).equalToWhenPresent(record::getCreateTime)</span><br><span class="line">                .set(amount).equalToWhenPresent(record::getAmount)</span><br><span class="line">                .set(orderStatus).equalToWhenPresent(record::getOrderStatus);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Generated</span>(<span class="string">"org.mybatis.generator.api.MyBatisGenerator"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">int</span> <span class="title">updateByPrimaryKey</span><span class="params">(Order record)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> update(c -&gt;</span><br><span class="line">            c.set(orderId).equalTo(record::getOrderId)</span><br><span class="line">            .set(createTime).equalTo(record::getCreateTime)</span><br><span class="line">            .set(amount).equalTo(record::getAmount)</span><br><span class="line">            .set(orderStatus).equalTo(record::getOrderStatus)</span><br><span class="line">            .where(id, isEqualTo(record::getId))</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Generated</span>(<span class="string">"org.mybatis.generator.api.MyBatisGenerator"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">default</span> <span class="keyword">int</span> <span class="title">updateByPrimaryKeySelective</span><span class="params">(Order record)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> update(c -&gt;</span><br><span class="line">            c.set(orderId).equalToWhenPresent(record::getOrderId)</span><br><span class="line">            .set(createTime).equalToWhenPresent(record::getCreateTime)</span><br><span class="line">            .set(amount).equalToWhenPresent(record::getAmount)</span><br><span class="line">            .set(orderStatus).equalToWhenPresent(record::getOrderStatus)</span><br><span class="line">            .where(id, isEqualTo(record::getId))</span><br><span class="line">        );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æç®€XMLæ˜ å°„æ–‡ä»¶">æç®€XMLæ˜ å°„æ–‡ä»¶</h3><p>æç®€<code>XML</code>æ˜ å°„æ–‡ä»¶ç”Ÿæˆåªéœ€è¦ç®€å•ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">context</span> <span class="attr">id</span>=<span class="string">"default"</span> <span class="attr">targetRuntime</span>=<span class="string">"MyBatis3Simple"</span>&gt;</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">javaClientGenerator</span> <span class="attr">type</span>=<span class="string">"XMLMAPPER"</span></span></span><br><span class="line"><span class="tag"><span class="attr">...</span></span></span><br></pre></td></tr></table></figure><p>ç”Ÿæˆä¸‰ä¸ªæ–‡ä»¶ï¼š</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// club.throwable.entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Order</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String orderId;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Date createTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> BigDecimal amount;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Byte orderStatus;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">getId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getOrderId</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> orderId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOrderId</span><span class="params">(String orderId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.orderId = orderId;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Date <span class="title">getCreateTime</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> createTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCreateTime</span><span class="params">(Date createTime)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.createTime = createTime;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> BigDecimal <span class="title">getAmount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> amount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAmount</span><span class="params">(BigDecimal amount)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.amount = amount;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Byte <span class="title">getOrderStatus</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> orderStatus;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOrderStatus</span><span class="params">(Byte orderStatus)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.orderStatus = orderStatus;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// club.throwable.dao</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">OrderMapper</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">deleteByPrimaryKey</span><span class="params">(Long id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">insert</span><span class="params">(Order record)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">Order <span class="title">selectByPrimaryKey</span><span class="params">(Long id)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">List&lt;Order&gt; <span class="title">selectAll</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">updateByPrimaryKey</span><span class="params">(Order record)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// mappings</span></span><br><span class="line">&lt;?xml version=<span class="string">"1.0"</span> encoding=<span class="string">"UTF-8"</span>?&gt;</span><br><span class="line">&lt;!DOCTYPE mapper PUBLIC <span class="string">"-//mybatis.org//DTD Mapper 3.0//EN"</span> <span class="string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span><br><span class="line">&lt;mapper namespace=<span class="string">"club.throwable.dao.OrderMapper"</span>&gt;</span><br><span class="line">    &lt;resultMap id=<span class="string">"BaseResultMap"</span> type=<span class="string">"club.throwable.entity.Order"</span>&gt;</span><br><span class="line">        &lt;id column=<span class="string">"id"</span> jdbcType=<span class="string">"BIGINT"</span> property=<span class="string">"id"</span>/&gt;</span><br><span class="line">        &lt;result column=<span class="string">"order_id"</span> jdbcType=<span class="string">"VARCHAR"</span> property=<span class="string">"orderId"</span>/&gt;</span><br><span class="line">        &lt;result column=<span class="string">"create_time"</span> jdbcType=<span class="string">"TIMESTAMP"</span> property=<span class="string">"createTime"</span>/&gt;</span><br><span class="line">        &lt;result column=<span class="string">"amount"</span> jdbcType=<span class="string">"DECIMAL"</span> property=<span class="string">"amount"</span>/&gt;</span><br><span class="line">        &lt;result column=<span class="string">"order_status"</span> jdbcType=<span class="string">"TINYINT"</span> property=<span class="string">"orderStatus"</span>/&gt;</span><br><span class="line">    &lt;/resultMap&gt;</span><br><span class="line">    &lt;delete id=<span class="string">"deleteByPrimaryKey"</span> parameterType=<span class="string">"java.lang.Long"</span>&gt;</span><br><span class="line">        delete</span><br><span class="line">        from t_order</span><br><span class="line">        where id = #&#123;id,jdbcType=BIGINT&#125;</span><br><span class="line">    &lt;/delete&gt;</span><br><span class="line">    &lt;insert id=<span class="string">"insert"</span> parameterType=<span class="string">"club.throwable.entity.Order"</span>&gt;</span><br><span class="line">        &lt;selectKey keyProperty=<span class="string">"id"</span> order=<span class="string">"AFTER"</span> resultType=<span class="string">"java.lang.Long"</span>&gt;</span><br><span class="line">            <span class="function">SELECT <span class="title">LAST_INSERT_ID</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        &lt;/selectKey&gt;</span></span><br><span class="line"><span class="function">        insert into <span class="title">t_order</span> <span class="params">(order_id, create_time, amount,</span></span></span><br><span class="line"><span class="function"><span class="params">        order_status)</span></span></span><br><span class="line"><span class="function">        <span class="title">values</span> <span class="params">(#&#123;orderId,jdbcType=VARCHAR&#125;, #&#123;createTime,jdbcType=TIMESTAMP&#125;, #&#123;amount,jdbcType=DECIMAL&#125;,</span></span></span><br><span class="line"><span class="function"><span class="params">        #&#123;orderStatus,jdbcType=TINYINT&#125;)</span></span></span><br><span class="line"><span class="function">    &lt;/insert&gt;</span></span><br><span class="line"><span class="function">    &lt;update id</span>=<span class="string">"updateByPrimaryKey"</span> parameterType=<span class="string">"club.throwable.entity.Order"</span>&gt;</span><br><span class="line">        update t_order</span><br><span class="line">        set order_id     = #&#123;orderId,jdbcType=VARCHAR&#125;,</span><br><span class="line">            create_time  = #&#123;createTime,jdbcType=TIMESTAMP&#125;,</span><br><span class="line">            amount       = #&#123;amount,jdbcType=DECIMAL&#125;,</span><br><span class="line">            order_status = #&#123;orderStatus,jdbcType=TINYINT&#125;</span><br><span class="line">        where id = #&#123;id,jdbcType=BIGINT&#125;</span><br><span class="line">    &lt;/update&gt;</span><br><span class="line">    &lt;select id=<span class="string">"selectByPrimaryKey"</span> parameterType=<span class="string">"java.lang.Long"</span> resultMap=<span class="string">"BaseResultMap"</span>&gt;</span><br><span class="line">        select id, order_id, create_time, amount, order_status</span><br><span class="line">        from t_order</span><br><span class="line">        where id = #&#123;id,jdbcType=BIGINT&#125;</span><br><span class="line">    &lt;/select&gt;</span><br><span class="line">    &lt;select id=<span class="string">"selectAll"</span> resultMap=<span class="string">"BaseResultMap"</span>&gt;</span><br><span class="line">        select id, order_id, create_time, amount, order_status</span><br><span class="line">        from t_order</span><br><span class="line">    &lt;/select&gt;</span><br><span class="line">    &lt;resultMap id=<span class="string">"BaseResultMap"</span> type=<span class="string">"club.throwable.entity.Order"</span>&gt;</span><br><span class="line">        &lt;id column=<span class="string">"id"</span> jdbcType=<span class="string">"BIGINT"</span> property=<span class="string">"id"</span>/&gt;</span><br><span class="line">        &lt;result column=<span class="string">"order_id"</span> jdbcType=<span class="string">"VARCHAR"</span> property=<span class="string">"orderId"</span>/&gt;</span><br><span class="line">        &lt;result column=<span class="string">"create_time"</span> jdbcType=<span class="string">"TIMESTAMP"</span> property=<span class="string">"createTime"</span>/&gt;</span><br><span class="line">        &lt;result column=<span class="string">"amount"</span> jdbcType=<span class="string">"DECIMAL"</span> property=<span class="string">"amount"</span>/&gt;</span><br><span class="line">        &lt;result column=<span class="string">"order_status"</span> jdbcType=<span class="string">"TINYINT"</span> property=<span class="string">"orderStatus"</span>/&gt;</span><br><span class="line">    &lt;/resultMap&gt;</span><br><span class="line">    &lt;delete id=<span class="string">"deleteByPrimaryKey"</span> parameterType=<span class="string">"java.lang.Long"</span>&gt;</span><br><span class="line">        delete</span><br><span class="line">        from t_order</span><br><span class="line">        where id = #&#123;id,jdbcType=BIGINT&#125;</span><br><span class="line">    &lt;/delete&gt;</span><br><span class="line">    &lt;insert id=<span class="string">"insert"</span> parameterType=<span class="string">"club.throwable.entity.Order"</span>&gt;</span><br><span class="line">        &lt;selectKey keyProperty=<span class="string">"id"</span> order=<span class="string">"BEFORE"</span> resultType=<span class="string">"java.lang.Long"</span>&gt;</span><br><span class="line">            <span class="function">SELECT <span class="title">LAST_INSERT_ID</span><span class="params">()</span></span></span><br><span class="line"><span class="function">        &lt;/selectKey&gt;</span></span><br><span class="line"><span class="function">        insert into <span class="title">t_order</span> <span class="params">(id, order_id, create_time,</span></span></span><br><span class="line"><span class="function"><span class="params">        amount, order_status)</span></span></span><br><span class="line"><span class="function">        <span class="title">values</span> <span class="params">(#&#123;id,jdbcType=BIGINT&#125;, #&#123;orderId,jdbcType=VARCHAR&#125;, #&#123;createTime,jdbcType=TIMESTAMP&#125;,</span></span></span><br><span class="line"><span class="function"><span class="params">        #&#123;amount,jdbcType=DECIMAL&#125;, #&#123;orderStatus,jdbcType=TINYINT&#125;)</span></span></span><br><span class="line"><span class="function">    &lt;/insert&gt;</span></span><br><span class="line"><span class="function">    &lt;update id</span>=<span class="string">"updateByPrimaryKey"</span> parameterType=<span class="string">"club.throwable.entity.Order"</span>&gt;</span><br><span class="line">        update t_order</span><br><span class="line">        set order_id     = #&#123;orderId,jdbcType=VARCHAR&#125;,</span><br><span class="line">            create_time  = #&#123;createTime,jdbcType=TIMESTAMP&#125;,</span><br><span class="line">            amount       = #&#123;amount,jdbcType=DECIMAL&#125;,</span><br><span class="line">            order_status = #&#123;orderStatus,jdbcType=TINYINT&#125;</span><br><span class="line">        where id = #&#123;id,jdbcType=BIGINT&#125;</span><br><span class="line">    &lt;/update&gt;</span><br><span class="line">    &lt;select id=<span class="string">"selectByPrimaryKey"</span> parameterType=<span class="string">"java.lang.Long"</span> resultMap=<span class="string">"BaseResultMap"</span>&gt;</span><br><span class="line">        select id, order_id, create_time, amount, order_status</span><br><span class="line">        from t_order</span><br><span class="line">        where id = #&#123;id,jdbcType=BIGINT&#125;</span><br><span class="line">    &lt;/select&gt;</span><br><span class="line">    &lt;select id=<span class="string">"selectAll"</span> resultMap=<span class="string">"BaseResultMap"</span>&gt;</span><br><span class="line">        select id, order_id, create_time, amount, order_status</span><br><span class="line">        from t_order</span><br><span class="line">    &lt;/select&gt;</span><br><span class="line">&lt;/mapper&gt;</span><br></pre></td></tr></table></figure><h3 id="ç¼–ç¨‹å¼è‡ªå®šä¹‰ç±»å‹æ˜ å°„">ç¼–ç¨‹å¼è‡ªå®šä¹‰ç±»å‹æ˜ å°„</h3><p>ç¬”è€…å–œæ¬¢æŠŠæ‰€æœ‰çš„éé•¿æ•´å‹çš„æ•°å­—ï¼Œç»Ÿä¸€ä½¿ç”¨<code>Integer</code>æ¥æ”¶ï¼Œå› æ­¤éœ€è¦è‡ªå®šä¹‰ç±»å‹æ˜ å°„ã€‚ç¼–å†™æ˜ å°„å™¨å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultJavaTypeResolver</span> <span class="keyword">extends</span> <span class="title">JavaTypeResolverDefaultImpl</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DefaultJavaTypeResolver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>();</span><br><span class="line">        typeMap.put(Types.SMALLINT, <span class="keyword">new</span> JdbcTypeInformation(<span class="string">"SMALLINT"</span>,</span><br><span class="line">                <span class="keyword">new</span> FullyQualifiedJavaType(Integer<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())))</span>;</span><br><span class="line">        typeMap.put(Types.TINYINT, <span class="keyword">new</span> JdbcTypeInformation(<span class="string">"TINYINT"</span>,</span><br><span class="line">                <span class="keyword">new</span> FullyQualifiedJavaType(Integer<span class="class">.<span class="keyword">class</span>.<span class="title">getName</span>())))</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶æœ€å¥½ä½¿ç”¨ç¼–ç¨‹å¼è¿è¡Œä»£ç ç”Ÿæˆå™¨ï¼Œä¿®æ”¹<code>XML</code>é…ç½®æ–‡ä»¶ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">javaTypeResolver</span> <span class="attr">type</span>=<span class="string">"club.throwable.mbg.DefaultJavaTypeResolver"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"forceBigDecimals"</span> <span class="attr">value</span>=<span class="string">"false"</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">javaTypeResolver</span>&gt;</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>è¿è¡Œæ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        List&lt;String&gt; warnings = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="comment">// å¦‚æœå·²ç»å­˜åœ¨ç”Ÿæˆè¿‡çš„æ–‡ä»¶æ˜¯å¦è¿›è¡Œè¦†ç›–</span></span><br><span class="line">        <span class="keyword">boolean</span> overwrite = <span class="keyword">true</span>;</span><br><span class="line">        ConfigurationParser cp = <span class="keyword">new</span> ConfigurationParser(warnings);</span><br><span class="line">        Configuration config = cp.parseConfiguration(Main.class.getResourceAsStream("/generator-configuration.xml"));</span><br><span class="line">        DefaultShellCallback callback = <span class="keyword">new</span> DefaultShellCallback(overwrite);</span><br><span class="line">        MyBatisGenerator generator = <span class="keyword">new</span> MyBatisGenerator(config, callback, warnings);</span><br><span class="line">        generator.generate(<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•°æ®åº“çš„<code>order_status</code>æ˜¯<code>TINYINT</code>ç±»å‹ï¼Œç”Ÿæˆå‡ºæ¥çš„æ–‡ä»¶ä¸­çš„<code>orderStatus</code>å­—æ®µå…¨éƒ¨æ›¿æ¢ä½¿ç”¨<code>Integer</code>ç±»å‹å®šä¹‰ã€‚</p><h2 id="å°ç»“">å°ç»“</h2><p>æœ¬æ–‡ç›¸å¯¹è¯¦å°½åœ°ä»‹ç»äº†<code>Mybatis Generator</code>çš„ä½¿ç”¨æ–¹å¼ï¼Œå…·ä½“åˆ†æäº†<code>XML</code>é…ç½®æ–‡ä»¶ä¸­ä¸»è¦æ ‡ç­¾ä»¥åŠæ ‡ç­¾å±æ€§çš„åŠŸèƒ½ã€‚å› ä¸º<code>Mybatis</code>åœ¨<code>Java</code>çš„<code>ORM</code>æ¡†æ¶ä½“ç³»ä¸­è¿˜ä¼šæœ‰ä¸€æ®µå¾ˆé•¿çš„æ—¶é—´å¤„äºä¸»æµåœ°ä½ï¼Œäº†è§£<code>Mybatis Generator</code>å¯ä»¥ç®€åŒ–<code>CRUD</code>æ–¹æ³•æ¨¡æ¿ä»£ç ã€å®ä½“ä»¥åŠ<code>Mapper</code>æ¥å£ä»£ç ç”Ÿæˆï¼Œä»è€Œè§£æ”¾å¤§é‡ç”Ÿäº§åŠ›ã€‚<code>Mybatis Generator</code>æœ‰ä¸å°‘ç¬¬ä¸‰æ–¹çš„æ‰©å±•ï¼Œä¾‹å¦‚<code>tk.mapper</code>æˆ–è€…<code>mybatis-plus</code>è‡ªèº«çš„æ‰©å±•ï¼Œå¯èƒ½é™„åŠ çš„åŠŸèƒ½ä¸ä¸€æ ·ï¼Œä½†æ˜¯åŸºæœ¬çš„ä½¿ç”¨æ˜¯ä¸€è‡´çš„ã€‚</p><p>å‚è€ƒèµ„æ–™ï¼š</p><ul><li><a href="http://mybatis.org/generator/index.html" target="_blank" rel="noopener">MyBatis Generator</a></li></ul><p>ï¼ˆæœ¬æ–‡å®Œ c-5-d e-a-20191216 1:00ï¼‰</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰æ&quot;&gt;å‰æ&lt;/h2&gt;
&lt;p&gt;æœ€è¿‘åœ¨åšåˆ›ä¸šé¡¹ç›®çš„æ—¶å€™å› ä¸ºæœ‰æ¯”è¾ƒå¤šçš„æ–°éœ€æ±‚ï¼Œéœ€è¦é¢‘ç¹åŸºäº&lt;code&gt;DDL&lt;/code&gt;ç”Ÿæˆ&lt;code&gt;Mybatis&lt;/code&gt;é€‚åˆçš„å®ä½“ã€&lt;code&gt;Mapper&lt;/code&gt;æ¥å£å’Œæ˜ å°„æ–‡ä»¶ã€‚å…¶ä¸­ï¼Œä»£ç ç”Ÿæˆå™¨æ˜¯&lt;code&gt;MyBatis Generator(MBG)&lt;/code&gt;ï¼Œç”¨åˆ°äº†&lt;code&gt;Mybatis-Generator-Core&lt;/code&gt;ç›¸å…³ä¾èµ–ï¼Œè¿™é‡Œé€šè¿‡ä¸€ç¯‡æ–‡ç« è¯¦ç»†åœ°åˆ†æè¿™ä¸ªä»£ç ç”Ÿæˆå™¨çš„ä½¿ç”¨æ–¹å¼ã€‚æœ¬æ–‡ç¼–å†™çš„æ—¶å€™ä½¿ç”¨çš„&lt;code&gt;Mybatis-Generator&lt;/code&gt;ç‰ˆæœ¬ä¸º&lt;code&gt;1.4.0&lt;/code&gt;ï¼Œå…¶ä»–ç‰ˆæœ¬æ²¡æœ‰è¿›è¡Œè¿‡è°ƒç ”ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Framework" scheme="http://throwable.club/blog/categories/Framework/"/>
    
      <category term="Mybatis" scheme="http://throwable.club/blog/categories/Framework/Mybatis/"/>
    
    
      <category term="Java" scheme="http://throwable.club/blog/tags/Java/"/>
    
      <category term="Mybatis" scheme="http://throwable.club/blog/tags/Mybatis/"/>
    
  </entry>
  
  <entry>
    <title>ä½ çš„SpringBootåº”ç”¨çœŸçš„éƒ¨ç½²æ›´æ–°æˆåŠŸäº†å—</title>
    <link href="http://throwable.club/2019/12/09/spring-boot-server-deploy-monitor/"/>
    <id>http://throwable.club/2019/12/09/spring-boot-server-deploy-monitor/</id>
    <published>2019-12-08T17:44:12.000Z</published>
    <updated>2019-12-08T17:45:46.863Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰æ">å‰æ</h2><p>å½“æˆ‘ä»¬åœ¨ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²äº†<code>SpringBoot</code>åº”ç”¨çš„æ—¶å€™ï¼Œè™½ç„¶å¯ä»¥é€šè¿‡<code>Jenkins</code>çš„æ„å»ºçŠ¶æ€å’Œ<code>Linux</code>çš„<code>ps</code>å‘½ä»¤å»æ„ŸçŸ¥åº”ç”¨æ˜¯å¦åœ¨æ–°çš„ä¸€æ¬¡å‘å¸ƒä¸­éƒ¨ç½²å’Œå¯åŠ¨æˆåŠŸï¼Œä½†æ˜¯è¿™ç§ç›‘æ§æ‰‹æ®µæ˜¯è¿ç»´å±‚é¢çš„ã€‚é‚£ä¹ˆï¼Œå¯ä»¥æä¾›ä¸€ç§æ‰‹æ®µèƒ½å¤Ÿåœ¨åº”ç”¨å±‚é¢æ„ŸçŸ¥æœåŠ¡åœ¨æ–°çš„ä¸€æ¬¡å‘å¸ƒä¸­çš„æ„å»ºéƒ¨ç½²å’Œå¯åŠ¨æ˜¯å¦æˆåŠŸå—ï¼Ÿè¿™ä¸ªé—®é¢˜ç¬”è€…èŠ±äº†ä¸€ç‚¹æ—¶é—´æƒ³é€šäº†è¿™ä¸ªé—®é¢˜ï¼Œé€šè¿‡è¿™ç¯‡æ–‡ç« æä¾›ä¸€ä¸ªç®€å•çš„å®ç°æ€è·¯ã€‚</p><a id="more"></a><h2 id="åŸºæœ¬æ€è·¯">åŸºæœ¬æ€è·¯</h2><p>å…¶å®åŸºæœ¬æ€è·¯å¾ˆç®€å•ï¼Œä¸€èˆ¬<code>SpringBoot</code>åº”ç”¨ä¼šä½¿ç”¨<code>Maven</code>æ’ä»¶æ‰“åŒ…ï¼ˆç¬”è€…ä¸ç†Ÿæ‚‰<code>Gradle</code>ï¼Œæ‰€ä»¥æš‚æ—¶ä¸å¯¹<code>Gradle</code>åšåˆ†æï¼‰ï¼Œæ‰€ä»¥å¯ä»¥è¿™æ ·è€ƒè™‘ï¼š</p><ol><li><code>Maven</code>æ’ä»¶æ‰“åŒ…çš„æ—¶å€™ï¼ŒæŠŠ<strong>æ„å»ºæ—¶é—´</strong>å’Œ<code>pom</code>æ–‡ä»¶ä¸­çš„ç‰ˆæœ¬å·éƒ½å†™åˆ°<code>jar</code>åŒ…çš„æè¿°æ–‡ä»¶ä¸­ï¼Œæ­£ç¡®æ¥è¯´å°±æ˜¯<code>MANIFEST.MF</code>æ–‡ä»¶ä¸­ã€‚</li><li>å¼•å…¥<code>spring-boot-starter-actuator</code>ï¼Œé€šè¿‡<code>/actuator/info</code>ç«¯ç‚¹å»æš´éœ²åº”ç”¨çš„ä¿¡æ¯ï¼ˆæœ€å¥½æ§åˆ¶ç½‘ç»œè®¿é—®æƒé™ä¸ºåªå…è®¸å†…ç½‘è®¿é—®ï¼‰ã€‚</li><li>æŠŠç¬¬1æ­¥ä¸­æ‰“åŒ…åˆ°<code>jar</code>åŒ…ä¸­çš„<code>MANIFEST.MF</code>æ–‡ä»¶çš„å†…å®¹è¯»å–å¹¶ä¸”åŠ è½½åˆ°<code>SpringBoot</code>ç¯å¢ƒå±æ€§ä¸­çš„<code>info.*</code>å±æ€§ä¸­ï¼Œä»¥ä¾¿å¯ä»¥é€šè¿‡<code>/actuator/info</code>è®¿é—®ã€‚</li></ol><p>æ€è·¯å®šå¥½äº†ï¼Œé‚£ä¹ˆä¸‹é¢å¼€å§‹å®æ–½ç¼–ç ã€‚</p><h2 id="ç¼–ç å®ç°">ç¼–ç å®ç°</h2><p>æœ€è¿‘åˆšå¥½åœ¨è°ƒç ”èš‚èšé‡‘æœçš„<code>SofaStack</code>ä½“ç³»ï¼Œè¿™é‡Œå¼•å…¥<code>SofaBoot</code>ç¼–å†™ç¤ºä¾‹ã€‚<code>pom</code>æ–‡ä»¶å¦‚ä¸‹ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>club.throwable<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sofa-boot-sample<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>sofa-boot-sample<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">project.build.sourceEncoding</span>&gt;</span>UTF-8<span class="tag">&lt;/<span class="name">project.build.sourceEncoding</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sofa.boot.version</span>&gt;</span>3.2.0<span class="tag">&lt;/<span class="name">sofa.boot.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">spring.boot.version</span>&gt;</span>2.1.0.RELEASE<span class="tag">&lt;/<span class="name">spring.boot.version</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">maven.build.timestamp.format</span>&gt;</span>yyyy-MM-dd HH:mm:ss.SSS<span class="tag">&lt;/<span class="name">maven.build.timestamp.format</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alipay.sofa<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sofaboot-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;sofa.boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.12<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alipay.sofa<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>healthcheck-sofa-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>sofa-boot-sample<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.8.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">source</span>&gt;</span>$&#123;maven.compiler.source&#125;<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">target</span>&gt;</span>$&#123;maven.compiler.target&#125;<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">encoding</span>&gt;</span>$&#123;project.build.sourceEncoding&#125;<span class="tag">&lt;/<span class="name">encoding</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;spring.boot.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">goal</span>&gt;</span>repackage<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-jar-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">archive</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">manifest</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">addBuildEnvironmentEntries</span>&gt;</span>true<span class="tag">&lt;/<span class="name">addBuildEnvironmentEntries</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;<span class="name">manifestEntries</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">Application-Name</span>&gt;</span>$&#123;project.groupId&#125;:$&#123;project.artifactId&#125;:$&#123;project.version&#125;<span class="tag">&lt;/<span class="name">Application-Name</span>&gt;</span></span><br><span class="line">                            <span class="tag">&lt;<span class="name">Build-Timestamp</span>&gt;</span>$&#123;maven.build.timestamp&#125;<span class="tag">&lt;/<span class="name">Build-Timestamp</span>&gt;</span></span><br><span class="line">                        <span class="tag">&lt;/<span class="name">manifestEntries</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;/<span class="name">archive</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure><p><code>pom</code>æ–‡ä»¶ä¸­ä¸€äº›å±æ€§å’Œå ä½ç¬¦çš„è®¾ç½®ï¼Œå¯ä»¥å‚è€ƒä¸€ä¸‹è¿™ä¸¤ä¸ªé“¾æ¥ï¼š<a href="http://maven.apache.org/shared/maven-archiver/index.html" target="_blank" rel="noopener">Maven-Archiver</a>å’Œ<a href="http://maven.apache.org/guides/introduction/introduction-to-the-pom.html#Available_Variables" target="_blank" rel="noopener">Available Variables</a>ã€‚<code>SpringBoot</code>çš„é…ç½®æ–‡ä»¶<code>application.yaml</code>å¦‚ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9091</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">server:</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">10091</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">enabled-by-default:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">info</span></span><br><span class="line">  <span class="attr">endpoint:</span></span><br><span class="line">    <span class="attr">info:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">sofa-boot-sample</span></span><br></pre></td></tr></table></figure><p><strong>è¿™é‡Œè¦æ³¨æ„ä¸€ç‚¹</strong>ï¼š<code>SpringBoot</code>åº”ç”¨é€šè¿‡å…¶<code>Maven</code>æ’ä»¶æ‰“å‡ºæ¥çš„<code>jar</code>åŒ…è§£å‹åçš„ç›®å½•å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">sofa-boot-sample.jar</span><br><span class="line">  - META-INF</span><br><span class="line">    - MANIFEST.MF</span><br><span class="line">    - maven ...</span><br><span class="line">  - org</span><br><span class="line">    - springframework </span><br><span class="line">      - boot ...</span><br><span class="line">  - BOOT-INF</span><br><span class="line">    - classes ...</span><br><span class="line">    - lib ...</span><br></pre></td></tr></table></figure><p>äº†è§£æ­¤è§£å‹ç›®å½•æ˜¯æˆ‘ä»¬ç¼–å†™<code>MANIFEST.MF</code>æ–‡ä»¶çš„è§£æå®ç°è¿‡ç¨‹çš„å‰æã€‚ç¼–å†™<code>MANIFEST.MF</code>æ–‡ä»¶çš„è§£æç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressWarnings</span>(<span class="string">"ConstantConditions"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> ManiFestFileExtractUtils &#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * å•ä¾‹</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    X;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, String&gt; RESULT = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">16</span>);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger LOGGER = LoggerFactory.getLogger(ManiFestFileExtractUtils<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        String jarFilePath = ClassUtils.getDefaultClassLoader().getResource(<span class="string">""</span>).getPath().replace(<span class="string">"!/BOOT-INF/classes!/"</span>, <span class="string">""</span>);</span><br><span class="line">        <span class="keyword">if</span> (jarFilePath.startsWith(<span class="string">"file"</span>)) &#123;</span><br><span class="line">            jarFilePath = jarFilePath.substring(<span class="number">5</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        LOGGER.info(<span class="string">"è¯»å–çš„Jarè·¯å¾„ä¸º:&#123;&#125;"</span>, jarFilePath);</span><br><span class="line">        <span class="keyword">try</span> (JarFile jarFile = <span class="keyword">new</span> JarFile(jarFilePath)) &#123;</span><br><span class="line">            JarEntry entry = jarFile.getJarEntry(<span class="string">"META-INF/MANIFEST.MF"</span>);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">null</span> != entry) &#123;</span><br><span class="line">                BufferedReader reader = <span class="keyword">new</span> BufferedReader(<span class="keyword">new</span> InputStreamReader(jarFile.getInputStream(entry), StandardCharsets.UTF_8));</span><br><span class="line">                String line;</span><br><span class="line">                <span class="keyword">while</span> (<span class="keyword">null</span> != (line = reader.readLine())) &#123;</span><br><span class="line">                    LOGGER.info(<span class="string">"è¯»å–åˆ°è¡Œ:&#123;&#125;"</span>, line);</span><br><span class="line">                    <span class="keyword">int</span> i = line.indexOf(<span class="string">":"</span>);</span><br><span class="line">                    <span class="keyword">if</span> (i &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">                        String key = line.substring(<span class="number">0</span>, i).trim();</span><br><span class="line">                        String value = line.substring(i + <span class="number">1</span>).trim();</span><br><span class="line">                        RESULT.put(key, value);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            LOGGER.warn(<span class="string">"è§£æMANIFEST.MFæ–‡ä»¶å¼‚å¸¸"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Map&lt;String, String&gt; <span class="title">extract</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> RESULT;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥é€šè¿‡ä¸€ä¸ª<code>CommandLineRunner</code>çš„å®ç°æŠŠ<code>MANIFEST.MF</code>æ–‡ä»¶çš„å†…å®¹å†™åˆ°<code>Environment</code>å®ä¾‹ä¸­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SofaBootSampleRunner</span> <span class="keyword">implements</span> <span class="title">CommandLineRunner</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ConfigurableEnvironment configurableEnvironment;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(String... args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        MutablePropertySources propertySources = configurableEnvironment.getPropertySources();</span><br><span class="line">        Map&lt;String, String&gt; result = ManiFestFileExtractUtils.X.extract();</span><br><span class="line">        Properties properties = <span class="keyword">new</span> Properties();</span><br><span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, String&gt; entry : result.entrySet()) &#123;</span><br><span class="line">            String key = <span class="string">"info."</span> + entry.getKey();</span><br><span class="line">            properties.setProperty(key, entry.getValue());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!properties.isEmpty()) &#123;</span><br><span class="line">            propertySources.addFirst(<span class="keyword">new</span> PropertiesPropertySource(<span class="string">"infoProperties"</span>, properties));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯åŠ¨ç±»å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SofaBootSampleApplication</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(SofaBootSampleApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æœ€ç»ˆæ•ˆæœ">æœ€ç»ˆæ•ˆæœ</h2><p>åœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä½¿ç”¨å‘½ä»¤<code>mvn package</code>ï¼Œæ‰“å‡º<code>jar</code>åŒ…åç›´æ¥å¯åŠ¨ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd JaråŒ…çš„ç›®å½•</span><br><span class="line">java -jar sofa-boot-sample.jar</span><br></pre></td></tr></table></figure><p>è°ƒç”¨<code>http://localhost:10091/actuator/info</code>æ¥å£è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="attr">"Spring-Boot-Version"</span>: <span class="string">"2.1.0.RELEASE"</span>,</span><br><span class="line"><span class="attr">"Start-Class"</span>: <span class="string">"club.throwable.sofa.SofaBootSampleApplication"</span>,</span><br><span class="line"><span class="attr">"Main-Class"</span>: <span class="string">"org.springframework.boot.loader.JarLauncher"</span>,</span><br><span class="line"><span class="attr">"Manifest-Version"</span>: <span class="string">"1.0"</span>,</span><br><span class="line"><span class="attr">"Build-Jdk-Spec"</span>: <span class="string">"1.8"</span>,</span><br><span class="line"><span class="attr">"Spring-Boot-Classes"</span>: <span class="string">"BOOT-INF/classes/"</span>,</span><br><span class="line"><span class="attr">"Created-By"</span>: <span class="string">"Maven Jar Plugin 3.2.0"</span>,</span><br><span class="line"><span class="attr">"Build-Timestamp"</span>: <span class="string">"2019-12-08 17:41:21.844"</span>,</span><br><span class="line"><span class="attr">"Spring-Boot-Lib"</span>: <span class="string">"BOOT-INF/lib/"</span>,</span><br><span class="line"><span class="attr">"Application-Name"</span>: <span class="string">"club.throwable:sofa-boot-sample:1.0-SNAPSHOT"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ”¹å˜<code>pom</code>æ–‡ä»¶ä¸­çš„ç‰ˆæœ¬æ ‡ç­¾<code>&lt;version&gt;</code>ä¸º<code>1.0.0</code>ï¼Œå†æ¬¡æ‰“åŒ…å¹¶ä¸”å¯åŠ¨æˆåŠŸåè°ƒç”¨<code>http://localhost:10091/actuator/info</code>æ¥å£è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"><span class="attr">"Spring-Boot-Version"</span>: <span class="string">"2.1.0.RELEASE"</span>,</span><br><span class="line"><span class="attr">"Start-Class"</span>: <span class="string">"club.throwable.sofa.SofaBootSampleApplication"</span>,</span><br><span class="line"><span class="attr">"Main-Class"</span>: <span class="string">"org.springframework.boot.loader.JarLauncher"</span>,</span><br><span class="line"><span class="attr">"Manifest-Version"</span>: <span class="string">"1.0"</span>,</span><br><span class="line"><span class="attr">"Build-Jdk-Spec"</span>: <span class="string">"1.8"</span>,</span><br><span class="line"><span class="attr">"Spring-Boot-Classes"</span>: <span class="string">"BOOT-INF/classes/"</span>,</span><br><span class="line"><span class="attr">"Created-By"</span>: <span class="string">"Maven Jar Plugin 3.2.0"</span>,</span><br><span class="line"><span class="attr">"Build-Timestamp"</span>: <span class="string">"2019-12-08 17:42:07.273"</span>,</span><br><span class="line"><span class="attr">"Spring-Boot-Lib"</span>: <span class="string">"BOOT-INF/lib/"</span>,</span><br><span class="line"><span class="attr">"Application-Name"</span>: <span class="string">"club.throwable:sofa-boot-sample:1.0.0"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯è§æ„å»ºæ—¶é—´æˆ³<code>Build-Timestamp</code>å’ŒæœåŠ¡å<code>Application-Name</code>éƒ½å‘ç”Ÿäº†å˜åŒ–ï¼Œè¾¾åˆ°äº†ç›‘æ§æœåŠ¡æ˜¯å¦æ­£å¸¸éƒ¨ç½²å’Œå¯åŠ¨çš„ç›®çš„ã€‚å¦‚æœæœ‰å¤šä¸ªæœåŠ¡èŠ‚ç‚¹ï¼Œå¯ä»¥æ·»åŠ ä¸€ä¸ª<code>ip</code>å±æ€§åŠ ä»¥åŒºåˆ†ã€‚</p><h2 id="å°ç»“">å°ç»“</h2><p>è¿™ç¯‡æ–‡ç« é€šè¿‡<code>SpringBoot</code>ä¸€äº›å®ç”¨æŠ€å·§å®ç°äº†åº”ç”¨å±‚é¢ç›‘æ§åº”ç”¨æ˜¯å¦æ­£å¸¸æ‰“åŒ…éƒ¨ç½²æ›´æ–°å’Œå¯åŠ¨æˆåŠŸçš„é—®é¢˜ã€‚</p><p>ï¼ˆæœ¬æ–‡å®Œ e-a-20191209:1:39 c-1-dï¼‰</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰æ&quot;&gt;å‰æ&lt;/h2&gt;
&lt;p&gt;å½“æˆ‘ä»¬åœ¨ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²äº†&lt;code&gt;SpringBoot&lt;/code&gt;åº”ç”¨çš„æ—¶å€™ï¼Œè™½ç„¶å¯ä»¥é€šè¿‡&lt;code&gt;Jenkins&lt;/code&gt;çš„æ„å»ºçŠ¶æ€å’Œ&lt;code&gt;Linux&lt;/code&gt;çš„&lt;code&gt;ps&lt;/code&gt;å‘½ä»¤å»æ„ŸçŸ¥åº”ç”¨æ˜¯å¦åœ¨æ–°çš„ä¸€æ¬¡å‘å¸ƒä¸­éƒ¨ç½²å’Œå¯åŠ¨æˆåŠŸï¼Œä½†æ˜¯è¿™ç§ç›‘æ§æ‰‹æ®µæ˜¯è¿ç»´å±‚é¢çš„ã€‚é‚£ä¹ˆï¼Œå¯ä»¥æä¾›ä¸€ç§æ‰‹æ®µèƒ½å¤Ÿåœ¨åº”ç”¨å±‚é¢æ„ŸçŸ¥æœåŠ¡åœ¨æ–°çš„ä¸€æ¬¡å‘å¸ƒä¸­çš„æ„å»ºéƒ¨ç½²å’Œå¯åŠ¨æ˜¯å¦æˆåŠŸå—ï¼Ÿè¿™ä¸ªé—®é¢˜ç¬”è€…èŠ±äº†ä¸€ç‚¹æ—¶é—´æƒ³é€šäº†è¿™ä¸ªé—®é¢˜ï¼Œé€šè¿‡è¿™ç¯‡æ–‡ç« æä¾›ä¸€ä¸ªç®€å•çš„å®ç°æ€è·¯ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Spring" scheme="http://throwable.club/blog/categories/Spring/"/>
    
      <category term="SpringBoot" scheme="http://throwable.club/blog/categories/Spring/SpringBoot/"/>
    
    
      <category term="Spring" scheme="http://throwable.club/blog/tags/Spring/"/>
    
      <category term="SpringBoot" scheme="http://throwable.club/blog/tags/SpringBoot/"/>
    
  </entry>
  
  <entry>
    <title>SpringMVCè¯·æ±‚å‚æ•°æ¥æ”¶æ€»ç»“(ä¸€)</title>
    <link href="http://throwable.club/2019/12/04/spring-mvc-param-handle-summary-1/"/>
    <id>http://throwable.club/2019/12/04/spring-mvc-param-handle-summary-1/</id>
    <published>2019-12-03T17:21:58.000Z</published>
    <updated>2019-12-03T17:24:23.170Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰æ">å‰æ</h2><p>åœ¨æ—¥å¸¸ä½¿ç”¨<code>SpringMVC</code>è¿›è¡Œå¼€å‘çš„æ—¶å€™ï¼Œæœ‰å¯èƒ½é‡åˆ°å‰ç«¯å„ç§ç±»å‹çš„è¯·æ±‚å‚æ•°ï¼Œè¿™é‡Œåšä¸€æ¬¡ç›¸å¯¹å…¨é¢çš„æ€»ç»“ã€‚<code>SpringMVC</code>ä¸­å¤„ç†æ§åˆ¶å™¨å‚æ•°çš„æ¥å£æ˜¯<code>HandlerMethodArgumentResolver</code>ï¼Œæ­¤æ¥å£æœ‰ä¼—å¤šå­ç±»ï¼Œåˆ†åˆ«å¤„ç†ä¸åŒ(æ³¨è§£ç±»å‹)çš„å‚æ•°ï¼Œä¸‹é¢åªåˆ—ä¸¾å‡ ä¸ªå­ç±»ï¼š</p><ul><li><code>RequestParamMethodArgumentResolver</code>ï¼šè§£æå¤„ç†ä½¿ç”¨äº†<code>@RequestParam</code>æ³¨è§£çš„å‚æ•°ã€<code>MultipartFile</code>ç±»å‹å‚æ•°å’Œ<code>Simple</code>ç±»å‹(å¦‚<code>long</code>ã€<code>int</code>ç­‰ç±»å‹)å‚æ•°ã€‚</li><li><code>RequestResponseBodyMethodProcessor</code>ï¼šè§£æå¤„ç†<code>@RequestBody</code>æ³¨è§£çš„å‚æ•°ã€‚</li><li><code>PathVariableMapMethodArgumentResolver</code>ï¼šè§£æå¤„ç†<code>@PathVariable</code>æ³¨è§£çš„å‚æ•°ã€‚</li></ul><a id="more"></a><p>å®é™…ä¸Šï¼Œä¸€èˆ¬åœ¨è§£æä¸€ä¸ªæ§åˆ¶å™¨çš„è¯·æ±‚å‚æ•°çš„æ—¶å€™ï¼Œç”¨åˆ°çš„æ˜¯<code>HandlerMethodArgumentResolverComposite</code>ï¼Œé‡Œé¢è£…è½½äº†æ‰€æœ‰å¯ç”¨çš„<code>HandlerMethodArgumentResolver</code>å­ç±»ã€‚è€Œ<code>HandlerMethodArgumentResolver</code>å­ç±»åœ¨è§£æå‚æ•°çš„æ—¶å€™ä½¿ç”¨åˆ°<code>HttpMessageConverter</code>ï¼ˆå®é™…ä¸Šä¹Ÿæ˜¯ä¸€ä¸ªåˆ—è¡¨ï¼Œè¿›è¡Œéå†åŒ¹é…è§£æï¼‰å­ç±»è¿›è¡ŒåŒ¹é…è§£æï¼Œå¸¸è§çš„å¦‚<code>MappingJackson2HttpMessageConverter</code>ï¼ˆä½¿ç”¨<code>Jackson</code>è¿›è¡Œåºåˆ—åŒ–å’Œååºåˆ—åŒ–ï¼‰ã€‚è€Œ<code>HandlerMethodArgumentResolver</code>å­ç±»åˆ°åº•ä¾èµ–ä»€ä¹ˆ<code>HttpMessageConverter</code>å®ä¾‹å®é™…ä¸Šæ˜¯ç”±è¯·æ±‚å¤´ä¸­çš„<code>Content-Type</code>ï¼ˆåœ¨<code>SpringMVC</code>ä¸­ç»Ÿä¸€å‘½åä¸º<code>MediaType</code>ï¼Œè§<code>org.springframework.http.MediaType</code>ï¼‰å†³å®šçš„ï¼Œå› æ­¤æˆ‘ä»¬åœ¨å¤„ç†æ§åˆ¶å™¨çš„è¯·æ±‚å‚æ•°ä¹‹å‰å¿…é¡»è¦æ˜ç¡®å¤–éƒ¨è¯·æ±‚çš„<code>Content-Type</code>åˆ°åº•æ˜¯ä»€ä¹ˆã€‚ä¸Šé¢çš„é€»è¾‘å¯ä»¥ç›´æ¥çœ‹æºç <code>AbstractMessageConverterMethodArgumentResolver#readWithMessageConverters</code>ï¼Œæ€è·¯æ˜¯æ¯”è¾ƒæ¸…æ™°çš„ã€‚åœ¨<code>@RequestMapping</code>æ³¨è§£ä¸­ï¼Œ<code>produces</code>å’Œ<code>consumes</code>å±æ€§å°±æ˜¯å’Œè¯·æ±‚æˆ–è€…å“åº”çš„<code>Content-Type</code>ç›¸å…³çš„ï¼š</p><ul><li><code>consumes</code>å±æ€§ï¼šæŒ‡å®šå¤„ç†è¯·æ±‚çš„æäº¤å†…å®¹ç±»å‹ï¼ˆ<code>Content-Type</code>ï¼‰ï¼Œä¾‹å¦‚<code>application/json</code>ã€<code>text/html</code>ç­‰ç­‰ï¼Œåªæœ‰å‘½ä¸­äº†å¯¹åº”çš„<code>Content-Type</code>çš„å€¼æ‰ä¼šæ¥å—è¯¥è¯·æ±‚ã€‚</li><li><code>produces</code>å±æ€§ï¼šæŒ‡å®šè¿”å›çš„å†…å®¹ç±»å‹ï¼Œä»…å½“æŸä¸ªè¯·æ±‚çš„è¯·æ±‚å¤´ä¸­çš„ï¼ˆ<code>Accept</code>ï¼‰ç±»å‹ä¸­åŒ…å«è¯¥æŒ‡å®šç±»å‹æ‰è¿”å›ï¼Œå¦‚æœè¿”å›çš„æ˜¯JSONæ•°æ®ä¸€èˆ¬è€ƒè™‘ä½¿ç”¨<code>application/json;charset=UTF-8</code>ã€‚</li></ul><p>å¦å¤–æä¸€ç‚¹ï¼Œ<code>SpringMVC</code>ä¸­é»˜è®¤ä½¿ç”¨<code>Jackson</code>ä½œä¸ºJSONçš„å·¥å…·åŒ…ï¼Œå¦‚æœä¸æ˜¯å®Œå…¨ç†è§£é€æ•´å¥—æºç çš„è¿ä½œï¼Œä¸€èˆ¬ä¸æ˜¯ååˆ†å»ºè®®ä¿®æ”¹é»˜è®¤ä½¿ç”¨çš„<code>MappingJackson2HttpMessageConverter</code>ï¼ˆä¾‹å¦‚æœ‰äº›äººå–œæ¬¢ä½¿ç”¨<code>FastJson</code>ï¼Œå®ç°<code>HttpMessageConverter</code>å¼•å…¥<code>FastJson</code>åšHTTPæ¶ˆæ¯è½¬æ¢å™¨ï¼Œè¿™ç§åšæ³•å¹¶ä¸æ¨èï¼‰ã€‚</p><h2 id="SpringMVCè¯·æ±‚å‚æ•°æ¥æ”¶">SpringMVCè¯·æ±‚å‚æ•°æ¥æ”¶</h2><p>å…¶å®ä¸€èˆ¬çš„è¡¨å•æˆ–è€…JSONæ•°æ®çš„è¯·æ±‚éƒ½æ˜¯ç›¸å¯¹ç®€å•çš„ï¼Œä¸€äº›å¤æ‚çš„å¤„ç†ä¸»è¦åŒ…æ‹¬URLè·¯å¾„å‚æ•°ã€æ–‡ä»¶ä¸Šä¼ ã€æ•°ç»„æˆ–è€…åˆ—è¡¨ç±»å‹æ•°æ®ç­‰ã€‚å¦å¤–ï¼Œå…³äºå‚æ•°ç±»å‹ä¸­å­˜åœ¨æ—¥æœŸç±»å‹å±æ€§ï¼ˆä¾‹å¦‚<code>java.util.Date</code>ã€<code>java.sql.Date</code>ã€<code>java.time.LocalDate</code>ã€<code>java.time.LocalDateTime</code>ã€<code>java.time.ZonedDateTime</code>ç­‰ç­‰ï¼‰ï¼Œè§£æçš„æ—¶å€™ä¸€èˆ¬éœ€è¦è‡ªå®šä¹‰å®ç°çš„é€»è¾‘å®ç°<code>String--&gt;æ—¥æœŸç±»å‹</code>çš„è½¬æ¢ã€‚å…¶å®é“ç†å¾ˆç®€å•ï¼Œæ—¥æœŸç›¸å…³çš„ç±»å‹å¯¹äºæ¯ä¸ªå›½å®¶ã€æ¯ä¸ªæ—¶åŒºç”šè‡³æ¯ä¸ªä½¿ç”¨è€…æ¥è¯´è®¤çŸ¥éƒ½ä¸ä¸€å®šç›¸åŒï¼Œæ‰€ä»¥<code>SpringMVC</code>å¹¶æ²¡æœ‰å¯¹äºæ—¥æœŸæ—¶é—´ç±»å‹çš„è§£ææä¾›ä¸€ä¸ªé€šç”¨çš„è§£å†³æ–¹æ¡ˆã€‚åœ¨æ¼”ç¤ºä¸€äº›ä¾‹å­å¯èƒ½ç”¨åˆ°ä¸‹é¢çš„æ¨¡ç‰¹ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> Integer age;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Contact&gt; contacts;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Contact</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> String phone;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢ä¸»è¦ä»¥<code>HTTP</code>çš„<code>GET</code>æ–¹æ³•å’Œ<code>POST</code>æ–¹æ³•æäº¤åœ¨<code>SpringMVC</code>ä½“ç³»ä¸­æ­£ç¡®å¤„ç†å‚æ•°çš„ä¾‹å­è¿›è¡Œåˆ†æï¼Œè¿˜ä¼šèŠ±ç²¾åŠ›æ•´ç†<code>SpringMVC</code>ä½“ç³»ä¸­<strong>ç‹¬æœ‰çš„<code>URL</code>è·¯å¾„å‚æ•°</strong>å¤„ç†çš„ä¸€äº›æŠ€å·§ä»¥åŠæœ€å¸¸è§çš„<strong>æ—¥æœŸå‚æ•°</strong>å¤„ç†çš„åˆç†å®è·µï¼ˆå¯¹äº<code>GET</code>æ–¹æ³•å’Œ<code>POST</code>æ–¹æ³•æäº¤çš„å‚æ•°å¤„ç†ï¼ŒåŸºæœ¬å›Šæ‹¬äº†å…¶ä»–å¦‚<code>DELETE</code>ã€<code>PUT</code>ç­‰æ–¹æ³•çš„å‚æ•°å¤„ç†ï¼Œéšæœºåº”å˜å³å¯ï¼‰ã€‚</p><h3 id="GETæ–¹æ³•è¯·æ±‚å‚æ•°å¤„ç†">GETæ–¹æ³•è¯·æ±‚å‚æ•°å¤„ç†</h3><p><code>HTTP(s)</code>åè®®ä½¿ç”¨<code>GET</code>æ–¹æ³•è¿›è¡Œè¯·æ±‚çš„æ—¶å€™ï¼Œæäº¤çš„å‚æ•°ä½äº<code>URL</code>æ¨¡å¼çš„<code>Query</code>éƒ¨åˆ†ï¼Œä¹Ÿå°±æ˜¯<code>URL</code>çš„<code>?</code>ä¹‹åçš„å‚æ•°ï¼Œæ ¼å¼æ˜¯<code>key1=value1&amp;key2=value2</code>ã€‚<code>GET</code>æ–¹æ³•è¯·æ±‚å‚æ•°å¯ä»¥æœ‰å¤šç§æ–¹æ³•è·å–ï¼š</p><ol><li>ä½¿ç”¨<code>@RequestParam</code>æ³¨è§£å¤„ç†ã€‚</li><li>ä½¿ç”¨å¯¹è±¡æ¥æ”¶ï¼Œæ³¨æ„å¯¹è±¡çš„å±æ€§åç§°è¦å’Œ<code>Query</code>ä¸­çš„å‚æ•°åç§°ä¸€è‡´ã€‚</li><li>ä½¿ç”¨<code>HttpServletRequest</code>å®ä¾‹æä¾›çš„æ–¹æ³•ï¼ˆä¸æ¨èï¼Œå­˜åœ¨ç¡¬ç¼–ç ï¼‰ã€‚</li></ol><p>å‡è®¾è¯·æ±‚çš„<code>URL</code>ä¸º<code>http://localhost:8080/get?name=doge&amp;age=26</code>ï¼Œé‚£ä¹ˆæ§åˆ¶å™¨å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SampleController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(path = <span class="string">"/get1"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">get1</span><span class="params">(@RequestParam(name = <span class="string">"name"</span>)</span> String name,</span></span><br><span class="line"><span class="function">                     @<span class="title">RequestParam</span><span class="params">(name = <span class="string">"age"</span>)</span> Integer age) </span>&#123;</span><br><span class="line">        log.info(<span class="string">"name:&#123;&#125;,age:&#123;&#125;"</span>, name, age);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(path = <span class="string">"/get2"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">get2</span><span class="params">(UserVo vo)</span> </span>&#123;</span><br><span class="line">        log.info(<span class="string">"name:&#123;&#125;,age:&#123;&#125;"</span>, vo.getName(), vo.getAge());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(path = <span class="string">"/get3"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">get3</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">        String name = request.getParameter(<span class="string">"name"</span>);</span><br><span class="line">        String age = request.getParameter(<span class="string">"age"</span>);</span><br><span class="line">        log.info(<span class="string">"name:&#123;&#125;,age:&#123;&#125;"</span>, name, age);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">UserVo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> String name;</span><br><span class="line">        <span class="keyword">private</span> Integer age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="è¡¨å•å‚æ•°">è¡¨å•å‚æ•°</h3><p>è¡¨å•å‚æ•°ï¼Œä¸€èˆ¬å¯¹åº”äºé¡µé¢ä¸Š<code>&lt;form&gt;</code>æ ‡ç­¾å†…çš„æ‰€æœ‰<code>&lt;input&gt;</code>æ ‡ç­¾çš„<code>name-value</code>èšåˆè€Œæˆçš„å‚æ•°ï¼Œä¸€èˆ¬<code>Content-Type</code>æŒ‡å®šä¸º<code>application/x-www-form-urlencoded</code>ï¼Œä¹Ÿå°±æ˜¯ä¼šè¿›è¡Œ<code>URL</code>ç¼–ç ã€‚ä¸‹é¢ä»‹ç»å‡ ç§å¸¸è§çš„è¡¨å•å‚æ•°æäº¤çš„å‚æ•°å½¢å¼ã€‚</p><ul><li>ã€éå¯¹è±¡ã€‘- éå¯¹è±¡ç±»å‹å•ä¸ªå‚æ•°æ¥æ”¶ã€‚</li></ul><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201912/spmvc-p-1.png" alt="spmvc-p-1"></p><p>å¯¹åº”çš„æ§åˆ¶å™¨å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(value = <span class="string">"/post"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">post</span><span class="params">(@RequestParam(name = <span class="string">"name"</span>)</span> String name,</span></span><br><span class="line"><span class="function">                   @<span class="title">RequestParam</span><span class="params">(name = <span class="string">"age"</span>)</span> Integer age) </span>&#123;</span><br><span class="line">    String content = String.format(<span class="string">"name = %s,age = %d"</span>, name, age);</span><br><span class="line">    log.info(content);</span><br><span class="line">    <span class="keyword">return</span> content;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯´å®è¯ï¼Œå¦‚æœæœ‰æ¯…åŠ›çš„è¯ï¼Œæ‰€æœ‰çš„å¤æ‚å‚æ•°çš„æäº¤æœ€ç»ˆéƒ½å¯ä»¥è½¬åŒ–ä¸ºå¤šä¸ªå•å‚æ•°æ¥æ”¶ï¼Œä¸è¿‡è¿™æ ·åšä¼šäº§ç”Ÿååˆ†å¤šå†—ä½™çš„ä»£ç ï¼Œè€Œä¸”å¯ç»´æŠ¤æ€§æ¯”è¾ƒä½ã€‚è¿™ç§æƒ…å†µä¸‹ï¼Œç”¨åˆ°çš„å‚æ•°å¤„ç†å™¨æ˜¯<code>RequestParamMapMethodArgumentResolver</code>ã€‚</p><ul><li>ã€å¯¹è±¡ã€‘ - å¯¹è±¡ç±»å‹å‚æ•°æ¥æ”¶ã€‚</li></ul><p>æˆ‘ä»¬æ¥ç€å†™ä¸€ä¸ªæ¥å£ç”¨äºæäº¤ç”¨æˆ·ä¿¡æ¯ï¼Œç”¨åˆ°çš„æ˜¯ä¸Šé¢æåˆ°çš„æ¨¡ç‰¹ç±»ï¼Œä¸»è¦åŒ…æ‹¬ç”¨æˆ·å§“åã€å¹´é¾„å’Œè”ç³»äººä¿¡æ¯åˆ—è¡¨ï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬ç›®æ ‡çš„æ§åˆ¶å™¨æœ€ç»ˆç¼–ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(value = <span class="string">"/user"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">saveUser</span><span class="params">(User user)</span> </span>&#123;</span><br><span class="line">    log.info(user.toString());</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬è¿˜æ˜¯æŒ‡å®š<code>Content-Type</code>ä¸º<code>application/x-www-form-urlencoded</code>ï¼Œæ¥ç€æˆ‘ä»¬éœ€è¦æ„é€ è¯·æ±‚å‚æ•°ï¼š</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201912/spmvc-p-2.png" alt="spmvc-p-2"></p><p>å› ä¸ºæ²¡æœ‰ä½¿ç”¨æ³¨è§£ï¼Œæœ€ç»ˆçš„å‚æ•°å¤„ç†å™¨ä¸º<code>ServletModelAttributeMethodProcessor</code>ï¼Œä¸»è¦æ˜¯æŠŠ<code>HttpServletRequest</code>ä¸­çš„è¡¨å•å‚æ•°å°è£…åˆ°<code>MutablePropertyValues</code>å®ä¾‹ä¸­ï¼Œå†é€šè¿‡å‚æ•°ç±»å‹å®ä¾‹åŒ–(é€šè¿‡æ„é€ åå°„åˆ›å»º<code>User</code>å®ä¾‹)ï¼Œåå°„åŒ¹é…å±æ€§è¿›è¡Œå€¼çš„å¡«å……ã€‚å¦å¤–ï¼Œè¯·æ±‚å¤æ‚å‚æ•°é‡Œé¢çš„åˆ—è¡¨å±æ€§è¯·æ±‚å‚æ•°çœ‹èµ·æ¥æ¯”è¾ƒå¥‡è‘©ï¼Œå®é™…ä¸Šå’Œåœ¨<code>.properties</code>æ–‡ä»¶ä¸­æ·»åŠ æœ€ç»ˆæ˜ å°„åˆ°<code>Map</code>ç±»å‹çš„å‚æ•°çš„å†™æ³•æ˜¯ä¸€è‡´çš„ã€‚é‚£ä¹ˆï¼Œèƒ½ä¸èƒ½æŠŠæ•´ä¸ªè¯·æ±‚å‚æ•°å¡åœ¨ä¸€ä¸ªå­—æ®µä¸­æäº¤å‘¢ï¼Ÿ</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201912/spmvc-p-3.png" alt="spmvc-p-3"></p><p>ç›´æ¥è¿™æ ·åšæ˜¯ä¸è¡Œçš„ï¼Œå› ä¸ºå®é™…æäº¤çš„<code>Form</code>è¡¨å•ï¼Œ<code>key</code>æ˜¯<code>user</code>å­—ç¬¦ä¸²ï¼Œ<code>value</code>å®é™…ä¸Šä¹Ÿæ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œç¼ºå°‘ä¸€ä¸ª<code>String-&gt;User</code>ç±»å‹çš„è½¬æ¢å™¨ï¼Œå®é™…ä¸Š<code>RequestParamMethodArgumentResolver</code>ä¾èµ–<code>WebConversionService</code>ä¸­<code>Converter</code>å®ä¾‹åˆ—è¡¨è¿›è¡Œå‚æ•°è½¬æ¢ï¼š</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201912/spmvc-p-4.png" alt="spmvc-p-4"></p><p>è§£å†³åŠæ³•è¿˜æ˜¯æœ‰çš„ï¼Œæ·»åŠ ä¸€ä¸ª<code>org.springframework.core.convert.converter.Converter</code>å®ç°å³å¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StringUserConverter</span> <span class="keyword">implements</span> <span class="title">Converter</span>&lt;<span class="title">String</span>, <span class="title">User</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowaired</span></span><br><span class="line">    <span class="keyword">private</span> ObjectMapper objectMapper;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> User <span class="title">convert</span><span class="params">(String source)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">               <span class="keyword">return</span> objectMapper.readValue(source, User<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢è¿™ç§åšæ³•å±äºæ›²çº¿æ•‘å›½çš„åšæ³•ï¼Œä¸æ¨èä½¿ç”¨åœ¨ç”Ÿäº§ç¯å¢ƒï¼Œä½†æ˜¯å¦‚æœæœ‰äº›ç¬¬ä¸‰æ–¹æ¥å£çš„å¯¹æ¥æ— æ³•é¿å…è¿™ç§å‚æ•°ï¼Œå¯ä»¥é€‰æ‹©è¿™ç§å®ç°æ–¹å¼ã€‚</p><ul><li>ã€æ•°ç»„ã€‘ - åˆ—è¡¨æˆ–è€…æ•°ç»„ç±»å‹å‚æ•°ã€‚</li></ul><p>æåº¦ä¸æ¨èä½¿ç”¨åœ¨<code>application/x-www-form-urlencoded</code>è¿™ç§åª’ä½“ç±»å‹çš„è¡¨å•æäº¤çš„å½¢å¼ä¸‹å¼ºè¡Œä½¿ç”¨åˆ—è¡¨æˆ–è€…æ•°ç»„ç±»å‹å‚æ•°ï¼Œé™¤éæ˜¯ä¸ºäº†å…¼å®¹å¤„ç†å†å²é—ç•™ç³»ç»Ÿçš„å‚æ•°æäº¤å¤„ç†ã€‚ä¾‹å¦‚æäº¤çš„å‚æ•°å½¢å¼æ˜¯ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">list &#x3D; [&quot;string-1&quot;, &quot;string-2&quot;, &quot;string-3&quot;]</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆè¡¨å•å‚æ•°çš„å½¢å¼è¦å†™æˆï¼š</p><table><thead><tr><th style="text-align:center">name</th><th style="text-align:center">value</th></tr></thead><tbody><tr><td style="text-align:center">list[0]</td><td style="text-align:center">string-1</td></tr><tr><td style="text-align:center">list[1]</td><td style="text-align:center">string-2</td></tr><tr><td style="text-align:center">list[2]</td><td style="text-align:center">string-3</td></tr></tbody></table><p>æ§åˆ¶å™¨çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(path = <span class="string">"/list"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">list</span><span class="params">(@RequestParam(name=<span class="string">"list"</span>)</span> List&lt;String&gt; list) </span>&#123;</span><br><span class="line">    log.info(list);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªæ›´åŠ å¤æ‚çš„ä¾‹å­å¦‚ä¸‹ï¼Œå‡è®¾æƒ³è¦æäº¤çš„æŠ¥æ–‡æ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">user &#x3D; [&#123;&quot;name&quot;:&quot;doge-1&quot;,&quot;age&quot;: 21&#125;,&#123;&quot;name&quot;:&quot;doge-2&quot;,&quot;age&quot;: 22&#125;]</span><br></pre></td></tr></table></figure><p>é‚£ä¹ˆè¡¨å•å‚æ•°çš„å½¢å¼è¦å†™æˆï¼š</p><table><thead><tr><th style="text-align:center">name</th><th style="text-align:center">value</th></tr></thead><tbody><tr><td style="text-align:center">user[0].name</td><td style="text-align:center">doge-1</td></tr><tr><td style="text-align:center">user[0].age</td><td style="text-align:center">21</td></tr><tr><td style="text-align:center">user[1].name</td><td style="text-align:center">doge-2</td></tr><tr><td style="text-align:center">user[1].age</td><td style="text-align:center">22</td></tr></tbody></table><p>æ§åˆ¶å™¨çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(path = <span class="string">"/user"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">saveUsers</span><span class="params">(@RequestParam(name=<span class="string">"user"</span>)</span> List&lt;UserVo&gt; users) </span>&#123;</span><br><span class="line">    log.info(users);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserVo</span></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> String name;</span><br><span class="line"><span class="keyword">private</span> Integer age;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="JSONå‚æ•°">JSONå‚æ•°</h3><p>ä¸€èˆ¬æ¥è¯´ï¼Œç›´æ¥åœ¨<code>POST</code>è¯·æ±‚ä¸­çš„è¯·æ±‚ä½“æäº¤ä¸€ä¸ªJSONå­—ç¬¦ä¸²è¿™ç§æ–¹å¼å¯¹äº<code>SpringMVC</code>æ¥è¯´æ˜¯æ¯”è¾ƒå‹å¥½çš„ï¼Œåªéœ€è¦æŠŠ<code>Content-Type</code>è®¾ç½®ä¸º<code>application/json</code>ï¼Œæäº¤ä¸€ä¸ªåŸå§‹çš„JSONå­—ç¬¦ä¸²å³å¯ï¼Œæ§åˆ¶å™¨æ–¹æ³•å‚æ•°ä½¿ç”¨<code>@RequestBody</code>æ³¨è§£å¤„ç†ï¼š</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201912/spmvc-p-5.png" alt="spmvc-p-5"></p><p>åç«¯æ§åˆ¶å™¨çš„ä»£ç ä¹Ÿæ¯”è¾ƒç®€å•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(value = <span class="string">"/user-2"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> User <span class="title">saveUser2</span><span class="params">(@RequestBody User user)</span> </span>&#123;</span><br><span class="line">    log.info(user.toString());</span><br><span class="line">    <span class="keyword">return</span> user;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å› ä¸ºä½¿ç”¨äº†<code>@RequestBody</code>æ³¨è§£ï¼Œæœ€ç»ˆä½¿ç”¨åˆ°çš„å‚æ•°å¤„ç†å™¨ä¸º<code>RequestResponseBodyMethodProcessor</code>ï¼Œå®é™…ä¸Šä¼šç”¨åˆ°<code>MappingJackson2HttpMessageConverter</code>è¿›è¡Œå‚æ•°ç±»å‹çš„è½¬æ¢ï¼Œåº•å±‚ä¾èµ–åˆ°<code>Jackson</code>ç›¸å…³çš„åŒ…ã€‚æ¨èä½¿ç”¨è¿™ç§æ–¹å¼ï¼Œè¿™æ˜¯æœ€å¸¸ç”¨ä¹Ÿæ˜¯æœ€ç¨³å¥çš„<code>JSON</code>å‚æ•°å¤„ç†æ–¹å¼ã€‚</p><h2 id="URLè·¯å¾„å‚æ•°">URLè·¯å¾„å‚æ•°</h2><p><code>URL</code>è·¯å¾„å‚æ•°ï¼Œæˆ–è€…å«è¯·æ±‚è·¯å¾„å‚æ•°æ˜¯åŸºäºURLæ¨¡æ¿è·å–åˆ°çš„å‚æ•°ï¼Œä¾‹å¦‚<code>/user/{userId}</code>æ˜¯ä¸€ä¸ª<code>URL</code>æ¨¡æ¿(<code>URL</code>æ¨¡æ¿ä¸­çš„å‚æ•°å ä½ç¬¦æ˜¯{})ï¼Œå®é™…è¯·æ±‚çš„<code>URL</code>ä¸º<code>/user/1</code>ï¼Œé‚£ä¹ˆé€šè¿‡åŒ¹é…å®é™…è¯·æ±‚çš„<code>URL</code>å’Œ<code>URL</code>æ¨¡æ¿å°±èƒ½æå–åˆ°<code>userId</code>ä¸º1ã€‚åœ¨<code>SpringMVC</code>ä¸­ï¼Œ<code>URL</code>æ¨¡æ¿ä¸­çš„è·¯å¾„å‚æ•°å«åš<code>PathVariable</code>ï¼Œå¯¹åº”æ³¨è§£<code>@PathVariable</code>ï¼Œå¯¹åº”çš„å‚æ•°å¤„ç†å™¨ä¸º<code>PathVariableMethodArgumentResolver</code>ã€‚<strong>æ³¨æ„ä¸€ç‚¹æ˜¯ï¼Œ@PathVariableçš„è§£ææ˜¯æŒ‰ç…§value(name)å±æ€§è¿›è¡ŒåŒ¹é…ï¼Œå’ŒURLå‚æ•°çš„é¡ºåºæ˜¯æ— å…³çš„</strong>ã€‚ä¸¾ä¸ªç®€å•çš„ä¾‹å­ï¼š</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201912/spmvc-p-6.png" alt="spmvc-p-6"></p><p>åå°çš„æ§åˆ¶å™¨å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(value = <span class="string">"/user/&#123;name&#125;/&#123;age&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">findUser1</span><span class="params">(@PathVariable(value = <span class="string">"age"</span>)</span> Integer age,</span></span><br><span class="line"><span class="function">@<span class="title">PathVariable</span><span class="params">(value = <span class="string">"name"</span>)</span> String name) </span>&#123;</span><br><span class="line">String content = String.format(<span class="string">"name = %s,age = %d"</span>, name, age);</span><br><span class="line">log.info(content);</span><br><span class="line"><span class="keyword">return</span> content;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ç§ç”¨æ³•è¢«å¹¿æ³›ä½¿ç”¨äº<code>Representational State Transfer(REST)</code>çš„è½¯ä»¶æ¶æ„é£æ ¼ï¼Œä¸ªäººè§‰å¾—è¿™ç§é£æ ¼æ˜¯æ¯”è¾ƒçµæ´»å’Œæ¸…æ™°çš„(ä»URLå’Œè¯·æ±‚æ–¹æ³•å°±èƒ½å®Œå…¨ç†è§£æ¥å£çš„æ„ä¹‰å’ŒåŠŸèƒ½)ã€‚ä¸‹é¢å†ä»‹ç»ä¸¤ç§ç›¸å¯¹ç‰¹æ®Šçš„ä½¿ç”¨æ–¹å¼ã€‚</p><ul><li>å¸¦æ¡ä»¶çš„<code>URL</code>å‚æ•°ã€‚</li></ul><p>å…¶å®è·¯å¾„å‚æ•°æ”¯æŒæ­£åˆ™è¡¨è¾¾å¼ï¼Œä¾‹å¦‚æˆ‘ä»¬åœ¨ä½¿ç”¨<code>/sex/{sex}</code>æ¥å£çš„æ—¶å€™ï¼Œè¦æ±‚<code>sex</code>å¿…é¡»æ˜¯<code>F(Female)</code>æˆ–è€…<code>M(Male)</code>ï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„URLæ¨¡æ¿å¯ä»¥å®šä¹‰ä¸º<code>/sex/{sex:M|F}</code>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(value = <span class="string">"/sex/&#123;sex:M|F&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">findUser2</span><span class="params">(@PathVariable(value = <span class="string">"sex"</span>)</span> String sex)</span>&#123;</span><br><span class="line">    log.info(sex);</span><br><span class="line">    <span class="keyword">return</span> sex;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åªæœ‰<code>/sex/F</code>æˆ–è€…<code>/sex/M</code>çš„è¯·æ±‚æ‰ä¼šè¿›å…¥<code>findUser2()</code>æ§åˆ¶å™¨æ–¹æ³•ï¼Œå…¶ä»–è¯¥è·¯å¾„å‰ç¼€çš„è¯·æ±‚éƒ½æ˜¯éæ³•çš„ï¼Œä¼šè¿”å›404çŠ¶æ€ç ã€‚è¿™é‡Œä»…ä»…æ˜¯ä»‹ç»äº†ä¸€ä¸ªæœ€ç®€å•çš„<code>URL</code>å‚æ•°æ­£åˆ™è¡¨è¾¾å¼çš„ä½¿ç”¨æ–¹å¼ï¼Œæ›´å¼ºå¤§çš„ç”¨æ³•å¯ä»¥è‡ªè¡Œæ‘¸ç´¢ã€‚</p><ul><li><code>@MatrixVariable</code>çš„ä½¿ç”¨ã€‚</li></ul><p><code>MatrixVariable</code>ä¹Ÿæ˜¯<code>URL</code>å‚æ•°çš„ä¸€ç§ï¼Œå¯¹åº”æ³¨è§£<code>@MatrixVariable</code>ï¼Œä¸è¿‡å®ƒå¹¶ä¸æ˜¯<code>URL</code>ä¸­çš„ä¸€ä¸ªå€¼(è¿™é‡Œçš„å€¼æŒ‡å®šæ˜¯ä¸¤ä¸ª&quot;/â€œä¹‹é—´çš„éƒ¨åˆ†)ï¼Œè€Œæ˜¯å€¼çš„ä¸€éƒ¨åˆ†ï¼Œå®ƒé€šè¿‡â€;â€œè¿›è¡Œåˆ†éš”ï¼Œé€šè¿‡â€=&quot;è¿›è¡ŒK-Vè®¾ç½®ã€‚è¯´èµ·æ¥æœ‰ç‚¹æŠ½è±¡ï¼Œä¸¾ä¸ªä¾‹å­ï¼šå‡å¦‚æˆ‘ä»¬éœ€è¦æ‰“ç”µè¯ç»™ä¸€ä¸ªåå­—ä¸ºdogeï¼Œæ€§åˆ«æ˜¯ç”·ï¼Œåˆ†ç»„æ˜¯ç ç•œçš„ç¨‹åºå‘˜ï¼Œ<code>GET</code>è¯·æ±‚çš„<code>URL</code>å¯ä»¥è¡¨ç¤ºä¸ºï¼š<code>/call/doge;gender=male;group=programmer</code>ï¼Œæˆ‘ä»¬è®¾è®¡çš„æ§åˆ¶å™¨æ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(value = <span class="string">"/call/&#123;name&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">find</span><span class="params">(@PathVariable(value = <span class="string">"name"</span>)</span> String name,</span></span><br><span class="line"><span class="function">                   @<span class="title">MatrixVariable</span><span class="params">(value = <span class="string">"gender"</span>)</span> String gender,</span></span><br><span class="line"><span class="function">                   @<span class="title">MatrixVariable</span><span class="params">(value = <span class="string">"group"</span>)</span> String group) </span>&#123;</span><br><span class="line">    String content = String.format(<span class="string">"name = %s,gender = %s,group = %s"</span>, name, gender, group);</span><br><span class="line">    log.info(content);</span><br><span class="line">    <span class="keyword">return</span> content;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ç„¶ï¼Œå¦‚æœä½ æŒ‰ç…§ä¸Šé¢çš„ä¾‹å­å†™å¥½ä»£ç ï¼Œå°è¯•è¯·æ±‚ä¸€ä¸‹è¯¥æ¥å£å‘ç°æ˜¯æŠ¥é”™çš„ï¼š<code>400 Bad Request - Missing matrix variable 'gender' for method parameter of type String</code>ã€‚è¿™æ˜¯å› ä¸º<code>@MatrixVariable</code>æ³¨è§£çš„ä½¿ç”¨æ˜¯ä¸å®‰å…¨çš„ï¼Œåœ¨<code>SpringMVC</code>ä¸­é»˜è®¤æ˜¯å…³é—­å¯¹å…¶æ”¯æŒã€‚è¦å¼€å¯å¯¹<code>@MatrixVariable</code>çš„æ”¯æŒï¼Œéœ€è¦è®¾ç½®<code>RequestMappingHandlerMapping#setRemoveSemicolonContent</code>æ–¹æ³•ä¸º<code>false</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomMvcConfiguration</span> <span class="keyword">implements</span> <span class="title">InitializingBean</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> RequestMappingHandlerMapping requestMappingHandlerMapping;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">afterPropertiesSet</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">requestMappingHandlerMapping.setRemoveSemicolonContent(<span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é™¤éæœ‰å¾ˆç‰¹æ®Šçš„éœ€è¦ï¼Œå¦åˆ™ä¸å»ºè®®ä½¿ç”¨<code>@MatrixVariable</code>ã€‚</p><h2 id="æ–‡ä»¶ä¸Šä¼ ">æ–‡ä»¶ä¸Šä¼ </h2><p>æ–‡ä»¶ä¸Šä¼ åœ¨ä½¿ç”¨<code>POSTMAN</code>æ¨¡æ‹Ÿè¯·æ±‚çš„æ—¶å€™éœ€è¦é€‰æ‹©<code>form-data</code>ï¼Œ<code>POST</code>æ–¹å¼è¿›è¡Œæäº¤ï¼š</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201912/spmvc-p-8.png" alt="spmvc-p-8"></p><p>å‡è®¾æˆ‘ä»¬åœ¨Dç›˜æœ‰ä¸€ä¸ªå›¾ç‰‡æ–‡ä»¶å«doge.jpgï¼Œç°åœ¨è¦é€šè¿‡æœ¬åœ°æœåŠ¡æ¥å£æŠŠæ–‡ä»¶ä¸Šä¼ ï¼Œæ§åˆ¶å™¨çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(value = <span class="string">"/file1"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">file1</span><span class="params">(@RequestPart(name = <span class="string">"file1"</span>)</span> MultipartFile multipartFile) </span>&#123;</span><br><span class="line">String content = String.format(<span class="string">"name = %s,originName = %s,size = %d"</span>,</span><br><span class="line">multipartFile.getName(), multipartFile.getOriginalFilename(), multipartFile.getSize());</span><br><span class="line">log.info(content);</span><br><span class="line"><span class="keyword">return</span> content;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ§åˆ¶å°è¾“å‡ºæ˜¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">name = file1,originName = doge.jpg,size = <span class="number">68727</span></span><br></pre></td></tr></table></figure><p>å¯èƒ½æœ‰ç‚¹ç–‘æƒ‘ï¼Œå‚æ•°æ˜¯æ€ä¹ˆæ¥çš„ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨<code>Fildder</code>è½¯ä»¶æŠ“ä¸ªåŒ…çœ‹ä¸‹ï¼š</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201912/spmvc-p-7.png" alt="spmvc-p-7"></p><p>å¯çŸ¥<code>MultipartFile</code>å®ä¾‹çš„ä¸»è¦å±æ€§åˆ†åˆ«æ¥è‡ª<code>Content-Disposition</code>ã€<code>Content-Type</code>å’Œ<code>Content-Length</code>ï¼Œå¦å¤–ï¼Œ<code>InputStream</code>ç”¨äºè¯»å–è¯·æ±‚ä½“çš„æœ€åéƒ¨åˆ†(æ–‡ä»¶çš„å­—èŠ‚åºåˆ—)ã€‚å‚æ•°å¤„ç†å™¨ç”¨åˆ°çš„æ˜¯<code>RequestPartMethodArgumentResolver</code>(è®°ä½ä¸€ç‚¹ï¼Œä½¿ç”¨äº†<code>@RequestPart</code>å’Œ<code>MultipartFile</code>ä¸€å®šæ˜¯ä½¿ç”¨æ­¤å‚æ•°å¤„ç†å™¨)ã€‚åœ¨å…¶ä»–æƒ…å†µä¸‹ï¼Œä½¿ç”¨<code>@RequestParam</code>å’Œ<code>MultipartFile</code>æˆ–è€…ä»…ä»…ä½¿ç”¨<code>MultipartFile</code>(å‚æ•°çš„åå­—å¿…é¡»å’Œ<code>POST</code>è¡¨å•ä¸­çš„<code>Content-Disposition</code>æè¿°çš„<code>name</code>ä¸€è‡´)ä¹Ÿå¯ä»¥æ¥æ”¶ä¸Šä¼ çš„æ–‡ä»¶æ•°æ®ï¼Œä¸»è¦æ˜¯é€šè¿‡<code>RequestParamMethodArgumentResolver</code>è¿›è¡Œè§£æå¤„ç†çš„ï¼Œå®ƒçš„åŠŸèƒ½æ¯”è¾ƒå¼ºå¤§ï¼Œå…·ä½“å¯ä»¥çœ‹å…¶<code>supportsParameter</code>æ–¹æ³•ï¼Œè¿™ä¸¤ç§æƒ…å†µçš„æ§åˆ¶å™¨æ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(value = <span class="string">"/file2"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">file2</span><span class="params">(MultipartFile file1)</span> </span>&#123;</span><br><span class="line">String content = String.format(<span class="string">"name = %s,originName = %s,size = %d"</span>,</span><br><span class="line">file1.getName(), file1.getOriginalFilename(), file1.getSize());</span><br><span class="line">log.info(content);</span><br><span class="line"><span class="keyword">return</span> content;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@PostMapping</span>(value = <span class="string">"/file3"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">file3</span><span class="params">(@RequestParam(name = <span class="string">"file1"</span>)</span> MultipartFile multipartFile) </span>&#123;</span><br><span class="line">String content = String.format(<span class="string">"name = %s,originName = %s,size = %d"</span>,</span><br><span class="line">multipartFile.getName(), multipartFile.getOriginalFilename(), multipartFile.getSize());</span><br><span class="line">log.info(content);</span><br><span class="line"><span class="keyword">return</span> content;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å…¶ä»–å‚æ•°">å…¶ä»–å‚æ•°</h2><p>å…¶ä»–å‚æ•°ä¸»è¦åŒ…æ‹¬è¯·æ±‚å¤´ã€<code>Cookie</code>ã€<code>Model</code>ã€<code>Map</code>ç­‰ç›¸å…³å‚æ•°ï¼Œè¿˜æœ‰ä¸€äº›å¹¶ä¸æ˜¯å¾ˆå¸¸ç”¨æˆ–è€…ä¸€äº›ç›¸å¯¹åŸç”Ÿçš„å±æ€§å€¼è·å–(ä¾‹å¦‚<code>HttpServletRequest</code>ã€<code>HttpServletResponse</code>ç­‰)ä¸åšè®¨è®ºã€‚</p><h3 id="è¯·æ±‚å¤´">è¯·æ±‚å¤´</h3><p>è¯·æ±‚å¤´çš„å€¼ä¸»è¦é€šè¿‡<code>@RequestHeader</code>æ³¨è§£çš„å‚æ•°è·å–ï¼Œå‚æ•°å¤„ç†å™¨æ˜¯<code>RequestHeaderMethodArgumentResolver</code>ï¼Œéœ€è¦åœ¨æ³¨è§£ä¸­æŒ‡å®šè¯·æ±‚å¤´çš„<code>Key</code>ã€‚ç®€å•å®ç”¨å¦‚ä¸‹ï¼š</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201912/spmvc-p-9.png" alt="spmvc-p-9"></p><p>æ§åˆ¶å™¨æ–¹æ³•ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(value = <span class="string">"/header"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">header</span><span class="params">(@RequestHeader(name = <span class="string">"Content-Type"</span>)</span> String Content-Type) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> Content-Type;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Cookie">Cookie</h3><p><code>Cookie</code>çš„å€¼ä¸»è¦é€šè¿‡<code>@CookieValue</code>æ³¨è§£çš„å‚æ•°è·å–ï¼Œå‚æ•°å¤„ç†å™¨ä¸º<code>ServletCookieValueMethodArgumentResolver</code>ï¼Œéœ€è¦åœ¨æ³¨è§£ä¸­æŒ‡å®š<code>Cookie</code>çš„<code>Key</code>ã€‚æ§åˆ¶å™¨æ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(value = <span class="string">"/cookie"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">cookie</span><span class="params">(@CookieValue(name = <span class="string">"JSESSIONID"</span>)</span> String sessionId) </span>&#123;</span><br><span class="line"><span class="keyword">return</span> sessionId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Modelç±»å‹å‚æ•°">Modelç±»å‹å‚æ•°</h3><p><code>Model</code>ç±»å‹å‚æ•°çš„å¤„ç†å™¨æ˜¯<code>ModelMethodProcessor</code>ï¼Œå®é™…ä¸Šå¤„ç†æ­¤å‚æ•°æ˜¯ç›´æ¥è¿”å›<code>ModelAndViewContainer</code>å®ä¾‹ä¸­çš„<code>Model</code>(<code>ModelMap</code>ç±»å‹)ï¼Œå› ä¸ºè¦æ¡¥æ¥ä¸åŒçš„æ¥å£å’Œç±»çš„åŠŸèƒ½ï¼Œå› æ­¤å›è°ƒçš„å®ä¾‹æ˜¯<code>BindingAwareModelMap</code>ç±»å‹ï¼Œæ­¤ç±»å‹ç»§æ‰¿è‡ª<code>ModelMap</code>åŒæ—¶å®ç°äº†<code>Model</code>æ¥å£ã€‚ä¸¾ä¸ªä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(value = <span class="string">"/model"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">model</span><span class="params">(Model model, ModelMap modelMap)</span> </span>&#123;</span><br><span class="line">    log.info(<span class="string">"&#123;&#125;"</span>, model == modelMap);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„è°ƒç”¨æ­¤æ¥å£ï¼Œæ§åˆ¶å°è¾“å‡ºINFOæ—¥å¿—å†…å®¹ä¸ºï¼štrueã€‚è¿˜è¦æ³¨æ„ä¸€ç‚¹ï¼š<code>ModelMap</code>æˆ–è€…<code>Model</code>ä¸­æ·»åŠ çš„å±æ€§é¡¹ä¼šé™„åŠ åˆ°<code>HttpRequestServlet</code>å®ä¾‹ä¸­å¸¦åˆ°é¡µé¢ä¸­è¿›è¡Œæ¸²æŸ“ã€‚</p><h3 id="ModelAttributeå‚æ•°">@ModelAttributeå‚æ•°</h3><p><code>@ModelAttribute</code>æ³¨è§£å¤„ç†çš„å‚æ•°å¤„ç†å™¨ä¸º<code>ModelAttributeMethodProcessor</code>ï¼Œ<code>@ModelAttribute</code>çš„åŠŸèƒ½æºç çš„æ³¨é‡Šå¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Annotation that binds a method parameter or method return value to a named model attribute, exposed to a web view.</span><br></pre></td></tr></table></figure><p>ç®€å•æ¥è¯´ï¼Œå°±æ˜¯é€šè¿‡<code>key-value</code>å½¢å¼ç»‘å®šæ–¹æ³•å‚æ•°æˆ–è€…æ–¹æ³•è¿”å›å€¼åˆ°<code>Model(Map)</code>ä¸­ï¼ŒåŒºåˆ«ä¸‹é¢ä¸‰ç§æƒ…å†µï¼š</p><ol><li><code>@ModelAttribute</code>ä½¿ç”¨åœ¨æ–¹æ³•(è¿”å›å€¼)ä¸Šï¼Œæ–¹æ³•æ²¡æœ‰è¿”å›å€¼(<code>void</code>ç±»å‹)ï¼Œ <code>Model(Map)</code>å‚æ•°éœ€è¦è‡ªè¡Œè®¾ç½®ã€‚</li><li><code>@ModelAttribute</code>ä½¿ç”¨åœ¨æ–¹æ³•(è¿”å›å€¼)ä¸Šï¼Œæ–¹æ³•æœ‰è¿”å›å€¼(é<code>void</code>ç±»å‹)ï¼Œè¿”å›å€¼ä¼šæ·»åŠ åˆ°<code>Model(Map)</code>å‚æ•°ï¼Œ<code>key</code>ç”±<code>@ModelAttribute</code>çš„<code>value</code>æŒ‡å®šï¼Œå¦åˆ™ä¼šä½¿ç”¨è¿”å›å€¼ç±»å‹å­—ç¬¦ä¸²(é¦–å†™å­—æ¯å˜ä¸ºå°å†™ï¼Œå¦‚è¿”å›å€¼ç±»å‹ä¸º<code>Integer</code>ï¼Œåˆ™<code>key</code>ä¸º<code>integer</code>)ã€‚</li><li><code>@ModelAttribute</code>ä½¿ç”¨åœ¨æ–¹æ³•å‚æ•°ä¸­ï¼Œåˆ™å¯ä»¥è·å–åŒä¸€ä¸ªæ§åˆ¶å™¨ä¸­çš„å·²ç»è®¾ç½®çš„<code>@ModelAttribute</code>å¯¹åº”çš„å€¼ã€‚</li></ol><p>åœ¨ä¸€ä¸ªæ§åˆ¶å™¨(ä½¿ç”¨äº†<code>@Controller</code>)ä¸­ï¼Œå¦‚æœå­˜åœ¨ä¸€åˆ°å¤šä¸ªä½¿ç”¨äº†<code>@ModelAttribute</code>çš„æ–¹æ³•ï¼Œè¿™äº›æ–¹æ³•æ€»æ˜¯åœ¨è¿›å…¥æ§åˆ¶å™¨æ–¹æ³•ä¹‹å‰æ‰§è¡Œï¼Œå¹¶ä¸”æ‰§è¡Œé¡ºåºæ˜¯ç”±åŠ è½½é¡ºåºå†³å®šçš„(å…·ä½“çš„é¡ºåºæ˜¯å¸¦å‚æ•°çš„ä¼˜å…ˆï¼Œå¹¶ä¸”æŒ‰ç…§æ–¹æ³•é¦–å­—æ¯å‡åºæ’åº)ï¼Œä¸¾ä¸ªä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Slf</span>4j</span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ModelAttributeController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ModelAttribute</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">(Model model)</span> </span>&#123;</span><br><span class="line">log.info(<span class="string">"before.........."</span>);</span><br><span class="line">model.addAttribute(<span class="string">"before"</span>, <span class="string">"beforeValue"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ModelAttribute</span>(value = <span class="string">"beforeArg"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">beforeArg</span><span class="params">()</span> </span>&#123;</span><br><span class="line">log.info(<span class="string">"beforeArg.........."</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="string">"beforeArgValue"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping</span>(value = <span class="string">"/modelAttribute"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">modelAttribute</span><span class="params">(Model model, @ModelAttribute(value = <span class="string">"beforeArg"</span>)</span> String beforeArg) </span>&#123;</span><br><span class="line">log.info(<span class="string">"modelAttribute.........."</span>);</span><br><span class="line">log.info(<span class="string">"beforeArg..........&#123;&#125;"</span>, beforeArg);</span><br><span class="line">log.info(<span class="string">"&#123;&#125;"</span>, model);</span><br><span class="line"><span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ModelAttribute</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">(Model model)</span> </span>&#123;</span><br><span class="line">log.info(<span class="string">"after.........."</span>);</span><br><span class="line">model.addAttribute(<span class="string">"after"</span>, <span class="string">"afterValue"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ModelAttribute</span>(value = <span class="string">"afterArg"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">afterArg</span><span class="params">()</span> </span>&#123;</span><br><span class="line">log.info(<span class="string">"afterArg.........."</span>);</span><br><span class="line"><span class="keyword">return</span> <span class="string">"afterArgValue"</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨æ­¤æ¥å£ï¼Œæ§åˆ¶å°è¾“å‡ºæ—¥å¿—å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">after..........</span><br><span class="line">before..........</span><br><span class="line">afterArg..........</span><br><span class="line">beforeArg..........</span><br><span class="line">modelAttribute..........</span><br><span class="line">beforeArg..........beforeArgValue</span><br><span class="line">&#123;after&#x3D;afterValue, before&#x3D;beforeValue, afterArg&#x3D;afterArgValue, beforeArg&#x3D;beforeArgValue&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥å°è¯æ’åºè§„åˆ™å’Œå‚æ•°è®¾ç½®ã€è·å–çš„ç»“æœå’Œå‰é¢çš„åˆ†ææ˜¯ä¸€è‡´çš„ã€‚</p><h3 id="Errorsæˆ–è€…BindingResultå‚æ•°">Errorsæˆ–è€…BindingResultå‚æ•°</h3><p><code>Errors</code>å…¶å®æ˜¯<code>BindingResult</code>çš„çˆ¶æ¥å£ï¼Œ<code>BindingResult</code>ä¸»è¦ç”¨äºå›è°ƒJSRå‚æ•°æ ¡éªŒå¼‚å¸¸çš„å±æ€§é¡¹ï¼Œå¦‚æœJSRæ ¡éªŒå¼‚å¸¸ï¼Œä¸€èˆ¬ä¼šæŠ›å‡º<code>MethodArgumentNotValidException</code>å¼‚å¸¸ï¼Œå¹¶ä¸”ä¼šè¿”å›400(Bad Request)ï¼Œè§å…¨å±€å¼‚å¸¸å¤„ç†å™¨<code>DefaultHandlerExceptionResolver</code>ã€‚<code>Errors</code>ç±»å‹çš„å‚æ•°å¤„ç†å™¨ä¸º<code>ErrorsMethodArgumentResolver</code>ã€‚ä¸¾ä¸ªä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(value = <span class="string">"/errors"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">errors</span><span class="params">(@RequestBody @Validated ErrorsModel errors, BindingResult bindingResult)</span> </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (bindingResult.hasErrors()) &#123;</span><br><span class="line"><span class="keyword">for</span> (ObjectError objectError : bindingResult.getAllErrors()) &#123;</span><br><span class="line">log.warn(<span class="string">"name=&#123;&#125;,message=&#123;&#125;"</span>, objectError.getObjectName(), objectError.getDefaultMessage());</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> errors.toString();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ErrorsModel</span></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ErrorsModel</span> </span>&#123;</span><br><span class="line">    <span class="meta">@NotNull</span>(message = <span class="string">"id must not be null!"</span>)</span><br><span class="line">    <span class="keyword">private</span> Integer id;</span><br><span class="line">    <span class="meta">@NotEmpty</span>(message = <span class="string">"errors name must not be empty!"</span>)</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨æ¥å£æ§åˆ¶å°Warnæ—¥å¿—å¦‚ä¸‹ï¼š</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">name&#x3D;errors,message&#x3D;errors name must not be empty!</span><br></pre></td></tr></table></figure><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸å»ºè®®ç”¨è¿™ç§æ–¹å¼å¤„ç†JSRæ ¡éªŒå¼‚å¸¸çš„å±æ€§é¡¹ï¼Œå› ä¸ºä¼šæ¶‰åŠåˆ°å¤§é‡çš„é‡å¤çš„ç¡¬ç¼–ç å·¥ä½œï¼Œå»ºè®®ï¼šæ–¹å¼ä¸€ç›´æ¥ç»§æ‰¿<code>ResponseEntityExceptionHandler</code>è¦†ç›–å¯¹åº”çš„æ–¹æ³•æˆ–è€…æ–¹å¼äºŒåŒæ—¶ä½¿ç”¨<code>@ExceptionHandler</code>å’Œ<code>@(Rest)ControllerAdvice</code>æ³¨è§£è¿›è¡Œå¼‚å¸¸å¤„ç†ã€‚ä¾‹å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestControllerAdvice</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationRestControllerAdvice</span></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@ExceptionHandler</span>(BusinessException<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">Response</span> <span class="title">handleBusinessException</span>(<span class="title">BusinessException</span> <span class="title">e</span>, <span class="title">HttpServletRequest</span> <span class="title">request</span>)</span>&#123;</span><br><span class="line">           <span class="comment">// è¿™é‡Œå¤„ç†å¼‚å¸¸å’Œè¿”å›å€¼</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Valueå‚æ•°">@Valueå‚æ•°</h3><p>æ§åˆ¶å™¨æ–¹æ³•çš„å‚æ•°å¯ä»¥æ˜¯<code>@Value</code>æ³¨è§£ä¿®é¥°çš„å‚æ•°ï¼Œä¼šä»<code>Environment</code>å®ä¾‹ä¸­è£…é…å’Œè½¬æ¢å±æ€§å€¼åˆ°å¯¹åº”çš„å‚æ•°ä¸­(ä¹Ÿå°±æ˜¯å‚æ•°çš„æ¥æºå¹¶ä¸æ˜¯è¯·æ±‚ä½“)ï¼Œå‚æ•°å¤„ç†å™¨ä¸º<code>ExpressionValueMethodArgumentResolver</code>ã€‚ä¸¾ä¸ªä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(value = <span class="string">"/value"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">value</span><span class="params">(@Value(value = <span class="string">"$&#123;spring.application.name&#125;"</span>)</span> String name) </span>&#123;</span><br><span class="line">    log.info(<span class="string">"spring.application.name=&#123;&#125;"</span>, name);</span><br><span class="line">    <span class="keyword">return</span> name;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>spring.application.name</code>å±æ€§ä¸€èˆ¬åœ¨é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šï¼Œåœ¨åŠ è½½é…ç½®æ–‡ä»¶å±æ€§çš„æ—¶å€™æ·»åŠ åˆ°å…¨å±€çš„<code>Environment</code>ä¸­ã€‚</p><h3 id="Mapç±»å‹å‚æ•°">Mapç±»å‹å‚æ•°</h3><p><code>Map</code>ç±»å‹å‚æ•°çš„èŒƒå›´ç›¸å¯¹æ¯”è¾ƒå¹¿ï¼Œå¯¹åº”ä¸€ç³»åˆ—çš„å‚æ•°å¤„ç†å™¨ï¼Œæ³¨æ„åŒºåˆ«ä½¿ç”¨äº†ä¸Šé¢æåˆ°çš„éƒ¨åˆ†æ³¨è§£çš„<code>Map</code>ç±»å‹å’Œå®Œå…¨ä¸ä½¿ç”¨æ³¨è§£çš„<code>Map</code>ç±»å‹å‚æ•°ï¼Œä¸¤è€…çš„å¤„ç†æ–¹å¼ä¸ç›¸åŒã€‚ä¸‹é¢åˆ—ä¸¾å‡ ä¸ªç›¸å¯¹å…¸å‹çš„<code>Map</code>ç±»å‹å‚æ•°å¤„ç†ä¾‹å­ã€‚</p><p><strong>ä¸ä½¿ç”¨ä»»ä½•æ³¨è§£çš„Map&lt;String,Object&gt;å‚æ•°</strong></p><p>è¿™ç§æƒ…å†µä¸‹å‚æ•°å®é™…ä¸Šç›´æ¥å›è°ƒ<code>ModelAndViewContainer</code>ä¸­çš„<code>ModelMap</code>å®ä¾‹ï¼Œå‚æ•°å¤„ç†å™¨ä¸º<code>MapMethodProcessor</code>ï¼Œå¾€<code>Map</code>å‚æ•°ä¸­æ·»åŠ çš„å±æ€§å°†ä¼šå¸¦åˆ°é¡µé¢ä¸­ã€‚</p><p><strong>ä½¿ç”¨@RequestParamæ³¨è§£çš„Map&lt;String,Object&gt;å‚æ•°</strong></p><p>è¿™ç§æƒ…å†µä¸‹çš„å‚æ•°å¤„ç†å™¨ä¸º<code>RequestParamMapMethodArgumentResolver</code>ï¼Œä½¿ç”¨çš„è¯·æ±‚æ–¹å¼éœ€è¦æŒ‡å®š<code>Content-Type</code>ä¸º<code>x-www-form-urlencoded</code>ï¼Œä¸èƒ½ä½¿ç”¨<code>application/json</code>çš„æ–¹å¼ï¼š</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201912/spmvc-p-10.png" alt="spmvc-p-10"></p><p>æ§åˆ¶å™¨ä»£ç ä¸ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(value = <span class="string">"/map"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">mapArgs</span><span class="params">(@RequestParam Map&lt;String, Object&gt; map)</span> </span>&#123;</span><br><span class="line">    log.info(<span class="string">"&#123;&#125;"</span>, map);</span><br><span class="line">    <span class="keyword">return</span> map.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>ä½¿ç”¨@RequestHeaderæ³¨è§£çš„Map&lt;String,Object&gt;å‚æ•°</strong></p><p>è¿™ç§æƒ…å†µä¸‹çš„å‚æ•°å¤„ç†å™¨ä¸º<code>RequestHeaderMapMethodArgumentResolver</code>ï¼Œä½œç”¨æ˜¯è·å–è¯·æ±‚çš„æ‰€æœ‰è¯·æ±‚å¤´çš„<code>Key-Value</code>ã€‚</p><p><strong>ä½¿ç”¨@PathVariableæ³¨è§£çš„Map&lt;String,Object&gt;å‚æ•°</strong></p><p>è¿™ç§æƒ…å†µä¸‹çš„å‚æ•°å¤„ç†å™¨ä¸º<code>PathVariableMapMethodArgumentResolver</code>ï¼Œä½œç”¨æ˜¯è·å–æ‰€æœ‰è·¯å¾„å‚æ•°å°è£…ä¸º<code>Key-Value</code>ç»“æ„ã€‚</p><h3 id="MultipartFileé›†åˆ-æ‰¹é‡æ–‡ä»¶ä¸Šä¼ ">MultipartFileé›†åˆ-æ‰¹é‡æ–‡ä»¶ä¸Šä¼ </h3><p>æ‰¹é‡æ–‡ä»¶ä¸Šä¼ çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¸€èˆ¬éœ€è¦æ¥æ”¶ä¸€ä¸ª<code>MultipartFile</code>é›†åˆï¼Œå¯ä»¥æœ‰ä¸¤ç§é€‰æ‹©ï¼š</p><ol><li>ä½¿ç”¨<code>MultipartHttpServletRequest</code>å‚æ•°ï¼Œç›´æ¥è°ƒç”¨<code>getFiles</code>æ–¹æ³•è·å–<code>MultipartFile</code>åˆ—è¡¨ã€‚</li><li>ä½¿ç”¨<code>@RequestParam</code>æ³¨è§£ä¿®é¥°<code>MultipartFile</code>åˆ—è¡¨ï¼Œå‚æ•°å¤„ç†å™¨æ˜¯<code>RequestParamMethodArgumentResolver</code>ï¼Œå…¶å®å°±æ˜¯ç¬¬1ç§æ–¹å¼çš„å°è£…è€Œå·²ã€‚</li></ol><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201912/spmvc-p-11.png" alt="spmvc-p-11"></p><p>æ§åˆ¶å™¨æ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(value = <span class="string">"/parts"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">partArgs</span><span class="params">(@RequestParam(name = <span class="string">"file"</span>)</span> List&lt;MultipartFile&gt; parts) </span>&#123;</span><br><span class="line">    log.info(<span class="string">"&#123;&#125;"</span>, parts);</span><br><span class="line">    <span class="keyword">return</span> parts.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ—¥æœŸç±»å‹å‚æ•°å¤„ç†">æ—¥æœŸç±»å‹å‚æ•°å¤„ç†</h2><p>æ—¥æœŸå‚æ•°å¤„ç†ä¸ªäººè®¤ä¸ºæ˜¯è¯·æ±‚å‚æ•°å¤„ç†ä¸­æœ€å¤æ‚çš„ï¼Œå› ä¸ºä¸€èˆ¬æ—¥æœŸå¤„ç†çš„é€»è¾‘ä¸æ˜¯é€šç”¨çš„ï¼Œè¿‡å¤šçš„å®šåˆ¶åŒ–å¤„ç†å¯¼è‡´å¾ˆéš¾æœ‰ä¸€ä¸ªç»Ÿä¸€çš„æ ‡å‡†å¤„ç†é€»è¾‘å»å¤„ç†å’Œè½¬æ¢æ—¥æœŸç±»å‹çš„å‚æ•°ã€‚ä¸è¿‡ï¼Œè¿™é‡Œä»‹ç»å‡ ä¸ªé€šç”¨çš„æ–¹æ³•ï¼Œä»¥åº”å¯¹å„ç§å¥‡è‘©çš„æ—¥æœŸæ ¼å¼ã€‚ä¸‹é¢ä»‹ç»çš„ä¾‹å­ä¸­å…¨éƒ¨ä½¿ç”¨Jdk8ä¸­å¼•å…¥çš„æ—¥æœŸæ—¶é—´APIï¼Œå›´ç»•<code>java.util.Date</code>ä¸ºæ ¸å¿ƒçš„æ—¥æœŸæ—¶é—´APIçš„ä½¿ç”¨æ–¹å¼ç±»åŒã€‚</p><h3 id="ä¸€ã€ç»Ÿä¸€ä»¥å­—ç¬¦ä¸²å½¢å¼æ¥æ”¶">ä¸€ã€ç»Ÿä¸€ä»¥å­—ç¬¦ä¸²å½¢å¼æ¥æ”¶</h3><p>è¿™ç§æ˜¯æœ€åŸå§‹ä½†æ˜¯æœ€å¥æ•ˆçš„æ–¹å¼ï¼Œç»Ÿä¸€ä»¥å­—ç¬¦ä¸²å½¢å¼æ¥æ”¶ï¼Œç„¶åè‡ªè¡Œå¤„ç†ç±»å‹è½¬æ¢ï¼Œä¸‹é¢ç»™ä¸ªå°ä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(value = <span class="string">"/date1"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">date1</span><span class="params">(@RequestBody UserDto userDto)</span> </span>&#123;</span><br><span class="line">    UserEntity userEntity = <span class="keyword">new</span> UserEntity();</span><br><span class="line">    userEntity.setUserId(userDto.getUserId());</span><br><span class="line">    userEntity.setBirthdayTime(LocalDateTime.parse(userDto.getBirthdayTime(), FORMATTER));</span><br><span class="line">    userEntity.setGraduationTime(LocalDateTime.parse(userDto.getGraduationTime(), FORMATTER));</span><br><span class="line">    log.info(userEntity.toString());</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDto</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> String userId;</span><br><span class="line"><span class="keyword">private</span> String birthdayTime;</span><br><span class="line"><span class="keyword">private</span> String graduationTime;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserEntity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> String userId;</span><br><span class="line"><span class="keyword">private</span> LocalDateTime birthdayTime;</span><br><span class="line"><span class="keyword">private</span> LocalDateTime graduationTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201912/spmvc-p-12.png" alt="spmvc-p-12"></p><p>ä½¿ç”¨å­—ç¬¦ä¸²æ¥æ”¶åå†è½¬æ¢çš„ç¼ºç‚¹å°±æ˜¯æ¨¡æ¿ä»£ç å¤ªå¤šï¼Œç¼–ç é£æ ¼ä¸å¤Ÿç®€æ´ï¼Œé‡å¤æ€§å·¥ä½œå¤ªå¤šã€‚</p><h3 id="äºŒã€ä½¿ç”¨æ³¨è§£-DateTimeFormatæˆ–è€…-JsonFormat">äºŒã€ä½¿ç”¨æ³¨è§£@DateTimeFormatæˆ–è€…@JsonFormat</h3><p><code>@DateTimeFormat</code>æ³¨è§£é…åˆ<code>@RequestBody</code>çš„å‚æ•°ä½¿ç”¨çš„æ—¶å€™ï¼Œä¼šå‘ç°æŠ›å‡º<code>InvalidFormatException</code>å¼‚å¸¸ï¼Œæç¤ºè½¬æ¢å¤±è´¥ï¼Œè¿™æ˜¯å› ä¸ºåœ¨å¤„ç†æ­¤æ³¨è§£çš„æ—¶å€™ï¼Œåªæ”¯æŒ<code>Form</code>è¡¨å•æäº¤(<code>Content-Type</code>ä¸º<code>x-www-form-urlencoded</code>)ï¼Œä¾‹å­å¦‚ä¸‹ï¼š</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201912/spmvc-p-13.png" alt="spmvc-p-13"></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDto2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> String userId;</span><br><span class="line"><span class="meta">@DateTimeFormat</span>(pattern = <span class="string">"yyyy-MM-dd HH:mm:ss"</span>)</span><br><span class="line"><span class="keyword">private</span> LocalDateTime birthdayTime;</span><br><span class="line"><span class="meta">@DateTimeFormat</span>(pattern = <span class="string">"yyyy-MM-dd HH:mm:ss"</span>)</span><br><span class="line"><span class="keyword">private</span> LocalDateTime graduationTime;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@PostMapping</span>(value = <span class="string">"/date2"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">date2</span><span class="params">(UserDto2 userDto2)</span> </span>&#123;</span><br><span class="line">    log.info(userDto2.toString());</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//æˆ–è€…åƒä¸‹é¢è¿™æ ·</span></span><br><span class="line"><span class="meta">@PostMapping</span>(value = <span class="string">"/date2"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">date2</span><span class="params">(@RequestParam(<span class="string">"name"</span>=<span class="string">"userId"</span>)</span>String userId,</span></span><br><span class="line"><span class="function">                    @<span class="title">RequestParam</span><span class="params">(<span class="string">"name"</span>=<span class="string">"birthdayTime"</span>)</span> @<span class="title">DateTimeFormat</span><span class="params">(pattern = <span class="string">"yyyy-MM-dd HH:mm:ss"</span>)</span> LocalDateTime birthdayTime,</span></span><br><span class="line"><span class="function">                    @<span class="title">RequestParam</span><span class="params">(<span class="string">"name"</span>=<span class="string">"graduationTime"</span>)</span> @<span class="title">DateTimeFormat</span><span class="params">(pattern = <span class="string">"yyyy-MM-dd HH:mm:ss"</span>)</span> LocalDateTime graduationTime) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è€Œ<code>@JsonFormat</code>æ³¨è§£å¯ä½¿ç”¨åœ¨Formè¡¨å•æˆ–è€…JSONè¯·æ±‚å‚æ•°çš„åœºæ™¯ï¼Œå› æ­¤æ›´æ¨èä½¿ç”¨<code>@JsonFormat</code>æ³¨è§£ï¼Œä¸è¿‡æ³¨æ„éœ€è¦æŒ‡å®šæ—¶åŒº(<code>timezone</code>å±æ€§ï¼Œä¾‹å¦‚åœ¨ä¸­å›½æ˜¯ä¸œå…«åŒº<code>GMT+8</code>)ï¼Œå¦åˆ™æœ‰å¯èƒ½å¯¼è‡´å‡ºç°<strong>æ—¶å·®</strong>ï¼Œä¸¾ä¸ªä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(value = <span class="string">"/date2"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">date2</span><span class="params">(@RequestBody UserDto2 userDto2)</span> </span>&#123;</span><br><span class="line">    log.info(userDto2.toString());</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDto2</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String userId;</span><br><span class="line">    <span class="meta">@JsonFormat</span>(pattern = <span class="string">"yyyy-MM-dd HH:mm:ss"</span>, timezone = <span class="string">"GMT+8"</span>)</span><br><span class="line">    <span class="keyword">private</span> LocalDateTime birthdayTime;</span><br><span class="line">    <span class="meta">@JsonFormat</span>(pattern = <span class="string">"yyyy-MM-dd HH:mm:ss"</span>, timezone = <span class="string">"GMT+8"</span>)</span><br><span class="line">    <span class="keyword">private</span> LocalDateTime graduationTime;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ä¸‰ã€Jacksonåºåˆ—åŒ–å’Œååºåˆ—åŒ–å®šåˆ¶">ä¸‰ã€Jacksonåºåˆ—åŒ–å’Œååºåˆ—åŒ–å®šåˆ¶</h3><p>å› ä¸º<code>SpringMVC</code>é»˜è®¤ä½¿ç”¨<code>Jackson</code>å¤„ç†<code>@RequestBody</code>çš„å‚æ•°è½¬æ¢ï¼Œå› æ­¤å¯ä»¥é€šè¿‡å®šåˆ¶åºåˆ—åŒ–å™¨å’Œååºåˆ—åŒ–å™¨æ¥å®ç°æ—¥æœŸç±»å‹çš„è½¬æ¢ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨<code>application/json</code>çš„å½¢å¼æäº¤è¯·æ±‚å‚æ•°ã€‚è¿™é‡Œçš„ä¾‹å­æ˜¯è½¬æ¢è¯·æ±‚Jsonå‚æ•°ä¸­çš„å­—ç¬¦ä¸²ä¸º<code>LocalDateTime</code>ç±»å‹ï¼Œå±äºJsonååºåˆ—åŒ–ï¼Œå› æ­¤éœ€è¦å®šåˆ¶ååºåˆ—åŒ–å™¨ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(value = <span class="string">"/date3"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">date3</span><span class="params">(@RequestBody UserDto3 userDto3)</span> </span>&#123;</span><br><span class="line">    log.info(userDto3.toString());</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UserDto3</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> String userId;</span><br><span class="line"><span class="meta">@JsonDeserialize</span>(using = CustomLocalDateTimeDeserializer<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">private</span> <span class="title">LocalDateTime</span> <span class="title">birthdayTime</span></span>;</span><br><span class="line"><span class="meta">@JsonDeserialize</span>(using = CustomLocalDateTimeDeserializer<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">private</span> <span class="title">LocalDateTime</span> <span class="title">graduationTime</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomLocalDateTimeDeserializer</span> <span class="keyword">extends</span> <span class="title">LocalDateTimeDeserializer</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">CustomLocalDateTimeDeserializer</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">super</span>(DateTimeFormatter.ofPattern(<span class="string">"yyyy-MM-dd HH:mm:ss"</span>));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å››ã€æœ€ä½³å®è·µ">å››ã€æœ€ä½³å®è·µ</h3><p>å‰é¢ä¸‰ç§æ–¹å¼éƒ½å­˜åœ¨ç¡¬ç¼–ç ç­‰é—®é¢˜ï¼Œå…¶å®æœ€ä½³å®è·µæ˜¯ç›´æ¥ä¿®æ”¹<code>MappingJackson2HttpMessageConverter</code>ä¸­çš„<code>ObjectMapper</code>å¯¹äºæ—¥æœŸç±»å‹å¤„ç†é»˜è®¤çš„åºåˆ—åŒ–å™¨å’Œååºåˆ—åŒ–å™¨ï¼Œè¿™æ ·å°±èƒ½å…¨å±€ç”Ÿæ•ˆï¼Œä¸éœ€è¦å†ä½¿ç”¨å…¶ä»–æ³¨è§£æˆ–è€…å®šåˆ¶åºåˆ—åŒ–æ–¹æ¡ˆ(å½“ç„¶ï¼Œæœ‰äº›æ—¶å€™éœ€è¦ç‰¹æ®Šå¤„ç†å®šåˆ¶)ï¼Œæˆ–è€…è¯´ï¼Œåœ¨éœ€è¦ç‰¹æ®Šå¤„ç†çš„åœºæ™¯æ‰ä½¿ç”¨å…¶ä»–æ³¨è§£æˆ–è€…å®šåˆ¶åºåˆ—åŒ–æ–¹æ¡ˆã€‚ä½¿ç”¨é’©å­æ¥å£<code>Jackson2ObjectMapperBuilderCustomizer</code>å¯ä»¥å®ç°å¯¹å®¹å™¨ä¸­çš„<code>ObjectMapper</code>å•ä¾‹ä¸­çš„å±æ€§å®šåˆ¶ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Jackson2ObjectMapperBuilderCustomizer <span class="title">jackson2ObjectMapperBuilderCustomizer</span><span class="params">()</span></span>&#123;</span><br><span class="line"><span class="keyword">return</span> customizer-&gt;&#123;</span><br><span class="line">customizer.serializerByType(LocalDateTime<span class="class">.<span class="keyword">class</span>,<span class="title">new</span> <span class="title">LocalDateTimeSerializer</span>(</span></span><br><span class="line">DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss")));</span><br><span class="line">customizer.deserializerByType(LocalDateTime<span class="class">.<span class="keyword">class</span>,<span class="title">new</span> <span class="title">LocalDateTimeDeserializer</span>(</span></span><br><span class="line">DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss")));</span><br><span class="line">&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·å°±èƒ½å®šåˆ¶åŒ–<code>MappingJackson2HttpMessageConverter</code>ä¸­æŒæœ‰çš„<code>ObjectMapper</code>ï¼Œä¸Šé¢çš„<code>LocalDateTime</code>åºåˆ—åŒ–å’Œååºåˆ—åŒ–å™¨å¯¹å…¨å±€ç”Ÿæ•ˆã€‚</p><h2 id="è¯·æ±‚URLåŒ¹é…">è¯·æ±‚URLåŒ¹é…</h2><p>å‰é¢åŸºæœ¬ä»‹ç»å®Œäº†ä¸»æµçš„è¯·æ±‚å‚æ•°å¤„ç†ï¼Œå…¶å®<code>SpringMVC</code>ä¸­è¿˜ä¼šæŒ‰ç…§<code>URL</code>çš„æ¨¡å¼è¿›è¡ŒåŒ¹é…ï¼Œä½¿ç”¨çš„æ˜¯<code>Ant</code>è·¯å¾„é£æ ¼ï¼Œå¤„ç†å·¥å…·ç±»ä¸º<code>org.springframework.util.AntPathMatcher</code>ï¼Œä»æ­¤ç±»çš„æ³¨é‡Šæ¥çœ‹ï¼ŒåŒ¹é…è§„åˆ™ä¸»è¦åŒ…æ‹¬ä¸‹é¢å››ç‚¹<br>ï¼š</p><ol><li><code>?</code>åŒ¹é…1ä¸ªå­—ç¬¦ã€‚</li><li><code>*</code>åŒ¹é…0ä¸ªæˆ–è€…å¤šä¸ª<strong>å­—ç¬¦</strong>ã€‚</li><li><code>**</code>åŒ¹é…è·¯å¾„ä¸­0ä¸ªæˆ–è€…å¤šä¸ª<strong>ç›®å½•</strong>ã€‚</li><li>æ­£åˆ™æ”¯æŒï¼Œå¦‚<code>{spring:[a-z]+}</code>å°†æ­£åˆ™è¡¨è¾¾å¼[a-z]+åŒ¹é…åˆ°çš„å€¼ï¼Œèµ‹å€¼ç»™åä¸º<strong>spring</strong>çš„è·¯å¾„å˜é‡ã€‚</li></ol><p>ä¸¾äº›ä¾‹å­ï¼š</p><p><strong>â€™?'å½¢å¼çš„URL</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(value = <span class="string">"/pattern?"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">pattern</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/pattern  <span class="number">404</span> Not Found</span><br><span class="line">/patternd  <span class="number">200</span> OK</span><br><span class="line">/patterndd  <span class="number">404</span> Not Found</span><br><span class="line">/pattern/  <span class="number">404</span> Not Found</span><br><span class="line">/patternd/s  <span class="number">404</span> Not Found</span><br></pre></td></tr></table></figure><p><strong>â€™*'å½¢å¼çš„URL</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(value = <span class="string">"/pattern*"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">pattern</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/pattern  <span class="number">200</span> OK</span><br><span class="line">/pattern/  <span class="number">200</span> OK</span><br><span class="line">/patternd  <span class="number">200</span> OK</span><br><span class="line">/pattern/a  <span class="number">404</span> Not Found</span><br></pre></td></tr></table></figure><p><strong>â€™**'å½¢å¼çš„URL</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(value = <span class="string">"/pattern/**/p"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">pattern</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/pattern/p  <span class="number">200</span> OK</span><br><span class="line">/pattern/x/p  <span class="number">200</span> OK</span><br><span class="line">/pattern/x/y/p  <span class="number">200</span> OK</span><br></pre></td></tr></table></figure><p><strong>{spring:[a-z]+}å½¢å¼çš„URL</strong>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(value = <span class="string">"/pattern/&#123;key:[a-c]+&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">pattern</span><span class="params">(@PathVariable(name = <span class="string">"key"</span>)</span> String key) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">/pattern/a  <span class="number">200</span> OK</span><br><span class="line">/pattern/ab  <span class="number">200</span> OK</span><br><span class="line">/pattern/abc  <span class="number">200</span> OK</span><br><span class="line">/pattern  <span class="number">404</span> Not Found</span><br><span class="line">/pattern/abcd  <span class="number">404</span> Not Found</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„å››ç§URLæ¨¡å¼å¯ä»¥ç»„åˆä½¿ç”¨ï¼Œåƒå˜ä¸‡åŒ–ã€‚</p><p><code>URL</code>åŒ¹é…è¿˜éµå¾ª<strong>ç²¾ç¡®åŒ¹é…åŸåˆ™</strong>ï¼Œä¹Ÿå°±æ˜¯å­˜åœ¨ä¸¤ä¸ªæ¨¡å¼å¯¹åŒä¸€ä¸ª<code>URL</code>éƒ½èƒ½å¤ŸåŒ¹é…æˆåŠŸï¼Œåˆ™<strong>é€‰å–æœ€ç²¾ç¡®çš„<code>URL</code>åŒ¹é…</strong>ï¼Œè¿›å…¥å¯¹åº”çš„æ§åˆ¶å™¨æ–¹æ³•ï¼Œä¸¾ä¸ªä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@GetMapping</span>(value = <span class="string">"/pattern/**/p"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">pattern1</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping</span>(value = <span class="string">"/pattern/p"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">pattern2</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"success"</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢ä¸¤ä¸ªæ§åˆ¶å™¨ï¼Œå¦‚æœè¯·æ±‚<code>URL</code>ä¸º<code>/pattern/p</code>ï¼Œæœ€ç»ˆè¿›å…¥çš„æ–¹æ³•ä¸º<code>pattern2</code>ã€‚</p><p>æœ€åï¼Œ<code>org.springframework.util.AntPathMatcher</code>ä½œä¸ºä¸€ä¸ªå·¥å…·ç±»ï¼Œå¯ä»¥å•ç‹¬ä½¿ç”¨ï¼Œä¸ä»…ä»…å¯ä»¥ç”¨äºåŒ¹é…<code>URL</code>ï¼Œä¹Ÿå¯ä»¥ç”¨äºåŒ¹é…ç³»ç»Ÿæ–‡ä»¶è·¯å¾„ï¼Œä¸è¿‡éœ€è¦ä½¿ç”¨å…¶å¸¦å‚æ•°æ„é€ æ”¹å˜å†…éƒ¨çš„<code>pathSeparator</code>å˜é‡ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">AntPathMatcher antPathMatcher = <span class="keyword">new</span> AntPathMatcher(File.separator);</span><br></pre></td></tr></table></figure><h2 id="å°ç»“">å°ç»“</h2><p>ç¬”è€…åœ¨å‰ä¸€æ®µæ—¶é—´æ›¾ç»èŠ±å¤§é‡æ—¶é—´æ¢³ç†å’Œåˆ†æè¿‡<code>Spring</code>ã€<code>SpringMVC</code>çš„æºç ï¼Œä½†æ˜¯åé¢ä¸€æ®µå¾ˆé•¿çš„æ—¶é—´éœ€è¦è¿›è¡Œä¸šåŠ¡å¼€å‘ï¼Œå¯¹æ¶æ„æ–¹é¢çš„ä¸œè¥¿æœ‰ç‚¹ç”Ÿç–äº†ï¼Œæ¯•ç«Ÿä¸œè¥¿ä¸ç”¨å°±ä¼šç”Ÿç–ï¼Œè¿™ä¸ªæ˜¯å¸¸ç†ã€‚è¿™ç¯‡æ–‡ç« åŸºäºä¸€äº›<code>SpringMVC</code>çš„æºç ç»éªŒæ€»ç»“äº†è¯·æ±‚å‚æ•°çš„å¤„ç†ç›¸å…³çš„ä¸€äº›çŸ¥è¯†ï¼Œå¸Œæœ›å¸®åˆ°è‡ªå·±å’Œå¤§å®¶ã€‚</p><p>å‚è€ƒèµ„æ–™ï¼š</p><ul><li>spring-boot-web-starter:2.0.3.RELEASEæºç ã€‚</li></ul><p>ï¼ˆæœ¬æ–‡å®Œ c-7-d e-a-20180512 æ—§æ–‡é‡å‘ï¼‰</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰æ&quot;&gt;å‰æ&lt;/h2&gt;
&lt;p&gt;åœ¨æ—¥å¸¸ä½¿ç”¨&lt;code&gt;SpringMVC&lt;/code&gt;è¿›è¡Œå¼€å‘çš„æ—¶å€™ï¼Œæœ‰å¯èƒ½é‡åˆ°å‰ç«¯å„ç§ç±»å‹çš„è¯·æ±‚å‚æ•°ï¼Œè¿™é‡Œåšä¸€æ¬¡ç›¸å¯¹å…¨é¢çš„æ€»ç»“ã€‚&lt;code&gt;SpringMVC&lt;/code&gt;ä¸­å¤„ç†æ§åˆ¶å™¨å‚æ•°çš„æ¥å£æ˜¯&lt;code&gt;HandlerMethodArgumentResolver&lt;/code&gt;ï¼Œæ­¤æ¥å£æœ‰ä¼—å¤šå­ç±»ï¼Œåˆ†åˆ«å¤„ç†ä¸åŒ(æ³¨è§£ç±»å‹)çš„å‚æ•°ï¼Œä¸‹é¢åªåˆ—ä¸¾å‡ ä¸ªå­ç±»ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;RequestParamMethodArgumentResolver&lt;/code&gt;ï¼šè§£æå¤„ç†ä½¿ç”¨äº†&lt;code&gt;@RequestParam&lt;/code&gt;æ³¨è§£çš„å‚æ•°ã€&lt;code&gt;MultipartFile&lt;/code&gt;ç±»å‹å‚æ•°å’Œ&lt;code&gt;Simple&lt;/code&gt;ç±»å‹(å¦‚&lt;code&gt;long&lt;/code&gt;ã€&lt;code&gt;int&lt;/code&gt;ç­‰ç±»å‹)å‚æ•°ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;RequestResponseBodyMethodProcessor&lt;/code&gt;ï¼šè§£æå¤„ç†&lt;code&gt;@RequestBody&lt;/code&gt;æ³¨è§£çš„å‚æ•°ã€‚&lt;/li&gt;
&lt;li&gt;&lt;code&gt;PathVariableMapMethodArgumentResolver&lt;/code&gt;ï¼šè§£æå¤„ç†&lt;code&gt;@PathVariable&lt;/code&gt;æ³¨è§£çš„å‚æ•°ã€‚&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
    
      <category term="Spring" scheme="http://throwable.club/blog/categories/Spring/"/>
    
      <category term="SpringMVC" scheme="http://throwable.club/blog/categories/Spring/SpringMVC/"/>
    
    
      <category term="Spring" scheme="http://throwable.club/blog/tags/Spring/"/>
    
      <category term="SpringMVC" scheme="http://throwable.club/blog/tags/SpringMVC/"/>
    
  </entry>
  
  <entry>
    <title>SpringMVCè¯·æ±‚å‚æ•°å’Œå“åº”ç»“æœå…¨å±€åŠ å¯†å’Œè§£å¯†</title>
    <link href="http://throwable.club/2019/11/29/spring-mvc-param-global-encryption-decryption-in-action/"/>
    <id>http://throwable.club/2019/11/29/spring-mvc-param-global-encryption-decryption-in-action/</id>
    <published>2019-11-28T16:57:38.000Z</published>
    <updated>2019-11-28T16:59:32.793Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰æ">å‰æ</h2><p>å‰æ®µæ—¶é—´åœ¨åšä¸€ä¸ªå¯¹å¤–çš„ç½‘å…³é¡¹ç›®ï¼Œæ¶‰åŠåˆ°åŠ å¯†å’Œè§£å¯†æ¨¡å—ï¼Œè¿™é‡Œè¯¦ç»†åˆ†æè§£å†³æ–¹æ¡ˆå’Œé€‚ç”¨çš„åœºæ™¯ã€‚ä¸ºäº†æ¨¡æ‹ŸçœŸå®çš„äº¤äº’åœºæ™¯ï¼Œå…ˆå®šåˆ¶ä¸€ä¸‹æ•´ä¸ªäº¤äº’æµç¨‹ã€‚ç¬¬ä¸‰æ–¹ä¼ è¾“(åŒ…æ‹¬è¯·æ±‚å’Œå“åº”)æ•°æ®æŠ¥æ–‡åŒ…æ‹¬ä¸‰ä¸ªéƒ¨åˆ†ï¼š</p><ul><li>1ã€timestampï¼Œlongç±»å‹ï¼Œæ—¶é—´æˆ³ã€‚</li><li>2ã€dataï¼ŒStringç±»å‹ï¼Œå®é™…çš„ä¸šåŠ¡è¯·æ±‚æ•°æ®è½¬åŒ–æˆçš„Jsonå­—ç¬¦ä¸²å†è¿›è¡ŒåŠ å¯†å¾—åˆ°çš„å¯†æ–‡ã€‚</li><li>3ã€signï¼Œç­¾åï¼Œç”Ÿæˆè§„åˆ™ç®—æ³•ä¼ªä»£ç æ˜¯SHA-256(data=xxx&amp;timestamp=11111)ï¼Œé˜²ç¯¡æ”¹ã€‚</li></ul><p>ä¸ºäº†ç®€å•èµ·è§ï¼ŒåŠ å¯†å’Œè§£å¯†é‡‡ç”¨AESï¼Œå¯¹ç§°ç§˜é’¥ä¸º&quot;throwable&quot;ã€‚ä¸Šé¢çš„åœºæ™¯å’ŒåŠ è§£å¯†ä¾‹å­ä»…ä»…æ˜¯ä¸ºäº†æ¨¡æ‹ŸçœŸå®åœºæ™¯ï¼Œå®‰å…¨ç³»æ•°ä½ï¼Œåˆ‡å‹¿ç›´æ¥ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚</p><a id="more"></a><p>ç°åœ¨è¿˜æœ‰ä¸€ä¸ªåœ°æ–¹è¦è€ƒè™‘ï¼Œå°±æ˜¯æ— æ³•å¾—çŸ¥ç¬¬ä¸‰æ–¹å¦‚ä½•æäº¤è¯·æ±‚æ•°æ®ï¼Œå‡å®šéƒ½æ˜¯é‡‡ç”¨POSTçš„Httpè¯·æ±‚æ–¹æ³•ï¼Œæäº¤æŠ¥æ–‡çš„æ—¶å€™æŒ‡å®šContentTypeä¸ºapplication/jsonæˆ–è€…application/x-www-form-urlencodedï¼Œä¸¤ç§ContentTypeæäº¤æ–¹å¼çš„è¯·æ±‚ä½“æ˜¯ä¸ç›¸åŒçš„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//application/x-www-form-urlencoded</span></span><br><span class="line">timestamp=xxxx&amp;data=yyyyyy&amp;sign=zzzzzzz</span><br><span class="line"></span><br><span class="line"><span class="comment">//application/json</span></span><br><span class="line">&#123;<span class="string">"timestamp"</span>:xxxxxx,<span class="string">"data"</span>:<span class="string">"yyyyyyyy"</span>,<span class="string">"sign"</span>:<span class="string">"zzzzzzz"</span>&#125;</span><br></pre></td></tr></table></figure><p>æœ€åä¸€ä¸ªè¦è€ƒè™‘çš„åœ°æ–¹æ˜¯ï¼Œç¬¬ä¸‰æ–¹å¼ºåˆ¶è¦æ±‚éƒ¨åˆ†æ¥å£éœ€è¦ç”¨æ˜æ–‡è¿›è¡Œè¯·æ±‚ï¼Œåœ¨æä¾›ä¸€äº›æ¥å£æ–¹æ³•çš„æ—¶å€™ï¼Œå…è®¸ä½¿ç”¨æ˜æ–‡äº¤äº’ã€‚æ€»ç»“ä¸€ä¸‹å°±æ˜¯è¦åšåˆ°ä»¥ä¸‹ä¸‰ç‚¹ï¼š</p><ul><li>1ã€éœ€è¦åŠ è§£å¯†çš„æ¥å£è¯·æ±‚å‚æ•°è¦è¿›è¡Œè§£å¯†ï¼Œå“åº”ç»“æœè¦è¿›è¡ŒåŠ å¯†ã€‚</li><li>2ã€ä¸éœ€è¦åŠ è§£å¯†çš„æ¥å£å¯ä»¥ç”¨æ˜æ–‡è¯·æ±‚ã€‚</li><li>3ã€å…¼å®¹ContentTypeä¸ºapplication/jsonæˆ–è€…application/x-www-form-urlencodedä¸¤ç§æ–¹å¼ã€‚</li></ul><p>ä¸Šé¢ä¸‰ç§æƒ…å†µè¦åŒæ—¶å…¼å®¹ç®—æ˜¯ååˆ†ä¸¥è‹›çš„åœºæ™¯ï¼Œåœ¨ç”Ÿäº§ç¯å¢ƒä¸­å¯èƒ½ä¹Ÿæ˜¯æå°‘æƒ…å†µä¸‹æ‰é‡åˆ°ï¼Œä¸è¿‡è¿˜æ˜¯èƒ½æ‰¾åˆ°ç›¸å¯¹ä¼˜é›…çš„è§£å†³æ–¹æ¡ˆã€‚å…ˆå®šä¹‰ä¸¤ä¸ªç‰¹å®šåœºæ™¯çš„æ¥å£ï¼š</p><p>1ã€ä¸‹å•æ¥å£(åŠ å¯†)</p><ul><li>URLï¼š/order/save</li><li>HTTP METHODï¼šPOST</li><li>ContentTypeï¼šapplication/x-www-form-urlencoded</li><li>åŸå§‹å‚æ•°ï¼šorderId=yyyyyyyyy&amp;userId=xxxxxxxxx&amp;amount=zzzzzzzzz</li><li>åŠ å¯†å‚æ•°ï¼štimestamp=xxxx&amp;data=yyyyyy&amp;sign=zzzzzzz</li></ul><p>2ã€è®¢å•æŸ¥è¯¢æ¥å£(æ˜æ–‡)</p><ul><li>URLï¼š/order/query</li><li>ContentTypeï¼šapplication/json</li><li>HTTP METHODï¼šPOST</li><li>åŸå§‹å‚æ•°ï¼š{â€œuserIdâ€:â€œxxxxxxxxâ€}</li></ul><p>ä¸¤ä¸ªæ¥å£çš„<code>ContentType</code>ä¸ç›¸åŒæ˜¯ä¸ºäº†æ•…æ„å¤æ‚åŒ–åœºæ™¯ï¼Œåœ¨ä¸‹é¢çš„å¯å–æ–¹æ¡ˆä¸­ï¼Œåšæ³•æ˜¯æŠŠ<code>application/x-www-form-urlencoded</code>ä¸­çš„å½¢å¼å¦‚xxx=yyy&amp;aaa=bbbçš„è¡¨å•å‚æ•°å’Œ<code>application/json</code>ä¸­å½¢å¼å¦‚{â€œkeyâ€:â€œvalueâ€}çš„è¯·æ±‚å‚æ•°ç»Ÿä¸€å½“åš<code>application/json</code>å½¢å¼çš„å‚æ•°å¤„ç†ï¼Œè¿™æ ·çš„è¯ï¼Œæˆ‘ä»¬å°±å¯ä»¥ç›´æ¥åœ¨æ§åˆ¶å™¨æ–¹æ³•ä¸­ä½¿ç”¨<code>@RequestBody</code>ã€‚</p><h2 id="æ–¹æ¡ˆ">æ–¹æ¡ˆ</h2><p>æˆ‘ä»¬é¦–å…ˆåŸºäºä¸Šé¢è¯´åˆ°çš„åŠ è§£å¯†æ–¹æ¡ˆï¼Œæä¾›ä¸€ä¸ªåŠ è§£å¯†å·¥å…·ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> EncryptUtils &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * SINGLETON</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">SINGLETON;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String SECRET = <span class="string">"throwable"</span>;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String CHARSET = <span class="string">"UTF-8"</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">sha</span><span class="params">(String raw)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">MessageDigest messageDigest = MessageDigest.getInstance(<span class="string">"SHA-256"</span>);</span><br><span class="line">messageDigest.update(raw.getBytes(CHARSET));</span><br><span class="line"><span class="keyword">return</span> Hex.encodeHexString(messageDigest.digest());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> Cipher <span class="title">createAesCipher</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"><span class="keyword">return</span> Cipher.getInstance(<span class="string">"AES"</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">encryptByAes</span><span class="params">(String raw)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">Cipher aesCipher = createAesCipher();</span><br><span class="line">KeyGenerator keyGenerator = KeyGenerator.getInstance(<span class="string">"AES"</span>);</span><br><span class="line">keyGenerator.init(<span class="number">128</span>, <span class="keyword">new</span> SecureRandom(SECRET.getBytes(CHARSET)));</span><br><span class="line">SecretKey secretKey = keyGenerator.generateKey();</span><br><span class="line">SecretKeySpec secretKeySpec = <span class="keyword">new</span> SecretKeySpec(secretKey.getEncoded(), <span class="string">"AES"</span>);</span><br><span class="line">aesCipher.init(Cipher.ENCRYPT_MODE, secretKeySpec);</span><br><span class="line"><span class="keyword">byte</span>[] bytes = aesCipher.doFinal(raw.getBytes(CHARSET));</span><br><span class="line"><span class="keyword">return</span> Hex.encodeHexString(bytes);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">decryptByAes</span><span class="params">(String raw)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"><span class="keyword">byte</span>[] bytes = Hex.decodeHex(raw);</span><br><span class="line">Cipher aesCipher = createAesCipher();</span><br><span class="line">KeyGenerator keyGenerator = KeyGenerator.getInstance(<span class="string">"AES"</span>);</span><br><span class="line">keyGenerator.init(<span class="number">128</span>, <span class="keyword">new</span> SecureRandom(SECRET.getBytes(CHARSET)));</span><br><span class="line">SecretKey secretKey = keyGenerator.generateKey();</span><br><span class="line">SecretKeySpec secretKeySpec = <span class="keyword">new</span> SecretKeySpec(secretKey.getEncoded(), <span class="string">"AES"</span>);</span><br><span class="line">aesCipher.init(Cipher.DECRYPT_MODE, secretKeySpec);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> String(aesCipher.doFinal(bytes), CHARSET);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„ä¸ºäº†ç®€åŒ–åŠ è§£å¯†æ“ä½œå¼•å…¥äº†apacheçš„codecä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-codec<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-codec<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.11<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„åŠ è§£å¯†è¿‡ç¨‹ä¸­è¦æ³¨æ„ä¸¤ç‚¹ï¼š</p><ul><li>1ã€åŠ å¯†åçš„ç»“æœæ˜¯byteæ•°ç»„ï¼Œè¦æŠŠäºŒè¿›åˆ¶è½¬åŒ–ä¸ºåå…­è¿›åˆ¶å­—ç¬¦ä¸²ã€‚</li><li>2ã€è§£å¯†çš„æ—¶å€™è¦æŠŠåŸå§‹å¯†æ–‡ç”±åå…­è¿›åˆ¶è½¬åŒ–ä¸ºäºŒè¿›åˆ¶çš„byteæ•°ç»„ã€‚</li></ul><p>ä¸Šé¢ä¸¤ç‚¹å¿…é¡»æ³¨æ„ï¼Œå¦åˆ™ä¼šäº§ç”Ÿä¹±ç ï¼Œè¿™ä¸ªå’Œç¼–ç ç›¸å…³ï¼Œå…·ä½“å¯ä»¥çœ‹ä¹‹å‰å†™çš„ä¸€ç¯‡åšå®¢ã€‚</p><h2 id="ä¸æ¨èçš„æ–¹æ¡ˆ">ä¸æ¨èçš„æ–¹æ¡ˆ</h2><p>å…¶å®æœ€æš´åŠ›çš„æ–¹æ¡ˆæ˜¯ç›´æ¥å®šåˆ¶æ¯ä¸ªæ§åˆ¶å™¨çš„æ–¹æ³•å‚æ•°ç±»å‹ï¼Œå› ä¸ºæˆ‘ä»¬å¯ä»¥å’Œç¬¬ä¸‰æ–¹ç£‹å•†å“ªäº›è¯·æ±‚è·¯å¾„éœ€è¦åŠ å¯†ï¼Œå“ªäº›æ˜¯ä¸éœ€è¦åŠ å¯†ï¼Œç”šè‡³å“ªäº›æ˜¯<code>application/x-www-form-urlencoded</code>ï¼Œå“ªäº›æ˜¯<code>application/json</code>çš„è¯·æ±‚ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥é€šè¿‡å¤§é‡çš„ç¡¬ç¼–ç è¾¾åˆ°æœ€ç»ˆçš„ç›®æ ‡ã€‚ä¸¾ä¸ªä¾‹å­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Controller1</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> ObjectMapper objectMapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@PostMapping</span>(value = <span class="string">"/order/save"</span>,</span><br><span class="line">consumes = MediaType.APPLICATION_FORM_URLENCODED_VALUE,</span><br><span class="line">produces = MediaType.APPLICATION_JSON_UTF8_VALUE)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ResponseEntity&lt;EncryptModel&gt; <span class="title">saveOrder</span><span class="params">(@RequestParam(name = <span class="string">"sign"</span>)</span> String sign,</span></span><br><span class="line"><span class="function">  @<span class="title">RequestParam</span><span class="params">(name = <span class="string">"timestamp"</span>)</span> Long timestamp,</span></span><br><span class="line"><span class="function">  @<span class="title">RequestParam</span><span class="params">(name = <span class="string">"data"</span>)</span> String data) <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">EncryptModel model = <span class="keyword">new</span> EncryptModel();</span><br><span class="line">model.setData(data);</span><br><span class="line">model.setTimestamp(timestamp);</span><br><span class="line">model.setSign(sign);</span><br><span class="line">String inRawSign = String.format(<span class="string">"data=%s&amp;timestamp=%d"</span>, model.getData(), model.getTimestamp());</span><br><span class="line">String inSign = EncryptUtils.SINGLETON.sha(inRawSign);</span><br><span class="line"><span class="keyword">if</span> (!inSign.equals(model.getSign()))&#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"éªŒè¯å‚æ•°ç­¾åå¤±è´¥!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//è¿™é‡Œå¿½ç•¥å®é™…çš„ä¸šåŠ¡é€»è¾‘,ç®€å•è®¾ç½®è¿”å›çš„dataä¸ºä¸€ä¸ªmap</span></span><br><span class="line">Map&lt;String, Object&gt; result = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">8</span>);</span><br><span class="line">result.put(<span class="string">"code"</span>, <span class="string">"200"</span>);</span><br><span class="line">result.put(<span class="string">"message"</span>, <span class="string">"success"</span>);</span><br><span class="line">EncryptModel out = <span class="keyword">new</span> EncryptModel();</span><br><span class="line">out.setTimestamp(System.currentTimeMillis());</span><br><span class="line">out.setData(EncryptUtils.SINGLETON.encryptByAes(objectMapper.writeValueAsString(result)));</span><br><span class="line">String rawSign = String.format(<span class="string">"data=%s&amp;timestamp=%d"</span>, out.getData(), out.getTimestamp());</span><br><span class="line">out.setSign(EncryptUtils.SINGLETON.sha(rawSign));</span><br><span class="line"><span class="keyword">return</span> ResponseEntity.ok(out);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@PostMapping</span>(value = <span class="string">"/order/query"</span>,</span><br><span class="line">consumes = MediaType.APPLICATION_JSON_VALUE,</span><br><span class="line">produces = MediaType.APPLICATION_JSON_UTF8_VALUE)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ResponseEntity&lt;Order&gt;  <span class="title">queryOrder</span><span class="params">(@RequestBody User user)</span></span>&#123;</span><br><span class="line">Order order = <span class="keyword">new</span> Order();</span><br><span class="line"><span class="comment">//è¿™é‡Œå¿½ç•¥å®é™…çš„ä¸šåŠ¡é€»è¾‘</span></span><br><span class="line"><span class="keyword">return</span> ResponseEntity.ok(order);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ç§åšæ³•èƒ½åœ¨çŸ­æ—¶é—´å®Œæˆå¯¹åº”çš„åŠ è§£å¯†åŠŸèƒ½ï¼Œä¸éœ€è¦åŠ è§£å¯†çš„æ¥å£ä¸ç”¨å¼•å…¥ç›¸å…³çš„ä»£ç å³å¯ã€‚ç¼ºé™·ååˆ†æ˜æ˜¾ï¼Œå­˜åœ¨ç¡¬ç¼–ç ã€ä»£ç å†—ä½™ç­‰é—®é¢˜ï¼Œä¸€æ—¦æ¥å£å¢å¤šï¼Œé¡¹ç›®çš„ç»´æŠ¤éš¾åº¦å¤§å¤§æé«˜ã€‚å› æ­¤ï¼Œè¿™ç§åšæ³•æ˜¯ä¸å¯å–çš„ã€‚</p><h2 id="æ··åˆæ–¹æ¡ˆä¹‹Filterå’ŒSpringMVCçš„Httpæ¶ˆæ¯è½¬æ¢å™¨">æ··åˆæ–¹æ¡ˆä¹‹Filterå’ŒSpringMVCçš„Httpæ¶ˆæ¯è½¬æ¢å™¨</h2><p>è¿™é‡Œå…ˆè¯´ä¸€ç‚¹ï¼Œè¿™é‡Œæ˜¯åœ¨<code>SpringMVC</code>ä¸­ä½¿ç”¨<code>Filter</code>ã€‚å› ä¸ºè¦å…¼å®¹ä¸¤ç§<code>contentType</code>ï¼Œæˆ‘ä»¬éœ€è¦åšåˆ°å‡ ç‚¹ï¼š</p><ul><li>1ã€ä¿®æ”¹è¯·æ±‚å¤´çš„ContentTypeä¸ºapplication/jsonã€‚</li><li>2ã€ä¿®æ”¹è¯·æ±‚ä½“ä¸­çš„å‚æ•°ï¼Œç»Ÿä¸€è½¬åŒ–ä¸ºInputStreamã€‚</li><li>3ã€å®šåˆ¶URLè§„åˆ™ï¼ŒåŒºåˆ«éœ€è¦åŠ è§£å¯†å’Œä¸éœ€è¦åŠ è§£å¯†çš„URLã€‚</li></ul><p>ä½¿ç”¨<code>Filter</code>æœ‰ä¸€ä¸ªä¼˜ç‚¹ï¼šä¸éœ€è¦ç†è§£<code>SpringMVC</code>çš„æµç¨‹ï¼Œä¹Ÿä¸éœ€è¦æ‰©å±•<code>SpringMVC</code>çš„ç›¸å…³ç»„ä»¶ã€‚ç¼ºç‚¹ä¹Ÿæ¯”è¾ƒæ˜æ˜¾ï¼š</p><ul><li>1ã€å¦‚æœéœ€è¦åŒºåˆ†åŠ è§£å¯†ï¼Œåªèƒ½é€šè¿‡URLè§„åˆ™è¿›è¡Œè¿‡æ»¤ã€‚</li><li>2ã€éœ€è¦åŠ å¯†çš„æ¥å£çš„SpringMVCæ§åˆ¶å™¨çš„è¿”å›å‚æ•°å¿…é¡»æ˜¯åŠ å¯†åçš„å®ä½“ç±»ï¼Œæ— æ³•åšåˆ°åŠ å¯†é€»è¾‘å’Œä¸šåŠ¡é€»è¾‘å®Œå…¨æ‹†åˆ†ï¼Œä¹Ÿå°±æ˜¯è§£å¯†é€»è¾‘å¯¹æ¥æ”¶çš„å‚æ•°æ˜¯æ— æ„ŸçŸ¥ï¼Œä½†æ˜¯åŠ å¯†é€»è¾‘å¯¹è¿”å›ç»“æœæ˜¯æœ‰æ„ŸçŸ¥çš„ã€‚</li></ul><p>PSï¼šä¸Šé¢æåˆ°çš„å‡ ä¸ªéœ€è¦ä¿®æ”¹è¯·æ±‚å‚æ•°ã€è¯·æ±‚å¤´ç­‰æ˜¯å› ä¸ºç‰¹æ®Šåœºæ™¯çš„å®šåˆ¶ï¼Œæ‰€ä»¥å¦‚æœæ— æ­¤åœºæ™¯å¯ä»¥ç›´æ¥çœ‹ä¸‹é¢çš„&quot;å•çº¯çš„Jsonè¯·æ±‚å‚æ•°å’ŒJsonå“åº”ç»“æœ&quot;å°èŠ‚ã€‚æµç¨‹å¤§è‡´å¦‚ä¸‹ï¼š</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201911/sp-ed-1.png" alt="sp-ed-1"></p><p>ç¼–å†™<code>Filter</code>çš„å®ç°å’Œ<code>HttpServletRequestWrapper</code>çš„å®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//CustomEncryptFilter</span></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomEncryptFilter</span> <span class="keyword">extends</span> <span class="title">OncePerRequestFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ObjectMapper objectMapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doFilterInternal</span><span class="params">(HttpServletRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">HttpServletResponse response,</span></span></span><br><span class="line"><span class="function"><span class="params">FilterChain filterChain)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line"><span class="comment">//Content-Type</span></span><br><span class="line">String contentType = request.getContentType();</span><br><span class="line">String requestBody = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">boolean</span> shouldEncrypt = <span class="keyword">false</span>;</span><br><span class="line"><span class="keyword">if</span> (StringUtils.substringMatch(contentType, <span class="number">0</span>, MediaType.APPLICATION_FORM_URLENCODED_VALUE)) &#123;</span><br><span class="line">shouldEncrypt = <span class="keyword">true</span>;</span><br><span class="line">requestBody = convertFormToString(request);</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (StringUtils.substringMatch(contentType, <span class="number">0</span>, MediaType.APPLICATION_JSON_VALUE)) &#123;</span><br><span class="line">shouldEncrypt = <span class="keyword">true</span>;</span><br><span class="line">requestBody = convertInputStreamToString(request.getInputStream());</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!shouldEncrypt) &#123;</span><br><span class="line">filterChain.doFilter(request, response);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">CustomEncryptHttpWrapper wrapper = <span class="keyword">new</span> CustomEncryptHttpWrapper(request, requestBody);</span><br><span class="line">wrapper.putHeader(<span class="string">"Content-Type"</span>, MediaType.APPLICATION_PROBLEM_JSON_UTF8_VALUE);</span><br><span class="line">filterChain.doFilter(wrapper, response);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">convertFormToString</span><span class="params">(HttpServletRequest request)</span> </span>&#123;</span><br><span class="line">Map&lt;String, String&gt; result = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">8</span>);</span><br><span class="line">Enumeration&lt;String&gt; parameterNames = request.getParameterNames();</span><br><span class="line"><span class="keyword">while</span> (parameterNames.hasMoreElements()) &#123;</span><br><span class="line">String name = parameterNames.nextElement();</span><br><span class="line">result.put(name, request.getParameter(name));</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="keyword">return</span> objectMapper.writeValueAsString(result);</span><br><span class="line">&#125; <span class="keyword">catch</span> (JsonProcessingException e) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(e);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> String <span class="title">convertInputStreamToString</span><span class="params">(InputStream inputStream)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"><span class="keyword">return</span> StreamUtils.copyToString(inputStream, Charset.forName(<span class="string">"UTF-8"</span>));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//CustomEncryptHttpWrapper</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomEncryptHttpWrapper</span> <span class="keyword">extends</span> <span class="title">HttpServletRequestWrapper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;String, String&gt; headers = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">8</span>);</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] data;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">CustomEncryptHttpWrapper</span><span class="params">(HttpServletRequest request, String content)</span> </span>&#123;</span><br><span class="line"><span class="keyword">super</span>(request);</span><br><span class="line">data = content.getBytes(Charset.forName(<span class="string">"UTF-8"</span>));</span><br><span class="line">Enumeration&lt;String&gt; headerNames = request.getHeaderNames();</span><br><span class="line"><span class="keyword">while</span> (headerNames.hasMoreElements()) &#123;</span><br><span class="line">String key = headerNames.nextElement();</span><br><span class="line">headers.put(key, request.getHeader(key));</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">putHeader</span><span class="params">(String key, String value)</span> </span>&#123;</span><br><span class="line">headers.put(key, value);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getHeader</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> headers.get(name);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Enumeration&lt;String&gt; <span class="title">getHeaders</span><span class="params">(String name)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> Collections.enumeration(Collections.singletonList(headers.get(name)));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Enumeration&lt;String&gt; <span class="title">getHeaderNames</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span>  Collections.enumeration(headers.keySet());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> ServletInputStream <span class="title">getInputStream</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">ByteArrayInputStream inputStream = <span class="keyword">new</span> ByteArrayInputStream(data);</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> ServletInputStream() &#123;</span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isFinished</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> !isReady();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">isReady</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> inputStream.available() &gt; <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setReadListener</span><span class="params">(ReadListener listener)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">read</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"><span class="keyword">return</span> inputStream.read();</span><br><span class="line">&#125;</span><br><span class="line">&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> BufferedReader <span class="title">getReader</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">super</span>.getReader();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//CustomEncryptConfiguration</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomEncryptConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Bean</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> FilterRegistrationBean&lt;CustomEncryptFilter&gt; <span class="title">customEncryptFilter</span><span class="params">(ObjectMapper objectMapper)</span></span>&#123;</span><br><span class="line">FilterRegistrationBean&lt;CustomEncryptFilter&gt; bean = <span class="keyword">new</span> FilterRegistrationBean&lt;&gt;(<span class="keyword">new</span> CustomEncryptFilter(objectMapper));</span><br><span class="line">bean.addUrlPatterns(<span class="string">"/e/*"</span>);</span><br><span class="line"><span class="keyword">return</span> bean;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ§åˆ¶å™¨ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//å¯åŠ å¯†çš„ï¼Œç©ºæ¥å£ï¼Œç”¨äºæ ‡è¯†è§£å¯†çš„æ¨¡å‹å¯¹è±¡</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Encryptable</span> </span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Order</span> <span class="keyword">implements</span> <span class="title">Encryptable</span></span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Long userId;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EncryptResponse</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Encryptable</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Integer code;</span><br><span class="line"><span class="keyword">private</span> T data;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Controller</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ObjectMapper objectMapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@PostMapping</span>(value = <span class="string">"/e/order/save"</span>,</span><br><span class="line">consumes = MediaType.APPLICATION_JSON_VALUE,</span><br><span class="line">produces = MediaType.APPLICATION_JSON_UTF8_VALUE)</span><br><span class="line"><span class="function"><span class="keyword">public</span> EncryptResponse&lt;Order&gt; <span class="title">saveOrder</span><span class="params">(@RequestBody Order order)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"><span class="comment">//è¿™é‡Œå¿½ç•¥å®é™…çš„ä¸šåŠ¡é€»è¾‘,ç®€å•è®¾ç½®è¿”å›çš„dataä¸ºä¸€ä¸ªmap</span></span><br><span class="line">EncryptResponse&lt;Order&gt; response = <span class="keyword">new</span> EncryptResponse&lt;&gt;();</span><br><span class="line">response.setCode(<span class="number">200</span>);</span><br><span class="line">response.setData(order);</span><br><span class="line"><span class="keyword">return</span> response;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@PostMapping</span>(value = <span class="string">"/c/order/query"</span>,</span><br><span class="line">consumes = MediaType.APPLICATION_JSON_VALUE,</span><br><span class="line">produces = MediaType.APPLICATION_JSON_UTF8_VALUE)</span><br><span class="line"><span class="function"><span class="keyword">public</span> ResponseEntity&lt;Order&gt; <span class="title">queryOrder</span><span class="params">(@RequestBody User user)</span> </span>&#123;</span><br><span class="line">Order order = <span class="keyword">new</span> Order();</span><br><span class="line"><span class="comment">//è¿™é‡Œå¿½ç•¥å®é™…çš„ä¸šåŠ¡é€»è¾‘</span></span><br><span class="line"><span class="keyword">return</span> ResponseEntity.ok(order);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯èƒ½æœ‰äººæœ‰ç–‘é—®ï¼Œä¸ºä»€ä¹ˆä¸åœ¨<code>Filter</code>åšåŠ è§£å¯†çš„æ“ä½œï¼Ÿå› ä¸ºè€ƒè™‘åˆ°åœºæ™¯å¤ªç‰¹æ®Šï¼Œè¦å…¼å®¹ä¸¤ç§å½¢å¼çš„è¡¨å•æäº¤å‚æ•°ï¼Œå¦‚æœåœ¨<code>Filter</code>åšåŠ è§£å¯†æ“ä½œï¼Œä¼šå½±å“åˆ°<code>Controller</code>çš„ç¼–ç ï¼Œè¿™å°±è¿åäº†å…¨å±€åŠ è§£å¯†ä¸å½±å“åˆ°é‡Œå±‚ä¸šåŠ¡ä»£ç çš„ç›®æ ‡ã€‚ä¸Šé¢çš„<code>Filter</code>åªä¼šæ‹¦æˆªURLæ»¡è¶³<code>/e/*</code>çš„è¯·æ±‚ï¼Œå› æ­¤æŸ¥è¯¢æ¥å£<code>/c/order/query</code>ä¸ä¼šå—åˆ°å½±å“ã€‚è¿™é‡Œä½¿ç”¨äº†æ ‡è¯†æ¥å£ç”¨äºå†³å®šè¯·æ±‚å‚æ•°æˆ–è€…å“åº”ç»“æœæ˜¯å¦éœ€è¦åŠ è§£å¯†ï¼Œä¹Ÿå°±æ˜¯åªéœ€è¦åœ¨<code>HttpMessageConverter</code>ä¸­åˆ¤æ–­è¯·æ±‚å‚æ•°çš„ç±»å‹æˆ–è€…å“åº”ç»“æœçš„ç±»å‹æ˜¯å¦åŠ è§£å¯†æ ‡è¯†æ¥å£çš„å­ç±»ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomEncryptHttpMessageConverter</span> <span class="keyword">extends</span> <span class="title">MappingJackson2HttpMessageConverter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ObjectMapper objectMapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">readInternal</span><span class="params">(Class&lt;?&gt; clazz, HttpInputMessage inputMessage)</span></span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> IOException, HttpMessageNotReadableException </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (Encryptable<span class="class">.<span class="keyword">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">clazz</span>)) </span>&#123;</span><br><span class="line">EncryptModel in = objectMapper.readValue(StreamUtils.copyToByteArray(inputMessage.getBody()), EncryptModel<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">String inRawSign = String.format(<span class="string">"data=%s&amp;timestamp=%d"</span>, in.getData(), in.getTimestamp());</span><br><span class="line">String inSign;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">inSign = EncryptUtils.SINGLETON.sha(inRawSign);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"éªŒè¯å‚æ•°ç­¾åå¤±è´¥!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!inSign.equals(in.getSign())) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"éªŒè¯å‚æ•°ç­¾åå¤±è´¥!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="keyword">return</span> objectMapper.readValue(EncryptUtils.SINGLETON.decryptByAes(in.getData()), clazz);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"è§£å¯†å¤±è´¥!"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">super</span>.readInternal(clazz, inputMessage);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">writeInternal</span><span class="params">(Object object, Type type, HttpOutputMessage outputMessage)</span></span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> IOException, HttpMessageNotWritableException </span>&#123;</span><br><span class="line">Class&lt;?&gt; clazz = (Class) type;</span><br><span class="line"><span class="keyword">if</span> (Encryptable<span class="class">.<span class="keyword">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">clazz</span>)) </span>&#123;</span><br><span class="line">EncryptModel out = <span class="keyword">new</span> EncryptModel();</span><br><span class="line">out.setTimestamp(System.currentTimeMillis());</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">out.setData(EncryptUtils.SINGLETON.encryptByAes(objectMapper.writeValueAsString(object)));</span><br><span class="line">String rawSign = String.format(<span class="string">"data=%s&amp;timestamp=%d"</span>, out.getData(), out.getTimestamp());</span><br><span class="line">out.setSign(EncryptUtils.SINGLETON.sha(rawSign));</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"å‚æ•°ç­¾åå¤±è´¥!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">super</span>.writeInternal(out, type, outputMessage);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">super</span>.writeInternal(object, type, outputMessage);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‡ªå®ç°çš„<code>HttpMessageConverter</code>ä¸»è¦éœ€è¦åˆ¤æ–­è¯·æ±‚å‚æ•°çš„ç±»å‹å’Œè¿”å›å€¼çš„ç±»å‹ï¼Œä»è€Œåˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡ŒåŠ è§£å¯†ã€‚</p><h2 id="å•çº¯çš„Jsonè¯·æ±‚å‚æ•°å’ŒJsonå“åº”ç»“æœçš„åŠ è§£å¯†å¤„ç†æœ€ä½³å®è·µ">å•çº¯çš„Jsonè¯·æ±‚å‚æ•°å’ŒJsonå“åº”ç»“æœçš„åŠ è§£å¯†å¤„ç†æœ€ä½³å®è·µ</h2><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¯¹æ¥æ–¹çš„è¯·æ±‚å‚æ•°å’Œå“åº”ç»“æœæ˜¯å®Œå…¨è§„èŒƒç»Ÿä¸€ä½¿ç”¨Json(ContentTypeæŒ‡å®šä¸º<code>application/json</code>ï¼Œä½¿ç”¨<code>@RequestBody</code>æ¥æ”¶å‚æ•°)ï¼Œé‚£ä¹ˆæ‰€æœ‰çš„äº‹æƒ…å°±ä¼šå˜å¾—ç®€å•ï¼Œå› ä¸ºä¸éœ€è¦è€ƒè™‘è¯·æ±‚å‚æ•°ç”±xxx=yyy&amp;aaa=bbbè½¬æ¢ä¸º<code>InputStream</code>å†äº¤ç»™<code>SpringMVC</code>å¤„ç†ï¼Œå› æ­¤æˆ‘ä»¬åªéœ€è¦æä¾›ä¸€ä¸ª<code>MappingJackson2HttpMessageConverter</code>å­ç±»å®ç°(ç»§æ‰¿å®ƒå¹¶ä¸”è¦†ç›–å¯¹åº”æ–¹æ³•ï¼Œæ·»åŠ åŠ è§£å¯†ç‰¹æ€§)ã€‚æˆ‘ä»¬è¿˜æ˜¯ä½¿ç”¨æ ‡è¯†æ¥å£ç”¨äºå†³å®šè¯·æ±‚å‚æ•°æˆ–è€…å“åº”ç»“æœæ˜¯å¦éœ€è¦åŠ è§£å¯†ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomEncryptHttpMessageConverter</span> <span class="keyword">extends</span> <span class="title">MappingJackson2HttpMessageConverter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ObjectMapper objectMapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Object <span class="title">readInternal</span><span class="params">(Class&lt;?&gt; clazz, HttpInputMessage inputMessage)</span></span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> IOException, HttpMessageNotReadableException </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (Encryptable<span class="class">.<span class="keyword">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">clazz</span>)) </span>&#123;</span><br><span class="line">EncryptModel in = objectMapper.readValue(StreamUtils.copyToByteArray(inputMessage.getBody()), EncryptModel<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">String inRawSign = String.format(<span class="string">"data=%s&amp;timestamp=%d"</span>, in.getData(), in.getTimestamp());</span><br><span class="line">String inSign;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">inSign = EncryptUtils.SINGLETON.sha(inRawSign);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"éªŒè¯å‚æ•°ç­¾åå¤±è´¥!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!inSign.equals(in.getSign())) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"éªŒè¯å‚æ•°ç­¾åå¤±è´¥!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="keyword">return</span> objectMapper.readValue(EncryptUtils.SINGLETON.decryptByAes(in.getData()), clazz);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"è§£å¯†å¤±è´¥!"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">super</span>.readInternal(clazz, inputMessage);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">writeInternal</span><span class="params">(Object object, Type type, HttpOutputMessage outputMessage)</span></span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> IOException, HttpMessageNotWritableException </span>&#123;</span><br><span class="line">Class&lt;?&gt; clazz = (Class) type;</span><br><span class="line"><span class="keyword">if</span> (Encryptable<span class="class">.<span class="keyword">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">clazz</span>)) </span>&#123;</span><br><span class="line">EncryptModel out = <span class="keyword">new</span> EncryptModel();</span><br><span class="line">out.setTimestamp(System.currentTimeMillis());</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">out.setData(EncryptUtils.SINGLETON.encryptByAes(objectMapper.writeValueAsString(object)));</span><br><span class="line">String rawSign = String.format(<span class="string">"data=%s&amp;timestamp=%d"</span>, out.getData(), out.getTimestamp());</span><br><span class="line">out.setSign(EncryptUtils.SINGLETON.sha(rawSign));</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"å‚æ•°ç­¾åå¤±è´¥!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">super</span>.writeInternal(out, type, outputMessage);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">super</span>.writeInternal(object, type, outputMessage);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ²¡é”™ï¼Œä»£ç æ˜¯æ‹·è´ä¸Šä¸€èŠ‚æä¾›çš„<code>HttpMessageConverter</code>å®ç°ï¼Œç„¶åæ§åˆ¶å™¨æ–¹æ³•çš„å‚æ•°ä½¿ç”¨<code>@RequestBody</code>æ³¨è§£å¹¶ä¸”ç±»å‹å®ç°åŠ è§£å¯†æ ‡è¯†æ¥å£<code>Encryptable</code>å³å¯ï¼Œè¿”å›å€¼çš„ç±»å‹ä¹Ÿéœ€è¦å®ç°åŠ è§£å¯†æ ‡è¯†æ¥å£<code>Encryptable</code>ã€‚è¿™ç§åšæ³•å¯ä»¥è®©æ§åˆ¶å™¨çš„ä»£ç å¯¹åŠ è§£å¯†å®Œå…¨æ— æ„ŸçŸ¥ã€‚å½“ç„¶ï¼Œä¹Ÿå¯ä»¥ä¸æ”¹å˜åŸæ¥çš„<code>MappingJackson2HttpMessageConverter</code>å®ç°ï¼Œä½¿ç”¨<code>RequestBodyAdvice</code>å’Œ<code>ResponseBodyAdvice</code>å®Œæˆç›¸åŒçš„åŠŸèƒ½ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomRequestBodyAdvice</span> <span class="keyword">extends</span> <span class="title">RequestBodyAdviceAdapter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ObjectMapper objectMapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(MethodParameter methodParameter, Type targetType,</span></span></span><br><span class="line"><span class="function"><span class="params">Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt; converterType)</span> </span>&#123;</span><br><span class="line">Class&lt;?&gt; clazz = (Class) targetType;</span><br><span class="line"><span class="keyword">return</span> Encryptable<span class="class">.<span class="keyword">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">clazz</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> HttpInputMessage <span class="title">beforeBodyRead</span><span class="params">(HttpInputMessage inputMessage, MethodParameter parameter, Type targetType,</span></span></span><br><span class="line"><span class="function"><span class="params">   Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt; converterType)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">Class&lt;?&gt; clazz = (Class) targetType;</span><br><span class="line"><span class="keyword">if</span> (Encryptable<span class="class">.<span class="keyword">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">clazz</span>)) </span>&#123;</span><br><span class="line">String content = StreamUtils.copyToString(inputMessage.getBody(), Charset.forName(<span class="string">"UTF-8"</span>));</span><br><span class="line">EncryptModel in = objectMapper.readValue(content, EncryptModel<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">String inRawSign = String.format(<span class="string">"data=%s&amp;timestamp=%d"</span>, in.getData(), in.getTimestamp());</span><br><span class="line">String inSign;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">inSign = EncryptUtils.SINGLETON.sha(inRawSign);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"éªŒè¯å‚æ•°ç­¾åå¤±è´¥!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!inSign.equals(in.getSign())) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"éªŒè¯å‚æ•°ç­¾åå¤±è´¥!"</span>);</span><br><span class="line">&#125;</span><br><span class="line">ByteArrayInputStream inputStream = <span class="keyword">new</span> ByteArrayInputStream(in.getData().getBytes(Charset.forName(<span class="string">"UTF-8"</span>)));</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">new</span> MappingJacksonInputMessage(inputStream, inputMessage.getHeaders());</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">super</span>.beforeBodyRead(inputMessage, parameter, targetType, converterType);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@RequiredArgsConstructor</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomResponseBodyAdvice</span> <span class="keyword">extends</span> <span class="title">JsonViewResponseBodyAdvice</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ObjectMapper objectMapper;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">supports</span><span class="params">(MethodParameter returnType, Class&lt;? extends HttpMessageConverter&lt;?&gt;&gt; converterType)</span> </span>&#123;</span><br><span class="line">Class&lt;?&gt; parameterType = returnType.getParameterType();</span><br><span class="line"><span class="keyword">return</span> Encryptable<span class="class">.<span class="keyword">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">parameterType</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">beforeBodyWriteInternal</span><span class="params">(MappingJacksonValue bodyContainer, MediaType contentType,</span></span></span><br><span class="line"><span class="function"><span class="params">   MethodParameter returnType, ServerHttpRequest request,</span></span></span><br><span class="line"><span class="function"><span class="params">   ServerHttpResponse response)</span> </span>&#123;</span><br><span class="line">Class&lt;?&gt; parameterType = returnType.getParameterType();</span><br><span class="line"><span class="keyword">if</span> (Encryptable<span class="class">.<span class="keyword">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">parameterType</span>)) </span>&#123;</span><br><span class="line">EncryptModel out = <span class="keyword">new</span> EncryptModel();</span><br><span class="line">out.setTimestamp(System.currentTimeMillis());</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">out.setData(EncryptUtils.SINGLETON.encryptByAes(objectMapper.writeValueAsString(bodyContainer.getValue())));</span><br><span class="line">String rawSign = String.format(<span class="string">"data=%s&amp;timestamp=%d"</span>, out.getData(), out.getTimestamp());</span><br><span class="line">out.setSign(EncryptUtils.SINGLETON.sha(rawSign));</span><br><span class="line">out.setSign(EncryptUtils.SINGLETON.sha(rawSign));</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"å‚æ•°ç­¾åå¤±è´¥!"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="keyword">super</span>.beforeBodyWriteInternal(bodyContainer, contentType, returnType, request, response);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å•çº¯çš„application-x-www-form-urlencodedè¡¨å•è¯·æ±‚å‚æ•°å’ŒJsonå“åº”ç»“æœçš„åŠ è§£å¯†å¤„ç†æœ€ä½³å®è·µ">å•çº¯çš„application/x-www-form-urlencodedè¡¨å•è¯·æ±‚å‚æ•°å’ŒJsonå“åº”ç»“æœçš„åŠ è§£å¯†å¤„ç†æœ€ä½³å®è·µ</h2><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œå¯¹æ¥æ–¹çš„è¯·æ±‚å‚æ•°å®Œå…¨é‡‡ç”¨<code>application/x-www-form-urlencoded</code>è¡¨å•è¯·æ±‚å‚æ•°è¿”å›ç»“æœå…¨éƒ¨æŒ‰ç…§Jsonæ¥æ”¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥é€šè¿‡ä¸€ä¸ª<code>HttpMessageConverter</code>å®ç°å°±å®ŒæˆåŠ è§£å¯†æ¨¡å—ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FormHttpMessageConverter</span> <span class="keyword">implements</span> <span class="title">HttpMessageConverter</span>&lt;<span class="title">Object</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;MediaType&gt; mediaTypes;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ObjectMapper objectMapper;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">FormHttpMessageConverter</span><span class="params">(ObjectMapper objectMapper)</span> </span>&#123;</span><br><span class="line"><span class="keyword">this</span>.objectMapper = objectMapper;</span><br><span class="line"><span class="keyword">this</span>.mediaTypes = <span class="keyword">new</span> ArrayList&lt;&gt;(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">this</span>.mediaTypes.add(MediaType.APPLICATION_FORM_URLENCODED);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">canRead</span><span class="params">(Class&lt;?&gt; clazz, MediaType mediaType)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> Encryptable<span class="class">.<span class="keyword">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">clazz</span>) &amp;&amp; <span class="title">mediaTypes</span>.<span class="title">contains</span>(<span class="title">mediaType</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">canWrite</span><span class="params">(Class&lt;?&gt; clazz, MediaType mediaType)</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> Encryptable<span class="class">.<span class="keyword">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">clazz</span>) &amp;&amp; <span class="title">mediaTypes</span>.<span class="title">contains</span>(<span class="title">mediaType</span>)</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;MediaType&gt; <span class="title">getSupportedMediaTypes</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">return</span> mediaTypes;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">read</span><span class="params">(Class&lt;?&gt; clazz, HttpInputMessage inputMessage)</span> <span class="keyword">throws</span></span></span><br><span class="line"><span class="function">IOException, HttpMessageNotReadableException </span>&#123;</span><br><span class="line"><span class="keyword">if</span> (Encryptable<span class="class">.<span class="keyword">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">clazz</span>)) </span>&#123;</span><br><span class="line">String content = StreamUtils.copyToString(inputMessage.getBody(), Charset.forName(<span class="string">"UTF-8"</span>));</span><br><span class="line">EncryptModel in = objectMapper.readValue(content, EncryptModel<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">String inRawSign = String.format(<span class="string">"data=%s&amp;timestamp=%d"</span>, in.getData(), in.getTimestamp());</span><br><span class="line">String inSign;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">inSign = EncryptUtils.SINGLETON.sha(inRawSign);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"éªŒè¯å‚æ•°ç­¾åå¤±è´¥!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (!inSign.equals(in.getSign())) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"éªŒè¯å‚æ•°ç­¾åå¤±è´¥!"</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line"><span class="keyword">return</span> objectMapper.readValue(EncryptUtils.SINGLETON.decryptByAes(in.getData()), clazz);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"è§£å¯†å¤±è´¥!"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">MediaType contentType = inputMessage.getHeaders().getContentType();</span><br><span class="line">Charset charset = (contentType != <span class="keyword">null</span> &amp;&amp; contentType.getCharset() != <span class="keyword">null</span> ?</span><br><span class="line">contentType.getCharset() : Charset.forName(<span class="string">"UTF-8"</span>));</span><br><span class="line">String body = StreamUtils.copyToString(inputMessage.getBody(), charset);</span><br><span class="line"></span><br><span class="line">String[] pairs = StringUtils.tokenizeToStringArray(body, <span class="string">"&amp;"</span>);</span><br><span class="line">MultiValueMap&lt;String, String&gt; result = <span class="keyword">new</span> LinkedMultiValueMap&lt;&gt;(pairs.length);</span><br><span class="line"><span class="keyword">for</span> (String pair : pairs) &#123;</span><br><span class="line"><span class="keyword">int</span> idx = pair.indexOf(<span class="string">'='</span>);</span><br><span class="line"><span class="keyword">if</span> (idx == -<span class="number">1</span>) &#123;</span><br><span class="line">result.add(URLDecoder.decode(pair, charset.name()), <span class="keyword">null</span>);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">String name = URLDecoder.decode(pair.substring(<span class="number">0</span>, idx), charset.name());</span><br><span class="line">String value = URLDecoder.decode(pair.substring(idx + <span class="number">1</span>), charset.name());</span><br><span class="line">result.add(name, value);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(Object o, MediaType contentType, HttpOutputMessage outputMessage)</span></span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> IOException, HttpMessageNotWritableException </span>&#123;</span><br><span class="line">Class&lt;?&gt; clazz = o.getClass();</span><br><span class="line"><span class="keyword">if</span> (Encryptable<span class="class">.<span class="keyword">class</span>.<span class="title">isAssignableFrom</span>(<span class="title">clazz</span>)) </span>&#123;</span><br><span class="line">EncryptModel out = <span class="keyword">new</span> EncryptModel();</span><br><span class="line">out.setTimestamp(System.currentTimeMillis());</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">out.setData(EncryptUtils.SINGLETON.encryptByAes(objectMapper.writeValueAsString(o)));</span><br><span class="line">String rawSign = String.format(<span class="string">"data=%s&amp;timestamp=%d"</span>, out.getData(), out.getTimestamp());</span><br><span class="line">out.setSign(EncryptUtils.SINGLETON.sha(rawSign));</span><br><span class="line">StreamUtils.copy(objectMapper.writeValueAsString(out)</span><br><span class="line">.getBytes(Charset.forName(<span class="string">"UTF-8"</span>)), outputMessage.getBody());</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line"><span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"å‚æ•°ç­¾åå¤±è´¥!"</span>);</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">String out = objectMapper.writeValueAsString(o);</span><br><span class="line">StreamUtils.copy(out.getBytes(Charset.forName(<span class="string">"UTF-8"</span>)), outputMessage.getBody());</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„<code>HttpMessageConverter</code>çš„å®ç°å¯ä»¥å‚è€ƒ<code>org.springframework.http.converter.FormHttpMessageConverter</code>ã€‚</p><h2 id="å°ç»“">å°ç»“</h2><p>è¿™ç¯‡æ–‡ç« å¼ºè¡Œå¤æ‚åŒ–äº†å®é™…çš„æƒ…å†µ(ä½†æ˜¯åœ¨å®é™…ä¸­çœŸçš„ç¢°åˆ°è¿‡)ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œç°åœ¨æµè¡Œä½¿ç”¨Jsonè¿›è¡Œæ•°æ®ä¼ è¾“ï¼Œåœ¨SpringMVCé¡¹ç›®ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦é’ˆå¯¹æ€§åœ°æ”¹é€ <code>MappingJackson2HttpMessageConverter</code>å³å¯(ç»§æ‰¿å¹¶ä¸”æ·»åŠ ç‰¹æ€§)ï¼Œå¦‚æœå¯¹<code>SpringMVC</code>çš„æºç ç›¸å¯¹ç†Ÿæ‚‰çš„è¯ï¼Œç›´æ¥æ·»åŠ è‡ªå®šä¹‰çš„<code>RequestBodyAdvice</code>(<code>RequestBodyAdviceAdapter</code>)å’Œ<code>ResponseBodyAdvice</code>(<code>JsonViewResponseBodyAdvice</code>)å®ç°ä¹Ÿå¯ä»¥è¾¾åˆ°ç›®çš„ã€‚è‡³äºä¸ºä»€ä¹ˆä½¿ç”¨<code>HttpMessageConverter</code>åšåŠ è§£å¯†åŠŸèƒ½ï¼Œè¿™é‡ŒåŸºäº<code>SpringMVC</code>æºç çš„å¯¹è¯·æ±‚å‚æ•°å¤„ç†çš„è¿‡ç¨‹æ•´ç†äº†ä¸€å¼ å¤„ç†æµç¨‹å›¾ï¼š</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201911/sp-ed-2.png" alt=""></p><p>ä¸Šé¢æµç¨‹æœ€æ ¸å¿ƒçš„ä»£ç å¯ä»¥çœ‹<code>AbstractMessageConverterMethodArgumentResolver#readWithMessageConverters</code>å’Œ<code>HandlerMethodArgumentResolverComposite#resolveArgument</code>ï¼Œæ¯•ç«Ÿæºç ä¸ä¼šéª—äººã€‚æ§åˆ¶å™¨æ–¹æ³•è¿”å›å€¼çš„å¤„ç†åŸºäºæ˜¯å¯¹ç§°çš„ï¼Œé˜…è¯»èµ·æ¥ä¹Ÿæ¯”è¾ƒè½»æ¾ã€‚</p><p>å‚è€ƒèµ„æ–™ï¼š</p><ul><li>spring-boot-web-starter:2.0.3.RELEASEæºç ã€‚</li></ul><p>ï¼ˆæœ¬æ–‡å®Œ c-d-4 e-a-2018-8-14 è€æ–‡é‡å‘ï¼‰</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰æ&quot;&gt;å‰æ&lt;/h2&gt;
&lt;p&gt;å‰æ®µæ—¶é—´åœ¨åšä¸€ä¸ªå¯¹å¤–çš„ç½‘å…³é¡¹ç›®ï¼Œæ¶‰åŠåˆ°åŠ å¯†å’Œè§£å¯†æ¨¡å—ï¼Œè¿™é‡Œè¯¦ç»†åˆ†æè§£å†³æ–¹æ¡ˆå’Œé€‚ç”¨çš„åœºæ™¯ã€‚ä¸ºäº†æ¨¡æ‹ŸçœŸå®çš„äº¤äº’åœºæ™¯ï¼Œå…ˆå®šåˆ¶ä¸€ä¸‹æ•´ä¸ªäº¤äº’æµç¨‹ã€‚ç¬¬ä¸‰æ–¹ä¼ è¾“(åŒ…æ‹¬è¯·æ±‚å’Œå“åº”)æ•°æ®æŠ¥æ–‡åŒ…æ‹¬ä¸‰ä¸ªéƒ¨åˆ†ï¼š&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;1ã€timestampï¼Œlongç±»å‹ï¼Œæ—¶é—´æˆ³ã€‚&lt;/li&gt;
&lt;li&gt;2ã€dataï¼ŒStringç±»å‹ï¼Œå®é™…çš„ä¸šåŠ¡è¯·æ±‚æ•°æ®è½¬åŒ–æˆçš„Jsonå­—ç¬¦ä¸²å†è¿›è¡ŒåŠ å¯†å¾—åˆ°çš„å¯†æ–‡ã€‚&lt;/li&gt;
&lt;li&gt;3ã€signï¼Œç­¾åï¼Œç”Ÿæˆè§„åˆ™ç®—æ³•ä¼ªä»£ç æ˜¯SHA-256(data=xxx&amp;amp;timestamp=11111)ï¼Œé˜²ç¯¡æ”¹ã€‚&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;ä¸ºäº†ç®€å•èµ·è§ï¼ŒåŠ å¯†å’Œè§£å¯†é‡‡ç”¨AESï¼Œå¯¹ç§°ç§˜é’¥ä¸º&amp;quot;throwable&amp;quot;ã€‚ä¸Šé¢çš„åœºæ™¯å’ŒåŠ è§£å¯†ä¾‹å­ä»…ä»…æ˜¯ä¸ºäº†æ¨¡æ‹ŸçœŸå®åœºæ™¯ï¼Œå®‰å…¨ç³»æ•°ä½ï¼Œåˆ‡å‹¿ç›´æ¥ç”¨äºç”Ÿäº§ç¯å¢ƒã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Spring" scheme="http://throwable.club/blog/categories/Spring/"/>
    
      <category term="SpringMVC" scheme="http://throwable.club/blog/categories/Spring/SpringMVC/"/>
    
    
      <category term="Spring" scheme="http://throwable.club/blog/tags/Spring/"/>
    
      <category term="SpringMVC" scheme="http://throwable.club/blog/tags/SpringMVC/"/>
    
  </entry>
  
  <entry>
    <title>åˆè¯†Redisçš„æ•°æ®ç±»å‹HyperLogLog</title>
    <link href="http://throwable.club/2019/11/17/redis-type-hll-introduction/"/>
    <id>http://throwable.club/2019/11/17/redis-type-hll-introduction/</id>
    <published>2019-11-17T05:10:16.000Z</published>
    <updated>2019-11-28T17:03:45.812Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰æ">å‰æ</h2><p>æœªæ¥ä¸€æ®µæ—¶é—´å¼€å‘çš„é¡¹ç›®æˆ–è€…éœ€æ±‚ä¼šå¤§é‡ä½¿ç”¨åˆ°<code>Redis</code>ï¼Œè¶ç€è¿™æ®µæ—¶é—´ä¸šåŠ¡å¹¶ä¸å¤ªç¹å¿™ï¼ŒæŠ½ç‚¹æ—¶é—´é¢„ä¹ å’Œå¤ä¹ <code>Redis</code>çš„ç›¸å…³å†…å®¹ã€‚åˆšå¥½çœ‹åˆ°åšå®¢ä¸‹é¢çš„<code>UV</code>å’Œ<code>PV</code>ç»Ÿè®¡ï¼Œæƒ³åˆ°äº†æœ€è¿‘çœ‹ä¹¦é‡Œé¢æåˆ°çš„<code>HyperLogLog</code>æ•°æ®ç±»å‹ï¼Œäºæ˜¯èŠ±ç‚¹æ—¶é—´åˆ†æä¸€ä¸‹å®ƒçš„ä½¿ç”¨æ–¹å¼å’Œä½¿ç”¨åœºæ™¯ï¼ˆ<strong>æš‚æ—¶ä¸æ¢ç©¶<code>HyperLogLog</code>çš„å®ç°åŸç†</strong>ï¼‰ã€‚<code>Redis</code>ä¸­<code>HyperLogLog</code>æ•°æ®ç±»å‹æ˜¯<code>Redid 2.8.9</code>å¼•å…¥çš„ï¼Œä½¿ç”¨çš„æ—¶å€™ç¡®ä¿<code>Redis</code>ç‰ˆæœ¬<code>&gt;= 2.8.9</code>ã€‚</p><a id="more"></a><h2 id="HyperLogLogç®€ä»‹">HyperLogLogç®€ä»‹</h2><p><code>åŸºæ•°è®¡æ•°(cardinality counting)</code>ï¼Œé€šå¸¸ç”¨æ¥ç»Ÿè®¡ä¸€ä¸ªé›†åˆä¸­ä¸é‡å¤çš„å…ƒç´ ä¸ªæ•°ã€‚ä¸€ä¸ªå¾ˆå¸¸è§çš„ä¾‹å­å°±æ˜¯ç»Ÿè®¡æŸä¸ªæ–‡ç« çš„<code>UV</code>ï¼ˆ<code>Unique Visitor</code>ï¼Œç‹¬ç«‹è®¿å®¢ï¼Œä¸€èˆ¬å¯ä»¥ç†è§£ä¸ºå®¢æˆ·ç«¯<code>IP</code>ï¼‰ã€‚å¤§æ•°æ®é‡èƒŒæ™¯ä¸‹ï¼Œè¦å®ç°åŸºæ•°è®¡æ•°ï¼Œå¤šæ•°æƒ…å†µä¸‹ä¸ä¼šé€‰æ‹©å­˜å‚¨å…¨é‡çš„åŸºæ•°é›†åˆçš„å…ƒç´ ï¼Œå› ä¸ºå¯ä»¥è®¡ç®—å‡ºå­˜å‚¨çš„å†…å­˜æˆæœ¬ï¼Œå‡è®¾ä¸€ä¸ªæ¯ä¸ªè¢«ç»Ÿè®¡çš„å…ƒç´ çš„å¹³å‡å¤§å°ä¸º<code>32bit</code>ï¼Œé‚£ä¹ˆå¦‚æœç»Ÿè®¡ä¸€äº¿ä¸ªæ•°æ®ï¼Œå ç”¨çš„å†…å­˜å¤§å°ä¸ºï¼š</p><ul><li><code>32 * 100000000 / 8 / 1024 / 1024 â‰ˆ 381M</code>ã€‚</li></ul><p>å¦‚æœæœ‰å¤šä¸ªé›†åˆï¼Œå¹¶ä¸”å…è®¸è®¡ç®—å¤šä¸ªé›†åˆçš„åˆå¹¶è®¡æ•°ç»“æœï¼Œé‚£ä¹ˆè¿™ä¸ªæ“ä½œå¸¦æ¥çš„å¤æ‚åº¦å¯èƒ½æ˜¯æ¯ç­æ€§çš„ã€‚å› æ­¤ï¼Œä¸ä¼šä½¿ç”¨<code>Bitmap</code>ã€<code>Tree</code>æˆ–è€…<code>HashSet</code>ç­‰æ•°æ®ç»“æ„ç›´æ¥å­˜å‚¨è®¡æ•°å…ƒç´ é›†åˆçš„æ–¹å¼è¿›è¡Œè®¡æ•°ï¼Œè€Œæ˜¯åœ¨ä¸è¿½æ±‚ç»å¯¹å‡†ç¡®è®¡æ•°ç»“æœçš„å‰æä¹‹ä¸‹ï¼Œä½¿ç”¨åŸºæ•°è®¡æ•°çš„æ¦‚ç‡ç®—æ³•è¿›è¡Œè®¡æ•°ï¼Œç›®å‰å¸¸è§çš„æœ‰æ¦‚ç‡ç®—æ³•ä»¥ä¸‹ä¸‰ç§ï¼š</p><ul><li><code>Linear Counting(LC)</code>ã€‚</li><li><code>LogLog Counting(LLC)</code>ã€‚</li><li><code>HyperLogLog Counting(HLL)</code>ã€‚</li></ul><blockquote><p>æ‰€ä»¥ï¼ŒHyperLogLogå…¶å®æ˜¯ä¸€ç§åŸºæ•°è®¡æ•°æ¦‚ç‡ç®—æ³•ï¼Œå¹¶ä¸æ˜¯Redisç‰¹æœ‰çš„ï¼ŒRedisåŸºäºCè¯­è¨€å®ç°äº†HyperLogLogå¹¶ä¸”æä¾›äº†ç›¸å…³å‘½ä»¤APIå…¥å£ã€‚</p></blockquote><p><code>Redis</code>çš„ä½œè€…<code>Antirez</code>ä¸ºäº†çºªå¿µ<a href="https://en.wikipedia.org/wiki/Philippe_Flajolet" target="_blank" rel="noopener">Philippe Flajolet</a>å¯¹ç»„åˆæ•°å­¦å’ŒåŸºæ•°è®¡ç®—ç®—æ³•åˆ†æçš„ç ”ç©¶ï¼Œæ‰€ä»¥åœ¨è®¾è®¡<code>HyperLogLog</code>å‘½ä»¤çš„æ—¶å€™ä½¿ç”¨äº†<code>Philippe Flajolet</code>å§“åçš„è‹±æ–‡é¦–å­—æ¯<code>PF</code>ä½œä¸ºå‰ç¼€ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ<code>Philippe Flajolet</code>åšå£«æ˜¯<code>HLL</code>ç®—æ³•çš„é‡å¤§è´¡çŒ®è€…ï¼Œä½†æ˜¯ä»–å…¶å®å¹¶ä¸æ˜¯<code>Redis</code>ä¸­<code>HyperLogLog</code>æ•°æ®ç±»å‹çš„å¼€å‘è€…ã€‚é—æ†¾çš„æ˜¯<code>Philippe Flajolet</code>åšå£«äº2011å¹´3æœˆ22æ—¥å› ç—…åœ¨å·´é»è¾ä¸–ã€‚è¿™ä¸ªæ˜¯<code>Philippe Flajolet</code>åšå£«çš„ç»´åŸºç™¾ç§‘ç…§ç‰‡ï¼š</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201911/Philippe_Flajolet.png" alt=""></p><p><code>Redis</code>æä¾›çš„<code>HyperLogLog</code>æ•°æ®ç±»å‹çš„ç‰¹å¾ï¼š</p><ul><li>åŸºæœ¬ç‰¹å¾ï¼šä½¿ç”¨<code>HyperLogLog Counting(HLL)</code>å®ç°ï¼Œ<strong>åªåšåŸºæ•°è®¡ç®—ï¼Œä¸ä¼šä¿å­˜å…ƒæ•°æ®</strong>ã€‚</li><li>å†…å­˜å ç”¨ï¼š<code>HyperLogLog</code>æ¯ä¸ª<code>KEY</code>æœ€å¤šå ç”¨<code>12K</code>çš„å†…å­˜ç©ºé—´ï¼Œå¯ä»¥è®¡ç®—æ¥è¿‘<code>2^64</code>ä¸ªä¸åŒå…ƒç´ çš„åŸºæ•°ï¼Œå®ƒçš„å­˜å‚¨ç©ºé—´é‡‡ç”¨ç¨€ç–çŸ©é˜µå­˜å‚¨ï¼Œç©ºé—´å ç”¨å¾ˆå°ï¼Œä»…ä»…åœ¨è®¡æ•°åŸºæ•°ä¸ªæ•°æ…¢æ…¢å˜å¤§ï¼Œç¨€ç–çŸ©é˜µå ç”¨ç©ºé—´æ¸æ¸è¶…è¿‡äº†é˜ˆå€¼æ—¶æ‰ä¼šä¸€æ¬¡æ€§è½¬å˜æˆç¨ å¯†çŸ©é˜µï¼Œè½¬å˜æˆç¨ å¯†çŸ©é˜µä¹‹åæ‰ä¼šå ç”¨<code>12K</code>çš„å†…å­˜ç©ºé—´ã€‚</li><li>è®¡æ•°è¯¯å·®èŒƒå›´ï¼šåŸºæ•°è®¡æ•°çš„ç»“æœæ˜¯ä¸€ä¸ªæ ‡å‡†è¯¯å·®ï¼ˆ<code>Standard Error</code>ï¼‰ä¸º<code>0.81%</code>çš„è¿‘ä¼¼å€¼ï¼Œå½“æ•°æ®é‡ä¸å¤§çš„æ—¶å€™ï¼Œå¾—åˆ°çš„ç»“æœä¹Ÿå¯èƒ½æ˜¯ä¸€ä¸ªå‡†ç¡®å€¼ã€‚</li></ul><p><strong>å†…å­˜å ç”¨å°ï¼ˆæ¯ä¸ªKEYæœ€é«˜å ç”¨12Kï¼‰æ˜¯<code>HyperLogLog</code>çš„æœ€å¤§ä¼˜åŠ¿</strong>ï¼Œè€Œå®ƒå­˜åœ¨ä¸¤ä¸ªç›¸å¯¹æ˜æ˜¾çš„é™åˆ¶ï¼š</p><ul><li>è®¡ç®—ç»“æœå¹¶ä¸æ˜¯å‡†ç¡®å€¼ï¼Œå­˜åœ¨æ ‡å‡†è¯¯å·®ï¼Œè¿™æ˜¯ç”±äºå®ƒæœ¬è´¨ä¸Šæ˜¯ç”¨æ¦‚ç‡ç®—æ³•å¯¼è‡´çš„ã€‚</li><li>ä¸ä¿å­˜åŸºæ•°çš„å…ƒæ•°æ®ï¼Œè¿™ä¸€ç‚¹å¯¹éœ€è¦ä½¿ç”¨å…ƒæ•°æ®è¿›è¡Œæ•°æ®åˆ†æçš„åœºæ™¯å¹¶ä¸å‹å¥½ã€‚</li></ul><h2 id="HyperLogLogå‘½ä»¤ä½¿ç”¨">HyperLogLogå‘½ä»¤ä½¿ç”¨</h2><p><code>Redis</code>æä¾›çš„<code>HyperLogLog</code>æ•°æ®ç±»å‹ä¸€å…±æœ‰ä¸‰ä¸ªå‘½ä»¤<code>API</code>ï¼š<code>PFADD</code>ã€<code>PFCOUNT</code>å’Œ<code>PFMERGE</code>ã€‚</p><h3 id="PFADD">PFADD</h3><p><code>PFADD</code>å‘½ä»¤å‚æ•°å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PFADD key element [element â€¦]</span><br></pre></td></tr></table></figure><blockquote><p>æ”¯æŒæ­¤å‘½ä»¤çš„Redisç‰ˆæœ¬æ˜¯ï¼š&gt;= 2.8.9<br>æ—¶é—´å¤æ‚åº¦ï¼šæ¯æ·»åŠ ä¸€ä¸ªå…ƒç´ çš„å¤æ‚åº¦ä¸ºO(1)</p></blockquote><ul><li>åŠŸèƒ½ï¼šå°†æ‰€æœ‰å…ƒç´ å‚æ•°<code>element</code>æ·»åŠ åˆ°é”®ä¸º<code>key</code>çš„<code>HyperLogLog</code>æ•°æ®ç»“æ„ä¸­ã€‚</li></ul><p><code>PFADD</code>å‘½ä»¤çš„æ‰§è¡Œæµç¨‹å¦‚ä¸‹ï¼š</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201911/r-d-h-l-l-1.png" alt=""></p><p><code>PFADD</code>å‘½ä»¤çš„ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; PFADD food apple fish</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; PFADD food apple</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; PFADD throwable</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; SET name doge</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; PFADD name throwable</span><br><span class="line">(error) WRONGTYPE Key is not a valid HyperLogLog string value.</span><br></pre></td></tr></table></figure><p>è™½ç„¶<code>HyperLogLog</code>æ•°æ®ç»“æ„æœ¬è´¨æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œä½†æ˜¯ä¸èƒ½åœ¨<code>String</code>ç±»å‹çš„<code>KEY</code>ä½¿ç”¨<code>HyperLogLog</code>çš„ç›¸å…³å‘½ä»¤ã€‚</p><h3 id="PFCOUNT">PFCOUNT</h3><p><code>PFCOUNT</code>å‘½ä»¤å‚æ•°å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PFCOUNT key [key â€¦]</span><br></pre></td></tr></table></figure><blockquote><p>æ”¯æŒæ­¤å‘½ä»¤çš„Redisç‰ˆæœ¬æ˜¯ï¼š&gt;= 2.8.9<br>æ—¶é—´å¤æ‚åº¦ï¼šè¿”å›å•ä¸ªHyperLogLogçš„åŸºæ•°è®¡æ•°å€¼çš„å¤æ‚åº¦ä¸ºO(1)ï¼Œå¹³å‡å¸¸æ•°æ—¶é—´æ¯”è¾ƒä½ã€‚å½“å‚æ•°ä¸ºå¤šä¸ªkeyçš„æ—¶å€™ï¼Œå¤æ‚åº¦ä¸ºO(N)ï¼ŒNä¸ºkeyçš„ä¸ªæ•°ã€‚</p></blockquote><ul><li>å½“<code>PFCOUNT</code>å‘½ä»¤ä½¿ç”¨å•ä¸ª<code>key</code>çš„æ—¶å€™ï¼Œè¿”å›å‚¨å­˜åœ¨ç»™å®šé”®çš„<code>HyperLogLog</code>æ•°æ®ç»“æ„çš„è¿‘ä¼¼åŸºæ•°ï¼Œå¦‚æœé”®ä¸å­˜åœ¨ï¼Œ åˆ™è¿”å›<code>0</code>ã€‚</li><li>å½“<code>PFCOUNT</code>å‘½ä»¤ä½¿ç”¨<strong>å¤š</strong>ä¸ª<code>key</code>çš„æ—¶å€™ï¼Œè¿”å›å‚¨å­˜åœ¨ç»™å®šçš„æ‰€æœ‰<code>HyperLogLog</code>æ•°æ®ç»“æ„çš„å¹¶é›†çš„è¿‘ä¼¼åŸºæ•°ï¼Œä¹Ÿå°±æ˜¯ä¼šæŠŠæ‰€æœ‰çš„<code>HyperLogLog</code>æ•°æ®ç»“æ„åˆå¹¶åˆ°ä¸€ä¸ªä¸´æ—¶çš„<code>HyperLogLog</code>æ•°æ®ç»“æ„ï¼Œç„¶åè®¡ç®—å‡ºè¿‘ä¼¼åŸºæ•°ã€‚</li></ul><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201911/r-d-h-l-l-2.png" alt=""></p><p><code>PFCOUNT</code>å‘½ä»¤çš„ä½¿ç”¨æ–¹å¼å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; PFADD POST:1 ip-1 ip-2</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; PFADD POST:2 ip-2 ip-3 ip-4</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; PFCOUNT POST:1</span><br><span class="line">(integer) 2</span><br><span class="line">127.0.0.1:6379&gt; PFCOUNT POST:1 POST:2</span><br><span class="line">(integer) 4</span><br><span class="line">127.0.0.1:6379&gt; PFCOUNT NOT_EXIST_KEY</span><br><span class="line">(integer) 0</span><br></pre></td></tr></table></figure><h3 id="PFMERGE">PFMERGE</h3><p><code>PFMERGE</code>å‘½ä»¤å‚æ•°å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PFMERGE destkey sourcekey [sourcekey ...]</span><br></pre></td></tr></table></figure><blockquote><p>æ”¯æŒæ­¤å‘½ä»¤çš„Redisç‰ˆæœ¬æ˜¯ï¼š&gt;= 2.8.9<br>æ—¶é—´å¤æ‚åº¦ï¼šO(N)ï¼Œå…¶ä¸­Nä¸ºè¢«åˆå¹¶çš„HyperLogLogæ•°æ®ç»“æ„çš„æ•°é‡ï¼Œæ­¤å‘½ä»¤çš„å¸¸æ•°æ—¶é—´æ¯”è¾ƒé«˜</p></blockquote><ul><li>åŠŸèƒ½ï¼šæŠŠå¤šä¸ª<code>HyperLogLog</code>æ•°æ®ç»“æ„åˆå¹¶ä¸ºä¸€ä¸ªæ–°çš„é”®ä¸º<code>destkey</code>çš„<code>HyperLogLog</code>æ•°æ®ç»“æ„ï¼Œåˆå¹¶åçš„<code>HyperLogLog</code>çš„åŸºæ•°æ¥è¿‘äºæ‰€æœ‰è¾“å…¥<code>HyperLogLog</code>çš„å¯è§é›†åˆï¼ˆ<code>Observed Set</code>ï¼‰çš„å¹¶é›†çš„åŸºæ•°ã€‚</li><li>å‘½ä»¤è¿”å›å€¼ï¼šåªä¼šè¿”å›å­—ç¬¦ä¸²<code>OK</code>ã€‚</li></ul><p><code>PFMERGE</code>å‘½ä»¤çš„ä½¿ç”¨æ–¹å¼å¦‚ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; PFADD POST:1 ip-1 ip-2</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; PFADD POST:2 ip-2 ip-3 ip-4</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; PFMERGE POST:1-2 POST:1 POST:2</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; PFCOUNT POST:1-2</span><br><span class="line">(integer) 4</span><br></pre></td></tr></table></figure><h2 id="ä½¿ç”¨HyperLogLogç»Ÿè®¡UVçš„æ¡ˆä¾‹">ä½¿ç”¨HyperLogLogç»Ÿè®¡UVçš„æ¡ˆä¾‹</h2><p>å‡è®¾ç°åœ¨æœ‰ä¸ªç®€å•çš„åœºæ™¯ï¼Œå°±æ˜¯ç»Ÿè®¡åšå®¢æ–‡ç« çš„<code>UV</code>ï¼Œè¦æ±‚<code>UV</code>çš„è®¡æ•°ä¸éœ€è¦å‡†ç¡®ï¼Œä¹Ÿä¸éœ€è¦ä¿å­˜å®¢æˆ·ç«¯çš„<code>IP</code>æ•°æ®ã€‚ä¸‹é¢å°±è¿™ä¸ªåœºæ™¯ï¼Œä½¿ç”¨<code>HyperLogLog</code>åšä¸€ä¸ªç®€å•çš„æ–¹æ¡ˆå’Œç¼–ç å®æ–½ã€‚</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201911/r-d-h-l-l-3.png" alt=""></p><p>è¿™ä¸ªæµç¨‹å¯èƒ½æ­¥éª¤çš„å…ˆåé¡ºåºå¯èƒ½ä¼šæœ‰æ‰€è°ƒæ•´ï¼Œä½†æ˜¯è¦åšçš„æ“ä½œæ˜¯åŸºæœ¬ä¸å˜çš„ã€‚å…ˆç®€å•å‡è®¾ï¼Œæ–‡ç« çš„å†…å®¹å’Œç»Ÿè®¡æ•°æ®éƒ½æ˜¯åå°æœåŠ¡è¿”å›çš„ï¼Œä¸¤ä¸ªæ¥å£æ˜¯åˆ†å¼€è®¾è®¡ã€‚å¼•å…¥<code>Redis</code>çš„é«˜çº§å®¢æˆ·ç«¯<code>Lettuce</code>ä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.lettuce<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lettuce-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ç¼–ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UvTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> RedisCommands&lt;String, String&gt; COMMANDS;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@BeforeClass</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">beforeClass</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–Rediså®¢æˆ·ç«¯</span></span><br><span class="line">        RedisURI uri = RedisURI.builder().withHost(<span class="string">"localhost"</span>).withPort(<span class="number">6379</span>).build();</span><br><span class="line">        RedisClient redisClient = RedisClient.create(uri);</span><br><span class="line">        StatefulRedisConnection&lt;String, String&gt; connect = redisClient.connect();</span><br><span class="line">        COMMANDS = connect.sync();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Data</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">PostDetail</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> Long id;</span><br><span class="line">        <span class="keyword">private</span> String content;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> PostDetail <span class="title">selectPostDetail</span><span class="params">(Long id)</span> </span>&#123;</span><br><span class="line">        PostDetail detail = <span class="keyword">new</span> PostDetail();</span><br><span class="line">        detail.setContent(<span class="string">"content"</span>);</span><br><span class="line">        detail.setId(id);</span><br><span class="line">        <span class="keyword">return</span> detail;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> PostDetail <span class="title">getPostDetail</span><span class="params">(String clientIp, Long postId)</span> </span>&#123;</span><br><span class="line">        PostDetail detail = selectPostDetail(postId);</span><br><span class="line">        String key = <span class="string">"puv:"</span> + postId;</span><br><span class="line">        COMMANDS.pfadd(key, clientIp);</span><br><span class="line">        <span class="keyword">return</span> detail;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> Long <span class="title">getPostUv</span><span class="params">(Long postId)</span> </span>&#123;</span><br><span class="line">        String key = <span class="string">"puv:"</span> + postId;</span><br><span class="line">        <span class="keyword">return</span> COMMANDS.pfcount(key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testViewPost</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        Long postId = <span class="number">1L</span>;</span><br><span class="line">        getPostDetail(<span class="string">"111.111.111.111"</span>, postId);</span><br><span class="line">        getPostDetail(<span class="string">"111.111.111.222"</span>, postId);</span><br><span class="line">        getPostDetail(<span class="string">"111.111.111.333"</span>, postId);</span><br><span class="line">        getPostDetail(<span class="string">"111.111.111.444"</span>, postId);</span><br><span class="line">        System.out.println(String.format(<span class="string">"The uv count of post [%d] is %d"</span>, postId, getPostUv(postId)));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">The uv count of post [1] is 4</span><br></pre></td></tr></table></figure><p>å¯ä»¥é€‚å½“ä½¿ç”¨æ›´å¤šæ•°é‡çš„ä¸åŒå®¢æˆ·ç«¯<code>IP</code>è°ƒç”¨<code>getPostDetail()</code>ï¼Œç„¶åç»Ÿè®¡ä¸€ä¸‹è¯¯å·®ã€‚</p><h2 id="é¢˜å¤–è¯-å¦‚ä½•å‡†ç¡®åœ°ç»Ÿè®¡UV">é¢˜å¤–è¯-å¦‚ä½•å‡†ç¡®åœ°ç»Ÿè®¡UV</h2><p>å¦‚æœæƒ³è¦å‡†ç¡®ç»Ÿè®¡<code>UV</code>ï¼Œåˆ™éœ€è¦æ³¨æ„å‡ ä¸ªç‚¹ï¼š</p><ul><li>å†…å­˜æˆ–è€…ç£ç›˜å®¹é‡éœ€è¦å‡†å¤‡å……è¶³ï¼Œå› ä¸ºå°±ç›®å‰çš„åŸºæ•°è®¡æ•°ç®—æ³•æ¥çœ‹ï¼Œæ²¡æœ‰ä»»ä½•ç®—æ³•å¯ä»¥åœ¨ä¸ä¿å­˜å…ƒæ•°æ®çš„å‰æä¸‹è¿›è¡Œå‡†ç¡®è®¡æ•°ã€‚</li><li>å¦‚æœéœ€è¦åšç”¨æˆ·è¡Œä¸ºåˆ†æï¼Œé‚£ä¹ˆå…ƒæ•°æ®æœ€ç»ˆéœ€è¦æŒä¹…åŒ–ï¼Œè¿™ä¸€ç‚¹åº”è¯¥ä¾æ‰˜äºå¤§æ•°æ®ä½“ç³»ï¼Œåœ¨è¿™ä¸€æ–¹é¢ç¬”è€…æ²¡æœ‰ç»éªŒï¼Œæ‰€ä»¥æš‚æ—¶ä¸å¤šè¯´ã€‚</li></ul><p>å‡è®¾åœ¨ä¸è€ƒè™‘å†…å­˜æˆæœ¬çš„å‰æä¸‹ï¼Œæˆ‘ä»¬ä¾ç„¶å¯ä»¥ä½¿ç”¨<code>Redis</code>åšå‡†ç¡®å’Œå®æ—¶çš„<code>UV</code>ç»Ÿè®¡ï¼Œç®€å•å°±å¯ä»¥ä½¿ç”¨<code>Set</code>æ•°æ®ç±»å‹ï¼Œå¢åŠ <code>UV</code>åªéœ€è¦ä½¿ç”¨<code>SADD</code>å‘½ä»¤ï¼Œç»Ÿè®¡<code>UV</code>åªéœ€è¦ä½¿ç”¨<code>SCARD</code>å‘½ä»¤ï¼ˆæ—¶é—´å¤æ‚åº¦ä¸º<code>O(1)</code>ï¼Œå¯ä»¥æ”¾å¿ƒä½¿ç”¨ï¼‰ã€‚ä¸¾ä¾‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; SADD puv:1 ip-1 ip-2</span><br><span class="line">(integer) 2</span><br><span class="line">127.0.0.1:6379&gt; SADD puv:1 ip-3 ip-4</span><br><span class="line">(integer) 2</span><br><span class="line">127.0.0.1:6379&gt; SCARD puv:1</span><br><span class="line">(integer) 4</span><br></pre></td></tr></table></figure><p>å¦‚æœè¿™äº›ç»Ÿè®¡æ•°æ®ä»…ä»…æ˜¯ç”¨æˆ·ç«¯å±•ç¤ºï¼Œé‚£ä¹ˆå¯ä»¥é‡‡ç”¨å¼‚æ­¥è®¾è®¡ï¼š</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201911/r-d-h-l-l-4.png" alt=""></p><p>åœ¨ä½“é‡å°çš„æ—¶å€™ï¼Œä¸Šé¢çš„æ‰€æœ‰åº”ç”¨çš„åŠŸèƒ½å¯ä»¥åœ¨åŒä¸€ä¸ªæœåŠ¡ä¸­å®Œæˆï¼Œæ¶ˆæ¯é˜Ÿåˆ—å¯ä»¥ç”¨çº¿ç¨‹æ± çš„å¼‚æ­¥æ–¹æ¡ˆæ›¿ä»£ã€‚</p><h2 id="å°ç»“">å°ç»“</h2><p>è¿™ç¯‡æ–‡ç« åªæ˜¯ç®€å•ä»‹ç»äº†<code>HyperLogLog</code>çš„ä½¿ç”¨å’Œç»Ÿè®¡<code>UV</code>çš„ä½¿ç”¨åœºæ™¯ã€‚æ€»çš„æ¥è¯´å°±æ˜¯ï¼šåœ¨ï¼ˆ1ï¼‰åŸå§‹æ•°æ®é‡å·¨å¤§ï¼Œï¼ˆ2ï¼‰å†…å­˜å ç”¨è¦æ±‚å°½å¯èƒ½å°ï¼Œï¼ˆ3ï¼‰å…è®¸è®¡æ•°å­˜åœ¨ä¸€å®šè¯¯å·®å¹¶ä¸”ï¼ˆ4ï¼‰ä¸è¦æ±‚å­˜æ”¾å…ƒæ•°æ®çš„åœºæ™¯ä¸‹ï¼Œå¯ä»¥ä¼˜å…ˆè€ƒè™‘ä½¿ç”¨<code>HyperLogLog</code>è¿›è¡Œè®¡æ•°ã€‚</p><p>å‚è€ƒèµ„æ–™ï¼š</p><ul><li><a href="http://antirez.com/news/75" target="_blank" rel="noopener">antirez-Redis new data structure: the HyperLogLog</a></li><li><a href="https://redis.io/commands" target="_blank" rel="noopener">Redis Commands</a></li><li>ç»´åŸºç™¾ç§‘</li></ul><p>ï¼ˆæœ¬æ–‡å®Œ c-3-d e-a-20191117ï¼‰</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰æ&quot;&gt;å‰æ&lt;/h2&gt;
&lt;p&gt;æœªæ¥ä¸€æ®µæ—¶é—´å¼€å‘çš„é¡¹ç›®æˆ–è€…éœ€æ±‚ä¼šå¤§é‡ä½¿ç”¨åˆ°&lt;code&gt;Redis&lt;/code&gt;ï¼Œè¶ç€è¿™æ®µæ—¶é—´ä¸šåŠ¡å¹¶ä¸å¤ªç¹å¿™ï¼ŒæŠ½ç‚¹æ—¶é—´é¢„ä¹ å’Œå¤ä¹ &lt;code&gt;Redis&lt;/code&gt;çš„ç›¸å…³å†…å®¹ã€‚åˆšå¥½çœ‹åˆ°åšå®¢ä¸‹é¢çš„&lt;code&gt;UV&lt;/code&gt;å’Œ&lt;code&gt;PV&lt;/code&gt;ç»Ÿè®¡ï¼Œæƒ³åˆ°äº†æœ€è¿‘çœ‹ä¹¦é‡Œé¢æåˆ°çš„&lt;code&gt;HyperLogLog&lt;/code&gt;æ•°æ®ç±»å‹ï¼Œäºæ˜¯èŠ±ç‚¹æ—¶é—´åˆ†æä¸€ä¸‹å®ƒçš„ä½¿ç”¨æ–¹å¼å’Œä½¿ç”¨åœºæ™¯ï¼ˆ&lt;strong&gt;æš‚æ—¶ä¸æ¢ç©¶&lt;code&gt;HyperLogLog&lt;/code&gt;çš„å®ç°åŸç†&lt;/strong&gt;ï¼‰ã€‚&lt;code&gt;Redis&lt;/code&gt;ä¸­&lt;code&gt;HyperLogLog&lt;/code&gt;æ•°æ®ç±»å‹æ˜¯&lt;code&gt;Redid 2.8.9&lt;/code&gt;å¼•å…¥çš„ï¼Œä½¿ç”¨çš„æ—¶å€™ç¡®ä¿&lt;code&gt;Redis&lt;/code&gt;ç‰ˆæœ¬&lt;code&gt;&amp;gt;= 2.8.9&lt;/code&gt;ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Middleware" scheme="http://throwable.club/blog/categories/Middleware/"/>
    
      <category term="Redis" scheme="http://throwable.club/blog/categories/Middleware/Redis/"/>
    
    
      <category term="Middleware" scheme="http://throwable.club/blog/tags/Middleware/"/>
    
      <category term="Redis" scheme="http://throwable.club/blog/tags/Redis/"/>
    
  </entry>
  
  <entry>
    <title>ä½¿ç”¨Rediså®ç°UAæ± </title>
    <link href="http://throwable.club/2019/11/14/redis-in-action-ua-pool/"/>
    <id>http://throwable.club/2019/11/14/redis-in-action-ua-pool/</id>
    <published>2019-11-13T17:02:36.000Z</published>
    <updated>2019-11-28T17:00:58.743Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰æ">å‰æ</h2><p>æœ€è¿‘å¿™äºä¸šåŠ¡å¼€å‘ã€äº¤æ¥å’Œæ¸¸æˆï¼ŒåŠ ä¸Šç¢°ä¸Šäº†ä¸å®šæ—¶å‡ºç°çš„çŠ¹è±«æœŸå’Œå›°æƒ‘æœŸï¼Œè’åºŸå­¦ä¸šäº†ä¸€æ®µæ—¶é—´ã€‚å¤©å†·äº†ï¼Œè¦é‡æ–°æ‹¾èµ·å¼€å§‹ä¸‹é˜¶æ®µçš„å­¦ä¹ äº†ã€‚ä¹‹å‰æ¥è§¦åˆ°çš„ä¸€äº›æ•°æ®æœç´¢é¡¹ç›®ï¼Œæ¶‰åŠåˆ°è¯·æ±‚æ¨¡æ‹Ÿï¼ŒåŸºäºåçˆ¬éœ€è¦ä½¿ç”¨éšæœºçš„<code>User Agent</code>ï¼Œäºæ˜¯ä½¿ç”¨<code>Redis</code>å®ç°äº†ä¸€ä¸ªååˆ†ç®€æ˜“çš„<code>UA</code>æ± ã€‚</p><a id="more"></a><h2 id="èƒŒæ™¯">èƒŒæ™¯</h2><p>æœ€è¿‘çš„ä¸€ä¸ªéœ€æ±‚ï¼Œæœ‰æ¨¡æ‹Ÿè¯·æ±‚çš„é€»è¾‘ï¼Œè¦æ±‚æ¯æ¬¡è¯·æ±‚çš„è¯·æ±‚å¤´ä¸­çš„<code>User Agent</code>è¦æ»¡è¶³ä¸‹é¢å‡ ç‚¹ï¼š</p><ul><li>æ¯æ¬¡è·å–çš„<code>User Agent</code>æ˜¯éšæœºçš„ã€‚</li><li>æ¯æ¬¡è·å–çš„<code>User Agent</code>ï¼ˆçŸ­æ—¶é—´å†…ï¼‰ä¸èƒ½é‡å¤ã€‚</li><li>æ¯æ¬¡è·å–çš„<code>User Agent</code>å¿…é¡»å¸¦æœ‰ä¸»æµçš„æ“ä½œç³»ç»Ÿä¿¡æ¯ï¼ˆå¯ä»¥æ˜¯<code>Uinux</code>ã€<code>Windows</code>ã€<code>IOS</code>å’Œå®‰å“ç­‰ç­‰ï¼‰ã€‚</li></ul><p>è¿™é‡Œä¸‰ç‚¹éƒ½å¯ä»¥ä»<code>UA</code>æ•°æ®çš„æ¥æºè§£å†³ï¼Œå®é™…ä¸Šæˆ‘ä»¬åº”è¯¥å…³æ³¨å…·ä½“çš„å®ç°æ–¹æ¡ˆã€‚ç®€å•åˆ†æä¸€ä¸‹ï¼Œæµç¨‹å¦‚ä¸‹ï¼š</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201911/r-u-a-p-1.png" alt=""></p><p>åœ¨è®¾è®¡<code>UA</code>æ± çš„æ—¶å€™ï¼Œå®ƒçš„æ•°æ®ç»“æ„å’Œç¯å½¢é˜Ÿåˆ—ååˆ†ç±»ä¼¼ï¼š</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201911/r-u-a-p-2.png" alt=""></p><p>ä¸Šå›¾ä¸­ï¼Œå‡è®¾ä¸åŒé¢œè‰²çš„<code>UA</code>æ˜¯å®Œå…¨ä¸åŒçš„<code>UA</code>ï¼Œå®ƒä»¬é€šè¿‡æ´—ç‰Œç®—æ³•æ‰“æ•£æ”¾è¿›å»ç¯å½¢é˜Ÿåˆ—ä¸­ï¼Œå®é™…ä¸Šæ¯æ¬¡å–å‡ºä¸€ä¸ª<code>UA</code>ä¹‹åï¼Œåªéœ€è¦æŠŠæ¸¸æ ‡<code>cursor</code>å‰è¿›æˆ–è€…åé€€ä¸€æ ¼å³å¯ï¼ˆç”šè‡³å¯ä»¥æŠŠæ¸¸æ ‡è®¾ç½®åˆ°é˜Ÿåˆ—ä¸­çš„ä»»æ„å…ƒç´ ï¼‰ã€‚æœ€ç»ˆçš„å®ç°å°±æ˜¯ï¼šéœ€è¦é€šè¿‡ä¸­é—´ä»¶å®ç°åˆ†å¸ƒå¼é˜Ÿåˆ—ï¼ˆåªæ˜¯é˜Ÿåˆ—ï¼Œä¸æ˜¯æ¶ˆæ¯é˜Ÿåˆ—ï¼‰ã€‚</p><h2 id="å…·ä½“å®ç°æ–¹æ¡ˆ">å…·ä½“å®ç°æ–¹æ¡ˆ</h2><p>æ¯«æ— ç–‘é—®éœ€è¦ä¸€ä¸ªåˆ†å¸ƒå¼æ•°æ®åº“ç±»å‹çš„ä¸­é—´ä»¶æ‰èƒ½å­˜æ”¾å·²ç»å‡†å¤‡å¥½çš„<code>UA</code>ï¼Œç¬¬ä¸€å°è±¡å°±æ„Ÿè§‰<code>Redis</code>ä¼šæ¯”è¾ƒåˆé€‚ã€‚æ¥ä¸‹æ¥éœ€è¦é€‰ç”¨<code>Redis</code>çš„æ•°æ®ç±»å‹ï¼Œä¸»è¦è€ƒè™‘å‡ ä¸ªæ–¹é¢ï¼š</p><ul><li>å…·å¤‡é˜Ÿåˆ—æ€§è´¨ã€‚</li><li>æœ€å¥½æ”¯æŒéšæœºè®¿é—®ã€‚</li><li>å…ƒç´ å…¥é˜Ÿã€å‡ºé˜Ÿå’Œéšæœºè®¿é—®çš„æ—¶é—´å¤æ‚åº¦è¦ä½ï¼Œæ¯•ç«Ÿè·å–<code>UA</code>çš„æ¥å£è®¿é—®é‡ä¼šæ¯”è¾ƒå¤§ã€‚</li></ul><p>æ”¯æŒè¿™å‡ ä¸ªæ–¹é¢çš„<code>Redis</code>æ•°æ®ç±»å‹å°±æ˜¯<code>List</code>ï¼Œä¸è¿‡æ³¨æ„<code>List</code>æœ¬èº«ä¸èƒ½å»é‡ï¼Œå»é‡çš„å·¥ä½œå¯ä»¥ç”¨ä»£ç é€»è¾‘å®ç°ã€‚ç„¶åå¯ä»¥æƒ³è±¡å®¢æˆ·ç«¯è·å–<code>UA</code>çš„æµç¨‹å¤§è‡´å¦‚ä¸‹ï¼š</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201911/r-u-a-p-3.png" alt=""></p><p>ç»“åˆå‰é¢çš„åˆ†æï¼Œç¼–ç è¿‡ç¨‹æœ‰å¦‚ä¸‹å‡ æ­¥ï¼š</p><ol><li>å‡†å¤‡å¥½éœ€è¦å¯¼å…¥çš„<code>UA</code>æ•°æ®ï¼Œå¯ä»¥ä»æ•°æ®æºè¯»å–ï¼Œä¹Ÿå¯ä»¥ç›´æ¥æ–‡ä»¶è¯»å–ã€‚</li><li>å› ä¸ºéœ€è¦å¯¼å…¥çš„<code>UA</code>æ•°æ®é›†åˆä¸€èˆ¬ä¸ä¼šå¤ªå¤§ï¼Œè€ƒè™‘å…ˆæŠŠè¿™ä¸ªé›†åˆçš„æ•°æ®éšæœºæ‰“æ•£ï¼Œå¦‚æœä½¿ç”¨<code>Java</code>å¼€å‘å¯ä»¥ç›´æ¥ä½¿ç”¨<code>Collections#shuffle()</code>æ´—ç‰Œç®—æ³•ï¼Œå½“ç„¶ä¹Ÿå¯ä»¥è‡ªè¡Œå®ç°è¿™ä¸ªæ•°æ®éšæœºåˆ†å¸ƒçš„ç®—æ³•ï¼Œ<strong>è¿™ä¸€æ­¥å¯¹äºä¸€äº›è¢«æ¨¡æ‹Ÿæ–¹ä¼šä¸¥æ ¼æ£€éªŒ<code>UA</code>åˆæ³•æ€§çš„åœºæ™¯æ˜¯å¿…é¡»çš„</strong>ã€‚</li><li>å¯¼å…¥<code>UA</code>æ•°æ®åˆ°<code>Redis</code>åˆ—è¡¨ä¸­ã€‚</li><li>ç¼–å†™<code>RPOP + LPUSH</code>çš„<code>Lua</code>è„šæœ¬ï¼Œå®ç°åˆ†å¸ƒå¼å¾ªç¯é˜Ÿåˆ—ã€‚</li></ol><h2 id="ç¼–ç å’Œæµ‹è¯•ç¤ºä¾‹">ç¼–ç å’Œæµ‹è¯•ç¤ºä¾‹</h2><p>å¼•å…¥<code>Redis</code>çš„é«˜çº§å®¢æˆ·ç«¯<code>Lettuce</code>ä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.lettuce<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lettuce-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.2.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>ç¼–å†™<code>RPOP + LPUSH</code>çš„<code>Lua</code>è„šæœ¬ï¼Œ<code>Lua</code>è„šæœ¬åå­—æš‚ç§°ä¸º<code>L_RPOP_LPUSH.lua</code>ï¼Œæ”¾åœ¨<code>resources/scripts/lua</code>ç›®å½•ä¸‹ï¼š</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> key = KEYS[<span class="number">1</span>]</span><br><span class="line"><span class="keyword">local</span> value = redis.call(<span class="string">'RPOP'</span>, key)</span><br><span class="line">redis.call(<span class="string">'LPUSH'</span>, key, value)</span><br><span class="line"><span class="keyword">return</span> value</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªè„šæœ¬ååˆ†ç®€å•ï¼Œä½†æ˜¯å·²ç»å®ç°äº†å¾ªç¯é˜Ÿåˆ—çš„åŠŸèƒ½ã€‚å‰©ä¸‹æ¥çš„æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UaPoolTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> RedisCommands&lt;String, String&gt; COMMANDS;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> AtomicReference&lt;String&gt; LUA_SHA = <span class="keyword">new</span> AtomicReference&lt;&gt;();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String KEY = <span class="string">"UA_POOL"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@BeforeClass</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">beforeClass</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        <span class="comment">// åˆå§‹åŒ–Rediså®¢æˆ·ç«¯</span></span><br><span class="line">        RedisURI uri = RedisURI.builder().withHost(<span class="string">"localhost"</span>).withPort(<span class="number">6379</span>).build();</span><br><span class="line">        RedisClient redisClient = RedisClient.create(uri);</span><br><span class="line">        StatefulRedisConnection&lt;String, String&gt; connect = redisClient.connect();</span><br><span class="line">        COMMANDS = connect.sync();</span><br><span class="line">        <span class="comment">// æ¨¡æ‹Ÿæ„å»ºUAæ± çš„åŸå§‹æ•°æ®,å‡è®¾æœ‰10ä¸ªUA,åˆ†åˆ«æ˜¯UA-0 ... UA-9</span></span><br><span class="line">        List&lt;String&gt; uaList = Lists.newArrayList();</span><br><span class="line">        IntStream.range(<span class="number">0</span>, <span class="number">10</span>).forEach(e -&gt; uaList.add(String.format(<span class="string">"UA-%d"</span>, e)));</span><br><span class="line">        <span class="comment">// æ´—ç‰Œ</span></span><br><span class="line">        Collections.shuffle(uaList);</span><br><span class="line">        <span class="comment">// åŠ è½½Luaè„šæœ¬</span></span><br><span class="line">        ClassPathResource resource = <span class="keyword">new</span> ClassPathResource(<span class="string">"/scripts/lua/L_RPOP_LPUSH.lua"</span>);</span><br><span class="line">        String content = StreamUtils.copyToString(resource.getInputStream(), StandardCharsets.UTF_8);</span><br><span class="line">        String sha = COMMANDS.scriptLoad(content);</span><br><span class="line">        LUA_SHA.compareAndSet(<span class="keyword">null</span>, sha);</span><br><span class="line">        <span class="comment">// Redisé˜Ÿåˆ—ä¸­å†™å…¥UAæ•°æ®,æ•°æ®é‡å¤šçš„æ—¶å€™å¯ä»¥è€ƒè™‘åˆ†æ‰¹å†™å…¥é˜²æ­¢é•¿æ—¶é—´é˜»å¡RedisæœåŠ¡</span></span><br><span class="line">        COMMANDS.lpush(KEY, uaList.toArray(<span class="keyword">new</span> String[<span class="number">0</span>]));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@AfterClass</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">afterClass</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        COMMANDS.del(KEY);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testUaPool</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        IntStream.range(<span class="number">1</span>, <span class="number">21</span>).forEach(e -&gt; &#123;</span><br><span class="line">            String result = COMMANDS.evalsha(LUA_SHA.get(), ScriptOutputType.VALUE, KEY);</span><br><span class="line">            System.out.println(String.format(<span class="string">"ç¬¬%dæ¬¡è·å–åˆ°çš„UAæ˜¯:%s"</span>, e, result));</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŸæ¬¡è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">ç¬¬1æ¬¡è·å–åˆ°çš„UAæ˜¯:UA-0</span><br><span class="line">ç¬¬2æ¬¡è·å–åˆ°çš„UAæ˜¯:UA-8</span><br><span class="line">ç¬¬3æ¬¡è·å–åˆ°çš„UAæ˜¯:UA-2</span><br><span class="line">ç¬¬4æ¬¡è·å–åˆ°çš„UAæ˜¯:UA-4</span><br><span class="line">ç¬¬5æ¬¡è·å–åˆ°çš„UAæ˜¯:UA-7</span><br><span class="line">ç¬¬6æ¬¡è·å–åˆ°çš„UAæ˜¯:UA-5</span><br><span class="line">ç¬¬7æ¬¡è·å–åˆ°çš„UAæ˜¯:UA-1</span><br><span class="line">ç¬¬8æ¬¡è·å–åˆ°çš„UAæ˜¯:UA-3</span><br><span class="line">ç¬¬9æ¬¡è·å–åˆ°çš„UAæ˜¯:UA-6</span><br><span class="line">ç¬¬10æ¬¡è·å–åˆ°çš„UAæ˜¯:UA-9</span><br><span class="line">ç¬¬11æ¬¡è·å–åˆ°çš„UAæ˜¯:UA-0</span><br><span class="line">ç¬¬12æ¬¡è·å–åˆ°çš„UAæ˜¯:UA-8</span><br><span class="line">ç¬¬13æ¬¡è·å–åˆ°çš„UAæ˜¯:UA-2</span><br><span class="line">ç¬¬14æ¬¡è·å–åˆ°çš„UAæ˜¯:UA-4</span><br><span class="line">ç¬¬15æ¬¡è·å–åˆ°çš„UAæ˜¯:UA-7</span><br><span class="line">ç¬¬16æ¬¡è·å–åˆ°çš„UAæ˜¯:UA-5</span><br><span class="line">ç¬¬17æ¬¡è·å–åˆ°çš„UAæ˜¯:UA-1</span><br><span class="line">ç¬¬18æ¬¡è·å–åˆ°çš„UAæ˜¯:UA-3</span><br><span class="line">ç¬¬19æ¬¡è·å–åˆ°çš„UAæ˜¯:UA-6</span><br><span class="line">ç¬¬20æ¬¡è·å–åˆ°çš„UAæ˜¯:UA-9</span><br></pre></td></tr></table></figure><p>å¯è§æ´—ç‰Œç®—æ³•çš„æ•ˆæœä¸å·®ï¼Œæ•°æ®ç›¸å¯¹åˆ†æ•£ã€‚</p><h2 id="å°ç»“">å°ç»“</h2><p>å…¶å®<code>UA</code>æ± çš„è®¾è®¡éš¾åº¦å¹¶ä¸å¤§ï¼Œéœ€è¦æ³¨æ„å‡ ä¸ªè¦ç‚¹ï¼š</p><ul><li>ä¸€èˆ¬ä¸»æµçš„ç§»åŠ¨è®¾å¤‡æˆ–è€…æ¡Œé¢è®¾å¤‡çš„ç³»ç»Ÿç‰ˆæœ¬ä¸ä¼šå¤ªå¤šï¼Œæ‰€ä»¥æ¥æº<code>UA</code>æ•°æ®ä¸ä¼šå¤ªå¤šï¼Œæœ€ç®€å•çš„å®ç°å¯ä»¥ä½¿ç”¨æ–‡ä»¶å­˜æ”¾ï¼Œä¸€æ¬¡è¯»å–ç›´æ¥å†™å…¥<code>Redis</code>ä¸­ã€‚</li><li>æ³¨æ„éœ€è¦éšæœºæ‰“æ•£<code>UA</code>æ•°æ®ï¼Œé¿å…åŒä¸€ä¸ªè®¾å¤‡ç³»ç»Ÿç±»å‹çš„<code>UA</code>æ•°æ®è¿‡äºå¯†é›†ï¼Œè¿™æ ·å¯ä»¥é¿å…è§¦å‘æ¨¡æ‹ŸæŸäº›è¯·æ±‚æ—¶å€™çš„é£æ§è§„åˆ™ã€‚</li><li>éœ€è¦ç†Ÿæ‚‰<code>Lua</code>çš„è¯­æ³•ï¼Œæ¯•ç«Ÿ<code>Redis</code>çš„åŸå­æŒ‡ä»¤ä¸€å®šç¦»ä¸å¼€<code>Lua</code>è„šæœ¬ã€‚</li></ul><p>ï¼ˆæœ¬æ–‡å®Œ c-2-d e-a-20191114ï¼‰</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰æ&quot;&gt;å‰æ&lt;/h2&gt;
&lt;p&gt;æœ€è¿‘å¿™äºä¸šåŠ¡å¼€å‘ã€äº¤æ¥å’Œæ¸¸æˆï¼ŒåŠ ä¸Šç¢°ä¸Šäº†ä¸å®šæ—¶å‡ºç°çš„çŠ¹è±«æœŸå’Œå›°æƒ‘æœŸï¼Œè’åºŸå­¦ä¸šäº†ä¸€æ®µæ—¶é—´ã€‚å¤©å†·äº†ï¼Œè¦é‡æ–°æ‹¾èµ·å¼€å§‹ä¸‹é˜¶æ®µçš„å­¦ä¹ äº†ã€‚ä¹‹å‰æ¥è§¦åˆ°çš„ä¸€äº›æ•°æ®æœç´¢é¡¹ç›®ï¼Œæ¶‰åŠåˆ°è¯·æ±‚æ¨¡æ‹Ÿï¼ŒåŸºäºåçˆ¬éœ€è¦ä½¿ç”¨éšæœºçš„&lt;code&gt;User Agent&lt;/code&gt;ï¼Œäºæ˜¯ä½¿ç”¨&lt;code&gt;Redis&lt;/code&gt;å®ç°äº†ä¸€ä¸ªååˆ†ç®€æ˜“çš„&lt;code&gt;UA&lt;/code&gt;æ± ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Middleware" scheme="http://throwable.club/blog/categories/Middleware/"/>
    
      <category term="Redis" scheme="http://throwable.club/blog/categories/Middleware/Redis/"/>
    
    
      <category term="Middleware" scheme="http://throwable.club/blog/tags/Middleware/"/>
    
      <category term="Redis" scheme="http://throwable.club/blog/tags/Redis/"/>
    
  </entry>
  
  <entry>
    <title>ä¸€æ–‡å½»åº•ç†è§£Redisåºåˆ—åŒ–åè®®ï¼Œä½ ä¹Ÿå¯ä»¥ç¼–å†™Rediså®¢æˆ·ç«¯</title>
    <link href="http://throwable.club/2019/10/09/redis-serialization-protocol-decode-guide/"/>
    <id>http://throwable.club/2019/10/09/redis-serialization-protocol-decode-guide/</id>
    <published>2019-10-09T14:40:13.000Z</published>
    <updated>2019-11-28T17:01:03.790Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰æ">å‰æ</h2><p>æœ€è¿‘å­¦ä¹ <code>Netty</code>çš„æ—¶å€™æƒ³åšä¸€ä¸ªåŸºäº<code>Redis</code>æœåŠ¡åè®®çš„ç¼–ç è§£ç æ¨¡å—ï¼Œè¿‡ç¨‹ä¸­é¡ºä¾¿é˜…è¯»äº†<code>Redis</code>æœåŠ¡åºåˆ—åŒ–åè®®<code>RESP</code>ï¼Œç»“åˆè‡ªå·±çš„ç†è§£å¯¹æ–‡æ¡£è¿›è¡Œäº†ç¿»è¯‘å¹¶ä¸”ç®€å•å®ç°äº†<code>RESP</code>åŸºäº<code>Java</code>è¯­è¨€çš„è§£æã€‚ç¼–å†™æœ¬æ–‡çš„ä½¿ç”¨ä½¿ç”¨çš„<code>JDK</code>ç‰ˆæœ¬ä¸º<code>[8+]</code>ã€‚</p><a id="more"></a><h2 id="RESPç®€ä»‹">RESPç®€ä»‹</h2><p><code>Redis</code>å®¢æˆ·ç«¯ä¸<code>Redis</code>æœåŠ¡ç«¯åŸºäºä¸€ä¸ªç§°ä½œ<code>RESP</code>çš„åè®®è¿›è¡Œé€šä¿¡ï¼Œ<code>RESP</code>å…¨ç§°ä¸º<code>Redis Serialization Protocol</code>ï¼Œä¹Ÿå°±æ˜¯<code>Redis</code>åºåˆ—åŒ–åè®®ã€‚è™½ç„¶<code>RESP</code>ä¸º<code>Redis</code>è®¾è®¡ï¼Œä½†æ˜¯å®ƒä¹Ÿå¯ä»¥åº”ç”¨åœ¨å…¶ä»–å®¢æˆ·ç«¯-æœåŠ¡ç«¯ï¼ˆ<code>Client-Server</code>ï¼‰çš„è½¯ä»¶é¡¹ç›®ä¸­ã€‚<code>RESP</code>åœ¨è®¾è®¡çš„æ—¶å€™æŠ˜ä¸­è€ƒè™‘äº†å¦‚ä¸‹å‡ ç‚¹ï¼š</p><ul><li>æ˜“äºå®ç°ã€‚</li><li>å¿«é€Ÿè§£æã€‚</li><li>å¯è¯»æ€§é«˜ã€‚</li></ul><p><code>RESP</code>å¯ä»¥åºåˆ—åŒ–ä¸åŒçš„æ•°æ®ç±»å‹ï¼Œå¦‚æ•´å‹ã€å­—ç¬¦ä¸²ã€æ•°ç»„è¿˜æœ‰ä¸€ç§ç‰¹æ®Šçš„<code>Error</code>ç±»å‹ã€‚éœ€è¦æ‰§è¡Œçš„<code>Redis</code>å‘½ä»¤ä¼šå°è£…ä¸ºç±»ä¼¼äº<strong>å­—ç¬¦ä¸²æ•°ç»„</strong>çš„è¯·æ±‚ç„¶åé€šè¿‡<code>Redis</code>å®¢æˆ·ç«¯å‘é€åˆ°<code>Redis</code>æœåŠ¡ç«¯ã€‚<code>Redis</code>æœåŠ¡ç«¯ä¼šåŸºäºç‰¹å®šçš„å‘½ä»¤ç±»å‹é€‰æ‹©å¯¹åº”çš„ä¸€ç§æ•°æ®ç±»å‹è¿›è¡Œå›å¤ï¼ˆè¿™ä¸€å¥æ˜¯æ„è¯‘ï¼ŒåŸæ–‡æ˜¯ï¼š<code>Redis replies with a command-specific data type</code>ï¼‰ã€‚</p><p><code>RESP</code>æ˜¯äºŒè¿›åˆ¶å®‰å…¨çš„ï¼ˆ<code>binary-safe</code>ï¼‰ï¼Œå¹¶ä¸”åœ¨<code>RESP</code>ä¸‹ä¸éœ€è¦å¤„ç†ä»ä¸€ä¸ªè¿›ç¨‹ä¼ è¾“åˆ°å¦ä¸€ä¸ªè¿›ç¨‹çš„æ‰¹é‡æ•°æ®ï¼Œå› ä¸ºå®ƒä½¿ç”¨äº†å‰ç¼€é•¿åº¦ï¼ˆ<code>prefixed-length</code>ï¼Œåé¢ä¼šåˆ†æï¼Œ<strong>å°±æ˜¯åœ¨æ¯ä¸ªæ•°æ®å—çš„å‰ç¼€å·²ç»å®šä¹‰å¥½æ•°æ®å—çš„ä¸ªæ•°</strong>ï¼Œç±»ä¼¼äº<code>Netty</code>é‡Œé¢çš„å®šé•¿ç¼–ç è§£ç ï¼‰æ¥ä¼ è¾“æ‰¹é‡æ•°æ®ã€‚</p><p>æ³¨æ„ï¼šæ­¤å¤„æ¦‚è¿°çš„åè®®ä»…ä»…ä½¿ç”¨åœ¨å®¢æˆ·ç«¯-æœåŠ¡ç«¯é€šä¿¡ï¼Œ<code>Redis Cluster</code>ä½¿ç”¨ä¸åŒçš„äºŒè¿›åˆ¶åè®®åœ¨å¤šä¸ªèŠ‚ç‚¹ä¹‹é—´äº¤æ¢æ¶ˆæ¯ï¼ˆä¹Ÿå°±æ˜¯<code>Redis</code>é›†ç¾¤ä¸­çš„èŠ‚ç‚¹ä¹‹é—´å¹¶ä¸ä½¿ç”¨<code>RESP</code>é€šä¿¡ï¼‰ã€‚</p><h3 id="ç½‘ç»œå±‚">ç½‘ç»œå±‚</h3><p><code>Redis</code>å®¢æˆ·ç«¯é€šè¿‡åˆ›å»ºä¸€ä¸ªåœ¨<code>6379</code>ç«¯å£çš„<code>TCP</code>è¿æ¥ï¼Œè¿æ¥åˆ°<code>Redis</code>æœåŠ¡ç«¯ã€‚</p><p>è™½ç„¶<code>RESP</code>åœ¨åº•å±‚é€šä¿¡åè®®æŠ€æœ¯ä¸Šæ˜¯é<code>TCP</code>ç‰¹å®šçš„ï¼Œä½†åœ¨<code>Redis</code>çš„ä¸Šä¸‹æ–‡ä¸­ï¼Œ<code>RESP</code>ä»…ç”¨äº<code>TCP</code>è¿æ¥ï¼ˆæˆ–ç±»ä¼¼çš„é¢å‘æµçš„è¿æ¥ï¼Œå¦‚<code>Unix</code>å¥—æ¥å­—ï¼‰ã€‚</p><h3 id="è¯·æ±‚-å“åº”æ¨¡å‹">è¯·æ±‚-å“åº”æ¨¡å‹</h3><p><code>Redis</code>æœåŠ¡ç«¯æ¥æ”¶ç”±ä¸åŒå‚æ•°ç»„æˆçš„å‘½ä»¤ï¼Œæ¥æ”¶åˆ°å‘½ä»¤å¹¶å°†å…¶å¤„ç†ä¹‹åä¼šæŠŠå›å¤å‘é€å›<code>Redis</code>å®¢æˆ·ç«¯ã€‚è¿™æ˜¯æœ€ç®€å•çš„æ¨¡å‹ï¼Œä½†æ˜¯æœ‰ä¸¤ç§ä¾‹å¤–çš„æƒ…å†µï¼š</p><ul><li><code>Redis</code>æ”¯æŒç®¡é“ï¼ˆ<code>Pipelining</code>ï¼Œæµæ°´çº¿ï¼Œå¤šæ•°æƒ…å†µä¸‹ä¹ æƒ¯ç§°ä¸ºç®¡é“ï¼‰æ“ä½œã€‚ä½¿ç”¨ç®¡é“çš„æƒ…å†µä¸‹ï¼Œ<code>Redis</code>å®¢æˆ·ç«¯å¯ä»¥ä¸€æ¬¡å‘é€å¤šä¸ªå‘½ä»¤ï¼Œç„¶åç­‰å¾…ä¸€æ¬¡æ€§çš„å›å¤ï¼ˆæ–‡ä¸­çš„å›å¤æ˜¯<code>replies</code>ï¼Œç†è§£ä¸º<code>Redis</code>æœåŠ¡ç«¯ä¼šä¸€æ¬¡æ€§è¿”å›ä¸€ä¸ªæ‰¹é‡å›å¤ç»“æœï¼‰ã€‚</li><li>å½“<code>Redis</code>å®¢æˆ·ç«¯è®¢é˜…<code>Pub/Sub</code>ä¿¡é“æ—¶ï¼Œè¯¥åè®®ä¼šæ›´æ”¹è¯­ä¹‰å¹¶æˆä¸ºæ¨é€åè®®ï¼ˆ<code>push protocol</code>ï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå®¢æˆ·ç«¯ä¸å†éœ€è¦å‘é€å‘½ä»¤ï¼Œå› ä¸º<code>Redis</code>æœåŠ¡ç«¯å°†è‡ªåŠ¨å‘å®¢æˆ·ç«¯ï¼ˆè®¢é˜…äº†æ”¹ä¿¡é“çš„å®¢æˆ·ç«¯ï¼‰å‘é€æ–°æ¶ˆæ¯ï¼ˆè¿™é‡Œçš„æ„æ€æ˜¯ï¼šåœ¨è®¢é˜…/å‘å¸ƒæ¨¡å¼ä¸‹ï¼Œæ¶ˆæ¯æ˜¯ç”±<code>Redis</code>æœåŠ¡ç«¯ä¸»åŠ¨æ¨é€ç»™è®¢é˜…äº†ç‰¹å®šä¿¡é“çš„<code>Redis</code>å®¢æˆ·ç«¯ï¼‰ã€‚</li></ul><p>é™¤äº†ä¸Šè¿°ä¸¤ä¸ªç‰¹ä¾‹ä¹‹å¤–ï¼Œ<code>Redis</code>åè®®æ˜¯ä¸€ç§ç®€å•çš„è¯·æ±‚-å“åº”åè®®ã€‚</p><h2 id="RESPæ”¯æŒçš„æ•°æ®ç±»å‹">RESPæ”¯æŒçš„æ•°æ®ç±»å‹</h2><p><code>RESP</code>åœ¨<code>Redis 1.2</code>ä¸­å¼•å…¥ï¼Œåœ¨<code>Redis 2.0</code>ï¼Œ<code>RESP</code>æ­£å¼æˆä¸ºä¸<code>Redis</code>æœåŠ¡ç«¯é€šä¿¡çš„æ ‡å‡†æ–¹æ¡ˆã€‚ä¹Ÿå°±æ˜¯å¦‚æœéœ€è¦ç¼–å†™<code>Redis</code>å®¢æˆ·ç«¯ï¼Œä½ å°±å¿…é¡»åœ¨å®¢æˆ·ç«¯ä¸­å®ç°æ­¤åè®®ã€‚</p><p><code>RESP</code>æœ¬è´¨ä¸Šæ˜¯ä¸€ç§åºåˆ—åŒ–åè®®ï¼Œå®ƒæ”¯æŒçš„æ•°æ®ç±»å‹å¦‚ä¸‹ï¼šå•è¡Œå­—ç¬¦ä¸²ã€é”™è¯¯æ¶ˆæ¯ã€æ•´å‹æ•°å­—ã€å®šé•¿å­—ç¬¦ä¸²å’Œ<code>RESP</code>æ•°ç»„ã€‚</p><p><code>RESP</code>åœ¨<code>Redis</code>ä¸­ç”¨ä½œè¯·æ±‚-å“åº”åè®®çš„æ–¹å¼å¦‚ä¸‹ï¼š</p><ul><li><code>Redis</code>å®¢æˆ·ç«¯å°†å‘½ä»¤å°è£…ä¸º<code>RESP</code>çš„æ•°ç»„ç±»å‹ï¼ˆ<strong>æ•°ç»„å…ƒç´ éƒ½æ˜¯å®šé•¿å­—ç¬¦ä¸²ç±»å‹</strong>ï¼Œæ³¨æ„è¿™ä¸€ç‚¹ï¼Œå¾ˆé‡è¦ï¼‰å‘é€åˆ°<code>Redis</code>æœåŠ¡å™¨ã€‚</li><li><code>Redis</code>æœåŠ¡ç«¯æ ¹æ®å‘½ä»¤å®ç°é€‰æ‹©å¯¹åº”çš„<code>RESP</code>æ•°æ®ç±»å‹ä¹‹ä¸€è¿›è¡Œå›å¤ã€‚</li></ul><p>åœ¨<code>RESP</code>ä¸­ï¼Œæ•°æ®ç±»å‹å–å†³äºæ•°æ®æŠ¥çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼š</p><ul><li>å•è¡Œå­—ç¬¦ä¸²çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º<code>+</code>ã€‚</li><li>é”™è¯¯æ¶ˆæ¯çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º<code>-</code>ã€‚</li><li>æ•´å‹æ•°å­—çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º<code>:</code>ã€‚</li><li>å®šé•¿å­—ç¬¦ä¸²çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º<code>$</code>ã€‚</li><li><code>RESP</code>æ•°ç»„çš„ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º<code>*</code>ã€‚</li></ul><p>å¦å¤–ï¼Œåœ¨<code>RESP</code>ä¸­å¯ä»¥ä½¿ç”¨å®šé•¿å­—ç¬¦ä¸²æˆ–è€…æ•°ç»„çš„ç‰¹æ®Šå˜ä½“æ¥è¡¨ç¤º<code>Null</code>å€¼ï¼Œåé¢ä¼šæåŠã€‚åœ¨<code>RESP</code>ä¸­ï¼Œ<strong>åè®®çš„ä¸åŒéƒ¨åˆ†å§‹ç»ˆä»¥<code>\r\n</code>ï¼ˆ<code>CRLF</code>ï¼‰ç»ˆæ­¢</strong>ã€‚</p><p>ç›®å‰<code>RESP</code>ä¸­5ç§æ•°æ®ç±»å‹çš„å°ç»“å¦‚ä¸‹ï¼š</p><table><thead><tr><th style="text-align:center">æ•°æ®ç±»å‹</th><th style="text-align:center">æœ¬æ–‡ç¿»è¯‘åç§°</th><th style="text-align:center">åŸºæœ¬ç‰¹å¾</th><th style="text-align:center">ä¾‹å­</th></tr></thead><tbody><tr><td style="text-align:center"><code>Simple String</code></td><td style="text-align:center">å•è¡Œå­—ç¬¦ä¸²</td><td style="text-align:center">ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯<code>+</code>ï¼Œæœ€åä¸¤ä¸ªå­—èŠ‚æ˜¯<code>\r\n</code>ï¼Œå…¶ä»–å­—èŠ‚æ˜¯å­—ç¬¦ä¸²å†…å®¹</td><td style="text-align:center"><code>+OK\r\n</code></td></tr><tr><td style="text-align:center"><code>Error</code></td><td style="text-align:center">é”™è¯¯æ¶ˆæ¯</td><td style="text-align:center">ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯<code>-</code>ï¼Œæœ€åä¸¤ä¸ªå­—èŠ‚æ˜¯<code>\r\n</code>ï¼Œå…¶ä»–å­—èŠ‚æ˜¯å¼‚å¸¸æ¶ˆæ¯çš„æ–‡æœ¬å†…å®¹</td><td style="text-align:center"><code>-ERR\r\n</code></td></tr><tr><td style="text-align:center"><code>Integer</code></td><td style="text-align:center">æ•´å‹æ•°å­—</td><td style="text-align:center">ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯<code>:</code>ï¼Œæœ€åä¸¤ä¸ªå­—èŠ‚æ˜¯<code>\r\n</code>ï¼Œå…¶ä»–å­—èŠ‚æ˜¯æ•°å­—çš„æ–‡æœ¬å†…å®¹</td><td style="text-align:center"><code>:100\r\n</code></td></tr><tr><td style="text-align:center"><code>Bulk String</code></td><td style="text-align:center">å®šé•¿å­—ç¬¦ä¸²</td><td style="text-align:center">ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯<code>$</code>ï¼Œç´§æ¥ç€çš„å­—èŠ‚æ˜¯<code>å†…å®¹å­—ç¬¦ä¸²é•¿åº¦\r\n</code>ï¼Œæœ€åä¸¤ä¸ªå­—èŠ‚æ˜¯<code>\r\n</code>ï¼Œå…¶ä»–å­—èŠ‚æ˜¯å­—ç¬¦ä¸²å†…å®¹</td><td style="text-align:center"><code>$4\r\ndoge\r\n</code></td></tr><tr><td style="text-align:center"><code>Array</code></td><td style="text-align:center"><code>RESP</code>æ•°ç»„</td><td style="text-align:center">ç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯<code>*</code>ï¼Œç´§æ¥ç€çš„å­—èŠ‚æ˜¯<code>å…ƒç´ ä¸ªæ•°\r\n</code>ï¼Œæœ€åä¸¤ä¸ªå­—èŠ‚æ˜¯<code>\r\n</code>ï¼Œå…¶ä»–å­—èŠ‚æ˜¯å„ä¸ªå…ƒç´ çš„å†…å®¹ï¼Œæ¯ä¸ªå…ƒç´ å¯ä»¥æ˜¯ä»»æ„ä¸€ç§æ•°æ®ç±»å‹</td><td style="text-align:center"><code>*2\r\n:100\r\n$4\r\ndoge\r\n</code></td></tr></tbody></table><p>ä¸‹é¢çš„å°èŠ‚æ˜¯å¯¹æ¯ç§æ•°æ®ç±»å‹çš„æ›´ç»†è‡´çš„åˆ†æã€‚</p><h3 id="RESPç®€å•å­—ç¬¦ä¸²-Simple-String">RESPç®€å•å­—ç¬¦ä¸²-Simple String</h3><p>ç®€å•å­—ç¬¦ä¸²çš„ç¼–ç æ–¹å¼å¦‚ä¸‹ï¼š</p><ul><li>ï¼ˆ1ï¼‰ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º<code>+</code>ã€‚</li><li>ï¼ˆ2ï¼‰ç´§æ¥ç€çš„æ˜¯ä¸€ä¸ªä¸èƒ½åŒ…å«<code>CR</code>æˆ–è€…<code>LF</code>å­—ç¬¦çš„å­—ç¬¦ä¸²ã€‚</li><li>ï¼ˆ3ï¼‰ä»¥<code>CRLF</code>ç»ˆæ­¢ã€‚</li></ul><p>ç®€å•å­—ç¬¦ä¸²èƒ½å¤Ÿä¿è¯åœ¨æœ€å°å¼€é”€çš„å‰æä¸‹ä¼ è¾“éäºŒè¿›åˆ¶å®‰å…¨çš„å­—ç¬¦ä¸²ã€‚ä¾‹å¦‚å¾ˆå¤š<code>Redis</code>å‘½ä»¤æ‰§è¡ŒæˆåŠŸåæœåŠ¡ç«¯éœ€è¦å›å¤<code>OK</code>å­—ç¬¦ä¸²ï¼Œæ­¤æ—¶é€šè¿‡ç®€å•å­—ç¬¦ä¸²ç¼–ç ä¸º5å­—èŠ‚çš„æ•°æ®æŠ¥å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">+OK\r\n</span><br></pre></td></tr></table></figure><p>å¦‚æœéœ€è¦å‘é€äºŒè¿›åˆ¶å®‰å…¨çš„å­—ç¬¦ä¸²ï¼Œé‚£ä¹ˆéœ€è¦ä½¿ç”¨å®šé•¿å­—ç¬¦ä¸²ã€‚</p><p>å½“<code>Redis</code>æœåŠ¡ç«¯ç”¨ç®€å•å­—ç¬¦ä¸²å“åº”æ—¶ï¼Œ<code>Redis</code>å®¢æˆ·ç«¯åº“åº”è¯¥å‘è°ƒç”¨è€…è¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¯¥å“åº”åˆ°è°ƒç”¨è€…çš„å­—ç¬¦ä¸²ç”±<code>+</code>ä¹‹åç›´åˆ°å­—ç¬¦ä¸²å†…å®¹æœ«å°¾çš„å­—ç¬¦ç»„æˆï¼ˆå…¶å®å°±æ˜¯ä¸Šé¢æåˆ°çš„ç¬¬ï¼ˆ2ï¼‰éƒ¨åˆ†çš„å†…å®¹ï¼‰ï¼Œä¸åŒ…æ‹¬æœ€åçš„<code>CRLF</code>å­—èŠ‚ã€‚</p><h3 id="RESPé”™è¯¯æ¶ˆæ¯-Error">RESPé”™è¯¯æ¶ˆæ¯-Error</h3><p>é”™è¯¯æ¶ˆæ¯ç±»å‹æ˜¯<code>RESP</code>ç‰¹å®šçš„æ•°æ®ç±»å‹ã€‚å®é™…ä¸Šï¼Œé”™è¯¯æ¶ˆæ¯ç±»å‹å’Œç®€å•å­—ç¬¦ä¸²ç±»å‹åŸºæœ¬ä¸€è‡´ï¼Œåªæ˜¯å…¶ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º<code>-</code>ã€‚é”™è¯¯æ¶ˆæ¯ç±»å‹è·Ÿç®€å•å­—ç¬¦ä¸²ç±»å‹çš„æœ€å¤§åŒºåˆ«æ˜¯ï¼šé”™è¯¯æ¶ˆæ¯ä½œä¸º<code>Redis</code>æœåŠ¡ç«¯å“åº”çš„æ—¶å€™ï¼Œå¯¹äºå®¢æˆ·ç«¯è€Œè¨€åº”è¯¥æ„ŸçŸ¥ä¸ºå¼‚å¸¸ï¼Œè€Œé”™è¯¯æ¶ˆæ¯ä¸­çš„å­—ç¬¦ä¸²å†…å®¹åº”è¯¥æ„ŸçŸ¥ä¸º<code>Redis</code>æœåŠ¡ç«¯è¿”å›çš„é”™è¯¯ä¿¡æ¯ã€‚é”™è¯¯æ¶ˆæ¯çš„ç¼–ç æ–¹å¼å¦‚ä¸‹ï¼š</p><ul><li>ï¼ˆ1ï¼‰ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º<code>-</code>ã€‚</li><li>ï¼ˆ2ï¼‰ç´§æ¥ç€çš„æ˜¯ä¸€ä¸ªä¸èƒ½åŒ…å«<code>CR</code>æˆ–è€…<code>LF</code>å­—ç¬¦çš„å­—ç¬¦ä¸²ã€‚</li><li>ï¼ˆ3ï¼‰ä»¥<code>CRLF</code>ç»ˆæ­¢ã€‚</li></ul><p>ä¸€ä¸ªç®€å•çš„ä¾‹å­å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-Error message\r\n</span><br></pre></td></tr></table></figure><p><code>Redis</code>æœåŠ¡ç«¯åªæœ‰åœ¨çœŸæ­£å‘ç”Ÿé”™è¯¯æˆ–è€…æ„ŸçŸ¥é”™è¯¯çš„æ—¶å€™æ‰ä¼šå›å¤é”™è¯¯æ¶ˆæ¯ï¼Œä¾‹å¦‚å°è¯•å¯¹é”™è¯¯çš„æ•°æ®ç±»å‹æ‰§è¡Œæ“ä½œæˆ–è€…å‘½ä»¤ä¸å­˜åœ¨ç­‰ç­‰ã€‚<code>Redis</code>å®¢æˆ·ç«¯æ¥æ”¶åˆ°é”™è¯¯æ¶ˆæ¯çš„æ—¶å€™ï¼Œåº”è¯¥è§¦å‘å¼‚å¸¸ï¼ˆä¸€èˆ¬æƒ…å†µå°±æ˜¯ç›´æ¥æŠ›å‡ºå¼‚å¸¸ï¼Œå¯ä»¥æ ¹æ®é”™è¯¯æ¶ˆæ¯çš„å†…å®¹è¿›è¡Œå¼‚å¸¸åˆ†ç±»ï¼‰ã€‚ä¸‹é¢æ˜¯é”™è¯¯æ¶ˆæ¯å“åº”çš„ä¸€äº›ä¾‹å­ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">-ERR unknown command 'foobar'</span><br><span class="line">-WRONGTYPE Operation against a key holding the wrong kind of value</span><br></pre></td></tr></table></figure><p><code>-</code>ä¹‹åçš„ç¬¬ä¸€ä¸ªå•è¯åˆ°ç¬¬ä¸€ä¸ªç©ºæ ¼æˆ–æ¢è¡Œç¬¦ä¹‹é—´çš„å†…å®¹ï¼Œä»£è¡¨è¿”å›çš„é”™è¯¯ç±»å‹ã€‚è¿™åªæ˜¯<code>Redis</code>ä½¿ç”¨çš„çº¦å®šï¼Œä¸æ˜¯<code>RESP</code>é”™è¯¯æ¶ˆæ¯æ ¼å¼çš„ä¸€éƒ¨åˆ†ã€‚</p><p>ä¾‹å¦‚ï¼Œ<code>ERR</code>æ˜¯é€šç”¨é”™è¯¯ï¼Œ<code>WRONGTYPE</code>åˆ™æ˜¯æ›´å…·ä½“çš„é”™è¯¯ï¼Œè¡¨ç¤ºå®¢æˆ·ç«¯è¯•å›¾é’ˆå¯¹é”™è¯¯çš„æ•°æ®ç±»å‹æ‰§è¡Œæ“ä½œã€‚è¿™ç§å®šä¹‰æ–¹å¼ç§°ä¸º<strong>é”™è¯¯å‰ç¼€</strong>ï¼Œæ˜¯ä¸€ç§ä½¿å®¢æˆ·ç«¯èƒ½å¤Ÿç†è§£æœåŠ¡å™¨è¿”å›çš„é”™è¯¯ç±»å‹çš„æ–¹æ³•ï¼Œè€Œä¸å¿…ä¾èµ–äºæ‰€ç»™å‡ºçš„ç¡®åˆ‡æ¶ˆæ¯å®šä¹‰ï¼Œè¯¥æ¶ˆæ¯å¯èƒ½ä¼šéšæ—¶é—´è€Œå˜åŒ–ã€‚</p><p>å®¢æˆ·ç«¯å®ç°å¯ä»¥é’ˆå¯¹ä¸åŒçš„é”™è¯¯ç±»å‹è¿”å›ä¸åŒç§ç±»çš„å¼‚å¸¸ï¼Œæˆ–è€…å¯ä»¥é€šè¿‡å°†é”™è¯¯ç±»å‹çš„åç§°ä½œä¸ºå­—ç¬¦ä¸²ç›´æ¥æä¾›ç»™è°ƒç”¨æ–¹æ¥æä¾›æ•è·é”™è¯¯çš„é€šç”¨æ–¹æ³•ã€‚</p><p>ä½†æ˜¯ï¼Œä¸åº”è¯¥å°†é”™è¯¯æ¶ˆæ¯åˆ†ç±»å¤„ç†çš„åŠŸèƒ½è§†ä¸ºè‡³å…³é‡è¦çš„åŠŸèƒ½ï¼Œå› ä¸ºå®ƒä½œç”¨å¹¶ä¸å·¨å¤§ï¼Œå¹¶ä¸”æœ‰äº›çš„å®¢æˆ·ç«¯å®ç°å¯èƒ½ä¼šç®€å•åœ°è¿”å›ç‰¹å®šå€¼å»å±è”½é”™è¯¯æ¶ˆæ¯ä½œä¸ºé€šç”¨çš„å¼‚å¸¸å¤„ç†ï¼Œä¾‹å¦‚ç›´æ¥è¿”å›<code>false</code>ã€‚</p><h3 id="RESPæ•´å‹æ•°å­—-Integer">RESPæ•´å‹æ•°å­—-Integer</h3><p>æ•´å‹æ•°å­—çš„ç¼–ç æ–¹å¼å¦‚ä¸‹ï¼š</p><ul><li>ï¼ˆ1ï¼‰ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º<code>ï¼š</code>ã€‚</li><li>ï¼ˆ2ï¼‰ç´§æ¥ç€çš„æ˜¯ä¸€ä¸ªä¸èƒ½åŒ…å«<code>CR</code>æˆ–è€…<code>LF</code>å­—ç¬¦çš„å­—ç¬¦ä¸²ï¼Œä¹Ÿå°±æ˜¯æ•°å­—è¦å…ˆè½¬æ¢ä¸ºå­—ç¬¦åºåˆ—ï¼Œæœ€ç»ˆè¦è¾“å‡ºä¸ºå­—èŠ‚ã€‚</li><li>ï¼ˆ3ï¼‰ä»¥<code>CRLF</code>ç»ˆæ­¢ã€‚</li></ul><p>ä¾‹å¦‚ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">:0\r\n</span><br><span class="line">:1000\r\n</span><br></pre></td></tr></table></figure><p>è®¸å¤š<code>Redis</code>å‘½ä»¤è¿”å›æ•´å‹æ•°å­—ï¼Œåƒ<code>INCR</code>ï¼Œ<code>LLEN</code>å’Œ<code>LASTSAVE</code>å‘½ä»¤ç­‰ç­‰ã€‚</p><p>è¿”å›çš„æ•´å‹æ•°å­—æ²¡æœ‰ç‰¹æ®Šçš„å«ä¹‰ï¼Œåƒ<code>INCR</code>è¿”å›çš„æ˜¯å¢é‡çš„æ€»é‡ï¼Œè€Œ<code>LASTSAVE</code>æ˜¯<code>UNIX</code>æ—¶é—´æˆ³ã€‚ä½†æ˜¯<code>Redis</code>æœåŠ¡ç«¯ä¿è¯è¿”å›çš„æ•´å‹æ•°å­—åœ¨<strong>å¸¦ç¬¦å·çš„64ä½æ•´æ•°</strong>èŒƒå›´å†…ã€‚</p><p>æœ‰äº›æƒ…å†µä¸‹ï¼Œè¿”å›çš„æ•´å‹æ•°å­—ä¼šæŒ‡ä»£<code>true</code>æˆ–è€…<code>false</code>ã€‚å¦‚<code>EXISTS</code>æˆ–è€…<code>SISMEMBER</code>å‘½ä»¤æ‰§è¡Œè¿”å›1ä»£è¡¨<code>true</code>ï¼Œ0ä»£è¡¨<code>false</code>ã€‚</p><p>æœ‰äº›æƒ…å†µä¸‹ï¼Œè¿”å›çš„æ•´å‹æ•°å­—ä¼šæŒ‡ä»£å‘½ä»¤æ˜¯å¦çœŸæ­£äº§ç”Ÿäº†æ•ˆæœã€‚å¦‚<code>SADD</code>ï¼Œ<code>SREM</code>å’Œ<code>SETNX</code>å‘½ä»¤æ‰§è¡Œè¿”å›1ä»£è¡¨å‘½ä»¤æ‰§è¡Œç”Ÿæ•ˆï¼Œ0ä»£è¡¨å‘½ä»¤æ‰§è¡Œä¸ç”Ÿæ•ˆï¼ˆç­‰ä»·äºå‘½ä»¤æ²¡æœ‰æ‰§è¡Œï¼‰ã€‚</p><p>ä¸‹é¢çš„ä¸€ç»„å‘½ä»¤æ‰§è¡Œåéƒ½æ˜¯è¿”å›æ•´å‹æ•°å­—ï¼š<code>SETNX, DEL, EXISTS, INCR, INCRBY, DECR, DECRBY, DBSIZE, LASTSAVE, RENAMENX, MOVE, LLEN, SADD, SREM, SISMEMBER, SCARD</code>ã€‚</p><h3 id="RESPå®šé•¿å­—ç¬¦ä¸²-Bulk-String">RESPå®šé•¿å­—ç¬¦ä¸²-Bulk String</h3><p>å®šé•¿å­—ç¬¦ä¸²ç”¨äºè¡¨ç¤ºä¸€ä¸ªæœ€å¤§é•¿åº¦ä¸º<code>512MB</code>çš„äºŒè¿›åˆ¶å®‰å…¨çš„å­—ç¬¦ä¸²ï¼ˆ<code>Bulk</code>ï¼Œæœ¬èº«æœ‰ä½“ç§¯å¤§çš„å«ä¹‰ï¼‰ã€‚å®šé•¿å­—ç¬¦ä¸²çš„ç¼–ç æ–¹å¼å¦‚ä¸‹ï¼š</p><ul><li>ï¼ˆ1ï¼‰ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º<code>$</code>ã€‚</li><li>ï¼ˆ2ï¼‰ç´§æ¥ç€çš„æ˜¯ç»„æˆå­—ç¬¦ä¸²çš„å­—èŠ‚æ•°é•¿åº¦ï¼ˆç§°ä¸º<code>prefixed length</code>ï¼Œä¹Ÿå°±æ˜¯å‰ç¼€é•¿åº¦ï¼‰ï¼Œå‰ç¼€é•¿åº¦åˆ†å—ä»¥<code>CRLF</code>ç»ˆæ­¢ã€‚</li><li>ï¼ˆ3ï¼‰ç„¶åæ˜¯ä¸€ä¸ªä¸èƒ½åŒ…å«<code>CR</code>æˆ–è€…<code>LF</code>å­—ç¬¦çš„å­—ç¬¦ä¸²ï¼Œä¹Ÿå°±æ˜¯æ•°å­—è¦å…ˆè½¬æ¢ä¸ºå­—ç¬¦åºåˆ—ï¼Œæœ€ç»ˆè¦è¾“å‡ºä¸ºå­—èŠ‚ã€‚</li><li>ï¼ˆ4ï¼‰ä»¥<code>CRLF</code>ç»ˆæ­¢ã€‚</li></ul><p>ä¸¾ä¸ªä¾‹å­ï¼Œ<code>doge</code>ä½¿ç”¨å®šé•¿å­—ç¬¦ä¸²ç¼–ç å¦‚ä¸‹ï¼š</p><table><thead><tr><th style="text-align:center">ç¬¬ä¸€ä¸ªå­—èŠ‚</th><th style="text-align:center">å‰ç¼€é•¿åº¦</th><th style="text-align:center"><code>CRLF</code></th><th style="text-align:center">å­—ç¬¦ä¸²å†…å®¹</th><th style="text-align:center"><code>CRLF</code></th><th style="text-align:center"></th><th style="text-align:center">å®šé•¿å­—ç¬¦ä¸²</th></tr></thead><tbody><tr><td style="text-align:center"><code>$</code></td><td style="text-align:center"><code>4</code></td><td style="text-align:center"><code>\r\n</code></td><td style="text-align:center"><code>doge</code></td><td style="text-align:center"><code>\r\n</code></td><td style="text-align:center"><code>===&gt;</code></td><td style="text-align:center"><code>$4\r\ndoge\r\n</code></td></tr></tbody></table><p><code>foobar</code>ä½¿ç”¨å®šé•¿å­—ç¬¦ä¸²ç¼–ç å¦‚ä¸‹ï¼š</p><table><thead><tr><th style="text-align:center">ç¬¬ä¸€ä¸ªå­—èŠ‚</th><th style="text-align:center">å‰ç¼€é•¿åº¦</th><th style="text-align:center"><code>CRLF</code></th><th style="text-align:center">å­—ç¬¦ä¸²å†…å®¹</th><th style="text-align:center"><code>CRLF</code></th><th style="text-align:center"></th><th style="text-align:center">å®šé•¿å­—ç¬¦ä¸²</th></tr></thead><tbody><tr><td style="text-align:center"><code>$</code></td><td style="text-align:center"><code>6</code></td><td style="text-align:center"><code>\r\n</code></td><td style="text-align:center"><code>foobar</code></td><td style="text-align:center"><code>\r\n</code></td><td style="text-align:center"><code>===&gt;</code></td><td style="text-align:center"><code>$6\r\nfoobar\r\n</code></td></tr></tbody></table><p>è¡¨ç¤º<strong>ç©ºå­—ç¬¦ä¸²ï¼ˆ<code>Empty String</code>ï¼Œå¯¹åº”Javaä¸­çš„<code>&quot;&quot;</code>ï¼‰</strong> çš„æ—¶å€™ï¼Œä½¿ç”¨å®šé•¿å­—ç¬¦ä¸²ç¼–ç å¦‚ä¸‹ï¼š</p><table><thead><tr><th style="text-align:center">ç¬¬ä¸€ä¸ªå­—èŠ‚</th><th style="text-align:center">å‰ç¼€é•¿åº¦</th><th style="text-align:center"><code>CRLF</code></th><th style="text-align:center"><code>CRLF</code></th><th style="text-align:center"></th><th style="text-align:center">å®šé•¿å­—ç¬¦ä¸²</th></tr></thead><tbody><tr><td style="text-align:center"><code>$</code></td><td style="text-align:center"><code>0</code></td><td style="text-align:center"><code>\r\n</code></td><td style="text-align:center"><code>\r\n</code></td><td style="text-align:center"><code>===&gt;</code></td><td style="text-align:center"><code>$0\r\n\r\n</code></td></tr></tbody></table><p>å®šé•¿å­—ç¬¦ä¸²ä¹Ÿå¯ä»¥ä½¿ç”¨ç‰¹æ®Šçš„æ ¼å¼æ¥è¡¨ç¤º<code>Null</code>å€¼ï¼ŒæŒ‡ä»£å€¼ä¸å­˜åœ¨ã€‚åœ¨è¿™ç§ç‰¹æ®Šæ ¼å¼ä¸­ï¼Œå‰ç¼€é•¿åº¦ä¸º-1ï¼Œå¹¶ä¸”æ²¡æœ‰æ•°æ®ï¼Œå› æ­¤ä½¿ç”¨å®šé•¿å­—ç¬¦ä¸²å¯¹<code>Null</code>å€¼è¿›è¡Œç¼–ç å¦‚ä¸‹ï¼š</p><table><thead><tr><th style="text-align:center">ç¬¬ä¸€ä¸ªå­—èŠ‚</th><th style="text-align:center">å‰ç¼€é•¿åº¦</th><th style="text-align:center"><code>CRLF</code></th><th style="text-align:center"></th><th style="text-align:center">å®šé•¿å­—ç¬¦ä¸²</th></tr></thead><tbody><tr><td style="text-align:center"><code>$</code></td><td style="text-align:center"><code>-1</code></td><td style="text-align:center"><code>\r\n</code></td><td style="text-align:center"><code>===&gt;</code></td><td style="text-align:center"><code>$-1\r\n</code></td></tr></tbody></table><p>å½“<code>Redis</code>æœåŠ¡ç«¯è¿”å›å®šé•¿å­—ç¬¦ä¸²ç¼–ç çš„<code>Null</code>å€¼çš„æ—¶å€™ï¼Œå®¢æˆ·ç«¯ä¸åº”è¯¥è¿”å›ç©ºå­—ç¬¦ä¸²ï¼Œè€Œåº”è¯¥è¿”å›å¯¹åº”ç¼–ç¨‹è¯­è¨€ä¸­çš„<code>Null</code>å¯¹è±¡ã€‚ä¾‹å¦‚<code>Ruby</code>ä¸­å¯¹åº”<code>nil</code>ï¼Œ<code>C</code>è¯­è¨€ä¸­å¯¹åº”<code>NULL</code>ï¼Œ<code>Java</code>ä¸­å¯¹åº”<code>null</code>ï¼Œä»¥æ­¤ç±»æ¨ã€‚</p><h3 id="RESPæ•°ç»„-Array">RESPæ•°ç»„-Array</h3><p><code>Redis</code>å®¢æˆ·ç«¯ä½¿ç”¨<code>RESP</code>æ•°ç»„å‘é€å‘½ä»¤åˆ°<code>Redis</code>æœåŠ¡ç«¯ã€‚ä¸æ­¤ç›¸ä¼¼ï¼ŒæŸäº›<code>Redis</code>å‘½ä»¤æ‰§è¡Œå®Œæ¯•åæœåŠ¡ç«¯éœ€è¦ä½¿ç”¨<code>RESP</code>æ•°ç»„ç±»å‹å°†å…ƒç´ é›†åˆè¿”å›ç»™å®¢æˆ·ç«¯ï¼Œå¦‚è¿”å›ä¸€ä¸ªå…ƒç´ åˆ—è¡¨çš„<code>LRANGE</code>å‘½ä»¤ã€‚<code>RESP</code>æ•°ç»„å’Œæˆ‘ä»¬è®¤çŸ¥ä¸­çš„æ•°ç»„å¹¶ä¸å®Œå…¨ä¸€è‡´ï¼Œå®ƒçš„ç¼–ç æ ¼å¼å¦‚ä¸‹ï¼š</p><ul><li>ï¼ˆ1ï¼‰ç¬¬ä¸€ä¸ªå­—èŠ‚ä¸º<code>*</code>ã€‚</li><li>ï¼ˆ2ï¼‰ç´§æ¥ç€çš„æ˜¯ç»„æˆ<code>RESP</code>æ•°ç»„çš„å…ƒç´ ä¸ªæ•°ï¼ˆåè¿›åˆ¶æ•°ï¼Œä½†æ˜¯æœ€ç»ˆéœ€è¦è½¬æ¢ä¸ºå­—èŠ‚åºåˆ—ï¼Œå¦‚10éœ€è¦è½¬æ¢ä¸º<code>1</code>å’Œ<code>0</code>ä¸¤ä¸ªç›¸é‚»çš„å­—èŠ‚ï¼‰ï¼Œå…ƒç´ ä¸ªæ•°åˆ†å—ä»¥<code>CRLF</code>ç»ˆæ­¢ã€‚</li><li>ï¼ˆ3ï¼‰<code>RESP</code>æ•°ç»„çš„æ¯ä¸ªå…ƒç´ å†…å®¹ï¼Œæ¯ä¸ªå…ƒç´ å¯ä»¥æ˜¯ä»»æ„çš„<code>RESP</code>æ•°æ®ç±»å‹ã€‚</li></ul><p>ä¸€ä¸ªç©ºçš„<code>RESP</code>æ•°ç»„çš„ç¼–ç å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*0\r\n</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªåŒ…å«2ä¸ªå®šé•¿å­—ç¬¦ä¸²å…ƒç´ å†…å®¹åˆ†åˆ«ä¸º<code>foo</code>å’Œ<code>bar</code>çš„<code>RESP</code>æ•°ç»„çš„ç¼–ç å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*2\r\n$3\r\nfoo\r\n$3\r\nbar\r\n</span><br></pre></td></tr></table></figure><p>é€šç”¨æ ¼å¼å°±æ˜¯ï¼š<code>*&lt;count&gt;CRLF</code>ä½œä¸º<code>RESP</code>æ•°ç»„çš„å‰ç¼€éƒ¨åˆ†ï¼Œè€Œç»„æˆ<code>RESP</code>æ•°ç»„çš„å…¶ä»–æ•°æ®ç±»å‹çš„å…ƒç´ åªæ˜¯ä¸€ä¸ªæ¥ä¸€ä¸ªåœ°ä¸²è”åœ¨ä¸€èµ·ã€‚ä¾‹å¦‚ä¸€ä¸ªåŒ…å«3ä¸ªæ•´æ•°ç±»å‹å…ƒç´ çš„<code>RESP</code>æ•°ç»„çš„ç¼–ç å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*3\r\n:1\r\n:2\r\n:3\r\n</span><br></pre></td></tr></table></figure><p><code>RESP</code>æ•°ç»„çš„å…ƒç´ ä¸ä¸€å®šæ˜¯åŒä¸€ç§æ•°æ®ç±»å‹ï¼Œå¯ä»¥åŒ…å«æ··åˆç±»å‹çš„å…ƒç´ ã€‚ä¾‹å¦‚ä¸‹é¢æ˜¯ä¸€ä¸ªåŒ…å«4ä¸ªæ•´æ•°ç±»å‹å…ƒç´ å’Œ1ä¸ªå®šé•¿å­—ç¬¦ä¸²ç±»å‹å…ƒç´ ï¼ˆä¸€å…±æœ‰5ä¸ªå…ƒç´ ï¼‰çš„<code>RESP</code>æ•°ç»„çš„ç¼–ç ï¼ˆä¸ºäº†çœ‹å¾—æ›´æ¸…æ¥šï¼Œåˆ†å¤šè¡Œè¿›è¡Œç¼–ç ï¼Œå®é™…ä¸Šä¸èƒ½è¿™æ ·åšï¼‰ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> å…ƒç´ ä¸ªæ•°</span></span><br><span class="line">*5\r\n</span><br><span class="line"><span class="meta">#</span><span class="bash"> ç¬¬1ä¸ªæ•´å‹ç±»å‹çš„å…ƒç´ </span></span><br><span class="line">:1\r\n</span><br><span class="line"><span class="meta">#</span><span class="bash"> ç¬¬2ä¸ªæ•´å‹ç±»å‹çš„å…ƒç´ </span></span><br><span class="line">:2\r\n</span><br><span class="line"><span class="meta">#</span><span class="bash"> ç¬¬3ä¸ªæ•´å‹ç±»å‹çš„å…ƒç´ </span></span><br><span class="line">:3\r\n</span><br><span class="line"><span class="meta">#</span><span class="bash"> ç¬¬4ä¸ªæ•´å‹ç±»å‹çš„å…ƒç´ </span></span><br><span class="line">:4\r\n</span><br><span class="line"><span class="meta">#</span><span class="bash"> å®šé•¿å­—ç¬¦ä¸²ç±»å‹çš„å…ƒç´ </span></span><br><span class="line"><span class="meta">$</span><span class="bash">6\r\n</span></span><br><span class="line">foobar\r\n</span><br></pre></td></tr></table></figure><p><code>Redis</code>æœåŠ¡ç«¯å“åº”æŠ¥çš„é¦–è¡Œ<code>*5\r\n</code>å®šä¹‰äº†åé¢ä¼šç´§è·Ÿç€5ä¸ªå›å¤æ•°æ®ï¼Œç„¶åæ¯ä¸ªå›å¤æ•°æ®åˆ†åˆ«ä½œå…ƒç´ é¡¹ï¼Œæ„æˆäº†ç”¨äºä¼ è¾“çš„å¤šå…ƒç´ å®šé•¿å›å¤ï¼ˆ<code>Multi Bulk Reply</code>ï¼Œæ„Ÿè§‰æ¯”è¾ƒéš¾ç¿»è¯‘ï¼Œè¿™é‡Œçš„å¤§æ¦‚æ„æ€å°±æ˜¯æ¯ä¸ªå›å¤è¡Œéƒ½æ˜¯æ•´ä¸ªå›å¤æŠ¥ä¸­çš„ä¸€ä¸ªé¡¹ï¼‰ã€‚</p><p>è¿™é‡Œå¯ä»¥ç±»æ¯”ä¸º<code>Java</code>ä¸­çš„<code>ArrayList</code>ï¼ˆæ³›å‹æ“¦é™¤ï¼‰ï¼Œæœ‰ç‚¹ç±»ä¼¼äºä¸‹é¢çš„ä¼ªä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">List encode = <span class="keyword">new</span> ArrayList();</span><br><span class="line"><span class="comment">// æ·»åŠ å…ƒç´ ä¸ªæ•°</span></span><br><span class="line">encode.add(elementCount);</span><br><span class="line">encode.add(CRLF);</span><br><span class="line"><span class="comment">// æ·»åŠ ç¬¬1ä¸ªæ•´å‹ç±»å‹çš„å…ƒç´  - 1</span></span><br><span class="line">encode.add(<span class="string">':'</span>);</span><br><span class="line">encode.add(<span class="number">1</span>);</span><br><span class="line">encode.add(CRLF);</span><br><span class="line"><span class="comment">// æ·»åŠ ç¬¬2ä¸ªæ•´å‹ç±»å‹çš„å…ƒç´  - 2</span></span><br><span class="line">encode.add(<span class="string">':'</span>);</span><br><span class="line">encode.add(<span class="number">2</span>);</span><br><span class="line">encode.add(CRLF);</span><br><span class="line"><span class="comment">// æ·»åŠ ç¬¬3ä¸ªæ•´å‹ç±»å‹çš„å…ƒç´  - 3</span></span><br><span class="line">encode.add(<span class="string">':'</span>);</span><br><span class="line">encode.add(<span class="number">3</span>);</span><br><span class="line">encode.add(CRLF);</span><br><span class="line"><span class="comment">// æ·»åŠ ç¬¬4ä¸ªæ•´å‹ç±»å‹çš„å…ƒç´  - 4</span></span><br><span class="line">encode.add(<span class="string">':'</span>);</span><br><span class="line">encode.add(<span class="number">4</span>);</span><br><span class="line">encode.add(CRLF);</span><br><span class="line"><span class="comment">// æ·»åŠ å®šé•¿å­—ç¬¦ä¸²ç±»å‹çš„å…ƒç´ </span></span><br><span class="line">encode.add(<span class="string">'$'</span>);</span><br><span class="line"><span class="comment">// å‰ç¼€é•¿åº¦</span></span><br><span class="line">encode.add(<span class="number">6</span>);</span><br><span class="line"><span class="comment">// å­—ç¬¦ä¸²å†…å®¹</span></span><br><span class="line">encode.add(<span class="string">"foobar"</span>);</span><br><span class="line">encode.add(CRLF);</span><br></pre></td></tr></table></figure><p><code>RESP</code>æ•°ç»„ä¸­ä¹Ÿå­˜åœ¨<code>Null</code>å€¼çš„æ¦‚å¿µï¼Œä¸‹é¢ç§°ä¸º<code>RESP Null Array</code>ã€‚å¤„äºå†å²åŸå› ï¼Œ<code>RESP</code>æ•°ç»„ä¸­é‡‡ç”¨äº†å¦ä¸€ç§ç‰¹æ®Šçš„ç¼–ç æ ¼å¼å®šä¹‰<code>Null</code>å€¼ï¼ŒåŒºåˆ«äºå®šé•¿å­—ç¬¦ä¸²ä¸­çš„<code>Null</code>å€¼å­—ç¬¦ä¸²ã€‚ä¾‹å¦‚ï¼Œ<code>BLPOP</code>å‘½ä»¤æ‰§è¡Œè¶…æ—¶çš„æ—¶å€™ï¼Œå°±ä¼šè¿”å›ä¸€ä¸ª<code>RESP Null Array</code>ç±»å‹çš„å“åº”ã€‚<code>RESP Null Array</code>çš„ç¼–ç å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*-1\r\n</span><br></pre></td></tr></table></figure><p>å½“<code>Redis</code>æœåŠ¡ç«¯çš„å›å¤æ˜¯<code>RESP Null Array</code>ç±»å‹çš„æ—¶å€™ï¼Œå®¢æˆ·ç«¯åº”è¯¥è¿”å›ä¸€ä¸ª<code>Null</code>å¯¹è±¡ï¼Œè€Œä¸æ˜¯ä¸€ä¸ªç©ºæ•°ç»„æˆ–è€…ç©ºåˆ—è¡¨ã€‚è¿™ä¸€ç‚¹æ¯”è¾ƒé‡è¦ï¼Œå®ƒæ˜¯åŒºåˆ†å›å¤æ˜¯ç©ºæ•°ç»„ï¼ˆä¹Ÿå°±æ˜¯å‘½ä»¤æ­£ç¡®æ‰§è¡Œå®Œæ¯•ï¼Œè¿”å›ç»“æœæ­£å¸¸ï¼‰æˆ–è€…å…¶ä»–åŸå› ï¼ˆå¦‚<code>BLPOP</code>å‘½ä»¤çš„è¶…æ—¶ç­‰ï¼‰çš„å…³é”®ã€‚</p><p><code>RESP</code>æ•°ç»„çš„å…ƒç´ ä¹Ÿå¯ä»¥æ˜¯<code>RESP</code>æ•°ç»„ï¼Œä¸‹é¢æ˜¯ä¸€ä¸ªåŒ…å«2ä¸ª<code>RESP</code>æ•°ç»„ç±»å‹çš„å…ƒç´ çš„<code>RESP</code>æ•°ç»„ï¼Œç¼–ç å¦‚ä¸‹ï¼ˆä¸ºäº†çœ‹å¾—æ›´æ¸…æ¥šï¼Œåˆ†å¤šè¡Œè¿›è¡Œç¼–ç ï¼Œå®é™…ä¸Šä¸èƒ½è¿™æ ·åšï¼‰ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> å…ƒç´ ä¸ªæ•°</span></span><br><span class="line">*2\r\n</span><br><span class="line"><span class="meta">#</span><span class="bash"> ç¬¬1ä¸ªRESPæ•°ç»„å…ƒç´ </span></span><br><span class="line">*3\r\n</span><br><span class="line">:1\r\n</span><br><span class="line">:2\r\n</span><br><span class="line">:3\r\n</span><br><span class="line"><span class="meta">#</span><span class="bash"> ç¬¬2ä¸ªRESPæ•°ç»„å…ƒç´ </span></span><br><span class="line">*2\r\n</span><br><span class="line">+Foo\r\n</span><br><span class="line">-Bar\r\n</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„<code>RESP</code>æ•°ç»„çš„åŒ…å«2ä¸ª<code>RESP</code>æ•°ç»„ç±»å‹çš„å…ƒç´ ï¼Œç¬¬1ä¸ª<code>RESP</code>æ•°ç»„å…ƒç´ åŒ…å«3ä¸ªæ•´å‹ç±»å‹çš„å…ƒç´ ï¼Œè€Œç¬¬2ä¸ª<code>RESP</code>æ•°ç»„å…ƒç´ åŒ…å«1ä¸ªç®€å•å­—ç¬¦ä¸²ç±»å‹çš„å…ƒç´ å’Œ1ä¸ªé”™è¯¯æ¶ˆæ¯ç±»å‹çš„å…ƒç´ ã€‚</p><p><strong><code>RESP</code>æ•°ç»„ä¸­çš„Nullå…ƒç´ </strong></p><p><code>RESP</code>æ•°ç»„ä¸­çš„å•ä¸ªå…ƒç´ ä¹Ÿæœ‰<code>Null</code>å€¼çš„æ¦‚å¿µï¼Œä¸‹é¢ç§°ä¸º<code>Null</code>å…ƒç´ ã€‚<code>Redis</code>æœåŠ¡ç«¯å›å¤å¦‚æœæ˜¯<code>RESP</code>æ•°ç»„ç±»å‹ï¼Œå¹¶ä¸”<code>RESP</code>æ•°ç»„ä¸­å­˜åœ¨<code>Null</code>å…ƒç´ ï¼Œé‚£ä¹ˆæ„å‘³ç€å…ƒç´ ä¸¢å¤±ï¼Œç»å¯¹ä¸èƒ½ç”¨ç©ºå­—ç¬¦ä¸²æ›¿ä»£ã€‚ç¼ºå°‘æŒ‡å®šé”®çš„å‰æä¸‹ï¼Œå½“ä¸<code>GET</code>æ¨¡å¼é€‰é¡¹ä¸€èµ·ä½¿ç”¨æ—¶ï¼Œ<code>SORT</code>å‘½ä»¤å¯èƒ½ä¼šå‘ç”Ÿè¿™ç§æƒ…å†µã€‚</p><p>ä¸‹é¢æ˜¯ä¸€ä¸ªåŒ…å«<code>Null</code>å…ƒç´ çš„<code>RESP</code>æ•°ç»„çš„ä¾‹å­ï¼ˆä¸ºäº†çœ‹å¾—æ›´æ¸…æ¥šï¼Œåˆ†å¤šè¡Œè¿›è¡Œç¼–ç ï¼Œå®é™…ä¸Šä¸èƒ½è¿™æ ·åšï¼‰ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">*3\r\n</span><br><span class="line"><span class="meta">$</span><span class="bash">3\r\n</span></span><br><span class="line">foo\r\n</span><br><span class="line"><span class="meta">$</span><span class="bash">-1\r\n</span></span><br><span class="line"><span class="meta">$</span><span class="bash">3\r\n</span></span><br><span class="line">bar\r\n</span><br></pre></td></tr></table></figure><p><code>RESP</code>æ•°ç»„ä¸­çš„ç¬¬2ä¸ªå…ƒç´ æ˜¯<code>Null</code>å…ƒç´ ï¼Œå®¢æˆ·ç«¯<code>API</code>æœ€ç»ˆè¿”å›çš„å†…å®¹åº”è¯¥æ˜¯ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> Ruby</span></span><br><span class="line">["foo",nil,"bar"]</span><br><span class="line"><span class="meta">#</span><span class="bash"> Java</span></span><br><span class="line">["foo",null,"bar"]</span><br></pre></td></tr></table></figure><h2 id="RESPå…¶ä»–ç›¸å…³å†…å®¹">RESPå…¶ä»–ç›¸å…³å†…å®¹</h2><p>ä¸»è¦åŒ…æ‹¬ï¼š</p><ul><li>å°†å‘½ä»¤å‘é€åˆ°RedisæœåŠ¡ç«¯çš„ç¤ºä¾‹ã€‚</li><li>æ‰¹é‡å‘½ä»¤ä¸ç®¡é“ã€‚</li><li>å†…è”å‘½ä»¤ï¼ˆ<code>Inline Commands</code>ï¼‰ã€‚</li></ul><p>å…¶å®æ–‡æ¡£ä¸­è¿˜æœ‰ä¸€èŠ‚ä½¿ç”¨<code>C</code>è¯­è¨€ç¼–å†™é«˜æ€§èƒ½<code>RESP</code>è§£æå™¨ï¼Œè¿™é‡Œä¸åšç¿»è¯‘ï¼Œå› ä¸ºæŒæ¡<code>RESP</code>çš„ç›¸å…³å†…å®¹åï¼Œå¯ä»¥åŸºäºä»»ä½•è¯­è¨€ç¼–å†™è§£æå™¨ã€‚</p><h3 id="å°†å‘½ä»¤å‘é€åˆ°RedisæœåŠ¡ç«¯">å°†å‘½ä»¤å‘é€åˆ°RedisæœåŠ¡ç«¯</h3><p>å¦‚æœå·²ç»ç›¸å¯¹ç†Ÿæ‚‰<code>RESP</code>ä¸­çš„åºåˆ—åŒ–æ ¼å¼ï¼Œé‚£ä¹ˆç¼–å†™<code>Redis</code>å®¢æˆ·ç«¯ç±»åº“å°±ä¼šå˜å¾—å¾ˆå®¹æ˜“ã€‚æˆ‘ä»¬å¯ä»¥è¿›ä¸€æ­¥æŒ‡å®šå®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„äº¤äº’æ–¹å¼ï¼š</p><ul><li><code>Redis</code>å®¢æˆ·ç«¯å‘<code>Redis</code>æœåŠ¡ç«¯å‘é€ä»…ä»…åŒ…å«å®šé•¿å­—ç¬¦ä¸²ç±»å‹å…ƒç´ çš„<code>RESP</code>æ•°ç»„ã€‚</li><li><code>Redis</code>æœåŠ¡ç«¯å¯ä»¥é‡‡ç”¨ä»»æ„ä¸€ç§<code>RESP</code>æ•°æ®ç±»å‹å‘<code>Redis</code>å®¢æˆ·ç«¯è¿›è¡Œå›å¤ï¼Œå…·ä½“çš„æ•°æ®ç±»å‹ä¸€èˆ¬å–å†³äºå‘½ä»¤ç±»å‹ã€‚</li></ul><p>ä¸‹é¢æ˜¯å…¸å‹çš„äº¤äº’ä¾‹å­ï¼š<code>Redis</code>å®¢æˆ·ç«¯å‘é€å‘½ä»¤<code>LLEN mylist</code>ä»¥è·å¾—<code>KEY</code>ä¸º<code>mylist</code>çš„é•¿åº¦ï¼Œ<code>Redis</code>æœåŠ¡ç«¯å°†ä»¥æ•´æ•°ç±»å‹è¿›è¡Œå›å¤ï¼Œå¦‚ä»¥ä¸‹ç¤ºä¾‹æ‰€ç¤ºï¼ˆ<code>C</code>æ˜¯å®¢æˆ·ç«¯ï¼Œ<code>S</code>æœåŠ¡å™¨ï¼‰ï¼Œä¼ªä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">C: *2\r\n</span><br><span class="line">C: $4\r\n</span><br><span class="line">C: LLEN\r\n</span><br><span class="line">C: $6\r\n</span><br><span class="line">C: mylist\r\n</span><br><span class="line"></span><br><span class="line">S: :48293\r\n</span><br></pre></td></tr></table></figure><p>ä¸ºäº†ç®€å•èµ·è§ï¼Œæˆ‘ä»¬ä½¿ç”¨æ¢è¡Œç¬¦æ¥åˆ†éš”åè®®çš„ä¸åŒéƒ¨åˆ†ï¼ˆè¿™é‡ŒæŒ‡ä¸Šé¢çš„ä»£ç åˆ†è¡Œå±•ç¤ºï¼‰ï¼Œä½†æ˜¯å®é™…äº¤äº’çš„æ—¶å€™<code>Redis</code>å®¢æˆ·ç«¯åœ¨å‘é€<code>*2\r\n$4\r\nLLEN\r\n$6\r\nmylist\r\n</code>çš„æ—¶å€™æ˜¯æ•´ä½“å‘é€çš„ã€‚</p><h3 id="æ‰¹é‡å‘½ä»¤ä¸ç®¡é“">æ‰¹é‡å‘½ä»¤ä¸ç®¡é“</h3><p><code>Redis</code>å®¢æˆ·ç«¯å¯ä»¥ä½¿ç”¨ç›¸åŒçš„è¿æ¥å‘é€æ‰¹é‡å‘½ä»¤ã€‚<code>Redis</code>æ”¯æŒç®¡é“ç‰¹æ€§ï¼Œå› æ­¤<code>Redis</code>å®¢æˆ·ç«¯å¯ä»¥é€šè¿‡ä¸€æ¬¡å†™æ“ä½œå‘é€å¤šä¸ªå‘½ä»¤ï¼Œè€Œæ— éœ€åœ¨å‘é€ä¸‹ä¸€ä¸ªå‘½ä»¤ä¹‹å‰è¯»å–<code>Redis</code>æœåŠ¡ç«¯å¯¹ä¸Šä¸€ä¸ªå‘½ä»¤çš„å›å¤ã€‚æ‰¹é‡å‘é€å‘½ä»¤ä¹‹åï¼Œæ‰€æœ‰çš„å›å¤å¯ä»¥åœ¨æœ€åå¾—åˆ°ï¼ˆåˆå¹¶ä¸ºä¸€ä¸ªå›å¤ï¼‰ã€‚æ›´å¤šç›¸å…³ä¿¡æ¯å¯ä»¥æŸ¥çœ‹<a href="https://redis.io/topics/pipelining" target="_blank" rel="noopener">Using pipelining to speedup Redis queries</a>ã€‚</p><h3 id="å†…è”å‘½ä»¤">å†…è”å‘½ä»¤</h3><p>æœ‰äº›åœºæ™¯ä¸‹ï¼Œæˆ‘ä»¬å¯èƒ½åªæœ‰<code>telnet</code>å‘½ä»¤å¯ä»¥ä½¿ç”¨ï¼Œåœ¨è¿™ç§æ¡ä»¶ä¸‹ï¼Œæˆ‘ä»¬éœ€è¦å‘é€å‘½ä»¤åˆ°<code>Redis</code>æœåŠ¡ç«¯ã€‚å°½ç®¡<code>Redis</code>åè®®æ˜“äºå®ç°ï¼Œä½†åœ¨äº¤äº’å¼ä¼šè¯ä¸­å¹¶ä¸ç†æƒ³ï¼Œå¹¶ä¸”<code>redis-cli</code>æœ‰äº›æƒ…å†µä¸‹ä¸ä¸€å®šå¯ç”¨ã€‚å¤„äºè¿™ç±»åŸå› ï¼Œ<code>Redis</code>è®¾è®¡äº†ä¸€ç§ä¸“ä¸ºäººç±»è®¾è®¡çš„å‘½ä»¤æ ¼å¼ï¼Œç§°ä¸ºå†…è”å‘½ä»¤ï¼ˆ<code>Inline Command</code>æ ¼å¼ã€‚</p><p>ä»¥ä¸‹æ˜¯æœåŠ¡å™¨/å®¢æˆ·ç«¯ä½¿ç”¨å†…è”å‘½ä»¤è¿›è¡ŒèŠå¤©çš„ç¤ºä¾‹ï¼ˆSä»£è¡¨æœåŠ¡ç«¯ï¼ŒCä»£è¡¨å®¢æˆ·ç«¯ï¼‰ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">C: PING</span><br><span class="line">S: +PONG</span><br></pre></td></tr></table></figure><p>ä»¥ä¸‹æ˜¯ä½¿ç”¨å†…è”å‘½ä»¤è¿”å›æ•´æ•°çš„å¦ä¸€ä¸ªç¤ºä¾‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">C: EXISTS somekey</span><br><span class="line">S: :0</span><br></pre></td></tr></table></figure><p>åŸºæœ¬ä¸Šåªéœ€åœ¨<code>telnet</code>ä¼šè¯ä¸­ç¼–å†™ä»¥ç©ºæ ¼åˆ†éš”çš„å‚æ•°ã€‚ç”±äºé™¤äº†ç»Ÿä¸€çš„è¯·æ±‚åè®®ä¹‹å¤–æ²¡æœ‰å‘½ä»¤ä¼šä»¥<code>*</code>å¼€å¤´ï¼Œ<code>Redis</code>èƒ½å¤Ÿæ£€æµ‹åˆ°è¿™ç§æƒ…å†µå¹¶è§£æè¾“å…¥çš„å‘½ä»¤ã€‚</p><h2 id="åŸºäºRESPç¼–å†™é«˜æ€§èƒ½è§£æå™¨">åŸºäºRESPç¼–å†™é«˜æ€§èƒ½è§£æå™¨</h2><p>å› ä¸º<code>JDK</code>åŸç”Ÿæä¾›çš„å­—èŠ‚ç¼“å†²åŒº<code>java.nio.ByteBuffer</code>å­˜åœ¨ä¸èƒ½è‡ªåŠ¨æ‰©å®¹ã€éœ€è¦åˆ‡æ¢è¯»å†™æ¨¡å¼ç­‰ç­‰é—®é¢˜ï¼Œè¿™é‡Œç›´æ¥å¼•å…¥<code>Netty</code>å¹¶ä¸”ä½¿ç”¨<code>Netty</code>æä¾›çš„<code>ByteBuf</code>è¿›è¡Œ<code>RESP</code>æ•°æ®ç±»å‹è§£æã€‚ç¼–å†™æœ¬æ–‡çš„æ—¶å€™ï¼ˆ2019-10-09ï¼‰<code>Netty</code>çš„æœ€æ–°ç‰ˆæœ¬ä¸º<code>4.1.42.Final</code>ã€‚å¼•å…¥ä¾èµ–ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.netty<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>netty-buffer<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.1.42.Final<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>å®šä¹‰è§£ç å™¨æ¥å£ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RespDecoder</span>&lt;<span class="title">V</span>&gt;</span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="function">V <span class="title">decode</span><span class="params">(ByteBuf buffer)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®šä¹‰å¸¸é‡ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RespConstants</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Charset ASCII = StandardCharsets.US_ASCII;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Charset UTF_8 = StandardCharsets.UTF_8;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span> DOLLAR_BYTE = <span class="string">'$'</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span> ASTERISK_BYTE = <span class="string">'*'</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span> PLUS_BYTE = <span class="string">'+'</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span> MINUS_BYTE = <span class="string">'-'</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span> COLON_BYTE = <span class="string">':'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String EMPTY_STRING = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Long ZERO = <span class="number">0L</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Long NEGATIVE_ONE = -<span class="number">1L</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span> CR = (<span class="keyword">byte</span>) <span class="string">'\r'</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span> LF = (<span class="keyword">byte</span>) <span class="string">'\n'</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] CRLF = <span class="string">"\r\n"</span>.getBytes(ASCII);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> ReplyType &#123;</span><br><span class="line"></span><br><span class="line">        SIMPLE_STRING,</span><br><span class="line"></span><br><span class="line">        ERROR,</span><br><span class="line"></span><br><span class="line">        INTEGER,</span><br><span class="line"></span><br><span class="line">        BULK_STRING,</span><br><span class="line"></span><br><span class="line">        RESP_ARRAY</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢çš„ç« èŠ‚ä¸­è§£ææ¨¡å—çš„å®ç°å·²ç»å¿½ç•¥ç¬¬ä¸€ä¸ªå­—èŠ‚çš„è§£æï¼Œå› ä¸ºç¬¬ä¸€ä¸ªå­—èŠ‚æ˜¯å†³å®šå…·ä½“çš„æ•°æ®ç±»å‹ã€‚</p><h3 id="è§£æç®€å•å­—ç¬¦ä¸²">è§£æç®€å•å­—ç¬¦ä¸²</h3><p>ç®€å•å­—ç¬¦ä¸²ç±»å‹å°±æ˜¯å•è¡Œå­—ç¬¦ä¸²ï¼Œå®ƒçš„è§£æç»“æœå¯¹åº”çš„å°±æ˜¯<code>Java</code>ä¸­çš„<code>String</code>ç±»å‹ã€‚è§£ç å™¨å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è§£æå•è¡Œå­—ç¬¦ä¸²</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LineStringDecoder</span> <span class="keyword">implements</span> <span class="title">RespDecoder</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">decode</span><span class="params">(ByteBuf buffer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> CodecUtils.X.readLine(buffer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> CodecUtils &#123;</span><br><span class="line"></span><br><span class="line">    X;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">findLineEndIndex</span><span class="params">(ByteBuf buffer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> index = buffer.forEachByte(ByteProcessor.FIND_LF);</span><br><span class="line">        <span class="keyword">return</span> (index &gt; <span class="number">0</span> &amp;&amp; buffer.getByte(index - <span class="number">1</span>) == <span class="string">'\r'</span>) ? index : -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">readLine</span><span class="params">(ByteBuf buffer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> lineEndIndex = findLineEndIndex(buffer);</span><br><span class="line">        <span class="keyword">if</span> (lineEndIndex &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> lineStartIndex = buffer.readerIndex();</span><br><span class="line">            <span class="comment">// è®¡ç®—å­—èŠ‚é•¿åº¦</span></span><br><span class="line">            <span class="keyword">int</span> size = lineEndIndex - lineStartIndex - <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[size];</span><br><span class="line">            buffer.readBytes(bytes);</span><br><span class="line">            <span class="comment">// é‡ç½®è¯»æ¸¸æ ‡ä¸º\r\nä¹‹åçš„ç¬¬ä¸€ä¸ªå­—èŠ‚</span></span><br><span class="line">            buffer.readerIndex(lineEndIndex + <span class="number">1</span>);</span><br><span class="line">            buffer.markReaderIndex();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> String(bytes, RespConstants.UTF_8);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RespSimpleStringDecoder</span> <span class="keyword">extends</span> <span class="title">LineStringDecoder</span> </span>&#123;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡ŒæŠ½å–å‡ºä¸€ä¸ªç±»<code>LineStringDecoder</code>ç”¨äºè§£æå•è¡Œå­—ç¬¦ä¸²ï¼Œè¿™æ ·åœ¨è§£æé”™è¯¯æ¶ˆæ¯çš„æ—¶å€™å¯ä»¥åšä¸€æ¬¡ç»§æ‰¿å³å¯ã€‚æµ‹è¯•ä¸€ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    ByteBuf buffer = ByteBufAllocator.DEFAULT.buffer();</span><br><span class="line">    <span class="comment">// +OK\r\n</span></span><br><span class="line">    buffer.writeBytes(<span class="string">"+OK"</span>.getBytes(RespConstants.UTF_8));</span><br><span class="line">    buffer.writeBytes(RespConstants.CRLF);</span><br><span class="line">    String value = RespCodec.X.decode(buffer);</span><br><span class="line">    log.info(<span class="string">"Decode result:&#123;&#125;"</span>, value);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Decode result:OK</span></span><br></pre></td></tr></table></figure><h3 id="è§£æé”™è¯¯æ¶ˆæ¯">è§£æé”™è¯¯æ¶ˆæ¯</h3><p>é”™è¯¯æ¶ˆæ¯çš„æœ¬è´¨ä¹Ÿæ˜¯å•è¡Œå­—ç¬¦ä¸²ï¼Œæ‰€ä»¥å…¶è§£ç çš„å®ç°å¯ä»¥å’Œç®€å•å­—ç¬¦ä¸²çš„è§£ç å®ç°ä¸€è‡´ã€‚é”™è¯¯æ¶ˆæ¯æ•°æ®ç±»å‹çš„è§£ç å™¨å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RespErrorDecoder</span> <span class="keyword">extends</span> <span class="title">LineStringDecoder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•ä¸€ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    ByteBuf buffer = ByteBufAllocator.DEFAULT.buffer();</span><br><span class="line">    <span class="comment">// -ERR unknown command 'foobar'\r\n</span></span><br><span class="line">    buffer.writeBytes(<span class="string">"-ERR unknown command 'foobar'"</span>.getBytes(RespConstants.UTF_8));</span><br><span class="line">    buffer.writeBytes(RespConstants.CRLF);</span><br><span class="line">    String value = RespCodec.X.decode(buffer);</span><br><span class="line">    log.info(<span class="string">"Decode result:&#123;&#125;"</span>, value);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Decode result:ERR unknown command 'foobar'</span></span><br></pre></td></tr></table></figure><h3 id="è§£ææ•´å‹æ•°å­—">è§£ææ•´å‹æ•°å­—</h3><p>æ•´å‹æ•°å­—ç±»å‹ï¼Œæœ¬è´¨å°±æ˜¯éœ€è¦ä»å­—èŠ‚åºåˆ—ä¸­è¿˜åŸå‡ºå¸¦ç¬¦å·çš„64<code>bit</code>çš„é•¿æ•´å‹ï¼Œå› ä¸ºæ˜¯å¸¦ç¬¦å·çš„ï¼Œç±»å‹æ ‡è¯†ä½<code>:</code>åçš„ç¬¬ä¸€ä¸ªå­—èŠ‚éœ€è¦åˆ¤æ–­æ˜¯å¦è´Ÿæ•°å­—ç¬¦<code>-</code>ï¼Œå› ä¸ºæ˜¯ä»å·¦å‘å³è§£æï¼Œç„¶åæ¯è§£æå‡ºä¸€ä¸ªæ–°çš„ä½ï¼Œå½“å‰çš„æ•°å­—å€¼è¦ä¹˜<code>10</code>ã€‚å…¶è§£ç å™¨çš„å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RespIntegerDecoder</span> <span class="keyword">implements</span> <span class="title">RespDecoder</span>&lt;<span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">decode</span><span class="params">(ByteBuf buffer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> lineEndIndex = CodecUtils.X.findLineEndIndex(buffer);</span><br><span class="line">        <span class="comment">// æ²¡æœ‰è¡Œå°¾ï¼Œå¼‚å¸¸</span></span><br><span class="line">        <span class="keyword">if</span> (-<span class="number">1</span> == lineEndIndex) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">long</span> result = <span class="number">0L</span>;</span><br><span class="line">        <span class="keyword">int</span> lineStartIndex = buffer.readerIndex();</span><br><span class="line">        <span class="keyword">boolean</span> negative = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">byte</span> firstByte = buffer.getByte(lineStartIndex);</span><br><span class="line">        <span class="comment">// è´Ÿæ•°</span></span><br><span class="line">        <span class="keyword">if</span> (RespConstants.MINUS_BYTE == firstByte) &#123;</span><br><span class="line">            negative = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> digit = firstByte - <span class="string">'0'</span>;</span><br><span class="line">            result = result * <span class="number">10</span> + digit;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = lineStartIndex + <span class="number">1</span>; i &lt; (lineEndIndex - <span class="number">1</span>); i++) &#123;</span><br><span class="line">            <span class="keyword">byte</span> value = buffer.getByte(i);</span><br><span class="line">            <span class="keyword">int</span> digit = value - <span class="string">'0'</span>;</span><br><span class="line">            result = result * <span class="number">10</span> + digit;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (negative) &#123;</span><br><span class="line">            result = -result;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// é‡ç½®è¯»æ¸¸æ ‡ä¸º\r\nä¹‹åçš„ç¬¬ä¸€ä¸ªå­—èŠ‚</span></span><br><span class="line">        buffer.readerIndex(lineEndIndex + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•´å‹æ•°å­—ç±»å‹çš„è§£æç›¸å¯¹å¤æ‚ï¼Œä¸€å®šè¦æ³¨æ„è´Ÿæ•°åˆ¤æ–­ã€‚æµ‹è¯•ä¸€ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    ByteBuf buffer = ByteBufAllocator.DEFAULT.buffer();</span><br><span class="line">    <span class="comment">// :-1000\r\n</span></span><br><span class="line">    buffer.writeBytes(<span class="string">":-1000"</span>.getBytes(RespConstants.UTF_8));</span><br><span class="line">    buffer.writeBytes(RespConstants.CRLF);</span><br><span class="line">    Long value = RespCodec.X.decode(buffer);</span><br><span class="line">    log.info(<span class="string">"Decode result:&#123;&#125;"</span>, value);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Decode result:-1000</span></span><br></pre></td></tr></table></figure><h3 id="è§£æå®šé•¿å­—ç¬¦ä¸²">è§£æå®šé•¿å­—ç¬¦ä¸²</h3><p>å®šé•¿å­—ç¬¦ä¸²ç±»å‹è§£æçš„å…³é”®æ˜¯å…ˆè¯»å–ç±»å‹æ ‡è¯†ç¬¦<code>$</code>åçš„ç¬¬ä¸€ä¸ªå­—èŠ‚åºåˆ—åˆ†å—è§£ææˆ64<code>bit</code>å¸¦ç¬¦å·çš„æ•´æ•°ï¼Œç”¨æ¥ç¡®å®šåé¢éœ€è¦è§£æçš„å­—ç¬¦ä¸²å†…å®¹çš„å­—èŠ‚é•¿åº¦ï¼Œç„¶åå†æŒ‰ç…§è¯¥é•¿åº¦è¯»å–åé¢çš„å­—èŠ‚ã€‚å…¶è§£ç å™¨å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RespBulkStringDecoder</span> <span class="keyword">implements</span> <span class="title">RespDecoder</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">decode</span><span class="params">(ByteBuf buffer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> lineEndIndex = CodecUtils.X.findLineEndIndex(buffer);</span><br><span class="line">        <span class="keyword">if</span> (-<span class="number">1</span> == lineEndIndex) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ä½¿ç”¨RespIntegerDecoderè¯»å–é•¿åº¦</span></span><br><span class="line">        Long length = (Long) DefaultRespCodec.DECODERS.get(ReplyType.INTEGER).decode(buffer);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == length) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Bulk Null String</span></span><br><span class="line">        <span class="keyword">if</span> (RespConstants.NEGATIVE_ONE.equals(length)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Bulk Empty String</span></span><br><span class="line">        <span class="keyword">if</span> (RespConstants.ZERO.equals(length)) &#123;</span><br><span class="line">            <span class="keyword">return</span> RespConstants.EMPTY_STRING;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// çœŸå®å­—èŠ‚å†…å®¹çš„é•¿åº¦</span></span><br><span class="line">        <span class="keyword">int</span> readLength = (<span class="keyword">int</span>) length.longValue();</span><br><span class="line">        <span class="keyword">if</span> (buffer.readableBytes() &gt; readLength) &#123;</span><br><span class="line">            <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[readLength];</span><br><span class="line">            buffer.readBytes(bytes);</span><br><span class="line">            <span class="comment">// é‡ç½®è¯»æ¸¸æ ‡ä¸º\r\nä¹‹åçš„ç¬¬ä¸€ä¸ªå­—èŠ‚</span></span><br><span class="line">            buffer.readerIndex(buffer.readerIndex() + <span class="number">2</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> String(bytes, RespConstants.UTF_8);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•ä¸€ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>&#123;</span><br><span class="line">    ByteBuf buffer = ByteBufAllocator.DEFAULT.buffer();</span><br><span class="line">    <span class="comment">// $6\r\nthrowable\r\n</span></span><br><span class="line">    buffer = ByteBufAllocator.DEFAULT.buffer();</span><br><span class="line">    buffer.writeBytes(<span class="string">"$9"</span>.getBytes(RespConstants.UTF_8));</span><br><span class="line">    buffer.writeBytes(RespConstants.CRLF);</span><br><span class="line">    buffer.writeBytes(<span class="string">"throwable"</span>.getBytes(RespConstants.UTF_8));</span><br><span class="line">    buffer.writeBytes(RespConstants.CRLF);</span><br><span class="line">    String value = RespCodec.X.decode(buffer);</span><br><span class="line">    log.info(<span class="string">"Decode result:&#123;&#125;"</span>, value);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Decode result:throwable</span></span><br></pre></td></tr></table></figure><h3 id="è§£æRESPæ•°ç»„">è§£æRESPæ•°ç»„</h3><p><code>RESP</code>æ•°ç»„ç±»å‹è§£æçš„å…³é”®ï¼š</p><ul><li>å…ˆè¯»å–ç±»å‹æ ‡è¯†ç¬¦<code>*</code>åçš„ç¬¬ä¸€ä¸ªå­—èŠ‚åºåˆ—åˆ†å—è§£ææˆ64<code>bit</code>å¸¦ç¬¦å·çš„æ•´æ•°ï¼Œç¡®å®šæ•°ç»„ä¸­çš„å…ƒç´ ä¸ªæ•°ã€‚</li><li>é€’å½’è§£ææ¯ä¸ªå…ƒç´ ã€‚</li></ul><p>å‚è€ƒè¿‡ä¸å°‘<code>Redis</code>åè®®è§£ææ¡†æ¶ï¼Œä¸å°‘æ˜¯ç”¨æ ˆæˆ–è€…çŠ¶æ€æœºå®ç°ï¼Œè¿™é‡Œå…ˆç®€å•ç‚¹ç”¨é€’å½’å®ç°ï¼Œè§£ç å™¨ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RespArrayDecoder</span> <span class="keyword">implements</span> <span class="title">RespDecoder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">decode</span><span class="params">(ByteBuf buffer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> lineEndIndex = CodecUtils.X.findLineEndIndex(buffer);</span><br><span class="line">        <span class="keyword">if</span> (-<span class="number">1</span> == lineEndIndex) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è§£æå…ƒç´ ä¸ªæ•°</span></span><br><span class="line">        Long length = (Long) DefaultRespCodec.DECODERS.get(ReplyType.INTEGER).decode(buffer);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == length) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Null Array</span></span><br><span class="line">        <span class="keyword">if</span> (RespConstants.NEGATIVE_ONE.equals(length)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Array Empty List</span></span><br><span class="line">        <span class="keyword">if</span> (RespConstants.ZERO.equals(length)) &#123;</span><br><span class="line">            <span class="keyword">return</span> Lists.newArrayList();</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;Object&gt; result = Lists.newArrayListWithCapacity((<span class="keyword">int</span>) length.longValue());</span><br><span class="line">        <span class="comment">// é€’å½’</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">            result.add(DefaultRespCodec.X.decode(buffer));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æµ‹è¯•ä¸€ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    ByteBuf buffer = ByteBufAllocator.DEFAULT.buffer();</span><br><span class="line">    <span class="comment">//*2\r\n$3\r\nfoo\r\n$3\r\nbar\r\n</span></span><br><span class="line">    buffer = ByteBufAllocator.DEFAULT.buffer();</span><br><span class="line">    buffer.writeBytes(<span class="string">"*2"</span>.getBytes(RespConstants.UTF_8));</span><br><span class="line">    buffer.writeBytes(RespConstants.CRLF);</span><br><span class="line">    buffer.writeBytes(<span class="string">"$3"</span>.getBytes(RespConstants.UTF_8));</span><br><span class="line">    buffer.writeBytes(RespConstants.CRLF);</span><br><span class="line">    buffer.writeBytes(<span class="string">"foo"</span>.getBytes(RespConstants.UTF_8));</span><br><span class="line">    buffer.writeBytes(RespConstants.CRLF);</span><br><span class="line">    buffer.writeBytes(<span class="string">"$3"</span>.getBytes(RespConstants.UTF_8));</span><br><span class="line">    buffer.writeBytes(RespConstants.CRLF);</span><br><span class="line">    buffer.writeBytes(<span class="string">"bar"</span>.getBytes(RespConstants.UTF_8));</span><br><span class="line">    buffer.writeBytes(RespConstants.CRLF);</span><br><span class="line">    List value = RespCodec.X.decode(buffer);</span><br><span class="line">    log.info(<span class="string">"Decode result:&#123;&#125;"</span>, value);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Decode result:[foo, bar]</span></span><br></pre></td></tr></table></figure><h2 id="å°ç»“">å°ç»“</h2><p>å¯¹<code>RESP</code>çš„å†…å®¹å’Œå…¶ç¼–ç è§£ç çš„è¿‡ç¨‹æœ‰ç›¸å¯¹æ·±åˆ»çš„è®¤è¯†åï¼Œå°±å¯ä»¥åŸºäº<code>Netty</code>ç¼–å†™<code>Redis</code>æœåŠ¡çš„ç¼–ç è§£ç æ¨¡å—ï¼Œä½œä¸º<code>Netty</code>å…¥é—¨çš„ååˆ†æœ‰æ„ä¹‰çš„ä¾‹å­ã€‚æœ¬æ–‡çš„æœ€åä¸€èŠ‚åªæ¼”ç¤ºäº†<code>RESP</code>çš„è§£ç éƒ¨åˆ†ï¼Œç¼–ç æ¨¡å—å’Œæ›´å¤šç»†èŠ‚ä¼šåœ¨å¦ä¸€ç¯‡ç”¨<code>Netty</code>å®ç°<code>Redis</code>å®¢æˆ·ç«¯çš„æ–‡ç« ä¸­å±•ç¤ºã€‚</p><p>å‚è€ƒèµ„æ–™ï¼š</p><ul><li><a href="https://redis.io/topics/protocol" target="_blank" rel="noopener">Redis Protocol specification</a></li></ul><h2 id="é™„å½•">é™„å½•</h2><p>æœ¬æ–‡æ¶‰åŠçš„æ‰€æœ‰ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RespConstants</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Charset ASCII = StandardCharsets.US_ASCII;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Charset UTF_8 = StandardCharsets.UTF_8;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span> DOLLAR_BYTE = <span class="string">'$'</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span> ASTERISK_BYTE = <span class="string">'*'</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span> PLUS_BYTE = <span class="string">'+'</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span> MINUS_BYTE = <span class="string">'-'</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span> COLON_BYTE = <span class="string">':'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String EMPTY_STRING = <span class="string">""</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Long ZERO = <span class="number">0L</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Long NEGATIVE_ONE = -<span class="number">1L</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span> CR = (<span class="keyword">byte</span>) <span class="string">'\r'</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span> LF = (<span class="keyword">byte</span>) <span class="string">'\n'</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] CRLF = <span class="string">"\r\n"</span>.getBytes(ASCII);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">enum</span> ReplyType &#123;</span><br><span class="line"></span><br><span class="line">        SIMPLE_STRING,</span><br><span class="line"></span><br><span class="line">        ERROR,</span><br><span class="line"></span><br><span class="line">        INTEGER,</span><br><span class="line"></span><br><span class="line">        BULK_STRING,</span><br><span class="line"></span><br><span class="line">        RESP_ARRAY</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> CodecUtils &#123;</span><br><span class="line"></span><br><span class="line">    X;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">findLineEndIndex</span><span class="params">(ByteBuf buffer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> index = buffer.forEachByte(ByteProcessor.FIND_LF);</span><br><span class="line">        <span class="keyword">return</span> (index &gt; <span class="number">0</span> &amp;&amp; buffer.getByte(index - <span class="number">1</span>) == <span class="string">'\r'</span>) ? index : -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">readLine</span><span class="params">(ByteBuf buffer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> lineEndIndex = findLineEndIndex(buffer);</span><br><span class="line">        <span class="keyword">if</span> (lineEndIndex &gt; -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> lineStartIndex = buffer.readerIndex();</span><br><span class="line">            <span class="comment">// è®¡ç®—å­—èŠ‚é•¿åº¦</span></span><br><span class="line">            <span class="keyword">int</span> size = lineEndIndex - lineStartIndex - <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[size];</span><br><span class="line">            buffer.readBytes(bytes);</span><br><span class="line">            <span class="comment">// é‡ç½®è¯»æ¸¸æ ‡ä¸º\r\nä¹‹åçš„ç¬¬ä¸€ä¸ªå­—èŠ‚</span></span><br><span class="line">            buffer.readerIndex(lineEndIndex + <span class="number">1</span>);</span><br><span class="line">            buffer.markReaderIndex();</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> String(bytes, RespConstants.UTF_8);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RespCodec</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    RespCodec X = DefaultRespCodec.X;</span><br><span class="line"></span><br><span class="line">    &lt;IN, OUT&gt; <span class="function">OUT <span class="title">decode</span><span class="params">(ByteBuf buffer)</span></span>;</span><br><span class="line"></span><br><span class="line">    &lt;IN, OUT&gt; <span class="function">ByteBuf <span class="title">encode</span><span class="params">(IN in)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> DefaultRespCodec implements RespCodec &#123;</span><br><span class="line"></span><br><span class="line">    X;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> Map&lt;ReplyType, RespDecoder&gt; DECODERS = Maps.newConcurrentMap();</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> RespDecoder DEFAULT_DECODER = <span class="keyword">new</span> DefaultRespDecoder();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        DECODERS.put(ReplyType.SIMPLE_STRING, <span class="keyword">new</span> RespSimpleStringDecoder());</span><br><span class="line">        DECODERS.put(ReplyType.ERROR, <span class="keyword">new</span> RespErrorDecoder());</span><br><span class="line">        DECODERS.put(ReplyType.INTEGER, <span class="keyword">new</span> RespIntegerDecoder());</span><br><span class="line">        DECODERS.put(ReplyType.BULK_STRING, <span class="keyword">new</span> RespBulkStringDecoder());</span><br><span class="line">        DECODERS.put(ReplyType.RESP_ARRAY, <span class="keyword">new</span> RespArrayDecoder());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;IN, OUT&gt; <span class="function">OUT <span class="title">decode</span><span class="params">(ByteBuf buffer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (OUT) DECODERS.getOrDefault(determineReplyType(buffer), DEFAULT_DECODER).decode(buffer);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> ReplyType <span class="title">determineReplyType</span><span class="params">(ByteBuf buffer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">byte</span> firstByte = buffer.readByte();</span><br><span class="line">        ReplyType replyType;</span><br><span class="line">        <span class="keyword">switch</span> (firstByte) &#123;</span><br><span class="line">            <span class="keyword">case</span> RespConstants.PLUS_BYTE:</span><br><span class="line">                replyType = ReplyType.SIMPLE_STRING;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> RespConstants.MINUS_BYTE:</span><br><span class="line">                replyType = ReplyType.ERROR;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> RespConstants.COLON_BYTE:</span><br><span class="line">                replyType = ReplyType.INTEGER;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> RespConstants.DOLLAR_BYTE:</span><br><span class="line">                replyType = ReplyType.BULK_STRING;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> RespConstants.ASTERISK_BYTE:</span><br><span class="line">                replyType = ReplyType.RESP_ARRAY;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">default</span>: &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"first byte:"</span> + firstByte);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> replyType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> &lt;IN, OUT&gt; <span class="function">ByteBuf <span class="title">encode</span><span class="params">(IN in)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// TODO</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">"encode"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RespDecoder</span>&lt;<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function">V <span class="title">decode</span><span class="params">(ByteBuf buffer)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DefaultRespDecoder</span> <span class="keyword">implements</span> <span class="title">RespDecoder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">decode</span><span class="params">(ByteBuf buffer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"decoder"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LineStringDecoder</span> <span class="keyword">implements</span> <span class="title">RespDecoder</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">decode</span><span class="params">(ByteBuf buffer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> CodecUtils.X.readLine(buffer);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RespSimpleStringDecoder</span> <span class="keyword">extends</span> <span class="title">LineStringDecoder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RespErrorDecoder</span> <span class="keyword">extends</span> <span class="title">LineStringDecoder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RespIntegerDecoder</span> <span class="keyword">implements</span> <span class="title">RespDecoder</span>&lt;<span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Long <span class="title">decode</span><span class="params">(ByteBuf buffer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> lineEndIndex = CodecUtils.X.findLineEndIndex(buffer);</span><br><span class="line">        <span class="comment">// æ²¡æœ‰è¡Œå°¾ï¼Œå¼‚å¸¸</span></span><br><span class="line">        <span class="keyword">if</span> (-<span class="number">1</span> == lineEndIndex) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">long</span> result = <span class="number">0L</span>;</span><br><span class="line">        <span class="keyword">int</span> lineStartIndex = buffer.readerIndex();</span><br><span class="line">        <span class="keyword">boolean</span> negative = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">byte</span> firstByte = buffer.getByte(lineStartIndex);</span><br><span class="line">        <span class="comment">// è´Ÿæ•°</span></span><br><span class="line">        <span class="keyword">if</span> (RespConstants.MINUS_BYTE == firstByte) &#123;</span><br><span class="line">            negative = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">int</span> digit = firstByte - <span class="string">'0'</span>;</span><br><span class="line">            result = result * <span class="number">10</span> + digit;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = lineStartIndex + <span class="number">1</span>; i &lt; (lineEndIndex - <span class="number">1</span>); i++) &#123;</span><br><span class="line">            <span class="keyword">byte</span> value = buffer.getByte(i);</span><br><span class="line">            <span class="keyword">int</span> digit = value - <span class="string">'0'</span>;</span><br><span class="line">            result = result * <span class="number">10</span> + digit;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (negative) &#123;</span><br><span class="line">            result = -result;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// é‡ç½®è¯»æ¸¸æ ‡ä¸º\r\nä¹‹åçš„ç¬¬ä¸€ä¸ªå­—èŠ‚</span></span><br><span class="line">        buffer.readerIndex(lineEndIndex + <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RespBulkStringDecoder</span> <span class="keyword">implements</span> <span class="title">RespDecoder</span>&lt;<span class="title">String</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">decode</span><span class="params">(ByteBuf buffer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> lineEndIndex = CodecUtils.X.findLineEndIndex(buffer);</span><br><span class="line">        <span class="keyword">if</span> (-<span class="number">1</span> == lineEndIndex) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        Long length = (Long) DefaultRespCodec.DECODERS.get(ReplyType.INTEGER).decode(buffer);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == length) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Bulk Null String</span></span><br><span class="line">        <span class="keyword">if</span> (RespConstants.NEGATIVE_ONE.equals(length)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Bulk Empty String</span></span><br><span class="line">        <span class="keyword">if</span> (RespConstants.ZERO.equals(length)) &#123;</span><br><span class="line">            <span class="keyword">return</span> RespConstants.EMPTY_STRING;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// çœŸå®å­—èŠ‚å†…å®¹çš„é•¿åº¦</span></span><br><span class="line">        <span class="keyword">int</span> readLength = (<span class="keyword">int</span>) length.longValue();</span><br><span class="line">        <span class="keyword">if</span> (buffer.readableBytes() &gt; readLength) &#123;</span><br><span class="line">            <span class="keyword">byte</span>[] bytes = <span class="keyword">new</span> <span class="keyword">byte</span>[readLength];</span><br><span class="line">            buffer.readBytes(bytes);</span><br><span class="line">            <span class="comment">// é‡ç½®è¯»æ¸¸æ ‡ä¸º\r\nä¹‹åçš„ç¬¬ä¸€ä¸ªå­—èŠ‚</span></span><br><span class="line">            buffer.readerIndex(buffer.readerIndex() + <span class="number">2</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> String(bytes, RespConstants.UTF_8);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RespArrayDecoder</span> <span class="keyword">implements</span> <span class="title">RespDecoder</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">decode</span><span class="params">(ByteBuf buffer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> lineEndIndex = CodecUtils.X.findLineEndIndex(buffer);</span><br><span class="line">        <span class="keyword">if</span> (-<span class="number">1</span> == lineEndIndex) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è§£æå…ƒç´ ä¸ªæ•°</span></span><br><span class="line">        Long length = (Long) DefaultRespCodec.DECODERS.get(ReplyType.INTEGER).decode(buffer);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == length) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Null Array</span></span><br><span class="line">        <span class="keyword">if</span> (RespConstants.NEGATIVE_ONE.equals(length)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Array Empty List</span></span><br><span class="line">        <span class="keyword">if</span> (RespConstants.ZERO.equals(length)) &#123;</span><br><span class="line">            <span class="keyword">return</span> Lists.newArrayList();</span><br><span class="line">        &#125;</span><br><span class="line">        List&lt;Object&gt; result = Lists.newArrayListWithCapacity((<span class="keyword">int</span>) length.longValue());</span><br><span class="line">        <span class="comment">// é€’å½’</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; length; i++) &#123;</span><br><span class="line">            result.add(DefaultRespCodec.X.decode(buffer));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ï¼ˆæœ¬æ–‡å®Œ e-a-20191009 c-2-dï¼‰</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰æ&quot;&gt;å‰æ&lt;/h2&gt;
&lt;p&gt;æœ€è¿‘å­¦ä¹ &lt;code&gt;Netty&lt;/code&gt;çš„æ—¶å€™æƒ³åšä¸€ä¸ªåŸºäº&lt;code&gt;Redis&lt;/code&gt;æœåŠ¡åè®®çš„ç¼–ç è§£ç æ¨¡å—ï¼Œè¿‡ç¨‹ä¸­é¡ºä¾¿é˜…è¯»äº†&lt;code&gt;Redis&lt;/code&gt;æœåŠ¡åºåˆ—åŒ–åè®®&lt;code&gt;RESP&lt;/code&gt;ï¼Œç»“åˆè‡ªå·±çš„ç†è§£å¯¹æ–‡æ¡£è¿›è¡Œäº†ç¿»è¯‘å¹¶ä¸”ç®€å•å®ç°äº†&lt;code&gt;RESP&lt;/code&gt;åŸºäº&lt;code&gt;Java&lt;/code&gt;è¯­è¨€çš„è§£æã€‚ç¼–å†™æœ¬æ–‡çš„ä½¿ç”¨ä½¿ç”¨çš„&lt;code&gt;JDK&lt;/code&gt;ç‰ˆæœ¬ä¸º&lt;code&gt;[8+]&lt;/code&gt;ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Middleware" scheme="http://throwable.club/blog/categories/Middleware/"/>
    
      <category term="Redis" scheme="http://throwable.club/blog/categories/Middleware/Redis/"/>
    
    
      <category term="Middleware" scheme="http://throwable.club/blog/tags/Middleware/"/>
    
      <category term="Redis" scheme="http://throwable.club/blog/tags/Redis/"/>
    
  </entry>
  
  <entry>
    <title>Redis5.xå“¨å…µæ­å»ºæ‰‹è®°</title>
    <link href="http://throwable.club/2019/10/07/redis-server-sentinel-install-guide/"/>
    <id>http://throwable.club/2019/10/07/redis-server-sentinel-install-guide/</id>
    <published>2019-10-06T17:48:24.000Z</published>
    <updated>2019-11-28T17:01:08.179Z</updated>
    
    <content type="html"><![CDATA[<h2 id="å‰æ">å‰æ</h2><p><code>Redis5.x</code>ä¹‹åï¼Œå•æœºã€å“¨å…µã€é›†ç¾¤æ­å»ºçš„éš¾åº¦å·²ç»ç®€åŒ–ã€‚é‰´äºç›®å‰çœ‹åˆ°å¤ªå¤šæ–‡ç« éƒ½æ˜¯å¤åˆ¶ç²˜è´´ä»¥å¾€ä¸€äº›<code>3.x</code>ç‰ˆæœ¬çš„ä¸€äº›å†…å®¹ï¼Œæ‰€ä»¥æ‰“ç®—åŸºäºå½“å‰<code>Redis</code>çš„æœ€æ–°ç‰ˆæœ¬åšä¸€æ¬¡å•æœºã€å“¨å…µå’Œé›†ç¾¤çš„æ­å»ºï¼Œè®°å½•ä¸€ä¸‹è¿‡ç¨‹æ­¥éª¤å’Œé‡åˆ°çš„é—®é¢˜ã€‚ç¼–å†™æœ¬æ–‡çš„æ—¶é—´æ˜¯2019å¹´10æœˆ6æ—¥ï¼ˆå›½åº†å‡æœŸâ€¦ï¼‰ï¼Œå½“å‰<code>Redis</code>çš„æœ€æ–°ç‰ˆæœ¬ä¸º<strong>5.0.5</strong>ã€‚æ“ä½œç³»ç»Ÿç”¨çš„æ˜¯è™šæ‹Ÿæœºé‡Œé¢å®‰è£…çš„<code>CentOS 7</code>ã€‚å…ˆç¡®å®šå·²ç»å®‰è£…å¥½<code>Redis</code>æœåŠ¡ï¼Œå¯ä»¥å‚è€ƒç¬”è€…å†™çš„å‰ä¸€ç¯‡æ–‡ç« ï¼š<a href="http://www.throwable.club/2019/10/06/redis-server-single-install-guide" target="_blank" rel="noopener">ã€ŠRedis5.xå•æœºæœåŠ¡æ­å»ºæ‰‹è®°ã€‹</a>ã€‚å‡ºäºä¹¦å†™ä¹ æƒ¯ï¼Œæœ¬æ–‡æœ‰å¯èƒ½æŠŠå“¨å…µç§°ä¸º<code>Sentinel</code>ã€<code>Redis Sentinel</code>ã€å“¨å…µæˆ–è€…<code>Redis</code>å“¨å…µï¼Œè¿™å››ä¸ªåè¯æ˜¯ç­‰ä»·çš„ã€‚</p><a id="more"></a><h2 id="å“¨å…µç®€ä»‹">å“¨å…µç®€ä»‹</h2><p>ä¸€å®šè¦æœ‰ä¸€ä¸ªæ¦‚å¿µï¼šå“¨å…µå®ä¾‹ä¹Ÿæ˜¯ç‰¹æ®Šçš„<code>Redis</code>å®ä¾‹ï¼Œä¹Ÿå°±æ˜¯å“¨å…µå®ä¾‹æ˜¯ç‹¬ç«‹çš„è¿›ç¨‹ï¼Œå¤šä¸ªå“¨å…µå®ä¾‹å¯ä»¥æ­å»ºä¸»ä»ï¼ˆ<code>Master-Slave</code>ï¼‰ï¼Œå®ƒä»¬æ‰¿æ‹…çš„èŒè´£å’Œæ™®é€šçš„<code>Redis</code>å®ä¾‹ä¸ä¸€æ ·ã€‚ä¸‹é¢æ˜¯å®˜æ–¹æ–‡æ¡£ä¸­å¯¹å“¨å…µçš„ä»‹ç»ï¼š</p><p><code>Redis</code>å“¨å…µä¸º<code>Redis</code>æä¾›äº†é«˜å¯ç”¨æ€§ï¼Œæ„å‘³ç€å¯ä»¥ä½¿ç”¨å“¨å…µåˆ›å»º<code>Redis</code>æœåŠ¡éƒ¨ç½²ï¼Œè¯¥éƒ¨ç½²å¯ä»¥åœ¨æ— éœ€äººå·¥å¹²é¢„çš„æƒ…å†µä¸‹æŠµå¾¡æŸäº›ç±»å‹çš„æ•…éšœã€‚<code>Redis</code>å“¨å…µè¿˜æä¾›å…¶ä»–åŠŸèƒ½ï¼Œå¦‚ç›‘è§†ã€é€šçŸ¥ï¼Œå¹¶ä¸”ä¸ºå®¢æˆ·ç«¯æä¾›é…ç½®å…¥å£ï¼ˆ<code>acts as a configuration provider for clients</code>ï¼‰ã€‚ä¸‹é¢æ˜¯<code>Redis</code>å“¨å…µæä¾›çš„å®Œæ•´åŠŸèƒ½åˆ—è¡¨ï¼š</p><ul><li>ç›‘æ§ï¼ˆ<code>Monitoring</code>ï¼‰ï¼š<code>Sentinel</code>ä¼šä¸æ–­æ£€æŸ¥<code>Master</code>å®ä¾‹å’Œ<code>Slave</code>å®ä¾‹æ˜¯å¦æŒ‰é¢„æœŸå·¥ä½œã€‚</li><li>é€šçŸ¥ï¼ˆ<code>Notification</code>ï¼‰ï¼š<code>Sentinel</code>å¯ä»¥é€šè¿‡APIè¿›è¡Œé€šçŸ¥å—ç›‘æ§çš„<code>Redis</code>å®ä¾‹å‡ºç°é—®é¢˜ã€‚</li><li>è‡ªåŠ¨æ•…éšœè½¬ç§»ï¼ˆ<code>Automatic Failover</code>ï¼‰ï¼šå¦‚æœ<code>Master</code>å®ä¾‹æœªæŒ‰é¢„æœŸå·¥ä½œï¼Œåˆ™<code>Sentinel</code>å¯ä»¥å¯åŠ¨æ•…éšœè½¬ç§»ç¨‹åºï¼Œåœ¨è¯¥è¿‡ç¨‹ä¸­ï¼Œä¼šå°†ä¸€ä¸ª<code>Slave</code>å®ä¾‹æå‡ä¸º<code>Master</code>å®ä¾‹ï¼Œå°†å…¶ä»–<code>Slave</code>å®ä¾‹é‡æ–°é…ç½®ä¸ºä½¿ç”¨æ–°çš„<code>Master</code>å®ä¾‹ï¼Œå¹¶ä¸”ä¼šé€šçŸ¥ä½¿ç”¨<code>Redis</code>å®ä¾‹çš„åº”ç”¨ç¨‹åºè·å–æ–°çš„åœ°å€ã€è¿æ¥ä¿¡æ¯ã€‚</li><li>æä¾›é…ç½®å…¥å£ï¼ˆ<code>Configuration provider</code>ï¼‰ï¼š<code>Sentinel</code>å……å½“å®¢æˆ·ç«¯æœåŠ¡å‘ç°çš„æˆæƒæ¥æºï¼ˆ<code>a source of authority</code>ï¼‰ï¼šå®¢æˆ·ç«¯è¿æ¥åˆ°<code>Sentinel</code>ï¼Œå¯ä»¥è¯¢é—®<code>Redis</code>æœåŠ¡ç¾¤ä¸­çš„<code>Master</code>å®ä¾‹çš„åœ°å€ã€‚å¦‚æœå‘ç”Ÿæ•…éšœè½¬ç§»ï¼Œ<code>Sentinel</code>å°†é€šçŸ¥å®¢æˆ·ç«¯æ–°çš„<code>Master</code>å®ä¾‹çš„åœ°å€ã€‚</li></ul><p><strong>Sentinelçš„åˆ†å¸ƒå¼æ€§è´¨</strong></p><p><code>Redis Sentinel</code>æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿï¼Œ<code>Sentinel</code>é‡‡ç”¨åŒä¸€ä»½é…ç½®å¤šä¸ª<code>Sentinel</code>è¿›ç¨‹å…±åŒåä½œè¿è¡Œçš„è®¾è®¡ï¼Œå¤š<code>Sentinel</code>è¿›ç¨‹åä½œçš„ä¼˜åŠ¿å¦‚ä¸‹ï¼š</p><ul><li>å¤šä¸ª<code>Sentinel</code>å®ä¾‹å°±ç»™å®šçš„ä¸»æœºä¸å†å¯ç”¨è¿™ä¸€äº‹å®è¾¾æˆå…±è¯†æ—¶ï¼Œå°†æ‰§è¡Œæ•…éšœæ£€æµ‹ï¼Œä»è€Œé™ä½äº†è¯¯æŠ¥çš„å¯èƒ½æ€§ã€‚</li><li><code>Sentinel</code>ç¾¤ä¸­å³ä½¿ä¸æ˜¯æ‰€æœ‰<code>Sentinel</code>å¤„äºå¯ç”¨çŠ¶æ€ï¼Œ<code>Sentinel</code>ç¾¤ä»ç„¶èƒ½å¤Ÿæ­£å¸¸å·¥ä½œï¼Œè¿›è¡Œæ•…éšœè½¬ç§»ã€‚</li></ul><h2 id="å“¨å…µæ­å»º">å“¨å…µæ­å»º</h2><p>å½“å‰çš„<code>Redis</code>å“¨å…µç‰ˆæœ¬ç§°ä¸º<strong>å“¨å…µ2</strong>ï¼Œå“¨å…µç‰ˆæœ¬1æ˜¯<code>Redis 2.6</code>çš„æ—¶å€™å¼•å…¥ï¼Œç°åœ¨å·²ç»è¿‡æœŸï¼Œä¸æ¨èä½¿ç”¨ã€‚å®˜æ–¹æ–‡æ¡£ä¸­éƒ¨ç½²å“¨å…µçš„ç¤ºä¾‹ä¸­æŒ‡å‡ºï¼š<strong>ä¸€ä¸ªå¥å£®çš„éƒ¨ç½²è‡³å°‘éœ€è¦ä¸‰ä¸ªSentinelå®ä¾‹</strong>ã€‚å†åŠ ä¸Šä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæ™®é€šçš„<code>Redis</code>æœåŠ¡å®ä¾‹ä¸ºäº†ä¿è¯å¥å£®æ€§éœ€è¦æ­å»º<strong>æ ‘çŠ¶ä¸»ä»</strong>ï¼Œè‡³å°‘å»ºè®®éƒ¨ç½²ä¸‰ä¸ªå®ä¾‹ã€‚è¿™é‡Œçš„éƒ¨ç½²æ‹“æ‰‘å›¾å¦‚ä¸‹ï¼š</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201910/r-s-i-g-1.png" alt=""></p><h3 id="ç¯å¢ƒé…ç½®">ç¯å¢ƒé…ç½®</h3><p>æŒ‰ç…§éƒ¨ç½²æ‹“æ‰‘å›¾ï¼Œä¸€å…±éƒ¨ç½²6ä¸ª<code>Redis</code>å®ä¾‹ï¼Œ3ä¸ªæ™®é€šçš„<code>Redis</code>å®ä¾‹ç»„æˆ<code>Master-Slave</code>ï¼Œå¹¶ä¸”æ˜¯<strong>æ ‘çŠ¶ä¸»ä»</strong>ï¼Œ3ä¸ª<code>Redis</code>å“¨å…µå®ä¾‹ã€‚ä¸ºäº†ç®€å•èµ·è§ï¼Œ6ä¸ª<code>Redis</code>å®ä¾‹éƒ¨ç½²åœ¨åŒä¸€ä¸ªè™šæ‹Ÿæœºä¸­ï¼Œæ³¨æ„åœ¨ç”Ÿäº§æˆ–è€…æµ‹è¯•ç¯å¢ƒè¦åˆ†æ•£æœºå™¨éƒ¨ç½²ï¼Œé¿å…æ‰€æœ‰é¸¡è›‹æ”¾åœ¨åŒä¸€ä¸ªç¯®å­å‡ºç°æœºå™¨å•ç‚¹æ•…éšœã€‚å…·ä½“ä¿¡æ¯å¦‚ä¸‹ï¼š</p><table><thead><tr><th style="text-align:center">å®ä¾‹æ ‡è¯†</th><th style="text-align:center">è§’è‰²</th><th style="text-align:center">ä¸»æœºIP</th><th style="text-align:center">ç«¯å£</th><th style="text-align:center">å¤‡æ³¨</th></tr></thead><tbody><tr><td style="text-align:center"><code>Sentinel-1</code></td><td style="text-align:center">-</td><td style="text-align:center"><code>192.168.56.200</code></td><td style="text-align:center">26379</td><td style="text-align:center">-</td></tr><tr><td style="text-align:center"><code>Sentinel-2</code></td><td style="text-align:center">-</td><td style="text-align:center"><code>192.168.56.200</code></td><td style="text-align:center">26380</td><td style="text-align:center">-</td></tr><tr><td style="text-align:center"><code>Sentinel-3</code></td><td style="text-align:center">-</td><td style="text-align:center"><code>192.168.56.200</code></td><td style="text-align:center">26381</td><td style="text-align:center">-</td></tr><tr><td style="text-align:center"><code>Redis-1</code></td><td style="text-align:center"><code>Master</code></td><td style="text-align:center"><code>192.168.56.200</code></td><td style="text-align:center">6380</td><td style="text-align:center">-</td></tr><tr><td style="text-align:center"><code>Redis-11</code></td><td style="text-align:center"><code>Slave</code></td><td style="text-align:center"><code>192.168.56.200</code></td><td style="text-align:center">6381</td><td style="text-align:center"><code>Redis-1</code>çš„ä»èŠ‚ç‚¹</td></tr><tr><td style="text-align:center"><code>Redis-111</code></td><td style="text-align:center"><code>Slave</code></td><td style="text-align:center"><code>192.168.56.200</code></td><td style="text-align:center">6382</td><td style="text-align:center"><code>Redis-11</code>çš„ä»èŠ‚ç‚¹</td></tr></tbody></table><h3 id="Sentinelé…ç½®å’Œé…ç½®æ–‡ä»¶åˆ›å»º">Sentinelé…ç½®å’Œé…ç½®æ–‡ä»¶åˆ›å»º</h3><p>å…ˆçœ‹æ ·æ¿é…ç½®æ–‡ä»¶<code>sentinel.conf</code>çš„å†…å®¹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">port 26379</span><br><span class="line">daemonize no</span><br><span class="line">pidfile /var/run/redis-sentinel.pid</span><br><span class="line">logfile ""</span><br><span class="line">dir /tmp</span><br><span class="line">sentinel monitor mymaster 127.0.0.1 6379 2</span><br><span class="line">sentinel down-after-milliseconds mymaster 30000</span><br><span class="line">sentinel parallel-syncs mymaster 1</span><br><span class="line">sentinel failover-timeout mymaster 180000</span><br><span class="line">sentinel deny-scripts-reconfig yes</span><br><span class="line"><span class="meta">#</span><span class="bash"> sentinel auth-pass mymaster 123456</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> <span class="built_in">bind</span> 127.0.0.1</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> ......</span></span><br></pre></td></tr></table></figure><p>å®Œæ•´çš„é…ç½®å±æ€§åˆ—è¡¨æ¯”è¾ƒå°‘ï¼Œè€Œ<code>port</code>ã€<code>daemonize</code>ã€<code>pidfile</code>ã€<code>logfile</code>ã€<code>dir</code>ã€<code>bind</code>ç­‰å±æ€§ä¸Šä¸€ç¯‡æ–‡ç« å·²ç»åˆ†æè¿‡ï¼Œè¿™é‡Œä¸å†å¤è¿°ã€‚</p><p><strong><code>sentinel monitor &lt;master-group-name&gt; &lt;ip&gt; &lt;port&gt; &lt;quorum&gt;</code></strong></p><ul><li><code>master-group-name</code>ï¼šè¢«ç›‘æ§çš„ç›®æ ‡<code>Master</code>å®ä¾‹çš„åç§°ï¼Œè¿™ä¸ªå€¼å¯ä»¥è‡ªå®šä¹‰ã€‚</li><li><code>ip</code>ï¼šè¢«ç›‘æ§çš„ç›®æ ‡<code>Master</code>å®ä¾‹çš„æœåŠ¡å™¨åœ°å€ã€‚</li><li><code>port</code>ï¼šè¢«ç›‘æ§çš„ç›®æ ‡<code>Master</code>å®ä¾‹çš„ç«¯å£ã€‚</li><li><code>quorum</code>ï¼šä»²è£å‚æ•°ï¼Œè®¾ç½®éœ€è¦å¤šå°‘ä¸ª<code>Sentinel</code>å®ä¾‹åŒæ„æ‰èƒ½åˆ¤æ–­ä¸€ä¸ªè¢«ç›‘æ§çš„<code>Redis</code>å®ä¾‹å¤±æ•ˆã€‚æ¢è¨€ä¹‹ï¼Œä¸€ä¸ª <code>Sentinel</code>ç¾¤éœ€è¦è·å¾—ç³»ç»Ÿä¸­å¤šæ•°<code>Sentinel</code>çš„æ”¯æŒï¼Œ æ‰èƒ½å‘èµ·ä¸€æ¬¡è‡ªåŠ¨æ•…éšœè¿ç§»ã€‚å¦‚æœæˆ‘ä»¬ä½¿ç”¨3ä¸ª<code>Sentinel</code>å®ä¾‹ï¼Œé‚£ä¹ˆè¿™ä¸ªå€¼å¯ä»¥å®šä¹‰ä¸º2ã€‚</li></ul><p><code>sentinel monitor</code>é…ç½®é¡¹æ¯”è¾ƒç‰¹æ®Šï¼Œä¸»è¦ç”¨æ¥æŒ‡å®š<code>Master</code>è§’è‰²<code>Redis</code>æœåŠ¡çš„é“¾æ¥ä¿¡æ¯ã€‚å…¶ä»–5ä¸ªé…ç½®é¡¹é‡‡ç”¨ä¸‹é¢çš„æ ¼å¼ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sentinel &lt;option_name&gt; &lt;master-group-name&gt; &lt;option_value&gt;</span><br></pre></td></tr></table></figure><ul><li><code>down-after-milliseconds</code>ï¼šå®šäº†<code>Sentinel</code>è®¤ä¸ºè¢«ç›‘æ§çš„<code>Redis</code>æœåŠ¡å·²ç»æ–­çº¿çš„æ€»æ¯«ç§’æ•°ã€‚å¦‚æœåœ¨æŒ‡å®šçš„æ¯«ç§’æ•°ä¹‹å†…ï¼Œè¢«ç›‘æ§çš„<code>Redis</code>æœåŠ¡æ²¡æœ‰å‘<code>Sentinel</code>å›å¤<code>PING</code>ä¿¡æ¯æˆ–è€…å›å¤äº†<code>Error</code>ä¿¡æ¯ï¼Œé‚£ä¹ˆ<code>Sentinel</code>ä¼šå¼€å§‹è®¤ä¸ºè¢«ç›‘æ§çš„<code>Redis</code>æœåŠ¡ä¸‹çº¿ï¼ˆå…¶å®è¿™é‡Œæ˜¯ä¸»è§‚ä¸‹çº¿ï¼ˆ<code>subjectively down</code>ï¼Œç®€ç§°<code>SDOWN</code>ï¼‰ã€‚</li><li><code>parallel-syncs</code>ï¼šæŒ‡å®šäº†åœ¨æ‰§è¡Œæ•…éšœè½¬ç§»æ—¶ï¼Œæœ€å¤šå¯ä»¥æœ‰å¤šå°‘<code>Slave</code>å®ä¾‹åŒæ—¶å¯¹æ–°çš„<code>Master</code>å®ä¾‹è¿›è¡ŒåŒæ­¥ï¼Œè¿™ä¸ªæ•°å­—è¶Šå°ï¼Œå®Œæˆæ•…éšœè½¬ç§»æ‰€éœ€çš„æ—¶é—´å°±è¶Šé•¿ã€‚è¿™é‡Œå»ºè®®å‚è€ƒæ ·æ¿é…ç½®ä¸­çš„å€¼ï¼Œè®¾ç½®ä¸º1ã€‚</li><li><code>failover-timeout</code>ï¼šæ•…éšœè½¬ç§»è¶…æ—¶æ—¶é—´ï¼Œå•ä½ä¸ºæ¯«ç§’ã€‚</li><li><code>deny-scripts-reconfig</code>ï¼šæ˜¯å¦ç¦ç”¨<code>SENTINEL SET</code>å‘½ä»¤è¿è¡Œæ—¶ä¿®æ”¹<code>notification-script</code>å’Œ<code>client-reconfig-script</code>ï¼Œé»˜è®¤å€¼ä¸º<code>yes</code>ã€‚</li><li><code>auth-pass</code>ï¼šé…ç½®è¿æ¥<code>Master</code>å®ä¾‹çš„è®¤è¯å¯†ç ï¼Œå¦‚æœ<code>Master</code>å®ä¾‹æ²¡æœ‰è®¾ç½®å¯†ç ï¼Œå¯ä»¥ä¸é…ç½®æ­¤é¡¹å±æ€§ã€‚</li></ul><p>åˆ›å»º3ä»½<code>Sentinel</code>é…ç½®æ–‡ä»¶<code>26379.conf</code>ã€<code>26380.conf</code>ã€<code>26381.conf</code>ï¼Œå®ƒä»¬çš„å†…å®¹ååˆ†ç›¸ä¼¼ï¼Œè¿™é‡Œåªåˆ—å‡º<code>26379.conf</code>çš„å†…å®¹ï¼ˆ<strong>192.168.56.200æ˜¯ç¬”è€…è™šæ‹Ÿæœºçš„ä¸»æœºåœ°å€</strong>ï¼‰ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">port 26379</span><br><span class="line">daemonize yes</span><br><span class="line">bind 0.0.0.0</span><br><span class="line">protected-mode no</span><br><span class="line">pidfile /var/run/sentinel-26379.pid</span><br><span class="line">logfile "/data/redis/sentinel-26379.log"</span><br><span class="line">dir /data/redis</span><br><span class="line">sentinel monitor doge-master 192.168.56.200 6380 2</span><br><span class="line">sentinel down-after-milliseconds doge-master 30000</span><br><span class="line">sentinel parallel-syncs doge-master 1</span><br><span class="line">sentinel failover-timeout doge-master 180000</span><br></pre></td></tr></table></figure><p>å¦å¤–ï¼Œåˆ›å»º3ä»½<code>Redis</code>æœåŠ¡çš„é…ç½®æ–‡ä»¶<code>6380.conf</code>ã€<code>6381.conf</code>ã€<code>6382.conf</code>ï¼Œå®ƒä»¬çš„å†…å®¹ååˆ†ç›¸ä¼¼ï¼Œè¿™é‡Œåªåˆ—å‡º<code>6380.confï¼ˆä¸»èŠ‚ç‚¹ï¼‰</code>çš„å†…å®¹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">port 6380</span><br><span class="line">daemonize yes</span><br><span class="line">bind 0.0.0.0</span><br><span class="line">protected-mode no</span><br><span class="line">pidfile /var/run/redis-6380.pid</span><br><span class="line">logfile "/data/redis/redis-6380.log"</span><br><span class="line">dir /data/redis</span><br><span class="line">dbfilename "dump-6380.rdb"</span><br></pre></td></tr></table></figure><p><code>6381.confï¼ˆä»èŠ‚ç‚¹ï¼‰</code>å°¾éƒ¨æ·»åŠ é¢å¤–é…ç½®ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">slaveof 192.168.56.200 6380</span><br></pre></td></tr></table></figure><p><code>6382.confï¼ˆä»èŠ‚ç‚¹ï¼‰</code>å°¾éƒ¨æ·»åŠ é¢å¤–é…ç½®ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">slaveof 192.168.56.200 6381</span><br></pre></td></tr></table></figure><p>æ¯ä»½é…ç½®è®°å¾—æ›¿æ¢å¥½å¯¹åº”çš„ç«¯å£å·ï¼Œéƒ½å‡†å¤‡å¥½äº†ä¹‹åï¼Œä¾æ¬¡å¯åŠ¨ä¸»èŠ‚ç‚¹ã€ä¸¤ä¸ªä»èŠ‚ç‚¹å’Œ3ä¸ª<code>Sentinel</code>ï¼ˆå¯ä»¥æŠŠå‘½ä»¤å†™æˆä¸€ä¸ª<code>start.sh</code>ï¼Œè°ƒç”¨<code>sh start.sh</code>ï¼‰ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">/data/redis/redis-5.0.5/src/redis-server /data/redis/6380.conf</span><br><span class="line">/data/redis/redis-5.0.5/src/redis-server /data/redis/6381.conf</span><br><span class="line">/data/redis/redis-5.0.5/src/redis-server /data/redis/6382.conf</span><br><span class="line"></span><br><span class="line">/data/redis/redis-5.0.5/src/redis-sentinel /data/redis/26379.conf</span><br><span class="line">/data/redis/redis-5.0.5/src/redis-sentinel /data/redis/26380.conf</span><br><span class="line">/data/redis/redis-5.0.5/src/redis-sentinel /data/redis/26381.conf</span><br></pre></td></tr></table></figure><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201910/r-s-i-g-2.png" alt=""></p><p>æ­¤æ—¶æŸ¥çœ‹å“¨å…µçš„é…ç½®ï¼Œå‘ç°è¢«<code>Redis</code>ä¿®æ”¹ï¼Œæ–°å¢äº†å‘ç°çš„ä¸»ä»ä¿¡æ¯å’Œå“¨å…µå®ä¾‹ä¿¡æ¯ï¼š</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201910/r-s-i-g-3.png" alt=""></p><p>æŸ¥çœ‹ä¸€ä¸‹å“¨å…µå®ä¾‹çš„æ—¥å¿—ï¼š</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201910/r-s-i-g-4.png" alt=""></p><p>ç›®å‰å“¨å…µå’Œ<code>Redis</code>æœåŠ¡éƒ½æ­£å¸¸è¿ä½œã€‚</p><h3 id="æ¨¡æ‹Ÿæ•…éšœè½¬ç§»">æ¨¡æ‹Ÿæ•…éšœè½¬ç§»</h3><p>å®˜æ–¹æ–‡æ¡£ä¸­å»ºè®®ä½¿ç”¨æµ‹è¯•å‘½ä»¤è®©<code>Redis</code>å®ä¾‹<code>Sleep</code>ä¸€ä¸ªæ—¶é—´ï¼Œä»è€Œè§¦å‘æ•…éšœè½¬ç§»ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -p [port] DEBUG sleep 30</span><br></pre></td></tr></table></figure><p>å…ˆæŸ¥çœ‹å½“å‰çš„<code>Master</code>å®ä¾‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]# redis-cli -p 26379 </span><br><span class="line">127.0.0.1:26379&gt; SENTINEL get-master-addr-by-name doge-master</span><br><span class="line">1) "127.0.0.1"</span><br><span class="line">2) "6380"</span><br></pre></td></tr></table></figure><p>å†å¯¹<code>Master</code>å®ä¾‹æ‰§è¡Œ<code>Sleep</code>å‘½ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -p 6380 DEBUG sleep 40</span><br></pre></td></tr></table></figure><p>è¯¥å‘½ä»¤ä¼šé˜»å¡ç›´åˆ°40ç§’åï¼Œæ§åˆ¶å°é‡Šæ”¾åï¼Œå†æŸ¥çœ‹å½“å‰çš„<code>Master</code>å®ä¾‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:26379&gt; SENTINEL get-master-addr-by-name doge-master</span><br><span class="line">1) "127.0.0.1"</span><br><span class="line">2) "6381"</span><br><span class="line">127.0.0.1:26379&gt;</span><br></pre></td></tr></table></figure><p>å¯è§ï¼Œå·²ç»æˆåŠŸåˆ‡æ¢<code>Master</code>å®ä¾‹ä¸º<code>6381</code>ã€‚é‚£ä¹ˆï¼Œå½“å‰çš„<code>Master-Slave</code>çš„æ‹“æ‰‘å…³ç³»åˆ°åº•æ˜¯æ€ä¹ˆæ ·çš„ï¼Ÿè¿™ä¸ªæ—¶å€™å…ˆçœ‹ä¸€ä¸‹<code>Sentinel</code>çš„æ—¥å¿—ï¼š</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201910/r-s-i-g-5.png" alt=""></p><p>è¿™é‡Œå¯ä»¥çœ‹å‡ºäº†ï¼Œæ¢å¤åçš„<code>6380</code>å®ä¾‹é‡æ–°æˆä¸ºäº†<code>Slave</code>è§’è‰²ï¼Œæ„Ÿè§‰æœ‰ç‚¹ç¿»è½¦äº†ï¼Œ<strong>åŸæ¥çš„æ ‘çŠ¶ä¸»ä»éƒ¨ç½²å˜å›äº†ä¸€ä¸»å¤šä»</strong>ï¼Œç¬”è€…å¼€å§‹ä¸ç›¸ä¿¡ï¼Œäºæ˜¯ä»å½“å‰çš„<code>Master</code>å®ä¾‹æŸ¥çœ‹äº†ä¸€ä¸‹ä¸»ä»ä¿¡æ¯ï¼š</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201910/r-s-i-g-6.png" alt=""></p><p>ç¡®å®å¦‚æ­¤ï¼Œå†æ£€æŸ¥äº†ä¸€ä¸‹æ—§çš„ä¸»èŠ‚ç‚¹<code>6380</code>çš„é…ç½®ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">port 6380</span><br><span class="line">daemonize yes</span><br><span class="line">bind 0.0.0.0</span><br><span class="line">protected-mode no</span><br><span class="line">pidfile "/var/run/redis-6380.pid"</span><br><span class="line">logfile "/data/redis/redis-6380.log"</span><br><span class="line">dir "/data/redis"</span><br><span class="line">dbfilename "dump-6380.rdb"</span><br><span class="line"><span class="meta">#</span><span class="bash"> Generated by CONFIG REWRITE</span></span><br><span class="line">replicaof 192.168.56.200 6381</span><br></pre></td></tr></table></figure><p>å‘ç°ï¼Œæœ€åä¸€è¡Œè¢«æ–°å¢äº†å†…å®¹ï¼Œå®ƒæˆä¸ºäº†ä»èŠ‚ç‚¹ã€‚è¿™ä¸€ç‚¹å¦‚æœä¸å®è·µï¼Œææ€•ä¸çŸ¥é“ä¼šè¡ç”Ÿå‡ºè¿™ç§ç»“æœã€‚ç”»äº†ä¸ªå›¾è¡¨æ˜ä¸€ä¸‹æ•´ä¸ªè¿‡ç¨‹ï¼š</p><p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201910/r-s-i-g-7.png" alt=""></p><p>è¿™ä¸ªé—®é¢˜æš‚æ—¶ä¸æ·±å…¥æ¢ç©¶ï¼Œç›®å‰çŸ¥é“ç»“æœå¦‚æ­¤å³å¯ã€‚</p><h2 id="å®¢æˆ·ç«¯ä»£ç æµ‹è¯•">å®¢æˆ·ç«¯ä»£ç æµ‹è¯•</h2><p>æ—¢ç„¶å“¨å…µæ­å»ºå®Œäº†ï¼Œå¯ä»¥ç”¨<code>Java</code>å®¢æˆ·ç«¯è¿æ¥è¿›è¡Œä¸€äº›ç®€å•çš„æ“ä½œã€‚ä½¿ç”¨çš„æ˜¯<code>Lettuce</code>é©±åŠ¨ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.lettuce<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lettuce-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>5.1.8.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><p>æµ‹è¯•ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSentinel</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    RedisURI uri = RedisURI.builder()</span><br><span class="line">            .withSentinelMasterId(<span class="string">"doge-master"</span>)</span><br><span class="line">            .withSentinel(<span class="string">"192.168.56.200"</span>, <span class="number">26379</span>)</span><br><span class="line">            .build();</span><br><span class="line">    RedisClient redisClient = RedisClient.create(uri);</span><br><span class="line">    StatefulRedisMasterSlaveConnection&lt;String, String&gt; connection = MasterSlave.connect(redisClient, <span class="keyword">new</span> Utf8StringCodec(), uri);</span><br><span class="line">    connection.setReadFrom(ReadFrom.SLAVE_PREFERRED);</span><br><span class="line">    RedisCommands&lt;String, String&gt; commands = connection.sync();</span><br><span class="line">    String result = commands.ping();</span><br><span class="line">    log.info(<span class="string">"PING:&#123;&#125;"</span>, result);</span><br><span class="line">    commands.setex(<span class="string">"name"</span>, <span class="number">5</span>, <span class="string">"throwable"</span>);</span><br><span class="line">    result = commands.get(<span class="string">"name"</span>);</span><br><span class="line">    log.info(<span class="string">"Get value:&#123;&#125;"</span>, result);</span><br><span class="line">    connection.close();</span><br><span class="line">    redisClient.shutdown();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PING:PONG</span><br><span class="line">Get value:throwable</span><br></pre></td></tr></table></figure><h2 id="å°ç»“">å°ç»“</h2><p><code>Redis</code>å“¨å…µæ­å»ºç›¸å¯¹ç®€å•ï¼Œä½†æ˜¯éœ€è¦æ³¨æ„<code>Redis</code>ä¸»ä»é…ç½®å’Œ<code>Sentinel</code>é…ç½®ï¼Œä¸€äº›å‘½ä»¤å¯ä»¥ç›´æ¥å†™æˆ<code>shell</code>è„šæœ¬æ–¹ä¾¿ä¸€é”®<code>shutdown</code>æˆ–è€…é‡å¯ã€‚åœ¨æµ‹è¯•æ•…éšœè½¬ç§»çš„æ—¶å€™å‘ç°äº†æ ‘çŠ¶ä¸»ä»ä¼šå˜æˆä¸€ä¸»å¤šä»ï¼Œè¿™ä¸ªé—®é¢˜åé¢ä¼šåˆ†æã€‚</p><p>å‚è€ƒèµ„æ–™ï¼š</p><ul><li><a href="https://redis.io/topics/sentinel" target="_blank" rel="noopener">Redis Sentinel Documentation</a></li></ul><p>ï¼ˆæœ¬æ–‡å®Œ c-1-d e-a-20191007ï¼‰</p>]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;å‰æ&quot;&gt;å‰æ&lt;/h2&gt;
&lt;p&gt;&lt;code&gt;Redis5.x&lt;/code&gt;ä¹‹åï¼Œå•æœºã€å“¨å…µã€é›†ç¾¤æ­å»ºçš„éš¾åº¦å·²ç»ç®€åŒ–ã€‚é‰´äºç›®å‰çœ‹åˆ°å¤ªå¤šæ–‡ç« éƒ½æ˜¯å¤åˆ¶ç²˜è´´ä»¥å¾€ä¸€äº›&lt;code&gt;3.x&lt;/code&gt;ç‰ˆæœ¬çš„ä¸€äº›å†…å®¹ï¼Œæ‰€ä»¥æ‰“ç®—åŸºäºå½“å‰&lt;code&gt;Redis&lt;/code&gt;çš„æœ€æ–°ç‰ˆæœ¬åšä¸€æ¬¡å•æœºã€å“¨å…µå’Œé›†ç¾¤çš„æ­å»ºï¼Œè®°å½•ä¸€ä¸‹è¿‡ç¨‹æ­¥éª¤å’Œé‡åˆ°çš„é—®é¢˜ã€‚ç¼–å†™æœ¬æ–‡çš„æ—¶é—´æ˜¯2019å¹´10æœˆ6æ—¥ï¼ˆå›½åº†å‡æœŸâ€¦ï¼‰ï¼Œå½“å‰&lt;code&gt;Redis&lt;/code&gt;çš„æœ€æ–°ç‰ˆæœ¬ä¸º&lt;strong&gt;5.0.5&lt;/strong&gt;ã€‚æ“ä½œç³»ç»Ÿç”¨çš„æ˜¯è™šæ‹Ÿæœºé‡Œé¢å®‰è£…çš„&lt;code&gt;CentOS 7&lt;/code&gt;ã€‚å…ˆç¡®å®šå·²ç»å®‰è£…å¥½&lt;code&gt;Redis&lt;/code&gt;æœåŠ¡ï¼Œå¯ä»¥å‚è€ƒç¬”è€…å†™çš„å‰ä¸€ç¯‡æ–‡ç« ï¼š&lt;a href=&quot;http://www.throwable.club/2019/10/06/redis-server-single-install-guide&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;ã€ŠRedis5.xå•æœºæœåŠ¡æ­å»ºæ‰‹è®°ã€‹&lt;/a&gt;ã€‚å‡ºäºä¹¦å†™ä¹ æƒ¯ï¼Œæœ¬æ–‡æœ‰å¯èƒ½æŠŠå“¨å…µç§°ä¸º&lt;code&gt;Sentinel&lt;/code&gt;ã€&lt;code&gt;Redis Sentinel&lt;/code&gt;ã€å“¨å…µæˆ–è€…&lt;code&gt;Redis&lt;/code&gt;å“¨å…µï¼Œè¿™å››ä¸ªåè¯æ˜¯ç­‰ä»·çš„ã€‚&lt;/p&gt;
    
    </summary>
    
    
      <category term="Middleware" scheme="http://throwable.club/blog/categories/Middleware/"/>
    
      <category term="Redis" scheme="http://throwable.club/blog/categories/Middleware/Redis/"/>
    
    
      <category term="Middleware" scheme="http://throwable.club/blog/tags/Middleware/"/>
    
      <category term="Redis" scheme="http://throwable.club/blog/tags/Redis/"/>
    
  </entry>
  
</feed>
