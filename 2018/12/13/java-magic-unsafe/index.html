<!DOCTYPE html>
<html>
<head hexo-theme='Volantis' version='1.5.2' docs='https://xaoxuu.com/wiki/volantis/'>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  
  <title>神奇的魔法类和双刃剑-Unsafe | Throwable&#39;s Blog</title>
  
  <meta name="keywords" content="thorwable,doge,Thorwable">
  
  
  <meta name="description" content="一棵还在尝试努力生存的90后韭菜Doge">
  

  

  <meta name="HandheldFriendly" content="True" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <!-- meta -->
  

  <!-- link -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.css" />
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.css">
  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.10.1/css/all.min.css">
  
  
  <link rel='stylesheet' href='https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/static/css/gb.css'>
  

  
  <link rel="shortcut icon" type='image/x-icon' href="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/mine/doge_favicon.ico">
  

  

  
    
<link rel="stylesheet" href="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/static/css/throwable.css">

  

  <script>
    function setLoadingBarProgress(num) {
      document.getElementById('loading-bar').style.width=num+"%";
    }
  </script>

  
  
    <!-- ba -->
    <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?4df6907aebab752244c3ca1432b4ff57";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
    </script>
  
</head>

<body>
  
  
  <div class="cover-wrapper">
    <cover class='cover post half'>
      
        
  <img class='logo' src='https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/mine/blog-logo.png'/>


  <div class="m_search">
    <form name="searchform" class="form u-search-form">
      <i class="icon fas fa-search fa-fw"></i>
      <input type="text" class="input u-search-input" placeholder="(゜-゜)つロ搜一搜有没有想看的" />
    </form>
  </div>

<div class='menu navigation'>
  <ul class='h-list'>
    
      
        <li>
          <a class="nav home "
            href="/"
            
            
            id="home">
            <i class='fas fa-home fa-fw'></i>&nbsp;主页
          </a>
        </li>
      
        <li>
          <a class="nav home "
            href="/projects/"
            
            
            id="projects">
            <i class='fas fa-code-branch fa-fw'></i>&nbsp;开源项目
          </a>
        </li>
      
        <li>
          <a class="nav home "
            href="/friends/"
            
              rel="nofollow"
            
            
            id="friends">
            <i class='fas fa-link fa-fw'></i>&nbsp;友链
          </a>
        </li>
      
        <li>
          <a class="nav home "
            href="/about/"
            
              rel="nofollow"
            
            
            id="about">
            <i class='fas fa-info-circle fa-fw'></i>&nbsp;关于
          </a>
        </li>
      
    
  </ul>
</div>
<div style="text-align: center;margin-top: 5px;" id="rollingColorfulFont"></div>
      
    </cover>
    <header class="l_header ">
  <div id="loading-bar-wrapper">
    <div id="loading-bar"></div>
  </div>

	<div class='wrapper'>
		<div class="nav-main container container--flex">
      <a class="logo flat-box" target="_self" href='/' >
        
          
          
            Throwable
          
        
      </a>
			<div class='menu navigation'>
				<ul class='h-list'>
          
  					
  						<li>
								<a class="nav flat-box" href="/"
                  
                  
                    target="_self"
                  
                  id="home">
									<i class='fas fa-hourglass-half fa-fw'></i>&nbsp;近期
								</a>
							</li>
      			
  						<li>
								<a class="nav flat-box" href="/categories/"
                  
                    rel="nofollow"
                  
                  
                    target="_self"
                  
                  id="categories">
									<i class='fas fa-folder-open fa-fw'></i>&nbsp;分类
								</a>
							</li>
      			
  						<li>
								<a class="nav flat-box" href="/tags/"
                  
                    rel="nofollow"
                  
                  
                    target="_self"
                  
                  id="tags">
									<i class='fas fa-hashtag fa-fw'></i>&nbsp;标签
								</a>
							</li>
      			
  						<li>
								<a class="nav flat-box" href="/friends/"
                  
                    rel="nofollow"
                  
                  
                  id="friends">
									<i class='fas fa-link fa-fw'></i>&nbsp;友接
								</a>
							</li>
      			
  						<li>
								<a class="nav flat-box" href="/blog/archives/"
                  
                    rel="nofollow"
                  
                  
                    target="_self"
                  
                  id="blogarchives">
									<i class='fas fa-archive fa-fw'></i>&nbsp;归档
								</a>
							</li>
      			
  						<li>
								<a class="nav flat-box" href="/about/"
                  
                    rel="nofollow"
                  
                  
                    target="_self"
                  
                  id="about">
									<i class='fas fa-info-circle fa-fw'></i>&nbsp;关于
								</a>
							</li>
      			
      		
				</ul>
			</div>

      <div class="m_search">
        <form name="searchform" class="form u-search-form">
          <i class="icon fas fa-search fa-fw"></i>
          <input type="text" class="input u-search-input" placeholder="(゜-゜)つロ搜一搜有没有想看的" />
        </form>
      </div>

			<ul class='switcher h-list'>
				
					<li class='s-search'><a class="fas fa-search fa-fw" target="_self" href='javascript:void(0)'></a></li>
				
				<li class='s-menu'><a class="fas fa-bars fa-fw" target="_self" href='javascript:void(0)'></a></li>
			</ul>
		</div>

		<div class='nav-sub container container--flex'>
			<a class="logo flat-box"></a>
			<ul class='switcher h-list'>
				<li class='s-comment'><a class="flat-btn fas fa-comments fa-fw" target="_self" href='javascript:void(0)'></a></li>
        
          <li class='s-toc'><a class="flat-btn fas fa-list fa-fw" target="_self" href='javascript:void(0)'></a></li>
        
			</ul>
		</div>
	</div>
</header>
	<aside class="menu-phone white-box">
    <header>
		<nav class="menu navigation">
      <ul>
        
          
            <li>
							<a class="nav flat-box" href="/"
                
                
                id="home">
								<i class='fas fa-clock fa-fw'></i>&nbsp;近期文章
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/blog/archives/"
                
                  rel="nofollow"
                
                
                id="blogarchives">
								<i class='fas fa-archive fa-fw'></i>&nbsp;文章归档
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/projects/"
                
                
                id="projects">
								<i class='fas fa-code-branch fa-fw'></i>&nbsp;开源项目
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/friends/"
                
                  rel="nofollow"
                
                
                id="friends">
								<i class='fas fa-link fa-fw'></i>&nbsp;我的友链
							</a>
            </li>
          
            <li>
							<a class="nav flat-box" href="/about/"
                
                  rel="nofollow"
                
                
                id="about">
								<i class='fas fa-info-circle fa-fw'></i>&nbsp;关于小站
							</a>
            </li>
          
       
      </ul>
		</nav>
    </header>
	</aside>
<script>setLoadingBarProgress(40);</script>

  </div>


  <div class="l_body">
    <div class='body-wrapper'>
      <div class='l_main'>
  

  
    <article id="post" class="post white-box card-shadow  article-type-post" itemscope itemprop="blogPost">
      


  <section class='meta'>
    
    
    <div class="meta" id="header-meta">
      
        
  
    <h1 class="title">
      <a href="/2018/12/13/java-magic-unsafe/">
        神奇的魔法类和双刃剑-Unsafe
      </a>
    </h1>
  


      
      <div class='new-meta-box'>
        
          
        
          
            
  <div class='new-meta-item author'>
    
      <a href="http://throwable.club" rel="nofollow">
        
          <img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/mine/doge_avatar.jpg">
        
        <p>Throwable</p>
      </a>
    
  </div>


          
        
          
            
  
  <div class='new-meta-item category'>
    <a href='/blog/categories/Java/' rel="nofollow">
      <i class="fas fa-folder-open" aria-hidden="true"></i>
      <p>Java</p>
    </a>
  </div>


          
        
          
            <div class="new-meta-item date">
  <a class='notlink'>
    <i class="fas fa-edit" aria-hidden="true"></i>
    <p>发布于：2018年12月13日</p>
  </a>
</div>

          
        
          
            <div class="new-meta-item date" itemprop="dateUpdated" datetime="2018-12-13T23:47:39+08:00">
  <a class='notlink'>
    <i class="fas fa-save" aria-hidden="true"></i>
    <p>更新于：2018年12月13日</p>
  </a>
</div>

          
        
          
            
  
    <div class="new-meta-item browse busuanzi">
      <a class='notlink'>
        <i class="fas fa-eye" aria-hidden="true"></i>
        <p>
          <span id="busuanzi_value_page_pv">
            <i class="fas fa-spinner fa-spin fa-fw" aria-hidden="true"></i>
          </span>
        </p>
      </a>
    </div>
  


          
        
          
            
  <div class="new-meta-item wordcount">
    <a class='notlink'>
      <i class="fas fa-keyboard" aria-hidden="true"></i>
      <p>字数：5.3k字</p>
    </a>
  </div>
  <div class="new-meta-item readtime">
    <a class='notlink'>
      <i class="fas fa-hourglass-half" aria-hidden="true"></i>
      <p>时长：20分钟</p>
    </a>
  </div>


          
        
          
            

          
        
      </div>
      
        <hr>
      
    </div>
  </section>


      <section class="article typo">
        <div class="article-entry" itemprop="articleBody">
          
          <h1>神奇的魔法类和双刃剑-Unsafe</h1>
<h2 id="前提">前提</h2>
<p>JDK9或者以后，<code>sun.misc</code>包的源码也可以上传到JDK类库中，可以直接导入IDE进行注释的阅读，这一点是比较好的改进。本文基于JDK11的源码阅读Unsafe类的注释，介绍一下这个类的使用方式。</p>
<h2 id="Unsafe简介">Unsafe简介</h2>
<p>在JDK9之后，<code>sun.misc.Unsafe</code>被移动到<code>jdk.unsupported</code>模块中，同时在<code>java.base</code>模块克隆了一个<code>jdk.internal.misc.Unsafe</code>类，代替了JDK8以前的<code>sun.misc.Unsafe</code>的功能，<code>jdk.internal</code>包不开放给开发者调用。</p>
<p>Unsafe是用于在实质上扩展Java语言表达能力、便于在更高层（Java层）代码里实现原本要在更低层（C层）实现的核心库功能用的。这些功能包括裸内存的申请/释放/访问，低层硬件的atomic/volatile支持，创建未初始化对象等。它原本的设计就只应该被标准库使用。</p>
<p>为了让开发者有机会过渡到尽量不使用<code>sun.misc.Unsafe</code>，默认不允许Java应用代码访问<code>sun.misc.Unsafe</code>类，同时在<code>java.base</code>模块克隆了一个不能被外部访问的<code>jdk.internal.misc.Unsafe</code>类用于JDK内部API演进。</p>
<h2 id="获取Unsafe实例">获取Unsafe实例</h2>
<p><code>sun.misc.Unsafe</code>提供了一个静态方法来获取其实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@CallerSensitive</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Unsafe <span class="title">getUnsafe</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Class&lt;?&gt; caller = Reflection.getCallerClass();</span><br><span class="line">    <span class="keyword">if</span> (!VM.isSystemDomainLoader(caller.getClassLoader()))</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> SecurityException(<span class="string">"Unsafe"</span>);</span><br><span class="line">    <span class="keyword">return</span> theUnsafe;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// VM类中的代码</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">boolean</span> <span class="title">isSystemDomainLoader</span><span class="params">(ClassLoader loader)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> loader == <span class="keyword">null</span> || loader == ClassLoader.getPlatformClassLoader();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个静态方法<code>getUnsafe()</code>必须在当前调用的类对应的类加载器为null(<strong>类加载器为null也就是当前调用的类必须使用Bootstrap类加载器加载</strong>)或者为<code>PlatformClassLoader</code>才不会抛出<code>SecurityException</code>异常。由于对<code>PlatformClassLoader</code>理解不深入，所以我们可以用VM参数<code>-Xbootclasspath:</code>让当前的调用类被Bootstrap类加载器加载。</p>
<p><img src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/201812/j-unsafe-1.png" alt="j-unsafe-1"></p>
<p>但是试验了一下(其实文档中已经提到此参数已经失效，不过这里还是试了下)，发现这个参数在JDK9之后已经不支持，使用的时候会导致JVM启动失败，异常信息是：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Error: Could not create the Java Virtual Machine.</span><br><span class="line">-Xbootclasspath is no longer a supported option.</span><br><span class="line">Error: A fatal exception has occurred. Program will exit.</span><br></pre></td></tr></table></figure>
<p>此特性暂时在JDK9以后找不到替代的VM参数，所以这里只能选择其他可行方法。查看<code>sun.misc.Unsafe</code>所在模块的信息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">module</span> jdk.unsupported &#123;</span><br><span class="line">    <span class="keyword">exports</span> com.sun.nio.file;</span><br><span class="line">    <span class="keyword">exports</span> sun.misc;</span><br><span class="line">    <span class="keyword">exports</span> sun.reflect;</span><br><span class="line"></span><br><span class="line">    opens sun.misc;</span><br><span class="line">    opens sun.reflect;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由于<code>sun.misc</code>是opens修饰的，可以使用反射直接调用。因此可以像下面这样获取<code>sun.misc.Unsafe</code>对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UnsafeMain</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		Field f = Unsafe.class.getDeclaredField("theUnsafe");</span><br><span class="line">		f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">		Unsafe unsafe = (Unsafe) f.get(<span class="keyword">null</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其实还有特殊的技巧可以直接暴露<code>jdk.internal.misc.Unsafe</code>所在的模块让它可以直接使用反射调用，只需要使用参数<code>addExports:java.base/jdk.internal.misc=ALL-UNAMED</code>，这样子就可以反射获取<code>jdk.internal.misc.Unsafe</code>的实例，不过推荐这种做法，毕竟<code>jdk.internal.misc.Unsafe</code>中提供更多底层的方法，能力越大越容易失去控制。</p>
<h2 id="Unsafe的使用建议">Unsafe的使用建议</h2>
<p>使用Unsafe要注意以下几个问题：</p>
<p>1、Unsafe有可能在未来的JDK版本移除或者不允许Java应用代码使用，这一点可能导致使用了Unsafe的应用无法运行在高版本的JDK。<br>
2、Unsafe的不少方法中必须提供原始地址(内存地址)和被替换对象的地址，偏移量要自己计算，一旦出现问题就是JVM崩溃级别的异常，会导致整个JVM实例崩溃，表现为应用程序直接crash掉(<strong>其实这个很好理解，JVM是C语言写出来的软件，如果操作一个不存在的内存地址，在C程序中就是引发程序崩溃的操作</strong>)。<br>
3、Unsafe提供的直接内存访问的方法中使用的内存不受JVM管理(无法被GC)，需要手动管理，一旦出现疏忽很有可能成为内存泄漏的源头。</p>
<p>暂时总结出以上三点问题。Unsafe在JUC(java.util.concurrent)包中大量使用(主要是CAS)，在netty中方便使用直接内存，还有一些高并发的交易系统为了提高CAS的效率也有可能直接使用到Unsafe。总而言之，Unsafe类是魔法类，也可以说是一把双刃剑。</p>
<h2 id="Unsafe的核心方法">Unsafe的核心方法</h2>
<p><code>sun.misc.Unsafe</code>一共提供了89个public修饰的方法，下面针对核心方法按功能分组简单介绍一下。</p>
<h3 id="类操作">类操作</h3>
<p>类操作相关主要和类实例化、属性地址获取等等操作，原来存在一个<code>defineClass</code>方法，已经被移除，但是该方法在<code>jdk.internal.misc.Unsafe</code>中依然存在。</p>
<p><strong>ensureClassInitialized</strong></p>
<ul>
<li><code>public boolean shouldBeInitialized(Class&lt;?&gt; c)</code></li>
</ul>
<p>检测给定的类是否已经初始化。通常需要使用在获取一个类的静态属性的时候(因为一个类如果没初始化，它的静态属性也不会初始化)。</p>
<p><strong>shouldBeInitialized</strong></p>
<ul>
<li><code>public boolean shouldBeInitialized(Class&lt;?&gt; c)</code></li>
</ul>
<p>检测给定的类是否需要初始化。通常需要使用在获取一个类的静态属性的时候(因为一个类如果没初始化，它的静态属性也不会初始化)。 此方法当且仅当<code>ensureClassInitialized</code>方法不生效的时候才返回false。</p>
<p><strong>defineAnonymousClass</strong></p>
<ul>
<li>
<p><code>public Class&lt;?&gt; defineAnonymousClass(Class&lt;?&gt; hostClass, byte[] data, Object[] cpPatches)</code></p>
<ul>
<li>hostClass：宿主类。</li>
<li>data：字节码字节数组。</li>
<li>cpPatches：替换常量池(Constant Pool)中的字面量得到的引用数组。</li>
</ul>
</li>
</ul>
<p>这个方法的使用可以看R大的知乎回答：<a href="https://www.zhihu.com/question/51132462" target="_blank" rel="noopener">JVM crashes at libjvm.so</a>，下面截取一点内容解释此方法。</p>
<ul>
<li>1、VM Anonymous Class可以看作一种模板机制，如果程序要动态生成很多结构相同、只是若干变量不同的类的话，可以先创建出一个包含占位符常量的正常类作为模板，然后利用<code>sun.misc.Unsafe#defineAnonymousClass()</code>方法，传入该类(host class，宿主类或者模板类)以及一个作为&quot;constant pool path&quot;的数组来替换指定的常量为任意值，结果得到的就是一个替换了常量的<code>VM Anonymous Class</code>。</li>
<li>2、<code>VM Anonymous Class</code>从VM的角度看是真正的&quot;没有名字&quot;的，在构造出来之后只能通过<code>Unsafe#defineAnonymousClass()</code>返回出来一个Class实例来进行反射操作。</li>
</ul>
<p>还有其他几点看以自行阅读。这个方法虽然翻译为&quot;定义匿名类&quot;，但是它所定义的类和实际的匿名类有点不相同，因此一般情况下我们不会用到此方法。在JDK中Lambda表达式的构造依赖到此方法，可以看<code>InnerClassLambdaMetafactory</code>这个类。<strong>方法的注释：定义一个不被类加载器系统或者系统字典感知的类型</strong>。</p>
<p><strong>allocateInstance</strong></p>
<ul>
<li><code>public native Object allocateInstance(Class&lt;?&gt; cls)</code></li>
</ul>
<p>注意此方法是JVM本地接口方法，通过Class对象创建一个类的实例，不需要调用其构造函数、初始化代码、JVM安全检查等等。同时，它抑制修饰符检测，也就是即使构造器是private修饰的也能通过此方法实例化。</p>
<p><strong>staticFieldBase</strong></p>
<ul>
<li><code>public Object staticFieldBase(Field f)</code></li>
</ul>
<p>返回给定的静态属性所在的位置(其实就是所在的对象的内存快照)，配合<code>staticFieldOffset</code>方法使用。实际上，这个方法返回值就是静态属性所在的Class对象的一个内存快照。注释中说到，此方法返回的Object有可能为null，它只是一个’cookie’而不是真实的对象，不要直接使用的它的实例中的获取属性和设置属性的方法，它的作用只是方便调用像<code>getInt(Object,long)</code>等等的任意方法。</p>
<p><strong>staticFieldOffset</strong></p>
<ul>
<li><code>public long staticFieldOffset(Field f)</code></li>
</ul>
<p>返回给定的<strong>静态属性</strong>在它的类的内存分配中的位置(内存偏移地址)。不要在这个偏移量上执行任何类型的算术运算，它只是一个被传递给不安全的堆内存访问器的cookie。注意：这个方法仅仅针对静态属性，使用在非静态属性上会抛异常。</p>
<p><strong>objectFieldOffset</strong></p>
<ul>
<li><code>public long staticFieldOffset(Field f)</code></li>
</ul>
<p>返回给定的<strong>非静态属性</strong>在它的类的内存分配中的位置(内存偏移地址)。不要在这个偏移量上执行任何类型的算术运算，它只是一个被传递给不安全的堆内存访问器的cookie。注意：这个方法仅仅针对非静态属性，使用在静态属性上会抛异常。</p>
<p><strong>defineClass</strong></p>
<ul>
<li><code>public Class&lt;?&gt; defineClass(String name, byte[] b, int off, int len, ClassLoader loader, ProtectionDomain protectionDomain)</code></li>
</ul>
<p>这个方法位于<code>jdk.internal.misc.Unsafe</code>，也就是开发者无法直接使用。作用是：绕过安全检查告知JVM定义一个类。默认情况下，ClassLoader(类加载器)和ProtectionDomain(保护域)实例应该来源于调用者。</p>
<h3 id="基于内存地址直接存取属性">基于内存地址直接存取属性</h3>
<p>前一节中提供了一些方法可以直接获取静态或者非静态成员属性的内存地址，这一节介绍的API可以基于成员属性内存地址直接获取或者设置其值。</p>
<p><strong>getObject</strong></p>
<ul>
<li><code>public Object getObject(Object o, long offset)</code></li>
</ul>
<p>通过给定的Java对象和属性内存地址获取引用值。这里实际上是获取一个Java对象o中，获取偏移地址为offset的属性的值，此方法可以突破修饰符的抑制，也就是无视private、protected和default修饰符。类似的方法有<code>getInt</code>、<code>getDouble</code>等等。</p>
<p><strong>putObject</strong></p>
<ul>
<li>
<p><code>public void putObject(Object o, long offset, Object x)</code></p>
<ul>
<li>o：当前操作的对象。</li>
<li>offset：成员属性的内存地址。</li>
<li>x：需要设置的目标属性值。</li>
</ul>
</li>
</ul>
<p>将引用值存储到给定的Java变量中。这里实际上是设置一个Java对象o中偏移地址为offset的属性的值为x，此方法可以突破修饰符的抑制，也就是无视private、protected和default修饰符。类似的方法有putInt、putDouble等等。</p>
<p><strong>getObjectVolatile</strong></p>
<ul>
<li><code>public Object getObjectVolatile(Object o, long offset)</code></li>
</ul>
<p>此方法和上面的<code>getObject</code>功能类似，不过附加了<code>volatile</code>关键字加载语义，也就是强制从主存中获取属性值。类似的方法有<code>getIntVolatile</code>、<code>getDoubleVolatile</code>等等。这个方法要求被使用的属性被volatile修饰，否则功能和<code>getObject</code>方法相同。</p>
<p><strong>putObjectVolatile</strong></p>
<ul>
<li><code>public void putObjectVolatile(Object o, long offset, Object x)</code></li>
</ul>
<p>此方法和上面的<code>putObject</code>功能类似，不过附加了<code>volatile</code>关键字加载语义，也就是设置值的时候强制(JMM会保证获得锁到释放锁之间所有对象的状态更新都会在锁被释放之后)更新到主存，从而保证这些变更对其他线程是可见的。类似的方法有<code>putIntVolatile</code>、<code>putDoubleVolatile</code>等等。这个方法要求被使用的属性被volatile修饰，否则功能和putObject方法相同。</p>
<p><strong>putOrderedObject</strong></p>
<ul>
<li><code>public void putOrderedObject(Object o, long offset, Object x)</code></li>
</ul>
<p>设置o对象中offset偏移地址offset对应的Object型field的值为指定值x。这是一个有序或者有延迟的<code>putObjectVolatile</code>方法，并且不保证值的改变被其他线程立即看到。只有在属性被volatile修饰并且期望被修改的时候使用才会生效。类似的方法有<code>putOrderedInt</code>和<code>putOrderedLong</code>。方法注释中提到：相当于C11中的<code>atomic_store_explicit(..., memory_order_release)</code>。</p>
<h3 id="数组操作">数组操作</h3>
<p><strong>arrayBaseOffset</strong></p>
<ul>
<li><code>public int arrayBaseOffset(Class&lt;?&gt; arrayClass)</code></li>
</ul>
<p>返回数组类型的第一个元素的偏移地址(基础偏移地址)。如果arrayIndexScale方法返回的比例因子不为0，你可以通过结合基础偏移地址和比例因子访问数组的所有元素。Unsafe中已经初始化了很多类似的常量如<code>ARRAY_BOOLEAN_BASE_OFFSET</code>等。</p>
<p><strong>arrayIndexScale</strong></p>
<ul>
<li><code>public int arrayIndexScale(Class&lt;?&gt; arrayClass)</code></li>
</ul>
<p>返回数组类型的比例因子(其实就是数据中元素偏移地址的增量，因为数组中的元素的地址是连续的)。此方法不适用于数组类型为&quot;narrow&quot;类型的数组，&quot;narrow&quot;类型的数组类型使用此方法会返回0(这里narrow应该是狭义的意思，但是具体指哪些类型暂时不明确，笔者查了很多资料也没找到结果)。Unsafe中已经初始化了很多类似的常量如<code>ARRAY_BOOLEAN_INDEX_SCALE</code>等。</p>
<h3 id="低级同步原语">低级同步原语</h3>
<p>低级同步原语的相关方法在JDK8还能通过<code>sun.misc.Unsafe</code>使用，在JDK9以后<code>sun.misc.Unsafe</code>和<code>jdk.internal.misc.Unsafe</code>都移除了相关的方法。低级同步原语主要包括监视器锁定、解锁方法。</p>
<p><strong>monitorEnter</strong></p>
<ul>
<li><code>public native void monitorEnter(Object o)</code></li>
</ul>
<p>锁定对象，必须通过monitorExit方法才能解锁。此方法经过实验是可以重入的，也就是可以多次调用，然后通过多次调用monitorExit进行解锁。</p>
<p><strong>monitorExit</strong></p>
<ul>
<li><code>public native void monitorExit(Object o)</code></li>
</ul>
<p>解锁对象，前提是对象必须已经调用monitorEnter进行加锁，否则抛出IllegalMonitorStateException异常。</p>
<p><strong>tryMonitorEnter</strong></p>
<ul>
<li><code>public native boolean tryMonitorEnter(Object o)</code></li>
</ul>
<p>尝试锁定对象，如果加锁成功返回true，否则返回false。必须通过monitorExit方法才能解锁。</p>
<h3 id="线程挂起与恢复">线程挂起与恢复</h3>
<p>JDK1.5引入了并发包<code>java.util.concurrent</code>中组件控制线程挂起和恢复就是依赖于<code>java.util.concurrent.locks.LockSupport</code>完成，而<code>LockSupport</code>底层依赖于<code>sun.misc.Unsafe</code>中下面提到线程的挂起和恢复方法完成的。相关方法主要是用于替代线程类<code>Thread</code>中过时并且不安全的<code>suspend</code>和<code>resume</code>方法。</p>
<p><strong>park</strong></p>
<ul>
<li>
<p><code>public void park(boolean isAbsolute, long time)</code></p>
<ul>
<li>time：时间长度，单位由isAbsolute控制，0表示永久阻塞。</li>
<li>isAbsolute：如果isAbsolute为true，time是相对于新纪元之后的毫秒，否则time表示纳秒。</li>
</ul>
</li>
</ul>
<p>注释：阻塞当前线程直到一个<code>unpark</code>方法出现(被调用)、一个用于<code>unpark</code>方法已经出现过(在此<code>park</code>方法调用之前已经调用过)、线程被中断或者time时间到期(也就是阻塞超时)。在time非零的情况下，如果isAbsolute为true，time是相对于新纪元之后的毫秒，否则time表示纳秒。这个方法执行时也可能不合理地返回(没有具体原因)。</p>
<p><strong>unpark</strong></p>
<ul>
<li><code>public void unpark(Object thread)</code></li>
</ul>
<p>释放被<code>park</code>创建的在一个线程上的阻塞。这个方法也可以被使用来终止一个先前调用<code>park</code>导致的阻塞。这个操作是不安全的，因此必须保证线程是存活的(thread has not been destroyed)。从Java代码中判断一个线程是否存活的是显而易见的，所以解除阻塞的时候需要对线程的存活性做判断。</p>
<p><strong>重点注意：</strong></p>
<ul>
<li><code>unpark</code>方法调用多次，实际上只有一次会生效，可以简单理解为它是一个只有0和1两个值的计数器，调用<code>unpark</code>多次，计数仍然为1。</li>
<li><code>park</code>方法总是针对当前线程，如果预先已经调用过一次<code>unpark</code>方法后再调用<code>park</code>方法，那么<strong>将不会进入阻塞状态直接释放</strong>。</li>
</ul>
<h3 id="CAS操作">CAS操作</h3>
<p>CAS，也就是Compare And Swap，也就是在一个原子操作中完成比较和交互。</p>
<p><strong>compareAndSwapObject</strong></p>
<ul>
<li>
<p><code>public final boolean compareAndSwapObject(Object o, long offset, Object expected, Object x)</code></p>
<ul>
<li>o：目标Java变量引用。</li>
<li>offset：目标Java变量中的目标属性的偏移地址。</li>
<li>expected：目标Java变量中的目标属性的期望的当前值。</li>
<li>x：目标Java变量中的目标属性的目标更新值。</li>
</ul>
</li>
</ul>
<p>针对Object对象进行CAS操作。即是对应Java变量引用o，原子性地更新o中偏移地址为offset的属性的值为x，当且仅的偏移地址为offset的属性的当前值为expected才会更新成功返回true，否则返回false。类似的方法有<code>compareAndSwapInt</code>和<code>compareAndSwapLong</code>，在Jdk8中基于CAS扩展出来的相关方法有<code>getAndAddInt</code>、<code>getAndAddLong</code>、<code>getAndSetInt</code>、<code>getAndSetLong</code>、<code>getAndSetObject</code>，它们的作用都是：通过CAS设置新的值，返回旧的值。</p>
<p><strong>getAndSetObject</strong></p>
<ul>
<li><code>public final Object getAndSetObject(Object o, long offset, Object newValue)</code></li>
</ul>
<p>见<strong>compareAndSwapObject</strong>中的描述。</p>
<h3 id="内存管理">内存管理</h3>
<p><strong>addressSize</strong></p>
<ul>
<li><code>public int addressSize();</code></li>
</ul>
<p>获取本地指针的大小(单位是byte)，通常值为4或者8。常量ADDRESS_SIZE就是调用此方法。</p>
<p><strong>pageSize</strong></p>
<ul>
<li><code>public int pageSize();</code></li>
</ul>
<p>获取本地内存的页数，此值为2的幂次方。</p>
<p><strong>allocateMemory</strong></p>
<ul>
<li><code>public long allocateMemory(long bytes);</code></li>
</ul>
<p>分配一块新的本地内存，通过bytes指定内存块的大小(单位是byte)，返回新开辟的内存的地址。如果内存块的内容不被初始化，那么它们一般会变成内存垃圾。生成的本机指针永远不会为零，并将对所有值类型进行对齐。可以通过<code>freeMemory</code>方法释放内存块，或者通过<code>reallocateMemory</code>方法调整内存块大小。bytes值为负数或者过大会抛出IllegalArgumentException异常，如果系统拒绝分配内存会抛出OutOfMemoryError异常。</p>
<p><strong>reallocateMemory</strong></p>
<ul>
<li><code>public long reallocateMemory(long address, long bytes);</code></li>
</ul>
<p>通过指定的内存地址address重新调整本地内存块的大小，调整后的内存块大小通过bytes指定(单位为byte)。可以通过<code>freeMemory</code>方法释放内存块，或者通过<code>reallocateMemory</code>方法调整内存块大小。bytes值为负数或者过大会抛出IllegalArgumentException异常，如果系统拒绝分配内存会抛出OutOfMemoryError异常。</p>
<p><strong>setMemory</strong></p>
<ul>
<li><code>public void setMemory(Object o, long offset, long bytes, byte value);</code></li>
</ul>
<p>将给定内存块中的所有字节设置为固定值(通常是0)。内存块的地址由对象引用o和偏移地址共同决定，如果对象引用o为null，offset就是绝对地址。第三个参数就是内存块的大小，如果使用<code>allocateMemory</code>进行内存开辟的话，这里的值应该和<code>allocateMemory</code>的参数一致。value就是设置的固定值，一般为0(这里可以参考netty的DirectByteBuffer)。一般而言，o为null，所有有个重载方法是<code>public void setMemory(long offset, long bytes, byte value);</code>，等效于<code>setMemory(null, long offset, long bytes, byte value);</code>。</p>
<p><strong>copyMemory</strong></p>
<ul>
<li><code>public void copyMemory(Object srcBase, long srcOffset, Object destBase, long destOffset, long bytes) </code></li>
</ul>
<p>拷贝给定内存地址的字节长度对应的字节到指定内存地址中。如果srcBase或者destBase为null，则srcOffset或者destOffset分别指代绝对地址。</p>
<h3 id="内存屏障">内存屏障</h3>
<p>内存屏障相关的方法是在Jdk8添加的。内存屏障相关的知识可以先自行查阅，笔者目前也没有深入了解相关知识。</p>
<p><strong>loadFence</strong></p>
<ul>
<li><code>public void loadFence();</code></li>
</ul>
<p>在该方法之前的所有读操作，一定在load屏障之前执行完成。</p>
<p><strong>storeFence</strong></p>
<ul>
<li><code>public void storeFence();</code></li>
</ul>
<p>在该方法之前的所有写操作，一定在store屏障之前执行完成</p>
<p><strong>fullFence</strong></p>
<ul>
<li><code>public void fullFence();</code></li>
</ul>
<p>在该方法之前的所有读写操作，一定在full屏障之前执行完成，这个内存屏障相当于上面两个(load屏障和store屏障)的合体功能。</p>
<h3 id="其它">其它</h3>
<p><strong>invokeCleaner</strong></p>
<ul>
<li><code>public void invokeCleaner(java.nio.ByteBuffer directBuffer)</code></li>
</ul>
<p>清空使用了堆外内存的<code>ByteBuffer</code>实例占据的内存，一般是<code>DirectBuffer</code>的子类。</p>
<p><strong>throwException</strong></p>
<ul>
<li><code>public void throwException(Throwable ee)</code></li>
</ul>
<p>绕过检测机制直接抛出异常。</p>
<p><strong>getLoadAverage</strong></p>
<ul>
<li><code>public int getLoadAverage(double[] loadavg, int nelems);</code></li>
</ul>
<p>获取系统的平均负载值，loadavg这个double数组将会存放负载值的结果，nelems决定样本数量，nelems只能取值为1到3，分别代表最近1、5、15分钟内系统的平均负载。如果无法获取系统的负载，此方法返回-1，否则返回获取到的样本数量(loadavg中有效的元素个数)。实验中这个方法一直返回-1，其实完全可以使用<strong>JMX</strong>中的相关方法替代此方法。</p>
<h2 id="使用例子">使用例子</h2>
<p>先封装一下获取<code>Unsafe</code>实例的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> Unsafe <span class="title">getUnsafe</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">	Field f = sun.misc.Unsafe.class.getDeclaredField("theUnsafe");</span><br><span class="line">	f.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">	<span class="keyword">return</span> (Unsafe) f.get(<span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="通过内存地址直接操作属性">通过内存地址直接操作属性</h3>
<p>通过<code>staticFieldOffset</code>和<code>objectFieldOffset</code>可以获取静态和非静态成员属性的偏移地址，然后直接进行存取值操作。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Simple</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">static</span> Integer STATIC_INT = <span class="number">10086</span>;</span><br><span class="line"></span><br><span class="line">   Long longField = <span class="number">1024L</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		Unsafe unsafe = getUnsafe();</span><br><span class="line">		Field staticInt = Simple.class.getDeclaredField("STATIC_INT");</span><br><span class="line">		staticInt.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">		Object staticFieldBase = unsafe.staticFieldBase(staticInt);</span><br><span class="line">		<span class="keyword">long</span> staticFieldOffset = unsafe.staticFieldOffset(staticInt);</span><br><span class="line">		<span class="comment">// 注意这里一定要getObject,getInt是针对原始类型int,包装类型要自己强转</span></span><br><span class="line">		System.out.println(<span class="string">"Sample初始化前,STATIC_INT = "</span> + unsafe.getObject(staticFieldBase, staticFieldOffset));</span><br><span class="line">		Simple simple = <span class="keyword">new</span> Simple();</span><br><span class="line">		System.out.println(<span class="string">"Sample初始化后,STATIC_INT = "</span> + unsafe.getObject(staticFieldBase, staticFieldOffset));</span><br><span class="line"></span><br><span class="line">		Field longField = Simple.class.getDeclaredField("longField");</span><br><span class="line">		longField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">		<span class="keyword">long</span> objectFieldOffset = unsafe.objectFieldOffset(longField);</span><br><span class="line">		System.out.println(<span class="string">"Sample初始化后,longField = "</span> + unsafe.getObject(simple, objectFieldOffset));</span><br><span class="line">		unsafe.putObject(simple,objectFieldOffset, <span class="number">4201L</span>);</span><br><span class="line">		System.out.println(<span class="string">"Sample属性被覆盖后,longField = "</span> + simple.longField);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 输出如下：</span></span><br><span class="line">Sample初始化前,STATIC_INT = <span class="keyword">null</span></span><br><span class="line">Sample初始化后,STATIC_INT = <span class="number">10086</span></span><br><span class="line">Sample初始化后,longField = <span class="number">1024</span></span><br><span class="line">Sample属性被覆盖后,longField = <span class="number">4201</span></span><br></pre></td></tr></table></figure>
<h3 id="线程挂起和恢复">线程挂起和恢复</h3>
<p>主要介绍一下<code>park</code>和<code>unpark</code>的用法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		Unsafe unsafe = getUnsafe();</span><br><span class="line">		Thread thread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">			<span class="meta">@Override</span></span><br><span class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">				System.out.println(<span class="string">"线程park!"</span>);</span><br><span class="line">				unsafe.park(<span class="keyword">false</span>, <span class="number">0</span>);</span><br><span class="line">				System.out.println(<span class="string">"线程恢复运行!"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;);</span><br><span class="line">		thread.start();</span><br><span class="line">		TimeUnit.SECONDS.sleep(<span class="number">2</span>);</span><br><span class="line">		System.out.println(<span class="string">"主线程unpark阻塞着的线程!"</span>);</span><br><span class="line">		unsafe.unpark(thread);</span><br><span class="line">		TimeUnit.SECONDS.sleep(Integer.MAX_VALUE);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 运行后输出：</span></span><br><span class="line">线程park!</span><br><span class="line">主线程unpark阻塞着的线程!</span><br><span class="line">线程恢复运行!</span><br></pre></td></tr></table></figure>
<h3 id=""></h3>
<h2 id="小结">小结</h2>
<p>存在即合理，虽然不推荐使用<code>Unsafe</code>，但是如果有需要的还是要挥动这把双刃剑。</p>
<p>参考资料：</p>
<ul>
<li><a href="https://www.zhihu.com/question/29266773?sort=created" target="_blank" rel="noopener">为什么JUC中大量使用了sun.misc.Unsafe 这个类，但官方却不建议开发者使用？</a></li>
<li>JDK11相关源码</li>
<li><a href="http://ifeve.com/sun-misc-unsafe/" target="_blank" rel="noopener">Java Magic. Part 4: sun.misc.Unsafe</a></li>
</ul>
<p>(本文完 e-a-20181213 c-3-d)</p>

          
            <br>
            
              
                
              
                
              
                
              
                
              
                
              
                
                  <section class='widget card-shadow  copyright'>
  <div class='content'>
    
      <blockquote>
        
          
            <p>作者：<a href="http://www.throwable.club" target="_blank" rel="noopener">Throwable</a></p>

          
        
          
            <p>版权：博客内容遵循<a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener">署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0) 协议</a>，转载请在文章明显位置注明作者及出处</p>

          
        
          
            <p>本文永久链接是：<a href=http://throwable.club/2018/12/13/java-magic-unsafe/>http://throwable.club/2018/12/13/java-magic-unsafe/</a></p>
          
        
      </blockquote>
    
  </div>
</section>

                
              
                
              
                
              
                
              
                
              
            
              
                
              
                
              
                
              
                
              
                
              
                
              
                
                  <section class='widget card-shadow  text'>
  <header>
  <div>
    
      <i class=" fa-fw" aria-hidden="true"></i><span class='name'>打赏</span>
    

  </div>
  
</header>

  <div class='content'>
    
      <p>
        <iframe src="https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/static/simple-mine/index.html" style="overflow-x:hidden;overflow-y:hidden; border:0xp none #fff; min-height:240px; width:100%;"  frameborder="0" scrolling="no"></iframe>
      </p>
    
  </div>
</section>

                
              
                
              
                
              
                
              
            
          
        </div>
        
          <br>
          


  <section class='meta' id="footer-meta">
    <div class='new-meta-box'>
      
        
          
  
  <div class="new-meta-item meta-tags"><a class="tag" href="/blog/tags/Java/" rel="nofollow"><i class="fas fa-tag" aria-hidden="true"></i><p>Java</p></a></div>


        
      
        
          
  <div class="new-meta-item share -mob-share-list">
  <div class="-mob-share-list share-body">
    
      
        <a class="-mob-share-qq" title="QQ好友" rel="external nofollow noopener noreferrer"
          
          href="http://connect.qq.com/widget/shareqq/index.html?url=http://throwable.club/2018/12/13/java-magic-unsafe/&title=神奇的魔法类和双刃剑-Unsafe | Throwable's Blog&pics=https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/mine/doge_avatar.jpg&summary="
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/xaoxuu/assets@19.1.9/logo/128/qq.png">
          
        </a>
      
    
      
        <a class="-mob-share-qzone" title="QQ空间" rel="external nofollow noopener noreferrer"
          
          href="https://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url=http://throwable.club/2018/12/13/java-magic-unsafe/&title=神奇的魔法类和双刃剑-Unsafe | Throwable's Blog&pics=https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/mine/doge_avatar.jpg&summary="
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/xaoxuu/assets@19.1.9/logo/128/qzone.png">
          
        </a>
      
    
      
        <a class='qrcode' rel="external nofollow noopener noreferrer" href='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACJklEQVR42u3aQW4DIQwF0N7/0ukFMjPfNq008FhFSgI8FhbY/vmJx+d23P/yararz1f/WjAwMDBey0i2mP/mfrtVfH58GBgYJzDysLgqKOch+H5vGBgYGMkFLgnB1YCOgYGBMWckpPzteT8bBgYGRu+BmhzE1SprH88YGBgnMHph8X8+/0l9AwMD41WMT3Ek/81X6e3hyzwYGBhbM+YXu17DRN6KUZgBAwNjU0aveJmnw/KQfb/WQxEUAwNja0b+cM3DZULKw3R+oBgYGLsyelPfU6slycnqhXsrBgbGaxnVMmE1ilfbwqotIBgYGKcxVqX7R61dg/1gYGDsysiXr5Yze2G01zSGgYGxNyN/duZbr5YkezM/VGIxMDC2ZuSYSavEJDH3cEHEwMDYjlFtiegF4rwJLG+twMDAOIeRj7ygWIX10nblAicGBsZrGdVWiTwNl6fqqqsv6PjAwMB4ISN5xK69zE2SdF8OBQMDY2tGvunJJpJwXI2cDy0XGBgYmzLmzRC9dH8vqRc1W2BgYGzKmKT454xRuRQDA+NIxuSaWC1wVksUlS8wMDDezZiUEu+vib1LYX7pxMDAOIfRa7bohdekYJAk45b1jGBgYLyKsSpcVnnVI3uYBwMD4wBGkgJLLnbVR+zkIY2BgYFRTs0PjmDBkxUDAwNj0Lw1T6VFxVQMDIwDGHkxIN9okuGbwzAwME5gVO9dycK99Fyv1QMDA2Nrxi8bVrJQXzIScwAAAABJRU5ErkJggg=='>
        
          <img src="https://cdn.jsdelivr.net/gh/xaoxuu/assets@19.1.9/logo/128/wechat.png">
        
        </a>
      
    
      
        <a class="-mob-share-weibo" title="微博" rel="external nofollow noopener noreferrer"
          
          href="http://service.weibo.com/share/share.php?url=http://throwable.club/2018/12/13/java-magic-unsafe/&title=神奇的魔法类和双刃剑-Unsafe | Throwable's Blog&pics=https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/mine/doge_avatar.jpg&summary="
          
          >
          
            <img src="https://cdn.jsdelivr.net/gh/xaoxuu/assets@19.1.9/logo/128/weibo.png">
          
        </a>
      
    
      
        <a class='qrcode' rel="external nofollow noopener noreferrer" href='data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAMYAAADGCAAAAACs8KCBAAACJklEQVR42u3aQW4DIQwF0N7/0ukFMjPfNq008FhFSgI8FhbY/vmJx+d23P/yararz1f/WjAwMDBey0i2mP/mfrtVfH58GBgYJzDysLgqKOch+H5vGBgYGMkFLgnB1YCOgYGBMWckpPzteT8bBgYGRu+BmhzE1SprH88YGBgnMHph8X8+/0l9AwMD41WMT3Ek/81X6e3hyzwYGBhbM+YXu17DRN6KUZgBAwNjU0aveJmnw/KQfb/WQxEUAwNja0b+cM3DZULKw3R+oBgYGLsyelPfU6slycnqhXsrBgbGaxnVMmE1ilfbwqotIBgYGKcxVqX7R61dg/1gYGDsysiXr5Yze2G01zSGgYGxNyN/duZbr5YkezM/VGIxMDC2ZuSYSavEJDH3cEHEwMDYjlFtiegF4rwJLG+twMDAOIeRj7ygWIX10nblAicGBsZrGdVWiTwNl6fqqqsv6PjAwMB4ISN5xK69zE2SdF8OBQMDY2tGvunJJpJwXI2cDy0XGBgYmzLmzRC9dH8vqRc1W2BgYGzKmKT454xRuRQDA+NIxuSaWC1wVksUlS8wMDDezZiUEu+vib1LYX7pxMDAOIfRa7bohdekYJAk45b1jGBgYLyKsSpcVnnVI3uYBwMD4wBGkgJLLnbVR+zkIY2BgYFRTs0PjmDBkxUDAwNj0Lw1T6VFxVQMDIwDGHkxIN9okuGbwzAwME5gVO9dycK99Fyv1QMDA2Nrxi8bVrJQXzIScwAAAABJRU5ErkJggg=='>
        
          <img src="https://cdn.jsdelivr.net/gh/xaoxuu/assets@19.1.9/logo/128/qrcode.png">
        
        </a>
      
    
  </div>
</div>



        
      
    </div>
  </section>


        
        
            <div class="prev-next">
                
                    <section class="prev">
                        <span class="art-item-left">
                            <h6><i class="fas fa-chevron-left" aria-hidden="true"></i>&nbsp;上一页</h6>
                            <h4>
                                <a href="/2018/12/15/java-reflection-handle-exception/" rel="prev" title="深入分析Java反射(六)-反射调用异常处理">
                                  
                                      深入分析Java反射(六)-反射调用异常处理
                                  
                                </a>
                            </h4>
                            
                                
                                <h6 class="tags">
                                    <a class="tag" href="/blog/tags/Java/"><i class="fas fa-tag fa-fw" aria-hidden="true"></i> Java</a> <a class="tag" href="/blog/tags/Reflection/"><i class="fas fa-tag fa-fw" aria-hidden="true"></i> Reflection</a>
                                </h6>
                            
                        </span>
                    </section>
                
                
                    <section class="next">
                        <span class="art-item-right" aria-hidden="true">
                            <h6>下一页&nbsp;<i class="fas fa-chevron-right" aria-hidden="true"></i></h6>
                            <h4>
                                <a href="/2018/12/09/java-reflection-class-load/" rel="prev" title="深入分析Java反射(五)-类实例化和类加载">
                                    
                                        深入分析Java反射(五)-类实例化和类加载
                                    
                                </a>
                            </h4>
                            
                                
                                <h6 class="tags">
                                    <a class="tag" href="/blog/tags/Java/"><i class="fas fa-tag fa-fw" aria-hidden="true"></i> Java</a> <a class="tag" href="/blog/tags/Reflection/"><i class="fas fa-tag fa-fw" aria-hidden="true"></i> Reflection</a>
                                </h6>
                            
                        </span>
                    </section>
                
            </div>
        
      </section>
    </article>
  

  
    <!-- 显示推荐文章和评论 -->



  <article class="post white-box comments card-shadow ">
    <section class="article typo">
      <h4><i class="fas fa-comments fa-fw" aria-hidden="true"></i>&nbsp;评论</h4>
      
      
      
      
        <section id="comments">
          <div id="valine_container" class="valine_thread">
            <i class="fas fa-spinner fa-spin fa-fw"></i>
          </div>
        </section>
      
    </section>
  </article>


  




<!-- 根据页面mathjax变量决定是否加载MathJax数学公式js -->



  <script>
    window.subData = {
      title: '神奇的魔法类和双刃剑-Unsafe',
      tools: true
    }
  </script>


</div>
<aside class='l_side'>
  
    
    
      
        
      
        
          
  <section class='widget card-shadow  toc-wrapper'>
    <header>
  <div>
    
      <i class="fas fa-list fa-fw" aria-hidden="true"></i><span class='name'>本文目录</span>
    

  </div>
  
    <!-- <div class='wrapper'><a class="s-toc rightBtn" rel="external nofollow noopener noreferrer" href="javascript:void(0)"><i class="fas fa-thumbtack fa-fw"></i></a></div> -->
  
</header>

    <div class='content'>
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#前提"><span class="toc-text">前提</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Unsafe简介"><span class="toc-text">Unsafe简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#获取Unsafe实例"><span class="toc-text">获取Unsafe实例</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Unsafe的使用建议"><span class="toc-text">Unsafe的使用建议</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Unsafe的核心方法"><span class="toc-text">Unsafe的核心方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#类操作"><span class="toc-text">类操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#基于内存地址直接存取属性"><span class="toc-text">基于内存地址直接存取属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#数组操作"><span class="toc-text">数组操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#低级同步原语"><span class="toc-text">低级同步原语</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#线程挂起与恢复"><span class="toc-text">线程挂起与恢复</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#CAS操作"><span class="toc-text">CAS操作</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#内存管理"><span class="toc-text">内存管理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#内存屏障"><span class="toc-text">内存屏障</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#其它"><span class="toc-text">其它</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#使用例子"><span class="toc-text">使用例子</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#通过内存地址直接操作属性"><span class="toc-text">通过内存地址直接操作属性</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#线程挂起和恢复"><span class="toc-text">线程挂起和恢复</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#null"><span class="toc-text"></span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#小结"><span class="toc-text">小结</span></a></li></ol>
    </div>
  </section>


        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
        
      
    
  
</aside>

<footer class="clearfix ">
  <br><br>
  
    <div class="social-wrapper">
      
        
          <a href="/atom.xml"
            class="social fas fa-rss fa-lg flat-btn"
            target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
        
          <a href="mailto:739805340@qq.com"
            class="social fas fa-envelope fa-lg flat-btn"
            target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
        
          <a href="https://github.com/zjcscut"
            class="social fab fa-github fa-lg flat-btn"
            target="_blank"
            rel="external nofollow noopener noreferrer">
          </a>
        
      
    </div>
  
  
  <br>
  <div><p>博客内容遵循 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener">署名-非商业性使用-相同方式共享 4.0 国际 (CC BY-NC-SA 4.0) 协议</a></p>
</div>
  <div>
    本站使用
    <a href="https://xaoxuu.com/wiki/volantis/" target="_blank" class="codename">Volantis</a>
    作为主题
    
      ，
      总访问量为
      <span id="busuanzi_value_site_pv"><i class="fas fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span>
      次
    
    。
  </div>
  
    <div class='copyright'>
    <p><a href="http://throwable.club">Copyright © 2017-2020 Throwable</a></p>

    </div>
  
</footer>
<script>setLoadingBarProgress(80);</script>


      <script>setLoadingBarProgress(60);</script>
    </div>
    <a class="s-top fas fa-arrow-up fa-fw" href='javascript:void(0)'></a>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>

  <script>
    
    var SEARCH_SERVICE = "hexo" || "hexo";
    var ROOT = "/" || "/";
    if (!ROOT.endsWith('/')) ROOT += '/';
  </script>

<script async src="//instant.page/3.0.0" type="module" defer integrity="sha384-OeDn4XE77tdHo8pGtE1apMPmAipjoxUQ++eeJa6EtJCfHlvijigWiJpD7VDPWXV1"></script>


  <script src="https://cdn.jsdelivr.net/npm/scrollreveal@4.0.5/dist/scrollreveal.min.js"></script>
  <script type="text/javascript">
    $(function() {
      const $reveal = $('.reveal');
      if ($reveal.length === 0) return;
      const sr = ScrollReveal({ distance: 0 });
      sr.reveal('.reveal');
    });
  </script>


  <script src="https://cdn.jsdelivr.net/npm/node-waves@0.7.6/dist/waves.min.js"></script>
  <script type="text/javascript">
    $(function() {
      Waves.attach('.flat-btn', ['waves-button']);
      Waves.attach('.float-btn', ['waves-button', 'waves-float']);
      Waves.attach('.float-btn-light', ['waves-button', 'waves-float', 'waves-light']);
      Waves.attach('.flat-box', ['waves-block']);
      Waves.attach('.float-box', ['waves-block', 'waves-float']);
      Waves.attach('.waves-image');
      Waves.init();
    });
  </script>


  <script async src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-busuanzi@2.3/js/busuanzi.pure.mini.js"></script>












  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  
    
      
<script src="https://cdn.jsdelivr.net/gh/xaoxuu/volantis@1.0.6/js/volantis.min.js"></script>

    
  
  <script>
  var GUEST_INFO = ['nick','mail','link'];
  var guest_info = 'nick,mail,link'.split(',').filter(function(item){
    return GUEST_INFO.indexOf(item) > -1
  });
  var notify = 'true' == true;
  var verify = 'true' == true;
  var valine = new Valine();
  valine.init({
    el: '#valine_container',
    notify: notify,
    verify: verify,
    guest_info: guest_info,
    
    appId: "2rSnXSt7hr4528jSF4ifr2lJ-gzGzoHsz",
    appKey: "n5fe705fSsz4JHfwwtym1Fus",
    placeholder: "(゜-゜)つロ 干杯~-bilibili",
    pageSize:'10',
    avatar:'mp',
    lang:'zh-cn',
    highlight:'true'
  })
  </script>



  
<script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@20.2.30/js/app.js"></script>



  
<script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@20.2.30/js/search.js"></script>



  
    
<script src="https://cdn.jsdelivr.net/gh/xaoxuu/cdn-volantis@20.2.30/js/commentTyping.js"></script>

  





<!-- 复制 -->
<script src="https://cdn.jsdelivr.net/npm/clipboard@2/dist/clipboard.min.js"></script>
<script>
  let COPY_SUCCESS = "复制成功";
  let COPY_FAILURE = "复制失败";
  /*页面载入完成后，创建复制按钮*/
  !function (e, t, a) {
    /* code */
    var initCopyCode = function(){
      var copyHtml = '';
      copyHtml += '<button class="btn-copy" data-clipboard-snippet="">';
      copyHtml += '  <i class="fa fa-copy"></i><span>复制</span>';
      copyHtml += '</button>';
      $(".highlight .code pre").before(copyHtml);
      var clipboard = new ClipboardJS('.btn-copy', {
        target: function(trigger) {
          return trigger.nextElementSibling;
        }
      });

      clipboard.on('success', function(e) {
        //您可以加入成功提示
        console.info('Action:', e.action);
        console.info('Text:', e.text);
        console.info('Trigger:', e.trigger);
        success_prompt(COPY_SUCCESS);
        e.clearSelection();
      });
      clipboard.on('error', function(e) {
        //您可以加入失败提示
        console.error('Action:', e.action);
        console.error('Trigger:', e.trigger);
        fail_prompt(COPY_FAILURE);
      });
    }
    initCopyCode();

  }(window, document);

  /**
   * 弹出式提示框，默认1.5秒自动消失
   * @param message 提示信息
   * @param style 提示样式，有alert-success、alert-danger、alert-warning、alert-info
   * @param time 消失时间
   */
  var prompt = function (message, style, time)
  {
      style = (style === undefined) ? 'alert-success' : style;
      time = (time === undefined) ? 1500 : time*1000;
      $('<div>')
          .appendTo('body')
          .addClass('alert ' + style)
          .html(message)
          .show()
          .delay(time)
          .fadeOut();
  };

  // 成功提示
  var success_prompt = function(message, time)
  {
      prompt(message, 'alert-success', time);
  };

  // 失败提示
  var fail_prompt = function(message, time)
  {
      prompt(message, 'alert-danger', time);
  };

  // 提醒
  var warning_prompt = function(message, time)
  {
      prompt(message, 'alert-warning', time);
  };

  // 信息提示
  var info_prompt = function(message, time)
  {
      prompt(message, 'alert-info', time);
  };

</script>


<!-- fancybox -->
<script src="https://cdn.jsdelivr.net/gh/fancyapps/fancybox@3.5.7/dist/jquery.fancybox.min.js"></script>
<script>
  let LAZY_LOAD_IMAGE = "";
  $(".article-entry").find("fancybox").find("img").each(function () {
      var element = document.createElement("a");
      $(element).attr("data-fancybox", "gallery");
      $(element).attr("href", $(this).attr("src"));
      /* 图片采用懒加载处理时,
       * 一般图片标签内会有个属性名来存放图片的真实地址，比如 data-original,
       * 那么此处将原本的属性名src替换为对应属性名data-original,
       * 修改如下
       */
       if (LAZY_LOAD_IMAGE) {
         $(element).attr("href", $(this).attr("data-original"));
       }
      $(this).wrap(element);
  });
</script>





<script src='https://throwable-blog-1256189093.cos.ap-guangzhou.myqcloud.com/static/js/roll.js'></script>


  <script>setLoadingBarProgress(100);</script>
</body>
</html>
